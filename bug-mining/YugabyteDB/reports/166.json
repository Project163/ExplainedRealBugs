{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20252","repository_url":"https://api.github.com/repos/yugabyte/yugabyte-db","labels_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20252/labels{/name}","comments_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20252/comments","events_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20252/events","html_url":"https://github.com/yugabyte/yugabyte-db/issues/20252","id":2033435300,"node_id":"I_kwDOBlCVUc55M8Kk","number":20252,"title":"[DocDB] Fix master load balancer UI so it does not count split parent tablets","user":{"login":"mdbridge","id":15827795,"node_id":"MDQ6VXNlcjE1ODI3Nzk1","avatar_url":"https://avatars.githubusercontent.com/u/15827795?v=4","gravatar_id":"","url":"https://api.github.com/users/mdbridge","html_url":"https://github.com/mdbridge","followers_url":"https://api.github.com/users/mdbridge/followers","following_url":"https://api.github.com/users/mdbridge/following{/other_user}","gists_url":"https://api.github.com/users/mdbridge/gists{/gist_id}","starred_url":"https://api.github.com/users/mdbridge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdbridge/subscriptions","organizations_url":"https://api.github.com/users/mdbridge/orgs","repos_url":"https://api.github.com/users/mdbridge/repos","events_url":"https://api.github.com/users/mdbridge/events{/privacy}","received_events_url":"https://api.github.com/users/mdbridge/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":711841622,"node_id":"MDU6TGFiZWw3MTE4NDE2MjI=","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/kind/bug","name":"kind/bug","color":"c2e0c6","default":false,"description":"This issue is a bug"},{"id":1290759928,"node_id":"MDU6TGFiZWwxMjkwNzU5OTI4","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/area/docdb","name":"area/docdb","color":"0c4fcc","default":false,"description":"YugabyteDB core features"},{"id":1419821900,"node_id":"MDU6TGFiZWwxNDE5ODIxOTAw","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/priority/medium","name":"priority/medium","color":"ffdc5e","default":false,"description":"Medium priority issue"}],"state":"closed","locked":false,"assignee":{"login":"mdbridge","id":15827795,"node_id":"MDQ6VXNlcjE1ODI3Nzk1","avatar_url":"https://avatars.githubusercontent.com/u/15827795?v=4","gravatar_id":"","url":"https://api.github.com/users/mdbridge","html_url":"https://github.com/mdbridge","followers_url":"https://api.github.com/users/mdbridge/followers","following_url":"https://api.github.com/users/mdbridge/following{/other_user}","gists_url":"https://api.github.com/users/mdbridge/gists{/gist_id}","starred_url":"https://api.github.com/users/mdbridge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdbridge/subscriptions","organizations_url":"https://api.github.com/users/mdbridge/orgs","repos_url":"https://api.github.com/users/mdbridge/repos","events_url":"https://api.github.com/users/mdbridge/events{/privacy}","received_events_url":"https://api.github.com/users/mdbridge/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"mdbridge","id":15827795,"node_id":"MDQ6VXNlcjE1ODI3Nzk1","avatar_url":"https://avatars.githubusercontent.com/u/15827795?v=4","gravatar_id":"","url":"https://api.github.com/users/mdbridge","html_url":"https://github.com/mdbridge","followers_url":"https://api.github.com/users/mdbridge/followers","following_url":"https://api.github.com/users/mdbridge/following{/other_user}","gists_url":"https://api.github.com/users/mdbridge/gists{/gist_id}","starred_url":"https://api.github.com/users/mdbridge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdbridge/subscriptions","organizations_url":"https://api.github.com/users/mdbridge/orgs","repos_url":"https://api.github.com/users/mdbridge/repos","events_url":"https://api.github.com/users/mdbridge/events{/privacy}","received_events_url":"https://api.github.com/users/mdbridge/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2023-12-08T23:36:30Z","updated_at":"2024-12-19T16:04:10Z","closed_at":"2024-10-22T16:09:53Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Jira Link: [DB-9214](https://yugabyte.atlassian.net/browse/DB-9214)\r\n### Description\n\nThe current load balancer UI (MasterPathHandlers::HandleLoadBalancer) counts inactive tablets:\r\n```\r\n~/code/yugabyte-db/src/yb/master/master-path-handlers.cc:3372:\r\n    TabletInfos tablets = table->GetTablets(IncludeInactive::kTrue);\r\n```\r\n\r\nThe problem is currently that includes (at least?) two cases:\r\n  * Tablets that are marked as HIDDEN for PITR.\r\n  * split parent tablets\r\n\r\nWe definitely do not want to count the second case as those tablets are gone.  We do, however, probably want to include the first case.\r\n\r\nNote the comments in the code base for \"inactive\" are wrong; please update them as appropriate.\r\n\r\n----------\r\n\r\nOn what constitutes an \"inactive\" tablet\r\n\r\nThe code for `TableInfo::tablets_` claims:\r\n```\r\n~/code/yugabyte-db/src/yb/master/catalog_entity_info.h:749:\r\n  // Sorted index of tablet start partition-keys to TabletInfo.\r\n  // The TabletInfo objects are owned by the CatalogManager.\r\n  // At any point in time it contains only the active tablets (defined in the comment on tablets_).\r\n  std::map<PartitionKey, TabletInfo*> partitions_ GUARDED_BY(lock_);\r\n  // At any point in time it contains both active and inactive tablets.\r\n  // Currently there are two cases for a tablet to be categorized as inactive:\r\n  // 1) Not yet deleted split parent tablets for which we've already\r\n  //    registered child split tablets.\r\n  // 2) Tablets that are marked as HIDDEN for PITR.\r\n  std::unordered_map<TabletId, TabletInfo*> tablets_ GUARDED_BY(lock_);\r\n```\r\n\r\nSupporting evidence is:\r\n```\r\n~/code/yugabyte-db/src/yb/master/catalog_manager.cc:10873:\r\n      // Inactive tablet now, so remove it from partitions_.\r\n      // After all the tablets have been deleted from the tservers, we remove it from tablets_.\r\n      tablet->table()->RemoveTablet(tablet->id(), DeactivateOnly::kTrue);\r\n```\r\n\r\nI believe this lies and we in fact never remove split tablet parents from tablets_ until the entire table is deleted.  So split parent tablets are always inactive while the table they belong to is alive, even after we have deleted them.\r\n\n\n### Issue Type\n\nkind/bug\n\n### Warning: Please confirm that this issue does not contain any sensitive information\n\n- [X] I confirm this issue does not contain any sensitive information.\n\n[DB-9214]: https://yugabyte.atlassian.net/browse/DB-9214?atlOrigin=eyJpIjoiNWRkNTljNzYxNjVmNDY3MDlhMDU5Y2ZhYzA5YTRkZjUiLCJwIjoiZ2l0aHViLWNvbS1KU1cifQ","closed_by":{"login":"yugabyte-ci","id":17281578,"node_id":"MDQ6VXNlcjE3MjgxNTc4","avatar_url":"https://avatars.githubusercontent.com/u/17281578?v=4","gravatar_id":"","url":"https://api.github.com/users/yugabyte-ci","html_url":"https://github.com/yugabyte-ci","followers_url":"https://api.github.com/users/yugabyte-ci/followers","following_url":"https://api.github.com/users/yugabyte-ci/following{/other_user}","gists_url":"https://api.github.com/users/yugabyte-ci/gists{/gist_id}","starred_url":"https://api.github.com/users/yugabyte-ci/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yugabyte-ci/subscriptions","organizations_url":"https://api.github.com/users/yugabyte-ci/orgs","repos_url":"https://api.github.com/users/yugabyte-ci/repos","events_url":"https://api.github.com/users/yugabyte-ci/events{/privacy}","received_events_url":"https://api.github.com/users/yugabyte-ci/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20252/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20252/timeline","performed_via_github_app":null,"state_reason":"completed"}