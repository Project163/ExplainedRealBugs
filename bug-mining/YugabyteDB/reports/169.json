{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/24658","repository_url":"https://api.github.com/repos/yugabyte/yugabyte-db","labels_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/24658/labels{/name}","comments_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/24658/comments","events_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/24658/events","html_url":"https://github.com/yugabyte/yugabyte-db/issues/24658","id":2618564541,"node_id":"I_kwDOBlCVUc6cFB-9","number":24658,"title":"[DocDB][Pg cron] Intermittent Failure of Cron Job Execution in Stress Test Runs Despite Latest Fixes on Master","user":{"login":"shishir2001-yb","id":59393494,"node_id":"MDQ6VXNlcjU5MzkzNDk0","avatar_url":"https://avatars.githubusercontent.com/u/59393494?v=4","gravatar_id":"","url":"https://api.github.com/users/shishir2001-yb","html_url":"https://github.com/shishir2001-yb","followers_url":"https://api.github.com/users/shishir2001-yb/followers","following_url":"https://api.github.com/users/shishir2001-yb/following{/other_user}","gists_url":"https://api.github.com/users/shishir2001-yb/gists{/gist_id}","starred_url":"https://api.github.com/users/shishir2001-yb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shishir2001-yb/subscriptions","organizations_url":"https://api.github.com/users/shishir2001-yb/orgs","repos_url":"https://api.github.com/users/shishir2001-yb/repos","events_url":"https://api.github.com/users/shishir2001-yb/events{/privacy}","received_events_url":"https://api.github.com/users/shishir2001-yb/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":711841622,"node_id":"MDU6TGFiZWw3MTE4NDE2MjI=","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/kind/bug","name":"kind/bug","color":"c2e0c6","default":false,"description":"This issue is a bug"},{"id":1290759928,"node_id":"MDU6TGFiZWwxMjkwNzU5OTI4","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/area/docdb","name":"area/docdb","color":"0c4fcc","default":false,"description":"YugabyteDB core features"},{"id":1353907004,"node_id":"MDU6TGFiZWwxMzUzOTA3MDA0","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/priority/high","name":"priority/high","color":"ffdc5e","default":false,"description":"High Priority"},{"id":3248174344,"node_id":"MDU6TGFiZWwzMjQ4MTc0MzQ0","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/QA","name":"QA","color":"A01624","default":false,"description":"QA filed bugs"},{"id":6312498755,"node_id":"LA_kwDOBlCVUc8AAAABeEEWQw","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/qa_stress","name":"qa_stress","color":"03660D","default":false,"description":"Bugs identified via Stress automation"},{"id":7221621143,"node_id":"LA_kwDOBlCVUc8AAAABrnExlw","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/2024.2_blocker","name":"2024.2_blocker","color":"ededed","default":false,"description":null},{"id":7473933036,"node_id":"LA_kwDOBlCVUc8AAAABvXsq7A","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/2024.2.0_blocker","name":"2024.2.0_blocker","color":"ededed","default":false,"description":null},{"id":7619062128,"node_id":"LA_kwDOBlCVUc8AAAABxiGpcA","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/2024.2.1_blocker","name":"2024.2.1_blocker","color":"ededed","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"hari90","id":12418230,"node_id":"MDQ6VXNlcjEyNDE4MjMw","avatar_url":"https://avatars.githubusercontent.com/u/12418230?v=4","gravatar_id":"","url":"https://api.github.com/users/hari90","html_url":"https://github.com/hari90","followers_url":"https://api.github.com/users/hari90/followers","following_url":"https://api.github.com/users/hari90/following{/other_user}","gists_url":"https://api.github.com/users/hari90/gists{/gist_id}","starred_url":"https://api.github.com/users/hari90/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hari90/subscriptions","organizations_url":"https://api.github.com/users/hari90/orgs","repos_url":"https://api.github.com/users/hari90/repos","events_url":"https://api.github.com/users/hari90/events{/privacy}","received_events_url":"https://api.github.com/users/hari90/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"hari90","id":12418230,"node_id":"MDQ6VXNlcjEyNDE4MjMw","avatar_url":"https://avatars.githubusercontent.com/u/12418230?v=4","gravatar_id":"","url":"https://api.github.com/users/hari90","html_url":"https://github.com/hari90","followers_url":"https://api.github.com/users/hari90/followers","following_url":"https://api.github.com/users/hari90/following{/other_user}","gists_url":"https://api.github.com/users/hari90/gists{/gist_id}","starred_url":"https://api.github.com/users/hari90/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hari90/subscriptions","organizations_url":"https://api.github.com/users/hari90/orgs","repos_url":"https://api.github.com/users/hari90/repos","events_url":"https://api.github.com/users/hari90/events{/privacy}","received_events_url":"https://api.github.com/users/hari90/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2024-10-28T14:17:12Z","updated_at":"2024-10-31T16:54:10Z","closed_at":"2024-10-31T16:54:10Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Jira Link: [DB-13724](https://yugabyte.atlassian.net/browse/DB-13724)\r\n### Description\n\nVersion: **2.25.0.0-b214**\r\nLogs: Added in jira\r\n\r\n\r\n```\r\n DB name: postgres_24 \r\nValidation failed for Job Id: 389 between [2024-10-28 06:51:08.113757+00:00, 2024-10-28 07:01:08.113838+00:00],\r\n Actual: 0\r\n Expected: 10\r\n```\r\n\r\nAdditionally, the count of executed jobs remains constant, suggesting that no new cron jobs are being triggered.\r\n\r\n```\r\nyugabyte=# select count(*) from cron.job_run_details ;\r\n count \r\n-------\r\n 69826\r\n(1 row)\r\n```\r\n\r\n```\r\nyugabyte=# select count(*) from cron.job;\r\n count \r\n-------\r\n  2840\r\n(1 row)\r\n\r\nyugabyte=# select count(*) from cron.job_run_details ;\r\n count \r\n-------\r\n 69826\r\n(1 row)\r\n\r\nyugabyte=# select jobid, runid, job_pid, database, username, status, return_message, start_time, end_time from cron.job_run_details where status = 'running';\r\n jobid | runid | job_pid |  database   | username | status  | return_message |          start_time           | end_time \r\n-------+-------+---------+-------------+----------+---------+----------------+-------------------------------+----------\r\n   379 | 69969 |  273161 | postgres_23 | yugabyte | running |                | 2024-10-28 06:40:09.115879+00 | \r\n   336 | 69967 |  273138 | postgres_19 | yugabyte | running |                | 2024-10-28 06:40:09.049794+00 | \r\n  1794 | 69971 |  273178 | postgres_41 | yugabyte | running |                | 2024-10-28 06:40:09.132326+00 | \r\n(3 rows)\r\n\r\nyugabyte=# SHOW cron.max_running_jobs;\r\n cron.max_running_jobs \r\n-----------------------\r\n 5\r\n(1 row)\r\n\r\nyugabyte=# SHOW max_worker_processes;\r\n max_worker_processes \r\n----------------------\r\n 8\r\n(1 row)\r\n\r\nyugabyte=# select count(*) from cron.job_run_details ;\r\n count \r\n-------\r\n 69826\r\n(1 row)\r\n```\r\n\r\nTest description\r\n\r\n```\r\n\"\"\"\r\n        1. Create a cluster with enable_pg_cron g-flag and other required g-flags.\r\n        2. Create 100 databases (50 colocated + 50 non-colocated).\r\n        3. Start SqlCrossDBLoadWithDDL workload this should create the below\r\n             - 2 tables\r\n             - A materialized view on each table\r\n        4. Create an age table which will be used to INSERT,UPDATE AND DELETE ROWS\r\n        5. Create PG cron extension on yugabyte keyspace\r\n        6. Connect to 'yugabyte' database and schedule the following Cron Jobs:\r\n          a. Refresh Materialized views (2-minute interval, every week, every month and\r\n             every year)\r\n          b. Insert data (1-minute, 2 minutes, 5 minutes, every week, every month and\r\n             every year)\r\n          c. Update data (1-minute, 2 minutes, 5 minutes, every week, every month and\r\n             every year)\r\n          d. Delete data (1-minute, 2 minutes, 5 minutes, every week, every month and\r\n             every year)\r\n          e. Explicit Transaction(INSERT,UPDATE AND DELETE) (1-minute)\r\n          e. Validate these cron jobs are getting executed.\r\n        7. Start a loop and execute the following for 4 hours:\r\n           a. Start nemesis (Node restart, Network slowdown, Instance termination,\r\n              Master/tserver stop/start, NetworkPartitionNemesis).\r\n           b. Deactivate most cron jobs(Cron jobs from 98 DBs)\r\n           c. Verify deactivated jobs are not running\r\n           d. Update some active cron jobs(From remaining 2 DBs)\r\n           e. Verify updated jobs are running correctly\r\n           f. Reactivate deactivated jobs\r\n           g. Verify reactivated jobs are running\r\n           h. With a 10% chance:\r\n              i.   Create a new database\r\n              ii.  Change ysql_cron_database_name g-flag to the new database\r\n              iii. Create pg cron extension on this new DB\r\n              iv.  Verify old cron jobs are not running\r\n               v.  Schedule new cron jobs via the new database\r\n              vi.  Verify new cron jobs are running\r\n\r\n        9. Clean up and end the test.\r\n        \"\"\"\r\n\r\n```\r\n\n\n### Issue Type\n\nkind/bug\n\n### Warning: Please confirm that this issue does not contain any sensitive information\n\n- [X] I confirm this issue does not contain any sensitive information.\n\n[DB-13724]: https://yugabyte.atlassian.net/browse/DB-13724?atlOrigin=eyJpIjoiNWRkNTljNzYxNjVmNDY3MDlhMDU5Y2ZhYzA5YTRkZjUiLCJwIjoiZ2l0aHViLWNvbS1KU1cifQ","closed_by":{"login":"yugabyte-ci","id":17281578,"node_id":"MDQ6VXNlcjE3MjgxNTc4","avatar_url":"https://avatars.githubusercontent.com/u/17281578?v=4","gravatar_id":"","url":"https://api.github.com/users/yugabyte-ci","html_url":"https://github.com/yugabyte-ci","followers_url":"https://api.github.com/users/yugabyte-ci/followers","following_url":"https://api.github.com/users/yugabyte-ci/following{/other_user}","gists_url":"https://api.github.com/users/yugabyte-ci/gists{/gist_id}","starred_url":"https://api.github.com/users/yugabyte-ci/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yugabyte-ci/subscriptions","organizations_url":"https://api.github.com/users/yugabyte-ci/orgs","repos_url":"https://api.github.com/users/yugabyte-ci/repos","events_url":"https://api.github.com/users/yugabyte-ci/events{/privacy}","received_events_url":"https://api.github.com/users/yugabyte-ci/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/24658/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/24658/timeline","performed_via_github_app":null,"state_reason":"completed"}