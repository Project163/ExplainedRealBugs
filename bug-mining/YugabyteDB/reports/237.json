{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/25100","repository_url":"https://api.github.com/repos/yugabyte/yugabyte-db","labels_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/25100/labels{/name}","comments_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/25100/comments","events_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/25100/events","html_url":"https://github.com/yugabyte/yugabyte-db/issues/25100","id":2695793862,"node_id":"I_kwDOBlCVUc6grozG","number":25100,"title":"[YSQL] PG15 Online Upgrade may incorrectly call namespace_names_mapper_.erase in error conditions","user":{"login":"timothy-e","id":26841748,"node_id":"MDQ6VXNlcjI2ODQxNzQ4","avatar_url":"https://avatars.githubusercontent.com/u/26841748?v=4","gravatar_id":"","url":"https://api.github.com/users/timothy-e","html_url":"https://github.com/timothy-e","followers_url":"https://api.github.com/users/timothy-e/followers","following_url":"https://api.github.com/users/timothy-e/following{/other_user}","gists_url":"https://api.github.com/users/timothy-e/gists{/gist_id}","starred_url":"https://api.github.com/users/timothy-e/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/timothy-e/subscriptions","organizations_url":"https://api.github.com/users/timothy-e/orgs","repos_url":"https://api.github.com/users/timothy-e/repos","events_url":"https://api.github.com/users/timothy-e/events{/privacy}","received_events_url":"https://api.github.com/users/timothy-e/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":711841624,"node_id":"MDU6TGFiZWw3MTE4NDE2MjQ=","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/kind/enhancement","name":"kind/enhancement","color":"c2e0c6","default":false,"description":"This is an enhancement of an existing feature"},{"id":1280238232,"node_id":"MDU6TGFiZWwxMjgwMjM4MjMy","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/area/ysql","name":"area/ysql","color":"0c4fcc","default":false,"description":"Yugabyte SQL (YSQL)"},{"id":1419821900,"node_id":"MDU6TGFiZWwxNDE5ODIxOTAw","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/priority/medium","name":"priority/medium","color":"ffdc5e","default":false,"description":"Medium priority issue"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2024-11-26T19:07:30Z","updated_at":"2025-02-06T00:57:59Z","closed_at":"2025-02-06T00:57:59Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Jira Link: [DB-14245](https://yugabyte.atlassian.net/browse/DB-14245)\r\n### Description\n\nA vanilla PG upgrade uses two different clusters, so it can drop and create items as it pleases. To ensure databases are set up properly, it drops and creates new databases. \r\n\r\nSince YB upgrade uses the same cluster and the same storage, we don't want to actually drop the databases, so we instead just keep track of what state the pg15 databases _would_ be in, if we followed the typical PG flow. \r\n\r\nThis means that when we create a namespace as part of the pg15 upgrade, we expect that catalog_manager.cc is already aware of the namespace. However, the catalog manager assumes that there can only be one namespace, so if something goes wrong during namespace creation, it removes the namespace entry (because it believes it was not properly set up). This can happen when any of the following statements in catalog_manager.cc fail:\r\n```\r\nsys_catalog_->Upsert(leader_ready_term(), ns); \r\nCopyPgsqlSysTables(ns->id(), template_tables, epoch);\r\nsys_catalog_->Upsert(term, ns); \r\n```\r\n\r\nWe should wrap calls to `namespace_names_mapper_[...].erase(...)` in some sort of function or class that ensures that we do not impact existing namespaces when doing the upgrade. This will also protect us from any future changes to the class. \r\n\r\n\r\n\r\n\n\n### Issue Type\n\nkind/enhancement\n\n### Warning: Please confirm that this issue does not contain any sensitive information\n\n- [X] I confirm this issue does not contain any sensitive information.\n\n[DB-14245]: https://yugabyte.atlassian.net/browse/DB-14245?atlOrigin=eyJpIjoiNWRkNTljNzYxNjVmNDY3MDlhMDU5Y2ZhYzA5YTRkZjUiLCJwIjoiZ2l0aHViLWNvbS1KU1cifQ","closed_by":{"login":"hari90","id":12418230,"node_id":"MDQ6VXNlcjEyNDE4MjMw","avatar_url":"https://avatars.githubusercontent.com/u/12418230?v=4","gravatar_id":"","url":"https://api.github.com/users/hari90","html_url":"https://github.com/hari90","followers_url":"https://api.github.com/users/hari90/followers","following_url":"https://api.github.com/users/hari90/following{/other_user}","gists_url":"https://api.github.com/users/hari90/gists{/gist_id}","starred_url":"https://api.github.com/users/hari90/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hari90/subscriptions","organizations_url":"https://api.github.com/users/hari90/orgs","repos_url":"https://api.github.com/users/hari90/repos","events_url":"https://api.github.com/users/hari90/events{/privacy}","received_events_url":"https://api.github.com/users/hari90/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/25100/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/25100/timeline","performed_via_github_app":null,"state_reason":"completed"}