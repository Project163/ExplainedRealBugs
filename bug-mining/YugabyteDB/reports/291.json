{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/27293","repository_url":"https://api.github.com/repos/yugabyte/yugabyte-db","labels_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/27293/labels{/name}","comments_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/27293/comments","events_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/27293/events","html_url":"https://github.com/yugabyte/yugabyte-db/issues/27293","id":3078221797,"node_id":"I_kwDOBlCVUc63ee_l","number":27293,"title":"[YSQL] Fix conflict on SELECT catalog version FOR UPDATE","user":{"login":"pao214","id":16426043,"node_id":"MDQ6VXNlcjE2NDI2MDQz","avatar_url":"https://avatars.githubusercontent.com/u/16426043?v=4","gravatar_id":"","url":"https://api.github.com/users/pao214","html_url":"https://github.com/pao214","followers_url":"https://api.github.com/users/pao214/followers","following_url":"https://api.github.com/users/pao214/following{/other_user}","gists_url":"https://api.github.com/users/pao214/gists{/gist_id}","starred_url":"https://api.github.com/users/pao214/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pao214/subscriptions","organizations_url":"https://api.github.com/users/pao214/orgs","repos_url":"https://api.github.com/users/pao214/repos","events_url":"https://api.github.com/users/pao214/events{/privacy}","received_events_url":"https://api.github.com/users/pao214/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":711841622,"node_id":"MDU6TGFiZWw3MTE4NDE2MjI=","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/kind/bug","name":"kind/bug","color":"c2e0c6","default":false,"description":"This issue is a bug"},{"id":1280238232,"node_id":"MDU6TGFiZWwxMjgwMjM4MjMy","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/area/ysql","name":"area/ysql","color":"0c4fcc","default":false,"description":"Yugabyte SQL (YSQL)"},{"id":1419821900,"node_id":"MDU6TGFiZWwxNDE5ODIxOTAw","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/priority/medium","name":"priority/medium","color":"ffdc5e","default":false,"description":"Medium priority issue"}],"state":"closed","locked":false,"assignee":{"login":"pkj415","id":12711838,"node_id":"MDQ6VXNlcjEyNzExODM4","avatar_url":"https://avatars.githubusercontent.com/u/12711838?v=4","gravatar_id":"","url":"https://api.github.com/users/pkj415","html_url":"https://github.com/pkj415","followers_url":"https://api.github.com/users/pkj415/followers","following_url":"https://api.github.com/users/pkj415/following{/other_user}","gists_url":"https://api.github.com/users/pkj415/gists{/gist_id}","starred_url":"https://api.github.com/users/pkj415/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pkj415/subscriptions","organizations_url":"https://api.github.com/users/pkj415/orgs","repos_url":"https://api.github.com/users/pkj415/repos","events_url":"https://api.github.com/users/pkj415/events{/privacy}","received_events_url":"https://api.github.com/users/pkj415/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"pkj415","id":12711838,"node_id":"MDQ6VXNlcjEyNzExODM4","avatar_url":"https://avatars.githubusercontent.com/u/12711838?v=4","gravatar_id":"","url":"https://api.github.com/users/pkj415","html_url":"https://github.com/pkj415","followers_url":"https://api.github.com/users/pkj415/followers","following_url":"https://api.github.com/users/pkj415/following{/other_user}","gists_url":"https://api.github.com/users/pkj415/gists{/gist_id}","starred_url":"https://api.github.com/users/pkj415/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pkj415/subscriptions","organizations_url":"https://api.github.com/users/pkj415/orgs","repos_url":"https://api.github.com/users/pkj415/repos","events_url":"https://api.github.com/users/pkj415/events{/privacy}","received_events_url":"https://api.github.com/users/pkj415/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2025-05-20T20:58:46Z","updated_at":"2025-06-25T21:49:38Z","closed_at":"2025-06-25T21:49:38Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Jira Link: [DB-16788](https://yugabyte.atlassian.net/browse/DB-16788)\n### Description\n\n### Example\n\nTest YbAdminSnapshotScheduleTestWithYsqlColocationRestoreParam.PgsqlAlterTableSetOwner sometimes fails with error\n\n```\n[ts-2] I0520 16:37:03.938395  3098 tablet_rpc.cc:507] Operation failed. Try again (yb/docdb/conflict_resolution.cc:96): Failed Read(tablet: {sys_catalog_tablet_id}, num_ops: 1, num_attempts: 1, txn: 06447313-8816-46b4-9c60-2291561bd7f8, subtxn: [none]) to tablet {sys_catalog_tablet_id} on tablet server { uuid: {m1_peer_id} private: [host: \"127.0.0.1\" port: 25481] cloud_info: placement_cloud: \"cloud1\" placement_region: \"datacenter1\" placement_zone: \"rack1\" after 1 attempt(s): 06447313-8816-46b4-9c60-2291561bd7f8 conflicts with same priority transaction (pri: 18446744073709551615): b2612978-e010-476f-ae20-0b96fd7f0b1c (transaction error 3)\n[ts-2] 2025-05-20 16:37:03.939 UTC [3084] ERROR:  could not serialize access due to concurrent update\n[ts-2] 2025-05-20 16:37:03.939 UTC [3084] DETAIL:  06447313-8816-46b4-9c60-2291561bd7f8 conflicts with same priority transaction (pri: 18446744073709551615): b2612978-e010-476f-ae20-0b96fd7f0b1c\n[ts-2] 2025-05-20 16:37:03.939 UTC [3084] STATEMENT:  ALTER TABLE test_table RENAME key TO key_new3\n${YB_SRC_ROOT}/src/yb/tools/yb-admin-snapshot-schedule-test.cc:2341: Failure\nFailed\nBad status: Network error (yb/yql/pgwrapper/libpq_utils.cc:453): Execute of 'ALTER TABLE test_table RENAME key TO key_new3' failed: 7, message: ERROR:  could not serialize access due to concurrent update\nDETAIL:  06447313-8816-46b4-9c60-2291561bd7f8 conflicts with same priority transaction (pri: 18446744073709551615): b2612978-e010-476f-ae20-0b96fd7f0b1c (pgsql error 40001) (aux msg ERROR:  could not serialize access due to concurrent update\nDETAIL:  06447313-8816-46b4-9c60-2291561bd7f8 conflicts with same priority transaction (pri: 18446744073709551615): b2612978-e010-476f-ae20-0b96fd7f0b1c)\nTest failure stack trace:\n    @     0xffff7e5096f4  testing::internal::TestEventRepeater::OnTestPartResult()\n    @     0xffff7e50ff54  testing::UnitTest::AddTestPartResult()\n    @     0xffff7e50f7ec  testing::internal::AssertHelper::operator=()\n    @     0xaaaade9d0268  yb::tools::YbAdminSnapshotScheduleTestWithYsqlColocationRestoreParam_PgsqlAlterTableSetOwner_Test::TestBody()\n    @     0xffff7e527d54  testing::internal::HandleExceptionsInMethodIfSupported<>()\n    @     0xffff7e527c14  testing::Test::Run()\n    @     0xffff7e528ae4  testing::TestInfo::Run()\n    @     0xffff7e5292d4  testing::TestSuite::Run()\n    @     0xffff7e537d6c  testing::internal::UnitTestImpl::RunAllTests()\n    @     0xffff7e537498  testing::UnitTest::Run()\n    @     0xffff7ee829bc  (unknown)\n    @     0xffff78144384  __libc_start_main\n    @     0xaaaade921834  (unknown)\n```\n\n### Hypothesis\n\nAfter #27036, when two DDLs run one after another\n\n```\nDDL1   <-- increments cat version\nDDL2  <-- SELECT FOR UPDATE lock on cat version\n```\n\nDDL2 picks a safe time that is less than the commit time of DDL1. Since master does not have wait queues enabled, this raises a conflict error.\n\n### Proposals\n\n1. Add retries for kConflict and kReadRestart errors on master\n2. Enable DDL retries\n3. Enable DDL retries only for errors on catalog version locking (perhaps we can add the table name in the conflict error message and check for the table name in postgres.c).\n4. Change safe time to current time in some cases?\n5. Wait queues on master.\n\n\n\n### Issue Type\n\nkind/bug\n\n### Warning: Please confirm that this issue does not contain any sensitive information\n\n- [x] I confirm this issue does not contain any sensitive information.\n\n[DB-16788]: https://yugabyte.atlassian.net/browse/DB-16788?atlOrigin=eyJpIjoiNWRkNTljNzYxNjVmNDY3MDlhMDU5Y2ZhYzA5YTRkZjUiLCJwIjoiZ2l0aHViLWNvbS1KU1cifQ","closed_by":{"login":"pkj415","id":12711838,"node_id":"MDQ6VXNlcjEyNzExODM4","avatar_url":"https://avatars.githubusercontent.com/u/12711838?v=4","gravatar_id":"","url":"https://api.github.com/users/pkj415","html_url":"https://github.com/pkj415","followers_url":"https://api.github.com/users/pkj415/followers","following_url":"https://api.github.com/users/pkj415/following{/other_user}","gists_url":"https://api.github.com/users/pkj415/gists{/gist_id}","starred_url":"https://api.github.com/users/pkj415/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pkj415/subscriptions","organizations_url":"https://api.github.com/users/pkj415/orgs","repos_url":"https://api.github.com/users/pkj415/repos","events_url":"https://api.github.com/users/pkj415/events{/privacy}","received_events_url":"https://api.github.com/users/pkj415/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/27293/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/27293/timeline","performed_via_github_app":null,"state_reason":"completed"}