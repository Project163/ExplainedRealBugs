{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20667","repository_url":"https://api.github.com/repos/yugabyte/yugabyte-db","labels_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20667/labels{/name}","comments_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20667/comments","events_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20667/events","html_url":"https://github.com/yugabyte/yugabyte-db/issues/20667","id":2087034497,"node_id":"I_kwDOBlCVUc58ZZ6B","number":20667,"title":"[DocDB] Fix tablet guardrail mechanism and turn it on for universes with 16 GB or less per-node RAM","user":{"login":"mdbridge","id":15827795,"node_id":"MDQ6VXNlcjE1ODI3Nzk1","avatar_url":"https://avatars.githubusercontent.com/u/15827795?v=4","gravatar_id":"","url":"https://api.github.com/users/mdbridge","html_url":"https://github.com/mdbridge","followers_url":"https://api.github.com/users/mdbridge/followers","following_url":"https://api.github.com/users/mdbridge/following{/other_user}","gists_url":"https://api.github.com/users/mdbridge/gists{/gist_id}","starred_url":"https://api.github.com/users/mdbridge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdbridge/subscriptions","organizations_url":"https://api.github.com/users/mdbridge/orgs","repos_url":"https://api.github.com/users/mdbridge/repos","events_url":"https://api.github.com/users/mdbridge/events{/privacy}","received_events_url":"https://api.github.com/users/mdbridge/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":894667487,"node_id":"MDU6TGFiZWw4OTQ2Njc0ODc=","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/kind/new-feature","name":"kind/new-feature","color":"c2e0c6","default":false,"description":"This is a request for a completely new feature"},{"id":1290759928,"node_id":"MDU6TGFiZWwxMjkwNzU5OTI4","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/area/docdb","name":"area/docdb","color":"0c4fcc","default":false,"description":"YugabyteDB core features"},{"id":1419821900,"node_id":"MDU6TGFiZWwxNDE5ODIxOTAw","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/priority/medium","name":"priority/medium","color":"ffdc5e","default":false,"description":"Medium priority issue"}],"state":"closed","locked":false,"assignee":{"login":"mdbridge","id":15827795,"node_id":"MDQ6VXNlcjE1ODI3Nzk1","avatar_url":"https://avatars.githubusercontent.com/u/15827795?v=4","gravatar_id":"","url":"https://api.github.com/users/mdbridge","html_url":"https://github.com/mdbridge","followers_url":"https://api.github.com/users/mdbridge/followers","following_url":"https://api.github.com/users/mdbridge/following{/other_user}","gists_url":"https://api.github.com/users/mdbridge/gists{/gist_id}","starred_url":"https://api.github.com/users/mdbridge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdbridge/subscriptions","organizations_url":"https://api.github.com/users/mdbridge/orgs","repos_url":"https://api.github.com/users/mdbridge/repos","events_url":"https://api.github.com/users/mdbridge/events{/privacy}","received_events_url":"https://api.github.com/users/mdbridge/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"mdbridge","id":15827795,"node_id":"MDQ6VXNlcjE1ODI3Nzk1","avatar_url":"https://avatars.githubusercontent.com/u/15827795?v=4","gravatar_id":"","url":"https://api.github.com/users/mdbridge","html_url":"https://github.com/mdbridge","followers_url":"https://api.github.com/users/mdbridge/followers","following_url":"https://api.github.com/users/mdbridge/following{/other_user}","gists_url":"https://api.github.com/users/mdbridge/gists{/gist_id}","starred_url":"https://api.github.com/users/mdbridge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdbridge/subscriptions","organizations_url":"https://api.github.com/users/mdbridge/orgs","repos_url":"https://api.github.com/users/mdbridge/repos","events_url":"https://api.github.com/users/mdbridge/events{/privacy}","received_events_url":"https://api.github.com/users/mdbridge/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2024-01-17T21:41:17Z","updated_at":"2024-02-22T22:57:24Z","closed_at":"2024-02-09T16:43:01Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Jira Link: [DB-9663](https://yugabyte.atlassian.net/browse/DB-9663)\r\n### Description\n\nWe built a guardrail mechanism to limit the number of tablets users can create -- see https://github.com/yugabyte/yugabyte-db/issues/16177.\r\n\r\nHowever, it is currently broken and cannot be safely used because it requires setting a limit for the per tablet overhead memory tracker, which would cause issues because:\r\n  * the memory tracker hierarchy under per-tablet-overhead is incorrect, containing MemTable trackers, which are not per tablet, and failing to contain untracked memory, which is almost all per tablet overhead\r\n  * the current code for checking for memory pressure double counts soft memory limit checks at every level of the memory hierarchy that has a limit\r\n  * we should not be enforcing a soft memory limit for any but the root memory tracker as the point of the soft memory limit is to absorb server-wide spikes not control individual memory components\r\n\r\nThis task is to work around this issue by temporarily making the Google flag:\r\n```\r\n~/code/yugabyte-db/src/yb/tserver/tablet_memory_manager.cc:55:\r\nDEFINE_NON_RUNTIME_int32(\r\n    tablet_overhead_size_percentage, 0,\r\n    \"Percentage of total available memory to use for tablet-related overheads. Default is 0, \"\r\n    \"meaning no limit. Must be between 0 and 100 inclusive.\");\r\n```\r\n*not* set a limit on the per-tablet overhead memory tracker.  This will make it possible to turn on this Google flag without running into the previous issues.  Other GitHub issues will address fixing these issues so that it will be possible to use the Google flag in the future to set a limit for that memory tracker.\r\n\r\nWe still need information on how much memory is available for per-tablet overhead for the guardrails; get that instead directly from the function that calculates what the limit would have been,\r\n```\r\n~/code/yugabyte-db/src/yb/tserver/tablet_memory_manager.cc:161:\r\nint64 ComputeTabletOverheadLimit() {\r\n  CHECK(0 <= FLAGS_tablet_overhead_size_percentage && FLAGS_tablet_overhead_size_percentage <= 100)\r\n      << Format(\r\n             \"Flag tablet_overhead_size_percentage must be between 0 and 100 inclusive. Current \"\r\n             \"value: $0\",\r\n             FLAGS_tablet_overhead_size_percentage);\r\n  if (0 == FLAGS_tablet_overhead_size_percentage) return -1;\r\n  return MemTracker::GetRootTracker()->limit() * FLAGS_tablet_overhead_size_percentage / 100;\r\n}\r\n```\r\n\r\n\r\nOnce the issues have been worked around, turn on the guardrail mechanism based on memory available for per-tablet overhead:\r\n```\r\n~/code/yugabyte-db/src/yb/master/tablet_limits.cc:23:\r\nDEFINE_RUNTIME_int32(tablet_replicas_per_gib_limit, 0,\r\n    \"The maximum number of tablets per GiB of RAM reserved by TServers for tablet overheads the \"\r\n    \"cluster can support. A non-positive number means no limit.\");\r\nTAG_FLAG(tablet_replicas_per_gib_limit, experimental);\r\n\r\nDEFINE_RUNTIME_int32(tablet_replicas_per_core_limit, 0,\r\n    \"The maximum number of tablets per vCPU available to TServer processes the cluster can \"\r\n    \"support. A non-positive number means no limit.\");\r\nTAG_FLAG(tablet_replicas_per_core_limit, experimental);\r\n```\r\nHere, set the first flag to 1024/0.7 for now (this is based on experiments).\r\n\r\nDiscussion is still pending whether to enable this feature via a auto flag that turns on for new universes or simply via a preview flag for now.  In either case, create a new boolean enable flag as it is advised to avoid integer auto flags; also it allows the customer to just turn the feature on without having to worry about what the default limits should be.\r\n\r\nBackport to 2.20.  Possibly the backport won't turn the feature on   unlike trunk.\r\n\r\n\r\nOther possibly useful code snippets:\r\n```\r\n~/code/yugabyte-db/src/yb/tserver/tablet_memory_manager.cc:181:\r\n  tablets_overhead_mem_tracker_ = MemTracker::FindOrCreateTracker(\r\n      ComputeTabletOverheadLimit(), \"Tablets_overhead\", server_mem_tracker_);\r\n```\r\n\r\n```\r\n~/code/yugabyte-db/src/yb/tserver/heartbeater.cc:403:\r\n    auto tracker =\r\n        server_->tablet_manager()->tablet_memory_manager()->tablets_overhead_mem_tracker();\r\n    // Only set the tablet overhead limit if the tablet overheads memory tracker exists and has a\r\n    // limit set.  The flag to set the memory tracker's limit is tablet_overhead_size_percentage.\r\n    if (tracker && tracker->has_limit()) {\r\n      resources->set_tablet_overhead_ram_in_bytes(tracker->limit());\r\n    }\r\n  }\r\n```\r\n\n\n### Issue Type\n\nkind/new-feature\n\n### Warning: Please confirm that this issue does not contain any sensitive information\n\n- [X] I confirm this issue does not contain any sensitive information.\n\n[DB-9663]: https://yugabyte.atlassian.net/browse/DB-9663?atlOrigin=eyJpIjoiNWRkNTljNzYxNjVmNDY3MDlhMDU5Y2ZhYzA5YTRkZjUiLCJwIjoiZ2l0aHViLWNvbS1KU1cifQ","closed_by":{"login":"mdbridge","id":15827795,"node_id":"MDQ6VXNlcjE1ODI3Nzk1","avatar_url":"https://avatars.githubusercontent.com/u/15827795?v=4","gravatar_id":"","url":"https://api.github.com/users/mdbridge","html_url":"https://github.com/mdbridge","followers_url":"https://api.github.com/users/mdbridge/followers","following_url":"https://api.github.com/users/mdbridge/following{/other_user}","gists_url":"https://api.github.com/users/mdbridge/gists{/gist_id}","starred_url":"https://api.github.com/users/mdbridge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdbridge/subscriptions","organizations_url":"https://api.github.com/users/mdbridge/orgs","repos_url":"https://api.github.com/users/mdbridge/repos","events_url":"https://api.github.com/users/mdbridge/events{/privacy}","received_events_url":"https://api.github.com/users/mdbridge/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20667/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20667/timeline","performed_via_github_app":null,"state_reason":"completed"}