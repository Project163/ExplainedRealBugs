{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/22800","repository_url":"https://api.github.com/repos/yugabyte/yugabyte-db","labels_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/22800/labels{/name}","comments_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/22800/comments","events_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/22800/events","html_url":"https://github.com/yugabyte/yugabyte-db/issues/22800","id":2344423663,"node_id":"I_kwDOBlCVUc6LvRDv","number":22800,"title":"[YSQL] ERROR:  not an integer type after turning off Nested Loop using CTE Insert","user":{"login":"knicely87","id":99351101,"node_id":"U_kgDOBev6PQ","avatar_url":"https://avatars.githubusercontent.com/u/99351101?v=4","gravatar_id":"","url":"https://api.github.com/users/knicely87","html_url":"https://github.com/knicely87","followers_url":"https://api.github.com/users/knicely87/followers","following_url":"https://api.github.com/users/knicely87/following{/other_user}","gists_url":"https://api.github.com/users/knicely87/gists{/gist_id}","starred_url":"https://api.github.com/users/knicely87/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/knicely87/subscriptions","organizations_url":"https://api.github.com/users/knicely87/orgs","repos_url":"https://api.github.com/users/knicely87/repos","events_url":"https://api.github.com/users/knicely87/events{/privacy}","received_events_url":"https://api.github.com/users/knicely87/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":711841622,"node_id":"MDU6TGFiZWw3MTE4NDE2MjI=","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/kind/bug","name":"kind/bug","color":"c2e0c6","default":false,"description":"This issue is a bug"},{"id":1280238232,"node_id":"MDU6TGFiZWwxMjgwMjM4MjMy","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/area/ysql","name":"area/ysql","color":"0c4fcc","default":false,"description":"Yugabyte SQL (YSQL)"},{"id":1419821900,"node_id":"MDU6TGFiZWwxNDE5ODIxOTAw","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/priority/medium","name":"priority/medium","color":"ffdc5e","default":false,"description":"Medium priority issue"}],"state":"closed","locked":false,"assignee":{"login":"tanujnay112","id":3924842,"node_id":"MDQ6VXNlcjM5MjQ4NDI=","avatar_url":"https://avatars.githubusercontent.com/u/3924842?v=4","gravatar_id":"","url":"https://api.github.com/users/tanujnay112","html_url":"https://github.com/tanujnay112","followers_url":"https://api.github.com/users/tanujnay112/followers","following_url":"https://api.github.com/users/tanujnay112/following{/other_user}","gists_url":"https://api.github.com/users/tanujnay112/gists{/gist_id}","starred_url":"https://api.github.com/users/tanujnay112/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tanujnay112/subscriptions","organizations_url":"https://api.github.com/users/tanujnay112/orgs","repos_url":"https://api.github.com/users/tanujnay112/repos","events_url":"https://api.github.com/users/tanujnay112/events{/privacy}","received_events_url":"https://api.github.com/users/tanujnay112/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"tanujnay112","id":3924842,"node_id":"MDQ6VXNlcjM5MjQ4NDI=","avatar_url":"https://avatars.githubusercontent.com/u/3924842?v=4","gravatar_id":"","url":"https://api.github.com/users/tanujnay112","html_url":"https://github.com/tanujnay112","followers_url":"https://api.github.com/users/tanujnay112/followers","following_url":"https://api.github.com/users/tanujnay112/following{/other_user}","gists_url":"https://api.github.com/users/tanujnay112/gists{/gist_id}","starred_url":"https://api.github.com/users/tanujnay112/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tanujnay112/subscriptions","organizations_url":"https://api.github.com/users/tanujnay112/orgs","repos_url":"https://api.github.com/users/tanujnay112/repos","events_url":"https://api.github.com/users/tanujnay112/events{/privacy}","received_events_url":"https://api.github.com/users/tanujnay112/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2024-06-10T17:05:27Z","updated_at":"2024-06-13T07:38:04Z","closed_at":"2024-06-13T07:38:04Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Jira Link: [DB-11701](https://yugabyte.atlassian.net/browse/DB-11701)\r\n### Description\r\n\r\nCurrently YB has a performance issue when using an INSERT ON CONFLICT and I am trying to use a work around via a CTE. Ideally I want the SQL to use BNL, but the optimizer is not choosing it, even if I provide a hint. That may be a separate issue, but I wanted to created this GH for a specific issue when after disabling nested loops (i.e. SET enable_nestloop = off;) an data type error is generated after running the INSERT.\r\n\r\nNote, this is happening in YB 2024.1.1 (Build 64).\r\n\r\n```\r\nyugabyte=# SELECT substring(version() from 'YB-([^\\s]+)') AS \"YugabyteDB Version\";\r\n YugabyteDB Version\r\n--------------------\r\n 2024.1.1.0-b0\r\n```\r\n\r\nHere is the table definition:\r\n\r\n```\r\nyugabyte=# \\d res_feat_ekey;\r\n                         Table \"public.res_feat_ekey\"\r\n    Column     |            Type             | Collation | Nullable | Default\r\n---------------+-----------------------------+-----------+----------+---------\r\n res_ent_id    | bigint                      |           | not null |\r\n eclass_id     | smallint                    |           | not null |\r\n lens_id       | smallint                    |           | not null |\r\n lib_feat_id   | bigint                      |           | not null |\r\n ftype_id      | smallint                    |           | not null |\r\n utype_code    | character varying(50)       |           | not null |\r\n suppressed    | character(1)                |           |          |\r\n used_from_dt  | timestamp without time zone |           |          |\r\n used_thru_dt  | timestamp without time zone |           |          |\r\n first_seen_dt | timestamp without time zone |           |          |\r\n last_seen_dt  | timestamp without time zone |           |          |\r\nIndexes:\r\n    \"res_feat_ekey_pkey\" PRIMARY KEY, lsm (lib_feat_id HASH, res_ent_id ASC, utype_code ASC)\r\n    \"res_feat_ekey_sk\" lsm (res_ent_id HASH)\r\n```\r\n    \r\nThis INSERT with a CTE works fine:\r\n\r\n```\r\nyugabyte=# EXPLAIN (ANALYZE, DIST, COSTS OFF)\r\nyugabyte-# WITH values_to_insert (RES_ENT_ID,LIB_FEAT_ID,LENS_ID,ECLASS_ID,FTYPE_ID,UTYPE_CODE,SUPPRESSED,USED_FROM_DT,USED_THRU_DT) AS (VALUES\r\nyugabyte(#        (-241,4443,1,1,9,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\nyugabyte(#        (-100133,2397,1,1,18,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\nyugabyte(#        (-302675,9124,1,1,18,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\nyugabyte(#        (-405051,3161,1,1,7,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\nyugabyte(#        (-500249,4620,1,1,18,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\nyugabyte(#        (-501913,5329,1,1,18,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\nyugabyte(#        (-307227,2399,1,1,18,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\nyugabyte(#        (-308441,4047,1,1,7,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\nyugabyte(#        (-407912,4869,1,1,18,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\nyugabyte(#        (-408441,4469,1,1,18,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\nyugabyte(#        (-506213,3596,1,1,22,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\nyugabyte(#        (-413921,2927,1,1,20,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP))\r\nyugabyte-#    , conflict AS (SELECT lib_feat_id, res_ent_id, utype_code FROM res_feat_ekey WHERE (lib_feat_id, res_ent_id, utype_code) IN (SELECT lib_feat_id, res_ent_id, utype_code FROM values_to_insert))\r\nyugabyte-#    INSERT INTO res_feat_ekey\r\nyugabyte-#     SELECT RES_ENT_ID,LIB_FEAT_ID,LENS_ID,ECLASS_ID,FTYPE_ID,UTYPE_CODE,SUPPRESSED,USED_FROM_DT::TIMESTAMP,USED_THRU_DT::TIMESTAMP FROM values_to_insert WHERE (lib_feat_id, res_ent_id, utype_code) NOT IN (SELECT lib_feat_id, res_ent_id, utype_code FROM conflict WHERE lib_feat_id IS NOT NULL);\r\n                                                                                       QUERY PLAN\r\n\r\n---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n-\r\n Insert on res_feat_ekey (actual time=2.496..2.496 rows=0 loops=1)\r\n   CTE values_to_insert\r\n     ->  Values Scan on \"*VALUES*\" (actual time=0.004..0.026 rows=12 loops=1)\r\n   CTE conflict\r\n     ->  Nested Loop (actual time=2.352..2.352 rows=0 loops=1)\r\n           ->  HashAggregate (actual time=0.034..0.040 rows=12 loops=1)\r\n                 Group Key: values_to_insert_1.lib_feat_id, values_to_insert_1.res_ent_id, values_to_insert_1.utype_code\r\n                 ->  CTE Scan on values_to_insert values_to_insert_1 (actual time=0.000..0.027 rows=12 loops=1)\r\n           ->  Index Scan using res_feat_ekey_pkey on res_feat_ekey res_feat_ekey_1 (actual time=0.187..0.187 rows=0 loops=12)\r\n                 Index Cond: ((lib_feat_id = values_to_insert_1.lib_feat_id) AND (res_ent_id = values_to_insert_1.res_ent_id) AND ((utype_code)::text = values_to_insert_1.utype_code))\r\n                 Storage Table Read Requests: 1\r\n                 Storage Table Read Execution Time: 0.168 ms\r\n   ->  CTE Scan on values_to_insert (actual time=2.368..2.373 rows=12 loops=1)\r\n         Filter: (NOT (hashed SubPlan 3))\r\n         Storage Table Write Requests: 12\r\n         Storage Index Write Requests: 12\r\n         SubPlan 3\r\n           ->  CTE Scan on conflict (actual time=2.352..2.352 rows=0 loops=1)\r\n                 Filter: (lib_feat_id IS NOT NULL)\r\n Planning Time: 0.307 ms\r\n Execution Time: 4.356 ms\r\n Storage Read Requests: 12\r\n Storage Read Execution Time: 2.014 ms\r\n Storage Rows Scanned: 0\r\n Storage Write Requests: 24\r\n Catalog Read Requests: 0\r\n Catalog Write Requests: 0\r\n Storage Flush Requests: 1\r\n Storage Flush Execution Time: 1.736 ms\r\n Storage Execution Time: 3.751 ms\r\n Peak Memory Usage: 168 kB\r\n(31 rows)\r\n```\r\n    \r\nBut this fails:\r\n\r\n```\r\nyugabyte=# DELETE FROM res_feat_ekey WHERE res_ent_id < 0;\r\nDELETE 12\r\n\r\nyugabyte=# SET enable_nestloop = off;\r\nSET\r\n\r\nyugabyte=# EXPLAIN (ANALYZE, DIST, COSTS OFF)\r\nWITH values_to_insert (RES_ENT_ID,LIB_FEAT_ID,LENS_ID,ECLASS_ID,FTYPE_ID,UTYPE_CODE,SUPPRESSED,USED_FROM_DT,USED_THRU_DT) AS (VALUES\r\n       (-241,4443,1,1,9,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\n       (-100133,2397,1,1,18,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\n       (-302675,9124,1,1,18,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\n       (-405051,3161,1,1,7,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\n       (-500249,4620,1,1,18,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\n       (-501913,5329,1,1,18,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\n       (-307227,2399,1,1,18,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\n       (-308441,4047,1,1,7,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\n       (-407912,4869,1,1,18,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\n       (-408441,4469,1,1,18,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\n       (-506213,3596,1,1,22,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP),\r\n       (-413921,2927,1,1,20,'','N', NULL::TIMESTAMP,NULL::TIMESTAMP))\r\n   , conflict AS (SELECT lib_feat_id, res_ent_id, utype_code FROM res_feat_ekey WHERE (lib_feat_id, res_ent_id, utype_code) IN (SELECT lib_feat_id, res_ent_id, utype_code FROM values_to_insert))\r\n   INSERT INTO res_feat_ekey\r\n    SELECT RES_ENT_ID,LIB_FEAT_ID,LENS_ID,ECLASS_ID,FTYPE_ID,UTYPE_CODE,SUPPRESSED,USED_FROM_DT::TIMESTAMP,USED_THRU_DT::TIMESTAMP FROM values_to_insert WHERE (lib_feat_id, res_ent_id, utype_code) NOT IN (SELECT lib_feat_id, res_ent_id, utype_code FROM conflict WHERE lib_feat_id IS NOT NULL);\r\nERROR:  not an integer type\r\n\r\nyugabyte=# \\errverbose\r\nERROR:  42804: not an integer type\r\nLOCATION:  YbIsIntegerInRange, yb_scan.c:1178\r\n```\r\n\r\nNote: It may have something to do wth the utype_code containing an empty string value:\r\n\r\n```\r\nyugabyte=# SELECT '*' || utype_code || '*' FROM res_feat_ekey WHERE utype_code = '' LIMIT 5;\r\n ?column?\r\n----------\r\n **\r\n **\r\n **\r\n **\r\n **\r\n(5 rows)\r\n\r\n\r\nyugabyte=# SELECT utype_code::INT FROM res_feat_ekey;\r\nERROR:  invalid input syntax for integer: \"\"\r\n```\r\n\r\nNote, we are using these GUC settings for this DB:\r\n\r\n```\r\nyugabyte=# SELECT name, setting FROM pg_settings WHERE name IN ('yb_enable_bitmapscan', 'yb_enable_base_scans_cost_model', 'yb_enable_optimizer_statistics', 'yb_bnl_batch_size', 'yb_fetch_row_limit', 'yb_fetch_size_limit', 'enable_bitmapscan', 'yb_prefer_bnl') ORDER BY 1;\r\n              name               | setting\r\n---------------------------------+---------\r\n enable_bitmapscan               | on\r\n yb_bnl_batch_size               | 1024\r\n yb_enable_base_scans_cost_model | on\r\n yb_enable_bitmapscan            | on\r\n yb_enable_optimizer_statistics  | on\r\n yb_fetch_row_limit              | 0\r\n yb_fetch_size_limit             | 1048576\r\n yb_prefer_bnl                   | on\r\n(8 rows)\r\n```\r\n\r\n### Issue Type\r\n\r\nkind/bug\r\n\r\n### Warning: Please confirm that this issue does not contain any sensitive information\r\n\r\n- [X] I confirm this issue does not contain any sensitive information.\r\n\r\n[DB-11701]: https://yugabyte.atlassian.net/browse/DB-11701?atlOrigin=eyJpIjoiNWRkNTljNzYxNjVmNDY3MDlhMDU5Y2ZhYzA5YTRkZjUiLCJwIjoiZ2l0aHViLWNvbS1KU1cifQ","closed_by":{"login":"tanujnay112","id":3924842,"node_id":"MDQ6VXNlcjM5MjQ4NDI=","avatar_url":"https://avatars.githubusercontent.com/u/3924842?v=4","gravatar_id":"","url":"https://api.github.com/users/tanujnay112","html_url":"https://github.com/tanujnay112","followers_url":"https://api.github.com/users/tanujnay112/followers","following_url":"https://api.github.com/users/tanujnay112/following{/other_user}","gists_url":"https://api.github.com/users/tanujnay112/gists{/gist_id}","starred_url":"https://api.github.com/users/tanujnay112/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tanujnay112/subscriptions","organizations_url":"https://api.github.com/users/tanujnay112/orgs","repos_url":"https://api.github.com/users/tanujnay112/repos","events_url":"https://api.github.com/users/tanujnay112/events{/privacy}","received_events_url":"https://api.github.com/users/tanujnay112/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/22800/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/22800/timeline","performed_via_github_app":null,"state_reason":"completed"}