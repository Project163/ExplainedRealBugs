{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/24547","repository_url":"https://api.github.com/repos/yugabyte/yugabyte-db","labels_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/24547/labels{/name}","comments_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/24547/comments","events_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/24547/events","html_url":"https://github.com/yugabyte/yugabyte-db/issues/24547","id":2603558300,"node_id":"I_kwDOBlCVUc6bLyWc","number":24547,"title":"[DocDB] fix flaky test AutoMode/XClusterOutboundReplicationGroupMockedParameterized.AddDeleteNamespaces/0","user":{"login":"mdbridge","id":15827795,"node_id":"MDQ6VXNlcjE1ODI3Nzk1","avatar_url":"https://avatars.githubusercontent.com/u/15827795?v=4","gravatar_id":"","url":"https://api.github.com/users/mdbridge","html_url":"https://github.com/mdbridge","followers_url":"https://api.github.com/users/mdbridge/followers","following_url":"https://api.github.com/users/mdbridge/following{/other_user}","gists_url":"https://api.github.com/users/mdbridge/gists{/gist_id}","starred_url":"https://api.github.com/users/mdbridge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdbridge/subscriptions","organizations_url":"https://api.github.com/users/mdbridge/orgs","repos_url":"https://api.github.com/users/mdbridge/repos","events_url":"https://api.github.com/users/mdbridge/events{/privacy}","received_events_url":"https://api.github.com/users/mdbridge/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":711841622,"node_id":"MDU6TGFiZWw3MTE4NDE2MjI=","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/kind/bug","name":"kind/bug","color":"c2e0c6","default":false,"description":"This issue is a bug"},{"id":1281039316,"node_id":"MDU6TGFiZWwxMjgxMDM5MzE2","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/kind/failing-test","name":"kind/failing-test","color":"c2e0c6","default":false,"description":"Tests and testing infra"},{"id":1290759928,"node_id":"MDU6TGFiZWwxMjkwNzU5OTI4","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/area/docdb","name":"area/docdb","color":"0c4fcc","default":false,"description":"YugabyteDB core features"},{"id":1419821900,"node_id":"MDU6TGFiZWwxNDE5ODIxOTAw","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/priority/medium","name":"priority/medium","color":"ffdc5e","default":false,"description":"Medium priority issue"}],"state":"closed","locked":false,"assignee":{"login":"hari90","id":12418230,"node_id":"MDQ6VXNlcjEyNDE4MjMw","avatar_url":"https://avatars.githubusercontent.com/u/12418230?v=4","gravatar_id":"","url":"https://api.github.com/users/hari90","html_url":"https://github.com/hari90","followers_url":"https://api.github.com/users/hari90/followers","following_url":"https://api.github.com/users/hari90/following{/other_user}","gists_url":"https://api.github.com/users/hari90/gists{/gist_id}","starred_url":"https://api.github.com/users/hari90/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hari90/subscriptions","organizations_url":"https://api.github.com/users/hari90/orgs","repos_url":"https://api.github.com/users/hari90/repos","events_url":"https://api.github.com/users/hari90/events{/privacy}","received_events_url":"https://api.github.com/users/hari90/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"hari90","id":12418230,"node_id":"MDQ6VXNlcjEyNDE4MjMw","avatar_url":"https://avatars.githubusercontent.com/u/12418230?v=4","gravatar_id":"","url":"https://api.github.com/users/hari90","html_url":"https://github.com/hari90","followers_url":"https://api.github.com/users/hari90/followers","following_url":"https://api.github.com/users/hari90/following{/other_user}","gists_url":"https://api.github.com/users/hari90/gists{/gist_id}","starred_url":"https://api.github.com/users/hari90/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hari90/subscriptions","organizations_url":"https://api.github.com/users/hari90/orgs","repos_url":"https://api.github.com/users/hari90/repos","events_url":"https://api.github.com/users/hari90/events{/privacy}","received_events_url":"https://api.github.com/users/hari90/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2024-10-21T20:10:04Z","updated_at":"2025-05-28T21:24:57Z","closed_at":"2024-10-22T01:19:08Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Jira Link: [DB-13581](https://yugabyte.atlassian.net/browse/DB-13581)\r\n### Description\n\nThis seems to occasionally fail on mac (multiple build types involving mac).\r\n\r\nThe relevant logs are:\r\n```\r\nI1020 19:02:24.926267 47161600 xcluster_outbound_replication_group-test.cc:166] Test uses automatic mode: 1\r\nW1020 19:02:24.926344 47161600 catalog_entity_info.cc:983] Not PGSQL IDs db1_id, table_id_1\r\nW1020 19:02:24.926390 47161600 catalog_entity_info.cc:983] Not PGSQL IDs db1_id, table_id_2\r\nW1020 19:02:24.926410 47161600 catalog_entity_info.cc:983] Not PGSQL IDs ns_id_2, ns2_table_id_1\r\nW1020 19:02:24.926427 47161600 catalog_entity_info.cc:983] Not PGSQL IDs ns_id_2, ns2_table_id_2\r\nI1020 19:02:24.926489 47161600 catalog_entity_base.h:96] vlog2: Load: Loading 18 data: automatic_ddl_mode: true\r\nI1020 19:02:24.927690 47161600 xcluster_outbound_replication_group.cc:441] vlog1: xClusterOutboundReplicationGroup rg1 :AddNamespaceInternal: db1_id\r\nW1020 19:02:24.927719 47161600 catalog_entity_info.cc:983] Not PGSQL IDs db1_id, table_id_1\r\nW1020 19:02:24.927733 47161600 catalog_entity_info.cc:983] Not PGSQL IDs db1_id, table_id_2\r\nI1020 19:02:24.927769 47161600 xcluster_outbound_replication_group.cc:354] vlog1: xClusterOutboundReplicationGroup rg1 :CreateNamespaceInfo: Tables: [public.table1 [id=table_id_1], public.table2 [id=table_id_2]]\r\nI1020 19:02:24.927824 47161600 multi_step_monitored_task.cc:31] XClusterCheckpointNamespaceTask [rg1]: Starting task 0x109b88b78\r\nI1020 19:02:24.927840 47161600 multi_step_monitored_task.cc:150] vlog1: XClusterCheckpointNamespaceTask [rg1]: Scheduling FirstStep on async task pool\r\nI1020 19:02:24.928014 47161600 thread.cc:838] vlog2: Started thread 2434324 - thread pool:Test [worker]xx\r\nI1020 19:02:24.928192 1876324352 multi_step_monitored_task.cc:194] vlog1: XClusterCheckpointNamespaceTask [rg1]: Running FirstStep\r\nW1020 19:02:24.928265 1876324352 catalog_entity_info.cc:983] Not PGSQL IDs db1_id, ddl_queue\r\nI1020 19:02:24.928279 47161600 xcluster_outbound_replication_group.cc:441] vlog1: xClusterOutboundReplicationGroup rg1 :AddNamespaceInternal: ns_id_2\r\nI1020 19:12:23.958050 1864429568 run-with-timeout.cc:185] Reaper thread: finished=0, subprocess_is_running=1, timeout_sec=601\r\nE1020 19:12:23.958081 1864429568 run-with-timeout.cc:58] Timeout reached, trying to stop the child process with SIGQUIT\r\nE1020 19:12:54.086414 1864429568 run-with-timeout.cc:58] Timeout reached, trying to stop the child process with SIGSEGV\r\n*** Aborted at 1729451574 (unix time) try \"date -d @1729451574\" if you are using GNU date ***\r\nPC: @                0x0 _MergedGlobals\r\n*** SIGSEGV (@0x0) received by PID 12522 (TID 0x202cfa100) stack trace: ***\r\n    @        0x1a75caa24 _sigtramp\r\n    @        0x1a759c574 _pthread_cond_wait\r\n    @        0x1a74c4ef0 std::condition_variable::wait()\r\n    @        0x1a74cabc4 std::__shared_mutex_base::lock()\r\n    @        0x1005dbe90 _ZNK2yb6master42XClusterOutboundReplicationGroupMockedTest16helper_functionsMUlRKNSt3__112basic_stringIcNS2_11char_traitsIcEENS2_9allocatorIcEEEEbE_clESA_b\r\n    @        0x1005dbd04 _ZNSt3__110__function6__funcIN2yb6master42XClusterOutboundReplicationGroupMockedTest16helper_functionsMUlRKNS_12basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEEbE_ENS8_ISD_EEFNS2_6ResultINS_6vectorINS3_15TableDesignatorENS8_ISH_EEEEEESC_bEEclESC_Ob\r\n    @        0x10219e2e4 yb::master::XClusterOutboundReplicationGroup::CreateNamespaceInfo()\r\n    @        0x10219f6b8 yb::master::XClusterOutboundReplicationGroup::AddNamespaceInternal()\r\n    @        0x1021a00e4 yb::master::XClusterOutboundReplicationGroup::AddNamespace()\r\n```\r\n\r\nI ran this 10 times on Ubuntu and could not get it to fail.\r\n\r\nSeems like it is stuck in the call to get tables function:\r\n```\r\n~/code/yugabyte-db/src/yb/master/xcluster/xcluster_outbound_replication_group.cc:348:\r\nResult<XClusterOutboundReplicationGroup::NamespaceInfoPB>\r\nXClusterOutboundReplicationGroup::CreateNamespaceInfo(\r\n    const NamespaceId& namespace_id, const LeaderEpoch& epoch) {\r\n  auto table_designators = VERIFY_RESULT(helper_functions_.get_tables_func(\r\n      namespace_id, /*include_sequences_data=*/(\r\n          AutomaticDDLMode() && FLAGS_TEST_xcluster_enable_sequence_replication)));\r\n  VLOG_WITH_PREFIX_AND_FUNC(1) << \"Tables: \" << yb::ToString(table_designators);\r\n```\r\n\r\n```\r\n~/code/yugabyte-db/src/yb/master/xcluster/xcluster_outbound_replication_group-test.cc:313:\r\n      .get_tables_func =\r\n          [this](const NamespaceId& namespace_id, bool include_sequences_data) {\r\n            std::lock_guard l(mutex_);\r\n            auto tables = namespace_tables[namespace_id];\r\n            std::vector<TableDesignator> table_designators;\r\n            for (const auto& table_info : tables) {\r\n              if (IsTableEligibleForXClusterReplication(*table_info)) {\r\n                table_designators.emplace_back(table_info);\r\n              }\r\n            }\r\n            if (include_sequences_data) {\r\n              auto sequences_tables = namespace_tables[kPgSequencesDataNamespaceId];\r\n              if (sequences_tables.size() > 0) {\r\n                table_designators.emplace_back(TableDesignator::CreateSequenceTableDesignator(\r\n                    sequences_tables.front(), namespace_id));\r\n              }\r\n            }\r\n            return table_designators;\r\n          },\r\n```\r\n\r\nI would guess this is due to a deadlock with the mutex acquisition below:\r\n```\r\n~/code/yugabyte-db/src/yb/master/xcluster/xcluster_outbound_replication_group-test.cc:233:\r\n  Result<TableInfoPtr> CreateTable(\r\n      const NamespaceId& namespace_id, const TableId& table_id, const TableName& table_name,\r\n      const PgSchemaName& pg_schema_name) {\r\n    SCHECK_FORMAT(\r\n        !TableExists(namespace_id, table_id), AlreadyPresent,\r\n        \"Table $0 already exists in namespace $1\", table_id, namespace_id);\r\n\r\n    auto table_info = TableInfoPtr(new TableInfo(table_id, /*colocated=*/false));\r\n    {\r\n      auto l = table_info->LockForWrite();\r\n      auto& pb = l.mutable_data()->pb;\r\n      pb.set_state(master::SysTablesEntryPB::PREPARING);\r\n      pb.set_name(table_name);\r\n      pb.set_namespace_id(namespace_id);\r\n      pb.mutable_schema()->set_pgschema_name(pg_schema_name);\r\n      pb.set_table_type(PGSQL_TABLE_TYPE);\r\n      l.Commit();\r\n    }\r\n\r\n    std::lock_guard l2(mutex_);\r\n    namespace_tables[namespace_id].push_back(table_info);\r\n\r\n    if (IsTableEligibleForXClusterReplication(*table_info)) {\r\n      RETURN_NOT_OK(AddTableToXClusterSourceTask(*table_info));\r\n```\r\n\n\n### Issue Type\n\nkind/bug\n\n### Warning: Please confirm that this issue does not contain any sensitive information\n\n- [X] I confirm this issue does not contain any sensitive information.\n\n[DB-13581]: https://yugabyte.atlassian.net/browse/DB-13581?atlOrigin=eyJpIjoiNWRkNTljNzYxNjVmNDY3MDlhMDU5Y2ZhYzA5YTRkZjUiLCJwIjoiZ2l0aHViLWNvbS1KU1cifQ","closed_by":{"login":"hari90","id":12418230,"node_id":"MDQ6VXNlcjEyNDE4MjMw","avatar_url":"https://avatars.githubusercontent.com/u/12418230?v=4","gravatar_id":"","url":"https://api.github.com/users/hari90","html_url":"https://github.com/hari90","followers_url":"https://api.github.com/users/hari90/followers","following_url":"https://api.github.com/users/hari90/following{/other_user}","gists_url":"https://api.github.com/users/hari90/gists{/gist_id}","starred_url":"https://api.github.com/users/hari90/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hari90/subscriptions","organizations_url":"https://api.github.com/users/hari90/orgs","repos_url":"https://api.github.com/users/hari90/repos","events_url":"https://api.github.com/users/hari90/events{/privacy}","received_events_url":"https://api.github.com/users/hari90/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/24547/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/24547/timeline","performed_via_github_app":null,"state_reason":"completed"}