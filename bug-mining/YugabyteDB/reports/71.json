{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/22101","repository_url":"https://api.github.com/repos/yugabyte/yugabyte-db","labels_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/22101/labels{/name}","comments_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/22101/comments","events_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/22101/events","html_url":"https://github.com/yugabyte/yugabyte-db/issues/22101","id":2257614945,"node_id":"I_kwDOBlCVUc6GkHhh","number":22101,"title":"[DocDB] e6bb62ab80a9c419df8a2807e2fe182cd2d7aa58/D34307 introduced a TSAN race","user":{"login":"hari90","id":12418230,"node_id":"MDQ6VXNlcjEyNDE4MjMw","avatar_url":"https://avatars.githubusercontent.com/u/12418230?v=4","gravatar_id":"","url":"https://api.github.com/users/hari90","html_url":"https://github.com/hari90","followers_url":"https://api.github.com/users/hari90/followers","following_url":"https://api.github.com/users/hari90/following{/other_user}","gists_url":"https://api.github.com/users/hari90/gists{/gist_id}","starred_url":"https://api.github.com/users/hari90/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hari90/subscriptions","organizations_url":"https://api.github.com/users/hari90/orgs","repos_url":"https://api.github.com/users/hari90/repos","events_url":"https://api.github.com/users/hari90/events{/privacy}","received_events_url":"https://api.github.com/users/hari90/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":711841624,"node_id":"MDU6TGFiZWw3MTE4NDE2MjQ=","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/kind/enhancement","name":"kind/enhancement","color":"c2e0c6","default":false,"description":"This is an enhancement of an existing feature"},{"id":1281039316,"node_id":"MDU6TGFiZWwxMjgxMDM5MzE2","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/kind/failing-test","name":"kind/failing-test","color":"c2e0c6","default":false,"description":"Tests and testing infra"},{"id":1290759928,"node_id":"MDU6TGFiZWwxMjkwNzU5OTI4","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/area/docdb","name":"area/docdb","color":"0c4fcc","default":false,"description":"YugabyteDB core features"},{"id":1419821900,"node_id":"MDU6TGFiZWwxNDE5ODIxOTAw","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/priority/medium","name":"priority/medium","color":"ffdc5e","default":false,"description":"Medium priority issue"}],"state":"closed","locked":false,"assignee":{"login":"hari90","id":12418230,"node_id":"MDQ6VXNlcjEyNDE4MjMw","avatar_url":"https://avatars.githubusercontent.com/u/12418230?v=4","gravatar_id":"","url":"https://api.github.com/users/hari90","html_url":"https://github.com/hari90","followers_url":"https://api.github.com/users/hari90/followers","following_url":"https://api.github.com/users/hari90/following{/other_user}","gists_url":"https://api.github.com/users/hari90/gists{/gist_id}","starred_url":"https://api.github.com/users/hari90/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hari90/subscriptions","organizations_url":"https://api.github.com/users/hari90/orgs","repos_url":"https://api.github.com/users/hari90/repos","events_url":"https://api.github.com/users/hari90/events{/privacy}","received_events_url":"https://api.github.com/users/hari90/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"hari90","id":12418230,"node_id":"MDQ6VXNlcjEyNDE4MjMw","avatar_url":"https://avatars.githubusercontent.com/u/12418230?v=4","gravatar_id":"","url":"https://api.github.com/users/hari90","html_url":"https://github.com/hari90","followers_url":"https://api.github.com/users/hari90/followers","following_url":"https://api.github.com/users/hari90/following{/other_user}","gists_url":"https://api.github.com/users/hari90/gists{/gist_id}","starred_url":"https://api.github.com/users/hari90/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hari90/subscriptions","organizations_url":"https://api.github.com/users/hari90/orgs","repos_url":"https://api.github.com/users/hari90/repos","events_url":"https://api.github.com/users/hari90/events{/privacy}","received_events_url":"https://api.github.com/users/hari90/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2024-04-22T23:15:51Z","updated_at":"2025-05-28T21:26:01Z","closed_at":"2024-04-22T23:35:29Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Jira Link: [DB-11034](https://yugabyte.atlassian.net/browse/DB-11034)\r\n### Description\n\n==================\r\nWARNING: ThreadSanitizer: data race (pid=685702)\r\n  Write of size 4 at 0x7b6000005328 by main thread:\r\n    #0 boost::asio::ip::address::operator=(boost::asio::ip::address const&) ${YB_THIRDPARTY_DIR}/installed/tsan/include/boost/asio/ip/impl/address.ipp:74:9 (libserver_process.so+0x9415f)\r\n    #1 yb::rpc::Messenger::TEST_SetOutboundIpBase(boost::asio::ip::address const&) ${YB_SRC_ROOT}/src/yb/rpc/messenger.h:299:28 (libserver_process.so+0x9415f)\r\n    #2 yb::server::TEST_SetupConnectivity(yb::rpc::Messenger*, unsigned long) ${YB_SRC_ROOT}/src/yb/server/server_base.cc:779:14 (libserver_process.so+0x9415f)\r\n    #3 yb::tserver::MiniTabletServer::Reconnect() ${YB_SRC_ROOT}/src/yb/tserver/mini_tablet_server.cc:163:3 (libtserver_test_util.so+0x24eb4)\r\n    #4 yb::tserver::MiniTabletServer::Start(yb::StronglyTypedBool<yb::tserver::WaitTabletsBootstrapped_Tag>) ${YB_SRC_ROOT}/src/yb/tserver/mini_tablet_server.cc:149:3 (libtserver_test_util.so+0x24c58)\r\n    #5 yb::MiniCluster::AddTabletServer(yb::tserver::TabletServerOptions const&) ${YB_SRC_ROOT}/src/yb/integration-tests/mini_cluster.cc:387:3 (libintegration-tests.so+0x19b8df)\r\n    #6 yb::MiniCluster::AddTabletServer() ${YB_SRC_ROOT}/src/yb/integration-tests/mini_cluster.cc:396:10 (libintegration-tests.so+0x19bc80)\r\n    #7 yb::MiniCluster::StartAsync(std::vector<yb::tserver::TabletServerOptions, std::allocator<yb::tserver::TabletServerOptions>> const&) ${YB_SRC_ROOT}/src/yb/integration-tests/mini_cluster.cc:228:9 (libintegration-tests.so+0x1986ab)\r\n    #8 yb::MiniCluster::Start(std::vector<yb::tserver::TabletServerOptions, std::allocator<yb::tserver::TabletServerOptions>> const&) ${YB_SRC_ROOT}/src/yb/integration-tests/mini_cluster.cc:309:3 (libintegration-tests.so+0x19bfda)\r\n    #9 yb::client::ClientTest::SetUp() ${YB_SRC_ROOT}/src/yb/client/client-test.cc:198:5 (client-test+0x1cecc3)\r\n    #10 void testing::internal::HandleSehExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) ${YB_THIRDPARTY_DIR}/src/googletest-1.12.1/googletest/src/gtest.cc:2599:10 (libgtest.so.1.12.1+0x894f9)\r\n    #11 void testing::internal::HandleExceptionsInMethodIfSupported<testing::Test, void>(testing::Test*, void (testing::Test::*)(), char const*) ${YB_THIRDPARTY_DIR}/src/googletest-1.12.1/googletest/src/gtest.cc:2635:14 (libgtest.so.1.12.1+0x894f9)\r\n    #12 testing::Test::Run() ${YB_THIRDPARTY_DIR}/src/googletest-1.12.1/googletest/src/gtest.cc:2669:3 (libgtest.so.1.12.1+0x611b7)\r\n    #13 testing::TestInfo::Run() ${YB_THIRDPARTY_DIR}/src/googletest-1.12.1/googletest/src/gtest.cc:2853:11 (libgtest.so.1.12.1+0x62a05)\r\n    #14 testing::TestSuite::Run() ${YB_THIRDPARTY_DIR}/src/googletest-1.12.1/googletest/src/gtest.cc:3012:30 (libgtest.so.1.12.1+0x63f04)\r\n    #15 testing::internal::UnitTestImpl::RunAllTests() ${YB_THIRDPARTY_DIR}/src/googletest-1.12.1/googletest/src/gtest.cc:5870:44 (libgtest.so.1.12.1+0x7be3d)\r\n    #16 bool testing::internal::HandleSehExceptionsInMethodIfSupported<testing::internal::UnitTestImpl, bool>(testing::internal::UnitTestImpl*, bool (testing::internal::UnitTestImpl::*)(), char const*) ${YB_THIRDPARTY_DIR}/src/googletest-1.12.1/googletest/src/gtest.cc:2599:10 (libgtest.so.1.12.1+0x8a7cd)\r\n    #17 bool testing::internal::HandleExceptionsInMethodIfSupported<testing::internal::UnitTestImpl, bool>(testing::internal::UnitTestImpl*, bool (testing::internal::UnitTestImpl::*)(), char const*) ${YB_THIRDPARTY_DIR}/src/googletest-1.12.1/googletest/src/gtest.cc:2635:14 (libgtest.so.1.12.1+0x8a7cd)\r\n    #18 testing::UnitTest::Run() ${YB_THIRDPARTY_DIR}/src/googletest-1.12.1/googletest/src/gtest.cc:5444:10 (libgtest.so.1.12.1+0x7b5bd)\r\n    #19 RUN_ALL_TESTS() ${YB_THIRDPARTY_DIR}/installed/tsan/include/gtest/gtest.h:2293:73 (libyb_test_main.so+0x49e9)\r\n    #20 main ${YB_SRC_ROOT}/src/yb/util/test_main.cc:110:13 (libyb_test_main.so+0x49e9)\r\n\r\n  Previous read of size 4 at 0x7b6000005328 by thread T150:\r\n    #0 boost::asio::ip::address::is_unspecified() const ${YB_THIRDPARTY_DIR}/installed/tsan/include/boost/asio/ip/impl/address.ipp:203:11 (libyrpc.so+0x141107)\r\n    #1 yb::rpc::Reactor::FindOrStartConnection(yb::rpc::ConnectionId const&, string const&, std::shared_ptr<yb::rpc::Connection>*) ${YB_SRC_ROOT}/src/yb/rpc/reactor.cc:760:42 (libyrpc.so+0x141107)\r\n    #2 yb::rpc::Reactor::AssignOutboundCall(std::shared_ptr<yb::rpc::OutboundCall> const&) ${YB_SRC_ROOT}/src/yb/rpc/reactor.cc:560:14 (libyrpc.so+0x140738)\r\n    #3 yb::rpc::Reactor::ProcessOutboundQueue() ${YB_SRC_ROOT}/src/yb/rpc/reactor.cc:903:17 (libyrpc.so+0x13990b)\r\n    #4 decltype(*std::declval<yb::rpc::Reactor*&>().*std::declval<void (yb::rpc::Reactor::*&)()>()()) std::__invoke[abi:v170002]<void (yb::rpc::Reactor::*&)(), yb::rpc::Reactor*&, void>(void (yb::rpc::Reactor::*&)(), yb::rpc::Reactor*&) ${YB_THIRDPARTY_DIR}/installed/tsan/libcxx/include/c++/v1/__type_traits/invoke.h:308:25 (libyrpc.so+0x14df6b)\r\n    #5 std::__bind_return<void (yb::rpc::Reactor::*)(), std::tuple<yb::rpc::Reactor*>, std::tuple<yb::rpc::Reactor*&>, __is_valid_bind_return<void (yb::rpc::Reactor::*)(), std::tuple<yb::rpc::Reactor*>, std::tuple<yb::rpc::Reactor*&>>::value>::type std::__apply_functor[abi:v170002]<void (yb::rpc::Reactor::*)(), std::tuple<yb::rpc::Reactor*>, 0ul, std::tuple<yb::rpc::Reactor*&>>(void (yb::rpc::Reactor::*&)(), std::tuple<yb::rpc::Reactor*>&, std::__tuple_indices<0ul>, std::tuple<yb::rpc::Reactor*&>&&) ${YB_THIRDPARTY_DIR}/installed/tsan/libcxx/include/c++/v1/__functional/bind.h:260:12 (libyrpc.so+0x14df6b)\r\n    #6 std::__bind_return<void (yb::rpc::Reactor::*)(), std::tuple<yb::rpc::Reactor*>, std::tuple<yb::rpc::Reactor*&>, __is_valid_bind_return<void (yb::rpc::Reactor::*)(), std::tuple<yb::rpc::Reactor*>, std::tuple<yb::rpc::Reactor*&>>::value>::type std::__bind<void (yb::rpc::Reactor::*)(), yb::rpc::Reactor*>::operator()[abi:v170002]<yb::rpc::Reactor*&>(yb::rpc::Reactor*&) ${YB_THIRDPARTY_DIR}/installed/tsan/libcxx/include/c++/v1/__functional/bind.h:292:20 (libyrpc.so+0x14df6b)\r\n    #7 yb::rpc::FunctorReactorTask<std::__bind<void (yb::rpc::Reactor::*)(), yb::rpc::Reactor*>>::Run(yb::rpc::Reactor*) ${YB_SRC_ROOT}/src/yb/rpc/reactor_task.h:92:5 (libyrpc.so+0x14df6b)\r\n    #8 yb::rpc::Reactor::AsyncHandler(ev::async&, int) ${YB_SRC_ROOT}/src/yb/rpc/reactor.cc:545:11 (libyrpc.so+0x14014d)\r\n    #9 void ev::base<ev_async, ev::async>::method_thunk<yb::rpc::Reactor, &yb::rpc::Reactor::AsyncHandler(ev::async&, int)>(ev_loop*, ev_async*, int) ${YB_THIRDPARTY_DIR}/installed/common/include/ev++.h:479:7 (libyrpc.so+0x14eac8)\r\n    #10 ev_invoke_pending <null> (libev.so.4+0x871a)\r\n    #11 decltype(*std::declval<yb::rpc::Reactor*&>().*std::declval<void (yb::rpc::Reactor::*&)()>()()) std::__invoke[abi:v170002]<void (yb::rpc::Reactor::*&)(), yb::rpc::Reactor*&, void>(void (yb::rpc::Reactor::*&)(), yb::rpc::Reactor*&) ${YB_THIRDPARTY_DIR}/installed/tsan/libcxx/include/c++/v1/__type_traits/invoke.h:308:25 (libyrpc.so+0x14eceb)\r\n    #12 std::__bind_return<void (yb::rpc::Reactor::*)(), std::tuple<yb::rpc::Reactor*>, std::tuple<>, __is_valid_bind_return<void (yb::rpc::Reactor::*)(), std::tuple<yb::rpc::Reactor*>, std::tuple<>>::value>::type std::__apply_functor[abi:v170002]<void (yb::rpc::Reactor::*)(), std::tuple<yb::rpc::Reactor*>, 0ul, std::tuple<>>(void (yb::rpc::Reactor::*&)(), std::tuple<yb::rpc::Reactor*>&, std::__tuple_indices<0ul>, std::tuple<>&&) ${YB_THIRDPARTY_DIR}/installed/tsan/libcxx/include/c++/v1/__functional/bind.h:260:12 (libyrpc.so+0x14eceb)\r\n    #13 std::__bind_return<void (yb::rpc::Reactor::*)(), std::tuple<yb::rpc::Reactor*>, std::tuple<>, __is_valid_bind_return<void (yb::rpc::Reactor::*)(), std::tuple<yb::rpc::Reactor*>, std::tuple<>>::value>::type std::__bind<void (yb::rpc::Reactor::* const&)(), yb::rpc::Reactor* const&>::operator()[abi:v170002]<>() ${YB_THIRDPARTY_DIR}/installed/tsan/libcxx/include/c++/v1/__functional/bind.h:292:20 (libyrpc.so+0x14eceb)\r\n    #14 decltype(std::declval<std::__bind<void (yb::rpc::Reactor::* const&)(), yb::rpc::Reactor* const&>&>()()) std::__invoke[abi:v170002]<std::__bind<void (yb::rpc::Reactor::* const&)(), yb::rpc::Reactor* const&>&>(std::__bind<void (yb::rpc::Reactor::* const&)(), yb::rpc::Reactor* const&>&) ${YB_THIRDPARTY_DIR}/installed/tsan/libcxx/include/c++/v1/__type_traits/invoke.h:340:25 (libyrpc.so+0x14eceb)\r\n    #15 void std::__invoke_void_return_wrapper<void, true>::__call[abi:v170002]<std::__bind<void (yb::rpc::Reactor::* const&)(), yb::rpc::Reactor* const&>&>(std::__bind<void (yb::rpc::Reactor::* const&)(), yb::rpc::Reactor* const&>&) ${YB_THIRDPARTY_DIR}/installed/tsan/libcxx/include/c++/v1/__type_traits/invoke.h:415:5 (libyrpc.so+0x14eceb)\r\n    #16 std::__function::__alloc_func<std::__bind<void (yb::rpc::Reactor::* const&)(), yb::rpc::Reactor* const&>, std::allocator<std::__bind<void (yb::rpc::Reactor::* const&)(), yb::rpc::Reactor* const&>>, void ()>::operator()[abi:v170002]() ${YB_THIRDPARTY_DIR}/installed/tsan/libcxx/include/c++/v1/__functional/function.h:192:16 (libyrpc.so+0x14eceb)\r\n    #17 std::__function::__func<std::__bind<void (yb::rpc::Reactor::* const&)(), yb::rpc::Reactor* const&>, std::allocator<std::__bind<void (yb::rpc::Reactor::* const&)(), yb::rpc::Reactor* const&>>, void ()>::operator()() ${YB_THIRDPARTY_DIR}/installed/tsan/libcxx/include/c++/v1/__functional/function.h:363:12 (libyrpc.so+0x14eceb)\r\n    #18 std::__function::__value_func<void ()>::operator()[abi:v170002]() const ${YB_THIRDPARTY_DIR}/installed/tsan/libcxx/include/c++/v1/__functional/function.h:517:16 (libyb_util.so+0x41720f)\r\n    #19 std::function<void ()>::operator()() const ${YB_THIRDPARTY_DIR}/installed/tsan/libcxx/include/c++/v1/__functional/function.h:1168:12 (libyb_util.so+0x41720f)\r\n    #20 yb::Thread::SuperviseThread(void*) ${YB_SRC_ROOT}/src/yb/util/thread.cc:866:3 (libyb_util.so+0x41720f)\r\n\n\n### Issue Type\n\nkind/failing-test\n\n### Warning: Please confirm that this issue does not contain any sensitive information\n\n- [X] I confirm this issue does not contain any sensitive information.\n\n[DB-11034]: https://yugabyte.atlassian.net/browse/DB-11034?atlOrigin=eyJpIjoiNWRkNTljNzYxNjVmNDY3MDlhMDU5Y2ZhYzA5YTRkZjUiLCJwIjoiZ2l0aHViLWNvbS1KU1cifQ","closed_by":{"login":"hari90","id":12418230,"node_id":"MDQ6VXNlcjEyNDE4MjMw","avatar_url":"https://avatars.githubusercontent.com/u/12418230?v=4","gravatar_id":"","url":"https://api.github.com/users/hari90","html_url":"https://github.com/hari90","followers_url":"https://api.github.com/users/hari90/followers","following_url":"https://api.github.com/users/hari90/following{/other_user}","gists_url":"https://api.github.com/users/hari90/gists{/gist_id}","starred_url":"https://api.github.com/users/hari90/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hari90/subscriptions","organizations_url":"https://api.github.com/users/hari90/orgs","repos_url":"https://api.github.com/users/hari90/repos","events_url":"https://api.github.com/users/hari90/events{/privacy}","received_events_url":"https://api.github.com/users/hari90/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/22101/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/22101/timeline","performed_via_github_app":null,"state_reason":"completed"}