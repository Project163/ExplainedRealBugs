{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20664","repository_url":"https://api.github.com/repos/yugabyte/yugabyte-db","labels_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20664/labels{/name}","comments_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20664/comments","events_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20664/events","html_url":"https://github.com/yugabyte/yugabyte-db/issues/20664","id":2086784966,"node_id":"I_kwDOBlCVUc58Yc_G","number":20664,"title":"[DocDB] Allow main memory division Google flags to optionally depend on node RAM","user":{"login":"mdbridge","id":15827795,"node_id":"MDQ6VXNlcjE1ODI3Nzk1","avatar_url":"https://avatars.githubusercontent.com/u/15827795?v=4","gravatar_id":"","url":"https://api.github.com/users/mdbridge","html_url":"https://github.com/mdbridge","followers_url":"https://api.github.com/users/mdbridge/followers","following_url":"https://api.github.com/users/mdbridge/following{/other_user}","gists_url":"https://api.github.com/users/mdbridge/gists{/gist_id}","starred_url":"https://api.github.com/users/mdbridge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdbridge/subscriptions","organizations_url":"https://api.github.com/users/mdbridge/orgs","repos_url":"https://api.github.com/users/mdbridge/repos","events_url":"https://api.github.com/users/mdbridge/events{/privacy}","received_events_url":"https://api.github.com/users/mdbridge/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":894667487,"node_id":"MDU6TGFiZWw4OTQ2Njc0ODc=","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/kind/new-feature","name":"kind/new-feature","color":"c2e0c6","default":false,"description":"This is a request for a completely new feature"},{"id":1290759928,"node_id":"MDU6TGFiZWwxMjkwNzU5OTI4","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/area/docdb","name":"area/docdb","color":"0c4fcc","default":false,"description":"YugabyteDB core features"},{"id":1419821900,"node_id":"MDU6TGFiZWwxNDE5ODIxOTAw","url":"https://api.github.com/repos/yugabyte/yugabyte-db/labels/priority/medium","name":"priority/medium","color":"ffdc5e","default":false,"description":"Medium priority issue"}],"state":"closed","locked":false,"assignee":{"login":"mdbridge","id":15827795,"node_id":"MDQ6VXNlcjE1ODI3Nzk1","avatar_url":"https://avatars.githubusercontent.com/u/15827795?v=4","gravatar_id":"","url":"https://api.github.com/users/mdbridge","html_url":"https://github.com/mdbridge","followers_url":"https://api.github.com/users/mdbridge/followers","following_url":"https://api.github.com/users/mdbridge/following{/other_user}","gists_url":"https://api.github.com/users/mdbridge/gists{/gist_id}","starred_url":"https://api.github.com/users/mdbridge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdbridge/subscriptions","organizations_url":"https://api.github.com/users/mdbridge/orgs","repos_url":"https://api.github.com/users/mdbridge/repos","events_url":"https://api.github.com/users/mdbridge/events{/privacy}","received_events_url":"https://api.github.com/users/mdbridge/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"mdbridge","id":15827795,"node_id":"MDQ6VXNlcjE1ODI3Nzk1","avatar_url":"https://avatars.githubusercontent.com/u/15827795?v=4","gravatar_id":"","url":"https://api.github.com/users/mdbridge","html_url":"https://github.com/mdbridge","followers_url":"https://api.github.com/users/mdbridge/followers","following_url":"https://api.github.com/users/mdbridge/following{/other_user}","gists_url":"https://api.github.com/users/mdbridge/gists{/gist_id}","starred_url":"https://api.github.com/users/mdbridge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdbridge/subscriptions","organizations_url":"https://api.github.com/users/mdbridge/orgs","repos_url":"https://api.github.com/users/mdbridge/repos","events_url":"https://api.github.com/users/mdbridge/events{/privacy}","received_events_url":"https://api.github.com/users/mdbridge/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2024-01-17T18:52:07Z","updated_at":"2024-05-17T18:25:47Z","closed_at":"2024-02-08T16:22:29Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Jira Link: [DB-9660](https://yugabyte.atlassian.net/browse/DB-9660)\r\n### Description\n\nToday we have Google flags that specify how much RAM should be used by the TServer and master.  They have fixed defaults that do not depend on the amount of RAM available:\r\n\r\n```\r\n~/code/yugabyte-db/src/yb/util/mem_tracker.cc:66:\r\nDEFINE_NON_RUNTIME_int64(memory_limit_hard_bytes, 0,\r\n             \"Maximum amount of memory this daemon should use, in bytes. \"\r\n             \"A value of 0 autosizes based on the total system memory. \"\r\n             \"A value of -1 disables all memory limiting.\");\r\nTAG_FLAG(memory_limit_hard_bytes, stable);\r\nDEFINE_NON_RUNTIME_double(default_memory_limit_to_ram_ratio, 0.85,\r\n              \"If memory_limit_hard_bytes is left unspecified, then it is \"\r\n              \"set to default_memory_limit_to_ram_ratio * Available RAM.\");\r\nTAG_FLAG(default_memory_limit_to_ram_ratio, advanced);\r\n```\r\nNote that the second Google flag default differs on master, hardcoded to 10%:\r\n```\r\n~/code/yugabyte-db/src/yb/master/master_main.cc:109:\r\n  FLAGS_default_memory_limit_to_ram_ratio = 0.10;\r\n```\r\n\r\nThis task is to enable determining these defaults by the amount of total RAM on the node the TServer or master is running on.\r\n\r\nThat is, at process startup if a new Google flag is set, look at the total RAM and if we are a master or TServer, use that to index a hardcoded lookup table and set the 2 Google flags above appropriately.\r\n\r\nTalk to Mark Lillibridge to get initial values for the table.\r\n\r\nBackport to 2.20; can consider making the turn on flag an auto flag that is automatically enabled for new clusters.\r\n\r\nFuture expansions may include additional Google flags for things like \"am I on a node with a master and TServer?\" and \"is YSQL disabled so there's no need to leave space for Postgres?\".\r\n\r\nThere should be a reasonable way for the operator to determine what the defaults got chosen.\r\n\n\n### Issue Type\n\nkind/new-feature\n\n### Warning: Please confirm that this issue does not contain any sensitive information\n\n- [X] I confirm this issue does not contain any sensitive information.\n\n[DB-9660]: https://yugabyte.atlassian.net/browse/DB-9660?atlOrigin=eyJpIjoiNWRkNTljNzYxNjVmNDY3MDlhMDU5Y2ZhYzA5YTRkZjUiLCJwIjoiZ2l0aHViLWNvbS1KU1cifQ","closed_by":{"login":"mdbridge","id":15827795,"node_id":"MDQ6VXNlcjE1ODI3Nzk1","avatar_url":"https://avatars.githubusercontent.com/u/15827795?v=4","gravatar_id":"","url":"https://api.github.com/users/mdbridge","html_url":"https://github.com/mdbridge","followers_url":"https://api.github.com/users/mdbridge/followers","following_url":"https://api.github.com/users/mdbridge/following{/other_user}","gists_url":"https://api.github.com/users/mdbridge/gists{/gist_id}","starred_url":"https://api.github.com/users/mdbridge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdbridge/subscriptions","organizations_url":"https://api.github.com/users/mdbridge/orgs","repos_url":"https://api.github.com/users/mdbridge/repos","events_url":"https://api.github.com/users/mdbridge/events{/privacy}","received_events_url":"https://api.github.com/users/mdbridge/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20664/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/yugabyte/yugabyte-db/issues/20664/timeline","performed_via_github_app":null,"state_reason":"completed"}