diff --git a/src/main/java/one/util/streamex/WithFirstSpliterator.java b/src/main/java/one/util/streamex/WithFirstSpliterator.java
index 253ae3d..e8d24b1 100644
--- a/src/main/java/one/util/streamex/WithFirstSpliterator.java
+++ b/src/main/java/one/util/streamex/WithFirstSpliterator.java
@@ -145,7 +145,7 @@ import java.util.function.Consumer;
     @Override
     public long estimateSize() {
         long size = source.estimateSize();
-        if (size > 0 && size < Long.MAX_VALUE && lock == null)
+        if (size > 0 && size < Long.MAX_VALUE && lock == null && state == STATE_NONE)
             size--;
         return size;
     }
diff --git a/src/main/java/one/util/streamex/WithHeadSpliterator.java b/src/main/java/one/util/streamex/WithHeadSpliterator.java
index 19b6c26..58ae1b3 100644
--- a/src/main/java/one/util/streamex/WithHeadSpliterator.java
+++ b/src/main/java/one/util/streamex/WithHeadSpliterator.java
@@ -16,6 +16,7 @@
 package one.util.streamex;
 
 import java.util.Spliterator;
+import java.util.Spliterators.AbstractSpliterator;
 import java.util.function.BiFunction;
 import java.util.function.Consumer;
 import java.util.stream.Stream;
@@ -25,12 +26,13 @@ import static one.util.streamex.StreamExInternals.*;
 /**
  * @author Tagir Valeev
  */
-/*package*/ final class WithHeadSpliterator<T, U> implements Spliterator<U> {
+/*package*/ final class WithHeadSpliterator<T, U> extends AbstractSpliterator<U> {
     private final Spliterator<T> source;
     private final BiFunction<T, StreamEx<T>, Stream<U>> mapper;
     private Spliterator<U> target;
     
     WithHeadSpliterator(Spliterator<T> source, BiFunction<T, StreamEx<T>, Stream<U>> mapper) {
+        super(Long.MAX_VALUE, ORDERED);
         this.source = source;
         this.mapper = mapper;
     }
@@ -65,21 +67,12 @@ import static one.util.streamex.StreamExInternals.*;
         return true;
     }
 
-    @Override
-    public Spliterator<U> trySplit() {
-        if(!init())
-            return null;
-        return target.trySplit();
-    }
-
     @Override
     public long estimateSize() {
-        long size = source.estimateSize();
-        return size == Long.MAX_VALUE || size <= 0 ? size : size - 1;
-    }
-
-    @Override
-    public int characteristics() {
-        return source.characteristics() & ORDERED;
+        if(target == null) {
+            long size = source.estimateSize();
+            return size == Long.MAX_VALUE || size <= 0 ? size : size - 1;
+        }
+        return target.estimateSize();
     }
 }
diff --git a/src/test/java/one/util/streamex/StreamExTest.java b/src/test/java/one/util/streamex/StreamExTest.java
index 3889d54..5ed7dd1 100644
--- a/src/test/java/one/util/streamex/StreamExTest.java
+++ b/src/test/java/one/util/streamex/StreamExTest.java
@@ -1512,9 +1512,12 @@ public class StreamExTest {
                 EntryStream.of("name", "Surname", "type", "string", "value", "Smith").toMap(),
                 EntryStream.of("name", "Given name", "type", "string", "value", "John").toMap()
                     );
-            streamEx(() -> StreamEx.ofLines(new StringReader(input)), s -> assertEquals(expected, s.get().map(
-                str -> str.split(",")).withFirst().mapKeyValue((header, row) -> EntryStream.zip(header, row).toMap())
-                    .toList()));
+            streamEx(() -> StreamEx.ofLines(new StringReader(input)), s -> {
+                assertEquals(expected, s.get().map(str -> str.split(",")).withFirst().mapKeyValue(
+                    (header, row) -> EntryStream.zip(header, row).toMap()).toList());
+                assertEquals(expected, s.get().map(str -> str.split(",")).withFirst((header, stream) -> 
+                    stream.map(row -> EntryStream.zip(header, row).toMap())).toList());
+            });
         });
         Map<Integer, List<Integer>> expected = Collections
                 .singletonMap(0, IntStreamEx.range(1, 10000).boxed().toList());
