diff --git a/src/main/java/one/util/streamex/StreamEx.java b/src/main/java/one/util/streamex/StreamEx.java
index 27e5545..ba79050 100644
--- a/src/main/java/one/util/streamex/StreamEx.java
+++ b/src/main/java/one/util/streamex/StreamEx.java
@@ -1344,8 +1344,8 @@ public class StreamEx<T> extends AbstractStreamEx<T, StreamEx<T>> {
         return strategy().newEntryStream(delegate(new WithFirstSpliterator<>(stream.spliterator())));
     }
 
-    public <U> StreamEx<U> withFirst(BiFunction<T, StreamEx<T>, Stream<U>> mapper) {
-        return strategy().newStreamEx(delegate(new WithHeadSpliterator<>(stream.spliterator(), mapper)));
+    public <U> StreamEx<U> withFirst(BiFunction<? super T, ? super StreamEx<T>, ? extends Stream<U>> mapper) {
+        return strategy().newStreamEx(delegate(new WithFirstMapperSpliterator<>(stream.spliterator(), mapper)));
     }
     
     /**
diff --git a/src/main/java/one/util/streamex/WithHeadSpliterator.java b/src/main/java/one/util/streamex/WithFirstMapperSpliterator.java
similarity index 77%
rename from src/main/java/one/util/streamex/WithHeadSpliterator.java
rename to src/main/java/one/util/streamex/WithFirstMapperSpliterator.java
index 58ae1b3..d11fc0c 100644
--- a/src/main/java/one/util/streamex/WithHeadSpliterator.java
+++ b/src/main/java/one/util/streamex/WithFirstMapperSpliterator.java
@@ -26,12 +26,12 @@ import static one.util.streamex.StreamExInternals.*;
 /**
  * @author Tagir Valeev
  */
-/*package*/ final class WithHeadSpliterator<T, U> extends AbstractSpliterator<U> {
+/*package*/ final class WithFirstMapperSpliterator<T, U> extends AbstractSpliterator<U> {
     private final Spliterator<T> source;
-    private final BiFunction<T, StreamEx<T>, Stream<U>> mapper;
+    private final BiFunction<? super T, ? super StreamEx<T>, ? extends Stream<U>> mapper;
     private Spliterator<U> target;
     
-    WithHeadSpliterator(Spliterator<T> source, BiFunction<T, StreamEx<T>, Stream<U>> mapper) {
+    WithFirstMapperSpliterator(Spliterator<T> source, BiFunction<? super T, ? super StreamEx<T>, ? extends Stream<U>> mapper) {
         super(Long.MAX_VALUE, ORDERED);
         this.source = source;
         this.mapper = mapper;
@@ -41,12 +41,6 @@ import static one.util.streamex.StreamExInternals.*;
     public boolean tryAdvance(Consumer<? super U> action) {
         if(!init())
             return false;
-        if(target instanceof WithHeadSpliterator) {
-            @SuppressWarnings("unchecked")
-            Spliterator<U> next = ((WithHeadSpliterator<?, U>) target).target;
-            if(next != null)
-                target = next;
-        }
         return target.tryAdvance(action);
     }
 
diff --git a/src/test/java/one/util/streamex/StreamExTest.java b/src/test/java/one/util/streamex/StreamExTest.java
index 5ed7dd1..7173bda 100644
--- a/src/test/java/one/util/streamex/StreamExTest.java
+++ b/src/test/java/one/util/streamex/StreamExTest.java
@@ -1530,9 +1530,25 @@ public class StreamExTest {
         streamEx(() -> StreamEx.iterate(2, x -> x + 1), s -> assertEquals(asList(2, 3, 5, 7, 11, 13, 17, 19, 23, 29,
             31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97), sieve(s.get()).takeWhile(x -> x < 100)
                 .toList()));
+        
+        emptyStreamEx(Integer.class, s -> {
+            assertEquals(0L, s.get().withFirst((first, head) -> {
+                throw new IllegalStateException();
+            }).count());
+            assertFalse(s.get().withFirst((first, head) -> {
+                throw new IllegalStateException();
+            }).findFirst().isPresent());
+        });
+        
+        streamEx(() -> IntStreamEx.range(100).boxed(), s -> assertEquals(IntStreamEx.rangeClosed(99, 0, -1).boxed()
+                .toList(), reverse(s.get()).toList()));
     }
     
     private static StreamEx<Integer> sieve(StreamEx<Integer> input) {
         return input.withFirst((head, stream) -> sieve(stream.filter(n -> n % head != 0)).prepend(head));
     }
+    
+    private static <T> StreamEx<T> reverse(StreamEx<T> input) {
+        return input.withFirst((head, stream) -> reverse(stream).append(head));
+    }
 }
