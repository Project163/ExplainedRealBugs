{"url":"https://api.github.com/repos/FasterXML/jackson-module-jsonSchema/issues/47","repository_url":"https://api.github.com/repos/FasterXML/jackson-module-jsonSchema","labels_url":"https://api.github.com/repos/FasterXML/jackson-module-jsonSchema/issues/47/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-module-jsonSchema/issues/47/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-module-jsonSchema/issues/47/events","html_url":"https://github.com/FasterXML/jackson-module-jsonSchema/issues/47","id":46450582,"node_id":"MDU6SXNzdWU0NjQ1MDU4Mg==","number":47,"title":"VisitorContext results in incomplete json schema output","user":{"login":"gadams00","id":2694081,"node_id":"MDQ6VXNlcjI2OTQwODE=","avatar_url":"https://avatars.githubusercontent.com/u/2694081?v=4","gravatar_id":"","url":"https://api.github.com/users/gadams00","html_url":"https://github.com/gadams00","followers_url":"https://api.github.com/users/gadams00/followers","following_url":"https://api.github.com/users/gadams00/following{/other_user}","gists_url":"https://api.github.com/users/gadams00/gists{/gist_id}","starred_url":"https://api.github.com/users/gadams00/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gadams00/subscriptions","organizations_url":"https://api.github.com/users/gadams00/orgs","repos_url":"https://api.github.com/users/gadams00/repos","events_url":"https://api.github.com/users/gadams00/events{/privacy}","received_events_url":"https://api.github.com/users/gadams00/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2014-10-21T22:04:39Z","updated_at":"2014-10-21T23:45:26Z","closed_at":"2014-10-21T23:45:26Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"In version 2.4.1, VisitorContext was added, which keeps track of visited JavaTypes in a static HashSet, with static methods to add to and get from the static HashSet. Because of this, if you use SchemaFactoryWrapper to generate json schema multiple times during a given run of the JVM, you may get references along the lines of \"$ref\" : \"urn:jsonschema:test:JsonSchemaTest:Bar\" when no such id exists in the json schema document generated. To make matters worse, because VisitorContext is all static, there's no way to work around the problem.\n\nhere's a quick test case that produces the issue:\n\n```\npackage test;\n\nimport java.io.StringWriter;\n\nimport org.junit.Test;\n\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.SerializationFeature;\nimport com.fasterxml.jackson.module.jsonSchema.factories.SchemaFactoryWrapper;\n\npublic class JsonSchemaTest {\n\n\n    class Foo {\n        private String fooProp1;\n        private int fooProp2;\n        private Bar fooProp3;\n\n        public String getFooProp1() {\n            return fooProp1;\n        }\n\n        public void setFooProp1(String fooProp1) {\n            this.fooProp1 = fooProp1;\n        }\n\n        public int getFooProp2() {\n            return fooProp2;\n        }\n\n        public void setFooProp2(int fooProp2) {\n            this.fooProp2 = fooProp2;\n        }\n\n        public Bar getFooProp3() {\n            return fooProp3;\n        }\n\n        public void setFooProp3(Bar fooProp3) {\n            this.fooProp3 = fooProp3;\n        }\n    }\n\n    class Bar {\n        private String barProp1;\n        private int barProp2;\n\n        public String getBarProp1() {\n            return barProp1;\n        }\n\n        public void setBarProp1(String barProp1) {\n            this.barProp1 = barProp1;\n        }\n\n        public int getBarProp2() {\n            return barProp2;\n        }\n\n        public void setBarProp2(int barProp2) {\n            this.barProp2 = barProp2;\n        }\n    }\n\n    class Qwer {\n        private String qwerProp1;\n        private Bar qwerProp2;\n\n        public String getQwerProp1() {\n            return qwerProp1;\n        }\n\n        public void setQwerProp1(String qwerProp1) {\n            this.qwerProp1 = qwerProp1;\n        }\n\n        public Bar getQwerProp2() {\n            return qwerProp2;\n        }\n\n        public void setQwerProp2(Bar qwerProp2) {\n            this.qwerProp2 = qwerProp2;\n        }\n    }\n\n    @Test\n    public void testSchemaGeneration() throws Exception {\n        printJsonSchema(Foo.class);\n        printJsonSchema(Qwer.class);\n    }\n\n    private void printJsonSchema(Class<?> clazz) throws Exception {\n        ObjectMapper mapper = new ObjectMapper();\n        mapper.configure(SerializationFeature.INDENT_OUTPUT, true);\n        SchemaFactoryWrapper visitor = new SchemaFactoryWrapper();\n        mapper.acceptJsonFormatVisitor(\n                mapper.constructType(\n                        clazz), visitor);\n        StringWriter sr = new StringWriter();\n        mapper.writeValue(sr, visitor.finalSchema());\n        System.out.println(sr.toString());\n    }\n\n}\n```\n\noutput:\n\n``` javascript\n{\n  \"type\" : \"object\",\n  \"id\" : \"urn:jsonschema:test:JsonSchemaTest:Foo\",\n  \"properties\" : {\n    \"fooProp3\" : {\n      \"type\" : \"object\",\n      \"id\" : \"urn:jsonschema:test:JsonSchemaTest:Bar\",\n      \"properties\" : {\n        \"barProp1\" : {\n          \"type\" : \"string\"\n        },\n        \"barProp2\" : {\n          \"type\" : \"integer\"\n        }\n      }\n    },\n    \"fooProp2\" : {\n      \"type\" : \"integer\"\n    },\n    \"fooProp1\" : {\n      \"type\" : \"string\"\n    }\n  }\n}\n{\n  \"type\" : \"object\",\n  \"id\" : \"urn:jsonschema:test:JsonSchemaTest:Qwer\",\n  \"properties\" : {\n    \"qwerProp2\" : {\n      \"type\" : \"object\",\n      \"$ref\" : \"urn:jsonschema:test:JsonSchemaTest:Bar\"\n    },\n    \"qwerProp1\" : {\n      \"type\" : \"string\"\n    }\n  }\n}\n```\n\nNote that the second object in the output is incomplete.\"$ref\" : \"urn:jsonschema:test:JsonSchemaTest:Bar\" refers to an id from the prior schema generation operation that got statically cached.\n","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-module-jsonSchema/issues/47/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-module-jsonSchema/issues/47/timeline","performed_via_github_app":null,"state_reason":"completed"}