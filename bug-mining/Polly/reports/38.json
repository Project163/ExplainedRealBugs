{"url":"https://api.github.com/repos/App-vNext/Polly/issues/2680","repository_url":"https://api.github.com/repos/App-vNext/Polly","labels_url":"https://api.github.com/repos/App-vNext/Polly/issues/2680/labels{/name}","comments_url":"https://api.github.com/repos/App-vNext/Polly/issues/2680/comments","events_url":"https://api.github.com/repos/App-vNext/Polly/issues/2680/events","html_url":"https://github.com/App-vNext/Polly/issues/2680","id":3258124841,"node_id":"I_kwDOAJaD5s7CMwop","number":2680,"title":"[Bug] Documentation has incorrect examples for ExecuteOutcomeAsync","user":{"login":"kevincathcart-cas","id":72209838,"node_id":"MDQ6VXNlcjcyMjA5ODM4","avatar_url":"https://avatars.githubusercontent.com/u/72209838?v=4","gravatar_id":"","url":"https://api.github.com/users/kevincathcart-cas","html_url":"https://github.com/kevincathcart-cas","followers_url":"https://api.github.com/users/kevincathcart-cas/followers","following_url":"https://api.github.com/users/kevincathcart-cas/following{/other_user}","gists_url":"https://api.github.com/users/kevincathcart-cas/gists{/gist_id}","starred_url":"https://api.github.com/users/kevincathcart-cas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kevincathcart-cas/subscriptions","organizations_url":"https://api.github.com/users/kevincathcart-cas/orgs","repos_url":"https://api.github.com/users/kevincathcart-cas/repos","events_url":"https://api.github.com/users/kevincathcart-cas/events{/privacy}","received_events_url":"https://api.github.com/users/kevincathcart-cas/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":294604181,"node_id":"MDU6TGFiZWwyOTQ2MDQxODE=","url":"https://api.github.com/repos/App-vNext/Polly/labels/up-for-grabs","name":"up-for-grabs","color":"5319e7","default":false,"description":null},{"id":3737923830,"node_id":"LA_kwDOAJaD5s7ezDD2","url":"https://api.github.com/repos/App-vNext/Polly/labels/help%20wanted","name":"help wanted","color":"4BC938","default":true,"description":"A change up for grabs for contributions from the community"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2025-07-24T01:09:39Z","updated_at":"2025-08-22T15:44:41Z","closed_at":"2025-08-22T15:44:41Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Many of the examples of ExecuteOutcomeAsync in the documentation are buggy. Per the xml documentation: \"The caller must make sure that the callback does not throw any exceptions.\". The discussion in #2025 confirms this.\n\nBut the documentation has a number of places where this is not done properly.\n\n<details>\n<summary>Buggy example in Migration Guide</summary>\n\nFor example, the migration guide says that:\n```c#\nvar context = ResilienceContextPool.Shared.Get();\nOutcome<int> pipelineResult = await pipeline.ExecuteOutcomeAsync(\n    static async (ctx, state) => Outcome.FromResult(await MethodAsync(ctx.CancellationToken)), context, \"state\");\nResilienceContextPool.Shared.Return(context);\n```\n\nis the V8 equivalent to \n\n```c#\nPolicyResult<int> asyncPolicyResult = await asyncPolicy.ExecuteAndCaptureAsync(MethodAsync, CancellationToken.None);\n```\n\nBut that is isn't correct. The equivalent is:\n```c#\nvar context = ResilienceContextPool.Shared.Get();\nOutcome<int> pipelineResult = await pipeline.ExecuteOutcomeAsync(\n    static async (ctx, state) => {\n        try \n        {\n            return Outcome.FromResult(await MethodAsync(ctx.CancellationToken));\n        }\n        catch (Exception e)\n        {\n            return Outcome.FromException<int>(e);\n        }\n    }), context, \"state\");\nResilienceContextPool.Shared.Return(context);\n```\n\nThe code without the catch could potentially be correct for a callback that will never throw and instead indicates errors with a 0 or negative return or something, but this example is trying to show the equivalents, which makes it incorrect.\n</details>\n\n<details>\n<summary>Buggy example on Fallback strategy page</summary>\n\nLook at the reasoning portion of the [\"Using fallback to replace thrown exception\" antipattern section](https://www.pollydocs.org/strategies/fallback.html#anti-patterns): \n\n```c#\npublic static async ValueTask<HttpResponseMessage> Action()\n{\n    var context = ResilienceContextPool.Shared.Get();\n    var outcome = await WhateverPipeline.ExecuteOutcomeAsync<HttpResponseMessage, string>(\n        async (ctx, state) =>\n        {\n            var result = await ActionCore();\n            return Outcome.FromResult(result);\n        }, context, \"state\");\n\n    if (outcome.Exception is HttpRequestException requestException)\n    {\n        throw new CustomNetworkException(\"Replace thrown exception\", requestException);\n    }\n\n    ResilienceContextPool.Shared.Return(context);\n    return outcome.Result!;\n}\n```\n\nThe callback (which must not throw) can only return a successful result, but the code is looking for an `HttpRequestException` in the returned outcome, which almost certainly would be coming from the callback.\n</details>\n\n<details>\n<summary>Buggy example on Circuit breaker strategy page</summary>\n\nThis one is from the Do example for [Circuit Breaker's \"Reducing thrown exceptions\" section](https://www.pollydocs.org/strategies/circuit-breaker.html#reducing-thrown-exceptions):\n\n```c#\nvar context = ResilienceContextPool.Shared.Get();\nvar circuitBreaker = new ResiliencePipelineBuilder()\n    .AddCircuitBreaker(new()\n    {\n        ShouldHandle = new PredicateBuilder().Handle<HttpRequestException>(),\n        BreakDuration = TimeSpan.FromSeconds(0.5),\n    })\n    .Build();\n\nOutcome<HttpResponseMessage> outcome = await circuitBreaker.ExecuteOutcomeAsync(static async (ctx, state) =>\n{\n    var response = await IssueRequest();\n    return Outcome.FromResult(response);\n}, context, \"state\");\n\nResilienceContextPool.Shared.Return(context);\n\nif (outcome.Exception is BrokenCircuitException)\n{\n    // The execution was stopped by the circuit breaker\n}\nelse\n{\n    HttpResponseMessage response = outcome.Result!;\n    // Your code goes here to process the response\n}\n```\n\nHere we a circuit breaker looking for `HttpRequestException`, but once again, the callback (which must not throw) can only return a result outcome.\n\nAside: This example is also not great because the code afterward looks likely to be totally ignoring any exception other than `BrokenCircuitException`, including the `HttpRequestException that we know can happen, as that is what gets used to break the circuit). Removing the line getting `.Result!`, and changing the comment to be `//Execution occurred without being stopped by the breaker. check outcome.Result for result or outcome.Exception for any thrown exception`, would fix this.\n</details>\n\nIn fact I can find only two places in the documentation show the correct pattern for wrapping user code that might throw: [the Performance page](https://www.pollydocs.org/advanced/performance.html#execute-callbacks-without-throwing-exceptions) and [the Pipelines page](https://www.pollydocs.org/pipelines/index.html?q=executeoutcomeasync#retrieving-execution-results-with-outcomet). \n\n\nWhile these bad examples can simply be fixed, it is worth questioning why they happened. Part of it comes from the simple fact is that while not correct, incorrectly letting the exception escape will work just fine in many cases, as long as the last strategy in the pipeline is one of the built in ones that use `StrategyHelper.ExecuteCallbackSafeAsync`, (which I know both Retry and Circuit Breaker do, and maybe some others too).\n\nBut this is also partly due to the design of having only one overload of ExecuteOutcomeAsync, namely: the fastest, lowest allocation version possible.  Now I certainly agree that the fastest lowest allocation version should be provided. But I'm not sure it needs to be the only overload. Clearly most of these examples really want an overload with a callback signature more like `Func<ResilienceContext, TState, ValueTask<TResult>>`, instead of `Func<ResilienceContext, TState, ValueTask<Outcome<TResult>>>`, which would avoid this correctness issues.\n\nThat would be easy to implement via a wrapping `static async` helper like is done with `ExecuteAsync` methods currently. It might even be possible to trade some allocations to be faster, using some approach similar to #2132.\n\nThe primary downside is of adding such an overload would needing to be more specific when trying to mention the approach with the minimal allocations and best speed, that would only the overload that takes the `Func<ResilienceContext, TState, ValueTask<Outcome<TResult>>>`.","closed_by":{"login":"martincostello","id":1439341,"node_id":"MDQ6VXNlcjE0MzkzNDE=","avatar_url":"https://avatars.githubusercontent.com/u/1439341?v=4","gravatar_id":"","url":"https://api.github.com/users/martincostello","html_url":"https://github.com/martincostello","followers_url":"https://api.github.com/users/martincostello/followers","following_url":"https://api.github.com/users/martincostello/following{/other_user}","gists_url":"https://api.github.com/users/martincostello/gists{/gist_id}","starred_url":"https://api.github.com/users/martincostello/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martincostello/subscriptions","organizations_url":"https://api.github.com/users/martincostello/orgs","repos_url":"https://api.github.com/users/martincostello/repos","events_url":"https://api.github.com/users/martincostello/events{/privacy}","received_events_url":"https://api.github.com/users/martincostello/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/App-vNext/Polly/issues/2680/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/App-vNext/Polly/issues/2680/timeline","performed_via_github_app":null,"state_reason":"completed"}