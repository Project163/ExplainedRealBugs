{"url":"https://api.github.com/repos/App-vNext/Polly/issues/2412","repository_url":"https://api.github.com/repos/App-vNext/Polly","labels_url":"https://api.github.com/repos/App-vNext/Polly/issues/2412/labels{/name}","comments_url":"https://api.github.com/repos/App-vNext/Polly/issues/2412/comments","events_url":"https://api.github.com/repos/App-vNext/Polly/issues/2412/events","html_url":"https://github.com/App-vNext/Polly/issues/2412","id":2734163684,"node_id":"I_kwDOAJaD5s6i-Abk","number":2412,"title":"[Bug]: `InvalidCastException` when multiple threads retrieve pipeline","user":{"login":"kmcclellan","id":43862801,"node_id":"MDQ6VXNlcjQzODYyODAx","avatar_url":"https://avatars.githubusercontent.com/u/43862801?v=4","gravatar_id":"","url":"https://api.github.com/users/kmcclellan","html_url":"https://github.com/kmcclellan","followers_url":"https://api.github.com/users/kmcclellan/followers","following_url":"https://api.github.com/users/kmcclellan/following{/other_user}","gists_url":"https://api.github.com/users/kmcclellan/gists{/gist_id}","starred_url":"https://api.github.com/users/kmcclellan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kmcclellan/subscriptions","organizations_url":"https://api.github.com/users/kmcclellan/orgs","repos_url":"https://api.github.com/users/kmcclellan/repos","events_url":"https://api.github.com/users/kmcclellan/events{/privacy}","received_events_url":"https://api.github.com/users/kmcclellan/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":38476905,"node_id":"MDU6TGFiZWwzODQ3NjkwNQ==","url":"https://api.github.com/repos/App-vNext/Polly/labels/bug","name":"bug","color":"fc2929","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/App-vNext/Polly/milestones/54","html_url":"https://github.com/App-vNext/Polly/milestone/54","labels_url":"https://api.github.com/repos/App-vNext/Polly/milestones/54/labels","id":11884591,"node_id":"MI_kwDOAJaD5s4AtVgv","number":54,"title":"v8.5.1","description":"","creator":{"login":"martincostello","id":1439341,"node_id":"MDQ6VXNlcjE0MzkzNDE=","avatar_url":"https://avatars.githubusercontent.com/u/1439341?v=4","gravatar_id":"","url":"https://api.github.com/users/martincostello","html_url":"https://github.com/martincostello","followers_url":"https://api.github.com/users/martincostello/followers","following_url":"https://api.github.com/users/martincostello/following{/other_user}","gists_url":"https://api.github.com/users/martincostello/gists{/gist_id}","starred_url":"https://api.github.com/users/martincostello/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martincostello/subscriptions","organizations_url":"https://api.github.com/users/martincostello/orgs","repos_url":"https://api.github.com/users/martincostello/repos","events_url":"https://api.github.com/users/martincostello/events{/privacy}","received_events_url":"https://api.github.com/users/martincostello/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":4,"state":"closed","created_at":"2024-11-12T21:14:11Z","updated_at":"2025-06-12T16:34:43Z","due_on":"2025-01-13T08:00:00Z","closed_at":"2025-01-13T17:37:43Z"},"comments":5,"created_at":"2024-12-11T22:30:42Z","updated_at":"2025-01-13T18:05:57Z","closed_at":"2025-01-13T16:45:51Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\n`System.ComponentModel.DataAnnotations.RangeAttribute` is [not thread safe](https://github.com/dotnet/runtime/issues/1143).\r\n\r\n[`ValidationHelper`](https://github.com/App-vNext/Polly/blob/885fbaaeb4a204e38c24c48ec580bf8e21735330/src/Polly.Core/Utils/ValidationHelper.cs#L31) does not synchronize access to Validator and is invoked when initializing pipelines. This can lead to occasional `InvalidCastException` when multiple threads retrieve a pipeline for the first time (while `RangeAttribute` is uninitialized).\r\n\r\nThis was previously reported as https://github.com/App-vNext/Polly/discussions/2096 but not fixed.\n\n### Expected behavior\n\nNo exception is thrown.\n\n### Actual behavior\n\n_No response_\n\n### Steps to reproduce\n\nIt's pretty difficult to reproduce in the registry, due to the specificity of the race condition and the fact that you only get one chance per process to trigger it.\r\n\r\nYou can simulate it reliably using just the attribute, however.\r\n\r\n```csharp\r\nusing System;\r\nusing System.ComponentModel.DataAnnotations;\r\nusing System.Threading;\r\nusing System.Threading.Tasks;\r\n\r\nvar exceptions = 0;\r\nvar parallelism = 2;\r\nconst int repeat = 100_000;\r\n\r\nfor (var i = 0; i < repeat; i++)\r\n{\r\n    var range = new RangeAttribute(typeof(TimeSpan), \"00:00:00\", \"1:00:00\");\r\n\r\n    Parallel.For(\r\n        0,\r\n        parallelism,\r\n        new ParallelOptions { MaxDegreeOfParallelism = parallelism },\r\n        index =>\r\n        {\r\n            try\r\n            {\r\n                range.IsValid(null);\r\n            }\r\n            catch (InvalidCastException)\r\n            {\r\n                Interlocked.Increment(ref exceptions);\r\n            }\r\n        });\r\n}\r\n\r\nvar frequency = exceptions / (double)repeat;\r\nConsole.WriteLine($\"{exceptions} exceptions encountered ({frequency:P4})\");\r\n```\r\nExample: \"25 exceptions encountered (0.0250%)\"\n\n### Exception(s) (if any)\n\n\r\n```\r\nSystem.InvalidCastException: Unable to cast object of type 'System.TimeSpan' to type 'System.String'.\r\n   at System.ComponentModel.DataAnnotations.RangeAttribute.SetupConversion()\r\n   at System.ComponentModel.DataAnnotations.RangeAttribute.IsValid(Object value)\r\n   at System.ComponentModel.DataAnnotations.ValidationAttribute.IsValid(Object value, ValidationContext validationContext)\r\n   at System.ComponentModel.DataAnnotations.ValidationAttribute.GetValidationResult(Object value, ValidationContext validationContext)\r\n   at System.ComponentModel.DataAnnotations.Validator.TryValidate(Object value, ValidationContext validationContext, ValidationAttribute attribute, ValidationError& validationError)\r\n   at System.ComponentModel.DataAnnotations.Validator.GetValidationErrors(Object value, ValidationContext validationContext, IEnumerable`1 attributes, Boolean breakOnFirstError)\r\n   at System.ComponentModel.DataAnnotations.Validator.GetObjectPropertyValidationErrors(Object instance, ValidationContext validationContext, Boolean validateAllProperties, Boolean breakOnFirstError)\r\n   at System.ComponentModel.DataAnnotations.Validator.GetObjectValidationErrors(Object instance, ValidationContext validationContext, Boolean validateAllProperties, Boolean breakOnFirstError)\r\n   at System.ComponentModel.DataAnnotations.Validator.TryValidateObject(Object instance, ValidationContext validationContext, ICollection`1 validationResults, Boolean validateAllProperties)\r\n   at Polly.Utils.ValidationHelper.ValidateObject(ResilienceValidationContext context)\r\n   at Polly.ResiliencePipelineBuilderBase.AddPipelineComponent(Func`2 factory, ResilienceStrategyOptions options)\r\n   at Polly.ResiliencePipelineBuilderExtensions.AddStrategy[TResult](ResiliencePipelineBuilder`1 builder, Func`2 factory, ResilienceStrategyOptions options)\r\n   at Polly.RetryResiliencePipelineBuilderExtensions.AddRetry[TResult](ResiliencePipelineBuilder`1 builder, RetryStrategyOptions`1 options)\r\n   at Firebird.Saga.Client.ServiceCollectionExtensions.<>c__DisplayClass2_0.<AddSagaCommands>b__6(ResiliencePipelineBuilder`1 x, ConfigureBuilderContext`1 y)\r\n   at Polly.Registry.RegistryPipelineComponentBuilder`2.CreateBuilder()\r\n   at Polly.Registry.RegistryPipelineComponentBuilder`2.CreateComponent()\r\n   at Polly.Registry.ResiliencePipelineRegistry`1.GenericRegistry`1.<>c__DisplayClass7_0.<GetOrAdd>b__0(TKey k)\r\n   at System.Collections.Concurrent.ConcurrentDictionary`2.GetOrAdd(TKey key, Func`2 valueFactory)\r\n   at Polly.Registry.ResiliencePipelineRegistry`1.GenericRegistry`1.GetOrAdd(TKey key, Action`2 configure)\r\n   at Polly.Registry.ResiliencePipelineRegistry`1.GenericRegistry`1.TryGet(TKey key, ResiliencePipeline`1& strategy)\r\n   at Polly.Registry.ResiliencePipelineRegistry`1.TryGetPipeline[TResult](TKey key, ResiliencePipeline`1& pipeline)\r\n   at Polly.Registry.ResiliencePipelineProvider`1.GetPipeline[TResult](TKey key)\r\n```\n\n### Polly version\n\n8.5.0\n\n### .NET Version\n\nnet9.0\n\n### Anything else?\n\n_No response_","closed_by":{"login":"martincostello","id":1439341,"node_id":"MDQ6VXNlcjE0MzkzNDE=","avatar_url":"https://avatars.githubusercontent.com/u/1439341?v=4","gravatar_id":"","url":"https://api.github.com/users/martincostello","html_url":"https://github.com/martincostello","followers_url":"https://api.github.com/users/martincostello/followers","following_url":"https://api.github.com/users/martincostello/following{/other_user}","gists_url":"https://api.github.com/users/martincostello/gists{/gist_id}","starred_url":"https://api.github.com/users/martincostello/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martincostello/subscriptions","organizations_url":"https://api.github.com/users/martincostello/orgs","repos_url":"https://api.github.com/users/martincostello/repos","events_url":"https://api.github.com/users/martincostello/events{/privacy}","received_events_url":"https://api.github.com/users/martincostello/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/App-vNext/Polly/issues/2412/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/App-vNext/Polly/issues/2412/timeline","performed_via_github_app":null,"state_reason":"completed"}