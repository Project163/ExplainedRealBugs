{"url":"https://api.github.com/repos/App-vNext/Polly/issues/341","repository_url":"https://api.github.com/repos/App-vNext/Polly","labels_url":"https://api.github.com/repos/App-vNext/Polly/issues/341/labels{/name}","comments_url":"https://api.github.com/repos/App-vNext/Polly/issues/341/comments","events_url":"https://api.github.com/repos/App-vNext/Polly/issues/341/events","html_url":"https://github.com/App-vNext/Polly/issues/341","id":270561827,"node_id":"MDU6SXNzdWUyNzA1NjE4Mjc=","number":341,"title":"non-generic CachePolicy does not work wrapped in a non-generic PolicyWrap","user":{"login":"tdabasinskas","id":7723360,"node_id":"MDQ6VXNlcjc3MjMzNjA=","avatar_url":"https://avatars.githubusercontent.com/u/7723360?v=4","gravatar_id":"","url":"https://api.github.com/users/tdabasinskas","html_url":"https://github.com/tdabasinskas","followers_url":"https://api.github.com/users/tdabasinskas/followers","following_url":"https://api.github.com/users/tdabasinskas/following{/other_user}","gists_url":"https://api.github.com/users/tdabasinskas/gists{/gist_id}","starred_url":"https://api.github.com/users/tdabasinskas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tdabasinskas/subscriptions","organizations_url":"https://api.github.com/users/tdabasinskas/orgs","repos_url":"https://api.github.com/users/tdabasinskas/repos","events_url":"https://api.github.com/users/tdabasinskas/events{/privacy}","received_events_url":"https://api.github.com/users/tdabasinskas/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":38476905,"node_id":"MDU6TGFiZWwzODQ3NjkwNQ==","url":"https://api.github.com/repos/App-vNext/Polly/labels/bug","name":"bug","color":"fc2929","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/App-vNext/Polly/milestones/21","html_url":"https://github.com/App-vNext/Polly/milestone/21","labels_url":"https://api.github.com/repos/App-vNext/Polly/milestones/21/labels","id":2886583,"node_id":"MDk6TWlsZXN0b25lMjg4NjU4Mw==","number":21,"title":"v5.5.0","description":"","creator":{"login":"reisenberger","id":9608723,"node_id":"MDQ6VXNlcjk2MDg3MjM=","avatar_url":"https://avatars.githubusercontent.com/u/9608723?v=4","gravatar_id":"","url":"https://api.github.com/users/reisenberger","html_url":"https://github.com/reisenberger","followers_url":"https://api.github.com/users/reisenberger/followers","following_url":"https://api.github.com/users/reisenberger/following{/other_user}","gists_url":"https://api.github.com/users/reisenberger/gists{/gist_id}","starred_url":"https://api.github.com/users/reisenberger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reisenberger/subscriptions","organizations_url":"https://api.github.com/users/reisenberger/orgs","repos_url":"https://api.github.com/users/reisenberger/repos","events_url":"https://api.github.com/users/reisenberger/events{/privacy}","received_events_url":"https://api.github.com/users/reisenberger/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":2,"state":"closed","created_at":"2017-11-03T17:42:56Z","updated_at":"2017-11-12T05:19:37Z","due_on":null,"closed_at":"2017-11-12T05:19:37Z"},"comments":4,"created_at":"2017-11-02T07:50:06Z","updated_at":"2017-11-06T08:10:41Z","closed_at":"2017-11-03T17:59:48Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello,\r\n\r\nI have the following `WrapPolicy` defined:\r\n```csharp\r\nvar cachePolicy = Policy.CacheAsync(new MemoryCacheProvider(memoryCache), new RelativeTtl(cacheDuration), new DefaultCacheKeyStrategy(),\r\n    onCachePut: (context, key) => logger.LogInformation($\"Caching '{key}'.\"),\r\n    onCacheGet: (context, key) => logger.LogInformation($\"Retrieving '{key}' from the cache.\"),\r\n    onCachePutError: (context, key, exception) => logger.LogError(exception, $\"Cannot add '{key}' to the cache.\"),\r\n    onCacheGetError: (context, key, exception) => logger.LogError(exception, $\"Cannot retrieve '{key}' from the cache.\"),\r\n    onCacheMiss: (context, key) => logger.LogWarning($\"Cache miss for '{key}'.\"));\r\nvar retryPolicy = Policy\r\n    .Handle<HttpRequestException>()\r\n    .WaitAndRetryAsync(retries, retryAttempt => TimeSpan.FromSeconds(Math.Pow(2, retryAttempt)),\r\n        (exception, timeSpan, retry, context) =>\r\n        {\r\n            logger.LogWarning((HttpRequestException)exception, $\"Cannot load external data from '{context.ExecutionKey}'. Retry {retry}/{retries}.\");\r\n        }\r\n    );\r\n\r\npolicyRegistry.Add(\"CachedHttpResiliencePolicy\", Policy.WrapAsync(cachePolicy, retryPolicy));\r\n```\r\n\r\nWhat I would expect it to do, is to load the data from cache (via `cachePolicy`), if it's available, or use the `retryPolicy` to retrieve the data on cache-miss/error. What actually happens is that the cache policy is never used and the data is always retrieved from the remote location, using the `retryPolicy`.\r\n\r\nIf I change the `CachedHttpResiliencePolicy` to contain only `cachePolicy`, instead of `Policy.WrapAsync(cachePolicy, retryPolicy)`, the the caching is working as expected. Anyhow, I'm losing the retry functionality.\r\n\r\nAm I doing something incorrectly?\r\n\r\nThank you!\r\n","closed_by":{"login":"reisenberger","id":9608723,"node_id":"MDQ6VXNlcjk2MDg3MjM=","avatar_url":"https://avatars.githubusercontent.com/u/9608723?v=4","gravatar_id":"","url":"https://api.github.com/users/reisenberger","html_url":"https://github.com/reisenberger","followers_url":"https://api.github.com/users/reisenberger/followers","following_url":"https://api.github.com/users/reisenberger/following{/other_user}","gists_url":"https://api.github.com/users/reisenberger/gists{/gist_id}","starred_url":"https://api.github.com/users/reisenberger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reisenberger/subscriptions","organizations_url":"https://api.github.com/users/reisenberger/orgs","repos_url":"https://api.github.com/users/reisenberger/repos","events_url":"https://api.github.com/users/reisenberger/events{/privacy}","received_events_url":"https://api.github.com/users/reisenberger/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/App-vNext/Polly/issues/341/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/App-vNext/Polly/issues/341/timeline","performed_via_github_app":null,"state_reason":"completed"}