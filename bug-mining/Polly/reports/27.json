{"url":"https://api.github.com/repos/App-vNext/Polly/issues/1874","repository_url":"https://api.github.com/repos/App-vNext/Polly","labels_url":"https://api.github.com/repos/App-vNext/Polly/issues/1874/labels{/name}","comments_url":"https://api.github.com/repos/App-vNext/Polly/issues/1874/comments","events_url":"https://api.github.com/repos/App-vNext/Polly/issues/1874/events","html_url":"https://github.com/App-vNext/Polly/issues/1874","id":2061095025,"node_id":"I_kwDOAJaD5s562dBx","number":1874,"title":"[Question]: Replacing ResiliencePipelineProvider with keyed services","user":{"login":"pekspro","id":3163293,"node_id":"MDQ6VXNlcjMxNjMyOTM=","avatar_url":"https://avatars.githubusercontent.com/u/3163293?v=4","gravatar_id":"","url":"https://api.github.com/users/pekspro","html_url":"https://github.com/pekspro","followers_url":"https://api.github.com/users/pekspro/followers","following_url":"https://api.github.com/users/pekspro/following{/other_user}","gists_url":"https://api.github.com/users/pekspro/gists{/gist_id}","starred_url":"https://api.github.com/users/pekspro/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pekspro/subscriptions","organizations_url":"https://api.github.com/users/pekspro/orgs","repos_url":"https://api.github.com/users/pekspro/repos","events_url":"https://api.github.com/users/pekspro/events{/privacy}","received_events_url":"https://api.github.com/users/pekspro/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":38476909,"node_id":"MDU6TGFiZWwzODQ3NjkwOQ==","url":"https://api.github.com/repos/App-vNext/Polly/labels/question","name":"question","color":"cc317c","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/App-vNext/Polly/milestones/47","html_url":"https://github.com/App-vNext/Polly/milestone/47","labels_url":"https://api.github.com/repos/App-vNext/Polly/milestones/47/labels","id":10184411,"node_id":"MI_kwDOAJaD5s4Am2bb","number":47,"title":"v8.3.0","description":"","creator":{"login":"martincostello","id":1439341,"node_id":"MDQ6VXNlcjE0MzkzNDE=","avatar_url":"https://avatars.githubusercontent.com/u/1439341?v=4","gravatar_id":"","url":"https://api.github.com/users/martincostello","html_url":"https://github.com/martincostello","followers_url":"https://api.github.com/users/martincostello/followers","following_url":"https://api.github.com/users/martincostello/following{/other_user}","gists_url":"https://api.github.com/users/martincostello/gists{/gist_id}","starred_url":"https://api.github.com/users/martincostello/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martincostello/subscriptions","organizations_url":"https://api.github.com/users/martincostello/orgs","repos_url":"https://api.github.com/users/martincostello/repos","events_url":"https://api.github.com/users/martincostello/events{/privacy}","received_events_url":"https://api.github.com/users/martincostello/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":37,"state":"closed","created_at":"2023-11-14T08:35:34Z","updated_at":"2024-02-05T10:13:49Z","due_on":"2024-02-05T08:00:00Z","closed_at":"2024-02-05T09:58:05Z"},"comments":8,"created_at":"2023-12-31T15:32:12Z","updated_at":"2024-01-07T19:01:07Z","closed_at":"2024-01-07T19:01:07Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### What are you wanting to achieve?\n\nIn .NET 8, support for [keyed services](https://learn.microsoft.com/en-us/aspnet/core/mvc/controllers/dependency-injection?view=aspnetcore-8.0#action-injection-with-fromkeyedservices) has been added. I think this can replace `ResiliencePipelineProvider` in many scenarios. \n\n### What code or approach do you have so far?\n\nI did this little test:\r\n\r\n```C#\r\npublic class MyApi2\r\n{\r\n    private readonly ResiliencePipeline _pipeline;\r\n\r\n    public MyApi2([FromKeyedServices(\"my-pipeline2\")] ResiliencePipeline pipeline)\r\n    {\r\n        _pipeline = pipeline;\r\n    }\r\n\r\n    public async Task ExecuteAsync(CancellationToken cancellationToken)\r\n    {\r\n        await _pipeline.ExecuteAsync(\r\n            static async token =>\r\n            {\r\n                // Add your code here\r\n            },\r\n            cancellationToken);\r\n    }\r\n}\r\n\r\npublic static class MyApi2Extensions\r\n{\r\n    public static IServiceCollection AddMyApi2(this IServiceCollection services)\r\n    {\r\n        ResiliencePipeline pipeline = new ResiliencePipelineBuilder()\r\n            .AddRetry(new RetryStrategyOptions\r\n            {\r\n                MaxRetryAttempts = 4\r\n            })\r\n            .Build();\r\n\r\n        services.AddKeyedSingleton<ResiliencePipeline>(\"my-pipeline2\", pipeline);\r\n\r\n        services.AddSingleton<MyApi2>();\r\n\r\n        return services;\r\n    }\r\n}\r\n```\r\n\r\nThis seems to work. The main benefit of this is there is no longer a need to mock `ResiliencePipelineProvider` in unit tests.\r\n\r\nI have been a bit suspicious of keyed services, but for Polly it seems to be a perfect match ðŸ˜Š. But Iâ€™m a bit surprised there is no documentation about this, not any discussions. Are there any drawbacks with this approach? Feels like Iâ€™m missing something.\n\n### Additional context\n\n_No response_","closed_by":{"login":"martintmk","id":103487740,"node_id":"U_kgDOBisY_A","avatar_url":"https://avatars.githubusercontent.com/u/103487740?v=4","gravatar_id":"","url":"https://api.github.com/users/martintmk","html_url":"https://github.com/martintmk","followers_url":"https://api.github.com/users/martintmk/followers","following_url":"https://api.github.com/users/martintmk/following{/other_user}","gists_url":"https://api.github.com/users/martintmk/gists{/gist_id}","starred_url":"https://api.github.com/users/martintmk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martintmk/subscriptions","organizations_url":"https://api.github.com/users/martintmk/orgs","repos_url":"https://api.github.com/users/martintmk/repos","events_url":"https://api.github.com/users/martintmk/events{/privacy}","received_events_url":"https://api.github.com/users/martintmk/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/App-vNext/Polly/issues/1874/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/App-vNext/Polly/issues/1874/timeline","performed_via_github_app":null,"state_reason":"completed"}