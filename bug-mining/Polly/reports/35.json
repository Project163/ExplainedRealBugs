{"url":"https://api.github.com/repos/App-vNext/Polly/issues/2375","repository_url":"https://api.github.com/repos/App-vNext/Polly","labels_url":"https://api.github.com/repos/App-vNext/Polly/issues/2375/labels{/name}","comments_url":"https://api.github.com/repos/App-vNext/Polly/issues/2375/comments","events_url":"https://api.github.com/repos/App-vNext/Polly/issues/2375/events","html_url":"https://github.com/App-vNext/Polly/issues/2375","id":2650319038,"node_id":"I_kwDOAJaD5s6d-Ki-","number":2375,"title":"[Bug]: Inconsistent behavior when canceling a retry","user":{"login":"kmcclellan","id":43862801,"node_id":"MDQ6VXNlcjQzODYyODAx","avatar_url":"https://avatars.githubusercontent.com/u/43862801?v=4","gravatar_id":"","url":"https://api.github.com/users/kmcclellan","html_url":"https://github.com/kmcclellan","followers_url":"https://api.github.com/users/kmcclellan/followers","following_url":"https://api.github.com/users/kmcclellan/following{/other_user}","gists_url":"https://api.github.com/users/kmcclellan/gists{/gist_id}","starred_url":"https://api.github.com/users/kmcclellan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kmcclellan/subscriptions","organizations_url":"https://api.github.com/users/kmcclellan/orgs","repos_url":"https://api.github.com/users/kmcclellan/repos","events_url":"https://api.github.com/users/kmcclellan/events{/privacy}","received_events_url":"https://api.github.com/users/kmcclellan/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":38476905,"node_id":"MDU6TGFiZWwzODQ3NjkwNQ==","url":"https://api.github.com/repos/App-vNext/Polly/labels/bug","name":"bug","color":"fc2929","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/App-vNext/Polly/milestones/55","html_url":"https://github.com/App-vNext/Polly/milestone/55","labels_url":"https://api.github.com/repos/App-vNext/Polly/milestones/55/labels","id":12158580,"node_id":"MI_kwDOAJaD5s4AuYZ0","number":55,"title":"v8.5.2","description":"","creator":{"login":"martincostello","id":1439341,"node_id":"MDQ6VXNlcjE0MzkzNDE=","avatar_url":"https://avatars.githubusercontent.com/u/1439341?v=4","gravatar_id":"","url":"https://api.github.com/users/martincostello","html_url":"https://github.com/martincostello","followers_url":"https://api.github.com/users/martincostello/followers","following_url":"https://api.github.com/users/martincostello/following{/other_user}","gists_url":"https://api.github.com/users/martincostello/gists{/gist_id}","starred_url":"https://api.github.com/users/martincostello/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martincostello/subscriptions","organizations_url":"https://api.github.com/users/martincostello/orgs","repos_url":"https://api.github.com/users/martincostello/repos","events_url":"https://api.github.com/users/martincostello/events{/privacy}","received_events_url":"https://api.github.com/users/martincostello/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":3,"state":"closed","created_at":"2025-01-13T18:02:11Z","updated_at":"2025-02-04T11:45:16Z","due_on":"2025-02-04T08:00:00Z","closed_at":"2025-02-04T11:45:03Z"},"comments":11,"created_at":"2024-11-11T20:27:56Z","updated_at":"2025-02-04T12:13:47Z","closed_at":"2025-02-04T08:43:30Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\nIf I cancel an execution that has been handled by a retry policy, it may or may not return the last executed outcome.\r\n\r\n\r\n### Expected behavior\r\n\r\nThere is some question as to what should happen when you trigger cancellation for a resilience strategy that has already invoked the callback but has more work to do. On the one hand, the caller may want to know that execution did not complete per configuration (esp. if the intent is to retry indefinitely). On the other, the invocation may have had side effects, and we do have an outcome that the caller might be interested in.\r\n\r\nIn my opinion, callbacks passed to resilience pipelines shouldn't make assumptions about how they will be executed and should include a `catch` to clean up any side-effects. Therefore, a retry strategy that _would have_ attempted additional invocations should acknowledge cancellation by throwing `OperationCanceledException` regardless of whether it has executed the callback or what delay configuration is in place.\r\n\r\nHowever, if instead we want the retry strategy to return the last executed outcome, it should do so consistently and refrain from acknowledging cancellation if invocation has completed at least once.\r\n\r\n### Actual behavior\r\n\r\nIf the cancellation token is in the requested state at the time an invocation of the callback completes, [that outcome is returned to the caller](https://github.com/App-vNext/Polly/blob/7567acc330c9f74d6c7b14897a8ef4d15e9d475a/src/Polly.Core/Retry/RetryResilienceStrategy.cs#L72). If the token is instead triggered during the subsequent delay between attempts, [an `OperationCanceledException` outcome is returned](https://github.com/App-vNext/Polly/blob/7567acc330c9f74d6c7b14897a8ef4d15e9d475a/src/Polly.Core/Retry/RetryResilienceStrategy.cs#L110).\r\n\r\n### Steps to reproduce\r\n\r\n```csharp\r\nusing Polly;\r\n\r\nvar pipeline = new ResiliencePipelineBuilder<int>()\r\n    .AddRetry(\r\n        new()\r\n        {\r\n            ShouldHandle = x => ValueTask.FromResult(x.Outcome.Result < 10),\r\n            MaxRetryAttempts = 10,\r\n            Delay = TimeSpan.FromSeconds(2),\r\n        })\r\n    .Build();\r\n\r\nawait TestCancel(TimeSpan.FromSeconds(1));\r\nawait TestCancel(TimeSpan.FromSeconds(3));\r\nawait TestCancel(TimeSpan.FromSeconds(5));\r\nawait TestCancel(TimeSpan.FromSeconds(7));\r\n\r\nasync Task TestCancel(TimeSpan duration)\r\n{\r\n    try\r\n    {\r\n        using var cancellation = new CancellationTokenSource(duration);\r\n        var n = 0;\r\n\r\n        var result = await pipeline.ExecuteAsync(\r\n            async cancellationToken =>\r\n            {\r\n                Console.WriteLine($\"Attempt: {n}\");\r\n                await Task.Delay(2000, CancellationToken.None);\r\n                return n++;\r\n            },\r\n            cancellation.Token);\r\n\r\n        Console.WriteLine($\"Execution completed: {result}\");\r\n    }\r\n    catch (OperationCanceledException)\r\n    {\r\n        Console.WriteLine(\"Execution was canceled.\");\r\n    }\r\n}\r\n```\r\n\r\n```\r\nAttempt: 0\r\nExecution completed: 0\r\nAttempt: 0\r\nExecution was canceled.\r\nAttempt: 0\r\nAttempt: 1\r\nExecution completed: 1\r\nAttempt: 0\r\nAttempt: 1\r\nExecution was canceled.\r\n```\r\n\r\n### Exception(s) (if any)\r\n\r\n_No response_\r\n\r\n### Polly version\r\n\r\n8.4.2\r\n\r\n### .NET Version\r\n\r\n8.0.403\r\n\r\n### Anything else?\r\n\r\n_No response_","closed_by":{"login":"martincostello","id":1439341,"node_id":"MDQ6VXNlcjE0MzkzNDE=","avatar_url":"https://avatars.githubusercontent.com/u/1439341?v=4","gravatar_id":"","url":"https://api.github.com/users/martincostello","html_url":"https://github.com/martincostello","followers_url":"https://api.github.com/users/martincostello/followers","following_url":"https://api.github.com/users/martincostello/following{/other_user}","gists_url":"https://api.github.com/users/martincostello/gists{/gist_id}","starred_url":"https://api.github.com/users/martincostello/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martincostello/subscriptions","organizations_url":"https://api.github.com/users/martincostello/orgs","repos_url":"https://api.github.com/users/martincostello/repos","events_url":"https://api.github.com/users/martincostello/events{/privacy}","received_events_url":"https://api.github.com/users/martincostello/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/App-vNext/Polly/issues/2375/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/App-vNext/Polly/issues/2375/timeline","performed_via_github_app":null,"state_reason":"completed"}