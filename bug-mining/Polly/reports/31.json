{"url":"https://api.github.com/repos/App-vNext/Polly/issues/2315","repository_url":"https://api.github.com/repos/App-vNext/Polly","labels_url":"https://api.github.com/repos/App-vNext/Polly/issues/2315/labels{/name}","comments_url":"https://api.github.com/repos/App-vNext/Polly/issues/2315/comments","events_url":"https://api.github.com/repos/App-vNext/Polly/issues/2315/events","html_url":"https://github.com/App-vNext/Polly/issues/2315","id":2553882522,"node_id":"I_kwDOAJaD5s6YOSea","number":2315,"title":"[Bug]: HedgingResilienceStrategyTests.ExecuteAsync_OnHedgingEventThrows_EnsureExceptionRethrown fails on debug mode","user":{"login":"gabidabet","id":42586945,"node_id":"MDQ6VXNlcjQyNTg2OTQ1","avatar_url":"https://avatars.githubusercontent.com/u/42586945?v=4","gravatar_id":"","url":"https://api.github.com/users/gabidabet","html_url":"https://github.com/gabidabet","followers_url":"https://api.github.com/users/gabidabet/followers","following_url":"https://api.github.com/users/gabidabet/following{/other_user}","gists_url":"https://api.github.com/users/gabidabet/gists{/gist_id}","starred_url":"https://api.github.com/users/gabidabet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gabidabet/subscriptions","organizations_url":"https://api.github.com/users/gabidabet/orgs","repos_url":"https://api.github.com/users/gabidabet/repos","events_url":"https://api.github.com/users/gabidabet/events{/privacy}","received_events_url":"https://api.github.com/users/gabidabet/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":38476905,"node_id":"MDU6TGFiZWwzODQ3NjkwNQ==","url":"https://api.github.com/repos/App-vNext/Polly/labels/bug","name":"bug","color":"fc2929","default":true,"description":null}],"state":"closed","locked":false,"assignee":{"login":"peter-csala","id":57183693,"node_id":"MDQ6VXNlcjU3MTgzNjkz","avatar_url":"https://avatars.githubusercontent.com/u/57183693?v=4","gravatar_id":"","url":"https://api.github.com/users/peter-csala","html_url":"https://github.com/peter-csala","followers_url":"https://api.github.com/users/peter-csala/followers","following_url":"https://api.github.com/users/peter-csala/following{/other_user}","gists_url":"https://api.github.com/users/peter-csala/gists{/gist_id}","starred_url":"https://api.github.com/users/peter-csala/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/peter-csala/subscriptions","organizations_url":"https://api.github.com/users/peter-csala/orgs","repos_url":"https://api.github.com/users/peter-csala/repos","events_url":"https://api.github.com/users/peter-csala/events{/privacy}","received_events_url":"https://api.github.com/users/peter-csala/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"peter-csala","id":57183693,"node_id":"MDQ6VXNlcjU3MTgzNjkz","avatar_url":"https://avatars.githubusercontent.com/u/57183693?v=4","gravatar_id":"","url":"https://api.github.com/users/peter-csala","html_url":"https://github.com/peter-csala","followers_url":"https://api.github.com/users/peter-csala/followers","following_url":"https://api.github.com/users/peter-csala/following{/other_user}","gists_url":"https://api.github.com/users/peter-csala/gists{/gist_id}","starred_url":"https://api.github.com/users/peter-csala/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/peter-csala/subscriptions","organizations_url":"https://api.github.com/users/peter-csala/orgs","repos_url":"https://api.github.com/users/peter-csala/repos","events_url":"https://api.github.com/users/peter-csala/events{/privacy}","received_events_url":"https://api.github.com/users/peter-csala/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":2,"created_at":"2024-09-27T23:35:07Z","updated_at":"2024-10-01T13:40:30Z","closed_at":"2024-10-01T13:40:30Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nWhen I run tests from Visual Studio with debug configuration, the tests Polly.Core.Tests.Hedging.HedgingResilienceStrategyTests.ExecuteAsync_OnHedgingEventThrows_EnsureExceptionRethrown fails.\r\n![image](https://github.com/user-attachments/assets/8cc7ffbc-0f0e-469d-a59f-a3be2373fa4c)\r\n\r\n\r\n\n\n### Expected behavior\n\nAll tests must pass.\n\n### Actual behavior\n\nthe test Polly.Core.Tests.Hedging.HedgingResilienceStrategyTests.ExecuteAsync_OnHedgingEventThrows_EnsureExceptionRethrown fails with an exception on debug mode \n\n### Steps to reproduce\n\nUse Visual Studio Runner to run tests with debug configuration.\n\n### Exception(s) (if any)\n\n```\r\nMessage: \r\nExpected a <System.InvalidOperationException> to be thrown, but found <Microsoft.VisualStudio.TestPlatform.TestHost.DebugAssertException>:\r\nMicrosoft.VisualStudio.TestPlatform.TestHost.DebugAssertException: Method Debug.Fail failed with 'There must be exactly one accepted outcome for hedging. Found 0.\r\n', and was translated to Microsoft.VisualStudio.TestPlatform.TestHost.DebugAssertException to avoid terminating the process hosting the test.\r\n   at Microsoft.VisualStudio.TestPlatform.TestHost.TestHostTraceListener.GetException(String message) in /_/src/testhost.x86/TestHostTraceListener.cs:line 48\r\n   at Microsoft.VisualStudio.TestPlatform.TestHost.TestHostTraceListener.Fail(String message, String detailMessage) in /_/src/testhost.x86/TestHostTraceListener.cs:line 43\r\n   at System.Diagnostics.TraceInternal.Fail(String message, String detailMessage)\r\n   at System.Diagnostics.Debug.Fail(String message, String detailMessage)\r\n   at Polly.Hedging.Utils.HedgingExecutionContext`1.UpdateOriginalContext() in C:\\Users\\pc\\source\\repos\\Polly\\src\\Polly.Core\\Hedging\\Controller\\HedgingExecutionContext.cs:line 202\r\n   at Polly.Hedging.Utils.HedgingExecutionContext`1.DisposeAsync() in C:\\Users\\pc\\source\\repos\\Polly\\src\\Polly.Core\\Hedging\\Controller\\HedgingExecutionContext.cs:line 78\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n   at Polly.Hedging.Utils.HedgingExecutionContext`1.DisposeAsync()\r\n   at Polly.Hedging.HedgingResilienceStrategy`1.ExecuteCore[TState](Func`3 callback, ResilienceContext context, TState state) in C:\\Users\\pc\\source\\repos\\Polly\\src\\Polly.Core\\Hedging\\HedgingResilienceStrategy.cs:line 49\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n   at Polly.Hedging.HedgingResilienceStrategy`1.ExecuteCore[TState](Func`3 callback, ResilienceContext context, TState state)\r\n   at Polly.Utils.Pipeline.BridgeComponent`1.ExecuteCore[TResult,TState](Func`3 callback, ResilienceContext context, TState state) in C:\\Users\\pc\\source\\repos\\Polly\\src\\Polly.Core\\Utils\\Pipeline\\BridgeComponent.TResult.cs:line 17\r\n   at Polly.Utils.Pipeline.CompositeComponent.ExecuteCoreWithoutTelemetry[TResult,TState](Func`3 callback, ResilienceContext context, TState state) in C:\\Users\\pc\\source\\repos\\Polly\\src\\Polly.Core\\Utils\\Pipeline\\CompositeComponent.cs:line 96\r\n   at Polly.Utils.Pipeline.CompositeComponent.ExecuteCore[TResult,TState](Func`3 callback, ResilienceContext context, TState state) in C:\\Users\\pc\\source\\repos\\Polly\\src\\Polly.Core\\Utils\\Pipeline\\CompositeComponent.cs:line 79\r\n   at Polly.ResiliencePipeline.ExecuteAsync[TResult](Func`2 callback, CancellationToken cancellationToken)\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n   at Polly.ResiliencePipeline.ExecuteAsync[TResult](Func`2 callback, CancellationToken cancellationToken)\r\n   at Polly.ResiliencePipeline`1.ExecuteAsync[TResult](Func`2 callback, CancellationToken cancellationToken) in C:\\Users\\pc\\source\\repos\\Polly\\src\\Polly.Core\\ResiliencePipelineT.Async.cs:line 84\r\n   at Polly.Core.Tests.Hedging.HedgingResilienceStrategyTests.<>c.<ExecuteAsync_OnHedgingEventThrows_EnsureExceptionRethrown>b__31_3(ResiliencePipeline`1 s) in C:\\Users\\pc\\source\\repos\\Polly\\test\\Polly.Core.Tests\\Hedging\\HedgingResilienceStrategyTests.cs:line 528\r\n   at FluentAssertions.AssertionExtensions.<>c__DisplayClass2_0`2.<Invoking>b__0()\r\n   at FluentAssertions.Specialized.AsyncFunctionAssertions`2.InvokeWithInterceptionAsync(Func`1 action)\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n   at FluentAssertions.Specialized.AsyncFunctionAssertions`2.InvokeWithInterceptionAsync(Func`1 action)\r\n   at FluentAssertions.Specialized.AsyncFunctionAssertions`2.ThrowAsync[TException](String because, Object[] becauseArgs)\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n   at FluentAssertions.Specialized.AsyncFunctionAssertions`2.ThrowAsync[TException](String because, Object[] becauseArgs)\r\n   at Polly.Core.Tests.Hedging.HedgingResilienceStrategyTests.ExecuteAsync_OnHedgingEventThrows_EnsureExceptionRethrown() in C:\\Users\\pc\\source\\repos\\Polly\\test\\Polly.Core.Tests\\Hedging\\HedgingResilienceStrategyTests.cs:line 527\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n   at Polly.Core.Tests.Hedging.HedgingResilienceStrategyTests.ExecuteAsync_OnHedgingEventThrows_EnsureExceptionRethrown()\r\n   at System.RuntimeMethodHandle.InvokeMethod(Object target, Void** arguments, Signature sig, Boolean isConstructor)\r\n   at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)\r\n   at System.Reflection.MethodBase.Invoke(Object obj, Object[] parameters)\r\n   at Xunit.Sdk.TestInvoker`1.CallTestMethod(Object testClassInstance) in /_/src/xunit.execution/Sdk/Frameworks/Runners/TestInvoker.cs:line 149\r\n   at Xunit.Sdk.TestInvoker`1.<>c__DisplayClass47_0.<<InvokeTestMethodAsync>b__1>d.MoveNext() in /_/src/xunit.execution/Sdk/Frameworks/Runners/TestInvoker.cs:line 256\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n   at Xunit.Sdk.TestInvoker`1.<>c__DisplayClass47_0.<InvokeTestMethodAsync>b__1()\r\n   at Xunit.Sdk.ExecutionTimer.AggregateAsync(Func`1 asyncAction) in /_/src/xunit.execution/Sdk/Frameworks/ExecutionTimer.cs:line 48\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n   at Xunit.Sdk.ExecutionTimer.AggregateAsync(Func`1 asyncAction)\r\n   at Xunit.Sdk.TestInvoker`1.<>c__DisplayClass47_0.<InvokeTestMethodAsync>b__0() in /_/src/xunit.execution/Sdk/Frameworks/Runners/TestInvoker.cs:line 215\r\n   at Xunit.Sdk.ExceptionAggregator.RunAsync(Func`1 code) in /_/src/xunit.core/Sdk/ExceptionAggregator.cs:line 90\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n   at Xunit.Sdk.ExceptionAggregator.RunAsync(Func`1 code)\r\n   at Xunit.Sdk.TestInvoker`1.InvokeTestMethodAsync(Object testClassInstance) in /_/src/xunit.execution/Sdk/Frameworks/Runners/TestInvoker.cs:line 214\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n   at Xunit.Sdk.TestInvoker`1.InvokeTestMethodAsync(Object testClassInstance)\r\n   at Xunit.Sdk.XunitTestInvoker.InvokeTestMethodAsync(Object testClassInstance) in /_/src/xunit.execution/Sdk/Frameworks/Runners/XunitTestInvoker.cs:line 112\r\n   at Xunit.Sdk.TestInvoker`1.<RunAsync>b__46_0() in /_/src/xunit.execution/Sdk/Frameworks/Runners/TestInvoker.cs:line 180\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n   at Xunit.Sdk.TestInvoker`1.<RunAsync>b__46_0()\r\n   at Xunit.Sdk.ExceptionAggregator.RunAsync[T](Func`1 code) in /_/src/xunit.core/Sdk/ExceptionAggregator.cs:line 107\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n   at Xunit.Sdk.ExceptionAggregator.RunAsync[T](Func`1 code)\r\n   at Xunit.Sdk.TestInvoker`1.RunAsync() in /_/src/xunit.execution/Sdk/Frameworks/Runners/TestInvoker.cs:line 163\r\n   at Xunit.Sdk.XunitTestRunner.InvokeTestMethodAsync(ExceptionAggregator aggregator) in /_/src/xunit.execution/Sdk/Frameworks/Runners/XunitTestRunner.cs:line 88\r\n   at Xunit.Sdk.XunitTestRunner.InvokeTestAsync(ExceptionAggregator aggregator) in /_/src/xunit.execution/Sdk/Frameworks/Runners/XunitTestRunner.cs:line 70\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n   at Xunit.Sdk.XunitTestRunner.InvokeTestAsync(ExceptionAggregator aggregator)\r\n   at Xunit.Sdk.TestRunner`1.<>c__DisplayClass43_0.<RunAsync>b__0() in /_/src/xunit.execution/Sdk/Frameworks/Runners/TestRunner.cs:line 149\r\n   at Xunit.Sdk.ExceptionAggregator.RunAsync[T](Func`1 code) in /_/src/xunit.core/Sdk/ExceptionAggregator.cs:line 107\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n   at Xunit.Sdk.ExceptionAggregator.RunAsync[T](Func`1 code)\r\n   at Xunit.Sdk.TestRunner`1.RunAsync() in /_/src/xunit.execution/Sdk/Frameworks/Runners/TestRunner.cs:line 149\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n   at Xunit.Sdk.TestRunner`1.RunAsync()\r\n   at Xunit.Sdk.XunitTestCaseRunner.RunTestAsync() in /_/src/xunit.execution/Sdk/Frameworks/Runners/XunitTestCaseRunner.cs:line 140\r\n   at Xunit.Sdk.TestCaseRunner`1.RunAsync() in /_/src/xunit.execution/Sdk/Frameworks/Runners/TestCaseRunner.cs:line 82\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n   at Xunit.Sdk.TestCaseRunner`1.RunAsync()\r\n   at Xunit.Sdk.XunitTestCase.RunAsync(IMessageSink diagnosticMessageSink, IMessageBus messageBus, Object[] constructorArguments, ExceptionAggregator aggregator, CancellationTokenSource cancellationTokenSource) in /_/src/xunit.execution/Sdk/Frameworks/XunitTestCase.cs:line 170\r\n   at Xunit.Sdk.XunitTestMethodRunner.RunTestCaseAsync(IXunitTestCase testCase) in /_/src/xunit.execution/Sdk/Frameworks/Runners/XunitTestMethodRunner.cs:line 45\r\n   at Xunit.Sdk.TestMethodRunner`1.RunTestCasesAsync() in /_/src/xunit.execution/Sdk/Frameworks/Runners/TestMethodRunner.cs:line 136\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachine)\r\n   at Xunit.Sdk.TestMethodRunner`1.RunTestCasesAsync()\r\n   at Xunit.Sdk.TestMethodRunner`1.RunAsync() in /_/src/xunit.execution/Sdk/Frameworks/Runners/TestMethodRunner.cs:line 106\r\n   at System.Runtime.CompilerServices.AsyncMethodBuilderCore.Start[TStateMachine](TStateMachine& stateMachin\r\n... <truncated>\r\n\r\n  Stack Trace: \r\nXUnit2TestFramework.Throw(String message)\r\nTestFrameworkProvider.Throw(String message)\r\nDefaultAssertionStrategy.HandleFailure(String message)\r\nAssertionScope.FailWith(Func`1 failReasonFunc)\r\nAssertionScope.FailWith(Func`1 failReasonFunc)\r\nAssertionScope.FailWith(String message, Object[] args)\r\nDelegateAssertionsBase`2.ThrowInternal[TException](Exception exception, String because, Object[] becauseArgs)\r\nAsyncFunctionAssertions`2.ThrowAsync[TException](String because, Object[] becauseArgs)\r\nHedgingResilienceStrategyTests.ExecuteAsync_OnHedgingEventThrows_EnsureExceptionRethrown() line 527\r\n--- End of stack trace from previous location ---\r\n\r\n  (result has additional output)\r\n```\n\n### Polly version\n\nmain\n\n### .NET Version\n\nnet8.0 (sdk: 8.0.402)\n\n### Anything else?\n\n_No response_","closed_by":{"login":"martincostello","id":1439341,"node_id":"MDQ6VXNlcjE0MzkzNDE=","avatar_url":"https://avatars.githubusercontent.com/u/1439341?v=4","gravatar_id":"","url":"https://api.github.com/users/martincostello","html_url":"https://github.com/martincostello","followers_url":"https://api.github.com/users/martincostello/followers","following_url":"https://api.github.com/users/martincostello/following{/other_user}","gists_url":"https://api.github.com/users/martincostello/gists{/gist_id}","starred_url":"https://api.github.com/users/martincostello/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martincostello/subscriptions","organizations_url":"https://api.github.com/users/martincostello/orgs","repos_url":"https://api.github.com/users/martincostello/repos","events_url":"https://api.github.com/users/martincostello/events{/privacy}","received_events_url":"https://api.github.com/users/martincostello/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/App-vNext/Polly/issues/2315/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/App-vNext/Polly/issues/2315/timeline","performed_via_github_app":null,"state_reason":"completed"}