<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:55:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FILEUPLOAD-143] &quot;Stream ended unexpectedly&quot; when posting from a Flash client</title>
                <link>https://issues.apache.org/jira/browse/FILEUPLOAD-143</link>
                <project id="12310476" key="FILEUPLOAD">Commons FileUpload</project>
                    <description>&lt;p&gt;I setup an upload script under a JSP. I tested it by uploading a file via html form upload and it worked fine - the file was received.&lt;/p&gt;

&lt;p&gt;But when I tried uploading the file through a flash interface using the FileReference object I got a 500 error response. Flash&apos;s FileReference API was very vague, and I was unable to reproduce the error under another interface so I could see the error.... But I finnally did get something back by writing a catch and writing the error to a file. I don&apos;t know if this is accurate or not:&lt;/p&gt;

&lt;p&gt;&quot;Stream ended unexpectedly&quot;&lt;/p&gt;

&lt;p&gt;I do know that the error occurs when this line is ran:&lt;/p&gt;

&lt;p&gt;List items = upload.parseRequest(request);&lt;/p&gt;

&lt;p&gt;And here is some relevant code, but not all of it: (to show that I do have a factory set):&lt;/p&gt;

&lt;p&gt;DiskFileItemFactory factory = new DiskFileItemFactory();&lt;br/&gt;
factory.setSizeThreshold(524288000);&lt;br/&gt;
ServletFileUpload upload = new ServletFileUpload(factory);&lt;br/&gt;
upload.setSizeMax(524288000);&lt;br/&gt;
List items = upload.parseRequest(request);&lt;/p&gt;

&lt;p&gt;I am fairly sure that flash is doing something that is throwing commons-fileupload off. But it does work with apache &amp;amp; php...&lt;/p&gt;

&lt;p&gt;The biggest difference in the headers, or at least the initial headers, is flash passes a &quot;connection: close&quot; header.&lt;/p&gt;

&lt;p&gt;When searching I came up with some vague answers. This page shows some comments at the bottom by users with similar problems:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://livedocs.adobe.com/flash/8/main/wwhelp/wwhimpl/common/html/wwhelp.htm?context=LiveDocs_Parts&amp;amp;file=00002225.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://livedocs.adobe.com/flash/8/main/wwhelp/wwhimpl/common/html/wwhelp.htm?context=LiveDocs_Parts&amp;amp;file=00002225.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;One guy posts a solution to fix the problem, but it seems like it is severely out of date because where it says &quot;return items;&quot; I do not see items declared in the function of the line he mentions. Plus he mentions line 336, and it&apos;s now on 800 something. Tried his suggestion but instead returned &quot;true&quot; and &quot;false&quot; (tried both ways) but it didn&apos;t work... Also when I tried his catch line ant said it was invalid, so I had to put &quot;Exception e&quot; instead. You may notice that his post is in all caps (posts after his appear to be for some reason). I did make sure to use the proper case (i do know of case sensitivity).&lt;/p&gt;

&lt;p&gt;With further reading I read instances where flash did a &quot;test upload&quot; without sending the file. In other cases I read something about it not sending to blank lines after the header. Not sure what my current problem is.... I&apos;m sure once the problem is found, it should be fairly trivial to fix (i hope).&lt;/p&gt;

&lt;p&gt;Even though it may be flash&apos;s fault, it works in PHP and other instances... So it should work here &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Thanks in advance,&lt;/p&gt;

&lt;p&gt;-Luke&lt;/p&gt;</description>
                <environment>&lt;p&gt;CentOS 4.4, Jetty running through Red5 (form of Flash Media Server), code under JSP&lt;/p&gt;</environment>
        <key id="12375379">FILEUPLOAD-143</key>
            <summary>&quot;Stream ended unexpectedly&quot; when posting from a Flash client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jochen@apache.org">Jochen Wiedmann</assignee>
                                    <reporter username="lukescott">Luke Scott</reporter>
                        <labels>
                    </labels>
                <created>Sun, 5 Aug 2007 06:31:00 +0000</created>
                <updated>Tue, 6 Jun 2017 04:47:05 +0000</updated>
                            <resolved>Mon, 11 Mar 2013 10:34:12 +0000</resolved>
                                    <version>1.2</version>
                                    <fixVersion>1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="12517782" author="jochen@apache.org" created="Sun, 5 Aug 2007 19:11:58 +0000"  >&lt;p&gt;It&apos;s impossible to diagnose the problem without some sort of trace. Such a trace might be created by using tools like tcpmon, or wireshark.&lt;/p&gt;</comment>
                            <comment id="12517791" author="lukescott" created="Sun, 5 Aug 2007 21:20:48 +0000"  >&lt;p&gt;Other than the information I&apos;ve given you, I have no idea how to do that because of my lack of experience. I know that it does work with a standard html upload, just not the flash... I&apos;m trying to get the complete body of the post, but I&apos;m not sure how to do that with java.  I got the error message through e.getMessage() in a catch statement. Flash doesn&apos;t give me the whole response. I&apos;ll be happy to get you more information, but I may need some assistance in getting it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="12519472" author="lukescott" created="Mon, 13 Aug 2007 16:58:34 +0000"  >&lt;p&gt;Finnally figured out how to get a stack trace. Here it is:&lt;/p&gt;

&lt;p&gt;org.apache.commons.fileupload.FileUploadException: Stream ended unexpectedly&lt;br/&gt;
	at org.apache.commons.fileupload.FileUploadBase.parseRequest(FileUploadBase.java:369)&lt;br/&gt;
	at org.apache.commons.fileupload.servlet.ServletFileUpload.parseRequest(ServletFileUpload.java:126)&lt;br/&gt;
	at org.apache.jsp.index_jsp._jspService(index_jsp.java:84)&lt;br/&gt;
	at org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:70)&lt;br/&gt;
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:803)&lt;br/&gt;
	at org.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:384)&lt;br/&gt;
	at org.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:320)&lt;br/&gt;
	at org.apache.jasper.servlet.JspServlet.service(JspServlet.java:266)&lt;br/&gt;
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:803)&lt;br/&gt;
	at org.mortbay.jetty.servlet.ServletHolder.handle(ServletHolder.java:491)&lt;br/&gt;
	at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:367)&lt;br/&gt;
	at org.mortbay.jetty.security.SecurityHandler.handle(SecurityHandler.java:185)&lt;br/&gt;
	at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:181)&lt;br/&gt;
	at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:689)&lt;br/&gt;
	at org.mortbay.jetty.webapp.WebAppContext.handle(WebAppContext.java:391)&lt;br/&gt;
	at org.mortbay.jetty.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:146)&lt;br/&gt;
	at org.mortbay.jetty.handler.HandlerCollection.handle(HandlerCollection.java:114)&lt;br/&gt;
	at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:139)&lt;br/&gt;
	at org.mortbay.jetty.Server.handle(Server.java:285)&lt;br/&gt;
	at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:457)&lt;br/&gt;
	at org.mortbay.jetty.HttpConnection$RequestHandler.content(HttpConnection.java:765)&lt;br/&gt;
	at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:627)&lt;br/&gt;
	at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:203)&lt;br/&gt;
	at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:357)&lt;br/&gt;
	at org.mortbay.io.nio.SelectChannelEndPoint.run(SelectChannelEndPoint.java:329)&lt;br/&gt;
	at org.mortbay.thread.BoundedThreadPool$PoolThread.run(BoundedThreadPool.java:475)&lt;br/&gt;
Caused by:&lt;br/&gt;
org.apache.commons.fileupload.MultipartStream$MalformedStreamException: Stream ended unexpectedly&lt;br/&gt;
	at org.apache.commons.fileupload.MultipartStream.readHeaders(MultipartStream.java:542)&lt;br/&gt;
	at org.apache.commons.fileupload.FileUploadBase$FileItemIteratorImpl.findNextItem(FileUploadBase.java:859)&lt;br/&gt;
	at org.apache.commons.fileupload.FileUploadBase$FileItemIteratorImpl.hasNext(FileUploadBase.java:916)&lt;br/&gt;
	at org.apache.commons.fileupload.FileUploadBase.parseRequest(FileUploadBase.java:348)&lt;br/&gt;
	at org.apache.commons.fileupload.servlet.ServletFileUpload.parseRequest(ServletFileUpload.java:126)&lt;br/&gt;
	at org.apache.jsp.index_jsp._jspService(index_jsp.java:84)&lt;br/&gt;
	at org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:70)&lt;br/&gt;
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:803)&lt;br/&gt;
	at org.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:384)&lt;br/&gt;
	at org.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:320)&lt;br/&gt;
	at org.apache.jasper.servlet.JspServlet.service(JspServlet.java:266)&lt;br/&gt;
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:803)&lt;br/&gt;
	at org.mortbay.jetty.servlet.ServletHolder.handle(ServletHolder.java:491)&lt;br/&gt;
	at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:367)&lt;br/&gt;
	at org.mortbay.jetty.security.SecurityHandler.handle(SecurityHandler.java:185)&lt;br/&gt;
	at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:181)&lt;br/&gt;
	at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:689)&lt;br/&gt;
	at org.mortbay.jetty.webapp.WebAppContext.handle(WebAppContext.java:391)&lt;br/&gt;
	at org.mortbay.jetty.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:146)&lt;br/&gt;
	at org.mortbay.jetty.handler.HandlerCollection.handle(HandlerCollection.java:114)&lt;br/&gt;
	at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:139)&lt;br/&gt;
	at org.mortbay.jetty.Server.handle(Server.java:285)&lt;br/&gt;
	at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:457)&lt;br/&gt;
	at org.mortbay.jetty.HttpConnection$RequestHandler.content(HttpConnection.java:765)&lt;br/&gt;
	at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:627)&lt;br/&gt;
	at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:203)&lt;br/&gt;
	at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:357)&lt;br/&gt;
	at org.mortbay.io.nio.SelectChannelEndPoint.run(SelectChannelEndPoint.java:329)&lt;br/&gt;
	at org.mortbay.thread.BoundedThreadPool$PoolThread.run(BoundedThreadPool.java:475)&lt;/p&gt;</comment>
                            <comment id="12519493" author="jochen@apache.org" created="Mon, 13 Aug 2007 19:22:56 +0000"  >&lt;p&gt;That&apos;s not the trace I was thinking of. The stack trace only demonstrates, that commons fileupload believes that the input stream terminates prematurely. In other words, that the input stream is corrupt.&lt;/p&gt;

&lt;p&gt;My guess would be that the library is right and that, for example, the network connection broke or something similar. However, it is also possible that there&apos;s a bug in the library. To diagnose that, I&apos;d need a trace of the data, which the browser has sent. Such a trace can easily be obtained with tools like tcpmon or wireshark.&lt;/p&gt;</comment>
                            <comment id="12519500" author="lukescott" created="Mon, 13 Aug 2007 19:59:44 +0000"  >&lt;p&gt;I&apos;m fairly sure I figured out what&apos;s causing this. It turns out Flash 8 (not sure about 9) doesn&apos;t properly terminate the final boundary. The final boundary should end with a &quot;--&quot;, but it doesn&apos;t. Because of this, commons-fileupload is throwing an exception.&lt;/p&gt;

&lt;p&gt;Other interfaces like PHP catch the error, but allows the file to be uploaded anyway. Somehow commons-fileupload needs to do the same thing.&lt;/p&gt;

&lt;p&gt;Here are the headers, minus the data for obvious reasons:&lt;/p&gt;

&lt;p&gt;POST /index.html HTTP/1.1&lt;br/&gt;
Connection: close&lt;br/&gt;
User-Agent: Macromedia Flash Player 8&lt;br/&gt;
X-Flash-Version: 8,0,22,0&lt;br/&gt;
Accept-Types: text/*&lt;br/&gt;
Content-Type: multipart/form-data; boundary=----------gL6Ij5ei4gL6Ef1GI3gL6gL6KM7cH2&lt;br/&gt;
Content-Length: 35122482&lt;br/&gt;
Host: localhost:4242&lt;/p&gt;

&lt;p&gt;------------gL6Ij5ei4gL6Ef1GI3gL6gL6KM7cH2&lt;br/&gt;
Content-Disposition: form-data; name=&quot;Filename&quot;&lt;/p&gt;

&lt;p&gt;arewethereyet.mov&lt;br/&gt;
------------gL6Ij5ei4gL6Ef1GI3gL6gL6KM7cH2&lt;br/&gt;
Content-Disposition: form-data; name=&quot;Filedata&quot;; filename=&quot;arewethereyet.mov&quot;&lt;br/&gt;
Content-Type: application/octet-stream&lt;/p&gt;

&lt;p&gt;...DATA HERE...&lt;br/&gt;
------------gL6Ij5ei4gL6Ef1GI3gL6gL6KM7cH2&lt;br/&gt;
Content-Disposition: form-data; name=&quot;Upload&quot;&lt;br/&gt;
Submit Query&lt;br/&gt;
------------gL6Ij5ei4gL6Ef1GI3gL6gL6KM7cH2&lt;/p&gt;</comment>
                            <comment id="12519511" author="jochen@apache.org" created="Mon, 13 Aug 2007 20:14:26 +0000"  >&lt;p&gt;Unsure, whether this works, but you might try to use the streaming API. If you are lucky, you&apos;ll get all the items and can read them until you finally encounter the exception.&lt;/p&gt;</comment>
                            <comment id="12519513" author="jochen@apache.org" created="Mon, 13 Aug 2007 20:20:02 +0000"  >&lt;p&gt;I notice, that my suggestion is consistent with the following quote from&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://livedocs.adobe.com/flash/8/main/wwhelp/wwhimpl/common/html/wwhelp.htm?context=LiveDocs_Parts&amp;amp;file=00002225.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://livedocs.adobe.com/flash/8/main/wwhelp/wwhimpl/common/html/wwhelp.htm?context=LiveDocs_Parts&amp;amp;file=00002225.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt; AJKERR SAID ON JAN 11, 2006 AT 12:34 PM :&lt;/p&gt;

&lt;p&gt;    IN ORDER TO GET FILE UPLOADING TO WORK WITH FLASH PLAYER 8 AND JAKARTA COMMONS FILE UPLOAD ON THE SERVER, WE HAD TO PATCH THE FILE UPLOAD SERVER CODE TO IGNORE THE EXCEPTION THAT WAS (CORRECTLY) BEING THROWN ON THE SERVER WHEN THE LAST SECTION IS PROCESSED.&lt;/p&gt;

&lt;p&gt;    THE CLASS THAT NEEDS TO BE PATCHED IS ORG.APACHE.COMMONS.FILEUPLOAD.FILEUPLOADBASE.&lt;/p&gt;

&lt;p&gt;    YOU&apos;LL NEED TO REPLACE LINE 336:&lt;br/&gt;
    MAP HEADERS = PARSEHEADERS(MULTI.READHEADERS());&lt;/p&gt;

&lt;p&gt;    ...WITH THE FOLLOWING CODE:&lt;br/&gt;
    MAP HEADERS = NULL;&lt;br/&gt;
    TRY&lt;/p&gt;
    {
    HEADERS = PARSEHEADERS(MULTI.READHEADERS());
    }
&lt;p&gt;    CATCH (MULTIPARTSTREAM.MALFORMEDSTREAMEXCEPTION E)&lt;/p&gt;
    {
    RETURN ITEMS;
    }

&lt;p&gt;    NOT THE MOST ELEGANT FIX, BUT IT WORKS AS A STOPGAP UNTIL MACROMEDIA RELEASES AN UPDATE TO THE FLASH 8 PLAYER.&lt;/p&gt;</comment>
                            <comment id="12519522" author="lukescott" created="Mon, 13 Aug 2007 20:44:49 +0000"  >&lt;p&gt;For some reason that solution did not work for me. I&apos;ve tried it before.&lt;/p&gt;

&lt;p&gt;I&apos;m attempting to use the streaming method, but I am unclear how to write the file using this method.&lt;/p&gt;

&lt;p&gt;My other concern is, what if the file being uploaded is large?&lt;/p&gt;</comment>
                            <comment id="12519540" author="lukescott" created="Mon, 13 Aug 2007 22:10:31 +0000"  >&lt;p&gt;Well I got a standard upload to work with the streaming API finally, just like it was working for the standard method. Then when I attempted to upload the file via flash, it gives me an &quot;HTTP error&quot; invoked by &quot;onIOError&quot;.... This event doesn&apos;t return any error codes at all, so now I don&apos;t have any idea what&apos;s causing it to not work.&lt;/p&gt;</comment>
                            <comment id="12519550" author="lukescott" created="Mon, 13 Aug 2007 23:03:21 +0000"  >&lt;p&gt;Oh now I feel silly.. I had the wrong URL put into my flash app... Now it works, but it still throws the exception. At least I got the file to save this time &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;The guide needs to be updated... The regular interface has an example of how to write a file, but the Streaming API does not. The regular interface talks about streaming data, which could easily be confused with the streaming APi... They don&apos;t mean the same thing.&lt;/p&gt;

&lt;p&gt;With the right libraries included, this is my final code that works. It also takes into account certain flash plugins sending a &quot;test&quot;. I have yet to come across that, but it&apos;s better to be safe than sorry.&lt;/p&gt;

&lt;p&gt;if( request.getContentLength() &amp;gt; 0 )&lt;br/&gt;
{&lt;br/&gt;
	Boolean isMultipart = ServletFileUpload.isMultipartContent(request);&lt;/p&gt;

&lt;p&gt;	if( isMultipart )&lt;br/&gt;
	{&lt;br/&gt;
		ServletFileUpload upload = new ServletFileUpload();&lt;br/&gt;
		FileItemIterator iter = upload.getItemIterator(request);&lt;br/&gt;
		while( iter.hasNext() )&lt;br/&gt;
		{&lt;br/&gt;
			try&lt;br/&gt;
			{&lt;br/&gt;
    			FileItemStream item = iter.next();&lt;br/&gt;
    			InputStream stream = item.openStream();&lt;/p&gt;

&lt;p&gt;    			if( !item.isFormField() &amp;amp;&amp;amp; item.getFieldName().equals(&quot;Filedata&quot;) )&lt;/p&gt;
				{
					OutputStream outstream = new FileOutputStream(&quot;/opt/red5/webapps/test/uploaded/&quot; + item.getName());
					Streams.copy(stream,outstream,true);
    			}
&lt;p&gt;			}&lt;br/&gt;
		}	&lt;br/&gt;
	}&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;Question: Should I close input and output stream in a finally block? Is there anything else I&apos;m missing?&lt;/p&gt;</comment>
                            <comment id="12519876" author="jochen@apache.org" created="Wed, 15 Aug 2007 06:40:19 +0000"  >&lt;p&gt;I have added the following entry to the FAQ:&lt;/p&gt;


&lt;p&gt;  &amp;lt;part id=&quot;flash&quot;&amp;gt;&lt;br/&gt;
    &amp;lt;title&amp;gt;FileUpload and Flash&amp;lt;/title&amp;gt;&lt;br/&gt;
    &amp;lt;faq id=&quot;missing-boundary-terminator&quot;&amp;gt;&lt;br/&gt;
      &amp;lt;question&amp;gt;&lt;br/&gt;
        I&apos;m using FileUpload to receive an upload from flash, but&lt;br/&gt;
        FileUpload will always throw an Exception &quot;Stream ended unexpectedly&quot;.&lt;br/&gt;
        What can I do?&lt;br/&gt;
      &amp;lt;/question&amp;gt;&lt;br/&gt;
      &amp;lt;answer&amp;gt;&lt;br/&gt;
        &amp;lt;p&amp;gt;&lt;br/&gt;
          At least as of version 8, Flash contains a known bug: The multipart&lt;br/&gt;
          stream it produces is broken, because the final boundary doesn&apos;t&lt;br/&gt;
          contain the suffix &quot;--&quot;, which ought to indicate, that no more&lt;br/&gt;
          items are following. Consequently, FileUpload waits for the next&lt;br/&gt;
          item (which it doesn&apos;t get) and throws an exception.&lt;br/&gt;
        &amp;lt;/p&amp;gt;&lt;br/&gt;
        &amp;lt;p&amp;gt;&lt;br/&gt;
          The problems details and a possible workaround are outlined in&lt;br/&gt;
          &amp;lt;a href=&quot;http://issues.apache.org/jira/browse/FILEUPLOAD-143&quot;&amp;gt;&lt;br/&gt;
          Bug 143&amp;lt;/a&amp;gt;. The workaround suggests to use the streaming API&lt;br/&gt;
          and catch the exception. The resulting code could look like&lt;br/&gt;
          this:&lt;br/&gt;
        &amp;lt;/p&amp;gt;&lt;br/&gt;
        &amp;lt;pre&amp;gt;&lt;br/&gt;
List items = new ArrayList();&lt;br/&gt;
FileItemIterator iter = fileUploadBase.getItemIterator(ctx);&lt;br/&gt;
try {&lt;br/&gt;
    while (iter.hasNext()) &lt;/p&gt;
{
        FileItemStream item = iter.next();
        FileItem fileItem = fileItemFactory.createItem(item.getFieldName(),
                        item.getContentType(), item.isFormField(),
                        item.getName());
        Streams.copy(item.openStream(), fileItem.getOutputStream(), true);
        items.add(fileItem);
    }
&lt;p&gt;} catch (MalformedStreamException e) {&lt;br/&gt;
    // Ignore this&lt;br/&gt;
}&lt;br/&gt;
        &amp;lt;/pre&amp;gt;&lt;br/&gt;
      &amp;lt;/answer&amp;gt;&lt;br/&gt;
    &amp;lt;/faq&amp;gt;&lt;br/&gt;
  &amp;lt;/part&amp;gt;&lt;/p&gt;</comment>
                            <comment id="12519982" author="lukescott" created="Wed, 15 Aug 2007 14:44:21 +0000"  >&lt;p&gt;&quot;ctx&quot; is not defined. Plus, I think the try block needs to be around iterator as well. And just in case I think the input stream needs to be closed with the finally block. I&apos;ve also included a fix where some flash versions will send a 0 byte test. Here is my final code:&lt;/p&gt;

&lt;p&gt;if( request.getContentLength() &amp;gt; 0 )&lt;br/&gt;
{&lt;br/&gt;
	Boolean isMultipart = ServletFileUpload.isMultipartContent(request);&lt;/p&gt;

&lt;p&gt;	if( isMultipart )&lt;br/&gt;
	{&lt;br/&gt;
		try&lt;br/&gt;
		{&lt;br/&gt;
			ServletFileUpload upload = new ServletFileUpload();&lt;br/&gt;
			FileItemIterator iter = upload.getItemIterator(request);&lt;br/&gt;
			while( iter.hasNext() )&lt;br/&gt;
			{&lt;br/&gt;
    			FileItemStream item = iter.next();&lt;br/&gt;
    			InputStream stream = item.openStream();&lt;/p&gt;

&lt;p&gt;    			if( !item.isFormField() &amp;amp;&amp;amp; item.getFieldName().equals(&quot;Filedata&quot;) )&lt;/p&gt;
				{
					String filename = item.getName();
					String tmpPath = &quot;/opt/red5/webapps/test/uploaded/.tmp.&quot; + filename;
					String finPath = &quot;/opt/red5/webapps/test/uploaded/&quot; + filename;
					
					OutputStream outstream = new FileOutputStream( tmpPath );
					Streams.copy(stream,outstream,true);
					
					File tmpFile = File( tmpPath );
					File finFile = File( finPath );
					
					tmpFile.renameTo( finFile );
    			}
&lt;p&gt;			}&lt;br/&gt;
		}&lt;br/&gt;
		catch( Exception e ) { }&lt;br/&gt;
		finally&lt;/p&gt;
		{
			stream.close();
		}	
&lt;p&gt;	}&lt;br/&gt;
}&lt;/p&gt;</comment>
                            <comment id="12892373" author="jsp1611" created="Mon, 26 Jul 2010 17:15:24 +0000"  >&lt;p&gt;I&apos;ve been getting a similar error. The stack trace for us, is as follows:&lt;/p&gt;

&lt;p&gt;2010-07-19 17:30:14,887 &lt;span class=&quot;error&quot;&gt;&amp;#91;TP-Processor7&amp;#93;&lt;/span&gt; ERROR vyre.publishing.portal.PortalFramework - Could not render portlet vyre.publishing.PortletInstance_628#46&lt;br/&gt;
org.exoplatform.services.portletcontainer.PortletProcessingException:&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.PortletApplicationHandler.processPortletException(PortletApplicationHandler.java:395)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.PortletApplicationHandler.process(PortletApplicationHandler.java:333)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.impl.servlet.ServletWrapper.service(ServletWrapper.java:139)&lt;br/&gt;
at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)&lt;br/&gt;
at org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:630)&lt;br/&gt;
at org.apache.catalina.core.ApplicationDispatcher.doInclude(ApplicationDispatcher.java:535)&lt;br/&gt;
at org.apache.catalina.core.ApplicationDispatcher.include(ApplicationDispatcher.java:472)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.PortletContainerDispatcher.dispatch(PortletContainerDispatcher.java:895)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.PortletContainerDispatcher.process(PortletContainerDispatcher.java:818)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.PortletContainerDispatcher.render(PortletContainerDispatcher.java:708)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.impl.PortletContainerServiceImpl.render(PortletContainerServiceImpl.java:569)&lt;br/&gt;
at vyre.publishing.portal.PortalFramework.render(PortalFramework.java:751)&lt;br/&gt;
at vyre.publishing.portal.PortalFramework.renderPortlet(PortalFramework.java:944)&lt;br/&gt;
at vyre.publishing.PortletInstance.render(PortletInstance.java:259)&lt;br/&gt;
at sun.reflect.GeneratedMethodAccessor405.invoke(Unknown Source)&lt;br/&gt;
at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
at org.hibernate.proxy.pojo.cglib.CGLIBLazyInitializer.invoke(CGLIBLazyInitializer.java:157)&lt;br/&gt;
at vyre.publishing.PortletInstance$$EnhancerByCGLIB$$4a6f6a50.render(&amp;lt;generated&amp;gt;)&lt;br/&gt;
at org.apache.jsp.WEB_002dINF.jsp.pub_005fmodule.portlet.portlet_005frender_jsp._jspService(Unknown Source)&lt;br/&gt;
at org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:70)&lt;br/&gt;
at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)&lt;br/&gt;
at org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:630)&lt;br/&gt;
at org.apache.catalina.core.ApplicationDispatcher.doInclude(ApplicationDispatcher.java:535)&lt;br/&gt;
at org.apache.catalina.core.ApplicationDispatcher.include(ApplicationDispatcher.java:472)&lt;br/&gt;
at vyre.publishing.ContentArea.render(ContentArea.java:352)&lt;br/&gt;
at org.apache.jsp.WEB_002dINF.jsp.pub_005fmodule.portlet.content_005farea_005frender_jsp._jspService(Unknown Source)&lt;br/&gt;
at org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:70)&lt;br/&gt;
at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)&lt;br/&gt;
at org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:630)&lt;br/&gt;
at org.apache.catalina.core.ApplicationDispatcher.doInclude(ApplicationDispatcher.java:535)&lt;br/&gt;
at org.apache.catalina.core.ApplicationDispatcher.include(ApplicationDispatcher.java:472)&lt;br/&gt;
at vyre.publishing.taglibs.ContentAreaTag.doStartTag(ContentAreaTag.java:64)&lt;br/&gt;
at org.apache.jsp.WEB_002dINF.generated_005ffiles.pub_005fmodule.template.t47_005f23_jsp._jspx_meth_vyre_002dtemplate_005fcontent_002darea_005f0(t47_005f23_jsp.java:356)&lt;br/&gt;
at org.apache.jsp.WEB_002dINF.generated_005ffiles.pub_005fmodule.template.t47_005f23_jsp._jspService(t47_005f23_jsp.java:110)&lt;br/&gt;
at org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:70)&lt;br/&gt;
at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)&lt;br/&gt;
at org.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:374)&lt;br/&gt;
at org.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:342)&lt;br/&gt;
at org.apache.jasper.servlet.JspServlet.service(JspServlet.java:267)&lt;br/&gt;
at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)&lt;br/&gt;
at org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:630)&lt;br/&gt;
at org.apache.catalina.core.ApplicationDispatcher.processRequest(ApplicationDispatcher.java:436)&lt;br/&gt;
at org.apache.catalina.core.ApplicationDispatcher.doForward(ApplicationDispatcher.java:374)&lt;br/&gt;
at org.apache.catalina.core.ApplicationDispatcher.forward(ApplicationDispatcher.java:302)&lt;br/&gt;
at vyre.publishing.PathFilter.doFilter(PathFilter.java:240)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)&lt;br/&gt;
at vyre.content.search.permissions.ViewPermissionFilter.doFilter(ViewPermissionFilter.java:27)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)&lt;br/&gt;
at vyre.realms.GateKeeper.doFilter(GateKeeper.java:137)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)&lt;br/&gt;
at org.springframework.orm.hibernate3.support.OpenSessionInViewFilter.doFilterInternal(OpenSessionInViewFilter.java:198)&lt;br/&gt;
at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:76)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)&lt;br/&gt;
at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)&lt;br/&gt;
at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)&lt;br/&gt;
at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:128)&lt;br/&gt;
at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)&lt;br/&gt;
at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)&lt;br/&gt;
at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:286)&lt;br/&gt;
at org.apache.jk.server.JkCoyoteHandler.invoke(JkCoyoteHandler.java:190)&lt;br/&gt;
at org.apache.jk.common.HandlerRequest.invoke(HandlerRequest.java:283)&lt;br/&gt;
at org.apache.jk.common.ChannelSocket.invoke(ChannelSocket.java:767)&lt;br/&gt;
at org.apache.jk.common.ChannelSocket.processConnection(ChannelSocket.java:697)&lt;br/&gt;
at org.apache.jk.common.ChannelSocket$SocketConnection.runIt(ChannelSocket.java:889)&lt;br/&gt;
at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:690)&lt;br/&gt;
at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
Caused by: javax.portlet.PortletException: Request processing failed&lt;br/&gt;
at org.springframework.web.portlet.FrameworkPortlet.processRequest(FrameworkPortlet.java:496)&lt;br/&gt;
at org.springframework.web.portlet.FrameworkPortlet.doDispatch(FrameworkPortlet.java:453)&lt;br/&gt;
at javax.portlet.GenericPortlet.render(GenericPortlet.java:233)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.PortletMethodCommand.render(PortletMethodCommand.java:62)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.execute(BaseCommandUnit.java:46)&lt;br/&gt;
at org.exoplatform.container.component.ExecutionContext.executeNextUnit(ExecutionContext.java:39)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.render(BaseCommandUnit.java:66)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.PortletSessionValidationCommand.render(PortletSessionValidationCommand.java:16)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.execute(BaseCommandUnit.java:46)&lt;br/&gt;
at org.exoplatform.container.component.ExecutionContext.executeNextUnit(ExecutionContext.java:39)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.PortletContentCommand.render(PortletContentCommand.java:28)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.execute(BaseCommandUnit.java:46)&lt;br/&gt;
at org.exoplatform.container.component.ExecutionContext.executeNextUnit(ExecutionContext.java:39)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.PortletCacheCommand.render(PortletCacheCommand.java:109)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.execute(BaseCommandUnit.java:46)&lt;br/&gt;
at org.exoplatform.container.component.ExecutionContext.executeNextUnit(ExecutionContext.java:39)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.PortletFilterCommand.render(PortletFilterCommand.java:71)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.execute(BaseCommandUnit.java:46)&lt;br/&gt;
at org.exoplatform.container.component.ExecutionContext.executeNextUnit(ExecutionContext.java:39)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.PortletSecurityCommand.render(PortletSecurityCommand.java:49)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.execute(BaseCommandUnit.java:46)&lt;br/&gt;
at org.exoplatform.container.component.ExecutionContext.executeNextUnit(ExecutionContext.java:39)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.render(BaseCommandUnit.java:66)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.execute(BaseCommandUnit.java:46)&lt;br/&gt;
at org.exoplatform.container.component.ExecutionContext.execute(ExecutionContext.java:32)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.PortletCommandChain.doRender(PortletCommandChain.java:61)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.PortletApplicationHandler.process(PortletApplicationHandler.java:300)&lt;br/&gt;
... 77 more&lt;br/&gt;
Caused by: java.lang.RuntimeException: org.apache.commons.fileupload.FileUploadBase$IOFileUploadException: Processing of multipart/form-data request failed. null&lt;br/&gt;
at vyre.util.params.PortletForm.getMap(PortletForm.java:109)&lt;br/&gt;
at vyre.util.params.PortletForm.&amp;lt;init&amp;gt;(PortletForm.java:28)&lt;br/&gt;
at vyre.util.params.ParameterManager.getParameters(ParameterManager.java:48)&lt;br/&gt;
at vyre.portlets.items.templateEdit.ViewController.handleActionRequestInternal(ViewController.java:105)&lt;br/&gt;
at vyre.portlets.items.templateEdit.ViewController.handleActionRequestInternal(ViewController.java:99)&lt;br/&gt;
at org.springframework.web.portlet.mvc.AbstractController.handleActionRequest(AbstractController.java:196)&lt;br/&gt;
at org.springframework.web.portlet.mvc.SimpleControllerHandlerAdapter.handleAction(SimpleControllerHandlerAdapter.java:46)&lt;br/&gt;
at org.springframework.web.portlet.DispatcherPortlet.doActionService(DispatcherPortlet.java:694)&lt;br/&gt;
at org.springframework.web.portlet.FrameworkPortlet.processRequest(FrameworkPortlet.java:480)&lt;br/&gt;
at org.springframework.web.portlet.FrameworkPortlet.processAction(FrameworkPortlet.java:462)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.PortletMethodCommand.processAction(PortletMethodCommand.java:89)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.execute(BaseCommandUnit.java:57)&lt;br/&gt;
at org.exoplatform.container.component.ExecutionContext.executeNextUnit(ExecutionContext.java:39)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.processAction(BaseCommandUnit.java:93)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.execute(BaseCommandUnit.java:57)&lt;br/&gt;
at org.exoplatform.container.component.ExecutionContext.executeNextUnit(ExecutionContext.java:39)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.processAction(BaseCommandUnit.java:93)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.execute(BaseCommandUnit.java:57)&lt;br/&gt;
at org.exoplatform.container.component.ExecutionContext.executeNextUnit(ExecutionContext.java:39)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.PortletCacheCommand.processAction(PortletCacheCommand.java:288)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.execute(BaseCommandUnit.java:57)&lt;br/&gt;
at org.exoplatform.container.component.ExecutionContext.executeNextUnit(ExecutionContext.java:39)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.PortletFilterCommand.processAction(PortletFilterCommand.java:108)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.execute(BaseCommandUnit.java:57)&lt;br/&gt;
at org.exoplatform.container.component.ExecutionContext.executeNextUnit(ExecutionContext.java:39)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.PortletSecurityCommand.processAction(PortletSecurityCommand.java:68)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.execute(BaseCommandUnit.java:57)&lt;br/&gt;
at org.exoplatform.container.component.ExecutionContext.executeNextUnit(ExecutionContext.java:39)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.processAction(BaseCommandUnit.java:93)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.BaseCommandUnit.execute(BaseCommandUnit.java:57)&lt;br/&gt;
at org.exoplatform.container.component.ExecutionContext.execute(ExecutionContext.java:32)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.aop.PortletCommandChain.doProcessAction(PortletCommandChain.java:75)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.PortletApplicationHandler.process(PortletApplicationHandler.java:284)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.impl.servlet.ServletWrapper.service(ServletWrapper.java:139)&lt;br/&gt;
at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290)&lt;br/&gt;
at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)&lt;br/&gt;
at org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:630)&lt;br/&gt;
at org.apache.catalina.core.ApplicationDispatcher.doInclude(ApplicationDispatcher.java:535)&lt;br/&gt;
at org.apache.catalina.core.ApplicationDispatcher.include(ApplicationDispatcher.java:472)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.PortletContainerDispatcher.dispatch(PortletContainerDispatcher.java:895)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.PortletContainerDispatcher.process(PortletContainerDispatcher.java:818)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.plugins.pc.PortletContainerDispatcher.processAction(PortletContainerDispatcher.java:670)&lt;br/&gt;
at org.exoplatform.services.portletcontainer.impl.PortletContainerServiceImpl.processAction(PortletContainerServiceImpl.java:509)&lt;br/&gt;
at vyre.publishing.portal.PortalFramework.processAction(PortalFramework.java:684)&lt;br/&gt;
at vyre.publishing.portal.PortalFramework.preRenderProcessing(PortalFramework.java:893)&lt;br/&gt;
at vyre.publishing.deployment.PageGenerator.prepareForRender(PageGenerator.java:328)&lt;br/&gt;
at vyre.publishing.deployment.PageGenerator.prepareForRender(PageGenerator.java:211)&lt;br/&gt;
at vyre.publishing.deployment.PageGenerator.prepareForRender(PageGenerator.java:200)&lt;br/&gt;
at vyre.publishing.PathFilter.doFilter(PathFilter.java:193)&lt;br/&gt;
... 25 more&lt;br/&gt;
Caused by: org.apache.commons.fileupload.FileUploadBase$IOFileUploadException: Processing of multipart/form-data request failed. null&lt;br/&gt;
at org.apache.commons.fileupload.FileUploadBase.parseRequest(FileUploadBase.java:367)&lt;br/&gt;
at org.apache.commons.fileupload.portlet.PortletFileUpload.parseRequest(PortletFileUpload.java:119)&lt;br/&gt;
at vyre.util.params.PortletForm.getMap(PortletForm.java:69)&lt;br/&gt;
... 74 more&lt;br/&gt;
Caused by: java.io.IOException&lt;br/&gt;
at org.apache.jk.common.JkInputStream.receive(JkInputStream.java:199)&lt;br/&gt;
at org.apache.jk.common.JkInputStream.refillReadBuffer(JkInputStream.java:258)&lt;br/&gt;
at org.apache.jk.common.JkInputStream.doRead(JkInputStream.java:177)&lt;br/&gt;
at org.apache.coyote.Request.doRead(Request.java:428)&lt;br/&gt;
at org.apache.catalina.connector.InputBuffer.realReadBytes(InputBuffer.java:304)&lt;br/&gt;
at org.apache.tomcat.util.buf.ByteChunk.substract(ByteChunk.java:405)&lt;br/&gt;
at org.apache.catalina.connector.InputBuffer.read(InputBuffer.java:327)&lt;br/&gt;
at org.apache.catalina.connector.CoyoteInputStream.read(CoyoteInputStream.java:193)&lt;br/&gt;
at org.apache.commons.fileupload.MultipartStream$ItemInputStream.makeAvailable(MultipartStream.java:977)&lt;br/&gt;
at org.apache.commons.fileupload.MultipartStream$ItemInputStream.read(MultipartStream.java:887)&lt;br/&gt;
at java.io.InputStream.read(InputStream.java:85)&lt;br/&gt;
at org.apache.commons.fileupload.util.Streams.copy(Streams.java:94)&lt;br/&gt;
at org.apache.commons.fileupload.util.Streams.copy(Streams.java:64)&lt;br/&gt;
at org.apache.commons.fileupload.FileUploadBase.parseRequest(FileUploadBase.java:362)&lt;br/&gt;
... 76 more&lt;/p&gt;

&lt;p&gt;This happens regularly with very large files. &lt;/p&gt;

&lt;p&gt;MultipartStream appears to be causing problems here. The code that throws the Exception is as follows: &lt;/p&gt;

&lt;p&gt;lines 963 through 1006 in release 1.2.1&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;MultipartStream.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;       &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; makeAvailable() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pos != -1) {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; 0;
            }

            &lt;span class=&quot;code-comment&quot;&gt;// Move the data to the beginning of the buffer.
&lt;/span&gt;            total += tail - head - pad;
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.arraycopy(buffer, tail - pad, buffer, 0, pad);

            &lt;span class=&quot;code-comment&quot;&gt;// Refill buffer with &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; data.
&lt;/span&gt;            head = 0;
            tail = pad;

            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ( ; ; ) {
                &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; bytesRead = input.read(buffer, tail, bufSize - tail);
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (bytesRead == -1) {
                    &lt;span class=&quot;code-comment&quot;&gt;// The last pad amount is left in the buffer.
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// Boundary can&apos;t be in there so signal an error
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// condition.
&lt;/span&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; msg = &lt;span class=&quot;code-quote&quot;&gt;&quot;Stream ended unexpectedly&quot;&lt;/span&gt;;
                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MalformedStreamException(msg);
                }
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (notifier != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                    notifier.noteBytesRead(bytesRead);
                }
                tail += bytesRead;

                findSeparator();
                &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; av = available();

                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (av &amp;gt; 0 || pos != -1) {
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; av;
                }
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When input.read() is called it returns -1 indicating that there is no more data to be read. For some reason this is considered to be an error, and an Exception is thrown. &lt;/p&gt;

&lt;p&gt;I&apos;ve had a look at previous versions of FileUpload, and more or less the same thing has been done for a while. I was wondering if anyone could explain to me why an Exception is thrown in this instance?&lt;/p&gt;


&lt;p&gt;References&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://commons.apache.org/fileupload/apidocs/org/apache/commons/fileupload/MultipartStream.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://commons.apache.org/fileupload/apidocs/org/apache/commons/fileupload/MultipartStream.html&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://java.sun.com/javase/6/docs/api/java/io/InputStream.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://java.sun.com/javase/6/docs/api/java/io/InputStream.html&lt;/a&gt;&lt;/p&gt;

</comment>
                            <comment id="12892380" author="lukescott" created="Mon, 26 Jul 2010 17:31:49 +0000"  >&lt;p&gt;It&apos;s been quite a long time since I posted this issue... So I don&apos;t remember the specifics. It is indeed a problem with Flash and how it uploads files. I ended up using a servlet with the streaming API. Below is a block of code from my class. Much of it is stripped down to include the important stuff. It won&apos;t work as-is, but hopefully will be of some help:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;UploadServlet &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; HttpServlet {

	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void service(HttpServletRequest request, HttpServletResponse response) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; ServletException, IOException {

		&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] session = request.getParameterValues(&lt;span class=&quot;code-quote&quot;&gt;&quot;s&quot;&lt;/span&gt;);
		&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; isMultipart = ServletFileUpload.isMultipartContent(request);
		
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( request.getContentLength() &amp;gt; 0 &amp;amp;&amp;amp; isMultipart &amp;amp;&amp;amp; session != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; session.length &amp;gt; 0 )
		{
			&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
			{
				ServletFileUpload upload = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ServletFileUpload();
				FileItemIterator iter = upload.getItemIterator(request);
				
				&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;( iter.hasNext() )
				{
	   				FileItemStream item = iter.next();
	   				InputStream stream = item.openStream();

	   				&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( !item.isFormField() &amp;amp;&amp;amp; item.getFieldName().equals(&lt;span class=&quot;code-quote&quot;&gt;&quot;Filedata&quot;&lt;/span&gt;) )
					{
						&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; filename = &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.toString(&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis(), 36);
						&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; tmpPath = &lt;span class=&quot;code-quote&quot;&gt;&quot;.&quot;&lt;/span&gt; + filename + &lt;span class=&quot;code-quote&quot;&gt;&quot;.tmp&quot;&lt;/span&gt;;
						&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; finPath = filename;
						OutputStream outstream = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileOutputStream( tmpPath );
						Streams.copy(stream,outstream,&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
						
						stream.close();
						outstream.close();

						File tmpFile = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File( tmpPath );
						File finFile = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File( finPath );
							
						tmpFile.renameTo( finFile );
   					}
				}
			}
			&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;( Exception e ) { }
		}

	} 
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12974172" author="visumagic" created="Wed, 22 Dec 2010 12:23:52 +0000"  >&lt;p&gt;Hi&lt;/p&gt;

&lt;p&gt;I&apos;m also having same issue. Uploading is failing at 40%. Even after trying many trials , still struck in the problem.&lt;/p&gt;

&lt;p&gt;Any workarounds please.&lt;/p&gt;

&lt;p&gt;-raghu&lt;/p&gt;</comment>
                            <comment id="13598693" author="simone.tripodi" created="Mon, 11 Mar 2013 10:34:12 +0000"  >&lt;p&gt;Workaround (re)included in r1455085, FAQ will be republished as soon as the site will be redeployed&lt;/p&gt;</comment>
                            <comment id="14381216" author="taromaru" created="Thu, 26 Mar 2015 02:03:28 +0000"  >&lt;p&gt;If the reproduction rate isn&apos;t 100%, I think &lt;a href=&quot;https://issues.apache.org/jira/browse/FILEUPLOAD-135&quot; title=&quot;InputStream created with Streaming API returns EOF on first read() for short files uploaded from FireFox over HTTPS&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FILEUPLOAD-135&quot;&gt;&lt;del&gt;FILEUPLOAD-135&lt;/del&gt;&lt;/a&gt; is related to this phenomenon.&lt;/p&gt;</comment>
                            <comment id="16038138" author="chtompki" created="Tue, 6 Jun 2017 04:47:05 +0000"  >&lt;p&gt;1.3 released.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>43089</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 23 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0skrb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>164840</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>