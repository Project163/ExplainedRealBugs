<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:55:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FILEUPLOAD-212] Insecure request size checking</title>
                <link>https://issues.apache.org/jira/browse/FILEUPLOAD-212</link>
                <project id="12310476" key="FILEUPLOAD">Commons FileUpload</project>
                    <description>&lt;p&gt;In FileUploadBase there is an issue when checking for upload request size, the check is based on presence of Content-Length header in request and FALSE assumption that when present it will represent the actual request size. Using this fact, attacker can supply request with defined Content-Length of 60 and bypass file upload restrictions, which can lead to successful Resource Depletion type attack. &lt;/p&gt;

&lt;p&gt;IMHO by default file upload should return the LimitedInputStream implementation for file upload.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Default configuration default environment.&lt;/p&gt;</environment>
        <key id="12598841">FILEUPLOAD-212</key>
            <summary>Insecure request size checking</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tn">Thomas Neidhart</assignee>
                                    <reporter username="fatfredyy">Damian Kolasa</reporter>
                        <labels>
                            <label>max_upload_size</label>
                            <label>resource_depletion</label>
                            <label>security</label>
                    </labels>
                <created>Sun, 15 Jul 2012 08:55:06 +0000</created>
                <updated>Sat, 3 Jun 2017 17:19:39 +0000</updated>
                            <resolved>Wed, 13 Mar 2013 07:27:33 +0000</resolved>
                                    <version>1.2.2</version>
                                    <fixVersion>1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="172800">48h</timeoriginalestimate>
                            <timeestimate seconds="172800">48h</timeestimate>
                                        <comments>
                            <comment id="13593447" author="simone.tripodi" created="Tue, 5 Mar 2013 14:51:56 +0000"  >&lt;p&gt;thanks for reporting, Damian - any chance you submit a patch? TIA!&lt;/p&gt;</comment>
                            <comment id="13598192" author="tn" created="Sun, 10 Mar 2013 08:42:16 +0000"  >&lt;p&gt;The attached patch adds some more unit tests with a Content-Length header provided in the request.&lt;/p&gt;

&lt;p&gt;The tests also show that the described problem does not exist, as always a LimitedInputStream is used, regardless if the Content-Length is provided or not.&lt;/p&gt;

&lt;p&gt;So I would mark this as invalid.&lt;/p&gt;</comment>
                            <comment id="13598371" author="simone.tripodi" created="Sun, 10 Mar 2013 20:15:03 +0000"  >&lt;p&gt;I applied locally &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tn&quot; class=&quot;user-hover&quot; rel=&quot;tn&quot;&gt;tn&lt;/a&gt;&apos;s patch and it demonstrates this is not an issue&lt;/p&gt;</comment>
                            <comment id="13598395" author="fatfredyy" created="Sun, 10 Mar 2013 21:41:13 +0000"  >&lt;p&gt;The issue is with global size limit not file size limit. FileUploadBase.java:917. And MockHttpServletRequest cannot create attacking scenario for testing because it gets Content-Length from passed string size, not &quot;Global&quot; request header. &lt;/p&gt;</comment>
                            <comment id="13598400" author="tn" created="Sun, 10 Mar 2013 21:48:18 +0000"  >&lt;p&gt;Indeed you are right, using the Streaming API this can happen.&lt;br/&gt;
When looking at the issue, I did not see the second occurrence of the size check.&lt;/p&gt;</comment>
                            <comment id="13598406" author="tn" created="Sun, 10 Mar 2013 21:52:41 +0000"  >&lt;p&gt;The second patch fixes the problem in the same way as in the FileItemStreamImpl constructor.&lt;/p&gt;

&lt;p&gt;Whatever is provided as content-length, only use it as fail-fast mechanism. Always limit the input stream by the max allowed size.&lt;/p&gt;</comment>
                            <comment id="13598596" author="simone.tripodi" created="Mon, 11 Mar 2013 07:15:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tn&quot; class=&quot;user-hover&quot; rel=&quot;tn&quot;&gt;tn&lt;/a&gt; I think you can checkin directly the modifications, no need for patches. Thanks!&lt;/p&gt;</comment>
                            <comment id="13598618" author="tn" created="Mon, 11 Mar 2013 07:51:45 +0000"  >&lt;p&gt;Ok, the patch needs to be improved a bit to fully support the global size limit.&lt;br/&gt;
Also some tests would be fine, I will work on it this evening.&lt;/p&gt;</comment>
                            <comment id="13598621" author="simone.tripodi" created="Mon, 11 Mar 2013 07:58:58 +0000"  >&lt;p&gt;I started checking in your modifications in order to let &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fatfredyy&quot; class=&quot;user-hover&quot; rel=&quot;fatfredyy&quot;&gt;fatfredyy&lt;/a&gt; playing with it - it is credited to you&lt;/p&gt;</comment>
                            <comment id="13599799" author="tn" created="Tue, 12 Mar 2013 07:38:29 +0000"  >&lt;p&gt;I worked on unit tests (see the attached patch) for the maxSize check and detected in the process that a SizeException could be the cause of these &quot;Stream ended unexpectedly&quot; problems some people have received.&lt;/p&gt;

&lt;p&gt;This is due to the fact that in some internal methods of MultipartStream any IOException is caught and re-thrown as MalformedStreamException. Any of the SizeExceptions is thrown inside a FileUploadIOException (derived from IOException), to conform to the InputStream interface, which is good, but we need to handle them separately and propagate the correct exception to the user.&lt;/p&gt;

&lt;p&gt;The patch also includes this change, please review.&lt;/p&gt;

&lt;p&gt;The maxSize test also changes the MockHttpServletRequest to allow a readLimit: read at maximum the given amount of bytes at a time, to better test the streaming API. Otherwise the full buffer would be filled in one go.&lt;/p&gt;</comment>
                            <comment id="13599826" author="simone.tripodi" created="Tue, 12 Mar 2013 08:30:55 +0000"  >&lt;p&gt;I &lt;b&gt;like&lt;/b&gt; the patch, IMHO it would worth you checkin it in order to let users check if it fixes the &quot;Stream ended unexpectedly&quot; issues.&lt;/p&gt;

&lt;p&gt;TIA!&lt;/p&gt;</comment>
                            <comment id="13600534" author="tn" created="Tue, 12 Mar 2013 22:01:20 +0000"  >&lt;p&gt;Applied with some more comments in r1455729.&lt;/p&gt;</comment>
                            <comment id="13600913" author="simone.tripodi" created="Wed, 13 Mar 2013 07:27:33 +0000"  >&lt;p&gt;resolved by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tn&quot; class=&quot;user-hover&quot; rel=&quot;tn&quot;&gt;tn&lt;/a&gt;&apos;s in r1455729&lt;/p&gt;</comment>
                            <comment id="13602695" author="fatfredyy" created="Thu, 14 Mar 2013 20:40:16 +0000"  >&lt;p&gt;Thank you very much &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Very nice!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12533490">FILEUPLOAD-202</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12572991" name="FILEUPLOAD-212_fix.patch" size="2364" author="tn" created="Sun, 10 Mar 2013 21:52:41 +0000"/>
                            <attachment id="12573280" name="FILEUPLOAD-212_test.patch" size="14451" author="tn" created="Tue, 12 Mar 2013 07:38:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>292956</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 36 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0skcf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>164773</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>