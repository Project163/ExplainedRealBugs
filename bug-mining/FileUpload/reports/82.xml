<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:55:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FILEUPLOAD-295] DiskFileItem: getStoreLocation() may return non-existing file</title>
                <link>https://issues.apache.org/jira/browse/FILEUPLOAD-295</link>
                <project id="12310476" key="FILEUPLOAD">Commons FileUpload</project>
                    <description>&lt;p&gt;&lt;b&gt;How to reproduce&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Create a DiskFileItem with threshold set to -1 (force save to disk).&lt;/li&gt;
	&lt;li&gt;Get OutputStream from DiskFileItem.&lt;/li&gt;
	&lt;li&gt;Close OutputStream without calling any write(...) method (e.g., because the uploaded file is empty).&lt;/li&gt;
	&lt;li&gt;Test the return value of the following methods:
	&lt;ul&gt;
		&lt;li&gt;isInMemory() --&amp;gt; returns false (OK)&lt;/li&gt;
		&lt;li&gt;getSize() --&amp;gt; returns 0 (OK)&lt;/li&gt;
		&lt;li&gt;getStoreLocation() --&amp;gt; returns a File object (OK), but the file does not exist (FAILURE).&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I think this is an inconsistency. If isInMemory() returns false adn getStoreLocation() returns a File object, the file should also exist.&lt;/p&gt;

&lt;p&gt;Java code (run with -ea to enable assertions):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// create a DiskFileItem
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; sizeThreshold = -1; &lt;span class=&quot;code-comment&quot;&gt;// always store to disk
&lt;/span&gt;File repository = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// use temporary folder
&lt;/span&gt;DiskFileItem item = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DiskFileItem(&lt;span class=&quot;code-quote&quot;&gt;&quot;file&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;text/plain&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;file.txt&quot;&lt;/span&gt;, sizeThreshold, repository);

OutputStream outputStream = item.getOutputStream();
&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not write to stream &amp;lt;-- IMPORTANT
&lt;/span&gt;outputStream.close();

&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; that data has been stored to disk
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; !item.isInMemory(); &lt;span class=&quot;code-comment&quot;&gt;// pass
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; item.getSize() == 0; &lt;span class=&quot;code-comment&quot;&gt;// pass
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; item.getStoreLocation() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// pass
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; item.getStoreLocation().isFile(); &lt;span class=&quot;code-comment&quot;&gt;// fails&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When adding a call to outputStream.write(new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;), the behavior changes and the empty file is created on disk.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13217551">FILEUPLOAD-295</key>
            <summary>DiskFileItem: getStoreLocation() may return non-existing file</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="jochen@apache.org">Jochen Wiedmann</assignee>
                                    <reporter username="stephan.markwalder@appway.com">Stephan Markwalder</reporter>
                        <labels>
                    </labels>
                <created>Sat, 23 Feb 2019 00:19:53 +0000</created>
                <updated>Thu, 24 Jul 2025 07:48:50 +0000</updated>
                                            <version>1.4</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16775914" author="jochen@apache.org" created="Sat, 23 Feb 2019 15:25:24 +0000"  >&lt;p&gt;I admit, that I wouldn&apos;t design it like this, if this were a new API. On the other hand, FileUpload is quite established, and I do not consider this a serious problem. So, I am suggesting to resolve this as WONTFIX.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16775950" author="stephan.markwalder@appway.com" created="Sat, 23 Feb 2019 17:19:36 +0000"  >&lt;p&gt;Hi Jochen,&lt;/p&gt;

&lt;p&gt;I&apos;m ok if this bug is not fixed. It is indeed an edge case.&#160;We have been running into it after upgrading from version 1.3.3 to version 1.4 (in which &lt;a href=&quot;https://issues.apache.org/jira/browse/FILEUPLOAD-258&quot; title=&quot;Empty files in mutipart requests aren&amp;#39;t saved to disk&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FILEUPLOAD-258&quot;&gt;&lt;del&gt;FILEUPLOAD-258&lt;/del&gt;&lt;/a&gt; has been fixed).&lt;/p&gt;

&lt;p&gt;Before, we have been using a sizeThreshold of 0 for a very long time, assuming that this would cause DiskFileItem to always store data on disk, never in memory. This was our fault no 1. Unfortunately, the JavaDoc for DiskFileItem&apos;s constructor is not very precise:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;tt&gt;sizeThreshold&lt;/tt&gt;&#160;- The threshold, in bytes, below which items will be retained in memory and above which they will be stored as a file.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;But&#160;what happens when the item size is equal to the&#160;threshold? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Our fault no 2 then was that&#160;people have used the return value of DiskFileItem.getStoreLocation() without a check of DiskFileItem.isInMemory() upfront (because of the assumption made above).&lt;/p&gt;

&lt;p&gt;Together, those two faults have lead to NullPointerExceptions in our code after the upgrade to version 1.4.&lt;/p&gt;

&lt;p&gt;When analyzing the issue,&#160;I though that it would be sufficient to set sizeThreshold to -1. No matter what the actual file size will be, it is for sure 0 or greater.&#160;According to JavaDoc, this then should guarantee that items will be stored as files on disk. But when writing some tests for DiskFileItem to explore how it deals with empty files, we noticed that it behaves differently depending on whether/how data is written into the DiskFileItem&apos;s OutputStream. In some cases, an empty file is created, in others not. Unfortunately, DiskFileItem then somehow is in an inconsistent state. isInMemory() returns false, getStoreLocation() returns a File object, but the file does not exist. As a result, we have seen FileNotFoundExceptions in some of our components, even the ones where people have thought about an upfront check with isInMemory(). Our &quot;fix&quot; now is to not trust DiskFileItem and the information it returns&#160;for isInMemory() or getStoreLocation(), but always go&#160;for an extra check whether the file actually exists.&lt;/p&gt;

&lt;p&gt;If this bug is not fixed, it has at least been filed once. If other people run into the same or a similar issue when upgrading to 1.4, they at least now have a chance to find this&#160;ticket and maybe get some insights in how to&#160;solve them for themselves.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="18003768" author="stephan.markwalder@appway.com" created="Tue, 8 Jul 2025 12:24:29 +0000"  >&lt;p&gt;&lt;b&gt;A quick update after the release of Commons FileUpload 1.6.0&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Due to changes in Commons IO&apos;s &lt;tt&gt;ThresholdingOutputStream&lt;/tt&gt; (probably in 2.16.0) the behavior of Commons FileUpload has changed once more. A value of -1 passed as &lt;tt&gt;sizeThreshold&lt;/tt&gt; to &lt;tt&gt;DiskFileItem&lt;/tt&gt; is now automatically changed to 0 in the constructor of &lt;tt&gt;ThresholdingOutputStream&lt;/tt&gt;:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;this.threshold = threshold &amp;lt; 0 ? 0 : threshold;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;The behavior of Commons FileUpload&apos;s API now seems to be self-consistent again when uploading an empty file:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;isInMemory() --&amp;gt; returns true&lt;/li&gt;
	&lt;li&gt;getSize() --&amp;gt; returns 0&lt;/li&gt;
	&lt;li&gt;getStoreLocation() --&amp;gt; returns null&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;However, it is impossible to configure Commons FileUpload so that it ALWAYS creates a file on disk, even for empty files.&lt;/p&gt;</comment>
                            <comment id="18003770" author="garydgregory" created="Tue, 8 Jul 2025 12:40:00 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stephan.markwalder%40appway.com&quot; class=&quot;user-hover&quot; rel=&quot;stephan.markwalder@appway.com&quot;&gt;stephan.markwalder@appway.com&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thank you for your report.&lt;/p&gt;

&lt;p&gt;Would your use case be accommodated with a new feature/bug fix in FileUpload? If so, would you be willing to submit a pull-request on GitHub?&lt;/p&gt;

&lt;p&gt;G.&lt;/p&gt;</comment>
                            <comment id="18005013" author="jochen@apache.org" created="Sun, 13 Jul 2025 21:00:07 +0000"  >&lt;p&gt;I have just committed an update, which makes the DiskFileItem implement the specification below (Commit f3f27401baea7e8a0be8155fa26afe026d0205af).&lt;/p&gt;

&lt;p&gt;A unit test (DiskFileItemTest) should ensure that contract.&#160; Please review.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stephan.markwalder%40appway.com&quot; class=&quot;user-hover&quot; rel=&quot;stephan.markwalder@appway.com&quot;&gt;stephan.markwalder@appway.com&lt;/a&gt;: Upon review, please keep in mind, that this change is not supposed to fulfill your assumptions on the model. The purpose is to have something, that is clear, precise, documented, and maintainable. We are taking the chance, that Fileupload 2 is not 100% compatible to any previous version. Looking forward is more important.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;State model&lt;/em&gt;: Instances of &lt;em&gt;&lt;tt&gt;DiskFileItem&lt;/tt&gt;&lt;/em&gt; are subject to a carefully designed state model. Depending on the so-called&#160;&lt;em&gt;&lt;tt&gt;threshold&lt;/tt&gt;&lt;/em&gt;, either of the three models are possible:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;em&gt;threshold = -1&lt;/em&gt; Uploaded data is never kept in memory. Instead, a temporary file is being created immediately.&#160;&lt;b&gt;&lt;tt&gt;isInMemory()&lt;/tt&gt;&lt;/b&gt; will always return false,&#160;&lt;b&gt;&lt;tt&gt;getPath()&lt;/tt&gt;&lt;/b&gt;&#160;will always return the path of an existing file. The temporary file may be empty.&lt;/li&gt;
	&lt;li&gt;&lt;em&gt;threshold = 0&lt;/em&gt; Uploaded data is never kept in memory. (Same as threshold=-1.) However, the temporary file is only created, if data was uploaded. Or, in other words: The uploaded file will never be empty.&#160;&lt;b&gt;&lt;tt&gt;isInMemory()&lt;/tt&gt;&lt;/b&gt; will return true, if no data was uploaded, otherwise it will be false. In the former case&#160;&lt;b&gt;&lt;tt&gt;getPath()&lt;/tt&gt;&lt;/b&gt; will return null, but in the latter case it returns the path of an existing, non-empty file.&lt;/li&gt;
	&lt;li&gt;&lt;em&gt;threshold &amp;gt; 0&lt;/em&gt; Uploaded data will be kept in memory, if the size is below the threshold. If the size is equal to, or above the threshold, then a temporary file has been created, and all uploaded data has been transferred to that file.&#160;&lt;b&gt;&lt;tt&gt;isInMemory()&lt;/tt&gt;&lt;/b&gt; returns true, if the size of the uploaded data is below the threshold. If so,&#160;&lt;b&gt;&lt;tt&gt;getPath()&lt;/tt&gt;&lt;/b&gt; returns null. Otherwise,&#160;&lt;tt&gt;&lt;b&gt;isInMemory()&lt;/b&gt;&lt;/tt&gt; returns false, and&#160;&lt;b&gt;&lt;tt&gt;getPath()&lt;/tt&gt;&lt;/b&gt;&#160;returns the path of an existing, temporary file. The size of the temporary file is equal to, or above the threshold.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="18009486" author="stephan.markwalder@appway.com" created="Thu, 24 Jul 2025 07:48:50 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jochen%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;jochen@apache.org&quot;&gt;jochen@apache.org&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Sorry for the late reply. I was traveling for some time.&lt;/p&gt;

&lt;p&gt;I had a look at the new state model and code in &lt;tt&gt;master&lt;/tt&gt; and I like it a lot. I find the code much easier to understand and validate. Initially, I was surprised by the decision to create an own &lt;tt&gt;DeferrableOutputStream&lt;/tt&gt; instead of relying on Commons IO. But after reading the explanation in JavaDoc and thinking about this once more, I think this is the right way to go.&lt;/p&gt;

&lt;p&gt;We do plan to migrate our web application to the Jakarta namespace in Q4 2025. This will be the perfect moment to upgrade to Commons FileUpload 2. I&apos;m already looking forward to this. The configuration with &lt;em&gt;threshold = -1&lt;/em&gt; will probably the one we will go for.&lt;/p&gt;

&lt;p&gt;PS: The 3 links to &lt;a href=&quot;https://issues.apache.org/jira/browse/FILEUPLOAD-295&quot; title=&quot;DiskFileItem: getStoreLocation() may return non-existing file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FILEUPLOAD-295&quot;&gt;FILEUPLOAD-295&lt;/a&gt; in the JavaDoc in &lt;tt&gt;DiskFileItemTest&lt;/tt&gt; are missing a digit in the link display name: &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;/&lt;font color=&quot;#00875a&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FILEUPLOAD-295&quot; title=&quot;DiskFileItem: getStoreLocation() may return non-existing file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FILEUPLOAD-295&quot;&gt;FILEUPLOAD-295&lt;/a&gt;&lt;/font&gt;&quot;&amp;gt;&lt;font color=&quot;#FF0000&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FILEUPLOAD-29&quot; title=&quot;[fileupload] Remove Javadoc warnings&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FILEUPLOAD-29&quot;&gt;&lt;del&gt;FILEUPLOAD-29&lt;/del&gt;&lt;/a&gt;&lt;/font&gt;&amp;lt;/a&amp;gt;&lt;/tt&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0005c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>