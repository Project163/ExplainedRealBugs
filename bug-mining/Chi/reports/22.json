{"url":"https://api.github.com/repos/go-chi/chi/issues/587","repository_url":"https://api.github.com/repos/go-chi/chi","labels_url":"https://api.github.com/repos/go-chi/chi/issues/587/labels{/name}","comments_url":"https://api.github.com/repos/go-chi/chi/issues/587/comments","events_url":"https://api.github.com/repos/go-chi/chi/issues/587/events","html_url":"https://github.com/go-chi/chi/issues/587","id":814060567,"node_id":"MDU6SXNzdWU4MTQwNjA1Njc=","number":587,"title":"Possible regression in 1.5.2: middleware got instantiated and invoked twice","user":{"login":"unext-wendong","id":15605134,"node_id":"MDQ6VXNlcjE1NjA1MTM0","avatar_url":"https://avatars.githubusercontent.com/u/15605134?v=4","gravatar_id":"","url":"https://api.github.com/users/unext-wendong","html_url":"https://github.com/unext-wendong","followers_url":"https://api.github.com/users/unext-wendong/followers","following_url":"https://api.github.com/users/unext-wendong/following{/other_user}","gists_url":"https://api.github.com/users/unext-wendong/gists{/gist_id}","starred_url":"https://api.github.com/users/unext-wendong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/unext-wendong/subscriptions","organizations_url":"https://api.github.com/users/unext-wendong/orgs","repos_url":"https://api.github.com/users/unext-wendong/repos","events_url":"https://api.github.com/users/unext-wendong/events{/privacy}","received_events_url":"https://api.github.com/users/unext-wendong/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2021-02-23T03:20:19Z","updated_at":"2022-09-26T20:41:32Z","closed_at":"2021-03-25T12:56:33Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We noticed the following behavior changes between 1.5.1 and 1.5.2+ (1.5.2 and 1.5.3) related to middleware handlers.\r\n- Middleware handlers got instantiated twice in 1.5.2+. It's once in 1.5.1.\r\n- Middleware handlers got invoked twice for URLs routed to NotFound handlers in 1.5.2+. It's once in 1.5.1.\r\n\r\nExample code:\r\n```\r\npackage main\r\n\r\nimport (\r\n\t\"fmt\"\r\n\t\"net/http\"\r\n\r\n\t\"github.com/go-chi/chi\"\r\n)\r\n\r\nfunc main() {\r\n\tr := chi.NewRouter()\r\n\r\n\tr.Use(func(next http.Handler) http.Handler {\r\n\t\tfmt.Println(\"Instantiating test middleware...\")\r\n\t\treturn http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\r\n\t\t\tfmt.Println(r.URL.Path, \"going through middleware...\")\r\n\t\t\tnext.ServeHTTP(w, r)\r\n\t\t})\r\n\t})\r\n\r\n\tr.NotFound(func(w http.ResponseWriter, r *http.Request) {\r\n\t\tw.WriteHeader(404)\r\n\t\tw.Write([]byte(\"Resource not found\\n\"))\r\n\t})\r\n\r\n\tr.Get(\"/hello\", func(w http.ResponseWriter, r *http.Request) {\r\n\t\tw.WriteHeader(200)\r\n\t\tw.Write([]byte(\"Hello world!\\n\"))\r\n\t})\r\n\r\n\tsvr := &http.Server{\r\n\t\tAddr:    \":6060\",\r\n\t\tHandler: r,\r\n\t}\r\n\r\n\tfmt.Println(\"Starting server...\")\r\n\tif err := svr.ListenAndServe(); err != nil && err != http.ErrServerClosed {\r\n\t\tfmt.Println(\"Server stopped with error:\", err)\r\n\t} else {\r\n\t\tfmt.Println(\"Server stopped normally\")\r\n\t}\r\n}\r\n```\r\n\r\nOutput after one `GET /hello` and one `GET /nihao` requests in 1.5.2+:\r\n```\r\nInstantiating test middleware...\r\nInstantiating test middleware...\r\nStarting server...\r\n/hello going through middleware...\r\n/nihao going through middleware...\r\n/nihao going through middleware...\r\n```\r\n\r\nOutput of the same case in 1.5.1:\r\n```\r\nInstantiating test middleware...\r\nStarting server...\r\n/hello going through middleware...\r\n/nihao going through middleware...\r\n```","closed_by":{"login":"pkieltyka","id":18831,"node_id":"MDQ6VXNlcjE4ODMx","avatar_url":"https://avatars.githubusercontent.com/u/18831?v=4","gravatar_id":"","url":"https://api.github.com/users/pkieltyka","html_url":"https://github.com/pkieltyka","followers_url":"https://api.github.com/users/pkieltyka/followers","following_url":"https://api.github.com/users/pkieltyka/following{/other_user}","gists_url":"https://api.github.com/users/pkieltyka/gists{/gist_id}","starred_url":"https://api.github.com/users/pkieltyka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pkieltyka/subscriptions","organizations_url":"https://api.github.com/users/pkieltyka/orgs","repos_url":"https://api.github.com/users/pkieltyka/repos","events_url":"https://api.github.com/users/pkieltyka/events{/privacy}","received_events_url":"https://api.github.com/users/pkieltyka/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/go-chi/chi/issues/587/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/go-chi/chi/issues/587/timeline","performed_via_github_app":null,"state_reason":"completed"}