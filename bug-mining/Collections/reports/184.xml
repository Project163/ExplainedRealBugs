<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sun Nov 09 05:55:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[COLLECTIONS-802] ReferenceMap iterator remove violates contract</title>
                <link>https://issues.apache.org/jira/browse/COLLECTIONS-802</link>
                <project id="12310465" key="COLLECTIONS">Commons Collections</project>
                    <description>&lt;p&gt;Out of curiosity I ran Guava&apos;s testlib Map tests against the Apache types. This uncovered a contract bug where &lt;tt&gt;Iterator.remove()&lt;/tt&gt; is invalidated by &lt;tt&gt;hasNext()&lt;/tt&gt;, causing its call to no-op due to &lt;tt&gt;currentKey&lt;/tt&gt; becoming &lt;tt&gt;null&lt;/tt&gt;. The isolates case is,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void iterator_remove() {
&#160; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; map = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ReferenceMap&amp;lt;&amp;gt;();
&#160; map.put(1, 2);
&#160; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; iter = map.entrySet().iterator();
&#160; assertTrue(iter.hasNext());
&#160; assertTrue(iter.hasNext());
&#160; assertEquals(iter.next(), 1);
&#160; assertFalse(iter.hasNext());
&#160; iter.remove();
&#160; assertEquals(map, Map.of());
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Guava&apos;s &lt;a href=&quot;https://github.com/google/guava/tree/master/guava-testlib&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testlib&lt;/a&gt; has good coverage for the Collections Framework and might be worth integrating. The simple test case that I wrote is attached.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13420118">COLLECTIONS-802</key>
            <summary>ReferenceMap iterator remove violates contract</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kinow">Bruno P. Kinoshita</assignee>
                                    <reporter username="ben.manes">Ben Manes</reporter>
                        <labels>
                    </labels>
                <created>Fri, 31 Dec 2021 05:43:42 +0000</created>
                <updated>Thu, 28 Apr 2022 10:39:18 +0000</updated>
                            <resolved>Thu, 28 Apr 2022 10:39:18 +0000</resolved>
                                    <version>4.4</version>
                                    <fixVersion>4.5.0-M1</fixVersion>
                                    <component>Map</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6600">1h 50m</timespent>
                                <comments>
                            <comment id="17526507" author="samabcde" created="Fri, 22 Apr 2022 15:47:54 +0000"  >&lt;p&gt;runnable with java 8, same result as stated&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void iterator_remove_failed_after_hasNext() {
        ReferenceMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt; map = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ReferenceMap&amp;lt;&amp;gt;();
        map.put(1, 2);
        Iterator&amp;lt;Map.Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt;&amp;gt; iter = map.entrySet().iterator();
        assertTrue(iter.hasNext());
        assertTrue(iter.hasNext());
        assertEquals(iter.next().getValue(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;(2));
        &lt;span class=&quot;code-comment&quot;&gt;// comment below hasNext() call will pass
&lt;/span&gt;        assertFalse(iter.hasNext());
        iter.remove();
        assertTrue(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expect empty but have entry: &quot;&lt;/span&gt; + map.toString(), map.isEmpty());
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Suspect to be due to line 806 and 807 setting currentKey and currentValue to null. &lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/commons-collections/blob/0b365e4c1833bf55648ca34b9dffd966c31cc69b/src/main/java/org/apache/commons/collections4/map/AbstractReferenceMap.java#L806&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-collections/blob/0b365e4c1833bf55648ca34b9dffd966c31cc69b/src/main/java/org/apache/commons/collections4/map/AbstractReferenceMap.java#L806&lt;/a&gt;&lt;br/&gt;
The whole hasNext method look strange as it is changing the state.&lt;/p&gt;</comment>
                            <comment id="17526546" author="ben.manes" created="Fri, 22 Apr 2022 16:31:07 +0000"  >&lt;p&gt;To clarify, the attached ApacheMapTest is a JUnit-3 test case that covers the entire collections interface. You might consider incorporating it into your test suite.&lt;/p&gt;</comment>
                            <comment id="17526562" author="ben.manes" created="Fri, 22 Apr 2022 16:50:11 +0000"  >&lt;p&gt;Caffeine&apos;s &lt;a href=&quot;https://github.com/ben-manes/caffeine/blob/f52062955adb749e7828d1f1cff12a9eea26bee4/caffeine/src/main/java/com/github/benmanes/caffeine/cache/BoundedLocalCache.java#L3485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;implementation&lt;/a&gt; also modified state during the hasNext(), but it caches on next() the removal key to decouple it from the cursor&apos;s current entry.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17527207" author="samabcde" created="Sun, 24 Apr 2022 16:40:22 +0000"  >&lt;p&gt;I raised a PR &lt;a href=&quot;https://github.com/apache/commons-collections/pull/300&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-collections/pull/300&lt;/a&gt; to fix the problem.&lt;br/&gt;
I didn&apos;t add attached ApacheMapTest as I&apos;m not sure if we can include &lt;b&gt;com.google.common.collect.testing&lt;/b&gt; dependency in this project.&lt;/p&gt;</comment>
                            <comment id="17527209" author="ben.manes" created="Sun, 24 Apr 2022 16:43:55 +0000"  >&lt;p&gt;Thanks! Can you run &lt;tt&gt;ApacheMapTest&lt;/tt&gt; locally then to make sure that your changes didn&apos;t break something else?&lt;/p&gt;</comment>
                            <comment id="17527256" author="kinow" created="Sun, 24 Apr 2022 22:25:51 +0000"  >&lt;p&gt;Running ApacheMapTest from the branch of the pull request had a few test failures. I left a comment in the pull request with the diff applied to pom.xml to get Guava&apos;s testlib into the code, and also added Apache License header &amp;amp; replaced var statements to run everything with `mvn clean test`. Thanks for the comment above &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ben.manes&quot; class=&quot;user-hover&quot; rel=&quot;ben.manes&quot;&gt;ben.manes&lt;/a&gt; ! &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samabcde&quot; class=&quot;user-hover&quot; rel=&quot;samabcde&quot;&gt;samabcde&lt;/a&gt; thanks for the PR. Take a look at the comment and let&apos;s see if we can fix this issue without any errors in ApacheMapTest &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Bruno&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13042863" name="ApacheMapTest-1.java" size="1755" author="ben.manes" created="Sun, 24 Apr 2022 23:08:00 +0000"/>
                            <attachment id="13038079" name="ApacheMapTest.java" size="1931" author="ben.manes" created="Fri, 31 Dec 2021 05:41:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 28 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0y5eg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>