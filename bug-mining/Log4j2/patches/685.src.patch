diff --git a/log4j-core/src/main/java/org/apache/logging/log4j/core/LoggerContext.java b/log4j-core/src/main/java/org/apache/logging/log4j/core/LoggerContext.java
index f2ae53b0db..42efbb553c 100644
--- a/log4j-core/src/main/java/org/apache/logging/log4j/core/LoggerContext.java
+++ b/log4j-core/src/main/java/org/apache/logging/log4j/core/LoggerContext.java
@@ -39,7 +39,6 @@ import org.apache.logging.log4j.core.config.Reconfigurable;
 import org.apache.logging.log4j.core.impl.Log4jLogEvent;
 import org.apache.logging.log4j.core.jmx.Server;
 import org.apache.logging.log4j.core.util.Cancellable;
-import org.apache.logging.log4j.core.util.NanoClockFactory;
 import org.apache.logging.log4j.core.util.NetUtils;
 import org.apache.logging.log4j.core.util.ShutdownCallbackRegistry;
 import org.apache.logging.log4j.message.MessageFactory;
@@ -82,7 +81,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
 
     /**
      * Constructor taking only a name.
-     * 
+     *
      * @param name The context name.
      */
     public LoggerContext(final String name) {
@@ -91,7 +90,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
 
     /**
      * Constructor taking a name and a reference to an external context.
-     * 
+     *
      * @param name The context name.
      * @param externalContext The external context.
      */
@@ -101,7 +100,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
 
     /**
      * Constructor taking a name, external context and a configuration URI.
-     * 
+     *
      * @param name The context name.
      * @param externalContext The external context.
      * @param configLocn The location of the configuration as a URI.
@@ -150,7 +149,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
      * WARNING - The LoggerContext returned by this method may not be the LoggerContext used to create a Logger for the
      * calling class.
      * </p>
-     * 
+     *
      * @return The current LoggerContext.
      * @see LogManager#getContext()
      */
@@ -226,7 +225,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
 
     /**
      * Starts with a specific configuration.
-     * 
+     *
      * @param config The new Configuration.
      */
     public void start(final Configuration config) {
@@ -318,19 +317,19 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
     public String getName() {
         return contextName;
     }
-    
+
     /**
      * Gets the root logger.
-     * 
+     *
      * @return the root logger.
      */
     public Logger getRootLogger() {
         return getLogger(LogManager.ROOT_LOGGER_NAME);
     }
-    
+
     /**
      * Sets the name.
-     * 
+     *
      * @param name the new LoggerContext name
      * @throws NullPointerException if the specified name is {@code null}
      */
@@ -340,7 +339,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
 
     /**
      * Sets the external context.
-     * 
+     *
      * @param context The external context.
      */
     public void setExternalContext(final Object context) {
@@ -349,7 +348,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
 
     /**
      * Returns the external context.
-     * 
+     *
      * @return The external context.
      */
     @Override
@@ -359,7 +358,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
 
     /**
      * Gets a Logger from the Context.
-     * 
+     *
      * @param name The name of the Logger to return.
      * @return The Logger.
      */
@@ -383,7 +382,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
 
     /**
      * Obtains a Logger from the Context.
-     * 
+     *
      * @param name The name of the Logger to return.
      * @param messageFactory The message factory is used only when creating a logger, subsequent use does not change the
      *            logger but will log a warning if mismatched.
@@ -391,7 +390,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
      */
     @Override
     public Logger getLogger(final String name, final MessageFactory messageFactory) {
-        // Note: This is the only method where we add entries to the 'loggers' ivar. 
+        // Note: This is the only method where we add entries to the 'loggers' ivar.
         // The loggers map key is the logger name plus the messageFactory FQCN.
         String key = LoggerContextKey.create(name, messageFactory);
         Logger logger = loggers.get(key);
@@ -409,7 +408,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
 
     /**
      * Determines if the specified Logger exists.
-     * 
+     *
      * @param name The Logger name to search for.
      * @return True if the Logger exists, false otherwise.
      */
@@ -420,7 +419,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
 
     /**
      * Determines if the specified Logger exists.
-     * 
+     *
      * @param name The Logger name to search for.
      * @return True if the Logger exists, false otherwise.
      */
@@ -431,7 +430,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
 
     /**
      * Determines if the specified Logger exists.
-     * 
+     *
      * @param name The Logger name to search for.
      * @return True if the Logger exists, false otherwise.
      */
@@ -452,7 +451,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
     /**
      * Adds a Filter to the Configuration. Filters that are added through the API will be lost when a reconfigure
      * occurs.
-     * 
+     *
      * @param filter The Filter to add.
      */
     public void addFilter(final Filter filter) {
@@ -461,7 +460,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
 
     /**
      * Removes a Filter from the current Configuration.
-     * 
+     *
      * @param filter The Filter to remove.
      */
     public void removeFilter(final Filter filter) {
@@ -470,7 +469,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
 
     /**
      * Sets the Configuration to be used.
-     * 
+     *
      * @param config The new Configuration.
      * @return The previous Configuration.
      */
@@ -506,8 +505,8 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
                 LOGGER.error("Could not reconfigure JMX", t);
             }
             // AsyncLoggers update their nanoClock when the configuration changes
-            Log4jLogEvent.setNanoClock(NanoClockFactory.createNanoClock());
-            
+            Log4jLogEvent.setNanoClock(configuration.getNanoClock());
+
             return prev;
         } finally {
             configLock.unlock();
@@ -533,7 +532,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
      * current configuration. Use {@link #getConfiguration()}.{@link Configuration#getConfigurationSource()
      * getConfigurationSource()}.{@link ConfigurationSource#getLocation() getLocation()} to get the actual source of the
      * current configuration.
-     * 
+     *
      * @return the initial configuration location or {@code null}
      */
     public URI getConfigLocation() {
@@ -542,7 +541,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
 
     /**
      * Sets the configLocation to the specified value and reconfigures this context.
-     * 
+     *
      * @param configLocation the location of the new configuration
      */
     public void setConfigLocation(final URI configLocation) {
@@ -587,7 +586,7 @@ public class LoggerContext extends AbstractLifeCycle implements org.apache.loggi
 
     /**
      * Causes all Logger to be updated against the specified Configuration.
-     * 
+     *
      * @param config The Configuration.
      */
     public void updateLoggers(final Configuration config) {
diff --git a/log4j-core/src/main/java/org/apache/logging/log4j/core/async/AsyncLogger.java b/log4j-core/src/main/java/org/apache/logging/log4j/core/async/AsyncLogger.java
index 62a2bba703..048f04deac 100644
--- a/log4j-core/src/main/java/org/apache/logging/log4j/core/async/AsyncLogger.java
+++ b/log4j-core/src/main/java/org/apache/logging/log4j/core/async/AsyncLogger.java
@@ -32,7 +32,6 @@ import org.apache.logging.log4j.core.util.Clock;
 import org.apache.logging.log4j.core.util.ClockFactory;
 import org.apache.logging.log4j.core.util.Constants;
 import org.apache.logging.log4j.core.util.NanoClock;
-import org.apache.logging.log4j.core.util.NanoClockFactory;
 import org.apache.logging.log4j.message.Message;
 import org.apache.logging.log4j.message.MessageFactory;
 import org.apache.logging.log4j.message.TimestampMessage;
@@ -89,7 +88,7 @@ public class AsyncLogger extends Logger implements EventTranslatorVararg<RingBuf
             final AsyncLoggerDisruptor loggerDisruptor) {
         super(context, name, messageFactory);
         this.loggerDisruptor = loggerDisruptor;
-        nanoClock = NanoClockFactory.createNanoClock(); // based on initial configuration
+        nanoClock = context.getConfiguration().getNanoClock();
     }
 
     /*
@@ -100,7 +99,7 @@ public class AsyncLogger extends Logger implements EventTranslatorVararg<RingBuf
     @Override
     protected void updateConfiguration(Configuration newConfig) {
         super.updateConfiguration(newConfig);
-        nanoClock = NanoClockFactory.createNanoClock();
+        nanoClock = newConfig.getNanoClock();
         LOGGER.trace("[{}] AsyncLogger {} uses {}.", getContext().getName(), getName(), nanoClock);
     }
 
diff --git a/log4j-core/src/main/java/org/apache/logging/log4j/core/config/AbstractConfiguration.java b/log4j-core/src/main/java/org/apache/logging/log4j/core/config/AbstractConfiguration.java
index 8834db6aa7..c9769e0aae 100644
--- a/log4j-core/src/main/java/org/apache/logging/log4j/core/config/AbstractConfiguration.java
+++ b/log4j-core/src/main/java/org/apache/logging/log4j/core/config/AbstractConfiguration.java
@@ -40,8 +40,10 @@ import org.apache.logging.log4j.core.script.AbstractScript;
 import org.apache.logging.log4j.core.script.ScriptManager;
 import org.apache.logging.log4j.core.script.ScriptRef;
 import org.apache.logging.log4j.core.util.Constants;
+import org.apache.logging.log4j.core.util.DummyNanoClock;
 import org.apache.logging.log4j.core.util.Loader;
 import org.apache.logging.log4j.core.util.NameUtil;
+import org.apache.logging.log4j.core.util.NanoClock;
 import org.apache.logging.log4j.core.util.WatchManager;
 import org.apache.logging.log4j.util.PropertiesUtil;
 
@@ -86,7 +88,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
      * Packages found in configuration "packages" attribute.
      */
     protected final List<String> pluginPackages = new ArrayList<>();
-    
+
     /**
      * The plugin manager.
      */
@@ -117,7 +119,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
     private ConfigurationScheduler configurationScheduler = new ConfigurationScheduler();
     private final WatchManager watchManager = new WatchManager(configurationScheduler);
     private AsyncLoggerConfigDisruptor asyncLoggerConfigDisruptor;
-
+    private NanoClock nanoClock = new DummyNanoClock();
 
     /**
      * Constructor.
@@ -268,11 +270,11 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
             loggerConfig.getReliabilityStrategy().beforeStopConfiguration(this);
         }
         root.getReliabilityStrategy().beforeStopConfiguration(this);
-        
+
         final String cls = getClass().getSimpleName();
         LOGGER.trace("{} notified {} ReliabilityStrategies that config will be stopped.", cls, loggerConfigs.size()
                 + 1);
-        
+
         if (!loggerConfigs.isEmpty()) {
             LOGGER.trace("{} stopping {} LoggerConfigs.", cls, loggerConfigs.size());
             for (final LoggerConfig logger : loggerConfigs.values()) {
@@ -288,7 +290,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
             LOGGER.trace("{} stopping AsyncLoggerConfigDisruptor.", cls);
             asyncLoggerConfigDisruptor.stop();
         }
-                
+
         // Stop the appenders in reverse order in case they still have activity.
         final Appender[] array = appenders.values().toArray(new Appender[appenders.size()]);
         final List<Appender> async = getAsyncAppenders(array);
@@ -305,7 +307,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
             loggerConfig.getReliabilityStrategy().beforeStopAppenders();
         }
         root.getReliabilityStrategy().beforeStopAppenders();
-        
+
         LOGGER.trace("{} stopping remaining Appenders.", cls);
         int appenderCount = 0;
         for (int i = array.length - 1; i >= 0; --i) {
@@ -339,7 +341,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
         }
         LOGGER.debug("Stopped {} OK", this);
     }
-    
+
     private List<Appender> getAsyncAppenders(final Appender[] all) {
         final List<Appender> result = new ArrayList<Appender>();
         for (int i = all.length - 1; i >= 0; --i) {
@@ -534,7 +536,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
 
     /**
      * Set the name of the configuration.
-     * 
+     *
      * @param name The name.
      */
     public void setName(final String name) {
@@ -543,7 +545,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
 
     /**
      * Returns the name of the configuration.
-     * 
+     *
      * @return the name of the configuration.
      */
     @Override
@@ -553,7 +555,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
 
     /**
      * Add a listener for changes on the configuration.
-     * 
+     *
      * @param listener The ConfigurationListener to add.
      */
     @Override
@@ -563,7 +565,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
 
     /**
      * Remove a ConfigurationListener.
-     * 
+     *
      * @param listener The ConfigurationListener to remove.
      */
     @Override
@@ -573,7 +575,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
 
     /**
      * Returns the Appender with the specified name.
-     * 
+     *
      * @param appenderName The name of the Appender.
      * @return the Appender with the specified name or null if the Appender cannot be located.
      */
@@ -585,7 +587,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
 
     /**
      * Returns a Map containing all the Appenders and their name.
-     * 
+     *
      * @return A Map containing each Appender's name and the Appender object.
      */
     @Override
@@ -595,7 +597,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
 
     /**
      * Adds an Appender to the configuration.
-     * 
+     *
      * @param appender The Appender to add.
      */
     @Override
@@ -634,7 +636,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
      * being updated at the same time.
      *
      * Note: This method is not used when configuring via configuration. It is primarily used by unit tests.
-     * 
+     *
      * @param logger The Logger the Appender will be associated with.
      * @param appender The Appender.
      */
@@ -661,7 +663,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
      * updated at the same time.
      *
      * Note: This method is not used when configuring via configuration. It is primarily used by unit tests.
-     * 
+     *
      * @param logger The Logger the Footer will be associated with.
      * @param filter The Filter.
      */
@@ -686,7 +688,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
      * updated at the same time.
      *
      * Note: This method is not used when configuring via configuration. It is primarily used by unit tests.
-     * 
+     *
      * @param logger The Logger the Appender will be associated with.
      * @param additive True if the LoggerConfig should be additive, false otherwise.
      */
@@ -709,7 +711,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
      * Remove an Appender. First removes any associations between LoggerConfigs and the Appender, removes the Appender
      * from this appender list and then stops the appender. This method is synchronized in case an Appender with the
      * same name is being added during the removal.
-     * 
+     *
      * @param appenderName the name of the appender to remove.
      */
     public synchronized void removeAppender(final String appenderName) {
@@ -725,7 +727,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
 
     /*
      * (non-Javadoc)
-     * 
+     *
      * @see org.apache.logging.log4j.core.config.Configuration#getCustomLevels()
      */
     @Override
@@ -736,7 +738,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
     /**
      * Locates the appropriate LoggerConfig for a Logger name. This will remove tokens from the package name as
      * necessary or return the root LoggerConfig if no other matches were found.
-     * 
+     *
      * @param loggerName The Logger name.
      * @return The located LoggerConfig.
      */
@@ -758,7 +760,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
 
     /**
      * Returns the root Logger.
-     * 
+     *
      * @return the root Logger.
      */
     @Override
@@ -768,7 +770,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
 
     /**
      * Returns a Map of all the LoggerConfigs.
-     * 
+     *
      * @return a Map with each entry containing the name of the Logger and the LoggerConfig.
      */
     @Override
@@ -778,7 +780,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
 
     /**
      * Returns the LoggerConfig with the specified name.
-     * 
+     *
      * @param loggerName The Logger name.
      * @return The LoggerConfig or null if no match was found.
      */
@@ -948,4 +950,13 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
         return buffer.toByteArray();
     }
 
+    @Override
+    public NanoClock getNanoClock() {
+        return nanoClock;
+    }
+
+    @Override
+    public void setNanoClock(final NanoClock nanoClock) {
+        this.nanoClock = Objects.requireNonNull(nanoClock, "nanoClock");
+    }
 }
diff --git a/log4j-core/src/main/java/org/apache/logging/log4j/core/config/Configuration.java b/log4j-core/src/main/java/org/apache/logging/log4j/core/config/Configuration.java
index e9bb6a04e8..900566d9a0 100644
--- a/log4j-core/src/main/java/org/apache/logging/log4j/core/config/Configuration.java
+++ b/log4j-core/src/main/java/org/apache/logging/log4j/core/config/Configuration.java
@@ -29,6 +29,7 @@ import org.apache.logging.log4j.core.filter.Filterable;
 import org.apache.logging.log4j.core.lookup.StrSubstitutor;
 import org.apache.logging.log4j.core.net.Advertiser;
 import org.apache.logging.log4j.core.script.ScriptManager;
+import org.apache.logging.log4j.core.util.NanoClock;
 import org.apache.logging.log4j.core.util.WatchManager;
 
 /**
@@ -41,7 +42,7 @@ public interface Configuration extends Filterable {
 
     /**
      * Returns the configuration name.
-     * 
+     *
      * @return the name of the configuration.
      */
     String getName();
@@ -49,7 +50,7 @@ public interface Configuration extends Filterable {
     /**
      * Locates the appropriate LoggerConfig for a Logger name. This will remove tokens from the package name as
      * necessary or return the root LoggerConfig if no other matches were found.
-     * 
+     *
      * @param name The Logger name.
      * @return The located LoggerConfig.
      */
@@ -57,7 +58,7 @@ public interface Configuration extends Filterable {
 
     /**
      * Returns the Appender with the specified name.
-     * 
+     *
      * @param <T> The expected Appender type.
      * @param name The name of the Appender.
      * @return the Appender with the specified name or null if the Appender cannot be located.
@@ -66,7 +67,7 @@ public interface Configuration extends Filterable {
 
     /**
      * Returns a Map containing all the Appenders and their name.
-     * 
+     *
      * @return A Map containing each Appender's name and the Appender object.
      */
     Map<String, Appender> getAppenders();
@@ -123,7 +124,7 @@ public interface Configuration extends Filterable {
 
     /**
      * Returns the source of this configuration.
-     * 
+     *
      * @return the source of this configuration
      */
     ConfigurationSource getConfigurationSource();
@@ -141,7 +142,7 @@ public interface Configuration extends Filterable {
      * {@link Level#getLevel(String)}), it is just not in the current configuration. {@link Level#values()} will return
      * {A, B, C, D and the built-in levels}.
      * </p>
-     * 
+     *
      * @return the custom levels defined in the current configuration
      */
     List<CustomLevelConfig> getCustomLevels();
@@ -151,7 +152,7 @@ public interface Configuration extends Filterable {
     /**
      * Returns the {@code AsyncLoggerConfigDelegate} shared by all
      * {@code AsyncLoggerConfig} instances defined in this Configuration.
-     * 
+     *
      * @return the {@code AsyncLoggerConfigDelegate}
      */
 	AsyncLoggerConfigDelegate getAsyncLoggerConfigDelegate();
@@ -172,4 +173,17 @@ public interface Configuration extends Filterable {
 
     ReliabilityStrategy getReliabilityStrategy(LoggerConfig loggerConfig);
 
+    /**
+     * Returns the {@link NanoClock} instance for this configuration.
+     *
+     * @return the nano clock
+     */
+    NanoClock getNanoClock();
+
+    /**
+     * Sets the {@link NanoClock} instance for this configuration.
+     *
+     * @param nanoClock the new nano clock for this configuration. Must be non-null.
+     */
+    void setNanoClock(NanoClock nanoClock);
 }
diff --git a/log4j-core/src/main/java/org/apache/logging/log4j/core/pattern/PatternParser.java b/log4j-core/src/main/java/org/apache/logging/log4j/core/pattern/PatternParser.java
index 08b66db613..4adb90a58a 100644
--- a/log4j-core/src/main/java/org/apache/logging/log4j/core/pattern/PatternParser.java
+++ b/log4j-core/src/main/java/org/apache/logging/log4j/core/pattern/PatternParser.java
@@ -29,7 +29,7 @@ import org.apache.logging.log4j.Logger;
 import org.apache.logging.log4j.core.config.Configuration;
 import org.apache.logging.log4j.core.config.plugins.util.PluginManager;
 import org.apache.logging.log4j.core.config.plugins.util.PluginType;
-import org.apache.logging.log4j.core.util.NanoClockFactory;
+import org.apache.logging.log4j.core.util.SystemNanoClock;
 import org.apache.logging.log4j.status.StatusLogger;
 import org.apache.logging.log4j.util.Strings;
 
@@ -173,12 +173,13 @@ public final class PatternParser {
         final Iterator<FormattingInfo> fieldIter = fields.iterator();
         boolean handlesThrowable = false;
 
-        NanoClockFactory.setMode(NanoClockFactory.Mode.Dummy); // LOG4J2-1074 use dummy clock by default
         for (final PatternConverter converter : converters) {
             if (converter instanceof NanoTimePatternConverter) {
                 // LOG4J2-1074 Switch to actual clock if nanosecond timestamps are required in config.
-                // LoggerContext will notify known NanoClockFactory users that the configuration has changed.
-                NanoClockFactory.setMode(NanoClockFactory.Mode.System);
+                // LOG4J2-1248 set config nanoclock
+                if (config != null) {
+                    config.setNanoClock(new SystemNanoClock());
+                }
             }
             LogEventPatternConverter pc;
             if (converter instanceof LogEventPatternConverter) {
@@ -218,7 +219,7 @@ public final class PatternParser {
      *        last processed character.
      * @param pattern
      *        format string.
-     * @param i
+     * @param start
      *        current index into pattern format.
      * @param convBuf
      *        buffer to receive conversion specifier.
@@ -256,7 +257,7 @@ public final class PatternParser {
      *
      * @param pattern
      *            conversion pattern.
-     * @param i
+     * @param start
      *            start of options.
      * @param options
      *            array to receive extracted options
@@ -567,7 +568,7 @@ public final class PatternParser {
      *            initial character of format specifier.
      * @param pattern
      *            conversion pattern
-     * @param i
+     * @param start
      *            current position in conversion pattern.
      * @param currentLiteral
      *            current literal.
diff --git a/log4j-core/src/main/java/org/apache/logging/log4j/core/util/NanoClockFactory.java b/log4j-core/src/main/java/org/apache/logging/log4j/core/util/NanoClockFactory.java
deleted file mode 100644
index 2a714ee483..0000000000
--- a/log4j-core/src/main/java/org/apache/logging/log4j/core/util/NanoClockFactory.java
+++ /dev/null
@@ -1,84 +0,0 @@
-/*
- * Licensed to the Apache Software Foundation (ASF) under one or more
- * contributor license agreements. See the NOTICE file distributed with
- * this work for additional information regarding copyright ownership.
- * The ASF licenses this file to You under the Apache license, Version 2.0
- * (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the license for the specific language governing permissions and
- * limitations under the license.
- */
-
-package org.apache.logging.log4j.core.util;
-
-import java.util.Objects;
-
-/**
- * Creates the appropriate {@link NanoClock} instance for the current configuration.
- */
-public final class NanoClockFactory {
-
-    /**
-     * Enum over the different kinds of nano clocks this factory can create.
-     */
-    public static enum Mode {
-        /**
-         * Creates dummy nano clocks that always return a fixed value.
-         */
-        Dummy {
-            @Override
-            public NanoClock createNanoClock() {
-                return new DummyNanoClock();
-            }
-        },
-        /**
-         * Creates real nano clocks which call {{System.nanoTime()}}.
-         */
-        System  {
-            @Override
-            public NanoClock createNanoClock() {
-                return new SystemNanoClock();
-            }
-        };
-        
-        public abstract NanoClock createNanoClock();
-    }
-    
-    private static volatile Mode mode = Mode.Dummy;
-    
-    private NanoClockFactory() {
-    }
-    
-    /**
-     * Returns a new {@code NanoClock} determined by the mode of this factory.
-     * 
-     * @return the appropriate {@code NanoClock} for the factory mode
-     */
-    public static NanoClock createNanoClock() {
-        return mode.createNanoClock();
-    }
-    
-    /**
-     * Returns the factory mode.
-     * 
-     * @return the factory mode that determines which kind of nano clocks this factory creates
-     */
-    public static Mode getMode() {
-        return mode;
-    }
-    
-    /**
-     * Sets the factory mode.
-     * 
-     * @param mode the factory mode that determines which kind of nano clocks this factory creates
-     */
-    public static void setMode(Mode mode) {
-        NanoClockFactory.mode = Objects.requireNonNull(mode, "mode must be non-null");
-    }
-}
diff --git a/log4j-core/src/test/java/org/apache/logging/log4j/core/async/AsyncLoggerTestNanoTime.java b/log4j-core/src/test/java/org/apache/logging/log4j/core/async/AsyncLoggerTestNanoTime.java
index bebb0ce934..591d08ba20 100644
--- a/log4j-core/src/test/java/org/apache/logging/log4j/core/async/AsyncLoggerTestNanoTime.java
+++ b/log4j-core/src/test/java/org/apache/logging/log4j/core/async/AsyncLoggerTestNanoTime.java
@@ -26,8 +26,6 @@ import org.apache.logging.log4j.core.CoreLoggerContexts;
 import org.apache.logging.log4j.core.config.ConfigurationFactory;
 import org.apache.logging.log4j.core.util.Constants;
 import org.apache.logging.log4j.core.util.DummyNanoClock;
-import org.apache.logging.log4j.core.util.NanoClockFactory;
-import org.apache.logging.log4j.core.util.NanoClockFactory.Mode;
 import org.apache.logging.log4j.core.util.SystemNanoClock;
 import org.apache.logging.log4j.util.Strings;
 import org.junit.AfterClass;
@@ -61,15 +59,16 @@ public class AsyncLoggerTestNanoTime {
         log.info("Use actual System.nanoTime()");
         assertTrue("using SystemNanoClock", log.getNanoClock() instanceof SystemNanoClock);
 
-        NanoClockFactory.setMode(Mode.Dummy);
-        final long DUMMYNANOTIME = 0;
-        
+        final long DUMMYNANOTIME = -53;
+        log.getContext().getConfiguration().setNanoClock(new DummyNanoClock(DUMMYNANOTIME));
+        log.updateConfiguration(log.getContext().getConfiguration());
+
         // trigger a new nano clock lookup
         log.updateConfiguration(log.getContext().getConfiguration());
-        
+
         log.info("Use dummy nano clock");
         assertTrue("using SystemNanoClock", log.getNanoClock() instanceof DummyNanoClock);
-        
+
         CoreLoggerContexts.stopLoggerContext(file); // stop async thread
 
         final BufferedReader reader = new BufferedReader(new FileReader(file));
@@ -87,7 +86,7 @@ public class AsyncLoggerTestNanoTime {
         assertEquals(line1Parts[0], line1Parts[1]);
         long loggedNanoTime = Long.parseLong(line1Parts[0]);
         assertTrue("used system nano time", loggedNanoTime - before < TimeUnit.SECONDS.toNanos(1));
-        
+
         final String[] line2Parts = line2.split(" AND ");
         assertEquals("Use dummy nano clock", line2Parts[2]);
         assertEquals(String.valueOf(DUMMYNANOTIME), line2Parts[0]);
diff --git a/log4j-core/src/test/java/org/apache/logging/log4j/core/pattern/PatternParserTest.java b/log4j-core/src/test/java/org/apache/logging/log4j/core/pattern/PatternParserTest.java
index d29eac8006..f77eab7177 100644
--- a/log4j-core/src/test/java/org/apache/logging/log4j/core/pattern/PatternParserTest.java
+++ b/log4j-core/src/test/java/org/apache/logging/log4j/core/pattern/PatternParserTest.java
@@ -26,9 +26,12 @@ import org.apache.logging.log4j.MarkerManager;
 import org.apache.logging.log4j.core.LogEvent;
 import org.apache.logging.log4j.core.Logger;
 import org.apache.logging.log4j.core.LoggerContext;
+import org.apache.logging.log4j.core.config.Configuration;
+import org.apache.logging.log4j.core.config.NullConfiguration;
 import org.apache.logging.log4j.core.impl.Log4jLogEvent;
 import org.apache.logging.log4j.core.util.Constants;
-import org.apache.logging.log4j.core.util.NanoClockFactory;
+import org.apache.logging.log4j.core.util.DummyNanoClock;
+import org.apache.logging.log4j.core.util.SystemNanoClock;
 import org.apache.logging.log4j.message.SimpleMessage;
 import org.junit.Before;
 import org.junit.Test;
@@ -111,7 +114,7 @@ public class PatternParserTest {
             formatter.format(event, buf);
         }
         final String str = buf.toString();
-        final String expected = "INFO  [PatternParserTest        :97  ] - Hello, world" + Constants.LINE_SEPARATOR;
+        final String expected = "INFO  [PatternParserTest        :100 ] - Hello, world" + Constants.LINE_SEPARATOR;
         assertTrue("Expected to end with: " + expected + ". Actual: " + str, str.endsWith(expected));
     }
 
@@ -157,14 +160,14 @@ public class PatternParserTest {
         assertTrue("Expected to end with: " + expected + ". Actual: " + str, str.endsWith(expected));
     }
 
-    
+
     @Test
     public void testBadPattern() {
         final Calendar cal = Calendar.getInstance();
         cal.set(2001, Calendar.FEBRUARY, 3, 4, 5, 6);
         cal.set(Calendar.MILLISECOND, 789);
         final long timestamp = cal.getTimeInMillis();
-        
+
         final List<PatternFormatter> formatters = parser.parse(badPattern);
         assertNotNull(formatters);
         final Throwable t = new Throwable();
@@ -183,7 +186,7 @@ public class PatternParserTest {
             formatter.format(event, buf);
         }
         final String str = buf.toString();
-        
+
         // eats all characters until the closing '}' character
         final String expected = "[2001-02-03 04:05:06,789] - Hello, world";
         assertTrue("Expected to start with: " + expected + ". Actual: " + str, str.startsWith(expected));
@@ -223,7 +226,7 @@ public class PatternParserTest {
         assertTrue("Expected to start with: " + expectedStart + ". Actual: " + str, str.startsWith(expectedStart));
         assertTrue("Expected to end with: \"" + expectedEnd + "\". Actual: \"" + str, str.endsWith(expectedEnd));
     }
-    
+
     @Test
     public void testNanoPatternShort() {
         final List<PatternFormatter> formatters = parser.parse("%N");
@@ -231,7 +234,7 @@ public class PatternParserTest {
         assertEquals(1, formatters.size());
         assertTrue(formatters.get(0).getConverter() instanceof NanoTimePatternConverter);
     }
-    
+
     @Test
     public void testNanoPatternLong() {
         final List<PatternFormatter> formatters = parser.parse("%nano");
@@ -239,20 +242,34 @@ public class PatternParserTest {
         assertEquals(1, formatters.size());
         assertTrue(formatters.get(0).getConverter() instanceof NanoTimePatternConverter);
     }
-    
+
     @Test
-    public void testNanoPatternShortChangesNanoClockFactoryMode() {
-        parser.parse("%m");
-        assertEquals(NanoClockFactory.Mode.Dummy, NanoClockFactory.getMode());
-        parser.parse("%nano");
-        assertEquals(NanoClockFactory.Mode.System, NanoClockFactory.getMode());
+    public void testNanoPatternShortChangesConfigurationNanoClock() {
+        Configuration config = new NullConfiguration();
+        assertTrue(config.getNanoClock() instanceof DummyNanoClock);
+
+        PatternParser pp = new PatternParser(config, KEY, null);
+        assertTrue(config.getNanoClock() instanceof DummyNanoClock);
+
+        pp.parse("%m");
+        assertTrue(config.getNanoClock() instanceof DummyNanoClock);
+
+        pp.parse("%nano"); // this changes the config clock
+        assertTrue(config.getNanoClock() instanceof SystemNanoClock);
     }
-    
+
     @Test
     public void testNanoPatternLongChangesNanoClockFactoryMode() {
-        parser.parse("%m");
-        assertEquals(NanoClockFactory.Mode.Dummy, NanoClockFactory.getMode());
-        parser.parse("%N");
-        assertEquals(NanoClockFactory.Mode.System, NanoClockFactory.getMode());
+        Configuration config = new NullConfiguration();
+        assertTrue(config.getNanoClock() instanceof DummyNanoClock);
+
+        PatternParser pp = new PatternParser(config, KEY, null);
+        assertTrue(config.getNanoClock() instanceof DummyNanoClock);
+
+        pp.parse("%m");
+        assertTrue(config.getNanoClock() instanceof DummyNanoClock);
+
+        pp.parse("%N");
+        assertTrue(config.getNanoClock() instanceof SystemNanoClock);
     }
 }
diff --git a/log4j-core/src/test/java/org/apache/logging/log4j/core/util/NanoClockFactoryTest.java b/log4j-core/src/test/java/org/apache/logging/log4j/core/util/NanoClockFactoryTest.java
deleted file mode 100644
index f7667d668f..0000000000
--- a/log4j-core/src/test/java/org/apache/logging/log4j/core/util/NanoClockFactoryTest.java
+++ /dev/null
@@ -1,65 +0,0 @@
-/*
- * Licensed to the Apache Software Foundation (ASF) under one or more
- * contributor license agreements. See the NOTICE file distributed with
- * this work for additional information regarding copyright ownership.
- * The ASF licenses this file to You under the Apache license, Version 2.0
- * (the "License"); you may not use this file except in compliance with
- * the License. You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the license for the specific language governing permissions and
- * limitations under the license.
- */
-
-package org.apache.logging.log4j.core.util;
-
-import org.junit.Test;
-
-import static org.junit.Assert.*;
-
-/**
- * Tests the NanoClockFactory.
- */
-public class NanoClockFactoryTest {
-
-    @Test
-    public void testDefaultModeIsDummy() {
-        assertEquals(NanoClockFactory.Mode.Dummy, NanoClockFactory.getMode());
-    }
-
-    @Test
-    public void testModeIsMutable() {
-        assertEquals(NanoClockFactory.Mode.Dummy, NanoClockFactory.getMode());
-        NanoClockFactory.setMode(NanoClockFactory.Mode.System);
-        assertEquals(NanoClockFactory.Mode.System, NanoClockFactory.getMode());
-
-        NanoClockFactory.setMode(NanoClockFactory.Mode.Dummy);
-        assertEquals(NanoClockFactory.Mode.Dummy, NanoClockFactory.getMode());
-    }
-
-    @Test
-    public void testModeDeterminesGeneratedClockType() {
-        NanoClockFactory.setMode(NanoClockFactory.Mode.Dummy);
-        assertEquals(NanoClockFactory.Mode.Dummy, NanoClockFactory.getMode());
-        assertTrue("dummy", NanoClockFactory.createNanoClock() instanceof DummyNanoClock);
-        
-        NanoClockFactory.setMode(NanoClockFactory.Mode.System);
-        assertEquals(NanoClockFactory.Mode.System, NanoClockFactory.getMode());
-        assertTrue("system", NanoClockFactory.createNanoClock() instanceof SystemNanoClock);
-        
-        NanoClockFactory.setMode(NanoClockFactory.Mode.Dummy);
-        assertEquals(NanoClockFactory.Mode.Dummy, NanoClockFactory.getMode());
-        assertTrue("dummy again", NanoClockFactory.createNanoClock() instanceof DummyNanoClock);
-        
-        NanoClockFactory.setMode(NanoClockFactory.Mode.System);
-        assertEquals(NanoClockFactory.Mode.System, NanoClockFactory.getMode());
-        assertTrue("system", NanoClockFactory.createNanoClock() instanceof SystemNanoClock);
-
-        NanoClockFactory.setMode(NanoClockFactory.Mode.Dummy);
-        assertTrue("dummy again2", NanoClockFactory.createNanoClock() instanceof DummyNanoClock);
-    }
-}
diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index d6de0593d7..b8fe598b88 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -24,19 +24,22 @@
   </properties>
   <body>
     <release version="2.5.1" date="201Y-MM-DD" description="GA Release 2.5.1">
+      <action issue="LOG4J2-1248" dev="rpopma" type="fix">
+        Fixed broken nanotime in pattern layout.
+      </action>
       <action issue="LOG4J2-1080" dev="rpopma" type="add">
         Added option to discard events below a certain log level if the async logger ring buffer
         or async appender queue remaining capacity falls below a certain ratio.
       </action>
       <action issue="LOG4J2-1237" dev="ggregory" type="add" due-to="Mike Calmus, Gary Gregory">
-        Make PatternLayout header and footer accept a pattern. 
+        Make PatternLayout header and footer accept a pattern.
       </action>
       <action issue="LOG4J2-1244" dev="ggregory" type="add" due-to="Anshu Garg, Remko Popma, Gary Gregory">
-        Make header and footer values customizable in JSONLayout. 
+        Make header and footer values customizable in JSONLayout.
       </action>
       <action issue="LOG4J2-1245" dev="ggregory" type="add">
-        Make CSV Layout header and footers accept patterns. 
-      </action>      
+        Make CSV Layout header and footers accept patterns.
+      </action>
       <action issue="LOG4J2-1192" dev="ggregory" type="add" due-to="JÃ¶rg Bretschneider, Gary Gregory">
         Dynamic Subject for SMTP Appender.
       </action>
@@ -65,7 +68,7 @@
         Update Liquibase from 3.3.5 to 3.4.2.
       </action>
       <action issue="LOG4J2-1233" dev="ggregory" type="update" due-to="Bahri Gencsoy">
-        Misleading Value In Properties Example.        
+        Misleading Value In Properties Example.
       </action>
     </release>
     <release version="2.5" date="2015-12-06" description="GA Release 2.5">
