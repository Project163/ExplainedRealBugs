<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:31:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-222] Async Logger threadpool not shut down by Tomcat shutdown</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-222</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;From the user mailing list - conversation with Steven Yang:&lt;/p&gt;

&lt;p&gt;Looks like Tomcat shutdown checks for memory leaks and notices that the Disruptor threadpool used by async loggers has not been shut down.&lt;br/&gt;
Is there any way to pick up a Tomcat shutdown signal and use that to trigger log subsystem shutdown?&lt;/p&gt;


&lt;p&gt;-------------------------&lt;br/&gt;
QUOTING STEVEN:&lt;br/&gt;
Thanks, I tried using asyncRoot and everything seems to log fine and I do see a lot of logs.&lt;br/&gt;
And logs do seem to be flushed immediately so I do not know if the hook on shutdown is been called correctly or not.&lt;/p&gt;

&lt;p&gt;I am using struts and spring so I see a lot of logs (log level at DEBUG) just by starting up tomcat, so I am wondering when I use &amp;lt;root&amp;gt; how come I dont see any log at all? how much log do I have to write before it starts to flush out? &lt;/p&gt;

&lt;p&gt;and one thing I found is that when I use asyncRoot and when I shutdown tomcat I see the following message regarding to clearing references and thread local.&lt;br/&gt;
The last one is related to log4j.&lt;br/&gt;
I am trying this on tomcat 6.0.29. &lt;/p&gt;


&lt;p&gt;&#22235;&#26376; 28, 2013 8:34:46 &#19978;&#21320; org.apache.catalina.loader.WebappClassLoader clearReferencesJdbc&lt;br/&gt;
SEVERE: The web application &lt;span class=&quot;error&quot;&gt;&amp;#91;/test&amp;#93;&lt;/span&gt; registered the JBDC driver &lt;span class=&quot;error&quot;&gt;&amp;#91;org.h2.Driver&amp;#93;&lt;/span&gt; but failed to unregister it when the web application was stopped. To prevent a memory leak, the JDBC Driver has been forcibly unregistered.&lt;br/&gt;
&#22235;&#26376; 28, 2013 8:34:46 &#19978;&#21320; org.apache.catalina.loader.WebappClassLoader clearReferencesThreads&lt;br/&gt;
SEVERE: The web application &lt;span class=&quot;error&quot;&gt;&amp;#91;/test&amp;#93;&lt;/span&gt; appears to have started a thread named &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-2-thread-1&amp;#93;&lt;/span&gt; but has failed to stop it. This is very likely to create a memory leak.&lt;br/&gt;
&#22235;&#26376; 28, 2013 8:34:46 &#19978;&#21320; org.apache.catalina.loader.WebappClassLoader clearThreadLocalMap&lt;br/&gt;
SEVERE: The web application &lt;span class=&quot;error&quot;&gt;&amp;#91;/test&amp;#93;&lt;/span&gt; created a ThreadLocal with key of type &lt;span class=&quot;error&quot;&gt;&amp;#91;java.lang.ThreadLocal&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;java.lang.ThreadLocal@454e119d&amp;#93;&lt;/span&gt;) and a value of type &lt;span class=&quot;error&quot;&gt;&amp;#91;com.opensymphony.xwork2.inject.ContainerImpl&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;com.opensymphony.xwork2.inject.ContainerImpl@8667df7&amp;#93;&lt;/span&gt;) but failed to remove it when the web application was stopped. This is very likely to create a memory leak.&lt;br/&gt;
&#22235;&#26376; 28, 2013 8:34:46 &#19978;&#21320; org.apache.catalina.loader.WebappClassLoader clearThreadLocalMap&lt;br/&gt;
SEVERE: The web application &lt;span class=&quot;error&quot;&gt;&amp;#91;/test&amp;#93;&lt;/span&gt; created a ThreadLocal with key of type &lt;span class=&quot;error&quot;&gt;&amp;#91;java.lang.ThreadLocal&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;java.lang.ThreadLocal@d7e770&amp;#93;&lt;/span&gt;) and a value of type &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.logging.log4j.core.impl.Log4jLogEvent&amp;#93;&lt;/span&gt; (value [Logger=org.springframework.beans.factory.support.DefaultListableBeanFactory Level=INFO Message=Destroying singletons in org.springframework.beans.factory.support.DefaultListableBeanFactory@61e118f9: defining beans [org.springframework.context.annotation.internalConfigurationAnnotationProcessor,org.springframework.context.annotation.internalAutowiredAnnotationProcessor,org.springframewo...&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12645056">LOG4J2-222</key>
            <summary>Async Logger threadpool not shut down by Tomcat shutdown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rpopma">Remko Popma</reporter>
                        <labels>
                    </labels>
                <created>Sun, 28 Apr 2013 01:26:14 +0000</created>
                <updated>Sun, 28 Jul 2013 16:17:31 +0000</updated>
                            <resolved>Tue, 30 Apr 2013 03:48:53 +0000</resolved>
                                    <version>2.0-beta5</version>
                                    <fixVersion>2.0-beta6</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13643866" author="remkop@yahoo.com" created="Sun, 28 Apr 2013 01:40:51 +0000"  >&lt;p&gt;It may make sense to look at these together.&lt;/p&gt;</comment>
                            <comment id="13645216" author="ralph.goers@dslextreme.com" created="Tue, 30 Apr 2013 03:48:53 +0000"  >&lt;p&gt;Fixed in revision 1477462. Please verify and close.&lt;/p&gt;</comment>
                            <comment id="13645229" author="remkop@yahoo.com" created="Tue, 30 Apr 2013 04:17:18 +0000"  >&lt;p&gt;Ralph, just eyeballing the changes you made it looks good, but I&apos;d like to step through it in a debugger to make sure.&lt;/p&gt;

&lt;p&gt;I noticed you made changes to AsyncLoggerConfig and *Helper, but not to AsyncLogger.&lt;br/&gt;
Is that because the problem did not exist in that class, or because &lt;br/&gt;
-DLog4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector&lt;br/&gt;
cannot be used in a web application?&lt;/p&gt;

&lt;p&gt;(If the latter is the case maybe I should note this in the Async Logger docs...)&lt;/p&gt;</comment>
                            <comment id="13645321" author="ralph.goers@dslextreme.com" created="Tue, 30 Apr 2013 06:36:15 +0000"  >&lt;p&gt;The problems were:&lt;br/&gt;
a) The disruptor was only being stopped during a shutdown. However, a reconfiguration from an async logger to a synchronous logger would cause it to never shutdown.&lt;br/&gt;
b) The disruptor is a singleton and could be shared by multiple things. A counter was added to keep track of them and only allow shutdown when everything is complete.&lt;br/&gt;
c) The disruptor was shutting down before the managers using it were stopped. It now stops after them so they can successfully complete.&lt;/p&gt;</comment>
                            <comment id="13646630" author="remkop@yahoo.com" created="Wed, 1 May 2013 15:03:44 +0000"  >&lt;p&gt;Added small fix (revision 1478040) to prevent NPE in ShutdownHook thread if disruptor was already shut down in app thread. (Details are in the comments of LOG4J-223)&lt;/p&gt;</comment>
                            <comment id="13647170" author="remkop@yahoo.com" created="Thu, 2 May 2013 01:35:59 +0000"  >&lt;p&gt;Tested revision 1478040 with Archiva and looks good. See comments in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-223&quot; title=&quot;IllegalStateException thrown during Tomcat shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-223&quot;&gt;&lt;del&gt;LOG4J2-223&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Tomcat now shuts down cleanly when using mixed sync and async loggers.&lt;br/&gt;
Superficial testing of the &quot;all loggers async&quot; scenario ( -DLog4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector ) also looked good.&lt;/p&gt;</comment>
                            <comment id="13721882" author="mikekloster" created="Sun, 28 Jul 2013 05:37:38 +0000"  >&lt;p&gt;This is marked as fixed. However, when I build the trunk as of July-27-2013 23:00 CDT, I can still generate the shutdown errors using a very simple example on Tomcat 7.0.42.&lt;/p&gt;

&lt;p&gt;Steps to reproduce:&lt;br/&gt;
1) create minimal web app with following structure:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;WEB-INF/lib/disruptor-3.1.1.jar
WEB-INF/lib/log4j-core-2.0-beta9-SNAPSHOT.jar
WEB-INF/lib/log4j-api-2.0-beta9-SNAPSHOT.jar
WEB-INF/classes/log4j.xml
WEB-INF/web.xml
asynclog.jsp
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;log4j2.xml&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;?xml version=&lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt; encoding=&lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;?&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;configuration status=&lt;span class=&quot;code-quote&quot;&gt;&quot;WARN&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;appenders&amp;gt;&lt;/span&gt;
    &amp;lt;FastRollingFile name=&lt;span class=&quot;code-quote&quot;&gt;&quot;MyFileLog&quot;&lt;/span&gt; filename=&lt;span class=&quot;code-quote&quot;&gt;&quot;logs/my.log&quot;&lt;/span&gt;
      filePattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;logs/my-%d{COMPACT}.log&quot;&lt;/span&gt;&amp;gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;PatternLayout pattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;%d %p %c{1.} [%t] %m%n&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;Policies&amp;gt;&lt;/span&gt;
	  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;SizeBasedTriggeringPolicy size=&lt;span class=&quot;code-quote&quot;&gt;&quot;5MB&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/Policies&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/FastRollingFile&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;Console name=&lt;span class=&quot;code-quote&quot;&gt;&quot;Console&quot;&lt;/span&gt; target=&lt;span class=&quot;code-quote&quot;&gt;&quot;SYSTEM_OUT&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;PatternLayout pattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;%d %p %c{1.} [%t] %m%n&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/Console&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/appenders&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;loggers&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;logger name=&lt;span class=&quot;code-quote&quot;&gt;&quot;mylogger&quot;&lt;/span&gt; level=&lt;span class=&quot;code-quote&quot;&gt;&quot;INFO&quot;&lt;/span&gt; additivity=&lt;span class=&quot;code-quote&quot;&gt;&quot;false&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;appender-ref ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;MyFileLog&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/logger&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;root level=&lt;span class=&quot;code-quote&quot;&gt;&quot;TRACE&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;appender-ref ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;Console&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/root&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/loggers&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/configuration&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;asynclog.jsp&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;%@ page &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.logging.log4j.*&quot;&lt;/span&gt;%&amp;gt;
&amp;lt;%
  &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; log = request.getParameter(&lt;span class=&quot;code-quote&quot;&gt;&quot;log&quot;&lt;/span&gt;);
  Logger logger = LogManager.getLogger(&lt;span class=&quot;code-quote&quot;&gt;&quot;mylogger&quot;&lt;/span&gt;);
  logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;log: &lt;span class=&quot;code-quote&quot;&gt;&apos;&quot;&lt;/span&gt;+log+&lt;span class=&quot;code-quote&quot;&gt;&quot;&apos;&lt;/span&gt;&quot;&lt;/span&gt;); 
%&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;web.xml&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;?xml version=&lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt; encoding=&lt;span class=&quot;code-quote&quot;&gt;&quot;ISO-8859-1&quot;&lt;/span&gt;?&amp;gt;&lt;/span&gt;
&amp;lt;web-app xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://java.sun.com/xml/ns/javaee&quot;&lt;/span&gt;
   &lt;span class=&quot;code-keyword&quot;&gt;xmlns:xsi&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&lt;/span&gt;
   xsi:schemaLocation=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;&lt;/span&gt;
   version=&lt;span class=&quot;code-quote&quot;&gt;&quot;2.5&quot;&lt;/span&gt;&amp;gt;

    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;description&amp;gt;&lt;/span&gt;
      Async Log Server Example
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/description&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;display-name&amp;gt;&lt;/span&gt;Async Log Server Example&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/display-name&amp;gt;&lt;/span&gt;

&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/web-app&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;2. setenv.sh on tomcat to indicate async logging:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;setenv.sh&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;#!/bin/bash

CATALINA_OPTS=-DLog4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;3. start tomcat with webapp and hit asynclog.jsp?log=example&lt;/p&gt;

&lt;p&gt;4. stop tomcat&lt;/p&gt;

&lt;p&gt;5. cat logs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Jul 28, 2013 12:27:37 AM org.apache.coyote.AbstractProtocol start
INFO: Starting ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080&quot;&lt;/span&gt;]
Jul 28, 2013 12:27:37 AM org.apache.coyote.AbstractProtocol start
INFO: Starting ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-bio-8009&quot;&lt;/span&gt;]
Jul 28, 2013 12:27:37 AM org.apache.catalina.startup.Catalina start
INFO: Server startup in 684 ms
Jul 28, 2013 12:28:00 AM org.apache.catalina.core.StandardServer await
INFO: A valid shutdown command was received via the shutdown port. Stopping the Server instance.
Jul 28, 2013 12:28:00 AM org.apache.coyote.AbstractProtocol pause
INFO: Pausing ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080&quot;&lt;/span&gt;]
Jul 28, 2013 12:28:00 AM org.apache.coyote.AbstractProtocol pause
INFO: Pausing ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-bio-8009&quot;&lt;/span&gt;]
Jul 28, 2013 12:28:00 AM org.apache.catalina.core.StandardService stopInternal
INFO: Stopping service Catalina
Jul 28, 2013 12:28:00 AM org.apache.catalina.loader.WebappClassLoader clearReferencesThreads
SEVERE: The web application [/asynclog] appears to have started a thread named [AsyncLogger-1] but has failed to stop it. This is very likely to create a memory leak.
Jul 28, 2013 12:28:00 AM org.apache.catalina.loader.WebappClassLoader checkThreadLocalMapForLeaks
SEVERE: The web application [/asynclog] created a ThreadLocal with key of type [java.lang.ThreadLocal] (value [java.lang.ThreadLocal@61bd427]) and a value of type [org.apache.logging.log4j.core.async.AsyncLogger.Info] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info@57ab4292]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and avoid a probable memory leak.
Jul 28, 2013 12:28:00 AM org.apache.coyote.AbstractProtocol stop
INFO: Stopping ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080&quot;&lt;/span&gt;]
Jul 28, 2013 12:28:00 AM org.apache.coyote.AbstractProtocol stop
INFO: Stopping ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-bio-8009&quot;&lt;/span&gt;]
Jul 28, 2013 12:28:00 AM org.apache.coyote.AbstractProtocol destroy
INFO: Destroying ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080&quot;&lt;/span&gt;]
Jul 28, 2013 12:28:00 AM org.apache.coyote.AbstractProtocol destroy
INFO: Destroying ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-bio-8009&quot;&lt;/span&gt;]
Jul 28, 2013 12:28:01 AM org.apache.catalina.loader.WebappClassLoader loadClass
INFO: Illegal access: &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; web application instance has been stopped already.  Could not load java.util.concurrent.TimeUnit.  The eventual following stack trace is caused by an error thrown &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; debugging purposes as well as to attempt to terminate the thread which caused the illegal access, and has no functional impact.
java.lang.IllegalStateException
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1600)
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1559)
	at com.lmax.disruptor.dsl.Disruptor.shutdown(Disruptor.java:292)
	at org.apache.logging.log4j.core.async.AsyncLogger.stop(AsyncLogger.java:249)
	at org.apache.logging.log4j.core.async.AsyncLoggerContext.stop(AsyncLoggerContext.java:56)
	at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:437)
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-9&quot;&lt;/span&gt; java.lang.NoClassDefFoundError: org/apache/logging/log4j/core/config/NullConfiguration
	at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:210)
	at org.apache.logging.log4j.core.async.AsyncLoggerContext.stop(AsyncLoggerContext.java:57)
	at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:437)
Caused by: java.lang.ClassNotFoundException: org.apache.logging.log4j.core.config.NullConfiguration
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1714)
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1559)
	... 3 more

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Scroll down through the catalina.out. The errors / exception on shutdown are still present. &lt;/p&gt;

&lt;p&gt;Should I submit this as a new bug report, or should the bug report be reopened?&lt;/p&gt;</comment>
                            <comment id="13721894" author="beamerblvd" created="Sun, 28 Jul 2013 06:33:15 +0000"  >&lt;p&gt;Please see the documentation on using Log4j 2 in Web Applications: &lt;a href=&quot;http://logging.apache.org/log4j/2.x/manual/webapp.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://logging.apache.org/log4j/2.x/manual/webapp.html&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;You either need to change your &lt;tt&gt;web-app&lt;/tt&gt; version to 3.0, or you need to declare the Log4j listener and filter.&lt;/p&gt;</comment>
                            <comment id="13721972" author="mikekloster" created="Sun, 28 Jul 2013 15:23:14 +0000"  >&lt;p&gt;I&apos;ve retested using 3.0 as the version property in web.xml and removing log4j*.jar in the jarsToSkip of catalina.properties on tomcat 7.0.42 and I get the following output on shutdown:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Jul 28, 2013 9:55:59 AM org.apache.coyote.AbstractProtocol start
INFO: Starting ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080&quot;&lt;/span&gt;]
Jul 28, 2013 9:55:59 AM org.apache.coyote.AbstractProtocol start
INFO: Starting ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-bio-8009&quot;&lt;/span&gt;]
Jul 28, 2013 9:55:59 AM org.apache.catalina.startup.Catalina start
INFO: Server startup in 841 ms
Jul 28, 2013 9:56:09 AM org.apache.catalina.core.StandardServer await
INFO: A valid shutdown command was received via the shutdown port. Stopping the Server instance.
Jul 28, 2013 9:56:09 AM org.apache.coyote.AbstractProtocol pause
INFO: Pausing ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080&quot;&lt;/span&gt;]
Jul 28, 2013 9:56:09 AM org.apache.coyote.AbstractProtocol pause
INFO: Pausing ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-bio-8009&quot;&lt;/span&gt;]
Jul 28, 2013 9:56:09 AM org.apache.catalina.core.StandardService stopInternal
INFO: Stopping service Catalina
Jul 28, 2013 9:56:09 AM org.apache.catalina.loader.WebappClassLoader checkThreadLocalMapForLeaks
SEVERE: The web application [/asynclog] created a ThreadLocal with key of type [java.lang.ThreadLocal] (value [java.lang.ThreadLocal@648bfdea]) and a value of type [org.apache.logging.log4j.core.async.AsyncLogger.Info] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info@4e26d560]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and avoid a probable memory leak.
Jul 28, 2013 9:56:09 AM org.apache.coyote.AbstractProtocol stop
INFO: Stopping ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080&quot;&lt;/span&gt;]
Jul 28, 2013 9:56:09 AM org.apache.coyote.AbstractProtocol stop
INFO: Stopping ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-bio-8009&quot;&lt;/span&gt;]
Jul 28, 2013 9:56:09 AM org.apache.coyote.AbstractProtocol destroy
INFO: Destroying ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080&quot;&lt;/span&gt;]
Jul 28, 2013 9:56:09 AM org.apache.coyote.AbstractProtocol destroy
INFO: Destroying ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-bio-8009&quot;&lt;/span&gt;]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;web.xml&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;?xml version=&lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt; encoding=&lt;span class=&quot;code-quote&quot;&gt;&quot;ISO-8859-1&quot;&lt;/span&gt;?&amp;gt;&lt;/span&gt;
&amp;lt;web-app xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://java.sun.com/xml/ns/javaee&quot;&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;xmlns:xsi&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&lt;/span&gt;
  xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee
                      http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;
  version=&lt;span class=&quot;code-quote&quot;&gt;&quot;3.0&quot;&lt;/span&gt;
  metadata-complete=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt;&amp;gt;

    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;description&amp;gt;&lt;/span&gt;
      Async Log Server Example
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/description&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;display-name&amp;gt;&lt;/span&gt;Async Log Server Example&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/display-name&amp;gt;&lt;/span&gt;

&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/web-app&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;catalina.properties&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;tomcat.util.scan.DefaultJarScanner.jarsToSkip=\
bootstrap.jar,commons-daemon.jar,tomcat-juli.jar,\
annotations-api.jar,el-api.jar,jsp-api.jar,servlet-api.jar,\
catalina.jar,catalina-ant.jar,catalina-ha.jar,catalina-tribes.jar,\
jasper.jar,jasper-el.jar,ecj-*.jar,\
tomcat-api.jar,tomcat-util.jar,tomcat-coyote.jar,tomcat-dbcp.jar,\
tomcat-jni.jar,tomcat-spdy.jar,\
tomcat-i18n-en.jar,tomcat-i18n-es.jar,tomcat-i18n-fr.jar,tomcat-i18n-ja.jar,\
tomcat-juli-adapters.jar,catalina-jmx-remote.jar,catalina-ws.jar,\
tomcat-jdbc.jar,\
tools.jar,\
commons-beanutils*.jar,commons-codec*.jar,commons-collections*.jar,\
commons-dbcp*.jar,commons-digester*.jar,commons-fileupload*.jar,\
commons-httpclient*.jar,commons-io*.jar,commons-lang*.jar,commons-logging*.jar,\
commons-math*.jar,commons-pool*.jar,\
jstl.jar,\
geronimo-spec-jaxrpc*.jar,wsdl4j*.jar,\
ant.jar,ant-junit*.jar,aspectj*.jar,jmx.jar,h2*.jar,hibernate*.jar,httpclient*.jar,\
jmx-tools.jar,jta*.jar,mail*.jar,slf4j*.jar,\
xercesImpl.jar,xmlParserAPIs.jar,xml-apis.jar,\
junit.jar,junit-*.jar,ant-launcher.jar
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I don&apos;t mean for you to debug my code. I apologize in advance if I&apos;ve missed anything obvious (again!).&lt;/p&gt;</comment>
                            <comment id="13721987" author="beamerblvd" created="Sun, 28 Jul 2013 16:17:31 +0000"  >&lt;p&gt;Nope, I don&apos;t think you&apos;ve missed anything obvious this time. The change you made to &lt;tt&gt;catalina.properties&lt;/tt&gt; and &lt;tt&gt;web.xml&lt;/tt&gt; resolved the issue with Log4j not shutting down properly. Now you&apos;ve found a completely unrelated ThreadLocal-leak. Please file a separate issue for that. You won&apos;t need &lt;tt&gt;catalina.properties&lt;/tt&gt; or your &lt;tt&gt;web.xml&lt;/tt&gt;, as they have nothing to do with this problem. Just include the new Tomcat console output you just showed me, &lt;tt&gt;log4j2.xml&lt;/tt&gt;, and &lt;tt&gt;setenv.sh&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;By the way, I noticed you&apos;re using Java code to log in your &lt;tt&gt;asynclog.jsp&lt;/tt&gt;. This isn&apos;t causing any problems, but it&apos;s not the easiest way to log in JSPs. You might want to take a look at the &lt;a href=&quot;http://logging.apache.org/log4j/2.x/log4j-taglib/index.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Log4j 2 Tag Library&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12645057">LOG4J2-223</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>325418</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 17 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1k54v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>325763</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>