<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:39:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-2007] Async logger with SMTP appender looses ThreadContext values in PatternLayout</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-2007</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;ThreadContext values seems not handled properly in pattern/header/footer properties of PatternLayout when using async logging with a SMTP appender.&lt;br/&gt;
Tested with a SMTP appended with a pattern layout: header is populated property in sync mode but it doesn&apos;t work anymore when switching to async (both using an Async appender than switching to async globally)&lt;/p&gt;

&lt;p&gt;This is a simple appender configuration that shows this behaviour:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt;SMTP name=&quot;sync-mail&quot; to=&quot;none@example.com&quot; from=&quot;TEST&amp;amp;lt;none@example.com&amp;amp;gt;&quot; smtpHost=&quot;localhost&quot; smtpPort=&quot;25&quot; ignoreExceptions=&quot;false&quot; subject=&quot;MDCSUBJECT%X{MDC1} %m&quot;&amp;gt;
      &amp;lt;PatternLayout header=&quot;%n
===================================%n
MDC1HEADER=%X{MDC1}%n
===================================%n&quot; pattern=&quot;%-5p  %c (%F:%L) %d{dd.MM.yyyy HH:mm:ss}  %m MDC1=%X{MDC1}%ex%n&quot; /&amp;gt;
    &amp;lt;/SMTP&amp;gt;
    &amp;lt;Async name=&quot;mail-async&quot; includeLocation=&quot;true&quot;&amp;gt;
      &amp;lt;AppenderRef ref=&quot;sync-mail&quot; /&amp;gt;
    &amp;lt;/Async&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;a simple:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ThreadContext.put(&quot;MDC1&quot;, &quot;***testmdc***&quot;);
log.error(&quot;test message&quot;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which goes directly to the sync-mail appender leads to the following result:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;subject: MDCSUBJECT***testmdc*** test message 
body: 
 ===================================
 MDC1HEADER=***testmdc***
 ===================================
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;as you can see the ThreadContext value is replace in both the subject (built with the &quot;subject&quot; attribute of the appender) and the body of the email, generated using the &quot;header&quot; layout attribute.&lt;/p&gt;

&lt;p&gt;Doing the same though the &quot;mail-async&quot; appender leads instead to the following result:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;subject: MDCSUBJECT***testmdc*** test message 
body: 
 ===================================
 MDC1HEADER=
 ===================================
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As you can see the subject of the email is still handled property (the ThreadContext value has been filled although the message has been sent by a separate thread) but the body of the email has lost any ThreadContext value. I actually couldn&apos;t find any way at the moment to preserve ThreadContext values in header/footer without keeping the smtp appender synchronous.&lt;/p&gt;

</description>
                <environment></environment>
        <key id="13094127">LOG4J2-2007</key>
            <summary>Async logger with SMTP appender looses ThreadContext values in PatternLayout</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="mikaelstaldal">Mikael St&#229;ldal</assignee>
                                    <reporter username="fgiust">Fabrizio Giustina</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Aug 2017 15:55:15 +0000</created>
                <updated>Thu, 30 Nov 2017 22:44:39 +0000</updated>
                                            <version>2.10.0</version>
                                                    <component>Appenders</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16273416" author="mikaelstaldal" created="Thu, 30 Nov 2017 21:03:18 +0000"  >&lt;p&gt;I can reproduce your results, but I am not sure what the expected behavior is.&lt;/p&gt;</comment>
                            <comment id="16273601" author="remkop@yahoo.com" created="Thu, 30 Nov 2017 22:44:39 +0000"  >&lt;p&gt;With async appender/loggers, many pieces of the smtp message are populated by the background thread. The background thread cannot see ThreadLocal values that the application put in the thread context. Please use another lookup, like system properties or a custom lookup (they&#8217;re easy to create and only a few lines of code).&lt;/p&gt;

&lt;p&gt;Why the subject still holds the thread context value I cannot tell without looking at the code, but I suspect there&#8217;s some caching involved. We could consider removing the caching to give more consistent behaviour, but (without looking at the code) unsure what the impact would be. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 50 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ip6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>