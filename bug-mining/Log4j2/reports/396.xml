<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:33:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-819] PermGen OutOfMemoryError when reloading webapp on Tomcat 6</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-819</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;When reloading an application 3 or 4 times in Tomcat 6, the application crashes with a &quot;java.lang.OutOfMemoryError: PermGen space&quot; exception.&lt;/p&gt;

&lt;p&gt;After some investigation using the &quot;When all else fails&quot; section of &lt;a href=&quot;https://wiki.apache.org/tomcat/OutOfMemory&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://wiki.apache.org/tomcat/OutOfMemory&lt;/a&gt; in conjunction with Java VisualVM, I have narrowed down the problem to the Thread created within org.apache.logging.log4j.core.util.CoarseCachedClock.&lt;/p&gt;

&lt;p&gt;When a Thread is created, it contains a reference to the classloader that it was created with. In this case, the Thread&apos;s contextClassLoader field contains a reference to the WebappClassLoader. When Tomcat attempts to unload the webapp, the Thread still holds onto this reference which prevents WebappClassLoader from being freed.&lt;/p&gt;

&lt;p&gt;Perhaps the Log4jServletContextListener (Log4jWebInitializerImpl) can be made to stop the CoarseCachedClock thread.&lt;/p&gt;

&lt;p&gt;I believe this is not an obvious issue on Tomcat 7 due to &lt;a href=&quot;https://wiki.apache.org/tomcat/MemoryLeakProtection&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://wiki.apache.org/tomcat/MemoryLeakProtection&lt;/a&gt;.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Tomcat 6&lt;/p&gt;</environment>
        <key id="12740321">LOG4J2-819</key>
            <summary>PermGen OutOfMemoryError when reloading webapp on Tomcat 6</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="costat">Costa Theodosiou</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Sep 2014 06:12:28 +0000</created>
                <updated>Sun, 14 Sep 2014 14:43:38 +0000</updated>
                            <resolved>Sun, 14 Sep 2014 14:08:00 +0000</resolved>
                                    <version>2.0.2</version>
                                    <fixVersion>2.1</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14128485" author="garydgregory" created="Wed, 10 Sep 2014 13:58:06 +0000"  >&lt;p&gt;All clocks are now stoppable in this patch. The Log4jWebInitializerImpl stops the clock but should the stop() call be in the logger context instead?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=costat&quot; class=&quot;user-hover&quot; rel=&quot;costat&quot;&gt;costat&lt;/a&gt;: Can you apply this patch and try it in your scenario?&lt;/p&gt;</comment>
                            <comment id="14129390" author="remkop@yahoo.com" created="Wed, 10 Sep 2014 23:55:14 +0000"  >&lt;p&gt;I&apos;m leaning towards not fixing this. Stopping (and re-starting!) clock threads brings too much complexity. &lt;/p&gt;

&lt;p&gt;These clocks were designed to be used in ultralow (sub-microsecond) latency applications. &lt;br/&gt;
Web apps don&apos;t fall into that category. &lt;/p&gt;

&lt;p&gt;Web apps should just use the default system clock. Using any other class gives them no benefits and only trouble. &lt;/p&gt;

&lt;p&gt;I will update the site docs to that effect. &lt;/p&gt;</comment>
                            <comment id="14129418" author="costat" created="Thu, 11 Sep 2014 00:13:14 +0000"  >&lt;p&gt;The scenario I reported was a default scenario. I did not configure a different clock to whatever was created by default. The CoarseCachedClock$1 Thread was created regardless.&lt;/p&gt;

&lt;p&gt;The CoarseCachedClock singleton is created automatically by the classloader. The singleton creates the Thread and the Thread is kicked off by the CoarseCachedClock constructor. This means regardless of what ClockFactory.getClock() you want, the Thread is already there chugging along.&lt;/p&gt;

&lt;p&gt;Perhaps what is needed is a for CoarseCachedClock.instance() to return a singleton that is created &lt;b&gt;on demand&lt;/b&gt;. Synchronization of this static method will also have to be considered so that one and only one instance is ever created.&lt;/p&gt;</comment>
                            <comment id="14129437" author="remkop@yahoo.com" created="Thu, 11 Sep 2014 00:29:43 +0000"  >&lt;p&gt;Aha! Thanks for pointing that out. I assumed you had configured the CoarseCachedClock and I completely missed that a singleton is always created. We should definitely fix that.&lt;/p&gt;</comment>
                            <comment id="14129465" author="garydgregory" created="Thu, 11 Sep 2014 01:04:56 +0000"  >&lt;p&gt;I disagree, from my reply on the ML:&lt;/p&gt;

&lt;p&gt;Hi Remko &amp;amp; Matt,&lt;/p&gt;

&lt;p&gt;Thank you for chiming in.&lt;/p&gt;

&lt;p&gt;As of now, the threads still exist and are not cleanly stoppable. The only way to cleanly and &lt;em&gt;simply&lt;/em&gt; stop a thread is with a flag as the patch does. From a design stand point it does not smell right to start threads and not offer a clean way to stop them. So that&apos;s one point I see in favor of &lt;em&gt;at least&lt;/em&gt; having the new cleaner clocks in master. Whether or not we stop them automatically is another issue.&lt;/p&gt;

&lt;p&gt;I see your point about web apps but that only means (to me) that out web integration needs to override the clock factory with one that does not use a thread. If the user configures a thread based clock anyway, then what? He or she is hosed? That does not sound right.&lt;/p&gt;

&lt;p&gt;So from a process POV, I would like to:&lt;/p&gt;

&lt;p&gt;(1) Agree on how to stop a thread-based clock (my patch minus the call from the web code).&lt;br/&gt;
(2) Discuss on who should do the stopping, if any one. At worse, the use can call the stop() method. At least we would have something in 2.1...&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="14129486" author="jvz" created="Thu, 11 Sep 2014 01:32:24 +0000"  >&lt;p&gt;I feel like we should have a central thread factory sort of thing that keeps track of anything we spawn so we can kill it off with the LoggerContext.&lt;/p&gt;</comment>
                            <comment id="14129514" author="costat" created="Thu, 11 Sep 2014 01:59:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=garydgregory&quot; class=&quot;user-hover&quot; rel=&quot;garydgregory&quot;&gt;garydgregory&lt;/a&gt; Regarding the patch, StopFlagThread.setStopFlag() needs to take a boolean stopFlag parameter.&lt;/p&gt;</comment>
                            <comment id="14129542" author="remkop@yahoo.com" created="Thu, 11 Sep 2014 02:45:55 +0000"  >&lt;p&gt;It turned out that this issue is caused by the singleton CoarseCachedClock that is created and started automatically even if the user does not configure a clock. That should be fixed; the instance should only be created on demand.&lt;/p&gt;

&lt;p&gt;Also, the documentation for these clocks needs to clarify that they are intended for niche applications and should not be used in web applications. If the docs say &quot;Don&apos;t do this!&quot;, and the user does it anyway, then I think it is fine if this doesn&apos;t work as expected.&lt;/p&gt;

&lt;p&gt;In general, Log4j should never stop its clock as long as the app is running and logging, or the log timestamp will not update anymore. So I don&apos;t think the Clock interface needs a stop() method. Let&apos;s avoid the complexities of managing a life cycle.&lt;/p&gt;</comment>
                            <comment id="14131494" author="garydgregory" created="Fri, 12 Sep 2014 13:01:04 +0000"  >&lt;p&gt;@Costa Theodosiou: The point of the method call is to &quot;raise the flag&quot; not to make it configurable. Would a different method name communicate this intent for you? Can you suggest an alternative?&lt;/p&gt;</comment>
                            <comment id="14131496" author="garydgregory" created="Fri, 12 Sep 2014 13:03:15 +0000"  >&lt;p&gt;Users can always shoot themselves in the foot &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; If we give them a gun in the form of a threaded clock, we should at the very least give programmatic access to unload the gun (stop the thread). My inclination is to commit the clock changes, but not hook up calls to stop the clock, then discuss it some more.&lt;/p&gt;</comment>
                            <comment id="14131504" author="remkop@yahoo.com" created="Fri, 12 Sep 2014 13:12:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=garydgregory&quot; class=&quot;user-hover&quot; rel=&quot;garydgregory&quot;&gt;garydgregory&lt;/a&gt; I don&apos;t like having a stop() method in the first place, because the Log4j clock should never be stopped: if you stop it log timestamps will not increase any more from that point onwards. The thing is, if you have a stop() method you need a start() method. And that opens the box of Pandora... &lt;/p&gt;

&lt;p&gt;There is no reason for the Clock interface to have a stop() method except for the implementation detail of the thread, and I&apos;d like to look at other ways to address this issue first before committing to a stop() method in the Clock interface.&lt;/p&gt;</comment>
                            <comment id="14131508" author="costat" created="Fri, 12 Sep 2014 13:16:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=garydgregory&quot; class=&quot;user-hover&quot; rel=&quot;garydgregory&quot;&gt;garydgregory&lt;/a&gt; If the intent is to set the flag, then setStopFlag() should set the flag to true. It is currently set to false which is also the default value of boolean stopFlag.&lt;/p&gt;</comment>
                            <comment id="14131517" author="remkop@yahoo.com" created="Fri, 12 Sep 2014 13:26:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=costat&quot; class=&quot;user-hover&quot; rel=&quot;costat&quot;&gt;costat&lt;/a&gt; I&apos;m having trouble reproducing the issue. You mentioned that you did not configure any clock and that the CoarseCachedClock singleton is created automatically by the classloader. That does not match what I am seeing. If I call &lt;tt&gt;ClockFactory.getClock().currentTimeMillis()&lt;/tt&gt; without any system properties, no CachedClock or CoarseCachedClock singleton is created (and neither are their associated updater threads).&lt;/p&gt;

&lt;p&gt;I can even do &lt;tt&gt;CoarseCachedClock.class.getName()&lt;/tt&gt; and I get the same result: no CoarseCachedClock singleton and also no associated thread. I only see the clock updater thread being started after explicitly calling &lt;tt&gt;CoarseCachedClock.instance()&lt;/tt&gt; or &lt;tt&gt;CachedClock.instance()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;So I wonder how the thread was created...&lt;/p&gt;

&lt;p&gt;As far as I can see, the clock updater thread can only be started if:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;the application explicitly calls &lt;tt&gt;CoarseCachedClock.instance()&lt;/tt&gt; or &lt;tt&gt;CachedClock.instance()&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;system property &lt;tt&gt;log4j.Clock&lt;/tt&gt; has one of these four values:
	&lt;ul&gt;
		&lt;li&gt;&quot;CachedClock&quot;&lt;/li&gt;
		&lt;li&gt;&quot;CoarseCachedClock&quot;&lt;/li&gt;
		&lt;li&gt;&quot;org.apache.logging.log4j.core.util.CachedClock&quot;&lt;/li&gt;
		&lt;li&gt;&quot;org.apache.logging.log4j.core.util.CoarseCachedClock&quot;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Can you double check that neither of the above is happening in your application?&lt;/p&gt;</comment>
                            <comment id="14131550" author="garydgregory" created="Fri, 12 Sep 2014 13:55:52 +0000"  >&lt;p&gt;v2 of the patch (fixed stop flag set method).&lt;/p&gt;</comment>
                            <comment id="14131551" author="garydgregory" created="Fri, 12 Sep 2014 13:56:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=costat&quot; class=&quot;user-hover&quot; rel=&quot;costat&quot;&gt;costat&lt;/a&gt;: Oops, good catch! Fix in the new patch attached.&lt;/p&gt;</comment>
                            <comment id="14131553" author="garydgregory" created="Fri, 12 Sep 2014 13:59:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=remkop%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;remkop@yahoo.com&quot;&gt;remkop@yahoo.com&lt;/a&gt;: Look out, &apos;cause initialization of a static can happen at other times then when you stated it previously. See &lt;a href=&quot;http://docs.oracle.com/javase/specs/jls/se7/html/jls-12.html#jls-12.4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/specs/jls/se7/html/jls-12.html#jls-12.4.1&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14131582" author="remkop@yahoo.com" created="Fri, 12 Sep 2014 14:09:07 +0000"  >&lt;p&gt;Thanks for the link! I&apos;ll take another look to see if I overlooked something...&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;UPDATE: I read the section on initialization twice, but I could not see any way for the singletons being created (and the threads started) other than a call to (Coarse)CachedClock.instance(). Log4j only calls that method when the log4j.Clock system property has one of the four values described above. So I still don&apos;t understand what causes this issue...&lt;/p&gt;</comment>
                            <comment id="14131604" author="remkop@yahoo.com" created="Fri, 12 Sep 2014 14:32:23 +0000"  >&lt;p&gt;By the way, why use a boolean flag? Isn&apos;t it simpler to just call &lt;tt&gt;updaterThread.interrupt();&lt;/tt&gt; from the clock&apos;s stop() method, and change the run() method to &lt;tt&gt;while (!interrupted()) {...&lt;/tt&gt;}. In general the built-in interrupt() is better than a custom stop flag because it allows the thread to return early from its call to sleep() when interrupted. The biggest advantage in this case is that we don&apos;t need to build infrastructure to maintain the boolean anymore, so no need for the StopFlagThread any more. (The Thread.interrupt() method is not deprecated like the Thread.stop(), suspend() and resume() methods.)&lt;/p&gt;

&lt;p&gt;That said, I still don&apos;t like having a public &lt;tt&gt;Clock.stop() method&lt;/tt&gt;. This unloads the gun for web apps (so they can no longer shoot themselves in the foot even if they try), but also hands out the gun to everyone else so they can shoot themselves (by stopping the clock prematurely)... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="14131685" author="garydgregory" created="Fri, 12 Sep 2014 15:58:16 +0000"  >&lt;p&gt;You can stop a thread cleanly using:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;a boolean flag&lt;/li&gt;
	&lt;li&gt;thread interrupt() and isInterrupted()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I reread &lt;em&gt;Effective Java&lt;/em&gt;, &lt;em&gt;Java Threads&lt;/em&gt;, and &lt;em&gt;Java Concurrency in Practice&lt;/em&gt; in this area.&lt;/p&gt;

&lt;p&gt;Note that the parkNanos API we use in the threaded clocks does not thrown &lt;tt&gt;InterruptedException&lt;/tt&gt; which must mean that it handles interruption requests cleanly.&lt;/p&gt;

&lt;p&gt;The argument against using a boolean flag is that the thread will only check the flag at the top or bottom of its run loop once it comes out of blocking calls.&lt;/p&gt;

&lt;p&gt;I am going to try another patch a la interrupt(), it should be less code.&lt;/p&gt;

&lt;p&gt;For the clocks, flag vs. interrupt is a detail the user should not care about (hopefully).&lt;/p&gt;</comment>
                            <comment id="14131703" author="garydgregory" created="Fri, 12 Sep 2014 16:13:35 +0000"  >&lt;p&gt;The patch &lt;tt&gt;gg-log4j2-clocks-interrupts.patch&lt;/tt&gt; uses Thread.interrupt() to request the clock threads to stop.&lt;/p&gt;</comment>
                            <comment id="14131710" author="garydgregory" created="Fri, 12 Sep 2014 16:19:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=remkop%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;remkop@yahoo.com&quot;&gt;remkop@yahoo.com&lt;/a&gt;: We need something to stop the threads. The clocks own the threads, so we have to ask the clocks, hence the stop methods.&lt;/p&gt;

&lt;p&gt;Alternatives:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Have the threads check some global &quot;is log4j shutting down&quot; flag. Bleh.&lt;/li&gt;
	&lt;li&gt;Use a thread pool (with no size limit) for use by all Log4j threads. Creating a thread should always go through the pool. Then we can shutdown the pool as a whole. This seems like a lot of work and hard to get right since thread shutdown matters I would imagine. Only enforceable by coding convention or with some extra Maven tooling. Yikes.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;What else?&lt;/p&gt;</comment>
                            <comment id="14131716" author="remkop@yahoo.com" created="Fri, 12 Sep 2014 16:27:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=costat&quot; class=&quot;user-hover&quot; rel=&quot;costat&quot;&gt;costat&lt;/a&gt; Can you provide a small web application that reproduces the issue?&lt;/p&gt;</comment>
                            <comment id="14131771" author="remkop@yahoo.com" created="Fri, 12 Sep 2014 17:21:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=garydgregory&quot; class=&quot;user-hover&quot; rel=&quot;garydgregory&quot;&gt;garydgregory&lt;/a&gt; My thinking is/was that the thread should not be started in the first place. Then we don&apos;t need to stop them and there is no use case for a stop() method.&lt;/p&gt;

&lt;p&gt;However I am assuming that this thread is only started in a web app by mistake. If I&apos;m wrong about that, then we don&apos;t have much choice...&lt;/p&gt;

&lt;p&gt;How about having a subinterface StoppableClock extending Clock with the stop() method, and the call site would do an instanceof. Would that be overkill? That would make it less easy to call ClockFactory.getClock().stop() by mistake. And we can document that this interface and its stop() method are for Log4j internal housekeeping purposes.&lt;/p&gt;

&lt;p&gt;About the patch, I like that we have less API surface in the interrupt version. Would you oppose removing AbstractClock as well? (SystemClock can just implement the empty stop() method directly.) About the thread name, do you want the fully qualified class name, e.g. org.apache.logging.log4j.core.util.CoarseCachedClock, in the thread name, or  class.getSimpleName? &lt;/p&gt;

&lt;p&gt;About the call site, I initially thought about calling stop() from LoggerContext.stop(), but that would cause the clock to stop updating when Log4j is reconfigured. It is probably a good idea to only call Clock (StoppableClock?).stop() when the webapp is unloaded.&lt;/p&gt;</comment>
                            <comment id="14131774" author="remkop@yahoo.com" created="Fri, 12 Sep 2014 17:24:12 +0000"  >&lt;p&gt;By the way, can we agree to only do this if we can reproduce the issue and prove that this patch solves the problem?&lt;/p&gt;</comment>
                            <comment id="14131790" author="garydgregory" created="Fri, 12 Sep 2014 17:33:16 +0000"  >&lt;p&gt;I consider the current implementation broken and bad design.&lt;/p&gt;

&lt;p&gt;To quote Brian Goetz et all from &lt;em&gt;Java Concurrency in Practice&lt;/em&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;End-of life cycle issues can complicate the design and implementation of tasks, services, and applications, and this important element of program design is too often ignored. Dealing with failure, shutdown, and cancellation is one of the characteristics that distinguishes a well-behaved application from one that merely works.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Let&apos;s:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Fix the clocks&lt;/li&gt;
	&lt;li&gt;Continue researching when/if/how log4j should automatically stop its clock.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Adding StoppableClock make the design less OO IMO, I am against it.&lt;/p&gt;</comment>
                            <comment id="14131847" author="remkop@yahoo.com" created="Fri, 12 Sep 2014 18:06:29 +0000"  >&lt;p&gt;I don&apos;t think it is a good idea or good design to put a public client method like &lt;tt&gt;currentTimeMillis()&lt;/tt&gt; in the same interface as an internal housekeeping method like &lt;tt&gt;stop()&lt;/tt&gt;. It suggests that client code would be perfectly free to call either method which is obviously not the case. &lt;/p&gt;

&lt;p&gt;There must be a better way to do this.&lt;/p&gt;</comment>
                            <comment id="14131882" author="remkop@yahoo.com" created="Fri, 12 Sep 2014 18:29:18 +0000"  >&lt;p&gt;Perhaps we&apos;ll get better ideas on what the design for this should look like when we know how it will actually be used. We can&apos;t really consider these things separately.&lt;/p&gt;</comment>
                            <comment id="14131924" author="ralph.goers@dslextreme.com" created="Fri, 12 Sep 2014 18:50:54 +0000"  >&lt;p&gt;I am having problems with all of this.  &lt;/p&gt;

&lt;p&gt;First, I would expect CoarseCachedClock to be an instance of CachedClock. It isn&apos;t.  I would expect a CachedClock to have extra methods like stop() that SystemClock doesn&apos;t need.&lt;/p&gt;

&lt;p&gt;If log4j-core is in the Tomcat lib directory then Log4jLogEvent will create and own the Clock instance. The Clock cannot be shutdown until Tomcat is shutdown. The latest patch seems to be stopping the clock when a web app is undeployed. That just won&apos;t work properly.&lt;/p&gt;

&lt;p&gt;If log4j-core is in each web apps WEB-INF/lib directory then each app will have its own Clock instance (and corresponding Thread if it is a CacnedClock), which seems odd but I guess could work fine. In this case you need to stop the Clock threads when each web app is undeployed.&lt;/p&gt;

&lt;p&gt;These two use cases are expected to be &quot;normal&quot; deployment models and must both work correctly. I just don&apos;t see how to reconcile between them.&lt;/p&gt;</comment>
                            <comment id="14131935" author="remkop@yahoo.com" created="Fri, 12 Sep 2014 18:54:51 +0000"  >&lt;p&gt;An alternative would be to remove CachedClock and CoarseCachedClock altogether. That would solve this Jira, it would remove the background threads completely, and it would fix &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-753&quot; title=&quot;CachedClock performs badly when contended by many threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-753&quot;&gt;&lt;del&gt;LOG4J2-753&lt;/del&gt;&lt;/a&gt;, all in one swoop.&lt;/p&gt;

&lt;p&gt;We can put the code for CachedClock as an example implementation in the javadoc for the Clock interface, or keep it in the log4j-perf module, for the small fraction of users who really want to squeeze every microsecond of performance out of their system.&lt;/p&gt;</comment>
                            <comment id="14131939" author="costat" created="Fri, 12 Sep 2014 18:57:02 +0000"  >&lt;p&gt;Attached is a demo project that can cause the PermGen OutOfMemoryError.&lt;/p&gt;

&lt;p&gt;It is a regular Servlet 2.5 + Spring + Hibernate webapp.&lt;/p&gt;

&lt;p&gt;To replicate the issue, reload the webapp several times. Monitor the permgen memory with Java VisualVM. Once the memory leak manifests itself, the Tomcat and the application become unresponsive and permgen error is logged in the server logs.&lt;/p&gt;</comment>
                            <comment id="14131947" author="ralph.goers@dslextreme.com" created="Fri, 12 Sep 2014 19:01:09 +0000"  >&lt;p&gt;Remko, I think what you are proposing makes the most sense.  However, it still would be good to look at Costa&apos;s project.&lt;/p&gt;</comment>
                            <comment id="14132006" author="ralph.goers@dslextreme.com" created="Fri, 12 Sep 2014 19:48:08 +0000"  >&lt;p&gt;I deployed the app to Tomcat 7.  When I do a jstack I don&apos;t see any threads related to the Clock. In fact, after changing the log4j2.xml to specify status=&quot;debug&quot; I am seeing&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;----------&amp;gt; Parent Classloader:^M
org.apache.catalina.loader.StandardClassLoader@25fa1bb6^M
, org.apache.logging.log4j.core.LoggerContext@6b248979] started OK.
2014-09-12 12:44:38,593 DEBUG Using &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; SystemClock &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; timestamps
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;in catalina.out during startup which obviously indicates that the CachedClock thread is not being started.&lt;/p&gt;</comment>
                            <comment id="14132060" author="garydgregory" created="Fri, 12 Sep 2014 20:34:54 +0000"  >&lt;p&gt;I am thinking that the threaded clocks are in advertently started because they are referenced from a static variable which gets initialized when the class is referenced. This is obviously not intentional. Can you try adding a console print statement in the clock constructors? That would let us know if the clocks are started.&lt;/p&gt;</comment>
                            <comment id="14132089" author="ralph.goers@dslextreme.com" created="Fri, 12 Sep 2014 20:53:47 +0000"  >&lt;p&gt;Gary, I don&apos;t really need to modify anything to verify they aren&apos;t being started. I have attached catalina.out and the output from jstack. As you will see, there is no clock updater thread.&lt;/p&gt;</comment>
                            <comment id="14132555" author="costat" created="Sat, 13 Sep 2014 05:31:25 +0000"  >&lt;p&gt;I have attached demorun-tomcat6-with-reload.zip which includes catalina.out which demonstrates the bug. It seems that the thread starts when the user requests that the application is reloaded - &lt;b&gt;not&lt;/b&gt; when it is first deployed.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;CoarseCachedClock &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Clock {
...
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; updater = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;Clock Updater &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;&quot;&lt;/span&gt;) {
        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;*************** Clock Updater &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; STARTED ***************&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;*************** Clock Updater &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; RUNNING ***************&quot;&lt;/span&gt;);
                millis = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis();

                &lt;span class=&quot;code-comment&quot;&gt;// avoid explicit dependency on sun.misc.Util
&lt;/span&gt;                LockSupport.parkNanos(1000 * 1000);
            }
        }
    };

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; CoarseCachedClock() {
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;*************** CoarseCachedClock CREATED ***************&quot;&lt;/span&gt;);
        updater.setDaemon(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        updater.start();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The app is first loaded on line 30 of catalina.out. It is reloaded on line 519. The thread starts soon after this.&lt;/p&gt;</comment>
                            <comment id="14132571" author="remkop@yahoo.com" created="Sat, 13 Sep 2014 06:25:52 +0000"  >&lt;p&gt;Costa, thanks for helping with the investigation.&lt;/p&gt;

&lt;p&gt;I think this is caused by Tomcat trying to prevent memory leaks. (Ironic isn&apos;t it?)&lt;br/&gt;
&lt;a href=&quot;http://wiki.apache.org/tomcat/MemoryLeakProtection#staticClassVariables&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://wiki.apache.org/tomcat/MemoryLeakProtection#staticClassVariables&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;When an app is stopped, Tomcat (even before 6.0.24) nullifies the value of all static class variables of classes loaded by the WebAppClassLoader. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So Tomcat, bless its little white cotton socks, causes the very problem it is trying to prevent: referencing the static fields in CachedClock and CoarseCachedClock will initialize these classes, which starts the background threads. Once these threads are started, the web app cannot be unloaded anymore, and voila, we have a memory leak.&lt;/p&gt;

&lt;p&gt;I&apos;m sure we are not the first to have this problem because Tomcat provides a workaround. They suggest to configure a &lt;a href=&quot;http://tomcat.apache.org/tomcat-6.0-doc/config/listeners.html#JRE_Memory_Leak_Prevention_Listener_-_org.apache.catalina.core.JreMemoryLeakPreventionListener&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JRE Memory Leak Prevention Listener&lt;/a&gt;. This supports a &lt;tt&gt;classesToInitialize&lt;/tt&gt; attribute where we can specify the classes that should be loaded by Tomcat&apos;s common class loader instead of the webapp&apos;s context class loader. &lt;/p&gt;

&lt;p&gt;I tried this, but unfortunately this initialization takes place at Tomcat startup, and with the log4j-core jar inside the demo.war file and not in Tomcat&apos;s lib folder I got a  JreMemoryLeakPreventionListener ClassNotFoundException &quot;Failed to load class org.apache.logging.log4j.core.util.CachedClock during Tomcat start to prevent possible memory leaks&quot;. So the workaround does not work for us here.&lt;/p&gt;

&lt;p&gt;Potential solutions:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Modify ClockFactory so that the CachedClock and CoarseCachedClock classes are not loaded unless the user explicitly requests these clocks, using reflection in ClockFactory.&lt;/li&gt;
	&lt;li&gt;Remove CachedClock and CoarseCachedClock from log4j-core altogether.&lt;/li&gt;
	&lt;li&gt;A stop() mechanism will not help because there is nobody around to call it (the web app has already been stopped before these threads are started by Tomcat&apos;s cleanup)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Although I suggested it, I&apos;m still a bit on the fence about removing these classes. Remember that &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-744?focusedCommentId=14077425&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14077425&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;benchmarks&lt;/a&gt; showed that System.currentTimeMillis() can take 3+ microseconds on Linux, vs 14 nanoseconds on Windows: a 220x&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/warning.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; difference... &lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="14132736" author="garydgregory" created="Sat, 13 Sep 2014 13:56:08 +0000"  >&lt;p&gt;It seems to be we can solve this in several ways:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;by changing the singleton final static instance and turning it into non-final lazy-initialized static. It can be initialized in the instance() method, which then should be synchronized. That means that when Tomcat scans all the classes and statics, the static singleton slot will be null and nothing happens.&lt;br/&gt;
or:&lt;/li&gt;
	&lt;li&gt;not having singletons for clocks and let the clock factory cache the clock it creates. Then you shutdown the factory when log4j shutsdown.&lt;/li&gt;
	&lt;li&gt;other?&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="14132795" author="ralph.goers@dslextreme.com" created="Sat, 13 Sep 2014 15:38:29 +0000"  >&lt;p&gt;I think the Clock instance needs to be stored in the LoggerContext and shutdown with it. I only see two places that it is used. &lt;br/&gt;
1. AsyncLogger - the constructor takes the LoggerContext as an argument so could easily initialize its Clock from that.&lt;br/&gt;
2. Log4jLogEvent - There is a default constructor that uses the static clock but nothing uses that constructor. The other constructors that don&apos;t take a timestamp could require the clock or LoggerContext be passed.&lt;/p&gt;</comment>
                            <comment id="14132934" author="garydgregory" created="Sat, 13 Sep 2014 20:42:35 +0000"  >&lt;p&gt;It also now feels that &lt;tt&gt;ClockFactory&lt;/tt&gt; class is misnamed, &lt;tt&gt;ClockManager&lt;/tt&gt; seems more accurate, especially since the API is &lt;tt&gt;getClock()&lt;/tt&gt; as opposed to &lt;tt&gt;createClock()&lt;/tt&gt;. Thoughts on that?&lt;/p&gt;</comment>
                            <comment id="14133025" author="ralph.goers@dslextreme.com" created="Sat, 13 Sep 2014 23:31:54 +0000"  >&lt;p&gt;I think you worry too much about names &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  I don&apos;t think it matters much one way or the other, and is nowhere near as important as making it work correctly.&lt;/p&gt;</comment>
                            <comment id="14133036" author="remkop@yahoo.com" created="Sun, 14 Sep 2014 00:20:44 +0000"  >&lt;p&gt;Gary, I named the class ~Factory to convey the intention that it does not manage clock instances, and client code is responsible for storing the returned Clock object itself. I don&apos;t mind changing the factory method to &lt;tt&gt;createClock()&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14133039" author="remkop@yahoo.com" created="Sun, 14 Sep 2014 00:41:22 +0000"  >&lt;p&gt;Ralph, since &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-628&quot; title=&quot;Cannot set log4j.Clock with Async appender&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-628&quot;&gt;&lt;del&gt;LOG4J2-628&lt;/del&gt;&lt;/a&gt; the Log4JLogEvent Clock is actually used for all (non-async logger) event timestamps. Please see the &lt;a href=&quot;http://logging.apache.org/log4j/2.x/log4j-core/xref/org/apache/logging/log4j/core/impl/Log4jLogEvent.html#145&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;constructor&lt;/a&gt; on line 145-155.&lt;/p&gt;

&lt;p&gt;I don&apos;t oppose your solution, but there is something missing:&lt;br/&gt;
The Coarse/CachedClock classes are loaded because of the way ClockFactory is coded. This has an undesired side effect that Tomcat ends up creating the background threads for &lt;b&gt;both&lt;/b&gt; CoarseCachedClock and CacheClock after the web app is stopped. This happens &lt;b&gt;even&lt;/b&gt; if Log4J uses SystemClock to create timestamps.&lt;/p&gt;

&lt;p&gt;So just managing a central Log4j clock instance in LoggerContext is not enough. I propose we modify ClockFactory such that the class loader no longer loads Coarse/CachedClock by accident. That would solve this Jira.&lt;/p&gt;

&lt;p&gt;That leaves the possibility that the user &lt;em&gt;intentionally&lt;/em&gt; configures CachedClock in a web application (which would also cause a memory leak). Ralph&apos;s proposal to make Clock part of the LoggerContext life cycle would address that concern.&lt;/p&gt;

&lt;p&gt;I don&apos;t oppose that, but that will be significant work. We don&apos;t have a user requesting this feature, so before we spend a lot of time on it I just want to point out an alternative:&lt;br/&gt;
What about simply documenting on the site that CachedClock should not be used by web applications? There is only one brief &lt;a href=&quot;http://logging.apache.org/log4j/2.x/manual/async.html#SysPropsAllAsync&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;mention here&lt;/a&gt; that CachedClock exists. CoarseCachedClock is never mentioned on the site. So I doubt that this would inconvenience any users.&lt;/p&gt;</comment>
                            <comment id="14133041" author="ralph.goers@dslextreme.com" created="Sun, 14 Sep 2014 00:50:22 +0000"  >&lt;p&gt;I admit I don&apos;t completely understand why Tomcat is finding those two classes, but my understanding is the problem is the static variables in those two classes that are automatically initialized when the class is referenced.  I am suggesting that those statics be removed as they are not necessary. The clock instance should be stored in the LoggerContext only.&lt;/p&gt;</comment>
                            <comment id="14133042" author="remkop@yahoo.com" created="Sun, 14 Sep 2014 00:56:59 +0000"  >&lt;p&gt;Tomcat loads those two classes because ClockFactory compares the user specified string with Coarse/CachedClock.class.getName(). If we change that, these classes are never loaded and their static variables do not become a problem.&lt;/p&gt;</comment>
                            <comment id="14133045" author="ralph.goers@dslextreme.com" created="Sun, 14 Sep 2014 01:11:18 +0000"  >&lt;p&gt;OK. But if we remove the static variables in those two classes does the problem also not go away?&lt;/p&gt;</comment>
                            <comment id="14133051" author="garydgregory" created="Sun, 14 Sep 2014 01:59:49 +0000"  >&lt;p&gt;It seems clear that no final statics = no problems. If the statics are non-final and lazy-initialized, no problem either.&lt;/p&gt;</comment>
                            <comment id="14133068" author="remkop@yahoo.com" created="Sun, 14 Sep 2014 03:48:11 +0000"  >&lt;p&gt;Yes, you are both correct.&lt;/p&gt;

&lt;p&gt;Gary&apos;s suggestion to lazily initialize the static variables is also sufficient to resolve this Jira (unintentionally started threads causing mem leaks).&lt;/p&gt;

&lt;p&gt;Removing the static variables and managing a single Clock instance centrally in LoggerContext may be the right thing to do because (in addition to fixing this Jira) it would make it possible for web apps to use CachedClock. The trade-off is that it would be significantly more work. So is that worth it?&lt;/p&gt;</comment>
                            <comment id="14133074" author="garydgregory" created="Sun, 14 Sep 2014 04:19:58 +0000"  >&lt;p&gt;This might be a silly comment but why is there not a clock that saves when it is started with &lt;tt&gt;System.currentTimeMillis()&lt;/tt&gt; and &lt;tt&gt;System.nanoTime()&lt;/tt&gt;. When &lt;tt&gt;Clock.currentTimeMillis()&lt;/tt&gt; is called, it calls &lt;tt&gt;System.nanoTime()&lt;/tt&gt; again and adds the difference to the original  &lt;tt&gt;System.nanoTime()&lt;/tt&gt; to &lt;tt&gt;System.currentTimeMillis()&lt;/tt&gt;?&lt;/p&gt;

&lt;p&gt;Is calling &lt;tt&gt;System.nanoTime()&lt;/tt&gt; as expensive as &lt;tt&gt;System.currentTimeMillis()&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="14133078" author="garydgregory" created="Sun, 14 Sep 2014 04:46:26 +0000"  >&lt;p&gt;To answer my own question it looks like &lt;tt&gt;nanoTime&lt;/tt&gt; is &lt;em&gt;more&lt;/em&gt; expensive than &lt;tt&gt;currentTimeMillis&lt;/tt&gt;. Am I reading this right?&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# Run complete. Total time: 00:01:38

Benchmark                                               Mode   Samples         Mean   Mean error    Units
o.a.l.l.p.j.ClocksBenchmark.baseline                  sample     60088       13.435        0.952    ns/op
o.a.l.l.p.j.ClocksBenchmark.cachedClock               sample     83142       29.188        1.191    ns/op
o.a.l.l.p.j.ClocksBenchmark.coarseCachedClock         sample     46747       13.653        1.166    ns/op
o.a.l.l.p.j.ClocksBenchmark.fixedClock                sample     92588       16.373        1.043    ns/op
o.a.l.l.p.j.ClocksBenchmark.fixedFinalClock           sample     93548       14.057        0.803    ns/op
o.a.l.l.p.j.ClocksBenchmark.systemClock               sample     70663       29.297        2.336    ns/op
o.a.l.l.p.j.ClocksBenchmark.systemCurrentTimeMillis   sample     78074       25.457        1.127    ns/op
o.a.l.l.p.j.ClocksBenchmark.systemNanoTime            sample     88921       35.775        1.519    ns/op
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I added &lt;tt&gt;systemNanoTime&lt;/tt&gt; locally and did not commit.&lt;/p&gt;

&lt;p&gt;FWIW: Updating the perf framework to the current version (1.1) does not compile.&lt;/p&gt;</comment>
                            <comment id="14133101" author="remkop@yahoo.com" created="Sun, 14 Sep 2014 06:07:32 +0000"  >&lt;p&gt;It looks like clock latency and granularity varies wildly across hardware and OS-es.  I&apos;ve seen System.nanotime() take 350ns on Solaris (haven&apos;t checked Linux). And System.currentTimeMillis() we saw take 3100ns on RedHat Linux. It&apos;s a jungle out there! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://blogs.oracle.com/dholmes/entry/inside_the_hotspot_vm_clocks&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This article&lt;/a&gt; is a bit dated but gives an overview of the issues. &lt;/p&gt;</comment>
                            <comment id="14133114" author="jvz" created="Sun, 14 Sep 2014 07:00:57 +0000"  >&lt;p&gt;I made a change to lazily initialize the two threaded Clock implementations.&lt;/p&gt;</comment>
                            <comment id="14133196" author="remkop@yahoo.com" created="Sun, 14 Sep 2014 12:56:19 +0000"  >&lt;p&gt;Thanks Matt!&lt;br/&gt;
I confirmed that I can no longer reproduce the issue anymore after your changes.&lt;/p&gt;

&lt;p&gt;I propose that we mark this issue as resolved so we document that this change it is part of the 2.1 release, and create a new Jira with a follow-up task to manage a single Clock instance centrally in LoggerContext as a better way to manage clocks that would also make it possible for web apps to use CachedClock.&lt;/p&gt;

&lt;p&gt;Before resolving this issue I will make some documentation changes on the site for now to warn users not to use CachedClock in web applications.&lt;/p&gt;</comment>
                            <comment id="14133230" author="remkop@yahoo.com" created="Sun, 14 Sep 2014 14:08:00 +0000"  >&lt;p&gt;This is now fixed in master.&lt;br/&gt;
Please verify and close.&lt;/p&gt;</comment>
                            <comment id="14133241" author="remkop@yahoo.com" created="Sun, 14 Sep 2014 14:43:38 +0000"  >&lt;p&gt;I&apos;ve created &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-826&quot; title=&quot;Manage a single Clock and NanoClock instance in Configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-826&quot;&gt;LOG4J2-826&lt;/a&gt; as a follow-up task based on the discussion above. Please feel free to modify the title/description if I made a mistake or missed anything.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                                                <inwardlinks description="is superceded by">
                                        <issuelink>
            <issuekey id="12741336">LOG4J2-826</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12668430" name="demo.zip" size="12090" author="costat" created="Fri, 12 Sep 2014 18:57:02 +0000"/>
                            <attachment id="12668547" name="demorun-tomcat6-with-reload.zip" size="33821" author="costat" created="Sat, 13 Sep 2014 05:31:25 +0000"/>
                            <attachment id="12668450" name="demorun.zip" size="15792" author="rgoers" created="Fri, 12 Sep 2014 20:53:47 +0000"/>
                            <attachment id="12668376" name="gg-log4j2-clocks-interrupts.patch" size="19424" author="ggregory" created="Fri, 12 Sep 2014 16:13:35 +0000"/>
                            <attachment id="12668337" name="gg-log4j2-clocks-v2.patch" size="18218" author="ggregory" created="Fri, 12 Sep 2014 13:55:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 10 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1zv7j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>