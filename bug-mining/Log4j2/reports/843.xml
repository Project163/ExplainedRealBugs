<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:36:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1434] StringBuffer in ThreadLocal can cause excessive memory usage after large log messages</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1434</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;In an effort to speed up logging ThreadLocals have been introduced see &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1125&quot; title=&quot;Reuse StringBuilder to improve performance for PatternLayout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1125&quot;&gt;&lt;del&gt;LOG4J2-1125&lt;/del&gt;&lt;/a&gt; however this does causes memory issues.&lt;/p&gt;

&lt;p&gt;The problem of the ThreadLocal occurs when threads are re-used which is an absolutely valid way of using java. For example an executor service can re-use threads as well as Jetty.&lt;/p&gt;

&lt;p&gt;Below I demonstrate a contrived example of the memory leak:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; stringSize = 1024*1024*10; &lt;span class=&quot;code-comment&quot;&gt;//~10MB maybe 20MB &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; UTF-16
&lt;/span&gt;        StringBuilder sb = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder(stringSize); 
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; stringSize; i++) {
            sb.append(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt; + i % 5);
        }
        
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; largeString = sb.toString();
        
        sb = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;//Let it be GC&apos;ed
&lt;/span&gt;        ExecutorService es = Executors.newFixedThreadPool(100);
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CountDownLatch countDownLatch = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CountDownLatch(100);
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 100; i++) {
            es.execute(()-&amp;gt; {
                &lt;span class=&quot;code-comment&quot;&gt;//Log the big string to demonstrate the issue.
&lt;/span&gt;                log.fatal(largeString);
                
                &lt;span class=&quot;code-comment&quot;&gt;//Ensure we use all 100 of our threads by not releasing &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; thread yet.
&lt;/span&gt;                countDownLatch.countDown();
            }); 
            
            &lt;span class=&quot;code-comment&quot;&gt;//We sleep &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 2s so we more easily watch memory growth
&lt;/span&gt;            &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(2000);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I recommend that log4j2 immediately remove the ThreadLocal as a small gain in performance does not outweigh the problems associated with memory leaks. Finally other options for caching the StringBuilder with a ThreadLocal could be considered for example we might re-use StringBuilders that are no larger than 3k while removing the ones which are larger than 3k.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12979667">LOG4J2-1434</key>
            <summary>StringBuffer in ThreadLocal can cause excessive memory usage after large log messages</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="lukebutters7">Luke Butters</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 Jun 2016 04:36:47 +0000</created>
                <updated>Sun, 18 Sep 2016 10:38:55 +0000</updated>
                            <resolved>Sun, 19 Jun 2016 00:04:46 +0000</resolved>
                                    <version>2.6.1</version>
                                    <fixVersion>2.6.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15333086" author="lukebutters7" created="Thu, 16 Jun 2016 04:52:56 +0000"  >&lt;p&gt;Looking at the diff here &lt;a href=&quot;https://github.com/apache/logging-log4j2/commit/8025bb18ce4444b76822a7965776bb075bd52aa9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/commit/8025bb18ce4444b76822a7965776bb075bd52aa9&lt;/a&gt;&lt;br/&gt;
perhaps just after line 206 you could check the length of the string and it is greater than 3k (perhaps a different value?) remove the StringBuffer from the thread local.&lt;/p&gt;</comment>
                            <comment id="15333092" author="garydgregory" created="Thu, 16 Jun 2016 05:00:47 +0000"  >&lt;p&gt;You can turn off &lt;tt&gt;ThreadLocal&lt;/tt&gt; usage with the system property &lt;tt&gt;log4j2.enable.threadlocals=false&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15333259" author="remkop@yahoo.com" created="Thu, 16 Jun 2016 07:11:47 +0000"  >&lt;p&gt;I did a lot of investigation in ThreadLocals and it turns out that ThreadLocals only result in memory leaks if non-JDK classes are held in the ThreadLocal map. &lt;/p&gt;

&lt;p&gt;Look at the Tomcat message:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;SEVERE: The web application [App] created a ThreadLocal with key of type [org.apache.logging.log4j.core.layout.PatternLayout$1] (value [org.apache.logging.log4j.core.layout.PatternLayout$1@14391aaf]) and a value of type [java.lang.StringBuilder] (value [2015-09-30 14:22:27.832 [localhost-startStop-1] ERROR AppLogger - Error log. ]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to try and avoid a probable memory leak.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Notice that the &lt;em&gt;value&lt;/em&gt; is a StringBuilder, which is a JDK class and cannot cause a memory leak. However, the &lt;em&gt;key&lt;/em&gt; in the threadlocal map is a &lt;tt&gt;org.apache.logging.log4j.core.layout.PatternLayout$1&lt;/tt&gt; inner class. Looking at the &lt;a href=&quot;https://github.com/apache/logging-log4j2/commit/8025bb18ce4444b76822a7965776bb075bd52aa9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;diff&lt;/a&gt; you linked to, at that time PatternLayout code looked like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; ThreadLocal&amp;lt;StringBuilder&amp;gt; strBuilder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThreadLocal&amp;lt;StringBuilder&amp;gt;() { &lt;span class=&quot;code-comment&quot;&gt;// anonymous &lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;that subclasses ThreadLocal
&lt;/span&gt;     @Override
     &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; StringBuilder initialValue() {
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder(1024);
     }        
};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The above code creates an anonymous subclass of ThreadLocal, and this class is loaded by the web application&apos;s class loader. This caused the memory leak because the class was held in the threadlocal map and could not be garbage collected. So the above idiom of providing an initial value in the declaration was what caused the memory leak.&lt;/p&gt;

&lt;p&gt;We have since then changed the way we use ThreadLocals. Log4j code now adheres to the idiom below:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// just declare a plain ThreadLocal, don&apos;t create anonymous subclass to populate initial value
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ThreadLocal&amp;lt;StringBuilder&amp;gt; threadLocal = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThreadLocal&amp;lt;&amp;gt;();

&lt;span class=&quot;code-comment&quot;&gt;// all code interested in getting the cached StringBuilder needs to go through &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; accessor method
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; StringBuilder getStringBuilder() {
        StringBuilder result = threadLocal.get();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (result == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder(DEFAULT_STRING_BUILDER_SIZE);
            threadLocal.set(result);
        }
        result.setLength(0);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; result;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This avoids the creation of the anonymous subclass and therefore the key in the threadlocal map is a plain JDK ThreadLocal, and the value is a plain JDK StringBuilder. This will not cause memory leaks. So I disagree with your statement that this issue was &quot;ignored in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1142&quot; title=&quot;ThreadLocals in Layout implementations may cause memory leaks in web containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1142&quot;&gt;&lt;del&gt;LOG4J2-1142&lt;/del&gt;&lt;/a&gt;&quot;. It was addressed and resolved.&lt;/p&gt;

&lt;p&gt;For other places where we had to store non-JDK classes in ThreadLocals,&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;the use of ThreadLocals is avoided if Log4j detects that it is used in a web container: when the &lt;tt&gt;javax.servlet.Servlet&lt;/tt&gt; class is in the classpath, or when system property &lt;tt&gt;log4j2.is.webapp&lt;/tt&gt; is set to &quot;true&quot;&lt;/li&gt;
	&lt;li&gt;users can manually disable Log4j&apos;s use of non-JDK classes in ThreadLocals by setting system property &lt;tt&gt;log4j2.enable.threadlocals&lt;/tt&gt; to &quot;false&quot;.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15333262" author="remkop@yahoo.com" created="Thu, 16 Jun 2016 07:13:06 +0000"  >&lt;p&gt;That said, if you can show a Tomcat memory leak warning with Log4j-2.6.1 we will address it.&lt;/p&gt;</comment>
                            <comment id="15333269" author="remkop@yahoo.com" created="Thu, 16 Jun 2016 07:19:34 +0000"  >&lt;p&gt;Marking this issue as &quot;Not a problem&quot;. Please feel free to re-open if you believe my assessment is incorrect. As I said previously, if there are still Tomcat memory leak issues we will address them.&lt;/p&gt;</comment>
                            <comment id="15334828" author="lukebutters7" created="Thu, 16 Jun 2016 22:27:42 +0000"  >&lt;p&gt;&lt;del&gt;Could you elaborate on why the issue is only one if it occurs under tomcat? If i don&apos;t use tomcat should I switch to a different logging framework?&lt;/del&gt; No need Ralph points out I have created confusion by referencing tickets which only related to tomcat. To simplify replication I am not running a web server to demonstrate the issue.&lt;/p&gt;

&lt;p&gt;I think we are talking about different issues. Perhaps the term memory leak is incorrect and a better wording would have been &quot;StringBuffer in ThreadLocal causes excessive  memory usage after large log messages&quot;. I think in your case you actually had a leaking where in this case the ThreadLocal was created correctly however the object held by the thread local can only grow.&lt;br/&gt;
The example code demonstrates this. As the threads are kept around (e.g. from being re-used) the large StringBuffer is never cleaned up. So we can and end up in the case where 100 threads each have a StringBuffer which is large enough to hold 10M chars. This results in the log framework taking up a significant portion of memory.&lt;/p&gt;

&lt;p&gt;I think it is worthwhile trying out the above code, if the logging framework has no issues then you will not run out of memory (I only gave my JVM 640M but we can increase the number of threads to make the problem occur) . Switching the log line to something like &lt;tt&gt;largeString.length()&lt;/tt&gt; resulted in no memory issues, confirming the memory issue is in the log framework.&lt;/p&gt;

&lt;p&gt;Having a look at your code base it seems you re-use getStringBuffer() which is good, however I suspect it will make fixing this issue even harder as the memory issue will be all over your application. Unless you know of a single spot where the size of the StringBuffer can be checked and the StringBuffer be shrunk or removed if it is too large.&lt;/p&gt;
</comment>
                            <comment id="15334831" author="lukebutters7" created="Thu, 16 Jun 2016 22:29:19 +0000"  >&lt;p&gt;oh cool, I will try it out!&lt;/p&gt;</comment>
                            <comment id="15334864" author="ralph.goers@dslextreme.com" created="Thu, 16 Jun 2016 22:44:17 +0000"  >&lt;p&gt;I think Remko may have misread this.  Typically, the &quot;memory leak&quot; issue is related to Tomcat undeploying and redeploying the web app, which is what &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1142&quot; title=&quot;ThreadLocals in Layout implementations may cause memory leaks in web containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1142&quot;&gt;&lt;del&gt;LOG4J2-1142&lt;/del&gt;&lt;/a&gt; and the StackOverflow link  you referenced were related to. I don&apos;t see where this issue is mentioned in 1142. &lt;/p&gt;</comment>
                            <comment id="15334876" author="lukebutters7" created="Thu, 16 Jun 2016 22:52:03 +0000"  >&lt;p&gt;I set &lt;tt&gt;-Dlog4j2.enable.threadlocals=false&lt;/tt&gt; but it did not seem to work looking at the log4j2 code I don&apos;t see how this would have worked.&lt;/p&gt;</comment>
                            <comment id="15334883" author="lukebutters7" created="Thu, 16 Jun 2016 22:53:18 +0000"  >&lt;p&gt;I will remove the relation to that issue, I guess it is only related to &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1125&quot; title=&quot;Reuse StringBuilder to improve performance for PatternLayout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1125&quot;&gt;&lt;del&gt;LOG4J2-1125&lt;/del&gt;&lt;/a&gt; as that ticket introduced the ThreadLocal for the speed up. Please suggest any other changes which could be made to the ticket to make it more concise.&lt;/p&gt;</comment>
                            <comment id="15334951" author="remkop@yahoo.com" created="Thu, 16 Jun 2016 23:25:27 +0000"  >&lt;p&gt;I don&apos;t think I misread. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I don&apos;t really see how the original question could have been interpreted differently. But no problem. &lt;/p&gt;

&lt;p&gt;Thanks for the clarification, I see what you mean and you have a good point. &lt;br/&gt;
The way I would address this is in the above &lt;tt&gt;getStringBuilder()&lt;/tt&gt; method, check the size of the StringBuilder before setting its length to zero, and trimming it to some MAX_SIZE if it has grown too much.  &lt;/p&gt;

&lt;p&gt;This allows us to do the check in a single place, with the drawback that the memory will not be freed in the case that a thread logs a very large message and then never logs anything again. I think that&apos;s a reasonable trade off. &lt;/p&gt;</comment>
                            <comment id="15335019" author="remkop@yahoo.com" created="Fri, 17 Jun 2016 00:00:17 +0000"  >&lt;p&gt;You are right. Some background:&lt;/p&gt;

&lt;p&gt;Log4j only checks the &lt;tt&gt;log4j2.enable.threadlocals&lt;/tt&gt; system property when deciding whether to store a non-JDK class in a ThreadLocal or use some less efficient mechanism that does not use ThreadLocals. &lt;/p&gt;

&lt;p&gt;The intention of this system property is to prevent memory leaks in web containers where non-JDK classes in ThreadLocals can prevent application classes from being garbage collected even if the web application is unloaded.&lt;/p&gt;

&lt;p&gt;StringBuilder is a JDK class so it will not cause this problem. To allow web applications to benefit from the speedup we don&apos;t check the &lt;tt&gt;log4j2.enable.threadlocals&lt;/tt&gt; system property here.&lt;/p&gt;</comment>
                            <comment id="15335479" author="lukebutters7" created="Fri, 17 Jun 2016 06:03:35 +0000"  >&lt;p&gt;That would be better than what we have, although not the most ideal solution.&lt;/p&gt;

&lt;p&gt;Thinking about the code written we know that the StringBuilder must never escape log4j2, so what we could do is the reverse of how the StringBuilder is provided. Using java 8 this becomes:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;AbstractStringLayout {
 
  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &amp;lt;T&amp;gt; T doWithStringBuilder(Function&amp;lt;StringBuilder, T&amp;gt; formater) {
     StringBuilder sb = getStringBuilderFromThreadLocal();
     &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; formater.apply(sb);
     } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
       &lt;span class=&quot;code-comment&quot;&gt;//No more work will be done with the StringBuilder
&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(sb.capacity() &amp;gt; 1024) {
          removeStringBuilderFromThreadLocal();
       } 
     }
  }

}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now our sub class might look like: (from &lt;a href=&quot;https://github.com/apache/logging-log4j2/blob/73b4bcffeccc22fd148b4ccc9c0cba1516dcb519/log4j-core/src/main/java/org/apache/logging/log4j/core/layout/GelfLayout.java#L144&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/blob/73b4bcffeccc22fd148b4ccc9c0cba1516dcb519/log4j-core/src/main/java/org/apache/logging/log4j/core/layout/GelfLayout.java#L144&lt;/a&gt; );&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] toByteArray(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; LogEvent event) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; doWithStringBuilder((sb) -&amp;gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StringBuilder text = toText(event, sb, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes = getBytes(text.toString());
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; compressionType != CompressionType.OFF &amp;amp;&amp;amp; bytes.length &amp;gt; compressionThreshold ? compress(bytes) : bytes;
        });
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If we need backward support (ie pre java 8) we could define our own interface rather than uses the Function provided by java 8.&lt;/p&gt;

&lt;p&gt;On my machine with a relatively simple test of using StringBuilders my proposed method results in code that is way faster than re-creating the StringBuilder and is close to but is not as fast as the Straight ThreadLocal perhaps because if the extra capacity check. Here are my speed results:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CurrentThreadLocal: 122ms, 100%
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder each time: 273ms, 224%
Functional: 153ms, 125%
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In my test I get or create the StringBuilder 1million times.&lt;/p&gt;

&lt;p&gt;The Functional way is still not as fast however it avoids memory issues.&lt;/p&gt;</comment>
                            <comment id="15335500" author="lukebutters7" created="Fri, 17 Jun 2016 06:17:06 +0000"  >&lt;p&gt;Ah another way which seems to run at about the same speed as the current implementation.&lt;br/&gt;
First change the &lt;tt&gt;getStringBuilderFromThreadLocal&lt;/tt&gt; to be private then create a class:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ThreadLocalStringBuilderProvider &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Closeable {
        
        @Getter &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; StringBuilder sb;
        
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; ThreadLocalStringBuilderProvider() {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sb = getStringBuilderFromThreadLocal();
        }
        
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; StringBuilder getStringBuilder() {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sb;
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(sb.capacity() &amp;gt; 1024) {
                removeStringBuilderFromThreadLocal();
             }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Java&apos;s try-with-resources block can be used to ensure we call close. One could argue this is better anyway as it promotes restricting the scope of the StringBuffer.&lt;/p&gt;</comment>
                            <comment id="15335798" author="remkop@yahoo.com" created="Fri, 17 Jun 2016 09:45:32 +0000"  >&lt;p&gt;Great that you are benchmarking to get an idea of the relative performance of various solutions. You&apos;d be surprised at how few people actually measure this. FYI, please take a look at the log4j-perf module. We have standardized on &lt;a href=&quot;http://openjdk.java.net/projects/code-tools/jmh/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JMH&lt;/a&gt; as our benchmarking tool to help us avoid some common &lt;a href=&quot;http://www.oracle.com/technetwork/articles/java/architect-benchmarking-2266277.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pitfalls&lt;/a&gt; associated with java micro-benchmarks. I found this a real eye-opener and very easy to use so I thought you might be interested.&lt;/p&gt;

&lt;p&gt;About the ThreadLocalStringBuilderProvider idea, can you show how this would be used in Layout code? I am specifically interested in whether this would be garbage-free.&lt;/p&gt;</comment>
                            <comment id="15337167" author="lukebutters7" created="Fri, 17 Jun 2016 22:56:07 +0000"  >&lt;p&gt;Yes I have experienced problems in micro bench marking before, so I think it will be useful. Thank you.&lt;/p&gt;

&lt;p&gt;So I imagine code would look like: (From &lt;a href=&quot;https://github.com/apache/logging-log4j2/blob/73b4bcffeccc22fd148b4ccc9c0cba1516dcb519/log4j-core/src/main/java/org/apache/logging/log4j/core/layout/GelfLayout.java#L144&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/blob/73b4bcffeccc22fd148b4ccc9c0cba1516dcb519/log4j-core/src/main/java/org/apache/logging/log4j/core/layout/GelfLayout.java#L144&lt;/a&gt; )&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] toByteArray(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; LogEvent event) {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;(ThreadLocalStringBuilderProvider stringBuilderProvider = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThreaLocalStringBuilderProvider()) {
        StringBuilder sb = stringBuilderProvider.getStringBuilder();
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StringBuilder text = toText(event, sb, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes = getBytes(text.toString());
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; compressionType != CompressionType.OFF &amp;amp;&amp;amp; bytes.length &amp;gt; compressionThreshold ? compress(bytes) : bytes;
    }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Assuming the JVM does nothing special it is not garbage free, as I create a new object. To get Java to show a warning when a resource is not closed, you have to create the resource with the keyword &lt;tt&gt;new&lt;/tt&gt;. Perhaps the JVM can however not create a new &lt;tt&gt;ThreadLocalStringBuilderProvider&lt;/tt&gt; and instead inline everything. &lt;/p&gt;</comment>
                            <comment id="15337187" author="lukebutters7" created="Fri, 17 Jun 2016 23:08:34 +0000"  >&lt;p&gt;Note that my assumption is we want to remember to call &lt;tt&gt;close()&lt;/tt&gt; But I guess we don&apos;t already do that and is not the worst if we forget to call close() (at least in the areas I don&apos;t care about &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;). If not having garbage is more important we could instead change &lt;tt&gt;ThreaLocalStringBuilderProvider&lt;/tt&gt; to have a field which is a &lt;tt&gt;StringBuilder&lt;/tt&gt; not supplied by a &lt;tt&gt;ThreadLocal&lt;/tt&gt; and place &lt;tt&gt;ThreaLocalStringBuilderProvider&lt;/tt&gt; in the thread local. So we have:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ThreadLocal&amp;lt;ThreaLocalStringBuilderProvider&amp;gt; threadLocal = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThreadLocal&amp;lt;&amp;gt;();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;our client code now looks like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] toByteArray(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; LogEvent event) {
    &lt;span class=&quot;code-comment&quot;&gt;//We get the string builder provider from a &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; method which gets it from the ThreadLocal.
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;(ThreadLocalStringBuilderProvider stringBuilderProvider = SomeClass.getThreadLocalStringBuilderProvider()) {
        StringBuilder sb = stringBuilderProvider.getStringBuilder();
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StringBuilder text = toText(event, sb, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes = getBytes(text.toString());
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; compressionType != CompressionType.OFF &amp;amp;&amp;amp; bytes.length &amp;gt; compressionThreshold ? compress(bytes) : bytes;
    }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For small enough log messages (because we have to create a new StringBuilder if the log message is large) we would not be creating new objects, so nothing would need to be collected.&lt;/p&gt;</comment>
                            <comment id="15337380" author="remkop@yahoo.com" created="Sat, 18 Jun 2016 01:02:29 +0000"  >&lt;p&gt;Where possible I prefer not to store non-JDK classes in ThreadLocals, but I think the try with resources is a good idea.&lt;/p&gt;

&lt;p&gt;I really want to avoid creating temporary objects during steady state logging. I wonder if this will work:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// AbstractStringLayout
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ThreadLocal&amp;lt;StringBuilder&amp;gt; threadLocal = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThreadLocal&amp;lt;&amp;gt;();

&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Closeable stringBuilderCleaner = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Closeable() {
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() {
        StringBuilder sb = threadLocal.get();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sb.length() &amp;gt; MAX_LENGTH) {
            sb.setLength(MAX_LENGTH);
            sb.trimToSize();
        }
    }
}

    &lt;span class=&quot;code-comment&quot;&gt;// all code interested in getting the cached StringBuilder needs to go through &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; accessor method
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; StringBuilder getStringBuilder() {
        &lt;span class=&quot;code-comment&quot;&gt;// as current
&lt;/span&gt;        ....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Then in Layout code we do&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// some layout
&lt;/span&gt;@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] toByteArray(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; LogEvent event) {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.stringBuilderCleaner) {
        StringBuilder sb = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getStringBuilder();
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StringBuilder text = toText(event, sb, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes = getBytes(text.toString());
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; compressionType != CompressionType.OFF &amp;amp;&amp;amp; bytes.length &amp;gt; compressionThreshold ? compress(bytes) : bytes;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="15337571" author="ralph.goers@dslextreme.com" created="Sat, 18 Jun 2016 05:41:58 +0000"  >&lt;p&gt;This seems like it is getting more and more complicated, and the try block is a little strange since the object of the try block isn&apos;t really the object being closed, thus making this a neat &quot;trick&quot;.&lt;/p&gt;

&lt;p&gt;I can also envision that this code really needs to be smarter. Ideally, you would want to have pools of StringBuilders of different sizes and somehow &quot;know&quot; that the event that is going to be processed would be best served by a specific pool.  Something like that would be way too involved to do in open code in AbstractStringLayout, but I fear that that is where this is headed.&lt;/p&gt;

&lt;p&gt;I really would prefer to figure out how to create a ThreadLocal registry of sorts that manages all the thread locals.&lt;/p&gt;</comment>
                            <comment id="15337591" author="remkop@yahoo.com" created="Sat, 18 Jun 2016 06:14:09 +0000"  >&lt;p&gt;Aha! Are you thinking of revisiting &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1116&quot; title=&quot;Web app-friendly thread locals for gc-free logging (was: upgrade to log4j2 causes too frequent minor gc)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1116&quot;&gt;LOG4J2-1116&lt;/a&gt;? That would be great!&lt;/p&gt;

&lt;p&gt;About this use case, I am also not 100% happy about the last solution I proposed. I agree that it does not follow the principle of least surprise, which is not good. &lt;/p&gt;

&lt;p&gt;Also, the try-with-resources approach is about as painless as possible for client code, but it is still a co-operative solution and all Layouts must remember to use this idiom. It would be better if the StringBuilder size was controlled without any effort by the Layout.&lt;/p&gt;

&lt;p&gt;I may just stick with my initial solution to check max size in the &lt;tt&gt;getStringBuilder()&lt;/tt&gt; method before returning it. That is simple and covers all but rare cases. We can revisit a more comprehensive solution with &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1116&quot; title=&quot;Web app-friendly thread locals for gc-free logging (was: upgrade to log4j2 causes too frequent minor gc)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1116&quot;&gt;LOG4J2-1116&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15337973" author="mikaelstaldal" created="Sat, 18 Jun 2016 15:24:44 +0000"  >&lt;p&gt;Perhaps we need a way to turn off the use of all ThreadLocal:s, including the StringBuilder ones?&lt;/p&gt;</comment>
                            <comment id="15338230" author="remkop@yahoo.com" created="Sat, 18 Jun 2016 22:22:10 +0000"  >&lt;p&gt;Mikael, why do you want this? &lt;br/&gt;
I&apos;m not sure we can deliver that: ThreadContext, and several other places use ThreadLocals to fulfill functional requirements. &lt;/p&gt;</comment>
                            <comment id="15338284" author="remkop@yahoo.com" created="Sun, 19 Jun 2016 00:04:46 +0000"  >&lt;p&gt;Fixed in master. Added system property &lt;tt&gt;log4j.layoutStringBuilder.maxSize&lt;/tt&gt; to control the maximum size of the buffer.&lt;/p&gt;

&lt;p&gt;This may not be a perfect solution, but should cover the vast majority. Please verify and close.&lt;/p&gt;</comment>
                            <comment id="15338441" author="mikaelstaldal" created="Sun, 19 Jun 2016 08:43:09 +0000"  >&lt;p&gt;After a second thought, not turn off all ThreadLocals (not ThreadContext). But rather to turn all ThreadLocals which are used to achieve garbage free logging. And the reason is that they increase memory usage.&lt;/p&gt;

&lt;p&gt;The garbage free logging comes with a cost of increased memory usage. Some users who do not need garbage free logging may not want to pay that cost.&lt;/p&gt;</comment>
                            <comment id="15338445" author="mikaelstaldal" created="Sun, 19 Jun 2016 09:09:25 +0000"  >&lt;p&gt;I just applied a similar fix to a private StringBuilder in GelfLayout.&lt;/p&gt;

&lt;p&gt;Is there something in PatternLayout that needs to be fixed as well?&lt;/p&gt;</comment>
                            <comment id="15338455" author="remkop@yahoo.com" created="Sun, 19 Jun 2016 09:36:38 +0000"  >&lt;p&gt;Oh, now I see what you mean. Okay, that&apos;s definitely something to consider. We should do this in a comprehensive way then, something like a low memory profile where various buffers are sized smaller, etc. How to deal with the garbage-free stuff would be part of that. Perhaps that should be another epic. &lt;/p&gt;</comment>
                            <comment id="15338456" author="remkop@yahoo.com" created="Sun, 19 Jun 2016 09:38:27 +0000"  >&lt;p&gt;I could be wrong but I think only GelfLayout has a second StringBuilder. &lt;/p&gt;</comment>
                            <comment id="15339227" author="lukebutters7" created="Mon, 20 Jun 2016 09:27:08 +0000"  >&lt;p&gt;Ah ok lets keep JDK classes in ThreadLocals.&lt;/p&gt;

&lt;p&gt;One thing I do like about a Provider which is closable, is it is the only way to get the StringBuilder (from the thread local). With the understanding that this is getting complicated what we can could do is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; SingleThreadStringBuilderProvider &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Closeable {
  /*
   * Gets the string builder &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; creating a log4j message.
   * Implementations may assume that a single thread will call &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
   * at most once, before calling close().
   */
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; StringBuilder getStringBuilder(); 
  
  
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Inside of our AbstractStringLayout we implement the only implementation and provide a protect getter method for our sub classes.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ThreadLocal&amp;lt;StringBuilder&amp;gt; threadLocal = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThreadLocal&amp;lt;&amp;gt;();

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SingleThreadStringBuilderProvider STRING_BUILDER_PROVIDER = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SingleThreadStringBuilderProvider() {
    
        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; StringBuilder getStringBuilder() {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; staticMehtodWhichGetsStringBuilder();
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() {
            &lt;span class=&quot;code-comment&quot;&gt;//If the StringBuilder is too &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; then shrink it down here.
&lt;/span&gt;        }
      };

    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; SingleThreadStringBuilderProvider getStringBuilderProviderThatIWillClose() {
        &lt;span class=&quot;code-comment&quot;&gt;//Return the &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; instance.
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; STRING_BUILDER_PROVIDER;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;Our client code which extends the Abstract class now looks like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void logSomething(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; s) {
       &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;(SingleThreadStringBuilderProvider provider = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getStringBuilderProviderThatIWillClose()) {
           StringBuilder sb = provider.getStringBuilder();
           nowGoLog(sb.append(s).toString());
       }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The nice thing about this is:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;we can use a more complicated StringBuilder provider later on, without changing our child classes.&lt;/li&gt;
	&lt;li&gt;we can&apos;t get the special StringBuilder unless we ask for out out of the thing which must be closed.&lt;/li&gt;
	&lt;li&gt;we don&apos;t create any classes.&lt;/li&gt;
	&lt;li&gt;In our testing we can mock out the StringBuilderProvider easily.&lt;/li&gt;
	&lt;li&gt;it solves the original problem.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15339410" author="mikaelstaldal" created="Mon, 20 Jun 2016 12:26:32 +0000"  >&lt;p&gt;Can we make the interface generic over StringBuilder?&lt;/p&gt;

&lt;p&gt;Like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; SingleThreadLocalProvider&amp;lt;T&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Closeable {
  T getLocal();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15339564" author="remkop@yahoo.com" created="Mon, 20 Jun 2016 14:19:51 +0000"  >&lt;p&gt;I am not a fan of introducing a new Provider to obtain the StringBuilder. All current built-in Layouts (and any unknown number of user-defined Layouts) that extend AbstractStringLayout now get their StringBuilder from the layout. If we change this so that the StringBuilder can only be obtained through this new Provider we would break custom Layouts. &lt;/p&gt;

&lt;p&gt;The options I see are:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Let AbstractStringLayout implement Closeable. Advantage: try-with-resources ensures that StringBuilder is cleaned up after use. Drawback #1: custom Layouts that have a custom &lt;tt&gt;close()&lt;/tt&gt; method would break. Drawback #2: client code needs to be aware of and follow this idiom. Client code looks like this:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// AbstractStringLayout subclass:
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
    format(event, getStringBuilder());
} 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;AbstractStringLayout provides a Closeable object whose close() method calls trimToMaxSize(StringBuilder). Advantage: try-with-resources ensures that StringBuilder is cleaned up after use. Drawback #1: arguably unintuitive (although this is debatable). Drawback #2: client code needs to be aware of and follow this idiom. Client code looks like this:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// AbstractStringLayout subclass:
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (STRINGBUILDER_CLEANER) {
    format(event, getStringBuilder());
} 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Manual cleanup without try with resources. Drawback #1: client code needs to be aware of and follow this idiom. Drawback #2: without try-finally exceptions can result in cleanup being skipped. Client code looks like this:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// AbstractStringLayout subclass:
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void format(LogEvent event, StringBuilder stringBuilder) {
    .... &lt;span class=&quot;code-comment&quot;&gt;// format the event
&lt;/span&gt;    trimToMaxSize(stringBuilder); &lt;span class=&quot;code-comment&quot;&gt;// clean up when done
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Auto-cleanup before handing out the StringBuilder. Advantage: No changes required for client code. Drawback: memory not cleaned up if no message follows a large message.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;In my opinion none of the above solutions is perfect and they all have different trade-offs. I&apos;ve currently implemented option #4 which I think gives the most bang for the buck. We can do more in addition, like a #2 for example, and update the call sites to use the StringBuilder in a try-with-resources block, but the vast majority of problems is addressed by what is currently in master.&lt;/p&gt;</comment>
                            <comment id="15340646" author="lukebutters7" created="Mon, 20 Jun 2016 23:18:54 +0000"  >&lt;p&gt;We could keep the existing &lt;tt&gt;getStringBuilder()&lt;/tt&gt; and mark it as Deprecated. Further we change its behaviour to do the pre-check length as you have already done. So at worst we trim the length before handing out the StringBuilder. Existing code wont break it just doesn&apos;t work as well.&lt;/p&gt;

&lt;p&gt;We can then add the provider which is supposed to be closed, future code or existing code can be slowly switched over to use this. Does this solve your listed problems?&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The abstract class does not add a close method, existing code wont break.&lt;/li&gt;
	&lt;li&gt;The thing that you have to go through to get the StringBuilder has to be closed, we could make the more initiative with the method name.&lt;/li&gt;
	&lt;li&gt;try with resources can be used so exceptional cases work.&lt;/li&gt;
	&lt;li&gt;If using the provider we don&apos;t wast memory.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I guess it is odd to think we need to close this as we might not think of StringBuilder as a resource. However if we look at the suggestion where we have a pool of StringBuilders then StringBuilders are a resource in that pool, a resource that we must get out of the pool do something with and finally return to the pool. With that in mind it might seem like a better idea to have a close() method.&lt;/p&gt;</comment>
                            <comment id="15340655" author="lukebutters7" created="Mon, 20 Jun 2016 23:20:57 +0000"  >&lt;p&gt;I had not considered that. I don&apos;t mind as it is not my code base.&lt;/p&gt;</comment>
                            <comment id="15340721" author="remkop@yahoo.com" created="Mon, 20 Jun 2016 23:56:44 +0000"  >&lt;p&gt;I have no issue with the idea of StringBuilder as a closeable resource. It&apos;s just that compared to option #2, I don&apos;t think a Provider adds enough extra value to justify deprecating getStringBuilder(). At least, that is my current thinking. &lt;/p&gt;

&lt;p&gt;Before making further, more invasive, changes I want to see how &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1116&quot; title=&quot;Web app-friendly thread locals for gc-free logging (was: upgrade to log4j2 causes too frequent minor gc)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1116&quot;&gt;LOG4J2-1116&lt;/a&gt; works out because it may result in a more general solution. &lt;/p&gt;</comment>
                            <comment id="15340736" author="remkop@yahoo.com" created="Tue, 21 Jun 2016 00:02:28 +0000"  >&lt;p&gt;By the way, Luke, thank you for raising this issue and pushing hard for an optimal solution! Keep them coming!&lt;/p&gt;</comment>
                            <comment id="15341127" author="lukebutters7" created="Tue, 21 Jun 2016 05:29:34 +0000"  >&lt;p&gt;I also noticed your code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void trimToMaxSize(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; StringBuilder stringBuilder) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (stringBuilder.length() &amp;gt; MAX_STRING_BUILDER_SIZE) {
            stringBuilder.setLength(MAX_STRING_BUILDER_SIZE);
            stringBuilder.trimToSize();
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Do you intentionally call &lt;tt&gt;stringBuilder.length()&lt;/tt&gt; over &lt;tt&gt;stringBuilder.capacity()&lt;/tt&gt; the difference is length() is the size of the String that would be returned where as capacity() is the size of the array&lt;/p&gt;

&lt;p&gt;I have pulled down the log4j source to actually start playing with it. I also ran the log4j-perf jar is there a particular set of arguments I should give java to test something which uses the ThreadLocal string builder?&lt;/p&gt;</comment>
                            <comment id="15341225" author="remkop@yahoo.com" created="Tue, 21 Jun 2016 06:43:34 +0000"  >&lt;p&gt;Good catch! capacity() is probably better.&lt;/p&gt;

&lt;p&gt;I usually run JMH benchmarks with 1 fork, 5-10 warmup iterations, 10-20 iterations: &lt;tt&gt;-f 1 -wi 10 -i 20&lt;/tt&gt;.&lt;br/&gt;
You can express the result in terms of throughput (ops/sec) with &lt;tt&gt;-bm thrpt -tu s&lt;/tt&gt; or sample service time latency (ns/op) with &lt;tt&gt;-bm sample -tu ns&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Remember to also test with multiple thread counts. &lt;tt&gt;-t 1&lt;/tt&gt; is one thread, &lt;tt&gt;-t 4&lt;/tt&gt; is four threads, etc. Easy! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Putting it all together, to run the org.apache.logging.log4j.perf.jmh.ThreadLocalVsConcurrentHashMapBenchmark benchmark with 4 threads:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java -jar log4j-perf/target/benchmarks.jar &lt;span class=&quot;code-quote&quot;&gt;&quot;.*ThreadLocalVsConcurrentHashMap.*&quot;&lt;/span&gt; -f 1 -wi 10 -i 20 -tu ns -bm sample -t 4
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310361">
                    <name>Blocked</name>
                                            <outwardlinks description="Blocked">
                                        <issuelink>
            <issuekey id="12888825">LOG4J2-1125</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311120" key="com.pyxis.greenhopper.jira:gh-epic-link">
                        <customfieldname>Epic Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>LOG4J2-1270</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 22 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2zjen:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>