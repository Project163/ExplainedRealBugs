<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:32:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-500] Unloading one webapp unloads JMX MBeans for all webapps</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-500</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;As a stopgap solution for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-406&quot; title=&quot;JMX MBeans are not being unregistered when a tomcat web application that uses log4j is undeployed, leading to a permgen memory leak.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-406&quot;&gt;&lt;del&gt;LOG4J2-406&lt;/del&gt;&lt;/a&gt;, all MBeans are unregistered when a LoggerContext is stopped. &lt;/p&gt;

&lt;p&gt;In an application server, multiple web applications can be deployed and undeployed independently and a better solution would only unregister the MBeans associated with the web application that is being undeployed.&lt;/p&gt;

&lt;p&gt;Current MBean ObjectNames look like this (simplified):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;...StatusLogger
...ContextSelector
...LoggerContext,ctx=%s
...LoggerConfig,ctx=%s,name=%s
...Appender,ctx=%s,name=%s
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Assuming that every web application has a unique name, and this name becomes the name of the LoggerContext, then one solution would be to create StatusLogger and ContextSelector MBeans that have the LoggerContext name in their ObjectName:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;...StatusLogger,ctx=%s
...ContextSelector,ctx=%s
...LoggerContext,ctx=%s
...LoggerConfig,ctx=%s,name=%s
...Appender,ctx=%s,name=%s
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This way, every web application would have its own StatusLogger and ContextSelector MBeans. The MBeans may point to the same (shared) underlying StatusLogger and ContextSelector objects. When a web application is undeployed, unregistering all MBeans associated with the LoggerContext will not affect any MBeans associated with another web application (which has it own, separate, LoggerContext).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12688506">LOG4J2-500</key>
            <summary>Unloading one webapp unloads JMX MBeans for all webapps</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="rpopma">Remko Popma</reporter>
                        <labels>
                    </labels>
                <created>Mon, 13 Jan 2014 08:08:59 +0000</created>
                <updated>Wed, 11 Jun 2014 23:49:45 +0000</updated>
                            <resolved>Fri, 7 Feb 2014 14:54:54 +0000</resolved>
                                    <version>2.0-rc1</version>
                                    <fixVersion>2.0-rc1</fixVersion>
                                    <component>JMX</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13883857" author="beamerblvd" created="Tue, 28 Jan 2014 07:29:43 +0000"  >&lt;p&gt;Remko, have you had a chance to look at this anymore? We should get this fixed before GA.&lt;/p&gt;</comment>
                            <comment id="13883867" author="remkop@yahoo.com" created="Tue, 28 Jan 2014 07:44:26 +0000"  >&lt;p&gt;Not yet. Should be fairly straight-forward. I&apos;ll try to resolve it this week.&lt;/p&gt;</comment>
                            <comment id="13887867" author="remkop@yahoo.com" created="Fri, 31 Jan 2014 16:04:34 +0000"  >&lt;p&gt;This is not as straight-forward as I thought: it turns out that registering StatusLogger multiple times (once for each LoggerContext) impacts the GUI.&lt;/p&gt;

&lt;p&gt;I haven&apos;t figured out yet if it really is the &lt;em&gt;same&lt;/em&gt; StatusLogger instance that is registered multiple times, or whether multiple webapps (by having different classloaders) actually have &lt;em&gt;different&lt;/em&gt; StatusLogger instances. And just to make it extra fun, perhaps both are possible, depending on whether the log4j2 jar files are in the web container lib folder (and shared between web applications) or bundled with the web application (in WEB-INF/lib)...&lt;/p&gt;

&lt;p&gt;If multiple StatusLoggers are possible then the GUI needs to show separate text areas for each StatusLogger.&lt;/p&gt;</comment>
                            <comment id="13888026" author="beamerblvd" created="Fri, 31 Jan 2014 19:07:01 +0000"  >&lt;p&gt;It can be both.&lt;/p&gt;

&lt;p&gt;If a web application has the Log4j libraries in its &lt;tt&gt;/WEB-INF/lib&lt;/tt&gt; directory, it ALWAYS has its own &lt;tt&gt;StatusLogger&lt;/tt&gt; class that is not the same as the &lt;tt&gt;StatusLogger&lt;/tt&gt; class of any application or the container. This is true even if the container also provides Log4j libraries. However, if the container provides Log4j libraries and the application DOES NOT, then an application would share the container&apos;s &lt;tt&gt;StatusLogger&lt;/tt&gt; class.&lt;/p&gt;

&lt;p&gt;So with all that said, the most complex scenario imaginable is that the container provides the Log4j libraries, multiple applications are deployed, and some of those applications provide their own Log4j libraries while others don&apos;t. In this case, there will be multiple &lt;tt&gt;StatusLogger&lt;/tt&gt; classes, but not necessarily as many as there are applications using Log4j. Fun, huh?&lt;/p&gt;

&lt;p&gt;So, in short, the GUI &lt;em&gt;does&lt;/em&gt; need to show separate text areas for each StatusLogger.&lt;/p&gt;</comment>
                            <comment id="13889525" author="remkop@yahoo.com" created="Mon, 3 Feb 2014 14:57:48 +0000"  >&lt;p&gt;This is still in progress, but I&apos;ve made the following changes in revisions 1563745 and 1563911:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;ObjectName changes&lt;/b&gt;&lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;(NEW JMX ObjectNames ARE INCOMPATIBLE WITH BETA-9 AND OLDER VERSIONS)&lt;/font&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Appenders: &lt;tt&gt;org.apache.logging.log4j2:type=%s,component=Appenders,name=%s&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Async Appenders: &lt;tt&gt;org.apache.logging.log4j2:type=%s,component=AsyncAppenders,name=%s&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;ContextSelector: &lt;tt&gt;org.apache.logging.log4j2:type=%s,component=ContextSelector&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;LoggerConfigs: &lt;tt&gt;org.apache.logging.log4j2:type=%s,component=Loggers,name=%s&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;LoggerContext: &lt;tt&gt;org.apache.logging.log4j2:type=%s&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;RingBuffer for all loggers async: &lt;tt&gt;org.apache.logging.log4j2:type=%s,component=AsyncLoggerRingBuffer&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;RingBuffer for mixed sync/async: &lt;tt&gt;org.apache.logging.log4j2:type=%s,component=Loggers,name=%s,subtype=RingBuffer&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;StatusLogger: &lt;tt&gt;org.apache.logging.log4j2:type=%s,component=StatusLogger&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(In case you wonder why these ObjectNames have &lt;tt&gt;type=LoggerContextName&lt;/tt&gt; and not &lt;tt&gt;name=LoggerContextName&lt;/tt&gt;. JConsole will assume that every &lt;tt&gt;ObjectName&lt;/tt&gt; has a &lt;tt&gt;type&lt;/tt&gt; property and will prioritize the &lt;tt&gt;type&lt;/tt&gt; property when building the navigation tree. Google &quot;JMX Best Practices&quot; for details.)&lt;/p&gt;

&lt;p&gt;&lt;b&gt;JMX Client GUI&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Now has a tab for each active LoggerContext&lt;/li&gt;
	&lt;li&gt;Each LoggerContext tab is itself a tabbed pane with a LoggerStatus tab and a configuration editor tab&lt;/li&gt;
	&lt;li&gt;Updated screenshots in JMX Client GUI manual page&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Granular Unloading&lt;/b&gt;&lt;br/&gt;
LoggerContext will now only unregister its own MBeans when stopped (unloading a webapp only unregisters the MBeans for that webapp)&lt;/p&gt;

&lt;p&gt;&lt;b&gt;TODO&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Test with web application (multiple active contexts, loading/unloading)&lt;/li&gt;
	&lt;li&gt;Document somewhere that the MBean ObjectNames are changing with this release&lt;/li&gt;
	&lt;li&gt;(Optional) Add screenshots with multiple active Logger Contexts&lt;/li&gt;
	&lt;li&gt;(Optional) Dynamically update client GUI when a web application is loaded and MBeans are registered (or unloaded and MBeans are unregistered)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13891975" author="remkop@yahoo.com" created="Wed, 5 Feb 2014 10:26:44 +0000"  >&lt;p&gt;I may need some help with this...&lt;/p&gt;

&lt;p&gt;With the current version of trunk, MBeans are not unregistering when a webapp is undeployed. As far as I can tell, the &lt;tt&gt;LoggerContext.stop()&lt;/tt&gt; method is never called. I&apos;ve tested on Tomcat 7.0.50 and 8.0.1.&lt;/p&gt;

&lt;p&gt;I have log4j-api and log4j-core jar files in WEB-INF/lib, and a jsp file that instantiates a &lt;tt&gt;Logger&lt;/tt&gt; and calls &lt;tt&gt;logger.info()&lt;/tt&gt; on it. No listeners or anything. Displaying the JSP page in a browser correctly causes the MBeans to get registered: I can see status logger debug messages (&quot;Registering MBean org.apache.logging.log4j2...&quot;) in the Tomcat console.&lt;/p&gt;

&lt;p&gt;When undeploying the webapp, I expected the &lt;tt&gt;Log4jWebInitializerImpl.deinitialize()&lt;/tt&gt; method to be called, but I don&apos;t see the log message &lt;tt&gt;&quot;Removing LoggerContext for &quot; + this.name + &quot;.&quot;&lt;/tt&gt; in the console or in any log file...&lt;br/&gt;
On the same hand, I also cannot find any &lt;em&gt;initialization&lt;/em&gt; log messages. (I expected to see the &lt;tt&gt;&quot;Log4jServletContainerInitializer starting up Log4j in Servlet 3.0+ environment.&quot;&lt;/tt&gt; message somewhere but cannot find it.)&lt;/p&gt;</comment>
                            <comment id="13894151" author="remkop@yahoo.com" created="Fri, 7 Feb 2014 03:11:19 +0000"  >&lt;p&gt;The new ObjectNames correctly separate MBeans for multiple web applications. Unloading a webapp now correctly unregisters the MBeans for only that LoggerContext.&lt;/p&gt;

&lt;p&gt;Two items remain: &lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;(at least in Tomcat 7.0.50 and 8.0.1) listeners and filters need to be configured in web.xml in order for the Log4j2 MBeans to be unregistered when the web application is undeployed. We expected that to happen automatically in Servlet 3.0 containers. &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-529&quot; title=&quot;Log4j2 does not auto-initialize on webapp deploy or auto-deinitialize on undeploy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-529&quot;&gt;&lt;del&gt;LOG4J2-529&lt;/del&gt;&lt;/a&gt; was created to track this issue.&lt;/li&gt;
	&lt;li&gt;The Log4J2 JMX GUI needs to dynamically update and add/remove the relevant tabs when MBeans for a LoggerContext are registered/unregistered. &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-530&quot; title=&quot;JMX Client GUI should dynamically update when LoggerContext MBeans are registered/unregistered in MBean server&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-530&quot;&gt;&lt;del&gt;LOG4J2-530&lt;/del&gt;&lt;/a&gt; tracks this issue.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12703316">LOG4J2-578</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12669499">LOG4J2-406</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12693845">LOG4J2-530</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12720679">LOG4J2-666</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12693808">LOG4J2-529</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>367525</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 41 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1rclr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>367833</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>