<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:31:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-393] Low initialization performance when using Log4J with jar packages</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-393</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;We discovered a huge performance difference when initializing Log4J with deployed jar packages compared to using it directly with normal class files.&lt;/p&gt;

&lt;p&gt;As it seems,&lt;br/&gt;
&lt;em&gt;org.apache.logging.log4j.core.config.plugins.ResolverUtil#loadImplementationsInJar&lt;/em&gt;&lt;br/&gt;
is way slower than its counterpart&lt;br/&gt;
&lt;em&gt;org.apache.logging.log4j.core.config.plugins.ResolverUtil#loadImplementationsInDirectory&lt;/em&gt;&lt;br/&gt;
and since this method gets called a few hundred times at initialization in this project, initialization of Log4J took more than 2 minutes with jar packages, compared to a few seconds with class files.&lt;/p&gt;

&lt;p&gt;The performance issue was already mentioned in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-184&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;LOG4J2-184&lt;/a&gt;, only without the jar problem.&lt;br/&gt;
The solution to &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-175&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;LOG4J2-175&lt;/a&gt; might cause this, but we are unsure why the methods exactly get called this often.&lt;/p&gt;

&lt;p&gt;I just can tell that&lt;br/&gt;
&lt;em&gt;org.apache.logging.log4j.core.config.plugins.PluginManager#collectPlugins()&lt;/em&gt; gets called VERY often via&lt;br/&gt;
&lt;em&gt;org.apache.logging.log4j.core.config.BaseConfiguration#getPluginManager&lt;/em&gt;, which gets called by&lt;br/&gt;
&lt;em&gt;org.apache.logging.log4j.core.config.XMLConfiguration#constructHierarchy&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;And &lt;em&gt;collectPlugins()&lt;/em&gt; is remapped to &lt;em&gt;collectPlugins(boolean preLoad, final String pkgs)&lt;/em&gt; with &lt;em&gt;collectPlugins(true, null);&lt;/em&gt;. I&apos;m unsure what this preLoad is for, since it gets overridden with false and apparently no kind of caching is used. In this method, &lt;em&gt;resolver.findInPackage(test, pkg);&lt;/em&gt; takes a whole lot of time searching within the jars, as described in the beginning.&lt;/p&gt;

&lt;p&gt;The only way to work around this was for us to extract the custom appender in a sperate ant build target, and with this in a seperate jar, to minimize the size of the jar, reducing the search time.&lt;/p&gt;

&lt;p&gt;Can you cache things and maybe reduce the calls to &lt;em&gt;collectPlugins()&lt;/em&gt;? I don&apos;t see the probability of changing plugins during initialization as described in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-175&quot; title=&quot;Plugin cache should be reset when addPackages is called&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-175&quot;&gt;&lt;del&gt;LOG4J2-175&lt;/del&gt;&lt;/a&gt; or the comment in &lt;em&gt;org.apache.logging.log4j.core.config.BaseConfiguration#getPluginManager&lt;/em&gt;.&lt;br/&gt;
Introducing a variable for the plugin manager within the for loop in &lt;em&gt;org.apache.logging.log4j.core.config.XMLConfiguration#constructHierarchy&lt;/em&gt; might be a good idea!&lt;/p&gt;</description>
                <environment></environment>
        <key id="12667130">LOG4J2-393</key>
            <summary>Low initialization performance when using Log4J with jar packages</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="philipp.hedwig">Philipp Hedwig</reporter>
                        <labels>
                            <label>performance</label>
                    </labels>
                <created>Thu, 5 Sep 2013 16:11:46 +0000</created>
                <updated>Fri, 13 Sep 2013 11:24:26 +0000</updated>
                            <resolved>Wed, 11 Sep 2013 15:31:22 +0000</resolved>
                                    <version>2.0-beta8</version>
                                    <fixVersion>2.0-beta9</fixVersion>
                                    <component>Configurators</component>
                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13759241" author="ralph.goers@dslextreme.com" created="Thu, 5 Sep 2013 17:27:12 +0000"  >&lt;p&gt;I was actually looking at that recently. Originally, getPluginManager returned a cached object. Somewhere along the lines that was changed to allow new packages to be added. I think it needs to be made a little smarter to only create a new PluginManager if the packages have actually changed.&lt;/p&gt;

&lt;p&gt;Using a variable in constructHierarchy also seems like a very good idea.&lt;/p&gt;</comment>
                            <comment id="13759260" author="sdeboy" created="Thu, 5 Sep 2013 17:48:50 +0000"  >&lt;p&gt;I believe this behavior changed when I needed to add the ability to add a test for the advertiser mechanism, which added a new package, and the new advertiser wasn&apos;t discovered until this logic was changed.&lt;/p&gt;</comment>
                            <comment id="13759262" author="ralph.goers@dslextreme.com" created="Thu, 5 Sep 2013 17:51:18 +0000"  >&lt;p&gt;Can you identify the test that had the problem? I&apos;d like to review it to see what we can do.&lt;/p&gt;</comment>
                            <comment id="13759278" author="sdeboy" created="Thu, 5 Sep 2013 18:14:06 +0000"  >&lt;p&gt;Test:&lt;br/&gt;
&lt;a href=&quot;https://svn.apache.org/repos/asf/logging/log4j/log4j2/trunk/log4j-core/src/test/java/org/apache/logging/log4j/core/config/AdvertiserTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/logging/log4j/log4j2/trunk/log4j-core/src/test/java/org/apache/logging/log4j/core/config/AdvertiserTest.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Associated xml config file:&lt;br/&gt;
&lt;a href=&quot;https://svn.apache.org/repos/asf/logging/log4j/log4j2/trunk/log4j-core/src/test/resources/log4j-advertiser.xml&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/logging/log4j/log4j2/trunk/log4j-core/src/test/resources/log4j-advertiser.xml&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13759281" author="sdeboy" created="Thu, 5 Sep 2013 18:17:00 +0000"  >&lt;p&gt;This isn&apos;t advertiser-specific.  I don&apos;t believe we had tests exercising lookups from additional config-defined packages, otherwise they would have failed as well.&lt;/p&gt;</comment>
                            <comment id="13763724" author="ralph.goers@dslextreme.com" created="Tue, 10 Sep 2013 23:45:44 +0000"  >&lt;p&gt;Scott,&lt;/p&gt;

&lt;p&gt;I am noticing that the &quot;advertiser&quot; attribute is on the configuration element along with the &quot;packages&quot; attribute. Prior to the advertiser change the PluginManager was initialized in the start method in BaseConfiguration. In that case all the packages would already have been registered. When you moved the PluginManager initialization into XMLConfiguration you made it indeterminate since the packages element might be processed before or after the advertisers element. &lt;/p&gt;

&lt;p&gt;The &quot;correct&quot; way to do this is to create an advertisers Node in XMLConfiguration and JSONConfiguration and then perform that actual Plugin work in doConfiguration.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure what you mean by &quot;lookups&quot; as the config file isn&apos;t referencing any variables? Do you mean looking up plugins in the test package? That is done all over the place to get the ListAppender, AlwaysFailAppender, etc and worked just fine before the advertiser change.&lt;/p&gt;

&lt;p&gt;I am going to change the code to what I described above to correct this.&lt;/p&gt;</comment>
                            <comment id="13763772" author="sdeboy" created="Wed, 11 Sep 2013 00:37:55 +0000"  >&lt;p&gt;Sounds good - I recall we had a conversation on the fact that there should be a single advertiser for the entire configuration.  As long as this fits that model, it works for me.  I assume the advertiser test will be updated as well when you&apos;re done?&lt;/p&gt;</comment>
                            <comment id="13764080" author="ralph.goers@dslextreme.com" created="Wed, 11 Sep 2013 07:43:09 +0000"  >&lt;p&gt;The changes described above were applied in revision 1521753. No changes to unit tests were needed. Please verify and close.&lt;/p&gt;</comment>
                            <comment id="13764279" author="philipp.hedwig" created="Wed, 11 Sep 2013 13:16:05 +0000"  >&lt;p&gt;I tried to test this with rev. 1521753, built new jar files and linked those in the project. Despite the on code level great looking changes, I get the following exception and stack trace during initialization:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.AbstractMethodError: javax.xml.parsers.DocumentBuilderFactory.setFeature(Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;;Z)V
	at org.apache.logging.log4j.core.config.XMLConfiguration.enableXInclude(XMLConfiguration.java:118)
	at org.apache.logging.log4j.core.config.XMLConfiguration.newDocumentBuilder(XMLConfiguration.java:97)
	at org.apache.logging.log4j.core.config.XMLConfiguration.&amp;lt;init&amp;gt;(XMLConfiguration.java:141)
	at org.apache.logging.log4j.core.config.XMLConfigurationFactory.getConfiguration(XMLConfigurationFactory.java:40)
	at org.apache.logging.log4j.core.config.ConfigurationFactory$Factory.getConfiguration(ConfigurationFactory.java:375)
	at org.apache.logging.log4j.core.LoggerContext.reconfigure(LoggerContext.java:377)
	at org.apache.logging.log4j.core.LoggerContext.start(LoggerContext.java:149)
	at org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:85)
	at org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:34)
	at org.apache.logging.log4j.LogManager.getLogger(LogManager.java:387)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I checked beta8 and the difference is: Calls to &lt;tt&gt;factory.setNamespaceAware(true);&lt;/tt&gt; and &lt;tt&gt;enableXInclude(factory);&lt;/tt&gt; are new. (&lt;em&gt;org.apache.logging.log4j.core.config.XMLConfiguration&lt;/em&gt;, lines 96 and 97)&lt;br/&gt;
Somehow the provided &lt;tt&gt;DocumentBuilderFactory&lt;/tt&gt; (&lt;em&gt;org.apache.xerces.jaxp.DocumentBuilderFactoryImpl&lt;/em&gt;) seems to not have implemented the &lt;tt&gt;setFeature(String name, boolean value)&lt;/tt&gt;-Method.&lt;/p&gt;

&lt;p&gt;This might prevent many from upgrading to the newest version, since it might be difficult to update the used xerces version.&lt;/p&gt;</comment>
                            <comment id="13764286" author="garydgregory" created="Wed, 11 Sep 2013 13:31:04 +0000"  >&lt;p&gt;That is weird, the method is part of the public Java 6 API: &lt;a href=&quot;http://docs.oracle.com/javase/6/docs/api/javax/xml/parsers/DocumentBuilderFactory.html#setFeature%28java.lang.String,%20boolean%29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/6/docs/api/javax/xml/parsers/DocumentBuilderFactory.html#setFeature%28java.lang.String,%20boolean%29&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It&apos;s also in Java 5 FWIW so it has been around for a long time: &lt;a href=&quot;http://docs.oracle.com/javase/1.5.0/docs/api/javax/xml/parsers/DocumentBuilderFactory.html#setFeature%28java.lang.String,%20boolean%29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/1.5.0/docs/api/javax/xml/parsers/DocumentBuilderFactory.html#setFeature%28java.lang.String,%20boolean%29&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;What is your Java set up like? Which version and vendor? Do have anything on the endorsed path? Did you override Xerces or any stock JRE classes?&lt;/p&gt;</comment>
                            <comment id="13764383" author="ralph.goers@dslextreme.com" created="Wed, 11 Sep 2013 15:05:59 +0000"  >&lt;p&gt;I&apos;m willing to bet that he has a copy of Xerces that doesn&apos;t support XIncludes in lib/endorsed. I&apos;ll add some code to handle this since.&lt;/p&gt;</comment>
                            <comment id="13764397" author="philipp.hedwig" created="Wed, 11 Sep 2013 15:16:01 +0000"  >&lt;p&gt;We are using Oracle JRE/JDK 1.7.0u09 on Win32. There are no libs in the endorsed path and we haven&apos;t intentionally overridden any classes of xerces or the JRE. We have a pretty old xerces.jar in our classpath, though.&lt;/p&gt;

&lt;p&gt;After removing our old xerces.jar from the classpath, further debugging showed, that the xalan.jar we are using defines a service &lt;tt&gt;META-INF/services/javax.xml.parsers.DocumentBuilderFactory&lt;/tt&gt; linked to the &lt;em&gt;org.apache.xerces.jaxp.DocumentBuilderFactoryImpl&lt;/em&gt; implementation of &lt;tt&gt;DocumentBuilderFactoryImpl&lt;/tt&gt;. After removing the xerces.jar, the implementation can&apos;t be found. If we remove the service definition from the xalan.jar, then the fallback implementation from the JRE is used. But I don&apos;t know if this leads to problems with xalan itself ...&lt;/p&gt;

&lt;p&gt;Changing/removing this many libs can cause many problems and finding those by testing our application would be problematic, too. It&apos;s a high risk of crashes in the production environment.&lt;/p&gt;

&lt;p&gt;Updating xalan to the newest version or removing the jar helps with the &lt;tt&gt;DocumentBuilderFactory&lt;/tt&gt;-problem, but I can&apos;t estimate the consequences. So a fallback option for extremely old xerces-versions would be very appreciated.&lt;/p&gt;</comment>
                            <comment id="13764408" author="ralph.goers@dslextreme.com" created="Wed, 11 Sep 2013 15:29:41 +0000"  >&lt;p&gt;I added code to catch the AbstractMethodError in revision 1521904. It will still log a warning but it should allow everything else to work. FWIW - the AbstractMethodError really is associated with &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-341&quot; title=&quot;Enable XInclude for XML configurations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-341&quot;&gt;&lt;del&gt;LOG4J2-341&lt;/del&gt;&lt;/a&gt;, not this issue.&lt;/p&gt;</comment>
                            <comment id="13764411" author="ralph.goers@dslextreme.com" created="Wed, 11 Sep 2013 15:31:22 +0000"  >&lt;p&gt;Please verify and close.&lt;/p&gt;</comment>
                            <comment id="13766414" author="philipp.hedwig" created="Fri, 13 Sep 2013 11:23:46 +0000"  >&lt;p&gt;Ok, I tested it with rev. 1522449.&lt;/p&gt;

&lt;p&gt;I didn&apos;t get a logged warning, since obviously the logger isn&apos;t initialized at the moment when &lt;tt&gt;LOGGER.warn()&lt;/tt&gt; gets called, but everything worked and loading times were much faster.&lt;br/&gt;
&lt;tt&gt;ResolverUtil.findInPackage()&lt;/tt&gt; still gets called too many times and is responsible for a great deal of the needed cpu time in intialization, but since this originates from &lt;tt&gt;PatternParser.PatternParser()&lt;/tt&gt; I guess this can&apos;t be improved.&lt;/p&gt;

&lt;p&gt;Thanks a lot for your help and your quick responses.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>347067</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 10 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1nuin:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>347366</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>