<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:37:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1637] OSGi support is broken in Log4j2 2.7</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1637</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;Log4j2 2.7 fails to initialise in an OSGi environement complaining that java.lang.NoClassDefFoundError: org/apache/logging/log4j/Logger.&lt;/p&gt;

&lt;p&gt;Running the OSGi tests on Log4j API also fails:&lt;br/&gt;
org.apache.logging.log4j.osgi.felix.FelixLoadApiBundleTest&lt;br/&gt;
testMissingImportOfCoreOsgiPackage(org.apache.logging.log4j.osgi.felix.FelixLoadApiBundleTest)  Time elapsed: 1.031 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!&lt;br/&gt;
org.osgi.framework.BundleException: Activator start error in bundle org.apache.logging.log4j.core &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;.&lt;br/&gt;
Caused by: java.lang.NoClassDefFoundError: org/apache/logging/log4j/Logger&lt;br/&gt;
Caused by: java.lang.ClassNotFoundException: org.apache.logging.log4j.Logger not found by org.apache.logging.log4j.core &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;... likewise for the other tests and equinox&amp;#93;&lt;/span&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Apache Felix, Java 8&lt;/p&gt;</environment>
        <key id="13010870">LOG4J2-1637</key>
            <summary>OSGi support is broken in Log4j2 2.7</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="lhochet">Ludovic HOCHET</reporter>
                        <labels>
                    </labels>
                <created>Sun, 9 Oct 2016 20:21:15 +0000</created>
                <updated>Wed, 21 Dec 2016 09:36:44 +0000</updated>
                            <resolved>Sun, 6 Nov 2016 00:35:16 +0000</resolved>
                                    <version>2.7</version>
                                    <fixVersion>2.8</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15560560" author="lhochet" created="Sun, 9 Oct 2016 20:21:57 +0000"  >&lt;p&gt;Quick search the manifest for log4j-core shows that it does not import org.apache.logging.log4j.&lt;br/&gt;
Since log4j-api is a dependency, I seached the manifest for log4j-api, which does export org.apache.logging.log4j, so no issue there.&lt;/p&gt;

&lt;p&gt;I then ran maven in debug mode to figure out why the maven-bundle-plugin was not creating the import and found that:&lt;br/&gt;
Private-Package=org.apache.logging.log4j.core,&lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;,org.apache.logging.log4j&lt;br/&gt;
indicating that org.apache.logging.log4j is a package in log4j-core.&lt;br/&gt;
Which indeed it is, it contains ThreadContextAccess introduced by commit fcb58f1 during the work on &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1349&quot; title=&quot;Garbage-free ThreadContext map&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1349&quot;&gt;&lt;del&gt;LOG4J2-1349&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
It seems to me that it could be moved to another package.&lt;/p&gt;</comment>
                            <comment id="15560587" author="ralph.goers@dslextreme.com" created="Sun, 9 Oct 2016 20:41:55 +0000"  >&lt;p&gt;Would it be possible for you to provide a test for this so we don&apos;t keep breaking this?&lt;/p&gt;</comment>
                            <comment id="15580653" author="lhochet" created="Sun, 16 Oct 2016 22:33:53 +0000"  >&lt;p&gt;patch-log4j2-1637.diff is a first attempt at it.&lt;br/&gt;
It is based on the OSGi tests in api, but promoted to a Maven submodule so that they get run on each build.&lt;br/&gt;
From the api test I&apos;ve removed AbstractLoadBundleTest::testLoadStartStop as it is indirectly done by the other tests.&lt;br/&gt;
I&apos;ve added AbstractLoadBundleTest::testClassNotFoundErrorLogger to better identify the failure (you&apos;ll note the difference in messages between Equinox and Felix), the other tests will be in error.&lt;br/&gt;
(The patch does not attempt to fix the split package issue)&lt;/p&gt;</comment>
                            <comment id="15581283" author="remkop@yahoo.com" created="Mon, 17 Oct 2016 05:36:59 +0000"  >&lt;p&gt;ThreadContextAccess is in that package so it can access the package protected &lt;tt&gt;ThreadContext.getThreadContextMap()&lt;/tt&gt; method. This solution had the benefit that the public API for ThreadContext did not need to change (which was desirable based on feedback in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1349&quot; title=&quot;Garbage-free ThreadContext map&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1349&quot;&gt;&lt;del&gt;LOG4J2-1349&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="15600372" author="lhochet" created="Sun, 23 Oct 2016 22:01:07 +0000"  >&lt;p&gt;I agree that it would be best not to extend the public API of ThreadContext. I had missed that part on my previous look at the issue.&lt;/p&gt;

&lt;p&gt;Since ThreadContext.contextMap is not modified once initialised, may be that value could be passed by ThreadContext::init to the ThreadContextAccess? (using reflection to avoid the hard dependency?)&lt;/p&gt;</comment>
                            <comment id="15623193" author="pbelbin" created="Mon, 31 Oct 2016 20:02:15 +0000"  >&lt;p&gt;perhaps related to this:&lt;/p&gt;

&lt;p&gt;Info:   2016-10-31 14:47:12,377 admin-thread-pool(1) DEBUG Log4jServletContainerInitializer starting up Log4j in Servlet 3.0+ environment.&lt;br/&gt;
Severe:   Error invoking ServletContainerInitializer org.apache.logging.log4j.web.Log4jServletContainerInitializer&lt;br/&gt;
java.lang.IllegalAccessError: tried to access method org.apache.logging.log4j.ThreadContext.getThreadContextMap()Lorg/apache/logging/log4j/spi/ThreadContextMap; from class org.apache.logging.log4j.ThreadContextAccess&lt;br/&gt;
	at org.apache.logging.log4j.ThreadContextAccess.getThreadContextMap(ThreadContextAccess.java:45)&lt;br/&gt;
	at org.apache.logging.log4j.core.impl.ContextDataInjectorFactory.createDefaultInjector(ContextDataInjectorFactory.java:83)&lt;br/&gt;
	at org.apache.logging.log4j.core.impl.ContextDataInjectorFactory.createInjector(ContextDataInjectorFactory.java:67)&lt;br/&gt;
	at org.apache.logging.log4j.core.lookup.ContextMapLookup.&amp;lt;init&amp;gt;(ContextMapLookup.java:34)&lt;br/&gt;
	at org.apache.logging.log4j.core.lookup.Interpolator.&amp;lt;init&amp;gt;(Interpolator.java:116)&lt;br/&gt;
	at org.apache.logging.log4j.web.Log4jWebInitializerImpl.&amp;lt;init&amp;gt;(Log4jWebInitializerImpl.java:63)&lt;br/&gt;
	at org.apache.logging.log4j.web.Log4jWebInitializerImpl.initialize(Log4jWebInitializerImpl.java:86)&lt;br/&gt;
	at org.apache.logging.log4j.web.WebLoggerContextUtils.getWebLifeCycle(WebLoggerContextUtils.java:83)&lt;br/&gt;
	at org.apache.logging.log4j.web.Log4jServletContainerInitializer.onStartup(Log4jServletContainerInitializer.java:56)&lt;br/&gt;
	at org.apache.catalina.core.StandardContext.callServletContainerInitializers(StandardContext.java:6062)&lt;br/&gt;
	at com.sun.enterprise.web.WebModule.callServletContainerInitializers(WebModule.java:775)&lt;br/&gt;
	at org.apache.catalina.core.StandardContext.start(StandardContext.java:5960)&lt;br/&gt;
	at com.sun.enterprise.web.WebModule.start(WebModule.java:692)&lt;br/&gt;
	at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:1041)&lt;br/&gt;
	at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:1024)&lt;br/&gt;
	at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:747)&lt;br/&gt;
	at com.sun.enterprise.web.WebContainer.loadWebModule(WebContainer.java:2296)&lt;br/&gt;
	at com.sun.enterprise.web.WebContainer.loadWebModule(WebContainer.java:1942)&lt;br/&gt;
	at com.sun.enterprise.web.WebApplication.start(WebApplication.java:139)&lt;br/&gt;
	at org.glassfish.internal.data.EngineRef.start(EngineRef.java:122)&lt;br/&gt;
	at org.glassfish.internal.data.ModuleInfo.start(ModuleInfo.java:291)&lt;br/&gt;
	at org.glassfish.internal.data.ApplicationInfo.start(ApplicationInfo.java:353)&lt;br/&gt;
	at com.sun.enterprise.v3.server.ApplicationLifecycle.deploy(ApplicationLifecycle.java:501)&lt;br/&gt;
	at com.sun.enterprise.v3.server.ApplicationLifecycle.deploy(ApplicationLifecycle.java:220)&lt;br/&gt;
	at org.glassfish.deployment.admin.DeployCommand.execute(DeployCommand.java:487)&lt;br/&gt;
	at com.sun.enterprise.v3.admin.CommandRunnerImpl$2$1.run(CommandRunnerImpl.java:539)&lt;br/&gt;
	at com.sun.enterprise.v3.admin.CommandRunnerImpl$2$1.run(CommandRunnerImpl.java:535)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at javax.security.auth.Subject.doAs(Subject.java:360)&lt;br/&gt;
	at com.sun.enterprise.v3.admin.CommandRunnerImpl$2.execute(CommandRunnerImpl.java:534)&lt;br/&gt;
	at com.sun.enterprise.v3.admin.CommandRunnerImpl$3.run(CommandRunnerImpl.java:565)&lt;br/&gt;
	at com.sun.enterprise.v3.admin.CommandRunnerImpl$3.run(CommandRunnerImpl.java:557)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at javax.security.auth.Subject.doAs(Subject.java:360)&lt;br/&gt;
	at com.sun.enterprise.v3.admin.CommandRunnerImpl.doCommand(CommandRunnerImpl.java:556)&lt;br/&gt;
	at com.sun.enterprise.v3.admin.CommandRunnerImpl.doCommand(CommandRunnerImpl.java:1464)&lt;br/&gt;
	at com.sun.enterprise.v3.admin.CommandRunnerImpl.access$1300(CommandRunnerImpl.java:109)&lt;br/&gt;
	at com.sun.enterprise.v3.admin.CommandRunnerImpl$ExecutionContext.execute(CommandRunnerImpl.java:1846)&lt;br/&gt;
	at com.sun.enterprise.v3.admin.CommandRunnerImpl$ExecutionContext.execute(CommandRunnerImpl.java:1722)&lt;br/&gt;
	at com.sun.enterprise.v3.admin.AdminAdapter.doCommand(AdminAdapter.java:534)&lt;br/&gt;
	at com.sun.enterprise.v3.admin.AdminAdapter.onMissingResource(AdminAdapter.java:224)&lt;br/&gt;
	at org.glassfish.grizzly.http.server.StaticHttpHandlerBase.service(StaticHttpHandlerBase.java:189)&lt;br/&gt;
	at com.sun.enterprise.v3.services.impl.ContainerMapper$HttpHandlerCallable.call(ContainerMapper.java:466)&lt;br/&gt;
	at com.sun.enterprise.v3.services.impl.ContainerMapper.service(ContainerMapper.java:169)&lt;br/&gt;
	at org.glassfish.grizzly.http.server.HttpHandler.runService(HttpHandler.java:206)&lt;br/&gt;
	at org.glassfish.grizzly.http.server.HttpHandler.doHandle(HttpHandler.java:180)&lt;br/&gt;
	at org.glassfish.grizzly.http.server.HttpServerFilter.handleRead(HttpServerFilter.java:235)&lt;br/&gt;
	at org.glassfish.grizzly.filterchain.ExecutorResolver$9.execute(ExecutorResolver.java:119)&lt;br/&gt;
	at org.glassfish.grizzly.filterchain.DefaultFilterChain.executeFilter(DefaultFilterChain.java:284)&lt;br/&gt;
	at org.glassfish.grizzly.filterchain.DefaultFilterChain.executeChainPart(DefaultFilterChain.java:201)&lt;br/&gt;
	at org.glassfish.grizzly.filterchain.DefaultFilterChain.execute(DefaultFilterChain.java:133)&lt;br/&gt;
	at org.glassfish.grizzly.filterchain.DefaultFilterChain.process(DefaultFilterChain.java:112)&lt;br/&gt;
	at org.glassfish.grizzly.ProcessorExecutor.execute(ProcessorExecutor.java:77)&lt;br/&gt;
	at org.glassfish.grizzly.portunif.PUFilter.handleRead(PUFilter.java:231)&lt;br/&gt;
	at org.glassfish.grizzly.filterchain.ExecutorResolver$9.execute(ExecutorResolver.java:119)&lt;br/&gt;
	at org.glassfish.grizzly.filterchain.DefaultFilterChain.executeFilter(DefaultFilterChain.java:284)&lt;br/&gt;
	at org.glassfish.grizzly.filterchain.DefaultFilterChain.executeChainPart(DefaultFilterChain.java:201)&lt;br/&gt;
	at org.glassfish.grizzly.filterchain.DefaultFilterChain.execute(DefaultFilterChain.java:133)&lt;br/&gt;
	at org.glassfish.grizzly.filterchain.DefaultFilterChain.process(DefaultFilterChain.java:112)&lt;br/&gt;
	at org.glassfish.grizzly.ProcessorExecutor.execute(ProcessorExecutor.java:77)&lt;br/&gt;
	at org.glassfish.grizzly.portunif.PUFilter.handleRead(PUFilter.java:231)&lt;br/&gt;
	at org.glassfish.grizzly.filterchain.ExecutorResolver$9.execute(ExecutorResolver.java:119)&lt;br/&gt;
	at org.glassfish.grizzly.filterchain.DefaultFilterChain.executeFilter(DefaultFilterChain.java:284)&lt;br/&gt;
	at org.glassfish.grizzly.filterchain.DefaultFilterChain.executeChainPart(DefaultFilterChain.java:201)&lt;br/&gt;
	at org.glassfish.grizzly.filterchain.DefaultFilterChain.execute(DefaultFilterChain.java:133)&lt;br/&gt;
	at org.glassfish.grizzly.filterchain.DefaultFilterChain.process(DefaultFilterChain.java:112)&lt;br/&gt;
	at org.glassfish.grizzly.ProcessorExecutor.execute(ProcessorExecutor.java:77)&lt;br/&gt;
	at org.glassfish.grizzly.nio.transport.TCPNIOTransport.fireIOEvent(TCPNIOTransport.java:526)&lt;br/&gt;
	at org.glassfish.grizzly.strategies.AbstractIOStrategy.fireIOEvent(AbstractIOStrategy.java:112)&lt;br/&gt;
	at org.glassfish.grizzly.strategies.WorkerThreadIOStrategy.run0(WorkerThreadIOStrategy.java:117)&lt;br/&gt;
	at org.glassfish.grizzly.strategies.WorkerThreadIOStrategy.access$100(WorkerThreadIOStrategy.java:56)&lt;br/&gt;
	at org.glassfish.grizzly.strategies.WorkerThreadIOStrategy$WorkerThreadRunnable.run(WorkerThreadIOStrategy.java:137)&lt;br/&gt;
	at org.glassfish.grizzly.threadpool.AbstractThreadPool$Worker.doWork(AbstractThreadPool.java:591)&lt;br/&gt;
	at org.glassfish.grizzly.threadpool.AbstractThreadPool$Worker.run(AbstractThreadPool.java:571)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;/p&gt;

&lt;p&gt;it used to work fine with 2.6.2, but, with 2.7, it&apos;s broken.&lt;/p&gt;</comment>
                            <comment id="15626820" author="garydgregory" created="Tue, 1 Nov 2016 22:06:51 +0000"  >&lt;p&gt;Updating the Maven Bundle plugin to the latest version fixes the class loading issue but also shows a new problem:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running org.apache.logging.log4j.osgi.tests.equinox.EquinoxLoadApiBundleTest
Running org.apache.logging.log4j.osgi.tests.felix.FelixLoadApiBundleTest
Tests run: 3, Failures: 0, Errors: 2, Skipped: 0, Time elapsed: 1.522 sec &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.logging.log4j.osgi.tests.felix.FelixLoadApiBundleTest
testMissingImportOfCoreOsgiPackage(org.apache.logging.log4j.osgi.tests.felix.FelixLoadApiBundleTest)  Time elapsed: 0.965 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
org.osgi.framework.BundleException: Unresolved constraint in bundle org.apache.logging.log4j.core [2]: Unable to resolve 2.0: missing requirement [2.0] osgi.wiring.package; (&amp;amp;(osgi.wiring.package=javax.jms)(version&amp;gt;=1.1.0)(!(version&amp;gt;=2.0.0)))

testSimpleLogInAnOsgiContext(org.apache.logging.log4j.osgi.tests.felix.FelixLoadApiBundleTest)  Time elapsed: 0.213 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
org.osgi.framework.BundleException: Unresolved constraint in bundle org.apache.logging.log4j.core [2]: Unable to resolve 2.0: missing requirement [2.0] osgi.wiring.package; (&amp;amp;(osgi.wiring.package=javax.jms)(version&amp;gt;=1.1.0)(!(version&amp;gt;=2.0.0)))

Tests run: 3, Failures: 0, Errors: 2, Skipped: 0, Time elapsed: 1.889 sec &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.logging.log4j.osgi.tests.equinox.EquinoxLoadApiBundleTest
testMissingImportOfCoreOsgiPackage(org.apache.logging.log4j.osgi.tests.equinox.EquinoxLoadApiBundleTest)  Time elapsed: 1.203 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
org.osgi.framework.BundleException: The bundle &quot;org.apache.logging.log4j.core_2.7.1.SNAPSHOT [2]&quot; could not be resolved. Reason: Missing Constraint: Import-Package: javax.jms; version=&quot;[1.1.0,2.0.0)&quot;

testSimpleLogInAnOsgiContext(org.apache.logging.log4j.osgi.tests.equinox.EquinoxLoadApiBundleTest)  Time elapsed: 0.29 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
org.osgi.framework.BundleException: The bundle &quot;org.apache.logging.log4j.core_2.7.1.SNAPSHOT [2]&quot; could not be resolved. Reason: Missing Constraint: Import-Package: javax.jms; version=&quot;[1.1.0,2.0.0)&quot;


Results :

Tests in error:
  EquinoxLoadApiBundleTest&amp;gt;AbstractLoadBundleTest.testMissingImportOfCoreOsgiPackage:150-&amp;gt;AbstractLoadBundleTest.start:187 &#187; Bundle
  EquinoxLoadApiBundleTest&amp;gt;AbstractLoadBundleTest.testSimpleLogInAnOsgiContext:118-&amp;gt;AbstractLoadBundleTest.start:187 &#187; Bundle
  FelixLoadApiBundleTest&amp;gt;AbstractLoadBundleTest.testMissingImportOfCoreOsgiPackage:150-&amp;gt;AbstractLoadBundleTest.start:187 &#187; Bundle
  FelixLoadApiBundleTest&amp;gt;AbstractLoadBundleTest.testSimpleLogInAnOsgiContext:118-&amp;gt;AbstractLoadBundleTest.start:187 &#187; Bundle

Tests run: 6, Failures: 0, Errors: 4, Skipped: 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15628089" author="garydgregory" created="Wed, 2 Nov 2016 07:40:56 +0000"  >&lt;p&gt;Any one with OSGi ideas?&lt;/p&gt;</comment>
                            <comment id="15628828" author="remkop@yahoo.com" created="Wed, 2 Nov 2016 12:39:06 +0000"  >&lt;p&gt;One way to solve the ThreadContextAccess problem is to change the visibility of &lt;tt&gt;ThreadContext::getThreadContextMap&lt;/tt&gt; from package-protected to public. Then the ThreadContextAccess class is no longer needed and ContextInjectors can simply call the public method to query the ThreadContextMap implementation.&lt;/p&gt;

&lt;p&gt;If this is not acceptable then we need some other way to let classes in log4j-core (like ContextInjectors) access the ThreadContextMap implementation that does not cause problems with OSGi.&lt;/p&gt;

&lt;p&gt;By the way, would the ThreadContextAccess problem be resolved if we can somehow ensure that the log4j-core MANIFEST.MF Export-Package section includes this?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;org.apache.logging.log4j.core.impl;uses:=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.logging.log4j&quot;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;or &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;org.apache.logging.log4j;uses:=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.logging.log4j&quot;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15628919" author="remkop@yahoo.com" created="Wed, 2 Nov 2016 13:10:48 +0000"  >&lt;p&gt;&lt;b&gt;ReadOnlyThreadContextMap&lt;/b&gt;&lt;br/&gt;
What if we split off the read-only methods from the ThreadContextMap interface into a separate ReadOnlyThreadContextMap interface? Would it be acceptable to make the &lt;tt&gt;ThreadContext::getThreadContextMap&lt;/tt&gt; method public when its return type is ReadOnlyThreadContextMap? That would solve the underlying problem because then the ThreadContextAccess class is no longer needed and ContextInjectors can get the information they need.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.apache.logging.log4j.spi;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; ReadOnlyThreadContextMap { &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;
&lt;/span&gt;    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; containsKey(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key);
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; get(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key);
    Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; getCopy();
    Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; getImmutableMapOrNull();
    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isEmpty();
    StringMap getReadOnlyContextData(); 
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15629041" author="jvz" created="Wed, 2 Nov 2016 13:54:18 +0000"  >&lt;p&gt;There is some sort of way to split packages in OSGi into two jar files, but it&apos;s been a while since I worked directly with OSGi. I do know that splitting packages like this is generally a big no-no in OSGi, but I do recall there being a specific workaround for it.&lt;/p&gt;</comment>
                            <comment id="15630892" author="remkop@yahoo.com" created="Wed, 2 Nov 2016 23:31:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ralphgoers&quot; class=&quot;user-hover&quot; rel=&quot;ralphgoers&quot;&gt;ralphgoers&lt;/a&gt; What do you think of the ReadOnlyThreadContextMap idea?&lt;/p&gt;</comment>
                            <comment id="15630929" author="ralph.goers@dslextreme.com" created="Wed, 2 Nov 2016 23:46:32 +0000"  >&lt;p&gt;That would be fine. The original contract was to return a read-only Map that directly referenced the ThreadContextMap and a mutable Map that was a copy of the ThreadContextMap. The methods you added should behave similarly.&lt;/p&gt;</comment>
                            <comment id="15631518" author="remkop@yahoo.com" created="Thu, 3 Nov 2016 04:25:38 +0000"  >&lt;p&gt;I created &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1660&quot; title=&quot;ThreadContext to expose ReadOnlyThreadContextMap internal data structure &quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1660&quot;&gt;&lt;del&gt;LOG4J2-1660&lt;/del&gt;&lt;/a&gt; for the new API method that will resolve the underlying problem. &lt;/p&gt;

&lt;p&gt;The unit test is of course still a very good thing. &lt;/p&gt;</comment>
                            <comment id="15633029" author="remkop@yahoo.com" created="Thu, 3 Nov 2016 15:12:22 +0000"  >&lt;p&gt;The changes for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1660&quot; title=&quot;ThreadContext to expose ReadOnlyThreadContextMap internal data structure &quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1660&quot;&gt;&lt;del&gt;LOG4J2-1660&lt;/del&gt;&lt;/a&gt; are pushed to master. I believe this fixes the problem with OSGi, can anyone confirm this?&lt;/p&gt;

&lt;p&gt;I haven&apos;t been able to look at the patch, sorry. Can anyone review the patch?&lt;/p&gt;</comment>
                            <comment id="15633212" author="garydgregory" created="Thu, 3 Nov 2016 15:46:53 +0000"  >&lt;p&gt;With the latest:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running org.apache.logging.log4j.osgi.tests.felix.FelixLoadApiBundleTest
Running org.apache.logging.log4j.osgi.tests.equinox.EquinoxLoadApiBundleTest
DEBUG: WIRE: [1.0] osgi.wiring.package; (&amp;amp;(osgi.wiring.package=org.osgi.framework)(version&amp;gt;=1.6.0)(!(version&amp;gt;=2.0.0))) -&amp;gt; [0]
DEBUG: WIRE: [1.0] osgi.wiring.package; (&amp;amp;(osgi.wiring.package=org.osgi.framework.wiring)(version&amp;gt;=1.0.0)(!(version&amp;gt;=2.0.0))) -&amp;gt; [0]
DEBUG: WIRE: [1.0] osgi.ee; (&amp;amp;(osgi.ee=JavaSE)(version=1.7)) -&amp;gt; [0]
DEBUG: WIRE: [1.0] osgi.wiring.package; (&amp;amp;(osgi.wiring.package=org.osgi.framework)(version&amp;gt;=1.6.0)(!(version&amp;gt;=2.0.0))) -&amp;gt; [0]
DEBUG: WIRE: [1.0] osgi.wiring.package; (&amp;amp;(osgi.wiring.package=org.osgi.framework.wiring)(version&amp;gt;=1.0.0)(!(version&amp;gt;=2.0.0))) -&amp;gt; [0]
DEBUG: WIRE: [1.0] osgi.ee; (&amp;amp;(osgi.ee=JavaSE)(version=1.7)) -&amp;gt; [0]
Tests run: 3, Failures: 0, Errors: 2, Skipped: 0, Time elapsed: 2.382 sec &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.logging.log4j.osgi.tests.equinox.EquinoxLoadApiBundleTest
testMissingImportOfCoreOsgiPackage(org.apache.logging.log4j.osgi.tests.equinox.EquinoxLoadApiBundleTest)  Time elapsed: 1.211 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
org.osgi.framework.BundleException: The bundle &quot;org.apache.logging.log4j.core_2.7.1.SNAPSHOT [2]&quot; could not be resolved. Reason: Missing Constraint: Import-Package: javax.jms; version=&quot;[1.1.0,2.0.0)&quot;

testSimpleLogInAnOsgiContext(org.apache.logging.log4j.osgi.tests.equinox.EquinoxLoadApiBundleTest)  Time elapsed: 0.183 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
org.osgi.framework.BundleException: The bundle &quot;org.apache.logging.log4j.core_2.7.1.SNAPSHOT [2]&quot; could not be resolved. Reason: Missing Constraint: Import-Package: javax.jms; version=&quot;[1.1.0,2.0.0)&quot;

DEBUG: WIRE: [1.0] osgi.wiring.package; (&amp;amp;(osgi.wiring.package=org.osgi.framework)(version&amp;gt;=1.6.0)(!(version&amp;gt;=2.0.0))) -&amp;gt; [0]
DEBUG: WIRE: [1.0] osgi.wiring.package; (&amp;amp;(osgi.wiring.package=org.osgi.framework.wiring)(version&amp;gt;=1.0.0)(!(version&amp;gt;=2.0.0))) -&amp;gt; [0]
DEBUG: WIRE: [1.0] osgi.ee; (&amp;amp;(osgi.ee=JavaSE)(version=1.7)) -&amp;gt; [0]
Tests run: 3, Failures: 0, Errors: 2, Skipped: 0, Time elapsed: 2.51 sec &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.logging.log4j.osgi.tests.felix.FelixLoadApiBundleTest
testMissingImportOfCoreOsgiPackage(org.apache.logging.log4j.osgi.tests.felix.FelixLoadApiBundleTest)  Time elapsed: 1.641 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
org.osgi.framework.BundleException: Unresolved constraint in bundle org.apache.logging.log4j.core [2]: Unable to resolve 2.0: missing requirement [2.0] osgi.wiring.package; (&amp;amp;(osgi.wiring.package=javax.jms)(version&amp;gt;=1.1.0)(!(version&amp;gt;=2.0.0)))

testSimpleLogInAnOsgiContext(org.apache.logging.log4j.osgi.tests.felix.FelixLoadApiBundleTest)  Time elapsed: 0.231 sec  &amp;lt;&amp;lt;&amp;lt; ERROR!
org.osgi.framework.BundleException: Unresolved constraint in bundle org.apache.logging.log4j.core [2]: Unable to resolve 2.0: missing requirement [2.0] osgi.wiring.package; (&amp;amp;(osgi.wiring.package=javax.jms)(version&amp;gt;=1.1.0)(!(version&amp;gt;=2.0.0)))


Results :

Tests in error:
  EquinoxLoadApiBundleTest&amp;gt;AbstractLoadBundleTest.testMissingImportOfCoreOsgiPackage:150-&amp;gt;AbstractLoadBundleTest.start:187 &#9559; Bundle
  EquinoxLoadApiBundleTest&amp;gt;AbstractLoadBundleTest.testSimpleLogInAnOsgiContext:118-&amp;gt;AbstractLoadBundleTest.start:187 &#9559; Bundle
  FelixLoadApiBundleTest&amp;gt;AbstractLoadBundleTest.testMissingImportOfCoreOsgiPackage:150-&amp;gt;AbstractLoadBundleTest.start:187 &#9559; Bundle
  FelixLoadApiBundleTest&amp;gt;AbstractLoadBundleTest.testSimpleLogInAnOsgiContext:118-&amp;gt;AbstractLoadBundleTest.start:187 &#9559; Bundle

Tests run: 6, Failures: 0, Errors: 4, Skipped: 0

[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 9.640 s
[INFO] Finished at: 2016-11-03T08:45:12-07:00
[INFO] Final Memory: 39M/440M
[INFO] ------------------------------------------------------------------------
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-surefire-plugin:2.19.1:test (default-test) on project log4j-osgi: There are test failures.
[ERROR]
[ERROR] Please refer to E:\vcs\git\apache\logging\logging-log4j2\log4j-osgi\target\surefire-reports for the individual test results.
[ERROR] -&amp;gt; [Help 1]
[ERROR]
[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.
[ERROR] Re-run Maven using the -X switch to enable full debug logging.
[ERROR]
[ERROR] For more information about the errors and possible solutions, please read the following articles:
[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/MojoFailureException
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think I should commit it with @Ignored on the failing tests to make it easier for others to look at? Check?&lt;/p&gt;</comment>
                            <comment id="15633236" author="garydgregory" created="Thu, 3 Nov 2016 15:56:06 +0000"  >&lt;p&gt;FWIW, this is the SAME errors I saw before Remko&apos;s commits. From what I can tell, this was already fixed by the update of the bundle plugin.&lt;/p&gt;

&lt;p&gt;Question: Do we still want Remko&apos;s changes since these tests fail just the same?&lt;/p&gt;

&lt;p&gt;We need some OSGi hardhats in here! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Gary&lt;/p&gt;</comment>
                            <comment id="15634666" author="remkop@yahoo.com" created="Thu, 3 Nov 2016 23:36:56 +0000"  >&lt;p&gt;The &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1660&quot; title=&quot;ThreadContext to expose ReadOnlyThreadContextMap internal data structure &quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1660&quot;&gt;&lt;del&gt;LOG4J2-1660&lt;/del&gt;&lt;/a&gt; changes are a good thing regardless of the OSGi issue. I wish I had thought of introducing ReadOnlyThreadContextMap sooner when working on &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1349&quot; title=&quot;Garbage-free ThreadContext map&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1349&quot;&gt;&lt;del&gt;LOG4J2-1349&lt;/del&gt;&lt;/a&gt;. I was never happy with the package-protected method in ThreadContext which then needed to be made public again in the ThreadContextAccessor class for the ContextInjectors. The new solution is much cleaner.&lt;/p&gt;

&lt;p&gt;About the unit test: are we sure it is testing the right thing then? There may actually be two problems:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lhochet&quot; class=&quot;user-hover&quot; rel=&quot;lhochet&quot;&gt;lhochet&lt;/a&gt; mentioned &quot;Log4j2 2.7 fails to initialise in an OSGi environement complaining that java.lang.NoClassDefFoundError: org/apache/logging/log4j/Logger&quot; (no stack trace, so I am not sure if the underlying issue is impacted by my fix...)&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pbelbin&quot; class=&quot;user-hover&quot; rel=&quot;pbelbin&quot;&gt;pbelbin&lt;/a&gt; mentioned &quot;Severe: Error invoking ServletContainerInitializer org.apache.logging.log4j.web.Log4jServletContainerInitializer&lt;br/&gt;
java.lang.IllegalAccessError: tried to access method org.apache.logging.log4j.ThreadContext.getThreadContextMap()Lorg/apache/logging/log4j/spi/ThreadContextMap; from class org.apache.logging.log4j.ThreadContextAccess&quot;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This last issue should be addressed by the &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1660&quot; title=&quot;ThreadContext to expose ReadOnlyThreadContextMap internal data structure &quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1660&quot;&gt;&lt;del&gt;LOG4J2-1660&lt;/del&gt;&lt;/a&gt; fix. Peter, and Ludovic, can you both check if the issue still occurs with the latest code in master? &lt;/p&gt;</comment>
                            <comment id="15634770" author="lhochet" created="Fri, 4 Nov 2016 00:27:58 +0000"  >&lt;p&gt;Regarding the &quot;javax.jms&quot; issue:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;it occurs &quot;long&quot; before the ClassNotFoundException so it was masking it&lt;/li&gt;
	&lt;li&gt;it results from a change in the maven-bundle-plugin (/bnd) 3.0.0 that drops the ;resolution:=optional part of the import&lt;br/&gt;
adding javax.jms;resolution:=optional, to the Import-Package instruction of log4j-core fixes it for me&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1660&quot; title=&quot;ThreadContext to expose ReadOnlyThreadContextMap internal data structure &quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1660&quot;&gt;&lt;del&gt;LOG4J2-1660&lt;/del&gt;&lt;/a&gt; fixes the issue. That is I get the tests running. Tomorrow I&apos;ll check with the office app where I first noticed the issue.&lt;/p&gt;

&lt;p&gt;Regarding the OSGi tests, now that the log4j-osgi module has been added, may be the existing OSGi tests that are on log4j-api and -core can be removed?&lt;/p&gt;</comment>
                            <comment id="15639944" author="lhochet" created="Sat, 5 Nov 2016 16:34:19 +0000"  >&lt;p&gt;I checked with the office app yesterday, it runs with &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1660&quot; title=&quot;ThreadContext to expose ReadOnlyThreadContextMap internal data structure &quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1660&quot;&gt;&lt;del&gt;LOG4J2-1660&lt;/del&gt;&lt;/a&gt; and javax.jms;resolution:=optional.&lt;/p&gt;</comment>
                            <comment id="15640840" author="remkop@yahoo.com" created="Sun, 6 Nov 2016 00:35:17 +0000"  >&lt;p&gt;Ludovic, thank you for the confirmation.&lt;br/&gt;
I will mark this issue as Resolved and it can be closed when Peter also confirms it fixes the issue he raised.&lt;/p&gt;

&lt;p&gt;I will raise a separate Jira ticket for improving the OSGi unit tests.&lt;/p&gt;</comment>
                            <comment id="15640855" author="remkop@yahoo.com" created="Sun, 6 Nov 2016 00:45:15 +0000"  >&lt;p&gt;Raised &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1664&quot; title=&quot;Improve OSGi unit tests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1664&quot;&gt;&lt;del&gt;LOG4J2-1664&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15648269" author="pbelbin" created="Tue, 8 Nov 2016 17:56:16 +0000"  >&lt;p&gt;I was able to test against the current master, and it appears to be fine for me.  Thank you very much for the fix!&lt;/p&gt;</comment>
                            <comment id="15648279" author="remkop@yahoo.com" created="Tue, 8 Nov 2016 18:00:20 +0000"  >&lt;p&gt;Thanks for the verification!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13029678">LOG4J2-1747</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12761163">LOG4J2-920</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13017007">LOG4J2-1658</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13017492">LOG4J2-1660</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                                                <inwardlinks description="is superceded by">
                                        <issuelink>
            <issuekey id="13018651">LOG4J2-1664</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12833650" name="patch-log4j2-1637.diff" size="27878" author="lhochet" created="Sun, 16 Oct 2016 22:26:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 2 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34n6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>