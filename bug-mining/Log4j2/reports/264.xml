<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:32:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-570] Memory Leak</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-570</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;Dynamically loading a JAR that uses log4j2 results in a memory leak when the JAR is unloaded.  This can be observed by deploying a web application to tomcat7 and exercising the stop, undeploy, or redeploy actions.  The memory leak is believed to be caused by log4j for the following reasons:&lt;br/&gt;
1)Heap Dump reveals the classloader instance responsible for the WAR plugin (of type org.apache.catalina.loader.WebappClassLoader) has 2 non weak/soft reference which are of type (org.apache.logging.log4j.core.LoggerContext$ShutdownThread) and (org.apache.logging.log4j.core.jmx.LoggerContextAdmin) after the WAR has been stopped or undeployed.&lt;br/&gt;
2)Using SLF4J (slf4j-api, jcl-over-slf4j) to logback-classic logging output is equivalent but all memory is gc as expected (the org.apache.catalina.loader.WebappClassLoader which loaded the WAR is no longer referenced by any hard references)&lt;br/&gt;
3)Using the SLF4J NOP logger implementation all memory is gc as expected (the org.apache.catalina.loader.WebappClassLoader which loaded the WAR is no longer referenced by any hard references)&lt;/p&gt;

&lt;p&gt;This may not be unique to 2.0rc-1 and I have seen similar behavior in previous 2.0 beta releases.&lt;/p&gt;

&lt;p&gt;This is reproducible with a very simple spring hello world application.  Code and/or heap dumps can be provided upon request.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu 12.04&lt;br/&gt;
Linux 3.2.0-58-generic x86_64 GNU/Linux&lt;br/&gt;
8 GB RAM&lt;/p&gt;

&lt;p&gt;java version &quot;1.7.0_51&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.7.0_51-b13)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 24.51-b03, mixed mode)&lt;/p&gt;

&lt;p&gt;JAVA_OPTS=-Xmx1024m -Dsun.net.inetaddr.ttl=60 -Dsun.net.inetaddr.negative.ttl=60 -Djava.net.preferIPv4Stack=true -XX:PermSize=128m -XX:MaxPermSize=256m -XX:+UseConcMarkSweepGC -XX:+CMSClassUnloadingEnabled&lt;/p&gt;

&lt;p&gt;&amp;lt;log4j.version&amp;gt;2.0-rc1&amp;lt;/log4j.version&amp;gt;&lt;br/&gt;
log4j-api&lt;br/&gt;
log4j-core&lt;br/&gt;
log4j-jcl&lt;/p&gt;

&lt;p&gt;Spring webmvc 4.0.2.RELEASE application (simple hello world) deployed in tomcat7.0.52 container.&lt;/p&gt;</environment>
        <key id="12702274">LOG4J2-570</key>
            <summary>Memory Leak</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mattsicker">Matt Sicker</assignee>
                                    <reporter username="smitchel">Scott</reporter>
                        <labels>
                            <label>memory_leak</label>
                    </labels>
                <created>Tue, 18 Mar 2014 22:45:39 +0000</created>
                <updated>Mon, 5 May 2014 00:59:32 +0000</updated>
                            <resolved>Sun, 4 May 2014 23:20:51 +0000</resolved>
                                    <version>2.0-rc1</version>
                                    <fixVersion>2.0-rc2</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13940471" author="smitchel" created="Wed, 19 Mar 2014 13:49:56 +0000"  >&lt;p&gt;This is the code (see README) which demonstrates memory leak. The hprof which demonstrates the before/after memory leak state is too big (&amp;gt;10MB). This can be provided upon request.&lt;/p&gt;</comment>
                            <comment id="13944139" author="jvz" created="Sat, 22 Mar 2014 16:25:14 +0000"  >&lt;p&gt;Well this is turning out to be a bit more complicated than I originally thought! Spawning off a shutdown hook thread in a web container is a bad idea due to problems like this, so I&apos;m looking at alternative ways to shutdown in a web context. I see that we could use a ServletContextListener to shut down when the ServletContext is destroyed, but we&apos;ll need to make sure that&apos;s only done for the LoggerContext associated to that ServletContext so that if log4j is a server library, it doesn&apos;t shut down everyone. Seems like this could work. I think the JMX class that stays loaded is due to the shutdown thread staying behind which references the LoggerContext linked to the JMX class.&lt;/p&gt;</comment>
                            <comment id="13944478" author="jvz" created="Sun, 23 Mar 2014 16:56:51 +0000"  >&lt;p&gt;Scratch that, I found the bug. This is a two-parter:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;The shutdown hook is enabled by default. In a web context, this should be disabled using the &lt;tt&gt;shutdownHook=&quot;disabled&quot;&lt;/tt&gt; attribute in &lt;tt&gt;&amp;lt;Configuration/&amp;gt;&lt;/tt&gt; (or equivalent in JSON or YAML).&lt;/li&gt;
	&lt;li&gt;This should be default behavior in a web context; otherwise, the shutdown hook thread &lt;em&gt;will&lt;/em&gt; leak, and there doesn&apos;t seem to be any way to prevent that without doing server-specific cases (which is also a bad idea).&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13944491" author="ggregory" created="Sun, 23 Mar 2014 17:38:24 +0000"  >&lt;p&gt;so add a big red warning in the docs?&lt;/p&gt;</comment>
                            <comment id="13944494" author="jvz" created="Sun, 23 Mar 2014 17:43:49 +0000"  >&lt;p&gt;I could add some logic to pre-disable the shutdown hook in o.a.l.l.c.LoggerContext that the web initialization code can use. I&apos;ll make a commit, and you can review that to see if it&apos;s too complicated to be worth it or not.&lt;/p&gt;</comment>
                            <comment id="13944555" author="jvz" created="Sun, 23 Mar 2014 20:00:45 +0000"  >&lt;p&gt;I&apos;ve updated the documentation to reflect this setting. I tried working in code that could prevent the shutdown hook from being used, but that turned out to not be feasible based on the current flow of execution. Removing a shutdown hook after it&apos;s been added in a web container doesn&apos;t appear to work, and said shutdown hook really won&apos;t be called until Tomcat (or similar) &lt;b&gt;itself&lt;/b&gt; is shutdown. We already clean up using ServletContextListener. The best I can do here is possibly call thread.interrupt(), but I&apos;m not sure if that&apos;s even a good idea.&lt;/p&gt;</comment>
                            <comment id="13944601" author="remkop@yahoo.com" created="Sun, 23 Mar 2014 21:59:21 +0000"  >&lt;p&gt;I haven&apos;t looked at the code, but would it be possible to detect if we&apos;re running in a web container before adding the shutdown hook and registering or not registering depending on that?&lt;/p&gt;

&lt;p&gt;I mean, if it is hard to do this cleanly, but it is important to do it, then we could use something ugly like setting a global flag in the web initialization logic...&lt;/p&gt;</comment>
                            <comment id="13944604" author="jvz" created="Sun, 23 Mar 2014 22:06:29 +0000"  >&lt;p&gt;Not without a bit of refactoring. Right now, when you use the JNDI context selector, that gives you a location to override the hook before going to the Status.STARTING state. In the non-JNDI case, following the call chain leaves you in Log4jContextFactory.getContext(lots of params) where the LoggerContext is started. The only hook existing here would be in the ContextSelector itself, but that&apos;s still specified by configuration.&lt;/p&gt;</comment>
                            <comment id="13945108" author="smitchel" created="Mon, 24 Mar 2014 13:55:15 +0000"  >&lt;p&gt;Thank you for looking into this Matt.  I had a feeling the solution to this issue may be constrained due to existing design and hooks w.r.t to servlet containers.  It is unfortunate detection can not be done prior to adding the hook as Remko suggested.  Are there usage statistics on log4j/log4j2 to know whether webapp/servlet deployment is a common enough use case to avoid a &quot;no-fix&quot; resolution? If the the proposed workaround (*see followup) does not work then I believe application developers are forced to use logback for this use-case (need to stop/redeploy/undeploy webapp).  The difficult part for application developers is that the leak will likely go undetected until disaster strikes (PermGen exhausted), and may be difficult to diagnose for some developers in the webapp/servlet use-case.&lt;/p&gt;

&lt;p&gt;Given the current state of affairs it may be beneficial to reference the logback code base. They provide an accessor to the LoggerContext for which the stop method can be invoked (&lt;a href=&quot;http://logback.qos.ch/manual/configuration.html#stopContext&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://logback.qos.ch/manual/configuration.html#stopContext&lt;/a&gt;) to explicitly cleanup.  More importantly they have figured out a way to either not start certain aspects of the infrastructure or clean up without explicit configuration or even explicitly closing the LoggerContext as described in their documentation (see code attached which uses logback-classic but does not close LoggerContext).&lt;/p&gt;

&lt;p&gt;*Can you clarify the proposed workaround?  Is the workaround to add an attribute to the &quot;log4j2.xml&quot; &amp;lt;Configuration&amp;gt; element which is &apos;shutdownHook=&quot;disable&quot;&apos;?  Is there anything else that needs to be done as I am still seeing a memory leak but with 1 layer of referencing removed.  To clarify an instance of &quot;org.apache.logging.log4j.core.jmx.LoggerContextAdmin&quot; classloader is now the only class which still has hard references that remain (to &quot;org.apache.catalina.loader.WebappClassLoader&quot;) and is preventing GC from cleaning up resources.&lt;/p&gt;

&lt;p&gt;Also can you provide a link to the updated documentation?  If not already modified/clarified the &quot;Web Applications and JSPs&quot; documentation (&lt;a href=&quot;http://logging.apache.org/log4j/2.x/manual/webapp.html#Servlet-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://logging.apache.org/log4j/2.x/manual/webapp.html#Servlet-3.0&lt;/a&gt;) states that log4j should &quot;just work&quot; w.r.t to deploying and shutting down.&lt;/p&gt;</comment>
                            <comment id="13945205" author="jvz" created="Mon, 24 Mar 2014 15:18:46 +0000"  >&lt;p&gt;Tomcat wasn&apos;t finding that other memory leak, so I&apos;m not sure what to do about that. In regards to the no-fix, that&apos;s mainly because I&apos;d like a separate issue raised for refactoring the initialization/destruction code to make this far more automatic. The current problem is the different code paths for JNDI versus an arbitrary ContextSelector. This actually relates a bit to how I&apos;d like to see things get more modular to allow for more use case scenarios to be properly supported (e.g., OSGi, other container/module frameworks, Jigsaw in Java 9, etc).&lt;/p&gt;

&lt;p&gt;I&apos;ve added a &quot;big red&quot; warning to the webapp.html documentation page that indicates you need to set &lt;tt&gt;shutdownHook=&quot;disable&quot;&lt;/tt&gt; to &lt;tt&gt;&amp;lt;Configuration/&amp;gt;&lt;/tt&gt; (so yes, exactly as you said). I&apos;m not familiar with the JMX code, so that might need to be looked at by someone else.&lt;/p&gt;

&lt;p&gt;In fact, I&apos;ll create a new issue for this because it&apos;s a separate but related issue.&lt;/p&gt;</comment>
                            <comment id="13945248" author="smitchel" created="Mon, 24 Mar 2014 15:48:53 +0000"  >&lt;p&gt;When you say: &quot;Tomact wasn&apos;t finding that other memory leak&quot; do you mean the &quot;Find Leaks&quot; feature provided by tomcat ( &lt;a href=&quot;http://tomcat.apache.org/tomcat-7.0-doc/manager-howto.html#Finding_memory_leaks&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://tomcat.apache.org/tomcat-7.0-doc/manager-howto.html#Finding_memory_leaks&lt;/a&gt; )?  For my test case this feature was detecting there was a leak (I can provide heap dumps if necessary, are there any notable differences in our environments).  This tomcat feature is nice but I&apos;m not sure if tomcat detecting the leak or not is relevant (tomcat&apos;s memory leak detection functionality may not be guaranteed to detect all leaks).  If you are just looking for ways to detect or inspect the memory leak I can suggest alternatives.  It sounds like you have 1 case covered with the &amp;lt;Configuration&amp;gt; node modification, but I&apos;m not confident this covers the whole issue.  Could we leave this issue open and/or re-assign (to log4j2 JMX SME) if the new restructuring issue you are suggesting is not designed to capture/resolve this entire issue?&lt;/p&gt;

&lt;p&gt;Creating a separate issue for restructuring is fine as long as we link (in jira, and in description) the two issues together in such a way that the new issue must address the leak in the process of restructuring.&lt;/p&gt;</comment>
                            <comment id="13945343" author="jvz" created="Mon, 24 Mar 2014 16:55:47 +0000"  >&lt;p&gt;Here&apos;s a link to the refactoring. The JMX memory leak sounds like a separate issue. I suppose you could either edit this one or create a new one for that. Any advice on detecting the JMX leak might be helpful. I&apos;ve got YourKit Java Profiler to use, but if you know of a better tool for finding leaks, I&apos;m open to suggestions.&lt;/p&gt;</comment>
                            <comment id="13945347" author="jvz" created="Mon, 24 Mar 2014 16:56:58 +0000"  >&lt;p&gt;As to the Tomcat thing, I should probably specify my environment, too.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Server version: Apache Tomcat/7.0.52
Server built:   Feb 13 2014 10:24:25
Server number:  7.0.52.0
OS Name:        Mac OS X
OS Version:     10.8.5
Architecture:   x86_64
JVM Version:    1.8.0-b132
JVM Vendor:     Oracle Corporation
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13945406" author="smitchel" created="Mon, 24 Mar 2014 17:41:32 +0000"  >&lt;p&gt;I have minimal experience with YourKit (no license), and slightly more with Visual VM.  Below are some instructions on how to detect if there is a memory leak.  My experience with these profiler tools is that it more difficult to actually trace the cause of the memory leak.  This is where Eclipse Memory Analyzer ( &lt;a href=&quot;https://www.eclipse.org/mat/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.eclipse.org/mat/&lt;/a&gt; ) really shines (see other set of instructions below).  Regardless if you like eclipse or not the filtering, searching, and object relationships (particularly to GC roots) provided by this plugin are very helpful.&lt;/p&gt;

&lt;p&gt;Profiler instructions (visual VM and should work for YourKit):&lt;br/&gt;
1) Load the test webapp into your servlet container (tomcat).&lt;br/&gt;
2) Find your servlet container in your favorite profiler.&lt;br/&gt;
3) Take a heap dump.&lt;br/&gt;
4) In the heap dump look for all instances of class &quot;org.apache.catalina.loader.WebappClassLoader&quot;.  There should be 1 instance of this class for each webapp that is loaded (started in tomcat&apos;s case).   Inspect the &quot;contextName&quot; of each (assuming there is more than 1) instance until it matches your test application name.&lt;br/&gt;
5) Stop your test webapp.&lt;br/&gt;
6) Take a heap dump.&lt;br/&gt;
7) There should now be 1 less instance of class &quot;org.apache.catalina.loader.WebappClassLoader&quot;.  I am claiming there is not 1 less and this is the memory leak.&lt;br/&gt;
8) This is the step where YourKit and Visual VM where not so helpful...You want to find all non-weak/non-soft references from this object to all GC roots.  For example Visual VM in the Out References you can right click &quot;this&quot; and &quot;Show Nearest GC Root&quot; but this does not yield very much context (often givens something general like a Task Thread). If you have a way to do this with Your Kit or another profiler tool please let me know.&lt;/p&gt;

&lt;p&gt;Eclipse Memory Analyzer (Eclipse Kepler) Instructions:&lt;br/&gt;
1) Take a heap dump (File-&amp;gt;New-&amp;gt;Other-&amp;gt;Other-&amp;gt;Heap Dump)&lt;br/&gt;
2) Select your application (Description=org.apache.catalina.startup.Boostrap start).&lt;br/&gt;
3) Select anything but &quot;Re-open previously run reports&quot; (i.e. &quot;Leak Suspects Report&quot;)&lt;br/&gt;
4) Click the &quot;Open Dominator Tree for entire heap&quot; (third button from left in heap report)&lt;br/&gt;
5) Search for &quot;org.apache.catalina.loader.WebappClassLoader&quot;&lt;br/&gt;
6) Inspect each instance to find the instance which references your web application (look at strings to find paths to your JARs)&lt;br/&gt;
7) Trace this instance back to GC roots (Right click-&amp;gt;Path to GC Roots-&amp;gt;exclude weak/soft references).&lt;br/&gt;
8) In this case you should see an instance of class &quot;org.apache.logging.log4j.core.jmx.LoggerContextAdmin&quot; which is holding on to a reference.&lt;/p&gt;</comment>
                            <comment id="13945492" author="smitchel" created="Mon, 24 Mar 2014 18:34:09 +0000"  >&lt;p&gt;It is always an option to create an OQL query (with javascript if supported) to answer the same question (find all gc roots exclude soft/weak references) the Eclipse Memory Analyzer can provide with a few button clicks.  If you do go this route feel free to post your query here.  Here are some references if you are interested:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://wiki.openitop.org/doku.php?id=oql:start&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://wiki.openitop.org/doku.php?id=oql:start&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://docs.oracle.com/middleware/1212/jdev/OJDUG/optimizing_java_projects.htm&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/middleware/1212/jdev/OJDUG/optimizing_java_projects.htm&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://visualvm.java.net/oqlhelp.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://visualvm.java.net/oqlhelp.html&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://help.eclipse.org/kepler/index.jsp?topic=%2Forg.eclipse.mat.ui.help%2Ftasks%2Fqueryingheapobjects.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://help.eclipse.org/kepler/index.jsp?topic=%2Forg.eclipse.mat.ui.help%2Ftasks%2Fqueryingheapobjects.html&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://www.combodo.com/IMG/pdf/OQL_Reference.pdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.combodo.com/IMG/pdf/OQL_Reference.pdf&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13945543" author="smitchel" created="Mon, 24 Mar 2014 19:03:45 +0000"  >&lt;p&gt;I tried running tomcat under java 8 JVM and the problem still persists. I don&apos;t have a Mac OS X machine handy but I don&apos;t think it is likely that would make a difference.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Tomcat Version: Apache Tomcat/7.0.52
JVM Version: 1.8.0-b132	
JVM Vendor: Oracle Corporation
OS Name: Linux
OS Version: 3.2.0-58-generic
OS Architecture: amd64
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let me know how you want to proceed.  I know you have suggested opening another issue for the JMX memory leak but I will wait in-case you are still doing more analysis with the updated debugging instructions provided.&lt;/p&gt;

&lt;p&gt;If JMX is not needed for Log4j2 then a workaround is to disable it &lt;a href=&quot;http://logging.apache.org/log4j/2.x/manual/jmx.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://logging.apache.org/log4j/2.x/manual/jmx.html&lt;/a&gt;.  I have verified that disabling JMX in combination with your proposed additional attribute to the log4j2.xml &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;Configuration shutdownHook=&lt;span class=&quot;code-quote&quot;&gt;&quot;disable&quot;&lt;/span&gt;&amp;gt; ... &amp;lt;/Configuration&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; mitigates the memory issue for this use-case.&lt;/p&gt;</comment>
                            <comment id="13945725" author="jvz" created="Mon, 24 Mar 2014 21:31:34 +0000"  >&lt;p&gt;In regard to the logback version, you can already do the same thing:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.logging.log4j.LogManager;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.logging.log4j.core.LoggerContext;
&lt;span class=&quot;code-comment&quot;&gt;// ...
&lt;/span&gt;LoggerContext ctx = (LoggerContext) LogManager.getContext();
ctx.stop();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It&apos;s actually amusing how similar that is. If you use log4j in a servlet context, there&apos;s a ServletContextListener that starts and stops the LoggerContext on init and destroy respectively for the ServletContext. The memory leak was caused due to an additional shutdown hook thread being spawned that won&apos;t be called until Tomcat (or whatever server) calls System.exit() (clearly doesn&apos;t happen when an application is undeployed).&lt;/p&gt;

&lt;p&gt;Now if the shutdown hook is preventing the LoggerContext from being cleaned up, I think that could be fixed by using a weak reference in the shutdown thread so that it doesn&apos;t prevent clean up. I&apos;m not so sure about the LoggerContextAdmin class. I&apos;ll take a look to see if I can find anything obvious, but I&apos;m not experienced with the JMX standard.&lt;/p&gt;</comment>
                            <comment id="13945757" author="smitchel" created="Mon, 24 Mar 2014 21:53:40 +0000"  >&lt;p&gt;Sounds promising. Can you explain why 2 shutdown hooks are needed?  Is there some way tomcat (or servlet containers in general) can be shutdown where the ServletContextListener contextDestroyed is not called for each listener, but the Tomcat System.exit() event causes the additional shutdown hook to be called?  In the simple use cases (stopping/unloading/redeploying, using the tomcat shutdown scripts, and even killing the Tomcat application from Visual VM) the contextDestroyed methods are called (verified via log4j2 log file output).&lt;/p&gt;

&lt;p&gt;Using a weak reference will likely help for this use-case, but is there a potential this will break other use-cases that are relying on a non-weak pointer?&lt;/p&gt;

&lt;p&gt;I created another issue for the JMX memory leak (&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-578&quot; title=&quot;JMX Memory Leak in Servlet Container&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-578&quot;&gt;&lt;del&gt;LOG4J2-578&lt;/del&gt;&lt;/a&gt;) as per your earlier suggestion.&lt;/p&gt;</comment>
                            <comment id="13945763" author="jvz" created="Mon, 24 Mar 2014 21:58:56 +0000"  >&lt;p&gt;The runtime shutdown hook is just for non-container contexts. I think it would be better to use a more generic start/stop interface for dealing with LoggerContext objects. Selection of the proper context is already implemented through the ContextSelector interface. Initialization and destruction logic is handled in LoggerContext, but the hooks to start and stop them could be handled better.&lt;/p&gt;

&lt;p&gt;In the servlet context, there is no reason for the shutdown hook to be enabled. Due to the difficulty in overriding that shutdown hook in the current code is why I suggested we refactor that to be more generic to support more contexts.&lt;/p&gt;</comment>
                            <comment id="13946143" author="remkop@yahoo.com" created="Tue, 25 Mar 2014 04:13:53 +0000"  >&lt;p&gt;If I understand the above correctly, the shutdown hook is registered before log4j becomes aware that it is running in a web container. If that is the case, how about creating a new a method that &lt;em&gt;unregisters&lt;/em&gt; the shutdown hook, and call this method as soon as log4j knows it is running in a web container?&lt;/p&gt;</comment>
                            <comment id="13946162" author="jvz" created="Tue, 25 Mar 2014 04:53:48 +0000"  >&lt;p&gt;I tried that, but I didn&apos;t have any luck. Despite removing the shutdown hook, it would still leak the thread for some reason. Might be worth looking into more if I just did it wrong or something.&lt;/p&gt;</comment>
                            <comment id="13949239" author="smitchel" created="Thu, 27 Mar 2014 12:44:18 +0000"  >&lt;p&gt;Is there any new developments related to this issue?  Were you able to find a more generic way to clean up the shutdown hook and resources dedicated to it (i.e. associated threads)?  You mentioned the use of weak pointers...did that help at all?&lt;/p&gt;</comment>
                            <comment id="13949919" author="jvz" created="Thu, 27 Mar 2014 20:58:33 +0000"  >&lt;p&gt;I tried using SoftReference, WeakReference, and PhantomReference (all with explicit use of enqueue() to mark for garbage collection), but the leak still remained. For some reason, there doesn&apos;t seem to be a way to unregister a shutdown hook thread in Tomcat.&lt;/p&gt;</comment>
                            <comment id="13955192" author="smitchel" created="Mon, 31 Mar 2014 13:59:31 +0000"  >&lt;p&gt;Thanks for the effort you&apos;ve invested thus far and its unfortunate this issue seems to be a difficult one.  What is the next step?  The &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-577&quot; title=&quot;Refactor LoggerContext initialization/destruction code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-577&quot;&gt;&lt;del&gt;LOG4J2-577&lt;/del&gt;&lt;/a&gt; task that was designed to make this issue easier to resolve seems like a longer term project.  What release is this task target toward?  I fear that with this issue being marked as &quot;RESOLVED&quot; the issue may lose visibility and fall through the cracks.  What is your feeling on the issue?&lt;/p&gt;</comment>
                            <comment id="13955311" author="remkop@yahoo.com" created="Mon, 31 Mar 2014 15:43:33 +0000"  >&lt;p&gt;Reopened. (We haven&apos;t found a solution yet, but that&apos;s not a good reason to close the issue.) &lt;/p&gt;</comment>
                            <comment id="13955641" author="jvz" created="Mon, 31 Mar 2014 20:17:09 +0000"  >&lt;p&gt;I began working on the initialization refactoring yesterday. Figuring out an appropriate way to use a sort of LoggerContext start-up strategy is where I&apos;m at. I&apos;ve got a branch in svn for that, too.&lt;/p&gt;</comment>
                            <comment id="13989194" author="jvz" created="Sun, 4 May 2014 23:20:21 +0000"  >&lt;p&gt;In r1592429, I&apos;ve added a check for the presence of a class from log4j-web. If the class is present, the shutdown hook is not used. This should solve the shutdown hook memory leak.&lt;/p&gt;</comment>
                            <comment id="13989196" author="jvz" created="Sun, 4 May 2014 23:20:51 +0000"  >&lt;p&gt;Shutdown thread memory leak fixed in r1592429.&lt;/p&gt;</comment>
                            <comment id="13989214" author="ralph.goers@dslextreme.com" created="Mon, 5 May 2014 00:38:30 +0000"  >&lt;p&gt;Rather than check for a class I would prefer that we look for a property that can be found by PropertyUtil. The web module should have the appropriate file defined in it so the property is always defined when the jar is present.&lt;/p&gt;</comment>
                            <comment id="13989215" author="jvz" created="Mon, 5 May 2014 00:40:44 +0000"  >&lt;p&gt;Wait so like a system property? Or we could even use a service via the META-INF/services/ thing.&lt;/p&gt;</comment>
                            <comment id="13989222" author="ralph.goers@dslextreme.com" created="Mon, 5 May 2014 00:59:32 +0000"  >&lt;p&gt;I am in front of my computer now so I can look at code. PropertiesUtil looks for a resource named &quot;log4j2.component.properties&quot;. We need to extend that so it can find multiple instances and concatenate them.  Then when you look up a property it can either come from that property file or a system property. So if the web module has a property file named log4j2.component.properties with the property in it we will know Log4j is running in a servlet container.  This is much better than relying on a class that someone might decide to rename.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12703316">LOG4J2-578</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12703213">LOG4J2-577</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12635547" name="spring_log4j2_memory_leak.tbz2" size="3662" author="smitchel" created="Wed, 19 Mar 2014 13:49:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>380614</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 29 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1tktr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>380893</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>