<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:42:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-3333] Classloader deadlock in ThreadContextDataInjector</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-3333</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;I ran into a deadlock involving &lt;tt&gt;ThreadContextDataInjector&lt;/tt&gt; and the &quot;Thread Context Data Task&quot; background thread. The basic idea is that the &quot;main&quot; thread holds the classloader lock (since log4j2 is initialized during class loading, as a rule) and tries to acquire the provider lock, while the &quot;Thread Context Data Task&quot; thread holds the provider lock and tries to load classes:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Found one Java-level deadlock:
=============================
&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; Context Data Task&quot;&lt;/span&gt;:
  waiting to lock monitor 0x00007fde50835958 (object 0x000000077bbf51c8, a org.powermock.core.classloader.MockClassLoader),
  which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt;:
  waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ownable synchronizer 0x0000000773e77ae8, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),
  which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; Context Data Task&quot;&lt;/span&gt;

Java stack information &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the threads listed above:
===================================================
&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; Context Data Task&quot;&lt;/span&gt;:
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName0(Native Method)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:348)
	at java.util.ServiceLoader$LazyIterator.nextService(ServiceLoader.java:370)
	at java.util.ServiceLoader$LazyIterator.next(ServiceLoader.java:404)
	at java.util.ServiceLoader$1.next(ServiceLoader.java:480)
	at org.apache.logging.log4j.core.impl.ThreadContextDataInjector.getServiceProviders(ThreadContextDataInjector.java:85)
	at org.apache.logging.log4j.core.impl.ThreadContextDataInjector.initServiceProviders(ThreadContextDataInjector.java:73)
	at org.apache.logging.log4j.core.LoggerContext$ThreadContextDataTask.run(LoggerContext.java:785)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt;:
	at sun.misc.Unsafe.park(Native Method)
	- parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x0000000773e77ae8&amp;gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:870)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1199)
	at java.util.concurrent.locks.ReentrantLock$NonfairSync.lock(ReentrantLock.java:209)
	at java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:285)
	at org.apache.logging.log4j.core.impl.ThreadContextDataInjector.initServiceProviders(ThreadContextDataInjector.java:70)
	at org.apache.logging.log4j.core.impl.ThreadContextDataInjector.getProviders(ThreadContextDataInjector.java:285)
	at org.apache.logging.log4j.core.impl.ThreadContextDataInjector.access$000(ThreadContextDataInjector.java:55)
	at org.apache.logging.log4j.core.impl.ThreadContextDataInjector$ForDefaultThreadContextMap.&amp;lt;init&amp;gt;(ThreadContextDataInjector.java:108)
	at org.apache.logging.log4j.core.impl.ContextDataInjectorFactory.createDefaultInjector(ContextDataInjectorFactory.java:91)
	at org.apache.logging.log4j.core.impl.ContextDataInjectorFactory.createInjector(ContextDataInjectorFactory.java:71)
	at org.apache.logging.log4j.core.impl.Log4jLogEvent.&amp;lt;clinit&amp;gt;(Log4jLogEvent.java:58)
	at org.apache.logging.log4j.core.LoggerContext.setConfiguration(LoggerContext.java:643)
	at org.apache.logging.log4j.core.LoggerContext.reconfigure(LoggerContext.java:699)
	at org.apache.logging.log4j.core.LoggerContext.reconfigure(LoggerContext.java:716)
	at org.apache.logging.log4j.core.LoggerContext.start(LoggerContext.java:270)
	at org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:155)
	at org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:47)
	at org.apache.logging.log4j.LogManager.getContext(LogManager.java:196)
	at org.apache.logging.log4j.spi.AbstractLoggerAdapter.getContext(AbstractLoggerAdapter.java:137)
	at org.apache.logging.log4j.jcl.LogAdapter.getContext(LogAdapter.java:40)
	at org.apache.logging.log4j.spi.AbstractLoggerAdapter.getLogger(AbstractLoggerAdapter.java:47)
	at org.apache.logging.log4j.jcl.LogFactoryImpl.getInstance(LogFactoryImpl.java:40)
	at org.apache.logging.log4j.jcl.LogFactoryImpl.getInstance(LogFactoryImpl.java:55)
	at org.apache.commons.logging.LogFactory.getLog(LogFactory.java:685)
	at com.amazon.coral.service.Context.&amp;lt;clinit&amp;gt;(Context.java:31)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName0(Native Method)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:348)
	at org.powermock.core.transformers.impl.TestClassTransformer.restoreOriginalConstructorsAccesses(TestClassTransformer.java:261)
	at org.powermock.core.transformers.impl.TestClassTransformer.transform(TestClassTransformer.java:205)
	at org.powermock.core.classloader.MockClassLoader.loadMockClass(MockClassLoader.java:251)
	at org.powermock.core.classloader.MockClassLoader.loadModifiedClass(MockClassLoader.java:180)
	at org.powermock.core.classloader.DeferSupportingClassLoader.loadClass(DeferSupportingClassLoader.java:68)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:351)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.getDeclaredConstructors0(Native Method)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.privateGetDeclaredConstructors(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:2671)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.getConstructors(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:1651)
	at org.junit.runners.model.TestClass.&amp;lt;init&amp;gt;(TestClass.java:47)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Additionally, I noticed a thread safety issue in &lt;tt&gt;LoggerContext&lt;/tt&gt;&apos;s constructors:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; LoggerContext(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; externalContext, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; URI configLocn) {
        &lt;span class=&quot;code-comment&quot;&gt;// ...
&lt;/span&gt;        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; runner = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThreadContextDataTask(), &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; Context Data Task&quot;&lt;/span&gt;);
        runner.setDaemon(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        runner.start();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since &lt;tt&gt;ThreadContextDataTask&lt;/tt&gt; is non-static, this means that a reference to an unconstructed object (that is, the unfinished &lt;tt&gt;LoggerContext&lt;/tt&gt;) is escaping the thread that is constructing it. This is highly thread-unsafe and can result in undefined behavior. Marking the inner class &lt;tt&gt;static&lt;/tt&gt; would fix the issue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13422375">LOG4J2-3333</key>
            <summary>Classloader deadlock in ThreadContextDataInjector</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ckozak">Carter Kozak</assignee>
                                    <reporter username="rschmitt">Ryan Schmitt</reporter>
                        <labels>
                    </labels>
                <created>Thu, 13 Jan 2022 03:16:21 +0000</created>
                <updated>Sun, 30 Jan 2022 15:01:39 +0000</updated>
                            <resolved>Sat, 22 Jan 2022 01:34:28 +0000</resolved>
                                    <version>2.17.1</version>
                                    <fixVersion>2.17.2</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17478289" author="ckozak" created="Wed, 19 Jan 2022 00:45:17 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rschmitt&quot; class=&quot;user-hover&quot; rel=&quot;rschmitt&quot;&gt;rschmitt&lt;/a&gt;! I&apos;m working on a patch here: &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/717&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/717&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Hoping to entirely remove the additional threads from the equation.&lt;/p&gt;</comment>
                            <comment id="17480317" author="jira-bot" created="Sat, 22 Jan 2022 01:32:03 +0000"  >&lt;p&gt;Commit fc31b44b629d9fe46bd96bfd02382519dfdb5f40 in logging-log4j2&apos;s branch refs/heads/release-2.x from Carter Kozak&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=fc31b44&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=fc31b44&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3333&quot; title=&quot;Classloader deadlock in ThreadContextDataInjector&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3333&quot;&gt;&lt;del&gt;LOG4J2-3333&lt;/del&gt;&lt;/a&gt;: Fix ThreadContextDataInjector classloader deadlock&lt;/p&gt;</comment>
                            <comment id="17480318" author="jira-bot" created="Sat, 22 Jan 2022 01:33:52 +0000"  >&lt;p&gt;Commit 46faed471a2c360e59972377a698bf052ef4c004 in logging-log4j2&apos;s branch refs/heads/master from Carter Kozak&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=46faed4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=46faed4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3333&quot; title=&quot;Classloader deadlock in ThreadContextDataInjector&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3333&quot;&gt;&lt;del&gt;LOG4J2-3333&lt;/del&gt;&lt;/a&gt;: Fix ThreadContextDataInjector classloader deadlock&lt;/p&gt;</comment>
                            <comment id="17480319" author="ckozak" created="Sat, 22 Jan 2022 01:34:28 +0000"  >&lt;p&gt;I&apos;ve resolved the issue on release-2.x for 2.17.2 &#8211; please verify from a snapshot and close the issue when you&apos;re satisfied.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 42 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0yjao:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>