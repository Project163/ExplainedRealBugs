<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:40:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1946] DefaultRolloverStrategy is failing if some log file is deleted from the current sequence</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1946</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;A wrong behaviour in rollover strategy has been reported to me today which is related to a problem on the DefaultRolloverStrategy.&lt;br/&gt;
The case specific settings are:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;RollingRandomAccessFile appender&lt;/li&gt;
	&lt;li&gt;SizeBasedTriggeringPolicy set to 1MB&lt;/li&gt;
	&lt;li&gt;DefaultRolloverStrategy with max set to 20&lt;/li&gt;
	&lt;li&gt;filePattern without date (i.e. C:/log/test.log.%i)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;When the rollover action begins (the moment the 20th file is completed) if someone deletes one of more files from the current sequence (for example test.log.8 and/or test.log.9 or whatever) the purgeAscending method is failing in engaging the rollover actions in the correct way and this results in a rollover effect limited only to 2 files (the other files are not updated anymore - in a similar way already observed and fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1821&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/LOG4J2-1821&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;I managed to reproduce the problem in the attached simple project, even in single threaded execution.&lt;br/&gt;
Note that I managed to workaround the problem adding a fake fileIndex to the appender appender.R.strategy.fileIndex=xxxx which results in engaging the purgeDescending method of the same class which is working fine.&lt;/p&gt;

&lt;p&gt;The completed log4j2.properties file is listed below. &lt;br/&gt;
status=INFO&lt;br/&gt;
monitorInterval=5&lt;br/&gt;
appender.R.type=RollingRandomAccessFile&lt;br/&gt;
appender.R.name=R&lt;br/&gt;
appender.R.fileName=C:/log/test.log&lt;br/&gt;
appender.R.layout.type=PatternLayout&lt;br/&gt;
appender.R.layout.pattern=%d&lt;/p&gt;
{dd-MM-yyyy HH:mm:ss,SSS}
&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;%mdc&amp;#93;&lt;/span&gt; %p %c&lt;/p&gt;
{1.}
&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;%t&amp;#93;&lt;/span&gt; %m %ex%n&lt;br/&gt;
appender.R.filePattern=C:/log/test.log.%i&lt;br/&gt;
appender.R.policies.type=Policies&lt;br/&gt;
appender.R.policies.size.type=SizeBasedTriggeringPolicy&lt;br/&gt;
appender.R.policies.size.size=1MB&lt;br/&gt;
appender.R.strategy.type=DefaultRolloverStrategy&lt;br/&gt;
appender.R.strategy.max=20&lt;br/&gt;
rootLogger.level=INFO&lt;br/&gt;
rootLogger.appenderRef.R.ref=R&lt;/p&gt;

&lt;p&gt;#added to workaround the issue&lt;br/&gt;
#appender.R.strategy.fileIndex=xxxx&lt;/p&gt;

&lt;p&gt;Could you please check it out and/or advise accordingly?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13080871">LOG4J2-1946</key>
            <summary>DefaultRolloverStrategy is failing if some log file is deleted from the current sequence</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rgoers">Ralph Goers</assignee>
                                    <reporter username="lucio.farinosi">Lucio Farinosi</reporter>
                        <labels>
                    </labels>
                <created>Mon, 19 Jun 2017 15:57:22 +0000</created>
                <updated>Thu, 1 Aug 2019 15:53:31 +0000</updated>
                            <resolved>Thu, 1 Aug 2019 15:53:31 +0000</resolved>
                                    <version>2.8.2</version>
                                    <fixVersion>2.12.1</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16054297" author="ralph.goers@dslextreme.com" created="Mon, 19 Jun 2017 16:41:12 +0000"  >&lt;p&gt;I guess this isn&apos;t too surprising. The code is looking at the files in the directory and less than 20 files are present so it isn&apos;t going to delete the oldest one. It then runs through the renames and probably is getting an error when it tries to rename a file. To be sure though we need the debug log My guess is that since item 20 wasn&apos;t deleted it is having a problem trying to rename file 19 to 20. Please change status=INFO to status=DEBUG = in your configuration and provide the logs.&lt;/p&gt;</comment>
                            <comment id="16054336" author="lucio.farinosi" created="Mon, 19 Jun 2017 17:02:56 +0000"  >&lt;p&gt;Please find in the attached log4j_trace.log the required trace. The breaking point is @ 2017-06-19 17:59:09,814 &lt;/p&gt;</comment>
                            <comment id="16054376" author="ralph.goers@dslextreme.com" created="Mon, 19 Jun 2017 17:14:28 +0000"  >&lt;p&gt;OK. Looking at the code I can see that the file renaming will not happen if less than 20 files are present. This makes sense because current log file just gets the highest index, so if the maximum files are present renaming isn&apos;t required. To fix this we would probably have to run through all the files to see if there is a gap (which there really shouldn&apos;t be).&lt;/p&gt;</comment>
                            <comment id="16054416" author="lucio.farinosi" created="Mon, 19 Jun 2017 17:32:44 +0000"  >&lt;p&gt;My apologies if I was not clear enough. &lt;br/&gt;
In this case the whole strategy is broken: simply deleting one file from the sequence I&apos;m getting the result the framework is reducing the sequence to test.log and test.log.20 ignoring the setting of the 20 files required in configuration. I would say quite weak or at least not very stable.&lt;br/&gt;
Besides descendingPurge is working in a totally acceptable fashion, keeping constant the number of files (maybe producing temporarly a 21, 22 etc version) until the missing part of the sequence is rolled out. &lt;br/&gt;
Furthermore everybody seems to be much more used to consider .1 as a more recent version of .20. &lt;br/&gt;
I&apos;m just wondering if it can be the case to change back to this logic.&lt;/p&gt;</comment>
                            <comment id="16054438" author="ralph.goers@dslextreme.com" created="Mon, 19 Jun 2017 17:42:07 +0000"  >&lt;p&gt;Your description was clear. The strategy is operating under the assumption that is will be the only thing deleting files. purgeDescending also assumes this and is also &quot;broken&quot; (as you noted) but just not in a way that keeps it from recovering.&lt;/p&gt;

&lt;p&gt;With purgeDescending the oldest file will have the highest index. With purgeAscending the oldest file will have the lowest. If you want file 1 to be the newest then use purgeDescending. &lt;br/&gt;
I&apos;m afraid I don&apos;t understand the last part.  What logic are you wanting what changed back to?&lt;/p&gt;</comment>
                            <comment id="16055817" author="lucio.farinosi" created="Tue, 20 Jun 2017 14:10:31 +0000"  >&lt;p&gt;I meant log4j 1.2 performed by default the descendingPurge and I don&apos;t have enough background on this project to get why the default behaviour has been changed.&lt;br/&gt;
From a user perspective descendingPurge is behaving well as it is giving guarantee to keep the number of historic files (20 in our case), even if in some particular situations the indexes cannot be in strict sequence, as we both noticed. &lt;br/&gt;
By the contrary the ascendingPurge is failing because a broken sequence, for whatever reason, makes the whole rollover strategy looping on one file (test.log.20 in our case).&lt;br/&gt;
You mentioned the assumption that this is the only process deleting files from the log dir: I believe this is not a good assumption as the framework is not locking any file (which is a good thing for sure) and so it cannot control the consistency of the sequence.&lt;br/&gt;
Looking at the code, the renaming should happen whenever the maximun index is exceeding the number of file required (20 in our case). I attached a version of the ascendingPurge method fixed in the sense (Fixed_ascendingPurge.java). Does it make more sense?&lt;/p&gt;</comment>
                            <comment id="16182806" author="finomosec" created="Wed, 27 Sep 2017 16:09:32 +0000"  >&lt;p&gt;We have the same problem.&lt;/p&gt;

&lt;p&gt;Logger Config:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;&amp;lt;RollingFile name=&lt;span class=&quot;code-quote&quot;&gt;&quot;externPersistence&quot;&lt;/span&gt;
		fileName   =&lt;span class=&quot;code-quote&quot;&gt;&quot;${sys:workDir}/log/module_externPersistence.xlog&quot;&lt;/span&gt;
		filePattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;${sys:workDir}/log/module_externPersistence.xlog.%i&quot;&lt;/span&gt;
		append=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt;&amp;gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;Policies&amp;gt;&lt;/span&gt;
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;SizeBasedTriggeringPolicy size=&lt;span class=&quot;code-quote&quot;&gt;&quot;500MB&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/Policies&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;DefaultRolloverStrategy max=&lt;span class=&quot;code-quote&quot;&gt;&quot;10&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;PatternLayout pattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;${sys:LOG4J_PATTERN_1}&quot;&lt;/span&gt; charset=&lt;span class=&quot;code-quote&quot;&gt;&quot;${sys:LOG4J_DEFAULT_CHARSET}&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/RollingFile&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Log-File Rotation-Pattern:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-rw-r--r-- 1 chat chat  46664746 Sep 24 02:40 module_externPersistence.xlog     # CURRENTLY WRITING
-rw-r--r-- 1 chat chat 524288494 Sep  4 09:21 module_externPersistence.xlog.10 # ROTATED!
-rw-r--r-- 1 chat chat 524288447 Oct 20  2016 module_externPersistence.xlog.11 # OLD
-rw-r--r-- 1 chat chat 524288086 Oct 20  2016 module_externPersistence.xlog.12 # OLD
-rw-r--r-- 1 chat chat 524288600 Oct 20  2016 module_externPersistence.xlog.13 # OLD
-rw-r--r-- 1 chat chat 524288052 Oct 20  2016 module_externPersistence.xlog.14 # OLD
-rw-r--r-- 1 chat chat 524289830 Oct 19  2016 module_externPersistence.xlog.15 # OLD
-rw-r--r-- 1 chat chat 524288168 Oct 19  2016 module_externPersistence.xlog.16 # OLD
-rw-r--r-- 1 chat chat 524288720 Oct 19  2016 module_externPersistence.xlog.17 # OLD
-rw-r--r-- 1 chat chat 524288376 Oct 18  2016 module_externPersistence.xlog.18 # OLD
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For some reason the files 1-9 are missing and only file 10 is rotated.&lt;/p&gt;

&lt;p&gt;I assume we had a higher setting for max before and reduced it; the logger then deleted file 1-9 and ended up in this buggy state.&lt;/p&gt;</comment>
                            <comment id="16898162" author="jira-bot" created="Thu, 1 Aug 2019 15:45:38 +0000"  >&lt;p&gt;Commit 05ab7bf87156586c2c2f3c39025ede0325489c07 in logging-log4j2&apos;s branch refs/heads/master from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=05ab7bf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=05ab7bf&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge pull request #299 from IgorPerelyotov/&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1946&quot; title=&quot;DefaultRolloverStrategy is failing if some log file is deleted from the current sequence&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1946&quot;&gt;&lt;del&gt;LOG4J2-1946&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;LOG4j2-1946&amp;#93;&lt;/span&gt; Fix problem with purgeAscending if an old file was deleted&lt;/p&gt;</comment>
                            <comment id="16898167" author="jira-bot" created="Thu, 1 Aug 2019 15:52:17 +0000"  >&lt;p&gt;Commit 0d3ffe2f44190768d615680c9a3dd57aee2fc868 in logging-log4j2&apos;s branch refs/heads/master from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=0d3ffe2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=0d3ffe2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1946&quot; title=&quot;DefaultRolloverStrategy is failing if some log file is deleted from the current sequence&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1946&quot;&gt;&lt;del&gt;LOG4J2-1946&lt;/del&gt;&lt;/a&gt; - allow file renames to work even if files are missing&lt;/p&gt;</comment>
                            <comment id="16898168" author="jira-bot" created="Thu, 1 Aug 2019 15:52:22 +0000"  >&lt;p&gt;Commit 55b8976187a864cc784fd55685b2ece1a2af85cf in logging-log4j2&apos;s branch refs/heads/release-2.x from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=55b8976&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=55b8976&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1946&quot; title=&quot;DefaultRolloverStrategy is failing if some log file is deleted from the current sequence&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1946&quot;&gt;&lt;del&gt;LOG4J2-1946&lt;/del&gt;&lt;/a&gt; - allow file renames to work even if files are missing&lt;/p&gt;</comment>
                            <comment id="16898170" author="ralph.goers@dslextreme.com" created="Thu, 1 Aug 2019 15:53:31 +0000"  >&lt;p&gt;Patch applied. Please verify and close.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12873690" name="Fixed_ascendingPurge.java" size="2582" author="lucio.farinosi" created="Tue, 20 Jun 2017 14:10:45 +0000"/>
                            <attachment id="12873513" name="log4j_issue.zip" size="5323" author="lucio.farinosi" created="Mon, 19 Jun 2017 15:59:42 +0000"/>
                            <attachment id="12873522" name="log4j_trace.log" size="536042" author="lucio.farinosi" created="Mon, 19 Jun 2017 17:02:25 +0000"/>
                            <attachment id="12873514" name="screenshot-1.png" size="58488" author="lucio.farinosi" created="Mon, 19 Jun 2017 16:02:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 15 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3gga7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>