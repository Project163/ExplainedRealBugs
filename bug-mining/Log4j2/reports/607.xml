<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:34:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1159] ThreadLocal leaks in Tomcat8 (even if Async Loggers are not used)</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1159</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;Since v2.4 there a TreadLocal warnings reported by Tomcat. This happens even when the application is not configured to use Async Loggers.&lt;/p&gt;

&lt;p&gt;A minimal webapp to reproduce can be found here: &lt;a href=&quot;https://github.com/jansohn/log4j2-threadlocal&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jansohn/log4j2-threadlocal&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARNUNG: The web application [log4j2webapp] appears to have started a thread named [AsyncLogger-1] but has failed to stop it. This is very likely to create a memory leak. Stack trace of thread:
 sun.misc.Unsafe.park(Native Method)
 java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
 java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)
 com.lmax.disruptor.BlockingWaitStrategy.waitFor(BlockingWaitStrategy.java:45)
 com.lmax.disruptor.ProcessingSequenceBarrier.waitFor(ProcessingSequenceBarrier.java:55)
 com.lmax.disruptor.BatchEventProcessor.run(BatchEventProcessor.java:123)
 java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
 java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
 java.lang.Thread.run(Thread.java:745)
Okt 14, 2015 1:06:48 PM org.apache.catalina.loader.WebappClassLoaderBase checkThreadLocalMapForLeaks
SCHWERWIEGEND: The web application [log4j2webapp] created a ThreadLocal with key of type [org.apache.logging.log4j.core.async.AsyncLogger$Info$1] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info$1@1d29f54]) and a value of type [org.apache.logging.log4j.core.async.AsyncLogger.Info] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info@1ea59ba]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to try and avoid a probable memory leak.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12904828">LOG4J2-1159</key>
            <summary>ThreadLocal leaks in Tomcat8 (even if Async Loggers are not used)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="jansohn">Robin Jansohn</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Oct 2015 11:14:22 +0000</created>
                <updated>Mon, 26 Oct 2015 14:44:02 +0000</updated>
                            <resolved>Wed, 21 Oct 2015 15:14:15 +0000</resolved>
                                    <version>2.4</version>
                    <version>2.4.1</version>
                                    <fixVersion>2.5</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14962924" author="remkop@yahoo.com" created="Mon, 19 Oct 2015 06:45:43 +0000"  >&lt;p&gt;Interestingly, the sample web app does not use Async Loggers, but the memory leak log mentions a thread started by the AsyncLogger class and the ThreadLocal storing a AsyncLogger$Info instance.&lt;/p&gt;

&lt;p&gt;The first problem: how can this happen in a web app that does not even use async loggers?&lt;/p&gt;

&lt;p&gt;Answer: This seems to be caused by a change made for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1074&quot; title=&quot;Add a logformat token for nanotime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1074&quot;&gt;&lt;del&gt;LOG4J2-1074&lt;/del&gt;&lt;/a&gt;, where the selected NanoClock is passed to the AsyncLogger class when Log4j reconfigures (in &lt;tt&gt;LoggerContext.setConfiguration&lt;/tt&gt;). This causes static initialization which results in the memory leak.&lt;/p&gt;

&lt;p&gt;I will next look at solving this issue for both the sample app and an app that actually uses async loggers.&lt;/p&gt;</comment>
                            <comment id="14967292" author="remkop@yahoo.com" created="Wed, 21 Oct 2015 15:14:15 +0000"  >&lt;p&gt;Limiting the scope of this issue to just the memory leak warnings generated by Tomcat when Async Loggers are not used.&lt;/p&gt;

&lt;p&gt;Fixed in commits 08790751 and bf3ba25dfe:&lt;br/&gt;
removed static initializer from AsyncLogger class, so that calling a static method on AsyncLogger will no longer initialize and start up the Disruptor and associated thread.&lt;/p&gt;

&lt;p&gt;Fixed in master.&lt;br/&gt;
Please verify and close.&lt;/p&gt;</comment>
                            <comment id="14971066" author="jansohn" created="Fri, 23 Oct 2015 14:23:59 +0000"  >&lt;p&gt;Is there a Maven SNAPSHOT version I could use to verify?&lt;/p&gt;</comment>
                            <comment id="14972109" author="garydgregory" created="Fri, 23 Oct 2015 23:31:10 +0000"  >&lt;p&gt;Yes, I just uploaded a new set here see &lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/org/apache/logging/log4j&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/logging/log4j&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(except for the log4j-perf module)&lt;/p&gt;</comment>
                            <comment id="14974310" author="jansohn" created="Mon, 26 Oct 2015 14:44:02 +0000"  >&lt;p&gt;Verified with 2.5-SNAPSHOT. Thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="12660290">LOG4J2-323</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 4 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mzyf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>