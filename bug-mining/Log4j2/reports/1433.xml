<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:41:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-2954] Shutdown callbacks registered in LoggerContext.setUpShutdownHook() aren&apos;t strongly referenced</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-2954</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;LoggerContext.setUpShutdownHook() passes a callback to the DefaultShutdownCallbackRegistry. To avoid a memory leak, the registry only holds a soft reference to the passed callback.&lt;/p&gt;

&lt;p&gt;However, the callback is itself just an inline lambda not-otherwise-referenced. Even while the context is alive, the callback will soon become eligible for GC once the SoftReference timer-from-last-access expires. By the time the shutdown hooks actually run, the references are cleared and the context is not gracefully closed.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;Probably surfaced after &lt;a href=&quot;https://github.com/apache/logging-log4j2/commit/bee90521bb63e6162a9cbed606adde4242675c62&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/commit/bee90521bb63e6162a9cbed606adde4242675c62&lt;/a&gt;.&#160;Fixing that leak (which actually kept the callback alive) now makes the callback completely unreferenced (strongly).&lt;/p&gt;

&lt;p&gt;Suggested fix:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;make RegisteredCancellable.hook a strong reference&lt;/li&gt;
	&lt;li&gt;make DefaultShutdownCallbackRegistry.hooks a Collection&amp;lt;WeakReference&amp;lt;...&amp;gt;&amp;gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This would keep the callback alive as long as the returned registration object (the Cancellable) is alive, and the LoggerContext does reference that.&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;Note: Unclear if the above is actually a complete solution. &quot;LoggerContext eligible for GC&quot; doesn&apos;t seem to imply &quot;LoggerContext contents all flushed to disk&quot; - the strong reference from the shutdown hook to the context actually seems necessary, to guarantee that any buffers in the context will be flushed even if the context itself happens to become unreferenced.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13337943">LOG4J2-2954</key>
            <summary>Shutdown callbacks registered in LoggerContext.setUpShutdownHook() aren&apos;t strongly referenced</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ckozak">Carter Kozak</assignee>
                                    <reporter username="henryptung">Henry Tung</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 Oct 2020 20:55:33 +0000</created>
                <updated>Tue, 28 Feb 2023 15:02:43 +0000</updated>
                            <resolved>Tue, 3 Nov 2020 14:59:28 +0000</resolved>
                                    <version>2.13.3</version>
                                    <fixVersion>2.14.0</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                <comments>
                            <comment id="17223348" author="ckozak" created="Fri, 30 Oct 2020 02:32:18 +0000"  >&lt;p&gt;Great find, this does look incorrect. I think the RegisteredCancellable.hook from the list of shutdown hooks must be weakly referenced (currently the case to avoid the memory leak from log4j2-1387), however we a must also strongly reference the hook from the returned Cancellable so it&apos;s not garbage collected prematurely.&lt;/p&gt;</comment>
                            <comment id="17225473" author="jira-bot" created="Tue, 3 Nov 2020 14:57:53 +0000"  >&lt;p&gt;Commit a3e31f76dd13a5e3da8584fc75a4380da206454a in logging-log4j2&apos;s branch refs/heads/release-2.x from Henry Tung&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=a3e31f7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=a3e31f7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2954&quot; title=&quot;Shutdown callbacks registered in LoggerContext.setUpShutdownHook() aren&amp;#39;t strongly referenced&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2954&quot;&gt;&lt;del&gt;LOG4J2-2954&lt;/del&gt;&lt;/a&gt; Retain strong reference to shutdown callbacks&lt;/p&gt;

&lt;p&gt;Make sure the returned Cancellable handler contains a strong&lt;br/&gt;
reference to the callback, so that it is not garbage-collected&lt;br/&gt;
prematurely. Add Javadoc note about collection semantics.&lt;/p&gt;</comment>
                            <comment id="17225474" author="jira-bot" created="Tue, 3 Nov 2020 14:58:16 +0000"  >&lt;p&gt;Commit a3e31f76dd13a5e3da8584fc75a4380da206454a in logging-log4j2&apos;s branch refs/heads/release-2.x from Henry Tung&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=a3e31f7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=a3e31f7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2954&quot; title=&quot;Shutdown callbacks registered in LoggerContext.setUpShutdownHook() aren&amp;#39;t strongly referenced&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2954&quot;&gt;&lt;del&gt;LOG4J2-2954&lt;/del&gt;&lt;/a&gt; Retain strong reference to shutdown callbacks&lt;/p&gt;

&lt;p&gt;Make sure the returned Cancellable handler contains a strong&lt;br/&gt;
reference to the callback, so that it is not garbage-collected&lt;br/&gt;
prematurely. Add Javadoc note about collection semantics.&lt;/p&gt;</comment>
                            <comment id="17225475" author="ckozak" created="Tue, 3 Nov 2020 14:59:28 +0000"  >&lt;p&gt;I&apos;ve merged the first approach to both release-2.x (for 2.14.0) and master. Happy to consider the second approach, but I want to make sure some version of the fix makes the 2.14.0 release.&lt;/p&gt;</comment>
                            <comment id="17225476" author="jira-bot" created="Tue, 3 Nov 2020 15:02:39 +0000"  >&lt;p&gt;Commit 1ef19da2d16d2d8d2487d32819f1048fb3d61228 in logging-log4j2&apos;s branch refs/heads/master from Henry Tung&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=1ef19da&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=1ef19da&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2954&quot; title=&quot;Shutdown callbacks registered in LoggerContext.setUpShutdownHook() aren&amp;#39;t strongly referenced&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2954&quot;&gt;&lt;del&gt;LOG4J2-2954&lt;/del&gt;&lt;/a&gt; Retain strong reference to shutdown callbacks&lt;/p&gt;

&lt;p&gt;Make sure the returned Cancellable handler contains a strong&lt;br/&gt;
reference to the callback, so that it is not garbage-collected&lt;br/&gt;
prematurely. Add Javadoc note about collection semantics.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 2 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0k4qg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>