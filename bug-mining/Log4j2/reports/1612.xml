<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:43:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-3577] Log4j2 configuration during servlet context initialization does not work on Websphere Liberty appserver</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-3577</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;In my web application, log4j configures itself twice:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;before the servlet context is initialized&lt;/li&gt;
	&lt;li&gt;during servlet context initialization&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;(1) uses a log4j configuration that only consists of console appenders. (2) uses a full log4j configuration that consists of servlet appenders and servlet context lookups that would fail if initialized before the servlet context was available. The logger configuration from (2) should overwrite the logger configuration created in (1) for the rest of the application&apos;s lifecycle.&lt;/p&gt;

&lt;p&gt;However, this does not work on Websphere Liberty. Because Log4j associates a logger context with the classloader used to create it, the classloader used during (2) must be the same classloader that is used during the rest of the application&apos;s lifecycle.&lt;/p&gt;

&lt;p&gt;Liberty uses the following classloaders:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;before servlet context initialization: AppClassLoader&lt;/li&gt;
	&lt;li&gt;during servlet context initialization: ThreadContextClassLoader&lt;/li&gt;
	&lt;li&gt;the rest of the application lifecycle: AppClassLoader&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This means that log messages produced during the rest of the application lifecycle do not go through the full log4j configuration created in (2) because the configuration from (2) is associated with the ThreadContextClassLoader whereas the rest of the application uses the AppClassLoader. All messages during the rest of the application lifecycle are logged with the configuration created in (1) because they have the same classloader.&lt;/p&gt;

&lt;p&gt;To workaround this, I have had to modify the source of Log4jWebInitializerImpl:initializeNonJndi to check if the classloader is an instance of com.ibm.ws.classloading.internal.ThreadContextClassLoader. If it is, I pass null as the classloader to Configurator:initialize to allow it to resolve the classloader via other means, which it ultimately computes as the AppClassLoader.&lt;/p&gt;

&lt;p&gt;I have attached my edited version of Log4jWebInitializerImpl.java&lt;/p&gt;

&lt;p&gt;This works on all other application servers that I have tested on, such as Tomcat, Weblogic, and JBoss.&lt;/p&gt;</description>
                <environment>&lt;p&gt;I am using Log4j 2.17.1 on Websphere Liberty 21.0.0.8.&lt;/p&gt;</environment>
        <key id="13477444">LOG4J2-3577</key>
            <summary>Log4j2 configuration during servlet context initialization does not work on Websphere Liberty appserver</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="pkarwasz">Piotr Karwasz</assignee>
                                    <reporter username="carlfroneberger">Carl Froneberger</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Aug 2022 14:07:31 +0000</created>
                <updated>Mon, 5 Sep 2022 13:45:37 +0000</updated>
                                            <version>2.17.1</version>
                                                    <component>Configuration</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17581396" author="jira-bot" created="Thu, 18 Aug 2022 15:23:52 +0000"  >&lt;p&gt;Commit 80aae217962109e86e7edba0f87a266b989fce37 in logging-log4j2&apos;s branch refs/heads/release-2.x from Piotr P. Karwasz&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=80aae21796&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=80aae21796&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3577&quot; title=&quot;Log4j2 configuration during servlet context initialization does not work on Websphere Liberty appserver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3577&quot;&gt;LOG4J2-3577&lt;/a&gt; Use classloader provided by servlet context&lt;/p&gt;

&lt;p&gt;Since we advertise a Servlet 4.0 requirement, we can use&lt;br/&gt;
`ServletContext#getClassLoader()` from Servlet 3.0 to retrieve the&lt;br/&gt;
correct logger context for the given servlet context.&lt;/p&gt;</comment>
                            <comment id="17581939" author="ralph.goers@dslextreme.com" created="Fri, 19 Aug 2022 16:12:01 +0000"  >&lt;p&gt;This sounds like it is working as designed. By default, Log4j2 uses the ClassLoaderContextSelector.  Its purpose is to allow a logging configuration for every application when running in a servlet container. A &quot;normal&quot; servlet container like Tomcat would have:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Bootstrap classloader&lt;/li&gt;
	&lt;li&gt;Tomcat classloader&lt;/li&gt;
	&lt;li&gt;App classloader&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;With this structure the ClassLoaderContextSelector allows one configuration for Tomcat while each app will have its own since they each have their own ClassLoader.&lt;/p&gt;

&lt;p&gt;It sounds like the problem here is that WebSphere is creating the application&apos;s ClassLoader and then initialing the application&apos;s servlet context using a different ClassLoader, possibly on a different Thread.  So I don&apos;t think the change committed by Piotr is correct. Instead, we need to figure out how to get the Logging Configuration performed before servlet context initialization to locate the application&apos;s logging configuration instead of using the default. That basically means using the Servlet Context is useless for logging configuration.&lt;/p&gt;

&lt;p&gt;The modification provided by the reporter essentially ignores the ThreadContextClassLoader in WebSphere so it will reconfigure the application when the ServletContext is initialized, which is better than what was committed is doing.&lt;/p&gt;

&lt;p&gt;It might make sense to create a WebSphereContextSelector to handle this.&lt;/p&gt;</comment>
                            <comment id="17582019" author="pkarwasz" created="Fri, 19 Aug 2022 20:12:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgoers&quot; class=&quot;user-hover&quot; rel=&quot;rgoers&quot;&gt;rgoers&lt;/a&gt;, I noticed that my commit was useless right away and rolled it back &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. We already use &lt;tt&gt;ServletContext#getClassLoader()&lt;/tt&gt; instead of using the thread context classloader on Servlet 3.0+.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=carlfroneberger&quot; class=&quot;user-hover&quot; rel=&quot;carlfroneberger&quot;&gt;carlfroneberger&lt;/a&gt;: if I understand correctly WebSphere uses &lt;tt&gt;AppClassloader&lt;/tt&gt; to load all the classes in your application, but a call to &lt;tt&gt;ServletContext#getClassLoader()&lt;/tt&gt; (and probably &lt;tt&gt;Thread.currentThread().getContextClassLoader()&lt;/tt&gt;) returns a different classloader? &lt;/p&gt;

&lt;p&gt;If that is the case, switching to the &lt;tt&gt;BasicContextSelector&lt;/tt&gt; should solve the problem: this selector chooses the logger context bound to the thread and &lt;tt&gt;log4j-web&lt;/tt&gt; binds a logger context to the thread at each request.&lt;/p&gt;

&lt;p&gt;Also I am not sure what do you mean by &quot;before servlet context initialization&quot;: the &lt;tt&gt;web-fragment.xml&lt;/tt&gt; contained in &lt;tt&gt;log4j-web&lt;/tt&gt; causes the &lt;tt&gt;Log4jServletContainerInitializer&lt;/tt&gt; to run before any other&#160; container initializer. Hence I would expect that no class in your web application is loaded before the logger context is set up.&lt;/p&gt;</comment>
                            <comment id="17582742" author="jira-bot" created="Mon, 22 Aug 2022 05:34:18 +0000"  >&lt;p&gt;Commit 80aae217962109e86e7edba0f87a266b989fce37 in logging-log4j2&apos;s branch refs/heads/&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3556&quot; title=&quot;JsonTemplateLayout truncation ignores exception cause&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3556&quot;&gt;&lt;del&gt;LOG4J2-3556&lt;/del&gt;&lt;/a&gt; from Piotr P. Karwasz&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=80aae21796&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=80aae21796&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3577&quot; title=&quot;Log4j2 configuration during servlet context initialization does not work on Websphere Liberty appserver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3577&quot;&gt;LOG4J2-3577&lt;/a&gt; Use classloader provided by servlet context&lt;/p&gt;

&lt;p&gt;Since we advertise a Servlet 4.0 requirement, we can use&lt;br/&gt;
`ServletContext#getClassLoader()` from Servlet 3.0 to retrieve the&lt;br/&gt;
correct logger context for the given servlet context.&lt;/p&gt;</comment>
                            <comment id="17583206" author="jira-bot" created="Mon, 22 Aug 2022 21:06:19 +0000"  >&lt;p&gt;Commit 80aae217962109e86e7edba0f87a266b989fce37 in logging-log4j2&apos;s branch refs/heads/slf4j-2.0 from Piotr P. Karwasz&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=80aae21796&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=80aae21796&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3577&quot; title=&quot;Log4j2 configuration during servlet context initialization does not work on Websphere Liberty appserver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3577&quot;&gt;LOG4J2-3577&lt;/a&gt; Use classloader provided by servlet context&lt;/p&gt;

&lt;p&gt;Since we advertise a Servlet 4.0 requirement, we can use&lt;br/&gt;
`ServletContext#getClassLoader()` from Servlet 3.0 to retrieve the&lt;br/&gt;
correct logger context for the given servlet context.&lt;/p&gt;</comment>
                            <comment id="17584457" author="JIRAUSER294610" created="Wed, 24 Aug 2022 20:27:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkarwasz&quot; class=&quot;user-hover&quot; rel=&quot;pkarwasz&quot;&gt;pkarwasz&lt;/a&gt; Yes, that is correct.&#160;{{ServletContext#getClassLoader() and&#160;}}Thread.currentThread().getContextClassLoader() both return a ThreadContextClassLoader. The rest of the application uses the AppClassLoader.&lt;/p&gt;

&lt;p&gt;For whatever reason, there are components of our application that initialize before the servlet context is available. There is a logging initialization before the&#160;Log4jServletContainerInitializer is invoked. There is a third party library that creates loggers very early in the application&apos;s startup process.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17600153" author="jira-bot" created="Mon, 5 Sep 2022 03:20:23 +0000"  >&lt;p&gt;Commit 80aae217962109e86e7edba0f87a266b989fce37 in logging-log4j2&apos;s branch refs/heads/dependabot/maven/com.fasterxml.woodstox-woodstox-core-6.3.1 from Piotr P. Karwasz&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=80aae21796&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=80aae21796&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3577&quot; title=&quot;Log4j2 configuration during servlet context initialization does not work on Websphere Liberty appserver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3577&quot;&gt;LOG4J2-3577&lt;/a&gt; Use classloader provided by servlet context&lt;/p&gt;

&lt;p&gt;Since we advertise a Servlet 4.0 requirement, we can use&lt;br/&gt;
`ServletContext#getClassLoader()` from Servlet 3.0 to retrieve the&lt;br/&gt;
correct logger context for the given servlet context.&lt;/p&gt;</comment>
                            <comment id="17600175" author="jira-bot" created="Mon, 5 Sep 2022 03:54:30 +0000"  >&lt;p&gt;Commit 80aae217962109e86e7edba0f87a266b989fce37 in logging-log4j2&apos;s branch refs/heads/dependabot/maven/org.hsqldb-hsqldb-2.7.0 from Piotr P. Karwasz&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=80aae21796&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=80aae21796&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3577&quot; title=&quot;Log4j2 configuration during servlet context initialization does not work on Websphere Liberty appserver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3577&quot;&gt;LOG4J2-3577&lt;/a&gt; Use classloader provided by servlet context&lt;/p&gt;

&lt;p&gt;Since we advertise a Servlet 4.0 requirement, we can use&lt;br/&gt;
`ServletContext#getClassLoader()` from Servlet 3.0 to retrieve the&lt;br/&gt;
correct logger context for the given servlet context.&lt;/p&gt;</comment>
                            <comment id="17600425" author="jira-bot" created="Mon, 5 Sep 2022 13:45:37 +0000"  >&lt;p&gt;Commit 80aae217962109e86e7edba0f87a266b989fce37 in logging-log4j2&apos;s branch refs/heads/dependabot/maven/groovy.version-3.0.12 from Piotr P. Karwasz&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=80aae21796&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=80aae21796&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3577&quot; title=&quot;Log4j2 configuration during servlet context initialization does not work on Websphere Liberty appserver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3577&quot;&gt;LOG4J2-3577&lt;/a&gt; Use classloader provided by servlet context&lt;/p&gt;

&lt;p&gt;Since we advertise a Servlet 4.0 requirement, we can use&lt;br/&gt;
`ServletContext#getClassLoader()` from Servlet 3.0 to retrieve the&lt;br/&gt;
correct logger context for the given servlet context.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13048290" name="Log4jWebInitializerImpl.java" size="14468" author="carlfroneberger" created="Thu, 18 Aug 2022 14:01:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 10 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z17v4g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>