<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:39:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-2060] AbstactDatabase appender issue with AsyncLogger</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-2060</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;Log4j2 AsycLogger Implementation with a database appender has an issue.&lt;/p&gt;

&lt;p&gt;As i investigated the async logger mechanism works like that.&lt;/p&gt;

&lt;p&gt;Messages are put into DistruptorRingBuffer&lt;/p&gt;

&lt;p&gt;Than&lt;/p&gt;

&lt;p&gt;&lt;b&gt;RingBufferLogEventHandler&lt;/b&gt;&apos;s &lt;b&gt;onEvent&lt;/b&gt; mehtod is called and message is passed to appender asyncronously.&lt;/p&gt;

&lt;p&gt;In &lt;b&gt;AbstractDatabaseAppender&lt;/b&gt; case&lt;/p&gt;

&lt;p&gt;The messages also put into an &lt;b&gt;ArrayList&lt;/b&gt; to make batches for bulk insert to table.&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; void append(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; LogEvent event) {
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.readLock.lock();
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getManager().write(event);
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; LoggingException e) {
        LOGGER.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to write to database [{}] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; appender [{}].&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getManager().getName(),
                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getName(), e);
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Exception e) {
        LOGGER.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to write to database [{}] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; appender [{}].&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getManager().getName(),
                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getName(), e);
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AppenderLoggingException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unable to write to database in appender: &quot;&lt;/span&gt; + e.getMessage(), e);
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.readLock.unlock();
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Than &lt;b&gt;Abstract Database Manager&lt;/b&gt; puts &lt;b&gt;LogEvent&lt;/b&gt; into &lt;b&gt;ArrayList&lt;/b&gt;&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void write(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; LogEvent event) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.bufferSize &amp;gt; 0) {

        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.buffer.add(event);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.buffer.size() &amp;gt;= &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.bufferSize || event.isEndOfBatch()) {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.flush();
        }
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.connectAndStart();
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.writeInternal(event);
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.commitAndClose();
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;After that correspoding &lt;b&gt;LogEvent&lt;/b&gt; object can be re-used in the &lt;b&gt;DistruptorRingBuffer&lt;/b&gt; mechanism.&lt;/p&gt;

&lt;p&gt;When a delay happens in the database the &lt;b&gt;LogEvent&lt;/b&gt; objects are overriden with same referance which causes inconsitency while preparing batches.&lt;/p&gt;

&lt;p&gt;I believe this points to a bug or design problem. &lt;/p&gt;

&lt;p&gt;I would like to contribute solution if anyone can guide where to start what might be the possible design.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13105967">LOG4J2-2060</key>
            <summary>AbstactDatabase appender issue with AsyncLogger</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="kavukcutolga">Tolga Kavukcu</reporter>
                        <labels>
                    </labels>
                <created>Fri, 29 Sep 2017 06:09:07 +0000</created>
                <updated>Mon, 4 Dec 2017 05:20:44 +0000</updated>
                            <resolved>Mon, 23 Oct 2017 23:11:09 +0000</resolved>
                                    <version>2.8.1</version>
                    <version>2.8.2</version>
                                    <fixVersion>2.10.0</fixVersion>
                                    <component>Appenders</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16192744" author="kavukcutolga" created="Thu, 5 Oct 2017 11:04:25 +0000"  >&lt;p&gt;Hi is there any idea or suggestion for this ticket ?&lt;/p&gt;</comment>
                            <comment id="16193245" author="remkop@yahoo.com" created="Thu, 5 Oct 2017 17:29:53 +0000"  >&lt;p&gt;You are correct.&lt;/p&gt;

&lt;p&gt;AbstractDatabaseManager should not keep a reference to the LogEvent since it is mutable and will be reused.&lt;br/&gt;
Instead it should make a copy with &lt;tt&gt;event.toImmutable()&lt;/tt&gt; and store that copy in the list.&lt;/p&gt;

&lt;p&gt;Do you think you would be able to submit a patch or a pull request with a failing unit test demonstrating the problem? That would be very helpful.&lt;/p&gt;</comment>
                            <comment id="16193453" author="kavukcutolga" created="Thu, 5 Oct 2017 19:04:01 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=remkop%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;remkop@yahoo.com&quot;&gt;remkop@yahoo.com&lt;/a&gt; i will test it with problematic unit tomorrow, if it becomes successful surely i can provide the patch.&lt;/p&gt;</comment>
                            <comment id="16196617" author="kavukcutolga" created="Mon, 9 Oct 2017 08:06:15 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;The &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
event.toImmutable()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;change fixes the override issue. But seems like this will have effect on performance. We are benchmarking the fix. After that i will provide an update.&lt;/p&gt;</comment>
                            <comment id="16197066" author="remkop@yahoo.com" created="Mon, 9 Oct 2017 14:35:23 +0000"  >&lt;p&gt;Glad you were able to confirm that the problem cannot be reproduced when the result of calling &lt;tt&gt;toImmutable&lt;/tt&gt; is stored in the list instead of the raw event. &lt;/p&gt;

&lt;p&gt;For what it&apos;s worth, I doubt you&apos;ll see much difference in performance since I would expect the JDBC driver to have more performance impact than creating a few more objects in memory. &lt;/p&gt;

&lt;p&gt;It would be great if you could provide a test that fails with the old code (Log4j 2.9.1) and passes after the &lt;tt&gt;toImmutable&lt;/tt&gt; change. &lt;/p&gt;</comment>
                            <comment id="16199870" author="kavukcutolga" created="Wed, 11 Oct 2017 06:41:56 +0000"  >&lt;p&gt;Sure i can provide the unit test case.&lt;/p&gt;</comment>
                            <comment id="16205112" author="jira-bot" created="Sun, 15 Oct 2017 13:35:11 +0000"  >&lt;p&gt;Commit 334667c7acc2955e157572bfa3b8d0272a8f1495 in logging-log4j2&apos;s branch refs/heads/master from rpopma&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=334667c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=334667c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2060&quot; title=&quot;AbstactDatabase appender issue with AsyncLogger&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2060&quot;&gt;&lt;del&gt;LOG4J2-2060&lt;/del&gt;&lt;/a&gt; AbstractDatabaseManager should make a copy of LogEvents before holding references to them: AsyncLogger log events are mutable&lt;/p&gt;</comment>
                            <comment id="16205113" author="remkop@yahoo.com" created="Sun, 15 Oct 2017 13:36:30 +0000"  >&lt;p&gt;I&apos;ve committed a fix to master. It would be great if you could provide a unit test if you have a chance.&lt;/p&gt;</comment>
                            <comment id="16207769" author="jira-bot" created="Tue, 17 Oct 2017 15:23:02 +0000"  >&lt;p&gt;Commit ecc2d35a4d3a90327d8a490edbd00ec8bfaeaea3 in logging-log4j2&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=garydgregory&quot; class=&quot;user-hover&quot; rel=&quot;garydgregory&quot;&gt;garydgregory&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=ecc2d35&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=ecc2d35&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Revert &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2060&quot; title=&quot;AbstactDatabase appender issue with AsyncLogger&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2060&quot;&gt;&lt;del&gt;LOG4J2-2060&lt;/del&gt;&lt;/a&gt; AbstractDatabaseManager should make a copy of LogEvents before holding references to them: AsyncLogger log events are mutable&quot;&lt;/p&gt;

&lt;p&gt;This reverts commit 334667c7acc2955e157572bfa3b8d0272a8f1495.&lt;/p&gt;</comment>
                            <comment id="16207771" author="jira-bot" created="Tue, 17 Oct 2017 15:23:06 +0000"  >&lt;p&gt;Commit 247c91d01cb4563cc4615eafd81fff5133b44b84 in logging-log4j2&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=garydgregory&quot; class=&quot;user-hover&quot; rel=&quot;garydgregory&quot;&gt;garydgregory&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=247c91d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=247c91d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2078&quot; title=&quot;Update LMAX disruptor from 3.3.6 to 3.3.7&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2078&quot;&gt;&lt;del&gt;LOG4J2-2078&lt;/del&gt;&lt;/a&gt; Update LMAX disruptor from 3.3.6 to 3.3.7. Note that in&lt;br/&gt;
order to get a passing build with &apos;mvn clean install&apos; I had to revert in&lt;br/&gt;
the previous commit the changes for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2060&quot; title=&quot;AbstactDatabase appender issue with AsyncLogger&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2060&quot;&gt;&lt;del&gt;LOG4J2-2060&lt;/del&gt;&lt;/a&gt; AbstractDatabaseManager&lt;br/&gt;
should make a copy of LogEvents before holding references to them:&lt;br/&gt;
AsyncLogger log events are mutable.&lt;/p&gt;</comment>
                            <comment id="16215262" author="jira-bot" created="Mon, 23 Oct 2017 15:06:01 +0000"  >&lt;p&gt;Commit 798e625147ef90514cc99a7d1ffdec1b38167a0a in logging-log4j2&apos;s branch refs/heads/master from rpopma&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=798e625&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=798e625&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2060&quot; title=&quot;AbstactDatabase appender issue with AsyncLogger&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2060&quot;&gt;&lt;del&gt;LOG4J2-2060&lt;/del&gt;&lt;/a&gt; AbstractDatabaseManager should make a copy of LogEvents before holding references to them: AsyncLogger log events are mutable&lt;/p&gt;

&lt;p&gt;Reverting commit that causes Test failures in log4j-taglib&lt;/p&gt;</comment>
                            <comment id="16216017" author="remkop@yahoo.com" created="Mon, 23 Oct 2017 23:11:09 +0000"  >&lt;p&gt;Fixed in master.&lt;br/&gt;
Please verify and close.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13122485">LOG4J2-2140</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 4 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3kp93:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>