<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:43:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-3621] Log4J 2.19 breaks contract of order of loading of System Properties</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-3621</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/742&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This change&lt;/a&gt; broke one of our systems on upgrading to 2.19.&lt;/p&gt;

&lt;p&gt;In our applications we had both LOG4J_CONFIGURATION_FILE environment variable as well as log4j.configurationFile system property set.&lt;/p&gt;

&lt;p&gt;In version 2.17.2 &quot;log4j.configurationFile&quot; gets priority vs in 2.19 &quot;LOG4J_CONFIGURATION_FILE&quot; gets priority. This also breaks the contract mentioned in the &lt;a href=&quot;https://logging.apache.org/log4j/2.x/manual/configuration.html#SystemProperties&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;documentation&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;This is happening because of the normalization code here, &lt;a href=&quot;https://github.com/apache/logging-log4j2/blob/release-2.x/log4j-api/src/main/java/org/apache/logging/log4j/util/PropertiesUtil.java#L503-L526&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/blob/release-2.x/log4j-api/src/main/java/org/apache/logging/log4j/util/PropertiesUtil.java#L503-L526&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When we are trying to normalize, we are checking if the source contains the normalKey. In case both log4j.configurationFile and LOG4J_CONFIGURATION_FILE are present, the following sequence happens,&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;log4j.configurationFile does not get inserted into the normalized map because the normal key is log4j2.configurationFile which is not present in the SystemPropertiesSource.&lt;/li&gt;
	&lt;li&gt;Then when we hit the EnvironmentPropertiesSource, log4j.configurationFile is normalized to LOG4J_CONFIGURATION_FILE and then an entry is made in the normalized map with key = log4j.configurationFile, but value of LOG4J_CONFIGURATION_FILE.&lt;/li&gt;
	&lt;li&gt;During look up with first look into normalized map, so now we got the wrong value (EnvironmentVariable instead of SystemProperty).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am aware changing &quot;log4j.configurationFile&quot; to &quot;log4j2.configurationFile&quot; can fix the issue, however this is clearly a backward incompatible change which will require this change across a lot of consumers who want to upgrade to log4j 2.19&lt;/p&gt;

&lt;p&gt;I can think of two ways to fix this,&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;We make an entry into the normalized map with the actual key if the normalized key is not present in the source, OR&lt;/li&gt;
	&lt;li&gt;While fetching we prefer literal map over normalized map.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Would like to know which of the approaches would be better, can raise a PR accordingly.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13486869">LOG4J2-3621</key>
            <summary>Log4J 2.19 breaks contract of order of loading of System Properties</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="adwsingh">Adwait Kumar Singh</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Oct 2022 15:36:14 +0000</created>
                <updated>Tue, 7 Feb 2023 18:24:34 +0000</updated>
                            <resolved>Tue, 7 Feb 2023 18:24:34 +0000</resolved>
                                    <version>2.19.0</version>
                    <version>2.19.1</version>
                                    <fixVersion>2.20.0</fixVersion>
                                    <component>Configuration</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17619693" author="pkarwasz" created="Tue, 18 Oct 2022 16:29:14 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adwsingh&quot; class=&quot;user-hover&quot; rel=&quot;adwsingh&quot;&gt;adwsingh&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;When implementing &lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3366&quot; title=&quot;Fix order of property sources&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3366&quot;&gt;&lt;del&gt;LOG4J2-3366&lt;/del&gt;&lt;/a&gt;&lt;/tt&gt; I didn&apos;t give much thought on how to order the legacy properties, because the first reported issue concerning property ordering is quite recent (&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3193&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;LOG4J2-3193&lt;/a&gt;) and the actual order differed from the documented one for a long time.&lt;/p&gt;

&lt;p&gt;Personally I don&apos;t have a strong opinion on where to put legacy properties, but I would prefer for them to have a lower priority than their normalized forms.&lt;/p&gt;

&lt;p&gt;Given the recent tendency to evaluate Log4j2 properties lazily (e.g. &lt;a href=&quot;https://github.com/apache/logging-log4j2/commit/258fd0c6cfaa27f7d64b6626c6a866b52eda3dc5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this recent commit&lt;/a&gt;) and the terrible performance of the &lt;tt&gt;PropertiesUtilOrderTest&lt;/tt&gt; (which reloads the cache multiple times for Java system properties that are never used) I might propose a third option:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;we can get rid of the preemptive property cache and cache property values when they are first accessed (if they are ever accessed): this would allow us to replace the cache maps with a single one and simplify the ordering logic (one method instead of two).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For the solution above to work with our current unit tests, we need to introduce a property (e.g. &lt;tt&gt;log4j2.disablePropertyCaching&lt;/tt&gt;) to disable property caching (and many headaches) in the test suite.&lt;/p&gt;</comment>
                            <comment id="17619752" author="adwsingh" created="Tue, 18 Oct 2022 19:39:50 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkarwasz&quot; class=&quot;user-hover&quot; rel=&quot;pkarwasz&quot;&gt;pkarwasz&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;Thanks for the quick reply! I had question regarding the preemptive property cache. We can&apos;t get rid of the &lt;tt&gt;tokenized cache&lt;/tt&gt; though right?&lt;/p&gt;

&lt;p&gt;Otherwise for every property look up I would have to go through all the system property keys, tokenize them and check if the tokens match with the given key.&lt;/p&gt;

&lt;p&gt;IMO this would be undesirable.&lt;/p&gt;</comment>
                            <comment id="17619756" author="adwsingh" created="Tue, 18 Oct 2022 19:45:11 +0000"  >&lt;p&gt;Also &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkarwasz&quot; class=&quot;user-hover&quot; rel=&quot;pkarwasz&quot;&gt;pkarwasz&lt;/a&gt;, regarding the property ordering, we seemed to have broken users who relied on &lt;tt&gt;priority of legacy properties &amp;lt; environment variables&lt;/tt&gt;. We would be fixing it here, but we would be breaking anyone who took a dependency on the reverse i.e &lt;tt&gt;priority of legacy properties &amp;gt; environment variables&lt;/tt&gt; in 2.19. &lt;/p&gt;

&lt;p&gt;So wanted to check what would be the release plan for this, would we release it in 2.20 or a minor version of 2.19. Also I think it would be a good idea to call out this behaviour in the docs, I can make changes for the same.&lt;/p&gt;</comment>
                            <comment id="17621321" author="pkarwasz" created="Thu, 20 Oct 2022 19:08:32 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adwsingh&quot; class=&quot;user-hover&quot; rel=&quot;adwsingh&quot;&gt;adwsingh&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;In my opinion a breaking change occurs only if the documented order changes. That is what happened between &lt;tt&gt;2.17.2&lt;/tt&gt; and &lt;tt&gt;2.18.0&lt;/tt&gt;: the documented order changed from &quot;environment variables &amp;lt; log4j2.component.properties &amp;lt; system properties&quot; to &quot;system properties &amp;lt; environment variables &amp;lt; log4j2.component.properties&quot;. Changes that fix the code to behave as documented are just bug fixes.&lt;/p&gt;

&lt;p&gt;So if you change from &quot;system properties &amp;lt; environment variables &amp;lt; legacy system properties&quot; to &quot;system properties &amp;lt; legacy system properties &amp;lt; environment variables&quot;, that is a bug fix. If someone relies on the bug (as you did in 2.17.2 when the doc said the &lt;tt&gt;LOG4J_CONFIGURATION_FILE&lt;/tt&gt; overrides &lt;tt&gt;log4j.configurationFile&lt;/tt&gt;), he will need to change his configuration.&lt;/p&gt;

&lt;p&gt;Regarding the token-based cache: in 2.17.2 it was necessary, because the normalized cache was broken. The Log4j2 code always performs lookups using &lt;b&gt;legacy&lt;/b&gt; property names, while the normalized cache used normalized keys. A lookup for &lt;tt&gt;log4j.configurationFile&lt;/tt&gt; in the normalized cache was always a miss and the code would fall back on the token-based cache.&lt;/p&gt;

&lt;p&gt;This has been fixed in 2.18.0: the normalized cache uses legacy names as keys and values corresponding to normalized keys as values. The token-based cache should not be necessary.&lt;/p&gt;

&lt;p&gt;That said: if you want to keep the preemptive caching of all properties, I would keep also the token-based cache. If you want to remove the preemptive cache and cache property values when they are looked up for the first time I think we can forget about tokens.&lt;/p&gt;

&lt;p&gt;Remark: most of the property lookups return &lt;tt&gt;null&lt;/tt&gt;, so caching both positive and negative results would be a performance improvement. E.g. we can use a &lt;tt&gt;Map&amp;lt;String, Optional&amp;lt;String&amp;gt;&amp;gt;&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17684303" author="adwsingh" created="Sun, 5 Feb 2023 13:24:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkarwasz&quot; class=&quot;user-hover&quot; rel=&quot;pkarwasz&quot;&gt;pkarwasz&lt;/a&gt; I am hesistant to change the preemptive cache behaviour as I am breaking some other tests. I can maybe try to fix it another time.&lt;/p&gt;

&lt;p&gt;For now in order to have legacy system properties have priority over Environment Variables, can I use a simpler approach of creating a new &lt;tt&gt;LegacySystemPropertiesSource&lt;/tt&gt; which would have priority of 1 ?&lt;/p&gt;</comment>
                            <comment id="17684343" author="pkarwasz" created="Sun, 5 Feb 2023 19:24:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adwsingh&quot; class=&quot;user-hover&quot; rel=&quot;adwsingh&quot;&gt;adwsingh&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;The loop in &lt;tt&gt;Environment#get&lt;/tt&gt; uses the correct ordering between legacy and normalized system properties.&lt;/p&gt;

&lt;p&gt;I think that you can just keep two caches: &lt;tt&gt;literal&lt;/tt&gt; and &lt;tt&gt;tokenized&lt;/tt&gt;. The &lt;tt&gt;tokenized&lt;/tt&gt; cache should work the same way it works now, but the &lt;tt&gt;literal&lt;/tt&gt; cache should map each key to the value obtained through:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; get(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; key, Set&amp;lt;PropertySource&amp;gt; sources) {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;CharSequence&amp;gt; tokens = PropertySource.Util.tokenize(key);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!tokens.isEmpty()) {
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; PropertySource source : sources) {
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; normalKey = Objects.toString(source.getNormalForm(tokens), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (normalKey != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; source.containsProperty(normalKey)) {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; source.getProperty(normalKey);
            }
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (source.containsProperty(key)) {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; source.getProperty(key);
            }
        }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17685193" author="adwsingh" created="Tue, 7 Feb 2023 10:05:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pkarwasz&quot; class=&quot;user-hover&quot; rel=&quot;pkarwasz&quot;&gt;pkarwasz&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I went via another approach, please see &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/1268&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/1268&lt;/a&gt;. I couldn&apos;t get my modified &lt;tt&gt;PropertiesUtilOrderTest#testOrderOfNormalizedProperties&lt;/tt&gt; to pass with your suggested changes.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13412549">LOG4J2-3193</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13424847">LOG4J2-3366</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 40 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z19gsw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>