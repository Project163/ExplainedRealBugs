<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:32:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-531] Rolled log files overwritten by RollingFile appender with composite time and size based policies</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-531</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;We have a system which generates high volume logs which are required to be preserved for audit purposes, and have been having problems with files being unexpectedly overwritten.&lt;/p&gt;

&lt;p&gt;We are using a RollingFile appender with day granularity, time based and size based triggering policies, and a rollover strategy with a suitably large max value.&lt;/p&gt;

&lt;p&gt;I have created a simple test case with minute granularity to quickly illustrate the problem, which is v. similar to the example given in the documentation:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class LogTest
{
    private static final Logger logger = LogManager.getLogger(&quot;TestLogger&quot;);

    public static void main(String[] args) throws Exception
    {
        for (long i=0; ; i+=1) {
            logger.debug(&quot;Sequence: &quot; + i);
            Thread.sleep(250);
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;... with a config of:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;
&amp;lt;Configuration&amp;gt;
    &amp;lt;Appenders&amp;gt;
        &amp;lt;RollingFile name=&quot;Test&quot; fileName=&quot;logs/test.log&quot; filePattern=&quot;logs/test/$${date:yyyyMMddHHmm}/TEST-%d{yyyyMMddHHmm}-%i.log.gz&quot;&amp;gt;
            &amp;lt;PatternLayout pattern=&quot;%d %p (%t) [%c] - %m%n&quot;/&amp;gt;
            &amp;lt;Policies&amp;gt;
                &amp;lt;TimeBasedTriggeringPolicy /&amp;gt;
                &amp;lt;SizeBasedTriggeringPolicy size=&quot;1 KB&quot;/&amp;gt;
            &amp;lt;/Policies&amp;gt;
            &amp;lt;DefaultRolloverStrategy max=&quot;999999&quot;/&amp;gt;
        &amp;lt;/RollingFile&amp;gt;
    &amp;lt;/Appenders&amp;gt;
    &amp;lt;Loggers&amp;gt;
        &amp;lt;Root level=&quot;debug&quot;&amp;gt;
            &amp;lt;AppenderRef ref=&quot;Test&quot;/&amp;gt;
        &amp;lt;/Root&amp;gt;
    &amp;lt;/Loggers&amp;gt;
&amp;lt;/Configuration&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If this is run as is many of the rollover logfiles have other files written over them and are lost, as can clearly be seen by the gaps in the remaining sequence numbers, and the order the sequence numbers appear in the resulting files.&lt;/p&gt;

&lt;p&gt;If the time based policy is removed from the config and it is re-run then all sequence numbers are correctly stored and in the expected order., Without the time based trigger some are carried over into the folder for the next period which is not ideal, though is what we are using at present to avoid data loss.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu 12.04 and 13.04, java version &quot;1.7.0_51&quot;&lt;/p&gt;</environment>
        <key id="12693898">LOG4J2-531</key>
            <summary>Rolled log files overwritten by RollingFile appender with composite time and size based policies</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="geoffballinger">Geoff Ballinger</reporter>
                        <labels>
                    </labels>
                <created>Fri, 7 Feb 2014 14:27:35 +0000</created>
                <updated>Mon, 17 Feb 2020 18:00:14 +0000</updated>
                            <resolved>Sun, 9 Feb 2014 15:48:11 +0000</resolved>
                                    <version>2.0-beta9</version>
                                    <fixVersion>2.0-rc1</fixVersion>
                                    <component>Appenders</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13895779" author="jvz" created="Sat, 8 Feb 2014 23:56:20 +0000"  >&lt;p&gt;Can confirm this bug using trunk. The results I get when I run the provided test as is indicate a loss of the initial 64 log messages, then a loss of 50 message in between each file rollover. This test is comparable to rolling3, but with the addition of a default rollover strategy.&lt;/p&gt;</comment>
                            <comment id="13895783" author="jvz" created="Sun, 9 Feb 2014 00:29:45 +0000"  >&lt;p&gt;My mistake. If you look at the RollingAppenderTimeAndSizeTest along with its generated files, you&apos;ll see the bug described in the report. It looks like that test will have to be updated once this problem is fixed.&lt;/p&gt;</comment>
                            <comment id="13895828" author="remkop@yahoo.com" created="Sun, 9 Feb 2014 04:27:55 +0000"  >&lt;p&gt;Geoff, just a preliminary update (still investigating): &lt;br/&gt;
because &lt;tt&gt;DefaultRolloverStrategy&lt;/tt&gt; is configured with &lt;tt&gt;max=&quot;999999&quot;&lt;/tt&gt;, the rollover logic will allow for up to 1 million files with the same timestamp (but a different %i index if the rollover was triggered by the size threshold). Within the same time window, the rollover logic will then ensure that no more than &lt;tt&gt;max&lt;/tt&gt; files are created, and if the max has been reached, then the logic will remove the oldest file and rename all other indexed files to make room for the new one.&lt;br/&gt;
(See &lt;a href=&quot;http://logging.apache.org/log4j/2.x/manual/appenders.html#DefaultRolloverStrategy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DefaultRolloverStrategy&lt;/a&gt;.)&lt;/p&gt;

&lt;p&gt;Why is this relevant? The logic above is implemented as a loop that will count down from 999999 to 1 (almost 1 million times), and call &lt;tt&gt;if (new File(format(pattern, i)).exists()) ...&lt;/tt&gt; in order to check if such a file exists and needs to be renamed.&lt;/p&gt;

&lt;p&gt;I suspect that accessing the disk so often will take significant time, and that the first rollover action is not complete yet when other threads have logged enough to trigger the next rollover, and that these overlapping rollover actions cause the problem you are seeing.&lt;/p&gt;

&lt;p&gt;If I am correct, the problem can be worked around by creating a smaller time window, configuring a larger &lt;tt&gt;size&lt;/tt&gt; for &lt;tt&gt;SizeBasedTriggeringPolicy&lt;/tt&gt; so you can configure a smaller value for &lt;tt&gt;max&lt;/tt&gt; in &lt;tt&gt;DefaultRolloverStrategy&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I will continue investigating and update later.&lt;/p&gt;</comment>
                            <comment id="13895846" author="remkop@yahoo.com" created="Sun, 9 Feb 2014 06:39:03 +0000"  >&lt;p&gt;Update: on my home laptop a rollover takes 5 minutes: that is how long it takes to call &lt;tt&gt;File.exists()&lt;/tt&gt; 1 million times (and that machine has a fairly fast SSD drive).&lt;/p&gt;

&lt;p&gt;However, this does not explain the loss of the initial zip file. That seems to be caused by a bug in the archive renaming logic. Here is what I&apos;ve found so far. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2014-02-09 14:42:29,365 DEBUG (main) [log4j2_531.LogTest] - Sequence: 0
2014-02-09 14:42:29,617 DEBUG (main) [log4j2_531.LogTest] - Sequence: 1
2014-02-09 14:42:29,868 DEBUG (main) [log4j2_531.LogTest] - Sequence: 2
2014-02-09 14:42:30,119 DEBUG (main) [log4j2_531.LogTest] - Sequence: 3
2014-02-09 14:42:30,370 DEBUG (main) [log4j2_531.LogTest] - Sequence: 4
2014-02-09 14:42:30,620 DEBUG (main) [log4j2_531.LogTest] - Sequence: 5
2014-02-09 14:42:30,871 DEBUG (main) [log4j2_531.LogTest] - Sequence: 6
2014-02-09 14:42:31,122 DEBUG (main) [log4j2_531.LogTest] - Sequence: 7
2014-02-09 14:42:31,372 DEBUG (main) [log4j2_531.LogTest] - Sequence: 8
2014-02-09 14:42:31,623 DEBUG (main) [log4j2_531.LogTest] - Sequence: 9
2014-02-09 14:42:31,874 DEBUG (main) [log4j2_531.LogTest] - Sequence: 10
2014-02-09 14:42:32,125 DEBUG (main) [log4j2_531.LogTest] - Sequence: 11
2014-02-09 14:42:32,376 DEBUG (main) [log4j2_531.LogTest] - Sequence: 12
2014-02-09 14:42:32,627 DEBUG (main) [log4j2_531.LogTest] - Sequence: 13
2014-02-09 14:47:24,372 TRACE DefaultRolloverStrategy.purge() took 291.484612529 seconds
2014-02-09 14:42:32,879 DEBUG (main) [log4j2_531.LogTest] - Sequence: 14
2014-02-09 14:52:16,386 TRACE DefaultRolloverStrategy.purge() took 291.746054955 seconds
2014-02-09 14:47:24,630 DEBUG (main) [log4j2_531.LogTest] - Sequence: 15
2014-02-09 14:57:09,710 TRACE DefaultRolloverStrategy.purge() took 293.05872818 seconds
2014-02-09 14:52:16,642 DEBUG (main) [log4j2_531.LogTest] - Sequence: 16
2014-02-09 15:02:03,915 TRACE DefaultRolloverStrategy.purge() took 293.942685691 seconds
2014-02-09 14:57:09,964 DEBUG (main) [log4j2_531.LogTest] - Sequence: 17
2014-02-09 15:06:58,657 TRACE DefaultRolloverStrategy.purge() took 294.479377825 seconds
2014-02-09 15:02:04,170 DEBUG (main) [log4j2_531.LogTest] - Sequence: 18
2014-02-09 15:11:55,732 TRACE DefaultRolloverStrategy.purge() took 296.808908234 seconds
2014-02-09 15:06:58,914 DEBUG (main) [log4j2_531.LogTest] - Sequence: 19
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
	&lt;li&gt;14:47 rollover creates &lt;tt&gt;TEST-201402091447-1.log.zip&lt;/tt&gt; - contains 14 lines with Sequence 0-13&lt;/li&gt;
	&lt;li&gt;14:52 rollover creates &lt;tt&gt;TEST-201402091442-1.log.zip&lt;/tt&gt; - contains 1 line with Sequence 14&lt;/li&gt;
	&lt;li&gt;14:57 rollover &lt;b&gt;overwrites&lt;/b&gt; &lt;tt&gt;TEST-201402091447-1.log.zip&lt;/tt&gt; - contains 1 line with Sequence 15&lt;/li&gt;
	&lt;li&gt;15:02 rollover creates &lt;tt&gt;TEST-201402091452-1.log.zip&lt;/tt&gt; - contains 1 line with Sequence 16&lt;/li&gt;
	&lt;li&gt;15:07 rollover creates &lt;tt&gt;TEST-201402091457-1.log.zip&lt;/tt&gt; - contains 1 line with Sequence 17&lt;/li&gt;
	&lt;li&gt;15:11 rollover creates &lt;tt&gt;TEST-201402091502-1.log.zip&lt;/tt&gt; - contains 1 line with Sequence 18&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;em&gt;(to be continued)&lt;/em&gt;&lt;/p&gt;</comment>
                            <comment id="13895869" author="geoffballinger" created="Sun, 9 Feb 2014 10:11:26 +0000"  >&lt;p&gt;Thanks for the updates Remko, in particular the comment on the effect of the &lt;tt&gt;max&lt;/tt&gt; value on the rollover time which we will definitely take into account going forward.&lt;/p&gt;

&lt;p&gt;For background we originally observed the issue on a system running with a vanilla &lt;tt&gt;DefaultRolloverStrategy&lt;/tt&gt; (i.e. max=7) but with a &lt;tt&gt;size&lt;/tt&gt; of 1GB. This would have been much quicker to find the next available filename but I guess much slower to do the rollover due to gzip&apos;ing 1GB of data.&lt;/p&gt;

&lt;p&gt;Also we never observed the issue on the first day the system ran, only on the second and subsequent days, though we haven&apos;t repeated it enough times to be absolutely confident that wasn&apos;t just coincidental.&lt;/p&gt;

&lt;p&gt;wrt your observation of a 5 minute rollover time I had observed that they were slow but they are nothing like that slow on my dev system - more like 2-3 seconds. I am using a very vanilla office desktop - i5 w/ a single HDD - running Ubuntu 13.04. Maybe an OS difference?,&lt;/p&gt;

&lt;p&gt;Geoff.&lt;/p&gt;</comment>
                            <comment id="13895903" author="remkop@yahoo.com" created="Sun, 9 Feb 2014 14:49:42 +0000"  >&lt;p&gt;Well, this is a nasty one... Sorry if what follows is a long story, but it has taken me all day to figure this out.&lt;/p&gt;

&lt;p&gt;At rollover, the name of the archive file is based on a date format and an index (assuming both TimeBased and SizeBased triggering).&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The index is determined based on a scan of the target directory.&lt;/li&gt;
	&lt;li&gt;The date-time is &lt;em&gt;not&lt;/em&gt; the current date-time, but the date-time of the &lt;em&gt;previous&lt;/em&gt; rollover.&lt;br/&gt;
This is by design: for example, if you roll over once a day, you want the archive containing Wednesday&apos;s log files to be called &quot;Wednesday.log.zip&quot;, even if the rollover happens on Thursday at midnight.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This behaviour is implemented in &lt;tt&gt;PatternProcessor&lt;/tt&gt; (the class responsible for producing the post-rollover file name) by remembering the previous rollover time in an instance variable.&lt;/p&gt;

&lt;p&gt;The current implementation assumes that rollover will not take longer than the rollover period specified in the date format. Since the &lt;tt&gt;DefaultRolloverStrategy&lt;/tt&gt; is configured with &lt;tt&gt;max=999999&lt;/tt&gt;, and a directory scan takes 5 minutes, this assumption no longer holds: we are supposed to roll over every minute but the rollover process takes five minutes.&lt;/p&gt;

&lt;p&gt;This highlights three problems in the current implementation:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;1. Initialization is incorrect&lt;/b&gt; &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;At startup, &lt;tt&gt;PatternProcessor.prevFileTime&lt;/tt&gt; (the field storing previous rollover time) is not initialized (its value is copied from &lt;tt&gt;nextFileTime&lt;/tt&gt; which is still zero).&lt;/li&gt;
	&lt;li&gt;At the same time, &lt;tt&gt;PatternProcessor.nextFileTime&lt;/tt&gt; is initialized to the log file&apos;s lastModified time (for example 10:00).&lt;/li&gt;
	&lt;li&gt;For the first rollover, the directory is scanned. This completes at 10:05.&lt;/li&gt;
	&lt;li&gt;The archive file is created based on &lt;tt&gt;PatternProcessor.prevFileTime&lt;/tt&gt;. Since this is not initialized yet, the logic falls back to the current time (10:05). &lt;font color=&quot;blue&quot;&gt;Rollover creates archive &amp;lt;...&amp;gt;1005.1.log.zip&lt;/font&gt;&lt;/li&gt;
	&lt;li&gt;The next log event is processed. Event time is 10:00:01, triggering another rollback. Also, &lt;tt&gt;PatternProcessor.nextFileTime&lt;/tt&gt; is copied to &lt;tt&gt;prevFileTime&lt;/tt&gt; and re-initialized to the current time. So, now &lt;tt&gt;prevFileTime=10:00&lt;/tt&gt; and &lt;tt&gt;nextFileTime=10:05&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;For the second rollback, the directory is scanned again. This completes at 10:10.&lt;/li&gt;
	&lt;li&gt;The archive file is created based on &lt;tt&gt;PatternProcessor.prevFileTime&lt;/tt&gt;, which is 10:00. &lt;font color=&quot;red&quot;&gt;Rollover creates archive &amp;lt;...&amp;gt;1000.1.log.zip &lt;b&gt;&lt;em&gt;(And we just went back in time...)&lt;/em&gt;&lt;/b&gt;&lt;/font&gt;&lt;/li&gt;
	&lt;li&gt;The next log event is processed. Event time is 10:00:02, triggering another rollback. Also, &lt;tt&gt;PatternProcessor.nextFileTime&lt;/tt&gt; is copied to &lt;tt&gt;prevFileTime&lt;/tt&gt; and re-initialized to the current time. So, now &lt;tt&gt;prevFileTime=10:05&lt;/tt&gt; and &lt;tt&gt;nextFileTime=10:10&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;For the third rollback, the directory is scanned again. This completes at 10:15.&lt;/li&gt;
	&lt;li&gt;The archive file is created based on &lt;tt&gt;PatternProcessor.prevFileTime&lt;/tt&gt;, which is 10:05. &lt;font color=&quot;red&quot;&gt;Rollover overwrites archive &amp;lt;...&amp;gt;1005.1.log.zip &lt;em&gt;(Overwriting an existing archive file... but that is problem #2, see below.)&lt;/em&gt;&lt;/font&gt;&lt;/li&gt;
	&lt;li&gt;The next log event is processed. Event time is 10:00:03, triggering another rollback. Also, &lt;tt&gt;PatternProcessor.nextFileTime&lt;/tt&gt; is copied to &lt;tt&gt;prevFileTime&lt;/tt&gt; and re-initialized to the current time. So, now &lt;tt&gt;prevFileTime=10:10&lt;/tt&gt; and &lt;tt&gt;nextFileTime=10:15&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;For the third rollback, the directory is scanned again. This completes at 10:20.&lt;/li&gt;
	&lt;li&gt;The archive file is created based on &lt;tt&gt;PatternProcessor.prevFileTime&lt;/tt&gt;, which is 10:10. &lt;font color=&quot;blue&quot;&gt;Rollover creates archive &amp;lt;...&amp;gt;1010.1.log.zip. From here on rollover should work correctly.&lt;/font&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In my opinion, the &lt;tt&gt;PatternProcessor.prevFileTime&lt;/tt&gt; should be initialized to the log file&apos;s last modified time at startup.&lt;br/&gt;
That would prevent the &quot;going back in time&quot; phenomenon we&apos;re seeing above.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;2. Rollover overwrites existing archives&lt;/b&gt;&lt;br/&gt;
If an archive &lt;tt&gt;&amp;lt;datetime&amp;gt;-1.zip&lt;/tt&gt; already exists, I would expect it to be renamed to &lt;tt&gt;&amp;lt;datetime&amp;gt;-2.zip&lt;/tt&gt; before the new archive file is created. This is not happening...&lt;/p&gt;

&lt;p&gt;Ater much digging, I found the reason. The check for existing files is with a different method than the method used to generate the new archive name...&lt;/p&gt;

&lt;p&gt;In our config, &lt;tt&gt;filePattern=&quot;logs/test/$${date:yyyyMMddHHmm}/TEST-%d{yyyyMMddHHmm}-%i.log.zip&quot;&lt;/tt&gt;. Now here is the fun bit: the directory pattern $${date:yyyyMMddHHmm} has two dollar chars and is evaluated dynamically.&lt;/p&gt;

&lt;p&gt;So if our scan starts at 10:10 and we work down from &lt;tt&gt;maxIndex&lt;/tt&gt;, then by the time we reach index 1, five minutes have passed and the logic checks if file &quot;logs/test/20140209&lt;font color=&quot;red&quot;&gt;&lt;b&gt;1015&lt;/b&gt;&lt;/font&gt;/TEST-20140209&lt;font color=&quot;red&quot;&gt;1010&lt;/font&gt;-1.log.zip&quot; exists.&lt;/p&gt;

&lt;p&gt;After the scan the log file is zipped to &quot;logs/test/20140209&lt;font color=&quot;red&quot;&gt;&lt;b&gt;1010&lt;/b&gt;&lt;/font&gt;/TEST-20140209&lt;font color=&quot;red&quot;&gt;1010&lt;/font&gt;-1.log.zip&quot;. This file &lt;em&gt;did&lt;/em&gt; exist but was not found during the scan.&lt;/p&gt;

&lt;p&gt;The fix for this is that the directory scan &lt;b&gt;must&lt;/b&gt; use the same pattern evaluation logic as used to generate the rolled-over archive file name.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;3. Directory scan time linear with &lt;tt&gt;DefaultRolloverStrategy.maxIndex&lt;/tt&gt;&lt;/b&gt;&lt;br/&gt;
Ideally I&apos;d like a faster implementation that does not call &lt;tt&gt;File.exists()&lt;/tt&gt; &lt;tt&gt;maxIndex&lt;/tt&gt; times.&lt;br/&gt;
One alternative implementation would be to build a list of all files in all subdirectories of the top-most directory in the file pattern, and do string-matching on that list.&lt;br/&gt;
This is possible, but not trivial either. I may take a stab at this later.&lt;/p&gt;

&lt;p&gt;I&apos;ll work on solutions for the first two issues.&lt;/p&gt;</comment>
                            <comment id="13895915" author="remkop@yahoo.com" created="Sun, 9 Feb 2014 15:48:11 +0000"  >&lt;p&gt;Fixed in revision 1566302.&lt;br/&gt;
Please verify and close.&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;Changes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;TimeBasedTriggeringPolicy.initialize&lt;/tt&gt; now calls &lt;tt&gt;PatternProcessor.getNextTime&lt;/tt&gt; twice to force initialization of both &lt;tt&gt;prevFileTime&lt;/tt&gt; and &lt;tt&gt;nextFileTime&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;RollingFileManager.createManager&lt;/tt&gt; now calls &lt;tt&gt;File.lastModified()&lt;/tt&gt; &lt;em&gt;after&lt;/em&gt; creating the file, so field &lt;tt&gt;initialTime&lt;/tt&gt; no longer has a value of zero.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;DefaultRolloverStrategy.purgeAscending&lt;/tt&gt; and &lt;tt&gt;purgeDescending&lt;/tt&gt; now use the same &lt;tt&gt;PatternProcessor.formatFileName&lt;/tt&gt; method as the method used to create the rollover file.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;DefaultRolloverStrategy.purgeAscending&lt;/tt&gt; and &lt;tt&gt;purgeDescending&lt;/tt&gt; now emit debug-level status log messages when a file is deleted or renamed.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;PatternProcessor.getNextTime&lt;/tt&gt; now emits trace-level status log messages when its &lt;tt&gt;prevFileTime&lt;/tt&gt; and &lt;tt&gt;nextFileTime&lt;/tt&gt; fields are modified before a rollover.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13895935" author="garydgregory" created="Sun, 9 Feb 2014 17:37:21 +0000"  >&lt;p&gt;Good job digging through all of this! Do we have unit tests now for all of this? Without tests I would have zero confidence touching any of this delicate logic.&lt;/p&gt;</comment>
                            <comment id="13896026" author="remkop@yahoo.com" created="Sun, 9 Feb 2014 20:33:52 +0000"  >&lt;p&gt;I will add JUnit tests for this ASAP. Probably one day from now. Sorry but I won&apos;t be able to do it sooner. &lt;/p&gt;</comment>
                            <comment id="13896031" author="garydgregory" created="Sun, 9 Feb 2014 20:41:43 +0000"  >&lt;p&gt;That&apos;s quite all right Remko &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I just need tests so that when I got in there and hack away (see my proposal on the ML), I can do so with confidence that the tests will back me up.&lt;/p&gt;</comment>
                            <comment id="13896035" author="remkop@yahoo.com" created="Sun, 9 Feb 2014 20:54:23 +0000"  >&lt;p&gt;Understood. I was also thinking to refactor the DefaultRolloverStrategy class when (or before) working on &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-524&quot; title=&quot;Feature request: auto-delete older rolled over files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-524&quot;&gt;&lt;del&gt;LOG4J2-524&lt;/del&gt;&lt;/a&gt;. The current implementation makes unit testing a bit difficult. I probably won&apos;t have time to work on this in the next week or so, so if you want to go first, no problem. &lt;/p&gt;</comment>
                            <comment id="13896038" author="remkop@yahoo.com" created="Sun, 9 Feb 2014 21:00:30 +0000"  >&lt;p&gt;I just re-read your ML message &amp;amp; realized your proposal would also address  &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-524&quot; title=&quot;Feature request: auto-delete older rolled over files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-524&quot;&gt;&lt;del&gt;LOG4J2-524&lt;/del&gt;&lt;/a&gt;. Cool! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13896139" author="remkop@yahoo.com" created="Mon, 10 Feb 2014 01:13:56 +0000"  >&lt;p&gt;Geoff, the fix just made it into the 2.0-rc1 release. It will take a few days for the team to verify the release and the artifacts to get published to the mirrors. Meanwhile, you can verify the fix with the artifacts staged here: &lt;a href=&quot;https://repository.apache.org/content/repositories/orgapachelogging-1002/org/apache/logging/log4j/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/orgapachelogging-1002/org/apache/logging/log4j/&lt;/a&gt;&lt;br/&gt;
(or you can build from trunk, or course).&lt;/p&gt;</comment>
                            <comment id="13896639" author="geoffballinger" created="Mon, 10 Feb 2014 15:06:41 +0000"  >&lt;p&gt;I can confirm that using your staged artefacts log files / lines are no longer being lost which is the main thing!&lt;/p&gt;

&lt;p&gt;The distribution of the log files into the folders is a bit odd however and it feels like there might be a flaw in the timestamp logic in there somewhere still.&lt;/p&gt;

&lt;p&gt;I kicked off the test run at &lt;tt&gt;14:29:11&lt;/tt&gt; using my example setup from the first post above more or less as is - but with a more sensible &lt;tt&gt;max=99&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The initial folder created was &lt;tt&gt;201402101429&lt;/tt&gt; and contained 27 numbered files prefixed &lt;tt&gt;TEST-201402101429-&lt;/tt&gt;. Numbers 1-12 contained 16 log lines each with timestamps &lt;tt&gt;14:29:11,667&lt;/tt&gt; to &lt;tt&gt;14:29:59,649&lt;/tt&gt;, number 13 a single log line with timestamp &lt;tt&gt;14:29:59,899&lt;/tt&gt;, and numbers 14-27 again contain 16 lines each with timestamps &lt;tt&gt;14:30:00,164&lt;/tt&gt; to &lt;tt&gt;14:30:56,155&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The second folder created was &lt;tt&gt;201402101430&lt;/tt&gt; and contained 15 numbered files. The first file contained 15 log lines with timestamps &lt;tt&gt;14:30:56,405&lt;/tt&gt; to &lt;tt&gt;14:30:59,919&lt;/tt&gt;. The subsequent files contained 16 log lines each with timestamps &lt;tt&gt;14:31:00,170&lt;/tt&gt; to &lt;tt&gt;14:31:56,123&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The third folder created was &lt;tt&gt;201402101431&lt;/tt&gt;. The first file contained 15 log lines with timestamps &lt;tt&gt;14:31:56,373&lt;/tt&gt; to &lt;tt&gt;14:31:59,886&lt;/tt&gt;. The subsequent files contained 16 log lines each with timestamps from &lt;tt&gt;14:32:00,136&lt;/tt&gt; onwards.&lt;/p&gt;

&lt;p&gt;So in summary after the first minute the majority of log lines from minute X end up in the folder for minute X-1. The exception are the last file of lines which end up in the correct folder.&lt;/p&gt;

&lt;p&gt;Geoff.&lt;/p&gt;</comment>
                            <comment id="13896737" author="remkop@yahoo.com" created="Mon, 10 Feb 2014 16:32:18 +0000"  >&lt;p&gt;Geoff, thanks first of all for confirming that the main problem is solved.&lt;/p&gt;

&lt;p&gt;Also thanks for pointing out that there may still be issues. I&apos;ll take another look with the &lt;tt&gt;max=99&lt;/tt&gt; setting. I suspect the problem you pointed out has to do with the time taken by the rollover, but would need to check. &lt;br/&gt;
(It is certainly an interesting scenario: rolling over that many times within the same minute. I&apos;m curious if it will lead us to other hidden flaws in the rollover implementation.)&lt;/p&gt;</comment>
                            <comment id="13897677" author="geoffballinger" created="Tue, 11 Feb 2014 09:40:18 +0000"  >&lt;p&gt;Fair comment wrt the unrealistic settings so I adjusted it to roll every hour and every 64kb (i.e. expect similar number of files per folder):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;?xml version=&lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt; encoding=&lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;?&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;Configuration&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;Appenders&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;RollingFile name=&lt;span class=&quot;code-quote&quot;&gt;&quot;Test&quot;&lt;/span&gt; fileName=&lt;span class=&quot;code-quote&quot;&gt;&quot;logs/test.log&quot;&lt;/span&gt; filePattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;logs/test/$${date:yyyyMMddHH}/TEST-%d{yyyyMMddHH}-%i.log.gz&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;PatternLayout pattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;%d %p (%t) [%c] - %m%n&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;Policies&amp;gt;&lt;/span&gt;
                &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;TimeBasedTriggeringPolicy /&amp;gt;&lt;/span&gt;
                &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;SizeBasedTriggeringPolicy size=&lt;span class=&quot;code-quote&quot;&gt;&quot;64 KB&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/Policies&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;DefaultRolloverStrategy max=&lt;span class=&quot;code-quote&quot;&gt;&quot;99&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/RollingFile&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/Appenders&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;Loggers&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;Root level=&lt;span class=&quot;code-quote&quot;&gt;&quot;debug&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;AppenderRef ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;Test&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/Root&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/Loggers&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/Configuration&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Running this overnight gave a similar pattern, e.g. the folder for &lt;tt&gt;2014021100&lt;/tt&gt; contains one file with timestamps &lt;tt&gt;00:59:42,836&lt;/tt&gt; to &lt;tt&gt;00:59:59,851&lt;/tt&gt;, and then 15 others covering timestamps &lt;tt&gt;01:00:00,101&lt;/tt&gt; to &lt;tt&gt;01:59:24,196&lt;/tt&gt;. Only the last file&apos;s worth for each hour (the one rotated based on time) is in the correct folder, and the rest (rotated based on size) are in the previous hour&apos;s folder.&lt;/p&gt;

&lt;p&gt;Geoff.&lt;/p&gt;</comment>
                            <comment id="13897721" author="remkop@yahoo.com" created="Tue, 11 Feb 2014 10:53:56 +0000"  >&lt;p&gt;Geoff, If you don&apos;t mind, I would like to close this issue (seeing that the title/description issue of data loss has been resolved). If you disagree, please feel free to re-open this issue.&lt;/p&gt;

&lt;p&gt;I&apos;ve started a new ticket (&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-535&quot; title=&quot;Rolled log files end up in the wrong directory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-535&quot;&gt;&lt;del&gt;LOG4J2-535&lt;/del&gt;&lt;/a&gt;) for the new issue you found. I&apos;ve tentatively called it &quot;Rolled log files end up in the wrong directory&quot; and used your last comment as the issue description, but please feel free to edit the title, description and anything else as you see fit.&lt;/p&gt;

&lt;p&gt;Best regards, -Remko&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12670913">LOG4J2-412</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12694460">LOG4J2-535</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13285832">LOG4J2-2784</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>372407</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 41 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1s6hb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>372711</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>