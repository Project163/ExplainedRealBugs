<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:33:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-903] ClassLoaderContextSelector uses ClassLoader.toString() as a key</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-903</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;&lt;tt&gt;org.apache.logging.log4j.core.selector.ClassLoaderContextSelector.locateContext(ClassLoader, URI)&lt;/tt&gt; uses the &lt;tt&gt;ClassLoader.toString()&lt;/tt&gt; as a key to find a context in the &lt;tt&gt;CONTEXT_MAP&lt;/tt&gt;. However, there are cases in which this string may change with time, for the same class loader instance.&lt;/p&gt;

&lt;p&gt;The example is the Tomcat class loader, which changes its &lt;tt&gt;toString()&lt;/tt&gt; value whenever a transformer is added (to do load time weaving).&lt;br/&gt;
I discovered this when I encountered the problem described at:&lt;br/&gt;
&lt;a href=&quot;http://stackoverflow.com/questions/27016854/tomcatloadtimeweaver-breaks-log4j-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/27016854/tomcatloadtimeweaver-breaks-log4j-2&lt;/a&gt;&lt;br/&gt;
This phenomenon leads to the webapp completely &quot;lose&quot; the Log4j configuration.&lt;/p&gt;

&lt;p&gt;I think the &lt;tt&gt;hashCode()&lt;/tt&gt; or even the &lt;tt&gt;System.identityHashCode()&lt;/tt&gt; should better fit the necessity to reliably retrieve a context associated with a class loader. And what about using the class loader itself as the map key?&lt;/p&gt;

&lt;p&gt;By the way, the use of a &lt;tt&gt;WeakReference&lt;/tt&gt; further concerns me about the reliability of the context lookup when the memory pressure is high...&lt;/p&gt;</description>
                <environment></environment>
        <key id="12756428">LOG4J2-903</key>
            <summary>ClassLoaderContextSelector uses ClassLoader.toString() as a key</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mauromol">Mauro Molinari</reporter>
                        <labels>
                    </labels>
                <created>Wed, 19 Nov 2014 15:43:51 +0000</created>
                <updated>Mon, 23 Feb 2015 10:40:22 +0000</updated>
                            <resolved>Wed, 26 Nov 2014 16:31:46 +0000</resolved>
                                    <version>2.1</version>
                                    <fixVersion>2.2</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14218146" author="ralph.goers@dslextreme.com" created="Wed, 19 Nov 2014 17:04:26 +0000"  >&lt;p&gt;Thanks for the info on how Tomcat behaves. I think your solution makes sense.&lt;/p&gt;

&lt;p&gt;A WeakReference is used to allow undeployment to work. The weak reference won&apos;t cause the LoggerContext or the ClassLoader to be garbage collected under memory pressure as they each have other hard references to them. It simply allows the ClassLoader to be released when the web app is undeployed. Of course, the LoggerContext should be shutdown when this happens as well.&lt;/p&gt;</comment>
                            <comment id="14226043" author="mauromol" created="Wed, 26 Nov 2014 11:17:48 +0000"  >&lt;p&gt;Hi Ralph,&lt;br/&gt;
thanks for your feedback. Do you think a fix for the &lt;tt&gt;LoggerContext&lt;/tt&gt; lookup could be provided soon? Because currently Log4j 2 can&apos;t be used reliably in Tomcat whenever load time weaving is used.&lt;/p&gt;</comment>
                            <comment id="14226189" author="garydgregory" created="Wed, 26 Nov 2014 13:47:05 +0000"  >&lt;p&gt;Can you try the latest from git master? I pushed changes but forgot to update this ticket.&lt;/p&gt;</comment>
                            <comment id="14333192" author="mauromol" created="Mon, 23 Feb 2015 10:40:22 +0000"  >&lt;p&gt;Fix verified in current 2.2-SNAPSHOT, built on 20141218.142019-11.&lt;br/&gt;
Thank you! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 39 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i22k7r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>