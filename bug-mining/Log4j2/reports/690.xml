<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:35:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1221] Dead lock observed in BlockingWaitStrategy in Log4J</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1221</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;We have seen this behavior in during high load. Where Logging Got Stropped and Application Went to not responsive state.&lt;br/&gt;
log4J Version : 2.2 Disruptor Version : 3.3.2&lt;br/&gt;
Ring Buffer Size : 128&lt;br/&gt;
Producer(Multiples Threads) and Consumer Threads(Single Thread As per Log 4J Configuration) Started Waiting on each other.&lt;/p&gt;

&lt;p&gt;Here is the one of the Trace from Thread Dump:&lt;/p&gt;

&lt;p&gt;Producer : &lt;br/&gt;
&quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;ACTIVE&amp;#93;&lt;/span&gt; ExecuteThread: &apos;7&apos; for queue: &apos;weblogic.kernel.Default (self-tuning)&apos;&quot; TIMED_WAITING&lt;br/&gt;
sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:349)&lt;br/&gt;
com.lmax.disruptor.MultiProducerSequencer.next(MultiProducerSequencer.java:136)&lt;br/&gt;
com.lmax.disruptor.MultiProducerSequencer.next(MultiProducerSequencer.java:105)&lt;br/&gt;
com.lmax.disruptor.RingBuffer.publishEvent(RingBuffer.java:444)&lt;br/&gt;
com.lmax.disruptor.dsl.Disruptor.publishEvent(Disruptor.java:256)&lt;br/&gt;
org.apache.logging.log4j.core.async.AsyncLogger.logMessage(AsyncLogger.java:285)&lt;br/&gt;
org.apache.logging.log4j.spi.AbstractLogger.logMessage(AbstractLogger.java:722)&lt;br/&gt;
org.apache.logging.log4j.spi.AbstractLogger.logIfEnabled(AbstractLogger.java:693)&lt;br/&gt;
org.apache.logging.log4j.jcl.Log4jLog.debug(Log4jLog.java:81)&lt;/p&gt;

&lt;p&gt;Consumer Thread :&lt;/p&gt;

&lt;p&gt;&quot;AsyncLogger-1&quot; waiting for lock java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@5d972983 WAITING&lt;br/&gt;
sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)&lt;br/&gt;
java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2043)&lt;br/&gt;
com.lmax.disruptor.BlockingWaitStrategy.waitFor(BlockingWaitStrategy.java:45)&lt;br/&gt;
com.lmax.disruptor.ProcessingSequenceBarrier.waitFor(ProcessingSequenceBarrier.java:55)&lt;br/&gt;
com.lmax.disruptor.BatchEventProcessor.run(BatchEventProcessor.java:123)&lt;br/&gt;
java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
java.lang.Thread.run(Thread.java:744)&lt;/p&gt;

&lt;p&gt;Is this is known issue which got already fixed in recent build ?&lt;/p&gt;</description>
                <environment>&lt;p&gt;log4J Version : 2.2 Disruptor Version : 3.3.2&lt;br/&gt;
Ring Buffer Size : 128&lt;br/&gt;
OS Version :&lt;br/&gt;
cat /etc/release&lt;br/&gt;
Oracle Solaris 11.2 X86&lt;br/&gt;
Java Version&lt;br/&gt;
java version &quot;1.7.0_45&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.7.0_45-b18)&lt;br/&gt;
Java HotSpot(TM) Server VM (build 24.45-b08, mixed mode)&lt;/p&gt;</environment>
        <key id="12921097">LOG4J2-1221</key>
            <summary>Dead lock observed in BlockingWaitStrategy in Log4J</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="sakumar">Sampath Kumar</reporter>
                        <labels>
                            <label>patch</label>
                    </labels>
                <created>Fri, 11 Dec 2015 16:43:52 +0000</created>
                <updated>Fri, 8 Apr 2016 08:11:39 +0000</updated>
                            <resolved>Wed, 23 Dec 2015 14:14:35 +0000</resolved>
                                    <version>2.2</version>
                                    <fixVersion>2.6</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15053006" author="garydgregory" created="Fri, 11 Dec 2015 16:54:47 +0000"  >&lt;p&gt;Can you test with our latest version 2.5?&lt;/p&gt;</comment>
                            <comment id="15053014" author="sakumar" created="Fri, 11 Dec 2015 16:58:25 +0000"  >&lt;p&gt;Can you tell me what is changes done to resolve this issue ? I hope you have visited &lt;a href=&quot;https://github.com/LMAX-Exchange/disruptor/issues/138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/LMAX-Exchange/disruptor/issues/138&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15053030" author="garydgregory" created="Fri, 11 Dec 2015 17:07:10 +0000"  >&lt;p&gt;I am telling you about our version 2.5 because it is very unlikely that we would release a new version based on 2.2 like a 2.2.1.&lt;/p&gt;

&lt;p&gt;If there is code to change it is most likely that this would happen in a 2.5.1 or 2.6.&lt;/p&gt;

&lt;p&gt;It is also possible that we might release 2.3.x version for users that require Java 6 instead of 7, which has been the new platform requirement since 2.4.&lt;/p&gt;</comment>
                            <comment id="15053045" author="sakumar" created="Fri, 11 Dec 2015 17:22:26 +0000"  >&lt;p&gt;I am OK to move 2.5 but problem is I am not sure how LMAX disruptor went to dead lock condition. How to simulate exact scenario. This occurred once during high load. &lt;/p&gt;

&lt;p&gt;LMAX Disruptor is a Ring Buffer which works on Sequence Number to avoid locking during consume and produce.&lt;/p&gt;

&lt;p&gt;Below is the response I have from LMAX Disruptor Github issue tracker &lt;/p&gt;

&lt;p&gt;&quot;You may also think about raising an enhancement request for Log4j to use the non-blocking calls to push to the Disruptor (RingBuffer.tryPublishEvent()), that way if the consumer is blocked the main application won&apos;t fail.&quot;&lt;/p&gt;

&lt;p&gt;Hence I request you to go through the above external link to get more info &lt;/p&gt;
</comment>
                            <comment id="15053116" author="ralph.goers@dslextreme.com" created="Fri, 11 Dec 2015 18:01:49 +0000"  >&lt;p&gt;Looking at the issue you raised with the disruptor team they haven&apos;t identified anything we might be doing incorrectly. As you said, the did suggest using the non-blocking calls to avoid a deadlock but I am not sure how we would handle that if it fails.&lt;/p&gt;</comment>
                            <comment id="15053174" author="sakumar" created="Fri, 11 Dec 2015 18:41:15 +0000"  >&lt;p&gt;I agree that this is a issue with LMAX disruptor. But its not good to wait till disruptor complete the analysis. This issue will be critical for any application which is using log4j for Async logging since only available recovery is restart.&lt;/p&gt;</comment>
                            <comment id="15053702" author="remkop@yahoo.com" created="Fri, 11 Dec 2015 22:34:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sakumar&quot; class=&quot;user-hover&quot; rel=&quot;sakumar&quot;&gt;sakumar&lt;/a&gt;, can you provide your full log4j2.xml configuration?&lt;/p&gt;</comment>
                            <comment id="15053771" author="remkop@yahoo.com" created="Fri, 11 Dec 2015 23:21:42 +0000"  >&lt;p&gt;I am thinking to treat this as a special case of &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1080&quot; title=&quot;Drop events when the RingBuffer is full&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1080&quot;&gt;&lt;del&gt;LOG4J2-1080&lt;/del&gt;&lt;/a&gt;, so the solution for that issue will also address this issue. &lt;/p&gt;</comment>
                            <comment id="15054090" author="sakumar" created="Sat, 12 Dec 2015 06:44:47 +0000"  >&lt;p&gt;Nope this is not resolved  by dropping the events. Ring Buffer Works on Producer and Consumer Thread Model.This issue actually happened due to signal missed by consumer. As per LMAX disruptor signal miss should not happen. However they are suspecting Solaris OS because of Native Calls happening for Park and UnPark.&lt;/p&gt;</comment>
                            <comment id="15054198" author="remkop@yahoo.com" created="Sat, 12 Dec 2015 10:09:05 +0000"  >&lt;p&gt;What do you propose?&lt;/p&gt;</comment>
                            <comment id="15054222" author="sakumar" created="Sat, 12 Dec 2015 10:43:36 +0000"  >&lt;p&gt;My Proposals are here&lt;/p&gt;

&lt;p&gt;1. Either Make use of Non Blocking Ring Buffer Call RingBuffer.tryPublishEvent() or Modify LMAX Disruptor BlockingWaitStrategy to Conditional Timed Waiting.&lt;br/&gt;
2. Avoid Unnecessary Filling up the Buffer by Third Party Libraries for which appender is not defined(Ref :  &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1080&quot; title=&quot;Drop events when the RingBuffer is full&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1080&quot;&gt;&lt;del&gt;LOG4J2-1080&lt;/del&gt;&lt;/a&gt;)&lt;br/&gt;
3.Develop Plugin Design for Ring Buffer so that application can inject their customized ring buffer instead tightly coupling with LMAX Disruptor.&lt;/p&gt;</comment>
                            <comment id="15054230" author="remkop@yahoo.com" created="Sat, 12 Dec 2015 11:09:46 +0000"  >&lt;ol&gt;
	&lt;li&gt;What do you propose to do when &lt;tt&gt;RingBuffer.tryPublishEvent()&lt;/tt&gt; returns false?
	&lt;ul&gt;
		&lt;li&gt;You are free to fork the Disruptor and make the timed waiting change.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;I saw your comment on that ticket but I am not sure I understand it. Can you please raise a separate Jira ticket and provide more detail there?&lt;/li&gt;
	&lt;li&gt;I am not enthusiastic about this idea. Even if you provide a patch that accomplishes this I&apos;m not sure I would support adding it to log4j.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15054260" author="sakumar" created="Sat, 12 Dec 2015 11:55:55 +0000"  >&lt;p&gt;I see  that this can be used for Enhancement Request for  &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1080&quot; title=&quot;Drop events when the RingBuffer is full&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1080&quot;&gt;&lt;del&gt;LOG4J2-1080&lt;/del&gt;&lt;/a&gt;  RingBuffer.tryPublishEvent()} for instead of dropping the event from Log 4J end if Flag enabled at appender level.&lt;/p&gt;

&lt;p&gt;What you suggest ?&lt;/p&gt;</comment>
                            <comment id="15054269" author="remkop@yahoo.com" created="Sat, 12 Dec 2015 12:27:55 +0000"  >&lt;p&gt;When the buffer is 100% full the only options I can think of is to either drop the event or to log the event synchronously (send it to the appender directly).&lt;/p&gt;

&lt;p&gt;I noticed that you configured the ring buffer size to 128. This is extremely small, and you will find the ring buffer filling up rapidly when the appender cannot keep up with bursts of log events. So your buffer will nearly always be full. In that case, dropping events is probably not what you want here, but logging synchronously to deal with a full buffer kind of defeats the purpose of using Async Loggers... I would recommend a much larger queue size.&lt;/p&gt;</comment>
                            <comment id="15054277" author="sakumar" created="Sat, 12 Dec 2015 12:40:11 +0000"  >&lt;p&gt;We need to check implementation of RingBuffer to confirm behaviour of RingBuffer.tryPublishEvent()  drop the event. If the same behaviour as expected by &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1080&quot; title=&quot;Drop events when the RingBuffer is full&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1080&quot;&gt;&lt;del&gt;LOG4J2-1080&lt;/del&gt;&lt;/a&gt; we can achieve using this API, I recommend to use this API if its return false  drop the event or to log the event synchronously (send it to the appender directly).This solves both Dead Lock Issue and Buffer Full Performance issue.&lt;/p&gt;

&lt;p&gt;I agree that this buffer size is too small. This can cause performance issue but no one accept application to go for dead lock !!. We will modify it to default 256.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Sakumar&lt;/p&gt;</comment>
                            <comment id="15054316" author="remkop@yahoo.com" created="Sat, 12 Dec 2015 13:30:38 +0000"  >&lt;p&gt;FYI, the default ring buffer size is 262144 (256*1024). I recommend you don&apos;t specify a size at all, so you get this default.&lt;/p&gt;

&lt;p&gt;The problem I have with this issue is that a full ring buffer usually does not indicate a problem. It simply means that the producers are logging faster than the appender can keep up with. The Disruptor&apos;s design (fixed buffer size) is to make the producers wait for a free slot to become available, so that the appender can catch up.&lt;/p&gt;

&lt;p&gt;I understand that the deadlock is a serious issue, but since the cause seems to be with the Disruptor (on Solaris), I am still not 100% convinced that we should have a special fix for it in log4j. At the very least I want to keep the normal behaviour as I described above. I need to think about this more.&lt;/p&gt;

&lt;p&gt;Have you asked Mike Barker (who maintains the Disruptor) if he can add a timed wait in the BlockingWaitStrategy?&lt;/p&gt;</comment>
                            <comment id="15054329" author="sakumar" created="Sat, 12 Dec 2015 13:46:40 +0000"  >&lt;p&gt;Yes i asked him to add a timed wait in the BlockingWaitStrategy. But he&lt;br/&gt;
also concerned that it will be work around, RCA will be unknown by adding&lt;br/&gt;
that fix. He is trying to simulate similar behaviour in unit test.&lt;/p&gt;

&lt;p&gt;Regarding your concern I would like to understand more about Disruptor,&lt;br/&gt;
will go through the implementation of disruptor.&lt;/p&gt;





&lt;p&gt;&amp;#8211; &lt;br/&gt;
Regards,&lt;br/&gt;
Sampath&lt;/p&gt;</comment>
                            <comment id="15065412" author="remkop@yahoo.com" created="Sat, 19 Dec 2015 15:40:08 +0000"  >&lt;p&gt;The solution for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1080&quot; title=&quot;Drop events when the RingBuffer is full&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1080&quot;&gt;&lt;del&gt;LOG4J2-1080&lt;/del&gt;&lt;/a&gt; that I am currently implementing will allow you to drop events above a certain level (which could be all events) when the ring buffer remaining capacity is below a certain percentage.&lt;/p&gt;

&lt;p&gt;By providing a custom implementation of a certain interface you can also stop using the background thread and log on the application thread when the ring buffer is full.&lt;/p&gt;</comment>
                            <comment id="15065421" author="sakumar" created="Sat, 19 Dec 2015 16:06:12 +0000"  >&lt;p&gt;Is Proposed solution completely avoids the dead lock ? if not we need to track this as separate defect. &lt;br/&gt;
Below are additional changes i am proposing&lt;br/&gt;
1.Suppose Application doesn&apos;t want to drop the events,log4j should provides default implementation for logging through Sync&lt;br/&gt;
2.log4j should notifies the application set buffer size is not optimum through some warning log to application console.&lt;/p&gt;

</comment>
                            <comment id="15065537" author="ralph.goers@dslextreme.com" created="Sat, 19 Dec 2015 21:14:35 +0000"  >&lt;p&gt;If you want synchronous behavior don&apos;t use asynchronous loggers.&lt;/p&gt;

&lt;p&gt;I would imagine that once the buffer reaches some threshold it should log something to the status logger.&lt;/p&gt;</comment>
                            <comment id="15065556" author="remkop@yahoo.com" created="Sat, 19 Dec 2015 22:40:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sakumar&quot; class=&quot;user-hover&quot; rel=&quot;sakumar&quot;&gt;sakumar&lt;/a&gt; Can you please provide your full log4j2.xml configuration? I need it to construct a test case for Mike Barker who maintains the disruptor. &lt;/p&gt;</comment>
                            <comment id="15065654" author="sakumar" created="Sun, 20 Dec 2015 07:41:02 +0000"  >&lt;p&gt;@Remko Popma I am OOO now. I will provide our application log4j2.xml configuration once I available in office. Mean while i am thinking can we avoid using different strategy AsyncLogger.WaitStrategy like Sleep. Our application uses Block, we chose this approach to avoid more CPU utilization. As per log4j async logging supports 3 types of waitstrategy block, sleep, yield. Do you have any perfomance test case to verify what is the percentage difference between CPU utilization in all of above strategies ?&lt;/p&gt;</comment>
                            <comment id="15065753" author="remkop@yahoo.com" created="Sun, 20 Dec 2015 13:27:54 +0000"  >&lt;p&gt;Take a look at the source code of /log4j-core/src/test/java/org/apache/logging/log4j/core/async/perftest/PerfTestDriver.java&lt;br/&gt;
and other classes in that package.&lt;/p&gt;</comment>
                            <comment id="15065772" author="sakumar" created="Sun, 20 Dec 2015 14:08:40 +0000"  >&lt;p&gt;Thanks Remko Popma. I will run this test cases in my development setup, to&lt;br/&gt;
confirm CPU utilization between Sleep and BLOCK waiting strategies.&lt;/p&gt;





&lt;p&gt;&amp;#8211; &lt;br/&gt;
Regards,&lt;br/&gt;
Sampath&lt;/p&gt;</comment>
                            <comment id="15065780" author="remkop@yahoo.com" created="Sun, 20 Dec 2015 14:32:17 +0000"  >&lt;p&gt;No worries.&lt;/p&gt;

&lt;p&gt;Also, consider using AsyncAppender instead of async loggers. This uses a simple BlockingQueue instead of the Disruptor.&lt;/p&gt;</comment>
                            <comment id="15065786" author="sakumar" created="Sun, 20 Dec 2015 14:43:40 +0000"  >&lt;p&gt;But only concern here is using BlockingQueue performance should not&lt;br/&gt;
degrade. As per performance result published by LMAX there is lot of&lt;br/&gt;
throughput difference between Disruptor and Blocking Queue.&lt;/p&gt;





&lt;p&gt;&amp;#8211; &lt;br/&gt;
Regards,&lt;br/&gt;
Sampath&lt;/p&gt;</comment>
                            <comment id="15066492" author="sakumar" created="Mon, 21 Dec 2015 14:24:33 +0000"  >&lt;p&gt;Why miss match in document and code ? is this is expected ?&lt;/p&gt;

&lt;p&gt;Document says AsyncLogger.WaitStrategy	Sleep --&amp;gt; Default Link &lt;a href=&quot;https://logging.apache.org/log4j/2.x/manual/async.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://logging.apache.org/log4j/2.x/manual/async.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Code : DisruptorUtil&lt;br/&gt;
static WaitStrategy createWaitStrategy(final String propertyName) {&lt;br/&gt;
        final String strategy = PropertiesUtil.getProperties().getStringProperty(propertyName);&lt;br/&gt;
        if (strategy != null) {&lt;br/&gt;
            LOGGER.trace(&quot;property {}={}&quot;, propertyName, strategy);&lt;br/&gt;
            if (&quot;Sleep&quot;.equalsIgnoreCase(strategy)) &lt;/p&gt;
{
                return new SleepingWaitStrategy();
            }
&lt;p&gt; else if (&quot;Yield&quot;.equalsIgnoreCase(strategy)) &lt;/p&gt;
{
                return new YieldingWaitStrategy();
            }
&lt;p&gt; else if (&quot;Block&quot;.equalsIgnoreCase(strategy)) &lt;/p&gt;
{
                return new BlockingWaitStrategy();
            }
&lt;p&gt;        }&lt;br/&gt;
        return new BlockingWaitStrategy();&lt;br/&gt;
    }&lt;/p&gt;</comment>
                            <comment id="15066496" author="remkop@yahoo.com" created="Mon, 21 Dec 2015 14:32:21 +0000"  >&lt;p&gt;Docs are out of sync. Thanks for the reminder.&lt;/p&gt;

&lt;p&gt;BTW, please attach your log4j2.xml config when you have a chance.&lt;/p&gt;</comment>
                            <comment id="15066506" author="sakumar" created="Mon, 21 Dec 2015 14:40:40 +0000"  >&lt;p&gt;Sure Tomorrow i will be in office. Will attach it by tomorrow EOD.&lt;/p&gt;</comment>
                            <comment id="15066670" author="sakumar" created="Mon, 21 Dec 2015 16:38:36 +0000"  >&lt;p&gt;Do you have Jira issue to track this Document mismatch ?&lt;/p&gt;</comment>
                            <comment id="15067155" author="remkop@yahoo.com" created="Mon, 21 Dec 2015 22:14:12 +0000"  >&lt;p&gt;I just fixed &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1212&quot; title=&quot;Update documentation of defaults for AsyncLogger.WaitStrategy AsyncLoggerConfig.WaitStrategy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1212&quot;&gt;&lt;del&gt;LOG4J2-1212&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15067883" author="sakumar" created="Tue, 22 Dec 2015 10:02:21 +0000"  >&lt;p&gt;Attached Log 4J  XML Configuration&lt;/p&gt;</comment>
                            <comment id="15069661" author="remkop@yahoo.com" created="Wed, 23 Dec 2015 14:14:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sakumar&quot; class=&quot;user-hover&quot; rel=&quot;sakumar&quot;&gt;sakumar&lt;/a&gt; Since the problem seems to be in the Disruptor library (&lt;a href=&quot;https://github.com/LMAX-Exchange/disruptor/issues/138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/LMAX-Exchange/disruptor/issues/138&lt;/a&gt;) there is a limit to what can be done in log4j. I did notice that the problem occurred when an extremely small ring buffer size (128) was configured and I strongly recommend using the much larger default ring buffer size; I think that will vastly reduce the chance of the problem happening again.&lt;/p&gt;

&lt;p&gt;On top of that, you can now determine what happens when the ring buffer is full. Please take a look at the &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1080?focusedCommentId=15069634&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15069634&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;solution for LOG4J2 -1080&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;You can use this to create a workaround for your issue as follows.&lt;/p&gt;

&lt;p&gt;For example, if you want to start logging events synchronously when the ring buffer is full, you can do the following:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;set system property &lt;tt&gt;log4j2.AsyncEventRouter&lt;/tt&gt; to value &lt;tt&gt;com.mycompany.SampathKumarRouter&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;compile the class below and add it to your classpath&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; com.mycompany;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.logging.log4j.Level;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.logging.log4j.core.async.AsyncEventRouter;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.logging.log4j.core.async.EventRoute;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SampathKumarRouter &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; AsyncEventRouter {
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; EventRoute getRoute(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; backgroundThreadId, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Level level, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; queueSize,
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; queueRemainingCapacity) {
        &lt;span class=&quot;code-comment&quot;&gt;// start logging synchronously when the queue is full, otherwise log asynchronously
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; queueRemainingCapacity == 0 ? EventRoute.SYNCHRONOUS : EventRoute.ENQUEUE;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Please verify and close.&lt;/p&gt;</comment>
                            <comment id="15069682" author="sakumar" created="Wed, 23 Dec 2015 14:40:40 +0000"  >&lt;p&gt;@Remko did you get a chance to reproduce this issue for the given log4j&lt;br/&gt;
configuration ?&lt;/p&gt;</comment>
                            <comment id="15069705" author="remkop@yahoo.com" created="Wed, 23 Dec 2015 15:02:12 +0000"  >&lt;p&gt;No, I haven&apos;t tried. (The configuration file looks okay by the way.)&lt;/p&gt;

&lt;p&gt;Can you reproduce the issue in your environment?&lt;/p&gt;</comment>
                            <comment id="15069711" author="sakumar" created="Wed, 23 Dec 2015 15:05:40 +0000"  >&lt;p&gt;Yes let me try it. After that I will close this issue&lt;/p&gt;





&lt;p&gt;&amp;#8211; &lt;br/&gt;
Regards,&lt;br/&gt;
Sampath&lt;/p&gt;</comment>
                            <comment id="15069749" author="remkop@yahoo.com" created="Wed, 23 Dec 2015 15:33:01 +0000"  >&lt;p&gt;After thinking about this some more, you may want to start logging synchronously a little bit &lt;em&gt;before&lt;/em&gt; the queue is completely full  (to prevent race conditions where multiple threads see a remaining slot in the queue and all try to add an event).&lt;/p&gt;

&lt;p&gt;Here is a slight modification to the above example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; EventRoute getRoute(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; backgroundThreadId, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Level level, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; queueSize,
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; queueRemainingCapacity) {
        &lt;span class=&quot;code-comment&quot;&gt;// start logging synchronously when the queue is 94% full, otherwise log asynchronously
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; queueRemainingCapacity &amp;lt;= fractionOf(queueSize) ? EventRoute.SYNCHRONOUS : EventRoute.ENQUEUE;
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; fractionOf(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; queueSize) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; queueSize &amp;gt;&amp;gt; 4; &lt;span class=&quot;code-comment&quot;&gt;// quick divide by 16:   1/16 ~= 6%
&lt;/span&gt;    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15094961" author="mikeb01" created="Tue, 12 Jan 2016 21:15:43 +0000"  >&lt;p&gt;From the analysis I did on the original Github issue it looks like the Disruptor gets stuck waiting on a notification from the publisher.  It looks like the signal from the condition variable is somehow missed.  I&apos;m still trying to dig into the reasons why this occurred.  I&apos;ve never seen it on Linux, so it could be a problem with the Solaris build of the JDK, the Solaris kernel or a bug in the Disruptor that I&apos;ve missed.  However there is a workaround.  I have a patch for Log4J that allows for the use of the TimeoutBlockingWaitStrategy, which will periodically wake up from the signal.await call.  So if a notification is missed somehow it will recover with a small latency delay (default 10ms).&lt;/p&gt;

&lt;p&gt;I&apos;ve attached the patch to this ticket.&lt;/p&gt;</comment>
                            <comment id="15095119" author="remkop@yahoo.com" created="Tue, 12 Jan 2016 22:36:50 +0000"  >&lt;p&gt;Hi Mike, thanks for the patch. I was not aware of the existence of TimeoutBlockingWaitStrategy.  Given the added safety it would even make sense to make this the default instead of BlockingWait, our current default.&lt;/p&gt;

&lt;p&gt;Our docs currently say that Async Loggers will work with Disruptor-3.0.0 and higher. From which Disruptor version was TimeoutBlockingWaitStrategy added?&lt;/p&gt;</comment>
                            <comment id="15095142" author="mikeb01" created="Tue, 12 Jan 2016 22:48:18 +0000"  >&lt;p&gt;From the changelog, just prior to the release of 3.0.0.&lt;/p&gt;</comment>
                            <comment id="15095567" author="sakumar" created="Wed, 13 Jan 2016 04:08:40 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Can we add fix in this ticket itself by making TimeoutBoundBlockingStrategy&lt;br/&gt;
as default one. I see current ticket in resolved state.&lt;/p&gt;

&lt;p&gt;Best Regards,&lt;br/&gt;
Sakumar&lt;/p&gt;

&lt;p&gt;On Wed, Jan 13, 2016 at 4:18 AM, Michael Barker (JIRA) &amp;lt;jira@apache.org&amp;gt;&lt;/p&gt;




&lt;p&gt;&amp;#8211; &lt;br/&gt;
Regards,&lt;br/&gt;
Sampath&lt;/p&gt;</comment>
                            <comment id="15095765" author="mikeb01" created="Wed, 13 Jan 2016 07:32:11 +0000"  >&lt;p&gt;I&apos;ve modified the patch to make the timeout strategy the default.&lt;/p&gt;</comment>
                            <comment id="15095982" author="remkop@yahoo.com" created="Wed, 13 Jan 2016 10:36:28 +0000"  >&lt;p&gt;Thanks Mike! Patch looks good. I will apply it when I get home.&lt;/p&gt;</comment>
                            <comment id="15096304" author="remkop@yahoo.com" created="Wed, 13 Jan 2016 15:02:31 +0000"  >&lt;p&gt;Patch merged into master with small modifications in commit f9a4b70.&lt;/p&gt;

&lt;p&gt;Thank you Michael!&lt;/p&gt;

&lt;p&gt;Sampath, please verify and close.&lt;/p&gt;</comment>
                            <comment id="15096496" author="ralph.goers@dslextreme.com" created="Wed, 13 Jan 2016 16:37:44 +0000"  >&lt;p&gt;Michael, if there are other issues you would like to submit patches for please know we greatly appreciate the help!&lt;/p&gt;</comment>
                            <comment id="15096510" author="garydgregory" created="Wed, 13 Jan 2016 16:46:52 +0000"  >&lt;p&gt;+1!&lt;/p&gt;</comment>
                            <comment id="15128039" author="sakumar" created="Tue, 2 Feb 2016 10:42:10 +0000"  >&lt;p&gt;Verified and didn&apos;t observe the Dead Lock in Timed Waiting Strategy&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12955692">LOG4J2-1350</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12844024">LOG4J2-1080</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12779024" name="log4j2-test.xml" size="1276" author="sakumar" created="Tue, 22 Dec 2015 10:02:21 +0000"/>
                            <attachment id="12781921" name="timeout_wait_strategy.patch" size="5401" author="mikeb01" created="Tue, 12 Jan 2016 21:15:26 +0000"/>
                            <attachment id="12782013" name="timeout_wait_strategy2.patch" size="5567" author="mikeb01" created="Wed, 13 Jan 2016 07:31:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12311024" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>External issue ID</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>138</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311020" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>External issue URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[https://github.com/LMAX-Exchange/disruptor/issues/138]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 42 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2prwv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>