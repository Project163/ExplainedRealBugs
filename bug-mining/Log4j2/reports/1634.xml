<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:43:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-3357] CronExpression.getTimeBefore() calculates incorrect result</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-3357</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;The method getTimeBefore(targetDate) of org.apache.logging.log4j.core.util.CronExpression incorrectly returns the prevFireTime value sometimes or is called with bad inputs.&lt;/p&gt;

&lt;p&gt;When CronTiggeringPolicy calls this method the targetDate object contains a current time.&lt;br/&gt;
For example, if we have a situation where we want to perform a midnight rollup, the method works differently if the entry time is ... 00:00:00 or ... 00:00:01. This can happen if we have many different logs, all of which we want to roll at the same time (typically midnight). But all &quot;getTimeBefore&quot; won&apos;t make it within 1 second. If the targetDate differs at least one second it causes the different comparison result at line:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; ... &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (prevFireTime.compareTo(targetDateNoMs) &amp;gt;= 0);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Configuration example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
...
&amp;lt;Properties&amp;gt;
&#160; &amp;lt;Property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;filePath&quot;&lt;/span&gt;&amp;gt;logs/l4j2_&amp;lt;/Property&amp;gt;
&#160; &amp;lt;Property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;fileBackupPath&quot;&lt;/span&gt;&amp;gt;logs/bck/l4j2_&amp;lt;/Property&amp;gt;
&#160; &amp;lt;Property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;fileSuffix&quot;&lt;/span&gt;&amp;gt;log.bz2&amp;lt;/Property&amp;gt;
&#160; &amp;lt;Property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;fileDatePattern&quot;&lt;/span&gt;&amp;gt;yyyyMMdd&amp;lt;/Property&amp;gt;
&#160; &amp;lt;Property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;basicPatternLayout&quot;&lt;/span&gt;&amp;gt;%d %-5p [%t] - %m%n&amp;lt;/Property&amp;gt;
&#160; &amp;lt;Property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;hostname&quot;&lt;/span&gt;&amp;gt;HOSTNAME&amp;lt;/Property&amp;gt;
&#160; &amp;lt;Property name=&lt;span class=&quot;code-quote&quot;&gt;&quot;environment&quot;&lt;/span&gt;&amp;gt;ENVIRONMENT&amp;lt;/Property&amp;gt;
&amp;lt;/Properties&amp;gt;
...
&amp;lt;RollingFile name=&lt;span class=&quot;code-quote&quot;&gt;&quot;UNICommonJavaScriptAppender&quot;&lt;/span&gt; fileName=&lt;span class=&quot;code-quote&quot;&gt;&quot;${filePath}uni-javascript.log&quot;&lt;/span&gt; filePattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;${fileBackupPath}uni-javascript-%d{${fileDatePattern}}_%i.${fileSuffix}&quot;&lt;/span&gt;&amp;gt;
&#160; &amp;lt;PatternLayout pattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;${basicPatternLayout}&quot;&lt;/span&gt; /&amp;gt;
&#160; &amp;lt;Policies&amp;gt;
&#160; &#160; &amp;lt;OnStartupTriggeringPolicy /&amp;gt;
&#160; &#160; &amp;lt;CronTriggeringPolicy schedule=&lt;span class=&quot;code-quote&quot;&gt;&quot;0,5 0 0 * * ?&quot;&lt;/span&gt;/&amp;gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;
&#160; &#160; &amp;lt;SizeBasedTriggeringPolicy size=&lt;span class=&quot;code-quote&quot;&gt;&quot;30MB&quot;&lt;/span&gt; /&amp;gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;
&#160; &amp;lt;/Policies&amp;gt;
&#160; &amp;lt;DefaultRolloverStrategy max=&lt;span class=&quot;code-quote&quot;&gt;&quot;50&quot;&lt;/span&gt;&amp;gt;
&#160; &#160; &amp;lt;Delete basePath=&lt;span class=&quot;code-quote&quot;&gt;&quot;logs/bck&quot;&lt;/span&gt; maxDepth=&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;&amp;gt;
&#160; &#160; &#160; &#160; &amp;lt;IfFileName glob=&lt;span class=&quot;code-quote&quot;&gt;&quot;l4j2_uni-javascript*.${fileSuffix}&quot;&lt;/span&gt;&amp;gt;
&#160; &#160; &#160; &#160; &amp;lt;IfAny&amp;gt;
&#160; &#160; &#160; &#160; &#160; &amp;lt;IfAccumulatedFileSize exceeds=&lt;span class=&quot;code-quote&quot;&gt;&quot;200 MB&quot;&lt;/span&gt; /&amp;gt;
&#160; &#160; &#160; &#160; &#160; &amp;lt;IfAccumulatedFileCount exceeds=&lt;span class=&quot;code-quote&quot;&gt;&quot;25&quot;&lt;/span&gt; /&amp;gt;
&#160; &#160; &#160; &#160; &amp;lt;/IfAny&amp;gt;
&#160; &#160; &#160; &amp;lt;/IfFileName&amp;gt;
&#160; &#160; &amp;lt;/Delete&amp;gt;
&#160; &amp;lt;/DefaultRolloverStrategy&amp;gt;
&amp;lt;/RollingFile&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Adding some extra debugging, we can see the behaviour:&lt;br/&gt;
1. targetDate in first second (1/20/22 0:00:00):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[1/20/22 0:00:00:018 CET] 00000186 SystemOut &#160; &#160; O 2022-01-20 00:00:00,018 Log4j2-TF-3-Scheduled-2 DEBUG PV: CronExpression | getTimeBefore - entering 2022-01-20T00:00:00.018+0100
[1/20/22 0:00:00:469 CET] 00000186 SystemOut &#160; &#160; O 2022-01-20 00:00:00,469 Log4j2-TF-3-Scheduled-2 DEBUG PV: CronExpression | getTimeBefore - result 2022-01-19T00:00:05.000+0100
[1/20/22 0:00:00:469 CET] 00000186 SystemOut &#160; &#160; O 2022-01-20 00:00:00,469 Log4j2-TF-3-Scheduled-2 DEBUG PV: RollingFileManager | rollover entered
[1/20/22 0:00:00:469 CET] 00000186 SystemOut &#160; &#160; O 2022-01-20 00:00:00,469 Log4j2-TF-3-Scheduled-2 DEBUG Setting prev file time to 2022-01-19T00:00:05.000+0100
[1/20/22 0:00:00:470 CET] 00000186 SystemOut &#160; &#160; O 2022-01-20 00:00:00,470 Log4j2-TF-3-Scheduled-2 DEBUG Formatting file name. useCurrentTime=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;. currentFileTime=1642546805000, prevFileTime=1642546805000
[1/20/22 0:00:00:470 CET] 00000186 SystemOut &#160; &#160; O 2022-01-20 00:00:00,470 Log4j2-TF-3-Scheduled-2 DEBUG Current file: logs/l4j2_ccm-javascript.log
...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;2. same cron with targetDate in second second (1/20/22 0:00:01):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[1/20/22 0:00:01:365 CET] 0000018d SystemOut &#160; &#160; O 2022-01-20 00:00:01,365 Log4j2-TF-3-Scheduled-9 DEBUG PV: CronExpression | getTimeBefore - entering 2022-01-20T00:00:01.365+0100
[1/20/22 0:00:01:365 CET] 0000018d SystemOut &#160; &#160; O 2022-01-20 00:00:01,365 Log4j2-TF-3-Scheduled-9 DEBUG PV: CronExpression | getTimeBefore - result 2022-01-20T00:00:00.000+0100
[1/20/22 0:00:01:365 CET] 0000018d SystemOut &#160; &#160; O 2022-01-20 00:00:01,365 Log4j2-TF-3-Scheduled-9 DEBUG PV: RollingFileManager | rollover entered
[1/20/22 0:00:01:366 CET] 0000018d SystemOut &#160; &#160; O 2022-01-20 00:00:01,366 Log4j2-TF-3-Scheduled-9 DEBUG Setting prev file time to 2022-01-20T00:00:00.000+0100
[1/20/22 0:00:01:366 CET] 0000018d SystemOut &#160; &#160; O 2022-01-20 00:00:01,366 Log4j2-TF-3-Scheduled-9 DEBUG Formatting file name. useCurrentTime=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;. currentFileTime=1642546805000, prevFileTime=1642633200000
[1/20/22 0:00:01:366 CET] 0000018d SystemOut &#160; &#160; O 2022-01-20 00:00:01,366 Log4j2-TF-3-Scheduled-9 DEBUG Current file: logs/l4j2_uni-perf.log
...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
You can see the difference in value prevFireTime. This issue may be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2575&quot; title=&quot;CronExpression.getTimeBefore() returns incorrect result&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2575&quot;&gt;&lt;del&gt;LOG4J2-2575&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13423921">LOG4J2-3357</key>
            <summary>CronExpression.getTimeBefore() calculates incorrect result</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rgoers">Ralph Goers</assignee>
                                    <reporter username="petrvalenta">Petr Valenta</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 Jan 2022 07:25:45 +0000</created>
                <updated>Tue, 3 Jan 2023 01:13:22 +0000</updated>
                            <resolved>Tue, 3 Jan 2023 01:13:22 +0000</resolved>
                                    <version>2.17.1</version>
                                    <fixVersion>2.20.0</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17537955" author="ralph.goers@dslextreme.com" created="Tue, 17 May 2022 05:57:50 +0000"  >&lt;p&gt;Well, the problem is that the logic for getTimeBefore is working correctly. It did indeed calculate the time the file should have rolled based on the provided time. Will need to think about how to best address this.&lt;/p&gt;</comment>
                            <comment id="17653717" author="ralph.goers@dslextreme.com" created="Tue, 3 Jan 2023 01:12:45 +0000"  >&lt;p&gt;I have made a change that I think will fix this problem but I haven&apos;t figured out how to create a unit test to validate it. Can you please test the fix?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 45 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ysts:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>