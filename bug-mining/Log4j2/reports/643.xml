<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:35:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1176] Memory leak from first loaded web app when log4j jars are in Tomcat&apos;s lib folder</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1176</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;When the log4j2 jar files are in $catalina.home/lib, the first web application that is loaded will be reported by Tomcat as having a memory leak from loaded classes. &lt;/p&gt;

&lt;p&gt;&lt;b&gt;1. Steps to reproduce&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Install Tomcat 7.0.65 afresh&lt;/li&gt;
	&lt;li&gt;Copy log4j-api-2.5-SNAPSHOT.jar, log4j-core-2.5-SNAPSHOT.jar, log4j-web-2.5-SNAPSHOT.jar into $catalina.home/lib.&lt;/li&gt;
	&lt;li&gt;(Optional) place a log4j2.xml config file with status=&quot;true&quot; in $catalina.home/lib. This helps to confirm that the web app which is loaded first causes the warning.&lt;/li&gt;
	&lt;li&gt;Edit $catalina.home/conf/catalina.properties: add &lt;tt&gt;log4j2.disable.jmx=true&lt;/tt&gt; (eliminate JMX as the culprit)&lt;/li&gt;
	&lt;li&gt;Edit $catalina.home/conf/tomcat-users.xml to give yourself permission to access the Tomcat Web App Manager&lt;/li&gt;
	&lt;li&gt;Start Tomcat&lt;/li&gt;
	&lt;li&gt;Open the &lt;a href=&quot;http://localhost:8080/manager/html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Manager App&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Reload the Tomcat Documentation (/docs) web app&lt;/li&gt;
	&lt;li&gt;Click the &quot;Find Leaks&quot; button under Diagnostics at the bottom of the Manager App page&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The following warning is displayed:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The following web applications were stopped (reloaded, undeployed), but their classes from previous runs are still loaded in memory, thus causing a memory leak (use a profiler to confirm):&lt;br/&gt;
/docs&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;b&gt;2. Use custom web app to prove the web app loaded first always has this issue&lt;/b&gt;&lt;br/&gt;
Use the attached web app to test the order of deployment.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Restart Tomcat&lt;/li&gt;
	&lt;li&gt;Deploy web app (containing its own log4j2.xml)&lt;/li&gt;
	&lt;li&gt;Restart Tomcat again (note that the custom web app is loaded first)&lt;/li&gt;
	&lt;li&gt;Reload /docs app: no memory leak&lt;/li&gt;
	&lt;li&gt;Reload /webapp: gives memory leak warning&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Different order:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Undeploy custom web app&lt;/li&gt;
	&lt;li&gt;Restart Tomcat ( /docs web app is loaded first)&lt;/li&gt;
	&lt;li&gt;Deploy custom web app&lt;/li&gt;
	&lt;li&gt;Reload /docs app: gives memory leak warning&lt;/li&gt;
	&lt;li&gt;Reload /webapp: no memory leak&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I have tried to use &lt;a href=&quot;https://eclipse.org/mat/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Eclipse Memory Analyzer&lt;/a&gt; to find out where the leak is, but without success. &lt;/p&gt;

&lt;p&gt;(Note that the problem also happens with the default configuration (when no log4j2.xml config is found), this may narrow things down a little... Perhaps this has something to do with the StatusLogger?)&lt;/p&gt;</description>
                <environment>&lt;p&gt;Tomcat 7.0.50 or Tomcat 7.0.65, jdk1.8.0_51, Win 10&lt;/p&gt;</environment>
        <key id="12907678">LOG4J2-1176</key>
            <summary>Memory leak from first loaded web app when log4j jars are in Tomcat&apos;s lib folder</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="rpopma">Remko Popma</reporter>
                        <labels>
                    </labels>
                <created>Sat, 24 Oct 2015 18:57:20 +0000</created>
                <updated>Sun, 8 Nov 2015 07:17:26 +0000</updated>
                            <resolved>Sun, 8 Nov 2015 06:41:57 +0000</resolved>
                                    <version>2.4.1</version>
                    <version>2.5</version>
                                    <fixVersion>2.5</fixVersion>
                                    <component>Configurators</component>
                    <component>Web/Servlet</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14973826" author="ralph.goers@dslextreme.com" created="Mon, 26 Oct 2015 06:54:57 +0000"  >&lt;p&gt;I would suggest looking at it with Yourkit..&lt;/p&gt;</comment>
                            <comment id="14984384" author="remkop@yahoo.com" created="Sun, 1 Nov 2015 12:30:46 +0000"  >&lt;p&gt;Yourkit is indeed a fine project. We should get an &lt;a href=&quot;https://www.yourkit.com/purchase/#licenses&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;open source license&lt;/a&gt; for it. I finally made some progress on this.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;One leak was caused by the StatusLogger. Objects were retained in the ParameterizedMessage objects kept in the StatusLogger&apos;s bounded queue of StatusData objects. I introduced a special MessageFactory for StatusLogger that does not keep a reference to the parameter objects. (in master in commit abc0f948)&lt;/li&gt;
	&lt;li&gt;Another leak is caused by the design of OutputStreamManager: it has a reference to the layout of the first Appender it was created for. The leak occurs as follows: DefaultConfiguration creates a ConsoleAppender with a PatternLayout. PatternLayout has a reference to its Configuration. As a result, the OutputStreamManager retained in AbstractManager.MAP keeps a reference to the first DefaultConfiguration (whether this config is STOPPED or not).  Fixed in master in commit 38107ece: ConsoleAppenders created for DefaultConfiguration now avoid sharing the same OutputStreamManager.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14984416" author="remkop@yahoo.com" created="Sun, 1 Nov 2015 15:03:42 +0000"  >&lt;p&gt;The problem still occurs after the above changes.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Steps to reproduce&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Install Tomcat 7.0.65 afresh&lt;/li&gt;
	&lt;li&gt;Copy log4j-api-2.5-SNAPSHOT.jar, log4j-core-2.5-SNAPSHOT.jar, log4j-web-2.5-SNAPSHOT.jar into $catalina.home/lib.&lt;/li&gt;
	&lt;li&gt;Remove default webapps &quot;examples&quot;, &quot;host-manager&quot; and &quot;ROOT&quot;, leaving only &quot;docs&quot; and &quot;manager&quot;.&lt;/li&gt;
	&lt;li&gt;Edit $catalina.home/conf/catalina.properties: add &lt;tt&gt;log4j2.disable.jmx=true&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Edit $catalina.home/conf/catalina.properties: add &lt;tt&gt;org.apache.logging.log4j.simplelog.StatusLogger.level=TRACE&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Edit $catalina.home/conf/tomcat-users.xml to give yourself permission to access the Tomcat Web App Manager&lt;/li&gt;
	&lt;li&gt;Start Tomcat&lt;/li&gt;
	&lt;li&gt;Open the &lt;a href=&quot;http://localhost:8080/manager/html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Manager App&lt;/a&gt; and &lt;b&gt;STOP&lt;/b&gt; (not Reload) the Tomcat Documentation (/docs) web app&lt;/li&gt;
	&lt;li&gt;Click the &quot;Find Leaks&quot; button under Diagnostics at the bottom of the Manager App page&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Gives:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The following web applications were stopped (reloaded, undeployed), but their classes from previous runs are still loaded in memory, thus causing a memory leak (use a profiler to confirm):&lt;br/&gt;
/docs&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;FYI, I have tried the below two changes (but the problem still occurred):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Removing constant LoggerContext.NULL_CONFIGURATION&lt;/li&gt;
	&lt;li&gt;Edit $catalina.home/conf/catalina.properties: add &lt;tt&gt;Log4jContextSelector=org.apache.logging.log4j.core.selector.BasicContextSelector&lt;/tt&gt; (this looked like a bad idea: after this change I did not see any StatusLogger output for the /manager webapp starting any more...)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14984420" author="remkop@yahoo.com" created="Sun, 1 Nov 2015 15:25:23 +0000"  >&lt;p&gt;&lt;tt&gt;BasicContextSelector&lt;/tt&gt; works correctly if log4j-web-2.5-SNAPSHOT.jar is removed from $catalina.home/lib. After this, the memory leak warning does not occur with the default /docs webapp.&lt;/p&gt;

&lt;p&gt;However, deploying a simple webapp (like the attached, but without even a log4j2.xml config, so that the simpler DefaultConfiguration is used), and stopping it, resulted in the above memory leak warning again.&lt;/p&gt;</comment>
                            <comment id="14995538" author="remkop@yahoo.com" created="Sun, 8 Nov 2015 06:41:57 +0000"  >&lt;p&gt;I finally found the remaining underlying cause: &lt;tt&gt;org.apache.logging.log4j.spi.Provider&lt;/tt&gt; has a strong reference to the web app ClassLoader that was used to find &lt;tt&gt;log4j-provider.properties&lt;/tt&gt;. &lt;tt&gt;ProviderUtil&lt;/tt&gt; keeps a static reference to a set of all loaded Providers, so the web app&apos;s classloader can not be garbage collected.&lt;/p&gt;

&lt;p&gt;The solution is to wrap the reference to the classloader in Provider in a WeakReference.&lt;/p&gt;

&lt;p&gt;Fixed in commits 83c22472, a02d50b9 and 60dd2265.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12703316">LOG4J2-578</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12768550" name="webapp.war" size="4884" author="rpopma" created="Sat, 24 Oct 2015 18:58:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 2 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2nhdj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>