<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:31:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-291] Failover appender doesn&apos;t fail over on JDBC appender error</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-291</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;When I configure a Failover appender using the jdbc appender as primary and console/file as secondary if I get a database error It prints something to System.err, but not to the file/console as expected.&lt;/p&gt;

&lt;p&gt;How to recreate:&lt;/p&gt;

&lt;p&gt;Make sure a jdbc appender works first.&lt;/p&gt;

&lt;p&gt;Prepare a configuration similar to the one below:&lt;/p&gt;

&lt;p&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;&lt;br/&gt;
&amp;lt;configuration status=&quot;WARN&quot;&amp;gt;&lt;br/&gt;
	&amp;lt;appenders&amp;gt;&lt;br/&gt;
		&amp;lt;Jdbc name=&quot;HubManagerDatabaseLog&quot; tablename=&quot;HUB_MANAGER_LOG&quot;&amp;gt;&lt;br/&gt;
			&amp;lt;ConnectionFactory class=&quot;com.somecompany.server.dal.DalCommon&quot; method=&quot;getDatabaseInstanceConnection&quot;/&amp;gt;&lt;br/&gt;
			&amp;lt;Column name=&quot;LOG_DATE&quot; isEventTimestamp=&quot;true&quot; /&amp;gt;&lt;br/&gt;
			&amp;lt;Column name=&quot;LOG_THREAD&quot; pattern=&quot;%thread&quot; /&amp;gt;&lt;br/&gt;
			&amp;lt;Column name=&quot;LOG_LEVEL&quot; pattern=&quot;%level&quot; /&amp;gt;&lt;br/&gt;
			&amp;lt;Column name=&quot;LOG_CLASS&quot; pattern=&quot;%logger&quot; /&amp;gt;&lt;br/&gt;
			&amp;lt;Column name=&quot;LOG_METHOD&quot; pattern=&quot;%method&quot; /&amp;gt;&lt;br/&gt;
			&amp;lt;Column name=&quot;LOG_MESSAGE&quot; pattern=&quot;%message&quot; /&amp;gt;&lt;br/&gt;
			&amp;lt;Column name=&quot;LOG_EXCEPTION&quot; pattern=&quot;%exception&quot; /&amp;gt;&lt;br/&gt;
		&amp;lt;/Jdbc&amp;gt;&lt;br/&gt;
		&amp;lt;FastRollingFile name=&quot;HubManagerFileLog&quot; filename=&quot;logs/HubManager.log&quot; filePattern=&quot;logs/HubManager-%d&lt;/p&gt;
{COMPACT}
&lt;p&gt;.log&quot;&amp;gt;&lt;br/&gt;
			&amp;lt;PatternLayout pattern=&quot;%d &lt;span class=&quot;error&quot;&gt;&amp;#91;%thread&amp;#93;&lt;/span&gt; %-5level %logger.%method - %message %exception%n&quot; /&amp;gt;&lt;br/&gt;
			&amp;lt;Policies&amp;gt;&lt;br/&gt;
				&amp;lt;SizeBasedTriggeringPolicy size=&quot;5MB&quot;/&amp;gt;&lt;br/&gt;
			&amp;lt;/Policies&amp;gt;&lt;br/&gt;
&amp;lt;!-- 			&amp;lt;DefaultRolloverStrategy max=&quot;50&quot;/&amp;gt; --&amp;gt;&lt;br/&gt;
		&amp;lt;/FastRollingFile&amp;gt;&lt;br/&gt;
		&amp;lt;Console name=&quot;Console&quot; target=&quot;SYSTEM_OUT&quot;&amp;gt;&lt;br/&gt;
			&amp;lt;PatternLayout pattern=&quot;%d &lt;span class=&quot;error&quot;&gt;&amp;#91;%thread&amp;#93;&lt;/span&gt; %-5level %logger.%method - %message %exception%n&quot; /&amp;gt;&lt;br/&gt;
		&amp;lt;/Console&amp;gt;&lt;br/&gt;
		&amp;lt;Failover name=&quot;PrimaryDatabaseLoggingIfFailGoToFile&quot; primary=&quot;HubManagerDatabaseLog&quot; suppressExceptions=&quot;false&quot;&amp;gt;&lt;br/&gt;
			&amp;lt;Failovers&amp;gt;&lt;br/&gt;
				&amp;lt;appender-ref ref=&quot;HubManagerFileLog&quot;/&amp;gt;&lt;br/&gt;
			&amp;lt;/Failovers&amp;gt;&lt;br/&gt;
		&amp;lt;/Failover&amp;gt;&lt;br/&gt;
	&amp;lt;/appenders&amp;gt;&lt;/p&gt;

&lt;p&gt;	&amp;lt;loggers&amp;gt;&lt;br/&gt;
		&amp;lt;logger name=&quot;com.exzac&quot; level=&quot;DEBUG&quot;&amp;gt;&lt;br/&gt;
			&amp;lt;appender-ref ref=&quot;PrimaryDatabaseLoggingIfFailGoToFile&quot;/&amp;gt;&lt;br/&gt;
			&amp;lt;appender-ref ref=&quot;Console&quot;/&amp;gt;&lt;br/&gt;
		&amp;lt;/logger&amp;gt;&lt;br/&gt;
		&amp;lt;root level=&quot;DEBUG&quot;&amp;gt;&lt;br/&gt;
		&amp;lt;/root&amp;gt;&lt;br/&gt;
	&amp;lt;/loggers&amp;gt;&lt;br/&gt;
&amp;lt;/configuration&amp;gt;&lt;/p&gt;

&lt;p&gt;Run the following in a test java class that correctly has the above xml configuration on the build path:&lt;/p&gt;

&lt;p&gt;import org.apache.logging.log4j.LogManager;&lt;br/&gt;
import org.apache.logging.log4j.Logger;&lt;/p&gt;

&lt;p&gt;public class TestFailOverAppender {&lt;br/&gt;
	private static final Logger LOGGER = LogManager.getLogger(TestFailOverAppender.class);&lt;/p&gt;

&lt;p&gt;	public static void main(final String[] args) {&lt;br/&gt;
		final String shortString = &quot;FailOver Short message that should go to database&quot;;&lt;br/&gt;
		LOGGER.info(shortString);&lt;br/&gt;
		final StringBuilder longString = new StringBuilder(shortString);&lt;br/&gt;
		while (longString.length() &amp;lt; 4000) &lt;/p&gt;
{
			longString.append(shortString);
		}

&lt;p&gt;		LOGGER.info(longString.toString());&lt;br/&gt;
		LOGGER.info(&quot;FailOver short string after message&quot;);&lt;br/&gt;
	}&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;I have tried setting suppressExceptions as false/true.  I have tried replacing the fileappender (which works normally) with just console instead and saw the same result.  This may or may not be related to another JIRA issue I found, &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-126&quot; title=&quot;Failover appender doesn&amp;#39;t fail over on JMS Queue appender error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-126&quot;&gt;&lt;del&gt;LOG4J2-126&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;If there is simply something wrong with my configuration please let me know.  I tried following the documentation as much as possible.  Thank you.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Java version 1.6_045 and Oracle 11g 11.2.0.3.0 database on 64-bit machine.  It&apos;s running within eclipse but I don&apos;t think that should make a difference.&lt;/p&gt;</environment>
        <key id="12654175">LOG4J2-291</key>
            <summary>Failover appender doesn&apos;t fail over on JDBC appender error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="beamerblvd">Nick Williams</assignee>
                                    <reporter username="asaf.erlich">Asaf Erlich</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 Jun 2013 15:07:58 +0000</created>
                <updated>Thu, 18 Jul 2013 18:57:01 +0000</updated>
                            <resolved>Wed, 17 Jul 2013 22:40:30 +0000</resolved>
                                    <version>2.0-beta7</version>
                                    <fixVersion>2.0-beta9</fixVersion>
                                    <component>Appenders</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13691209" author="tn" created="Sat, 22 Jun 2013 18:39:25 +0000"  >&lt;p&gt;The JDBCAppender will by default suppress any exceptions and log them. In the failover case this is not intended, so you need to set the &quot;suppressExceptions&quot; parameter to &quot;false&quot;, so the exception is correctly propagated to the FailoverAppender and the event is correctly logged with the configured failover appender.&lt;/p&gt;

&lt;p&gt;Unfortunately, the JDBCAppender has a bug with this setting, the line 83 in the current trunk should be changed to:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        final boolean handleExceptions = suppressExceptions == null || Boolean.parseBoolean(suppressExceptions);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The naming is confusing, handleException=true actually has the same meaning as suppressExceptions=true, as handleException means to handle the exception internally.&lt;/p&gt;</comment>
                            <comment id="13691216" author="tn" created="Sat, 22 Jun 2013 18:50:39 +0000"  >&lt;p&gt;The same bug is actually present in the JPAAppender and the NoSQLAppender.&lt;/p&gt;</comment>
                            <comment id="13705559" author="mikekloster" created="Thu, 11 Jul 2013 07:32:32 +0000"  >&lt;p&gt;It seems to the the issue goes deeper than just the value of the handleExceptions flag. In the current trunk, the JDBCDatabaseManager writeInternal() method catches SQLExceptions, logs them, and does not throw them as AppenderRuntimeException. This code starts in JDBCDatabaseManager on line 117.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;JDBCDatabaseManager.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;117:    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SQLException e) { 
118:        LOGGER.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to insert record &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; log event in manager [{}].&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getName(), e); 
119:    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; { 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 
&lt;p&gt;This means any exception in writing the log to the database gets trapped. I&apos;m new to the Log4J 2 codebase, but it seems to me there should be an additional line after 118 to the effect of:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;JDBCDatabaseManager.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SQLException e) {
            LOGGER.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to insert record &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; log event in manager [{}].&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getName(), e);
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.logging.log4j.core.appender.AppenderRuntimeException(e);
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After making the change to JDBCAppender per Thomas N. comment and adding the throw above, I am able to get the failover logs appearing in the log file. The use case I used for testing a failure is to shutdown the database server after the application is running, thus simulating a database failure or connectivity problem.&lt;/p&gt;

&lt;p&gt;Scanning through the rest of JDBCDatabaseManager seems to have other places where the log is not written to the database due to some error condition, but no exception is raised. Line 87 has a check for a null or closed connection, and simply returns after logging if the connection is not available.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;JDBCDatabaseManager.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;87:         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.isConnected() || &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.connection == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.connection.isClosed()) {
                LOGGER.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot write logging event; manager [{}] not connected to the database.&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getName());
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Unless I am missing something, it appears to me that the JDBCAppender is not written with failover in mind.&lt;/p&gt;
</comment>
                            <comment id="13711743" author="beamerblvd" created="Wed, 17 Jul 2013 22:40:30 +0000"  >&lt;p&gt;This is fixed. Please verify with latest (or wait until the next release) and then close.&lt;/p&gt;</comment>
                            <comment id="13712653" author="mikekloster" created="Thu, 18 Jul 2013 18:53:29 +0000"  >&lt;p&gt;I pulled the latest snapshot today, built and can confirm the fix.&lt;/p&gt;

&lt;p&gt;My test case uses a configuration nearly identical to the original bug report. To test the fail over, I set up two connection pools, one for my application, and one for the logger. I used a different user account for the logger than the application. After starting my application, the logs correctly appeared in the database and not in the failover file. Then, I dropped the logger user from the database (simulating a disruption in the ability to write logs to the database), the failover log file was then written. I also recreated the database user and saw the logs resume being written to the database.&lt;/p&gt;

&lt;p&gt;Great work! Thanks.&lt;/p&gt;</comment>
                            <comment id="13712659" author="beamerblvd" created="Thu, 18 Jul 2013 18:56:53 +0000"  >&lt;p&gt;Good to hear! I&apos;ll close this now.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>334452</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 18 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1lozj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>334778</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>