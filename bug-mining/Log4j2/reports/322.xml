<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:32:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-705] Async logger loses thread context stack for events</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-705</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;I&apos;ve enabled the async logger and created some log message with values in thread context stack. However, the logged message does not contain any of these items.&lt;/p&gt;

&lt;p&gt;Looking at the sources, it seems that AsyncLogger.logMessage() needs to clone the stack instead of using ThreadContext.getImmutableStack() (line 260). This is because getImmutableStack() method returns the same stack as original - getting the real one from thread local storage. So when passed to another thread (as async does), the same stack &quot;looks&quot; into different thread and returns empty list. It is even possible to break this &quot;immutable&quot; stack when you create your own appender and use ThreadContext.push() in append() method. This will affect the message being logged.&lt;/p&gt;

&lt;p&gt;Simple solution is to replace getImmutableStack() method in AsyncLogger.logMessage() (line 260) with ThreadContext.cloneStack(). But I&apos;m not sure if this is the right way.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12726267">LOG4J2-705</key>
            <summary>Async logger loses thread context stack for events</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="mfrydl">Martin Frydl</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Jul 2014 08:30:01 +0000</created>
                <updated>Mon, 14 Jul 2014 12:00:01 +0000</updated>
                            <resolved>Sat, 12 Jul 2014 11:23:33 +0000</resolved>
                                    <version>2.0-rc2</version>
                                    <fixVersion>2.0</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14058062" author="remkop@yahoo.com" created="Thu, 10 Jul 2014 22:33:56 +0000"  >&lt;p&gt;Can you please post the full contents of your log4j2.xml configuration file?&lt;/p&gt;</comment>
                            <comment id="14058840" author="mfrydl" created="Fri, 11 Jul 2014 14:37:20 +0000"  >&lt;p&gt;Attached a test case - source and config file&lt;/p&gt;</comment>
                            <comment id="14059692" author="remkop@yahoo.com" created="Sat, 12 Jul 2014 07:13:55 +0000"  >&lt;p&gt;Your analysis of the problem is correct. The stack contents should not be kept in a ThreadLocal when passing to the appender thread. I&apos;m working on a solution that preserves the current copy-on-write behaviour.&lt;/p&gt;</comment>
                            <comment id="14059745" author="remkop@yahoo.com" created="Sat, 12 Jul 2014 11:01:57 +0000"  >&lt;p&gt;I&apos;m surprised this has not been found earlier. This problem has been there from the start...&lt;/p&gt;

&lt;p&gt;The objective of both &lt;tt&gt;DefaultThreadContextStack&lt;/tt&gt; and &lt;tt&gt;DefaultThreadContextMap&lt;/tt&gt; is to be a copy-on-write implementation, the reasoning being that modifications to the map/stack will be rare, and this will allow us to avoid copying the stack/map for every single log event. Each log event is given a stack/map instance obtained with a call to &lt;tt&gt;ThreadContext.getImmutableStack()&lt;/tt&gt; and &lt;tt&gt;ThreadContext.getImmutableMap()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;For the map, this method returns the internal immutable map. This is safe because with every modification that map will be replaced with another instance. With the stack we were also returning the internal representation, but as you pointed out, the &lt;tt&gt;DefaultThreadContextStack&lt;/tt&gt; implementation stores the data in a thread-local variable, so instances of this class are not suitable for passing to another thread because that other thread will not be able to access the data. &lt;/p&gt;

&lt;p&gt;The solution is to do something similar as we are doing with the map. The thread-local variable should keep an immutable stack instance that can safely be handed off to other threads. Every time the stack is modified, a new stack instance will be created and stored in the thread-local variable.&lt;/p&gt;

&lt;p&gt;This requires an API change: we need to add a method &lt;tt&gt;ThreadContextStack.getImmutableStackOrNull()&lt;/tt&gt;, analogous to the existing &lt;tt&gt;ThreadContextMap.getImmutableMapOrNull()&lt;/tt&gt; method.&lt;/p&gt;

&lt;p&gt;I doubt many users have custom &lt;tt&gt;ThreadContextStack&lt;/tt&gt; implementations, so I doubt this API change will impact many users (if anyone at all).&lt;/p&gt;</comment>
                            <comment id="14059748" author="remkop@yahoo.com" created="Sat, 12 Jul 2014 11:23:33 +0000"  >&lt;p&gt;Fixed in revision 1609903.&lt;/p&gt;

&lt;p&gt;Please verify and close.&lt;/p&gt;</comment>
                            <comment id="14060580" author="mfrydl" created="Mon, 14 Jul 2014 12:00:01 +0000"  >&lt;p&gt;Tested on revision 1610388, works fine. Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12655217" name="async-context-test.zip" size="1134" author="mfrydl" created="Fri, 11 Jul 2014 14:37:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>404374</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 19 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xle7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>404413</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>