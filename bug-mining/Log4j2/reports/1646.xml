<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:43:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-3657] Log4j memory leak via Classloader</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-3657</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;We have a memory leak in the application. If we stop and run Jetty in the loop in JUnit we get OOM.&#160;&lt;/p&gt;

&lt;p&gt;The issue is in the following lines. I think Log4j attaches an object to the thread via the &lt;em&gt;get&lt;/em&gt; method (because the field is defined like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ThreadLocal&amp;lt;DefaultLogBuilder&amp;gt; logBuilder = ThreadLocal.withInitial(DefaultLogBuilder::&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It means that Log4j attaches an object to a thread &lt;b&gt;even &lt;em&gt;Constants.ENABLE_THREADLOCALS&lt;/em&gt; is disabled&lt;/b&gt;. My thoughts:&lt;/p&gt;

&lt;p&gt;1) Log4j code attaches &lt;em&gt;DefaultLogBuilder&lt;/em&gt; object to threads&lt;br/&gt;
2) &lt;em&gt;DefaultLogBuilder&lt;/em&gt; object has a link to &lt;em&gt;DefaultLogBuilder.class&lt;/em&gt; that has a link to &lt;em&gt;DefaultLogBuilder.class.getClassloader()&lt;/em&gt;&#160;&lt;/p&gt;

&lt;p&gt;3) &lt;em&gt;DefaultLogBuilder.class.getClassloader()&lt;/em&gt; is a Web App Classloader and during our JUnit testing many classes are loaded to the classloader&lt;br/&gt;
4) I suspect somewhere some Thread Pool is used and even if we clean all resources in the application, Log4j &lt;b&gt;holds classloaders and all loaded classes&lt;/b&gt; via &lt;em&gt;DefaultLogBuilder.class.getClassloader()&lt;/em&gt;&lt;br/&gt;
&#160;&lt;br/&gt;
I suggest checking &lt;em&gt;Constants.ENABLE_THREADLOCALS&lt;/em&gt; variable before calling &lt;em&gt;logBuilder.get()&lt;/em&gt; in &lt;em&gt;org.apache.logging.log4j.spi.AbstractLogger.&lt;/em&gt;&#160;&lt;b&gt;After the following changes, the problem is gone.&lt;/b&gt; (except additionally I added &lt;em&gt;log4j2.disable.jmx=true&lt;/em&gt;, because it has a similar issue, but I think it is not a log4j issue)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
 * Returns a log builder that logs at the specified level.
 *
 * @since 2.20.0
 */
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; LogBuilder getLogBuilder(Level level) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (Constants.ENABLE_THREADLOCALS) {
        DefaultLogBuilder builder = logBuilder.get();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!builder.isInUse()) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; builder.reset(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, level);
        }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultLogBuilder(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, level);
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Original code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
 * Returns a log builder that logs at the specified level.
 *
 * @since 2.20.0
 */
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; LogBuilder getLogBuilder(Level level) {
    DefaultLogBuilder builder = logBuilder.get();
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Constants.ENABLE_THREADLOCALS &amp;amp;&amp;amp; !builder.isInUse() ? builder.reset(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, level)
            : &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DefaultLogBuilder(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, level);
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;P.S. Please, if it is possible can you include the fix in an upcoming release, the issue randomly happens during our application build and it is a headache for us &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Thank you.&lt;/p&gt;

&lt;p&gt;P.S.S. We use a free license of Yourkit for open-source projects. Please, look at the picture from a profiler.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13056794/13056794_image-2023-03-24-21-05-55-700.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13530020">LOG4J2-3657</key>
            <summary>Log4j memory leak via Classloader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vy">Volkan Yazici</assignee>
                                    <reporter username="mkamalov">Marat Kamalov</reporter>
                        <labels>
                    </labels>
                <created>Fri, 24 Mar 2023 18:19:34 +0000</created>
                <updated>Mon, 27 Mar 2023 08:44:20 +0000</updated>
                            <resolved>Fri, 24 Mar 2023 21:21:16 +0000</resolved>
                                    <version>2.20.0</version>
                                    <fixVersion>2.21.0</fixVersion>
                                    <component>API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17704818" author="vy" created="Fri, 24 Mar 2023 21:20:23 +0000"  >&lt;p&gt;Thanks so much for the report, through investigation, and the fix &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkamalov&quot; class=&quot;user-hover&quot; rel=&quot;mkamalov&quot;&gt;mkamalov&lt;/a&gt;! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_up.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I have pushed the fix to &lt;tt&gt;2.x&lt;/tt&gt;. You can follow the status of the build &lt;a href=&quot;https://github.com/apache/logging-log4j2/actions/runs/4515421697&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. Would you mind confirming that the published SNAPSHOT artifacts fixes the issue, and if so, close the issue, please?&lt;/p&gt;

&lt;p&gt;Let me remind that we have &lt;a href=&quot;https://logging.apache.org/log4j/2.x/support.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;started using GitHub Issues officially&lt;/a&gt;. Given the amount of effort you have already put into this, a GitHub pull request would be great next time! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13056794" name="image-2023-03-24-21-05-55-700.png" size="381412" author="mkamalov" created="Fri, 24 Mar 2023 18:05:56 +0000"/>
                            <attachment id="13056793" name="image-2023-03-24-21-07-04-937.png" size="58826" author="mkamalov" created="Fri, 24 Mar 2023 18:07:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 33 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1gubc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>