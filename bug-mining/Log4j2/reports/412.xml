<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:33:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-862] Misleading error message &quot;Log4j2 could not find a logging implementation. Please add log4j-core to the classpath.&quot;</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-862</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;In the code out put I see&lt;br/&gt;
&quot;ERROR StatusLogger Log4j2 could not find a logging implementation. Please add log4j-core to the classpath. Using SimpleLogger to log to the console...&quot; followed by &quot;java.lang.ClassCastException: org.apache.logging.log4j.simple.SimpleLoggerContext cannot be cast to org.apache.logging.log4j.core.LoggerContext&quot; which means core must be on the class path as otherwise you couldn&apos;t get that class cast execption. At which point the application using Log4j2 fails to start. &lt;/p&gt;

&lt;p&gt;The underlying problem is org.apache.logging.log4j.LogManager assuming if org.apache.logging.log4j.util.ProviderUtil returns false for hasProviders it is because core is not on the classpath. In practice I&apos;ve found that hasProviders can return false because ProviderUtil is using a different Classloader than the rest of the application. It cannot find the &quot;META-INF/log4j-provider.properties&quot; resource but it is on the class path.&lt;/p&gt;

&lt;p&gt;I think there is a problem with the logic of how the classloaders are chosen but I don&apos;t understand what Log4j is trying to do here, however I am sure the error message is confusing and misleading&lt;/p&gt;</description>
                <environment></environment>
        <key id="12744206">LOG4J2-862</key>
            <summary>Misleading error message &quot;Log4j2 could not find a logging implementation. Please add log4j-core to the classpath.&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mattsicker">Matt Sicker</assignee>
                                    <reporter username="mike1979">Michael Sutherland</reporter>
                        <labels>
                    </labels>
                <created>Fri, 26 Sep 2014 04:08:40 +0000</created>
                <updated>Sat, 4 Oct 2014 05:15:21 +0000</updated>
                            <resolved>Tue, 30 Sep 2014 02:34:07 +0000</resolved>
                                    <version>2.0.2</version>
                                    <fixVersion>2.1</fixVersion>
                                    <component>Configurators</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14148833" author="remkop@yahoo.com" created="Fri, 26 Sep 2014 06:29:24 +0000"  >&lt;p&gt;Thanks for pointing out this possibility.&lt;br/&gt;
The current message was introduced based on frequent questions on StackOverflow, but perhaps we can refine the wording a little.&lt;/p&gt;

&lt;p&gt;Can you explain the scenario that caused ProviderUtil to use a different Classloader than the rest of your application?&lt;/p&gt;</comment>
                            <comment id="14148850" author="mike1979" created="Fri, 26 Sep 2014 06:55:00 +0000"  >&lt;p&gt;I can give a rough explaination now but I haven&apos;t had the oportunity to refine it down to the bare details so some of the information may be extraneous. I&apos;m also having to obfuscate some company specific details so you may see some cut and paste artifacts.&lt;/p&gt;

&lt;p&gt;I have an Ant script that calls a custom Ant task&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;build.xml&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;project name=&lt;span class=&quot;code-quote&quot;&gt;&quot;DB 1.0.0&quot;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&quot;build&quot;&lt;/span&gt;&amp;gt;

    &amp;lt;path id=&lt;span class=&quot;code-quote&quot;&gt;&quot;project.classpath&quot;&lt;/span&gt;&amp;gt;
        &amp;lt;fileset dir=&lt;span class=&quot;code-quote&quot;&gt;&quot;$./lib/shipped&quot;&lt;/span&gt;&amp;gt;
            &amp;lt;include name=&lt;span class=&quot;code-quote&quot;&gt;&quot;log4j-1.2-api-2.0.2.jar&quot;&lt;/span&gt;/&amp;gt;
            &amp;lt;include name=&lt;span class=&quot;code-quote&quot;&gt;&quot;log4j-api-2.0.2.jar&quot;&lt;/span&gt;/&amp;gt;
            &amp;lt;include name=&lt;span class=&quot;code-quote&quot;&gt;&quot;log4j-core-2.0.2.jar&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;/fileset&amp;gt;
        &amp;lt;path location=&lt;span class=&quot;code-quote&quot;&gt;&quot;./classes&quot;&lt;/span&gt;/&amp;gt;
    &amp;lt;/path&amp;gt;

    &amp;lt;taskdef name=&lt;span class=&quot;code-quote&quot;&gt;&quot;customTaskThatUsesLog4j&quot;&lt;/span&gt; classname=&lt;span class=&quot;code-quote&quot;&gt;&quot;com.example.CustomTaskThatUsesLog4j&quot;&lt;/span&gt;&amp;gt;
        &amp;lt;classpath refid=&lt;span class=&quot;code-quote&quot;&gt;&quot;project.classpath&quot;&lt;/span&gt;/&amp;gt;
    &amp;lt;/taskdef&amp;gt;
    &amp;lt;customTaskThatUsesLog4j hostname=&lt;span class=&quot;code-quote&quot;&gt;&quot;zzzz&quot;&lt;/span&gt; username=&lt;span class=&quot;code-quote&quot;&gt;&quot;suthermi&quot;&lt;/span&gt;/&amp;gt;
&amp;lt;/build&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;The customTaskThatUsesLog4j should print out a number of messages about what it&apos;s doing using Log4j2 but fails due to the errors mentioned above. If I add the following code to the task &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;CustomTaskThatUsesLog4j.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; recName = &lt;span class=&quot;code-quote&quot;&gt;&quot;META-INF/log4j-provider.properties&quot;&lt;/span&gt;;
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;ProviderUtil.findClassLoader() &quot;&lt;/span&gt;+ProviderUtil.findClassLoader()+&lt;span class=&quot;code-quote&quot;&gt;&quot; finds &quot;&lt;/span&gt;+ProviderUtil.findClassLoader().getResources(recName).hasMoreElements());
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getContextClassLoader() &quot;&lt;/span&gt;+&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getContextClassLoader()+&lt;span class=&quot;code-quote&quot;&gt;&quot; finds &quot;&lt;/span&gt;+&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getContextClassLoader().getResources(recName).hasMoreElements());
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.getSystemClassLoader() &quot;&lt;/span&gt;+&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.getSystemClassLoader()+&lt;span class=&quot;code-quote&quot;&gt;&quot; finds &quot;&lt;/span&gt;+&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.getSystemClassLoader().getResources(recName).hasMoreElements());
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;ProviderUtil.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getClassLoader() &quot;&lt;/span&gt;+ProviderUtil.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getClassLoader()+&lt;span class=&quot;code-quote&quot;&gt;&quot; finds &quot;&lt;/span&gt;+ProviderUtil.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getClassLoader().getResources(recName).hasMoreElements());
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;ProviderUtil.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getClassLoader() parent &quot;&lt;/span&gt;+ProviderUtil.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getClassLoader().getParent());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I get &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;ProviderUtil.findClassLoader() sun.misc.Launcher$AppClassLoader@7c9ed5d6 finds false&lt;br/&gt;
Thread.currentThread().getContextClassLoader() sun.misc.Launcher$AppClassLoader@7c9ed5d6 finds false&lt;br/&gt;
ClassLoader.getSystemClassLoader() sun.misc.Launcher$AppClassLoader@7c9ed5d6 finds false&lt;br/&gt;
ProviderUtil.class.getClassLoader() AntClassLoader&lt;span class=&quot;error&quot;&gt;&amp;#91;.\log4j-core-2.0.2.jar;.\lib\shipped\commons-lang-2.5.jar;.\lib\shipped\log4j-1.2-api-2.0.2.jar;.\lib\shipped\log4j-api-2.0.2.jar;.\classes&amp;#93;&lt;/span&gt; finds true&lt;br/&gt;
ProviderUtil.class.getClassLoader() parent sun.misc.Launcher$AppClassLoader@7c9ed5d6&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;as an output. Which looks to me like Log4j2 is using the parent classloader &quot;AppClassLoader@7c9ed5d6&quot; of the class loader it should be using &quot;AntClassLoader&quot;.&lt;/p&gt;

&lt;p&gt;Does that give you enough detail?&lt;/p&gt;</comment>
                            <comment id="14148915" author="remkop@yahoo.com" created="Fri, 26 Sep 2014 08:35:14 +0000"  >&lt;p&gt;I had a look at the code. Looks like ProviderUtil uses the current Thread classloader, unless the Security Manager restricts the &quot;getClassLoader&quot; privilege, in which case it uses the classloader of its own class. We probably want the latter, so you could try restricting that permission.&lt;/p&gt;

&lt;p&gt;You may be able to get more detail on what is going wrong by setting system property &lt;tt&gt;-Dlog4j2.StatusLogger.level=TRACE&lt;/tt&gt; - this is the internal log4j2 status logging level before it is set to the status level of the log4j2.xml configuration file. &lt;/p&gt;</comment>
                            <comment id="14148950" author="mike1979" created="Fri, 26 Sep 2014 09:11:29 +0000"  >&lt;p&gt;I did try setting &lt;em&gt;&quot;-Dlog4j2.StatusLogger.level=TRACE&quot;&lt;/em&gt; but Log4j2 fails with the class cast exception before it starts logging anything so it doesn&apos;t add anything to the discussion.&lt;/p&gt;

&lt;p&gt;When you say &quot;Looks like ProviderUtil uses the current Thread classloader, unless the Security Manager restricts the &quot;getClassLoader&quot; privilege, in which case it uses the classloader of its own class.&quot; I don&apos;t think I agree, if it cannot use &lt;tt&gt;ThreadContextClassLoaderGetter&lt;/tt&gt; it uses &lt;tt&gt;ClassLoader.getSystemClassLoader()&lt;/tt&gt; which is not the same as &lt;tt&gt;ProviderUtil.class.getClassLoader()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;You can see the output from the three different options in the code I quoted above. In short &lt;tt&gt;ClassLoader.getSystemClassLoader()&lt;/tt&gt; will return an instance of &lt;tt&gt;sun.misc.Launcher$AppClassLoader&lt;/tt&gt; and &lt;tt&gt;ProviderUtil.class.getClassLoader()&lt;/tt&gt; will return an instance of &lt;tt&gt;AntClassLoader&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;How do you do the format for the -DLog4j line? It would make this post much clearer to read.&lt;/p&gt;



</comment>
                            <comment id="14148996" author="remkop@yahoo.com" created="Fri, 26 Sep 2014 10:07:01 +0000"  >&lt;p&gt;Surround the string with {{ and }}.&lt;/p&gt;

&lt;p&gt;Hmm... Just looking at the LoaderUtil code, if a SecurityManager is set, and RuntimePermission(&quot;getClassLoader&quot;) is not permitted, then internal flag GET_CLASS_LOADER_DISABLED is set, and getThreadContextClassLoader() returns LoaderUtil.class.getClassLoader().&lt;/p&gt;

&lt;p&gt;The ThreadContextClassLoaderGetter you mentioned only comes into play if the internal flag GET_CLASS_LOADER_DISABLED  is false.&lt;/p&gt;</comment>
                            <comment id="14149972" author="jvz" created="Fri, 26 Sep 2014 21:08:46 +0000"  >&lt;p&gt;Pushed a fix. I had mixed up the order of ClassLoader priority in the class.&lt;/p&gt;</comment>
                            <comment id="14150183" author="remkop@yahoo.com" created="Fri, 26 Sep 2014 23:21:54 +0000"  >&lt;p&gt;Thanks Matt! Can you add an entry to changes.xml for the release notes?&lt;/p&gt;

&lt;p&gt;Michael, can you build from master and confirm that this solves the issue? Thanks!&lt;/p&gt;</comment>
                            <comment id="14150591" author="remkop@yahoo.com" created="Sat, 27 Sep 2014 13:55:07 +0000"  >&lt;p&gt;(Updated change log.)&lt;/p&gt;

&lt;p&gt;Michael, we are getting ready for the 2.1 release. If the fix in master does not work we just might be able to correct it if you let us know soon.&lt;/p&gt;</comment>
                            <comment id="14151349" author="mike1979" created="Mon, 29 Sep 2014 04:33:59 +0000"  >&lt;p&gt;I&apos;ve tried building from trunk and I&apos;d say this is still a problem. I think it&apos;s due to ProviderUtil.findClassLoader going directly to LoaderUtil.getThreadContextClassLoader(). It means all the code in LoaderUtil that checks for the &quot;IGNORE_TCCL_PROPERTY&quot; is skipped and Thread.currentThread().getContextClassLoader() is exectuted despite the system properties. &lt;/p&gt;

&lt;p&gt;If i replace the line &lt;tt&gt;if (cl != null){&lt;/tt&gt; with &lt;tt&gt;if (cl != null &amp;amp;&amp;amp; !&quot;true&quot;.equals(System.getProperty(IGNORE_TCCL_PROPERTY))) {&lt;/tt&gt; log4j works as I&apos;d expect but it doesn&apos;t fit the architecture of having PropertiesUtil&lt;/p&gt;</comment>
                            <comment id="14152729" author="jvz" created="Tue, 30 Sep 2014 02:34:07 +0000"  >&lt;p&gt;Fixed for real this time in the latest master. Commit ID: d80c6a20824bd13090bf80d415c02b39c53e8f21&lt;/p&gt;</comment>
                            <comment id="14152820" author="mike1979" created="Tue, 30 Sep 2014 05:39:51 +0000"  >&lt;p&gt;Agreed, a build from master works perfectly now. Thanks Matt and Remko.&lt;/p&gt;</comment>
                            <comment id="14158963" author="jvz" created="Sat, 4 Oct 2014 05:15:21 +0000"  >&lt;p&gt;Thanks for the confirmation.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 7 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20ibr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>