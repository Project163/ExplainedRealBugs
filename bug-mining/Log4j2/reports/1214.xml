<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:39:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-2333] Errors thrown in formatting may stop background threads</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-2333</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;If a message causes an Error (OOM, for example) on toString, the disruptor background thread does not catch it, and will stop processing events.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13156907">LOG4J2-2333</key>
            <summary>Errors thrown in formatting may stop background threads</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ckozak">Carter Kozak</assignee>
                                    <reporter username="ckozak">Carter Kozak</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 May 2018 16:31:20 +0000</created>
                <updated>Fri, 4 May 2018 14:19:06 +0000</updated>
                            <resolved>Fri, 4 May 2018 13:43:57 +0000</resolved>
                                    <version>2.11.0</version>
                                    <fixVersion>2.11.1</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16462754" author="githubbot" created="Thu, 3 May 2018 16:43:39 +0000"  >&lt;p&gt;GitHub user cakofony opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/174&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/174&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2333&quot; title=&quot;Errors thrown in formatting may stop background threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2333&quot;&gt;&lt;del&gt;LOG4J2-2333&lt;/del&gt;&lt;/a&gt; Handle errors thrown in disruptor ExceptionHandler&lt;/p&gt;

&lt;p&gt;    Previously this would kill the background thread and stop processing&lt;br/&gt;
    events.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/cakofony/logging-log4j2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/cakofony/logging-log4j2&lt;/a&gt; async_logger_error_handling&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/174.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/174.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #174&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 90e61ccdc43d72cc9bc10b5b601af2aa4712cb43&lt;br/&gt;
Author: Carter Kozak &amp;lt;ckozak@...&amp;gt;&lt;br/&gt;
Date:   2018-05-03T16:37:19Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2333&quot; title=&quot;Errors thrown in formatting may stop background threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2333&quot;&gt;&lt;del&gt;LOG4J2-2333&lt;/del&gt;&lt;/a&gt; Handle errors thrown in disruptor ExceptionHandler&lt;/p&gt;

&lt;p&gt;    Previously this would kill the background thread and stop processing&lt;br/&gt;
    events.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16462786" author="remkop@yahoo.com" created="Thu, 3 May 2018 17:04:51 +0000"  >&lt;p&gt;Isn&#8217;t the current logic sufficient?&lt;/p&gt;

&lt;p&gt;There&#8217;s an ExceptionHandler (that can be customized) to handle Exceptions. Errors and Throwables are traditionally not handled.&#160;&lt;/p&gt;

&lt;p&gt;What is the use case here? Why should Errors/Throwables be handled?&lt;/p&gt;</comment>
                            <comment id="16462841" author="ckozak" created="Thu, 3 May 2018 17:40:06 +0000"  >&lt;p&gt;If we don&apos;t handle Errors, the background thread stops spinning, and no more events will be logged.  Without the fix my test will fail to log any events.&lt;/p&gt;

&lt;p&gt;This is problem when the jvm is under memory pressure, OOMs get logged heavily. If append fails and throws an exception (probably another OOM since we&apos;re near the peak), it causes the background thread to die, and allows events to queue up holding references to parameters, and causing more ooms without any logging.&lt;/p&gt;

&lt;p&gt;I&apos;m using a custom ExceptionHandler which does catch Errors in my codebases now, but it seems like a reasonable default to avoid getting caught in OOM spirals.&lt;/p&gt;</comment>
                            <comment id="16462904" author="remkop@yahoo.com" created="Thu, 3 May 2018 18:35:05 +0000"  >&lt;p&gt;I think there are two concerns here: when an Error/Throwable occurs in the async logging background thread, we&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;want to give the user information on what happened&lt;/li&gt;
	&lt;li&gt;&lt;em&gt;may&lt;/em&gt; want to prevent the background thread from dying&#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I can agree with the first objective. I am&#160;less sure that it is a good idea to keep the background thread alive. (But I&apos;m not religious about&#160;it&#160;either.)&lt;/p&gt;

&lt;p&gt;Looking at the proposed change, I am not sure that it will accomplish the first objective. If we caught a Throwable, especially an OutOfMemoryError, we should assume that all subsequent actions may also fail. So appending to the StringBuilder is risky. I would prefer to immediately start printing details to &lt;tt&gt;stderr&lt;/tt&gt; instead. Also, we should do this in a way that is most likely to succeed: avoid allocating memory where possible. For example, we can start by printing the class of the Throwable and its message (and avoid calling &lt;tt&gt;Throwable.toString)&lt;/tt&gt;, before we call &lt;tt&gt;Throwable.printStackTrace&lt;/tt&gt;, which allocates many temporary objects.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16462956" author="ckozak" created="Thu, 3 May 2018 19:23:28 +0000"  >&lt;p&gt;Good call, thanks for the quick feedback!&lt;/p&gt;

&lt;p&gt;Are you suggesting that we write directly to stderr instead of a buffer to begin with, or that we branch based on the type of failure? I prefer using the same codepath in all cases for simplicity, but more writes to stderr is going to be a bit slower and may cause our log line to be interleaved with other messages written to stderr. I&apos;ve pushed this as a follow up commit.&lt;/p&gt;</comment>
                            <comment id="16462999" author="remkop@yahoo.com" created="Thu, 3 May 2018 20:21:02 +0000"  >&lt;p&gt;Yes, the last commit looks close to what I had in mind.&#160;&lt;/p&gt;

&lt;p&gt;Maybe instead of &lt;tt&gt;&quot;ERROR calling toString()...&#8220;&lt;/tt&gt; it would be nice also to print the class and error message of the &lt;tt&gt;ignored&lt;/tt&gt; Throwable. Otherwise looks good. Performance in the error handler is less of a concern for me. &lt;/p&gt;</comment>
                            <comment id="16463051" author="ckozak" created="Thu, 3 May 2018 21:03:27 +0000"  >&lt;p&gt;Makes sense, updated. I&apos;ll plan to merge later today unless you have concerns about not allowing background threads to terminate.&lt;/p&gt;</comment>
                            <comment id="16463886" author="jira-bot" created="Fri, 4 May 2018 13:45:16 +0000"  >&lt;p&gt;Commit 9d57fe27b7353985814ea81c8cd807ee8350fac4 in logging-log4j2&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckozak&quot; class=&quot;user-hover&quot; rel=&quot;ckozak&quot;&gt;ckozak&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=9d57fe2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=9d57fe2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2333&quot; title=&quot;Errors thrown in formatting may stop background threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2333&quot;&gt;&lt;del&gt;LOG4J2-2333&lt;/del&gt;&lt;/a&gt; Handle errors thrown in disruptor ExceptionHandler&lt;/p&gt;

&lt;p&gt;Previously this would kill the background thread and stop processing&lt;br/&gt;
events.&lt;/p&gt;</comment>
                            <comment id="16463887" author="jira-bot" created="Fri, 4 May 2018 13:45:27 +0000"  >&lt;p&gt;Commit aebb1617cbf26154fe31faed0491766546f2271a in logging-log4j2&apos;s branch refs/heads/release-2.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckozak&quot; class=&quot;user-hover&quot; rel=&quot;ckozak&quot;&gt;ckozak&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=aebb161&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=aebb161&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2333&quot; title=&quot;Errors thrown in formatting may stop background threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2333&quot;&gt;&lt;del&gt;LOG4J2-2333&lt;/del&gt;&lt;/a&gt; Handle errors thrown in disruptor ExceptionHandler&lt;/p&gt;

&lt;p&gt;Previously this would kill the background thread and stop processing&lt;br/&gt;
events.&lt;/p&gt;</comment>
                            <comment id="16463935" author="githubbot" created="Fri, 4 May 2018 14:19:05 +0000"  >&lt;p&gt;Github user cakofony commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/174&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/174&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    merged&lt;/p&gt;</comment>
                            <comment id="16463936" author="githubbot" created="Fri, 4 May 2018 14:19:06 +0000"  >&lt;p&gt;Github user cakofony closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/174&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/174&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 28 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3tb7z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>