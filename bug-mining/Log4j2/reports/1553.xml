<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:42:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-3193] ConfigurationFactory cannot find config file property normalized by EnvironmentPropertySource</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-3193</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;I am setting `LOG4J_CONFIGURATION_FILE` as an environment variable, and also have a `log4j2.component.properties` file that specifies a different value for `log4j2.configurationFile`.&lt;/p&gt;

&lt;p&gt;When `PropertyUtils$Environment.reload` &lt;a href=&quot;https://github.com/apache/logging-log4j2/blob/rel/2.14.1/log4j-api/src/main/java/org/apache/logging/log4j/util/PropertiesUtil.java#L466&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;handles each key value pair and normalizes the key&lt;/a&gt;, `EnvironmentPropertySource.getNormalForm` &lt;a href=&quot;https://github.com/apache/logging-log4j2/blob/rel/2.14.1/log4j-api/src/main/java/org/apache/logging/log4j/util/EnvironmentPropertySource.java#L61&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;normalizes the environment variable&lt;/a&gt; to `LOG4J_CONFIGURATION_FILE` but `PropertiesPropertySource.getNormalForm` &#160;&lt;a href=&quot;https://github.com/apache/logging-log4j2/blob/rel/2.14.1/log4j-api/src/main/java/org/apache/logging/log4j/util/PropertiesPropertySource.java#L52&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;normalizes the property from the file&lt;/a&gt; as `log4j2.configurationFile`. So &lt;em&gt;both&lt;/em&gt; values end up in the `normalized` Map.&lt;/p&gt;

&lt;p&gt;Then when `ConfigurationFactory` &lt;a href=&quot;https://github.com/apache/logging-log4j2/blob/rel/2.14.1/log4j-core/src/main/java/org/apache/logging/log4j/core/config/ConfigurationFactory.java#L398&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;gets the configuration file property&lt;/a&gt; it only looks for `log4j.configurationFile` and ignores the LOG4J_CONFIGURATION_FILE environment variable.&lt;/p&gt;

&lt;p&gt;This seems to contradict the &lt;a href=&quot;https://logging.apache.org/log4j/2.x/manual/configuration.html#SystemProperties&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;documentation&lt;/a&gt; which says that environment variables should take precedence over properties files.&lt;/p&gt;

&lt;p&gt;If I&apos;m not mistaken and this is truly a bug, then I&apos;d be happy to work on a PR if it would get it resolved more quickly. I would just need some guidance about the proper solution. Should `EnvironmentPropertySource.getNormalForm` be updated to produce the same style output as `PropertyPropertySource.getNormalForm`? The &lt;a href=&quot;https://github.com/apache/logging-log4j2/blob/rel/2.14.1/log4j-api/src/test/java/org/apache/logging/log4j/util/EnvironmentPropertySourceTest.java#L43&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tests indicate&lt;/a&gt; that the current behavior is not an accident, so I&apos;m unsure what ought to be done.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13412549">LOG4J2-3193</key>
            <summary>ConfigurationFactory cannot find config file property normalized by EnvironmentPropertySource</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pkarwasz">Piotr Karwasz</assignee>
                                    <reporter username="Burke">David</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Nov 2021 14:06:47 +0000</created>
                <updated>Mon, 16 Jan 2023 05:30:06 +0000</updated>
                            <resolved>Tue, 10 May 2022 06:12:38 +0000</resolved>
                                    <version>2.14.1</version>
                                    <fixVersion>2.18.0</fixVersion>
                                    <component>Configuration</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17446125" author="pkarwasz" created="Thu, 18 Nov 2021 20:03:28 +0000"  >&lt;p&gt;It seems like a smaller problem in &lt;a href=&quot;https://github.com/apache/logging-log4j2/blob/3042e80fc6624e410925e4a264acddad92cc1541/log4j-api/src/main/java/org/apache/logging/log4j/util/PropertiesUtil.java#L453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Environment#reload&lt;/a&gt;, which allows sources with higher priority number to override those with lower priority number. The order of the TreeSet should be reversed.&lt;/p&gt;</comment>
                            <comment id="17446276" author="JIRAUSER280459" created="Fri, 19 Nov 2021 04:30:47 +0000"  >&lt;p&gt;I think that&apos;s part of it. Do you think it makes sense to declare the TreeSet with &quot;new PropertySource.Comparator().reversed()&quot; rather than change the behavior of the comparator itself? I&apos;m not sure how else that Comparator is used.&lt;/p&gt;

&lt;p&gt;I don&apos;t think that&apos;s the whole problem I was seeing though. When my debugger gets to ConfigurationFactory$Factory.getConfiguration, and it executes:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; configLocationStr = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.substitutor.replace(PropertiesUtil.getProperties()
  &#160; &#160; &#160; .getStringProperty(CONFIGURATION_FILE_PROPERTY));&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The PropertiesUtil instance has both of these values in its normalized map:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;log4j2.configurationFile=bad.xml&lt;/li&gt;
	&lt;li&gt;LOG4J_CONFIGURATION_FILE=good.xml&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Because the key from the environment variable is &apos;normalized&apos; differently, it can&apos;t override the key from the PropertiesPropertySource no matter what order they go in. Then getConfiguration specifically looks up &apos;log4j.configurationFile&apos; so it can never see the key from the EnvironmentPropertySource.&lt;/p&gt;

&lt;p&gt;The &apos;tokenized&apos; map ends up with only one entry, but it is checked last by PropertiesUtil$Environment.get so the value from &apos;normalized&apos; always wins. The value in &apos;tokenized&apos; is the (wrong) property value, but that would be fixed by reversing the TreeSet as you mentioned. Would it make sense for PropertiesUtil$Environment.get to check &apos;tokenized&apos; first?&lt;/p&gt;</comment>
                            <comment id="17446313" author="jvz" created="Fri, 19 Nov 2021 06:38:40 +0000"  >&lt;p&gt;Yes, this is a bug. Your idea about using a tokenized version of the property for lookup sounds appropriate. Can you file a PR for this?&lt;/p&gt;</comment>
                            <comment id="17446462" author="JIRAUSER280459" created="Fri, 19 Nov 2021 11:52:33 +0000"  >&lt;p&gt;I should be able to do that. Can you confirm that I&apos;d also need to reverse the order of the TreeSet as Piotr suggested above? In my debugging, the tokenized map does have the &quot;wrong&quot; value from the properties file, but I believe if the EnvironmentPropertySource were applied later it would override the same key in that map and I&apos;d get the right value.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also, would I need to sign the Apache ICLA (and have my employer sign the CLA) before the PR is merged? Or are those only needed for people merging into &apos;master&apos;?&lt;/p&gt;</comment>
                            <comment id="17446581" author="jvz" created="Fri, 19 Nov 2021 16:59:40 +0000"  >&lt;p&gt;Yeah, the comparator change sounds right, too. For small contributions, an ICLA isn&#8217;t strictly necessary.&lt;/p&gt;</comment>
                            <comment id="17446818" author="pkarwasz" created="Sat, 20 Nov 2021 12:45:11 +0000"  >&lt;p&gt;&lt;cite&gt;The &apos;tokenized&apos; map ends up with only one entry, but it is checked last by PropertiesUtil$Environment.get so the value from &apos;normalized&apos; always wins.&lt;/cite&gt;&lt;/p&gt;

&lt;p&gt;Yes, the &apos;normalized&apos; version always wins, but &lt;tt&gt;getConfiguration&lt;/tt&gt; asks for a non-normalized name &apos;log4j.configurationFile&apos; (without the 2), so neither the environment variable nor the entry in `log4j2.component.properties&apos; match it.&lt;/p&gt;

&lt;p&gt;The name is resolved only by the &apos;tokenized&apos; map.&lt;/p&gt;</comment>
                            <comment id="17447640" author="JIRAUSER280459" created="Mon, 22 Nov 2021 22:11:35 +0000"  >&lt;p&gt;I started a PR. I still need to test the change. &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/601&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/601&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17494291" author="jira-bot" created="Thu, 17 Feb 2022 23:40:37 +0000"  >&lt;p&gt;Commit b89b8983f6df451c4708362684ae046371340d7e in logging-log4j2&apos;s branch refs/heads/release-2.x from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=b89b898&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=b89b898&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3193&quot; title=&quot;ConfigurationFactory cannot find config file property normalized by EnvironmentPropertySource&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3193&quot;&gt;&lt;del&gt;LOG4J2-3193&lt;/del&gt;&lt;/a&gt; - Add unit test to validate loading via the system property works&lt;/p&gt;</comment>
                            <comment id="17534159" author="pkarwasz" created="Tue, 10 May 2022 06:12:38 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Burke&quot; class=&quot;user-hover&quot; rel=&quot;Burke&quot;&gt;Burke&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I merged a fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3366&quot; title=&quot;Fix order of property sources&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3366&quot;&gt;&lt;del&gt;LOG4J2-3366&lt;/del&gt;&lt;/a&gt;, which is available in the latest &lt;tt&gt;2.17.3-SNAPSHOT&lt;/tt&gt;. Can you check if it solves your problem? The order of the sources has been changed to (from the most prioritized):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;System properties,&lt;/li&gt;
	&lt;li&gt;Environment variables,&lt;/li&gt;
	&lt;li&gt;`log4j2.component.properties`.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17534935" author="JIRAUSER280459" created="Wed, 11 May 2022 14:39:29 +0000"  >&lt;p&gt;Yes, that solves my problem! I created a test scenario that does not work in 2.17.2, and then with 2.17.3-SNAPSHOT I was able to override the value of `log4j2.configurationFile` in `log4j2.component.properties` by either setting the `LOG4J_CONFIGURATION_FILE` environment variable or the `log4j2.configurationFile` system property. Thanks for working on this!&lt;/p&gt;</comment>
                            <comment id="17535012" author="pkarwasz" created="Wed, 11 May 2022 16:52:07 +0000"  >&lt;p&gt;I am closing the issue then. Thank you for the double check.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                                                <inwardlinks description="Is contained by">
                                        <issuelink>
            <issuekey id="13424847">LOG4J2-3366</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13486869">LOG4J2-3621</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>java</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 27 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0wv8g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>