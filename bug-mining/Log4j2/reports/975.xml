<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:37:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1687] NPE in ThrowableProxy when resolving stack in Java EE/OSGi environment</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1687</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;NPE when logging in Java EE/OSGi environment. &lt;/p&gt;

&lt;p&gt;In some cases the ClassLoader ( &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/lang/Class.html#getClassLoader(&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/7/docs/api/java/lang/Class.html#getClassLoader(&lt;/a&gt;) ) will be null for a Class.&lt;/p&gt;

&lt;p&gt;With the changes introduced in &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1457&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/LOG4J2-1457&lt;/a&gt; logging with %xEx can cause a NullPointerExeception when trying to resolve the stack.&lt;/p&gt;

&lt;p&gt;Since it&apos;s not a common occurrence in most environments I suggest the ThrowableProxy swallow the NPE in the same way it swallows SecurityExeception and other classloading exceptions to avoid extra branching for all environments.&lt;/p&gt;
</description>
                <environment>&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;java version &quot;1.7.0_80&quot; ,Java(TM) SE Runtime Environment (build 1.7.0_80-b15), Java HotSpot(TM) 64-Bit Server VM (build 24.80-b11, mixed mode)&lt;/li&gt;
	&lt;li&gt;Jboss EAP 5.2.0-EAP&lt;/li&gt;
&lt;/ul&gt;
</environment>
        <key id="13019747">LOG4J2-1687</key>
            <summary>NPE in ThrowableProxy when resolving stack in Java EE/OSGi environment</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ggregory">Gary D. Gregory</assignee>
                                    <reporter username="hjertmann">Robert Christiansen</reporter>
                        <labels>
                            <label>easyfix</label>
                    </labels>
                <created>Thu, 10 Nov 2016 06:36:51 +0000</created>
                <updated>Wed, 7 Dec 2016 18:00:40 +0000</updated>
                            <resolved>Tue, 6 Dec 2016 16:23:53 +0000</resolved>
                                    <version>2.7</version>
                                    <fixVersion>2.8</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15653207" author="hjertmann" created="Thu, 10 Nov 2016 06:39:27 +0000"  >&lt;p&gt;Stacktrace and patch.&lt;/p&gt;

&lt;p&gt;Fix tested successfully in our environments.&lt;/p&gt;
</comment>
                            <comment id="15704515" author="garydgregory" created="Tue, 29 Nov 2016 07:32:08 +0000"  >&lt;p&gt;This is some funky special case. &lt;tt&gt;Object.getClass()&lt;/tt&gt; returns null where the object is a &lt;tt&gt;ThrowableProxy&lt;/tt&gt;? How is that possible? The Javadoc for &lt;tt&gt;Object.getClass()&lt;/tt&gt; in Java 7 does not even hint that null is a legal return value. Have you tried using one of the &lt;tt&gt;LoaderUtil&lt;/tt&gt; methods instead of &lt;tt&gt;this.getClass().getClassLoader().loadClass(className)&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="15704553" author="hjertmann" created="Tue, 29 Nov 2016 07:44:37 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=garydgregory&quot; class=&quot;user-hover&quot; rel=&quot;garydgregory&quot;&gt;garydgregory&lt;/a&gt;, it is the &lt;tt&gt;Class.getClassLoader()&lt;/tt&gt; that can return null, not the &lt;tt&gt;Object.getClass()&lt;/tt&gt; which makes more sense I hope. Issue &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1457&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;LOG4J2-1457&lt;/a&gt; removed the usage of &lt;tt&gt;LoaderUtil&lt;/tt&gt; (but introduced the NPE) due to issues with deadlocks and the ClassLoader in some cases.&lt;/p&gt;</comment>
                            <comment id="15707496" author="jvz" created="Wed, 30 Nov 2016 04:25:45 +0000"  >&lt;p&gt;&lt;tt&gt;Class.getClassLoader()&lt;/tt&gt; can return null for the bootstrap &lt;tt&gt;ClassLoader&lt;/tt&gt;, so that would also cause a NPE.&lt;/p&gt;

&lt;p&gt;That is also why it would be a better idea to use &lt;tt&gt;LoaderUtil&lt;/tt&gt; as it accounts for that special case.&lt;/p&gt;</comment>
                            <comment id="15707574" author="garydgregory" created="Wed, 30 Nov 2016 05:13:22 +0000"  >&lt;p&gt;Wholly Cow, you&apos;re right! &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/lang/Class.html#getClassLoader(&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/7/docs/api/java/lang/Class.html#getClassLoader(&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="15707579" author="garydgregory" created="Wed, 30 Nov 2016 05:16:29 +0000"  >&lt;p&gt;Where else is this going to be a problem?&lt;/p&gt;

&lt;p&gt;I&apos;m not a fan of the style of the patch because you cannot tell that you are guarding against the null class loader, it&apos;s too mysterious IMO. A null check with a comment would be better from a maintenance POV. But that&apos;s just me.&lt;/p&gt;</comment>
                            <comment id="15708845" author="hjertmann" created="Wed, 30 Nov 2016 15:14:23 +0000"  >&lt;p&gt;I agree with your assessment. It was a necessary fix to get production flowing again with minimal changes (not too happy about running on home patched versions of 3rd party libraries). Before the last fix, the &lt;tt&gt;LoaderUtil&lt;/tt&gt; was also used, but since the method of loading/initializing the class was no longer used the guards that comes with the Util is no longer in place.&lt;/p&gt;

&lt;p&gt;I can prepare a proper patch if you like. I have set some time aside later this week.&lt;/p&gt;</comment>
                            <comment id="15709236" author="garydgregory" created="Wed, 30 Nov 2016 17:44:22 +0000"  >&lt;p&gt;It sounds like we need a clean fix for this so you do not have to rely on a patch library. Please attach you patch here when you can. I&apos;m not sure how this can best be unit tested.&lt;/p&gt;</comment>
                            <comment id="15724850" author="hjertmann" created="Tue, 6 Dec 2016 08:56:31 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=garydgregory&quot; class=&quot;user-hover&quot; rel=&quot;garydgregory&quot;&gt;garydgregory&lt;/a&gt;, I&apos;ve attached a possible patch with test. Unfortunately I couldn&apos;t get a meaningful test in place for ThrowableProxy since I was unable to get a &lt;tt&gt;null&lt;/tt&gt; response for &lt;tt&gt;class.getClassLoader&lt;/tt&gt; even with Mockito or cglib. Not saying it&apos;s not possible, but there are some restrictions on reflection and final fields that was in the way for me. I did not go the path of changing the runtime environment, which could be an avenue to get it under test.&lt;/p&gt;

&lt;p&gt;Since it&apos;s a simple refactoring, I&apos;ve simply moved the check out in the &lt;tt&gt;LoaderUtil&lt;/tt&gt; as per &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jvz&quot; class=&quot;user-hover&quot; rel=&quot;jvz&quot;&gt;jvz&lt;/a&gt; recommendation and put the method it under test.&lt;/p&gt;</comment>
                            <comment id="15725954" author="garydgregory" created="Tue, 6 Dec 2016 16:23:55 +0000"  >&lt;p&gt;In git master. Please verify and fix.&lt;/p&gt;</comment>
                            <comment id="15728656" author="hjertmann" created="Wed, 7 Dec 2016 12:31:58 +0000"  >&lt;p&gt;Fix verified with build from git master on staging servers.&lt;/p&gt;</comment>
                            <comment id="15729404" author="garydgregory" created="Wed, 7 Dec 2016 18:00:40 +0000"  >&lt;p&gt;Closing, fix verified by user.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12841906" name="LOG4J2-1687.patch" size="3923" author="hjertmann" created="Tue, 6 Dec 2016 08:56:31 +0000"/>
                            <attachment id="12838301" name="error.log" size="3791" author="hjertmann" created="Thu, 10 Nov 2016 06:39:27 +0000"/>
                            <attachment id="12838302" name="patch.diff" size="1193" author="hjertmann" created="Thu, 10 Nov 2016 06:39:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 50 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i365sn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>