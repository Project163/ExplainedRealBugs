<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:30:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-161] Using Log4J2 in Tomcat and WebApp results in all messages being sent to Tomcat&apos;s logger</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-161</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;We are experiencing difficulty getting web applications deployed under Tomcat 6.0.x to honor per-app Log4J2 configuration, when Tomcat itself has been modified to also use Log4J2.&lt;/p&gt;

&lt;p&gt;I will attach a modified Tomcat archive with the following steps applied:&lt;br/&gt;
1. Download and decompress Tomcat 6.0.36&lt;br/&gt;
2. Follow steps #3 and #4 at &lt;a href=&quot;https://tomcat.apache.org/tomcat-6.0-doc/logging.html#Using_Log4j&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://tomcat.apache.org/tomcat-6.0-doc/logging.html#Using_Log4j&lt;/a&gt; , but instead of using Log4J 1.x, use Log4J 2.0-beta4 core, api, and log4j-1.2 jars.&lt;br/&gt;
3. Deploy a web application to Tomcat which includes Log4J 2.0-beta4 .jar files, and includes the following in web.xml:&lt;br/&gt;
  	&amp;lt;context-param&amp;gt;&lt;br/&gt;
		&amp;lt;param-name&amp;gt;log4jConfiguration&amp;lt;/param-name&amp;gt;&lt;br/&gt;
		&amp;lt;param-value&amp;gt;${log4j.app.configurationFile}&amp;lt;/param-value&amp;gt;&lt;br/&gt;
	&amp;lt;/context-param&amp;gt;&lt;/p&gt;

&lt;p&gt;	&amp;lt;listener&amp;gt;&lt;br/&gt;
		&amp;lt;listener-class&amp;gt;org.apache.logging.log4j.core.web.Log4jContextListener&amp;lt;/listener-class&amp;gt;&lt;br/&gt;
	&amp;lt;/listener&amp;gt;&lt;br/&gt;
4. Create two Log4J2 configuration files, one for Tomcat and one for the web app. They should use different PatternLayouts so output can be distinguished from each other.&lt;br/&gt;
5. Launch Tomcat, passing the following environment variable:&lt;br/&gt;
CATALINA_OPTS=&quot;-Dlog4j.app.configurationFile=/path/to/log4j2-webapp.xml -Dlog4j.configurationFile=/path/to/log4j2-tomcat.xml&quot;&lt;br/&gt;
6. Force the web app to generate a log message.&lt;br/&gt;
7. View Tomcat&apos;s catalina.out file, and observe messages from the web app are output with Tomcat&apos;s configured PatternLayout.&lt;/p&gt;


&lt;p&gt;With the attached Tomcat archive, it&apos;s simplified to :&lt;br/&gt;
1. Unzip tomcat-6.0.36-log4j2.tar.gz&lt;br/&gt;
2. Set the CATALINA_OPTS environment variable to:&lt;br/&gt;
CATALINA_OPTS=&quot;-Dlog4j.app.configurationFile=/path/to/tomcat-6.0.36/webapps/log4j2-tomcat/WEB-INF/log4j2.xml -Dlog4j.configurationFile=/path/to/tomcat-6.0.36/conf/log4j2.xml&quot;&lt;br/&gt;
3. Run the platform-appropriate startup.&lt;span class=&quot;error&quot;&gt;&amp;#91;sh|bat&amp;#93;&lt;/span&gt; file&lt;br/&gt;
4. Access &lt;a href=&quot;http://localhost:8080/log4j2-tomcat/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/log4j2-tomcat/&lt;/a&gt; in a web browser.&lt;/p&gt;

&lt;p&gt;/path/to/tomcat-6.0.36/logs/catalina.out will contain something like:&lt;br/&gt;
TOMCAT: 16:53:09.065 INFO  org.apache.coyote.http11.Http11Protocol - Starting Coyote HTTP/1.1 on http-8080&lt;br/&gt;
TOMCAT: 16:53:09.096 INFO  org.apache.jk.common.ChannelSocket - JK: ajp13 listening on /0.0.0.0:8009&lt;br/&gt;
TOMCAT: 16:53:09.099 INFO  org.apache.jk.server.JkMain - Jk running ID=0 time=0/10  config=null&lt;br/&gt;
TOMCAT: 16:53:09.100 INFO  org.apache.catalina.startup.Catalina - Server startup in 324 ms&lt;br/&gt;
TOMCAT: 16:53:23.617 WARN  JSP - App message 1&lt;/p&gt;

&lt;p&gt;The final message is from the web app, and &lt;b&gt;should&lt;/b&gt; be prefixed with &quot;APP&quot; instead of &quot;TOMCAT&quot;.&lt;/p&gt;

&lt;p&gt;We&apos;ve run this process in a debugger, and can observe Log4J2 being initialized both by Tomcat and the web app, with no errors. Still, for some reason the web application is using Tomcat&apos;s configuration instead of the supplied app-specific config file.&lt;/p&gt;

&lt;p&gt;A mailing list suggestion was to only include Log4J2 core .jar in Tomcat (not in the web app). However, at startup, we get the &quot;SimpleLogger&quot; error message from the web app, as the Tomcat&apos;s version of the Log4J2 core .jar is hidden from the web app&apos;s classloader.&lt;/p&gt;

&lt;p&gt;We&apos;re at a loss. Due to Tomcat&apos;s architecture, we seemingly &lt;b&gt;must&lt;/b&gt; include Log4J2 core in both Tomcat and the web app. In a debugger, we can see both configuration files being loaded. However, when the application sends log messages, they end up using Tomcat&apos;s configuration.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu 12.04 64bit: Java 1.6.0_38&lt;br/&gt;
Solaris 10 u9 x64: Java 1.6.0_33&lt;/p&gt;

&lt;p&gt;Tomcat 6.0.29 and Tomcat 6.0.36&lt;/p&gt;</environment>
        <key id="12630958">LOG4J2-161</key>
            <summary>Using Log4J2 in Tomcat and WebApp results in all messages being sent to Tomcat&apos;s logger</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rgoers">Ralph Goers</assignee>
                                    <reporter username="ssevertson">Scott Severtson</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Feb 2013 22:09:14 +0000</created>
                <updated>Sun, 3 Mar 2013 21:44:05 +0000</updated>
                            <resolved>Sun, 3 Mar 2013 21:44:05 +0000</resolved>
                                    <version>2.0-beta4</version>
                                    <fixVersion>2.0-beta5</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13571790" author="ssevertson" created="Tue, 5 Feb 2013 22:10:25 +0000"  >&lt;p&gt;Tomcat pre-configured with Log4J2 and sample web application to demonstrate the problem.&lt;/p&gt;</comment>
                            <comment id="13571792" author="ssevertson" created="Tue, 5 Feb 2013 22:12:18 +0000"  >&lt;p&gt;FYI, there&apos;s no complied classes in the web app included in the Tomcat demo. Just a web.xml file, an index.jsp file to invoke logging, and Log4J2 .jar files in WEB-INF/lib. We have also confirmed that the problem exists in compiled class files, but went for the simplest demonstration possible.&lt;/p&gt;</comment>
                            <comment id="13585526" author="ralph.goers@dslextreme.com" created="Sun, 24 Feb 2013 22:57:34 +0000"  >&lt;p&gt;Here is what I see when I debug it:&lt;br/&gt;
1. You are configured to use the ClassLoaderContextSelector, which is the default.&lt;br/&gt;
2. The class that shows up when the JSP calls getLogger is org.apache.jsp.index_jsp.&lt;br/&gt;
3. This class has a class loader of org.apache.jasper.servlet.JasperLoader.  &lt;br/&gt;
4. It has no LoggerContext associated with it and there is no configuration being passed to create the LoggerContext.&lt;br/&gt;
5. It has a parent ClassLoader of the WebAppClassLoader which does have a LoggerContext and a configuration.&lt;/p&gt;

&lt;p&gt;Due to this a new LoggerContext is created and it is reconfigured with the configuration from the log4j.configurationFile property.&lt;br/&gt;
You can actually see all of this if you enable status=&quot;debug&quot; in the tomcat log4j2.xml.&lt;/p&gt;

&lt;p&gt;Oh - and the ThreadContext ClassLoader is also the WebAppClassLoader.&lt;/p&gt;

&lt;p&gt;I&apos;m going to have to test with JBoss but my suspicion is that it doesn&apos;t make sense to choose the current class loader if it has no configuration and it has a parent that does have a configuration, especially if that ClassLoader is the ThreadContext ClassLoader.&lt;/p&gt;</comment>
                            <comment id="13585661" author="ralph.goers@dslextreme.com" created="Mon, 25 Feb 2013 06:47:03 +0000"  >&lt;p&gt;The attached patch fixes the problem under Tomcat. I still need to test it with JBoss and a couple of other environmens.&lt;/p&gt;</comment>
                            <comment id="13591875" author="ralph.goers@dslextreme.com" created="Sun, 3 Mar 2013 21:44:05 +0000"  >&lt;p&gt;Fixed in revision 1452133. Please verify and close.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12570733" name="LOG4J2-161.patch" size="20599" author="rgoers" created="Mon, 25 Feb 2013 06:47:03 +0000"/>
                            <attachment id="12568098" name="tomcat-6.0.36-log4j2.tar.gz" size="6753207" author="ssevertson" created="Tue, 5 Feb 2013 22:10:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>311454</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 38 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1hqzr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>311800</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>