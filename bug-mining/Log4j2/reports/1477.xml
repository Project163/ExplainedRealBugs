<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:42:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-3131] Attempting to call getExtendedStackTraceAsString() after deserializing JSON LogEvent results in a NPE</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-3131</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;How to reproduce:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Generate a LogEvent with an Exception that has at least one cause (i.e. nested Exception)&lt;/li&gt;
	&lt;li&gt;Use the standard JSON Layout to turn that LogEvent into JSON&lt;/li&gt;
	&lt;li&gt;Using JsonLogEventParser to turn it back into a LogEvent&lt;/li&gt;
	&lt;li&gt;Call getExtendedStackTraceAsString() on the ThrowableProxy associated with the deserialized LogEvent&lt;/li&gt;
	&lt;li&gt;A NullPointerException will be thrown&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;ve attached a small example project to reproduce the error.&#160;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13392178">LOG4J2-3131</key>
            <summary>Attempting to call getExtendedStackTraceAsString() after deserializing JSON LogEvent results in a NPE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ggregory">Gary D. Gregory</assignee>
                                    <reporter username="adam@adam-long.net">Adam Long</reporter>
                        <labels>
                    </labels>
                <created>Tue, 27 Jul 2021 17:34:15 +0000</created>
                <updated>Thu, 29 Jul 2021 12:40:55 +0000</updated>
                            <resolved>Thu, 29 Jul 2021 12:40:06 +0000</resolved>
                                    <version>2.14.1</version>
                                    <fixVersion>3.0.0</fixVersion>
                    <fixVersion>2.15.0</fixVersion>
                                    <component>Layouts</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17388212" author="garydgregory" created="Tue, 27 Jul 2021 17:39:05 +0000"  >&lt;p&gt;May you post the stack trace here please?&lt;/p&gt;</comment>
                            <comment id="17388250" author="adam@adam-long.net" created="Tue, 27 Jul 2021 18:47:11 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.NullPointerException
	at org.apache.logging.log4j.core.impl.ThrowableProxyRenderer.formatElements(ThrowableProxyRenderer.java:91)
	at org.apache.logging.log4j.core.impl.ThrowableProxyRenderer.formatThrowableProxy(ThrowableProxyRenderer.java:71)
	at org.apache.logging.log4j.core.impl.ThrowableProxyRenderer.formatCause(ThrowableProxyRenderer.java:57)
	at org.apache.logging.log4j.core.impl.ThrowableProxyRenderer.formatExtendedStackTraceTo(ThrowableProxyRenderer.java:182)
	at org.apache.logging.log4j.core.impl.ThrowableProxy.formatExtendedStackTraceTo(ThrowableProxy.java:374)
	at org.apache.logging.log4j.core.impl.ThrowableProxy.getExtendedStackTraceAsString(ThrowableProxy.java:360)
	at org.apache.logging.log4j.core.impl.ThrowableProxy.getExtendedStackTraceAsString(ThrowableProxy.java:313)
	at example.StringAppender.append(StringAppender.java:42)
	at org.apache.logging.log4j.core.config.AppenderControl.tryCallAppender(AppenderControl.java:156)
	at org.apache.logging.log4j.core.config.AppenderControl.callAppender0(AppenderControl.java:129)
	at org.apache.logging.log4j.core.config.AppenderControl.callAppenderPreventRecursion(AppenderControl.java:120)
	at org.apache.logging.log4j.core.config.AppenderControl.callAppender(AppenderControl.java:84)
	at org.apache.logging.log4j.core.config.LoggerConfig.callAppenders(LoggerConfig.java:540)
	at org.apache.logging.log4j.core.config.LoggerConfig.processLogEvent(LoggerConfig.java:498)
	at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:481)
	at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:456)
	at org.apache.logging.log4j.core.config.AwaitCompletionReliabilityStrategy.log(AwaitCompletionReliabilityStrategy.java:82)
	at org.apache.logging.log4j.core.Logger.log(Logger.java:161)
	at org.apache.logging.log4j.spi.AbstractLogger.tryLogMessage(AbstractLogger.java:2205)
	at org.apache.logging.log4j.spi.AbstractLogger.logMessageTrackRecursion(AbstractLogger.java:2159)
	at org.apache.logging.log4j.spi.AbstractLogger.logMessageSafely(AbstractLogger.java:2142)
	at org.apache.logging.log4j.spi.AbstractLogger.logMessage(AbstractLogger.java:2017)
	at org.apache.logging.log4j.spi.AbstractLogger.logIfEnabled(AbstractLogger.java:1983)
	at org.apache.logging.log4j.spi.AbstractLogger.error(AbstractLogger.java:750)
	at example.Main.main(Main.java:8)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17388251" author="adam@adam-long.net" created="Tue, 27 Jul 2021 18:49:14 +0000"  >&lt;p&gt;For what it&apos;s worth, here&apos;s the JSON that is being worked on:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-json&quot;&gt;
{
  &lt;span class=&quot;code-quote&quot;&gt;&quot;instant&quot;&lt;/span&gt; : {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;epochSecond&quot;&lt;/span&gt; : 1627411715,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;nanoOfSecond&quot;&lt;/span&gt; : 689093000
  },
  &lt;span class=&quot;code-quote&quot;&gt;&quot;thread&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;level&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;ERROR&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;loggerName&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;example.Main&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;message&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;Hello World&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;thrown&quot;&lt;/span&gt; : {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;commonElementCount&quot;&lt;/span&gt; : 0,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;localizedMessage&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.IllegalArgumentException: This is a test&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;message&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.IllegalArgumentException: This is a test&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.RuntimeException&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;cause&quot;&lt;/span&gt; : {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;commonElementCount&quot;&lt;/span&gt; : 1,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;localizedMessage&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;This is a test&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;message&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;This is a test&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.IllegalArgumentException&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;cause&quot;&lt;/span&gt; : {
        &lt;span class=&quot;code-quote&quot;&gt;&quot;commonElementCount&quot;&lt;/span&gt; : 1,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;localizedMessage&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;Third Exception&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;message&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;Third Exception&quot;&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.RuntimeException&quot;&lt;/span&gt;
      }
    },
    &lt;span class=&quot;code-quote&quot;&gt;&quot;extendedStackTrace&quot;&lt;/span&gt; : [ {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;class&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;example.Main&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;method&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;file&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;Main.java&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;line&quot;&lt;/span&gt; : 8,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;exact&quot;&lt;/span&gt; : &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;location&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;classes/&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;version&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;?&quot;&lt;/span&gt;
    } ]
  },
  &lt;span class=&quot;code-quote&quot;&gt;&quot;endOfBatch&quot;&lt;/span&gt; : &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;loggerFqcn&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.logging.log4j.spi.AbstractLogger&quot;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;threadId&quot;&lt;/span&gt; : 1,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;threadPriority&quot;&lt;/span&gt; : 5
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17388633" author="vy" created="Wed, 28 Jul 2021 09:20:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adam%40adam-long.net&quot; class=&quot;user-hover&quot; rel=&quot;adam@adam-long.net&quot;&gt;adam@adam-long.net&lt;/a&gt;, thanks so much for the bug report, including the detailed context and the reproduction path. I think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt; will check it out. In the meantime, I was curious if switching from &lt;tt&gt;JsonLayout&lt;/tt&gt; to &lt;a href=&quot;https://logging.apache.org/log4j/2.x/manual/json-template-layout.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JsonTemplateLayout&lt;/a&gt; is an option for you. In essence, &lt;tt&gt;JsonTemplateLayout&lt;/tt&gt; is the successor of &lt;tt&gt;JsonLayout&lt;/tt&gt;; better in terms of performance, customizability, and features. In the JSON-serialized &lt;tt&gt;LogEvent&lt;/tt&gt; that you have shared, I see that you are serializing the stack trace into an object rather than a string. While there is nothing wrong with that, &lt;tt&gt;JsonLayout&lt;/tt&gt;, IMHO, has a very naive way of serializing the stack trace: It just throws the &lt;tt&gt;Throwable&lt;/tt&gt; instance into the &lt;tt&gt;ObjectMapper&lt;/tt&gt; of Jackson. Consequently, Jackson treats it as a yet another POJO and you end up having a nested set of objects with all the fields exposed by a &lt;tt&gt;Throwable&lt;/tt&gt;. To say the least, such a nested structure is mostly incompatible with any log sink (e.g., Elasticsearch) out there in the wild. In contrast, &lt;tt&gt;JsonTemplateLayout&lt;/tt&gt; serializes &lt;tt&gt;Throwable&lt;/tt&gt;&apos;s into a sink-friendly flat list of objects. In conclusion, I strongly advise you to migrate to &lt;tt&gt;JsonTemplateLayout&lt;/tt&gt;, if possible.&lt;/p&gt;

&lt;p&gt;A follow-up question I have is, what are you exactly trying to do by deserializing from &lt;tt&gt;LogEvent&lt;/tt&gt;&apos;s? What is your use case?&lt;/p&gt;</comment>
                            <comment id="17388656" author="adam@adam-long.net" created="Wed, 28 Jul 2021 09:47:29 +0000"  >&lt;p&gt;My use-case has us storing the stack trace for future debugging purposes - we end up shoving it into a database as a String anyways.  I was simply trying to take the path of least resistance for transport - use the tools available to turn it into JSON then back into POJO, then into a typical Java-formatted stack trace String.&lt;/p&gt;

&lt;p&gt;I&apos;ll give JsonTemplateLayout a shot.  Thanks for the tip.&lt;/p&gt;</comment>
                            <comment id="17388733" author="jira-bot" created="Wed, 28 Jul 2021 12:36:19 +0000"  >&lt;p&gt;Commit edbba3e6a7f2ed37afb0674653ace4bb7d5231ae in logging-log4j2&apos;s branch refs/heads/release-2.x from Gary Gregory&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=edbba3e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=edbba3e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3131&quot; title=&quot;Attempting to call getExtendedStackTraceAsString() after deserializing JSON LogEvent results in a NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3131&quot;&gt;&lt;del&gt;LOG4J2-3131&lt;/del&gt;&lt;/a&gt; Attempting to call getExtendedStackTraceAsString() after&lt;br/&gt;
deserializing JSON LogEvent results in a NPE.&lt;/p&gt;</comment>
                            <comment id="17388752" author="garydgregory" created="Wed, 28 Jul 2021 12:52:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adam%40adam-long.net&quot; class=&quot;user-hover&quot; rel=&quot;adam@adam-long.net&quot;&gt;adam@adam-long.net&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I fixed this in the git branch &lt;tt&gt;release-2.x&lt;/tt&gt;. Please verify your use case. You can try the git branch or a SNAPSHOT build from &lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/org/apache/logging/log4j/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/logging/log4j/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17388849" author="adam@adam-long.net" created="Wed, 28 Jul 2021 15:20:23 +0000"  >&lt;p&gt;Works on my local test.  Thanks for the quick turnaround.&lt;/p&gt;</comment>
                            <comment id="17388913" author="jira-bot" created="Wed, 28 Jul 2021 18:03:11 +0000"  >&lt;p&gt;Commit bcf8adb88cc6c35e387421f2873522db32f81c34 in logging-log4j2&apos;s branch refs/heads/master from Gary Gregory&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=bcf8adb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=bcf8adb&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3131&quot; title=&quot;Attempting to call getExtendedStackTraceAsString() after deserializing JSON LogEvent results in a NPE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3131&quot;&gt;&lt;del&gt;LOG4J2-3131&lt;/del&gt;&lt;/a&gt; Attempting to call getExtendedStackTraceAsString() after&lt;br/&gt;
deserializing JSON LogEvent results in a NPE.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13031123" name="example.zip" size="3135" author="adam@adam-long.net" created="Tue, 27 Jul 2021 17:31:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 16 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0tdqo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>