<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:41:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-2756] ClassLoaderContextSelector: WeakReference and GC</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-2756</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;A race-condition between GC and WeakReference in ClassLoaderContextSelector can lead to a NPE in Log4jContextFactory.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.NullPointerException
&#160;&#160; &#160;at org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:152)
&#160;&#160; &#160;at org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:45)
&#160;&#160; &#160;at org.apache.logging.log4j.LogManager.getContext(LogManager.java:194)
&#160;&#160; &#160;at org.apache.logging.log4j.LogManager.getLogger(LogManager.java:602)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In org.apache.logging.log4j.core.selector.ClassLoaderContextSelector there is the following creation of a LoggerContext in method locateContext:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; LoggerContext ctx = createContext(name, configLocation);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; AtomicReference&amp;lt;WeakReference&amp;lt;LoggerContext&amp;gt;&amp;gt; r = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AtomicReference&amp;lt;&amp;gt;();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; r.set(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; WeakReference&amp;lt;&amp;gt;(ctx));
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; CONTEXT_MAP.putIfAbsent(name, r);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ctx = CONTEXT_MAP.get(name).get().get();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ctx;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The created LoggerContext is stored in local variable ctx. After storing the LoggerContext into a WeakReference the local variable isn&apos;t read until overridden by a new value out of the CONTEXT_MAP. A garbage collection between creating the WeakReference and reading the CONTEXT_MAP might remove the LoggerContext.&lt;/p&gt;

&lt;p&gt;This leads to intermittent failures in JVMs like OpenJ9 which mark locals as not-an-object so they can be collected as soon as possible. See also: &lt;a href=&quot;https://github.com/eclipse/openj9/issues/4005&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/eclipse/openj9/issues/4005&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;The problem depends on the implemention of the WeakReference-check in the used garbage collection algorithm of the JVM.&lt;/p&gt;

&lt;p&gt;Examples of affected JVMs:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;OpenJ9 OpenJDK8U-jdk_x64_linux_openj9_8u232b09_openj9-0.17.0.tar.gz (in combination with log4j-core-2.13.0.jar)&lt;/li&gt;
	&lt;li&gt;IBM JRE 1.8.0_221 z/OS (with log4j-2.8.1)&lt;/li&gt;
	&lt;li&gt;OpenJ9 JDK8 linux_x86 2115.LT2 (with log4j-2.3)&lt;/li&gt;
	&lt;li&gt;OpenJ9 JDK11 x86_mac 441.WL4&#160;(with log4j-2.3)&lt;/li&gt;
	&lt;li&gt;OpenJ9 JDK13 146 (&lt;a href=&quot;https://ci.eclipse.org/openj9/job/Test_openjdk13_j9_extended.system_ppc64le_linux_Nightly/146/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.eclipse.org/openj9/job/Test_openjdk13_j9_extended.system_ppc64le_linux_Nightly/146/&lt;/a&gt; with log4j-2.3)&lt;/li&gt;
&lt;/ul&gt;
</environment>
        <key id="13278126">LOG4J2-2756</key>
            <summary>ClassLoaderContextSelector: WeakReference and GC</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rogmann">Sascha Rogmann</reporter>
                        <labels>
                    </labels>
                <created>Wed, 8 Jan 2020 10:23:04 +0000</created>
                <updated>Mon, 9 Mar 2020 19:41:23 +0000</updated>
                            <resolved>Sun, 23 Feb 2020 06:35:40 +0000</resolved>
                                    <version>2.13.0</version>
                                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17011602" author="rogmann" created="Thu, 9 Jan 2020 09:27:00 +0000"  >&lt;p&gt;The following proposal holds the LoggerContext until the CONTEXT_MAP has been read.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; LoggerContext ctxJustCreated = createContext(name, configLocation);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; AtomicReference&amp;lt;WeakReference&amp;lt;LoggerContext&amp;gt;&amp;gt; r = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AtomicReference&amp;lt;&amp;gt;();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; r.set(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; WeakReference&amp;lt;&amp;gt;(ctxJustCreated));
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-comment&quot;&gt;// CONTEXT_MAP: use only one LoggerContext in &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; of parallel threads.
&lt;/span&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; CONTEXT_MAP.putIfAbsent(name, r);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; LoggerContext ctxContextMap = CONTEXT_MAP.get(name).get().get();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-comment&quot;&gt;// LOG4J2-2756: Prevent the GC from collection of ctxJustCreated by reading it
&lt;/span&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-comment&quot;&gt;// after the call of CONTEXT_MAP.get.
&lt;/span&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ctxContextMap == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-comment&quot;&gt;// The call of ctxJustCreated.toString() turns ctxJustCreated into
&lt;/span&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-comment&quot;&gt;// a strong reference and prevents ctxContextMap == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;.
&lt;/span&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;CONTEXT_MAP contains neither just created LoggerContext (%s) nor a parallel computed one.&quot;&lt;/span&gt;,
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ctxJustCreated));
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ctxContextMap;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17042797" author="ralph.goers@dslextreme.com" created="Sun, 23 Feb 2020 05:14:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2366&quot; title=&quot;LoggerContext leak using Log4jLoggerFactory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2366&quot;&gt;&lt;del&gt;LOG4J2-2366&lt;/del&gt;&lt;/a&gt; added support for a shutdown listener to explicitly remove references to the LoggerContext. That should have fixed this problem but a block of code that was applied to master somehow got missed being applied to the release-2.x branch. The code has now been modified to do:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
LoggerContext ctx = createContext(name, configLocation);
LoggerContext newContext = CONTEXT_MAP.computeIfAbsent(name,
      k -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AtomicReference&amp;lt;&amp;gt;(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; WeakReference&amp;lt;&amp;gt;(ctx))).get().get();
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (newContext == ctx) {
    ctx.addShutdownListener(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
}
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; newContext;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I believe this should resolve the issue. As I have no good way to verify the fix I would appreciate it if you could provide feedback.&lt;/p&gt;</comment>
                            <comment id="17042807" author="jira-bot" created="Sun, 23 Feb 2020 06:29:52 +0000"  >&lt;p&gt;Commit c98e8981fb26f0bc69c782f4993e0672bab95a4c in logging-log4j2&apos;s branch refs/heads/master from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=c98e898&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=c98e898&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2756&quot; title=&quot;ClassLoaderContextSelector: WeakReference and GC&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2756&quot;&gt;&lt;del&gt;LOG4J2-2756&lt;/del&gt;&lt;/a&gt; - Prevent LoggerContext from being garbage collected while being created.&lt;/p&gt;</comment>
                            <comment id="17042808" author="jira-bot" created="Sun, 23 Feb 2020 06:29:58 +0000"  >&lt;p&gt;Commit 1482062a163734a63de176a69cff8ad71f5ed468 in logging-log4j2&apos;s branch refs/heads/release-2.x from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=1482062&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=1482062&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2756&quot; title=&quot;ClassLoaderContextSelector: WeakReference and GC&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2756&quot;&gt;&lt;del&gt;LOG4J2-2756&lt;/del&gt;&lt;/a&gt; - Prevent LoggerContext from being garbage collected while being created.&lt;/p&gt;</comment>
                            <comment id="17042810" author="ralph.goers@dslextreme.com" created="Sun, 23 Feb 2020 06:35:40 +0000"  >&lt;p&gt;Marking as resolved. Please verify and close or reopen if issues are still present.&lt;/p&gt;</comment>
                            <comment id="17042998" author="jira-bot" created="Sun, 23 Feb 2020 17:25:15 +0000"  >&lt;p&gt;Commit b6e5b0234adbd43db7ebd5407f7cfd31f39bbac9 in logging-log4j2&apos;s branch refs/heads/release-2.x from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=b6e5b02&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=b6e5b02&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2756&quot; title=&quot;ClassLoaderContextSelector: WeakReference and GC&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2756&quot;&gt;&lt;del&gt;LOG4J2-2756&lt;/del&gt;&lt;/a&gt; - Prevent LoggerContext from being garbage collected while being created.&lt;/p&gt;</comment>
                            <comment id="17055328" author="rogmann" created="Mon, 9 Mar 2020 19:41:23 +0000"  >&lt;p&gt;I couldn&apos;t reproduce the NPE by using the fixed class.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also a parallel thread calling System.gc and some sleep-statements couldn&apos;t reproduce the problem.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12686057">LOG4J2-477</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12311024" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>External issue ID</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>#4005</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311020" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>External issue URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[https://github.com/eclipse/openj9/issues/4005]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 36 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0aalc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>