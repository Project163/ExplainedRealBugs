<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:36:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1467] [OSGi] Missing import package</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1467</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;The Import-Package statement in log4j-api-2.6.2.jar is missing the package &quot;org.apache.logging.log4j.core.lookup&quot;. This results in the following log output while starting a enterprise OSGi application:&lt;/p&gt;

&lt;p&gt;Blueprint Extender: 3 WARN JNDI lookup class is not available because this JRE does not support JNDI. JNDI string lookups will not be available, continuing configuration. java.lang.ClassNotFoundException: org.apache.logging.log4j.core.lookup.JndiLookup&lt;br/&gt;
        at java.lang.Class.forName(Class.java:256)&lt;br/&gt;
        at org.apache.logging.log4j.util.LoaderUtil.loadClass(LoaderUtil.java:122)&lt;br/&gt;
        at org.apache.logging.log4j.util.LoaderUtil.newInstanceOf(LoaderUtil.java:141)&lt;br/&gt;
        at org.apache.logging.log4j.util.LoaderUtil.newCheckedInstanceOf(LoaderUtil.java:168)&lt;br/&gt;
        at org.apache.logging.log4j.core.util.Loader.newCheckedInstanceOf(Loader.java:301)&lt;br/&gt;
        at org.apache.logging.log4j.core.lookup.Interpolator.&amp;lt;init&amp;gt;(Interpolator.java:95)&lt;br/&gt;
        at org.apache.logging.log4j.core.config.AbstractConfiguration.&amp;lt;init&amp;gt;(AbstractConfiguration.java:116)&lt;/p&gt;

&lt;p&gt;and&lt;/p&gt;

&lt;p&gt;Blueprint Extender: 3 WARN JMX runtime input lookup class is not available because this JRE does not support JMX. JMX lookups will not be available, continuing configuration. java.lang.ClassNotFoundException: org.apache.logging.log4j.core.lookup.JmxRuntimeInputArgumentsLookup&lt;br/&gt;
   (Stacktrace like above)&lt;/p&gt;

&lt;p&gt;As local fix I added &apos;DynamicImport-Package: *&apos; to the MANIFEST.MF. &lt;/p&gt;</description>
                <environment>&lt;p&gt;Enterprise OSGi application&lt;/p&gt;</environment>
        <key id="12990583">LOG4J2-1467</key>
            <summary>[OSGi] Missing import package</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rakus">Ralf</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Jul 2016 22:33:36 +0000</created>
                <updated>Wed, 27 Jul 2016 00:32:56 +0000</updated>
                            <resolved>Tue, 26 Jul 2016 23:50:05 +0000</resolved>
                                    <version>2.6.2</version>
                                    <fixVersion>2.7</fixVersion>
                                    <component>API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15383234" author="jvz" created="Mon, 18 Jul 2016 22:51:38 +0000"  >&lt;p&gt;Yikes, that&apos;s an unfun workaround. Is this only affecting that one package? If so, we can add a &lt;tt&gt;resolution:=optional&lt;/tt&gt; for that package import. If it&apos;s affecting the rest of log4j-core, then we&apos;ll have to add optional imports to all the log4j-core packages which seems rather hacky.&lt;/p&gt;</comment>
                            <comment id="15383335" author="remkop@yahoo.com" created="Tue, 19 Jul 2016 00:05:22 +0000"  >&lt;p&gt;The issue says &quot;log4j-api-2.6.2.jar is missing...&quot;&lt;br/&gt;
Is that correct or should that be the core jar? Not my area of expertise but it seems strange that api would need an osgi configuration that mentions core...&lt;/p&gt;</comment>
                            <comment id="15383349" author="jvz" created="Tue, 19 Jul 2016 00:12:05 +0000"  >&lt;p&gt;This issue might be fixable without screwing around with OSGi package imports. Ideally, log4j-api shouldn&apos;t need to import anything from other bundles because the BundleActivator uses other bundles&apos; ClassLoaders to load a log4j provider. This may be a case where using the TCCL is incorrect, however. I&apos;d like to try and take a closer look at the code path that causes this bug.&lt;/p&gt;

&lt;p&gt;Edit: using the TCCL may still be needed, but setting the TCCL and unsetting it afterward is a typical hack used in these types of scenarios.&lt;/p&gt;</comment>
                            <comment id="15383698" author="rakus" created="Tue, 19 Jul 2016 07:14:07 +0000"  >&lt;p&gt;Just a very quick look at the code (without fully understanding it):&lt;br/&gt;
The class LoaderUtil is exported from log4j-api and is designed to load any class by name, so log4j-api potential needs access to every package.&lt;br/&gt;
The same might be true for org.apache.logging.log4j.core.util.Loader, as this class is exported from log4j-core and it provides a method loadClass(String className).&lt;/p&gt;

&lt;p&gt;I agree, that &quot;DynamicImport-Package&quot; is an &quot;unfun workaround&quot;, but I don&apos;t have any other idea. &lt;/p&gt;</comment>
                            <comment id="15384173" author="jvz" created="Tue, 19 Jul 2016 13:55:31 +0000"  >&lt;p&gt;LoaderUtil is using other ClassLoaders to load classes, so I don&apos;t see why the log4j-api bundle should ever have to know about other bundles. Otherwise, how else are low level reflective libraries supposed to work while also supporting non-OSGi environments?&lt;/p&gt;</comment>
                            <comment id="15386355" author="rakus" created="Wed, 20 Jul 2016 18:15:35 +0000"  >&lt;p&gt;LoaderUtils uses &lt;tt&gt;Class.forName(...)&lt;/tt&gt;, so it depends in the imports declarated in the Manifest.&lt;/p&gt;

&lt;p&gt;I see following possible solutions:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Add &lt;tt&gt;DynamicImport-Package: *&lt;/tt&gt;&lt;/b&gt;&lt;br/&gt;
With this, all available bundles will be searched for the one exporting the needed package. This results in a performance penalty only once, as the result is cached (exception: the result is not cached if the class was not found).&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Handing over the ClassLoader&lt;/b&gt;&lt;br/&gt;
The class &lt;tt&gt;org.apache.logging.log4j.core.util.Loader&lt;/tt&gt; uses &lt;tt&gt;org.apache.logging.log4j.util.LoaderUtil&lt;/tt&gt; to load classes.&lt;br/&gt;
&lt;tt&gt;LoaderUtil&lt;/tt&gt; should provide methods, to specify the class loader to use.&lt;/p&gt;

&lt;p&gt;Like &lt;br/&gt;
&lt;tt&gt;newCheckedInstanceOf(String className, Class&amp;lt;T&amp;gt; clazz, ClassLoader loader)&lt;/tt&gt;. &lt;br/&gt;
It would then be called from &lt;tt&gt;Loader&lt;/tt&gt;  like &lt;br/&gt;
&lt;tt&gt;LoaderUtil.newCheckedInstanceOf(className, clazz, Loader.class.getClassLoader())&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Interesting read: &lt;a href=&quot;http://njbartlett.name/2010/08/30/osgi-readiness-loading-classes.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://njbartlett.name/2010/08/30/osgi-readiness-loading-classes.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15386529" author="jvz" created="Wed, 20 Jul 2016 20:09:15 +0000"  >&lt;p&gt;What are you talking about? Here&apos;s the code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; loadClass(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; className) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; ClassNotFoundException {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isIgnoreTccl()) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(className);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; getThreadContextClassLoader().loadClass(className);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Throwable ignored) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(className);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It only uses Class.forName() as a fallback.&lt;/p&gt;</comment>
                            <comment id="15386667" author="rakus" created="Wed, 20 Jul 2016 21:27:27 +0000"  >&lt;p&gt;I&apos;m talking about the stacktrace in the description of this issue.&lt;/p&gt;</comment>
                            <comment id="15386670" author="jvz" created="Wed, 20 Jul 2016 21:29:52 +0000"  >&lt;p&gt;Oh, then it looks like the TCCL did not have access to the class in question. It might be necessary to set and unset the TCCL instead, because adding Dynamic-Import is a terrible hack for a library.&lt;/p&gt;</comment>
                            <comment id="15390202" author="rakus" created="Fri, 22 Jul 2016 21:13:52 +0000"  >&lt;p&gt;A few thoughts:&lt;/p&gt;

&lt;p&gt;DynamicImport-Package:&lt;/p&gt;

&lt;p&gt;DynamicImport-Package contradicts a basic idea of OSGi. That is, that every JAR (aka Bundle) clearly describes its external dependencies.  With that the OSGi runtime knows at startup time, that all needed packages are available.&lt;/p&gt;

&lt;p&gt;With DynamicImport-Packages, the class loader of the bundle is allowed to search the exported packages of all other bundles at runtime, which might result in ClassNotFound or in a class found with the wrong version.&lt;/p&gt;

&lt;p&gt;From the OSGi point of view DynamicImport-Package is a bad idea and in complex scenarios the result might be unpredictable.&lt;/p&gt;

&lt;p&gt;Setting the ThreadContextClassLoader:&lt;/p&gt;

&lt;p&gt;The LoaderUtil either use the TCCL or its own CL to load the requested class.  In a OSGi environment the TCCL is undefined. AFAIK there are OSGi frameworks that set the TCCL to the bundle class loader, other might just set it to null.  Anyway in OSGi you cannot rely on the TCCL.&lt;/p&gt;

&lt;p&gt;As Matt mentioned the TCCL could be set set befor calling LoaderUtil and reset afterward.&lt;/p&gt;

&lt;p&gt;This adds a hidden prerequisite to the LoaderUtil API. Not good.&lt;/p&gt;

&lt;p&gt;(Also the method LoaderUtil.getThreadContextClassLoader() would be pointless.)&lt;/p&gt;

&lt;p&gt;Refactoring the LoaderUtil methods:&lt;/p&gt;

&lt;p&gt;The third way is to refactor the methods of LoaderUtil, so they require the class loader to use as parameter. The result would be similar to setting the TCCL, but it is clear, that a class loader must be provided. The &quot;old methods&quot; should be deprecated.&lt;/p&gt;

&lt;p&gt;(Again LoaderUtil.getThreadContextClassLoader() would be pointless.)&lt;/p&gt;

&lt;p&gt;From this three options I would prefer the last one.&lt;/p&gt;

&lt;p&gt;There is one scenario that needs additional thinking: The caller of LoaderUtil knows the name of the class to load, but has no idea which classloader should be used.&lt;/p&gt;</comment>
                            <comment id="15390252" author="ralph.goers@dslextreme.com" created="Fri, 22 Jul 2016 21:50:44 +0000"  >&lt;p&gt;Your last sentence is key.  The whole point of LoaderUtil is so the caller doesn&apos;t have to determine what ClassLoader to use.&lt;/p&gt;</comment>
                            <comment id="15390320" author="jvz" created="Fri, 22 Jul 2016 22:42:20 +0000"  >&lt;p&gt;Can we (ab)use ReflectionUtil to get the caller class and use its ClassLoader?&lt;/p&gt;</comment>
                            <comment id="15394231" author="rakus" created="Tue, 26 Jul 2016 18:09:41 +0000"  >&lt;p&gt;Regarding the point &quot;... but has no idea which classloader should be used.&quot;&lt;/p&gt;

&lt;p&gt;I&apos;m still with option thre from above (passing the classloader).&lt;/p&gt;

&lt;p&gt;In OSGi there is the concept of Fragments. Those are special bundles that are loaded into a &quot;host bundle&quot;. Then all classes of the fragment are loadable by the class loader of the host bundle.&lt;/p&gt;

&lt;p&gt;As far as I understand all extensions are loaded from the log4j-core bundle. So extensions need to have that bundle set as &quot;Fragment-Host&quot;.&lt;/p&gt;

&lt;p&gt;Example: If then the class org.apache.logging.log4j.core.util.Loader hands over its own class loader to org.apache.logging.log4j.util.LoaderUtil, it gives LoaderUtil access to all classes inside the log4j-core bundle and its fragments. Hence LoaderUtil is able to load classes from log4j-core (like the class org.apache.logging.log4j.core.lookup.JndiLookup) but also any classes from fragments.&lt;/p&gt;

&lt;p&gt;If my assumption regarding &quot;all extensions are loaded from the log4j-core bundle&quot; is wrong, then a documentation is needed which host plugin should be used for which extension.&lt;/p&gt;</comment>
                            <comment id="15394355" author="jvz" created="Tue, 26 Jul 2016 19:08:35 +0000"  >&lt;p&gt;From what I remember, each bundle&apos;s BundleContext is used to initially load plugin classes. Does that require using fragments?&lt;/p&gt;</comment>
                            <comment id="15394474" author="garydgregory" created="Tue, 26 Jul 2016 20:15:44 +0000"  >&lt;p&gt;I think that what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rakus&quot; class=&quot;user-hover&quot; rel=&quot;rakus&quot;&gt;rakus&lt;/a&gt; is saying is that any Log4j module that has a dependency on log4j-core should have &lt;tt&gt;Fragment-Host:org.apache.logging.log4j.core&lt;/tt&gt; or something similar.&lt;/p&gt;

&lt;p&gt;I thought that &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-351&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/LOG4J2-351&lt;/a&gt; fixed this for 2.0-beta9 but obviously not. That, or the fix is gone and we do not have a regression test for it.&lt;/p&gt;</comment>
                            <comment id="15394479" author="jvz" created="Tue, 26 Jul 2016 20:21:09 +0000"  >&lt;p&gt;That Fragment-Host manifest header isn&apos;t in the pom anymore. There was most likely a different fix that superseded the need for using Fragment-Host, but it appears that it might have regressed since then (or never worked?).&lt;/p&gt;</comment>
                            <comment id="15394486" author="garydgregory" created="Tue, 26 Jul 2016 20:27:34 +0000"  >&lt;p&gt;From &lt;a href=&quot;https://www.ibm.com/support/knowledgecenter/SSHR6W_16.0.0/com.ibm.websphere.wdt.doc/topics/cbundlefragment.htm:&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.ibm.com/support/knowledgecenter/SSHR6W_16.0.0/com.ibm.websphere.wdt.doc/topics/cbundlefragment.htm:&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;A fragment cannot have its own class loader or bundle activator.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Which is what we want in this case.&lt;/p&gt;

&lt;p&gt;Check?&lt;/p&gt;</comment>
                            <comment id="15394491" author="garydgregory" created="Tue, 26 Jul 2016 20:29:21 +0000"  >&lt;p&gt;Hm... right now log4j-api and log4j-core both have Bundle Activators, that seems OK based on the description above.&lt;/p&gt;</comment>
                            <comment id="15394789" author="garydgregory" created="Tue, 26 Jul 2016 23:50:05 +0000"  >&lt;p&gt;Please verify and close (assuming you can build locally).&lt;/p&gt;</comment>
                            <comment id="15394835" author="jvz" created="Wed, 27 Jul 2016 00:30:13 +0000"  >&lt;p&gt;It would also be nice to have a unit or integration test for this, especially if a less hacky method can be supported in the future.&lt;/p&gt;</comment>
                            <comment id="15394840" author="garydgregory" created="Wed, 27 Jul 2016 00:32:56 +0000"  >&lt;p&gt;Good point, testing with Eclipse Equinox and Apache Felix would be good.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12663648">LOG4J2-351</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 17 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3163j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>