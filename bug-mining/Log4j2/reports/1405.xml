<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:41:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-2867] ContextDataProvider will cause concurrent threads blocking at the first logging time</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-2867</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;The recently introduced&#160; `ContextDataProvider` use `ServiceLoader` to find all possible implementations of&#160;ContextDataProvider, which will try to scan all jar files. So when many new threads comes in the first logging time concurrently, all thread will be blocking on the` getProviders` method. It will make web service get very bad performance to serve requests in the beginning.&lt;/p&gt;


&lt;p&gt;Here is an example of blocking thread stack:&lt;/p&gt;

&lt;p&gt;at java.util.zip.ZipFile.getEntry (ZipFile.java:309)at java.util.zip.ZipFile.getEntry (ZipFile.java:309)at java.util.jar.JarFile.getEntry (JarFile.java:240)at java.util.jar.JarFile.getJarEntry (JarFile.java:223)at sun.misc.URLClassPath$JarLoader.getResource (URLClassPath.java:1005)at sun.misc.URLClassPath$JarLoader.findResource (URLClassPath.java:983)at sun.misc.URLClassPath$1.next (URLClassPath.java:240)at sun.misc.URLClassPath$1.hasMoreElements (URLClassPath.java:250)at java.net.URLClassLoader$3$1.run (URLClassLoader.java:601)at java.net.URLClassLoader$3$1.run (URLClassLoader.java:599)at java.security.AccessController.doPrivileged (Native Method)at java.net.URLClassLoader$3.next (URLClassLoader.java:598)at java.net.URLClassLoader$3.hasMoreElements (URLClassLoader.java:623)at sun.misc.CompoundEnumeration.next (CompoundEnumeration.java:45)at sun.misc.CompoundEnumeration.hasMoreElements (CompoundEnumeration.java:54)at sun.misc.CompoundEnumeration.next (CompoundEnumeration.java:45)at sun.misc.CompoundEnumeration.hasMoreElements (CompoundEnumeration.java:54)at java.util.ServiceLoader$LazyIterator.hasNextService (ServiceLoader.java:354)at java.util.ServiceLoader$LazyIterator.hasNext (ServiceLoader.java:393)at java.util.ServiceLoader$1.hasNext (ServiceLoader.java:474)at org.apache.logging.log4j.core.impl.ThreadContextDataInjector.getProviders (ThreadContextDataInjector.java:254)at org.apache.logging.log4j.core.impl.ThreadContextDataInjector.access$000 (ThreadContextDataInjector.java:53)at org.apache.logging.log4j.core.impl.ThreadContextDataInjector$ForDefaultThreadContextMap.&amp;lt;init&amp;gt; (ThreadContextDataInjector.java:74)at org.apache.logging.log4j.core.impl.ContextDataInjectorFactory.createDefaultInjector (ContextDataInjectorFactory.java:91)at org.apache.logging.log4j.core.impl.ContextDataInjectorFactory.createInjector (ContextDataInjectorFactory.java:71)at org.apache.logging.log4j.core.async.RingBufferLogEventTranslator.&amp;lt;init&amp;gt; (RingBufferLogEventTranslator.java:40)at org.apache.logging.log4j.core.async.AsyncLogger.getCachedTranslator (AsyncLogger.java:121)at org.apache.logging.log4j.core.async.AsyncLogger.logWithThreadLocalTranslator (AsyncLogger.java:222)at org.apache.logging.log4j.core.async.AsyncLogger.access$000 (AsyncLogger.java:67)at org.apache.logging.log4j.core.async.AsyncLogger$1.log (AsyncLogger.java:152)at org.apache.logging.log4j.core.async.AsyncLogger.log (AsyncLogger.java:136)at org.apache.logging.log4j.spi.AbstractLogger.tryLogMessage (AbstractLogger.java:2198)at org.apache.logging.log4j.spi.AbstractLogger.logMessageTrackRecursion (AbstractLogger.java:2152)at org.apache.logging.log4j.spi.AbstractLogger.logMessageSafely (AbstractLogger.java:2135)at org.apache.logging.log4j.spi.AbstractLogger.logMessage (AbstractLogger.java:2011)at org.apache.logging.log4j.spi.AbstractLogger.logIfEnabled (AbstractLogger.java:1983)at org.apache.logging.slf4j.Log4jLogger.warn&lt;/p&gt;</description>
                <environment>&lt;p&gt;Java Version: 1.8.0_45&lt;/p&gt;

&lt;p&gt;Web Server: Tomcat 8.0.30&lt;/p&gt;

&lt;p&gt;OS: CentOS 6.8&lt;/p&gt;</environment>
        <key id="13310906">LOG4J2-2867</key>
            <summary>ContextDataProvider will cause concurrent threads blocking at the first logging time</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="emengjzs">Zishun Jiao</reporter>
                        <labels>
                            <label>performance</label>
                    </labels>
                <created>Thu, 11 Jun 2020 11:42:31 +0000</created>
                <updated>Thu, 16 Jul 2020 20:43:59 +0000</updated>
                            <resolved>Mon, 29 Jun 2020 00:48:28 +0000</resolved>
                                    <version>2.13.2</version>
                    <version>2.13.3</version>
                                    <fixVersion>2.14.0</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                    <workratio workratioPercent="1"/>
                                    <progress percentage="1">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="1" backgroundColor="#51a825"/>
                                                    <row percentage="99" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="1">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="1" backgroundColor="#51a825"/>
                                                    <row percentage="99" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="172800">48h</timeoriginalestimate>
                            <timeestimate seconds="171000">47.5h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="17147479" author="jira-bot" created="Mon, 29 Jun 2020 00:39:54 +0000"  >&lt;p&gt;Commit f14654af0bba3fc1382682f538e7ef1bea814c11 in logging-log4j2&apos;s branch refs/heads/master from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=f14654a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=f14654a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2867&quot; title=&quot;ContextDataProvider will cause concurrent threads blocking at the first logging time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2867&quot;&gt;&lt;del&gt;LOG4J2-2867&lt;/del&gt;&lt;/a&gt; - Obtain ContextDataProviders asynchronously&lt;/p&gt;</comment>
                            <comment id="17147480" author="jira-bot" created="Mon, 29 Jun 2020 00:40:32 +0000"  >&lt;p&gt;Commit 102c29427c0aad60da3e51f48d03773b2028ebae in logging-log4j2&apos;s branch refs/heads/release-2.x from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=102c294&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=102c294&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2867&quot; title=&quot;ContextDataProvider will cause concurrent threads blocking at the first logging time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2867&quot;&gt;&lt;del&gt;LOG4J2-2867&lt;/del&gt;&lt;/a&gt; - Measure the time of writing the first log event&lt;/p&gt;</comment>
                            <comment id="17147481" author="jira-bot" created="Mon, 29 Jun 2020 00:40:34 +0000"  >&lt;p&gt;Commit f5392e6b87ea4829894eb0744bf1293cbc43fd99 in logging-log4j2&apos;s branch refs/heads/release-2.x from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=f5392e6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=f5392e6&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2867&quot; title=&quot;ContextDataProvider will cause concurrent threads blocking at the first logging time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2867&quot;&gt;&lt;del&gt;LOG4J2-2867&lt;/del&gt;&lt;/a&gt; - Obtain ContextDataProviders asynchronously&lt;/p&gt;</comment>
                            <comment id="17147482" author="jira-bot" created="Mon, 29 Jun 2020 00:43:16 +0000"  >&lt;p&gt;Commit 4ae84d8d1fadadff851c660eca0596b3d84cd875 in logging-log4j2&apos;s branch refs/heads/release-2.x from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=4ae84d8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=4ae84d8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2867&quot; title=&quot;ContextDataProvider will cause concurrent threads blocking at the first logging time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2867&quot;&gt;&lt;del&gt;LOG4J2-2867&lt;/del&gt;&lt;/a&gt; - Obtain ContextDataProviders asynchronously&lt;/p&gt;</comment>
                            <comment id="17147483" author="jira-bot" created="Mon, 29 Jun 2020 00:43:32 +0000"  >&lt;p&gt;Commit f123ff5d3e209c7ae0def0934890486dd815081f in logging-log4j2&apos;s branch refs/heads/master from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=f123ff5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=f123ff5&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2867&quot; title=&quot;ContextDataProvider will cause concurrent threads blocking at the first logging time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2867&quot;&gt;&lt;del&gt;LOG4J2-2867&lt;/del&gt;&lt;/a&gt; - Obtain ContextDataProviders asynchronously&lt;/p&gt;</comment>
                            <comment id="17147484" author="ralph.goers@dslextreme.com" created="Mon, 29 Jun 2020 00:47:33 +0000"  >&lt;p&gt;I couldn&apos;t really make a test that proves this fix solves the problem. I did create a test that runs faster with this change than before it, but testing the performance of the initial pass through any Java code is subject to wide variation. I also tried to profile this with Yourkit, but again trying to capture the performance of a single execution didn&apos;t yield a very good profiling snapshot.&#160;&lt;/p&gt;

&lt;p&gt;With that said, please try this a see if it addresses the problem you observed.&lt;/p&gt;</comment>
                            <comment id="17153507" author="emengjzs" created="Wed, 8 Jul 2020 11:04:26 +0000"  >&lt;p&gt;The context provider will be initialized only once among all threads after fixed, so it should address the problem.&lt;/p&gt;

&lt;p&gt;I think&#160; we can make a test that starts 1000 threads and log a message in each thread at the same time. It should see the performance between changes.&lt;/p&gt;</comment>
                            <comment id="17157558" author="ckozak" created="Tue, 14 Jul 2020 18:15:18 +0000"  >&lt;p&gt;I think a large part of the problem in this case is that RingBufferLogEventTranslator requests a new instance each time it is constructed. I think we can either use a static instance instead, or pass the static instance from AsyncLogger.&lt;/p&gt;

&lt;p&gt;as an aside, the CompletableFuture.runAsync calls introduced by this change:&lt;br/&gt;
CompletableFuture.runAsync(ThreadContextDataInjector::initServiceProviders);&lt;br/&gt;
 are equivalent to:&lt;/p&gt;

&lt;p&gt;ForkJoinPool.commonPool().submit(ThreadContextDataInjector::initServiceProviders);&lt;/p&gt;

&lt;p&gt;The fork-join pool can be difficult to debug, we may want to use our own pool instead.&lt;/p&gt;</comment>
                            <comment id="17157726" author="ralph.goers@dslextreme.com" created="Tue, 14 Jul 2020 21:54:19 +0000"  >&lt;p&gt;All the initServiceProviders method does is locate all the ContextDataProviders. I don&apos;t know what there would be to debug.&lt;/p&gt;</comment>
                            <comment id="17157740" author="ckozak" created="Tue, 14 Jul 2020 22:53:32 +0000"  >&lt;p&gt;The common failure I&apos;ve encountered occurs when something else submits long-running tasks to the fork-join pool, preventing my tasks from executing. Because the pool is shared, it can be difficult to figure out why a task hasn&apos;t run. The pool also implements work-stealing, so tasks may be executed on a thread that&apos;s blocking waiting for tasks it has submitted to the fork-join pool, possibly with an unexpected context classloader.&lt;/p&gt;</comment>
                            <comment id="17158650" author="ckozak" created="Wed, 15 Jul 2020 19:28:50 +0000"  >&lt;p&gt;I&apos;ve proposed this change to use a static ContextDataInjector instance in RingBufferLogEventTranslator:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/387&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/387&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17158653" author="ralph.goers@dslextreme.com" created="Wed, 15 Jul 2020 19:34:49 +0000"  >&lt;p&gt;That is definitely a good change, but I don&apos;t think it would cause me to want to change the way the reported problem here was fixed. There are several places that create a ContextDataInjector and iI think t is better to initialize it prior to the first log event call vs as part of that.&lt;/p&gt;</comment>
                            <comment id="17158672" author="ckozak" created="Wed, 15 Jul 2020 19:52:11 +0000"  >&lt;p&gt;I agree, I think a combination of our changes is ideal. Thanks! I&apos;ll merge after I&apos;ve had a chance to run the full test suite, I have a couple other changes to queue up.&lt;/p&gt;</comment>
                            <comment id="17159472" author="jira-bot" created="Thu, 16 Jul 2020 20:36:31 +0000"  >&lt;p&gt;Commit cb3ee2b6ef9d888c3b269b3fa8c0d1d9345ecc5c in logging-log4j2&apos;s branch refs/heads/release-2.x from Carter Kozak&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=cb3ee2b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=cb3ee2b&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2867&quot; title=&quot;ContextDataProvider will cause concurrent threads blocking at the first logging time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2867&quot;&gt;&lt;del&gt;LOG4J2-2867&lt;/del&gt;&lt;/a&gt;: RingBufferLogEventTranslator uses a static ContextDataInjector&lt;/p&gt;

&lt;p&gt;Previously a new instance was created for each translator, which&lt;br/&gt;
occurred on every thread.&lt;/p&gt;</comment>
                            <comment id="17159476" author="jira-bot" created="Thu, 16 Jul 2020 20:41:55 +0000"  >&lt;p&gt;Commit d40bb6dfac6e4a366dca8914b2edb75da52d5005 in logging-log4j2&apos;s branch refs/heads/master from Carter Kozak&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=d40bb6d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=d40bb6d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2867&quot; title=&quot;ContextDataProvider will cause concurrent threads blocking at the first logging time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2867&quot;&gt;&lt;del&gt;LOG4J2-2867&lt;/del&gt;&lt;/a&gt;: RingBufferLogEventTranslator uses a static ContextDataInjector&lt;/p&gt;

&lt;p&gt;Previously a new instance was created for each translator, which&lt;br/&gt;
occurred on every thread.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 17 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0frc8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>