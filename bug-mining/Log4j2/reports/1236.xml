<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:40:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-2389] fix the CacheEntry map in ThrowableProxy#toExtendedStackTrace to be put and gotten with same key</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-2389</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;ul&gt;
	&lt;li&gt;fix the CacheEntry map in ThrowableProxy#toExtendedStackTrace to be put and gotten with same key&lt;/li&gt;
	&lt;li&gt;stackTraceElement.toString() returns a string representation of this stack trace element, just as MyClass.mash(MyClass.java)&lt;/li&gt;
	&lt;li&gt;stackTraceElement.getClassName() returns the fully qualified name of the Class, just as&#160;org.apache.logging.log4j.MyClass
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; className = stackTraceElement.getClassName();
&#8230;&#8230;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CacheEntry cacheEntry = map.get(className);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cacheEntry != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CacheEntry entry = cacheEntry;
      extClassInfo = entry.element;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (entry.loader != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
             lastLoader = entry.loader;
      }
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CacheEntry entry = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.toCacheEntry(stackTraceElement,
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.loadClass(lastLoader, className), &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
      extClassInfo = entry.element;
      map.put(stackTraceElement.toString(), entry);
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (entry.loader != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
             lastLoader = entry.loader;
      }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The main impact of the problem was that it would increase of frequency of loading classes ,which led to the execution of the program be slow down, because of the synchronization mechanism in the method loadClass&lt;/li&gt;
	&lt;li&gt;In addition to fixing the problem, I think&#160;cache map could be made global, instead of a new one for each exception instance.&#160;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ThrowableProxy(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Throwable throwable, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Set&amp;lt;Throwable&amp;gt; visited) {
    ...
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, CacheEntry&amp;gt; map = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.extendedStackTrace = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.toExtendedStackTrace(stack, map, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,      
    throwable.getStackTrace());
    ...
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;We made the benchmark test to  compares the performance of ThrowableProxy optimizations for different exception&lt;/li&gt;
	&lt;li&gt;baseline: test `ThrowableProxy` in log4j2, not optimized, with bug, for comparison consideration.&lt;/li&gt;
	&lt;li&gt;bugfixed: fixed bug in `ThrowableProxy` accessing the cache.&lt;/li&gt;
	&lt;li&gt;optimized: make the cache global, instead of a new one for each exception instance.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Then we see&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;more than `10` times improvement when the bug is fixed for exceptions with stack element class duplicated many times.&lt;/li&gt;
	&lt;li&gt;and about `2` times further improvement when make the cache global (compared with log4j2, more than `20` times improvement).&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;benchmark test detail: &lt;a href=&quot;https://github.com/liuwenchn/log4j2-throwableproxy-benchmark&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/liuwenchn/log4j2-throwableproxy-benchmark&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;PR: &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/195&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/195&lt;/a&gt;&lt;br/&gt;
&#160;&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13173629">LOG4J2-2389</key>
            <summary>fix the CacheEntry map in ThrowableProxy#toExtendedStackTrace to be put and gotten with same key</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="liuwenchn">LIU WEN</reporter>
                        <labels>
                    </labels>
                <created>Sun, 22 Jul 2018 02:48:10 +0000</created>
                <updated>Wed, 29 Jul 2020 08:01:13 +0000</updated>
                            <resolved>Sun, 22 Jul 2018 17:23:23 +0000</resolved>
                                    <version>2.6.2</version>
                    <version>2.7</version>
                    <version>2.8</version>
                    <version>2.8.1</version>
                    <version>2.8.2</version>
                    <version>2.9.0</version>
                    <version>2.9.1</version>
                    <version>2.10.0</version>
                    <version>2.11.0</version>
                                    <fixVersion>2.11.1</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16552046" author="githubbot" created="Sun, 22 Jul 2018 15:06:51 +0000"  >&lt;p&gt;Github user liuwenchn commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/195&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/195&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    hi  garydgregory, &lt;br/&gt;
          thanks for your reply. We  have thought about what you said. &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The main ideas and standpoints are as follows:&lt;/li&gt;
	&lt;li&gt;Each item in our map corresponds to a class, so the total number of items in the map must not exceed the total number of classes loaded.&lt;/li&gt;
	&lt;li&gt;And then for each item, we have a very small amount of data in there, extendedClassInfo, just a few fields.&lt;/li&gt;
	&lt;li&gt;A class, which has everything in memory that contains all the information about the class. Each item in our map takes up much less memory than its corresponding class.&lt;/li&gt;
	&lt;li&gt;In my benchmarking test &lt;span class=&quot;error&quot;&gt;&amp;#91;result,&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/liuwenchn/log4j2-throwableproxy-benchmark/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/liuwenchn/log4j2-throwableproxy-benchmark/&lt;/a&gt;) when make the cache global, about 2 times further improvement than the version of just fixing bug in ThrowableProxy accessing the cache.&lt;/li&gt;
	&lt;li&gt;Weighing the pros and cons, we we think that the map should be global&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16552064" author="ralph.goers@dslextreme.com" created="Sun, 22 Jul 2018 16:26:13 +0000"  >&lt;p&gt;This issue needs to be split in 2. This issue should be titled &quot;Fix the CacheEntry map in ThrowableProxy#toExtendedStackTrace to be put and gotten with same key&quot;. This is clearly a bug.  The second issue would be to make the cache global, which is an enhancement request.&lt;/p&gt;</comment>
                            <comment id="16552066" author="githubbot" created="Sun, 22 Jul 2018 16:33:17 +0000"  >&lt;p&gt;Github user rgoers commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/195&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/195&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This makes no sense to me. &lt;br/&gt;
    1. The cache is meant to keep a record of the cache entries in a single set of chained exceptions. &lt;br/&gt;
    1. This logic attempts to optimize the performance of logging exceptions, but exceptions are supposed to be infrequent so optimization isn&apos;t important.&lt;br/&gt;
    1. This will cache stack entries from any exception that happens from anywhere in the program. While there may be a finite limit to that this could get extremely large.&lt;/p&gt;

&lt;p&gt;    I am +1 on fixing the bug and -1 on the global cache.&lt;/p&gt;
</comment>
                            <comment id="16552076" author="ralph.goers@dslextreme.com" created="Sun, 22 Jul 2018 16:44:08 +0000"  >&lt;p&gt;Modified this issue to only cover the bug so I can fix that.&lt;/p&gt;</comment>
                            <comment id="16552093" author="jira-bot" created="Sun, 22 Jul 2018 17:21:58 +0000"  >&lt;p&gt;Commit 6aa1e86602a3b7bf5a02891b6f6b05d3488dbcaa in logging-log4j2&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ralph.goers%40dslextreme.com&quot; class=&quot;user-hover&quot; rel=&quot;ralph.goers@dslextreme.com&quot;&gt;ralph.goers@dslextreme.com&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=6aa1e86&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=6aa1e86&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2389&quot; title=&quot;fix the CacheEntry map in ThrowableProxy#toExtendedStackTrace to be put and gotten with same key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2389&quot;&gt;&lt;del&gt;LOG4J2-2389&lt;/del&gt;&lt;/a&gt; - ThrowableProxy was saving and retrieving cache entries using different keys.&lt;/p&gt;</comment>
                            <comment id="16552094" author="jira-bot" created="Sun, 22 Jul 2018 17:22:29 +0000"  >&lt;p&gt;Commit d310dd49002d394967a6f6d597bd891a5d6c4d3b in logging-log4j2&apos;s branch refs/heads/release-2.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ralph.goers%40dslextreme.com&quot; class=&quot;user-hover&quot; rel=&quot;ralph.goers@dslextreme.com&quot;&gt;ralph.goers@dslextreme.com&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=d310dd4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=d310dd4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2389&quot; title=&quot;fix the CacheEntry map in ThrowableProxy#toExtendedStackTrace to be put and gotten with same key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2389&quot;&gt;&lt;del&gt;LOG4J2-2389&lt;/del&gt;&lt;/a&gt; - ThrowableProxy was saving and retrieving cache entries using different keys.&lt;/p&gt;</comment>
                            <comment id="16552095" author="ralph.goers@dslextreme.com" created="Sun, 22 Jul 2018 17:23:23 +0000"  >&lt;p&gt;The bug has been fixed in both release-2.x and master. Please verify and close.&lt;/p&gt;</comment>
                            <comment id="16552328" author="liuwenchn" created="Mon, 23 Jul 2018 04:54:35 +0000"  >&lt;p&gt;thanks. I have checked the master branch , the bug has been fixed. Is it will be released on the version  2.11.1?&lt;/p&gt;</comment>
                            <comment id="16552339" author="ralph.goers@dslextreme.com" created="Mon, 23 Jul 2018 05:18:41 +0000"  >&lt;p&gt;Yes, it will be in Log4j 2.11.1.&lt;/p&gt;</comment>
                            <comment id="16552341" author="githubbot" created="Mon, 23 Jul 2018 05:23:38 +0000"  >&lt;p&gt;Github user xnslong commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/195&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/195&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @rgoers you mentioned&lt;/p&gt;

&lt;p&gt;    &amp;gt; exceptions are supposed to be infrequent&lt;/p&gt;

&lt;p&gt;    I can&apos;t quite agree about it. Through for most time the exceptions are infrequent, but those are not the time we care about them either. We may care about them when some critical error occurs, for example, when a strongly dependent service goes down. At that time, the logger may uncontrollably log a lot of exceptions. But if the logger is slow at that time, then more problems than the real one (the dependent service having went down) will occur, this may confuse us a lot when identifying the problems. &lt;/p&gt;</comment>
                            <comment id="16552343" author="githubbot" created="Mon, 23 Jul 2018 05:28:43 +0000"  >&lt;p&gt;Github user rgoers commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/195&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/195&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    For the sake of argument lets say I agree that optimizing performance here would be good. That still doesn&apos;t solve the second issue that it is likely to cause problems in applications where the same class name can be loaded by multiple class loaders.&lt;/p&gt;</comment>
                            <comment id="16552354" author="githubbot" created="Mon, 23 Jul 2018 05:52:03 +0000"  >&lt;p&gt;Github user xnslong commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/195&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/195&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @rgoers Thanks for the reply and I see the problem. There are 2 problems:&lt;/p&gt;

&lt;p&gt;    1. If multiple ClassLoader has loaded classes with the same name, they will interfere each other.&lt;br/&gt;
    2. We can&apos;t clear it from the cache if the class is unloaded.&lt;/p&gt;

&lt;p&gt;    But I also checked the benchmark. After fixing the bug, the performance has been improved a lot if there are duplicated classes in the same stack. And it will improve further more for all kinds of exceptions if the cache is global, it&apos;s very attractive. So I just think if there is a way to solve these problems.&lt;/p&gt;

&lt;p&gt;    I found the cache map is a map with `String` type key indicating a class. So why not make the key type as `Class`? The `Class` objects will be different if they are loaded by different `ClassLoader`s even with the same qualified name. And as for the `unloading`, we may introduce the `WeakReference` in the key. When a class is unloaded and collected by GC, the reference will receive a notice. We can clear the information from the cache map then.&lt;/p&gt;

&lt;p&gt;    And after all, I still agree only to fix the bug for this time. If there should be such further optimizations, we can do it later after close study.&lt;/p&gt;

&lt;p&gt;    Yours.&lt;/p&gt;</comment>
                            <comment id="16553165" author="githubbot" created="Mon, 23 Jul 2018 17:47:08 +0000"  >&lt;p&gt;Github user cakofony commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/195&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/195&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I would also prefer to avoid a global cache anywhere we can avoid it, however I have noticed when my stacks start encountering failures (temporary network loss, for example) I&apos;ve seen quite a lot of threads stuck in ThrowableProxy.&lt;/p&gt;

&lt;p&gt;    While I would prefer not to optimize performance for exceptional cases, I put together a simple benchmark locally which uses GC-free logging with both patterns `%m%n%xEx%n` and `%m%n%ex%n`. The former uses extended traces, the latter does not, which avoids creating a ThrowableProxy instance since I&apos;m using synchronous logging.&lt;br/&gt;
    The former is logging 2,100 events/second while the latter is logging 161,000 events/second.&lt;/p&gt;

&lt;p&gt;    I&apos;m worried that we may be creating more work for the application than we expect.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 17 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3w56n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>