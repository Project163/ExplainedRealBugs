<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:32:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-467] Thread name caching in async logger incompatible with use of Thread.setName()</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-467</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;AsyncLogger caches a thread&apos;s name in a thread-local info variable.  I make use of a thread pool where the submitted Runnables call Thread.setName() at the beginning of their task and the thread name is included in the log message.  For an example of this behavior, see org.jboss.netty.util.ThreadRenamingRunnable in Netty 3.x.  With the cached thread name, the log messages will contain whatever name the thread had when it logged for the first time and so long as the thread doesn&apos;t terminate (such as in a core pool thread), all log messages involving this thread will be erroneous.  If Thread.getName has a significant performance impact for async logging, I would be satisfied if this behavior were configurable, perhaps on a per-logger basis, so that the penalty only needs to be taken by users who make use of Thread.setName()&lt;/p&gt;</description>
                <environment>&lt;p&gt;Debian Squeeze amd64&lt;br/&gt;
OpenJDK 7u25&lt;/p&gt;</environment>
        <key id="12684135">LOG4J2-467</key>
            <summary>Thread name caching in async logger incompatible with use of Thread.setName()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="abaldocchi">Anthony Baldocchi</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Dec 2013 00:22:41 +0000</created>
                <updated>Fri, 15 Sep 2017 16:47:05 +0000</updated>
                            <resolved>Sun, 5 Jan 2014 12:47:11 +0000</resolved>
                                    <version>2.0-beta9</version>
                                    <fixVersion>2.0-rc1</fixVersion>
                    <fixVersion>2.0</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13845962" author="remkop@yahoo.com" created="Thu, 12 Dec 2013 01:24:47 +0000"  >&lt;p&gt;Anthony, thanks for your feedback.&lt;br/&gt;
Caching the thread name did give a significant performance improvement, so I would like to keep it as the default,&lt;br/&gt;
but making it configurable is certainly possible.&lt;/p&gt;

&lt;p&gt;I&apos;m still thinking about how to do this. (Perhaps do this as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-321&quot; title=&quot;Provide configuration alternative to system properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-321&quot;&gt;&lt;del&gt;LOG4J2-321&lt;/del&gt;&lt;/a&gt;.)&lt;/p&gt;

&lt;p&gt;Do you need this to be configurable on a per-logger basis or is that a nice-to-have and would a global setting work for you?&lt;/p&gt;</comment>
                            <comment id="13845994" author="garydgregory" created="Thu, 12 Dec 2013 01:53:50 +0000"  >&lt;p&gt;Was caching the thread name a premature optimization?&lt;/p&gt;

&lt;p&gt;It saves creating one string for each call to &lt;tt&gt;Thread#getName()&lt;/tt&gt;, which would be called once per log event.&lt;/p&gt;

&lt;p&gt;Rather than adding the complexity of making this configurable, why not simply back out the caching?&lt;/p&gt;</comment>
                            <comment id="13846007" author="remkop@yahoo.com" created="Thu, 12 Dec 2013 02:26:35 +0000"  >&lt;p&gt;Gary, I don&apos;t remember the exact numbers but I remember the difference was significant (10% or more).&lt;br/&gt;
I think the trade-off is worthwhile.&lt;/p&gt;</comment>
                            <comment id="13846015" author="abaldocchi" created="Thu, 12 Dec 2013 02:43:31 +0000"  >&lt;p&gt;Remko, thank you for your quick feedback.  My use case does not require this to be configurable on a per-logger basis; a global setting would suit me fine.  I mentioned the potential for it being set on a per-logger basis simply as a middle-ground option if there was an expedient method for enabling such.&lt;/p&gt;</comment>
                            <comment id="13846032" author="remkop@yahoo.com" created="Thu, 12 Dec 2013 03:22:38 +0000"  >&lt;p&gt;Anthony, understood, thanks!&lt;br/&gt;
I&apos;ve given it some thought and the per-logger config would be a lot more complex than a global config, so I&apos;ll start with the simple solution and will consider a per-logger solution if a strong use case comes up.&lt;/p&gt;</comment>
                            <comment id="13846340" author="garydgregory" created="Thu, 12 Dec 2013 14:52:04 +0000"  >&lt;p&gt;Hi Remko,&lt;/p&gt;

&lt;p&gt;I find it hard to believe that a method call and one new String per log event makes a 10% difference. Can you create a benchmark before we go on and make things even more complicated than they are? 10% of what is also an issue &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Gary&lt;/p&gt;</comment>
                            <comment id="13861384" author="remkop@yahoo.com" created="Fri, 3 Jan 2014 09:48:07 +0000"  >&lt;p&gt;Gary, I&apos;ve tested the performance difference like you asked. I used the existing benchmark test that I used to generate the performance numbers for Async Loggers: org.apache.logging.log4j.core.async.perftest.*&lt;br/&gt;
I modified the PerfTestDriver class to comment out all tests except for &quot;Loggers all async&quot;, and tested for 1, 2 and 4 threads. Here are the results:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Cached thread name (AsyncLogger line 203: info.cachedThreadName)
1 thread : throughput: 4,380,953 ops/sec. (avg of 5 runs)
2 threads: throughput: 2,481,713 ops/sec. (avg of 5 runs)
4 threads: throughput: 5,712,182 ops/sec. (avg of 3 runs)

&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getName() (AsyncLogger line 202)
1 thread : throughput: 3,762,280 ops/sec. (avg of 5 runs)
2 threads: throughput: 2,805,796 ops/sec. (avg of 5 runs)
4 threads: throughput: 2,193,664 ops/sec. (avg of 3 runs)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I conclude that caching the thread name gives a significant performance benefit.&lt;/p&gt;

&lt;p&gt;I attached the PerfTestDriver class so you can run the tests yourself to verify these results if you want. Each run takes about 30 minutes. To toggle between Thread.currentThread().getName() and the cached thread name, you need to modify AsyncLogger and recompile.&lt;/p&gt;

&lt;p&gt;This command starts the test:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cd log4j2
mvn clean install -DskipTests
cd log4j-core\target
java -cp .;log4j-core-2.0RC1-SNAPSHOT-tests.jar;log4j-core-2.0RC1-SNAPSHOT.jar;..\..\log4j-api\target\log4j-api-2.0RC1-SNAPSHOT.jar;test-classes;c:\users\remko\.m2\repository/com/lmax/disruptor/3.2.0/disruptor-3.2.0.jar org.apache.logging.log4j.core.async.perftest.PerfTestDriver
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13861483" author="remkop@yahoo.com" created="Fri, 3 Jan 2014 12:56:04 +0000"  >&lt;p&gt;Anthony,&lt;br/&gt;
I&apos;ve added an option to switch off thread name caching with system property &lt;tt&gt;-DAsyncLogger.ThreadNameStrategy=UNCACHED&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Ideally this should be configurable in the log4j2 configuration file (and there is a Jira ticket &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-321&quot; title=&quot;Provide configuration alternative to system properties&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-321&quot;&gt;&lt;del&gt;LOG4J2-321&lt;/del&gt;&lt;/a&gt; to address this) but this option is consistent with other options for tuning AsyncLogger behaviour.&lt;/p&gt;

&lt;p&gt;Fixed in revision 1555076.&lt;br/&gt;
Please verify and close.&lt;/p&gt;</comment>
                            <comment id="13861644" author="garydgregory" created="Fri, 3 Jan 2014 16:40:04 +0000"  >&lt;p&gt;Thank you for the update Remko. Interesting numbers!&lt;/p&gt;</comment>
                            <comment id="13861743" author="abaldocchi" created="Fri, 3 Jan 2014 18:23:13 +0000"  >&lt;p&gt;Using a single-threaded executor, thread names in my test log output change when the Runnable calls setName when tuning this option to UNCACHED and remain fixed with CACHED, which is the expected behavior.  Verified and thanks.&lt;/p&gt;</comment>
                            <comment id="13862126" author="remkop@yahoo.com" created="Sat, 4 Jan 2014 01:31:13 +0000"  >&lt;p&gt;Gary, after rebooting my windows laptop I&apos;m getting different numbers. &lt;/p&gt;

&lt;div class=&quot;panel&quot; style=&quot;background-color: #FFFFCE;border-color: #ccc;border-style: dashed;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: dashed;border-bottom-color: #ccc;background-color: #F7D6C1;&quot;&gt;&lt;b&gt;Update&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot; style=&quot;background-color: #FFFFCE;&quot;&gt;
&lt;p&gt;I made a mistake running these tests. These results are all for the CACHED thread name scenario. Results for the UNCACHED scenario are in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-467?focusedCommentId=13862236&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13862236&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;this comment below&lt;/a&gt; &lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Run 1: CACHED
(1 thread) : throughput: 4,407,972 ops/sec.
(2 threads): throughput: 2,717,954 ops/sec.
(4 threads): throughput: 1,616,480 ops/sec.

Run 2: UNCACHED
(1 thread) : throughput: 4,124,748 ops/sec.
(2 threads): throughput: 1,928,624 ops/sec.
(4 threads): throughput: 3,006,960 ops/sec.

Run 3: CACHED
(1 thread) : throughput: 4,987,891 ops/sec.
(2 threads): throughput: 1,933,868 ops/sec.
(4 threads): throughput: 3,222,753 ops/sec.

Run 4: UNCACHED
(1 thread) : throughput: 4,670,605 ops/sec.
(2 threads): throughput: 2,215,214 ops/sec. 
(4 threads): throughput: 1,154,320 ops/sec. 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;CACHED still has an advantage over UNCACHED, but there seems to be a lot of variance between runs. Especially the 4-thread results have too much variance to be useful. (This may be because my laptop only has 4 virtual cores, and occasionally running OS tasks skew the results.)&lt;/p&gt;

&lt;p&gt;I&apos;ll try running the performance test on a Unix box early next week.&lt;/p&gt;</comment>
                            <comment id="13862187" author="sdeboy" created="Sat, 4 Jan 2014 03:31:02 +0000"  >&lt;p&gt;What should be the bottleneck in this test?  I ran this on my MBP and I see around 70% idle CPU, disk doesn&apos;t look like it&apos;s being thrashed.&lt;/p&gt;</comment>
                            <comment id="13862194" author="remkop@yahoo.com" created="Sat, 4 Jan 2014 04:04:01 +0000"  >&lt;p&gt;Hi Scott!&lt;br/&gt;
Good question, not sure. &lt;br/&gt;
Disk access should be efficient as the RandomAccessFileAppender does a lot of buffering and becomes more efficient (batching multiple events together into a single I/O call) when it falls behind the producer. It could be lock contention, although use of the Disruptor in Async Loggers should resolve most of that. If your have 4 cores then the single-threaded part of the test should show around 75% idle CPU. &lt;br/&gt;
How many cores do you have? (What is an MBP, by the way?)&lt;/p&gt;

&lt;p&gt;Can you post your results here? (Just the throughput numbers is fine.)&lt;/p&gt;</comment>
                            <comment id="13862199" author="sdeboy" created="Sat, 4 Jan 2014 04:25:49 +0000"  >&lt;p&gt;The test fails part way through for me since it isn&apos;t resolving the slf4j classes: Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: org/slf4j/LoggerFactory&lt;/p&gt;

&lt;p&gt;I am only getting through the single threaded tests before it fails.&lt;/p&gt;

&lt;p&gt;Assume I need the slf4j API and an implementation?  What&apos;s the right command to get those included?&lt;/p&gt;

&lt;p&gt;MBP means macbook pro..it&apos;s a mid 2012, 2.3 i7, SSD Samsung 840 pro w/16G, on Mavericks.  Once I have a good command to run I&apos;ll update the bug with results.&lt;/p&gt;</comment>
                            <comment id="13862203" author="remkop@yahoo.com" created="Sat, 4 Jan 2014 04:50:34 +0000"  >&lt;p&gt;(away from PC)&lt;br/&gt;
You shouldn&apos;t need slf4j to run the modified PerfTestDriver attached to this Jira. &lt;/p&gt;

&lt;p&gt;Just found one issue with that PerfTestDriver: it doesn&apos;t pass command line system properties to the PerfTest process it creates, so it will only allow one to test the CACHED scenario. &lt;/p&gt;

&lt;p&gt;Will fix PerfTestDriver and attach to this Jira. &lt;/p&gt;</comment>
                            <comment id="13862217" author="sdeboy" created="Sat, 4 Jan 2014 05:22:43 +0000"  >&lt;p&gt;I&apos;m not sure why, but I do get an slf4j error as you see above:&lt;/p&gt;

&lt;p&gt;Logback: Sync (single thread) (1/5)...Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: org/slf4j/LoggerFactory&lt;/p&gt;
</comment>
                            <comment id="13862227" author="remkop@yahoo.com" created="Sat, 4 Jan 2014 06:17:36 +0000"  >&lt;p&gt;Reopening so I can attach files and edit old comments.&lt;/p&gt;</comment>
                            <comment id="13862229" author="remkop@yahoo.com" created="Sat, 4 Jan 2014 06:29:08 +0000"  >&lt;p&gt;Scott,&lt;br/&gt;
If you see &quot;Logback...&quot; you are not using the PerfTestDriver class attached to this Jira. The attached PerfTestDriver has all tests commented out except the Log4J2 AsyncLogger test.&lt;/p&gt;

&lt;p&gt;I&apos;ve attached a new version of PerfTestDriver to this Jira that correctly passes command line property -DAsyncLogger.ThreadNameStrategy=UNCACHED (or CACHED) to the actual test process.&lt;/p&gt;

&lt;p&gt;To run this test:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;update log4j2 project from SVN&lt;/li&gt;
	&lt;li&gt;replace  &lt;tt&gt;log4j2/log4j-core/src/test/java/org/apache/logging/log4j/core/async/perftest/PerfTestDriver.java&lt;/tt&gt; with the file attached to this Jira&lt;/li&gt;
	&lt;li&gt;build with &lt;tt&gt;mvn clean install -DskipTests&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;cd log4j2/log4j-core/target&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;java -DAsyncLogger.ThreadNameStrategy=UNCACHED -cp .;log4j-core-2.0RC1-SNAPSHOT-tests.jar;log4j-core-2.0RC1-SNAPSHOT.jar;../../log4j-api/target/log4j-api-2.0RC1-SNAPSHOT.jar;test-classes;c:/users/remko/.m2/repository/com/lmax/disruptor/3.2.0/disruptor-3.2.0.jar org.apache.logging.log4j.core.async.perftest.PerfTestDriver&lt;/tt&gt;
	&lt;ul&gt;
		&lt;li&gt;(You probably need to modify the path to &lt;tt&gt;disruptor-3.2.0.jar&lt;/tt&gt;)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13862236" author="remkop@yahoo.com" created="Sat, 4 Jan 2014 07:42:12 +0000"  >&lt;p&gt;Performance test result update:&lt;/p&gt;

&lt;p&gt;The numbers I reported in the &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-467?focusedCommentId=13862126&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13862126&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;comment above&lt;/a&gt; are all results for the CACHED thread name scenario. Here they are again:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;CACHED&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;(1 thread) : throughput: 4,407,972 ops/sec.
(2 threads): throughput: 2,717,954 ops/sec.
(4 threads): throughput: 1,616,480 ops/sec.

(1 thread) : throughput: 4,124,748 ops/sec.
(2 threads): throughput: 1,928,624 ops/sec.
(4 threads): throughput: 3,006,960 ops/sec.

(1 thread) : throughput: 4,987,891 ops/sec.
(2 threads): throughput: 1,933,868 ops/sec.
(4 threads): throughput: 3,222,753 ops/sec.

(1 thread) : throughput: 4,670,605 ops/sec.
(2 threads): throughput: 2,215,214 ops/sec. 
(4 threads): throughput: 1,154,320 ops/sec. 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ve re-run the tests with the updated PerfTestDriver and the -DAsyncLogger.ThreadNameStrategy=UNCACHED option:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;UNCACHED&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;(1 thread) : throughput: 3,429,421 ops/sec.
(2 threads): throughput: 1,688,868 ops/sec.
(4 threads): throughput: 2,207,599 ops/sec.

(1 thread) : throughput: 4,684,796 ops/sec.
(2 threads): throughput: 1,232,496 ops/sec.
(4 threads): throughput: 2,906,195 ops/sec.

(1 thread) : throughput: 3,404,258 ops/sec.
(2 threads): throughput: 1,821,020 ops/sec.
(4 threads): throughput: 4,254,485 ops/sec.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(All on Windows 7 (64bit) with JDK1.7.0_45, 2-core Intel i5-3317u CPU @1.70Ghz with hyperthreading switched on (4 virtual cores)).&lt;/p&gt;

&lt;p&gt;Discounting the 4-thread tests (too much variance) I get these averages (in million ops/sec):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Cached&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Uncached&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1 thread&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;4.5&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;3.8&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2 thread&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.2&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.6&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt; I will re-run the tests on a Unix box with more cores next week (should have less variance).&lt;/p&gt;</comment>
                            <comment id="13862435" author="sdeboy" created="Sat, 4 Jan 2014 22:48:22 +0000"  >&lt;p&gt;Details about my machine:&lt;br/&gt;
java version &quot;1.7.0_45&quot;&lt;br/&gt;
16 G memory&lt;br/&gt;
Mid 2012 Macbook Pro, 2.3 i7&lt;br/&gt;
Mavericks&lt;/p&gt;

&lt;p&gt;Summary? Is it fair to say this is a &apos;push&apos;? At least on my box it looks like it is (or uncached you could argue is slightly better)&lt;/p&gt;

&lt;p&gt;Results:&lt;/p&gt;

&lt;p&gt;CACHED&lt;/p&gt;

&lt;p&gt;Ranking:&lt;br/&gt;
1. Log4j2: Loggers all async (single thread): throughput: 7,023,291 ops/sec. latency(ns): avg=4137.8 99% &amp;lt; 16384.0 99.99% &amp;lt; 2936012.8 (53351 samples)&lt;br/&gt;
2. Log4j2: Loggers all async (2 threads): throughput: 3,542,271 ops/sec. latency(ns): avg=2588.6 99% &amp;lt; 4505.6 99.99% &amp;lt; 2097152.0 (368968 samples)&lt;br/&gt;
3. Log4j2: Loggers all async (4 threads): throughput: 1,895,205 ops/sec. latency(ns): avg=2431.8 99% &amp;lt; 4096.0 99.99% &amp;lt; 2097152.0 (741385 samples)&lt;/p&gt;


&lt;p&gt;Ranking:&lt;br/&gt;
1. Log4j2: Loggers all async (single thread): throughput: 7,370,012 ops/sec. latency(ns): avg=4088.8 99% &amp;lt; 16384.0 99.99% &amp;lt; 3355443.2 (57130 samples)&lt;br/&gt;
2. Log4j2: Loggers all async (2 threads): throughput: 3,602,343 ops/sec. latency(ns): avg=2448.9 99% &amp;lt; 3686.4 99.99% &amp;lt; 2097152.0 (406678 samples)&lt;br/&gt;
3. Log4j2: Loggers all async (4 threads): throughput: 1,934,711 ops/sec. latency(ns): avg=2436.2 99% &amp;lt; 4096.0 99.99% &amp;lt; 2446677.3 (748575 samples)&lt;/p&gt;



&lt;p&gt;UNCACHED:&lt;/p&gt;

&lt;p&gt;Ranking:&lt;br/&gt;
1. Log4j2: Loggers all async (single thread): throughput: 6,818,683 ops/sec. latency(ns): avg=3747.8 99% &amp;lt; 16384.0 99.99% &amp;lt; 2936012.8 (64379 samples)&lt;br/&gt;
2. Log4j2: Loggers all async (2 threads): throughput: 3,915,888 ops/sec. latency(ns): avg=2616.1 99% &amp;lt; 4096.0 99.99% &amp;lt; 2306867.2 (368855 samples)&lt;br/&gt;
3. Log4j2: Loggers all async (4 threads): throughput: 1,911,439 ops/sec. latency(ns): avg=2464.6 99% &amp;lt; 4096.0 99.99% &amp;lt; 2097152.0 (737069 samples)&lt;/p&gt;

&lt;p&gt;Ranking:&lt;br/&gt;
1. Log4j2: Loggers all async (single thread): throughput: 7,449,397 ops/sec. latency(ns): avg=3675.4 99% &amp;lt; 16384.0 99.99% &amp;lt; 2516582.4 (61476 samples)&lt;br/&gt;
2. Log4j2: Loggers all async (2 threads): throughput: 4,031,314 ops/sec. latency(ns): avg=2578.6 99% &amp;lt; 3481.6 99.99% &amp;lt; 2516582.4 (388410 samples)&lt;br/&gt;
3. Log4j2: Loggers all async (4 threads): throughput: 2,625,581 ops/sec. latency(ns): avg=2454.1 99% &amp;lt; 4096.0 99.99% &amp;lt; 2970965.3 (764774 samples)&lt;/p&gt;</comment>
                            <comment id="13862544" author="remkop@yahoo.com" created="Sun, 5 Jan 2014 12:47:11 +0000"  >&lt;p&gt;Marking this as resolved again (I only reopened it to attach a file and edit an older comment).&lt;/p&gt;</comment>
                            <comment id="13862822" author="remkop@yahoo.com" created="Mon, 6 Jan 2014 07:09:27 +0000"  >&lt;p&gt;Interesting to see that last year&apos;s consumer hardware (Scott&apos;s MBP) is much faster than 5 year old enterprise hardware...&lt;/p&gt;

&lt;p&gt;Below are the results of running the perf tests on Solaris 10 (64bit) with JDK1.7.0_06, 4-core Xeon X5570 dual CPU @2.93Ghz with hyperthreading switched on (16 virtual cores):&lt;/p&gt;

&lt;p&gt;&lt;b&gt;CACHED&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;(1 thread) : throughput: 2,993,579 ops/sec. (avg of 5 runs)
(2 threads): throughput: 1,643,640 ops/sec. (avg of 5 runs)
(4 threads): throughput: 1,509,098 ops/sec. (avg of 3 runs)

(1 thread) : throughput: 2,905,708 ops/sec. (     &quot;       )
(2 threads): throughput: 1,887,124 ops/sec. (     &quot;       )
(4 threads): throughput: 1,403,921 ops/sec. (     &quot;       )

(1 thread) : throughput: 3,031,088 ops/sec. (     &quot;       )
(2 threads): throughput: 1,828,200 ops/sec. (     &quot;       )
(4 threads): throughput: 1,517,553 ops/sec. (     &quot;       )

(1 thread) : throughput: 2,936,223 ops/sec. (     &quot;       )
(2 threads): throughput: 1,505,578 ops/sec. (     &quot;       )
(4 threads): throughput: 1,184,906 ops/sec. (     &quot;       )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;UNCACHED&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;(1 thread) : throughput: 2,368,698 ops/sec. (     &quot;       )
(2 threads): throughput: 1,360,309 ops/sec. (     &quot;       )
(4 threads): throughput:   998,752 ops/sec. (     &quot;       )

(1 thread) : throughput: 2,396,895 ops/sec. (     &quot;       )
(2 threads): throughput: 1,347,167 ops/sec. (     &quot;       )
(4 threads): throughput: 1,179,600 ops/sec. (     &quot;       )

(1 thread) : throughput: 2,354,092 ops/sec. (     &quot;       )
(2 threads): throughput: 1,444,437 ops/sec. (     &quot;       )
(4 threads): throughput: 1,089,047 ops/sec. (     &quot;       )

(1 thread) : throughput: 2,465,949 ops/sec. (     &quot;       )
(2 threads): throughput: 1,231,593 ops/sec. (     &quot;       )
(4 threads): throughput: 1,144,265 ops/sec. (     &quot;       )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The one thing that the enterprise hardware has going for it is that there is very little variance between runs.&lt;/p&gt;

&lt;p&gt;Summary (in million ops/sec):&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Cached&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Uncached&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1 thread&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;3.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.4&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2 threads&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.7&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;4 threads&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.4&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.1&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;On the Windows and Unix platforms I tested, caching the thread name seems to boost performance. I can&apos;t explain Scott&apos;s results. However, I think the results as a whole justify the slightly added complexity of caching the thread name.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13102624">LOG4J2-2052</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12621457" name="PerfTestDriver.java" size="15915" author="rpopma" created="Sat, 4 Jan 2014 06:29:08 +0000"/>
                            <attachment id="12621291" name="PerfTestDriver.java" size="15727" author="rpopma" created="Fri, 3 Jan 2014 09:48:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363207</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 46 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qlw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363513</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>