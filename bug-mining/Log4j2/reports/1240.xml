<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:40:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-2201] ReusableParametrizedMessages keeps references to objects beyond their expected lifetime</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-2201</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;During some memory leak analysis i noticed that one of my object which was expected to die was kept alive for longer than expected. The only reference to it was in ReusableParametrizedMessage&lt;/p&gt;

&lt;p&gt;This object was pretty heavy and hold tens-hundreds of references to&#160;child object alive also.&lt;/p&gt;

&lt;p&gt;I had to disable logging to test the leaks.&lt;/p&gt;

&lt;p&gt;The side effect to this is:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Holding the references longer than expected&#160;will move the memory from young generation to tenured generation where collection is more expensive and affect performance&lt;/li&gt;
	&lt;li&gt;Debugging memory leaks just became harder.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;ReusableParametrizedMessage should not hold references to objects&#160;beyond their intended lifetime&lt;/p&gt;

&lt;p&gt;As you can see in this sample code&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ReusableParameterizedMessage set(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; messagePattern, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; p0) {
    params[0] = p0;
    init(messagePattern, 1, params);
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;;
}

ReusableParameterizedMessage set(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; messagePattern, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; p0, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; p1) {
    params[0] = p0;
    params[1] = p1;
    init(messagePattern, 2, params);
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;;
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If i call set(pattern,p0,p1) and then set(pattern, p0) ...then reference to p1 is kept alive until overriden by another set.&#160;&lt;/p&gt;

&lt;p&gt;I don&apos;t have an understanding about log4j inner workings but for me the references should be kept only for the duration of the call to log.&#160;&lt;/p&gt;

&lt;p&gt;I would be happy to be able to&#160;disable the mechanism. We are anyway running the software with INFO level and without logging the data plane so this optimization does not really bring much.&lt;/p&gt;

&lt;p&gt;How about just setting the params to null after finishing the logging ?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux, ubuntu 14.04, java 8u151&lt;/p&gt;</environment>
        <key id="13132121">LOG4J2-2201</key>
            <summary>ReusableParametrizedMessages keeps references to objects beyond their expected lifetime</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ckozak">Carter Kozak</assignee>
                                    <reporter username="mhstnsc">mhstnsc</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Jan 2018 09:07:04 +0000</created>
                <updated>Mon, 6 Aug 2018 21:45:30 +0000</updated>
                            <resolved>Mon, 6 Aug 2018 21:45:30 +0000</resolved>
                                    <version>2.8.2</version>
                                    <fixVersion>3.0.0</fixVersion>
                    <fixVersion>2.11.2</fixVersion>
                                    <component>API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16331996" author="remkop@yahoo.com" created="Fri, 19 Jan 2018 09:36:19 +0000"  >&lt;p&gt;Yes you are right. They should be nulled out after use. &lt;/p&gt;</comment>
                            <comment id="16351248" author="garydgregory" created="Sat, 3 Feb 2018 04:56:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=remkop%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;remkop@yahoo.com&quot;&gt;remkop@yahoo.com&lt;/a&gt;: Are you planning on tending to this issue?&lt;/p&gt;</comment>
                            <comment id="16351265" author="remkop@yahoo.com" created="Sat, 3 Feb 2018 05:58:33 +0000"  >&lt;p&gt;I&#8217;m traveling. Unsure when I can take a look. If anyone wants to take it go ahead.&lt;/p&gt;</comment>
                            <comment id="16351393" author="remkop@yahoo.com" created="Sat, 3 Feb 2018 13:03:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mhstnsc&quot; class=&quot;user-hover&quot; rel=&quot;mhstnsc&quot;&gt;mhstnsc&lt;/a&gt; I tried but I am unable to reproduce the issue. &lt;/p&gt;

&lt;p&gt;Can you provide us with a small program that reproduces the issue? At least let us know your exact configuration: log4j2.xml file, whether you are running in a web app or a standalone java app, and any system properties related to Log4j.&lt;/p&gt;</comment>
                            <comment id="16385326" author="mhstnsc" created="Sun, 4 Mar 2018 19:49:43 +0000"  >&lt;p&gt;Ok. i will make a reproducer or provide clear steps.&lt;/p&gt;</comment>
                            <comment id="16570757" author="ckozak" created="Mon, 6 Aug 2018 20:47:53 +0000"  >&lt;p&gt;I think this is fixed in 2.11.1 by &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2269&quot; title=&quot;Memory leaking of replacement parameters in case of enableThreadlocals=true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2269&quot;&gt;&lt;del&gt;LOG4J2-2269&lt;/del&gt;&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2362&quot; title=&quot;ReusableObjectMessage retains object reference after use&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2362&quot;&gt;&lt;del&gt;LOG4J2-2362&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2364&quot; title=&quot;ReusableParameterizedMessage memory leak: throwable, varargs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2364&quot;&gt;&lt;del&gt;LOG4J2-2364&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think I see another place where this sort of thing could occur, though it&apos;s very, unlikely in normal operation. Commit incoming shortly.&lt;/p&gt;</comment>
                            <comment id="16570812" author="jira-bot" created="Mon, 6 Aug 2018 21:38:21 +0000"  >&lt;p&gt;Commit e2b5ef243f373c8421a50b5b3f0949eca20c222d in logging-log4j2&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckozak&quot; class=&quot;user-hover&quot; rel=&quot;ckozak&quot;&gt;ckozak&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=e2b5ef2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=e2b5ef2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2201&quot; title=&quot;ReusableParametrizedMessages keeps references to objects beyond their expected lifetime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2201&quot;&gt;&lt;del&gt;LOG4J2-2201&lt;/del&gt;&lt;/a&gt; Fix memory leak in ReusableParameterizedMessage&lt;/p&gt;

&lt;p&gt;When emptyReplacement length is less than 10 but large enough for&lt;br/&gt;
the current paramers, the ReusableParameterizedMessage would&lt;br/&gt;
retain references to the most recently logged parameters.&lt;/p&gt;</comment>
                            <comment id="16570817" author="jira-bot" created="Mon, 6 Aug 2018 21:42:34 +0000"  >&lt;p&gt;Commit 16e73c9f44e3a673cea61a7644f51362bd91dd31 in logging-log4j2&apos;s branch refs/heads/release-2.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckozak&quot; class=&quot;user-hover&quot; rel=&quot;ckozak&quot;&gt;ckozak&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=16e73c9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=16e73c9&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2201&quot; title=&quot;ReusableParametrizedMessages keeps references to objects beyond their expected lifetime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2201&quot;&gt;&lt;del&gt;LOG4J2-2201&lt;/del&gt;&lt;/a&gt; Fix memory leak in ReusableParameterizedMessage&lt;/p&gt;

&lt;p&gt;When emptyReplacement length is less than 10 but large enough for&lt;br/&gt;
the current paramers, the ReusableParameterizedMessage would&lt;br/&gt;
retain references to the most recently logged parameters.&lt;/p&gt;</comment>
                            <comment id="16570822" author="ckozak" created="Mon, 6 Aug 2018 21:45:30 +0000"  >&lt;p&gt;I&apos;ve merged a fix to master and release-2.x, though the issue fixed by this commit should be quite rare. 2.11.1 is likely sufficient, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mhstnsc&quot; class=&quot;user-hover&quot; rel=&quot;mhstnsc&quot;&gt;mhstnsc&lt;/a&gt; would you mind verifying the fix against 2.11.1 and 2.11.2-SNAPSHOT? Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 15 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3p3s7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>