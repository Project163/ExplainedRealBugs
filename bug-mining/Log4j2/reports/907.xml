<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:37:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1518] Deadlock when using pure async and toString logs another message</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1518</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;It looks like this was reported before in: &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-471&quot; title=&quot;toString methods that perform logging can deadlock AsyncLogger&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-471&quot;&gt;&lt;del&gt;LOG4J2-471&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We&apos;ve encountered similar issue with one of the libraries where it&apos;s toString was indirectly also logging. This caused a deadlock when RingBuffer was full. Please see attached stack snippet.&lt;/p&gt;

&lt;p&gt;According to the following docs, it&apos;s possible to set sync policy to synchronously log the event if buffer is full. I don&apos;t see it documented. What&apos;s the policy option?&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/plugins/servlet/mobile#issue/LOG4J2-1080&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/plugins/servlet/mobile#issue/LOG4J2-1080&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://logging.apache.org/log4j/2.x/log4j-core/apidocs/org/apache/logging/log4j/core/async/AsyncQueueFullPolicyFactory.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://logging.apache.org/log4j/2.x/log4j-core/apidocs/org/apache/logging/log4j/core/async/AsyncQueueFullPolicyFactory.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thank you&lt;/p&gt;</description>
                <environment>&lt;p&gt;Solaris&lt;/p&gt;</environment>
        <key id="12997219">LOG4J2-1518</key>
            <summary>Deadlock when using pure async and toString logs another message</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="leonfin">Leon Finker</reporter>
                        <labels>
                    </labels>
                <created>Mon, 15 Aug 2016 02:59:25 +0000</created>
                <updated>Sun, 10 Sep 2017 12:53:34 +0000</updated>
                            <resolved>Mon, 5 Sep 2016 18:00:16 +0000</resolved>
                                    <version>2.6.2</version>
                                    <fixVersion>2.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15421012" author="leonfin" created="Mon, 15 Aug 2016 14:13:39 +0000"  >&lt;p&gt;Full thread dump attached. I can see that the async logger processor thread is not doing anything and waiting for events:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;Log4j2-AsyncLogger[AsyncContext@18b4aac2]1&quot; #24 daemon prio=5 os_prio=64 tid=0x0000000002278000 nid=0x2b runnable [0xfffffd7e695fe000]
   java.lang.Thread.State: RUNNABLE
	at com.lmax.disruptor.ProcessingSequenceBarrier.waitFor(ProcessingSequenceBarrier.java:56)
	at com.lmax.disruptor.BatchEventProcessor.run(BatchEventProcessor.java:124)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Yet all the other threads are blocked on&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;	at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:338)
	at com.lmax.disruptor.MultiProducerSequencer.next(MultiProducerSequencer.java:136)
	at com.lmax.disruptor.MultiProducerSequencer.next(MultiProducerSequencer.java:105)
	at com.lmax.disruptor.RingBuffer.publishEvent(RingBuffer.java:450)
	at com.lmax.disruptor.dsl.Disruptor.publishEvent(Disruptor.java:315)
	at org.apache.logging.log4j.core.async.AsyncLoggerDisruptor.enqueueLogMessageInfo(AsyncLoggerDisruptor.java:203)
	at org.apache.logging.log4j.core.async.AsyncLogger.handleRingBufferFull(AsyncLogger.java:169)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And the only out of ordinary thread stack that is nested with double log calls is:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;102469:c:japan&quot; #171 prio=5 os_prio=64 tid=0x00000000052be000 nid=0xba runnable [0xfffffd7e5d1e7000]
   java.lang.Thread.State: TIMED_WAITING (parking)
	at sun.misc.Unsafe.park(Native Method)
	at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:338)
	at com.lmax.disruptor.MultiProducerSequencer.next(MultiProducerSequencer.java:136)
	at com.lmax.disruptor.MultiProducerSequencer.next(MultiProducerSequencer.java:105)
	at com.lmax.disruptor.RingBuffer.publishEvent(RingBuffer.java:450)
	at com.lmax.disruptor.dsl.Disruptor.publishEvent(Disruptor.java:315)
	at org.apache.logging.log4j.core.async.AsyncLoggerDisruptor.enqueueLogMessageInfo(AsyncLoggerDisruptor.java:203)
	at org.apache.logging.log4j.core.async.AsyncLogger.handleRingBufferFull(AsyncLogger.java:169)
	at org.apache.logging.log4j.core.async.AsyncLogger.publish(AsyncLogger.java:161)
	at org.apache.logging.log4j.core.async.AsyncLogger.logWithThreadLocalTranslator(AsyncLogger.java:156)
	at org.apache.logging.log4j.core.async.AsyncLogger.logMessage(AsyncLogger.java:126)
	at org.apache.logging.log4j.spi.AbstractLogger.logMessage(AbstractLogger.java:2005)
	at org.apache.logging.log4j.spi.AbstractLogger.logIfEnabled(AbstractLogger.java:1876)
	at org.apache.logging.slf4j.Log4jLogger.debug(Log4jLogger.java:124)
...
	at x.share.biz.instrument.Instrument.toString(Instrument.java:290)
	at org.apache.logging.log4j.message.ParameterFormatter.tryObjectToString(ParameterFormatter.java:611)
	at org.apache.logging.log4j.message.ParameterFormatter.recursiveDeepToString(ParameterFormatter.java:431)
	at org.apache.logging.log4j.message.ParameterFormatter.formatMessage2(ParameterFormatter.java:189)
	at org.apache.logging.log4j.message.ReusableParameterizedMessage.formatTo(ReusableParameterizedMessage.java:307)
	at org.apache.logging.log4j.core.async.RingBufferLogEvent.setMessage(RingBufferLogEvent.java:118)
	at org.apache.logging.log4j.core.async.RingBufferLogEvent.setValues(RingBufferLogEvent.java:104)
	at org.apache.logging.log4j.core.async.RingBufferLogEventTranslator.translateTo(RingBufferLogEventTranslator.java:56)
	at org.apache.logging.log4j.core.async.RingBufferLogEventTranslator.translateTo(RingBufferLogEventTranslator.java:34)
	at com.lmax.disruptor.RingBuffer.translateAndPublish(RingBuffer.java:947)
	at com.lmax.disruptor.RingBuffer.tryPublishEvent(RingBuffer.java:463)
	at org.apache.logging.log4j.core.async.AsyncLoggerDisruptor.tryPublish(AsyncLoggerDisruptor.java:190)
	at org.apache.logging.log4j.core.async.AsyncLogger.publish(AsyncLogger.java:160)
	at org.apache.logging.log4j.core.async.AsyncLogger.logWithThreadLocalTranslator(AsyncLogger.java:156)
	at org.apache.logging.log4j.core.async.AsyncLogger.logMessage(AsyncLogger.java:126)
	at org.apache.logging.log4j.spi.AbstractLogger.logMessage(AbstractLogger.java:2005)
	at org.apache.logging.log4j.spi.AbstractLogger.logIfEnabled(AbstractLogger.java:1876)
	at org.apache.logging.slf4j.Log4jLogger.debug(Log4jLogger.java:124)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15421791" author="remkop@yahoo.com" created="Mon, 15 Aug 2016 22:25:27 +0000"  >&lt;p&gt;I&apos;ll take a look at this when I get back from traveling at the end of the week. &lt;/p&gt;</comment>
                            <comment id="15427494" author="remkop@yahoo.com" created="Fri, 19 Aug 2016 02:09:36 +0000"  >&lt;p&gt; By default the AsyncQueueFullPolicy will only log synchronously if it detects that the logging attempt is made from the background thread, since this will definitely cause a deadlock.&lt;/p&gt;

&lt;p&gt;In your case the logging attempt (from the toString method) is made from one of the application threads. It is unclear to me why this would deadlock. Is your environment Solaris? We have seen a similar issue with Solaris before (TODO add link to relevant Jira ticket).&lt;/p&gt;</comment>
                            <comment id="15427578" author="leonfin" created="Fri, 19 Aug 2016 04:05:36 +0000"  >&lt;p&gt;Yes on Solaris. But I thought that issue was already fixed. It didn&apos;t deadlock just once. It deadlocked on that specific service on multiple instances (3) of that service. First two instances then were restarted fine, but 3rd instance was restarted twice and same deadlock. The only solution was to disable async logging and then it started. Same code is used in 100s of other services and instances with async logging and no issues observed. The other services are mixture of Solaris and Linux.&lt;/p&gt;</comment>
                            <comment id="15428304" author="leonfin" created="Fri, 19 Aug 2016 14:59:56 +0000"  >&lt;p&gt;Do you mean this issue? &lt;a href=&quot;https://github.com/LMAX-Exchange/disruptor/issues/138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/LMAX-Exchange/disruptor/issues/138&lt;/a&gt;&lt;br/&gt;
If that&apos;s the case, then please upgrade log4j2 to disruptor 3.3.5. But in my case the disruptor background thread is RUNNABLE and looping in ProcessingSequenceBarrier.waitFor. So sounds similar but not exactly the same. Checked 3 instances thread dumps and exactly the same for AsyncLogger thread. So it&apos;s just looping and pegging the CPU, but not picking up any of the events. 100% CPU usage by the JVM confirmed when this happened.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;Log4j2-AsyncLogger[AsyncContext@18b4aac2]1&quot; #24 daemon prio=5 os_prio=64 tid=0x0000000001f8d800 nid=0x2b runnable [0xfffffd7e695fe000]
   java.lang.Thread.State: RUNNABLE
        at com.lmax.disruptor.ProcessingSequenceBarrier.waitFor(ProcessingSequenceBarrier.java:56)
        at com.lmax.disruptor.BatchEventProcessor.run(BatchEventProcessor.java:124)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Disruptor 3.3.5 changelog:&lt;br/&gt;
    Fix NPE in TimeoutBlockingWaitStrategy when used with WorkProcessor&lt;br/&gt;
    Add LiteTimeoutBlockingWaitStrategy&lt;br/&gt;
    Resignal any waiting threads when trying to publish to a full ring buffer&lt;/p&gt;</comment>
                            <comment id="15429105" author="remkop@yahoo.com" created="Sat, 20 Aug 2016 00:25:06 +0000"  >&lt;p&gt;Yes, that is the ticket I meant. Can you try if the problems still occurs when you use disruptor 3.3.5? Log4j2 should work with that version.&lt;/p&gt;</comment>
                            <comment id="15429543" author="remkop@yahoo.com" created="Sun, 21 Aug 2016 00:27:46 +0000"  >&lt;p&gt;Leon, I finally took a closer look at this and I see now that this is a Log4j2 issue, not a Disruptor issue.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;https://github.com/apache/logging-log4j2/blob/d00c38dddf6a3c90a29c14a73ba1f9e56bbbf0b9/log4j-core/src/main/java/org/apache/logging/log4j/core/async/DefaultAsyncQueueFullPolicy.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DefaultAsyncQueueFullPolicy&lt;/a&gt; assumes that the &lt;tt&gt;toString&lt;/tt&gt; method is only invoked from the background thread. Some changes in log4j-2.6 mean that this is no longer the case.&lt;/p&gt;

&lt;p&gt;One way to fix this is to let DefaultAsyncQueueFullPolicy always send the event directly to the appender (&lt;tt&gt;return EventRoute.SYNCHRONOUS&lt;/tt&gt;) unconditionally when the queue is full.&lt;/p&gt;

&lt;p&gt;You don&apos;t need to wait for the next log4j2 release to address this. You can provide a custom policy like the below and configure log4j to use it by specifying system property &lt;tt&gt;-Dlog4j2.AsyncQueueFullPolicy=com.mypackage.MyQueueFullPolicy&lt;/tt&gt;.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; com.mypackage;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyQueueFullPolicy &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; AsyncQueueFullPolicy {
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; EventRoute getRoute(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; backgroundThreadId, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Level level) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; EventRoute.SYNCHRONOUS;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15429590" author="garydgregory" created="Sun, 21 Aug 2016 05:23:26 +0000"  >&lt;p&gt;We should stop using deprecated APIs from the Disruptor IMO.&lt;/p&gt;</comment>
                            <comment id="15463748" author="leonfin" created="Mon, 5 Sep 2016 00:21:03 +0000"  >&lt;p&gt;Remko, i added sync policy. But it means logging can happen out of sequence when buffer is full in all cases and not just toString logging case.&lt;/p&gt;</comment>
                            <comment id="15463785" author="remkop@yahoo.com" created="Mon, 5 Sep 2016 00:53:36 +0000"  >&lt;p&gt;Leon, yes, this may result events end up in the log out of sequence. I agree this is undesirable (but it is better than deadlock...) if there are other ways around this, I am open to ideas.&lt;/p&gt;

&lt;p&gt;My hope is that the case where objects doing logging in their &lt;tt&gt;toString()&lt;/tt&gt; method when the RingBuffer is full is a very rare case...&lt;/p&gt;

&lt;p&gt;I haven&apos;t addressed this in master yet. I may be able to squeeze fixing the DefaultAsyncQueueFullPolicy into 2.7 but it depends on when the release manager starts the release...&lt;/p&gt;</comment>
                            <comment id="15464871" author="leonfin" created="Mon, 5 Sep 2016 12:15:49 +0000"  >&lt;p&gt;Logging from toString wouldn&apos;t be intentional. It can happen when someone calls some other method, which calls some other method, etc. eventually something logs. It happened in our case and causes denial of service since all threads of the process eventually deadlock on logging. The particular instance of code was fixed. But with millions lines of code and many library dependencies it&apos;s hard to know what&apos;s lurking out there. It&apos;s a bug waiting to happen under the right conditions. Same as &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1457&quot; title=&quot;Class loader deadlock when using async logging and extended stack trace pattern&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1457&quot;&gt;&lt;del&gt;LOG4J2-1457&lt;/del&gt;&lt;/a&gt;. I think the deadlocks warrant emergency fix.&lt;/p&gt;</comment>
                            <comment id="15465502" author="remkop@yahoo.com" created="Mon, 5 Sep 2016 18:00:16 +0000"  >&lt;p&gt;Fixed in master in commit 8bd80f3.&lt;br/&gt;
Please verify and close.&lt;/p&gt;</comment>
                            <comment id="15466164" author="leonfin" created="Tue, 6 Sep 2016 02:11:38 +0000"  >&lt;p&gt;Confirmed. Attached patch with unit test that can prove it working or not working. Thank you&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13099798">LOG4J2-2031</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12823693" name="10511.jstack" size="332262" author="leonfin" created="Mon, 15 Aug 2016 14:13:39 +0000"/>
                            <attachment id="12827109" name="LOG4J2-1518.patch" size="3316" author="leonfin" created="Tue, 6 Sep 2016 02:11:38 +0000"/>
                            <attachment id="12823649" name="async_deadlock.txt" size="6355" author="leonfin" created="Mon, 15 Aug 2016 03:00:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 11 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i32b1b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>