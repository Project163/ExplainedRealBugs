<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:37:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1642] DefaultShutdownCallbackRegistry can throw a NoClassDefFoundError</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1642</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;When running the Maven goals for packaging my project an exception is thrown when the JVM exits..&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 01:36 min (Wall Clock)
[INFO] Finished at: 2016-10-18T12:06:06+03:00
[INFO] Final Memory: 48M/626M
[INFO] ------------------------------------------------------------------------
Exception in thread &quot;pool-1-thread-1&quot; java.lang.NoClassDefFoundError: org/apache/logging/log4j/message/ParameterizedMessage
	at org.apache.logging.log4j.message.ParameterizedNoReferenceMessageFactory.newMessage(ParameterizedNoReferenceMessageFactory.java:104)
	at org.apache.logging.log4j.message.AbstractMessageFactory.newMessage(AbstractMessageFactory.java:75)
	at org.apache.logging.log4j.spi.AbstractLogger.logMessage(AbstractLogger.java:2010)
	at org.apache.logging.log4j.spi.AbstractLogger.logIfEnabled(AbstractLogger.java:1884)
	at org.apache.logging.log4j.spi.AbstractLogger.error(AbstractLogger.java:793)
	at org.apache.logging.log4j.core.util.DefaultShutdownCallbackRegistry.run(DefaultShutdownCallbackRegistry.java:76)
	at java.lang.Thread.run(Thread.java:745)
Caused by: java.lang.ClassNotFoundException: org.apache.logging.log4j.message.ParameterizedMessage
	at org.codehaus.plexus.classworlds.strategy.SelfFirstStrategy.loadClass(SelfFirstStrategy.java:50)
	at org.codehaus.plexus.classworlds.realm.ClassRealm.unsynchronizedLoadClass(ClassRealm.java:271)
	at org.codehaus.plexus.classworlds.realm.ClassRealm.loadClass(ClassRealm.java:247)
	at org.codehaus.plexus.classworlds.realm.ClassRealm.loadClass(ClassRealm.java:239)
	... 7 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;java version &quot;1.8.0_60&quot;&lt;br/&gt;
Maven_3.2.2&lt;/p&gt;</environment>
        <key id="13013112">LOG4J2-1642</key>
            <summary>DefaultShutdownCallbackRegistry can throw a NoClassDefFoundError</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ggregory">Gary D. Gregory</assignee>
                                    <reporter username="johno">Johno Crawford</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Oct 2016 09:12:13 +0000</created>
                <updated>Wed, 1 Mar 2017 11:47:20 +0000</updated>
                            <resolved>Wed, 7 Dec 2016 00:10:01 +0000</resolved>
                                    <version>2.7</version>
                                    <fixVersion>2.8</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15584958" author="johno" created="Tue, 18 Oct 2016 09:13:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mikaelstaldal&quot; class=&quot;user-hover&quot; rel=&quot;mikaelstaldal&quot;&gt;mikaelstaldal&lt;/a&gt; is this a known issue with the shutdown hook?&lt;/p&gt;</comment>
                            <comment id="15584976" author="mikaelstaldal" created="Tue, 18 Oct 2016 09:20:31 +0000"  >&lt;p&gt;Not that I am aware of.&lt;/p&gt;</comment>
                            <comment id="15584983" author="mikaelstaldal" created="Tue, 18 Oct 2016 09:21:44 +0000"  >&lt;p&gt;Can you provide some more information on how to reproduce this problem? The full Maven command line, and preferably a complete Maven project (or at least a .pom file).&lt;/p&gt;</comment>
                            <comment id="15585072" author="johno" created="Tue, 18 Oct 2016 10:05:28 +0000"  >&lt;p&gt;I am working on providing a reproducer but haven&apos;t had any luck so far, will update here if that changes.&lt;/p&gt;</comment>
                            <comment id="15585076" author="johno" created="Tue, 18 Oct 2016 10:06:44 +0000"  >&lt;p&gt;For my reference.&lt;/p&gt;

&lt;p&gt;java.lang.NoClassDefFoundError This exception indicates that the JVM looked in its internal class definition data structure for the definition of a class and did not find it. This is different than saying that it could not be loaded from the classpath. Usually this indicates that we previously attempted to load a class from the classpath, but it failed for some reason - now we&apos;re trying to use the class again (and thus need to load it, since it failed last time), but we&apos;re not even going to try to load it, because we failed loading it earlier (and reasonably suspect that we would fail again). The earlier failure could be a ClassNotFoundException or an ExceptionInInitializerError (indicating a failure in the static initialization block) or any number of other problems. The point is, a NoClassDefFoundError is not necessarily a classpath problem.&lt;/p&gt;</comment>
                            <comment id="15675407" author="rajind" created="Fri, 18 Nov 2016 01:34:55 +0000"  >&lt;p&gt;Hi, this seems to be reproducing in mine after moving from log4j2 v2.6 to v2.7. I&apos;m still trying to figure out the new changes between 2.6 to 2.7 that is causing this issue. &lt;/p&gt;

&lt;p&gt;One important thing I could notice is that if I run maven clean install with the log4j2 configuration as &quot;mvn clean install -Dlog4j.configurationFile=conf/log4j2.xml&quot; where in the configuration shutdownHook is disabled, then this issue is not occurring.&lt;/p&gt;

&lt;p&gt;So somehow this issue is related to log4j shutdown hook being registered while maven build. &lt;/p&gt;</comment>
                            <comment id="15725355" author="johno" created="Tue, 6 Dec 2016 12:35:40 +0000"  >&lt;p&gt;The fact LOGGER.error is used in a try catch Throwable inside a shutdown hook is a bad idea, in my opinion we should consider using System.err or just invoke t.printStacktrace().. instead as LOGGER.error may fail and the root cause of the error will be masked. I will try patching log4j-core to find the root cause of my exception.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    /**
     * Executes the registered shutdown callbacks.
     */
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (state.compareAndSet(State.STARTED, State.STOPPING)) {
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; hook : hooks) {
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Executing shutdown hook &quot;&lt;/span&gt; + hook);
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    hook.run();
                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Throwable t) {
                    t.printStackTrace();
                    &lt;span class=&quot;code-comment&quot;&gt;//LOGGER.error(SHUTDOWN_HOOK_MARKER, &lt;span class=&quot;code-quote&quot;&gt;&quot;Caught exception executing shutdown hook {}&quot;&lt;/span&gt;, hook, t);
&lt;/span&gt;                }
            }
            state.set(State.STOPPED);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15725454" author="johno" created="Tue, 6 Dec 2016 13:14:10 +0000"  >&lt;p&gt;here is the &quot;root cause&quot; exception..&lt;/p&gt;

&lt;p&gt;java.lang.NoClassDefFoundError: org/apache/logging/log4j/core/util/ExecutorServices&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:337)&lt;br/&gt;
	at org.apache.logging.log4j.core.AbstractLifeCycle.stop(AbstractLifeCycle.java:127)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext$1.run(LoggerContext.java:275)&lt;br/&gt;
	at org.apache.logging.log4j.core.util.DefaultShutdownCallbackRegistry$RegisteredCancellable.run(DefaultShutdownCallbackRegistry.java:106)&lt;br/&gt;
	at org.apache.logging.log4j.core.util.DefaultShutdownCallbackRegistry.run(DefaultShutdownCallbackRegistry.java:74)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;br/&gt;
Caused by: java.lang.ClassNotFoundException: org.apache.logging.log4j.core.util.ExecutorServices&lt;br/&gt;
	at org.codehaus.plexus.classworlds.strategy.SelfFirstStrategy.loadClass(SelfFirstStrategy.java:50)&lt;br/&gt;
	at org.codehaus.plexus.classworlds.realm.ClassRealm.unsynchronizedLoadClass(ClassRealm.java:271)&lt;br/&gt;
	at org.codehaus.plexus.classworlds.realm.ClassRealm.loadClass(ClassRealm.java:247)&lt;br/&gt;
	at org.codehaus.plexus.classworlds.realm.ClassRealm.loadClass(ClassRealm.java:239)&lt;br/&gt;
	... 6 more&lt;/p&gt;</comment>
                            <comment id="15725465" author="johno" created="Tue, 6 Dec 2016 13:19:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=garydgregory&quot; class=&quot;user-hover&quot; rel=&quot;garydgregory&quot;&gt;garydgregory&lt;/a&gt; I believe this to be a regression with &lt;a href=&quot;https://github.com/apache/logging-log4j2/commit/221b68d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/commit/221b68d&lt;/a&gt; by invoking shutdown from within LoggerContext I no longer see these exceptions on JVM shutdown.&lt;/p&gt;</comment>
                            <comment id="15725616" author="johno" created="Tue, 6 Dec 2016 14:21:18 +0000"  >&lt;p&gt;To verify I wrapped the executors shutdown calls and printed the exception there too..&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                shutdownEs = ExecutorServices.shutdown(executorService, timeout, timeUnit, source);
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable e) {
                e.printStackTrace();
            }
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                shutdownEsd = ExecutorServices.shutdown(executorServiceDeamons, -1, timeUnit, source);
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable e) {
                e.printStackTrace();
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Executing shutdown hook Shutdown callback for LoggerContext&lt;span class=&quot;error&quot;&gt;&amp;#91;name=1e578d2c&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.NoClassDefFoundError: org/apache/logging/log4j/core/util/ExecutorServices&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:338)&lt;br/&gt;
	at org.apache.logging.log4j.core.AbstractLifeCycle.stop(AbstractLifeCycle.java:127)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext$1.run(LoggerContext.java:275)&lt;br/&gt;
	at org.apache.logging.log4j.core.util.DefaultShutdownCallbackRegistry$RegisteredCancellable.run(DefaultShutdownCallbackRegistry.java:107)&lt;br/&gt;
	at org.apache.logging.log4j.core.util.DefaultShutdownCallbackRegistry.run(DefaultShutdownCallbackRegistry.java:75)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;br/&gt;
Caused by: java.lang.ClassNotFoundException: org.apache.logging.log4j.core.util.ExecutorServices&lt;br/&gt;
	at org.codehaus.plexus.classworlds.strategy.SelfFirstStrategy.loadClass(SelfFirstStrategy.java:50)&lt;br/&gt;
	at org.codehaus.plexus.classworlds.realm.ClassRealm.unsynchronizedLoadClass(ClassRealm.java:271)&lt;br/&gt;
	at org.codehaus.plexus.classworlds.realm.ClassRealm.loadClass(ClassRealm.java:247)&lt;br/&gt;
	at org.codehaus.plexus.classworlds.realm.ClassRealm.loadClass(ClassRealm.java:239)&lt;br/&gt;
	... 6 more&lt;/p&gt;</comment>
                            <comment id="15725622" author="johno" created="Tue, 6 Dec 2016 14:22:47 +0000"  >&lt;p&gt;&lt;del&gt;I wonder if in some circumstances during JVM shutdown the JVM will refuse to load new classes..? Or&lt;/del&gt; maybe there are two JVM hooks racing and the classloader is cleaned up? &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; Unfortunately I am not familiar with how plexus-classworlds works wrt class loading / lifecycle.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/lang/Runtime.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/7/docs/api/java/lang/Runtime.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&quot;When the virtual machine begins its shutdown sequence it will start all registered shutdown hooks in some unspecified order and let them run concurrently.&quot;&lt;/p&gt;</comment>
                            <comment id="15726209" author="johno" created="Tue, 6 Dec 2016 17:52:09 +0000"  >&lt;p&gt;Please find attached patch proposal.&lt;/p&gt;</comment>
                            <comment id="15727155" author="garydgregory" created="Wed, 7 Dec 2016 00:10:02 +0000"  >&lt;p&gt;Patch applied. Thank you. Please verify and close.&lt;/p&gt;</comment>
                            <comment id="15728314" author="johno" created="Wed, 7 Dec 2016 09:54:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=garydgregory&quot; class=&quot;user-hover&quot; rel=&quot;garydgregory&quot;&gt;garydgregory&lt;/a&gt; I don&apos;t see a 2.8 snapshot (the fix version set in JIRA) &lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/org/apache/logging/log4j/log4j-core/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/logging/log4j/log4j-core/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Is 2.7.1 built from master or will it need to be backported to some branch?&lt;/p&gt;</comment>
                            <comment id="15728329" author="johno" created="Wed, 7 Dec 2016 10:01:17 +0000"  >&lt;p&gt;I checked log4j-core-2.7.1-20161207.040938-136-sources.jar manually, seems to contain the fix. Will try it now.&lt;/p&gt;</comment>
                            <comment id="15728546" author="johno" created="Wed, 7 Dec 2016 11:37:27 +0000"  >&lt;p&gt;Verified the exception is no longer thrown with 2.7.1 SNAPSHOT, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=garydgregory&quot; class=&quot;user-hover&quot; rel=&quot;garydgregory&quot;&gt;garydgregory&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="15729126" author="garydgregory" created="Wed, 7 Dec 2016 16:11:01 +0000"  >&lt;p&gt;Hi Johno,&lt;/p&gt;

&lt;p&gt;We will end up releasing 2.7.1-SNAPSHOT as 2.8.&lt;/p&gt;

&lt;p&gt;Gary&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13047288">LOG4J2-1830</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12842002" name="LOG4J2_1642.patch" size="2710" author="johno" created="Tue, 6 Dec 2016 17:50:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 50 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i350vz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>