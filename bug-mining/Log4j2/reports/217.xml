<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:32:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-459] Race condition on Web app configuration prevents ${web:initParam. lookup</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-459</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;I am happy for someone to challenge me on this assertion, but I cannot see how ${web:initParam.*} notation in XML configuration could ever work in 2.0-beta9 at least. Well at least for bootstrapped config.&lt;/p&gt;

&lt;p&gt;I have a Web application that includes an XML configfile in the WAR at:&lt;/p&gt;

&lt;p&gt;WEB-INF/classes/log4j2.xml&lt;/p&gt;

&lt;p&gt;The file looks something like this:&lt;/p&gt;

&lt;p&gt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;&lt;br/&gt;
&amp;lt;Configuration status=&quot;WARN&quot;&amp;gt;&lt;br/&gt;
&amp;lt;Appenders&amp;gt;&lt;br/&gt;
&amp;lt;File name=&quot;file&quot; fileName=&quot;${web:initParam.myapp.logdir}/myapp.log&quot; append=&quot;true&quot;&amp;gt;&lt;br/&gt;
	&amp;lt;PatternLayout pattern=&quot;%d &lt;span class=&quot;error&quot;&gt;&amp;#91;%t&amp;#93;&lt;/span&gt; %-5p %c - %m%n&quot;/&amp;gt;&lt;br/&gt;
&amp;lt;/File&amp;gt;&lt;br/&gt;
&amp;lt;/Appenders&amp;gt;&lt;br/&gt;
&amp;lt;Loggers&amp;gt;&lt;br/&gt;
&amp;lt;Root level=&quot;warn&quot;&amp;gt;&lt;br/&gt;
&amp;lt;AppenderRef ref=&quot;file&quot;/&amp;gt;&lt;br/&gt;
 &amp;lt;/Root&amp;gt;&lt;br/&gt;
&amp;lt;/Loggers&amp;gt;&lt;br/&gt;
&amp;lt;/Configuration&amp;gt;&lt;/p&gt;

&lt;p&gt;For the uninitiated, a recap on how ${web:initParam.myapp.logdir} is resolved, to the best of my understanding.&lt;/p&gt;

&lt;p&gt;The ${web: prefix will indicate to log4j2 that it should use the WebLookup class to resolve what comes after it; initParam.myapp.logdir.&lt;/p&gt;

&lt;p&gt;WebLookup will then check if that key is prefixed with initParam. (as well as another attr type prefix), and seeing that it is, will use the remainder as the real key name: myapp.logdir.&lt;/p&gt;

&lt;p&gt;It then calls getInitParameter() with that key on the ServletContext for the parent web application. That should pluck a value that could, for example, be configured in the web.xml like this:&lt;/p&gt;

&lt;p&gt;     &amp;lt;context-param&amp;gt;&lt;br/&gt;
    &amp;lt;param-name&amp;gt;myapp.logdir&amp;lt;/param-name&amp;gt;&lt;br/&gt;
    &amp;lt;param-value&amp;gt;c:/myapp_logs&amp;lt;/param-value&amp;gt;&lt;br/&gt;
    &amp;lt;/context-param&amp;gt;&lt;/p&gt;

&lt;p&gt;However, this is where there is a race condition. To get the ServletContext , the WebLookup.lookup() method will call its own getServletContext() method. This in term attempt to get the ServletContext from the LogManager singleton, which stores it as an untyped (java.lang.Object) externalContext concept.&lt;/p&gt;

&lt;p&gt;For a Web App, this externalContext is not being set ahead of the bootstrapping parse of the XML config file.The problem can be seen in the sequencing of instructions in the Configurator.initialize() method:&lt;/p&gt;

&lt;p&gt;    public static LoggerContext initialize(final String name, final ClassLoader loader, final URI configLocation,&lt;br/&gt;
                                           final Object externalContext) {&lt;/p&gt;

&lt;p&gt;        try {&lt;br/&gt;
            final org.apache.logging.log4j.spi.LoggerContext context = LogManager.getContext(loader, false, configLocation);&lt;br/&gt;
            if (context instanceof LoggerContext) {&lt;br/&gt;
                final LoggerContext ctx = (LoggerContext) context;&lt;br/&gt;
                ContextAnchor.THREAD_CONTEXT.set(ctx);&lt;br/&gt;
                if (externalContext != null) &lt;/p&gt;
{
                    ctx.setExternalContext(externalContext);
                }

&lt;p&gt;This line:&lt;/p&gt;

&lt;p&gt;            final org.apache.logging.log4j.spi.LoggerContext context = LogManager.getContext(loader, false, configLocation);&lt;/p&gt;

&lt;p&gt;kicks-off the boostrapped parse of the XML config, that in turn utilizes WebLookup.lookup().&lt;/p&gt;

&lt;p&gt;You can see however that ctx.setExternalContext(externalContext) is called after.&lt;/p&gt;

&lt;p&gt;Simple reasoning suggests that this initialization could be moved ahead. However this code applies to non-web apps too, and being not familiar with the design and intentions, I&apos;d be very appreciative of someone looking into a fix for this.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12682636">LOG4J2-459</key>
            <summary>Race condition on Web app configuration prevents ${web:initParam. lookup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rgoers">Ralph Goers</assignee>
                                    <reporter username="da4an1qu1">Shaddy Baddah</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Dec 2013 07:48:08 +0000</created>
                <updated>Thu, 9 Jan 2014 04:02:00 +0000</updated>
                            <resolved>Sat, 4 Jan 2014 18:26:36 +0000</resolved>
                                    <version>2.0-beta9</version>
                                    <fixVersion>2.0-rc1</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13839921" author="ralph.goers@dslextreme.com" created="Thu, 5 Dec 2013 07:52:00 +0000"  >&lt;p&gt;LogManager.getContext does not kick off configuration.  If you will notice in the code you have shown that the two lines following that are:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Configuration config = ConfigurationFactory.getInstance().getConfiguration(name, configLocation);
ctx.start(config);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The configuration is processed via the call to start, which is happening after the external context is set.&lt;/p&gt;</comment>
                            <comment id="13840055" author="da4an1qu1" created="Thu, 5 Dec 2013 12:48:13 +0000"  >&lt;p&gt;Thanks for the explanation Ralph. But what I mean is that LogManager.getContext &lt;b&gt;indirectly&lt;/b&gt; is kicking-off the configuration. I&apos;ve included the full stack trace of a run at the base of the comment, but the telling portion is directly below this line:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;	LoggerContext.start() line: 149	
	Log4jContextFactory.getContext(String, ClassLoader, boolean, URI) line: 104	
	Log4jContextFactory.getContext(String, ClassLoader, boolean, URI) line: 34	
	LogManager.getContext(ClassLoader, boolean, URI) line: 187	
	Configurator.initialize(String, ClassLoader, URI, Object) line: 103	
	Configurator.initialize(String, ClassLoader, String, Object) line: 63	
	Log4jWebInitializerImpl.initializeNonJndi(String) line: 136	
	Log4jWebInitializerImpl.initialize() line: 82	
	Log4jServletContainerInitializer.onStartup(Set&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;, ServletContext) line: 41	
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So you can see that LogManager.getContext() leads a path down to the very same call to start as the lines you listed.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Thread [main] (Suspended (breakpoint at line 49 in WebLookup))	
	WebLookup.lookup(String) line: 49	
	Interpolator.lookup(LogEvent, String) line: 121	
	StrSubstitutor.resolveVariable(LogEvent, String, StringBuilder, int, int) line: 904	
	StrSubstitutor.substitute(LogEvent, StringBuilder, int, int, List&amp;lt;String&amp;gt;) line: 825	
	StrSubstitutor.substitute(LogEvent, StringBuilder, int, int) line: 737	
	StrSubstitutor.replace(LogEvent, String) line: 306	
	XMLConfiguration(BaseConfiguration).createPluginObject(PluginType&amp;lt;T&amp;gt;, Node, LogEvent) line: 720	
	XMLConfiguration(BaseConfiguration).createConfiguration(Node, LogEvent) line: 595	
	XMLConfiguration(BaseConfiguration).createConfiguration(Node, LogEvent) line: 587	
	XMLConfiguration(BaseConfiguration).doConfigure() line: 244	
	XMLConfiguration(BaseConfiguration).start() line: 142	
	LoggerContext.setConfiguration(Configuration) line: 339	
	LoggerContext.reconfigure() line: 378	
	LoggerContext.start() line: 149	
	Log4jContextFactory.getContext(String, ClassLoader, boolean, URI) line: 104	
	Log4jContextFactory.getContext(String, ClassLoader, boolean, URI) line: 34	
	LogManager.getContext(ClassLoader, boolean, URI) line: 187	
	Configurator.initialize(String, ClassLoader, URI, Object) line: 103	
	Configurator.initialize(String, ClassLoader, String, Object) line: 63	
	Log4jWebInitializerImpl.initializeNonJndi(String) line: 136	
	Log4jWebInitializerImpl.initialize() line: 82	
	Log4jServletContainerInitializer.onStartup(Set&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;, ServletContext) line: 41	
	ContainerInitializer.callStartup(WebAppContext) line: 106	
	ServletContainerInitializerListener.doStart() line: 107	
	ServletContainerInitializerListener(AbstractLifeCycle).start() line: 64	
	JettyWebAppContext(AggregateLifeCycle).doStart() line: 81	
	JettyWebAppContext(AbstractHandler).doStart() line: 58	
	JettyWebAppContext(HandlerWrapper).doStart() line: 96	
	JettyWebAppContext(ScopedHandler).doStart() line: 115	
	JettyWebAppContext(ContextHandler).startContext() line: 763	
	JettyWebAppContext(ServletContextHandler).startContext() line: 249	
	JettyWebAppContext(WebAppContext).startContext() line: 1242	
	JettyWebAppContext(ContextHandler).doStart() line: 717	
	JettyWebAppContext(WebAppContext).doStart() line: 494	
	JettyWebAppContext.doStart() line: 298	
	JettyWebAppContext(AbstractLifeCycle).start() line: 64	
	ContextHandlerCollection(HandlerCollection).doStart() line: 229	
	ContextHandlerCollection.doStart() line: 172	
	ContextHandlerCollection(AbstractLifeCycle).start() line: 64	
	HandlerCollection.doStart() line: 229	
	HandlerCollection(AbstractLifeCycle).start() line: 64	
	JettyServer(HandlerWrapper).doStart() line: 95	
	JettyServer(Server).doStart() line: 282	
	JettyServer.doStart() line: 65	
	JettyServer(AbstractLifeCycle).start() line: 64	
	JettyRunMojo(AbstractJettyMojo).startJetty() line: 520	
	JettyRunMojo(AbstractJettyMojo).execute() line: 365	
	JettyRunMojo.execute() line: 523	
	DefaultBuildPluginManager.executeMojo(MavenSession, MojoExecution) line: 101	
	MojoExecutor.execute(MavenSession, MojoExecution, ProjectIndex, DependencyContext) line: 209	
	MojoExecutor.execute(MavenSession, MojoExecution, ProjectIndex, DependencyContext, PhaseRecorder) line: 153	
	MojoExecutor.execute(MavenSession, List&amp;lt;MojoExecution&amp;gt;, ProjectIndex) line: 145	
	LifecycleModuleBuilder.buildProject(MavenSession, MavenSession, ReactorContext, MavenProject, TaskSegment) line: 84	
	LifecycleModuleBuilder.buildProject(MavenSession, ReactorContext, MavenProject, TaskSegment) line: 59	
	LifecycleStarter.singleThreadedBuild(MavenSession, ReactorContext, ProjectBuildList, List&amp;lt;TaskSegment&amp;gt;, ReactorBuildStatus) line: 183	
	LifecycleStarter.execute(MavenSession) line: 161	
	DefaultMaven.doExecute(MavenExecutionRequest) line: 320	
	DefaultMaven.execute(MavenExecutionRequest) line: 156	
	MavenCli.execute(MavenCli$CliRequest) line: 537	
	MavenCli.doMain(MavenCli$CliRequest) line: 196	
	MavenCli.main(String[], ClassWorld) line: 141	
	NativeMethodAccessorImpl.invoke0(Method, Object, Object[]) line: not available [native method]	
	NativeMethodAccessorImpl.invoke(Object, Object[]) line: 57	
	DelegatingMethodAccessorImpl.invoke(Object, Object[]) line: 43	
	Method.invoke(Object, Object...) line: 606	
	Launcher.launchEnhanced(String[]) line: 290	
	Launcher.launch(String[]) line: 230	
	Launcher.mainWithExitCode(String[]) line: 409	
	Launcher.main(String[]) line: 352	
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13840187" author="ralph.goers@dslextreme.com" created="Thu, 5 Dec 2013 15:42:14 +0000"  >&lt;p&gt;What happens when the start method is called again in Configurator.initialize? Isn&apos;t the configuration replaced with one where the WebLookup works properly?&lt;/p&gt;</comment>
                            <comment id="13840944" author="da4an1qu1" created="Fri, 6 Dec 2013 04:06:04 +0000"  >&lt;p&gt;Unfortunately not. By that stage, the &quot;horse has bolted&quot;. That is, log4j has actually tried to configure the appender and failed. Including all the other failures of loggers that reference the failed appender. Here is an example of what I see falling through the stack to complete the call to getContext():&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-12-06 14:51:50,361 ERROR FileManager (${web:initParam.myappdir}/myapp.log) java.io.FileNotFoundException: ${web:initParam.myappdir}/myapp.log (The filename, directory name, or volume label syntax is incorrect)
2013-12-06 14:51:50,364 ERROR Unable to invoke method createAppender in class org.apache.logging.log4j.core.appender.FileAppender for element File java.lang.reflect.InvocationTargetException
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And it stands to reason. The following ctx.start(config) does nothing. As the code for LoggerContext.start does this check:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        if (configLock.tryLock()) {
            try {
                if ((status == Status.INITIALIZED || status == Status.STOPPED) &amp;amp;&amp;amp; config.isShutdownHookEnabled() ) {
...
                    status = Status.STARTED;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The earlier call to start has set the status to STARTED.&lt;/p&gt;

&lt;p&gt;I&apos;m quite convinced that this is a &quot;chicken-egg&quot; scenario (if race condition is exclusive to multi-threaded scenarios).&lt;/p&gt;

</comment>
                            <comment id="13841365" author="ralph.goers@dslextreme.com" created="Fri, 6 Dec 2013 15:48:01 +0000"  >&lt;p&gt;OK. Thanks for the extra info. With all of that I agree that this is indeed a bug.&lt;/p&gt;</comment>
                            <comment id="13862380" author="ralph.goers@dslextreme.com" created="Sat, 4 Jan 2014 18:26:36 +0000"  >&lt;p&gt;Fixed in revision 1555400. Please verify and close.&lt;/p&gt;</comment>
                            <comment id="13866291" author="da4an1qu1" created="Thu, 9 Jan 2014 04:02:00 +0000"  >&lt;p&gt;Although I encountered &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-492&quot; title=&quot;MalformedObjectNameException: Invalid escape sequence... under Jetty&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-492&quot;&gt;&lt;del&gt;LOG4J2-492&lt;/del&gt;&lt;/a&gt; confirming the fix for this issue, I can confirm that the fix works. Thanks &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>361893</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 45 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qdrj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>362188</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>