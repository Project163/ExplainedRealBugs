<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:33:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-798] jar scanning for plugins too expensive and called too many times</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-798</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;related to: &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-741&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/LOG4J2-741&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It takes about 3 seconds to perform &lt;tt&gt;PluginManager.collectPlugins()&lt;/tt&gt; and it appears to run 4 times before log4j2 is done initializing. That is pretty not okay. Please consider making the plugin discovery method configurable and/or curtailing the redundant calls.&lt;/p&gt;

&lt;p&gt;My application jar uses the maven shade plugin. I do not specify a &apos;packages&apos; attribute. I do use a custom plugin (a configuration factory), but I excluded the resultant plugin dat file created for it and specify its usage at runtime via the appropriate system property.&lt;/p&gt;

&lt;p&gt;My suggestion for the easiest fix is to use the pre-computed plugin list and optionally (maybe even enabled by default) also scan the class path for custom plugins.&lt;/p&gt;

&lt;p&gt;Some nice extras would be:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;removing the redundant &lt;tt&gt;collectPlugins()&lt;/tt&gt; calls&lt;/li&gt;
	&lt;li&gt;using a plugin dat file format that is both human friendly and amenable to append operations so that users of the maven shade plugin and users who struggle with annotation processors can easily include custom plugins. See &lt;a href=&quot;https://github.com/addthis/codec&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/addthis/codec&lt;/a&gt; for an example of such a plugin system/ file format that is based on hocon.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>&lt;p&gt;modern hardware, fat jar&lt;/p&gt;</environment>
        <key id="12736538">LOG4J2-798</key>
            <summary>jar scanning for plugins too expensive and called too many times</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ianbarfield">Ian Barfield</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Aug 2014 15:55:34 +0000</created>
                <updated>Thu, 25 Sep 2014 21:41:08 +0000</updated>
                            <resolved>Thu, 25 Sep 2014 02:01:00 +0000</resolved>
                                    <version>2.0.1</version>
                    <version>2.0.2</version>
                                    <fixVersion>2.1</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14109272" author="ralph.goers@dslextreme.com" created="Mon, 25 Aug 2014 16:28:24 +0000"  >&lt;p&gt;The 4 calls you see are not redundant. They are each collecting different types of plugins. If you do not specify a packages attribute and the .dat file is present this should take milliseconds, not seconds.  &lt;/p&gt;

&lt;p&gt;Did you include Log4j&apos;s .dat file in your shaded jar?  &lt;/p&gt;</comment>
                            <comment id="14109306" author="ianbarfield" created="Mon, 25 Aug 2014 16:55:23 +0000"  >&lt;p&gt;I do not see any indication in the code that they are &apos;collecting different types of plugins&apos;. They may or may not be using a different &apos;category&apos;, but the &lt;tt&gt;loadFromPackages&lt;/tt&gt; call appears to load every plugin of every category that it finds on each call. Including the first.&lt;/p&gt;

&lt;p&gt;I see this once:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;2014-08-22 22:22:02,494 DEBUG Generated plugins in 0.000056 seconds, packages: [], preload: false.&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I see this message once:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;2014-08-22 22:22:05,737 DEBUG Generated plugins in 3.242552 seconds, packages: &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.logging.log4j.core&amp;#93;&lt;/span&gt;, preload: true.&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;and this one three times:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;2014-08-22 22:22:08,833 DEBUG Generated plugins in 3.085961 seconds, packages: &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.logging.log4j.core&amp;#93;&lt;/span&gt;, preload: false.&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I am including Log4j&apos;s .dat file. That is the only way it would work at all under 2.0, and I see log messages to that effect &lt;tt&gt;2014-08-22 22:22:02,494 DEBUG Found Plugin Map at jar:&lt;a href=&quot;file:[...]Log4j2Plugins.dat&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:[...]Log4j2Plugins.dat&lt;/a&gt;&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14109334" author="ianbarfield" created="Mon, 25 Aug 2014 17:21:26 +0000"  >&lt;p&gt;Some additional digging reveals the following:&lt;/p&gt;

&lt;p&gt;the first message is from &lt;tt&gt;AbstractConfiguration.start()&lt;/tt&gt; at line 133 &lt;tt&gt;pluginManager.collectPlugins();&lt;/tt&gt;. It loads the &quot;Core&quot; plugins and works correctly (quickly). The next call with &lt;tt&gt;preload: true&lt;/tt&gt; is from the very next two lines at 134 and 135 where it looks for any plugins with the category &quot;Level&quot;. Since there are none defined via the plugin system by default, it adds the default log4j package to the list of &apos;packages&apos; and thereby dooms itself and all subsequent calls to require jar scanning.&lt;/p&gt;

&lt;p&gt;That case could be fixed, but I would still classify the repeated full jar scans as a bug in its own right. There should be no re-scans unless there are additional packages to look for.&lt;/p&gt;</comment>
                            <comment id="14110692" author="seh4nc" created="Tue, 26 Aug 2014 13:33:46 +0000"  >&lt;p&gt;I posted a patch at &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-745&quot; title=&quot;Plugins can cause ConverterKeys collisions with unpredictable results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-745&quot;&gt;&lt;del&gt;LOG4J2-745&lt;/del&gt;&lt;/a&gt; that improves and documents the plugin loading. Matt reviewed it but has not checked it in.&lt;/p&gt;

&lt;p&gt;I am 90% sure my code would fix Ian&apos;s problem.&lt;/p&gt;</comment>
                            <comment id="14110776" author="ianbarfield" created="Tue, 26 Aug 2014 14:52:54 +0000"  >&lt;p&gt;Gave the patch a once over. Without comment on the rest of the changes, it does seem to fix at least the specific issue of the &apos;Level&apos; category erroneously triggering core package scans. Naturally, I feel that the solution I created for codec is superior for that issue since it uses an existing, well-documented and supported standard for controlling overrides etc.&lt;/p&gt;

&lt;p&gt;However, as long as I can prevent any package scans and include my configuration factory via a system property (as a specific class &amp;#8211; not a package that requires jar scans), then that&apos;s all I really need.&lt;/p&gt;</comment>
                            <comment id="14111310" author="jvz" created="Tue, 26 Aug 2014 20:46:39 +0000"  >&lt;p&gt;I&apos;ll take a look over that (and this) more this week. I kind of got distracted by things going on in the career world of programming, so I wasn&apos;t able to spend much time on the plugin system. I would like to go that route and flesh out a better plugin registry that could integrate with OSGi, Spring, Guice, etc., similar to how Camel has a generic registry for its various types of plugins. Since we&apos;d be aiming for 2.1, we have the time to flesh out a more comprehensive plugin registry system.&lt;/p&gt;</comment>
                            <comment id="14136865" author="remkop@yahoo.com" created="Wed, 17 Sep 2014 06:51:35 +0000"  >&lt;p&gt;Is this issue resolved now that &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-745&quot; title=&quot;Plugins can cause ConverterKeys collisions with unpredictable results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-745&quot;&gt;&lt;del&gt;LOG4J2-745&lt;/del&gt;&lt;/a&gt; is committed to master?&lt;/p&gt;</comment>
                            <comment id="14146116" author="remkop@yahoo.com" created="Wed, 24 Sep 2014 09:23:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ianbarfield&quot; class=&quot;user-hover&quot; rel=&quot;ianbarfield&quot;&gt;ianbarfield&lt;/a&gt; We are getting ready for a 2.1 release. Can you verify if the problem still exists with current master? &lt;/p&gt;</comment>
                            <comment id="14147251" author="jvz" created="Thu, 25 Sep 2014 02:01:00 +0000"  >&lt;p&gt;This was fixed from the work done on &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-745&quot; title=&quot;Plugins can cause ConverterKeys collisions with unpredictable results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-745&quot;&gt;&lt;del&gt;LOG4J2-745&lt;/del&gt;&lt;/a&gt;. Could you please verify and close?&lt;/p&gt;</comment>
                            <comment id="14148356" author="ianbarfield" created="Thu, 25 Sep 2014 21:41:08 +0000"  >&lt;p&gt;The expensive part is certainly fixed, and I suppose that is more than enough for me. I still see three instances of &lt;tt&gt;PluginManager &apos;Converter&apos; found 33 plugins&lt;/tt&gt; from the status logger during init, but doesn&apos;t really bother me any I guess.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 8 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1zapj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>