<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:34:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1049] AsyncAppender eats my Interrupt</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1049</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;I wrote a LoggingThread that will be stopped by sending loggingThread.interrupt() from another Thread.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;LoggingThread.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LoggingThread &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; {
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Logger LOGGER = LoggerFactory.getLogger(LoggingThread .class);
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().isInterrupted()) {
      LOGGER.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;{} is logging {}&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;nothing&quot;&lt;/span&gt;);
    }
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Unfortunately, loggingThread.interrupt() is sometimes set before AsyncAppender.append() or at the beginning of that.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;AsyncAppender#append() line 153&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
  &lt;span class=&quot;code-comment&quot;&gt;// wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; free slots in the queue
&lt;/span&gt;  queue.put(Log4jLogEvent.serialize(coreEvent, includeLocation));
  appendSuccessful = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; InterruptedException e) {
  LOGGER.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Interrupted &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a free slot in the AsyncAppender LogEvent-queue {}&quot;&lt;/span&gt;,
  getName());
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This will make queue.put throw an InterruptedException and remove the interrupted flag of the current flag.&lt;/p&gt;

&lt;p&gt;I suggest a simple bugfix: Call Thread by Thread.currentThread().interrupt() in the catch clause. This will reset the interrupted flag of the current Thread.&lt;/p&gt;

&lt;p&gt;A more complex bugfix which doesn&apos;t loose a message:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;AsyncAppender#append() line 153&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Serializable serialized = Log4jLogEvent.serialize(coreEvent, includeLocation);
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
  &lt;span class=&quot;code-comment&quot;&gt;// wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; free slots in the queue
&lt;/span&gt;  queue.put(serialized);
  appendSuccessful = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; InterruptedException e) {
  &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    &lt;span class=&quot;code-comment&quot;&gt;// The interrupt is catched and the interrupted flag is unset.
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// Therefore offer() won&apos;t &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; with an InterruptedException
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// unless another &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; sends again an interrupt.
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// Use a timeout to handle the &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; where the Interrupt e
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// was really meant &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a hanging put() and not just 
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// coincidently sent at the same time.
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// If the put() was really hanging,
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// offer() would &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; with &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; after 10ms and no second
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// external interrupt() is required
&lt;/span&gt;    appendSuccessful = queue.offer(serialized, 10L, TimeUnit.MILLISECONDS);
  } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; InterruptedException e2) {
    &lt;span class=&quot;code-comment&quot;&gt;// queue.put is really hanging and someone 
&lt;/span&gt;  }
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!appendSuccessful) {
    LOGGER.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Interrupted &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a free slot in the AsyncAppender LogEvent-queue {}&quot;&lt;/span&gt;,
    getName());
  }
  &lt;span class=&quot;code-comment&quot;&gt;// set the interrupted flag again.
&lt;/span&gt;  &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Java 7, Windows&lt;/p&gt;</environment>
        <key id="12836830">LOG4J2-1049</key>
            <summary>AsyncAppender eats my Interrupt</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="robert.schaft">Robert Schaft</reporter>
                        <labels>
                            <label>Async</label>
                    </labels>
                <created>Wed, 10 Jun 2015 13:46:57 +0000</created>
                <updated>Thu, 11 Jun 2015 08:21:10 +0000</updated>
                            <resolved>Wed, 10 Jun 2015 16:14:13 +0000</resolved>
                                    <version>2.2</version>
                    <version>2.3</version>
                                    <fixVersion>2.4</fixVersion>
                                    <component>Appenders</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="172800">48h</timeoriginalestimate>
                            <timeestimate seconds="172800">48h</timeestimate>
                                        <comments>
                            <comment id="14580539" author="robert.schaft" created="Wed, 10 Jun 2015 13:49:53 +0000"  >&lt;p&gt;A similar problem was tackled by &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-830&quot; title=&quot;failure to shutdown JVM when join called on AsyncAppender thread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-830&quot;&gt;&lt;del&gt;LOG4J2-830&lt;/del&gt;&lt;/a&gt;. But the fix was apparently incomplete and just made the problem harder to see.&lt;/p&gt;</comment>
                            <comment id="14580706" author="remkop@yahoo.com" created="Wed, 10 Jun 2015 16:03:36 +0000"  >&lt;p&gt;Interesting use case.&lt;br/&gt;
About your proposed solution: why not simply use the &lt;tt&gt;offer(Object)&lt;/tt&gt; method without the timeout?&lt;/p&gt;</comment>
                            <comment id="14580722" author="remkop@yahoo.com" created="Wed, 10 Jun 2015 16:14:13 +0000"  >&lt;p&gt;Fixed in Git in commit ba3070e714172fe587e0bd5e9f8e0b72890a719a.&lt;br/&gt;
Please verify and close.&lt;/p&gt;</comment>
                            <comment id="14580726" author="robert.schaft" created="Wed, 10 Jun 2015 16:19:14 +0000"  >&lt;p&gt;I thought that put() will only throw an InterruptedException if the queue is full. And I wanted to give the queue a chance to drain because l feel that reliably written log messages are more important than an interrupted thread.&lt;/p&gt;

&lt;p&gt;You suggestion would solve the major design flaw in the complex solution that I saw: the magic arbitrary time constant.&lt;/p&gt;</comment>
                            <comment id="14580736" author="robert.schaft" created="Wed, 10 Jun 2015 16:22:34 +0000"  >&lt;p&gt;It is hard to verify in my code because it happens only every now and then and a lot of unrelated things are executed, too.&lt;/p&gt;</comment>
                            <comment id="14581666" author="robert.schaft" created="Thu, 11 Jun 2015 08:21:10 +0000"  >&lt;p&gt;Remko: In the comment to your patch you wrote:&lt;/p&gt;

&lt;p&gt;&lt;cite&gt;(Yes, this means there is a possibility the same event is logged twice.)&lt;/cite&gt;&lt;/p&gt;

&lt;p&gt;I don&apos;t see how. If &lt;tt&gt;put()&lt;/tt&gt; is successful, it will not throw an &lt;tt&gt;InterruptedException&lt;/tt&gt;. What am I missing?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 23 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2fvnr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>