<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:36:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1324] Install default error handler for Async Loggers that does not rethrow (was: Async Logger - Consumer thread dying - new thread unable to start)</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1324</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;We are seeing a situation where the consumer thread&lt;br/&gt;
&quot;AsyncLoggerConfig-1&quot; is apparently dying.&lt;br/&gt;
We do see a new consumer thread trying to start up, but it is blocked&lt;br/&gt;
waiting for a lock, so no logging is happening.&lt;/p&gt;

&lt;p&gt;Is this a defect in log4j?&lt;br/&gt;
Is the original consumer thread dying due to perhaps an unhandled exception ?&lt;br/&gt;
Is that original consumer thread not terminating gracefully and&lt;br/&gt;
releasing the locked object so the new consumer thread can start?&lt;/p&gt;

&lt;p&gt;Please see attached screenshot.  Top of screen is normal&lt;br/&gt;
asyncloggerconfig thread (consumer).&lt;br/&gt;
Bottom is thread trace when logging stops, we no longer see an&lt;br/&gt;
&quot;asyncloggerconfig-1&quot; thread, instead a new thread is trying to start&lt;br/&gt;
but never does &quot;asyncloggerconfig-2&quot;.&lt;/p&gt;</description>
                <environment>&lt;p&gt;LOG4J CORE Release Version 2.2&lt;br/&gt;
Disruptor Bundle-Version 3.3.2&lt;br/&gt;
ORACLE jdk1.8.0_45&lt;br/&gt;
 Linux 2.6.32-573.el6.x86_64, amd64&lt;/p&gt;</environment>
        <key id="12952090">LOG4J2-1324</key>
            <summary>Install default error handler for Async Loggers that does not rethrow (was: Async Logger - Consumer thread dying - new thread unable to start)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="rong">Steve Yurong Su</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Mar 2016 16:44:49 +0000</created>
                <updated>Sat, 26 Mar 2016 05:07:45 +0000</updated>
                            <resolved>Sat, 26 Mar 2016 05:07:44 +0000</resolved>
                                    <version>2.2</version>
                                    <fixVersion>2.6</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15205311" author="remkop@yahoo.com" created="Mon, 21 Mar 2016 22:44:52 +0000"  >&lt;p&gt;In the Environment section, can you add details on what version of log4j and the Disruptor you are using? Also, what OS and Java vendor/version are you using?&lt;/p&gt;

&lt;p&gt;Is the problem reproducible? &lt;/p&gt;</comment>
                            <comment id="15205385" author="remkop@yahoo.com" created="Mon, 21 Mar 2016 23:48:10 +0000"  >&lt;p&gt;Can you attach your log4j config file?&lt;/p&gt;</comment>
                            <comment id="15205484" author="rong" created="Tue, 22 Mar 2016 00:53:06 +0000"  >&lt;ul&gt;
	&lt;li&gt;it looks like the batcheventprocessor is defaulting to the com.lmax.disruptorFatalExceptionHandler, as we don&apos;t have an exception handler defined otherwise.&lt;/li&gt;
	&lt;li&gt;the log4j config, as well as log4j/disruptor/jdk versions have been updated in the ticket.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;I wonder whether the new AsyncLoggerConfig-2 thread is failing to start due to the default of &quot;blocking strategy&quot; lock, rather than wait strategy.&lt;/li&gt;
	&lt;li&gt;Does the consumer hold open the file descriptor to the log file, or are there certain circumstances where the OS file descriptor to the log file itself on disk is released back to the OS and a new file descriptor is acquired?&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15205641" author="remkop@yahoo.com" created="Tue, 22 Mar 2016 02:20:06 +0000"  >&lt;p&gt;Thanks for the environment update and config. Can you also add what operating system (and version) you are on?&lt;/p&gt;

&lt;p&gt;Looking at the Thread Dump, the AsyncLoggerConfig-1 thread is not actually dead, it is waiting for a notification before it tries to take another event from the ring buffer. Previously someone reported a similar issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1221&quot; title=&quot;Dead lock observed in BlockingWaitStrategy in Log4J&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1221&quot;&gt;&lt;del&gt;LOG4J2-1221&lt;/del&gt;&lt;/a&gt;, external issue &lt;a href=&quot;https://github.com/LMAX-Exchange/disruptor/issues/138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/LMAX-Exchange/disruptor/issues/138&lt;/a&gt;) when running on Solaris. Because of this we are making com.lmax.disruptor.TimeoutBlockingWaitStrategy the default in Log4j-2.6. &lt;/p&gt;

&lt;p&gt;I&apos;m trying to think of a workaround that would help you between now and the 2.6 release, but TimeoutBlockingWaitStrategy does not have a default constructor, so it will take a bit of hacking to install it. (Specifying the fully qualified class name of this class for system property &lt;tt&gt;AsyncLoggerConfig.WaitStrategy&lt;/tt&gt; will not work.)&lt;/p&gt;

&lt;p&gt;About the AsyncLoggerConfig-2 thread, looking at the Thread Dump it is waiting for data to become available in a LinkedBlockingQueue. I don&apos;t know what this thread is. The thread name suggests it is a log4j thread, but as far as I know we don&apos;t use LinkedBlockingQueue in log4j... Did you create a ThreadPool with log4j&apos;s DaemonThreadFactory?&lt;/p&gt;</comment>
                            <comment id="15206245" author="rong" created="Tue, 22 Mar 2016 12:12:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;Looking at the Thread Dump, the AsyncLoggerConfig-1 thread is not actually dead,&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Sorry Remko I did not provide you the full thread dump, but I can assure you that in the screenshot provided you are looking at two different stack traces : pre and post &quot;crash&quot;.  What I mean by crash is that logging stops altogether.  As you can see from the heap dump the ringbuffer is full (195MB) and we have rollover configured for the log file at 200mb (however our log file on disk was only 64MB).  &lt;/p&gt;

&lt;p&gt;So in the stack trace where I am showing &quot;AsyncLoggerConfig-2&quot; thread, there is assuredly no other thread called &quot;AsyncLoggerConfig-1&quot; consumer.  So that means that when logging stops completely, we have no consumer thread.  All we see is the AsyncLoggerConfig-2 thread at that point and as you can see, that thread is not starting properly.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;About the AsyncLoggerConfig-2 thread, looking at the Thread Dump it is waiting for data to become available in a LinkedBlockingQueue. I don&apos;t know what this thread is. The thread name suggests it is a log4j thread, but as far as I know we don&apos;t use LinkedBlockingQueue in log4j... Did you create a ThreadPool with log4j&apos;s DaemonThreadFactory?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think &lt;a href=&quot;http://grepcode.com/file/repo1.maven.org/maven2/org.apache.logging.log4j/log4j-core/2.2/org/apache/logging/log4j/core/async/DaemonThreadFactory.java/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;org.apache.logging.log4j.core.async.DaemonThreadFactory&lt;/a&gt; is creating that secondary thread when the AsyncLoggerConfig-1 thread exits.  However I don&apos;t think the -1 thread is exiting cleanly, so I think that&apos;s why we see the second asyncloggerconfig - 2 thread in a weird stack, as it is unable to startup.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Previously someone reported a similar issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1221&quot; title=&quot;Dead lock observed in BlockingWaitStrategy in Log4J&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1221&quot;&gt;&lt;del&gt;LOG4J2-1221&lt;/del&gt;&lt;/a&gt;, external issue &lt;a href=&quot;https://github.com/LMAX-Exchange/disruptor/issues/138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/LMAX-Exchange/disruptor/issues/138&lt;/a&gt;)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We did look at log4j-1221 and think it is very closely related, however, in that particular issue, they did no see &quot;AsyncLoggerConfig-1&quot; disappear, nor did they report a new thread being created called &quot;AsyncLoggerConfig-2&quot;.  We&apos;ll do some more research on the thread dumps to determine if perhaps these threads are simply exiting and being recreated and functioning as designed.&lt;/p&gt;

&lt;p&gt;Do your consumer threads enter and exit very quickly?  Or do the consumer threads stay alive once instantiated?  My feeling is that the consumer threads once created shouldn&apos;t exit.  That&apos;s why I think some unhandled exception is causing them to exit.&lt;/p&gt;</comment>
                            <comment id="15206272" author="rong" created="Tue, 22 Mar 2016 12:32:39 +0000"  >&lt;p&gt;attaching image shows:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12794752/12794752_2016-03-22_8-32-37.jpg&quot; title=&quot;2016-03-22_8-32-37.jpg attached to LOG4J2-1324&quot;&gt;2016-03-22_8-32-37.jpg&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;On Left: &lt;br/&gt;
Shows default consumer thread stack trace from &lt;br/&gt;
&lt;a href=&quot;https://github.com/LMAX-Exchange/disruptor/issues/138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/LMAX-Exchange/disruptor/issues/138&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;On Right shows:&lt;br/&gt;
New thread attempting to be instantiated by daemon thread factory.&lt;/p&gt;

&lt;p&gt;We are theorizing that this means that the old thread is not exiting cleanly, releasing lock on the object, preventing the new consumer from starting cleanly (i.e. not able to enter and obtain the locked object).&lt;/p&gt;</comment>
                            <comment id="15207371" author="rong" created="Tue, 22 Mar 2016 21:44:34 +0000"  >&lt;p&gt;we dug into the heap dump and found that the original asyncloggerconfig thread had exited, but the ring buffer and other objects were still instantiated.  We have reached a preliminary conclusion that the root cause is that an exception is being raised that is aborting the consumer thread (which is why a new AsyncLoggerConfig-2 is being instantiated) however, when the default disruptor strategy is set as blocking, there&apos;s no chance for the disruptor to release it&apos;s &quot;blockingwaitstrategy&quot; lock, so the new async logger config thread is unable to start servicing the ring buffer again (or some such variation of this interaction) as we haven&apos;t quite pieced it all together yet.&lt;/p&gt;

&lt;p&gt;In log4j2-1221 the conclusion was reached that a &quot;signal was missed&quot; in solaris, however if you look at the ticket &lt;a href=&quot;https://github.com/LMAX-Exchange/disruptor/issues/138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/LMAX-Exchange/disruptor/issues/138&lt;/a&gt; you will notice that others have reproduced with linux, and that the maintainer has not been able to reproduce it with the disruptor in isolation.&lt;/p&gt;

&lt;p&gt;I believe the core issue is release of the lock when the thread aborts in the blocking wait strategy, but this might be something needing to be handled in log4j instead of in the disruptor.&lt;/p&gt;</comment>
                            <comment id="15207479" author="remkop@yahoo.com" created="Tue, 22 Mar 2016 22:57:43 +0000"  >&lt;p&gt;If it is possible to work around this in log4j, we will. I&apos;m still trying to understand what is happening. &lt;/p&gt;

&lt;p&gt;I understand now that the  AsyncLoggerConfig-2 thread is waiting for a task to be submitted to the ThreadPoolExecutor (that&apos;s the LinkedBlockingQueue in the stack dump).&lt;/p&gt;

&lt;p&gt;I don&apos;t think the AsyncLoggerConfig-1 thread died while holding on to a lock (not sure if that&apos;s even possible), but I suspect the Disruptor is not designed to let another thread take over when the original consumer thread dies. The consumer thread is not supposed to die. &lt;/p&gt;

&lt;p&gt;Your analysis showed that the FatalExceptionHandler is installed, but this did not prevent the thread from dying. I don&apos;t understand why the thread can still die with this ExceptionHandler installed: this handler handles Throwables...&lt;/p&gt;

&lt;p&gt;Was the log message from that handler captured anywhere?&lt;/p&gt;</comment>
                            <comment id="15207482" author="remkop@yahoo.com" created="Tue, 22 Mar 2016 23:01:13 +0000"  >&lt;p&gt;I think this is a very different issue from &lt;a href=&quot;https://github.com/LMAX-Exchange/disruptor/issues/138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/LMAX-Exchange/disruptor/issues/138&lt;/a&gt;, if you want to raise it on the Disruptor issue tracker you might want to raise a separate ticket. &lt;/p&gt;</comment>
                            <comment id="15208014" author="mikeb01" created="Wed, 23 Mar 2016 07:38:46 +0000"  >&lt;p&gt;If you are using the FatalExceptionHandler then the BatchEventProcessor thread will exit if an exception is encountered.  This is because it rethrows the exception.  If you want to continue process messages, then you should have an ExceptionHandler that swallows the exception.  See the IgnoreExceptionHandler as an example.  Or trap the exception within your EventHandler.&lt;/p&gt;

&lt;p&gt;The simple workaround for this problem is to switch to the SleepingWaitStrategy.  This is a little bit more energy consuming than the blocking one, but is poll based so won&apos;t miss the wake-ups.&lt;/p&gt;</comment>
                            <comment id="15208031" author="remkop@yahoo.com" created="Wed, 23 Mar 2016 08:08:04 +0000"  >&lt;p&gt;Oh darn, I did not realize that FatalExceptionHandler rethrows the exception... Hm, perhaps we should install IgnoreExceptionHandler as the default instead in Log4j.&lt;/p&gt;

&lt;p&gt;If my understanding is correct using SleepingWaitStrategy would not solve this issue since the problem is not that wake-ups are missed, but instead that an uncaught (well, caught and rethrown) exception killed the consumer thread.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=RonG&quot; class=&quot;user-hover&quot; rel=&quot;rong&quot;&gt;RonG&lt;/a&gt; You can work around this issue by installing the IgnoreExceptionHandler: set system property &lt;tt&gt;AsyncLoggerConfig.ExceptionHandler&lt;/tt&gt; to value &lt;tt&gt;com.lmax.disruptor.IgnoreExceptionHandler&lt;/tt&gt;. Any exception will then be caught and logged to the java.util.Logger framework at INFO level. I would be interested to know what exception that was: perhaps this is something that needs to be handled in the appender...&lt;/p&gt;</comment>
                            <comment id="15208047" author="mikeb01" created="Wed, 23 Mar 2016 08:18:43 +0000"  >&lt;p&gt;I would suggest writing your own.  The IgnoreExceptionHandler tries to log to the JDK logger.  You&apos;ll probably want to do something different, like fall back to stdout/stderr.&lt;/p&gt;</comment>
                            <comment id="15208086" author="remkop@yahoo.com" created="Wed, 23 Mar 2016 08:53:58 +0000"  >&lt;p&gt;Makes sense. Thanks for looking at this.&lt;/p&gt;</comment>
                            <comment id="15212805" author="remkop@yahoo.com" created="Sat, 26 Mar 2016 05:07:44 +0000"  >&lt;p&gt;Fixed in master.&lt;/p&gt;

&lt;p&gt;I added a new default exception handler for Async Loggers and AsyncLoggerConfig. This handler prints a message and stack trace to the standard error stream and does not rethrow the exception.&lt;/p&gt;

&lt;p&gt;Please verify and close. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12794536" name="2016-03-18_17-44-06.jpg" size="304609" author="rong" created="Mon, 21 Mar 2016 16:45:08 +0000"/>
                            <attachment id="12794752" name="2016-03-22_8-32-37.jpg" size="96420" author="rong" created="Tue, 22 Mar 2016 12:32:39 +0000"/>
                            <attachment id="12794656" name="BatchEventProcessor.png" size="64674" author="rong" created="Tue, 22 Mar 2016 00:53:58 +0000"/>
                            <attachment id="12794652" name="log4j2_config.xml" size="14769" author="rong" created="Tue, 22 Mar 2016 00:50:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 34 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2uysv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>