<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:43:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-3680] Some log events are no longer serialized correctly</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-3680</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;We noticed a regression between 2.21.1 and 2.22.0 in the serilialization of log events. The below test succeeds with 2.21.1, but fails with 2.22.0. I had a look at the source code, and I think it&apos;s because of changes in the &lt;tt&gt;ObjectMessage.read/writeObject&lt;/tt&gt; implementation.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; org.apache.logging.log4j.LogManager.getLogger;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; org.junit.jupiter.api.Assertions.assertEquals;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.ByteArrayInputStream;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.ByteArrayOutputStream;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.IOException;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.ObjectInputStream;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.ObjectOutputStream;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.Serializable;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.ArrayList;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.List;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.logging.log4j.core.Appender;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.logging.log4j.core.ErrorHandler;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.logging.log4j.core.Layout;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.logging.log4j.core.LogEvent;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.logging.log4j.core.Logger;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.jupiter.api.AfterEach;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.jupiter.api.BeforeEach;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.jupiter.api.Test;

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Log4jSerializationTest {

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Logger logger = (Logger) getLogger(Log4jSerializationTest.class);

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; RecordingAppender appender = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RecordingAppender(Log4jSerializationTest.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName());

    @BeforeEach
    void addRecordingAppender() {
        appender.start();
        logger.addAppender(appender);
    }

   @AfterEach
    void removeRecordingAppender() {
        logger.removeAppender(appender);
        appender.stop();
    }

    @Test
    void logEventSerialization() {
        RuntimeException exception = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;induced by test&quot;&lt;/span&gt;);
        logger.error(exception, exception);
        LogEvent event = appender.getEvents().get(0);
        assertEquals(RuntimeException.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;: induced by test&quot;&lt;/span&gt;, event.getMessage().getFormattedMessage());
    }

    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;RecordingAppender &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Appender {

        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;LogEvent&amp;gt; events = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList();
        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; State state = State.STOPPED;
        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name;
        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ErrorHandler handler;

        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; RecordingAppender(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name) {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.name = name;
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; State getState() {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; state;
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void initialize() {
            state = State.INITIALIZED;
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isStarted() {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; state == State.STARTED;
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isStopped() {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; !isStarted();
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void start() {
            events.clear();
            state = State.STARTED;
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void stop() {
            events.clear();
            state = State.STOPPED;
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void append(LogEvent event) {
            &lt;span class=&quot;code-comment&quot;&gt;// The event is a mutable one, Log4j2 emits the same event instance but changes the message each time.
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// If we want to hold on to the event details, we need to clone the event.
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// LogEvent is not an instance of &lt;span class=&quot;code-object&quot;&gt;Cloneable&lt;/span&gt;, but it IS an instance of Serializable.
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// So we clone by serializing and deserializing.
&lt;/span&gt;            ByteArrayOutputStream out = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayOutputStream();
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (ObjectOutputStream objectOut = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ObjectOutputStream(out)) {
                objectOut.writeObject(event);
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(e);
            }
            LogEvent clone;
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (ObjectInputStream objectInput = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ObjectInputStream(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayInputStream(out.toByteArray()))) {
                clone = (LogEvent) objectInput.readObject();
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException | ClassNotFoundException e) {
                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(e);
            }
            events.add(clone);
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; ErrorHandler getHandler() {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; handler;
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Layout&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Serializable&amp;gt; getLayout() {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; getName() {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; name;
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; ignoreExceptions() {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        }

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setHandler(ErrorHandler handler) {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.handler = handler;
        }

        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; List&amp;lt;LogEvent&amp;gt; getEvents() {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; events;
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13567017">LOG4J2-3680</key>
            <summary>Some log events are no longer serialized correctly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pkarwasz">Piotr Karwasz</assignee>
                                    <reporter username="peterdm">Peter De Maeyer</reporter>
                        <labels>
                    </labels>
                <created>Thu, 1 Feb 2024 10:11:15 +0000</created>
                <updated>Thu, 8 Feb 2024 14:49:21 +0000</updated>
                            <resolved>Tue, 6 Feb 2024 06:20:22 +0000</resolved>
                                    <version>2.22.0</version>
                                    <fixVersion>2.23.0</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="17813612" author="pkarwasz" created="Fri, 2 Feb 2024 10:42:33 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=peterdm&quot; class=&quot;user-hover&quot; rel=&quot;peterdm&quot;&gt;peterdm&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;The problem is due to the hardening of the deserialization of Log4j classes in version 2.22.0 (cf. &lt;a href=&quot;http://example.com&quot; title=&quot;https://github.com/apache/logging-log4j2/pull/1906&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;apache/logging-log4j2#1906&lt;/a&gt;). Only a limited number of classes can be deserialized (e.g. those in &lt;tt&gt;java.lang&lt;/tt&gt;), but the filter does not work correctly with arrays (e.g. it denies &lt;tt&gt;java.lang.StackTraceElement[]&lt;/tt&gt;). We&apos;ll fix this in the next release.&lt;/p&gt;</comment>
                            <comment id="17813670" author="pkarwasz" created="Fri, 2 Feb 2024 13:25:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/2259&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR#2259&lt;/a&gt; should fix your problem.&lt;/p&gt;

&lt;p&gt;On a side note, IMHO logging an exception as *&lt;b&gt;message&lt;/b&gt;* is not a very good practice. I would rather use &lt;tt&gt;exception.getMessage()&lt;/tt&gt; explicitly.&lt;/p&gt;</comment>
                            <comment id="17813825" author="peterdm" created="Fri, 2 Feb 2024 20:50:48 +0000"  >&lt;blockquote&gt;
&lt;p&gt;On a side note, IMHO logging an exception as &lt;b&gt;message&lt;/b&gt; is not a very good practice. I would rather use &lt;tt&gt;exception.getMessage()&lt;/tt&gt; explicitly.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I fully agree. Please realize the example comes from a legacy codebase that has plenty of such occurrences, none of which I&apos;m the author of. I just have to deal with it here and now.&lt;/p&gt;</comment>
                            <comment id="17814626" author="pkarwasz" created="Tue, 6 Feb 2024 06:20:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=peterdm&quot; class=&quot;user-hover&quot; rel=&quot;peterdm&quot;&gt;peterdm&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Can you check if the newest snapshot in the Maven repo &lt;tt&gt;&lt;a href=&quot;https://repository.apache.org/snapshots&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/snapshots&lt;/a&gt;&lt;/tt&gt; fixes your problem?&lt;/p&gt;

&lt;p&gt;If it does, please close the issue.&lt;/p&gt;</comment>
                            <comment id="17815708" author="peterdm" created="Thu, 8 Feb 2024 14:49:17 +0000"  >&lt;p&gt;I confirm that the latest snapshot fixes it.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 39 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1n5dk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>