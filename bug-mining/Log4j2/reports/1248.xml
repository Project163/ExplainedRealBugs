<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:40:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-2478] JMH Benchmarks in not consuming all computed variables (risk of DCE)</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-2478</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;We are conducting a scientific study to investigate bad practices/anti-patterns on creating micro-benchmarks using JMH, and we found an instance of harmfull non-consumed computation in `AbstractStringLayoutStringEncodingBenchmark`.&lt;/p&gt;

&lt;p&gt;As a good practice, every computation performed in inside the benchmark should be consumed (see&#160;[JMH Documentation|&lt;a href=&quot;http://hg.openjdk.java.net/code-tools/jmh/file/66fb723292d4/jmh-samples/src/main/java/org/openjdk/jmh/samples/JMHSample_08_DeadCode.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hg.openjdk.java.net/code-tools/jmh/file/66fb723292d4/jmh-samples/src/main/java/org/openjdk/jmh/samples/JMHSample_08_DeadCode.java&lt;/a&gt;.]&#160;&lt;/p&gt;

&lt;p&gt;This is partially done here with the self-made consume method, but on some benchmarks (such as baseline, usAsciiGetBytes) the return is not consumed in the benchmark, which opens the possibility of a Dead-Code Elimination to be performed by JVM.&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;There is a very simple solution:&lt;/b&gt; just return the long primitive calculated by &lt;em&gt;consume()&lt;/em&gt; at the end of&#160;each benchmark. This is done on other benchmarks of the project as well.&lt;/p&gt;

&lt;p&gt;In our tests, benchmarks were lightly affected (see attachment), with Throughputs 5-35% lower after&#160;our fix patch.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;I am reporting the result of 5 full executions with default parameters (iterations, forks, warmups, etc..)&lt;/p&gt;

&lt;p&gt;Tests run on a Computational server with CPU: E5-1660-3.3GHZ (6 cores + HT), 64 GB RAM.&lt;/p&gt;</environment>
        <key id="13191557">LOG4J2-2478</key>
            <summary>JMH Benchmarks in not consuming all computed variables (risk of DCE)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="DiegoEliasCosta">Diego Elias Damasceno Costa</reporter>
                        <labels>
                    </labels>
                <created>Mon, 15 Oct 2018 11:20:20 +0000</created>
                <updated>Wed, 17 Oct 2018 00:08:46 +0000</updated>
                            <resolved>Tue, 16 Oct 2018 23:58:44 +0000</resolved>
                                                                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16650092" author="githubbot" created="Mon, 15 Oct 2018 11:28:26 +0000"  >&lt;p&gt;GitHub user DiegoEliasCosta opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/219&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/219&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2478&quot; title=&quot;JMH Benchmarks in not consuming all computed variables (risk of DCE)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2478&quot;&gt;&lt;del&gt;LOG4J2-2478&lt;/del&gt;&lt;/a&gt; Return the computed variables on each benchmark to avoid DCE&lt;/p&gt;

&lt;p&gt;    As mentioned in &lt;span class=&quot;error&quot;&gt;&amp;#91;JIRA&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2478&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/LOG4J2-2478&lt;/a&gt;), this patch simply returns the computation on every benchmark that uses the static &lt;em&gt;consume&lt;/em&gt; method. We do that to prevent dead-code elimination, which is only partially addressed in the current implementation.&lt;/p&gt;

&lt;p&gt;    Another patch that could simplify the benchmark code, and get considerably faster throughputs, would be to simply rely on &lt;em&gt;Blackhole.consume&lt;/em&gt; methods to sink the computation. We then, would not need the &lt;em&gt;consume&lt;/em&gt; method we have in the class.&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/DiegoEliasCosta/logging-log4j2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/DiegoEliasCosta/logging-log4j2&lt;/a&gt; jmh-antipatterns-ignoredreturn&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/219.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/219.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #219&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 59a41bb5dbe2f5edba9c4b7eb68f309ad7f637ce&lt;br/&gt;
Author: DiegoEliasCosta &amp;lt;diegoelias1@...&amp;gt;&lt;br/&gt;
Date:   2018-10-15T11:21:30Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2478&quot; title=&quot;JMH Benchmarks in not consuming all computed variables (risk of DCE)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2478&quot;&gt;&lt;del&gt;LOG4J2-2478&lt;/del&gt;&lt;/a&gt; Return the computed variables on each benchmark to avoid DCE&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16652532" author="githubbot" created="Tue, 16 Oct 2018 22:09:11 +0000"  >&lt;p&gt;Github user remkop commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/219&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/219&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    These are all good changes and we should merge this PR.&lt;br/&gt;
    Not sure when I can do it but perhaps someone else gets there first.&lt;/p&gt;</comment>
                            <comment id="16652603" author="githubbot" created="Tue, 16 Oct 2018 22:57:32 +0000"  >&lt;p&gt;Github user cakofony commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/219&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/219&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I can take care of this &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16652667" author="jira-bot" created="Tue, 16 Oct 2018 23:43:27 +0000"  >&lt;p&gt;Commit 2f224d3aa73324a8927fd4304a3cdeb73448b37c in logging-log4j2&apos;s branch refs/heads/master from DiegoEliasCosta&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=2f224d3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=2f224d3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2478&quot; title=&quot;JMH Benchmarks in not consuming all computed variables (risk of DCE)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2478&quot;&gt;&lt;del&gt;LOG4J2-2478&lt;/del&gt;&lt;/a&gt; Return the computed variables on each benchmark to avoid DCE&lt;/p&gt;</comment>
                            <comment id="16652668" author="jira-bot" created="Tue, 16 Oct 2018 23:43:29 +0000"  >&lt;p&gt;Commit de8b8fbf4687d6fb7e6fba46d69825ced7b862e5 in logging-log4j2&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckozak&quot; class=&quot;user-hover&quot; rel=&quot;ckozak&quot;&gt;ckozak&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=de8b8fb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=de8b8fb&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Changelog for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2478&quot; title=&quot;JMH Benchmarks in not consuming all computed variables (risk of DCE)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2478&quot;&gt;&lt;del&gt;LOG4J2-2478&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16652671" author="jira-bot" created="Tue, 16 Oct 2018 23:45:30 +0000"  >&lt;p&gt;Commit 869925c609b5700fba15b8291ddcdfba748cd7c2 in logging-log4j2&apos;s branch refs/heads/release-2.x from DiegoEliasCosta&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=869925c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=869925c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2478&quot; title=&quot;JMH Benchmarks in not consuming all computed variables (risk of DCE)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2478&quot;&gt;&lt;del&gt;LOG4J2-2478&lt;/del&gt;&lt;/a&gt; Return the computed variables on each benchmark to avoid DCE&lt;/p&gt;</comment>
                            <comment id="16652672" author="jira-bot" created="Tue, 16 Oct 2018 23:45:31 +0000"  >&lt;p&gt;Commit c886016594b2424b787521925c76df85801a0d41 in logging-log4j2&apos;s branch refs/heads/release-2.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckozak&quot; class=&quot;user-hover&quot; rel=&quot;ckozak&quot;&gt;ckozak&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=c886016&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=c886016&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Changelog for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2478&quot; title=&quot;JMH Benchmarks in not consuming all computed variables (risk of DCE)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2478&quot;&gt;&lt;del&gt;LOG4J2-2478&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This closes #219&lt;/p&gt;</comment>
                            <comment id="16652675" author="remkop@yahoo.com" created="Tue, 16 Oct 2018 23:47:02 +0000"  >&lt;p&gt;Thank you Carter!&lt;/p&gt;</comment>
                            <comment id="16652679" author="ckozak" created="Tue, 16 Oct 2018 23:48:17 +0000"  >&lt;p&gt;Merged to master and release-2.x, Thank you for your contribution &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=DiegoEliasCosta&quot; class=&quot;user-hover&quot; rel=&quot;DiegoEliasCosta&quot;&gt;DiegoEliasCosta&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="16652694" author="jira-bot" created="Wed, 17 Oct 2018 00:08:30 +0000"  >&lt;p&gt;Commit 81f982555961da1e08dd47e0e377e3858f949949 in logging-log4j2&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckozak&quot; class=&quot;user-hover&quot; rel=&quot;ckozak&quot;&gt;ckozak&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=81f9825&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=81f9825&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Changelog for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2478&quot; title=&quot;JMH Benchmarks in not consuming all computed variables (risk of DCE)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2478&quot;&gt;&lt;del&gt;LOG4J2-2478&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This closes #219&lt;/p&gt;</comment>
                            <comment id="16652709" author="githubbot" created="Wed, 17 Oct 2018 00:08:46 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/219&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/219&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12943929" name="logginglog4j2-jmhantipatterns-retu.csv" size="1082" author="DiegoEliasCosta" created="Mon, 15 Oct 2018 11:19:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3z6xz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>