<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:32:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-702] LoggerConfig#waitForCompletion is not thread safe</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-702</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;This is in trunk, svn commit 1608156&lt;/p&gt;

&lt;p&gt;LoggerConfig#waitForCompletion uses an AtomicInteger counter to try to detect if there are any calls currently executing the log(Event) method, but it does not do so in a thread safe manner.  Consider two threads A and B, where Thread A is calling clearAppenders(), and Thread B is calling log(Event),&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; A  loggerConfig.clearAppenders()
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; A  loggerConfig.waitForCompletion()
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; A  counter.get() &lt;span class=&quot;code-comment&quot;&gt;//returns 0
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; A  &lt;span class=&quot;code-comment&quot;&gt;//loggerConfig.waitForCompletion() returns
&lt;/span&gt;
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; B  loggerConfig.log(Event)
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; B  counter.increment()

&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; A  proceeds assuming no log calls are onging, but thread B is in the log method

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m not sure what the requirements are, but if the requirement is to not lose logging events, I think you need some sort of synchronization outside of the LoggerConfig object.  &lt;/p&gt;</description>
                <environment></environment>
        <key id="12725663">LOG4J2-702</key>
            <summary>LoggerConfig#waitForCompletion is not thread safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="sbridges">Sean Bridges</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Jul 2014 04:31:28 +0000</created>
                <updated>Tue, 13 Oct 2015 04:35:15 +0000</updated>
                            <resolved>Tue, 13 Oct 2015 04:35:15 +0000</resolved>
                                    <version>2.0-rc2</version>
                                    <fixVersion>2.4</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14053370" author="jvz" created="Mon, 7 Jul 2014 05:57:59 +0000"  >&lt;p&gt;Oh man, good catch on a neat threading issue! Taking a look at what&apos;s going on here, I think a slightly more complex locking mechanism will be needed for the counter. Before this change, the whole method &lt;tt&gt;waitForCompletion&lt;/tt&gt; was synchronized. It seems like this could be doable.&lt;/p&gt;</comment>
                            <comment id="14053378" author="jvz" created="Mon, 7 Jul 2014 06:32:09 +0000"  >&lt;p&gt;Fixed in revision 1608344. Please verify and close.&lt;/p&gt;</comment>
                            <comment id="14053379" author="ralph.goers@dslextreme.com" created="Mon, 7 Jul 2014 06:33:12 +0000"  >&lt;p&gt;First, I have to assume the problem description is incorrect and that all references to LoggerContext should be LoggerConfig?&lt;/p&gt;

&lt;p&gt;Second, the clearAppenders method is called by stop (and really shouldn&apos;t be called by anything else).  The stop method should only be called after updateLoggers has been called to transfer logging to a new configuration, in which case calls to all log events would go there, not to the configuration being stopped, or during a shutdown, at which point logging shouldn&apos;t be happening.&lt;/p&gt;

&lt;p&gt;Do you have a stack trace that shows an actual problem or is this a hypothetical exercise?&lt;/p&gt;</comment>
                            <comment id="14053381" author="jvz" created="Mon, 7 Jul 2014 06:38:48 +0000"  >&lt;p&gt;I think it&apos;s a hypothetical actually. The clearAppenders method is protected and is only called by AbstractConfiguration.stop(). This follows a chain of stop() methods as well, so this might actually be a non-issue.&lt;/p&gt;</comment>
                            <comment id="14053383" author="ralph.goers@dslextreme.com" created="Mon, 7 Jul 2014 06:46:39 +0000"  >&lt;p&gt;Yes, and I have a fear that moving the lock as you did might cause a deadlock, although the ReconfigurationDeadlockTest which was added for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-620&quot; title=&quot;Deadlock on reconfiguration with Appenders that use log4j&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-620&quot;&gt;&lt;del&gt;LOG4J2-620&lt;/del&gt;&lt;/a&gt; still passes.&lt;/p&gt;</comment>
                            <comment id="14053385" author="ralph.goers@dslextreme.com" created="Mon, 7 Jul 2014 06:48:19 +0000"  >&lt;p&gt;I changed all mentions of LoggerContext to LoggerConfig&lt;/p&gt;</comment>
                            <comment id="14053387" author="ralph.goers@dslextreme.com" created="Mon, 7 Jul 2014 06:51:49 +0000"  >&lt;p&gt;This would have been a good choice to ask a question on the dev list before immediately making a change. &lt;/p&gt;</comment>
                            <comment id="14053727" author="jvz" created="Mon, 7 Jul 2014 15:02:17 +0000"  >&lt;p&gt;I&apos;m going to revert this change and defer any additional changes until we decide a change is actually necessary. The idea behind this change was to make sure anything attempting to wait for completion has to wait to get a lock before it can even check the shutdown status. I don&apos;t think it&apos;s necessary based on current usage as long as we make a note in the javadocs to clarify as such.&lt;/p&gt;</comment>
                            <comment id="14053946" author="sbridges" created="Mon, 7 Jul 2014 18:07:43 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Second, the clearAppenders method is called by stop (and really shouldn&apos;t be called by anything else). The stop method should only be called after updateLoggers has been called to transfer logging to a new configuration, in which case calls to all log events would go there, not to the configuration being stopped, or during a shutdown, at which point logging shouldn&apos;t be happening.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think there is still the same problem just pushed up the stack a bit, as you can have two threads doing something like,&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; B acquire reference to current loggerConfig

&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; A updateLoggers()
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; A stop()
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; A  loggerConfig.clearAppenders()
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; A  loggerConfig.waitForCompletion()
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; A  counter.get() &lt;span class=&quot;code-comment&quot;&gt;//returns 0
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; A  &lt;span class=&quot;code-comment&quot;&gt;//loggerConfig.waitForCompletion() returns
&lt;/span&gt;
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; B  loggerConfig.log(Event)
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; B  counter.increment()

&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; A  proceeds assuming no log calls are onging, but thread B is in the log method
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14053964" author="sbridges" created="Mon, 7 Jul 2014 18:22:21 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Do you have an actual stack trace that demonstrates the problem?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I haven&apos;t experienced this problem.  I was just curious if log4j2 was able to log without doing any locking like log4j does, and saw this code isn&apos;t thread safe.  &lt;/p&gt;</comment>
                            <comment id="14053989" author="ralph.goers@dslextreme.com" created="Mon, 7 Jul 2014 18:37:47 +0000"  >&lt;p&gt;I will look at this. I would expect the odds that it will ever happen are low but I guess it could happen, especially if you only have a root logger.&lt;/p&gt;</comment>
                            <comment id="14054012" author="sbridges" created="Mon, 7 Jul 2014 18:49:16 +0000"  >&lt;p&gt;I think the bookeeping needs to be done outside the LoggerConfig class.&lt;/p&gt;

&lt;p&gt;Say you used loggerConfig something like,&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LoggerConfig {
   /**
    * returns &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the reference count was incremented
   */
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; addRef()...
  
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void decRef() ...
}

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SomeClassUsingLoggerConfig {
    &lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt; LoggerConfig loggerConfig;

    
   ...
  &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
     LoggerConfig local  = loggerConfig;
     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(local.addRef()) {
       &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-comment&quot;&gt;//use local 
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
       } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            local.decRef();
       } 
    }
    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
         &lt;span class=&quot;code-comment&quot;&gt;//sleep? some sort of exponential backoff
&lt;/span&gt;    }

  }
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="14058141" author="remkop@yahoo.com" created="Fri, 11 Jul 2014 00:05:37 +0000"  >&lt;p&gt;I think I agree with Sean&apos;s analysis. There is a small window of opportunity between thread A obtaining a reference to the LoggerConfig and the counter being incremented.&lt;/p&gt;

&lt;p&gt;To flip this around, if the counter was incremented before the reference was obtained, that would close the window. &lt;/p&gt;

&lt;p&gt;When thinking about how to address this, I arrived at something close to Sean&apos;s suggestion to have &lt;tt&gt;incRef()&lt;/tt&gt; and &lt;tt&gt;decRef()&lt;/tt&gt; methods on LoggerConfig.&lt;/p&gt;

&lt;p&gt;How about&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// Logger
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void logMessage(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; fqcn, Level level, Marker marker, Message message, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Throwable t) {
    config.log(getName(), fqcn, marker, level, msg, t); &lt;span class=&quot;code-comment&quot;&gt;// delegate all the work to PrivateConfig
&lt;/span&gt;}

&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;PrivateConfig {
    ....
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void logEvent(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; LogEvent event) {
        loggerConfig.incRef();
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            config.getConfigurationMonitor().checkConfiguration();
            loggerConfig.log(event);
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            loggerConfig.decRef();
        }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; log(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; fqcn, Marker marker, Level level, Message msg, Throwable t)
        loggerConfig.incRef();
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            config.getConfigurationMonitor().checkConfiguration();
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Message message = msg == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleMessage(Strings.EMPTY) : msg;
            loggerConfig.log(name, fqcn, marker, level, message, t);
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            loggerConfig.decRef();
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m not sure about Sean&apos;s suggestion to make the &lt;tt&gt;incRef()&lt;/tt&gt; method return a boolean and loop in the log() method until LoggerConfig.incRef() returns true. With our current design, the LoggerConfig itself has been replaced and once it has been shut down it will not become usable again. So once incRef() returned false it will not return true after that.&lt;/p&gt;

&lt;p&gt;However, isn&apos;t that problem already solved by the Logger.PrivateConfig being replaced with a fresh instance (containing a different LoggerConfig) when a reconfiguration occurs?&lt;/p&gt;</comment>
                            <comment id="14059646" author="sbridges" created="Sat, 12 Jul 2014 04:56:45 +0000"  >&lt;p&gt;I don&apos;t think your example code works, I added some comments below,&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void logEvent(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; LogEvent event) {
        loggerConfig.incRef();  
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            config.getConfigurationMonitor().checkConfiguration();
            &lt;span class=&quot;code-comment&quot;&gt;//loggerConfig here may not be == to the loggerConfig you called incRef() on
&lt;/span&gt;            loggerConfig.log(event);
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            &lt;span class=&quot;code-comment&quot;&gt;//loggerConfig here may not be == to the loggerConfig you called incRef() on
&lt;/span&gt;            loggerConfig.decRef();
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This also doesn&apos;t work,&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;LoggerConfig origConfig = loggerConfig;
origConfig.incRef();
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    &lt;span class=&quot;code-comment&quot;&gt;//use origConfig
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;//however &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is the same as the original problem
&lt;/span&gt;} &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
   origConfig.decRef();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14059654" author="remkop@yahoo.com" created="Sat, 12 Jul 2014 05:17:20 +0000"  >&lt;p&gt;Sean, I believe your analysis is incorrect. The call to &lt;tt&gt;config.getConfigurationMonitor().checkConfiguration();&lt;/tt&gt; may cause the Logger&apos;s PrivateConfig to be replaced by a fresh one, that is true. This fresh privateConfig willl contain a new LoggerConfig. The Logger will no longer have a reference to the old PrivateConfig and going forward, invocations of the &lt;tt&gt;Logger.logMessage()&lt;/tt&gt; method will be delegated to the new PrivateConfig object.&lt;/p&gt;

&lt;p&gt;However, the code is currently executing in the old PrivateConfig instance and will now execute the next statement (&lt;tt&gt;loggerConfig.log(event);&lt;/tt&gt;) on the old PrivateConfig object, which still has a reference to the old LoggerConfig.&lt;/p&gt;</comment>
                            <comment id="14059884" author="ralph.goers@dslextreme.com" created="Sat, 12 Jul 2014 19:11:00 +0000"  >&lt;p&gt;While I agree with you Remko, the problem really is that once you have a reference to the PrivateConfig you might still be incrementing the counter after waitForCompletion has determined the counter is at zero. What I am struggling with is how you can make &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;config.loggerConfig.log(getName(), fqcn, marker, level, msg, t);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in the logMessage method signal its intention to log just by accessing the config variable. &lt;/p&gt;</comment>
                            <comment id="14059927" author="ralph.goers@dslextreme.com" created="Sat, 12 Jul 2014 21:23:15 +0000"  >&lt;p&gt;Here is what I am thinking.&lt;br/&gt;
1. I really don&apos;t know why logEvent is part of PrivateConfig. It should be moved to the Logger class itself.&lt;br/&gt;
2. Revert the changes Matt made.&lt;br/&gt;
3 Change LoggerConfig.log(LogEvent event) return a boolean and to check the Configuration lifecycle state for &quot;stopping&quot; after incrementing the counter. Since we know stop() is only called after updateLoggers is called we can just return false if that is the case.&lt;br/&gt;
3. Change LoggerConfig.log(params) to return the LogEvent if the log method returns false, otherwise return null.&lt;br/&gt;
4. Change Logger.logMessage to do:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;LogEvent event = config.loggerConfig.log(getName(), fqcn, marker, level, msg, t);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (event != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!config.loggerConfig.log(event))
  {
     &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; we loop here or &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; an exception? Reconfiguration shouldn&apos;t happen 2 times in a row &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; fast.
&lt;/span&gt;  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;5. Change Logger.logEvent to do:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!config.loggerConfig.log(event))
  {
     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!config.loggerConfig.log(event))
     {    
        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; we loop here or &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; an exception? Reconfiguration shouldn&apos;t happen 2 times in a row &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; fast.
&lt;/span&gt;     }    
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The only other way I can think of to do this is the use a ReadLock when accessing the PrivateConfig to log and a WriteLock in updateConfiguration, but I really don&apos;t want to do that.&lt;/p&gt;</comment>
                            <comment id="14059942" author="remkop@yahoo.com" created="Sat, 12 Jul 2014 22:23:47 +0000"  >&lt;p&gt;I created the PrivateLogger.logEvent() method (a long time ago). It is called by AsyncLogger (from the background thread).&lt;/p&gt;</comment>
                            <comment id="14059945" author="ralph.goers@dslextreme.com" created="Sat, 12 Jul 2014 22:29:38 +0000"  >&lt;p&gt;Actually, I think I created it. It is also called by LogEventListener.  However, I see no reason it shouldn&apos;t be part of the core Logger class instead of PrivateConfig.&lt;/p&gt;</comment>
                            <comment id="14059958" author="remkop@yahoo.com" created="Sat, 12 Jul 2014 23:53:32 +0000"  >&lt;p&gt;Ah, yes, I only increased its visibility, that&apos;s right. No objection to moving this method, btw.&lt;/p&gt;

&lt;p&gt;I&apos;m looking at the retry design. So far I haven&apos;t found any fault with it. I&apos;ll keep looking.&lt;/p&gt;

&lt;p&gt;One thing: instead of retrying once (with an if), the standard idiom with lock-free designs like this seems to be a while loop that continues until it succeeds. We could have some max-attempts circuit breaker, but (as you pointed out) then what do we do with the event that we haven&apos;t been able to log? Log it to some error appender? Throwing an exception would disrupt the application which seems undesirable.&lt;/p&gt;</comment>
                            <comment id="14059962" author="ralph.goers@dslextreme.com" created="Sun, 13 Jul 2014 00:01:14 +0000"  >&lt;p&gt;Yes, it would be undesirable.  But the only time the retry should fail is if the PrivateConfig is attached to a Configuration that is once again marked as stopping. I would at least put a sleep for 10 milliseconds in the loop but I think looping for a fixed number of times and then throwing an exception would be fine as that would imply something bizarre is going on, as every iteration through the loop should be getting a new PrivateLogger since the one in use has a Configuration that is stopping.&lt;/p&gt;</comment>
                            <comment id="14059991" author="sbridges" created="Sun, 13 Jul 2014 04:55:30 +0000"  >&lt;p&gt;Remko, I think your solution works.&lt;/p&gt;</comment>
                            <comment id="14060004" author="ralph.goers@dslextreme.com" created="Sun, 13 Jul 2014 05:41:02 +0000"  >&lt;p&gt;Did you really mean Remko&apos;s solution or what I proposed?  I don&apos;t think Remko&apos;s solution will work as the same scenario you outlined above can still occur after the code obtains the reference to the PrivateConfig but before logEvent increments the counter.&lt;/p&gt;</comment>
                            <comment id="14060297" author="sbridges" created="Mon, 14 Jul 2014 03:53:05 +0000"  >&lt;p&gt;Sorry, I commented without seeing some of the posts.&lt;/p&gt;

&lt;p&gt;Ralph, yes you are right, Remko&apos;s solution in his 10/Jul/14 17:05 comment suffers from the flaw you mention.  I think it is better to loop rather than hardcode a fixed number of iterations.  Another alternative to looping might be to chain the configs.  Something like,&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;//in PrivateConfig
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt; LoggerConfig next;

void log(...) {
   counter.incrementAndGet();
   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(next != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      counter.decrementAndGet();
      next.log(...); 
   } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
         ...&lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; stuff
      } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        counter.decrementAndGet();
      }
   }

void stop(LoggerConfig next) {
  &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.next = next;
  ...cleanup
}


}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14146134" author="remkop@yahoo.com" created="Wed, 24 Sep 2014 09:43:09 +0000"  >&lt;p&gt;The Fix Version for this issue was 2.1.  Ralph (I&apos;m assuming you want to take care of this issue), of course it would be great if you want to address this in the next few days, but I&apos;m tentatively changing the Fix Version to 2.2 to give us some more time.&lt;/p&gt;</comment>
                            <comment id="14954367" author="ralph.goers@dslextreme.com" created="Tue, 13 Oct 2015 04:34:39 +0000"  >&lt;p&gt;This was almost certainly fixed by &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1121&quot; title=&quot;LoggerConfig performance improvement: remove waitForCompletion and associated fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1121&quot;&gt;&lt;del&gt;LOG4J2-1121&lt;/del&gt;&lt;/a&gt; which was part of the 2.4 release.&lt;/p&gt;</comment>
                            <comment id="14954369" author="ralph.goers@dslextreme.com" created="Tue, 13 Oct 2015 04:35:15 +0000"  >&lt;p&gt;Please verify and close.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12863690">LOG4J2-1121</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>403821</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 6 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xi1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>403864</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>