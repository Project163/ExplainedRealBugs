<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:31:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-255] Multi-byte character strings are scrambled in log output</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-255</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;When I tried to log a Japanese string the output was scrambled in both the Console and a log file.&lt;/p&gt;

&lt;p&gt;For example,&lt;br/&gt;
logger.warn(&quot;&#26085;&#26412;&#35486;&#12486;&#12473;&#12488;&quot;); // (Japanese test)&lt;/p&gt;

&lt;p&gt;came out as&lt;br/&gt;
15:07:00.184 &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; WARN  test.JapaneseTest - &#35660;&#65381;&#35675;&#65388;&#38577;&#27117;&#12518;&#32359;&#65401;&#32349;?&lt;/p&gt;

&lt;p&gt;This is the log4j2.xml configuration:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;?xml version=&lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt; encoding=&lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;?&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;configuration status=&lt;span class=&quot;code-quote&quot;&gt;&quot;warn&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;appenders&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;Console name=&lt;span class=&quot;code-quote&quot;&gt;&quot;Console&quot;&lt;/span&gt; target=&lt;span class=&quot;code-quote&quot;&gt;&quot;SYSTEM_OUT&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;PatternLayout&amp;gt;&lt;/span&gt;
                &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;pattern&amp;gt;&lt;/span&gt;%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n
                &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/pattern&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/PatternLayout&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/Console&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;File name=&lt;span class=&quot;code-quote&quot;&gt;&quot;tracelog&quot;&lt;/span&gt; fileName=&lt;span class=&quot;code-quote&quot;&gt;&quot;trace-log.txt&quot;&lt;/span&gt; immediateFlush=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt; append=&lt;span class=&quot;code-quote&quot;&gt;&quot;false&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;PatternLayout pattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/File&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/appenders&amp;gt;&lt;/span&gt;
    
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;loggers&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;root level=&lt;span class=&quot;code-quote&quot;&gt;&quot;trace&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;appender-ref ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;Console&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;appender-ref ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;tracelog&quot;&lt;/span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/root&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/loggers&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/configuration&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12647689">LOG4J2-255</key>
            <summary>Multi-byte character strings are scrambled in log output</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="rpopma">Remko Popma</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 May 2013 06:12:44 +0000</created>
                <updated>Sun, 9 Oct 2016 17:53:14 +0000</updated>
                            <resolved>Wed, 15 May 2013 16:35:39 +0000</resolved>
                                    <version>2.0-beta6</version>
                                    <fixVersion>2.0-beta7</fixVersion>
                                    <component>Appenders</component>
                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13658125" author="remkop@yahoo.com" created="Wed, 15 May 2013 07:01:57 +0000"  >&lt;p&gt;Analysis:&lt;br/&gt;
If no character set is specified in the PatternLayout, UTF-8 is used.&lt;br/&gt;
However, in my experience programmers save their source code in the platform encoding.&lt;br/&gt;
The default should be the platform encoding, not UTF-8.&lt;/p&gt;

&lt;p&gt;Fix: in o.a.l.l.c.helpers.Charsets#getSupportedCharset (line 48),&lt;br/&gt;
replace &lt;br/&gt;
    charset = UTF_8;&lt;br/&gt;
with&lt;br/&gt;
    charset = Charset.defaultCharset();&lt;/p&gt;

&lt;p&gt;I&apos;ll commit this when I get home tonight.&lt;/p&gt;</comment>
                            <comment id="13658520" author="remkop@yahoo.com" created="Wed, 15 May 2013 16:35:39 +0000"  >&lt;p&gt;Fixed in revision 1482944.&lt;/p&gt;

&lt;p&gt;This is an important one for Asian users.&lt;/p&gt;</comment>
                            <comment id="13658545" author="garydgregory" created="Wed, 15 May 2013 17:06:06 +0000"  >&lt;p&gt;The fix is not right IMO. &lt;/p&gt;

&lt;p&gt;The goal (unstated, I suppose, so it&apos;s just in my head) of getSupportedCharset is to return a known charset, the one that is passed in, or ... UTF-8 (IMO). UTF-8 is known, the platform default could be anything.&lt;/p&gt;

&lt;p&gt;The change &quot;charset = Charset.defaultCharset()&quot;  just happened to make the test work because YOUR platform encoding supports JP chars, this will not always be the case, so the test will fail for some developers.&lt;/p&gt;

&lt;p&gt;This is a case where the test should be configured to write to a file (and Console) with a JP charset. &lt;/p&gt;</comment>
                            <comment id="13658647" author="remkop@yahoo.com" created="Wed, 15 May 2013 18:39:42 +0000"  >&lt;p&gt;Gary, thanks for reviewing the changes!&lt;/p&gt;

&lt;p&gt;I did not fully understand your comments, let me know if I interpreted them correctly:&lt;br/&gt;
1) Charsets.getSupportedCharset should not return the platform default encoding, but UTF-8, because then the method will return a constant value.&lt;br/&gt;
2) The JUnit tests I wrote will fail for some developers &lt;br/&gt;
3) The JUnit tests are not complete, an additional test is needed that actually writes to a file&lt;/p&gt;

&lt;p&gt;Let me reply to these one by one.&lt;/p&gt;

&lt;p&gt;1)&lt;br/&gt;
I don&apos;t know about the spec for this method, but going on current usage,&lt;br/&gt;
getSupportedCharset is used by all Layouts to (a) either validate a specified encoding - may replace this if unsupported, or (b) provide a default encoding if the user did not specify an encoding in the layout configuration. I guess (b) is most common.&lt;/p&gt;

&lt;p&gt;The key point is that to prevent scrambled messages in the log file, the encoding of the source code with the call to Logger.log must match the encoding used to write the message to the log file. If getSupportedCharset always returns a constant UTF-8 then the log file will always contain scrambled messages unless the user saves their source code in UTF-8. &lt;/p&gt;

&lt;p&gt;Most developers save their source code in the platform encoding. Eclipse and NetBeans save source code in the platform encoding by default (sorry, I don&apos;t know about IntelliJ). Hence the Layouts should use the platform encoding when converting chars to bytes (unless an encoding is specified in the config).&lt;/p&gt;

&lt;p&gt;2)&lt;br/&gt;
I believe this is a misunderstanding. KOI8-R is an encoding for Russian, not JP. It is actually part of the Basic Encodings and included in lib/rt.jar&lt;br/&gt;
This test should work for everyone.&lt;/p&gt;

&lt;p&gt;3)&lt;br/&gt;
You are probably right. &lt;/p&gt;</comment>
                            <comment id="13659101" author="garydgregory" created="Thu, 16 May 2013 01:00:12 +0000"  >&lt;p&gt;I think I might have figured it out; the bottom line is that you should really specify an encoding for your appenders. Neither UTF-8 nor the platform default is right, but the platform default is likely worse.&lt;/p&gt;

&lt;p&gt;1) Let me walk us through it: You are saying that if I encode my .java source files (I will leave aside the scenario where messages are in an external file like a .properties files) in encoding X, then I should set the encoding for my appenders to match X. However, I can use Unicode escapes in a Java String to create any kind of Unicode String, no matter what encoding I am using in my .java source file. Because Java Strings are Unicode strings, it does not matter what the encoding of the source file is, the compiler and JVM use Unicode strings. If you use an encoding in your .java files that is not the platform encoding, then you have to tell the compiler about the encoding in order for the compiler to read the source correctly and convert the Java bytes to String objects. As we all know, if I have a Java String and I want bytes, I need to use an encoding to convert the String to bytes. Therefore, the encoding of the source file is irrelevant. What matters is that the JVM has a Unicode String object and we need to give it an encoding to get bytes to write some place.&lt;/p&gt;

&lt;p&gt;So, back to the Russians: If the JVM has a (Unicode) String with Cyrillic characters, I had better give it an encoding that knows what to do with these characters; ASCII will not do for example. If I rely on the platform encoding, who knows what I will get. On Windows for example, there are no Cyrillic characters in the default encoding Cp1252. If UTF-8 is the default &amp;#8211; recall that UTF stands for Unicode Transformation Format &#8211; I should get better results. &lt;/p&gt;

&lt;p&gt;The bottom line is that for predictable results, I should always use an encoding in my configuration and not rely on the platform encoding. If I do not specify and default to the platform encoding, sometimes I will get expected results, sometimes I will get junk and other times different kinds of junk, all depending on the platform. On the other hand, if I do not specify and default to UTF-8, I&#8217;m likely to get better results and if I do get junk, it will be the same junk on all platforms.&lt;/p&gt;

&lt;p&gt;2) The only encodings you can count on are the six listed in &lt;a href=&quot;http://docs.oracle.com/javase/6/docs/api/java/nio/charset/Charset.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/6/docs/api/java/nio/charset/Charset.html&lt;/a&gt;. In practice, different JRE and JDK implementations provide many additional encodings, but these are not required. Therefore, in order to write portable tests, we should not expect them to be there, we should only rely on the required six. See my changes to CharsetTests.java.&lt;br/&gt;
Please help me find holes in this or support it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13659152" author="remkop@yahoo.com" created="Thu, 16 May 2013 02:35:29 +0000"  >&lt;p&gt;1. I have to eat humble pie here and admit you are completely right about the source file encoding being irrelevant. The JVM has a unicode string in memory. I think I confused myself when I was doing some tests with changing the editor encoding on a source file with Japanese in Eclipse. My bad.&lt;/p&gt;

&lt;p&gt;I understand your point that using UTF-8 as the default would be predictable. This is especially useful when a log file is read in an environment with a different platform encoding than where the log file was written.&lt;/p&gt;

&lt;p&gt;It just does not seem right that if I log a Japanese string to the Console in my Japanese environment it comes out scrambled.&lt;br/&gt;
Let me check how log4j-1.2 and logback handle this. &lt;/p&gt;


&lt;p&gt;2. I was looking at &lt;a href=&quot;http://docs.oracle.com/javase/6/docs/technotes/guides/intl/encoding.doc.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/6/docs/technotes/guides/intl/encoding.doc.html&lt;/a&gt; but I agree these are only for the Oracle JVM. Thanks for the pointer. I&apos;ll remove the Russian encoding from the JUnit test.&lt;/p&gt;</comment>
                            <comment id="13659211" author="beamerblvd" created="Thu, 16 May 2013 04:37:44 +0000"  >&lt;p&gt;Yes, Gary is completely right about Java&apos;s strings always being unicode.&lt;/p&gt;

&lt;p&gt;I&apos;m a bit confused here. My (admittedly limited) understanding of character sets was that UTF-8 takes care of &lt;b&gt;everything&lt;/b&gt;. English, Cyrillic, Korean, Japanese, etc. should all be able to be properly represented using UTF-8. That&apos;s why I&apos;m a bit uncertain about why we can&apos;t always use UTF-8 for &lt;b&gt;everything&lt;/b&gt;. The only exception I can think of is /reading/ files, which would have been created by something else (text editor, other program) and need to have their encoding detected/specified. But why wouldn&apos;t UTF-8 work for everything that Log4j writes/transmits?&lt;/p&gt;</comment>
                            <comment id="13659255" author="remkop@yahoo.com" created="Thu, 16 May 2013 05:45:55 +0000"  >&lt;p&gt;If the default for writing is UTF-8, then if I log a Japanese string to the Console in my Japanese environment it comes out scrambled, because the Console is in the platform default encoding.&lt;/p&gt;

&lt;p&gt;(Same with reading log files written in UTF-8, unless I tell the editor/viewer explicitly to use UTF-8. Most Japanese editors use the platform encoding by default, and often have an option to switch to another encoding.)&lt;/p&gt;</comment>
                            <comment id="13659259" author="ralph.goers@dslextreme.com" created="Thu, 16 May 2013 06:03:14 +0000"  >&lt;p&gt;Nick, while UTF-8 is capable of representing characters in many languages most computers don&apos;t display characters on the screen in Unicode.  They use what IBM calls code pages. For example, Gary mentioned cp 1252 - cp stands for code page. &lt;a href=&quot;http://en.wikipedia.org/wiki/Code_page&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://en.wikipedia.org/wiki/Code_page&lt;/a&gt; gives a simple explanation of what they are.  So the problem is that although you may have data in Unicode, to display it on the screen so that it is viewable it must be converted to the proper code page.  Since Strings in Java are always UTF-8, when you call getBytes() on the string passing in a charset allows Java to convert the UTF-8 into the target code page, provided that the OS has the definition for the code page installed.  This is why Layouts accept a charset parameter. The charset Java&apos;s name for a code page.&lt;/p&gt;

&lt;p&gt;What I don&apos;t understand here is that if Remko is generating logs in UTF-8 that contain Japanese characters and is specifying the proper Japanese code page for the host computer why it is generating unreadable stuff. If no charset is specified then it is perfectly understandable why this would be happening.&lt;/p&gt;

&lt;p&gt;Note that this is actually the proper way to performa internationalization/localization - the Strings should be manipulated in UTF-8 and passed from client to server that way and only converted to the target code page when they are actually displayed. &lt;/p&gt;</comment>
                            <comment id="13659263" author="remkop@yahoo.com" created="Thu, 16 May 2013 06:10:43 +0000"  >&lt;p&gt;Ralph, when you say &quot;Remko ... is specifying the proper Japanese code page for the host computer&quot;, what do you mean?&lt;br/&gt;
Do you mean specifying a charset in the Layout section of the log4j2.xml?&lt;/p&gt;</comment>
                            <comment id="13659285" author="ralph.goers@dslextreme.com" created="Thu, 16 May 2013 06:26:06 +0000"  >&lt;p&gt;Yes. Are you specifying the target code page on your Layout?  If not, Charsets.getSupportedCharset() will return Charset.defaultCharset(), which may or may not be what you want. You would probably need to write a simple test case to see what it returns (or stop it in the debugger).&lt;/p&gt;</comment>
                            <comment id="13659288" author="remkop@yahoo.com" created="Thu, 16 May 2013 06:32:37 +0000"  >&lt;p&gt;Ralph, ok. I understand what you mean now.&lt;/p&gt;

&lt;p&gt;The configuration I used does not specify any charset encoding. This gave the problem described in the summary.&lt;/p&gt;

&lt;p&gt;I fixed this in trunk, so now Charsets.getSupportedCharset() will return Charset.defaultCharset().&lt;br/&gt;
This fixes the issue and logging a Japanese string to the console is no longer scrambled.&lt;/p&gt;

&lt;p&gt;My earlier comment referred to Gary&apos;s suggestion that the fix is wrong and Charsets.getSupportedCharset() should return &quot;UTF-8&quot;.&lt;br/&gt;
In that case logging a Japanese string to the console will give scrambled output by default. &lt;/p&gt;

&lt;p&gt;It is true that users could fix that by putting their platform encoding in the Layout configuration, but it is my opinion that logging to the console should just work out of the box.&lt;/p&gt;</comment>
                            <comment id="13659290" author="ralph.goers@dslextreme.com" created="Thu, 16 May 2013 06:34:43 +0000"  >&lt;p&gt;FWIW - Log4j 1.x uses a WriterAppender as the base for most String based appenders that write to an OutputStream. You specify the charset on the Appender and the OutputStreamWriter is passed the encoding. It will convert the Strings it is passed into the target charset.  Log4j 2 just moves the encoding into the Layouts so that Appenders can handle any kind of data.&lt;/p&gt;</comment>
                            <comment id="13659292" author="remkop@yahoo.com" created="Thu, 16 May 2013 06:37:14 +0000"  >&lt;p&gt;I see. What encoding does Log4j 1.x use if no charset is specified on the Appender?&lt;/p&gt;</comment>
                            <comment id="13659293" author="ralph.goers@dslextreme.com" created="Thu, 16 May 2013 06:38:43 +0000"  >&lt;p&gt;Yes - I think Gary&apos;s example has one thing incorrect. I would expect that a Windows computer in Russia would have been localized to that environment and would have a Cyrillic code page as the default for the OS.  That is why Windows and most other operating systems ask where you are during the OS installation.  I seem to recall that the internationalized version of Windows also gave the option to install additional code pages - but I may be remembering incorrectly since it has been a while since I last installed Windows.&lt;/p&gt;</comment>
                            <comment id="13659297" author="ralph.goers@dslextreme.com" created="Thu, 16 May 2013 06:44:05 +0000"  >&lt;p&gt;As for Log4j 1.x. - if the encoding is null then it will use the system default.&lt;/p&gt;</comment>
                            <comment id="13659301" author="garydgregory" created="Thu, 16 May 2013 06:47:15 +0000"  >&lt;p&gt;I do not understand how using UTF-8 scrambles the text. This is an&lt;br/&gt;
issue that needs explaining, could there be a different bug?&lt;/p&gt;

&lt;p&gt;Here is where using the platform default breaks when no charset is&lt;br/&gt;
defined in the config: you set up an app on your JP system and you get&lt;br/&gt;
some logging. You give me your config and I run it on my US Windows&lt;br/&gt;
system and it comes out scrambled. If the config specifics the&lt;br/&gt;
charset, all output on all systems is OK.&lt;/p&gt;

&lt;p&gt;If no charset is set in the config, I claim that if UTF-8 is used I&lt;br/&gt;
the right places, all should be well. But, it sounds like Remko is&lt;br/&gt;
seeing otherwise. So either, I do not understand how UTF-8 works,&lt;br/&gt;
there is bug, or we are missing some info from Remko. Arg. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Gary&lt;/p&gt;

</comment>
                            <comment id="13659309" author="remkop@yahoo.com" created="Thu, 16 May 2013 06:57:35 +0000"  >&lt;p&gt;Gary, you are describing the different use case of sharing log files between environments that use different encodings.&lt;br/&gt;
Fair enough, you need to tell the recipient what encoding the file is in.&lt;/p&gt;

&lt;p&gt;In the use case I am describing, writing and reading is happening on the same machine.&lt;br/&gt;
If you write UTF-8 bytes to the Console, the Console will interpret these bytes as being in the platform encoding.&lt;/p&gt;

&lt;p&gt;This works for English text because the platform encoding (I assume US-ASCII) is a subset of UTF-8, so you cannot test this on your machine.&lt;br/&gt;
But for Japanese text, if you take UTF-8 bytes for &quot;&#26085;&#26412;&#35486;&quot; and you interpret these bytes as MS932 (the platform encoding for Japanese Windows), you end up with scrambled text.&lt;/p&gt;</comment>
                            <comment id="13659317" author="ralph.goers@dslextreme.com" created="Thu, 16 May 2013 07:06:05 +0000"  >&lt;p&gt;Gary, that is absolutely incorrect. If I specify characters in the Japanese encoding range of UTF-8 and you are running on a non-Japenese computer, odds are you are going to end up with garbage.  Now what you are saying would be true on my Mac because it has a LANG setting of en_US.UTF-8 - so the display IS apparently actually capable of displaying all the characters.  However, note that in this case the default encoding would also be correct. But if my computer was set to en_US.cp1252 the default encoding wouldn&apos;t work correctly, but neither would the configured code page if I don&apos;t have that installed on my machine, and if my computer screen can&apos;t render UTF-8 then there is no way to display any Japanese characters.&lt;/p&gt;

</comment>
                            <comment id="13659476" author="beamerblvd" created="Thu, 16 May 2013 12:26:58 +0000"  >&lt;p&gt;Okay, I think I understand all of this better. The 100% correct solution that will work all of the time is to change all of the computers in the world to have a default UTF-8 platform encoding. Too bad we don&apos;t have the power to do that... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Here&apos;s what I think should be happening:&lt;/p&gt;

&lt;p&gt;Internally, absolutely everything should be handled UTF-8 for consistency&apos;s sake. However, when dealing with external resources:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Data transmitted over the wire or interprocess (such as net, flume, etc.) should use UTF-8 exclusively.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;XML written to a file or other non-network output stream should use UTF-8 exclusively.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Data read from files or other non-network input streams should detect the file encoding (is this possible? do we have to just rely on the platform default here?) and read in that file encoding, converting to Unicode upon reading (which should happen automatically, since all Strings in Java are Unicode). My understanding of XML is that you SHOULD always encode it a Unicode variant such as UTF-8, UTF-16, etc., but not everybody does.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Data written to files or other output streams (including the Console) should use the platform default encoding if no explicit encoding is specified. Every AbstractStringLayout should provide a way to specify an encoding that overrides the platform default encoding. AbstractStringLayout already does this by having a mandatory constructor that takes a Charset. However, it doesn&apos;t account for the possibility that it is constructed with a null Charset. IMO, it should be setting the Charset to the platform default if it&apos;s constructed with a null Charset. Furthermore, every class that extends AbstractStringLayout should use this Charset /except/ XMLLayout, which should ALWAYS use UTF-8. The `@PluginAttr(&quot;charset&quot;) String charsetName` parameter for XMLLayout#createLayout should be removed, the `Charset charset` parameter for XMLLayout#XMLLayout should be removed, and UTF-8 should be hardcoded as the value for super(). (In fact, right now the XMLLayout is broken, because it accepts a user-supplied Charset but the header is hard-coded to &amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;.)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(Side note: Strings in Java are Unicode, not UTF-8. Some of the people commenting here have used these terms interchangeably, but they are not interchangeable. Unicode is the system of assigning decimal numbers to characters. UTF-8, UTF-16, UTF-32, etc. are different systems for interpreting bytes as these decimal, Unicode numbers. &lt;a href=&quot;http://stackoverflow.com/questions/643694/utf-8-vs-unicode&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/643694/utf-8-vs-unicode&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="13659559" author="remkop@yahoo.com" created="Thu, 16 May 2013 14:15:15 +0000"  >&lt;p&gt;Nick, nice find on the header being hard-coded to UTF-8 in XMLLayout!&lt;/p&gt;

&lt;p&gt;I agree that the default encoding for XMLLayout should be UTF-8 if the user did not specify a charset in the config, but I would prefer to fix the hard-coded header to use the specified charset instead. I think it is ok to use user-specified encodings for XML (&lt;a href=&quot;http://www.w3schools.com/xml/xml_encoding.asp&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.w3schools.com/xml/xml_encoding.asp&lt;/a&gt;) as long as the header correctly reflects that. &lt;/p&gt;

&lt;p&gt;Otherwise what you&apos;re saying sounds reasonable.&lt;/p&gt;

&lt;p&gt;This made me think: perhaps the default encoding depends on the layout?&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;UTF-8 for XMLLayout, RFC5424Layout (actually RFC5424 seems to require UTF-8 or US-ASCII)&lt;/li&gt;
	&lt;li&gt;Platform default for BasicLayout, PatternLayout&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Not sure about HTMLLayout (leaning towards UTF-8) and SyslogLayout (no clue... What software would be used to view these log records?).&lt;/p&gt;

&lt;p&gt;Regardless of what default we choose for HTMLLayout, the header is currently missing the encoding name.&lt;br/&gt;
We should add something like this between the &amp;lt;head&amp;gt; and the &amp;lt;title&amp;gt; elements:&lt;br/&gt;
&amp;lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=XXXXXX&quot;&amp;gt; &amp;lt;-- getCharset().name()&lt;/p&gt;</comment>
                            <comment id="13659572" author="remkop@yahoo.com" created="Thu, 16 May 2013 14:23:55 +0000"  >&lt;p&gt;Yay! Fancy wiki formatting!! Yippee! &lt;em&gt;Awesome!&lt;/em&gt;&lt;/p&gt;</comment>
                            <comment id="13659577" author="beamerblvd" created="Thu, 16 May 2013 14:28:06 +0000"  >&lt;p&gt;I like that plan:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;XMLLayout and HTMLLayout default to UTF-8 if none specified, but allow customization&lt;/li&gt;
	&lt;li&gt;RFC5424 hard-coded to UTF-8 and does not allow customization (US-ASCII cannot display Japanese and other characters, therefor we should just stick with UTF-8 here to avoid any possibility of problems)&lt;/li&gt;
	&lt;li&gt;Other AbstractStringLayouts default to platform encoding if none specified&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The SyslogLayout confuses me. RFC5424 /is/ &quot;The Syslog Protocol,&quot; so why would we need both Layouts? Either way, it appears that Syslog, being RFC5424, requires either UTF-8 or US-ASCII, so I think it also should be hard-coded to UTF-8.&lt;/p&gt;</comment>
                            <comment id="13659578" author="beamerblvd" created="Thu, 16 May 2013 14:29:13 +0000"  >&lt;p&gt;It&apos;s about time! &lt;em&gt;Finally&lt;/em&gt; I can &lt;tt&gt;&amp;lt;code&amp;gt;&lt;/tt&gt; when I need to.&lt;/p&gt;</comment>
                            <comment id="13659582" author="garydgregory" created="Thu, 16 May 2013 14:31:35 +0000"  >&lt;p&gt;What encoding should I used in the layout for the example in the description? The obvious ones I&apos;ve tried give me junk output (Shift_JIS, MS932).&lt;/p&gt;</comment>
                            <comment id="13659598" author="remkop@yahoo.com" created="Thu, 16 May 2013 14:45:26 +0000"  >&lt;p&gt;You mean, in order to reproduce the issue?&lt;br/&gt;
Perhaps you have reproduced the issue! What is your platform encoding and where are you seeing the garbage? Console, or text editor/viewer?&lt;/p&gt;</comment>
                            <comment id="13659601" author="garydgregory" created="Thu, 16 May 2013 14:51:13 +0000"  >&lt;p&gt;I want to see the correct chars on Windows, so I want to plugin the right charset. I &lt;em&gt;know&lt;/em&gt; that using Cp1252 (my default) will yield junk.&lt;/p&gt;

&lt;p&gt;My misunderstanding was that I could use UTF-8 and have the right thing happen, which it does not, because... the Windows CMD console always displays in the platform encoding? So how can I see the right characters on Windows in the console?&lt;/p&gt;</comment>
                            <comment id="13659605" author="garydgregory" created="Thu, 16 May 2013 14:55:02 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Data read from files or other non-network input streams should detect the file encoding (is this possible? do we have to just rely on the platform default here?)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;XML parsers can auto-detect file encodings because the XML standard defines Byte Order Mark (BOM) bytes and the &lt;tt&gt;xml&lt;/tt&gt; processing instruction with its &lt;tt&gt;encoding&lt;/tt&gt; attribute.&lt;/p&gt;

&lt;p&gt;For all other kinds of files, you have to know the encoding.&lt;/p&gt;</comment>
                            <comment id="13659654" author="remkop@yahoo.com" created="Thu, 16 May 2013 15:49:39 +0000"  >&lt;p&gt;Gary, I actually think you are hitting the same problem that made me file this JIRA.&lt;br/&gt;
Windows console always displays the platform encoding and cannot display UTF-8 bytes for multi-byte characters.&lt;/p&gt;

&lt;p&gt;To answer your question how you can see the right characters on Windows in the console, I don&apos;t see any other way than to change your platform encoding. &lt;a href=&quot;http://www.emeditor.com/help/glossary/systemdefaultencoding.htm&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.emeditor.com/help/glossary/systemdefaultencoding.htm&lt;/a&gt;&lt;br/&gt;
I tried this and changed the language setting to US English. After the required reboot the console used a different font and was unable to display Japanese. You can try changing your setting to Japanese, and try to reproduce the issue again, specifying one of these encodings in the Layout charset: UTF-8 (I suspect this won&apos;t work) and Shift_JIS or MS932 (MS932 should work if your machine has that codepage and you successfully switched to Japanese).&lt;/p&gt;</comment>
                            <comment id="13659933" author="garydgregory" created="Thu, 16 May 2013 20:23:40 +0000"  >&lt;p&gt;A couple of data points for testing and the record.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If I set the file appender charset to &lt;tt&gt;Shift-JIS&lt;/tt&gt;, the file has the correct data when I view it in Notepad++ and Eclipse with the encoding to view the file also set to &lt;tt&gt;Shift-JIS&lt;/tt&gt;. Using &lt;tt&gt;UTF-8&lt;/tt&gt; in the viewer looks like junk.&lt;/li&gt;
	&lt;li&gt;If I set the file appender charset to &lt;tt&gt;UTF-8&lt;/tt&gt;, the file has the correct data when I view it in Eclipse with the encoding to view the file also set to &lt;tt&gt;UTF-8&lt;/tt&gt;. Using &lt;tt&gt;Shift-JIS&lt;/tt&gt; in the viewer looks like junk.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The above is good, no bug there.&lt;/p&gt;

&lt;p&gt;Windows lets you change code pages in a CMD console with the &lt;tt&gt;chcp&lt;/tt&gt; command. For me though, &lt;tt&gt;chcp 932&lt;/tt&gt; does not work, where &lt;tt&gt;932&lt;/tt&gt; is the Windows code page number for &lt;tt&gt;Shift-JIS&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Another tip is that you have to you a font in the CMD that is at least Lucinda Console for display certain chars.&lt;/p&gt;

&lt;p&gt;I tried to output and view UTF-8 on the CMD console without success. I tried, &lt;tt&gt;chcp 65001&lt;/tt&gt;, no go. I tried &lt;tt&gt;cmd /U&lt;/tt&gt;, no go.&lt;/p&gt;</comment>
                            <comment id="13660168" author="remkop@yahoo.com" created="Thu, 16 May 2013 23:56:39 +0000"  >&lt;p&gt;Looks like this was a fruitful discussion: 5 new JIRAs, 4 already fixed (thanks, Gary!)&lt;/p&gt;

&lt;p&gt;I did another test and I am satisfied that the current solution (using platform default in BasicLayout, PatternLayout if no charset was specified in configuration) is correct for Japanese users (and Chinese users, based on conversations with Chinese colleagues).&lt;/p&gt;

&lt;p&gt;Gary, do you still have doubts?&lt;br/&gt;
If testing on your PC is a concern, you can give me commands to execute on my Japanese environment and I can give you back the results.&lt;/p&gt;</comment>
                            <comment id="13660199" author="garydgregory" created="Fri, 17 May 2013 00:28:42 +0000"  >&lt;p&gt;I think am resigned to the fact that we have to let the platform default kick in when the charset is not specified. This makes it simpler to use.&lt;/p&gt;

&lt;p&gt;A best-practice, which we could document if we agree, is to always specify a charset in your configs. This could be enforced by making the charset required but that seems overzealous.&lt;/p&gt;

&lt;p&gt;We do have write-once, run anywhere, but differently &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13660209" author="remkop@yahoo.com" created="Fri, 17 May 2013 00:42:44 +0000"  >&lt;p&gt;That is great, thanks for the confirmation!&lt;/p&gt;

&lt;p&gt;I think specifying a charset is especially valuable when sharing log files between different environments. &lt;br/&gt;
When I researched if log4j-1.x and logback had any encoding issues, I only found questions for that scenario.&lt;br/&gt;
So this is definitely worth mentioning in the FAQ page.&lt;/p&gt;

&lt;p&gt;I think for normal usage not specifying a charset is fine. All Japanese and Chinese users I&apos;ve talked to about this said they never used the option to specify a charset in log4j-1.x, but also never experienced any problems.&lt;/p&gt;

&lt;p&gt;That said, I&apos;m not opposed to using a charset in a few examples to show that this is possible, as long as we avoid giving the impression that this is mandatory now with log4j-2.0.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13010862">LOG4J2-1636</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12647971">LOG4J2-257</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>328045</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 27 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1kllz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>328389</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>