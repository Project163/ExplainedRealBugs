<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:42:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-3274] Log4j2 deadlock version 2.16</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-3274</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;My application is a sprint boot application that uses log4j2 and runs in a Wildfly server. After the zero day attack, we upgraded to the latest log4j2 version(2.16). But after the log4j upgrade, my application stops working once in a while. And when I looked at the threaddumps, I found that there is a deadlock created by log4j.&#160;&lt;/p&gt;

&lt;p&gt;When analysing this issue, I came through a possible defect in log4j code. Not sure if that can result in a deadlock.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Log4J possible bug&lt;/b&gt;&#160;- As per the release notes, there was a fix to&#160;&lt;b&gt;Enable immediate flush on RollingFileAppender when buffered i/o is not enabled. (&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3114&quot; title=&quot;Wrong value &amp;quot;false&amp;quot; of RollingFileAppender.immediateFlush when configured from a Log4j 1.x configuration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3114&quot;&gt;&lt;del&gt;LOG4J2-3114&lt;/del&gt;&lt;/a&gt;)&lt;/b&gt;. But the code just does the opposite in &lt;b&gt;RollingFileAppenderBuilder&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;It should have been&#160;&lt;tt&gt;if(!bufferedIo) { immediateFlush = true; }{&lt;/tt&gt;}. And one of my appender explicitly sets bufferedIo value to true. I know that log4j does a bufferedio by default and it is not necessary to set this flag explicitly. But unfortunately the code that I am working on is a legacy code and the configuration was working fine before the upgrade.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;I have added my log4j configuration in here &lt;a href=&quot;https://stackoverflow.com/questions/70450611/log4j2-deadlock&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/70450611/log4j2-deadlock&lt;/a&gt;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Extract from Thread dump:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&quot;default task-128&quot; #450 prio=5 os_prio=0 tid=0x00007f31f80cf800 nid=0x14c8 waiting for monitor entry &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f31a7d88000&amp;#93;&lt;/span&gt;&lt;br/&gt;
&#160; &#160;java.lang.Thread.State: BLOCKED (on object monitor)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.appender.OutputStreamManager.writeBytes(OutputStreamManager.java:352)&lt;br/&gt;
&#160; &#160; - waiting to lock &amp;lt;0x00000000c0e70eb0&amp;gt; (a org.apache.logging.log4j.core.appender.OutputStreamManager)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.layout.TextEncoderHelper.writeEncodedText(TextEncoderHelper.java:96)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.layout.TextEncoderHelper.encodeText(TextEncoderHelper.java:65)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.layout.StringBuilderEncoder.encode(StringBuilderEncoder.java:68)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.layout.StringBuilderEncoder.encode(StringBuilderEncoder.java:32)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.layout.PatternLayout.encode(PatternLayout.java:228)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.layout.PatternLayout.encode(PatternLayout.java:60)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.directEncodeEvent(AbstractOutputStreamAppender.java:197)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.tryAppend(AbstractOutputStreamAppender.java:190)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.append(AbstractOutputStreamAppender.java:181)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.config.AppenderControl.tryCallAppender(AppenderControl.java:161)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.config.AppenderControl.callAppender0(AppenderControl.java:134)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.config.AppenderControl.callAppenderPreventRecursion(AppenderControl.java:125)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.config.AppenderControl.callAppender(AppenderControl.java:89)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.config.LoggerConfig.callAppenders(LoggerConfig.java:542)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.config.LoggerConfig.processLogEvent(LoggerConfig.java:500)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:483)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.config.LoggerConfig.logParent(LoggerConfig.java:533)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.config.LoggerConfig.processLogEvent(LoggerConfig.java:502)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:483)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:388)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.config.AwaitCompletionReliabilityStrategy.log(AwaitCompletionReliabilityStrategy.java:63)&lt;br/&gt;
&#160; &#160; at org.apache.logging.log4j.core.Logger.logMessage(Logger.java:153)&lt;br/&gt;
&#160; &#160; at org.apache.logging.slf4j.Log4jLogger.log(Log4jLogger.java:376)&lt;br/&gt;
&#160; &#160; at org.apache.commons.logging.impl.SLF4JLocationAwareLog.error(SLF4JLocationAwareLog.java:203)&lt;br/&gt;
&#160; &#160; at org.springframework.boot.web.support.ErrorPageFilter.handleCommittedResponse(ErrorPageFilter.java:225)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13419039">LOG4J2-3274</key>
            <summary>Log4j2 deadlock version 2.16</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10004">Not A Bug</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="faskan">Faisal Khan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 22 Dec 2021 15:09:20 +0000</created>
                <updated>Thu, 23 Dec 2021 15:58:46 +0000</updated>
                            <resolved>Wed, 22 Dec 2021 23:07:24 +0000</resolved>
                                                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17463902" author="ralph.goers@dslextreme.com" created="Wed, 22 Dec 2021 15:35:24 +0000"  >&lt;p&gt;You will have to show more of the stack trace than that. It is perfectly normal for a thread to be blocked in writeBytes. It simply means some other thread is writing to the file. Can you supply the full thread dump?&lt;/p&gt;

&lt;p&gt;Also, line 156 in RollingFileAppender was changed from&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
isImmediateFlush()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
!isBufferedIo || isImmediateFlush() &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which is correct. Are you looking somewhere else?&lt;/p&gt;</comment>
                            <comment id="17463916" author="garydgregory" created="Wed, 22 Dec 2021 15:45:24 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=faskan&quot; class=&quot;user-hover&quot; rel=&quot;faskan&quot;&gt;faskan&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Please consider updating from 2.16.0 to 2.17.0, I think this will make debugging simpler for all involved.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17463923" author="ralph.goers@dslextreme.com" created="Wed, 22 Dec 2021 15:52:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=faskan&quot; class=&quot;user-hover&quot; rel=&quot;faskan&quot;&gt;faskan&lt;/a&gt; I found the line you are referencing. The line in question is in the RollingFileAppenderBuilder in the log4j-1.2-api compatibility code. It is indeed incorrect. However, that should not cause a deadlock.&lt;/p&gt;</comment>
                            <comment id="17463939" author="JIRAUSER282470" created="Wed, 22 Dec 2021 16:18:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgoers&quot; class=&quot;user-hover&quot; rel=&quot;rgoers&quot;&gt;rgoers&lt;/a&gt; , I have attached the thread dumps here. I didn&apos;t notice that RollingFileAppenderBuilder was in log4j-1.2-api compatibility code. Then that issue has no impact in my application since mine is already using log4j2 compatible configuration. But still the deadlock is a question mark.&lt;/p&gt;</comment>
                            <comment id="17464010" author="jira-bot" created="Wed, 22 Dec 2021 18:55:09 +0000"  >&lt;p&gt;Commit 121a4a3db42297b2af9f144c2b8788bcde36a0e2 in logging-log4j2&apos;s branch refs/heads/release-2.x from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=121a4a3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=121a4a3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3274&quot; title=&quot;Log4j2 deadlock version 2.16&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3274&quot;&gt;&lt;del&gt;LOG4J2-3274&lt;/del&gt;&lt;/a&gt; -  Buffered I/O checked had inverted logic in RollingFileAppenderBuidler&lt;/p&gt;</comment>
                            <comment id="17464150" author="ralph.goers@dslextreme.com" created="Wed, 22 Dec 2021 23:05:04 +0000"  >&lt;p&gt;This is quite an interesting thread dump. It shows:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Threads blocked in the Log4j OutputStreamManager waiting for lock 0x00000000c0e70eb0 to write.&#160;&lt;/li&gt;
	&lt;li&gt;A thread holding 0x00000000c0e70eb0 that is blocked writing to the JBoss Console waiting for lock 0x00000000c226b858.&lt;/li&gt;
	&lt;li&gt;A thread holding 0x00000000c226b858 that is in the Log4j StatusLogger writing to System.out and was redirected to org.jboss.stdio.WriterOutputStream.write which then called org.jboss.logmanager.log, which in turn called the SLF4J Logger Bridge, entered Log4j&apos;s SLF4J bridge and called Log4j&apos;s logger. This is blocked waiting to get lock 0x00000000c0e70eb0, which is held by item 2.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;From what I can gather here and the configuration you posted on Stackoverflow you have log4j configured to write to the console. But then you have installed something to have JBoss route its logs to Log4j. So you have a circularity problem. If you didn&apos;t have a deadlock you would instead end up with a StackOverflowError as they ping-pong back and forth between JBoss and Log4j.&#160; You need to modify your configuration so that things sent to the JBoss Console do not end up in the Console Appender.&lt;/p&gt;</comment>
                            <comment id="17464152" author="ralph.goers@dslextreme.com" created="Wed, 22 Dec 2021 23:07:24 +0000"  >&lt;p&gt;Resolving as not a bug since this was caused by a bad configuration. Please close after you confirm. You can reopen if there are still issues.&lt;/p&gt;</comment>
                            <comment id="17464662" author="JIRAUSER282470" created="Thu, 23 Dec 2021 15:58:40 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgoers&quot; class=&quot;user-hover&quot; rel=&quot;rgoers&quot;&gt;rgoers&lt;/a&gt;. Closing this issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13037842" name="threaddumps" size="7351819" author="faskan" created="Wed, 22 Dec 2021 16:15:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>Java</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 46 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0xyrk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>