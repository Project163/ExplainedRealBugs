<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:38:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1628] Regression in FileAppender locking since 2.6</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1628</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;We have several threads writing to an async file with locking set to true. Under log4j 2.5 the message from each thread are interleaved correctly. Using log4j 2.6.2 some messages are scrambled as if multiple threads are writing to the file simultaneously. Reverting to 2.5 fixes the problem.&lt;br/&gt;
Configuration to follow.&lt;/p&gt;</description>
                <environment>&lt;p&gt;centos&lt;/p&gt;</environment>
        <key id="13009009">LOG4J2-1628</key>
            <summary>Regression in FileAppender locking since 2.6</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="markbowman">Mark Bowman</reporter>
                        <labels>
                    </labels>
                <created>Fri, 30 Sep 2016 22:34:39 +0000</created>
                <updated>Sun, 25 Dec 2016 14:05:22 +0000</updated>
                            <resolved>Sun, 25 Dec 2016 14:05:21 +0000</resolved>
                                    <version>2.6.2</version>
                                    <fixVersion>2.8</fixVersion>
                                    <component>Appenders</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15537285" author="markbowman" created="Fri, 30 Sep 2016 22:41:12 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;?xml version=&lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt; encoding=&lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;?&amp;gt;
&amp;lt;Configuration status=&lt;span class=&quot;code-quote&quot;&gt;&quot;warn&quot;&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;pubsub&quot;&lt;/span&gt; packages=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.lcogt.commons.log&quot;&lt;/span&gt; verbose=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;&amp;gt;
 
    &amp;lt;Appenders&amp;gt;
        &amp;lt;File name=&lt;span class=&quot;code-quote&quot;&gt;&quot;LogStash&quot;&lt;/span&gt; fileName=&lt;span class=&quot;code-quote&quot;&gt;&quot;logstash.log&quot;&lt;/span&gt; locking=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt; bufferSize=&lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;&amp;gt;
            &amp;lt;LCOGTLayout/&amp;gt;
        &amp;lt;/File&amp;gt;
    &amp;lt;/Appenders&amp;gt;

    &amp;lt;Loggers&amp;gt;
        &amp;lt;asyncLogger name=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.lcogt&quot;&lt;/span&gt; level=&lt;span class=&quot;code-quote&quot;&gt;&quot;info&quot;&lt;/span&gt; additivity=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;&amp;gt;
            &amp;lt;AppenderRef ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;LogStash&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;/asyncLogger&amp;gt;
    &amp;lt;/Loggers&amp;gt;
&amp;lt;/Configuration&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15537317" author="garydgregory" created="Fri, 30 Sep 2016 22:51:41 +0000"  >&lt;p&gt;Can do describe or post &lt;tt&gt;LCOGTLayout&lt;/tt&gt; SVP?&lt;/p&gt;</comment>
                            <comment id="15537325" author="markbowman" created="Fri, 30 Sep 2016 22:55:23 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;package org.lcogt.commons.log;

import org.apache.logging.log4j.core.LogEvent;
import org.apache.logging.log4j.core.config.plugins.Plugin;
import org.apache.logging.log4j.core.config.plugins.PluginAttribute;
import org.apache.logging.log4j.core.config.plugins.PluginFactory;
import org.apache.logging.log4j.core.layout.AbstractStringLayout;
import org.apache.logging.log4j.message.Message;
import org.json.simple.JSONValue;

import java.io.PrintWriter;
import java.io.StringWriter;
import java.nio.charset.Charset;
import java.util.Date;

/**
 * A Log4J layout that formats messages to adhere to LCOGT standards
 * http://intranet.lco.gtn/Software:Logging_Best_Practice
 * Created by ariba on 8/26/15.
 * Ported to log4j2 by mbowman 4th November 2015
 */
@Plugin(name = &quot;LCOGTLayout&quot;, category = &quot;Core&quot;, elementType = &quot;layout&quot;)
public class LCOGTLayout extends AbstractStringLayout
{
    protected LCOGTLayout(Charset charset)
    {
        super(charset);
    }

    @PluginFactory
    public static LCOGTLayout createLayout(@PluginAttribute(value = &quot;charset&quot;, defaultString = &quot;UTF-8&quot;) Charset charset)
    {
        return new LCOGTLayout(charset);
    }

    private static final ConcurrentDateFormatAccess dfa = new ConcurrentDateFormatAccess();


    @Override
    public String toSerializable(LogEvent loggingEvent)
    {
        Message message = loggingEvent.getMessage();
        StringBuilder builder = new StringBuilder();
        builder.append(dfa.format(new Date(loggingEvent.getTimeMillis()))).append(&quot; &quot;);
        builder.append(loggingEvent.getLevel()).append(&quot;: &quot;);
        builder.append(loggingEvent.getLoggerName()).append(&quot;: &quot;);

        builder.append(message.getFormattedMessage());

        if (loggingEvent.getThrown() != null)
        {
            builder.append(&quot;\n&quot;).append(getStackTrace(loggingEvent.getThrown()));
        }

        builder.append(&quot; | &quot;);

        builder.append(JSONValue.toJSONString(loggingEvent.getContextMap()));

        builder.append(&quot;\n&quot;);
        return builder.toString();
    }

    /**
     * Get the stack trace for the specified exception as a string
     *
     * @param t Exception to get stack trace
     * @return Stack trace as string
     */
    private String getStackTrace(Throwable t)
    {
        String stackTrace = &quot;&quot;;
        if (t != null)
        {
            StringWriter sw = new StringWriter();
            PrintWriter pw = new PrintWriter(sw, true);
            t.printStackTrace(pw);
            pw.flush();
            sw.flush();
            stackTrace = sw.toString();
        }
        return stackTrace;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15537373" author="garydgregory" created="Fri, 30 Sep 2016 23:13:07 +0000"  >&lt;p&gt;As an aside, could you describe in a separate ticket how your needs could be met through an improvement to the &lt;tt&gt;PatternLayout&lt;/tt&gt;?&lt;br/&gt;
Also, the link in the Javadoc is not reachable (intranet). I&apos;m just curious &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15537384" author="markbowman" created="Fri, 30 Sep 2016 23:16:56 +0000"  >&lt;p&gt;Yes, the link is intranet. I&apos;ll try and get an answer on why we had to hand-roll a layout. It may have more to do with legacy than necessity.&lt;/p&gt;</comment>
                            <comment id="15537413" author="remkop@yahoo.com" created="Fri, 30 Sep 2016 23:34:39 +0000"  >&lt;p&gt;Mark, the problem description of scrambled messages reminded me of &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1583&quot; title=&quot;Nested logging call disrupts output of outer logging call&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1583&quot;&gt;&lt;del&gt;LOG4J2-1583&lt;/del&gt;&lt;/a&gt;. This was tracked down to the objects being logged themselves doing logging from their &lt;tt&gt;toString()&lt;/tt&gt; method, which didn&apos;t play well with some of the mechanisms used to make Log4j garbage-free.  &lt;/p&gt;

&lt;p&gt;That issue has been fixed. Can you try if the problem still occurs with our current master?  &lt;/p&gt;

&lt;p&gt;Another possible cause is that the AsyncLogger ringbuffer is full (could happen if the application logs more than the appender can keep up with) and the AsyncQueueFullPolicy is to log synchronously. This makes Log4j bypass the AsyncLogger queue and send the event straight to the appender, so new and previously queued events appear out of order in the log. &lt;br/&gt;
However, in Log4j 2.6.2 the default AsyncQueueFullPolicy only logs synchronously when the queue is full and logging is attempted from an object&apos;s &lt;tt&gt;toString()&lt;/tt&gt; (to prevent deadlock). From 2.7 the default AsyncQueueFullPolicy will be simplified (see &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1518&quot; title=&quot;Deadlock when using pure async and toString logs another message&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1518&quot;&gt;&lt;del&gt;LOG4J2-1518&lt;/del&gt;&lt;/a&gt;) but will have similar results. &lt;/p&gt;</comment>
                            <comment id="15537432" author="markbowman" created="Fri, 30 Sep 2016 23:43:59 +0000"  >&lt;p&gt;Is their a public repo for nightly-build maven artifacts or do I need to build and install to our local nexus instance?&lt;/p&gt;</comment>
                            <comment id="15537468" author="markbowman" created="Sat, 1 Oct 2016 00:00:50 +0000"  >&lt;p&gt;The core module of log4j2 master doesn&apos;t build for me.&lt;br/&gt;
Failed tests: &lt;br/&gt;
  JeroMqAppenderTest.testClientServer:54 Appender named JeroMQAppender was null in logger context org.apache.logging.log4j.core.LoggerContext@724af044&lt;br/&gt;
  JeroMqAppenderTest.testMultiThreadedServer:81 Appender named JeroMQAppender was null in logger context org.apache.logging.log4j.core.LoggerContext@724af044&lt;br/&gt;
  JeroMqAppenderTest.testServerOnly:129 Appender named JeroMQAppender was null in logger context org.apache.logging.log4j.core.LoggerContext@724af044&lt;/p&gt;</comment>
                            <comment id="15537487" author="remkop@yahoo.com" created="Sat, 1 Oct 2016 00:10:09 +0000"  >&lt;p&gt;You can build with &lt;tt&gt;mvn -DskipTests clean install&lt;/tt&gt;. That is quite a bit faster. &lt;/p&gt;</comment>
                            <comment id="15537567" author="jvz" created="Sat, 1 Oct 2016 00:54:10 +0000"  >&lt;p&gt;Public repo for all apache project snapshots is here: &lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Use version 2.6.3-SNAPSHOT or 2.7.1-SNAPSHOT.&lt;/p&gt;</comment>
                            <comment id="15549365" author="markbowman" created="Wed, 5 Oct 2016 17:09:24 +0000"  >&lt;p&gt;I&apos;m seeing the same behavior with the current master. It might be slightly rarer but I couldn&apos;t swear to it.  &lt;/p&gt;</comment>
                            <comment id="15549412" author="garydgregory" created="Wed, 5 Oct 2016 17:24:18 +0000"  >&lt;p&gt;As a sanity check, are you also seeing the problem if you use the &lt;tt&gt;PatternLayout&lt;/tt&gt; instead of the &lt;tt&gt;LCOGTLayout&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="15549475" author="markbowman" created="Wed, 5 Oct 2016 17:49:06 +0000"  >&lt;p&gt;Just to be clear the problem is not out-of-order messages, it is messages scrambled (presumably) due to simultaneous file access. For example, the second message below has lost the first few dozen characters&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2016-10-04 23:49:02.741 INFO: org.lcogt.jTCS.jTpoint.TpointAgent: org.lcogt.jTCS.jTpoint.TpointAgent: Setting pier adjustment: Lower tail-fixator:0.4mm, Shift front-rail East:0.6mm | {&quot;observatory&quot;:&quot;aqwa&quot;,&quot;path&quot;:&quot;0m4a.aqwa.lsc&quot;,&quot;agent&quot;:&quot;Tpoint&quot;,&quot;site&quot;:&quot;lsc&quot;,&quot;telescope&quot;:&quot;0m4a&quot;}
viour: Exposure time is 10.0 and exp time factor 1.0 | {&quot;observatory&quot;:&quot;domc&quot;,&quot;path&quot;:&quot;ef08&quot;,&quot;site&quot;:&quot;lsc&quot;,&quot;agent&quot;:&quot;ef08&quot;,&quot;tracking_num&quot;:&quot;0000238128&quot;,&quot;request_num&quot;:&quot;0000795735&quot;,&quot;molecule_id&quot;:&quot;236030862&quot;,&quot;telescope&quot;:&quot;1m0a&quot;,&quot;block_id&quot;:&quot;95121483&quot;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15549484" author="markbowman" created="Wed, 5 Oct 2016 17:51:23 +0000"  >&lt;p&gt;I should also add that we are hitting the file about 25 times a second at this point.&lt;/p&gt;</comment>
                            <comment id="15549505" author="markbowman" created="Wed, 5 Oct 2016 17:57:45 +0000"  >&lt;p&gt;That&apos;s actually quite a big ask. The LCOGTLayout formats the messages to be ingested into ElasticSearch. Kibana makes searching for these (very) rare events very easy. If I was to dump the data to file using a Patternlayout I&apos;m not entirely sure I would be able to prove one way or another if the problem exists.&lt;br/&gt;
I&apos;ll have a ponder.&lt;/p&gt;</comment>
                            <comment id="15550864" author="garydgregory" created="Thu, 6 Oct 2016 04:47:02 +0000"  >&lt;p&gt;If you can create a patch for failing unit test, I think I or someone else here can take a stab at it.&lt;/p&gt;</comment>
                            <comment id="15766776" author="remkop@yahoo.com" created="Wed, 21 Dec 2016 11:11:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markbowman&quot; class=&quot;user-hover&quot; rel=&quot;markbowman&quot;&gt;markbowman&lt;/a&gt; I want to take another look at this. To summarize my understanding (please correct if I&apos;m wrong):&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;This is a single process (there are no multiple applications or web apps writing to the same file)&lt;/li&gt;
	&lt;li&gt;The application has multiple threads that log concurrently&lt;/li&gt;
	&lt;li&gt;Messages appear scrambled in the log. Example &lt;b&gt;actual&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2016-10-04 23:49:02.741 INFO: org.lcogt.jTCS.jTpoint.TpointAgent: org.lcogt.jTCS.jTpoint.TpointAgent: Setting pier adjustment: Lower tail-fixator:0.4mm, Shift front-rail East:0.6mm | {&lt;span class=&quot;code-quote&quot;&gt;&quot;observatory&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;aqwa&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;path&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;0m4a.aqwa.lsc&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;agent&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;Tpoint&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;site&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;lsc&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;telescope&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;0m4a&quot;&lt;/span&gt;}
viour: Exposure time is 10.0 and exp time factor 1.0 | {&lt;span class=&quot;code-quote&quot;&gt;&quot;observatory&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;domc&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;path&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;ef08&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;site&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;lsc&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;agent&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;ef08&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;tracking_num&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;0000238128&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;request_num&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;0000795735&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;molecule_id&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;236030862&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;telescope&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1m0a&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;block_id&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;95121483&quot;&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Expected&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2016-10-04 23:49:02.741 INFO: org.lcogt.jTCS.jTpoint.TpointAgent: org.lcogt.jTCS.jTpoint.TpointAgent: Setting pier adjustment: Lower tail-fixator:0.4mm, Shift front-rail East:0.6mm | {&lt;span class=&quot;code-quote&quot;&gt;&quot;observatory&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;aqwa&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;path&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;0m4a.aqwa.lsc&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;agent&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;Tpoint&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;site&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;lsc&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;telescope&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;0m4a&quot;&lt;/span&gt;}
2016-10-04 23:49:02.741 INFO: org.lcogt.jTCS.jTpoint.TpointAgent: org.lcogt.jTCS.jTpoint.TpointAgent XXxxxxx behaviour: Exposure time is 10.0 and exp time factor 1.0 | {&lt;span class=&quot;code-quote&quot;&gt;&quot;observatory&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;domc&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;path&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;ef08&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;site&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;lsc&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;agent&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;ef08&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;tracking_num&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;0000238128&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;request_num&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;0000795735&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;molecule_id&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;236030862&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;telescope&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;1m0a&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;block_id&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;95121483&quot;&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
	&lt;li&gt;I notice that the logger name &lt;tt&gt;org.lcogt.jTCS.jTpoint.TpointAgent&lt;/tt&gt; appears twice. Is that expected behaviour?&lt;/li&gt;
	&lt;li&gt;Does the problem also occur when you use plain &lt;tt&gt;Logger&lt;/tt&gt; in the configuration instead of &lt;tt&gt;AsyncLogger&lt;/tt&gt;?&lt;/li&gt;
	&lt;li&gt;Is it possible to provide a small program that reproduces the issue?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15771467" author="markbowman" created="Fri, 23 Dec 2016 00:23:01 +0000"  >&lt;p&gt;Thanks Remko,&lt;br/&gt;
I can answer some of these now. Other will take some effort.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The file is being written to by multiple applications in different JVMs on multiple hosts. The file is on a shared NFS mount. The file is only accessed via log4j2. My reading of documentation is that this what locking is designed to allow (&lt;a href=&quot;https://logging.apache.org/log4j/2.x/manual/appenders.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://logging.apache.org/log4j/2.x/manual/appenders.html&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;Each application will presumably only log via a single thread because I am using an AsyncLogger, so log4j2 manages the thread doing the actual file access.&lt;/li&gt;
	&lt;li&gt;The scrambling is as you describe&lt;/li&gt;
	&lt;li&gt;The double class path is correct in this instance (usually the classes are different parent: child)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15772238" author="remkop@yahoo.com" created="Fri, 23 Dec 2016 07:50:42 +0000"  >&lt;p&gt;Mark, thanks for the clarification. I have a better idea where to look now. I&apos;ll let you know when I find out more. &lt;/p&gt;

&lt;p&gt;One more question: is &lt;tt&gt;LCOGTLayout&lt;/tt&gt; the only Layout used to write to that file?&lt;/p&gt;</comment>
                            <comment id="15776495" author="remkop@yahoo.com" created="Sun, 25 Dec 2016 13:31:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markbowman&quot; class=&quot;user-hover&quot; rel=&quot;markbowman&quot;&gt;markbowman&lt;/a&gt; It turns out this is a regression caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1343&quot; title=&quot;Update ConsoleAppender to utilize gc-free Layout method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1343&quot;&gt;&lt;del&gt;LOG4J2-1343&lt;/del&gt;&lt;/a&gt;:&lt;br/&gt;
If &lt;a href=&quot;https://logging.apache.org/log4j/2.x/log4j-core/apidocs/org/apache/logging/log4j/core/util/Constants.html#ENABLE_DIRECT_ENCODERS&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;direct encoding&lt;/a&gt; is enabled (true by default), then FileAppender &lt;a href=&quot;https://github.com/apache/logging-log4j2/blob/56aac98b0569531e6af4e7917c053c172ce30c6a/log4j-core/src/main/java/org/apache/logging/log4j/core/appender/AbstractOutputStreamAppender.java#L167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;does not call&lt;/a&gt; the &lt;tt&gt;FileAppender.write&lt;/tt&gt; method where the file is locked.&lt;/p&gt;

&lt;p&gt;In Log4j 2.6 and later, you can work around this issue by setting system property &lt;tt&gt;log4j2.enable.direct.encoders&lt;/tt&gt; to &quot;false&quot;. &lt;/p&gt;

&lt;p&gt;The fix is likely to override &lt;tt&gt;OutputStreamManager.writeToDestination&lt;/tt&gt; in FileManager, and lock the FileChannel in that method, similar to how &lt;a href=&quot;https://github.com/apache/logging-log4j2/blob/dd943975b7c809c3d302237cecf7116c9c9e9ea2/log4j-core/src/main/java/org/apache/logging/log4j/core/appender/FileManager.java#L120&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FileAppender.write&lt;/a&gt; overrides &lt;tt&gt;OutputStreamManager.write&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15776541" author="remkop@yahoo.com" created="Sun, 25 Dec 2016 14:05:22 +0000"  >&lt;p&gt;Fixed in master in commit 556cea0.&lt;/p&gt;

&lt;p&gt;Please verify and close.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 47 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34bpr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>