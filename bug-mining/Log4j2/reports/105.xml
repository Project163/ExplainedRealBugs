<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:31:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-245] EmptyStackException when logging exceptions with Log4J2 in Java 8</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-245</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Note: the description below is the original error report. After analysis it turned out that this problem will happen unconditionally when logging a Throwable on a Java 8 JVM.&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Possibly affects earlier versions, too, but I did not check.&lt;/p&gt;

&lt;p&gt;beta5 and beta6 are both unusable with Spring Framework. Any time an error gets logged through log4j-jcl bridge using Spring, the error below appears in the Tomcat log, masking the error that Spring was trying to log and making it very difficult to figure out what happened. I&apos;ve also included my configuration file below the stack trace. The root error is happening on Tomcat 6 due to Spring bug, and that root problem is unimportant. The important problem is the Log4j error that masks it.&lt;/p&gt;

&lt;p&gt;SEVERE: Exception sending context initialized event to listener instance of class org.springframework.web.context.ContextLoaderListener&lt;br/&gt;
java.util.EmptyStackException&lt;br/&gt;
	at java.util.Stack.peek(Stack.java:102)&lt;br/&gt;
	at org.apache.logging.log4j.core.impl.ThrowableProxy.resolvePackageData(ThrowableProxy.java:339)&lt;br/&gt;
	at org.apache.logging.log4j.core.impl.ThrowableProxy.&amp;lt;init&amp;gt;(ThrowableProxy.java:71)&lt;br/&gt;
	at org.apache.logging.log4j.core.impl.Log4jLogEvent.&amp;lt;init&amp;gt;(Log4jLogEvent.java:110)&lt;br/&gt;
	at org.apache.logging.log4j.core.impl.Log4jLogEvent.&amp;lt;init&amp;gt;(Log4jLogEvent.java:81)&lt;br/&gt;
	at org.apache.logging.log4j.core.config.LoggerConfig.createEvent(LoggerConfig.java:423)&lt;br/&gt;
	at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:344)&lt;br/&gt;
	at org.apache.logging.log4j.core.Logger.log(Logger.java:110)&lt;br/&gt;
	at org.apache.logging.log4j.spi.AbstractLoggerWrapper.log(AbstractLoggerWrapper.java:55)&lt;br/&gt;
	at org.apache.logging.log4j.spi.AbstractLogger.error(AbstractLogger.java:539)&lt;br/&gt;
	at org.springframework.web.context.ContextLoader.initWebApplicationContext(ContextLoader.java:319)&lt;br/&gt;
	at org.springframework.web.context.ContextLoaderListener.contextInitialized(ContextLoaderListener.java:112)&lt;br/&gt;
	at org.apache.catalina.core.StandardContext.listenerStart(StandardContext.java:4765)&lt;br/&gt;
	at org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:5210)&lt;br/&gt;
	at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:150)&lt;br/&gt;
	at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:726)&lt;br/&gt;
	at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:702)&lt;br/&gt;
	at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:698)&lt;br/&gt;
	at org.apache.catalina.startup.HostConfig.manageApp(HostConfig.java:1491)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:491)&lt;br/&gt;
	at org.apache.tomcat.util.modeler.BaseModelMBean.invoke(BaseModelMBean.java:300)&lt;br/&gt;
	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.invoke(DefaultMBeanServerInterceptor.java:819)&lt;br/&gt;
	at com.sun.jmx.mbeanserver.JmxMBeanServer.invoke(JmxMBeanServer.java:792)&lt;br/&gt;
	at org.apache.catalina.mbeans.MBeanFactory.createStandardContext(MBeanFactory.java:468)&lt;br/&gt;
	at org.apache.catalina.mbeans.MBeanFactory.createStandardContext(MBeanFactory.java:415)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:491)&lt;br/&gt;
	at org.apache.tomcat.util.modeler.BaseModelMBean.invoke(BaseModelMBean.java:300)&lt;br/&gt;
	at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.invoke(DefaultMBeanServerInterceptor.java:819)&lt;br/&gt;
	at com.sun.jmx.mbeanserver.JmxMBeanServer.invoke(JmxMBeanServer.java:792)&lt;br/&gt;
	at javax.management.remote.rmi.RMIConnectionImpl.doOperation(RMIConnectionImpl.java:1465)&lt;br/&gt;
	at javax.management.remote.rmi.RMIConnectionImpl.access$300(RMIConnectionImpl.java:75)&lt;br/&gt;
	at javax.management.remote.rmi.RMIConnectionImpl$PrivilegedOperation.run(RMIConnectionImpl.java:1306)&lt;br/&gt;
	at javax.management.remote.rmi.RMIConnectionImpl.doPrivilegedOperation(RMIConnectionImpl.java:1398)&lt;br/&gt;
	at javax.management.remote.rmi.RMIConnectionImpl.invoke(RMIConnectionImpl.java:827)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:491)&lt;br/&gt;
	at sun.rmi.server.UnicastServerRef.dispatch(UnicastServerRef.java:322)&lt;br/&gt;
	at sun.rmi.transport.Transport$1.run(Transport.java:177)&lt;br/&gt;
	at sun.rmi.transport.Transport$1.run(Transport.java:174)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at sun.rmi.transport.Transport.serviceCall(Transport.java:173)&lt;br/&gt;
	at sun.rmi.transport.tcp.TCPTransport.handleMessages(TCPTransport.java:556)&lt;br/&gt;
	at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run0(TCPTransport.java:811)&lt;br/&gt;
	at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run(TCPTransport.java:670)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:724)&lt;/p&gt;

&lt;p&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;&lt;br/&gt;
&amp;lt;configuration status=&quot;WARN&quot;&amp;gt;&lt;br/&gt;
    &amp;lt;appenders&amp;gt;&lt;br/&gt;
        &amp;lt;Console name=&quot;Console&quot; target=&quot;SYSTEM_OUT&quot;&amp;gt;&lt;br/&gt;
            &amp;lt;PatternLayout&lt;br/&gt;
                    pattern=&quot;%d&lt;/p&gt;
{HH:mm:ss.SSS}
&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;%t&amp;#93;&lt;/span&gt; %-5level %logger&lt;/p&gt;
{36} - %msg%n&quot;/&amp;gt;&lt;br/&gt;
        &amp;lt;/Console&amp;gt;&lt;br/&gt;
        &amp;lt;RollingFile name=&quot;WroxFileAppender&quot; fileName=&quot;../logs/application.log&quot;&lt;br/&gt;
                     filePattern=&quot;../logs/application-%d{MM-dd-yyyy}-%i.log&quot;&amp;gt;&lt;br/&gt;
            &amp;lt;PatternLayout&amp;gt;&lt;br/&gt;
                &amp;lt;pattern&amp;gt;%d{HH:mm:ss.SSS} &lt;span class=&quot;error&quot;&gt;&amp;#91;%t&amp;#93;&lt;/span&gt; %X{id} %X{username} %-5level %c{36}
&lt;p&gt; %l: %msg%n&amp;lt;/pattern&amp;gt;&lt;br/&gt;
            &amp;lt;/PatternLayout&amp;gt;&lt;br/&gt;
            &amp;lt;Policies&amp;gt;&lt;br/&gt;
                &amp;lt;SizeBasedTriggeringPolicy size=&quot;10 MB&quot; /&amp;gt;&lt;br/&gt;
            &amp;lt;/Policies&amp;gt;&lt;br/&gt;
            &amp;lt;DefaultRolloverStrategy min=&quot;1&quot; max=&quot;4&quot; /&amp;gt;&lt;br/&gt;
        &amp;lt;/RollingFile&amp;gt;&lt;br/&gt;
    &amp;lt;/appenders&amp;gt;&lt;br/&gt;
    &amp;lt;loggers&amp;gt;&lt;br/&gt;
        &amp;lt;root level=&quot;warn&quot;&amp;gt;&lt;br/&gt;
            &amp;lt;appender-ref ref=&quot;Console&quot; /&amp;gt;&lt;br/&gt;
            &amp;lt;appender-ref ref=&quot;WroxFileAppender&quot; /&amp;gt;&lt;br/&gt;
        &amp;lt;/root&amp;gt;&lt;br/&gt;
        &amp;lt;logger name=&quot;com.wrox&quot; level=&quot;info&quot; /&amp;gt;&lt;br/&gt;
        &amp;lt;logger name=&quot;org.apache&quot; level=&quot;info&quot; /&amp;gt;&lt;br/&gt;
        &amp;lt;logger name=&quot;org.springframework&quot; level=&quot;info&quot; /&amp;gt;&lt;br/&gt;
    &amp;lt;/loggers&amp;gt;&lt;br/&gt;
&amp;lt;/configuration&amp;gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Java 8 (1.8.0-ea-b88)&lt;/p&gt;</environment>
        <key id="12646747">LOG4J2-245</key>
            <summary>EmptyStackException when logging exceptions with Log4J2 in Java 8</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="beamerblvd">Nick Williams</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 May 2013 04:06:35 +0000</created>
                <updated>Tue, 18 Feb 2014 14:06:18 +0000</updated>
                            <resolved>Sun, 12 May 2013 23:49:35 +0000</resolved>
                                    <version>2.0-beta5</version>
                    <version>2.0-beta6</version>
                                    <fixVersion>2.0-beta7</fixVersion>
                                    <component>Core</component>
                    <component>JCL Bridge</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13652881" author="remkop@yahoo.com" created="Thu, 9 May 2013 11:37:49 +0000"  >&lt;p&gt;Nick, if you need something fast, I cannot commit from work, but here is a patch that I believe will fix the issue.&lt;br/&gt;
Can you build and see if this fixes the issue?&lt;/p&gt;

&lt;p&gt;Index: D:/data/workspace-4.2.1/log4j2/core/src/main/java/org/apache/logging/log4j/core/impl/ThrowableProxy.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; D:/data/workspace-4.2.1/log4j2/core/src/main/java/org/apache/logging/log4j/core/impl/ThrowableProxy.java	(revision 1480220)&lt;br/&gt;
+++ D:/data/workspace-4.2.1/log4j2/core/src/main/java/org/apache/logging/log4j/core/impl/ThrowableProxy.java	(working copy)&lt;br/&gt;
@@ -336,19 +336,19 @@&lt;br/&gt;
             stackLength = stackTrace.length;&lt;br/&gt;
         }&lt;br/&gt;
         final StackTracePackageElement[] packageArray = new StackTracePackageElement&lt;span class=&quot;error&quot;&gt;&amp;#91;stackLength&amp;#93;&lt;/span&gt;;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Class&amp;lt;?&amp;gt; clazz = stack.peek();&lt;br/&gt;
+        Class&amp;lt;?&amp;gt; clazz = stack.isEmpty() ? null : stack.peek();&lt;br/&gt;
         ClassLoader lastLoader = null;&lt;br/&gt;
         for (int i = stackLength - 1; i &amp;gt;= 0; --i) {&lt;br/&gt;
             final String className = stackTrace&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.getClassName();&lt;br/&gt;
             // The stack returned from getCurrentStack will be missing entries for  java.lang.reflect.Method.invoke()&lt;br/&gt;
             // and its implementation. The Throwable might also contain stack entries that are no longer&lt;br/&gt;
             // present as those methods have returned.&lt;/li&gt;
	&lt;li&gt;if (className.equals(clazz.getName())) {&lt;br/&gt;
+            if (!stack.isEmpty() &amp;amp;&amp;amp; className.equals(clazz.getName())) 
{
                 final CacheEntry entry = resolvePackageElement(clazz, true);
                 packageArray[i] = entry.element;
                 lastLoader = entry.loader;
                 stack.pop();
-                clazz = stack.peek();
+                clazz = stack.isEmpty() ? null : stack.peek();
             }
&lt;p&gt; else {&lt;br/&gt;
                 if (map.containsKey(className)) {&lt;br/&gt;
                     final CacheEntry entry = map.get(className);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13652884" author="beamerblvd" created="Thu, 9 May 2013 11:49:02 +0000"  >&lt;p&gt;Shouldn&apos;t&lt;/p&gt;

&lt;p&gt;if (!stack.isEmpty() &amp;amp;&amp;amp; className.equals(clazz.getName())) {&lt;/p&gt;

&lt;p&gt;Just be&lt;/p&gt;

&lt;p&gt;if (clazz != null &amp;amp;&amp;amp; className.equals(clazz.getName())) {&lt;/p&gt;

&lt;p&gt;It achieves the same thing but doesn&apos;t involve the overhead of a method call.&lt;/p&gt;

&lt;p&gt;Also, why does this only happen through the JCL bridge? Why doesn&apos;t it happen when I call log.error() with an exception in my code? It seems like knowing  the answer to that question might be important. :-/&lt;/p&gt;</comment>
                            <comment id="13652889" author="remkop@yahoo.com" created="Thu, 9 May 2013 11:57:45 +0000"  >&lt;p&gt;Nick, I could be paranoid but the check against an empty stack guards against the possibility of the call to stack.pop() throwing another EmptyStackException on line 350.&lt;/p&gt;

&lt;p&gt;I don&apos;t think it is caused by JCL bridge. From the stack trace it looks like this is a JMX remote method invocation. Which means that a SecurityManager is set. If on top of that, the sun.reflect.Reflection class could not be loaded, then the Stack object returned by #getCurrentStack() will be an empty Stack object.&lt;/p&gt;

&lt;p&gt;You can confirm my hypothesis by setting status=&quot;DEBUG&quot; in your log4j2.xml config. I suspect you will see this line:&lt;br/&gt;
&quot;sun.reflect.Reflection is not installed&quot;. &lt;/p&gt;</comment>
                            <comment id="13652895" author="remkop@yahoo.com" created="Thu, 9 May 2013 12:12:30 +0000"  >&lt;p&gt;About performance though, I wanted to do some profiling anyway, and this class was already high on my list of Persons Of Interest.&lt;br/&gt;
I won&apos;t know for sure until I&apos;ve done the profiling, but from the looks of it this class is doing quite a bit of (expensive?) work for every single event.&lt;br/&gt;
However, the fruits of all that labor are only enjoyed by configurations with a  RootThrowablePattern &lt;/p&gt;
{&quot;rEx&quot;, &quot;rThrowable&quot;, &quot;rException&quot; }
&lt;p&gt; or an ExtendedThrowablePattern &lt;/p&gt;
{&quot;xEx&quot;, &quot;xThrowable&quot;, &quot;xException&quot; }
&lt;p&gt;.&lt;/p&gt;

&lt;p&gt;I could be wrong and constructing a ThrowableProxy may be quite cheap, I won&apos;t know until I&apos;ve profiled it. But it may be an opportunity for a performance improvement.&lt;/p&gt;</comment>
                            <comment id="13652899" author="beamerblvd" created="Thu, 9 May 2013 12:16:37 +0000"  >&lt;p&gt;You are paranoid &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ... and slightly incorrect:&lt;/p&gt;

&lt;p&gt;1) The way the Stack is created and used here, it is on the Java stack during the execution of the constructor, it is local, it is not held by any other objects, and it cannot be concurrently modified. So there is no danger of stack.pop() throwing another ESE if class != null.&lt;br/&gt;
2) If the Stack WERE a reference shared by other objects (it is not, to be clear), calling stack.isEmpty() again STILL would not guard against an ESE. You would need to synchronize access to the stack to prevent this completely. However, since it&apos;s only local, you don&apos;t need to synchronize.&lt;/p&gt;

&lt;p&gt;Also, that was a good hypothesis, but it did not hold. The reason JMX was being used is that IntelliJ deploys projects using JMX. So I deployed the project and started Tomcat manually, instead, which removed JMX from the equation. Stack trace is different, problem still exists.&lt;/p&gt;

&lt;p&gt;Nick&lt;/p&gt;


&lt;p&gt;SEVERE: Exception sending context initialized event to listener instance of class org.springframework.web.context.ContextLoaderListener&lt;br/&gt;
java.util.EmptyStackException&lt;br/&gt;
	at java.util.Stack.peek(Stack.java:102)&lt;br/&gt;
	at org.apache.logging.log4j.core.impl.ThrowableProxy.resolvePackageData(ThrowableProxy.java:339)&lt;br/&gt;
	at org.apache.logging.log4j.core.impl.ThrowableProxy.&amp;lt;init&amp;gt;(ThrowableProxy.java:71)&lt;br/&gt;
	at org.apache.logging.log4j.core.impl.Log4jLogEvent.&amp;lt;init&amp;gt;(Log4jLogEvent.java:110)&lt;br/&gt;
	at org.apache.logging.log4j.core.impl.Log4jLogEvent.&amp;lt;init&amp;gt;(Log4jLogEvent.java:81)&lt;br/&gt;
	at org.apache.logging.log4j.core.config.LoggerConfig.createEvent(LoggerConfig.java:423)&lt;br/&gt;
	at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:344)&lt;br/&gt;
	at org.apache.logging.log4j.core.Logger.log(Logger.java:110)&lt;br/&gt;
	at org.apache.logging.log4j.spi.AbstractLoggerWrapper.log(AbstractLoggerWrapper.java:55)&lt;br/&gt;
	at org.apache.logging.log4j.spi.AbstractLogger.error(AbstractLogger.java:539)&lt;br/&gt;
	at org.springframework.web.context.ContextLoader.initWebApplicationContext(ContextLoader.java:319)&lt;br/&gt;
	at org.springframework.web.context.ContextLoaderListener.contextInitialized(ContextLoaderListener.java:112)&lt;br/&gt;
	at org.apache.catalina.core.StandardContext.listenerStart(StandardContext.java:4765)&lt;br/&gt;
	at org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:5210)&lt;br/&gt;
	at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:150)&lt;br/&gt;
	at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:726)&lt;br/&gt;
	at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:702)&lt;br/&gt;
	at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:698)&lt;br/&gt;
	at org.apache.catalina.startup.HostConfig.deployDirectory(HostConfig.java:1056)&lt;br/&gt;
	at org.apache.catalina.startup.HostConfig$DeployDirectory.run(HostConfig.java:1610)&lt;br/&gt;
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:724)&lt;/p&gt;</comment>
                            <comment id="13652903" author="remkop@yahoo.com" created="Thu, 9 May 2013 12:27:11 +0000"  >&lt;p&gt;First, did the modification fix the issue?&lt;/p&gt;

&lt;p&gt;Second, (on root cause investigation) if you set status=&quot;DEBUG&quot; in your log4j2.xml config, do you see these lines?&lt;br/&gt;
 sun.reflect.Reflection is not installed&lt;br/&gt;
 Unable to install security manager &amp;lt;exception&amp;gt;&lt;/p&gt;</comment>
                            <comment id="13652908" author="beamerblvd" created="Thu, 9 May 2013 12:36:17 +0000"  >&lt;p&gt;Unfortunately, I cannot easily test the modification because of the environment I&apos;m running in. I&apos;m stuck with what&apos;s in Maven repositories. However, I think we have a bigger problem...&lt;/p&gt;

&lt;p&gt;It is now happening without JCL. ANY time I log a Throwable I&apos;m getting the following ESE. This is a change from a few weeks ago. Also, I set status=&quot;DEBUG&quot; and its output is below the ESE. I do not see &quot;sun.reflect.Reflection is not installed&quot; or &quot;Unable to install security manager,&quot; but I DO see &quot;Jansi is not installed.&quot; Even if your modification DID work (again, I can&apos;t test it), all exceptions logged would be missing data in their stack trace it appears.&lt;/p&gt;

&lt;p&gt;java.util.EmptyStackException&lt;br/&gt;
        at java.util.Stack.peek(Stack.java:102)&lt;br/&gt;
        at org.apache.logging.log4j.core.impl.ThrowableProxy.resolvePackageData(ThrowableProxy.java:339)&lt;br/&gt;
        at org.apache.logging.log4j.core.impl.ThrowableProxy.&amp;lt;init&amp;gt;(ThrowableProxy.java:71)&lt;br/&gt;
        at org.apache.logging.log4j.core.impl.Log4jLogEvent.&amp;lt;init&amp;gt;(Log4jLogEvent.java:110)&lt;br/&gt;
        at org.apache.logging.log4j.core.impl.Log4jLogEvent.&amp;lt;init&amp;gt;(Log4jLogEvent.java:81)&lt;br/&gt;
        at org.apache.logging.log4j.core.config.LoggerConfig.createEvent(LoggerConfig.java:423)&lt;br/&gt;
        at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:344)&lt;br/&gt;
        at org.apache.logging.log4j.core.Logger.log(Logger.java:110)&lt;br/&gt;
        at org.apache.logging.log4j.spi.AbstractLogger.error(AbstractLogger.java:576)&lt;br/&gt;
        at com.wrox.config.Bootstrap.onStartup(Bootstrap.java:21)&lt;br/&gt;
        at org.springframework.web.SpringServletContainerInitializer.onStartup(SpringServletContainerInitializer.java:180)&lt;br/&gt;
        at org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:5199)&lt;br/&gt;
        at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:150)&lt;br/&gt;
        at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:726)&lt;br/&gt;
        at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:702)&lt;br/&gt;
        at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:698)&lt;br/&gt;
        at org.apache.catalina.startup.HostConfig.deployDirectory(HostConfig.java:1056)&lt;br/&gt;
        at org.apache.catalina.startup.HostConfig$DeployDirectory.run(HostConfig.java:1610)&lt;br/&gt;
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)&lt;br/&gt;
        at java.util.concurrent.FutureTask.run(FutureTask.java:262)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:724)&lt;/p&gt;

&lt;p&gt;2013-05-09 07:26:03,309 DEBUG Generated plugins in 0.000018300 seconds&lt;br/&gt;
2013-05-09 07:26:03,310 DEBUG Generated plugins in 0.000012200 seconds&lt;br/&gt;
2013-05-09 07:26:03,311 DEBUG Generated plugins in 0.000014800 seconds&lt;br/&gt;
2013-05-09 07:26:03,312 DEBUG Generated plugins in 0.000012100 seconds&lt;br/&gt;
2013-05-09 07:26:03,313 DEBUG Generated plugins in 0.000025000 seconds&lt;br/&gt;
2013-05-09 07:26:03,313 DEBUG Generated plugins in 0.000012800 seconds&lt;br/&gt;
2013-05-09 07:26:03,314 DEBUG Generated plugins in 0.000011900 seconds&lt;br/&gt;
2013-05-09 07:26:03,315 DEBUG Generated plugins in 0.000012500 seconds&lt;br/&gt;
2013-05-09 07:26:03,316 DEBUG Generated plugins in 0.000015100 seconds&lt;br/&gt;
2013-05-09 07:26:03,318 DEBUG Generated plugins in 0.000018200 seconds&lt;br/&gt;
2013-05-09 07:26:03,319 DEBUG Generated plugins in 0.000015500 seconds&lt;br/&gt;
2013-05-09 07:26:03,320 DEBUG Generated plugins in 0.000015600 seconds&lt;br/&gt;
2013-05-09 07:26:03,320 DEBUG Generated plugins in 0.000013400 seconds&lt;br/&gt;
2013-05-09 07:26:03,321 DEBUG Generated plugins in 0.000013100 seconds&lt;br/&gt;
2013-05-09 07:26:03,322 DEBUG Generated plugins in 0.000013600 seconds&lt;br/&gt;
2013-05-09 07:26:03,323 DEBUG Generated plugins in 0.000012100 seconds&lt;br/&gt;
2013-05-09 07:26:03,334 DEBUG Calling createLayout on class org.apache.logging.log4j.core.layout.PatternLayout for element PatternLayout with params(pattern=&quot;%d&lt;/p&gt;
{HH:mm:ss.SSS}
&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;%t&amp;#93;&lt;/span&gt; %-5level %logger&lt;/p&gt;
{36} - %msg%n&quot;, Configuration(C:\Program Files\Apache Software Foundation\Tomcat 8.0\webapps\java\WEB-INF\classes\log4j2.xml), null, charset=&quot;null&quot;)&lt;br/&gt;
2013-05-09 07:26:03,335 DEBUG Generated plugins in 0.000031700 seconds&lt;br/&gt;
2013-05-09 07:26:03,337 DEBUG Calling createAppender on class org.apache.logging.log4j.core.appender.ConsoleAppender for element Console with params(PatternLayout(%d{HH:mm:ss.SSS} &lt;span class=&quot;error&quot;&gt;&amp;#91;%t&amp;#93;&lt;/span&gt; %-5level %logger{36}
&lt;p&gt; - %msg%n), null, target=&quot;SYSTEM_OUT&quot;, name=&quot;Console&quot;, follow=&quot;null&quot;, suppressExceptions=&quot;null&quot;)&lt;br/&gt;
2013-05-09 07:26:03,339 DEBUG Jansi is not installed&lt;br/&gt;
2013-05-09 07:26:03,340 DEBUG Calling createLayout on class org.apache.logging.log4j.core.layout.PatternLayout for element PatternLayout with params(pattern=&quot;%d&lt;/p&gt;
{HH:mm:ss.SSS}
&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;%t&amp;#93;&lt;/span&gt; %X&lt;/p&gt;
{id} %X{username} %-5level %c{36} %l: %msg%n&quot;, Configuration(C:\Program Files\Apache Software Foundation\Tomcat 8.0\webapps\java\WEB-INF\classes\log4j2.xml), null, charset=&quot;null&quot;)&lt;br/&gt;
2013-05-09 07:26:03,341 DEBUG Calling createPolicy on class org.apache.logging.log4j.core.appender.rolling.SizeBasedTriggeringPolicy for element SizeBasedTriggeringPolicy with params(size=&quot;10 MB&quot;)&lt;br/&gt;
2013-05-09 07:26:03,343 DEBUG Calling createPolicy on class org.apache.logging.log4j.core.appender.rolling.CompositeTriggeringPolicy for element Policies with params(policies={SizeBasedTriggeringPolicy(size=10485760)})&lt;br/&gt;
2013-05-09 07:26:03,344 DEBUG Calling createStrategy on class org.apache.logging.log4j.core.appender.rolling.DefaultRolloverStrategy for element DefaultRolloverStrategy with params(max=&quot;4&quot;, min=&quot;1&quot;, fileIndex=&quot;null&quot;, Configuration(C:\Program Files\Apache Software Foundation\Tomcat 8.0\webapps\java\WEB-INF\classes\log4j2.xml))&lt;br/&gt;
2013-05-09 07:26:03,346 DEBUG Calling createAppender on class org.apache.logging.log4j.core.appender.RollingFileAppender for element RollingFile with params(fileName=&quot;../logs/application.log&quot;, filePattern=&quot;../logs/application-%d{MM-dd-yyyy}-%i.log&quot;, append=&quot;null&quot;, name=&quot;WroxFileAppender&quot;, bufferedIO=&quot;null&quot;, immediateFlush=&quot;null&quot;, Policies(CompositeTriggeringPolicy{SizeBasedTriggeringPolicy(size=10485760)}), DefaultRolloverStrategy(DefaultRolloverStrategy(min=1, max=4)), PatternLayout(%d{HH:mm:ss.SSS} &lt;span class=&quot;error&quot;&gt;&amp;#91;%t&amp;#93;&lt;/span&gt; %X{id}
&lt;p&gt; %X&lt;/p&gt;
{username}
&lt;p&gt; %-5level %c&lt;/p&gt;
{36}
&lt;p&gt; %l: %msg%n),null, suppressExceptions=&quot;null&quot;, advertise=&quot;null&quot;, advertiseURI=&quot;null&quot;, Configuration(C:\Program Files\Apache Software Foundation\Tomcat 8.0\webapps\java\WEB-INF\classes\log4j2.xml))&lt;br/&gt;
2013-05-09 07:26:03,350 DEBUG Starting RollingFileManager ../logs/application.log&lt;br/&gt;
2013-05-09 07:26:03,353 DEBUG Generated plugins in 0.000017900 seconds&lt;br/&gt;
2013-05-09 07:26:03,355 DEBUG Calling createAppenders on class org.apache.logging.log4j.core.config.plugins.AppendersPlugin for element appenders with params(appenders=&lt;/p&gt;
{Console, WroxFileAppender}
&lt;p&gt;)&lt;br/&gt;
2013-05-09 07:26:03,356 DEBUG Generated plugins in 0.000026800 seconds&lt;br/&gt;
2013-05-09 07:26:03,358 DEBUG Calling createAppenderRef on class org.apache.logging.log4j.core.config.AppenderRef for element appender-ref with params(ref=&quot;Console&quot;, level=&quot;null&quot;, null)&lt;br/&gt;
2013-05-09 07:26:03,360 DEBUG Calling createAppenderRef on class org.apache.logging.log4j.core.config.AppenderRef for element appender-ref with params(ref=&quot;WroxFileAppender&quot;, level=&quot;null&quot;, null)&lt;br/&gt;
2013-05-09 07:26:03,362 DEBUG Calling createLogger on class org.apache.logging.log4j.core.config.LoggerConfig$RootLogger for element root with params(additivity=&quot;null&quot;, level=&quot;warn&quot;, includeLocation=&quot;null&quot;, appender-ref=&lt;/p&gt;
{org.apache.logging.log4j.core.config.AppenderRef@39f14d85, org.apache.logging.log4j.core.config.AppenderRef@15fc1bda}
&lt;p&gt;, properties={}, Configuration(C:\Program Files\Apache Software Foundation\Tomcat 8.0\webapps\java\WEB-INF\classes\log4j2.xml), null)&lt;br/&gt;
2013-05-09 07:26:03,364 DEBUG Calling createLogger on class org.apache.logging.log4j.core.config.LoggerConfig for element logger with params(additivity=&quot;null&quot;,level=&quot;info&quot;, name=&quot;com.wrox&quot;, includeLocation=&quot;null&quot;, appender-ref={}, properties={}, Configuration(C:\Program Files\Apache Software Foundation\Tomcat 8.0\webapps\java\WEB-INF\classes\log4j2.xml), null)&lt;br/&gt;
2013-05-09 07:26:03,366 DEBUG Calling createLogger on class org.apache.logging.log4j.core.config.LoggerConfig for element logger with params(additivity=&quot;null&quot;,level=&quot;info&quot;, name=&quot;org.apache&quot;, includeLocation=&quot;null&quot;, appender-ref={}, properties={}, Configuration(C:\Program Files\Apache Software Foundation\Tomcat 8.0\webapps\java\WEB-INF\classes\log4j2.xml), null)&lt;br/&gt;
2013-05-09 07:26:03,370 DEBUG Calling createLogger on class org.apache.logging.log4j.core.config.LoggerConfig for element logger with params(additivity=&quot;null&quot;,level=&quot;info&quot;, name=&quot;org.springframework&quot;, includeLocation=&quot;null&quot;, appender-ref={}, properties={}, Configuration(C:\Program Files\Apache Software Foundation\Tomcat 8.0\webapps\java\WEB-INF\classes\log4j2.xml), null)&lt;br/&gt;
2013-05-09 07:26:03,372 DEBUG Calling createLoggers on class org.apache.logging.log4j.core.config.plugins.LoggersPlugin for element loggers with params(loggers=&lt;/p&gt;
{root, com.wrox, org.apache, org.springframework}
&lt;p&gt;)&lt;br/&gt;
2013-05-09 07:26:03,375 DEBUG Reconfiguration completed&lt;/p&gt;</comment>
                            <comment id="13652913" author="beamerblvd" created="Thu, 9 May 2013 12:44:33 +0000"  >&lt;p&gt;Okay, I think I&apos;ve narrowed it down. Two weeks ago I could log Throwables using beta5. Today I can&apos;t log Throwables using beta5. The only difference is my JVM has been upgraded from 1.8.0-ea-b86 to 1.8.0-ea-b88.&lt;/p&gt;

&lt;p&gt;It appears that Java 8 has changed something that makes this class not work. It will need to be updated to work with Java 8. I&apos;m not sure exactly what that is. I&apos;ll examine the code some and see if I can&apos;t figure it out.&lt;/p&gt;</comment>
                            <comment id="13652915" author="beamerblvd" created="Thu, 9 May 2013 12:52:49 +0000"  >&lt;p&gt;By the way, my JVM /does/ have a class sun.reflect.Reflection and that class /does/ have a public static method called getCallerClass. So I&apos;m not sure how the stack is ever empty.&lt;/p&gt;</comment>
                            <comment id="13652927" author="remkop@yahoo.com" created="Thu, 9 May 2013 12:59:47 +0000"  >&lt;p&gt;Interesting.&lt;br/&gt;
I originally thought that the Stack could only be empty if both the sun.reflect.Reflection class could not be loaded and PrivateSecurityManager could not be installed.&lt;/p&gt;

&lt;p&gt;However other reasons the Stack could end up empty (at least in theory) are:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Reflection.getCallerClass fails with an exception. This exception is currently ignored and not logged... The patch should probably address this too?&lt;/li&gt;
	&lt;li&gt;PrivateSecurityManager.getClasses returns an empty array.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13652933" author="beamerblvd" created="Thu, 9 May 2013 13:06:31 +0000"  >&lt;p&gt;GOT IT!&lt;/p&gt;

&lt;p&gt;In Java &amp;lt;= 7, the signature of this method was:&lt;/p&gt;

&lt;p&gt;public static native java.lang.Class&amp;lt;?&amp;gt; getCallerClass(int realFramesToSkip)&lt;/p&gt;

&lt;p&gt;In Java 8 it has been changed to:&lt;/p&gt;

&lt;p&gt;public static native java.lang.Class&amp;lt;?&amp;gt; getCallerClass()&lt;/p&gt;

&lt;p&gt;(You can&apos;t skip frames anymore.)&lt;/p&gt;

&lt;p&gt;When ThrowableProxy tries to invoke getCallerClass(), it fails with a &quot;wrong number of arguments&quot; reflection exception. In the code, this exception is caught and ignored:&lt;/p&gt;

&lt;p&gt;try {&lt;br/&gt;
    final Object[] params = new Object[]&lt;/p&gt;
{index}
&lt;p&gt;;&lt;br/&gt;
    return (Class&amp;lt;?&amp;gt;) getCallerClass.invoke(null, params);&lt;br/&gt;
} catch (final Exception ex) {&lt;br/&gt;
    // logger.debug(&quot;Unable to determine caller class via Sun Reflection&quot;, ex);&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;Never mind for a minute that ignoring this exception is bad, that&apos;s the root cause. This class will need to test the number of arguments getCallerClass takes, and either 1) not use it if it doesn&apos;t take exactly one argument or 2) use it differently. In either case, the stack should still be checked for emptiness. 1) Can be accomplished by changing this:&lt;/p&gt;

&lt;p&gt;if (method.getName().equals(&quot;getCallerClass&quot;) &amp;amp;&amp;amp; Modifier.isStatic(modifier)) {&lt;/p&gt;

&lt;p&gt;To this:&lt;/p&gt;

&lt;p&gt;if (method.getName().equals(&quot;getCallerClass&quot;) &amp;amp;&amp;amp; Modifier.isStatic(modifier) &amp;amp;&amp;amp; method.getParameterTypes().length == 1 &amp;amp;&amp;amp; method.getParameterTypes()&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; == int.class) {&lt;/p&gt;</comment>
                            <comment id="13652943" author="beamerblvd" created="Thu, 9 May 2013 13:11:11 +0000"  >&lt;p&gt;Really, that whole looping-through-methods things is inefficient:&lt;/p&gt;

&lt;p&gt;final Method[] methods = clazz.getMethods();&lt;br/&gt;
for (final Method method : methods) {&lt;/p&gt;

&lt;p&gt;It should just be this:&lt;/p&gt;

&lt;p&gt;getCallerClass = clazz.getMethod(&quot;getCallerClass&quot;, int.class);&lt;/p&gt;

&lt;p&gt;And then catch the exceptions (meaning method doesn&apos;t exist). If we want to try using the new Java 8 version of getCallerClass, in the catch we could then do this:&lt;/p&gt;

&lt;p&gt;getCallerClass = clazz.getMethod(&quot;getCallerClass&quot;);&lt;/p&gt;

&lt;p&gt;And further catch the exceptions (meaning that method doesn&apos;t exist, either). This would be way more efficient (and less fragile) than looping over methods...&lt;/p&gt;</comment>
                            <comment id="13652979" author="garydgregory" created="Thu, 9 May 2013 14:07:44 +0000"  >&lt;p&gt;Why are we using reflection in the first place?&lt;/p&gt;</comment>
                            <comment id="13652990" author="beamerblvd" created="Thu, 9 May 2013 14:37:17 +0000"  >&lt;p&gt;I think the more pertinent question is, why are we using sun.* classes in the first place?&lt;/p&gt;

&lt;p&gt;Classes in sun.* are not guaranteed to be in every JVM. In fact, they will NOT be in certain JVMs like Azul Systems&apos; JVM. As such, you&apos;re not supposed to write code against sun.* classes.&lt;/p&gt;

&lt;p&gt;I assume that, in this case, we&apos;re using this class because it offers some performance benefit over getting stack information a supported way. I don&apos;t necessarily disagree with that, if that&apos;s the case. Performance benefits are definitely good and sometimes warrant doing something like this, as long as there&apos;s a backup in case the class doesn&apos;t exist. sun.reflect.Reflection seems to have been a relatively stable, universal class over the past 4 or 5 versions, until Java 8.&lt;/p&gt;

&lt;p&gt;If we DO continue to use this class because it creates a performance benefit, we HAVE to use reflection if we don&apos;t want to get a NoClassDefFoundError on non-supported JVMs.&lt;/p&gt;</comment>
                            <comment id="13653006" author="ralph.goers@dslextreme.com" created="Thu, 9 May 2013 15:12:45 +0000"  >&lt;p&gt;The performance benefit of using this class is at least an order of magnitude.  I did lots of testing which is why it uses the Reflection class first if it can, then the SecurityManager.&lt;/p&gt;</comment>
                            <comment id="13653017" author="remkop@yahoo.com" created="Thu, 9 May 2013 15:43:24 +0000"  >&lt;p&gt;I was going to commit a change (like the patch above) to add defensive code that checks if the Stack is empty,&lt;br/&gt;
but this would hide the root cause that the Reflection.getCallerClass method signature has changed.&lt;br/&gt;
(And it would hide other potential issues as well.)&lt;/p&gt;

&lt;p&gt;I guess we should fix the Reflection.getCallerClass code so that it works with both Java8 and older.&lt;br/&gt;
Then after that, what to do with empty Stacks? &lt;br/&gt;
Add defensive code to prevent EmptyStackExceptions, or check at the top of the method and throw an (IllegalArgument, IllegalState or other) exception if the stack is empty?&lt;/p&gt;</comment>
                            <comment id="13653018" author="beamerblvd" created="Thu, 9 May 2013 15:44:25 +0000"  >&lt;p&gt;You can view the change made to the getCallerClass method here: &lt;a href=&quot;http://hg.openjdk.java.net/jdk8/jdk8/jdk/rev/da6addef956e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hg.openjdk.java.net/jdk8/jdk8/jdk/rev/da6addef956e&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The way it works was completely changed. It maybe shouldn&apos;t even have the same name. Everywhere this method was used in the JVM was calling it a single time with a constant value passed to it (and almost all of those values were 3), which is different from how we&apos;re using it (in a loop, incrementing the depth). They added a @sun.reflect.CallerSensitive annotation and changed getCallerClass to keep going back up the stack until it found a method without that annotation, so the depth parameter was no longer needed. They furthermore changed the native code so that there is no replacement for what we were doing.&lt;/p&gt;

&lt;p&gt;I&apos;m going to add an enhancement request on the JDK project to create a replacement for it. It probably won&apos;t get accepted, but we&apos;ll see. For now, this class needs to get changed to:&lt;/p&gt;

&lt;p&gt;1) Not use getCallerClass unless (method.getName().equals(&quot;getCallerClass&quot;) &amp;amp;&amp;amp; Modifier.isStatic(modifier) &amp;amp;&amp;amp; method.getParameterTypes().length == 1 &amp;amp;&amp;amp; method.getParameterTypes()&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; == int.class)&lt;/p&gt;

&lt;p&gt;2) Use isEmpty() before peek() and add change (className.equals(clazz.getName())) to (clazz != null &amp;amp;&amp;amp; className.equals(clazz.getName())).&lt;/p&gt;</comment>
                            <comment id="13653022" author="garydgregory" created="Thu, 9 May 2013 15:50:04 +0000"  >&lt;p&gt;FWIW: sun.* classes will not work on IBM JVMs too.&lt;/p&gt;</comment>
                            <comment id="13653025" author="beamerblvd" created="Thu, 9 May 2013 16:00:15 +0000"  >&lt;p&gt;Just so I understand (which will help me file the enhancement request), what are we doing with this stack? It&apos;s not completely clear to me.&lt;/p&gt;</comment>
                            <comment id="13653031" author="remkop@yahoo.com" created="Thu, 9 May 2013 16:12:49 +0000"  >&lt;p&gt;Same question as Nick...&lt;br/&gt;
Will the #resolvePackageData method still work correctly if the Stack is empty (after we add defensive code to prevent the EmptyStackException)?&lt;br/&gt;
I don&apos;t understand the code well enough to answer that question.&lt;/p&gt;</comment>
                            <comment id="13653037" author="beamerblvd" created="Thu, 9 May 2013 16:18:26 +0000"  >&lt;p&gt;Yea, I don&apos;t understand what extra information we&apos;re getting that Thread#getStackTrace() / Throwable#getStackTrace() doesn&apos;t provide. This doesn&apos;t appear to be a substitute for *#getStackTrace(), since we&apos;re using both that AND the getCallerClass method.&lt;/p&gt;</comment>
                            <comment id="13653088" author="beamerblvd" created="Thu, 9 May 2013 19:37:21 +0000"  >&lt;p&gt;Okay, I&apos;ve done a little analysis. First, it appears that the goal here is to include more information in the output stack trace than just:&lt;/p&gt;

&lt;p&gt;package.Class.method(File:line)&lt;/p&gt;

&lt;p&gt;It appears whoever wrote this actually wanted:&lt;/p&gt;

&lt;p&gt;package.Class.method(File:line) jar-or-dir:implementation-version&lt;/p&gt;

&lt;p&gt;Those last two bits you can&apos;t get from the StackTraceElement. You can only get them from the Class. Since loading the Class from a String isn&apos;t very efficient (read: is very slow), the goal was to use getCallerClass (or the security manager) to get a stack of classes instead of a stack of StackTraceElements. A cache was put in place to improve things, but getCallerClass still makes it better.&lt;/p&gt;

&lt;p&gt;Now, if I have misunderstood anything here, please let me know, because the rest of this might not be pertinent. Assuming I&apos;m right...&lt;/p&gt;

&lt;p&gt;The first thing I noticed is that Throwable#getStackTrace() and Reflection#getCallerClass(in loop) will not return the same stack! They will have different classes, or classes out of order. The stacks will only match up to a certain point, and then they will stop matching and you&apos;ll revert to loading classes manually. Maybe this is okay and was understood, but I&apos;m not sure how much good it&apos;s doing.&lt;/p&gt;

&lt;p&gt;The second thing that caught my eyes was this:&lt;/p&gt;

&lt;p&gt;if (source != null) {&lt;br/&gt;
    final URL locationURL = source.getLocation();&lt;br/&gt;
    if (locationURL != null) {&lt;br/&gt;
        final String str = locationURL.toString().replace(&apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;, &apos;/&apos;);&lt;br/&gt;
        int index = str.lastIndexOf(&quot;/&quot;);&lt;br/&gt;
        if (index &amp;gt;= 0 &amp;amp;&amp;amp; index == str.length() - 1) &lt;/p&gt;
{
            index = str.lastIndexOf(&quot;/&quot;, index - 1);
            location = str.substring(index + 1);
        }
&lt;p&gt; else &lt;/p&gt;
{
            location = str.substring(index + 1);
        }
&lt;p&gt;    }&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;I think the performance of this can be improved (please check my syntax):&lt;/p&gt;

&lt;p&gt;if (source != null) {&lt;br/&gt;
    final URL locationURL = source.getLocation();&lt;br/&gt;
    if (locationURL != null) &lt;/p&gt;
{
        // split without limit trims off empty parts, so no need to worry about URL ending in slash
        final String[] parts = locationURL.toString().split(&quot;(\\\\|\\/)&quot;);
        location = parts[ parts.length - 1];
    }
&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;I believe that&apos;s an improvement. (I could be wrong; regular expressions aren&apos;t always the answer.)&lt;/p&gt;

&lt;p&gt;By the way, I created this: &lt;a href=&quot;http://mail.openjdk.java.net/pipermail/java-se-8-spec-comments/2013-May/000014.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail.openjdk.java.net/pipermail/java-se-8-spec-comments/2013-May/000014.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13653100" author="ralph.goers@dslextreme.com" created="Thu, 9 May 2013 19:47:52 +0000"  >&lt;p&gt;&quot;whoever wrote it&quot; is me.  Yes, your understanding seems correct. This is to emulate the extended stack trace Logback provides. It is actually quite handy to have this information when it is available. As I recall, getCallerClass skips certain classes, so I believe the code was written to understand that.  I don&apos;t recall them being in different orders - just that one returns the full stack and the other doesn&apos;t. So the code synchs them up after it finds a gap. &lt;/p&gt;

&lt;p&gt;I&apos;ll have to look at the code above to figure out if it is OK.&lt;/p&gt;</comment>
                            <comment id="13653103" author="garydgregory" created="Thu, 9 May 2013 19:50:28 +0000"  >&lt;p&gt;Tangent: What about making those &quot;last two bits&quot; optional? You&apos;d have to ask for them in your layout to get them.&lt;/p&gt;</comment>
                            <comment id="13653129" author="beamerblvd" created="Thu, 9 May 2013 20:16:48 +0000"  >&lt;p&gt;Re Gary&apos;s suggestion: I tend to agree with this.&lt;/p&gt;

&lt;p&gt;Ralph, don&apos;t bother checking my code, it is not okay. I did some bench marking and it did not perform nearly as well as your original code. Measure is nanoseconds per iteration over 100,000 iterations.&lt;/p&gt;

&lt;p&gt;Original code, using replace/indexOf:&lt;br/&gt;
no trailing slash: ~1000 nanoseconds&lt;br/&gt;
trailing slash: ~1100 nanosoconds&lt;/p&gt;

&lt;p&gt;My code, exactly as above:&lt;br/&gt;
no trailing slash: ~5500 nanoseconds&lt;br/&gt;
trailing slash: ~6500 nanoseconds&lt;/p&gt;

&lt;p&gt;Modified version of my code, compiling regex first:&lt;br/&gt;
no trailing slash: ~3200 nanoseconds&lt;br/&gt;
trailing slash: ~3400 nanoseconds&lt;/p&gt;</comment>
                            <comment id="13653137" author="ralph.goers@dslextreme.com" created="Thu, 9 May 2013 20:21:33 +0000"  >&lt;p&gt;I&apos;ll see if I can look into this in the next few days and see what can be done to support Java 8. To be honest, I&apos;ve not even downloaded it yet.&lt;/p&gt;</comment>
                            <comment id="13653162" author="beamerblvd" created="Thu, 9 May 2013 20:37:53 +0000"  >&lt;p&gt;Ralph, I need to correct something you said. The result of calling getCallerClass() will almost never return the same stack trace as Throwable#getStackTrace() in &quot;the real world,&quot; even if you account for the gaps; but you&apos;re right, it won&apos;t have different /order/. Consider this stack:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Thread.run()&lt;/li&gt;
	&lt;li&gt;Parent.teach()&lt;/li&gt;
	&lt;li&gt;ClassA.foo()&lt;/li&gt;
	&lt;li&gt;ClassB.bar()&lt;/li&gt;
	&lt;li&gt;Child.misbehave() throws PitchFitException&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Here, Parent#teach() catches the exception thrown in Child#misbehave(). The stack trace is:&lt;/p&gt;

&lt;p&gt;PitchFitException: I want my money now!&lt;br/&gt;
    at Child.misbehave()&lt;br/&gt;
    at ClassB.bar()&lt;br/&gt;
    at ClassA.foo()&lt;br/&gt;
    at Parent.teach()&lt;br/&gt;
    at Thread.run()&lt;/p&gt;

&lt;p&gt;Now Parent#teach() calls Logger#error(&quot;Message&quot;, e); When ThrowableProxy is created and calls getCallingClass, the stack looks like this:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Thread.run()&lt;/li&gt;
	&lt;li&gt;Parent.teach()&lt;/li&gt;
	&lt;li&gt;Logger.error()&lt;/li&gt;
	&lt;li&gt;Logger.log()&lt;/li&gt;
	&lt;li&gt;CoreClass.doSomething()&lt;/li&gt;
	&lt;li&gt;ThrowableProxy.&amp;lt;init&amp;gt;()&lt;/li&gt;
	&lt;li&gt;ThrowableProxy.getCurrentStack()&lt;/li&gt;
	&lt;li&gt;Reflection.getCallingClass()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;As a result, the java.util.Stack creating from calling getCallingClass looks like this:&lt;/p&gt;

&lt;p&gt;Reflection&lt;br/&gt;
ThrowableProxy&lt;br/&gt;
ThrowableProxy&lt;br/&gt;
CoreClass&lt;br/&gt;
Logger&lt;br/&gt;
Logger&lt;br/&gt;
Parent&lt;br/&gt;
Thread&lt;/p&gt;

&lt;p&gt;When the code runs to line them up, it will only match Thread and Parent. All the other classes it will have to look up manually. In the best case scenario, only 2 or 3 elements of the stack trace will have to be looked up &quot;the hard way.&quot; In the worst case scenario, you have 3 or 4 causes and each has 30 or 40 elements that have to be looked up the hard way.&lt;/p&gt;

&lt;p&gt;If you test this in a simple program, it will APPEAR to perform much better because you&apos;re creating the Exception in the same method that you&apos;re creating the ThrowableProxy, so ALL of the stack will line up. But in the real world, the exception stack trace will look very different from the real stack trace, and this performance-improving code won&apos;t do a whole lot, IMO.&lt;/p&gt;

&lt;p&gt;Does that make sense?&lt;/p&gt;</comment>
                            <comment id="13653376" author="remkop@yahoo.com" created="Thu, 9 May 2013 23:25:57 +0000"  >&lt;p&gt;I created &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-250&quot; title=&quot;(TBD) Refactor Log4jLogEvent to lazily create ThrowableProxy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-250&quot;&gt;&lt;del&gt;LOG4J2-250&lt;/del&gt;&lt;/a&gt; to separate the performance concerns of ThrowableProxy from the original issue (the EmptyStackException).&lt;/p&gt;</comment>
                            <comment id="13653378" author="remkop@yahoo.com" created="Thu, 9 May 2013 23:30:08 +0000"  >&lt;p&gt;With regards to what would be the correct defensive code if the Stack is empty (for any reason):&lt;/p&gt;

&lt;p&gt;Does the above analysis mean that the #resolvePackageData method will not work properly if the Stack is empty (even if we prevent EmptyStackExceptions)?&lt;br/&gt;
If that is the case, perhaps we should check at the top of the #resolvePackageData method and return an empty StackTracePackageElement[] if the Stack is empty.&lt;/p&gt;</comment>
                            <comment id="13653386" author="beamerblvd" created="Thu, 9 May 2013 23:34:36 +0000"  >&lt;p&gt;No. If the stack is empty, it will get this information the slower way (Class.forName). If you return an empty array here, the whole class will stop working altogether. The original plan (stack.isEmpty() before stack.peek(), clazz != null &amp;amp;&amp;amp; ...) is still the correct fix.&lt;/p&gt;</comment>
                            <comment id="13653416" author="remkop@yahoo.com" created="Fri, 10 May 2013 00:15:40 +0000"  >&lt;p&gt;Updated Title, Environment and Description of this JIRA ticket to make it easier to find for other users encountering the same problem.&lt;/p&gt;</comment>
                            <comment id="13655681" author="ralph.goers@dslextreme.com" created="Sun, 12 May 2013 23:49:35 +0000"  >&lt;p&gt;I have prevented the EmptyStack exception in revision 1481671. I also added a check for a single parameter to getCallerClass so it will not be found in Java 8.  I have not found an equivalent replacement in Java 8 yet.&lt;/p&gt;</comment>
                            <comment id="13661371" author="beamerblvd" created="Sat, 18 May 2013 15:13:10 +0000"  >&lt;p&gt;I verified that the revision stops the EmptyStackException in Java 8. In theory this issue can be closed, unless you want to leave it open as a reminder to look for Java 8 alternatives to getCallerClass at a later date.&lt;/p&gt;</comment>
                            <comment id="13827516" author="max.larsson" created="Wed, 20 Nov 2013 10:23:47 +0000"  >&lt;p&gt;I have the same problem under a different environment. I&apos;m using a Mac with JDK 1.7.0_45 (Oracle), which shows the same behavior as describe here, except that the issue still exist in the 2.0-beta9.&lt;/p&gt;

&lt;p&gt;Some background information we used Java 6 and log4j 2.0-beta4 and migrated over to Java 7 and stumbled over this issue. After reading through all the related information about this issues, we updated log4j to 2.0-beat9. Still the issue is existent. I cannot say for sure if it is the same cause as described here, but as long i can judge i would yes. That&apos;s why i comment here and doesn&apos;t open a new issue. BTW using again Java 6 doesn&apos;t expose this behavior.&lt;/p&gt;</comment>
                            <comment id="13885070" author="beamerblvd" created="Wed, 29 Jan 2014 06:39:07 +0000"  >&lt;p&gt;Max, I cannot replicate this in Java 1.7.0_45 or Java 8 on my Mac. Are you sure that you have deleted ALL beta4 JARs and replaced them with beta9 JARs?&lt;/p&gt;</comment>
                            <comment id="13904066" author="max.larsson" created="Tue, 18 Feb 2014 14:06:18 +0000"  >&lt;p&gt;Nick, your right. After a long time searching, we found that a deprecated library developed by use put a beta4 jar on the release class path. Nevertheless until we found that, we could even reproduced it under Linux.&lt;br/&gt;
Thanks for your effort, and sorry for the false report.&lt;/p&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12646914">LOG4J2-250</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>327105</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 40 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1kft3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>327449</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>