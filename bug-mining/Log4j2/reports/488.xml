<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:33:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1025] Custom java.util.logging.Level gives null Log4j Level and causes NPE</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1025</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;I use a 3rd party library which uses custom non-standard java.util.logging.Level.&lt;/p&gt;

&lt;p&gt;The Log4j JUL adapter will emit log event with level set to null in that case, which causes NullPointerException in a Log4j filter further on.&lt;/p&gt;

&lt;p&gt;This is not acceptable. When encountering an unrecognised JUL Level, the JUL adapter should either: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;emit some default Log4j Level&lt;/li&gt;
	&lt;li&gt;throw an Exception with a clear error message immediately&lt;/li&gt;
	&lt;li&gt;silently discard the log event&lt;/li&gt;
	&lt;li&gt;discard the log event and log a warning to the StatusLogger&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; java.lang.NullPointerException
        at org.apache.logging.log4j.Level.isMoreSpecificThan(Level.java:163)
        at org.apache.logging.log4j.core.filter.BurstFilter.filter(BurstFilter.java:129)
        at org.apache.logging.log4j.core.filter.BurstFilter.filter(BurstFilter.java:101)
        at org.apache.logging.log4j.core.Logger$PrivateConfig.filter(Logger.java:295)
        at org.apache.logging.log4j.core.Logger.isEnabled(Logger.java:122)
        at org.apache.logging.log4j.spi.ExtendedLoggerWrapper.isEnabled(ExtendedLoggerWrapper.java:87)
        at org.apache.logging.log4j.spi.AbstractLogger.logIfEnabled(AbstractLogger.java:699)
        at org.apache.logging.log4j.jul.WrappedLogger.log(WrappedLogger.java:50)
        at org.apache.logging.log4j.jul.ApiLogger.log(ApiLogger.java:106)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12831745">LOG4J2-1025</key>
            <summary>Custom java.util.logging.Level gives null Log4j Level and causes NPE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mikaelstaldal">Mikael St&#229;ldal</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 May 2015 14:34:51 +0000</created>
                <updated>Sat, 13 Jun 2015 17:03:16 +0000</updated>
                            <resolved>Tue, 2 Jun 2015 18:33:40 +0000</resolved>
                                    <version>2.3</version>
                                    <fixVersion>2.4</fixVersion>
                                    <component>JUL adapter</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14554378" author="mikaelstaldal" created="Thu, 21 May 2015 14:45:54 +0000"  >&lt;p&gt;The documentation says:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Using the default LevelConverter implementation, custom logging levels are mapped to whatever the current level of the Logger being logged to is using. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;but that does not seems to be the case.&lt;/p&gt;</comment>
                            <comment id="14554729" author="garydgregory" created="Thu, 21 May 2015 17:48:27 +0000"  >&lt;p&gt;Changed &quot;Affects version&quot; from 2.3 to 2.4 since 2.4 is not out yet!&lt;/p&gt;</comment>
                            <comment id="14554732" author="garydgregory" created="Thu, 21 May 2015 17:50:13 +0000"  >&lt;p&gt;You can fix this today by specifying the system property &lt;tt&gt;log4j.jul.levelConverter&lt;/tt&gt; to a custom implementation of &lt;tt&gt;org.apache.logging.log4j.jul.LevelConverter&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;It&apos;s not clear to me yet what the &lt;tt&gt;org.apache.logging.log4j.jul.DefaultLevelConverter&lt;/tt&gt; should do, I&apos;ll take a look though.&lt;/p&gt;</comment>
                            <comment id="14554967" author="garydgregory" created="Thu, 21 May 2015 20:12:05 +0000"  >&lt;p&gt;A smarter converter, perhaps a subclass of &lt;tt&gt;DefaultLevelConverter&lt;/tt&gt; could map the custom level&apos;s int to the closest JUL level and map from there. This would be a &quot;rounding&quot; converter. I am not sure if this functionality should be in the &lt;tt&gt;DefaultLevelConverter&lt;/tt&gt;. Another option would be for a client app to call some Log4j class to register custom levels, that seems like going to deep into Log4j code so this could be done through configuration. This would still not handle &quot;unknown&quot; custom levels. So a &quot;dynamic rounding level converter&quot; sounds like the best solution. Whether or not this should be built in to the &lt;tt&gt;DefaultLevelConverter&lt;/tt&gt; or in a new &lt;tt&gt;DynamicRoundingLevelConverter&lt;/tt&gt; class is the question.&lt;/p&gt;

&lt;p&gt;Thoughts? Patches?&lt;/p&gt;

&lt;p&gt;Gary&lt;/p&gt;</comment>
                            <comment id="14555781" author="mikaelstaldal" created="Fri, 22 May 2015 07:47:38 +0000"  >&lt;p&gt;In any case, I would suggest to add a null check in &lt;tt&gt;org.apache.logging.log4j.jul.LevelTranslator#toLevel()&lt;/tt&gt; to make sure we never pass along any log event with &lt;tt&gt;null&lt;/tt&gt; level.&lt;/p&gt;</comment>
                            <comment id="14566161" author="garydgregory" created="Sat, 30 May 2015 19:39:01 +0000"  >&lt;p&gt;How would that solve anything? I see:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    /**
     * Converts a JDK logging Level to a Log4j logging Level.
     *
     * @param level JDK Level to convert.
     * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; converted Level.
     */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Level toLevel(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; java.util.logging.Level level) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; LEVEL_CONVERTER.toLevel(level);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The method still hasto return something &lt;em&gt;and&lt;/em&gt; the level converter should be able to handle &lt;tt&gt;null&lt;/tt&gt; by providing, for example, a configurable default.&lt;/p&gt;

&lt;p&gt;Am I missing something?&lt;/p&gt;</comment>
                            <comment id="14566163" author="garydgregory" created="Sat, 30 May 2015 19:40:57 +0000"  >&lt;p&gt;Right now, I am thinking that if there is no mapping, the int level should be rounded down to the next level.&lt;/p&gt;</comment>
                            <comment id="14567062" author="mikaelstaldal" created="Mon, 1 Jun 2015 08:24:48 +0000"  >&lt;p&gt;A method does not have to return something, it can throw an exception.&lt;/p&gt;</comment>
                            <comment id="14567515" author="garydgregory" created="Mon, 1 Jun 2015 16:26:25 +0000"  >&lt;p&gt;This patch maps custom JUL levels to their nearest default Log4j Levels.&lt;/p&gt;

&lt;p&gt;Looking for feedback...&lt;/p&gt;</comment>
                            <comment id="14567548" author="mikaelstaldal" created="Mon, 1 Jun 2015 16:40:44 +0000"  >&lt;p&gt;I think we have a potential thread safety issue on the julToLog4j map now.&lt;/p&gt;</comment>
                            <comment id="14569541" author="garydgregory" created="Tue, 2 Jun 2015 18:33:40 +0000"  >&lt;p&gt;The &lt;tt&gt;org.apache.logging.log4j.jul.DefaultLevelConverter&lt;/tt&gt; now maps custom JUL levels to their nearest default mappings.&lt;/p&gt;

&lt;p&gt;See &lt;tt&gt;org.apache.logging.log4j.jul.DefaultLevelConverterCustomJulLevelsTest&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Please verify and close.&lt;/p&gt;</comment>
                            <comment id="14570436" author="mikaelstaldal" created="Wed, 3 Jun 2015 07:44:23 +0000"  >&lt;p&gt;I like the functionality, but I still think there is a thread safety issue on the julToLog4j map, which should be fixed.&lt;/p&gt;</comment>
                            <comment id="14570452" author="garydgregory" created="Wed, 3 Jun 2015 08:08:40 +0000"  >&lt;p&gt;Please check out the new implementation of &lt;tt&gt;org.apache.logging.log4j.jul.DefaultLevelConverter.addCustomJulLevel(Level)&lt;/tt&gt;. Feel free to provide a patch for a better implementation and/or unit tests.&lt;/p&gt;</comment>
                            <comment id="14570490" author="mikaelstaldal" created="Wed, 3 Jun 2015 08:45:12 +0000"  >&lt;p&gt;You need to synchronize the toLevel() method as well, both get and put on the map needs to be synchronized.&lt;/p&gt;</comment>
                            <comment id="14571201" author="remkop@yahoo.com" created="Wed, 3 Jun 2015 15:29:38 +0000"  >&lt;p&gt;I would not want to make &lt;tt&gt;toLevel()&lt;/tt&gt; a synchronized method: it is called for every event so I expect this will impact performance.&lt;br/&gt;
How about making &lt;tt&gt;julToLog4j&lt;/tt&gt; a ConcurrentHashMap instead?&lt;/p&gt;</comment>
                            <comment id="14571231" author="mikaelstaldal" created="Wed, 3 Jun 2015 15:40:22 +0000"  >&lt;p&gt;ConcurrentHashMap would also solve the issue, without synchronization.&lt;/p&gt;</comment>
                            <comment id="14571238" author="garydgregory" created="Wed, 3 Jun 2015 15:50:42 +0000"  >&lt;p&gt;The trade off with ConcurrentHashMap is that we &quot;pay&quot; for using &quot;equals&quot; vs. == currently. But that&apos;s the way to go I think since there is no Concurrent IdentityHashMap in the JRE.&lt;/p&gt;</comment>
                            <comment id="14571331" author="garydgregory" created="Wed, 3 Jun 2015 17:07:25 +0000"  >&lt;p&gt;I updated the JUL to Log4j Level map to a &lt;tt&gt;ConcurrentHashMap&lt;/tt&gt; and changed how it is built dynamically. There should not be any runtime exceptions due to concurrent access. The only ugly part is the possible concurrent overwriting of the same level mapping in case a new level is seen by the converter at the same time. This should not cause a problem. Once all custom levels are registered, that should be it.&lt;/p&gt;</comment>
                            <comment id="14572326" author="mikaelstaldal" created="Thu, 4 Jun 2015 07:48:43 +0000"  >&lt;p&gt;It seems to me that the first five lines of the nearestLevel() method are redundant, since the same check is done before it is called.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Level level = julToLog4j.get(customJavaLevel);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (level != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-comment&quot;&gt;// don&apos;t search
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; level;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14573019" author="garydgregory" created="Thu, 4 Jun 2015 15:52:37 +0000"  >&lt;p&gt;Removed. Please verify and close if appropriate.&lt;/p&gt;</comment>
                            <comment id="14574239" author="mikaelstaldal" created="Fri, 5 Jun 2015 09:59:47 +0000"  >&lt;p&gt;Looks good now.&lt;/p&gt;</comment>
                            <comment id="14574245" author="mikaelstaldal" created="Fri, 5 Jun 2015 10:03:31 +0000"  >&lt;p&gt;However, I would like to have this extra safety net.&lt;/p&gt;</comment>
                            <comment id="14574936" author="garydgregory" created="Fri, 5 Jun 2015 18:02:37 +0000"  >&lt;p&gt;I am not a fan of this #2 patch because it costs a null check on a what should the most efficient code path. Also if the the level is null, it does not cause a problem in the patched method.&lt;/p&gt;

&lt;p&gt;If there should be a null check, it should be where the null would actually be harmful and cause an NPE. At that point the null check can thrown or do something less harmful and at least log a warning to the status logger (&quot;I do not know about level foo, so I am mapping it to debug&quot; or &quot;I am dropping this event on the floor&quot;.&lt;/p&gt;</comment>
                            <comment id="14584719" author="mikaelstaldal" created="Sat, 13 Jun 2015 17:03:16 +0000"  >&lt;p&gt;The fix is good enough, so closing this issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12737897" name="LOG4J2-1025-2.patch" size="801" author="mikaelstaldal" created="Fri, 5 Jun 2015 10:03:31 +0000"/>
                            <attachment id="12736595" name="LOG4J2-1025.patch" size="11325" author="ggregory" created="Mon, 1 Jun 2015 16:26:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 23 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2f1tj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>