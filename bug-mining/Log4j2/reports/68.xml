<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:30:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-169] LogManager.getLogger doesn&apos;t work</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-169</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;We randomly get the following:&lt;/p&gt;

&lt;p&gt;java.util.ConcurrentModificationException&lt;br/&gt;
	at org.apache.logging.log4j.core.config.ConfigurationFactory$Factory.getConfiguration(ConfigurationFactory.java:377)&lt;br/&gt;
	at org.apache.logging.log4j.core.config.ConfigurationFactory$Factory.getConfiguration(ConfigurationFactory.java:361)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext.reconfigure(LoggerContext.java:266)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext.start(LoggerContext.java:134)&lt;br/&gt;
	at org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:75)&lt;br/&gt;
	at org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:30)&lt;br/&gt;
	at org.apache.logging.log4j.LogManager.getLogger(LogManager.java:165)&lt;br/&gt;
	at org.apache.logging.log4j.LogManager.getLogger(LogManager.java:174)&lt;br/&gt;
	at &#8230;&lt;/p&gt;

&lt;p&gt;factories is defined as:&lt;/p&gt;

&lt;p&gt;    private static List&amp;lt;ConfigurationFactory&amp;gt; factories = new ArrayList&amp;lt;ConfigurationFactory&amp;gt;();&lt;/p&gt;

&lt;p&gt;The simple fix is to use a java.util.concurrent.CopyOnWriteArrayList:&lt;/p&gt;

&lt;p&gt;    private static final List&amp;lt;ConfigurationFactory&amp;gt; factories = new CopyOnWriteArrayList&amp;lt;ConfigurationFactory&amp;gt;();&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://svn.apache.org/repos/asf/logging/log4j/log4j2/trunk/core/src/main/java/org/apache/logging/log4j/core/config/ConfigurationFactory.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/logging/log4j/log4j2/trunk/core/src/main/java/org/apache/logging/log4j/core/config/ConfigurationFactory.java&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12633315">LOG4J2-169</key>
            <summary>LogManager.getLogger doesn&apos;t work</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rgoers">Ralph Goers</assignee>
                                    <reporter username="jedws">Jed Wesley-Smith</reporter>
                        <labels>
                            <label>thread-safety</label>
                    </labels>
                <created>Thu, 21 Feb 2013 01:12:28 +0000</created>
                <updated>Thu, 28 Mar 2013 00:02:49 +0000</updated>
                            <resolved>Sun, 3 Mar 2013 23:05:43 +0000</resolved>
                                    <version>2.0-beta4</version>
                                    <fixVersion>2.0-beta5</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13587311" author="garydgregory" created="Tue, 26 Feb 2013 17:51:31 +0000"  >&lt;p&gt;Using a CopyOnWriteArrayList seems like a brute force solution would generate a lot of garbage when many loggers are added. My server at work uses 100&apos;s of loggers.&lt;/p&gt;

&lt;p&gt;The alternative would be to synchronize in just the right places, which is harder to get right. &lt;/p&gt;

&lt;p&gt;Ralph, any thoughts? &lt;/p&gt;
</comment>
                            <comment id="13587457" author="ralph.goers@dslextreme.com" created="Tue, 26 Feb 2013 19:52:50 +0000"  >&lt;p&gt;I looked at this code last night and it struck me that I don&apos;t think getInstance should be adding factory Class instances to the list every time it is called. There are a couple of choices in fixing that which would also solve the ConcurrentModificationException.  &lt;/p&gt;</comment>
                            <comment id="13587467" author="garydgregory" created="Tue, 26 Feb 2013 19:57:29 +0000"  >&lt;p&gt;Are duplicate factories allowed? If not, the type of the static variable should be a Set, not a List.&lt;/p&gt;</comment>
                            <comment id="13587518" author="jedws" created="Tue, 26 Feb 2013 20:41:58 +0000"  >&lt;p&gt;&amp;gt; Using a CopyOnWriteArrayList seems like a brute force solution would generate a lot of garbage when many loggers are added. My server at work uses 100&apos;s of loggers.&lt;/p&gt;

&lt;p&gt;100s is not very many at all. Also, we are talking about ConfigurationFactory objects, not Loggers. This technique (copy-on-write) is tried and true for this kind of read-mostly configuration data.&lt;/p&gt;

&lt;p&gt;&amp;gt; The alternative would be to synchronize in just the right places, which is harder to get right. &lt;/p&gt;

&lt;p&gt;Well no, it is easy actually, but you don&apos;t want to. Syncchronizing or locking means you must synchronize readers as well as writers &#8211; which is an unnecessary performance hit. CopyOnWriteArrayList does the right thing for you. It is extremely simple to implement.&lt;/p&gt;
</comment>
                            <comment id="13587526" author="jedws" created="Tue, 26 Feb 2013 20:45:56 +0000"  >&lt;p&gt;&amp;gt; I looked at this code last night and it struck me that I don&apos;t think getInstance should be adding factory Class instances to the list every time it is called. There are a couple of choices in fixing that which would also solve the ConcurrentModificationException.&lt;/p&gt;

&lt;p&gt;That is truly bizarre.&lt;/p&gt;</comment>
                            <comment id="13587528" author="ralph.goers@dslextreme.com" created="Tue, 26 Feb 2013 20:52:51 +0000"  >&lt;p&gt;What is bizarre?  &lt;/p&gt;</comment>
                            <comment id="13587561" author="jedws" created="Tue, 26 Feb 2013 21:10:38 +0000"  >&lt;p&gt;&amp;gt; What is bizarre?&lt;/p&gt;

&lt;p&gt;Creating a new Configuration each time getInstance is called. I hadn&apos;t noticed that, I was only looking at the direct usages of the list.&lt;/p&gt;</comment>
                            <comment id="13588381" author="garydgregory" created="Wed, 27 Feb 2013 14:29:43 +0000"  >&lt;p&gt;Ralph: So... CopyOnWriteArrayList  or something else?&lt;/p&gt;</comment>
                            <comment id="13588510" author="ralph.goers@dslextreme.com" created="Wed, 27 Feb 2013 16:51:39 +0000"  >&lt;p&gt;I am thinking more like using thread safe double checked locking:&lt;/p&gt;

&lt;p&gt;private static volatile List&amp;lt;ConfigurationFactory&amp;gt; factories = null;&lt;/p&gt;

&lt;p&gt;public static ConfigurationFactory getInstance() {&lt;/p&gt;

&lt;p&gt;    if (factories == null) {&lt;br/&gt;
        synchronized (TEST_PREFIX) &lt;/p&gt;
{
            List&amp;lt;ConfigurationFactory&amp;gt; list = new ArrayList&amp;lt;ConfigurationFactory&amp;gt;();
            ....
            factories = Collections.unmodifiableList(list);
        }
&lt;p&gt;    }&lt;br/&gt;
    return configFactory;&lt;/p&gt;

&lt;p&gt;}&lt;/p&gt;</comment>
                            <comment id="13589399" author="grandinj" created="Thu, 28 Feb 2013 09:53:32 +0000"  >&lt;p&gt;The thread-safe DCL looks like:&lt;/p&gt;

&lt;p&gt;public static ConfigurationFactory getInstance() {&lt;br/&gt;
    if (factories == null) {&lt;br/&gt;
        synchronized (TEST_PREFIX) {&lt;br/&gt;
            if (factories == null) &lt;/p&gt;
{
               List&amp;lt;ConfigurationFactory&amp;gt; list = new ArrayList&amp;lt;ConfigurationFactory&amp;gt;();
               ....
               factories = Collections.unmodifiableList(list);
            }
&lt;p&gt;        }&lt;br/&gt;
    }&lt;br/&gt;
    return configFactory;&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;Otherwise, later on, someone adds something that shouldn&apos;t be executed more than once inside the inner block, and bad stuff happens &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13591531" author="remkop@yahoo.com" created="Sat, 2 Mar 2013 21:35:26 +0000"  >&lt;p&gt;Double-checked locking is broken because the JIT will optimize and out-of-order writes can happen.&lt;/p&gt;

&lt;p&gt;Here is the analysis plus a solution:&lt;br/&gt;
&lt;a href=&quot;http://www.ibm.com/developerworks/java/library/j-dcl/index.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.ibm.com/developerworks/java/library/j-dcl/index.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13591564" author="ralph.goers@dslextreme.com" created="Sat, 2 Mar 2013 23:43:18 +0000"  >&lt;p&gt;The article you reference is very old. Take a look at &lt;a href=&quot;http://www.cs.umd.edu/~pugh/java/memoryModel/DoubleCheckedLocking.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.cs.umd.edu/~pugh/java/memoryModel/DoubleCheckedLocking.html&lt;/a&gt; and then search for &quot;volatile&quot; (this is just the first article Google gave me when I searched - there are others).  You will notice that in the code fragment I posted above the factories variable is declared volatile. Noel left it out in his example because he was simply fixing the mistake I made of not checking the variable again. &lt;/p&gt;

&lt;p&gt;The semantics of volatile changed in Java 5 such that it provides some of the same guarantees you get with synchronizing access to a variable. Log4j2 takes advantage of this during reconfiguration to avoid having to synchronize access to the configuration. See &lt;a href=&quot;http://www.javamex.com/tutorials/synchronization_volatile_java_5.shtml&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.javamex.com/tutorials/synchronization_volatile_java_5.shtml&lt;/a&gt; for a reasonable, if simple, explanation. There are some other things that can happen with non-volatile variables or even volatile variables prior to java 5 that won&apos;t any more due to the memory guarantees.&lt;/p&gt;

&lt;p&gt;In any case, DCL does work if the variable being checked is declared volatile or is an element of a ConcurrentHashMap, or the like, which provide similar guarantees.&lt;/p&gt;</comment>
                            <comment id="13591576" author="remkop@yahoo.com" created="Sun, 3 Mar 2013 00:27:16 +0000"  >&lt;p&gt;You are right, I missed the &quot;volatile&quot; declaration.&lt;/p&gt;

&lt;p&gt;Still, the &quot;static singleton&quot; solution proposed in both the articles (in yours it&apos;s under &quot;Making it work for static singletons&quot;) looks a lot simpler:&lt;br/&gt;
(and it will be faster because it doesn&apos;t even have the volatile memory barrier).&lt;/p&gt;

&lt;p&gt;private static List&amp;lt;ConfigurationFactory&amp;gt; factories = createFactories(); // no need to make this volatile&lt;/p&gt;

&lt;p&gt;public static List&amp;lt;ConfigurationFactory&amp;gt; getInstance() &lt;/p&gt;
{ return factories; }
&lt;p&gt; &lt;/p&gt;

&lt;p&gt;private static List&amp;lt;ConfigurationFactory&amp;gt; createFactories() { // no need for null checking or synchronization here&lt;br/&gt;
    List&amp;lt;ConfigurationFactory&amp;gt; list = new ArrayList&amp;lt;ConfigurationFactory&amp;gt;();&lt;br/&gt;
     ....&lt;br/&gt;
    return Collections.unmodifiableList(list);&lt;br/&gt;
}&lt;/p&gt;</comment>
                            <comment id="13591880" author="ralph.goers@dslextreme.com" created="Sun, 3 Mar 2013 21:56:38 +0000"  >&lt;p&gt;Making the change as you propose has the side effect of causing the initialization to occur when the ConfigurationFactory class is first referenced instead of when an instance of the ConfigurationFactory is required. Doing that would cause the createFactories method to try to create instances of the ConfigurationFactory class while that class hasn&apos;t finished initializing, which I don&apos;t think is a good idea. &lt;/p&gt;</comment>
                            <comment id="13591891" author="ralph.goers@dslextreme.com" created="Sun, 3 Mar 2013 23:05:43 +0000"  >&lt;p&gt;Fixed in revision 1452151. Please verify and close.&lt;/p&gt;</comment>
                            <comment id="13593013" author="remkop@yahoo.com" created="Tue, 5 Mar 2013 03:30:11 +0000"  >&lt;p&gt;Maven build seems broken: org.apache.logging.log4j.LogManager now has an (unused)&lt;br/&gt;
import  com.sun.xml.internal.xsom.impl.UnionSimpleTypeImpl; that stops the build.&lt;br/&gt;
Removing the import fixes the problem.&lt;/p&gt;</comment>
                            <comment id="13615907" author="jedws" created="Thu, 28 Mar 2013 00:02:49 +0000"  >&lt;p&gt;Anything in particular holding up a beta5 release?&lt;/p&gt;

&lt;p&gt;It has been a few months since the last one and this particular problem is seriously slowing our test runs as they must be executed sequentially to avoid tripping this up.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>313811</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 34 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1i5jb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>314156</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>