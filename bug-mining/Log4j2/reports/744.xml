<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:36:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1160] LoggerContext logs with FATAL priority when unable to register a shutdown hook</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1160</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;LoggerContext logs a message at FATAL priority when unable to register a shutdown hook sounds a bit excessive to me. &lt;/p&gt;

&lt;p&gt;Consider the following scenario: an app is being shut down, it is going through its resource de-allocation and cleanup routines. It loads a new class which has not been used up to this point. The class happens to have a static logger. The logger gets initialized. LoggerContext attempts to register a shutdown hook and fails because the JVM is already being shut down. DefaultShutdownCallbackRegistry throws an ISE which gets logged at FATAL priority. People get a heart attack. Widows and orphans cry.   &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2015-10-14 17:50:11,491 Thread-1 FATAL Unable to register shutdown hook because JVM is shutting down. java.lang.IllegalStateException: Cannot add new shutdown hook as this is not started. Current state: STOPPED
	at org.apache.logging.log4j.core.util.DefaultShutdownCallbackRegistry.addShutdownCallback(DefaultShutdownCallbackRegistry.java:113)
	at org.apache.logging.log4j.core.impl.Log4jContextFactory.addShutdownCallback(Log4jContextFactory.java:271)
	at org.apache.logging.log4j.core.LoggerContext.setUpShutdownHook(LoggerContext.java:256)
	at org.apache.logging.log4j.core.LoggerContext.start(LoggerContext.java:216)
	at org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:146)
	at org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:41)
	at org.apache.logging.log4j.LogManager.getContext(LogManager.java:185)
	at org.apache.logging.log4j.spi.AbstractLoggerAdapter.getContext(AbstractLoggerAdapter.java:103)
	at org.apache.logging.slf4j.Log4jLoggerFactory.getContext(Log4jLoggerFactory.java:43)
	at org.apache.logging.log4j.spi.AbstractLoggerAdapter.getLogger(AbstractLoggerAdapter.java:42)
	at org.apache.logging.slf4j.Log4jLoggerFactory.getLogger(Log4jLoggerFactory.java:29)
	at org.slf4j.LoggerFactory.getLogger(LoggerFactory.java:285)
	at org.slf4j.LoggerFactory.getLogger(LoggerFactory.java:305)
	at org.apache.activemq.util.ThreadPoolUtils.&amp;lt;clinit&amp;gt;(ThreadPoolUtils.java:31)
	at org.apache.activemq.ActiveMQConnection.close(ActiveMQConnection.java:728)
	at org.springframework.jms.connection.SingleConnectionFactory.closeConnection(SingleConnectionFactory.java:456)
	at org.springframework.jms.connection.SingleConnectionFactory.resetConnection(SingleConnectionFactory.java:345)
	at org.springframework.jms.connection.SingleConnectionFactory.destroy(SingleConnectionFactory.java:335)
	at org.springframework.beans.factory.support.DisposableBeanAdapter.destroy(DisposableBeanAdapter.java:261)
	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.destroyBean(DefaultSingletonBeanRegistry.java:578)
	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.destroySingleton(DefaultSingletonBeanRegistry.java:554)
	at org.springframework.beans.factory.support.DefaultListableBeanFactory.destroySingleton(DefaultListableBeanFactory.java:925)
	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.destroySingletons(DefaultSingletonBeanRegistry.java:523)
	at org.springframework.beans.factory.support.DefaultListableBeanFactory.destroySingletons(DefaultListableBeanFactory.java:932)
	at org.springframework.context.support.AbstractApplicationContext.destroyBeans(AbstractApplicationContext.java:997)
	at org.springframework.context.support.AbstractApplicationContext.doClose(AbstractApplicationContext.java:973)
	at org.springframework.context.support.AbstractApplicationContext.close(AbstractApplicationContext.java:925)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think it is legal for #addShutdownCallback to fail at this point. Logging at  FATAL priority here sounds unwarranted. &lt;/p&gt;

&lt;p&gt;Could you please consider toning this down a little? Warning maybe?&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</description>
                <environment></environment>
        <key id="12904921">LOG4J2-1160</key>
            <summary>LoggerContext logs with FATAL priority when unable to register a shutdown hook</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="olegk">Oleg Kalnichevski</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Oct 2015 16:39:52 +0000</created>
                <updated>Tue, 8 Mar 2016 21:43:57 +0000</updated>
                            <resolved>Tue, 8 Mar 2016 21:43:57 +0000</resolved>
                                    <version>2.4.1</version>
                                    <fixVersion>2.6</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14957440" author="ralph.goers@dslextreme.com" created="Wed, 14 Oct 2015 18:19:03 +0000"  >&lt;p&gt;I agree that logging at FATAL is too extreme. That said, I do believe it is an error. A new class that contains a Logger really shouldn&apos;t be loaded at this point. &lt;/p&gt;</comment>
                            <comment id="14957571" author="olegk" created="Wed, 14 Oct 2015 19:24:19 +0000"  >&lt;p&gt;Ralph,&lt;br/&gt;
Even if I agreed I have no control over what Spring does. I do think, however, Log4J ought not assume that new classes cannot be loaded and new loggers created while the JVM is being shut down.&lt;/p&gt;

&lt;p&gt;Oleg  &lt;/p&gt;</comment>
                            <comment id="14957642" author="garydgregory" created="Wed, 14 Oct 2015 20:03:38 +0000"  >&lt;p&gt;I change the log event from FATAL to ERROR. &lt;/p&gt;

&lt;p&gt;Should Log4j log ANYTHING at the FATAL level?&lt;/p&gt;

&lt;p&gt;For example:&lt;/p&gt;

&lt;p&gt;LOGGER.fatal(&quot;Ignoring log event after log4j was shut down&quot;);&lt;/p&gt;

&lt;p&gt;?&lt;/p&gt;</comment>
                            <comment id="14957732" author="ralph.goers@dslextreme.com" created="Wed, 14 Oct 2015 20:51:43 +0000"  >&lt;p&gt;No.  FATAL means your whole system is toast.  That clearly isn&apos;t the case here.&lt;/p&gt;</comment>
                            <comment id="14957804" author="garydgregory" created="Wed, 14 Oct 2015 21:22:11 +0000"  >&lt;p&gt;Here are all the fatal call sites:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ProviderUtil.java
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;128: LOGGER.fatal(&quot;Interrupted before Log4j Providers could be loaded.&quot;, e);&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;AsyncLogger.java (2 matches)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;248: LOGGER.fatal(&quot;Ignoring log event after log4j was shut down&quot;);&lt;/li&gt;
		&lt;li&gt;368: LOGGER.fatal(&quot;Ignoring log event after log4j was shut down.&quot;);&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;AsyncLoggerConfigHelper.java (2 matches)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;325: LOGGER.fatal(&quot;Ignoring log event after log4j was shut down&quot;);&lt;/li&gt;
		&lt;li&gt;337: LOGGER.fatal(&quot;Ignoring log event after log4j was shut down.&quot;);&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Configurator.java
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;51: LOGGER.fatal(&quot;LogManager did not return a LoggerContextFactory. This indicates something has gone terribly wrong!&quot;);&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15185221" author="jvz" created="Tue, 8 Mar 2016 16:54:08 +0000"  >&lt;p&gt;Looks like Configurator and ProviderUtil use fatal properly, not sure about the async logs, though.&lt;/p&gt;</comment>
                            <comment id="15185858" author="remkop@yahoo.com" created="Tue, 8 Mar 2016 21:30:09 +0000"  >&lt;p&gt;Thanks for the reminder! I fixed the async logging stuff, so its status log messages are now at WARN instead of FATAL level if logging is attempted after the Disruptor was shut down. (I initially changed it to ERROR but WARN feels more appropriate.)&lt;/p&gt;</comment>
                            <comment id="15185874" author="jvz" created="Tue, 8 Mar 2016 21:36:48 +0000"  >&lt;p&gt;Then that covers everything. We could probably close this, yes?&lt;/p&gt;</comment>
                            <comment id="15185884" author="remkop@yahoo.com" created="Tue, 8 Mar 2016 21:40:05 +0000"  >&lt;p&gt;I did not check the rest, but based on Gary&apos;s listing it looks like we&apos;re good now.&lt;/p&gt;</comment>
                            <comment id="15185888" author="jvz" created="Tue, 8 Mar 2016 21:43:42 +0000"  >&lt;p&gt;I searched the project and the only other calls to fatal are in unit tests, so I think we&apos;re safe to close this now.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2n0j3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>