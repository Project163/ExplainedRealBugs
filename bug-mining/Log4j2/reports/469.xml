<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:33:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-891] AbstractLifecycle should not implement equals() and hashCode()</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-891</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;Starting with version 2.1, the AbstractLifeCycle class (which I think was also introduced in that version) have an implementation of equals() and hashCode() which is being inherited by other core classes such as LoggerContext. That implementation considers two objects as equals if they have the same LifeCycle.State, and calculates the hashCode based on that same attribute.&lt;/p&gt;

&lt;p&gt;This has unwanted side effects:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;For a class like LoggerContext, that implementation of equals() doesn&apos;t apply at all. For example, I&apos;m using log4j2 as the logging technology for an application container. Each deployed application get its own LoggerContext. Those LoggerContext are not equal just because they have the same status.&lt;/li&gt;
	&lt;li&gt;AbstractLifeCycle instances are no longer suitable for use in a HashSet or HashMap. Because every instance with the same state will return the same hashCode, changes are that many of them will end up in the same bucket. Also, because of the same reasons which make the equals() implementation wrong, invokations to HashSet#contains(AbstractLifeCycle) might start showing unexpected behavior.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This was fine in 2.0.2 and I have verified these issues with the LoggerContext class. I&apos;m pretty sure that the same thing happens to all its subclasses. I don&apos;t think that the state is a good attribute to determine equality or idempotency.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12752843">LOG4J2-891</key>
            <summary>AbstractLifecycle should not implement equals() and hashCode()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mgonzalez">Mariano Gonzalez</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Nov 2014 20:52:33 +0000</created>
                <updated>Mon, 18 Jan 2016 19:21:01 +0000</updated>
                            <resolved>Tue, 2 Dec 2014 19:27:56 +0000</resolved>
                                    <version>2.1</version>
                                    <fixVersion>2.2</fixVersion>
                                    <component>API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14196816" author="garydgregory" created="Tue, 4 Nov 2014 21:09:40 +0000"  >&lt;p&gt;For LoggerContext, the problem is that it should implement equals and hashCode. Which attributes should be considered? Just the &lt;tt&gt;name&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="14196836" author="mgonzalez" created="Tue, 4 Nov 2014 21:18:40 +0000"  >&lt;p&gt;For LoggerContext I think it should be the identity itself. Back to the application container example, I can deploy an application and generate a LoggerContext for it with name &quot;myApp&quot;. Then I can redeploy that application (even maybe with a different log4j config), and that would generate a new LoggerContext which has the same name but is fundamentally different.&lt;/p&gt;

&lt;p&gt;I think I can probably imagine similar scenarios for all the subclasses of AbstractLifeCycle that I&apos;ve seen. Even if using the state as a key works for the other examples, the fact that the hashCode functions has low dispersion is still an issue.&lt;/p&gt;</comment>
                            <comment id="14196861" author="ralph.goers@dslextreme.com" created="Tue, 4 Nov 2014 21:33:08 +0000"  >&lt;p&gt;I tend to agree. I cannot see how implementing equals and hashCode on LifeCycle would ever be desirable.&lt;/p&gt;</comment>
                            <comment id="14196888" author="garydgregory" created="Tue, 4 Nov 2014 21:43:57 +0000"  >&lt;p&gt;It sounds like removing hashCode and equals from AbstractLifeCycle is the simplest solution. Check?&lt;/p&gt;</comment>
                            <comment id="14196895" author="pbenedict" created="Tue, 4 Nov 2014 21:47:18 +0000"  >&lt;p&gt;The question of implementing equals() is always about business equality. If you can reasonably justify when two contexts are equal for the sake of business logic, then okay; otherwise it&apos;s better to always say separate instances are never equal (Object&apos;s default implementation). Personally, I don&apos;t see any business equality for this class.&lt;/p&gt;</comment>
                            <comment id="14198954" author="garydgregory" created="Wed, 5 Nov 2014 19:49:20 +0000"  >&lt;p&gt;If I take out hashCode and equals from ALC, then &lt;tt&gt;org.apache.logging.log4j.core.filter.DynamicThresholdFilterSerializationTest&lt;/tt&gt; fails because it depends on equals in DynamicThresholdFilter which depends on equals in ALC.&lt;/p&gt;

&lt;p&gt;Thoughts? Patches?&lt;/p&gt;</comment>
                            <comment id="14199013" author="mgonzalez" created="Wed, 5 Nov 2014 20:31:08 +0000"  >&lt;p&gt;I&apos;m not familiar with that tests but sounds like DynamicThresholdFilter should implements equals() and hashCode() in a manner in which that test works but doesn&apos;t rely onbehaviour inherited from ALC&lt;/p&gt;</comment>
                            <comment id="14199374" author="garydgregory" created="Wed, 5 Nov 2014 23:38:41 +0000"  >&lt;p&gt;Hi All: Please review git master. &lt;/p&gt;

&lt;p&gt;&lt;tt&gt;AbstractLifeCycle&lt;/tt&gt; no longer implements &lt;tt&gt;equals&lt;/tt&gt; and &lt;tt&gt;hashCode&lt;/tt&gt;. Instead it makes implementations of these methods available to subclasses like &lt;tt&gt;DynamicThresholdFilter&lt;/tt&gt; with the protected methods &lt;tt&gt;equalsImpl&lt;/tt&gt; and &lt;tt&gt;hashCodeImpl&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14231950" author="mgonzalez" created="Tue, 2 Dec 2014 19:17:01 +0000"  >&lt;p&gt;hello. Can you confirm this fix will be available in 2.2?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="14231967" author="garydgregory" created="Tue, 2 Dec 2014 19:27:56 +0000"  >&lt;p&gt;Yes, I just set the version to 2.2 for this issue. The code has been in git master for a while now and can be used from a 2.2-SNAPSHOT build.&lt;/p&gt;</comment>
                            <comment id="14231981" author="mgonzalez" created="Tue, 2 Dec 2014 19:35:44 +0000"  >&lt;p&gt;perfect, thank you!&lt;/p&gt;</comment>
                            <comment id="14380153" author="seandawson" created="Wed, 25 Mar 2015 16:22:35 +0000"  >&lt;p&gt;AbstractFilter seems to have been negatively impacted by this. It now fails on super.equals() because of object identity mismatch.&lt;/p&gt;</comment>
                            <comment id="14380218" author="garydgregory" created="Wed, 25 Mar 2015 16:56:18 +0000"  >&lt;p&gt;Clearly, this needs careful thought and implementation. Can you provide additional thoughts and patches?&lt;/p&gt;</comment>
                            <comment id="14381074" author="seandawson" created="Thu, 26 Mar 2015 00:03:54 +0000"  >&lt;p&gt;I&apos;m quite new to log4j2 so I don&apos;t know what the right fix is. It would seem that the previous code checked AbstractLifeCycle which compared State&apos;s, and then AbstractFilter compared onMatch and onMismatch, If AbstractLifeCycle is not going to have equals() but State is still important, I suppose AbstractFilter could simply remove the call to super.equals() and check State itself. Both classes already checked for identity and class type.  So, that given I&apos;m not aware of all of the resulting consequences, I&apos;d propose AbstractFilter be changed to:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; equals(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; obj) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; == obj) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getClass() != obj.getClass()) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; AbstractFilter other = (AbstractFilter) obj;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getState() != other.getState()) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (onMatch != other.onMatch) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (onMismatch != other.onMismatch) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14381141" author="remkop@yahoo.com" created="Thu, 26 Mar 2015 00:50:55 +0000"  >&lt;p&gt;Is it actually a good idea to define equals/hashCode in AbstractFilter? And is this the best implementation, for example, should we refer to the lifecycle state in equals()? &lt;/p&gt;

&lt;p&gt;I would argue that defining equals/hashCode here may give rise to similar problems as we saw with AbstractLifeCycle (the reason this ticket was created): a superclass cannot know what equality means for all its subclasses.&lt;/p&gt;

&lt;p&gt;The simplest thing may be to just remove these methods and let subclasses who need it provide their own implementation. I created &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-985&quot; title=&quot;AbstractFilter should not implement equals() and hashCode()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-985&quot;&gt;&lt;del&gt;LOG4J2-985&lt;/del&gt;&lt;/a&gt; for this.&lt;/p&gt;</comment>
                            <comment id="14381144" author="ralph.goers@dslextreme.com" created="Thu, 26 Mar 2015 00:54:18 +0000"  >&lt;p&gt;Unless the equals and hashcode methods provide a valid implementation to all classes that inherit it then I don&apos;t think it is a good idea for the methods to be there.&lt;/p&gt;</comment>
                            <comment id="14381150" author="garydgregory" created="Thu, 26 Mar 2015 00:57:26 +0000"  >&lt;p&gt;Hm, right. But this is the same problem any class hierachy has, each subclass can define equals/hashCode for its own fields and call super for all others. That seems OO doesn&apos;t? Otherwise, if only leaf classes implemented equals/hashCode, there would be a lot of duplication. The old impl in ALC is OK IMO, it&apos;s just that some subclasses probably relied on the default Object equals/hashCode impl. So, equals/hashCode should be implemented everywhere or nowhere I suppose.&lt;/p&gt;</comment>
                            <comment id="14381151" author="ralph.goers@dslextreme.com" created="Thu, 26 Mar 2015 00:59:39 +0000"  >&lt;p&gt;Let me rephrase. If the equals and hashcode methods are going to need to be overridden in the majority of cases then they should probably not be implemented in an abstract class. That said, I haven&apos;t looked at whether that is true in this case.&lt;/p&gt;</comment>
                            <comment id="15105708" author="seandawson" created="Mon, 18 Jan 2016 19:21:01 +0000"  >&lt;p&gt;This looks like it has been resolved but I&apos;m not clear on what the solution was.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12785751">LOG4J2-985</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 44 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i21ypj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>