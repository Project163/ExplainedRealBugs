<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:40:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-2373] StringBuilder escapeJson performs unnecessary Memory Allocations</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-2373</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;The StringBuilders.escapeJson function&#160;currently uses the string builder&apos;s insert method to add elements to an existing builder for the purposes of escaping special characters.&#160; Unfortunately, this leads to a&#160;loop that regularly&#160;expands the builder capacity, causing issues at scale.&lt;/p&gt;

&lt;p&gt;A better approach would do a first run through to compute the total space required for the addition and then fill that space&#160;using the current method.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13171538">LOG4J2-2373</key>
            <summary>StringBuilder escapeJson performs unnecessary Memory Allocations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ckozak">Carter Kozak</assignee>
                                    <reporter username="kmeurer">Kevin Andrew Meurer</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Jul 2018 20:47:27 +0000</created>
                <updated>Thu, 12 Jul 2018 02:03:45 +0000</updated>
                            <resolved>Thu, 12 Jul 2018 02:03:07 +0000</resolved>
                                    <version>2.11.0</version>
                                    <fixVersion>2.11.1</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16540653" author="githubbot" created="Wed, 11 Jul 2018 20:57:48 +0000"  >&lt;p&gt;GitHub user kmeurer opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/190&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/190&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2373&quot; title=&quot;StringBuilder escapeJson performs unnecessary Memory Allocations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2373&quot;&gt;&lt;del&gt;LOG4J2-2373&lt;/del&gt;&lt;/a&gt; Reduce memory allocations in StringBuilders.escapeJson&lt;/p&gt;

&lt;p&gt;    This PR resolves a memory allocation issue with the escapeJson function.  Rather than compute expansions of the String builder as we encounter them, we compute the total expansion, allocate the memory, and then assign characters as needed.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/kmeurer/logging-log4j2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/kmeurer/logging-log4j2&lt;/a&gt; feature/json-escape-perf&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/190.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/190.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #190&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 2fbc11e4a4710d974907a01a673959ff38041dbe&lt;br/&gt;
Author: kmeurer &amp;lt;kmeurer@...&amp;gt;&lt;br/&gt;
Date:   2018-07-11T20:50:12Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2373&quot; title=&quot;StringBuilder escapeJson performs unnecessary Memory Allocations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2373&quot;&gt;&lt;del&gt;LOG4J2-2373&lt;/del&gt;&lt;/a&gt; Reduce memory allocations in the StringBuilders.escapeJson function.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16540689" author="githubbot" created="Wed, 11 Jul 2018 21:26:14 +0000"  >&lt;p&gt;Github user cakofony commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/190#discussion_r201844357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/190#discussion_r201844357&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: log4j-api/src/main/java/org/apache/logging/log4j/util/StringBuilders.java &amp;#8212;&lt;br/&gt;
    @@ -169,53 +169,85 @@ public static void trimToMaxSize(final StringBuilder stringBuilder, final int ma&lt;br/&gt;
         }&lt;/p&gt;

&lt;p&gt;         public static void escapeJson(final StringBuilder toAppendTo, final int start) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (int i = toAppendTo.length() - 1; i &amp;gt;= start; i--) { // backwards: length may change&lt;br/&gt;
    +        int escapeCount = 0;&lt;br/&gt;
    +        for (int i = start; i &amp;lt; toAppendTo.length(); i++) {&lt;br/&gt;
                 final char c = toAppendTo.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;br/&gt;
                 switch (c) {&lt;br/&gt;
                     case &apos;\b&apos;:&lt;/li&gt;
	&lt;li&gt;toAppendTo.setCharAt(i, &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;);&lt;/li&gt;
	&lt;li&gt;toAppendTo.insert(i + 1, &apos;b&apos;);&lt;br/&gt;
    +                case &apos;\t&apos;:&lt;br/&gt;
    +                case &apos;\f&apos;:&lt;br/&gt;
    +                case &apos;\n&apos;:&lt;br/&gt;
    +                case &apos;\r&apos;:&lt;br/&gt;
    +                case &apos;&quot;&apos;:&lt;br/&gt;
    +                case &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;:&lt;br/&gt;
    +                    escapeCount++;&lt;br/&gt;
    +                    break;&lt;br/&gt;
    +                default:&lt;br/&gt;
    +                    if (Character.isISOControl(c)) 
{
    +                        escapeCount += 5;
    +                    }
&lt;p&gt;    +            }&lt;br/&gt;
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        int lastChar = toAppendTo.length() - 1;&lt;br/&gt;
    +        toAppendTo.setLength(toAppendTo.length() + escapeCount);&lt;br/&gt;
    +        int lastPos = toAppendTo.length() - 1;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = lastChar; i &amp;gt;= start; i--) {&lt;br/&gt;
    +            final char c = toAppendTo.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;br/&gt;
    +            switch (c) {&lt;br/&gt;
    +                case &apos;\b&apos;:&lt;br/&gt;
    +                    lastPos = escapeAndDecrement(toAppendTo, lastPos, &apos;b&apos;);&lt;br/&gt;
                         break;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;                     case &apos;\t&apos;:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;toAppendTo.setCharAt(i, &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;);&lt;/li&gt;
	&lt;li&gt;toAppendTo.insert(i + 1, &apos;t&apos;);&lt;br/&gt;
    +                    lastPos = escapeAndDecrement(toAppendTo, lastPos, &apos;t&apos;);&lt;br/&gt;
                         break;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;                     case &apos;\f&apos;:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;toAppendTo.setCharAt(i, &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;);&lt;/li&gt;
	&lt;li&gt;toAppendTo.insert(i + 1, &apos;f&apos;);&lt;br/&gt;
    +                    lastPos = escapeAndDecrement(toAppendTo, lastPos, &apos;f&apos;);&lt;br/&gt;
                         break;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;                     case &apos;\n&apos;:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// Json string newline character must be encoded as literal &quot;\n&quot;&lt;/li&gt;
	&lt;li&gt;toAppendTo.setCharAt(i, &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;);&lt;/li&gt;
	&lt;li&gt;toAppendTo.insert(i + 1, &apos;n&apos;);&lt;br/&gt;
    +                    lastPos = escapeAndDecrement(toAppendTo, lastPos, &apos;n&apos;);&lt;br/&gt;
                         break;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;                     case &apos;\r&apos;:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;toAppendTo.setCharAt(i, &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;);&lt;/li&gt;
	&lt;li&gt;toAppendTo.insert(i + 1, &apos;r&apos;);&lt;br/&gt;
    +                    lastPos = escapeAndDecrement(toAppendTo, lastPos, &apos;r&apos;);&lt;br/&gt;
                         break;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;                     case &apos;&quot;&apos;:&lt;br/&gt;
    +                    lastPos = escapeAndDecrement(toAppendTo, lastPos, &apos;&quot;&apos;);&lt;br/&gt;
    +                    break;&lt;br/&gt;
                     case &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// only &quot; and \ need to be escaped; other escapes are optional&lt;/li&gt;
	&lt;li&gt;toAppendTo.insert(i, &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;);&lt;br/&gt;
    +                    lastPos = escapeAndDecrement(toAppendTo, lastPos, &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Might as well combine `\` and `&quot;`, in both cases the char `c` is the escaped character&lt;/p&gt;</comment>
                            <comment id="16540690" author="githubbot" created="Wed, 11 Jul 2018 21:26:14 +0000"  >&lt;p&gt;Github user cakofony commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/190#discussion_r201843300&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/190#discussion_r201843300&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: log4j-api/src/main/java/org/apache/logging/log4j/util/StringBuilders.java &amp;#8212;&lt;br/&gt;
    @@ -169,53 +169,85 @@ public static void trimToMaxSize(final StringBuilder stringBuilder, final int ma&lt;br/&gt;
         }&lt;/p&gt;

&lt;p&gt;         public static void escapeJson(final StringBuilder toAppendTo, final int start) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (int i = toAppendTo.length() - 1; i &amp;gt;= start; i--) { // backwards: length may change&lt;br/&gt;
    +        int escapeCount = 0;&lt;br/&gt;
    +        for (int i = start; i &amp;lt; toAppendTo.length(); i++) {&lt;br/&gt;
                 final char c = toAppendTo.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;br/&gt;
                 switch (c) {&lt;br/&gt;
                     case &apos;\b&apos;:&lt;/li&gt;
	&lt;li&gt;toAppendTo.setCharAt(i, &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;);&lt;/li&gt;
	&lt;li&gt;toAppendTo.insert(i + 1, &apos;b&apos;);&lt;br/&gt;
    +                case &apos;\t&apos;:&lt;br/&gt;
    +                case &apos;\f&apos;:&lt;br/&gt;
    +                case &apos;\n&apos;:&lt;br/&gt;
    +                case &apos;\r&apos;:&lt;br/&gt;
    +                case &apos;&quot;&apos;:&lt;br/&gt;
    +                case &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;:&lt;br/&gt;
    +                    escapeCount++;&lt;br/&gt;
    +                    break;&lt;br/&gt;
    +                default:&lt;br/&gt;
    +                    if (Character.isISOControl(c)) 
{
    +                        escapeCount += 5;
    +                    }
&lt;p&gt;    +            }&lt;br/&gt;
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        int lastChar = toAppendTo.length() - 1;&lt;br/&gt;
    +        toAppendTo.setLength(toAppendTo.length() + escapeCount);&lt;br/&gt;
    +        int lastPos = toAppendTo.length() - 1;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = lastChar; i &amp;gt;= start; i--) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think we can change the condition from `i &amp;gt;= start` to `lastPos &amp;gt; i`. On the fast path there&apos;s nothing to escape, so this loop should be a no-op. This allows us to stop iterating once we&apos;ve escaped the last unescaped character.&lt;/p&gt;</comment>
                            <comment id="16540691" author="githubbot" created="Wed, 11 Jul 2018 21:26:14 +0000"  >&lt;p&gt;Github user cakofony commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/190#discussion_r201844005&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/190#discussion_r201844005&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: log4j-api/src/main/java/org/apache/logging/log4j/util/StringBuilders.java &amp;#8212;&lt;br/&gt;
    @@ -169,53 +169,85 @@ public static void trimToMaxSize(final StringBuilder stringBuilder, final int ma&lt;br/&gt;
         }&lt;/p&gt;

&lt;p&gt;         public static void escapeJson(final StringBuilder toAppendTo, final int start) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (int i = toAppendTo.length() - 1; i &amp;gt;= start; i--) { // backwards: length may change&lt;br/&gt;
    +        int escapeCount = 0;&lt;br/&gt;
    +        for (int i = start; i &amp;lt; toAppendTo.length(); i++) {&lt;br/&gt;
                 final char c = toAppendTo.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;br/&gt;
                 switch (c) {&lt;br/&gt;
                     case &apos;\b&apos;:&lt;/li&gt;
	&lt;li&gt;toAppendTo.setCharAt(i, &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;);&lt;/li&gt;
	&lt;li&gt;toAppendTo.insert(i + 1, &apos;b&apos;);&lt;br/&gt;
    +                case &apos;\t&apos;:&lt;br/&gt;
    +                case &apos;\f&apos;:&lt;br/&gt;
    +                case &apos;\n&apos;:&lt;br/&gt;
    +                case &apos;\r&apos;:&lt;br/&gt;
    +                case &apos;&quot;&apos;:&lt;br/&gt;
    +                case &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;:&lt;br/&gt;
    +                    escapeCount++;&lt;br/&gt;
    +                    break;&lt;br/&gt;
    +                default:&lt;br/&gt;
    +                    if (Character.isISOControl(c)) 
{
    +                        escapeCount += 5;
    +                    }
&lt;p&gt;    +            }&lt;br/&gt;
    +        }&lt;br/&gt;
    +&lt;br/&gt;
    +        int lastChar = toAppendTo.length() - 1;&lt;br/&gt;
    +        toAppendTo.setLength(toAppendTo.length() + escapeCount);&lt;br/&gt;
    +        int lastPos = toAppendTo.length() - 1;&lt;br/&gt;
    +&lt;br/&gt;
    +        for (int i = lastChar; i &amp;gt;= start; i--) {&lt;br/&gt;
    +            final char c = toAppendTo.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;br/&gt;
    +            switch (c) {&lt;br/&gt;
    +                case &apos;\b&apos;:&lt;br/&gt;
    +                    lastPos = escapeAndDecrement(toAppendTo, lastPos, &apos;b&apos;);&lt;br/&gt;
                         break;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;                     case &apos;\t&apos;:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;toAppendTo.setCharAt(i, &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;);&lt;/li&gt;
	&lt;li&gt;toAppendTo.insert(i + 1, &apos;t&apos;);&lt;br/&gt;
    +                    lastPos = escapeAndDecrement(toAppendTo, lastPos, &apos;t&apos;);&lt;br/&gt;
                         break;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;                     case &apos;\f&apos;:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;toAppendTo.setCharAt(i, &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;);&lt;/li&gt;
	&lt;li&gt;toAppendTo.insert(i + 1, &apos;f&apos;);&lt;br/&gt;
    +                    lastPos = escapeAndDecrement(toAppendTo, lastPos, &apos;f&apos;);&lt;br/&gt;
                         break;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;                     case &apos;\n&apos;:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// Json string newline character must be encoded as literal &quot;\n&quot;&lt;/li&gt;
	&lt;li&gt;toAppendTo.setCharAt(i, &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;);&lt;/li&gt;
	&lt;li&gt;toAppendTo.insert(i + 1, &apos;n&apos;);&lt;br/&gt;
    +                    lastPos = escapeAndDecrement(toAppendTo, lastPos, &apos;n&apos;);&lt;br/&gt;
                         break;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;                     case &apos;\r&apos;:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;toAppendTo.setCharAt(i, &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;);&lt;/li&gt;
	&lt;li&gt;toAppendTo.insert(i + 1, &apos;r&apos;);&lt;br/&gt;
    +                    lastPos = escapeAndDecrement(toAppendTo, lastPos, &apos;r&apos;);&lt;br/&gt;
                         break;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;                     case &apos;&quot;&apos;:&lt;br/&gt;
    +                    lastPos = escapeAndDecrement(toAppendTo, lastPos, &apos;&quot;&apos;);&lt;br/&gt;
    +                    break;&lt;br/&gt;
                     case &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// only &quot; and \ need to be escaped; other escapes are optional&lt;/li&gt;
	&lt;li&gt;toAppendTo.insert(i, &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;);&lt;br/&gt;
    +                    lastPos = escapeAndDecrement(toAppendTo, lastPos, &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;);&lt;br/&gt;
                         break;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;                     default:&lt;br/&gt;
                         if (Character.isISOControl(c)) &lt;/p&gt;
{
    -                        // all iso control characters are in U+00xx
    -                        toAppendTo.setCharAt(i, &apos;\\&apos;);
    -                        toAppendTo.insert(i + 1, &quot;u0000&quot;);
    -                        toAppendTo.setCharAt(i + 4, Chars.getUpperCaseHex((c &amp;amp; 0xF0) &amp;gt;&amp;gt; 4));
    -                        toAppendTo.setCharAt(i + 5, Chars.getUpperCaseHex(c &amp;amp; 0xF));
    +                        // all iso control characters are in U+00xx, JSON output format is \u00XX
    +                        toAppendTo.setCharAt(lastPos - 5, &apos;\\&apos;);
    +                        toAppendTo.setCharAt(lastPos - 4, &apos;u&apos;);
    +                        toAppendTo.setCharAt(lastPos - 3, &apos;0&apos;);
    +                        toAppendTo.setCharAt(lastPos - 2, &apos;0&apos;);
    +                        toAppendTo.setCharAt(lastPos - 1, Chars.getUpperCaseHex((c &amp;amp; 0xF0) &amp;gt;&amp;gt; 4));
    +                        toAppendTo.setCharAt(lastPos, Chars.getUpperCaseHex(c &amp;amp; 0xF));
    +                        lastPos -= 6;
    +                    }
&lt;p&gt; else &lt;/p&gt;
{
    +                        toAppendTo.setCharAt(lastPos, c);
    +                        lastPos--;
                         }
&lt;p&gt;                 }&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;/p&gt;

&lt;p&gt;    +    private static int escapeAndDecrement(StringBuilder toAppendTo, int lastPos, char b) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I might inline this&lt;/p&gt;

&lt;p&gt;    ```java&lt;br/&gt;
    toAppendTo.setCharAt(lastPos--, &amp;lt;char&amp;gt;);&lt;br/&gt;
    toAppendTo.setCharAt(lastPos--, &apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;);&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="16541017" author="jira-bot" created="Thu, 12 Jul 2018 02:01:52 +0000"  >&lt;p&gt;Commit 363984f1f78f738f1ef9c726dea2cb485fc6bb7b in logging-log4j2&apos;s branch refs/heads/release-2.x from kmeurer&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=363984f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=363984f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2373&quot; title=&quot;StringBuilder escapeJson performs unnecessary Memory Allocations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2373&quot;&gt;&lt;del&gt;LOG4J2-2373&lt;/del&gt;&lt;/a&gt; Reduce unnecessary character movement in the StringBuilders.escapeJson function.&lt;/p&gt;

&lt;p&gt;This closes #190&lt;/p&gt;</comment>
                            <comment id="16541019" author="jira-bot" created="Thu, 12 Jul 2018 02:02:10 +0000"  >&lt;p&gt;Commit 0fe1b47b263edc792748c3a8d5557c793daf739c in logging-log4j2&apos;s branch refs/heads/master from kmeurer&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=0fe1b47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=0fe1b47&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2373&quot; title=&quot;StringBuilder escapeJson performs unnecessary Memory Allocations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2373&quot;&gt;&lt;del&gt;LOG4J2-2373&lt;/del&gt;&lt;/a&gt; Reduce unnecessary character movement in the StringBuilders.escapeJson function.&lt;/p&gt;

&lt;p&gt;This closes #190&lt;/p&gt;</comment>
                            <comment id="16541021" author="githubbot" created="Thu, 12 Jul 2018 02:02:25 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/190&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/190&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16541022" author="ckozak" created="Thu, 12 Jul 2018 02:03:07 +0000"  >&lt;p&gt;Thanks for your contribution &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kmeurer&quot; class=&quot;user-hover&quot; rel=&quot;kmeurer&quot;&gt;kmeurer&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 18 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vsi7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>