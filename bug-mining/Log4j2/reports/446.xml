<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:33:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-938] org.apache.logging.log4j.core.jmx.Server never shuts down the ExecutorService it creates</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-938</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;The class &lt;tt&gt;org.apache.logging.log4j.core.jmx.Server&lt;/tt&gt; creates an &lt;tt&gt;ExecutorService&lt;/tt&gt; at construction time and and stores it as an instance variable of type &lt;tt&gt;Executor&lt;/tt&gt; (named &lt;tt&gt;executor&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;This executor service is never shut down (I guess the &lt;tt&gt;unregisterMBeans()&lt;/tt&gt; methods may be good candidates, with some care for &lt;tt&gt;unregisterMBeans(MBeanServer)&lt;/tt&gt; which performs unregistration only for a single &lt;tt&gt;MBeanServer&lt;/tt&gt;). This causes a memory leak if Log4j is used in a web application (under Tomcat, for instance) and the JMX services have been used (i.e.: the &lt;tt&gt;Server&lt;/tt&gt; class has been instantiated).&lt;/p&gt;

&lt;p&gt;But even worse, what I&apos;m observing is that a notification Job may be submitted to that executor by &lt;tt&gt;javax.management.NotificationBroadcasterSupport.sendNotification(Notification)&lt;/tt&gt;, invoked by &lt;tt&gt;org.apache.logging.log4j.core.jmx.StatusLoggerAdmin.log(StatusData)&lt;/tt&gt; in certain circumstances exactly during Tomcat shutdown process: since the executor is using non-daemon threads to execute tasks, this eventually prevents the application server to shutdown (I have to kill it).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12767704">LOG4J2-938</key>
            <summary>org.apache.logging.log4j.core.jmx.Server never shuts down the ExecutorService it creates</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="mauromol">Mauro Molinari</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Jan 2015 10:49:48 +0000</created>
                <updated>Tue, 3 Mar 2015 15:11:12 +0000</updated>
                            <resolved>Sun, 22 Feb 2015 14:16:19 +0000</resolved>
                                    <version>2.1</version>
                                    <fixVersion>2.2</fixVersion>
                                    <component>JMX</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14286034" author="garydgregory" created="Wed, 21 Jan 2015 18:42:57 +0000"  >&lt;p&gt;Thank you for your report. Patches are welcome...&lt;/p&gt;</comment>
                            <comment id="14291274" author="garydgregory" created="Sun, 25 Jan 2015 21:19:03 +0000"  >&lt;p&gt;Or at least a unit test patch...&lt;/p&gt;</comment>
                            <comment id="14326155" author="mauromol" created="Wed, 18 Feb 2015 16:37:40 +0000"  >&lt;p&gt;Here is my patch. It was not so trivial, so let&apos;s explain what I&apos;ve done.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;Server&lt;/tt&gt; doesn&apos;t use an only &lt;tt&gt;ExecutorService&lt;/tt&gt; any more, but rather one for each logger context on each &lt;tt&gt;MBeanServer&lt;/tt&gt; it is registered. So, a static &lt;tt&gt;Map&amp;lt;MBeanServer, Map&amp;lt;String, ExecutorService&amp;gt;&amp;gt;&lt;/tt&gt; is managed by &lt;tt&gt;Server&lt;/tt&gt; (&lt;tt&gt;String&lt;/tt&gt; because the class is using the context name as a unique key to the logger context).&lt;br/&gt;
This said, &lt;tt&gt;reregisterMBeansAfterReconfigure(MBeanServer)&lt;/tt&gt; method creates the &lt;tt&gt;ExecutorService&lt;/tt&gt; and puts it in the map before passing it to the &lt;tt&gt;LoggerContextAdmin&lt;/tt&gt; instance it creates.&lt;br/&gt;
On the other hand, &lt;tt&gt;unregisterLoggerContext(String, MBeanServer)&lt;/tt&gt;, which is correctly called on logger context shutdown, retrieves the &lt;tt&gt;ExecutorService&lt;/tt&gt; from the map (if it exists) and shuts it down, cleaning up the map itself if needed.&lt;br/&gt;
However, what I observe is that, depending on the logging configuration, my webapp can still invoke Log4j2 after the logger context has been shut down, causing a new one to be created. When this happens and JMX is enabled and used (with JConsole or VisualVM, for instance), I observe two events:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;an MBean re-registration is invoked (&lt;tt&gt;org.apache.logging.log4j.core.jmx.Server.reregisterMBeansAfterReconfigure(MBeanServer)&lt;/tt&gt;)&lt;/li&gt;
	&lt;li&gt;a call to &lt;tt&gt;org.apache.logging.log4j.core.jmx.StatusLoggerAdmin.log(StatusData)&lt;/tt&gt; is made&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The first event would cause a new &lt;tt&gt;ExecutorService&lt;/tt&gt; to be created and put in the map, after the previous shutdown event. To prevent this, I wrapped the &lt;tt&gt;ExecutorService&lt;/tt&gt; into a &quot;LazyExecutorService&quot;, which delegates to a real &lt;tt&gt;ExecutorService&lt;/tt&gt; which is however created lazily, i.e. &lt;b&gt;only&lt;/b&gt; when a task is actually submitted. In this way, even if a &lt;tt&gt;LazyExecutorService&lt;/tt&gt; instance is created, no actual &lt;tt&gt;ExecutorService&lt;/tt&gt; is created and then no non-daemon thread is started unless an actual notification task is submitted.&lt;/p&gt;

&lt;p&gt;The second event, which however happens before the above one, causes a task to be submitted to the executor service even if, meanwhile, that executor service has been shut down by the &lt;tt&gt;Server&lt;/tt&gt; class, causing a &quot;task rejected&quot; exception. To prevent this, I added the method &lt;tt&gt;org.apache.logging.log4j.core.jmx.Server.isLoggerContextRegistered(String, MBeanServer)&lt;/tt&gt; that detects whether a logger context is currently registered on an MBean server or not; then, &lt;tt&gt;org.apache.logging.log4j.core.jmx.StatusLoggerAdmin.log(StatusData)&lt;/tt&gt; checks if this condition is met and sends notifications only if it is the case. If it is not, no task is submitted and hence no &quot;task rejected&quot; exception is thrown.&lt;/p&gt;

&lt;p&gt;With this patch applied, I can finally stop my web application even without disabling Log4j2 JMX support.&lt;/p&gt;

&lt;p&gt;In theory, there&apos;s still a failing use case, if the following sequence of events occur:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;logger context shutdown&lt;/li&gt;
	&lt;li&gt;logger context re-registration&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;org.apache.logging.log4j.core.jmx.StatusLoggerAdmin.log(StatusData)&lt;/tt&gt; invocation&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In this case, although the use of a &lt;tt&gt;LazyExecutorService&lt;/tt&gt; a new actual &lt;tt&gt;ExecutorService&lt;/tt&gt; would be created, together with its non-daemon thread. However, this case never occurred in my tests.&lt;/p&gt;

&lt;p&gt;To permanently solve all possible cases of re-initialization after Log4j2 shutdown (which by the way often produce error reportings in my console on webapp stop), you should find a way (if it exists) to make sure that &lt;tt&gt;org.apache.logging.log4j.web.Log4jServletContextListener.contextDestroyed(ServletContextEvent)&lt;/tt&gt; is invoked as the &lt;b&gt;very last&lt;/b&gt; contextDestroyed event receiver. As of now, it seems like there&apos;s no guarantee on the invocation order of all such receivers, so another one may be invoked after the Log4j2 one and use Log4j2 itself to produce further logging output.&lt;/p&gt;

&lt;p&gt;Feel free to complete/correct/adjust/comment/change/etc. this patch as you like. In particular, some synchronization might be required to &lt;tt&gt;Server&lt;/tt&gt; to ensure the map of executor services is accessed in a thread safe way. Honestly, I didn&apos;t care of this aspect too much.&lt;/p&gt;</comment>
                            <comment id="14329974" author="garydgregory" created="Sat, 21 Feb 2015 03:54:32 +0000"  >&lt;p&gt;This is a non-trivial patch. Can whomever worked on JMX take a look?&lt;/p&gt;</comment>
                            <comment id="14332056" author="remkop@yahoo.com" created="Sun, 22 Feb 2015 06:27:13 +0000"  >&lt;p&gt;If the main problem is the Executor never shutting down, causing a memory leak, then would it be an idea to create the Executor with a daemon thread from the beginning? I believe we already have a DaemonThreadFactory in the core.async package. &lt;/p&gt;

&lt;p&gt;Then we can keep a single static Executor and avoid the complexity of managing multiple Executors in the nested Map data structure.&lt;/p&gt;</comment>
                            <comment id="14332120" author="mauromol" created="Sun, 22 Feb 2015 11:05:44 +0000"  >&lt;p&gt;Hi Remko,&lt;br/&gt;
if you use a daemon thread you&apos;ll solve the problem of the VM not shutting down on Tomcat stop, but you won&apos;t solve the memory leak (which will especially hurt if you just restart the webapp). For that, you absolutely must stop that thread (even if it&apos;s a daemon thread) and hence shut down the ExecutorService.&lt;/p&gt;</comment>
                            <comment id="14332144" author="remkop@yahoo.com" created="Sun, 22 Feb 2015 12:02:33 +0000"  >&lt;p&gt;Mauro,&lt;br/&gt;
Thanks for the clarification. I understand the reasoning behind the patch now.&lt;/p&gt;

&lt;p&gt;There are three problems the patch is addressing:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The Executor must use a daemon thread or the VM will not shut down on Tomcat stop&lt;/li&gt;
	&lt;li&gt;Restarting the webapp without stopping the Executor thread causes a memory leak&lt;/li&gt;
	&lt;li&gt;depending on the logging configuration, a webapp can still invoke Log4j2 after the logger context has been shut down&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;ve gone ahead and made the Executor a daemon thread for now (commit e27c5b5 in git master).&lt;/p&gt;

&lt;p&gt;I would like to think a little more about problem 2. Note that another option is to use a &lt;tt&gt;null&lt;/tt&gt; Executor: this will cause notifications to be sent out in the &lt;em&gt;calling&lt;/em&gt; thread instead of a background thread. This is an alternative solution that will solve both problem 1 (the VM not shutting down) and problem 2 (the memory leak). I am not sure about the performance impact, however, it may be that there is very little status logging going on during normal operation, so performance impact is negligible. This may be the simplest solution.&lt;/p&gt;

&lt;p&gt;I would like to understand problem 3 better. What configuration causes this and which configuration avoids this behaviour?&lt;/p&gt;</comment>
                            <comment id="14332159" author="remkop@yahoo.com" created="Sun, 22 Feb 2015 13:25:06 +0000"  >&lt;p&gt;I&apos;ve given it some more thought and I would really prefer to avoid the complexity of having multiple Executor threads and manually starting/stopping them. I believe we will never be able to perfectly cover all corner cases. (My experience with managing the async loggers thread lifecycle in web applications has been fairly painful. For example, &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-493&quot; title=&quot;Problem with AsyncLogger when web app is deployed/undeployed multiple times&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-493&quot;&gt;&lt;del&gt;LOG4J2-493&lt;/del&gt;&lt;/a&gt; is still open.)&lt;/p&gt;

&lt;p&gt;We may be able to get the best of both worlds: for web apps, let&apos;s sidestep this issue entirely and use a null Executor. JMX notifications are done in the calling thread, and there is no more memory leak. Web apps are not low-latency so the performance cost should not be noticable. For non-web apps, we keep the current behaviour of a single static (daemon) Executor. In detail:&lt;/p&gt;

&lt;p&gt;We introduce a new system property &lt;tt&gt;log4j2.jmx.notify.async&lt;/tt&gt;. If &lt;tt&gt;true&lt;/tt&gt; the Executor is initialized to a daemon background thread Executor. If &lt;tt&gt;false&lt;/tt&gt;, the Executor is initialized to &lt;tt&gt;null&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;If this property is not set (the most common case), we check if we are running in a web container:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;If we detect that the &lt;tt&gt;javax.servlet.Servlet&lt;/tt&gt; class is on the classpath, we assume we are running in a web container and initialize the Executor to &lt;tt&gt;null&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Otherwise we create a daemon Executor.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Both web apps and non-web apps can explicitly set the property to override the default behaviour if necessary.&lt;br/&gt;
Thoughts?&lt;/p&gt;</comment>
                            <comment id="14332164" author="mauromol" created="Sun, 22 Feb 2015 13:41:20 +0000"  >&lt;p&gt;Hi Remko,&lt;br/&gt;
solving problem 2 in any case would solve problem 1, because if the ExecutorService is properly shut down, it won&apos;t prevent the VM to cleanly shut down, hence forcing it to use a daemon thread becomes almost useless.&lt;/p&gt;

&lt;p&gt;Secondly, I also thought that letting Log4j2 use a &lt;tt&gt;null&lt;/tt&gt; executor to let JMX notifications being synchronous would have been the simplest solution: after all, while debugging, I saw that other two libraries I&apos;m using (HikariCP and EclipseLink) are doing it this way. However, in my patch I followed the idea to keep the asynchronous execution because I thought this was done on purpose in Log4j2 for performance reasons.&lt;/p&gt;

&lt;p&gt;Problem 3 happens whenever you use Log4j (either directly or indirectly, through a higher level logging abstraction, like Slf4j or Commons Logging) in a web application where you have other Servlet listeners that use logging (for instance in their own contextDestroyed receiver method)  after the Log4j logger context have been shut down. In fact, AFAIK, there&apos;s no way to force a Servlet 3.1 environment to execute the &lt;tt&gt;Log4jServletContextListener.contextDestroyed(ServletContextEvent)&lt;/tt&gt; as the very last one. Correct me if I&apos;m wrong.&lt;/p&gt;

&lt;p&gt;Your proposed solution is OK for me, although in principle I&apos;m not keen on doing different things in different environments unless strictly necessary. In any case, isn&apos;t there a way to detect if we&apos;re in a web application by taking advantage of the existence of &lt;tt&gt;Log4jServletContextListener&lt;/tt&gt; or something like that, instead of merely trying to detect if &lt;tt&gt;Servlet&lt;/tt&gt; class in on the classpath?&lt;/p&gt;</comment>
                            <comment id="14332177" author="remkop@yahoo.com" created="Sun, 22 Feb 2015 14:16:19 +0000"  >&lt;p&gt;Fixed in master in commit d329cf3.&lt;br/&gt;
Please verify and close.&lt;/p&gt;

&lt;p&gt;(The new system property is documented on the Configuration manual page.)&lt;/p&gt;

&lt;p&gt;Mauro, I agree this solution is a compromise, but I hope its simplicity will help avoid future issues. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; To answer your question: if Log4jServletContextListener is not on the classpath it could be that the user simply did not include the log4j-web module, and we may still be running in a web container. Also, it looks like the core.lookup.Interpolator class uses a similar mechanism (it looks for ServletContext) to see if it should enable the &lt;tt&gt;web:&lt;/tt&gt; lookup or not, so there is some precedent.&lt;/p&gt;

&lt;p&gt;Thanks very much for raising the issue and your detailed analysis on the cause!&lt;/p&gt;</comment>
                            <comment id="14332185" author="mauromol" created="Sun, 22 Feb 2015 14:36:10 +0000"  >&lt;p&gt;You&apos;re welcome, thanks for fixing this! &lt;br/&gt;
When do you plan to release version 2.2? I would need this fix and &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-903&quot; title=&quot;ClassLoaderContextSelector uses ClassLoader.toString() as a key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-903&quot;&gt;&lt;del&gt;LOG4J2-903&lt;/del&gt;&lt;/a&gt;. Meanwhile, I will search for a nightly build to test both in my environment. Thanks again.&lt;/p&gt;</comment>
                            <comment id="14332186" author="remkop@yahoo.com" created="Sun, 22 Feb 2015 14:42:57 +0000"  >&lt;p&gt;Hopefully soon, depends on when the release manager has time. If you can confirm that the fix that Gary made to master for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-903&quot; title=&quot;ClassLoaderContextSelector uses ClassLoader.toString() as a key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-903&quot;&gt;&lt;del&gt;LOG4J2-903&lt;/del&gt;&lt;/a&gt; solves the issue, could you close that ticket too? Thanks!&lt;/p&gt;</comment>
                            <comment id="14333210" author="mauromol" created="Mon, 23 Feb 2015 11:02:38 +0000"  >&lt;p&gt;Hi Remko,&lt;br/&gt;
the current 2.2-SNAPSHOT build on Apache snapshot Maven repository is dated 2014-12-18: is it normal?&lt;br/&gt;
Do you think a new snapshot will be published so that I can test with that? It would be much simpler for me.&lt;br/&gt;
Meanwhile I tested and closed &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-903&quot; title=&quot;ClassLoaderContextSelector uses ClassLoader.toString() as a key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-903&quot;&gt;&lt;del&gt;LOG4J2-903&lt;/del&gt;&lt;/a&gt; (which was fixed before that date).&lt;/p&gt;</comment>
                            <comment id="14333293" author="ralph.goers@dslextreme.com" created="Mon, 23 Feb 2015 13:00:49 +0000"  >&lt;p&gt;We don&apos;t have a CI server configured to build nightly SNAPSHOTS. Occasionally I will deploy a SNAPSHOT at someone&apos;s request.  FYI - the first 2.2 release candidate has been prepared and is being reviewed.&lt;/p&gt;</comment>
                            <comment id="14345193" author="mauromol" created="Tue, 3 Mar 2015 15:11:05 +0000"  >&lt;p&gt;I just verified that in 2.2 the original issue is fixed. Thank you Remko!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12699492" name="LOG4J2-938.patch" size="10039" author="mauromol" created="Wed, 18 Feb 2015 16:37:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 38 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i24emv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>