<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:39:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-2158] ThreadContext map is cleared =&gt; entries are only available for one log event</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-2158</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;In &lt;tt&gt;org.apache.logging.log4j.core.impl.ThreadContextDataInjector.ForCopyOnWriteThreadContextMap.injectContextData&lt;/tt&gt; without properties set, the result of &lt;tt&gt;ThreadContext.getThreadContextMap().getReadOnlyContextData()&lt;/tt&gt; is returned which was saved in a variable called &lt;tt&gt;immutableCopy&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;org.apache.logging.log4j.core.impl.ReusableLogEventFactory.createEvent&lt;/tt&gt; calls &lt;tt&gt;result.clear()&lt;/tt&gt; on that context data when the next log event is created.&lt;/p&gt;

&lt;p&gt;Unfortunately the &quot;immutable&quot; copy is not immutable at all, but is cleared on the this call and all thread context map entries are lost.&lt;/p&gt;

&lt;p&gt;If I set a &lt;tt&gt;Property&lt;/tt&gt; on all loggers in the config, then the thread context map entries are not cleared, because the internal string map is not given out but the entries copied, but that property is also logged then of course.&lt;/p&gt;

&lt;p&gt;If I instead set the system property &lt;tt&gt;log4j2.garbagefree.threadContextMap&lt;/tt&gt;, the thread context map entries are also not cleared, as then also the entries are copied and not the internal structure given out.&lt;/p&gt;

&lt;p&gt;From what I have seen, I&apos;d say there is a &lt;tt&gt;immutableCopy.freeze()&lt;/tt&gt; missing before the &lt;tt&gt;immutableCopy&lt;/tt&gt; is returned inside the &lt;tt&gt;if&lt;/tt&gt;-block.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13126607">LOG4J2-2158</key>
            <summary>ThreadContext map is cleared =&gt; entries are only available for one log event</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="vampire">Bj&#246;rn Kautler</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Dec 2017 17:33:09 +0000</created>
                <updated>Tue, 27 Feb 2018 21:54:16 +0000</updated>
                            <resolved>Sun, 7 Jan 2018 11:17:53 +0000</resolved>
                                    <version>2.10.0</version>
                                    <fixVersion>2.11.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16300672" author="remkop@yahoo.com" created="Thu, 21 Dec 2017 22:41:27 +0000"  >&lt;p&gt;Thanks for reporting this, I&#8217;ll take a look. &lt;br/&gt;
Would you be able to produce a unit test that demonstrates the issue?&lt;/p&gt;</comment>
                            <comment id="16301222" author="vampire" created="Fri, 22 Dec 2017 10:24:46 +0000"  >&lt;p&gt;Ah, while trying to write the test I found out the actual error.&lt;br/&gt;
I wondered already why this wasn&apos;t noticed before.&lt;br/&gt;
This only happens with the &lt;tt&gt;ForCopyOnWriteThreadContextMap&lt;/tt&gt; with &lt;tt&gt;log4j2.isThreadContextMapInheritable&lt;/tt&gt; set to &lt;tt&gt;true&lt;/tt&gt;.&lt;br/&gt;
The main context object is immutable, but the inherited ones are not and that is where the error occurs.&lt;/p&gt;</comment>
                            <comment id="16301514" author="githubbot" created="Fri, 22 Dec 2017 14:43:58 +0000"  >&lt;p&gt;GitHub user Vampire opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/139&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2158&quot; title=&quot;ThreadContext map is cleared =&amp;gt; entries are only available for one log event&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2158&quot;&gt;&lt;del&gt;LOG4J2-2158&lt;/del&gt;&lt;/a&gt; make inherited log event context data immutable when using CopyOnWriteThreadContextMap&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/Vampire/logging-log4j2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Vampire/logging-log4j2&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2158&quot; title=&quot;ThreadContext map is cleared =&amp;gt; entries are only available for one log event&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2158&quot;&gt;&lt;del&gt;LOG4J2-2158&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/139.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/139.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #139&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 64cdddb2e3d811d5ca6cc635154427cfe630ba62&lt;br/&gt;
Author: Bj&#246;rn Kautler &amp;lt;bjoern@...&amp;gt;&lt;br/&gt;
Date:   2017-12-22T14:41:45Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2158&quot; title=&quot;ThreadContext map is cleared =&amp;gt; entries are only available for one log event&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2158&quot;&gt;&lt;del&gt;LOG4J2-2158&lt;/del&gt;&lt;/a&gt; make inherited log event context data immutable when using CopyOnWriteThreadContextMap&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16301522" author="vampire" created="Fri, 22 Dec 2017 14:54:05 +0000"  >&lt;p&gt;There you have it &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=remkop%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;remkop@yahoo.com&quot;&gt;remkop@yahoo.com&lt;/a&gt;, including a proposed fix.&lt;br/&gt;
As far as I can see that Travis is not building is not my fault.&lt;/p&gt;</comment>
                            <comment id="16314695" author="remkop@yahoo.com" created="Sat, 6 Jan 2018 15:08:11 +0000"  >&lt;p&gt;Sorry for my late response. I had some trouble trying to merge this. Would you mind rebasing on master? There have been a lot of changes since your PR.&lt;/p&gt;</comment>
                            <comment id="16315017" author="vampire" created="Sun, 7 Jan 2018 00:45:14 +0000"  >&lt;p&gt;I&apos;m unsure what you mean, none of the four classes I changed was touched since my PR.&lt;br/&gt;
I rebased the PR, but it was a simple conflictless command.&lt;/p&gt;</comment>
                            <comment id="16315196" author="jira-bot" created="Sun, 7 Jan 2018 11:12:42 +0000"  >&lt;p&gt;Commit f1f3945b707d8a590d2fb60624673484771b7d31 in logging-log4j2&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vampire&quot; class=&quot;user-hover&quot; rel=&quot;vampire&quot;&gt;vampire&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=f1f3945&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=f1f3945&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2158&quot; title=&quot;ThreadContext map is cleared =&amp;gt; entries are only available for one log event&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2158&quot;&gt;&lt;del&gt;LOG4J2-2158&lt;/del&gt;&lt;/a&gt; make inherited log event context data immutable when using CopyOnWriteThreadContextMap&lt;/p&gt;</comment>
                            <comment id="16315197" author="jira-bot" created="Sun, 7 Jan 2018 11:12:45 +0000"  >&lt;p&gt;Commit 2352052d0bc797ede29a5b4a8897200aa49a8c43 in logging-log4j2&apos;s branch refs/heads/master from rpopma&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=2352052&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=2352052&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2158&quot; title=&quot;ThreadContext map is cleared =&amp;gt; entries are only available for one log event&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2158&quot;&gt;&lt;del&gt;LOG4J2-2158&lt;/del&gt;&lt;/a&gt; (update change log) Fixed bug where ThreadContext map was cleared, resulting in entries being only available for one log event.&lt;/p&gt;</comment>
                            <comment id="16315198" author="githubbot" created="Sun, 7 Jan 2018 11:12:54 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/139&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16315202" author="remkop@yahoo.com" created="Sun, 7 Jan 2018 11:17:53 +0000"  >&lt;p&gt;Thanks for the contribution!&lt;br/&gt;
Merged into master. Please verify and close this ticket.&lt;/p&gt;</comment>
                            <comment id="16316229" author="vampire" created="Mon, 8 Jan 2018 12:39:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=remkop%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;remkop@yahoo.com&quot;&gt;remkop@yahoo.com&lt;/a&gt; do you mean me? I&apos;m not familiar with your workflow.&lt;/p&gt;</comment>
                            <comment id="16316247" author="vampire" created="Mon, 8 Jan 2018 12:50:09 +0000"  >&lt;p&gt;I tested with `2.10.1-SNAPSHOT` and there the error is gone&lt;/p&gt;</comment>
                            <comment id="16316268" author="remkop@yahoo.com" created="Mon, 8 Jan 2018 13:06:37 +0000"  >&lt;p&gt;@Bjorn Thanks for the confirmation!&lt;/p&gt;</comment>
                            <comment id="16379345" author="markbowman" created="Tue, 27 Feb 2018 21:50:05 +0000"  >&lt;p&gt;2.10.1-SNAPSHOT works for me too. I can log from simple threads&#160;or executor threads and the ContextMap is preserved during multiple log events.&lt;/p&gt;

&lt;p&gt;We&apos;re stuck on 2.6.2 because this is the last release where logging in threads gets a reliable copy of the ContextMap. Fixing this issue is a major success. Would it be possible to get 2.10.1 released?&lt;/p&gt;</comment>
                            <comment id="16379349" author="jvz" created="Tue, 27 Feb 2018 21:54:16 +0000"  >&lt;p&gt;The next release will likely be 2.11.0, though it&apos;s the same branch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 38 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3o6q7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>