<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:31:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-278] Embedded Flume agent fails to rollback</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-278</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;If the embedded Flume agent decides to rollback (for example, because the succeeding node is full) then that rollback fails. It appears that this is because of Flume code attempting to recursively send log events. i.e. where other Log4j2 appenders use StatusLogger the embedded Flume agent does not.&lt;/p&gt;

&lt;p&gt;Steps:&lt;br/&gt;
1. Setup a Flume agent as the succeeding agent and convince it to fill its queue. (In my case, I can make it run out of memory then the queue fills which makes it refuse to accept more messages.)&lt;br/&gt;
2. Extract the attached code (a very simple Jetty server) and modify the log4j2.xml to have embedded=true for the FlumeAppender&lt;br/&gt;
3. Run the attached code&lt;/p&gt;

&lt;p&gt;Expected result:&lt;br/&gt;
The embedded agent should queue messages.&lt;/p&gt;

&lt;p&gt;Actual result:&lt;br/&gt;
2013-06-10 14:39:11,173 ERROR An exception occurred processing Appender FlumeAppender java.lang.IllegalStateException: rollback() called when transaction is COMPLETED! identityHashCode=1164913745&lt;br/&gt;
	at com.google.common.base.Preconditions.checkState(Preconditions.java:172)&lt;br/&gt;
	at org.apache.flume.channel.BasicTransactionSemantics.rollback(BasicTransactionSemantics.java:171)&lt;br/&gt;
	at org.apache.flume.channel.ChannelProcessor.processEvent(ChannelProcessor.java:269)&lt;br/&gt;
	at org.apache.logging.log4j.flume.appender.Log4jEventSource.send(Log4jEventSource.java:59)&lt;br/&gt;
	at org.apache.logging.log4j.flume.appender.FlumeEmbeddedManager.send(FlumeEmbeddedManager.java:123)&lt;br/&gt;
	at org.apache.logging.log4j.flume.appender.FlumeAppender.append(FlumeAppender.java:86)&lt;br/&gt;
	at org.apache.logging.log4j.core.config.AppenderControl.callAppender(AppenderControl.java:102)&lt;br/&gt;
	at org.apache.logging.log4j.core.config.LoggerConfig.callAppenders(LoggerConfig.java:424)&lt;br/&gt;
	at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:405)&lt;br/&gt;
	at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:366)&lt;br/&gt;
	at org.apache.logging.log4j.core.Logger.log(Logger.java:110)&lt;br/&gt;
	at org.apache.logging.log4j.spi.AbstractLoggerWrapper.log(AbstractLoggerWrapper.java:55)&lt;br/&gt;
	at org.slf4j.impl.SLF4JLogger.debug(SLF4JLogger.java:139)&lt;br/&gt;
	at org.apache.flume.channel.file.Log.rollback(Log.java:566)&lt;br/&gt;
	at org.apache.flume.channel.file.FileChannel$FileBackedTransaction.doRollback(FileChannel.java:590)&lt;br/&gt;
	at org.apache.flume.channel.BasicTransactionSemantics.rollback(BasicTransactionSemantics.java:179)&lt;br/&gt;
	at org.apache.flume.sink.AvroSink.process(AvroSink.java:316)&lt;br/&gt;
	at org.apache.flume.sink.FailoverSinkProcessor.process(FailoverSinkProcessor.java:182)&lt;br/&gt;
	at org.apache.flume.SinkRunner$PollingRunner.run(SinkRunner.java:147)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;


&lt;p&gt;(note the identityHashCode is from my own modifications for debugging but does not affect this repro).&lt;/p&gt;

&lt;p&gt;The initial problem is in org.apache.flume.channel.file.Log line 566 where, during a rollback, it logs that it&apos;s rolling back. Flume transactions are held in a thread local. That transaction is open, then the rollback is attempted, which hits Log line 566, so a log write is attempted, which gets the same transaction, which is already open, which causes the exception.&lt;/p&gt;

&lt;p&gt;If I explicitly set the logging on org.apache.flume.channel.file.Log to warn then I get:&lt;br/&gt;
013-06-10 15:25:25,673 WARN  &lt;span class=&quot;error&quot;&gt;&amp;#91;SinkRunner-PollingRunner-FailoverSinkProcessor-1241018503&amp;#93;&lt;/span&gt; appender.Log4jEventSource (Log4jEventSource.java:61) - Unabled to process event {}[Event headers = &lt;/p&gt;
{timeStamp=1370903125671, guId=a5c6c2bf-d21c-11e2-a12c-24be05270b5c}
&lt;p&gt;, body.length = 216 ]&lt;br/&gt;
org.apache.flume.ChannelException: Unable to put event on required channel: FileChannel primary &lt;/p&gt;
{ dataDirs: [/var/local/flume/castellan-reader-berkeley-db/data] }
&lt;p&gt;txn: 1638840125&lt;br/&gt;
	at org.apache.flume.channel.ChannelProcessor.processEvent(ChannelProcessor.java:275) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flume-ng-core-1.3.1-SIN124-SNAPSHOT.jar:1.3.1-SIN124-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.logging.log4j.flume.appender.Log4jEventSource.send(Log4jEventSource.java:59) &lt;span class=&quot;error&quot;&gt;&amp;#91;log4j-flume-ng-2.0-beta7.jar:2.0-beta7&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.logging.log4j.flume.appender.FlumeEmbeddedManager.send(FlumeEmbeddedManager.java:123) &lt;span class=&quot;error&quot;&gt;&amp;#91;log4j-flume-ng-2.0-beta7.jar:2.0-beta7&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.logging.log4j.flume.appender.FlumeAppender.append(FlumeAppender.java:86) &lt;span class=&quot;error&quot;&gt;&amp;#91;log4j-flume-ng-2.0-beta7.jar:2.0-beta7&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.logging.log4j.core.config.AppenderControl.callAppender(AppenderControl.java:102) &lt;span class=&quot;error&quot;&gt;&amp;#91;log4j-core-2.0-beta7.jar:2.0-beta7&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.logging.log4j.core.config.LoggerConfig.callAppenders(LoggerConfig.java:424) &lt;span class=&quot;error&quot;&gt;&amp;#91;log4j-core-2.0-beta7.jar:2.0-beta7&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:405) &lt;span class=&quot;error&quot;&gt;&amp;#91;log4j-core-2.0-beta7.jar:2.0-beta7&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:366) &lt;span class=&quot;error&quot;&gt;&amp;#91;log4j-core-2.0-beta7.jar:2.0-beta7&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.logging.log4j.core.Logger.log(Logger.java:110) &lt;span class=&quot;error&quot;&gt;&amp;#91;log4j-core-2.0-beta7.jar:2.0-beta7&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.logging.log4j.spi.AbstractLoggerWrapper.log(AbstractLoggerWrapper.java:55) &lt;span class=&quot;error&quot;&gt;&amp;#91;log4j-api-2.0-beta7.jar:2.0-beta7&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.slf4j.impl.SLF4JLogger.debug(SLF4JLogger.java:154) &lt;span class=&quot;error&quot;&gt;&amp;#91;log4j-slf4j-impl-2.0-beta7.jar:2.0-beta7&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.flume.sink.AvroSink.destroyConnection(AvroSink.java:199) &lt;span class=&quot;error&quot;&gt;&amp;#91;flume-ng-core-1.3.1-SIN124-SNAPSHOT.jar:1.3.1-SIN124-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.flume.sink.AvroSink.verifyConnection(AvroSink.java:224) &lt;span class=&quot;error&quot;&gt;&amp;#91;flume-ng-core-1.3.1-SIN124-SNAPSHOT.jar:1.3.1-SIN124-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.flume.sink.AvroSink.process(AvroSink.java:282) &lt;span class=&quot;error&quot;&gt;&amp;#91;flume-ng-core-1.3.1-SIN124-SNAPSHOT.jar:1.3.1-SIN124-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.flume.sink.FailoverSinkProcessor.process(FailoverSinkProcessor.java:162) &lt;span class=&quot;error&quot;&gt;&amp;#91;flume-ng-core-1.3.1-SIN124-SNAPSHOT.jar:1.3.1-SIN124-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.flume.SinkRunner$PollingRunner.run(SinkRunner.java:147) &lt;span class=&quot;error&quot;&gt;&amp;#91;flume-ng-core-1.3.1-SIN124-SNAPSHOT.jar:1.3.1-SIN124-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:722) &lt;span class=&quot;error&quot;&gt;&amp;#91;?:1.7.0_21&amp;#93;&lt;/span&gt;&lt;br/&gt;
Caused by: java.lang.IllegalStateException: begin() called when transaction is OPEN!&lt;br/&gt;
	at com.google.common.base.Preconditions.checkState(Preconditions.java:145) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;guava-10.0.1.jar:?&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.flume.channel.BasicTransactionSemantics.begin(BasicTransactionSemantics.java:133) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flume-ng-core-1.3.1-SIN124-SNAPSHOT.jar:1.3.1-SIN124-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.flume.channel.ChannelProcessor.processEvent(ChannelProcessor.java:263) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;flume-ng-core-1.3.1-SIN124-SNAPSHOT.jar:1.3.1-SIN124-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
	... 16 more&lt;br/&gt;
2013-06-10 15:25:25,675 ERROR An exception occurred processing Appender FlumeAppender org.apache.flume.ChannelException: Unable to put event on required channel: FileChannel primary &lt;/p&gt;
{ dataDirs: [/var/local/flume/castellan-reader-berkeley-db/data] }
&lt;p&gt;txn: 1638840125&lt;br/&gt;
	at org.apache.flume.channel.ChannelProcessor.processEvent(ChannelProcessor.java:275)&lt;br/&gt;
	at org.apache.logging.log4j.flume.appender.Log4jEventSource.send(Log4jEventSource.java:59)&lt;br/&gt;
	at org.apache.logging.log4j.flume.appender.FlumeEmbeddedManager.send(FlumeEmbeddedManager.java:123)&lt;br/&gt;
	at org.apache.logging.log4j.flume.appender.FlumeAppender.append(FlumeAppender.java:86)&lt;br/&gt;
	at org.apache.logging.log4j.core.config.AppenderControl.callAppender(AppenderControl.java:102)&lt;br/&gt;
	at org.apache.logging.log4j.core.config.LoggerConfig.callAppenders(LoggerConfig.java:424)&lt;br/&gt;
	at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:405)&lt;br/&gt;
	at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:366)&lt;br/&gt;
	at org.apache.logging.log4j.core.Logger.log(Logger.java:110)&lt;br/&gt;
	at org.apache.logging.log4j.spi.AbstractLoggerWrapper.log(AbstractLoggerWrapper.java:55)&lt;br/&gt;
	at org.slf4j.impl.SLF4JLogger.debug(SLF4JLogger.java:154)&lt;br/&gt;
	at org.apache.flume.sink.AvroSink.destroyConnection(AvroSink.java:199)&lt;br/&gt;
	at org.apache.flume.sink.AvroSink.verifyConnection(AvroSink.java:224)&lt;br/&gt;
	at org.apache.flume.sink.AvroSink.process(AvroSink.java:282)&lt;br/&gt;
	at org.apache.flume.sink.FailoverSinkProcessor.process(FailoverSinkProcessor.java:162)&lt;br/&gt;
	at org.apache.flume.SinkRunner$PollingRunner.run(SinkRunner.java:147)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:722)&lt;br/&gt;
Caused by: java.lang.IllegalStateException: begin() called when transaction is OPEN!&lt;br/&gt;
	at com.google.common.base.Preconditions.checkState(Preconditions.java:145)&lt;br/&gt;
	at org.apache.flume.channel.BasicTransactionSemantics.begin(BasicTransactionSemantics.java:133)&lt;br/&gt;
	at org.apache.flume.channel.ChannelProcessor.processEvent(ChannelProcessor.java:263)&lt;br/&gt;
	... 16 more&lt;/p&gt;

&lt;p&gt;That failure appears to be AvroSink line 199.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12652103">LOG4J2-278</key>
            <summary>Embedded Flume agent fails to rollback</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ejsarge">Edward Sargisson</reporter>
                        <labels>
                    </labels>
                <created>Mon, 10 Jun 2013 22:14:38 +0000</created>
                <updated>Thu, 4 Jul 2013 15:22:14 +0000</updated>
                            <resolved>Thu, 4 Jul 2013 15:22:14 +0000</resolved>
                                    <version>2.0-beta7</version>
                                    <fixVersion>2.0-beta8</fixVersion>
                                    <component>Flume Appender</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13700134" author="ralph.goers@dslextreme.com" created="Thu, 4 Jul 2013 15:20:03 +0000"  >&lt;p&gt;I haven&apos;t tested this issue, but with the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-279&quot; title=&quot;Logging from log4j2 FlumeAppender with BerkeleyDB agent from Jetty webapp to Avro source with full queue raises ClosedByInterruptException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-279&quot;&gt;&lt;del&gt;LOG4J2-279&lt;/del&gt;&lt;/a&gt; this issue is probably resolved. Please verify.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12587143" name="flume-embedded-web-flume-2067.tar.gz" size="4575" author="ejsarge" created="Mon, 10 Jun 2013 22:15:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>332427</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 20 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1lcif:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>332756</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>