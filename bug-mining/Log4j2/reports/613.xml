<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:35:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-493] Problem with AsyncLogger when web app is deployed/undeployed multiple times</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-493</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;em&gt;This ticket tracks Async Logger issues in Tomcat when making all loggers async with LoggerContextSelector system property. For Tomcat issues with AsyncRoot/AsyncLogger in the configuration file, see &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-323&quot; title=&quot;ThreadLocal-leak on tomcat shutdown when using async logging&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-323&quot;&gt;&lt;del&gt;LOG4J2-323&lt;/del&gt;&lt;/a&gt;.&lt;/em&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;When redeploying my application in tomcat multiple times, I get an exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-29&quot;&lt;/span&gt; java.lang.NullPointerException
        at org.apache.logging.log4j.core.async.AsyncLogger.stop(AsyncLogger.java:249)
        at org.apache.logging.log4j.core.async.AsyncLoggerContext.stop(AsyncLoggerContext.java:56)
        at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:437)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This seems to be due to the fact that some initialization code happens in the class initializer but is undone in the stop() method which is called during webapp undeployment. This causes issues because in this case the log4j jar is loaded by the shared classloader ($catalina.home/lib) rather than the webapp classloader. This means the AsyncLogger class is not re-created during webapp deployment. &lt;/p&gt;

&lt;p&gt;I am using this structure because I have many 3rd party libraries and want to keep redeployments lightweight. &lt;/p&gt;</description>
                <environment>&lt;p&gt;tomcat 7.0.42&lt;/p&gt;</environment>
        <key id="12688172">LOG4J2-493</key>
            <summary>Problem with AsyncLogger when web app is deployed/undeployed multiple times</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="kireet">Kireet Reddy</reporter>
                        <labels>
                            <label>Async</label>
                    </labels>
                <created>Fri, 10 Jan 2014 01:11:13 +0000</created>
                <updated>Mon, 26 Oct 2015 02:26:54 +0000</updated>
                            <resolved>Fri, 23 Oct 2015 15:12:24 +0000</resolved>
                                    <version>2.0-beta9</version>
                    <version>2.0-rc1</version>
                                    <fixVersion>2.5</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13867421" author="remkop@yahoo.com" created="Fri, 10 Jan 2014 01:58:10 +0000"  >&lt;p&gt;Can you please specify what minor version of Tomcat 7 you are using?&lt;br/&gt;
Also, do you have a single log4j2.xml configuration file shared by all web applications or a separate configuration for each web application?&lt;/p&gt;</comment>
                            <comment id="13867899" author="kireet" created="Fri, 10 Jan 2014 15:21:25 +0000"  >&lt;p&gt;using 7.0.42, the log4j2.xml file is per webapp.&lt;/p&gt;</comment>
                            <comment id="13868670" author="remkop@yahoo.com" created="Sat, 11 Jan 2014 05:53:10 +0000"  >&lt;p&gt;Kireet,&lt;br/&gt;
I will think about how to solve this with AsyncLogger.&lt;/p&gt;

&lt;p&gt;Meanwhile, can you try if one of these two workarounds solves the problem?&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Package the log4j2 jars with your web applications (and remove them from $catalina.home/lib). Using the webapp classloader instead of the shared classloader should solve the problem.&lt;/li&gt;
	&lt;li&gt;Instead of making all loggers Asynchronous with the &lt;tt&gt;Log4jContextSelector&lt;/tt&gt; system property, use &lt;a href=&quot;http://logging.apache.org/log4j/2.x/manual/async.html#MixedSync-Async&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;mixed sync and async loggers&lt;/a&gt;. In the log4j2.xml configuration for your apps, replace &lt;tt&gt;root&lt;/tt&gt; by &lt;tt&gt;AsyncRoot&lt;/tt&gt; and &lt;tt&gt;logger&lt;/tt&gt; by &lt;tt&gt;AsyncLogger&lt;/tt&gt; elements. (Don&apos;t forget to remove the  &lt;tt&gt;Log4jContextSelector&lt;/tt&gt; system property setting.) Mixed sync/async logging has a different implementation that should not suffer from the problem you describe.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13868816" author="kireet" created="Sat, 11 Jan 2014 15:51:56 +0000"  >&lt;p&gt;yes, i have done option 1 for now and it works fine.&lt;/p&gt;</comment>
                            <comment id="13892531" author="jvz" created="Wed, 5 Feb 2014 20:31:06 +0000"  >&lt;p&gt;Could this be related to LOG4J-511?&lt;/p&gt;</comment>
                            <comment id="13892821" author="remkop@yahoo.com" created="Thu, 6 Feb 2014 00:31:57 +0000"  >&lt;p&gt;They are not related: &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-511&quot; title=&quot;Referenced appenders on async appender are shutdown prematurely&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-511&quot;&gt;&lt;del&gt;LOG4J2-511&lt;/del&gt;&lt;/a&gt; is about the underlying appender (e.g. FileAppender) being stopped while the AsyncAppender still has log events in its queue and the async thread is still passing these events to the FileAppender. &lt;/p&gt;

&lt;p&gt;This issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-493&quot; title=&quot;Problem with AsyncLogger when web app is deployed/undeployed multiple times&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-493&quot;&gt;&lt;del&gt;LOG4J2-493&lt;/del&gt;&lt;/a&gt;) has to do with deploy-undeploy-deploy-undeploy use cases in web apps.&lt;br/&gt;
I did not consider this use case in enough depth when designing the Async Loggers. The implementation for making all loggers async uses a static initializer block to set up and start the Disruptor. (AsyncLogger line 116-)&lt;/p&gt;

&lt;p&gt;This works fine if the class is unloaded when the web app is undeployed (when the log4j-core jar is in WEB-INF/lib), but causes issues if the class is &lt;em&gt;not&lt;/em&gt; unloaded when the web app is undeployed (when the log4j-core jar is in the application server&apos;s shared lib directory).&lt;/p&gt;

&lt;p&gt;Note that mixing Async Loggers with synchronous Loggers does not have this problem as the implementation is different. &lt;tt&gt;AsyncLoggerConfigHelper&lt;/tt&gt; is tracking the ref count and only shuts down the Disruptor if the ref count is zero. It also allows for re-creating a new Disruptor if the ref count goes up again. &lt;/p&gt;

&lt;p&gt;Ideally we should do something similar in &lt;tt&gt;AsyncLogger&lt;/tt&gt;. But until then, the workaround is to put the log4j-core jar in WEB-INF/lib...&lt;/p&gt;</comment>
                            <comment id="13893372" author="remkop@yahoo.com" created="Thu, 6 Feb 2014 14:21:17 +0000"  >&lt;p&gt;In revision 1565254 I made a change to &lt;tt&gt;AsyncLogger.stop()&lt;/tt&gt; that prevents the NullPointerException when stopping.&lt;/p&gt;

&lt;p&gt;This does not fix the underlying issue that AsyncLogger is a singleton that can only be initialized once.&lt;br/&gt;
If the log4j-core jar is in the application server&apos;s shared lib directory, users will still see NPEs after deploy-undeploy-redeploying the webapp...&lt;br/&gt;
(I&apos;m just making a note here because the problem will occur in a different place going forward.)&lt;/p&gt;</comment>
                            <comment id="13893878" author="jvz" created="Thu, 6 Feb 2014 22:08:13 +0000"  >&lt;p&gt;So if it&apos;s an NPE in some other location now, how about a different bug?&lt;/p&gt;</comment>
                            <comment id="13907968" author="remkop@yahoo.com" created="Fri, 21 Feb 2014 05:08:27 +0000"  >&lt;p&gt;Good point, Matt. I&apos;ve changed the title of this issue from &quot;NPE in AsyncLogger&quot; to &quot;Problem with AsyncLogger when web app is deployed/undeployed multiple times&quot;.&lt;/p&gt;</comment>
                            <comment id="14969000" author="remkop@yahoo.com" created="Thu, 22 Oct 2015 11:47:32 +0000"  >&lt;p&gt;Quick summary of the AsyncLogger redesign:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;AsyncLogger has been refactored: management of the Disruptor instance has been split off to a separate class AsyncLoggerHelper.&lt;/li&gt;
	&lt;li&gt;The Disruptor is no longer a singleton: each AsyncLoggerHelper instance has a separate Disruptor instance.&lt;/li&gt;
	&lt;li&gt;AsyncLoggers in the same logger context use the same shared AsyncLoggerHelper instance.&lt;/li&gt;
	&lt;li&gt;AsyncLoggerContext is no longer a singleton (each web app has its own instance).&lt;/li&gt;
	&lt;li&gt;AsyncLoggerContext creates and owns the AsyncLoggerHelper for that logger context.&lt;/li&gt;
	&lt;li&gt;Deploying/undeploying a web app will start/stop its AsyncLoggerContext, which starts/stops its AsyncLoggerHelper, which starts/stops its Disruptor.&lt;/li&gt;
	&lt;li&gt;AsyncLoggerContextSelector now subclasses ClassLoaderContextSelector.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Initial test results: with log4j2.xml and all log4j2 jars in $catalina.home/lib, multiple web apps can now be restarted and logging no longer breaks.&lt;/p&gt;</comment>
                            <comment id="14969552" author="remkop@yahoo.com" created="Thu, 22 Oct 2015 18:02:01 +0000"  >&lt;p&gt;Merged branch &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-493&quot; title=&quot;Problem with AsyncLogger when web app is deployed/undeployed multiple times&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-493&quot;&gt;&lt;del&gt;LOG4J2-493&lt;/del&gt;&lt;/a&gt;-AsyncLogger-webapps into master: all tests pass, and the AsyncLogger related code is much improved.&lt;br/&gt;
Need to do some more testing to check that these changes fully resolve this issue.&lt;/p&gt;</comment>
                            <comment id="14970535" author="remkop@yahoo.com" created="Fri, 23 Oct 2015 06:40:15 +0000"  >&lt;p&gt;Made further changes to handle the case where the log4j jars are in $catalina.home/lib, but the log4j2.xml config file is in the WEB-INF/lib folder of one of the web apps. In this scenario, the Disruptor should only be started for web apps with a log4j2 config file. &lt;/p&gt;

&lt;p&gt;The other web apps have a LoggerContext (because the Log4jServletContextListener detects them), but use the DefaultConfiguration (config not found). Starting a Disruptor for these contexts would be wasteful.&lt;/p&gt;

&lt;p&gt;I will mark this issue as resolved when I have a chance to commit these changes.&lt;/p&gt;</comment>
                            <comment id="14971132" author="remkop@yahoo.com" created="Fri, 23 Oct 2015 15:12:24 +0000"  >&lt;p&gt;Fixed in master. Final relevant commit is c705ffdc.&lt;/p&gt;</comment>
                            <comment id="14973562" author="garydgregory" created="Mon, 26 Oct 2015 02:14:27 +0000"  >&lt;p&gt;Hi All,&lt;/p&gt;

&lt;p&gt;I&apos;m not a fan of the name &lt;tt&gt;AsyncLoggerHelper&lt;/tt&gt;, it&apos;s just too much of a kitchen sink name when the job of the class is specific to the LMAX Disruptor. I would suggest something that clues the reader in to what&apos;s going on here. Maybe something like &lt;tt&gt;AsyncLoggerDisruptor&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Gary&lt;/p&gt;</comment>
                            <comment id="14973569" author="remkop@yahoo.com" created="Mon, 26 Oct 2015 02:26:54 +0000"  >&lt;p&gt;I was thinking the same thing. I like your suggestion and will make the change when I have a chance.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12660290">LOG4J2-323</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12907281">LOG4J2-1171</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12907475">LOG4J2-1172</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>367192</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 4 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1rakf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>367501</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>