<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:31:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-223] IllegalStateException thrown during Tomcat shutdown</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-223</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Apr 25, 2013 3:03:33 PM org.apache.catalina.core.StandardServer await
INFO: A valid shutdown command was received via the shutdown port. Stopping the Server instance.
Apr 25, 2013 3:03:33 PM org.apache.coyote.AbstractProtocol pause
INFO: Pausing ProtocolHandler [&quot;http-nio-8080&quot;]
Apr 25, 2013 3:03:33 PM org.apache.coyote.AbstractProtocol pause
INFO: Pausing ProtocolHandler [&quot;ajp-nio-8009&quot;]
Apr 25, 2013 3:03:33 PM org.apache.catalina.core.StandardService stopInternal
INFO: Stopping service Catalina
Apr 25, 2013 3:03:33 PM org.apache.coyote.AbstractProtocol stop
INFO: Stopping ProtocolHandler [&quot;http-nio-8080&quot;]
Apr 25, 2013 3:03:33 PM org.apache.coyote.AbstractProtocol stop
INFO: Stopping ProtocolHandler [&quot;ajp-nio-8009&quot;]
Apr 25, 2013 3:03:33 PM org.apache.coyote.AbstractProtocol destroy
INFO: Destroying ProtocolHandler [&quot;http-nio-8080&quot;]
Apr 25, 2013 3:03:33 PM org.apache.coyote.AbstractProtocol destroy
INFO: Destroying ProtocolHandler [&quot;ajp-nio-8009&quot;]
Apr 25, 2013 3:03:33 PM org.apache.catalina.loader.WebappClassLoader loadClass
INFO: Illegal access: this web application instance has been stopped already.  Could not load org.apache.logging.log4j.core.config.NullConfiguration.  The eventual following stack trace is caused by an error thrown for debugging purposes as well as to attempt to terminate the thread which caused the illegal access, and has no functional impact.
java.lang.IllegalStateException
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1351)
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1310)
	at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:171)
	at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:389)

Exception in thread &quot;Thread-18&quot; java.lang.NoClassDefFoundError: org/apache/logging/log4j/core/config/NullConfiguration
	at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:171)
	at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:389)
Caused by: java.lang.ClassNotFoundException: org.apache.logging.log4j.core.config.NullConfiguration
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1465)
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1310)
	... 2 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12645057">LOG4J2-223</key>
            <summary>IllegalStateException thrown during Tomcat shutdown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rgoers">Ralph Goers</reporter>
                        <labels>
                    </labels>
                <created>Sun, 28 Apr 2013 01:37:30 +0000</created>
                <updated>Tue, 3 Dec 2013 22:37:37 +0000</updated>
                            <resolved>Wed, 29 May 2013 14:45:23 +0000</resolved>
                                    <version>2.0-beta5</version>
                                    <fixVersion>2.0-beta7</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13643868" author="ralph.goers@dslextreme.com" created="Sun, 28 Apr 2013 01:46:58 +0000"  >&lt;p&gt;Configurator was not stopping the LoggerContext but was just reconfiguring to a default configuration. It now stops the LoggerContext.&lt;/p&gt;</comment>
                            <comment id="13643869" author="beamerblvd" created="Sun, 28 Apr 2013 01:47:15 +0000"  >&lt;p&gt;I guess you needed me to file a bug, huh? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Do you still need me to provide a sample project? Say the word. I&apos;ve got it zipped up and can attach it on request.&lt;/p&gt;

&lt;p&gt;By the way, misspelling in the bug title. IlliegalStateException should be IllegalStateException.&lt;/p&gt;</comment>
                            <comment id="13645230" author="remkop@yahoo.com" created="Tue, 30 Apr 2013 04:17:48 +0000"  >&lt;p&gt;Nick, this issue is closed so you cannot attach to it any more.&lt;br/&gt;
However &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-222&quot; title=&quot;Async Logger threadpool not shut down by Tomcat shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-222&quot;&gt;&lt;del&gt;LOG4J2-222&lt;/del&gt;&lt;/a&gt; looks similar and a sample project would be helpful when I double-check Ralph&apos;s solution. Could you attach your sample project to &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-222&quot; title=&quot;Async Logger threadpool not shut down by Tomcat shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-222&quot;&gt;&lt;del&gt;LOG4J2-222&lt;/del&gt;&lt;/a&gt;? &lt;br/&gt;
Much appreciated! -Remko&lt;/p&gt;</comment>
                            <comment id="13645244" author="olamy" created="Tue, 30 Apr 2013 04:53:33 +0000"  >&lt;p&gt;If you need a sample project, I have similar issue with archiva project.&lt;/p&gt;

&lt;p&gt;svn co &lt;a href=&quot;https://svn.apache.org/repos/asf/archiva/trunk/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/archiva/trunk/&lt;/a&gt; archiva-trunk&lt;br/&gt;
cd archiva-trunk&lt;br/&gt;
sh ./t7.sh&lt;/p&gt;

&lt;p&gt;when tomcat running just use ctrl+c&lt;/p&gt;
</comment>
                            <comment id="13645268" author="remkop@yahoo.com" created="Tue, 30 Apr 2013 05:23:34 +0000"  >&lt;p&gt;Thanks Olivier! I&apos;ll take a look when I get home.&lt;/p&gt;</comment>
                            <comment id="13645323" author="ralph.goers@dslextreme.com" created="Tue, 30 Apr 2013 06:39:08 +0000"  >&lt;p&gt;The flume-remote sample web app had this problem and was used to debug and resolve it.  Oliver, can you test the latest code and verify that it fixes the problem you are seeing?&lt;/p&gt;</comment>
                            <comment id="13645482" author="olamy" created="Tue, 30 Apr 2013 11:31:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ralph.goers%40dslextreme.com&quot; class=&quot;user-hover&quot; rel=&quot;ralph.goers@dslextreme.com&quot;&gt;ralph.goers@dslextreme.com&lt;/a&gt; with r1477565 build locally I still have the issue.&lt;/p&gt;

&lt;p&gt;^C2013-04-30 21:29:07,714 DEBUG Shutting down OutputStreamManager SYSTEM_OUT&lt;br/&gt;
2013-04-30 21:29:07,714 DEBUG Shutting down FastRollingFileManager /Users/olamy/dev/tests/archiva-appserver-base-test/logs/archiva.log&lt;br/&gt;
Exception in thread &quot;Thread-6&quot; java.lang.NullPointerException&lt;br/&gt;
	at org.apache.logging.log4j.core.async.AsyncLoggerConfigHelper.shutdown(AsyncLoggerConfigHelper.java:227)&lt;br/&gt;
	at org.apache.logging.log4j.core.async.AsyncLoggerConfig.stopFilter(AsyncLoggerConfig.java:137)&lt;br/&gt;
	at org.apache.logging.log4j.core.config.BaseConfiguration.stop(BaseConfiguration.java:148)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:201)&lt;br/&gt;
	at org.apache.logging.log4j.core.async.AsyncLoggerContext.stop(AsyncLoggerContext.java:57)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:418)&lt;/p&gt;</comment>
                            <comment id="13646507" author="remkop@yahoo.com" created="Wed, 1 May 2013 11:18:39 +0000"  >&lt;p&gt;Olivier, I tried running archiva.&lt;br/&gt;
I could not get it to run (OutOfMemory on my 32bit PC at work), but I did see this:&lt;/p&gt;

&lt;p&gt;2013-05-01 19:56:22,300 DEBUG property AsyncLoggerConfig.WaitStrategy=null &amp;lt;--- (1) Mixed Async Logger &amp;lt;asyncRoot/asyncLogger&amp;gt;&lt;br/&gt;
2013-05-01 19:56:22,300 DEBUG disruptor event handler uses SleepingWaitStrategy&lt;br/&gt;
2013-05-01 19:56:22,331 DEBUG No AsyncLoggerConfig.ExceptionHandler specified&lt;br/&gt;
2013-05-01 19:56:22,331 DEBUG Starting AsyncLoggerConfig disruptor with ringbuffer size 262144...&lt;br/&gt;
2013-05-01 19:56:22,347 DEBUG Reconfiguration completed&lt;br/&gt;
2013-05-01 19:56:22,347 DEBUG Using default SystemClock for timestamps&lt;br/&gt;
2013-05-01 19:56:22,347 DEBUG property AsyncLogger.WaitStrategy=null  &amp;lt;----(2) All Async Loggers (sysprop Log4jContextSelector)&lt;br/&gt;
2013-05-01 19:56:22,347 DEBUG disruptor event handler uses SleepingWaitStrategy&lt;br/&gt;
2013-05-01 19:56:22,394 DEBUG No AsyncLogger.ExceptionHandler specified&lt;br/&gt;
2013-05-01 19:56:22,394 DEBUG Starting AsyncLogger disruptor with ringbuffer size 262144...&lt;/p&gt;

&lt;p&gt;Looks like you are using both Async Logger mechanisms together:&lt;br/&gt;
1) the log4j2.xml config has &amp;lt;asyncLogger&amp;gt; and &amp;lt;asyncRoot&amp;gt;    (and quite a few of them, good test case! )&lt;br/&gt;
2) in addition, /archiva/archiva-modules/archiva-web/archiva-webapp/pom.xml has this line:&lt;br/&gt;
            &amp;lt;Log4jContextSelector&amp;gt;org.apache.logging.log4j.core.async.AsyncLoggerContextSelector&amp;lt;/Log4jContextSelector&amp;gt;&lt;/p&gt;

&lt;p&gt;This means you end up with 2 disruptors. You only need one.&lt;br/&gt;
The fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-222&quot; title=&quot;Async Logger threadpool not shut down by Tomcat shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-222&quot;&gt;&lt;del&gt;LOG4J2-222&lt;/del&gt;&lt;/a&gt; only works for (1). Can you try again after removing the AsyncLoggerContextSelector config from archiva-webapp/pom.xml ?&lt;/p&gt;</comment>
                            <comment id="13646510" author="olamy" created="Wed, 1 May 2013 11:27:51 +0000"  >&lt;p&gt;To get it running I use MAVEN_OPTS=-Djava.awt.headless=true -Xmx768m -Xms768m -XX:MaxPermSize=256m -client -XX:+HeapDumpOnOutOfMemoryError.&lt;br/&gt;
Oh Yes I removed &amp;lt;Log4jContextSelector&amp;gt;org.apache.logging.log4j.core.async.AsyncLoggerContextSelector&amp;lt;/Log4jContextSelector&amp;gt; as it was for testing purpose.&lt;/p&gt;</comment>
                            <comment id="13646524" author="remkop@yahoo.com" created="Wed, 1 May 2013 12:12:33 +0000"  >&lt;p&gt;Thanks, that helped.&lt;br/&gt;
I can now see one disruptor being started, followed by lots of archiva startup logs (cute banner btw)...&lt;/p&gt;

&lt;p&gt;When I press Ctrl-C, I get the same problem that Ralph fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-222&quot; title=&quot;Async Logger threadpool not shut down by Tomcat shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-222&quot;&gt;&lt;del&gt;LOG4J2-222&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
How do I make aptiva use my latest build of log4j2-XX-beta6-SNAPSHOT ?&lt;/p&gt;</comment>
                            <comment id="13646527" author="olamy" created="Wed, 1 May 2013 12:17:48 +0000"  >&lt;p&gt;that&apos;s already the case &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
mb-olamy:archiva olamy$ grep &apos;&amp;lt;log4j.version&apos; pom.xml &lt;br/&gt;
    &amp;lt;log4j.version&amp;gt;2.0-beta6-SNAPSHOT&amp;lt;/log4j.version&amp;gt;&lt;br/&gt;
You must install locally  2.0-beta6-SNAPSHOT (not sure snapshots for repository.a.o are deployed ?)&lt;/p&gt;
</comment>
                            <comment id="13646529" author="remkop@yahoo.com" created="Wed, 1 May 2013 12:24:52 +0000"  >&lt;p&gt;That does not match what I&apos;m seeing:&lt;/p&gt;

&lt;p&gt;Ctrl-C&lt;br/&gt;
2013-05-01 20:57:08,487 DEBUG Generated plugins in 0.000010057 seconds&lt;br/&gt;
2013-05-01 20:57:08,487 DEBUG Jansi is not installed&lt;br/&gt;
2013-05-01 20:57:08,487 DEBUG Reconfiguration started for context Default &amp;lt;--- problem 2 caused by problem 1 below&lt;br/&gt;
2013/05/01 20:57:08 org.apache.coyote.AbstractProtocol pause&lt;br/&gt;
&#24773;&#22577;: Pausing ProtocolHandler &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;http-bio-9091&amp;quot;&amp;#93;&lt;/span&gt;&lt;br/&gt;
2013-05-01 20:57:08,519 DEBUG Generated plugins in 0.000008660 seconds&lt;br/&gt;
...&lt;br/&gt;
2013-05-01 20:57:08,550 DEBUG Reconfiguration completed&lt;br/&gt;
Exception in thread &quot;Thread-3&quot; java.lang.IllegalStateException: Shutdown in progress&lt;br/&gt;
        at java.lang.ApplicationShutdownHooks.add(ApplicationShutdownHooks.java:39)&lt;br/&gt;
        at java.lang.Runtime.addShutdownHook(Runtime.java:192)&lt;br/&gt;
        at org.apache.logging.log4j.core.LoggerContext.start(LoggerContext.java:150)&lt;br/&gt;
        at org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:84)&lt;br/&gt;
        at org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:34)&lt;br/&gt;
        at org.apache.logging.log4j.LogManager.getContext(LogManager.java:138)    &amp;lt;------------ PROBLEM 1 ***********&lt;br/&gt;
        at org.apache.logging.log4j.core.async.AsyncLoggerConfig.stopFilter(AsyncLoggerConfig.java:132)&lt;br/&gt;
        at org.apache.logging.log4j.core.config.BaseConfiguration.stop(BaseConfiguration.java:136)&lt;br/&gt;
        at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:172)&lt;br/&gt;
        at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:389)&lt;/p&gt;

&lt;p&gt;the line marked with PROBLEM 2 should not happen with the latest  2.0-beta6-SNAPSHOT:&lt;br/&gt;
that call to LogManager.getContext was commented out...&lt;/p&gt;</comment>
                            <comment id="13646530" author="remkop@yahoo.com" created="Wed, 1 May 2013 12:28:28 +0000"  >&lt;p&gt;ok I will try to replace the files in the local maven repo with my last build&lt;/p&gt;</comment>
                            <comment id="13646532" author="olamy" created="Wed, 1 May 2013 12:31:30 +0000"  >&lt;p&gt;sure.&lt;br/&gt;
mvn clean install (in log4j2 must do that &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;)&lt;/p&gt;</comment>
                            <comment id="13646566" author="remkop@yahoo.com" created="Wed, 1 May 2013 13:27:03 +0000"  >&lt;p&gt;Phew. I can now reproduce the problem (at least very similar):&lt;/p&gt;

&lt;p&gt;Ctrl-C&lt;br/&gt;
2013-05-01 21:53:04,093 DEBUG Shutting down OutputStreamManager SYSTEM_OUT&lt;br/&gt;
2013-05-01 21:53:04,093 DEBUG Shutting down FastRollingFileManager D:\data\workspace-4.2.1\archiva\archiva-modules\archi&lt;br/&gt;
va-web\archiva-webapp\target/appserver-base/logs/archiva.log&lt;br/&gt;
2013/05/01 21:53:04 org.apache.coyote.AbstractProtocol pause&lt;br/&gt;
&#24773;&#22577;: Pausing ProtocolHandler &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;http-bio-9091&amp;quot;&amp;#93;&lt;/span&gt;&lt;br/&gt;
Exception in thread &quot;Thread-3&quot; java.lang.NullPointerException&lt;br/&gt;
        at org.apache.logging.log4j.core.async.AsyncLoggerConfigHelper.shutdown(AsyncLoggerConfigHelper.java:227)&lt;br/&gt;
        at org.apache.logging.log4j.core.async.AsyncLoggerConfig.stopFilter(AsyncLoggerConfig.java:137)&lt;br/&gt;
        at org.apache.logging.log4j.core.config.BaseConfiguration.stop(BaseConfiguration.java:148)&lt;br/&gt;
        at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:201)&lt;br/&gt;
        at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:418)&lt;/p&gt;

&lt;p&gt;I suspect that the ShutdownThread runs after the Disruptor has already been shut down in the main application thread.&lt;br/&gt;
The shutdown() code does not check if the static field holding the Disruptor has already been set to null.&lt;/p&gt;

&lt;p&gt;The fix is:&lt;br/&gt;
AsyncLoggerConfigHelper.shutdown() line 222: &lt;br/&gt;
CURRENT:&lt;br/&gt;
        Disruptor&amp;lt;Log4jEventWrapper&amp;gt; temp = disruptor;&lt;/p&gt;

&lt;p&gt;FIXED: &lt;br/&gt;
        Disruptor&amp;lt;Log4jEventWrapper&amp;gt; temp = disruptor;&lt;br/&gt;
        if (temp == null) &lt;/p&gt;
{ return; }</comment>
                            <comment id="13646629" author="remkop@yahoo.com" created="Wed, 1 May 2013 15:01:28 +0000"  >&lt;p&gt;Fixed in revision 1478040.&lt;br/&gt;
I&apos;ll re-test tomorrow. Olivier, could you also take a look if you have time?&lt;/p&gt;</comment>
                            <comment id="13647130" author="remkop@yahoo.com" created="Thu, 2 May 2013 00:31:24 +0000"  >&lt;p&gt;Tested and looks good. Archiva/Tomcat now shuts down cleanly on Ctrl-C.&lt;/p&gt;

&lt;p&gt;...&lt;br/&gt;
&#24773;&#22577;: Starting ProtocolHandler &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;http-bio-9091&amp;quot;&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Ctrl-C&lt;/p&gt;

&lt;p&gt;2013-05-02 09:29:06,786 DEBUG Shutting down OutputStreamManager SYSTEM_OUT&lt;br/&gt;
2013-05-02 09:29:06,786 DEBUG Shutting down FastRollingFileManager D:\data\workspace-4.2.1\archiva\archiva-modules\archi&lt;br/&gt;
va-web\archiva-webapp\target/appserver-base/logs/archiva.log&lt;br/&gt;
Terminate batch job (Y/N)? y&lt;/p&gt;

&lt;p&gt;D:\data\workspace-4.2.1\archiva&amp;gt;&lt;/p&gt;</comment>
                            <comment id="13647340" author="olamy" created="Thu, 2 May 2013 06:27:53 +0000"  >&lt;p&gt;Thanks Dude !&lt;/p&gt;</comment>
                            <comment id="13652715" author="beamerblvd" created="Thu, 9 May 2013 03:48:09 +0000"  >&lt;p&gt;I still get this when shutting down Tomcat using Log4j2 beta6. This issue is not fixed.&lt;/p&gt;

&lt;p&gt;INFO: Illegal access: this web application instance has been stopped already.  Could not load org.apache.logging.log4j.core.config.NullConfiguration.  The eventual following stack trace is caused by an error thrown for debugging purposes as well as to attempt to terminate the thread which caused the illegal access, and has no functional impact.&lt;br/&gt;
java.lang.IllegalStateException&lt;br/&gt;
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1351)&lt;br/&gt;
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1310)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:199)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:418)&lt;/p&gt;

&lt;p&gt;Exception in thread &quot;Thread-13&quot; java.lang.NoClassDefFoundError: org/apache/logging/log4j/core/config/NullConfiguration&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:199)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:418)&lt;br/&gt;
Caused by: java.lang.ClassNotFoundException: org.apache.logging.log4j.core.config.NullConfiguration&lt;br/&gt;
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1465)&lt;br/&gt;
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1310)&lt;br/&gt;
	... 2 more&lt;/p&gt;</comment>
                            <comment id="13652730" author="remkop@yahoo.com" created="Thu, 9 May 2013 04:26:52 +0000"  >&lt;p&gt;Darn! Hmm... I guess I need help to reproduce this issue. (It worked when Olivier and I tested.) &lt;br/&gt;
Would it be possible to attach a small case that demonstrates the issue?&lt;/p&gt;</comment>
                            <comment id="13652886" author="beamerblvd" created="Thu, 9 May 2013 11:50:51 +0000"  >&lt;p&gt;Reopening since this is not fixed in beta6 and a test project needs to be attached.&lt;/p&gt;</comment>
                            <comment id="13652891" author="beamerblvd" created="Thu, 9 May 2013 12:00:04 +0000"  >&lt;p&gt;Attached:&lt;br/&gt;
Logging-Integration.zip - IntelliJ project with source code&lt;br/&gt;
logging-integration-1.0.0.SNAPSHOT.war - WAR file that can be deployed directly in Tomcat&lt;/p&gt;

&lt;p&gt;You only need to go to &lt;a href=&quot;http://localhost:8080/appcontext/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/appcontext/&lt;/a&gt; (replace appcontext with however you deploy it). The page will be blank but logging has taken place. That&apos;s enough to cause Log4j to start up. Then when you shut down Tomcat you&apos;ll see the errors. If you don&apos;t go to &lt;a href=&quot;http://localhost:8080/appcontext/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/appcontext/&lt;/a&gt; to start up Log4j you won&apos;t see the errors.&lt;/p&gt;</comment>
                            <comment id="13658527" author="remkop@yahoo.com" created="Wed, 15 May 2013 16:41:53 +0000"  >&lt;p&gt;I have been unable to find the time to look at this and I don&apos;t expect this to change in the next few days. If anyone has the time and inclination to tackle this one, please go ahead.&lt;/p&gt;</comment>
                            <comment id="13661262" author="beamerblvd" created="Sat, 18 May 2013 03:56:32 +0000"  >&lt;p&gt;In the latest 2.0-beta7-SNAPSHOT, this is still not fixed:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO: Illegal access: this web application instance has been stopped already.  Could not load org.apache.logging.log4j.core.config.NullConfiguration.  The eventual following stack trace is caused by an error thrown for debugging purposes as well as to attempt to terminate the thread which caused the illegal access, and has no functional impact.
java.lang.IllegalStateException
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1351)
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1310)
	at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:201)
	at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:427)

Exception in thread &quot;Thread-19&quot; java.lang.NoClassDefFoundError: org/apache/logging/log4j/core/config/NullConfiguration
	at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:201)
	at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:427)
Caused by: java.lang.ClassNotFoundException: org.apache.logging.log4j.core.config.NullConfiguration
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1465)
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1310)
	... 2 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;d really like to see this issue fixed before beta7 is released. Are you able to replicate it in my sample application? Or have you still not been able to look at it? Is there anyone else that can look at it?&lt;/p&gt;

&lt;p&gt;I&apos;d try to help with this, but now that Spring 4.0.0.M1 has been released (today), I have to get back to working on my book now. I&apos;m about four weeks behind on chapters. Ooops.&lt;/p&gt;</comment>
                            <comment id="13661266" author="remkop@yahoo.com" created="Sat, 18 May 2013 04:12:37 +0000"  >&lt;p&gt;Haven&apos;t had a chance. Have been making long hours at work.&lt;br/&gt;
I don&apos;t think I&apos;ll be able to this weekend. I don&apos;t even have Tomcat set up yet...&lt;/p&gt;

&lt;p&gt;Btw, could you provide some more details on versions and stuff?&lt;br/&gt;
Java version, Tomcat version? Any command line options?&lt;br/&gt;
I&apos;m not 100% sure but you are not using Async Loggers, are you? &lt;br/&gt;
Are you using another ContextSelector? Also, not sure if relevant, but are you using the JSP TagLib?&lt;/p&gt;</comment>
                            <comment id="13661268" author="beamerblvd" created="Sat, 18 May 2013 04:21:09 +0000"  >&lt;p&gt;Java 1.8.0-ea-b88&lt;br/&gt;
Tomcat 8.0-SNAPSHOT (r1478984)&lt;br/&gt;
No special command-line options.&lt;br/&gt;
I am not using Async Loggers.&lt;br/&gt;
I am not using another ContextSelector.&lt;br/&gt;
I /am/ using the Tag Library but I get this error even if I don&apos;t go to any JSPs, so I don&apos;t think that&apos;s it.&lt;/p&gt;

&lt;p&gt;I&apos;d encourage you to try to duplicate this on Java 7 / Tomcat 7 before bothering trying to replicate my setup.&lt;/p&gt;</comment>
                            <comment id="13661289" author="remkop@yahoo.com" created="Sat, 18 May 2013 05:09:56 +0000"  >&lt;p&gt;Thanks. &lt;br/&gt;
Unexpected family circumstances just came up and I won&apos;t have access to a PC today, maybe this weekend.  Only iPhone. &lt;br/&gt;
Could you paste the output of StatusLogger debug output here?&lt;/p&gt;</comment>
                            <comment id="13661373" author="beamerblvd" created="Sat, 18 May 2013 15:19:37 +0000"  >&lt;p&gt;With &lt;tt&gt;status=&quot;DEBUG&quot;&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-05-18 10:10:54,533 DEBUG Generated plugins in 0.000028800 seconds
2013-05-18 10:10:54,533 DEBUG Generated plugins in 0.000013200 seconds
2013-05-18 10:10:54,534 DEBUG Generated plugins in 0.000012700 seconds
2013-05-18 10:10:54,534 DEBUG Generated plugins in 0.000013100 seconds
2013-05-18 10:10:54,535 DEBUG Generated plugins in 0.000013500 seconds
2013-05-18 10:10:54,535 DEBUG Generated plugins in 0.000012700 seconds
2013-05-18 10:10:54,536 DEBUG Generated plugins in 0.000012900 seconds
2013-05-18 10:10:54,536 DEBUG Generated plugins in 0.000012400 seconds
2013-05-18 10:10:54,536 DEBUG Generated plugins in 0.000012100 seconds
2013-05-18 10:10:54,537 DEBUG Generated plugins in 0.000012600 seconds
2013-05-18 10:10:54,537 DEBUG Generated plugins in 0.000012000 seconds
2013-05-18 10:10:54,538 DEBUG Generated plugins in 0.000012300 seconds
2013-05-18 10:10:54,538 DEBUG Generated plugins in 0.000015800 seconds
2013-05-18 10:10:54,539 DEBUG Generated plugins in 0.000015800 seconds
2013-05-18 10:10:54,539 DEBUG Generated plugins in 0.000012700 seconds
2013-05-18 10:10:54,540 DEBUG Generated plugins in 0.000012800 seconds
2013-05-18 10:10:54,548 DEBUG Calling createLayout on class org.apache.logging.log4j.core.layout.PatternLayout for element PatternLayout with params(pattern=&quot;%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n&quot;, Configuration(C:\Users\Nicholas\Desktop\Logging-Integration\target\logging-integration-1.0.0.SNAPSHOT\WEB-INF\classes\log4j2.xml), null, charset=&quot;null&quot;, suppressExceptions=&quot;null&quot;)
2013-05-18 10:10:54,549 DEBUG Generated plugins in 0.000019700 seconds
2013-05-18 10:10:54,551 DEBUG Calling createAppender on class org.apache.logging.log4j.core.appender.ConsoleAppender for element Console with params(PatternLayout(%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n), null, target=&quot;SYSTEM_OUT&quot;, name=&quot;Console&quot;, follow=&quot;null&quot;, suppressExceptions=&quot;null&quot;)
2013-05-18 10:10:54,551 DEBUG Jansi is not installed
2013-05-18 10:10:54,552 DEBUG Calling createLayout on class org.apache.logging.log4j.core.layout.PatternLayout for element PatternLayout with params(pattern=&quot;%d{HH:mm:ss.SSS} [%t] %X{id} %X{username} %-5level %c{36} %l: %msg%n&quot;, Configuration(C:\Users\Nicholas\Desktop\Logging-Integration\target\logging-integration-1.0.0.SNAPSHOT\WEB-INF\classes\log4j2.xml), null, charset=&quot;null&quot;, suppressExceptions=&quot;null&quot;)
2013-05-18 10:10:54,553 DEBUG Calling createPolicy on class org.apache.logging.log4j.core.appender.rolling.SizeBasedTriggeringPolicy for element SizeBasedTriggeringPolicy with params(size=&quot;10 MB&quot;)
2013-05-18 10:10:54,554 DEBUG Calling createPolicy on class org.apache.logging.log4j.core.appender.rolling.CompositeTriggeringPolicy for element Policies with params(policies={SizeBasedTriggeringPolicy(size=10485760)})
2013-05-18 10:10:54,555 DEBUG Calling createStrategy on class org.apache.logging.log4j.core.appender.rolling.DefaultRolloverStrategy for element DefaultRolloverStrategy with params(max=&quot;4&quot;, min=&quot;1&quot;, fileIndex=&quot;null&quot;, Configuration(C:\Users\Nicholas\Desktop\Logging-Integration\target\logging-integration-1.0.0.SNAPSHOT\WEB-INF\classes\log4j2.xml))
2013-05-18 10:10:54,557 DEBUG Calling createAppender on class org.apache.logging.log4j.core.appender.RollingFileAppender for element RollingFile with params(fileName=&quot;../logs/application.log&quot;, filePattern=&quot;../logs/application-%d{MM-dd-yyyy}-%i.log&quot;, append=&quot;null&quot;, name=&quot;WroxFileAppender&quot;, bufferedIO=&quot;null&quot;, immediateFlush=&quot;null&quot;, Policies(CompositeTriggeringPolicy{SizeBasedTriggeringPolicy(size=10485760)}), DefaultRolloverStrategy(DefaultRolloverStrategy(min=1, max=4)), PatternLayout(%d{HH:mm:ss.SSS} [%t] %X{id} %X{username} %-5level %c{36} %l: %msg%n), null, suppressExceptions=&quot;null&quot;, advertise=&quot;null&quot;, advertiseURI=&quot;null&quot;, Configuration(C:\Users\Nicholas\Desktop\Logging-Integration\target\logging-integration-1.0.0.SNAPSHOT\WEB-INF\classes\log4j2.xml))
2013-05-18 10:10:54,561 DEBUG Starting RollingFileManager ../logs/application.log
2013-05-18 10:10:54,563 DEBUG Generated plugins in 0.000018300 seconds
2013-05-18 10:10:54,565 DEBUG Calling createAppenders on class org.apache.logging.log4j.core.config.plugins.AppendersPlugin for element appenders with params(appenders={Console, WroxFileAppender})
2013-05-18 10:10:54,565 DEBUG Generated plugins in 0.000013300 seconds
2013-05-18 10:10:54,566 DEBUG Calling createAppenderRef on class org.apache.logging.log4j.core.config.AppenderRef for element appender-ref with params(ref=&quot;Console&quot;, level=&quot;null&quot;, null)
2013-05-18 10:10:54,567 DEBUG Calling createLogger on class org.apache.logging.log4j.core.config.LoggerConfig$RootLogger for element root with params(additivity=&quot;null&quot;, level=&quot;warn&quot;, includeLocation=&quot;null&quot;, appender-ref={org.apache.logging.log4j.core.config.AppenderRef@5445de97}, properties={}, Configuration(C:\Users\Nicholas\Desktop\Logging-Integration\target\logging-integration-1.0.0.SNAPSHOT\WEB-INF\classes\log4j2.xml), null)
2013-05-18 10:10:54,568 DEBUG Calling createAppenderRef on class org.apache.logging.log4j.core.config.AppenderRef for element appender-ref with params(ref=&quot;WroxFileAppender&quot;, level=&quot;null&quot;, null)
2013-05-18 10:10:54,569 DEBUG Calling createLogger on class org.apache.logging.log4j.core.config.LoggerConfig for element logger with params(additivity=&quot;false&quot;, level=&quot;info&quot;, name=&quot;com.wrox&quot;, includeLocation=&quot;null&quot;, appender-ref={org.apache.logging.log4j.core.config.AppenderRef@70970527}, properties={}, Configuration(C:\Users\Nicholas\Desktop\Logging-Integration\target\logging-integration-1.0.0.SNAPSHOT\WEB-INF\classes\log4j2.xml), null)
2013-05-18 10:10:54,570 DEBUG Calling createAppenderRef on class org.apache.logging.log4j.core.config.AppenderRef for element appender-ref with params(ref=&quot;WroxFileAppender&quot;, level=&quot;null&quot;, null)
2013-05-18 10:10:54,571 DEBUG Calling createLogger on class org.apache.logging.log4j.core.config.LoggerConfig for element logger with params(additivity=&quot;null&quot;, level=&quot;info&quot;, name=&quot;org.apache&quot;, includeLocation=&quot;null&quot;, appender-ref={org.apache.logging.log4j.core.config.AppenderRef@17238e67}, properties={}, Configuration(C:\Users\Nicholas\Desktop\Logging-Integration\target\logging-integration-1.0.0.SNAPSHOT\WEB-INF\classes\log4j2.xml), null)
2013-05-18 10:10:54,572 DEBUG Calling createLoggers on class org.apache.logging.log4j.core.config.plugins.LoggersPlugin for element loggers with params(loggers={root, com.wrox, org.apache})
2013-05-18 10:10:54,574 DEBUG Reconfiguration completed&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;All of these messages happen when I go to the first page in the sample app. There are no debug messages that occur while Tomcat is shutting down / while the errors are occurring. I changed it to &lt;tt&gt;status=&quot;TRACE&quot;&lt;/tt&gt; and didn&apos;t get any extra output.&lt;/p&gt;</comment>
                            <comment id="13661447" author="remkop@yahoo.com" created="Sun, 19 May 2013 00:38:03 +0000"  >&lt;p&gt;I was unable to reproduce this issue on Apache Tomcat/7.0.40 or Apache Tomcat/6.0.36 (on Windows 7 (64b), Java 1.7.0_11 64bit).&lt;/p&gt;

&lt;p&gt;Steps to reproduce:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;install Tomcat&lt;/li&gt;
	&lt;li&gt;cd to TOMCAT_HOME/bin&lt;/li&gt;
	&lt;li&gt;run startup.bat&lt;/li&gt;
	&lt;li&gt;drop attached file logging-integration-1.0.0.SNAPSHOT.war into TOMCAT_HOME/webapps&lt;/li&gt;
	&lt;li&gt;(there seems to be an extra directory named &quot;logging-integration-1.0.0.SNAPSHOT&quot; inside the WAR file, so pull the contents of TOMCAT_HOME/webapps/logging-integration-1.0.0.SNAPSHOT/logging-integration-1.0.0.SNAPSHOT into TOMCAT_HOME/webapps/logging-integration-1.0.0.SNAPSHOT)&lt;/li&gt;
	&lt;li&gt;open &lt;a href=&quot;http://localhost:8080/logging-integration-1.0.0.SNAPSHOT/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/logging-integration-1.0.0.SNAPSHOT/&lt;/a&gt; in browser
	&lt;ol&gt;
		&lt;li&gt;(result on Tomcat 6) 404 - /logging-integration-1.0.0.SNAPSHOT/files is not available&lt;/li&gt;
		&lt;li&gt;(result on Tomcat 7) 404 - /logging-integration-1.0.0.SNAPSHOT/ is not available&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;run shutdown.bat&lt;/li&gt;
	&lt;li&gt;Tomcat stops without any issues&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Sorry Nick, I am giving up on this one.&lt;/p&gt;</comment>
                            <comment id="13661457" author="beamerblvd" created="Sun, 19 May 2013 01:45:29 +0000"  >&lt;p&gt;Remko,&lt;/p&gt;

&lt;p&gt;Waaaaiiit! Don&apos;t give up yet! My apologies. I did three things wrong here:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;I compiled the application using Java 8, so you won&apos;t be able to run it (that&apos;s why you&apos;re getting 404 errors most likely).&lt;/li&gt;
	&lt;li&gt;I created the WAR file incorrectly.&lt;/li&gt;
	&lt;li&gt;I hadn&apos;t narrowed down the exact conditions that must take place.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I have compiled with Java 6 and created a proper WAR file. I was able to get the WAR file to duplicate the problem by following the following steps:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Install Tomcat&lt;/li&gt;
	&lt;li&gt;Open TOMCAT_HOME/conf and add a user to tomcat-users.xml with the manager-gui role (e.g., &lt;tt&gt;&amp;lt;user username=&quot;admin&quot; password=&quot;admin&quot; roles=&quot;manager-gui&quot;/&amp;gt;&lt;/tt&gt;).&lt;/li&gt;
	&lt;li&gt;Copy log4j-223.war into TOMCAT_HOME/webapps&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;cd&lt;/tt&gt; into TOMCAT_HOME/bin&lt;/li&gt;
	&lt;li&gt;Run &lt;tt&gt;catalina.bat run&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Go to &lt;a href=&quot;http://localhost:8080/log4j-223/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/log4j-223/files&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Go to &lt;a href=&quot;http://localhost:8080/manager&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/manager&lt;/a&gt; and enter proper credentials (admin/admin)&lt;/li&gt;
	&lt;li&gt;Click the &quot;Undeploy&quot; button next to the log4j-223 application&lt;/li&gt;
	&lt;li&gt;Return to command prompt and Ctrl+C to shut down Tomcat&lt;/li&gt;
	&lt;li&gt;Error appears&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13661487" author="remkop@yahoo.com" created="Sun, 19 May 2013 04:14:03 +0000"  >&lt;p&gt;with the above steps I was able to reproduce the issue. (I only tried Tomcat 7, btw.)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;5 19, 2013 11:12:11 AM org.apache.catalina.loader.WebappClassLoader loadClass
INFO: Illegal access: &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; web application instance has been stopped already. 
      Could not load org.apache.logging.log4j.core.config.NullConfiguration. 
      The eventual following stack trace is caused by an error thrown &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; debugging purposes as well as 
      to attempt to terminate the thread which caused the illegal access, and has no functional impact.
java.lang.IllegalStateException
        at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1600)
        at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1559)
        at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:199)
        at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:418)

Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-36&quot;&lt;/span&gt; java.lang.NoClassDefFoundError: org/apache/logging/log4j/core/config/NullConfiguration
        at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:199)
        at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:418)
Caused by: java.lang.ClassNotFoundException: org.apache.logging.log4j.core.config.NullConfiguration
        at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1714)
        at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1559)
        ... 2 more
5 19, 2013 11:12:11 AM org.apache.coyote.AbstractProtocol pause
INFO: Pausing ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-apr-8009&quot;&lt;/span&gt;]
5 19, 2013 11:12:11 AM org.apache.catalina.core.StandardService stopInternal
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looks like Catalina&apos;s WebappClassLoader won&apos;t allow a web application to load new classes after it has been stopped.&lt;/p&gt;

&lt;p&gt;The problem seems to be the code here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void stop() {
    configLock.lock();
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (status == Status.STOPPED) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        }
        status = Status.STOPPING;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shutdownThread != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.getRuntime().removeShutdownHook(shutdownThread);
            shutdownThread = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        }
        Configuration prev = config;
        config = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NullConfiguration(); &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;-- Tomcat won&apos;t let us &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
&lt;/span&gt;        updateLoggers();
        prev.stop();
        externalContext = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        status = Status.STOPPED;
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        configLock.unlock();
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here is what I tried: at the top of LoggerContext, declare a static field holding an instance of NullConfiguration. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-comment&quot;&gt;// LOG4J2-223 cannot load &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;during stop() in web apps, so load &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; up front
&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; NullConfiguration NULL_CONFIGURATION = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NullConfiguration();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then, in the stop() method, instead of creating a new NullConfiguration, return the pre-loaded instance:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;status = Status.STOPPING;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shutdownThread != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.getRuntime().removeShutdownHook(shutdownThread);
    shutdownThread = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
}
Configuration prev = config;
config = NULL_CONFIGURATION;
updateLoggers();
prev.stop();
externalContext = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
status = Status.STOPPED;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To test this, I unzipped the log4j-223.war file and replaced these files:&lt;br/&gt;
log4j-api-2.0-beta6.jar&lt;br/&gt;
log4j-core-2.0-beta6.jar&lt;br/&gt;
log4j-jcl-2.0-beta6.jar&lt;br/&gt;
log4j-slf4j-impl-2.0-beta6.jar&lt;br/&gt;
log4j-taglib-2.0-beta6.jar&lt;/p&gt;

&lt;p&gt;with these freshly built files:&lt;br/&gt;
log4j-api-2.0-beta7-SNAPSHOT.jar&lt;br/&gt;
log4j-core-2.0-beta7-SNAPSHOT.jar&lt;br/&gt;
log4j-jcl-2.0-beta7-SNAPSHOT.jar&lt;br/&gt;
log4j-slf4j-impl-2.0-beta7-SNAPSHOT.jar&lt;br/&gt;
log4j-taglib-2.0-beta7-SNAPSHOT.jar&lt;/p&gt;

&lt;p&gt;Then I followed the same steps as Nick described above to check the result.&lt;/p&gt;

&lt;p&gt;Opening &lt;a href=&quot;http://localhost:8080/log4j-223a/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/log4j-223a/&lt;/a&gt; gave (I actually got a Japanese error message but this is my rough translation):&lt;br/&gt;
 500 - /index.jsp (line: 1, column: 1) absolute URI: &lt;a href=&quot;http://logging.apache.org/log4j/tld/log&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://logging.apache.org/log4j/tld/log&lt;/a&gt; cannot be resolved in&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; web.xml or the deployed jar for this application&lt;/p&gt;

&lt;p&gt;I think this is related to the JSP Taglib, here is the stack trace for completeness:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;org.apache.jasper.JasperException: /index.jsp (line: 1, column: 1) absolute URI: 
                     http:&lt;span class=&quot;code-comment&quot;&gt;//logging.apache.org/log4j/tld/log cannot be resolved in(?) 
&lt;/span&gt;                     web.xml or the deployed jar &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; application
	org.apache.jasper.compiler.DefaultErrorHandler.jspError(DefaultErrorHandler.java:42)
	org.apache.jasper.compiler.ErrorDispatcher.dispatch(ErrorDispatcher.java:443)
	org.apache.jasper.compiler.ErrorDispatcher.jspError(ErrorDispatcher.java:89)
	org.apache.jasper.compiler.Parser.processIncludeDirective(Parser.java:324)
	org.apache.jasper.compiler.Parser.addInclude(Parser.java:375)
	org.apache.jasper.compiler.Parser.parse(Parser.java:132)
	org.apache.jasper.compiler.ParserController.doParse(ParserController.java:242)
	org.apache.jasper.compiler.ParserController.parse(ParserController.java:102)
	org.apache.jasper.compiler.&lt;span class=&quot;code-object&quot;&gt;Compiler&lt;/span&gt;.generateJava(&lt;span class=&quot;code-object&quot;&gt;Compiler&lt;/span&gt;.java:198)
	org.apache.jasper.compiler.&lt;span class=&quot;code-object&quot;&gt;Compiler&lt;/span&gt;.compile(&lt;span class=&quot;code-object&quot;&gt;Compiler&lt;/span&gt;.java:373)
	org.apache.jasper.compiler.&lt;span class=&quot;code-object&quot;&gt;Compiler&lt;/span&gt;.compile(&lt;span class=&quot;code-object&quot;&gt;Compiler&lt;/span&gt;.java:353)
	org.apache.jasper.compiler.&lt;span class=&quot;code-object&quot;&gt;Compiler&lt;/span&gt;.compile(&lt;span class=&quot;code-object&quot;&gt;Compiler&lt;/span&gt;.java:340)
	org.apache.jasper.JspCompilationContext.compile(JspCompilationContext.java:646)
	org.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:357)
	org.apache.jasper.servlet.JspServlet.serviceJspFile(JspServlet.java:390)
	org.apache.jasper.servlet.JspServlet.service(JspServlet.java:334)
	javax.servlet.http.HttpServlet.service(HttpServlet.java:728)
	com.wrox.LoggingFilter.doFilter(LoggingFilter.java:32)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Undeploying the webapp in the Tomcat manager did not work cleanly: &lt;br/&gt;
webapps\log4j-223a\WEB-INF\lib\log4j-core-2.0-beta7-SNAPSHOT.jar was not removed&lt;br/&gt;
and Tomcat gave these warnings in the console:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;5 19, 2013 12:46:43 &#21320;&#24460; org.apache.catalina.startup.ExpandWar deleteDir
SEVERE: [C:\apps\apache-tomcat-7.0.40\webapps\log4j-223a\WEB-INF\lib] could not be completely deleted. The presence of the remaining files may cause p
roblems
5 19, 2013 12:46:43 &#21320;&#24460; org.apache.catalina.startup.ExpandWar deleteDir
SEVERE: [C:\apps\apache-tomcat-7.0.40\webapps\log4j-223a\WEB-INF] could not be completely deleted. The presence of the remaining files may cause problems
5 19, 2013 12:46:43 &#21320;&#24460; org.apache.catalina.startup.ExpandWar deleteDir
SEVERE: [C:\apps\apache-tomcat-7.0.40\webapps\log4j-223a] could not be completely deleted. The presence of the remaining files may cause problems
5 19, 2013 12:46:43 &#21320;&#24460; org.apache.catalina.startup.ExpandWar delete
SEVERE: [C:\apps\apache-tomcat-7.0.40\webapps\log4j-223a] could not be completely deleted. The presence of the remaining files may cause problems
5 19, 2013 12:46:43 &#21320;&#24460; org.apache.catalina.startup.HostConfig deployDirectory
INFO: Web application directory  C:\apps\apache-tomcat-7.0.40\webapps\log4j-223a deploying
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After this, Ctrl-C in the command prompt does shut down Tomcat without errors.&lt;/p&gt;</comment>
                            <comment id="13661488" author="remkop@yahoo.com" created="Sun, 19 May 2013 04:25:40 +0000"  >&lt;p&gt;The 500 error above is probably not related to Taglib. It also occurred after replacing the logging.jsp with a simple &quot;Hello world&quot; containing only HTML tags.&lt;/p&gt;

&lt;p&gt;Not sure if this is related, but the console also shows this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;5 19, 2013 1:18:36 &#21320;&#24460; org.apache.jasper.compiler.TldLocationsCache tldScanJar
INFO: At least one JAR was scanned &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; TLDs yet contained no TLDs. Enable debug logging &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; logger &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a complete list of JARs that were scanned
but no TLDs were found in them. Skipping unneeded JARs during scanning can improve startup time and JSP compilation time.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13661489" author="beamerblvd" created="Sun, 19 May 2013 04:33:02 +0000"  >&lt;p&gt;Try going to &lt;a href=&quot;http://localhost:8080/log4j-223a/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/log4j-223a/files&lt;/a&gt; directly instead of &lt;a href=&quot;http://localhost:8080/log4j-223a/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/log4j-223a/&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Cause: log4j-taglib*.jar contains a TLD (Tag Library Descriptor) used in the JSPs. The container must scan this JAR to pick up the TLD. However, since Log4j has never had a tag library until now, Tomcat has an exclusion built in that says not to scan log4j*.jar files for tag libraries (for which I have filed a bug, &lt;a href=&quot;https://issues.apache.org/bugzilla/show_bug.cgi?id=54770&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/bugzilla/show_bug.cgi?id=54770&lt;/a&gt;). In my local Tomcat install, I removed the log4j*.jar exclusion from catalina.properties. You can either do the same, or go to &lt;a href=&quot;http://localhost:8080/log4j-223a/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/log4j-223a/files&lt;/a&gt; directly to skip all JSPs and therefore avoid TLD-loading errors.&lt;/p&gt;

&lt;p&gt;This is unrelated to the issue at hand, but is the cause of the new errors you saw. Just go to &lt;a href=&quot;http://localhost:8080/log4j-223a/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/log4j-223a/files&lt;/a&gt; directly (or remove the log4j*.jar exclusion from TOMCAT_HOME/conf/catalina.properties) to isolate the IllegalStateException behavior.&lt;/p&gt;

&lt;p&gt;It looks like your change may fix the error being displayed, but I don&apos;t think it resolves the underlying issue. The underlying issue appears to be a memory leak. By registering a shutdown hook, Log4j creates a thread with classes loaded in the servlet context class loader but held on to by the JVM. When Tomcat undeploys the application, the garbage collector will be unable to collect the servlet context class loader and any classes it loaded because of this. If you redeploy and undeploy the application several times, you will eventually get an &lt;tt&gt;OutOfMemoryError: perm gen space&lt;/tt&gt; exception.&lt;/p&gt;

&lt;p&gt;What is this code trying to accomplish? Why are we registering a shutdown hook here? I question the necessity of this code, and its existence is creating a dangerous situation for web applications.&lt;/p&gt;</comment>
                            <comment id="13661490" author="remkop@yahoo.com" created="Sun, 19 May 2013 04:43:52 +0000"  >&lt;p&gt;I also tried my fix in Tomcat 6.&lt;br/&gt;
Here, I don&apos;t get the 500 error.&lt;br/&gt;
The logging.jsp page shows the message &quot;Messages have been logged.&quot;, and the output from the taglib logs is correctly logged to the console and /logs/application.log file.&lt;br/&gt;
My hello-world page also shows the expected output.&lt;/p&gt;

&lt;p&gt;Unloading the webapp does not give warnings, it just says &quot;Undeploying web application at context path /log4j-223&quot; (in Japanese, the English may be slightly different).&lt;/p&gt;

&lt;p&gt;Shutting down Tomcat-6 after that with Ctrl-C now gives this stack trace:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-40&quot;&lt;/span&gt; java.lang.NullPointerException
        at org.apache.logging.log4j.status.StatusLogger.log(StatusLogger.java:170)
        at org.apache.logging.log4j.spi.AbstractLogger.debug(AbstractLogger.java:354)
        at org.apache.logging.log4j.core.appender.AbstractManager.release(AbstractManager.java:118)
        at org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.stop(AbstractOutputStreamAppender.java:97)
        at org.apache.logging.log4j.core.appender.RollingFileAppender.stop(RollingFileAppender.java:70)
        at org.apache.logging.log4j.core.config.BaseConfiguration.stop(BaseConfiguration.java:142)
        at org.apache.logging.log4j.core.config.XMLConfiguration.stop(XMLConfiguration.java:244)
        at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:206)
        at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:430)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Line numbers changed with my fix, so here is what at line 206 in LoggerContext:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;203	Configuration prev = config;
204	config = NULL_CONFIGURATION;
205	updateLoggers();
206	prev.stop();
207	externalContext = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13661491" author="beamerblvd" created="Sun, 19 May 2013 04:48:19 +0000"  >&lt;p&gt;Yes, the log4j*.jar exclusion doesn&apos;t exist in Tomcat 6 (only Tomcat 7+), and it is not surprising that the error resulting from the class loader problem is slightly different in Tomcat 6 and Tomcat 7.&lt;/p&gt;

&lt;p&gt;Make sure you see my comment above about the log4j*.jar exclusion in Tomcat 7+ and about questioning the shutdown hook.&lt;/p&gt;</comment>
                            <comment id="13661492" author="remkop@yahoo.com" created="Sun, 19 May 2013 04:51:15 +0000"  >&lt;p&gt;Well, my son wants to go play in the park now. That gets priority. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I have seen more than enough Tomcat for today... I hope the above helps with the investigation.&lt;/p&gt;</comment>
                            <comment id="13661493" author="beamerblvd" created="Sun, 19 May 2013 04:59:33 +0000"  >&lt;p&gt;Note: I have asked on the Tomcat user&apos;s and developer&apos;s list for one of the people very knowledgeable about class loaders and memory leaks to chime in on this bug.&lt;/p&gt;</comment>
                            <comment id="13661494" author="remkop@yahoo.com" created="Sun, 19 May 2013 05:02:33 +0000"  >&lt;p&gt;Would it be an idea for the LoggerContext to check if it is running in a web application and not register the shutdown hook if that is the case? (Is there an official way to check if you are running inside a web container?)&lt;/p&gt;</comment>
                            <comment id="13661501" author="ralph.goers@dslextreme.com" created="Sun, 19 May 2013 06:31:38 +0000"  >&lt;p&gt;The web.xml in the sample application doesn&apos;t have the Log4jContextListener registered. If it did the LoggerContext would have been unregistered when the webapp was undeployed, the shutdown hook would have been removed, and the above error would not have occurred. &lt;/p&gt;

&lt;p&gt;It is hard to imagine what at line 170 could be causing the NPE, but I would guess that the NullPointerException that Remko got above is because the webapp has already been undeployed and the StatusLogger class isn&apos;t there any more.  If they had been deployed to the Tomcat class loader instead of the webapp classloader then I suspect this error would not have occurred.&lt;/p&gt;

&lt;p&gt;Removing the shutdown hook is not an appropriate solution. The configuration really needs to be shutdown when the web app is undeployed or when the server is shutdown, depending on where the log4j jars are placed, to clean up all the resources. &lt;/p&gt;</comment>
                            <comment id="13661505" author="remkop@yahoo.com" created="Sun, 19 May 2013 07:28:07 +0000"  >&lt;p&gt;Sounds like one for the FAQ page.&lt;br/&gt;
I&apos;d like to try this. How do I do register the Log4jContextListener? &lt;/p&gt;

&lt;p&gt;Also, does &lt;a href=&quot;https://logging.apache.org/log4j/2.x/manual/logsep.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://logging.apache.org/log4j/2.x/manual/logsep.html&lt;/a&gt; need to be updated after this?&lt;br/&gt;
I&apos;d like to try the simple approach mentioned on that page first and configure the BasicContextSelector, but how do I do that?&lt;/p&gt;</comment>
                            <comment id="13661506" author="ralph.goers@dslextreme.com" created="Sun, 19 May 2013 07:34:04 +0000"  >&lt;p&gt;Log4jContextListener is documented at &lt;a href=&quot;http://logging.apache.org/log4j/2.x/log4j-web/index.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://logging.apache.org/log4j/2.x/log4j-web/index.html&lt;/a&gt; but could use an example.  You can find one at &lt;a href=&quot;https://svn.apache.org/repos/asf/logging/log4j/log4j2/trunk/samples/flume-remote/src/main/webapp/WEB-INF/web.xml&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/logging/log4j/log4j2/trunk/samples/flume-remote/src/main/webapp/WEB-INF/web.xml&lt;/a&gt;. How to use the BasicContextSelector is documented on the page you reference. See item 1 under &quot;Using Context Selectors&quot;.&lt;/p&gt;</comment>
                            <comment id="13661516" author="remkop@yahoo.com" created="Sun, 19 May 2013 09:32:25 +0000"  >&lt;p&gt;Definitely one for the FAQ. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;The problem no longer occurs if the BasicContextSelector is configured.&lt;br/&gt;
In Tomcat, this can be done by adding this line to $TOMCAT_HOME/conf/catalina.properties :&lt;br/&gt;
&lt;tt&gt;Log4jContextSelector=org.apache.logging.log4j.core.selector.BasicContextSelector&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ll try the Log4jContextListener next.&lt;/p&gt;</comment>
                            <comment id="13661520" author="remkop@yahoo.com" created="Sun, 19 May 2013 09:58:20 +0000"  >&lt;p&gt;The listener did not go as smooth...&lt;/p&gt;

&lt;p&gt;First, I removed the above BasicContextSelector.&lt;br/&gt;
Then, after deploying Nick&apos;s attached log4j-223.war, I modified\webapps\log4j-223\WEB-INF\web.xml as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;web-app xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//java.sun.com/xml/ns/javaee&quot;&lt;/span&gt;
&lt;/span&gt;           xmlns:xsi=&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//www.w3.org/2001/XMLSchema-instance&quot;&lt;/span&gt;
&lt;/span&gt;           xsi:schemaLocation=&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//java.sun.com/xml/ns/javaee
&lt;/span&gt;                               http:&lt;span class=&quot;code-comment&quot;&gt;//java.sun.com/xml/ns/javaee/web-app_3_1.xsd&quot;
&lt;/span&gt;           version=&lt;span class=&quot;code-quote&quot;&gt;&quot;3.1&quot;&lt;/span&gt;&amp;gt;

    &amp;lt;display-name&amp;gt;Logging Integration Application&amp;lt;/display-name&amp;gt;

&amp;lt;!-- added listener --&amp;gt;
	&amp;lt;listener&amp;gt;
		&amp;lt;listener-&lt;span class=&quot;code-keyword&quot;&gt;class&amp;&lt;/span&gt;gt;org.apache.logging.log4j.core.web.Log4jContextListener&amp;lt;/listener-&lt;span class=&quot;code-keyword&quot;&gt;class&amp;&lt;/span&gt;gt;
	&amp;lt;/listener&amp;gt;
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I also had to add log4j-web-2.0-beta6.jar to WEB-INF/lib.&lt;/p&gt;

&lt;p&gt;Undeploying gave the following (now familiar) error:&lt;br/&gt;
FAIL - Unable to delete &lt;span class=&quot;error&quot;&gt;&amp;#91;C:\apps\apache-tomcat-7.0.40\webapps\log4j-223&amp;#93;&lt;/span&gt;. The continued presence of this file may cause problems.&lt;/p&gt;

&lt;p&gt;Under the webapps folder, this file was not deleted: webapps\log4j-223\WEB-INF\lib\log4j-core-2.0-beta6.jar&lt;br/&gt;
However, shutting down Tomcat with Ctrl-C did not give any errors.&lt;/p&gt;</comment>
                            <comment id="13661524" author="remkop@yahoo.com" created="Sun, 19 May 2013 10:33:07 +0000"  >&lt;p&gt;I added the following text to the documentation in /web/src/site/xdoc/index.xml:&lt;/p&gt;

&lt;p&gt;...&lt;br/&gt;
To register this listener, make sure that the log4j-web-2.0.jar file is in the classpath (either in your web application&apos;s WEB-INF/lib directory or in the container&apos;s classpath) and add the following snippet to your web.xml:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &amp;lt;listener&amp;gt;
    &amp;lt;listener-&lt;span class=&quot;code-keyword&quot;&gt;class&amp;&lt;/span&gt;gt;org.apache.logging.log4j.core.web.Log4jContextListener&amp;lt;/listener-&lt;span class=&quot;code-keyword&quot;&gt;class&amp;&lt;/span&gt;gt;
  &amp;lt;/listener&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;I hope that both these classpath locations are actually correct. Ralph, are they?&lt;/p&gt;</comment>
                            <comment id="13661569" author="beamerblvd" created="Sun, 19 May 2013 14:26:12 +0000"  >&lt;p&gt;I have two issues with all of this:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;&quot;FAIL - Unable to delete &lt;span class=&quot;error&quot;&gt;&amp;#91;C:\apps\apache-tomcat-7.0.40\webapps\log4j-223&amp;#93;&lt;/span&gt;. The continued presence of this file may cause problems.&quot; &amp;lt;-- This means Log4j has a memory leak in web applications. The Log4j classes are still loaded by a class outside the web application and can&apos;t be garbage collected.&lt;/li&gt;
	&lt;li&gt;Log4j 1 did not require users to configure a listener in order for logging to work properly. Log4j 2 users should not have to, either. It should &quot;just work&quot; like Log4j 1 did. If the only purpose of the log4j-web module is to make Log4j 2 work properly in web applications, I suggest that it should be removed completely and a better way should be found. Like I said, Log4j 1 works just fine without a listener.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13661571" author="ralph.goers@dslextreme.com" created="Sun, 19 May 2013 14:55:07 +0000"  >&lt;p&gt;Item 1 is a problem. I have a feeling I know what is causing it. I suspect there is a relationship between the LoggerContext and classloader that is not being removed.&lt;/p&gt;

&lt;p&gt;As for item 2 - Log4j 1 &quot;just works&quot; by not doing anything. That doesn&apos;t mean it is better. It doesn&apos;t close files or perform any cleanup. This may result in the loss of data during shutdown depending on how the appenders work.&lt;/p&gt;</comment>
                            <comment id="13661572" author="beamerblvd" created="Sun, 19 May 2013 15:04:17 +0000"  >&lt;p&gt;Fair enough, but I still think there&apos;s a &quot;better way&quot; than requiring users to configure a listener. To me, philosophically, logging should &quot;just work.&quot;&lt;/p&gt;

&lt;p&gt;What about &lt;a href=&quot;http://docs.oracle.com/javase/6/docs/api/java/lang/Object.html#finalize()&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Object#finalize()&lt;/a&gt;? If we created a finalizer for &lt;tt&gt;LoggerContext&lt;/tt&gt;, it could check if the context had been stopped, and stop it if it had not. Then we wouldn&apos;t need a shutdown hook. In theory (and this would need to be tested), without a shutdown hook the &lt;tt&gt;LoggerContext&lt;/tt&gt; would be garbage collected as soon as the web application was undeployed, resulting in the &lt;tt&gt;LoggerContext&lt;/tt&gt; being closed without a listener.&lt;/p&gt;</comment>
                            <comment id="13661573" author="beamerblvd" created="Sun, 19 May 2013 15:14:05 +0000"  >&lt;p&gt;The problem with &lt;tt&gt;Object#finalize()&lt;/tt&gt;, it would appear after brief experimentation, is that it isn&apos;t called in a standalone application at JVM shutdown, so the shutdown hook would still be needed there. I&apos;m going to continue to experiment a bit...&lt;/p&gt;</comment>
                            <comment id="13661577" author="ralph.goers@dslextreme.com" created="Sun, 19 May 2013 15:50:44 +0000"  >&lt;p&gt;I suspect that the &quot;real&quot; solution is going to be to make the BasicContextSelector the default. It should cause the behavior to be just like Log4j 1. I&apos;m not really sure what ClassLoaderContextSelector is doing that is causing the problem though.&lt;/p&gt;</comment>
                            <comment id="13661579" author="beamerblvd" created="Sun, 19 May 2013 15:52:01 +0000"  >&lt;p&gt;So, in Tomcat anyway, Object#finalize() on a basic class appears to always be called if the application is undeployed while Tomcat continues to run, but it is not called if Tomcat just shuts down. So, unfortunately, this is not an acceptable replacement. :-/&lt;/p&gt;</comment>
                            <comment id="13661583" author="beamerblvd" created="Sun, 19 May 2013 16:00:37 +0000"  >&lt;p&gt;A couple of things, Ralph:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;&lt;tt&gt;ClassLoaderContextSelector&lt;/tt&gt; appears to be using &lt;tt&gt;getCallerClass&lt;/tt&gt; like &lt;tt&gt;ThrowableProxy&lt;/tt&gt; was, which means it will break on Java 8. The same check for method parameters needs to be performed here. As in &lt;tt&gt;ThrowableProxy&lt;/tt&gt;, I again wonder why we&apos;re looping through methods looking for one named &lt;tt&gt;getCallerClass&lt;/tt&gt; instead of just calling &lt;tt&gt;getMethod(&quot;getCallerClass&quot;, int.class)&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;I&apos;m not exactly sure what the &lt;tt&gt;ContextSelector&lt;/tt&gt; and &lt;tt&gt;LoggerContext&lt;/tt&gt; do, and I don&apos;t understand the difference between &lt;tt&gt;BasicContextSelector&lt;/tt&gt; and &lt;tt&gt;ClassLoaderContextSelector&lt;/tt&gt;. Could you enlighten me?&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13661586" author="ralph.goers@dslextreme.com" created="Sun, 19 May 2013 16:18:31 +0000"  >&lt;p&gt;See &lt;a href=&quot;http://logging.apache.org/log4j/2.x/manual/architecture.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://logging.apache.org/log4j/2.x/manual/architecture.html&lt;/a&gt;. Ceki does a good job of explaining the Logback LoggerContext and ContextSelector in his documentation. In particular look at  &lt;a href=&quot;http://logback.qos.ch/manual/loggingSeparation.html#tamingStaticRefs&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://logback.qos.ch/manual/loggingSeparation.html#tamingStaticRefs&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The LoggerContext is the &quot;anchor point&quot; for all the logging. It references the configuration.&lt;/p&gt;

&lt;p&gt;The ClassLoaderContextSelector attempts to solve the problem Ceki described in the Taming Static Refs section. It creates LoggerContexts based on the ClassLoader that loaded the caller to getLogger. Thus, assuming the Log4j jars are on the Tomcat classpath, loggers should be able to be declared as static and still be cleaned up properly.  I made this ContextSelector the default to insure that it would get exposure and testing. I&apos;m suspecting however, that there is something that isn&apos;t being accounted for.&lt;/p&gt;</comment>
                            <comment id="13661591" author="beamerblvd" created="Sun, 19 May 2013 16:26:00 +0000"  >&lt;p&gt;Okay, I think I understand better.&lt;/p&gt;

&lt;p&gt;I don&apos;t think the problem is in the selector. Regardless of which selector is being used, the &lt;tt&gt;o.a.l.l.core.LoggerContext&lt;/tt&gt; class is still the class ultimately instantiated. &lt;em&gt;That&lt;/em&gt; class is the one adding the shutdown hook. The shutdown hook is responsible for the class loader memory leak, because the Runtime class&apos;s holding an instance of the shutdown hook means that the &lt;tt&gt;LoggerContext.ShutdownHook&lt;/tt&gt; class can&apos;t be unloaded, which means the class loader and all of the classes it holds can&apos;t be garbage collected.&lt;/p&gt;</comment>
                            <comment id="13661594" author="beamerblvd" created="Sun, 19 May 2013 16:37:48 +0000"  >&lt;p&gt;In addition to my comment above, I was looking through the log4j-web source for a minute and I&apos;m a little confused. What&apos;s the difference between &lt;tt&gt;Log4jContextListener&lt;/tt&gt; and &lt;tt&gt;JNDIContextFilter&lt;/tt&gt; and when would you use one or the other or both?&lt;/p&gt;</comment>
                            <comment id="13661597" author="ralph.goers@dslextreme.com" created="Sun, 19 May 2013 16:41:26 +0000"  >&lt;p&gt;Remko stated above that if you use the BasicContextSelector with the Log4jContextListener everything is good.  However, if you use the ClassLoaderContextSelector you still get the message&lt;/p&gt;

&lt;p&gt;FAIL - Unable to delete &lt;span class=&quot;error&quot;&gt;&amp;#91;C:\apps\apache-tomcat-7.0.40\webapps\log4j-223&amp;#93;&lt;/span&gt;. The continued presence of this file may cause problems.&lt;/p&gt;

&lt;p&gt;This implies that ClassLoaderContextSelector is hanging onto something.&lt;/p&gt;

&lt;p&gt;You are correct that the LoggerContext adds the shutdown hook. I suppose the way to deal with that is to add another attribute to the configuration element to enable the hook.&lt;/p&gt;</comment>
                            <comment id="13661599" author="ralph.goers@dslextreme.com" created="Sun, 19 May 2013 16:55:48 +0000"  >&lt;p&gt;You would use the JNDIContextFilter when you use the JNDIContextSelector. The context filter locates it via a JNDI lookup and then stores it in a ThreadLocal. Then whenever the LoggerContext is needed it is retrieved from the ThreadLocal.&lt;/p&gt;</comment>
                            <comment id="13661602" author="beamerblvd" created="Sun, 19 May 2013 17:08:18 +0000"  >&lt;p&gt;I don&apos;t think the hook &lt;em&gt;has&lt;/em&gt; to be able to be enabled/disabled. &lt;tt&gt;Log4jContextListener&lt;/tt&gt; calls &lt;tt&gt;stop()&lt;/tt&gt; on the &lt;tt&gt;LoggerContext&lt;/tt&gt;, and &lt;tt&gt;stop()&lt;/tt&gt; removes the shutdown hook. So, used this way, the shutdown hook isn&apos;t a problem, it just isn&apos;t used. That&apos;s why everything&apos;s okay when using the &lt;tt&gt;BasicContextSelector&lt;/tt&gt;. (I&apos;m not saying it&apos;s a &lt;em&gt;bad&lt;/em&gt; idea to provide way to enable/disable the shutdown hook. It wouldn&apos;t hurt.)&lt;/p&gt;

&lt;p&gt;So here are the philosophical or real issues that need to be resolved/answered, from my perspective:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Why does &lt;tt&gt;BasicContextSelector&lt;/tt&gt; work and &lt;tt&gt;ClassLoaderContextSelector&lt;/tt&gt; not work in a web application when a &lt;tt&gt;Log4jContextListener&lt;/tt&gt; is properly used?&lt;/li&gt;
	&lt;li&gt;Is there any way to make logging &quot;just work&quot; in a web application without creating a listener and/or filter? I&apos;m starting to become convinced that there isn&apos;t, and that disappoints me.&lt;/li&gt;
	&lt;li&gt;Would &lt;tt&gt;Log4jContextListener&lt;/tt&gt; and &lt;tt&gt;JNDIContextFilter&lt;/tt&gt; ever both be used at the same time, and would doing that cause a malfunction?&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Assuming the ultimate conclusion is that logging can&apos;t &quot;just work&quot; in a web application and a listener/filter is required, I would like to drastically simplify usage of the log4j-web module. My thoughts on it are:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;There should only be a listener, not a filter.&lt;/li&gt;
	&lt;li&gt;There should be no init parameters; everything should be automatic and follow normal Log4j conventions.&lt;/li&gt;
	&lt;li&gt;There should be a &lt;tt&gt;META-INF/web-fragment.xml&lt;/tt&gt; file that creates the filter automatically so that if the user is using a Servlet 3.0 or newer container he doesn&apos;t even have to consciously create the filter, he just has to include the JAR.&lt;/li&gt;
	&lt;li&gt;It should be in the Core module, so that it works automatically in web applications.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I make these arguments because, here I am, a committer on the project and an avid reader of the documentation, and I still had no idea the &lt;tt&gt;Log4jContextListener&lt;/tt&gt; and/or &lt;tt&gt;JNDIContextFilter&lt;/tt&gt; were required to make logging work properly in a web application.&lt;/p&gt;</comment>
                            <comment id="13661603" author="beamerblvd" created="Sun, 19 May 2013 17:11:09 +0000"  >&lt;p&gt;&lt;del&gt;Also, you said &quot;You would use the &lt;tt&gt;JNDIContextFilter&lt;/tt&gt; when you use the &lt;tt&gt;JNDIContextSelector&lt;/tt&gt;.&quot; But I&apos;m seeing a chicken-and-egg problem. If you&apos;re running Log4j in a web application, how do you specify that it should use the &lt;tt&gt;JNDIContextSelector&lt;/tt&gt; before the &lt;tt&gt;JNDIContextFilter&lt;/tt&gt; is initialized?&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;Okay, I see now that one would include a &lt;tt&gt;log4j2.component.properties&lt;/tt&gt; file in the &lt;tt&gt;WEB-INF/classes&lt;/tt&gt; directory, and that it should contain a &lt;tt&gt;Log4jContextSelector&lt;/tt&gt; property pointing to the correct class name. Note that I don&apos;t see any documentation in the manual that explains this process. If it&apos;s there, it sure is hard to find. So, back to my original 3 issues and 4 thoughts above.&lt;/p&gt;</comment>
                            <comment id="13661604" author="ralph.goers@dslextreme.com" created="Sun, 19 May 2013 17:21:29 +0000"  >&lt;p&gt;The shutdown hook is necessary in applications that aren&apos;t web apps (i.e. - there is no equivalent of a Servlet context listener).  Please remember that Log4j has to work in standalone apps, web apps where the jars in the Tomcat ClassLoader, web apps where each has the log4j classes, ejbs (yuck), etc.&lt;/p&gt;

&lt;p&gt;As I said, with the BasicContextListener the behavior you should get should match Log4j 1.x - it won&apos;t shutdown the LoggerContext and the appenders, etc. won&apos;t be gracefully cleaned up. Adding the context listener provides that.&lt;/p&gt;

&lt;p&gt;A filter and context listener do very different things. You can&apos;t set a ThreadLocal in a context listener. Likewise, unless you are using the JNDIContextSelector you don&apos;t really want to set the ThreadLocal.&lt;/p&gt;

&lt;p&gt;ContextSelectors are chosen via a system property. They can also be specified in the file &quot;log4j2.component.properties&quot; which is read when LogManager is first called.&lt;/p&gt;</comment>
                            <comment id="13661605" author="ralph.goers@dslextreme.com" created="Sun, 19 May 2013 17:23:38 +0000"  >&lt;p&gt;Oops. I missed the comment about web-fragment.xml.  That is a good idea but it needs to make sure that whatever it is doing is applicable to all web apps that would be including the log4j-web jar.&lt;/p&gt;</comment>
                            <comment id="13661606" author="ralph.goers@dslextreme.com" created="Sun, 19 May 2013 17:27:42 +0000"  >&lt;p&gt;If web-fragment.xml is in core how would you handle the following two scenarios:&lt;/p&gt;

&lt;p&gt;1. A container with multiple web applications. The log4j jars are in the Tomcat classpath and they all share the same configuration file.&lt;/p&gt;

&lt;p&gt;2. A container with multiple web applications. Each has their own copy of the log4j jars and each has their own configuration file.&lt;/p&gt;</comment>
                            <comment id="13661621" author="beamerblvd" created="Sun, 19 May 2013 18:17:43 +0000"  >&lt;p&gt;I think you misunderstood my comment. I&apos;m not suggesting the shutdown hook should be removed completely. I fully recognize it is needed in standalone apps. You said, &quot;You are correct that the &lt;tt&gt;LoggerContext&lt;/tt&gt; adds the shutdown hook. I suppose the way to deal with that is to add another attribute to the configuration element to enable the hook.&quot; My response was that I don&apos;t think it&apos;s a &lt;em&gt;must&lt;/em&gt; to add the ability to enable/disable the hook because the listener and filter take actions that remove the hook.&lt;/p&gt;

&lt;p&gt;I think you&apos;re wrong about something, though. You said, &quot;With the &lt;tt&gt;BasicContextListener&lt;/tt&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;I think you meant BasicContextSelector&amp;#93;&lt;/span&gt; the behavior you should get should match Log4j 1.x - it won&apos;t shutdown the &lt;tt&gt;LoggerContext&lt;/tt&gt; and the appenders, etc. won&apos;t be gracefully cleaned up. Adding the context listener provides that.&quot; That is not completely true all the time. Since &lt;tt&gt;LoggerContext&lt;/tt&gt; creates a shutdown hook, it &lt;em&gt;will&lt;/em&gt; shut down the &lt;tt&gt;LoggerContext&lt;/tt&gt; and the appenders if the servlet container is shut down without undeploying the application. The only time the &lt;tt&gt;LoggerContext&lt;/tt&gt; and appenders won&apos;t be shut down is if the application is undeployed &lt;em&gt;before&lt;/em&gt; the container is shut down.&lt;/p&gt;

&lt;p&gt;Before we start discussing web-fragment.xml, etc., I want to get &lt;tt&gt;Log4jContextListener&lt;/tt&gt; and &lt;tt&gt;JNDIContextFilter&lt;/tt&gt; straight.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;Log4jContextListener&lt;/tt&gt; does the following:
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;On startup, it calls &lt;tt&gt;Configurator.initialize&lt;/tt&gt; which loads the Log4j configuration and creates the correct selector (&lt;tt&gt;BasicContextSelector&lt;/tt&gt;, &lt;tt&gt;ClassLoaderContextSelector&lt;/tt&gt;, &lt;tt&gt;JNDIContextSelector&lt;/tt&gt;, etc. based on properties). It then adds the returned &lt;tt&gt;LoggerContext&lt;/tt&gt; to the &lt;tt&gt;ServletContext&lt;/tt&gt; as a context attribute.&lt;/li&gt;
		&lt;li&gt;On shutdown, it calls &lt;tt&gt;Configurator.shutdown&lt;/tt&gt; which calls &lt;tt&gt;stop()&lt;/tt&gt; on the &lt;tt&gt;LoggerContext&lt;/tt&gt; which, incidentally, results in the shutdown hook being removed.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;JNDIContextFilter&lt;/tt&gt; does the following:
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;On startup, it checks if the servlet context attribute for a &lt;tt&gt;LoggerContext&lt;/tt&gt; is set. If it is, it does nothing and the filter essentially becomes a no-op. It then gets the &lt;tt&gt;LoggerContextFactory&lt;/tt&gt; from the &lt;tt&gt;LogManager&lt;/tt&gt;. &lt;em&gt;If&lt;/em&gt; the factory is a &lt;tt&gt;Log4jContextFactory&lt;/tt&gt; and &lt;em&gt;if&lt;/em&gt; its selector is a &lt;tt&gt;NamedContextSelector&lt;/tt&gt; (&lt;b&gt;note: NOT a JNDIContextSelector&lt;/b&gt;), it adds the &lt;tt&gt;LoggerContext&lt;/tt&gt; to the &lt;tt&gt;ServletContext&lt;/tt&gt; as a context attribute. Otherwise, the filter essentially becomes a no-op.&lt;/li&gt;
		&lt;li&gt;On each request, it looks for the &lt;tt&gt;LoggerContext&lt;/tt&gt; on the &lt;tt&gt;ServletContext&lt;/tt&gt; and sets it to &lt;tt&gt;ContextAnchor.THREAD_CONTEXT&lt;/tt&gt; if it exists.&lt;/li&gt;
		&lt;li&gt;On shutdown, it stops the &lt;tt&gt;LoggerContext&lt;/tt&gt; which, incidentally, results in the shutdown hook being removed.&lt;/li&gt;
		&lt;li&gt;Questions:
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;Why is the &lt;tt&gt;JNDIContextFilter&lt;/tt&gt; working with the &lt;tt&gt;NamedContextSelector&lt;/tt&gt; instead of the &lt;tt&gt;JNDIContextSelector&lt;/tt&gt; as previously explained?&lt;/li&gt;
			&lt;li&gt;Why does &lt;tt&gt;JNDIContextFilter&lt;/tt&gt; have to set a thread local in &lt;tt&gt;doFilter&lt;/tt&gt;? I don&apos;t see how the correct loggers won&apos;t be used if the thread local isn&apos;t set.&lt;/li&gt;
			&lt;li&gt;Am I correct in assuming that, based on all of this, the &lt;tt&gt;JNDIContextFilter&lt;/tt&gt; will not work correctly use the &lt;tt&gt;NamedContextSelector&lt;/tt&gt; if the &lt;tt&gt;Log4jContextListener&lt;/tt&gt; is also in use (as-written), and will (perhaps incorrectly) add the &lt;tt&gt;LoggerContext&lt;/tt&gt; created in the &lt;tt&gt;Log4jContextListener&lt;/tt&gt; to the thread local if both are used?&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13661688" author="ralph.goers@dslextreme.com" created="Sun, 19 May 2013 22:31:18 +0000"  >&lt;p&gt;Provided the Log4jContextListener is configured in web.xml shutdown now works fine with Tomcat 7 with revision 1484363.&lt;/p&gt;

&lt;p&gt;FWIW, the sample war provided was compiled with Java 7 not Java 6.&lt;/p&gt;

&lt;p&gt;Although the underlying error should now be fixed I am leaving this open to continue discussion on web-fragment.xml or if more still needs to be done.&lt;/p&gt;</comment>
                            <comment id="13663650" author="beamerblvd" created="Wed, 22 May 2013 01:15:48 +0000"  >&lt;p&gt;Ralph,&lt;/p&gt;

&lt;p&gt;My bad, I typoed. Meant to say the sample WAR was compiled with Java 7, not Java 6.&lt;/p&gt;

&lt;p&gt;If someone could respond to my analysis in the comment immediately above and let me know if my assumptions are correct and what the answers to my questions are, I&apos;d be in a good position to make some recommendations about how I think this could all be improved, vis-&#224;-vis &lt;tt&gt;web-fragment.xml&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="13663786" author="ralph.goers@dslextreme.com" created="Wed, 22 May 2013 05:15:07 +0000"  >&lt;p&gt;1. JNDIContextSelector implements the NamedContextSelector interface. In theory, JNDIContextFilter can work on any NamedContextSelector so I guess it really should be named NamedContextFilter.&lt;br/&gt;
2. If the context isn&apos;t found in the ThreadLocal then JNDIContextSelector performs a JNDILookup to locate the context. Using the ThreadLocal avoids the need to do the JNDI lookup, which is much more expensive.&lt;br/&gt;
3. Both should work fine if they are used together. Log4jContextListener will get control during web app deployment and set the context as a ServletContext attribute. On each request JNDIContextFilter will get the context from the attribute and store it in a ThreadLocal.&lt;/p&gt;

&lt;p&gt;Note that all the apps where I work run in JBoss 5, which doesn&apos;t support web-fragment.xml as far as I know. Also, I&apos;d still like to know how to handle the two scenarios I asked about above.&lt;/p&gt;</comment>
                            <comment id="13668682" author="beamerblvd" created="Tue, 28 May 2013 21:10:20 +0000"  >&lt;p&gt;Okay, based on all of this, here are my suggestions on how I would improve this (sorry for my scarcity lately ... trying to catch up on chapters for the book). These suggestions are based on the following goals:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Design web application support so that users of simple Log4j configurations (not using JNDI lookups for logging configuration) don&apos;t have to do any additional configuration to get Log4j to &quot;just work&quot; in a Servlet container. This goal is made with the understanding that this is only possible for users of Servlet 3.0, 3.1, or higher. Users of Servlet 2.5 will have to manually configure listeners and filters. It&apos;s the only way.&lt;/li&gt;
	&lt;li&gt;Eliminate the need for web applications to have an additional JAR just to support proper configuration.&lt;/li&gt;
	&lt;li&gt;Improve the documentation considerably so that it is abundantly clear how Log4j works in web applications.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;With these goals in mind, here are my recommendations:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Get rid of the log4j-web module and move this stuff into log4j-core. We&apos;ll need &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=timothyjward&quot; class=&quot;user-hover&quot; rel=&quot;timothyjward&quot;&gt;timothyjward&lt;/a&gt;&apos;s input on how this could impact OSGi support. In theory, I don&apos;t think we should have a problem. No other Log4j classes will refer to the listener or filter. These classes will only ever get loaded BY the Servlet container, in which case the Servlet API will already be loaded, so I don&apos;t think it would be possible to get &lt;tt&gt;NoClassDefFoundError&lt;/tt&gt; s.&lt;/li&gt;
	&lt;li&gt;Create a &lt;tt&gt;/META-INF/web-fragment.xml&lt;/tt&gt; file with the contents noted below. This will ensure that the Log4j fragment is loaded before any other fragments.&lt;/li&gt;
	&lt;li&gt;Create a &lt;tt&gt;Log4jWebInitializer&lt;/tt&gt; class (doesn&apos;t implement any interfaces, package-private) to properly initialize and de-initialize Log4j in a Servlet container. It works like this: If the context parameters currently required by the &lt;tt&gt;JNDIContextFilter&lt;/tt&gt; exist, it initializes Log4j the way &lt;tt&gt;JNDIContextFilter&lt;/tt&gt; currently does. If they don&apos;t exist, it initializes Log4j the way &lt;tt&gt;Log4jContextListener&lt;/tt&gt; currently does.&lt;/li&gt;
	&lt;li&gt;Create a &lt;tt&gt;Log4jServletContainerInitializer implements ServletContainerInitializer&lt;/tt&gt; and a &lt;tt&gt;/META-INF/services/javax.servlet.ServletContainerInitializer&lt;/tt&gt; file to go along with it. This initializer:
	&lt;ul&gt;
		&lt;li&gt;Initializes Log4j properly using the &lt;tt&gt;Log4jWebInitializer&lt;/tt&gt;.&lt;/li&gt;
		&lt;li&gt;Installs a private listener to de-initialize Log4j when the container shuts down the application using the &lt;tt&gt;Log4jWebInitializer&lt;/tt&gt;.&lt;/li&gt;
		&lt;li&gt;Installs the &lt;tt&gt;NamedContextFilter&lt;/tt&gt; (renamed from &lt;tt&gt;JNDIContextFilter&lt;/tt&gt;), which doesn&apos;t do any initialization/deinitialization, it just does what it currently does for &lt;tt&gt;doFilter&lt;/tt&gt;.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Change the existing &lt;tt&gt;Log4jContextListener&lt;/tt&gt; to use the &lt;tt&gt;Log4jWebInitializer&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Create a new manual page directly under the &quot;MANUAL&quot; menu heading on the homepage that explains how to use Log4j in a Servlet container:
	&lt;ul&gt;
		&lt;li&gt;If you&apos;re using Servlet 3.0 or higher, it &quot;just works,&quot; but if you&apos;re also using JNDI you need to create the proper context parameters.&lt;/li&gt;
		&lt;li&gt;If you&apos;re using Servlet 2.5, you MUST add the &lt;tt&gt;Log4jContextListener&lt;/tt&gt; (and the &lt;tt&gt;NamedContextFilter&lt;/tt&gt; and context parameters if you&apos;re using JNDI) to your deployment descriptor.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Now, to address some questions:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;&quot;What to do about JBoss 5, which doesn&apos;t support web-fragment.xml?&quot; JBoss 5 doesn&apos;t support web-fragment.xml because it&apos;s a Servlet 2.5 container, not a Servlet 3.0 container. Users of JBoss 5 would follow the Servlet 2.5 instructions just like all other users. Users of JBoss 6, 7, 8, etc., would follow the Servlet 3.0 instructions (&quot;don&apos;t do anything&quot;).&lt;/li&gt;
	&lt;li&gt;&quot;A container with multiple web applications. The Log4j jars are in the Tomcat classpath and they all share the same configuration file.&quot; versus &quot;A container with multiple web applications. Each has their own copy of the log4j jars and each has their own configuration file.&quot; Easy! The &lt;tt&gt;Log4jServletContainerInitializer&lt;/tt&gt; will get executed for every application, whether the Log4j JARs are in the Tomcat classpath or in /WEB-INF/lib (this is per the Servlet specification). Each application will get its own context. Regardless of where the JARs are, that context will load the application&apos;s configuration file if it has its own, and will load the shared configuration if it doesn&apos;t have its own.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Thoughts?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;web-fragment.xml&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;web-fragment ... metadata-complete=&lt;span class=&quot;code-quote&quot;&gt;&quot;true&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;name&amp;gt;&lt;/span&gt;log4j&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/name&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;distributable/&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;ordering&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;before&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;others/&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/before&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/ordering&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/web-fragment&amp;gt;&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13668708" author="garydgregory" created="Tue, 28 May 2013 21:41:07 +0000"  >&lt;p&gt;Nice deep dive Nick. I do like the idea of one less jar for a simpler for to configure web apps. This would add the Servlet API as an optional runtime dependency in Core, which is OK.&lt;/p&gt;</comment>
                            <comment id="13669298" author="ralph.goers@dslextreme.com" created="Wed, 29 May 2013 14:32:25 +0000"  >&lt;p&gt;Should all this enhancement stuff go into a separate Jira?  It feels like the issue reported here has been resolved.&lt;/p&gt;</comment>
                            <comment id="13669310" author="beamerblvd" created="Wed, 29 May 2013 14:40:27 +0000"  >&lt;p&gt;That makes sense to me. I&apos;ll create it and close this.&lt;/p&gt;</comment>
                            <comment id="13669315" author="beamerblvd" created="Wed, 29 May 2013 14:45:23 +0000"  >&lt;p&gt;Confirmed. Created issue &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-270&quot; title=&quot;Improve logging initialization in Servlet containers; reduce amount of extra configuration needed in these contexts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-270&quot;&gt;&lt;del&gt;LOG4J2-270&lt;/del&gt;&lt;/a&gt; based on further discussions related to this.&lt;/p&gt;</comment>
                            <comment id="13828906" author="taskend" created="Thu, 21 Nov 2013 13:13:46 +0000"  >&lt;p&gt;I am facing same problem in Websphere. Did you solve this problem with this way Nick?&lt;/p&gt;</comment>
                            <comment id="13828911" author="taskend" created="Thu, 21 Nov 2013 13:16:39 +0000"  >&lt;p&gt;I am using log4j beta v9. But in websphere throws same exception. how did you solve this problem?&lt;/p&gt;</comment>
                            <comment id="13838272" author="tennant" created="Tue, 3 Dec 2013 22:37:37 +0000"  >&lt;p&gt;We are still seeing this exception in Tomcat 7.0.47 with log4j2 beta9.&lt;/p&gt;

&lt;p&gt;INFO: Illegal access: this web application instance has been stopped already.  Could not load org.apache.logging.log4j.core.config.NullConfiguration.  The eventual following stack trace is caused by an error thrown for debugging purposes as well as to attempt to terminate the thread which caused the illegal access, and has no functional impact.&lt;br/&gt;
java.lang.IllegalStateException&lt;br/&gt;
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1588)&lt;br/&gt;
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1547)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:210)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:437)&lt;/p&gt;

&lt;p&gt;Exception in thread &quot;Thread-4&quot; java.lang.NoClassDefFoundError: org/apache/logging/log4j/core/config/NullConfiguration&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:210)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:437)&lt;br/&gt;
Caused by: java.lang.ClassNotFoundException: org.apache.logging.log4j.core.config.NullConfiguration&lt;br/&gt;
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1702)&lt;br/&gt;
	at org.apache.catalina.loader.WebappClassLoader.loadClass(WebappClassLoader.java:1547)&lt;br/&gt;
	... 2 more&lt;/p&gt;

&lt;p&gt;We can set debug points and verify that Log4jServletContainerInitializer gets called on startup, and so does Log4jServletContextListener. However, on server shutdown, Log4jServletContextListener.contextDestroyed does not getting invoked. &lt;/p&gt;

&lt;p&gt;Note, that we are using spring&apos;s WebApplicationInitializer to bootstrap our webapp, we do not have a web.xml file. We configure log4j2 via a log4j2.xml on the classpath.&lt;/p&gt;

&lt;p&gt;Any advice? &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12645056">LOG4J2-222</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12649940">LOG4J2-270</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12583752" name="log4j-223.war" size="2763623" author="beamerblvd" created="Sun, 19 May 2013 01:45:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>325419</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 51 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1k553:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>325764</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>