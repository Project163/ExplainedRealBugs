<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:40:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-2366] LoggerContext leak using Log4jLoggerFactory</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-2366</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;Hi all!&lt;/p&gt;

&lt;p&gt;We&#160;are using log4j2 as the logging framework for our applications.&lt;br/&gt;
This is done by using the log4j implementation&#160;provided&#160;for slf4j.&lt;/p&gt;

&lt;p&gt;The problem we are seeing is that after many application redeploys, many LoggerContexts are still referenced, even after stopping them.&lt;/p&gt;

&lt;p&gt;I&apos;ve taken many heap dumps of our standalone server and found that many of these references are kept by a WeakHashMap&amp;lt;&amp;gt; instantiated in the Log4jLoggerFactory. (&apos;registry&apos; attribute of org.apache.logging.log4j.spi.AbstractLoggerAdapter)&lt;br/&gt;
What happens is that, even when the Map is a WeakHashMap (Where the keys should be weakly referenced), it will never be cleared because it&apos;s values keep references to those same keys.&lt;/p&gt;

&lt;p&gt;If you check the heap dumps that i&apos;ve provided, you can see that most of the LoggerContexts (org.mule.runtime.module.launcher.log4j2.MuleLoggerContext) states are: STOPPED and even it&apos;s loggers configurations are updated to NullConfiguration, but the references are kept.&lt;/p&gt;

&lt;p&gt;On the other hand, i could remove the references to their contexts for the loggers (&apos;context&apos; attribute of org.apache.logging.log4j.core.Logger) when those contexts are stopped but the field is final and private, which makes it impossible to change for an child class.&lt;/p&gt;

&lt;p&gt;For the heapdumps, i took them as follows:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;deployed application&lt;/li&gt;
	&lt;li&gt;dumped patched_before.hprof&lt;/li&gt;
	&lt;li&gt;redeployed app 10 times&lt;/li&gt;
	&lt;li&gt;dumped patched_after.hprof&lt;/li&gt;
	&lt;li&gt;waited an hour&lt;/li&gt;
	&lt;li&gt;dumped patched_after_waited.hprof&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You can see that in&#160;&lt;em&gt;patched_before.hprof&lt;/em&gt;&#160;there are only 4 LoggerContext instances while in&#160;&lt;em&gt;patched_after.hprof&lt;/em&gt;&#160;and &lt;em&gt;patched_after_waited.hprof&lt;/em&gt;&#160;&#160;there are around 16, most of them referenced by a logger that is linked to a value in the WeakHashMap mentioned above.&lt;/p&gt;

&lt;p&gt;I think that you should, either provide a way to&#160;remove entries from&#160;that &apos;registry&apos;, or check for circular dependencies somehow so that they are removed by the GC.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</description>
                <environment></environment>
        <key id="13169902">LOG4J2-2366</key>
            <summary>LoggerContext leak using Log4jLoggerFactory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="lucianorm">Luciano Raineri Marchina</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Jul 2018 19:22:03 +0000</created>
                <updated>Mon, 29 Jul 2019 02:09:20 +0000</updated>
                            <resolved>Mon, 29 Jul 2019 02:09:20 +0000</resolved>
                                    <version>2.11.0</version>
                                    <fixVersion>2.12.1</fixVersion>
                                    <component>SLF4J Bridge</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16533003" author="ralph.goers@dslextreme.com" created="Wed, 4 Jul 2018 18:40:38 +0000"  >&lt;p&gt;Can this be duplicated without Mule?  Mule has its own MuleLoggerContext and also apparently has a LoggerContextCache. It is unclear how those may, or may not, play into what you are seeing.&lt;/p&gt;

&lt;p&gt;It is important to note that having Loggers reference the LoggerContext will not prevent the LoggerContext from being cleaned up, so long as the Loggers are not referenceable or the object they reside is no longer referenceable. For example, If I have a situation where A references B which references C, C will be cleaned up so long as B is the only thing referencing it, A is the only thing referencing B and nothing references A.&lt;/p&gt;</comment>
                            <comment id="16534064" author="lucianorm" created="Thu, 5 Jul 2018 19:38:51 +0000"  >&lt;p&gt;Hi Ralph!&lt;br/&gt;
 First of all, thanks for the quick response.&lt;/p&gt;

&lt;p&gt;&lt;cite&gt;It is important to note that having Loggers reference the LoggerContext will not prevent the LoggerContext from being cleaned up, so long as the Loggers are not referenceable or the object they reside is no longer referenceable.&lt;/cite&gt;&lt;/p&gt;

&lt;p&gt; The loggers will always be referenceable by the entries in the WeakHashMap i mentioned which is referenced by the loggerFactory which is always referenced by the StaticLoggerBinder class.&lt;/p&gt;

&lt;p&gt;I&apos;m now attaching a minimal example of the same issue being replicated without Mule, along with some heap dumps i took to check that the leak was indeed happening.&#160;&lt;br/&gt;
 &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12930430/12930430_minimal_example.7z&quot; title=&quot;minimal_example.7z attached to LOG4J2-2366&quot;&gt;minimal_example.7z&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16579780" author="lucianorm" created="Tue, 14 Aug 2018 13:17:28 +0000"  >&lt;p&gt;Hi!,&lt;/p&gt;

&lt;p&gt;Any news on this?&#160;&lt;/p&gt;</comment>
                            <comment id="16579797" author="ralph.goers@dslextreme.com" created="Tue, 14 Aug 2018 13:30:30 +0000"  >&lt;p&gt;Sorry, not yet.&lt;/p&gt;</comment>
                            <comment id="16800952" author="lucianorm" created="Mon, 25 Mar 2019 18:13:03 +0000"  >&lt;p&gt;Hi!&lt;/p&gt;

&lt;p&gt;Is there any update on this? Can you at least confirm this is indeed an issue?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="16894622" author="ralph.goers@dslextreme.com" created="Sun, 28 Jul 2019 05:20:52 +0000"  >&lt;p&gt;This may just be repeating what you said, but in a form that is clearer to me. In looking at the code it seems an org.apache.logging.log4j.core.Logger is going to be created and wrapped in an SLF4J Logger. This will then be stored into the ConcurrentMap that is the value of the Map entry. This strong reference will prevent the WeakHashMap entry from being removed.&#160;&lt;/p&gt;

&lt;p&gt;I will look into how to fix this.&lt;/p&gt;</comment>
                            <comment id="16894860" author="jira-bot" created="Mon, 29 Jul 2019 02:08:01 +0000"  >&lt;p&gt;Commit 2b2b85d8ed3005520f0d8e464c33c1007df43918 in logging-log4j2&apos;s branch refs/heads/master from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=2b2b85d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=2b2b85d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2366&quot; title=&quot;LoggerContext leak using Log4jLoggerFactory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2366&quot;&gt;&lt;del&gt;LOG4J2-2366&lt;/del&gt;&lt;/a&gt; - Remove references to LoggerContext when it is shutdown&lt;/p&gt;</comment>
                            <comment id="16894861" author="jira-bot" created="Mon, 29 Jul 2019 02:08:29 +0000"  >&lt;p&gt;Commit 4ac441d1f9e4373c5477cc896057469b41b8b1f4 in logging-log4j2&apos;s branch refs/heads/release-2.x from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=4ac441d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=4ac441d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2366&quot; title=&quot;LoggerContext leak using Log4jLoggerFactory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2366&quot;&gt;&lt;del&gt;LOG4J2-2366&lt;/del&gt;&lt;/a&gt; - Remove references to LoggerContext when it is shutdown&lt;/p&gt;</comment>
                            <comment id="16894862" author="ralph.goers@dslextreme.com" created="Mon, 29 Jul 2019 02:09:20 +0000"  >&lt;p&gt;Fix has been applied. Please verify and close.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12930430" name="minimal_example.7z" size="5260913" author="lucianorm" created="Thu, 5 Jul 2018 19:38:45 +0000"/>
                            <attachment id="12930175" name="patched_after.hprof.7z" size="29793432" author="lucianorm" created="Tue, 3 Jul 2018 19:21:50 +0000"/>
                            <attachment id="12930177" name="patched_after_waited.hprof.7z" size="30720588" author="lucianorm" created="Tue, 3 Jul 2018 19:21:48 +0000"/>
                            <attachment id="12930176" name="patched_before.hprof.7z" size="26655968" author="lucianorm" created="Tue, 3 Jul 2018 19:21:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 16 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vihr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>