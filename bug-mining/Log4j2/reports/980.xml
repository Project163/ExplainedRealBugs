<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:37:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1731] SslSocketManager should respect connectTimeoutMillis</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1731</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;Creating a SocketAppender with an SSLConfiguration causes log4j to use SslSocketManager to connect to the remote server.&lt;/p&gt;

&lt;p&gt;When SSL is not configured, TcpSocketManager correctly uses connectTimeoutMillis both during the initial socket setup and in the reconnection manager thread.&lt;/p&gt;

&lt;p&gt;But when SSL is configured SslSocketManager does not use connectTimeoutMillis when creating SSL sockets. The affects both the initial connection and the reconnection manager thread.&lt;/p&gt;

&lt;p&gt;In my testing, it takes nearly a minute for the connection to time out when the other side does not exists (i.e. use invalid host like 10.0.0.0).&lt;/p&gt;

&lt;p&gt;Example code to set up the SocketAppender:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SocketAppender appender = SyslogAppender.newBuilder()
				.withHost(&lt;span class=&quot;code-quote&quot;&gt;&quot;10.0.0.0&quot;&lt;/span&gt;)
				.withPort(514)
				.withProtocol(Protocol.SSL)
				.withSslConfiguration(SslConfiguration.createSSLConfiguration(&lt;span class=&quot;code-quote&quot;&gt;&quot;TLSv1.2&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;))
				.withConnectTimeoutMillis(1000)
				.withReconnectDelayMillis(500)
				.withImmediateFail(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
				.withImmediateFlush(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
				.withAdvertise(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
				.withIgnoreExceptions(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
				.withLayout(layout)
				.withName(&lt;span class=&quot;code-quote&quot;&gt;&quot;MY_APPENDER&quot;&lt;/span&gt;)
				.build();
appender.start();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If you run this, you should see the call to build() block for ~60s until the underlying operating system timeout occurs.&lt;/p&gt;

&lt;p&gt;Interestingly, the reconnection code and the initial connection code ignore the timeout for different reasons.&lt;/p&gt;

&lt;p&gt;1. The reconnect code uses a pattern that allows for specification of the timeout, but 0 is hard-coded in the constructor call for SslSocketManager.&lt;/p&gt;

&lt;p&gt;2. The initial connection code doesn&apos;t use a pattern that allows for specification of the connection time.&lt;/p&gt;

&lt;p&gt;Suggested fixes:&lt;br/&gt;
1. Use the configuration data&apos;s connectTimeoutMillis when instantiating SslSocketManager instead of hard-coding timeout to 0&lt;/p&gt;

&lt;p&gt;2. Use the same pattern that the reconnection code uses for socket connect where timeout is specified when connecting the socket.&lt;/p&gt;

&lt;p&gt;Suggested patch:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/log4j-core/src/main/java/org/apache/logging/log4j/core/net/SslSocketManager.java b/log4j-core/src/main/java/org/apache/logging/log4j/core/net/SslSocketManager.java
index 57a4b43..8c9eddc 100644
--- a/log4j-core/src/main/java/org/apache/logging/log4j/core/net/SslSocketManager.java
+++ b/log4j-core/src/main/java/org/apache/logging/log4j/core/net/SslSocketManager.java
@@ -190,8 +190,8 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SslSocketManager &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; TcpSocketManager {
                 LOGGER.catching(Level.DEBUG, e);
                 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
             }
-            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SslSocketManager(name, os, socket, data.sslConfiguration, inetAddress, data.host, data.port, 0,
-                    data.delayMillis, data.immediateFail, data.layout, data.bufferSize, data.socketOptions);
+            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SslSocketManager(name, os, socket, data.sslConfiguration, inetAddress, data.host, data.port,
+                    data.connectTimeoutMillis, data.delayMillis, data.immediateFail, data.layout, data.bufferSize, data.socketOptions);
         }

         &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; InetAddress resolveAddress(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; hostName) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; TlsSocketManagerFactoryException {
@@ -218,11 +218,12 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SslSocketManager &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; TcpSocketManager {
             SSLSocket socket;

             socketFactory = createSslSocketFactory(data.sslConfiguration);
-            socket = (SSLSocket) socketFactory.createSocket(data.host, data.port);
+            socket = (SSLSocket) socketFactory.createSocket();
             &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SocketOptions socketOptions = data.socketOptions;
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (socketOptions != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                 socketOptions.apply(socket);
             }
+            socket.connect(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InetSocketAddress(data.host, data.port), data.connectTimeoutMillis);
             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; socket;
         }
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With this patch applied, both the initial connect and reconnect respect connectTimeoutMillis and my tests/applications don&apos;t hang on startup when the server is not available.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13027214">LOG4J2-1731</key>
            <summary>SslSocketManager should respect connectTimeoutMillis</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="chribble">Chris Ribble</reporter>
                        <labels>
                            <label>patch</label>
                    </labels>
                <created>Sat, 10 Dec 2016 20:27:40 +0000</created>
                <updated>Tue, 13 Dec 2016 01:00:51 +0000</updated>
                            <resolved>Sun, 11 Dec 2016 11:30:08 +0000</resolved>
                                    <version>2.7</version>
                                    <fixVersion>2.8</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="86400">24h</timeoriginalestimate>
                            <timeestimate seconds="86400">24h</timeestimate>
                                        <comments>
                            <comment id="15738441" author="githubbot" created="Sat, 10 Dec 2016 20:29:49 +0000"  >&lt;p&gt;GitHub user chrisribble opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/49&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/49&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1731&quot; title=&quot;SslSocketManager should respect connectTimeoutMillis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1731&quot;&gt;&lt;del&gt;LOG4J2-1731&lt;/del&gt;&lt;/a&gt; SslSocketManager should respect connectTimeoutMillis&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/chrisribble/logging-log4j2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/chrisribble/logging-log4j2&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/49.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/49.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #49&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit e77ffc53fd1a624fb04b3749a4822115e5bd9dee&lt;br/&gt;
Author: Chris Ribble &amp;lt;chribble@cisco.com&amp;gt;&lt;br/&gt;
Date:   2016-12-10T20:05:39Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1731&quot; title=&quot;SslSocketManager should respect connectTimeoutMillis&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1731&quot;&gt;&lt;del&gt;LOG4J2-1731&lt;/del&gt;&lt;/a&gt; SslSocketManager should respect connectTimeoutMillis&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15738498" author="githubbot" created="Sat, 10 Dec 2016 21:14:03 +0000"  >&lt;p&gt;Github user chrisribble commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/49&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/49&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    It looks like this test failed, but all tests - including this one - passed on my machine.&lt;/p&gt;

&lt;p&gt;    TlsSyslogAppenderTest&amp;gt;SyslogAppenderTest.testUDPStructuredAppender:86-&amp;gt;SyslogAppenderTestBase.sendAndCheckStructuredMessage:84-&amp;gt;SyslogAppenderTestBase.checkTheNumberOfSentAndReceivedMessages:103 The number of received messages should be equal with the number of sent messages expected:&amp;lt;1&amp;gt; but was:&amp;lt;0&amp;gt;&lt;/p&gt;

&lt;p&gt;    This is my first time contributing to log4j2, so I&apos;m not really sure what the next step is.&lt;/p&gt;</comment>
                            <comment id="15739589" author="githubbot" created="Sun, 11 Dec 2016 11:28:55 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/49&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/49&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15739591" author="remkop@yahoo.com" created="Sun, 11 Dec 2016 11:30:10 +0000"  >&lt;p&gt;Patch applied without issues. All core tests pass on my machine.&lt;/p&gt;

&lt;p&gt;Thank you for the patch!&lt;br/&gt;
Please verify and close.&lt;/p&gt;</comment>
                            <comment id="15742981" author="garydgregory" created="Mon, 12 Dec 2016 19:59:38 +0000"  >&lt;p&gt;This test fails for me now: &lt;tt&gt;org.apache.logging.log4j.core.appender.SecureSocketAppenderSocketOptionsTest.testSocketOptions()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;You?&lt;/p&gt;</comment>
                            <comment id="15743336" author="remkop@yahoo.com" created="Mon, 12 Dec 2016 22:19:42 +0000"  >&lt;p&gt;I tried building 3 times Sunday night. &lt;br/&gt;
Core tests all past, just got stuck on the osgi module. I didn&apos;t see the issue you mentioned. I&apos;ll try again. &lt;/p&gt;

&lt;p&gt;Sent from my iPhone&lt;/p&gt;
</comment>
                            <comment id="15743498" author="remkop@yahoo.com" created="Mon, 12 Dec 2016 23:25:39 +0000"  >&lt;p&gt;Today again, all core tests pass (stuck on OSGi with a different error).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chribble&quot; class=&quot;user-hover&quot; rel=&quot;chribble&quot;&gt;chribble&lt;/a&gt;, Gary made the following change to make the test pass for him. Can you review?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Socket createSocket(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SslFactoryData data) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    SSLSocketFactory socketFactory;
    SSLSocket socket;

    socketFactory = createSslSocketFactory(data.sslConfiguration);
    socket = (SSLSocket) socketFactory.createSocket();
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SocketOptions socketOptions = data.socketOptions;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (socketOptions != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-comment&quot;&gt;// Not sure which options must be applied before or after the connect() call.
&lt;/span&gt;        socketOptions.apply(socket);
    }
    socket.connect(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InetSocketAddress(data.host, data.port), data.connectTimeoutMillis);

&lt;span class=&quot;code-comment&quot;&gt;// THIS IF BLOCK WAS ADDED
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (socketOptions != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-comment&quot;&gt;// Not sure which options must be applied before or after the connect() call.
&lt;/span&gt;        socketOptions.apply(socket);
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; socket;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15743586" author="chribble" created="Tue, 13 Dec 2016 00:05:48 +0000"  >&lt;p&gt;I wasn&apos;t really sure what order the SocketOptions should be applied in. Intuitively, it makes sense to apply options before connecting, since some options might affect socket set up, but previously the code was applying SocketOptions after connect.&lt;/p&gt;

&lt;p&gt;Looking at the JavaDoc for Socket (&lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/net/Socket.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/7/docs/api/java/net/Socket.html&lt;/a&gt;) I don&apos;t see anything indicating that you should call the various Socket functions after connect, but three of them (setTrafficClass, setReuseAddress, and setPerformancePreferences) indicate that they may have no effect or have undefined behaviors after binding the socket (depending on the underlying platform implementation).&lt;/p&gt;

&lt;p&gt;I pulled master and ran the tests just now; they pass and so does my use case (setting timeout still works). However, I&apos;m not specifying any extra SocketOptions, so I can&apos;t really speak to the correctness of the SocketOptions apply order.&lt;/p&gt;</comment>
                            <comment id="15743685" author="garydgregory" created="Tue, 13 Dec 2016 00:44:01 +0000"  >&lt;p&gt;I current git master code hammers the options on the socket again after connect so the tests pass. The question is: how do you get the test to pass without doing that.&lt;/p&gt;</comment>
                            <comment id="15743725" author="chribble" created="Tue, 13 Dec 2016 01:00:51 +0000"  >&lt;p&gt;My system is running LInux (2.6.32-642.6.2.el6.x86_64) with Oracle JDK 1.8.0_51. Presumably the difference we&apos;re seeing some sort of platform socket management difference between Linux and Windows WRT the order the options are applied.&lt;/p&gt;

&lt;p&gt;I am not doing anything special to get the tests to pass; just &quot;mvn clean install&quot;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 49 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37fvz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>