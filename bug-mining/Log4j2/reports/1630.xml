<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:43:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-3487] The LoggerConfig includeLocation defaults to true in 2.17.2</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-3487</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;We&apos;ve found services running 2.17.2 to be slower than 2.17.1. A heat map indicates a StackWalker in log4j.&lt;/p&gt;

&lt;p&gt;I found that the code that Logger plugin calls into has changed. In 2.17.1 the default config for includeLocation is based only on the configured value. In 2.17.2 it&apos;s based on the config value if present, but then defaults to !(context instanceof AsyncLoggerContext).&lt;/p&gt;

&lt;p&gt;Since none of our Logger elements declare includeLocation - the default behavior has changed causing all LogEvents to include their location.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13441382">LOG4J2-3487</key>
            <summary>The LoggerConfig includeLocation defaults to true in 2.17.2</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="dmessink">Dave Messink</reporter>
                        <labels>
                    </labels>
                <created>Sun, 24 Apr 2022 19:14:43 +0000</created>
                <updated>Mon, 2 Jan 2023 06:30:13 +0000</updated>
                            <resolved>Thu, 29 Dec 2022 20:50:32 +0000</resolved>
                                    <version>2.17.2</version>
                                    <fixVersion>2.20.0</fixVersion>
                                    <component>Configuration</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17527247" author="ralph.goers@dslextreme.com" created="Sun, 24 Apr 2022 20:38:44 +0000"  >&lt;p&gt;The default isn&apos;t that simple. AbstractLogger has a requiresLocation() method that defaults to false. However, the default isn&apos;t particularly meaningful as it ends up referring to the requiresLocation value for the LoggerConfig associated with the Logger. This ends up doing:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; requiresLocation() {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!includeLocation) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    }
    AppenderControl[] controls = appenders.get();
    LoggerConfig loggerConfig = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (loggerConfig != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (AppenderControl control : controls) {
            Appender appender = control.getAppender();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (appender &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; LocationAware &amp;amp;&amp;amp; ((LocationAware) appender).requiresLocation()) {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
            }
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (loggerConfig.additive) {
            loggerConfig = loggerConfig.parent;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (loggerConfig != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                controls = loggerConfig.appenders.get();
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
        }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The Appender requiresLocation will check to see if the Layout or any other elements associated with the Appender require location information. If the LoggerConfig is additive it will check those as well. Note that the default for includeLocation is true. It is only set to false when something explicitly sets it to false.&#160; This has been the behavior since 2.12.1. If something was modified to indicate it now requires location information or your configuration was updated to use something that requires location information then that would cause this behavior.&lt;/p&gt;</comment>
                            <comment id="17527549" author="JIRAUSER288551" created="Mon, 25 Apr 2022 14:52:21 +0000"  >&lt;p&gt;I simplified my testing and was using jconsole to detect the difference. It appears that the Logger mbeans reflect the LoggerConfig, and not the Logger. The default value in the Logger mbean does indicate a change in the includeLocation attribute when it is not configured, but that does not reflect what the Logger requiresLocation is.&lt;/p&gt;

&lt;p&gt;To your point, there must me something else triggering requiresLocation in the actual service.&lt;/p&gt;</comment>
                            <comment id="17527739" author="JIRAUSER288551" created="Mon, 25 Apr 2022 19:57:19 +0000"  >&lt;p&gt;The MBean thing through me off, but it&apos;s still the root cause of the issue. The Logger MBean says includeLocation = true, while the Logger itself uses the logic above and it&apos;s requiresLocation field is false.&lt;/p&gt;

&lt;p&gt;The problem is that the LoggerConfig processes the LogEvent, and sets the event&apos;s includeLocation to the LoggerConfig.includeLocation value. This causes the LogEvent to walk the stack trace to discover the location - when it should not.&lt;/p&gt;

&lt;p&gt;LoggerConfig:&lt;/p&gt;

&lt;p&gt;private void processLogEvent(final LogEvent event, final LoggerConfigPredicate predicate) {&#160; &#160;&lt;b&gt;event.setIncludeLocation(isIncludeLocation());&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160; if (predicate.allow(this)) &lt;/p&gt;
{

&#160; &#160; callAppenders(event);

&#160; }

&lt;p&gt;&#160; logParent(event, predicate);&lt;/p&gt;

&lt;p&gt;}&lt;/p&gt;</comment>
                            <comment id="17527790" author="JIRAUSER288551" created="Mon, 25 Apr 2022 22:37:03 +0000"  >&lt;p&gt;The attached log4j2-3487.patch file defines a test that passes against 2.17.1, but fails in 2.17.2.&lt;/p&gt;</comment>
                            <comment id="17528419" author="ralph.goers@dslextreme.com" created="Tue, 26 Apr 2022 21:17:12 +0000"  >&lt;p&gt;Is &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3491&quot; title=&quot;High cpu, due to a change that cause to includeLocation by default for AsyncLogger&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3491&quot;&gt;&lt;del&gt;LOG4J2-3491&lt;/del&gt;&lt;/a&gt; a duplicate of this?&lt;/p&gt;</comment>
                            <comment id="17528429" author="JIRAUSER288551" created="Tue, 26 Apr 2022 21:59:20 +0000"  >&lt;p&gt;Yes. They&apos;re reporting the same change in 2.17.2 that causes the LogEvent.includeLocation to be true.&lt;/p&gt;</comment>
                            <comment id="17641056" author="JIRAUSER288551" created="Wed, 30 Nov 2022 04:15:04 +0000"  >&lt;p&gt;I&apos;ve discovered that this includeLocation regression exists in both 2.18.0 and 2.19.0. Specifically for the AsyncRootLogger. I tried to generate a PR &#8211; but I&apos;m still working through my account issues. I&apos;m attaching a patch file that adds a test and patch for the AsyncRootLogger default includeLocation.&lt;/p&gt;</comment>
                            <comment id="17641067" author="pkarwasz" created="Wed, 30 Nov 2022 05:30:07 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dmessink&quot; class=&quot;user-hover&quot; rel=&quot;dmessink&quot;&gt;dmessink&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;By the way, we are working on solutions that will render &lt;tt&gt;includeLocation&lt;/tt&gt; obsolete: cf &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3628&quot; title=&quot;Migrate from maven-changes-plugin to a merge-conflict-free Markdown-based solution&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3628&quot;&gt;&lt;del&gt;LOG4J2-3628&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/1147&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #1147&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I would really appreciate your opinion on the direction the bytecode weaving tool is taking. E.g. what would be the minimal set of features for the tool? What logging APIs do we need to support?&lt;/p&gt;</comment>
                            <comment id="17641068" author="ralph.goers@dslextreme.com" created="Wed, 30 Nov 2022 05:31:14 +0000"  >&lt;p&gt;Unfortunately your patch is out of date with release-2.x. The tests have been moved to log4j-core-tests and the changes.xml conflicts. It is best to probably just put the changes.xml entry in this issue for the time being. We are changing how we handle documenting changes to avoid these kinds of conflicts but that isn&apos;t quite ready yet.&lt;/p&gt;</comment>
                            <comment id="17641436" author="JIRAUSER288551" created="Wed, 30 Nov 2022 16:24:37 +0000"  >&lt;p&gt;My bad on that patch file. I&apos;ve attached a regenerated version of it. I didn&apos;t quite get your comment on changes.xml.&lt;/p&gt;</comment>
                            <comment id="17642316" author="JIRAUSER288551" created="Fri, 2 Dec 2022 06:58:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/1162&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/1162&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17649906" author="JIRAUSER288551" created="Tue, 20 Dec 2022 17:44:11 +0000"  >&lt;p&gt;FYI - The regression also messes up garbage-free logging as well. (The cost of acquiring the current stack trace.)&lt;/p&gt;</comment>
                            <comment id="17652939" author="ralph.goers@dslextreme.com" created="Thu, 29 Dec 2022 20:50:05 +0000"  >&lt;p&gt;I merged the PR to release-2.x. It looks like the change had already been made to master.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13441755">LOG4J2-3491</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13042964" name="log4j2-3487-1.patch" size="3001" author="dmessink" created="Tue, 26 Apr 2022 15:42:55 +0000"/>
                            <attachment id="13053427" name="log4j2-3487-2.patch" size="6502" author="dmessink" created="Fri, 2 Dec 2022 05:40:58 +0000"/>
                            <attachment id="13042909" name="log4j2-3487.patch" size="2908" author="dmessink" created="Mon, 25 Apr 2022 22:36:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 45 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z11r60:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>