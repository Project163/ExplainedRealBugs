<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:36:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1409] ArrayIndexOutOfBoundsException in ReusableParameterizedMessage </title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1409</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;A specific set of parameterised logging messages produces an Array Index Out of Bounds exception. It occurs due to the params array (initially set to 10) being reset to a lower number due to a lambda function passed in as an parameter. Then the subsequent logging messages don&apos;t reset this number.&lt;/p&gt;

&lt;p&gt;Best to explain in an example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Logger logger = LogManager.getLogger();

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
        logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hello {} {} {}&quot;&lt;/span&gt;, 1, 2,3);
        logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hello {}&quot;&lt;/span&gt;, () -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;World&quot;&lt;/span&gt;);
        logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hello {}&quot;&lt;/span&gt;, 1);
        
        &lt;span class=&quot;code-comment&quot;&gt;// Uncomment out &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; log event and the params gets reset correctly
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// No exception occurs
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hello {}&quot;&lt;/span&gt;, 1);
&lt;/span&gt;
        &lt;span class=&quot;code-comment&quot;&gt;// Exception at &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; log event - as the params is set to 1!
&lt;/span&gt;        logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hello {} {} {}&quot;&lt;/span&gt;, 1, 2,3);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Work around for this is not to use the ReusableParameterizedMessage. Instead to specify the legacy Message Factory of ParameterizedMessageFactory as a property of the program and no exception occurs.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12975368">LOG4J2-1409</key>
            <summary>ArrayIndexOutOfBoundsException in ReusableParameterizedMessage </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="Shahan">Shahan</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Jun 2016 02:57:15 +0000</created>
                <updated>Sun, 18 Sep 2016 10:36:43 +0000</updated>
                            <resolved>Sun, 18 Sep 2016 10:36:43 +0000</resolved>
                                    <version>2.6</version>
                                    <fixVersion>2.6.1</fixVersion>
                                    <component>API</component>
                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15313541" author="remkop@yahoo.com" created="Fri, 3 Jun 2016 04:07:01 +0000"  >&lt;p&gt;Thanks for reporting this! Looking into it.&lt;/p&gt;</comment>
                            <comment id="15314094" author="remkop@yahoo.com" created="Fri, 3 Jun 2016 13:21:25 +0000"  >&lt;p&gt;Actually, this can happen even without a lambda, whenever a parameter array of length less than 10 is specified. For example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hello {}&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]{1});
        logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hello {} {} {}&quot;&lt;/span&gt;, 1, 2,3);
        logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hello {} {} {}&quot;&lt;/span&gt;, 1, 2,3);

gives
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.ArrayIndexOutOfBoundsException: 1
	at org.apache.logging.log4j.message.ReusableParameterizedMessage.set(ReusableParameterizedMessage.java:129)
	at org.apache.logging.log4j.message.ReusableMessageFactory.newMessage(ReusableMessageFactory.java:112)
	at org.apache.logging.log4j.spi.AbstractLogger.logMessage(AbstractLogger.java:2030)
	at org.apache.logging.log4j.spi.AbstractLogger.logIfEnabled(AbstractLogger.java:1906)
	at org.apache.logging.log4j.spi.AbstractLogger.info(AbstractLogger.java:1445)
	at LOG4J2_1409.main(LOG4J2_1409.java:16)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It has to do with the mechanism introduced to preserve parameters (&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1342&quot; title=&quot;ReusableParameterizedMessage should preserve parameters when used with Async Loggers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1342&quot;&gt;&lt;del&gt;LOG4J2-1342&lt;/del&gt;&lt;/a&gt;): the swapParameters() method.&lt;br/&gt;
Essentially, explicitly specifying a small parameter array will mean that this small array ends up being swapped in.&lt;/p&gt;

&lt;p&gt;Unit test that reproduces the issue:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.apache.logging.log4j.message; 
&lt;span class=&quot;code-comment&quot;&gt;// test must be in log4j-core but in org.apache.logging.log4j.message &lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; because it calls &lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt;-&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; methods
&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.logging.log4j.core.impl.MutableLogEvent;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.Test;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MutableLogEventWithReusableParamMsgTest {

    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testInteractionWithReusableParameterizedMessage() {
        MutableLogEvent evt = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MutableLogEvent();
        ReusableParameterizedMessage msg = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ReusableParameterizedMessage();
        msg.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hello {} {} {}&quot;&lt;/span&gt;, 1, 2, 3);
        evt.setMessage(msg);
        evt.clear();

        msg.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hello {}&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]{1});
        evt.setMessage(msg);
        evt.clear();

        msg.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hello {}&quot;&lt;/span&gt;, 1);
        evt.setMessage(msg);
        evt.clear();

        &lt;span class=&quot;code-comment&quot;&gt;// Uncomment out &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; log event and the params gets reset correctly (No exception occurs)
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//        msg.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hello {}&quot;&lt;/span&gt;, 1);
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//        evt.setMessage(msg);
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;//        evt.clear();
&lt;/span&gt;
        &lt;span class=&quot;code-comment&quot;&gt;// Exception at &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; log event - as the params is set to 1!
&lt;/span&gt;        msg.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;Hello {} {} {}&quot;&lt;/span&gt;, 1, 2, 3);
        evt.setMessage(msg);
        evt.clear();
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Fix&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Index: log4j-api/src/main/java/org/apache/logging/log4j/message/ReusableParameterizedMessage.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&amp;lt;+&amp;gt;UTF-8
===================================================================
--- log4j-api/src/main/java/org/apache/logging/log4j/message/ReusableParameterizedMessage.java	(revision )
+++ log4j-api/src/main/java/org/apache/logging/log4j/message/ReusableParameterizedMessage.java	(revision )
@@ -62,10 +62,32 @@
         &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] result;
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (varargs == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
             result = params;
-            params = Objects.requireNonNull(emptyReplacement);
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (emptyReplacement.length &amp;lt; 10) { &lt;span class=&quot;code-comment&quot;&gt;// Bad replacement! Too small, may blow up &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; 10-arg messages.
&lt;/span&gt;+                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (argCount &amp;lt;= emptyReplacement.length) {
+                    &lt;span class=&quot;code-comment&quot;&gt;// copy params into the specified replacement array and &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; that
&lt;/span&gt;+                    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.arraycopy(params, 0, emptyReplacement, 0, argCount);
+                    result = emptyReplacement;
-        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
+                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
+                    &lt;span class=&quot;code-comment&quot;&gt;// replacement array is too small &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; current content and &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; content: discard it
&lt;/span&gt;+                    params = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[10];
+                }
+            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
+                params = emptyReplacement;
+            }
+        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
+            &lt;span class=&quot;code-comment&quot;&gt;// Whatever array we &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;, the caller will likely &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to reuse it in &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; swapParameter() calls.
&lt;/span&gt;+            &lt;span class=&quot;code-comment&quot;&gt;// However, &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the vararg array is less than 10 params it is not reusable.
&lt;/span&gt;+            &lt;span class=&quot;code-comment&quot;&gt;// If we ignore &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; fact and still *swap* with the specified array, then the specified array will likely
&lt;/span&gt;+            &lt;span class=&quot;code-comment&quot;&gt;// be discarded (even though it had 10 slots and was perfectly reusable).
&lt;/span&gt;+            &lt;span class=&quot;code-comment&quot;&gt;// Instead, we
&lt;/span&gt;+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (argCount &amp;lt;= emptyReplacement.length) {
+                &lt;span class=&quot;code-comment&quot;&gt;// copy params into the specified replacement array and &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; that
&lt;/span&gt;+                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.arraycopy(varargs, 0, emptyReplacement, 0, argCount);
+                result = emptyReplacement;
+            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
-            result = varargs;
-            varargs = Objects.requireNonNull(emptyReplacement);
+                result = varargs;
+                varargs = Objects.requireNonNull(emptyReplacement);
+            }
         }
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; result;
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15314367" author="remkop@yahoo.com" created="Fri, 3 Jun 2016 16:30:35 +0000"  >&lt;p&gt;Fixed in master in commit 6d80ddf.&lt;br/&gt;
Please verify and close.&lt;/p&gt;</comment>
                            <comment id="15318033" author="remkop@yahoo.com" created="Tue, 7 Jun 2016 07:26:27 +0000"  >&lt;p&gt;The fix for this is included in the upcoming 2.6.1 release.&lt;/p&gt;

&lt;p&gt;As a workaround, this issue will not occur if system property &lt;tt&gt;log4j2.enable.threadlocals&lt;/tt&gt; is set to &lt;tt&gt;false&lt;/tt&gt; &lt;b&gt;before&lt;/b&gt; log4j is initialized.&lt;/p&gt;</comment>
                            <comment id="15318473" author="shahan" created="Tue, 7 Jun 2016 13:37:41 +0000"  >&lt;p&gt;Tested with same code in ticket description with 2.6.1-SNAPSHOT and works as expected. Hence closed the issue.&lt;/p&gt;</comment>
                            <comment id="15318478" author="shahan" created="Tue, 7 Jun 2016 13:41:03 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=remkop%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;remkop@yahoo.com&quot;&gt;remkop@yahoo.com&lt;/a&gt; for fixing the issue and providing the workaround. &lt;/p&gt;

&lt;p&gt;Also, could you please let me know when we can expect the release 2.6.1 ?&lt;/p&gt;</comment>
                            <comment id="15318831" author="jvz" created="Tue, 7 Jun 2016 16:38:28 +0000"  >&lt;p&gt;There&apos;s a vote in progress for 2.6.1, so provided no blockers are found, it&apos;ll be released in a few days.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311120" key="com.pyxis.greenhopper.jira:gh-epic-link">
                        <customfieldname>Epic Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>LOG4J2-1270</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 24 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yxb3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>