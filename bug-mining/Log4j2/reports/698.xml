<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:35:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1222] Initializing Logger during JVM shutdown fails with FATAL error</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1222</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;Trying to stop a web application leads to the following problem:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[INFO] Stopped ServerConnector@7fad214a{HTTP/1.1,[http/1.1]}{0.0.0.0:8080}
[INFO] Stopped ServerConnector@7793ad58{SSL,[ssl, http/1.1]}{0.0.0.0:8443}
2015-12-12 19:09:24,604 &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-1 FATAL Unable to register shutdown hook because JVM is shutting down. java.lang.IllegalStateException: Cannot add &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; shutdown hook as &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is not started. Current state: STOPPED
	at org.apache.logging.log4j.core.util.DefaultShutdownCallbackRegistry.addShutdownCallback(DefaultShutdownCallbackRegistry.java:113)
	at org.apache.logging.log4j.core.impl.Log4jContextFactory.addShutdownCallback(Log4jContextFactory.java:271)
	at org.apache.logging.log4j.core.LoggerContext.setUpShutdownHook(LoggerContext.java:240)
	at org.apache.logging.log4j.core.LoggerContext.start(LoggerContext.java:201)
	at org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:146)
	at org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:41)
	at org.apache.logging.log4j.LogManager.getContext(LogManager.java:177)
	at org.apache.logging.log4j.spi.AbstractLoggerAdapter.getContext(AbstractLoggerAdapter.java:103)
	at org.apache.logging.slf4j.Log4jLoggerFactory.getContext(Log4jLoggerFactory.java:43)
	at org.apache.logging.log4j.spi.AbstractLoggerAdapter.getLogger(AbstractLoggerAdapter.java:42)
	at org.apache.logging.slf4j.Log4jLoggerFactory.getLogger(Log4jLoggerFactory.java:29)
	at org.slf4j.LoggerFactory.getLogger(LoggerFactory.java:284)
	at org.slf4j.LoggerFactory.getLogger(LoggerFactory.java:304)
	at org.apache.wicket.core.util.lang.PropertyResolver.&amp;lt;clinit&amp;gt;(PropertyResolver.java:75)
	at org.apache.wicket.Application.internalDestroy(Application.java:786)
	at org.apache.wicket.protocol.http.WebApplication.internalDestroy(WebApplication.java:704)
	at org.apache.wicket.protocol.http.WicketFilter.destroy(WicketFilter.java:614)
	at org.eclipse.jetty.servlet.FilterHolder.destroyInstance(FilterHolder.java:172)
	at org.eclipse.jetty.servlet.FilterHolder.doStop(FilterHolder.java:150)
	at org.eclipse.jetty.util.component.AbstractLifeCycle.stop(AbstractLifeCycle.java:89)
	at org.eclipse.jetty.util.component.ContainerLifeCycle.stop(ContainerLifeCycle.java:143)
	at org.eclipse.jetty.util.component.ContainerLifeCycle.doStop(ContainerLifeCycle.java:161)
	at org.eclipse.jetty.server.handler.AbstractHandler.doStop(AbstractHandler.java:73)
....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is at:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;at org.slf4j.LoggerFactory.getLogger(LoggerFactory.java:304)
	at org.apache.wicket.core.util.lang.PropertyResolver.&amp;lt;clinit&amp;gt;(PropertyResolver.java:75)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;During shutdown a class (PropertyResolver) is loaded for a first time and its &apos;private static final Logger&apos; leads to the above problem.&lt;/p&gt;

&lt;p&gt;The problem appears first in 2.4. There is no such issue with 2.3.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12921409">LOG4J2-1222</key>
            <summary>Initializing Logger during JVM shutdown fails with FATAL error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rgoers">Ralph Goers</assignee>
                                    <reporter username="mgrigorov">Martin Tzvetanov Grigorov</reporter>
                        <labels>
                    </labels>
                <created>Sat, 12 Dec 2015 18:18:36 +0000</created>
                <updated>Thu, 29 Sep 2016 00:23:22 +0000</updated>
                            <resolved>Mon, 8 Feb 2016 03:55:07 +0000</resolved>
                                    <version>2.4</version>
                    <version>2.5</version>
                                    <fixVersion>2.6</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15054525" author="ralph.goers@dslextreme.com" created="Sat, 12 Dec 2015 18:37:27 +0000"  >&lt;p&gt;I&apos;m not sure why this wouldn&apos;t have happened in 2.3. Adding the shutdown hook would have still thrown an exception.&lt;/p&gt;

&lt;p&gt;The only reasonable thing I can think of to do here is to catch the exception in LogManager and then revert to using the SimpleLoggerContextFactory instead.&lt;/p&gt;</comment>
                            <comment id="15054529" author="mgrigorov" created="Sat, 12 Dec 2015 18:39:49 +0000"  >&lt;p&gt;Do you need a demo application to play with ?&lt;/p&gt;</comment>
                            <comment id="15054581" author="ralph.goers@dslextreme.com" created="Sat, 12 Dec 2015 19:39:36 +0000"  >&lt;p&gt;A unit test that we can use to verify the fix would be great!&lt;/p&gt;</comment>
                            <comment id="15054602" author="mgrigorov" created="Sat, 12 Dec 2015 20:02:35 +0000"  >&lt;p&gt;See attached Maven project.&lt;br/&gt;
It consists of a single unit test showing the problem.&lt;br/&gt;
Indeed 2.3 fails! It is just a different exception.&lt;br/&gt;
2.0 works though.&lt;/p&gt;</comment>
                            <comment id="15114211" author="ralph.goers@dslextreme.com" created="Sun, 24 Jan 2016 06:01:07 +0000"  >&lt;p&gt;During shutdown trying to create a LoggerContext will now fail with an error message. LogManager will then use the SimpleLogger for any further logging.&lt;/p&gt;

&lt;p&gt;Please verify that this works the way you wanted and close the issue if it does.&lt;/p&gt;</comment>
                            <comment id="15114217" author="remkop@yahoo.com" created="Sun, 24 Jan 2016 06:41:43 +0000"  >&lt;p&gt;Ralph, your last 5 commits (I believe for this issue) were to the LOG4J-1181 branch, not to master. Was that intentionally?&lt;/p&gt;</comment>
                            <comment id="15114219" author="ralph.goers@dslextreme.com" created="Sun, 24 Jan 2016 06:49:29 +0000"  >&lt;p&gt;Rats. No. I didn&apos;t even realize I hadn&apos;t switched back to master. Merging these to master without bringing Scala in is going to be fun. I guess I will do it by hand.&lt;/p&gt;</comment>
                            <comment id="15114233" author="mgrigorov" created="Sun, 24 Jan 2016 07:38:31 +0000"  >&lt;p&gt;You should be able to cherry-pick the commits. I guess it will be easier.&lt;/p&gt;

&lt;p&gt;I&apos;ll test the fix in the next few days. Just let me know when the commits are in master.&lt;/p&gt;</comment>
                            <comment id="15114234" author="ralph.goers@dslextreme.com" created="Sun, 24 Jan 2016 07:53:09 +0000"  >&lt;p&gt;Yes. I just did that with SourceTree. It is in master now.&lt;/p&gt;</comment>
                            <comment id="15120650" author="mgrigorov" created="Thu, 28 Jan 2016 02:52:22 +0000"  >&lt;p&gt;Just tested with 2.5.1-SNAPSHOT and 2.6-SNAPSHOT and the problem is still here:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2016-01-28 03:50:49,374 &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-1 ERROR Unable to register shutdown hook because JVM is shutting down. java.lang.IllegalStateException: Cannot add &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; shutdown hook as &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is not started. Current state: STOPPED
	at org.apache.logging.log4j.core.util.DefaultShutdownCallbackRegistry.addShutdownCallback(DefaultShutdownCallbackRegistry.java:113)
	at org.apache.logging.log4j.core.impl.Log4jContextFactory.addShutdownCallback(Log4jContextFactory.java:276)
	at org.apache.logging.log4j.core.LoggerContext.setUpShutdownHook(LoggerContext.java:256)
	at org.apache.logging.log4j.core.LoggerContext.start(LoggerContext.java:216)
	at org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:148)
	at org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:41)
	at org.apache.logging.log4j.LogManager.getContext(LogManager.java:183)
	at org.apache.logging.log4j.spi.AbstractLoggerAdapter.getContext(AbstractLoggerAdapter.java:103)
	at org.apache.logging.slf4j.Log4jLoggerFactory.getContext(Log4jLoggerFactory.java:43)
	at org.apache.logging.log4j.spi.AbstractLoggerAdapter.getLogger(AbstractLoggerAdapter.java:42)
	at org.apache.logging.slf4j.Log4jLoggerFactory.getLogger(Log4jLoggerFactory.java:29)
	at org.slf4j.LoggerFactory.getLogger(LoggerFactory.java:284)
	at org.slf4j.LoggerFactory.getLogger(LoggerFactory.java:304)
....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15120652" author="mgrigorov" created="Thu, 28 Jan 2016 02:55:12 +0000"  >&lt;p&gt;The attached unit test passes but the original problem is still reproducible with a real application.&lt;/p&gt;</comment>
                            <comment id="15120654" author="mgrigorov" created="Thu, 28 Jan 2016 02:57:25 +0000"  >&lt;p&gt;Attaching a mini app that reproduces the problem.&lt;br/&gt;
Steps: &lt;br/&gt;
1) mvn jetty:run&lt;br/&gt;
2) Ctrl+C&lt;/p&gt;</comment>
                            <comment id="15120658" author="garydgregory" created="Thu, 28 Jan 2016 02:59:18 +0000"  >&lt;p&gt;FYI: 2.5.1-SNAPSHOT is no more, &apos;long live&apos; 2.6-SNAPSHOT!&lt;/p&gt;</comment>
                            <comment id="15136498" author="ralph.goers@dslextreme.com" created="Sun, 7 Feb 2016 22:44:41 +0000"  >&lt;p&gt;I built and ran the mini-app in Tomcat and didn&apos;t see a problem. I do see the problem with mvn jetty:run.&lt;/p&gt;</comment>
                            <comment id="15136574" author="ralph.goers@dslextreme.com" created="Mon, 8 Feb 2016 03:54:53 +0000"  >&lt;p&gt;Fix applied. The mini-app attached now shuts down without an error. Please verify and close.&lt;/p&gt;</comment>
                            <comment id="15139817" author="mgrigorov" created="Tue, 9 Feb 2016 21:33:39 +0000"  >&lt;p&gt;Seems to work fine now!&lt;br/&gt;
Thank you!&lt;/p&gt;</comment>
                            <comment id="15530885" author="rocketraman" created="Wed, 28 Sep 2016 21:12:59 +0000"  >&lt;p&gt;The fix for this seems to have created a new issue on shutdown when using log4j-jul, unsuccessfully attempting to cast a SimpleLogger to org.apache.logging.log4j.core.Logger at org.apache.logging.log4j.jul.CoreLoggerAdapter.newLogger(CoreLoggerAdapter.java:37)&lt;/p&gt;</comment>
                            <comment id="15530888" author="rocketraman" created="Wed, 28 Sep 2016 21:13:31 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1618&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/LOG4J2-1618&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12916405">WICKET-6046</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13008359">LOG4J2-1618</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12777303" name="log4j2-1222.tgz" size="5280" author="mgrigorov" created="Sat, 12 Dec 2015 20:02:35 +0000"/>
                            <attachment id="12784806" name="mini-app.tgz" size="20858" author="mgrigorov" created="Thu, 28 Jan 2016 02:57:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 7 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ptbj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>