<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:31:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-406] JMX MBeans are not being unregistered when a tomcat web application that uses log4j is undeployed, leading to a permgen memory leak.</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-406</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;When the log4j2 library is being used with a tomcat web application (included in the web application&apos;s libraries, not in the container&apos;s libraries), tomcat correctly discovers and initializes the Log4jServletContainerInitializer and adds the Log4JServletContextListener as described in the &lt;a href=&quot;http://logging.apache.org/log4j/2.x/manual/webapp.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;manual&lt;/a&gt; (after removing &quot;log4j*.jar&quot; from the jarsToSkip property as described on that page). However, two MBeans that log4j registers (ContextSelector and StatusLogger) are never unregistered when the web application is undeployed. This prevents the entire web application from being garbage collected and leads to a permgen memory leak and causes an OutOfMemoryError after a few undeploy/redeploy cycles*.&lt;/p&gt;

&lt;p&gt;We could work around this by taking the following steps:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Added a context parameter to the web.xml file specifying a value for the log4jContextName parameter. This seems to prevent java.lang.ApplicationShutdownHooks from keeping a refernce to the log4j LoggerContext, which was part of why the memory leak was occuring**.&lt;/li&gt;
	&lt;li&gt;In addition, took one of the following measures:
	&lt;ul&gt;
		&lt;li&gt;Added the log4j2 libraries to tomcat&apos;s classpath. Regardless of whether or not the libraries were in the web application&apos;s classpath, this seemed to circumvent the entire issue.&lt;/li&gt;
		&lt;li&gt;Disabled jmx entirely, by adding -Dlog4j.disable.jmx=true to the JVM options for tomcat.&lt;/li&gt;
		&lt;li&gt;Added a custom ServletContextListener which manually unregisters all log4j MBeans upon the destruction of the context.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Any of the steps from 2 worked equally well, but none of them worked unless we also took step 1.&lt;/p&gt;

&lt;p&gt;&amp;#42; We used jmap and jhat to confirm that the application was not being unloaded from memory after being undeployed, and were able to narrow the cause down to those MBeans by tracing a reference path from the StandardClassloader through them to the WebappClassLoader.&lt;br/&gt;
&amp;#42;* We&apos;re unsure of what role ApplicationShutdownHooks plays in this scenario, but we observed in jhat that the reference path between log4j and ApplicationShutdownHooks disappeared after adding the log4jContextName parameter, and that this was necessary to stop the permgen memory leak.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Java 1.7.0_17-b02, tomcat 7.0.34.0, NetBeans 7.3, Windows 7 (64 bit)&lt;/p&gt;</environment>
        <key id="12669499">LOG4J2-406</key>
            <summary>JMX MBeans are not being unregistered when a tomcat web application that uses log4j is undeployed, leading to a permgen memory leak.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="karjaneth">Kerrigan Joseph</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Sep 2013 17:57:03 +0000</created>
                <updated>Mon, 7 Apr 2014 23:47:13 +0000</updated>
                            <resolved>Mon, 13 Jan 2014 07:52:53 +0000</resolved>
                                    <version>2.0-beta9</version>
                                    <fixVersion>2.0-rc1</fixVersion>
                    <fixVersion>2.0</fixVersion>
                                    <component>Core</component>
                    <component>JMX</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13772120" author="beamerblvd" created="Thu, 19 Sep 2013 18:03:39 +0000"  >&lt;p&gt;The &lt;tt&gt;ServletContextListener&lt;/tt&gt; correctly shuts down Log4j. The problem is that shutting down Log4j doesn&apos;t remove the MBeans. IMO, it should. Remko, can you take a look at that?&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;ApplicationShutdownHooks&lt;/tt&gt; should be disabled in a web application environment. I&apos;ll look at that this weekend.&lt;/p&gt;</comment>
                            <comment id="13772132" author="karjaneth" created="Thu, 19 Sep 2013 18:13:34 +0000"  >&lt;p&gt;I&apos;ve attached a sample netbeans project illustrating the issue. If this project is deployed and undeployed, an examination of a jmap dump of the tomcat process using jhat should indicate that it is still loaded. The web.xml file has some commented out sections that demonstrate one of the workarounds.&lt;/p&gt;</comment>
                            <comment id="13772489" author="remkop@yahoo.com" created="Thu, 19 Sep 2013 23:51:08 +0000"  >&lt;p&gt;Nick, I did&apos;t have much time to work on this but I&apos;ve added a way to unregister all MBeans associated with a LoggerContext.&lt;br/&gt;
&lt;tt&gt;org.apache.logging.log4j.core.jmx.Server#unregisterContext(String loggerContextName)&lt;/tt&gt;&lt;/p&gt;


&lt;p&gt;Next step would be calling this method when a web application is undeployed.&lt;/p&gt;</comment>
                            <comment id="13794708" author="remkop@yahoo.com" created="Tue, 15 Oct 2013 00:34:41 +0000"  >&lt;p&gt;Linked to &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-323&quot; title=&quot;ThreadLocal-leak on tomcat shutdown when using async logging&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-323&quot;&gt;&lt;del&gt;LOG4J2-323&lt;/del&gt;&lt;/a&gt;: some more &quot;cleaning-up-resources&quot; work to do at undeploy time.&lt;/p&gt;

&lt;p&gt;(update)&lt;br/&gt;
... and unlinked as it turns out that the ThreadLocal memory leak can be taken care of internally in the async logging components.&lt;/p&gt;</comment>
                            <comment id="13869339" author="remkop@yahoo.com" created="Mon, 13 Jan 2014 07:52:53 +0000"  >&lt;p&gt;Changes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;MBeans are now re-registered every time the Configuration is modified (previously there were some code paths where MBeans  were not registered).&lt;/li&gt;
	&lt;li&gt;&lt;em&gt;All&lt;/em&gt; MBeans are now unregistered when the LoggerContext is stopped. This includes the MBeans for the StatusLogger and ContextSelector.&lt;/li&gt;
	&lt;li&gt;Cleaned up the o.a.l.l.c.jmx.Server class (mixing format changes with logic changes, sorry about that).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This &lt;em&gt;should&lt;/em&gt; solve the problem but when using jhat to view the heap after undeploying the example PermGen application I still see the log4j classes loaded. (Not sure that I did this right...) With another test program I&apos;ve verified that MBeans are unregistered when the LoggerContext is stopped, though, so is it possible that the problem is caused by something other than the MBeans?&lt;/p&gt;

&lt;p&gt;Note also that this is a stopgap solution. It unregisters &lt;em&gt;all&lt;/em&gt; MBeans, so unloading one webapp will unload the MBeans for all other webapps as well. This is clearly not ideal but seemed a lesser evil than causing the app server to crash with an OutOfMemoryError. I will create a separate Jira issue for the permanent solution.&lt;/p&gt;

&lt;p&gt;Fixed in revision 1557654.&lt;br/&gt;
Please verify and close.&lt;/p&gt;</comment>
                            <comment id="13870140" author="karjaneth" created="Mon, 13 Jan 2014 23:53:03 +0000"  >&lt;p&gt;Thanks much! I&apos;ll try to poke it a bit and see if I can see why the log4j classes aren&apos;t unloading.&lt;/p&gt;</comment>
                            <comment id="13870253" author="remkop@yahoo.com" created="Tue, 14 Jan 2014 01:24:26 +0000"  >&lt;p&gt;Thank you! I am not confident that I did the jhat thing right...&lt;/p&gt;</comment>
                            <comment id="13962398" author="remkop@yahoo.com" created="Mon, 7 Apr 2014 23:47:13 +0000"  >&lt;p&gt;This ticket only mentions the stopgap solution. A more fine-grained solution was implemented with &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-500&quot; title=&quot;Unloading one webapp unloads JMX MBeans for all webapps&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-500&quot;&gt;&lt;del&gt;LOG4J2-500&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12673762">LOG4J2-426</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12688506">LOG4J2-500</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                                                <inwardlinks description="is superceded by">
                                        <issuelink>
            <issuekey id="12703316">LOG4J2-578</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12604079" name="PermGen.zip" size="760348" author="karjaneth" created="Thu, 19 Sep 2013 18:13:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>349431</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 33 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1o92n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>349729</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>