<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:41:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-2880] High CPU consumption using StackWalker</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-2880</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;While using OpenJDK 11, there are possibility cause severe CPU consumption because of JDK bug in using StackWalker.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;[Application on JDK11 consume 100% CPU after a few hours of uptime|&lt;a href=&quot;https://bugs.openjdk.java.net/browse/JDK-8222942&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugs.openjdk.java.net/browse/JDK-8222942&lt;/a&gt;]&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And it happened serveral times on our production environment.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13006603/13006603_image-2020-06-28-02-42-12-987.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Stack trace Is:&lt;/p&gt;

&lt;p&gt;&quot;reactor-http-epoll-1&quot; #75 daemon prio=5 os_prio=0 cpu=25100145.64ms elapsed=306507.26s tid=0x0000556eddcbd000 nid=0x61 runnable&#160; &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f8605443000&amp;#93;&lt;/span&gt;&quot;reactor-http-epoll-2&quot; #75 daemon prio=5 os_prio=0 cpu=25100145.64ms elapsed=306507.26s tid=0x0000556eddcbd000 nid=0x61 runnable&#160; &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f8605443000&amp;#93;&lt;/span&gt;&#160; &#160;java.lang.Thread.State: RUNNABLE at java.lang.StackStreamFactory$AbstractStackWalker.callStackWalk(java.base@11.0.6/Native Method) at java.lang.StackStreamFactory$AbstractStackWalker.beginStackWalk(java.base@11.0.6/StackStreamFactory.java:370) at java.lang.StackStreamFactory$AbstractStackWalker.walk(java.base@11.0.6/StackStreamFactory.java:243) at java.lang.StackWalker.walk(java.base@11.0.6/StackWalker.java:498) at org.apache.logging.log4j.util.StackLocator.calcLocation(StackLocator.java:81) at org.apache.logging.log4j.util.StackLocatorUtil.calcLocation(StackLocatorUtil.java:76) at org.apache.logging.log4j.spi.AbstractLogger.getLocation(AbstractLogger.java:2201) at org.apache.logging.log4j.spi.AbstractLogger.logMessageTrackRecursion(AbstractLogger.java:2144) at org.apache.logging.log4j.spi.AbstractLogger.logMessageSafely(AbstractLogger.java:2127) at org.apache.logging.log4j.spi.AbstractLogger.logMessage(AbstractLogger.java:2020) at org.apache.logging.log4j.spi.AbstractLogger.logIfEnabled(AbstractLogger.java:1891) at org.apache.logging.log4j.spi.AbstractLogger.info(AbstractLogger.java:1436)&lt;/p&gt;</description>
                <environment>&lt;p&gt;log4j version: 2.12.1&lt;/p&gt;

&lt;p&gt;JDK version: OpenJDK 11.0.6&lt;/p&gt;</environment>
        <key id="13313809">LOG4J2-2880</key>
            <summary>High CPU consumption using StackWalker</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="zhxhash">Hash Jang</reporter>
                        <labels>
                    </labels>
                <created>Sun, 28 Jun 2020 02:44:24 +0000</created>
                <updated>Fri, 31 Jul 2020 04:23:09 +0000</updated>
                            <resolved>Fri, 31 Jul 2020 04:23:09 +0000</resolved>
                                    <version>2.11.1</version>
                    <version>2.11.2</version>
                    <version>2.12.0</version>
                    <version>2.12.1</version>
                    <version>2.13.0</version>
                    <version>2.13.1</version>
                    <version>2.13.2</version>
                    <version>2.13.3</version>
                                    <fixVersion>2.14.0</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17147165" author="ralph.goers@dslextreme.com" created="Sun, 28 Jun 2020 03:04:09 +0000"  >&lt;p&gt;There is not enough information here to be able to do any problem determination. That said, I suspect this is a duplicate of&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2792&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/LOG4J2-2792&lt;/a&gt;. Please review that issue and see if it applies to your case. If not, please provide your logging configuration and, ideally, a sample program that demonstrates the problem.&lt;/p&gt;

&lt;p&gt;Also, the JDK bug doesn&apos;t look like it has enough info to be resolved either.&lt;/p&gt;</comment>
                            <comment id="17147174" author="zhxhash" created="Sun, 28 Jun 2020 03:22:58 +0000"  >&lt;p&gt;Thanks for the response. But I think we are not facing the same issue. Our application has serveral instances cpu consumption is usual at first and the load is stable and load of each instance is the same, but after some time &#65288;may serveral hours or several days&#65289;, one instance is facing this problem, which is the same to the JDK bug description:&#160;&lt;b&gt;Application on JDK11 consume 100% CPU after a few hours of uptime&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Here is our configuration:&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13006604/13006604_log4j2.xml&quot; title=&quot;log4j2.xml attached to LOG4J2-2880&quot;&gt;log4j2.xml&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17147185" author="zhxhash" created="Sun, 28 Jun 2020 03:37:32 +0000"  >&lt;p&gt;By the way, there are four&#160;reactor-http-epoll- threads, and their combination cpu consumption is 4 * 22. 7% nearly 100% CPU.&#160; Each with same stack trace:&#160;&lt;/p&gt;

&lt;p&gt;java.lang.Thread.State: RUNNABLEjava.lang.Thread.State: RUNNABLE at java.lang.StackStreamFactory$AbstractStackWalker.callStackWalk(java.base@11.0.6/Native Method) at java.lang.StackStreamFactory$AbstractStackWalker.beginStackWalk(java.base@11.0.6/StackStreamFactory.java:370) at java.lang.StackStreamFactory$AbstractStackWalker.walk(java.base@11.0.6/StackStreamFactory.java:243) at java.lang.StackWalker.walk(java.base@11.0.6/StackWalker.java:498) at org.apache.logging.log4j.util.StackLocator.calcLocation(StackLocator.java:81) at org.apache.logging.log4j.util.StackLocatorUtil.calcLocation(StackLocatorUtil.java:76) at org.apache.logging.log4j.spi.AbstractLogger.getLocation(AbstractLogger.java:2201) at org.apache.logging.log4j.spi.AbstractLogger.logMessageTrackRecursion(AbstractLogger.java:2144) at org.apache.logging.log4j.spi.AbstractLogger.logMessageSafely(AbstractLogger.java:2127) at org.apache.logging.log4j.spi.AbstractLogger.logMessage(AbstractLogger.java:2020) at org.apache.logging.log4j.spi.AbstractLogger.logIfEnabled(AbstractLogger.java:1891) at org.apache.logging.log4j.spi.AbstractLogger.info(AbstractLogger.java:1436)&lt;/p&gt;</comment>
                            <comment id="17147195" author="ralph.goers@dslextreme.com" created="Sun, 28 Jun 2020 03:52:30 +0000"  >&lt;p&gt;OK. If you believe this matches the JDK bug why did you open this issue?&lt;/p&gt;</comment>
                            <comment id="17147197" author="zhxhash" created="Sun, 28 Jun 2020 04:08:40 +0000"  >&lt;p&gt;Well, I hope you can eliminate the Stackwalker until the bug is resolved or provide a configuration to enable&#160;Stackwalker or using Throwable as StackLocator&lt;/p&gt;</comment>
                            <comment id="17160899" author="jira-bot" created="Mon, 20 Jul 2020 05:16:19 +0000"  >&lt;p&gt;Commit d3fb653f3c3b2dba52f35f12ee7fe622b6fdc040 in logging-log4j2&apos;s branch refs/heads/release-2.x from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=d3fb653&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=d3fb653&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2880&quot; title=&quot;High CPU consumption using StackWalker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2880&quot;&gt;&lt;del&gt;LOG4J2-2880&lt;/del&gt;&lt;/a&gt; - Add StackWalker benchmark. Revert back to using StackWalker.walk based on performance results&lt;/p&gt;</comment>
                            <comment id="17160900" author="jira-bot" created="Mon, 20 Jul 2020 05:17:07 +0000"  >&lt;p&gt;Commit fe57a508a305f896edfc979333273b829dd07f6d in logging-log4j2&apos;s branch refs/heads/master from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=fe57a50&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=fe57a50&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2880&quot; title=&quot;High CPU consumption using StackWalker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2880&quot;&gt;&lt;del&gt;LOG4J2-2880&lt;/del&gt;&lt;/a&gt; - Add StackWalker benchmark. Revert back to using StackWalker.walk based on performance results&lt;/p&gt;</comment>
                            <comment id="17160906" author="ralph.goers@dslextreme.com" created="Mon, 20 Jul 2020 05:32:11 +0000"  >&lt;p&gt;I created a benchmark to measure the options for walking the stack.&#160; I had previously tested this with a test application that was logging caller information but did not use JMH. Based on these results I have converted calcLocation back to using StackWalker.walk() to directly locate the caller.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Benchmark                            (callDepth)  (initialDepth)  Mode  Cnt   Score   Error  Units
StackWalkBenchmark.baseline                    5              10  avgt    5   0.069 &#177; 0.049  us/op
StackWalkBenchmark.baseline                    5              20  avgt    5   0.076 &#177; 0.036  us/op
StackWalkBenchmark.baseline                    5              50  avgt    5   0.452 &#177; 0.261  us/op
StackWalkBenchmark.baseline                   10              10  avgt    5   0.046 &#177; 0.005  us/op
StackWalkBenchmark.baseline                   10              20  avgt    5   0.055 &#177; 0.008  us/op
StackWalkBenchmark.baseline                   10              50  avgt    5   0.172 &#177; 0.025  us/op
StackWalkBenchmark.baseline                   20              10  avgt    5   0.039 &#177; 0.004  us/op
StackWalkBenchmark.baseline                   20              20  avgt    5   0.056 &#177; 0.001  us/op
StackWalkBenchmark.baseline                   20              50  avgt    5   0.168 &#177; 0.004  us/op
StackWalkBenchmark.stackWalkerArray            5              10  avgt    5  11.304 &#177; 0.236  us/op
StackWalkBenchmark.stackWalkerArray            5              20  avgt    5  14.122 &#177; 0.480  us/op
StackWalkBenchmark.stackWalkerArray            5              50  avgt    5  22.216 &#177; 0.431  us/op
StackWalkBenchmark.stackWalkerArray           10              10  avgt    5  12.247 &#177; 0.264  us/op
StackWalkBenchmark.stackWalkerArray           10              20  avgt    5  15.807 &#177; 0.477  us/op
StackWalkBenchmark.stackWalkerArray           10              50  avgt    5  24.083 &#177; 0.770  us/op
StackWalkBenchmark.stackWalkerArray           20              10  avgt    5  16.846 &#177; 0.187  us/op
StackWalkBenchmark.stackWalkerArray           20              20  avgt    5  19.330 &#177; 0.062  us/op
StackWalkBenchmark.stackWalkerArray           20              50  avgt    5  28.364 &#177; 0.227  us/op
StackWalkBenchmark.stackWalkerWalk             5              10  avgt    5   6.517 &#177; 0.070  us/op
StackWalkBenchmark.stackWalkerWalk             5              20  avgt    5   6.500 &#177; 0.085  us/op
StackWalkBenchmark.stackWalkerWalk             5              50  avgt    5   6.656 &#177; 0.075  us/op
StackWalkBenchmark.stackWalkerWalk            10              10  avgt    5   7.101 &#177; 0.074  us/op
StackWalkBenchmark.stackWalkerWalk            10              20  avgt    5   6.984 &#177; 0.349  us/op
StackWalkBenchmark.stackWalkerWalk            10              50  avgt    5   7.014 &#177; 0.241  us/op
StackWalkBenchmark.stackWalkerWalk            20              10  avgt    5  14.524 &#177; 0.769  us/op
StackWalkBenchmark.stackWalkerWalk            20              20  avgt    5  13.655 &#177; 0.325  us/op
StackWalkBenchmark.stackWalkerWalk            20              50  avgt    5  13.546 &#177; 0.405  us/op
StackWalkBenchmark.throwableSearch             5              10  avgt    5  14.593 &#177; 0.293  us/op
StackWalkBenchmark.throwableSearch             5              20  avgt    5  18.479 &#177; 0.168  us/op
StackWalkBenchmark.throwableSearch             5              50  avgt    5  28.606 &#177; 0.201  us/op
StackWalkBenchmark.throwableSearch            10              10  avgt    5  17.693 &#177; 0.982  us/op
StackWalkBenchmark.throwableSearch            10              20  avgt    5  21.331 &#177; 1.974  us/op
StackWalkBenchmark.throwableSearch            10              50  avgt    5  30.328 &#177; 0.343  us/op
StackWalkBenchmark.throwableSearch            20              10  avgt    5  19.937 &#177; 0.522  us/op
StackWalkBenchmark.throwableSearch            20              20  avgt    5  23.048 &#177; 0.299  us/op
StackWalkBenchmark.throwableSearch            20              50  avgt    5  32.670 &#177; 0.842  us/op

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17160908" author="jira-bot" created="Mon, 20 Jul 2020 05:33:59 +0000"  >&lt;p&gt;Commit 673d316fd7b8a99f17bce0f876f160e12b2497c6 in logging-log4j2&apos;s branch refs/heads/release-2.x from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=673d316&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=673d316&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2880&quot; title=&quot;High CPU consumption using StackWalker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2880&quot;&gt;&lt;del&gt;LOG4J2-2880&lt;/del&gt;&lt;/a&gt; - Add StackWalker benchmark. Revert back to using StackWalker.walk based on performance results&lt;/p&gt;</comment>
                            <comment id="17160909" author="jira-bot" created="Mon, 20 Jul 2020 05:34:35 +0000"  >&lt;p&gt;Commit b963d7c1aef39299e93f598334f62196c8d0e681 in logging-log4j2&apos;s branch refs/heads/master from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=b963d7c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=b963d7c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2880&quot; title=&quot;High CPU consumption using StackWalker&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2880&quot;&gt;&lt;del&gt;LOG4J2-2880&lt;/del&gt;&lt;/a&gt; - Add StackWalker benchmark. Revert back to using StackWalker.walk based on performance results&lt;/p&gt;</comment>
                            <comment id="17161659" author="zhxhash" created="Tue, 21 Jul 2020 01:58:56 +0000"  >&lt;p&gt;Thanks a lot for this promotion&lt;/p&gt;</comment>
                            <comment id="17168384" author="ralph.goers@dslextreme.com" created="Fri, 31 Jul 2020 04:23:09 +0000"  >&lt;p&gt;I can&apos;t say whether the JDK has a problem or not, but after running the benchmarks I believe Log4j has done all it can. Please verify and close.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13287965">LOG4J2-2792</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13006603" name="image-2020-06-28-02-42-12-987.png" size="42075" author="zhxhash" created="Sun, 28 Jun 2020 02:42:43 +0000"/>
                            <attachment id="13006604" name="log4j2.xml" size="3773" author="zhxhash" created="Sun, 28 Jun 2020 03:22:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0g96w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>