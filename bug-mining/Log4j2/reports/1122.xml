<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:39:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-2031] Messages appear out of order in log file (was: Log4j2 log file not reflecting application log function calls)</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-2031</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;Was hoping to move our numerous J2EE projects from Log4j to Log4j2 for the performance improvements.  I put together a small test case that writes a string pattern to a Rolling File.  There is a 6 digit sequence number at the start of the log message.  This allows me to quickly see if all the log requests are making it into the log file. I attach the test case and log4j2.xml.  The log4j2.xml uses an asynchronous appender.&lt;/p&gt;

&lt;p&gt;What I observe in the output log file is that after a short interval (120 or so entries) the logged are appearing in the wrong order, and entries can be missing.  The missing entries issues especially shows up when rolling to the next log file.&lt;/p&gt;

&lt;p&gt;Perhaps there is a deliberate decision to not to guarantee log file accurately for speed.  However we need the logs to accurately reflect what the application is logging.  I have also noticed the performance is 25% worse in Log4j2 than Log4j when not using the asynchronous appender.  So that rather kills us using Log4j2 at the moment.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows, Sun Java 8.&lt;/p&gt;</environment>
        <key id="13099798">LOG4J2-2031</key>
            <summary>Messages appear out of order in log file (was: Log4j2 log file not reflecting application log function calls)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="colinarity">Colin McDowell</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Sep 2017 10:48:09 +0000</created>
                <updated>Thu, 8 Feb 2018 06:57:20 +0000</updated>
                            <resolved>Wed, 20 Sep 2017 14:03:04 +0000</resolved>
                                    <version>2.8.2</version>
                    <version>2.9.0</version>
                    <version>2.9.1</version>
                                    <fixVersion>2.10.0</fixVersion>
                                    <component>Appenders</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="2419200">672h</timeoriginalestimate>
                            <timeestimate seconds="2419200">672h</timeestimate>
                                        <comments>
                            <comment id="16153768" author="remkop@yahoo.com" created="Tue, 5 Sep 2017 14:48:45 +0000"  >&lt;p&gt;I haven&apos;t looked in great detail, but some initial observations:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the PatternLayout uses location ( &lt;tt&gt;%L&lt;/tt&gt; ). This is implemented by walking the stack trace for every log event. This is &lt;a href=&quot;https://logging.apache.org/log4j/2.x/performance.html#asyncLoggingWithLocation&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;known to be very slow&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;rollover is configured in the test to be size-based after 20MB, and I suspect that the test spends a lot of its time doing rollovers. What is measured in this test is likely very different from   the actual logging performance in your real-life application.&lt;/li&gt;
	&lt;li&gt;you can get another small performance boost by using one of the predefined date formats like &lt;tt&gt;%d{DEFAULT&lt;/tt&gt;}. (These use a highly optimized custom formatter.)&lt;/li&gt;
	&lt;li&gt;the tests also include initialization time in their measurement. Log4j2 is slower to initialize than Log4j-1.2. We&apos;re aware of that but don&apos;t have plans to optimize that area. Not sure how important  startup time is for your applications, but may I suggest adding a separate loop (with the same number of iterations) that is not measured, before starting to measure? That will also allow the JVM to warm up and should give more realistic results.&lt;/li&gt;
	&lt;li&gt;The tests are single threaded. A lot of the &lt;a href=&quot;https://logging.apache.org/log4j/2.x/performance.html#fileLoggingComparison&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;performance improvements&lt;/a&gt; in Log4j2 (even for synchronous file logging) have to do with concurrent logging from multiple threads. J2EE applications tend to be heavily multi-threaded so they should benefit from Log4j2&apos;s fine grained locking and use of lock-free data structures. However, these benefits won&apos;t show up in the current tests. May I suggest looking at &lt;a href=&quot;http://openjdk.java.net/projects/code-tools/jmh/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JMH&lt;/a&gt; for performance testing? This takes care of things like warmup and allows you to easily verify multi threaded performance.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I need to run your example to see what&apos;s causing the reordering. &lt;/p&gt;</comment>
                            <comment id="16154970" author="colinarity" created="Wed, 6 Sep 2017 08:05:48 +0000"  >&lt;p&gt;Appreciate you taking time to look at the issue Remko.  Here is a sample from the logged output.&lt;/p&gt;

&lt;p&gt;As I mentioned a short distance into the log the output is no longer in sequence. I deliberately output my own counter at start of each log entry.  I added a &apos;%sn&apos; the log4j2 sequence number.  Notice the two counters are not the same.&lt;/p&gt;

&lt;p&gt;000110 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#160; 112 09/06 08:31:16.058 &lt;span class=&quot;error&quot;&gt;&amp;#91;&#160;&#160;&#160;&#160;&#160; main&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;com.allstate.drivewise.logging.test.CapacityTest:&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;000111 123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0 113 09/06 08:31:16.058 &lt;span class=&quot;error&quot;&gt;&amp;#91;&#160;&#160;&#160;&#160;&#160; main&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;com.allstate.drivewise.logging.test.CapacityTest:&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;000112 23456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 01 114 09/06 08:31:16.058 &lt;span class=&quot;error&quot;&gt;&amp;#91;&#160;&#160;&#160;&#160;&#160; main&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;com.allstate.drivewise.logging.test.CapacityTest:&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;000113 3456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 012 115 09/06 08:31:16.058 &lt;span class=&quot;error&quot;&gt;&amp;#91;&#160;&#160;&#160;&#160;&#160; main&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;com.allstate.drivewise.logging.test.CapacityTest:&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;000243 MNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKL 116 09/06 08:31:16.065 &lt;span class=&quot;error&quot;&gt;&amp;#91;&#160;&#160;&#160;&#160;&#160; main&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;com.allstate.drivewise.logging.test.CapacityTest:&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;000114 456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123 117 09/06 08:31:16.058 &lt;span class=&quot;error&quot;&gt;&amp;#91;&#160;&#160;&#160;&#160;&#160; main&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;com.allstate.drivewise.logging.test.CapacityTest:&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;000115 56789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 01234 118 09/06 08:31:16.058 &lt;span class=&quot;error&quot;&gt;&amp;#91;&#160;&#160;&#160;&#160;&#160; main&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;com.allstate.drivewise.logging.test.CapacityTest:&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;000246 PQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNO 119 09/06 08:31:16.065 &lt;span class=&quot;error&quot;&gt;&amp;#91;&#160;&#160;&#160;&#160;&#160; main&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;com.allstate.drivewise.logging.test.CapacityTest:&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;000116 6789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 012345 120 09/06 08:31:16.058 &lt;span class=&quot;error&quot;&gt;&amp;#91;&#160;&#160;&#160;&#160;&#160; main&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;com.allstate.drivewise.logging.test.CapacityTest:&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;000248 RSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQ 121 09/06 08:31:16.065 &lt;span class=&quot;error&quot;&gt;&amp;#91;&#160;&#160;&#160;&#160;&#160; main&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;com.allstate.drivewise.logging.test.CapacityTest:&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;000117 789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456 122 09/06 08:31:16.058 &lt;span class=&quot;error&quot;&gt;&amp;#91;&#160;&#160;&#160;&#160;&#160; main&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;com.allstate.drivewise.logging.test.CapacityTest:&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;000250 TUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ 0123456789ABCDEFGHIJKLMNOPQRS 123 09/06 08:31:16.065 &lt;span class=&quot;error&quot;&gt;&amp;#91;&#160;&#160;&#160;&#160;&#160; main&amp;#93;&lt;/span&gt; ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;com.allstate.drivewise.logging.test.CapacityTest:&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16158590" author="remkop@yahoo.com" created="Fri, 8 Sep 2017 13:01:05 +0000"  >&lt;p&gt;I think I know what is happening with the messages appearing out-of-order in the log file.&lt;/p&gt;

&lt;p&gt;The test uses an async appender. This appender has a queue, and a background thread that reads from the queue and writes to the file. Adding log events to that queue is very fast, but rendering these objects into bytes and writing data to the disk is slower. So at some point during the test the queue becomes full. (The async appender queue size is 128 by default, not very large...)&lt;/p&gt;


&lt;p&gt;When the async logging queue is full, Log4j2 needs to decide what to do with the current log event. There are several options:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Wait until space becomes available in the queue&lt;/li&gt;
	&lt;li&gt;Log the event synchronously (bypass the queue, go directly to the underlying appender)&lt;/li&gt;
	&lt;li&gt;Discard the log event&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Log4j2 currently uses option #2: log the event synchronously, bypassing the queue, and going directly to the underlying appender.&lt;/p&gt;

&lt;p&gt;The original behaviour was #1:&#160;to wait until space in the queue becomes available. However, there was a problem when an object performs logging from its &lt;tt&gt;toString&lt;/tt&gt; method when the queue was full (&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1518&quot; title=&quot;Deadlock when using pure async and toString logs another message&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1518&quot;&gt;&lt;del&gt;LOG4J2-1518&lt;/del&gt;&lt;/a&gt;). This could cause the application to deadlock... &lt;/p&gt;

&lt;p&gt;At the time, the best thing I could think of was to change the default behaviour from (#1) to (#2) and log the event synchronously when the queue is full. This is not great... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; The hope is that the queue is large enough to absorb bursts of events so users would rarely see out-of-order messages in the log. &lt;/p&gt;

&lt;p&gt;The performance test logs 180,000 messages, rapidly filling up the queue. Log4j then starts to write messages from the application thread directly to the appender. At the same time the background thread is writing older enqueued messages. This explains the out of order messages you are seeing.&lt;/p&gt;

&lt;p&gt;I have not been able to come up with a better solution yet.&lt;/p&gt;

&lt;p&gt;You have a number of options, each has its pros and cons:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Change the queue size to something large enough to handle bursts of events. This is a good idea anyway.&lt;/li&gt;
	&lt;li&gt;You can configure Log4j2&apos;s behaviour via system property &lt;tt&gt;log4j2.AsyncQueueFullPolicy&lt;/tt&gt;. See &lt;a href=&quot;https://logging.apache.org/log4j/2.0/log4j-core/apidocs/org/apache/logging/log4j/core/async/AsyncQueueFullPolicy.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;AsyncQueueFullPolicy&lt;/a&gt; and &lt;a href=&quot;https://logging.apache.org/log4j/2.0/log4j-core/apidocs/org/apache/logging/log4j/core/async/AsyncQueueFullPolicyFactory.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;AsyncQueueFullPolicyFactory&lt;/a&gt;. The &quot;Discard&quot; policy with some log level may be of interest.&lt;/li&gt;
	&lt;li&gt;If you are confident that your applications do not perform logging from their &lt;tt&gt;toString&lt;/tt&gt; method, so there is no risk of deadlock, you can create a custom &lt;tt&gt;AsyncQueueFullPolicy&lt;/tt&gt; that always return &lt;tt&gt;EventRoute.ENQUEUE&lt;/tt&gt;. This policy will block until space becomes available in the queue.&lt;/li&gt;
	&lt;li&gt;Some applications frequently experience long sustained bursts of log events. When the application logs at a sustained rate that is faster than the underlying appender, even a large queue will fill up during normal operation, and much of the logging takes place with a full queue. For such applications asynchronous logging is not the best choice, and synchronous logging may be more appropriate. Log4j2 should still give performance benefits with multi-threaded applications.&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="16160342" author="remkop@yahoo.com" created="Sun, 10 Sep 2017 13:42:03 +0000"  >&lt;p&gt;After thinking about this some more, I think it should be possible to prevent messages from appearing out of order in most cases.&lt;/p&gt;

&lt;p&gt;The reason Log4j2 logs directly to the appender, bypassing the async queue when the queue is full, is to prevent deadlock. &lt;/p&gt;

&lt;p&gt;However, when exactly is deadlock possible? Only when an application object is logged that itself invokes a logging call in its &lt;tt&gt;toString&lt;/tt&gt; method. If the logging call from the &lt;tt&gt;toString&lt;/tt&gt; method would block until it was able to add a new LogEvent to the queue, then the object that is being logged could never return from its &lt;tt&gt;toString&lt;/tt&gt; method, resulting in deadlock.&lt;/p&gt;

&lt;p&gt;For &quot;normal&quot; logging calls (not from a &lt;tt&gt;toString&lt;/tt&gt;) it is fine to block when the queue is full, because the background thread will eventually make a slot available.&lt;/p&gt;

&lt;p&gt;Currently the &lt;a href=&quot;https://logging.apache.org/log4j/2.0/log4j-core/apidocs/org/apache/logging/log4j/core/async/DefaultAsyncQueueFullPolicy.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DefaultAsyncQueueFullPolicy&lt;/a&gt; is very conservative and logs directly to the underlying appender for &lt;em&gt;all&lt;/em&gt; events when the queue is full. This can be improved by trying to rule out cases where deadlock could not occur, and in such cases, block until space in the queue becomes available. &lt;/p&gt;

&lt;p&gt;Ways to detect potential deadlock situations when the queue is full:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the logging thread is a background thread (of any of the Async Appenders, or a Disruptor) - this is the original solution for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-471&quot; title=&quot;toString methods that perform logging can deadlock AsyncLogger&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-471&quot;&gt;&lt;del&gt;LOG4J2-471&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;set a thread-local flag when logging is invoked (specifically, before calling &lt;tt&gt;Disruptor.tryPublish&lt;/tt&gt;). If the flag has already been set then deadlock is possible - this should cover &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1518&quot; title=&quot;Deadlock when using pure async and toString logs another message&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1518&quot;&gt;&lt;del&gt;LOG4J2-1518&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If deadlock is possible, the current behaviour (log directly to the underlying appender) is the safe thing to do. Perhaps a suffix should be appended to such log events to the effect that &quot;(Log4j2) This message appears out of order to prevent deadlock: logging inside the toString() method is not recommended.&quot;&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="16161631" author="colinarity" created="Mon, 11 Sep 2017 17:24:53 +0000"  >&lt;p&gt;Hi Remko,&lt;br/&gt;
Not sure if our are directing all these comments in my direction.&#160; I did little more testing with v2.8.2 and v2.9.0.&lt;/p&gt;

&lt;p&gt;I created a log4j2.component.properties containinglog4j2.AsyncQueueFullPolicy=com.allstate.drivewise.logger.log4j2.BlockingAsyncQueueFullPolicy&lt;br/&gt;
AsyncLoggerConfig.RingBufferSize=8096&lt;/p&gt;

&lt;p&gt;Also&lt;/p&gt;

&lt;p&gt;public class BlockingAsyncQueueFullPolicy implements AsyncQueueFullPolicy {&#160;&lt;br/&gt;
    @Override&#160;&lt;br/&gt;
    public EventRoute getRoute(long arg0, Level arg1) &lt;/p&gt;
{&#160;&#160;
        return EventRoute.ENQUEUE;&#160;
    }
&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;With the above config the test logging 180,000 entries the test is both fast and the ordering problem is fixed.&lt;/p&gt;

&lt;p&gt;Still this toString() deadlock issue is worrying. We use many many open source libraries.&#160;How could I guarantee none of them is logging in any of their toString functions.&lt;/p&gt;

&lt;p&gt;If I take the log4j2.AsyncQueueFullPolicy out then the ordering problems returns.&#160; Also the AsyncLoggerConfig.RingBufferSize appears have no affect. The unordered entries appear in the same place.&#160; I would have expected increasing the queue size to have a positive effect.&lt;/p&gt;

&lt;p&gt;I don&apos;t follow the information regarding handling the Background thread.&#160; Obviously I don&apos;t know the Log4j2 source code.&lt;/p&gt;</comment>
                            <comment id="16161643" author="colinarity" created="Mon, 11 Sep 2017 17:32:40 +0000"  >
&lt;p&gt;I looked up the Log4j2 documentation.  Appears to have a different description of AsyncQueueFullPolicy.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://logging.apache.org/log4j/2.x/manual/configuration.html#log4j2.AsyncQueueFullPolicy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://logging.apache.org/log4j/2.x/manual/configuration.html#log4j2.AsyncQueueFullPolicy&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Was there supposed to be a change in v2.9.0?  Testing that version didn&apos;t show any difference in ordering issue.&lt;/p&gt;</comment>
                            <comment id="16162158" author="remkop@yahoo.com" created="Mon, 11 Sep 2017 22:35:23 +0000"  >&lt;p&gt;Hi Colin, &lt;br/&gt;
The &lt;tt&gt;AsyncLoggerConfig.RingBufferSize&lt;/tt&gt; property doesn&apos;t apply: it is for when using &lt;a href=&quot;https://logging.apache.org/log4j/2.x/manual/async.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;async loggers&lt;/a&gt; (when  the configuration contains &lt;tt&gt;AsyncLogger&lt;/tt&gt; or &lt;tt&gt;AsyncRoot&lt;/tt&gt; instead of &lt;tt&gt;Logger&lt;/tt&gt; and &lt;tt&gt;Root&lt;/tt&gt;). &lt;/p&gt;

&lt;p&gt;Your test configuration uses a different way to be async:  &lt;tt&gt;AsyncAppender&lt;/tt&gt;. To control the queue size of this appender, specify attribute &lt;tt&gt;bufferSize=&quot;8096&quot;&lt;/tt&gt; on the &lt;a href=&quot;https://logging.apache.org/log4j/2.x/manual/appenders.html#AsyncAppender&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Async appender element in the configuration&lt;/a&gt;. &lt;br/&gt;
FYI, async loggers have a default queue size of 128 * 1024 slots. The default for AsyncAppender is tiny by comparison. Note to self: we should increase that. &lt;/p&gt;

&lt;p&gt;Thanks for verifying that the out of order messages are indeed caused by the AsyncQueueFullPolicy. Good point about external libraries.  I agree that configuring a custom policy that ENQUEUEs by default is not a realistic option. &lt;/p&gt;

&lt;p&gt;I&apos;m planning to do some work to fix this properly. (Some of my comments were also to get feedback on that from the Log4j2 community.)&lt;/p&gt;

&lt;p&gt;Until then, please use a large queue size that is able to absorb most bursts of events. &lt;/p&gt;</comment>
                            <comment id="16162169" author="remkop@yahoo.com" created="Mon, 11 Sep 2017 22:41:29 +0000"  >&lt;p&gt;Thanks for pointing out that the documentation on AsyncQueueFullPolicy doesn&apos;t fully cover what is happening. I&apos;ll update it when I have a chance. (No changes have been made in this area since 2.6.2 or 2.7 I believe.)&lt;/p&gt;</comment>
                            <comment id="16173196" author="jira-bot" created="Wed, 20 Sep 2017 13:48:37 +0000"  >&lt;p&gt;Commit b478b97ee724decc330f1425ba147aa40d39cbe8 in logging-log4j2&apos;s branch refs/heads/master from rpopma&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=b478b97&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=b478b97&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2031&quot; title=&quot;Messages appear out of order in log file (was: Log4j2 log file not reflecting application log function calls)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2031&quot;&gt;&lt;del&gt;LOG4J2-2031&lt;/del&gt;&lt;/a&gt; improve async queue full handling:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Only log out of order if recursive logging was detected and the queue was full: bypass the queue to avoid deadlock&lt;/li&gt;
	&lt;li&gt;Otherwise delegate to the AsyncQueueFullPolicy&lt;/li&gt;
	&lt;li&gt;DefaultAsyncQueueFullPolicy is ENQUEUE, unless log event came from background thread. This could cause deadlock, so we bypass the queue and log out of order directly to the appender again.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16173197" author="jira-bot" created="Wed, 20 Sep 2017 13:48:39 +0000"  >&lt;p&gt;Commit c81c118a2957cab9434ece771daef4cb8311ae63 in logging-log4j2&apos;s branch refs/heads/master from rpopma&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=c81c118&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=c81c118&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge branch &apos;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2031&quot; title=&quot;Messages appear out of order in log file (was: Log4j2 log file not reflecting application log function calls)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2031&quot;&gt;&lt;del&gt;LOG4J2-2031&lt;/del&gt;&lt;/a&gt;-improveQueueFull-handling&apos;&lt;/p&gt;</comment>
                            <comment id="16173212" author="jira-bot" created="Wed, 20 Sep 2017 14:00:13 +0000"  >&lt;p&gt;Commit cf163a995a1ceea805ff162dc20debf933094ea8 in logging-log4j2&apos;s branch refs/heads/master from rpopma&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=cf163a9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=cf163a9&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2031&quot; title=&quot;Messages appear out of order in log file (was: Log4j2 log file not reflecting application log function calls)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2031&quot;&gt;&lt;del&gt;LOG4J2-2031&lt;/del&gt;&lt;/a&gt; Update change log&lt;/p&gt;

&lt;p&gt;Until this change, messages appeared out of order in log file any time when the async logging queue was full. With this change, messages are only logged out of order to prevent deadlock when Log4j2 detects recursive logging while the queue is full.&lt;/p&gt;</comment>
                            <comment id="16173217" author="remkop@yahoo.com" created="Wed, 20 Sep 2017 14:03:04 +0000"  >&lt;p&gt;Fixed in master.&lt;br/&gt;
Please verify and close.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;With this change, you should no longer see out-of-order messages in the log file.&lt;/p&gt;

&lt;p&gt;When the async queue is full, Log4j2 will now by default block until a slot becomes available in the queue (unless recursive logging is detected).&lt;/p&gt;

&lt;p&gt;This will impact your performance test mentioned in the description of this ticket. I would suggest increasing the queue size to match the number of messages logged in the test, if you want to test async logging speed. With a smaller queue you are essentially measuring the speed of the underlying appender. &lt;/p&gt;

&lt;p&gt;If you want to discuss performance testing further, please raise a separate ticket or we can discuss on the log4j-user mailing list.&lt;/p&gt;</comment>
                            <comment id="16173350" author="jira-bot" created="Wed, 20 Sep 2017 15:33:18 +0000"  >&lt;p&gt;Commit 12650876fa6609d01a307a2f1b64999ec37331ec in logging-log4j2&apos;s branch refs/heads/master from rpopma&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=1265087&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=1265087&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2031&quot; title=&quot;Messages appear out of order in log file (was: Log4j2 log file not reflecting application log function calls)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2031&quot;&gt;&lt;del&gt;LOG4J2-2031&lt;/del&gt;&lt;/a&gt; javadoc fix&lt;/p&gt;</comment>
                            <comment id="16173351" author="jira-bot" created="Wed, 20 Sep 2017 15:33:21 +0000"  >&lt;p&gt;Commit 4410073823047fc0bc16ee7693a1efc1b32c264d in logging-log4j2&apos;s branch refs/heads/master from rpopma&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=4410073&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=4410073&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2031&quot; title=&quot;Messages appear out of order in log file (was: Log4j2 log file not reflecting application log function calls)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2031&quot;&gt;&lt;del&gt;LOG4J2-2031&lt;/del&gt;&lt;/a&gt; refactor to get remaining queue capacity for AsyncAppender as well as Async Loggers&lt;/p&gt;</comment>
                            <comment id="16173352" author="jira-bot" created="Wed, 20 Sep 2017 15:33:23 +0000"  >&lt;p&gt;Commit 3f5d58cd32ad96ccb4a644fc32be11ffca0e5922 in logging-log4j2&apos;s branch refs/heads/master from rpopma&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=3f5d58c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=3f5d58c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2031&quot; title=&quot;Messages appear out of order in log file (was: Log4j2 log file not reflecting application log function calls)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2031&quot;&gt;&lt;del&gt;LOG4J2-2031&lt;/del&gt;&lt;/a&gt; added tests&lt;/p&gt;</comment>
                            <comment id="16187779" author="colinarity" created="Mon, 2 Oct 2017 08:59:08 +0000"  >&lt;p&gt;Hi Remko,&lt;br/&gt;
Appreciate the fix &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Is there an expected date for the release of v2.10?&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Colin&lt;/p&gt;</comment>
                            <comment id="16356555" author="scottsue" created="Thu, 8 Feb 2018 06:57:20 +0000"  >&lt;p&gt;Hi all,&lt;/p&gt;

&lt;p&gt;Sorry to resurrect an old Jira but this is the most appropriate place to comment on this.&#160; I&apos;ve been looking into this as well and my opinion is that blocking the application due to the ring buffer being full is dangerous.&#160; We log our message our to the KafkaAppender so we are at the mercy of the network.&#160; If we have sustained logging there can be a chance that the ringbuffer is full.&#160; Once full as per the change above, we will block.&#160; Logging&#160;in my opinion is very important, however it should not block the application from running.&lt;/p&gt;

&lt;p&gt;I think your suggestion is good regarding marking out of order messages in the logs so it at least gives the logs reader a chance to determine that a given message is out of order.&lt;/p&gt;

&lt;p&gt;Another potential solution (not sure if it is feasible, or a good idea) would be to have a hybrid of a Queue and ringbuffer? So if the ringbuffer is full it will write the message into the Queue instead (therefore bound by memory).&#160; Once the ringbuffer empties, we can also start draining the Queue to maintain log order?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12685928">LOG4J2-471</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13115612">LOG4J2-2095</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13101565">LOG4J2-2048</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12997219">LOG4J2-1518</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12885362" name="CapacityTest.java" size="3477" author="colinarity" created="Tue, 5 Sep 2017 10:53:30 +0000"/>
                            <attachment id="12885361" name="log4j2.xml" size="1161" author="colinarity" created="Tue, 5 Sep 2017 10:54:08 +0000"/>
                            <attachment id="12885360" name="pom2.xml" size="3736" author="colinarity" created="Tue, 5 Sep 2017 11:02:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3jne7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>