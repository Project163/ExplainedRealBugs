<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:41:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-2981] OnStartupTriggeringPolicy only rolls over when minsize = 0 with DirectWriteTriggeringPolicy</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-2981</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;I am trying to use a &lt;tt&gt;RollingFileAppender&lt;/tt&gt; with a &lt;tt&gt;CompositeTriggeringPolicy&lt;/tt&gt; that includes a &lt;tt&gt;OnStartupTriggeringPolicy&lt;/tt&gt; which is deemed to rollover the log when the JVM is (re-)started.&lt;/p&gt;

&lt;p&gt;However, I have noted that the files only roll over on startup when I specify &quot;minsize = 0&quot; on the log4j2.xml configuration file. If I put any other value or leave the minsize unspecified (i.e. rely on its default value minsize = 1), the appender proceeds writing to the previously existing file. &lt;/p&gt;

&lt;p&gt;I have run the debugger and traced down the bug according as follows.&lt;/p&gt;

&lt;p&gt;All the logic in &lt;tt&gt;OnStartupTriggeringPolicy.initialize()&lt;/tt&gt; is conditioned upon the size of the rolling file being larger than &lt;tt&gt;minSize&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void initialize(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; RollingFileManager manager) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (manager.getFileTime() &amp;lt; JVM_START_TIME &amp;amp;&amp;amp; manager.getFileSize() &amp;gt;= minSize) {
           ...
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, &lt;tt&gt;manager.getFileSize()&lt;/tt&gt; always returns 0, thus the body of that if is never entered (... unless &lt;tt&gt;minSize == 0&lt;/tt&gt;). In fact, this call to &lt;tt&gt;OnStartupTriggeringPolicy.initialize()&lt;/tt&gt; is invoked indeed from &lt;tt&gt;RollingFileManager.initialize()&lt;/tt&gt; &lt;b&gt;before&lt;/b&gt; any value has been assigned to &lt;tt&gt;size&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void initialize() {

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!initialized) {
            LOGGER.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Initializing triggering policy {}&quot;&lt;/span&gt;, triggeringPolicy);
            initialized = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
            triggeringPolicy.initialize(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (triggeringPolicy &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; LifeCycle) {
                ((LifeCycle) triggeringPolicy).start();
            }
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (directWrite) {
                &lt;span class=&quot;code-comment&quot;&gt;// LOG4J2-2485: Initialize size from the most recently written file.
&lt;/span&gt;                File file = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(getFileName());
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (file.exists()) {
                    size = file.length();
                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                    ((DirectFileRolloverStrategy) rolloverStrategy).clearCurrentFileName();
                }
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thus, within &lt;tt&gt;OnStartupTriggeringPolicy.initialize()&lt;/tt&gt;, &lt;tt&gt;manager.getFileSize()&lt;/tt&gt; always evaluates to &lt;tt&gt;0&lt;/tt&gt;, and the only way that the file is rolled over at startup is that &lt;tt&gt;minSize&lt;/tt&gt; has been configured as &lt;tt&gt;0&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;As a side consequence, this may also affect SizeBaseTriggerinPolicy if a rollover is needed by coincidence during startup.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13347949">LOG4J2-2981</key>
            <summary>OnStartupTriggeringPolicy only rolls over when minsize = 0 with DirectWriteTriggeringPolicy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rgoers">Ralph Goers</assignee>
                                    <reporter username="samuelm">Samuel Martin</reporter>
                        <labels>
                            <label>Policy</label>
                            <label>RollingFileAppender</label>
                    </labels>
                <created>Sat, 26 Dec 2020 14:00:31 +0000</created>
                <updated>Wed, 3 Mar 2021 04:24:24 +0000</updated>
                            <resolved>Wed, 3 Mar 2021 04:24:24 +0000</resolved>
                                    <version>2.14.0</version>
                                    <fixVersion>2.14.1</fixVersion>
                                    <component>Appenders</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17292346" author="ralph.goers@dslextreme.com" created="Sun, 28 Feb 2021 08:41:22 +0000"  >&lt;p&gt;SizeBasedTriggeringPolicy would not be vulnerable to this as it doesn&apos;t check the file size in its initialize method, only in isTriggeringEvent().&#160;&lt;/p&gt;

&lt;p&gt;I will have to try moving the triggeringPolicy initialization to after the directWrite check and see if that resolves the issue.&lt;/p&gt;</comment>
                            <comment id="17292541" author="ralph.goers@dslextreme.com" created="Sun, 28 Feb 2021 23:01:26 +0000"  >&lt;p&gt;After running the existing unit test I am realizing your analysis isn&apos;t exactly correct. It seems that RollingFileManager.getFileManager() is called from RollingFileAppender before anything is initialized. the getManager() method calls the static getManager method in OutputStreamManager which delegates to AbstractManager&apos;s getManager method (this is standard practice in all the Appender Managers).&#160; It then calls RollingFileManager&apos;s createManager method.&lt;/p&gt;

&lt;p&gt;The createManager method checks if the configuration included a fileName. If it does and the append attribute is true then it sets size to the file&apos;s size. Otherwise the size ends up zero here. This makes sense because if append is false you are indicating that you want to overwrite the file and if no filename attribute is provided the name of the file isn&apos;t known yet.&lt;/p&gt;

&lt;p&gt;So to encounter the case you are observing you must either be using the DirectWriteRolloverStrategy or have set append to false. I wouldn&apos;t consider it to be a bug if append is false since that directly conflicts with the idea of rolling on startup. So that only leaves the DirectWrite case and I must assume that is how you have your appender configured.&#160;&lt;/p&gt;



&lt;p&gt;I have created a test that confirms the problem when direct write is used and modified the code so that test now passes.&lt;/p&gt;</comment>
                            <comment id="17292576" author="jira-bot" created="Mon, 1 Mar 2021 03:22:06 +0000"  >&lt;p&gt;Commit a0f8f0df6c275f86037a8699710e366b84b91da4 in logging-log4j2&apos;s branch refs/heads/release-2.x from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=a0f8f0d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=a0f8f0d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2981&quot; title=&quot;OnStartupTriggeringPolicy only rolls over when minsize = 0 with DirectWriteTriggeringPolicy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2981&quot;&gt;&lt;del&gt;LOG4J2-2981&lt;/del&gt;&lt;/a&gt; - OnStartupTriggeringPolicy would fail to cause the file to roll over with DirectWriteTriggeringPolicy unless minSize was set to 0&lt;/p&gt;</comment>
                            <comment id="17292589" author="jira-bot" created="Mon, 1 Mar 2021 03:52:35 +0000"  >&lt;p&gt;Commit b137f443872c07336080f6d6b41b03a5ed915f26 in logging-log4j2&apos;s branch refs/heads/master from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=b137f44&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=b137f44&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2981&quot; title=&quot;OnStartupTriggeringPolicy only rolls over when minsize = 0 with DirectWriteTriggeringPolicy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2981&quot;&gt;&lt;del&gt;LOG4J2-2981&lt;/del&gt;&lt;/a&gt; - OnStartupTriggeringPolicy would fail to cause the file to roll over with DirectWriteTriggeringPolicy unless minSize was set to 0&lt;/p&gt;</comment>
                            <comment id="17294268" author="ralph.goers@dslextreme.com" created="Wed, 3 Mar 2021 04:24:24 +0000"  >&lt;p&gt;Patch applied. Please verify and close.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13335343">LOG4J2-2946</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0lueo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>