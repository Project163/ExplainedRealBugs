<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:40:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-2606] Asynchronous logging when the queue is full results heavy CPU load</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-2606</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;I&apos;ve encountered unexpected performance characteristics when the asynchronous logging queue is full, resulting in the application becoming unavailable for an extended period of time.&lt;/p&gt;

&lt;p&gt;I think EventRoute.ENQUEUE is using a spin lock (or similar construct). When many threads attempt to log at a higher rate than we can drain the queue, logging throughput drops significantly while CPU utilization skyrockets causing instability across the system.&lt;/p&gt;

&lt;p&gt;I can reproduce this in a benchmark (I will clean it up and push when I have a moment) where I get the following results:&lt;/p&gt;

&lt;p&gt;Setup:&lt;br/&gt;
 Root logger has a random access file appender with immediateFlush disabled&lt;/p&gt;

&lt;p&gt;AsyncLoggerContextSelector enabled for completely asynchronous logging&lt;/p&gt;

&lt;p&gt;1 thread logging, any queue full policy: ~1,400k events/second, 150% CPU&lt;/p&gt;

&lt;p&gt;32 threads logging, default policy (EventRoute.ENQUEUE, default policy): 300k-400k events/second. 930% CPU load&lt;/p&gt;

&lt;p&gt;32 threads logging, custom policy using EventRoute.SYNCHRONOUS: 1,200k events/second. 350% CPU load&lt;/p&gt;

&lt;p&gt;Using the synchronous policy results in ~1/3 the CPU load and 3-4x throughput when the system is loaded to the point that the logging queue is filled.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13234019">LOG4J2-2606</key>
            <summary>Asynchronous logging when the queue is full results heavy CPU load</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ckozak">Carter Kozak</assignee>
                                    <reporter username="ckozak">Carter Kozak</reporter>
                        <labels>
                    </labels>
                <created>Fri, 17 May 2019 18:05:15 +0000</created>
                <updated>Tue, 18 Jun 2019 01:28:28 +0000</updated>
                            <resolved>Tue, 18 Jun 2019 01:28:24 +0000</resolved>
                                    <version>2.11.2</version>
                                    <fixVersion>2.12.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="13200">3h 40m</timespent>
                                <comments>
                            <comment id="16842659" author="remkop@yahoo.com" created="Fri, 17 May 2019 22:12:45 +0000"  >&lt;p&gt;&lt;tt&gt;EventRoute.SYNCHRONOUS&lt;/tt&gt; means the queued events are bypassed when the queue is full and the log file will show &quot;jumbled&quot; logs where log messages appear out of order. This used to be our default but nobody was happy was this. (It&apos;s a nightmare to try to make sense of an out-of-order log file.) I would not recommend making this the default.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;EventRoute.ENQUEUE&lt;/tt&gt; calls &lt;tt&gt;disruptor.getRingBuffer().publishEvent(...)&lt;/tt&gt;.  The wait strategy used by publishEvent is &lt;a href=&quot;https://github.com/apache/logging-log4j2/blob/master/log4j-core/src/main/java/org/apache/logging/log4j/core/async/DisruptorUtil.java#L56&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;determined by system properties&lt;/a&gt;. The default used by Log4j is &lt;tt&gt;TimeoutBlockingWaitStrategy&lt;/tt&gt; with 10 millis timeout.&lt;/p&gt;

&lt;p&gt;Why don&apos;t we &lt;a href=&quot;https://github.com/LMAX-Exchange/disruptor/issues&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;raise&lt;/a&gt; this with the Disruptor maintainer? Perhaps they have had reports of issues with &lt;tt&gt;TimeoutBlockingWaitStrategy&lt;/tt&gt; and can give us advice. If we can create steps to reproduce this, even better. &lt;/p&gt;

&lt;p&gt;There are other wait strategies. For example, the disruptor has a &lt;a href=&quot;https://lmax-exchange.github.io/disruptor/docs/com/lmax/disruptor/PhasedBackoffWaitStrategy.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;back-off strategy&lt;/a&gt; with some limited number of spin-retries, then some limited number of yield-retries, and finally some other fallback. But let&apos;s hear from the Disruptor maintainers first.&lt;/p&gt;</comment>
                            <comment id="16843171" author="ckozak" created="Sat, 18 May 2019 13:36:02 +0000"  >&lt;p&gt;Thanks for the context, I had not realized synchronous was the old default. I will put together a reproducer and file an upstream ticket this weekend or early next week.&lt;/p&gt;</comment>
                            <comment id="16843181" author="garydgregory" created="Sat, 18 May 2019 15:03:03 +0000"  >&lt;p&gt;I think current versions of the disruptor require Java 8. &lt;/p&gt;

&lt;p&gt;How long do we want to support Java 7?&lt;/p&gt;</comment>
                            <comment id="16843194" author="ralph.goers@dslextreme.com" created="Sat, 18 May 2019 15:57:26 +0000"  >&lt;p&gt;Until we stop releasing 2.x releases. We already decided 3.x requires Java 8. We need to make more progress on getting that out.&lt;/p&gt;</comment>
                            <comment id="16844053" author="ckozak" created="Mon, 20 May 2019 15:41:02 +0000"  >&lt;p&gt;Filed an issue here: &lt;a href=&quot;https://github.com/LMAX-Exchange/disruptor/issues/266&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/LMAX-Exchange/disruptor/issues/266&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16844191" author="ckozak" created="Mon, 20 May 2019 18:26:48 +0000"  >&lt;p&gt;I&apos;ve added benchmarks in this set of changes: &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/269&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16844432" author="remkop@yahoo.com" created="Tue, 21 May 2019 01:27:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ckozak&quot; class=&quot;user-hover&quot; rel=&quot;ckozak&quot;&gt;ckozak&lt;/a&gt;, thanks for raising the ticket with the Disruptor maintainers, and thanks for providing a benchmark to allow the Disruptor maintainers to reproduce the issue. (I guess they would just check out the &lt;a href=&quot;https://github.com/carterkozak/logging-log4j2/tree/LOG4J2-2609&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;carterkozak:LOG4J2-2609&lt;/a&gt; branch and build that to get access to the benchmark, right?)&lt;/p&gt;

&lt;p&gt;If you can think of any more information that may help the Disruptor maintainers, let&apos;s add it to &lt;a href=&quot;https://github.com/LMAX-Exchange/disruptor/issues/266&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/LMAX-Exchange/disruptor/issues/266&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16844461" author="ckozak" created="Tue, 21 May 2019 03:08:52 +0000"  >&lt;p&gt;That is correct, the benchmark illustrates the scenario I encountered in production. I&apos;ve updated the disruptor issue with additional context. Apologies for the delay, it&apos;s a busy week &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16845243" author="jira-bot" created="Tue, 21 May 2019 20:43:56 +0000"  >&lt;p&gt;Commit 15aadc24773bdf2b2b537899594d513d3eb48e2c in logging-log4j2&apos;s branch refs/heads/master from Carter Kozak&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=15aadc2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=15aadc2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Implement benchmarks for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2606&quot; title=&quot;Asynchronous logging when the queue is full results heavy CPU load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2606&quot;&gt;&lt;del&gt;LOG4J2-2606&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Preliminiary results:&lt;/p&gt;

&lt;p&gt;Benchmark                                                      (queueFullPolicy)   Mode  Cnt        Score         Error  Units&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads            ENQUEUE  thrpt    3   369559.791 &#177; 1307230.236  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads        SYNCHRONOUS  thrpt    3  1059713.811 &#177; 1910806.587  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread                 ENQUEUE  thrpt    3  1451843.607 &#177;  355606.050  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread             SYNCHRONOUS  thrpt    3  1393328.851 &#177;  589759.385  ops/s&lt;/p&gt;</comment>
                            <comment id="16845245" author="jira-bot" created="Tue, 21 May 2019 20:44:31 +0000"  >&lt;p&gt;Commit d2ffe1c15fae87cfb86bfea04b8c87c200298943 in logging-log4j2&apos;s branch refs/heads/release-2.x from Carter Kozak&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=d2ffe1c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=d2ffe1c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Implement benchmarks for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2606&quot; title=&quot;Asynchronous logging when the queue is full results heavy CPU load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2606&quot;&gt;&lt;del&gt;LOG4J2-2606&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Preliminiary results:&lt;/p&gt;

&lt;p&gt;Benchmark                                                      (queueFullPolicy)   Mode  Cnt        Score         Error  Units&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads            ENQUEUE  thrpt    3   369559.791 &#177; 1307230.236  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads        SYNCHRONOUS  thrpt    3  1059713.811 &#177; 1910806.587  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread                 ENQUEUE  thrpt    3  1451843.607 &#177;  355606.050  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread             SYNCHRONOUS  thrpt    3  1393328.851 &#177;  589759.385  ops/s&lt;/p&gt;</comment>
                            <comment id="16846229" author="jira-bot" created="Wed, 22 May 2019 21:02:31 +0000"  >&lt;p&gt;Commit 42dc53d90f2dc2c8de6061056be17d7991efd94e in logging-log4j2&apos;s branch refs/heads/&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2606&quot; title=&quot;Asynchronous logging when the queue is full results heavy CPU load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2606&quot;&gt;&lt;del&gt;LOG4J2-2606&lt;/del&gt;&lt;/a&gt; from Carter Kozak&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=42dc53d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=42dc53d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2606&quot; title=&quot;Asynchronous logging when the queue is full results heavy CPU load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2606&quot;&gt;&lt;del&gt;LOG4J2-2606&lt;/del&gt;&lt;/a&gt;: Substantially improve async logging performance under heavy load&lt;/p&gt;

&lt;p&gt;This change applies synchronization to AsyncLoggerDisruptor blocking enqueue&lt;br/&gt;
operations when the asynchronous logging queue is completely full.&lt;br/&gt;
This new behavior may be disabled using the boolean property&lt;br/&gt;
`AsyncLogger.SynchronizeEnqueueWhenQueueFull` (default true).&lt;/p&gt;

&lt;p&gt;Alternatives tested:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;All available lmax disruptor `WaitStrategy` implementations.&lt;br/&gt;
  None of the available implementations provided a substantial&lt;br/&gt;
  difference in throughput or CPU utilization. In all cases&lt;br/&gt;
  my processor was stuck at or near 100% across all six cores.&lt;/li&gt;
	&lt;li&gt;Based on feedback from &lt;a href=&quot;https://github.com/LMAX-Exchange/disruptor/issues/266&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/LMAX-Exchange/disruptor/issues/266&lt;/a&gt;&lt;br/&gt;
  I attempted avoiding the blocking enqueue entirely in favor of&lt;br/&gt;
  `LockSupport.parkNanos` with values ranging from 1,000 through&lt;br/&gt;
  1,000,000. 1,000,000 provided the most throughput among parkNanos&lt;br/&gt;
  values tested, but is too long for most scenarios.&lt;/li&gt;
	&lt;li&gt;Semaphore instead of synchronized. Testing with permits&lt;br/&gt;
  equivalent to the available processor count yielded higher&lt;br/&gt;
  CPU utilization and lower throughput than a semaphore&lt;br/&gt;
  with a single permit. Given that most work occurs on&lt;br/&gt;
  the (single) background thread, there&apos;s not much reason&lt;br/&gt;
  to allow multiple enqueues simultaneously.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Updated benchmarks adding &quot;ENQUEUE_UNSYNCHRONIZED&quot; following&lt;br/&gt;
the old unsynchronized path, where &quot;ENQUEUE&quot; shows an improvement:&lt;/p&gt;

&lt;p&gt;Benchmark                                                           (queueFullPolicy)   Mode  Cnt        Score         Error  Units&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads                 ENQUEUE  thrpt    3  1146649.538 &#177;  103899.750  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads  ENQUEUE_UNSYNCHRONIZED  thrpt    3   422244.124 &#177;  785429.301  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads             SYNCHRONOUS  thrpt    3  1084417.832 &#177;  354547.695  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread                      ENQUEUE  thrpt    3  1250748.284 &#177; 1202507.746  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread       ENQUEUE_UNSYNCHRONIZED  thrpt    3  1280794.688 &#177;  832379.969  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread                  SYNCHRONOUS  thrpt    3  1227202.214 &#177; 1398451.960  ops/s&lt;/p&gt;</comment>
                            <comment id="16866115" author="jira-bot" created="Tue, 18 Jun 2019 01:25:51 +0000"  >&lt;p&gt;Commit e3937fec5880b5f6b3d3173c819d47a1c1ad2c86 in logging-log4j2&apos;s branch refs/heads/release-2.x from Carter Kozak&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=e3937fe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=e3937fe&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2606&quot; title=&quot;Asynchronous logging when the queue is full results heavy CPU load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2606&quot;&gt;&lt;del&gt;LOG4J2-2606&lt;/del&gt;&lt;/a&gt;: Substantially improve async logging performance under heavy load&lt;/p&gt;

&lt;p&gt;This change applies synchronization to AsyncLoggerDisruptor blocking enqueue&lt;br/&gt;
operations when the asynchronous logging queue is completely full.&lt;br/&gt;
This new behavior may be disabled using the boolean property&lt;br/&gt;
`AsyncLogger.SynchronizeEnqueueWhenQueueFull` (default true).&lt;/p&gt;

&lt;p&gt;Alternatives tested:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;All available lmax disruptor `WaitStrategy` implementations.&lt;br/&gt;
  None of the available implementations provided a substantial&lt;br/&gt;
  difference in throughput or CPU utilization. In all cases&lt;br/&gt;
  my processor was stuck at or near 100% across all six cores.&lt;/li&gt;
	&lt;li&gt;Based on feedback from &lt;a href=&quot;https://github.com/LMAX-Exchange/disruptor/issues/266&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/LMAX-Exchange/disruptor/issues/266&lt;/a&gt;&lt;br/&gt;
  I attempted avoiding the blocking enqueue entirely in favor of&lt;br/&gt;
  `LockSupport.parkNanos` with values ranging from 1,000 through&lt;br/&gt;
  1,000,000. 1,000,000 provided the most throughput among parkNanos&lt;br/&gt;
  values tested, but is too long for most scenarios.&lt;/li&gt;
	&lt;li&gt;Semaphore instead of synchronized. Testing with permits&lt;br/&gt;
  equivalent to the available processor count yielded higher&lt;br/&gt;
  CPU utilization and lower throughput than a semaphore&lt;br/&gt;
  with a single permit. Given that most work occurs on&lt;br/&gt;
  the (single) background thread, there&apos;s not much reason&lt;br/&gt;
  to allow multiple enqueues simultaneously.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Updated benchmarks adding &quot;ENQUEUE_UNSYNCHRONIZED&quot; following&lt;br/&gt;
the old unsynchronized path, where &quot;ENQUEUE&quot; shows an improvement:&lt;/p&gt;

&lt;p&gt;Benchmark                                                      (asyncLoggerType)       (queueFullPolicy)   Mode  Cnt        Score         Error  Units&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads      ASYNC_CONTEXT                 ENQUEUE  thrpt    3  1258165.831 &#177;  667148.832  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads      ASYNC_CONTEXT  ENQUEUE_UNSYNCHRONIZED  thrpt    3   454371.810 &#177;  409868.594  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads      ASYNC_CONTEXT             SYNCHRONOUS  thrpt    3  1053495.203 &#177;  636177.787  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads       ASYNC_CONFIG                 ENQUEUE  thrpt    3  1276622.582 &#177;  127625.711  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads       ASYNC_CONFIG  ENQUEUE_UNSYNCHRONIZED  thrpt    3   611023.061 &#177;  993497.457  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads       ASYNC_CONFIG             SYNCHRONOUS  thrpt    3  1174098.357 &#177;  379968.531  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread           ASYNC_CONTEXT                 ENQUEUE  thrpt    3  1397715.099 &#177;  292151.880  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread           ASYNC_CONTEXT  ENQUEUE_UNSYNCHRONIZED  thrpt    3  1351109.640 &#177; 1013899.613  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread           ASYNC_CONTEXT             SYNCHRONOUS  thrpt    3  1265741.941 &#177; 1020413.924  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread            ASYNC_CONFIG                 ENQUEUE  thrpt    3  1501815.413 &#177;  375077.112  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread            ASYNC_CONFIG  ENQUEUE_UNSYNCHRONIZED  thrpt    3  1516153.045 &#177;  874311.252  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread            ASYNC_CONFIG             SYNCHRONOUS  thrpt    3  1493252.704 &#177;  947903.342  ops/s&lt;/p&gt;</comment>
                            <comment id="16866116" author="jira-bot" created="Tue, 18 Jun 2019 01:25:52 +0000"  >&lt;p&gt;Commit 7908b79560c2ce9b115ca9ed6a7bfd3d311a6159 in logging-log4j2&apos;s branch refs/heads/release-2.x from Carter Kozak&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=7908b79&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=7908b79&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2606&quot; title=&quot;Asynchronous logging when the queue is full results heavy CPU load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2606&quot;&gt;&lt;del&gt;LOG4J2-2606&lt;/del&gt;&lt;/a&gt; documentation&lt;/p&gt;</comment>
                            <comment id="16866118" author="jira-bot" created="Tue, 18 Jun 2019 01:28:20 +0000"  >&lt;p&gt;Commit 72e777708b50b5cf6240f70eafcc4b08797a0047 in logging-log4j2&apos;s branch refs/heads/master from Carter Kozak&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=72e7777&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=72e7777&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2606&quot; title=&quot;Asynchronous logging when the queue is full results heavy CPU load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2606&quot;&gt;&lt;del&gt;LOG4J2-2606&lt;/del&gt;&lt;/a&gt;: Substantially improve async logging performance under heavy load&lt;/p&gt;

&lt;p&gt;This change applies synchronization to AsyncLoggerDisruptor blocking enqueue&lt;br/&gt;
operations when the asynchronous logging queue is completely full.&lt;br/&gt;
This new behavior may be disabled using the boolean property&lt;br/&gt;
`AsyncLogger.SynchronizeEnqueueWhenQueueFull` (default true).&lt;/p&gt;

&lt;p&gt;Alternatives tested:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;All available lmax disruptor `WaitStrategy` implementations.&lt;br/&gt;
  None of the available implementations provided a substantial&lt;br/&gt;
  difference in throughput or CPU utilization. In all cases&lt;br/&gt;
  my processor was stuck at or near 100% across all six cores.&lt;/li&gt;
	&lt;li&gt;Based on feedback from &lt;a href=&quot;https://github.com/LMAX-Exchange/disruptor/issues/266&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/LMAX-Exchange/disruptor/issues/266&lt;/a&gt;&lt;br/&gt;
  I attempted avoiding the blocking enqueue entirely in favor of&lt;br/&gt;
  `LockSupport.parkNanos` with values ranging from 1,000 through&lt;br/&gt;
  1,000,000. 1,000,000 provided the most throughput among parkNanos&lt;br/&gt;
  values tested, but is too long for most scenarios.&lt;/li&gt;
	&lt;li&gt;Semaphore instead of synchronized. Testing with permits&lt;br/&gt;
  equivalent to the available processor count yielded higher&lt;br/&gt;
  CPU utilization and lower throughput than a semaphore&lt;br/&gt;
  with a single permit. Given that most work occurs on&lt;br/&gt;
  the (single) background thread, there&apos;s not much reason&lt;br/&gt;
  to allow multiple enqueues simultaneously.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Updated benchmarks adding &quot;ENQUEUE_UNSYNCHRONIZED&quot; following&lt;br/&gt;
the old unsynchronized path, where &quot;ENQUEUE&quot; shows an improvement:&lt;/p&gt;

&lt;p&gt;Benchmark                                                      (asyncLoggerType)       (queueFullPolicy)   Mode  Cnt        Score         Error  Units&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads      ASYNC_CONTEXT                 ENQUEUE  thrpt    3  1258165.831 &#177;  667148.832  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads      ASYNC_CONTEXT  ENQUEUE_UNSYNCHRONIZED  thrpt    3   454371.810 &#177;  409868.594  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads      ASYNC_CONTEXT             SYNCHRONOUS  thrpt    3  1053495.203 &#177;  636177.787  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads       ASYNC_CONFIG                 ENQUEUE  thrpt    3  1276622.582 &#177;  127625.711  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads       ASYNC_CONFIG  ENQUEUE_UNSYNCHRONIZED  thrpt    3   611023.061 &#177;  993497.457  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.concurrentLoggingThreads       ASYNC_CONFIG             SYNCHRONOUS  thrpt    3  1174098.357 &#177;  379968.531  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread           ASYNC_CONTEXT                 ENQUEUE  thrpt    3  1397715.099 &#177;  292151.880  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread           ASYNC_CONTEXT  ENQUEUE_UNSYNCHRONIZED  thrpt    3  1351109.640 &#177; 1013899.613  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread           ASYNC_CONTEXT             SYNCHRONOUS  thrpt    3  1265741.941 &#177; 1020413.924  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread            ASYNC_CONFIG                 ENQUEUE  thrpt    3  1501815.413 &#177;  375077.112  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread            ASYNC_CONFIG  ENQUEUE_UNSYNCHRONIZED  thrpt    3  1516153.045 &#177;  874311.252  ops/s&lt;br/&gt;
ConcurrentAsyncLoggerToFileBenchmark.singleLoggingThread            ASYNC_CONFIG             SYNCHRONOUS  thrpt    3  1493252.704 &#177;  947903.342  ops/s&lt;/p&gt;</comment>
                            <comment id="16866119" author="jira-bot" created="Tue, 18 Jun 2019 01:28:22 +0000"  >&lt;p&gt;Commit 658faf46bbbf725c183a11a52b9a7be739a2acd4 in logging-log4j2&apos;s branch refs/heads/master from Carter Kozak&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=658faf4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=658faf4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2606&quot; title=&quot;Asynchronous logging when the queue is full results heavy CPU load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2606&quot;&gt;&lt;del&gt;LOG4J2-2606&lt;/del&gt;&lt;/a&gt; documentation&lt;/p&gt;</comment>
                            <comment id="16866120" author="jira-bot" created="Tue, 18 Jun 2019 01:28:23 +0000"  >&lt;p&gt;Commit e5190d87f1ccdcbe66a28c67e0da3c3eefeb1d46 in logging-log4j2&apos;s branch refs/heads/master from Carter Kozak&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=e5190d8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=e5190d8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge pull request #273 from carterkozak/&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2606&quot; title=&quot;Asynchronous logging when the queue is full results heavy CPU load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2606&quot;&gt;&lt;del&gt;LOG4J2-2606&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2606&quot; title=&quot;Asynchronous logging when the queue is full results heavy CPU load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2606&quot;&gt;&lt;del&gt;LOG4J2-2606&lt;/del&gt;&lt;/a&gt;: Substantially improve async logging performance under heavy load&lt;/p&gt;</comment>
                            <comment id="16866121" author="jira-bot" created="Tue, 18 Jun 2019 01:28:24 +0000"  >&lt;p&gt;Commit e5190d87f1ccdcbe66a28c67e0da3c3eefeb1d46 in logging-log4j2&apos;s branch refs/heads/master from Carter Kozak&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=e5190d8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=e5190d8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge pull request #273 from carterkozak/&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2606&quot; title=&quot;Asynchronous logging when the queue is full results heavy CPU load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2606&quot;&gt;&lt;del&gt;LOG4J2-2606&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2606&quot; title=&quot;Asynchronous logging when the queue is full results heavy CPU load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2606&quot;&gt;&lt;del&gt;LOG4J2-2606&lt;/del&gt;&lt;/a&gt;: Substantially improve async logging performance under heavy load&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 22 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z02t2w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>