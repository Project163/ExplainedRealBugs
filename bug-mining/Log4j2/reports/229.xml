<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:32:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-479] Use of InheritableThreadLocal in Map ThreadContext is dangerous and unhelpful</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-479</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;Described here &lt;a href=&quot;http://logging.apache.org/log4j/2.x/manual/thread-context.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://logging.apache.org/log4j/2.x/manual/thread-context.html&lt;/a&gt;&lt;br/&gt;
The use of InheritableThreadLocal creates subtle and hard to track bugs while not really adding much useful.  It is counterintuitive &amp;#8211; I don&apos;t see why would anyone expect logging context to be inherited.  But it breaks down completely when used with Thread Executors.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12686584">LOG4J2-479</key>
            <summary>Use of InheritableThreadLocal in Map ThreadContext is dangerous and unhelpful</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="meshko">MK</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 Dec 2013 23:34:07 +0000</created>
                <updated>Tue, 1 Jul 2014 15:27:07 +0000</updated>
                            <resolved>Sun, 12 Jan 2014 16:19:26 +0000</resolved>
                                                    <fixVersion>2.0-rc1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13857920" author="remkop@yahoo.com" created="Sat, 28 Dec 2013 02:44:21 +0000"  >&lt;p&gt;Could you elaborate on what problems you think can happen with the current implementation,  and when these problems may occur (what may trigger them)?&lt;br/&gt;
Also, do you propose a solution? If so, can you provide more detail?&lt;/p&gt;</comment>
                            <comment id="13857923" author="meshko" created="Sat, 28 Dec 2013 02:58:03 +0000"  >&lt;p&gt;Here&apos;s the scenario that I ran into:&lt;br/&gt;
I am decorating all web request handlers with some log4j context map values using AOP&lt;br/&gt;
Some of the requests kick off long-running jobs which are executed by a thread pool (ThreadExecutor)&lt;br/&gt;
ThreadExecutor will kick of threads as needed&lt;br/&gt;
So: &lt;br/&gt;
user1 logs in, submits a batch job request&lt;br/&gt;
threadExecutor launches a new thread which inherits the thread context with user1&apos;s context map&lt;br/&gt;
user1 logs out&lt;br/&gt;
user2 logs in&lt;br/&gt;
submits a batch job.  This batch job is going to be running in the same thread that user1 spawned, which is still annotated with user1&apos;s information. Bah.&lt;/p&gt;

&lt;p&gt;As a bonus, notice how when testing with just user1 everything appears to be working correctly.&lt;br/&gt;
Actually, testing with 2 users will also likely work correctly, because 2nd user will start a new thread, also &quot;correctly&quot; annotated.&lt;/p&gt;

&lt;p&gt;It is generally knowns that InheritableThreadLocal does not work with thread pools for that reason.&lt;br/&gt;
I do not really understand under what circumstances inheriting log context to a child thread is the desired behavior.&lt;br/&gt;
As a matter of fact this is not what the ThreadContext.push() does.  That stuff is not inherited and all is well.&lt;br/&gt;
So my suggested fix is to just replace InheritableThreadLocal with a regular ThreadLocal.  Or at least provide a simple out of the box way of switching.&lt;br/&gt;
Plus both mechanisms should be consistent and the documentation (&lt;a href=&quot;http://logging.apache.org/log4j/2.x/manual/thread-context.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://logging.apache.org/log4j/2.x/manual/thread-context.html&lt;/a&gt;) has to be fixed.  There is a vague paragraph there talking about this problem but offering no sane solution.&lt;/p&gt;</comment>
                            <comment id="13861104" author="remkop@yahoo.com" created="Fri, 3 Jan 2014 02:16:09 +0000"  >&lt;p&gt;Can you confirm the desired behaviour? In the scenario you described:&lt;/p&gt;

&lt;p&gt;user1 logs in, (any logging in the web request handler thread should use this user&apos;s ThreadContext info), &lt;br/&gt;
user1 thread submits a batch job request, threadExecutor launches a new thread which does not inherit any thread context, and &lt;br/&gt;
any logging in thread pool thread should take place without any thread context info.&lt;/p&gt;

&lt;p&gt;Is this what you are trying to achieve?&lt;/p&gt;

&lt;p&gt;One way to accomplish this is to call ThreadContext.clear() at the start of any batch job Runnable or Callable that is submitted to the thread pool. Would that solve the issue? &lt;/p&gt;</comment>
                            <comment id="13861115" author="meshko" created="Fri, 3 Jan 2014 02:22:09 +0000"  >&lt;p&gt;Yes, this is the desired behavior and yes, ThreadContext.clear() does what I want, but how am I going to remember to put that line in every possible place where I&apos;m using a thread pool?  I&apos;m working on a relatively small code base and can immediately think of 3 completely different thread pools.  Shouldn&apos;t the logging library be getting out of my way in simple matters like this?&lt;/p&gt;</comment>
                            <comment id="13861501" author="remkop@yahoo.com" created="Fri, 3 Jan 2014 13:31:37 +0000"  >&lt;p&gt;Hmm... I&apos;m not sure how to proceed here.&lt;/p&gt;

&lt;p&gt;On the one hand, if an application needs some threads to log with ThreadContext info and some threads to log without ThreadContext info, then it would be reasonable to ask the application to control this. (It knows how to put stuff into the ThreadContext somewhere, so it should know how/when to take stuff out.)&lt;/p&gt;

&lt;p&gt;On the other hand, it is interesting that &lt;tt&gt;DefaultThreadContextMap&lt;/tt&gt; uses an &lt;tt&gt;InheritableThreadLocal&lt;/tt&gt; while &lt;tt&gt;DefaultThreadContextStack&lt;/tt&gt; uses a plain &lt;tt&gt;ThreadLocal&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;It seems to me that the map implementation is inheritable on purpose and I hesitate to change this.&lt;br/&gt;
Ralph, can you shed any light on this?&lt;/p&gt;</comment>
                            <comment id="13861507" author="meshko" created="Fri, 3 Jan 2014 13:37:41 +0000"  >&lt;p&gt;One other thing I want to stress, is that missing thread context is very easy to spot and diagnose &amp;#8211; we were initially using DefaultThreadContextStack and immediately knew why some of the decorations were missing.&lt;br/&gt;
But the bug caused by the inheriting thread context is subtle, hard to notice because log lines are decorated and, furthermore, they are decorated correctly while you are developing in a single user environment.   That&apos;s why I strongly prefer no inheritance of the thread context in this case.&lt;/p&gt;</comment>
                            <comment id="13861649" author="ralph.goers@dslextreme.com" created="Fri, 3 Jan 2014 16:43:25 +0000"  >&lt;p&gt;Log4j 1.x used an InheritableThreadLocal for the MDC and a Hashtable with the current thread as the key for the NDC.  Since the NDC is a Stack it doesn&apos;t make any sense for multiple threads to manipulate it.  I believe Logback used to use an InheritableThreadLocal but does something different now that has the same effect (it copies the data from the parent thread).  Our implementation is the same is these for compatibility.  This means you will get the same behavior when you are using the SLF4J API.  However, this issue has been raised a couple of times on the Logback and there are open Jira issues for it.  The most logical proposal is one to allow a system property to control whether the child inherits from its parent.&lt;/p&gt;</comment>
                            <comment id="13861671" author="meshko" created="Fri, 3 Jan 2014 17:11:12 +0000"  >&lt;p&gt;I&apos;ll take a property&lt;/p&gt;</comment>
                            <comment id="13861703" author="beamerblvd" created="Fri, 3 Jan 2014 17:40:35 +0000"  >&lt;p&gt;In my opinion, we need to take one of two paths:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Remove uses of &lt;tt&gt;InheritableThreadLocal&lt;/tt&gt; completely.&lt;/li&gt;
	&lt;li&gt;Make a system option to enable use of &lt;tt&gt;InheritableThreadLocal&lt;/tt&gt;, but &lt;b&gt;disable it by default&lt;/b&gt; so that values are not inherited unless specifically enabled.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;In applications that use thread pools to spin off long-running processes (and this is a lot of applications), an &lt;tt&gt;InheritableThreadLocal&lt;/tt&gt; is &lt;b&gt;dangerous&lt;/b&gt;. Before the thread pool is used for the first time, it is initially empty. It hasn&apos;t yet created any threads. If a thread sets the value in an &lt;tt&gt;InheritableThreadLocal&lt;/tt&gt; and then borrows a thread from that pool, the pool will create a thread with the same &lt;tt&gt;InheritableThreadLocal&lt;/tt&gt; values. That thread will then always have that value, even after the application returns it to the pool. Even worse, in a web application multiple applications could share a single thread pool, resulting in information leaking from one application to another.&lt;/p&gt;</comment>
                            <comment id="13868678" author="remkop@yahoo.com" created="Sat, 11 Jan 2014 06:26:16 +0000"  >&lt;p&gt;Ralph, is disabled by default also what you were thinking?&lt;/p&gt;</comment>
                            <comment id="13868838" author="ralph.goers@dslextreme.com" created="Sat, 11 Jan 2014 17:36:52 +0000"  >&lt;p&gt;Yes.&lt;/p&gt;</comment>
                            <comment id="13869074" author="remkop@yahoo.com" created="Sun, 12 Jan 2014 16:19:26 +0000"  >&lt;p&gt;I made changes to &lt;tt&gt;DefaultThreadContextMap&lt;/tt&gt; so that it now uses a plain &lt;tt&gt;ThreadLocal&lt;/tt&gt; by default. &lt;tt&gt;InheritableThreadLocal&lt;/tt&gt; is used if system property &lt;tt&gt;isThreadContextMapInheritable&lt;/tt&gt; has value &lt;tt&gt;&quot;true&quot;&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Also updated the Thread Context manual page (&lt;a href=&quot;http://logging.apache.org/log4j/2.x/manual/thread-context.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://logging.apache.org/log4j/2.x/manual/thread-context.html&lt;/a&gt; ).&lt;/p&gt;

&lt;p&gt;Fixed in revision 1557551.&lt;br/&gt;
Please verify and close.&lt;/p&gt;</comment>
                            <comment id="14048698" author="sishbi" created="Tue, 1 Jul 2014 09:42:26 +0000"  >&lt;p&gt;The ThreadContext.clear method was removed in 2.0-rc2 it is now called: clearAll&lt;br/&gt;
There are additional clear methods: clearMap and clearStack - I don&apos;t know when these were introduced.&lt;/p&gt;

&lt;p&gt;This has caused issues with existing code that was written against 2.0-rc1&lt;/p&gt;

&lt;p&gt;Also, the manual page still mentions using the clear method to clear the stack (in the stack example) when it should be clearStack ?&lt;br/&gt;
&lt;a href=&quot;http://logging.apache.org/log4j/2.x/manual/thread-context.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://logging.apache.org/log4j/2.x/manual/thread-context.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14048966" author="ralph.goers@dslextreme.com" created="Tue, 1 Jul 2014 15:27:07 +0000"  >&lt;p&gt;clearStack has been around since the ContextStack was added to the ThreadContext - several years now.  clear was renamed because it wasn&apos;t clear what it cleared. It was renamed clearMap.  The clearAll method was added to clear both the stack and map.&lt;/p&gt;

&lt;p&gt;You can expect that these won&apos;t change again.&lt;/p&gt;

&lt;p&gt;Thanks for letting us know about the documentation error. We will get that fixed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>365575</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 21 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1r0l3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>365882</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>