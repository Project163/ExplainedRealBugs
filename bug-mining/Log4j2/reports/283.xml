<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:32:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-620] Deadlock on reconfiguration with Appenders that use log4j</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-620</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;We&apos;re using the JDBC appender to log to database and provide connections from a C3P0 pool.&lt;br/&gt;
We&apos;re finding deadlocks when reconfiguring the log4j2 configuration under heavy load.&lt;br/&gt;
It seems like C3P0 writes to log4j when getting/returning connections from/to the pool and the application deadlocks.&lt;br/&gt;
I think what happens is: When the appender gets a connection from the pool, the call to log4j from C3P0 notices the configuration change, tries to reconfigure, and waits for all appenders (including itself) to finish...&lt;/p&gt;

&lt;p&gt;To simplify things I&apos;ve written a small sample application (Maven project) with a custom appender that uses log4j in its append method.&lt;br/&gt;
As you can see the application deadlocks soon (usually on the first reconfiguration)&lt;/p&gt;

&lt;p&gt;You can run it with: &lt;br/&gt;
&lt;tt&gt;mvn compile exec:java -Dexec.mainClass=logdeadlock.Test&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;It should print a few log messages: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Log: 19:13:54.689 [logdeadlock.Test.main()] ERROR logdeadlock.Test - Test! 0
Log: 19:13:55.696 [logdeadlock.Test.main()] ERROR logdeadlock.Test - Test! 1
Log: 19:13:56.703 [logdeadlock.Test.main()] ERROR logdeadlock.Test - Test! 2
Log: 19:13:57.709 [logdeadlock.Test.main()] ERROR logdeadlock.Test - Test! 3
Log: 19:13:58.715 [logdeadlock.Test.main()] ERROR logdeadlock.Test - Test! 4
2014-04-28 19:13:59,883 DEBUG Reconfiguration started &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; context java.net.URLClassLoader@2ddf7c93
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And then deadlock after the reconfiguration.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;logdeadlock.Test.main()&quot;&lt;/span&gt; prio=10 tid=0x00007fb38883c800 nid=0x2a38 in &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [0x00007fb37e80b000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (on object monitor)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(Native Method)
	- waiting on &amp;lt;0x00000007d894be20&amp;gt; (a org.apache.logging.log4j.core.config.LoggerConfig)
	at org.apache.logging.log4j.core.config.LoggerConfig.waitForCompletion(LoggerConfig.java:382)
	- locked &amp;lt;0x00000007d894be20&amp;gt; (a org.apache.logging.log4j.core.config.LoggerConfig)
	at org.apache.logging.log4j.core.config.LoggerConfig.clearAppenders(LoggerConfig.java:225)
	at org.apache.logging.log4j.core.config.BaseConfiguration.stop(BaseConfiguration.java:228)
	at org.apache.logging.log4j.core.LoggerContext.setConfiguration(LoggerContext.java:346)
	- locked &amp;lt;0x00000007d74a0840&amp;gt; (a org.apache.logging.log4j.core.LoggerContext)
	at org.apache.logging.log4j.core.LoggerContext.onChange(LoggerContext.java:423)
	- locked &amp;lt;0x00000007d74a0840&amp;gt; (a org.apache.logging.log4j.core.LoggerContext)
	at org.apache.logging.log4j.core.config.FileConfigurationMonitor.checkConfiguration(FileConfigurationMonitor.java:79)
	- locked &amp;lt;0x00000007d7bca408&amp;gt; (a org.apache.logging.log4j.core.config.FileConfigurationMonitor)
	at org.apache.logging.log4j.core.Logger$PrivateConfig.filter(Logger.java:318)
	at org.apache.logging.log4j.core.Logger.isEnabled(Logger.java:132)
	at org.apache.logging.log4j.spi.AbstractLogger.isEnabled(AbstractLogger.java:1096)
	at logdeadlock.SomethingThatUsesLogging.doSomething(SomethingThatUsesLogging.java:15)
	at logdeadlock.MyAppender.append(MyAppender.java:41)
	at org.apache.logging.log4j.core.config.AppenderControl.callAppender(AppenderControl.java:97)
	at org.apache.logging.log4j.core.config.LoggerConfig.callAppenders(LoggerConfig.java:425)
	at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:406)
	at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:367)
	at org.apache.logging.log4j.core.Logger.log(Logger.java:112)
	at org.apache.logging.log4j.spi.AbstractLogger.error(AbstractLogger.java:577)
	at logdeadlock.Test.main(Test.java:42)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.codehaus.mojo.exec.ExecJavaMojo$1.run(ExecJavaMojo.java:293)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12710971">LOG4J2-620</key>
            <summary>Deadlock on reconfiguration with Appenders that use log4j</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rgoers">Ralph Goers</assignee>
                                    <reporter username="stefanwehner">Stefan Wehner</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 Apr 2014 17:11:06 +0000</created>
                <updated>Fri, 6 Nov 2020 12:44:51 +0000</updated>
                            <resolved>Mon, 19 May 2014 04:54:35 +0000</resolved>
                                    <version>2.0-rc1</version>
                                    <fixVersion>2.0-rc2</fixVersion>
                                    <component>Configurators</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13983220" author="stefanwehner" created="Mon, 28 Apr 2014 17:12:22 +0000"  >&lt;p&gt;Sample application with its stacktrace when the deadlock occurs.&lt;br/&gt;
Sample stacktrace of our application when the deadlock occurs.&lt;/p&gt;</comment>
                            <comment id="14001386" author="ralph.goers@dslextreme.com" created="Mon, 19 May 2014 04:54:35 +0000"  >&lt;p&gt;Fixed in revision 1595741. Please verify and close.&lt;/p&gt;</comment>
                            <comment id="14001973" author="stefanwehner" created="Mon, 19 May 2014 16:51:03 +0000"  >&lt;p&gt;Yep - the sample app seems to work now! Thanks!&lt;/p&gt;</comment>
                            <comment id="17200710" author="jira-bot" created="Wed, 23 Sep 2020 10:13:31 +0000"  >&lt;p&gt;Commit b68b29986115da7f487e7ee825e11ef95e3366a9 in logging-log4j2&apos;s branch refs/heads/release-2.x from Volkan Yazici&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=b68b299&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=b68b299&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-620&quot; title=&quot;Deadlock on reconfiguration with Appenders that use log4j&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-620&quot;&gt;&lt;del&gt;LOG4J2-620&lt;/del&gt;&lt;/a&gt; ReconfigurationDeadlockTest rewrite to prevent spurious failures.&lt;/p&gt;</comment>
                            <comment id="17200792" author="jira-bot" created="Wed, 23 Sep 2020 12:28:24 +0000"  >&lt;p&gt;Commit 751cebdb59e1046e080ee96a21233602355c65de in logging-log4j2&apos;s branch refs/heads/release-2.x from Volkan Yazici&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=751cebd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=751cebd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-620&quot; title=&quot;Deadlock on reconfiguration with Appenders that use log4j&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-620&quot;&gt;&lt;del&gt;LOG4J2-620&lt;/del&gt;&lt;/a&gt; ReconfigurationDeadlockTest rewrite to prevent spurious failures.&lt;/p&gt;</comment>
                            <comment id="17227381" author="jira-bot" created="Fri, 6 Nov 2020 12:44:51 +0000"  >&lt;p&gt;Commit 80f62c4c7b78fca08d82fd648efe69c88ffd487f in logging-log4j2&apos;s branch refs/heads/master from Volkan Yaz&#305;c&#305;&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=80f62c4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=80f62c4&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-620&quot; title=&quot;Deadlock on reconfiguration with Appenders that use log4j&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-620&quot;&gt;&lt;del&gt;LOG4J2-620&lt;/del&gt;&lt;/a&gt; ReconfigurationDeadlockTest rewrite to prevent spurious failures.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12710880">LOG4J2-619</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12642274" name="deadlock.tgz" size="2803" author="stefanwehner" created="Mon, 28 Apr 2014 17:12:22 +0000"/>
                            <attachment id="12642276" name="real_app_trace.txt" size="4015" author="stefanwehner" created="Mon, 28 Apr 2014 17:12:22 +0000"/>
                            <attachment id="12642275" name="sample_app_trace.txt" size="2506" author="stefanwehner" created="Mon, 28 Apr 2014 17:12:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>389292</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1v21j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>389538</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>