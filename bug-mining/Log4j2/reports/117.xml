<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:31:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-238] OSGi dependency failures in core</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-238</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;To get the core module to load, in addition to re-fixing what was almost fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-159&quot; title=&quot;log4j.xml loading from classpath not working correct in osgi environment&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-159&quot;&gt;&lt;del&gt;LOG4J2-159&lt;/del&gt;&lt;/a&gt; I had to make several packages optional.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;com.lmax.disruptor&lt;/li&gt;
	&lt;li&gt;com.lmax.disruptor.dsl&lt;/li&gt;
	&lt;li&gt;com.lmax.disruptor.util&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;These provided a dependency on sun.misc, which I could hack around to make available but isn&apos;t normally available in OSGi and thus not a dependency I can easily put into a product. I believe the dependency is on sun.misc.Unsafe  I&apos;d like to use it...&lt;/p&gt;

&lt;p&gt;There is also a direct dependency somewhere on&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;sun.misc (also Unsafe)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;com.sun.tools.jconsole &amp;#8211; I think this unlikely to be used in an OSGi environment, so optional is appropriate.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;org.codehaus.jackson&lt;/li&gt;
	&lt;li&gt;org.codehaus.jackson.map&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;These would be easy enough to satisfy, but since most people won&apos;t need JSON logging, the dependency should be optional.&lt;/p&gt;

&lt;p&gt;I think the correct minimal fix is just to make them all optional in the manifest. Eliminating the need for sun.misc would be a good further step&lt;/p&gt;</description>
                <environment>&lt;p&gt;OSGi (Eclipse 4.2.2, but I think the issue is generic OSGi)&lt;/p&gt;</environment>
        <key id="12646075">LOG4J2-238</key>
            <summary>OSGi dependency failures in core</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10101">Abandoned</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rwk">Bob Kerns</reporter>
                        <labels>
                            <label>OSGi</label>
                    </labels>
                <created>Sat, 4 May 2013 07:16:02 +0000</created>
                <updated>Fri, 31 Jul 2020 06:56:20 +0000</updated>
                            <resolved>Fri, 31 Jul 2020 06:56:20 +0000</resolved>
                                    <version>2.0-beta5</version>
                                                    <component>Core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13649043" author="remkop@yahoo.com" created="Sat, 4 May 2013 08:00:04 +0000"  >&lt;p&gt;(Not a solution, just providing some detail)&lt;/p&gt;

&lt;p&gt;The disruptor is used by Async Loggers. &lt;/p&gt;

&lt;p&gt;The direct dependency on Unsafe is in some of the implementations of the Clock interface. &lt;br/&gt;
The package is org.apache.logging.log4j.core.helpers. &lt;br/&gt;
The default Clock impl is SystemClock which does not use Unsafe. I think I can change the other impl classes to avoid using Unsafe, but would need to do some performance tests. &lt;/p&gt;

&lt;p&gt;The dependency on jconsole will be moved out of core in beta6. &lt;/p&gt;</comment>
                            <comment id="13649278" author="ralph.goers@dslextreme.com" created="Sun, 5 May 2013 05:29:09 +0000"  >&lt;p&gt;The jackson dependencies are optional in the pom.xml. How does one make them optional in the OSGi manifest?&lt;/p&gt;</comment>
                            <comment id="13649380" author="rwk" created="Sun, 5 May 2013 17:48:44 +0000"  >&lt;p&gt;Generally, what Unsafe offers is available in other forms. For example, the LMAX disruptors use it to do what java.util.concurrent.atomic.AtomicIntegerArray provides &amp;#8211; which calls the same Unsafe operations under the hood. I don&apos;t know why it&apos;s using Unsafe to do these operations instead &amp;#8211; perhaps Java 1.4 compatibility?&lt;/p&gt;

&lt;p&gt;But making the packages optional will at least allow LOG4J2 to load, sans Async loggers. And to get Async loggers, all I need to do is provide a modified, OSGi&apos;d version of the LMAX Disruptors. Since that doesn&apos;t exist right now, nobody can load LOG4J Core in OSGi, unless we make it optional.&lt;/p&gt;

&lt;p&gt;Until LMAX Disruptors are easily available in OSGi, It would be nice to make Async loggers work if LMAX Disruptors are not present, via blocking queues. A shame, really; LMAX Disruptors are perfect for this usage!&lt;/p&gt;

&lt;p&gt;As for CachedClock and CourseCachedClock, I don&apos;t see any reason they can&apos;t use Object.wait(long) for this purpose. It&apos;s slightly more complex to use because you have to synchronize on some object, and handle the Interrupted exception&lt;/p&gt;

&lt;p&gt;I don&apos;t have a good understanding of Maven, especially its OSGi packaging. (Though it uses bnd, which I do understand). But to be optional in the OSGi manifest, the package imports must look like this:&lt;/p&gt;

&lt;p&gt;Import-Package: com.example.optpkg;resolution:=optional&lt;/p&gt;

&lt;p&gt;That is, resolution:=optional must appear as one of the items after the &apos;;&apos; for each optional package.&lt;/p&gt;

&lt;p&gt;That is generated using bnd; the property that drives it is ${osgi.import}, which is being set in the parent pom. It&apos;s currently being set as * however &amp;#8211; prepending comma-separated package entries for the packages you want to control directly should do the trick.  This should be done locally, rather than in the parent. But perhaps all this Maven stuff provides a better, more automated way?&lt;/p&gt;

&lt;p&gt;I don&apos;t seem to quite have enough Maven integration loaded to fully look at the Maven issues; I&apos;m getting lifecycle configuration errors for felix and mojo, and a lot of missing artifacts. Maybe I can be more helpful if I get that sorted out.&lt;/p&gt;

&lt;p&gt;Also, I see &amp;lt;_nouses&amp;gt;true&amp;lt;/_nouses&amp;gt; in the pom. This is probably not a good idea, though it may be an apparent workaround for a problem elsewhere. The uses clauses &amp;#8211; ugly as they are &amp;#8211; prevent problems when different plugins ask want conflicting versions of packages.&lt;/p&gt;</comment>
                            <comment id="13650259" author="rwk" created="Mon, 6 May 2013 23:59:00 +0000"  >&lt;p&gt;Now that I&apos;ve sorted through my Maven issues, I see the problem is a bit different than I was assuming from the documentation.&lt;/p&gt;

&lt;p&gt;Without it being a fragment, there&apos;s no OSGi-compatible way for it to locate the core implementation. Making it a fragment would solve that particular problem (though locating it as an OSGi service would be a better approach), but still does not lead us to locating a configuration.&lt;/p&gt;

&lt;p&gt;I&apos;m still investigating, but I wanted to document my confusion about what problem making it a fragment is addressing, before I confuse anyone else...&lt;/p&gt;

&lt;p&gt;Ideally we&apos;d integrate with the OSGi logging service (with bridging in either direction), but that&apos;s another topic.&lt;/p&gt;
</comment>
                            <comment id="13651706" author="rwk" created="Wed, 8 May 2013 08:29:34 +0000"  >&lt;p&gt;I&apos;m attaching a git-formatted patch, only lightly tested and in need of some cleanup before applying, but posting for review purposes.&lt;/p&gt;

&lt;p&gt;This uses OSGi declarative services to link API and implementation (core), and provides a OSGi-specific LoggingContextFactory implementation.&lt;/p&gt;

&lt;p&gt;A known flaw is that it extends the search for configurations for all environments, not just OSGi. Some adjustments to ConfigurationFactory will be needed to avoid this.&lt;/p&gt;</comment>
                            <comment id="13651707" author="rwk" created="Wed, 8 May 2013 08:31:59 +0000"  >&lt;p&gt;The patch also addresses &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-159&quot; title=&quot;log4j.xml loading from classpath not working correct in osgi environment&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-159&quot;&gt;&lt;del&gt;LOG4J2-159&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13655813" author="ralph.goers@dslextreme.com" created="Mon, 13 May 2013 07:10:32 +0000"  >&lt;p&gt;The way to OSGi LoggerContextFactory is hooked in bothers me as it is going to prevent any other LoggerContextFactories from being used. You are correct that it changes the behavior of the ConfigurationFactory.&lt;/p&gt;

&lt;p&gt;At the moment I&apos;m concerned that while applying this may make things work in an OSGi environment it may cause problems in non-OSGi environments.&lt;/p&gt;</comment>
                            <comment id="13656257" author="rwk" created="Mon, 13 May 2013 18:56:21 +0000"  >&lt;p&gt;OSGiLoggerContextFactory is a proxy, that dispatches to the real one that&apos;s supplied to it as an OSGi service. The user can substitute a different LoggerContextFactory by simply supplying a service with a higher service.ranking property. But an enhancement would be add a property that allows customization on a per-bundle basis.&lt;/p&gt;

&lt;p&gt;For example, look at org.apache.logging.log4j.core.osgi.LoggerContextService, which is the actual LoggerContextFactory that gets used by default. (It&apos;s a subclass of Log4jContextFactory). It starts out:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;LoggerContextService.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Component(name=&lt;span class=&quot;code-quote&quot;&gt;&quot;log4j2&quot;&lt;/span&gt;, immediate=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, enabled=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, policy=ConfigurationPolicy.IGNORE)
@Service(org.apache.logging.log4j.spi.LoggerContextFactory.class)
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LoggerContextService &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Log4jContextFactory &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; org.apache.logging.log4j.spi.LoggerContextFactory {
  @property(intValue=10)
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; SERVICE_RANKING = &lt;span class=&quot;code-quote&quot;&gt;&quot;service.ranking&quot;&lt;/span&gt;;
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;OSGiLoggerContextFactory finds all such services, and picks the one with the highest value. Supplying @property(intValue=20) on your own implementation allows you to customize it.&lt;/p&gt;

&lt;p&gt;That&apos;s why OSGiLoggerContextFactory maintains an ordered set of services, rather than specifying cardinality 0..1. Right now, it&apos;s duplicating what OSGi will do in arbitrating services, but I made it explicit so we can customize it.&lt;/p&gt;

&lt;p&gt;While I think we would like to have the ability to customize per bundle (done similarly, with another property), I don&apos;t see that as a barrier to putting it in for beta; even without the enhancement, it&apos;s a step forward and allows as much customization as in a non-OSGi environment.&lt;/p&gt;

&lt;p&gt;As for the other concerns, about ConfigurationFactory, and the possibility of problems in a non-OSGi environment: Agreed, it should not go in just yet. I&apos;ll try to get a chance soon to address the ConfigurationFactory, and test in a non-OSGi environment. (I had hoped to do that last week, but I hope to get to it in the next day or two). I should also test supplying a custom one.&lt;/p&gt;

&lt;p&gt;If I did it right (test!) the only impact on non-OSGi environments, will be that LogManager, while loading, will run the bit of code I added that tries to load OSGiLoggerContextFactory, it won&apos;t load, and it will log it at the INFO level, and then continue as it would before. Beyond that point, there should be no OSGi-related code involved. There &lt;em&gt;are&lt;/em&gt; a few changes, such as refactoring in Log4JContextFactory to allow LoggerContextService to override what ContextSelector is created. These should all do the same thing as before. ConfigurationFactory is an exception that needs to be fixed.&lt;/p&gt;</comment>
                            <comment id="13667012" author="remkop@yahoo.com" created="Sat, 25 May 2013 07:17:14 +0000"  >&lt;p&gt;I removed the dependency on sun.misc.Unsafe from CachedClock and CoarseCachedClock (revision 1486296).&lt;/p&gt;</comment>
                            <comment id="13667035" author="sdeboy" created="Sat, 25 May 2013 09:27:34 +0000"  >&lt;p&gt;Would you mind removing the commented out code?&lt;/p&gt;</comment>
                            <comment id="13667043" author="remkop@yahoo.com" created="Sat, 25 May 2013 10:39:04 +0000"  >&lt;p&gt;Done.&lt;/p&gt;</comment>
                            <comment id="13712086" author="remkop@yahoo.com" created="Thu, 18 Jul 2013 07:02:20 +0000"  >&lt;p&gt;Bob, some work was done on this issue as well as on &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-10&quot; title=&quot;log4j 2.0 should work well with OSGi and Apache Felix&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-10&quot;&gt;&lt;del&gt;LOG4J2-10&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
(Specifically, &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-10?focusedCommentId=13657655&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13657655&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/LOG4J2-10?focusedCommentId=13657655&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13657655&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Still, I&apos;m not sure whether this ticket can now be marked as &quot;fixed&quot;.&lt;br/&gt;
Can you take a look and let us know if there are any remaining issues?&lt;/p&gt;</comment>
                            <comment id="13917637" author="jvz" created="Mon, 3 Mar 2014 00:14:05 +0000"  >&lt;p&gt;Adding to epic.&lt;/p&gt;</comment>
                            <comment id="13976344" author="jvz" created="Tue, 22 Apr 2014 03:30:31 +0000"  >&lt;p&gt;So it looks like we&apos;ve got a couple issues with the use of sun.misc.Unsafe. First of all, you can&apos;t use this class at all without either having no security context or by at least having some reflection permissions (which tends to allow one to completely destroy any and all security in Java at that point; it&apos;s the god permission). In that regard, I find it amusing that LMAX disruptor &lt;a href=&quot;https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/util/Util.java#L102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;bypasses the security check via reflection&lt;/a&gt; instead of bothering with the &lt;a href=&quot;http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/37392f2f5d59/src/share/classes/sun/misc/Unsafe.java#l87&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;getUnsafe method&lt;/a&gt; (which does its own security check by seeing if the calling class has a ClassLoader; not sure why that&apos;s supposed to work).&lt;/p&gt;

&lt;p&gt;When it comes to disruptor, the Unsafe class is only used in two places: &lt;a href=&quot;https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/Sequence.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Sequence&lt;/a&gt; and &lt;a href=&quot;https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/MultiProducerSequencer.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;MultiProducerSequencer&lt;/a&gt;. While I commend their efforts at keeping all the code in Java, when it comes to manipulating things at this level, some of this code might be better off as JNI code. At least that would work in OSGi as far as I know.&lt;/p&gt;</comment>
                            <comment id="16870466" author="ralph.goers@dslextreme.com" created="Sun, 23 Jun 2019 07:33:13 +0000"  >&lt;p&gt;Can we close this issue?&lt;/p&gt;</comment>
                            <comment id="17168442" author="ralph.goers@dslextreme.com" created="Fri, 31 Jul 2020 06:56:20 +0000"  >&lt;p&gt;Marking as resolved/abandoned due to lack of activity.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12582269" name="0001-LOG4J2-238-and-Log472-159.-OSGi-coordination-of-API-.patch" size="32752" author="rwk" created="Wed, 8 May 2013 08:29:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311120" key="com.pyxis.greenhopper.jira:gh-epic-link">
                        <customfieldname>Epic Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>LOG4J2-515</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>326433</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1kbe7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>326778</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>