<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:35:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-323] ThreadLocal-leak on tomcat shutdown when using async logging</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-323</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;When shutting down Tomcat 7.0.42, catalina.out displays the following warning indicating a memory leak:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Jul 28, 2013 9:55:59 AM org.apache.coyote.AbstractProtocol start
INFO: Starting ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080&quot;&lt;/span&gt;]
Jul 28, 2013 9:55:59 AM org.apache.coyote.AbstractProtocol start
INFO: Starting ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-bio-8009&quot;&lt;/span&gt;]
Jul 28, 2013 9:55:59 AM org.apache.catalina.startup.Catalina start
INFO: Server startup in 841 ms
Jul 28, 2013 9:56:09 AM org.apache.catalina.core.StandardServer await
INFO: A valid shutdown command was received via the shutdown port. Stopping the Server instance.
Jul 28, 2013 9:56:09 AM org.apache.coyote.AbstractProtocol pause
INFO: Pausing ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080&quot;&lt;/span&gt;]
Jul 28, 2013 9:56:09 AM org.apache.coyote.AbstractProtocol pause
INFO: Pausing ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-bio-8009&quot;&lt;/span&gt;]
Jul 28, 2013 9:56:09 AM org.apache.catalina.core.StandardService stopInternal
INFO: Stopping service Catalina
Jul 28, 2013 9:56:09 AM org.apache.catalina.loader.WebappClassLoader checkThreadLocalMapForLeaks
SEVERE: The web application [/asynclog] created a ThreadLocal with key of type [java.lang.ThreadLocal] (value [java.lang.ThreadLocal@648bfdea]) and a value of type [org.apache.logging.log4j.core.async.AsyncLogger.Info] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info@4e26d560]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and avoid a probable memory leak.
Jul 28, 2013 9:56:09 AM org.apache.coyote.AbstractProtocol stop
INFO: Stopping ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080&quot;&lt;/span&gt;]
Jul 28, 2013 9:56:09 AM org.apache.coyote.AbstractProtocol stop
INFO: Stopping ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-bio-8009&quot;&lt;/span&gt;]
Jul 28, 2013 9:56:09 AM org.apache.coyote.AbstractProtocol destroy
INFO: Destroying ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;http-bio-8080&quot;&lt;/span&gt;]
Jul 28, 2013 9:56:09 AM org.apache.coyote.AbstractProtocol destroy
INFO: Destroying ProtocolHandler [&lt;span class=&quot;code-quote&quot;&gt;&quot;ajp-bio-8009&quot;&lt;/span&gt;]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;log4j2.xml&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;?xml version=&lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt; encoding=&lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;?&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;configuration status=&lt;span class=&quot;code-quote&quot;&gt;&quot;WARN&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;appenders&amp;gt;&lt;/span&gt;
    &amp;lt;FastRollingFile name=&lt;span class=&quot;code-quote&quot;&gt;&quot;MyFileLog&quot;&lt;/span&gt; filename=&lt;span class=&quot;code-quote&quot;&gt;&quot;logs/my.log&quot;&lt;/span&gt;
      filePattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;logs/my-%d{COMPACT}.log&quot;&lt;/span&gt;&amp;gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;PatternLayout pattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;%d %p %c{1.} [%t] %m%n&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;Policies&amp;gt;&lt;/span&gt;
	  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;SizeBasedTriggeringPolicy size=&lt;span class=&quot;code-quote&quot;&gt;&quot;5MB&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/Policies&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/FastRollingFile&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;Console name=&lt;span class=&quot;code-quote&quot;&gt;&quot;Console&quot;&lt;/span&gt; target=&lt;span class=&quot;code-quote&quot;&gt;&quot;SYSTEM_OUT&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;PatternLayout pattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;%d %p %c{1.} [%t] %m%n&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/Console&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/appenders&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;loggers&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;logger name=&lt;span class=&quot;code-quote&quot;&gt;&quot;mylogger&quot;&lt;/span&gt; level=&lt;span class=&quot;code-quote&quot;&gt;&quot;INFO&quot;&lt;/span&gt; additivity=&lt;span class=&quot;code-quote&quot;&gt;&quot;false&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;appender-ref ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;MyFileLog&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/logger&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;root level=&lt;span class=&quot;code-quote&quot;&gt;&quot;TRACE&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;appender-ref ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;Console&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/root&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/loggers&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/configuration&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;log4j2.xml&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;#!/bin/bash

CATALINA_OPTS=-DLog4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Mac OS X 10.8.4, Tomcat 7.0.42, java version 1.6.0_51&lt;/p&gt;</environment>
        <key id="12660290">LOG4J2-323</key>
            <summary>ThreadLocal-leak on tomcat shutdown when using async logging</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="mikekloster">Michael Kloster</reporter>
                        <labels>
                            <label>Async</label>
                    </labels>
                <created>Sun, 28 Jul 2013 16:46:37 +0000</created>
                <updated>Sat, 12 Sep 2020 16:00:15 +0000</updated>
                            <resolved>Fri, 23 Oct 2015 17:00:55 +0000</resolved>
                                    <version>2.0-beta9</version>
                                    <fixVersion>2.3</fixVersion>
                    <fixVersion>2.5</fixVersion>
                                        <due></due>
                            <votes>5</votes>
                                    <watches>15</watches>
                                                                                                                <comments>
                            <comment id="13794704" author="remkop@yahoo.com" created="Tue, 15 Oct 2013 00:32:25 +0000"  >&lt;p&gt;This issue is similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-425&quot; title=&quot;Permgen leak in AsyncLoggerConfigHelper&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-425&quot;&gt;&lt;del&gt;LOG4J2-425&lt;/del&gt;&lt;/a&gt;. Both AsyncLoggerConfigHelper and AsyncLogger use a similar mechanism, so they should be fixed together.&lt;/p&gt;

&lt;p&gt;Implementation note:&lt;br/&gt;
the simplest way to accomplish this is probably to null out the reference to the ThreadLocal field (or replace it with a new instance), so that the old instance (with its map of thread references) can be garbage collected. (This means the field can no longer be final.)&lt;/p&gt;</comment>
                            <comment id="13795385" author="remkop@yahoo.com" created="Tue, 15 Oct 2013 17:08:36 +0000"  >&lt;p&gt;Resolved memory leak by releasing reference to ThreadLocal when AsyncLogger is stopped.&lt;/p&gt;

&lt;p&gt;Fixed in revision 1532438.&lt;br/&gt;
Please verify and close.&lt;/p&gt;</comment>
                            <comment id="13796598" author="hudson" created="Wed, 16 Oct 2013 09:24:07 +0000"  >&lt;p&gt;SUCCESS: Integrated in Syncope-trunk #467 (See &lt;a href=&quot;https://builds.apache.org/job/Syncope-trunk/467/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Syncope-trunk/467/&lt;/a&gt;)&lt;br/&gt;
Getting log4j 2.0RC1 enhancements (including &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-323&quot; title=&quot;ThreadLocal-leak on tomcat shutdown when using async logging&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-323&quot;&gt;&lt;del&gt;LOG4J2-323&lt;/del&gt;&lt;/a&gt;) and avoid resetting log files between restarts (ilgrosso: rev 1532675)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/syncope/trunk/console/src/main/resources/log4j2.xml&lt;/li&gt;
	&lt;li&gt;/syncope/trunk/core/src/main/resources/log4j2.xml&lt;/li&gt;
	&lt;li&gt;/syncope/trunk/pom.xml&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13796717" author="remkop@yahoo.com" created="Wed, 16 Oct 2013 12:24:22 +0000"  >&lt;p&gt;Hi Hudson, so before you were seeing the Tomcat memory leak warning but with the latest checkout from trunk you are no longer seeing it?&lt;/p&gt;</comment>
                            <comment id="13796730" author="ilgrosso" created="Wed, 16 Oct 2013 12:37:35 +0000"  >&lt;p&gt;It&apos;s not Hudson, it&apos;s me updating log4j2 version to 2.0RC1-SNAPSHOT on Syncope trunk &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Anyway, I confirm the fix works: nice job!&lt;br/&gt;
Regards.&lt;/p&gt;</comment>
                            <comment id="13796745" author="remkop@yahoo.com" created="Wed, 16 Oct 2013 12:50:52 +0000"  >&lt;p&gt;Oh. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Sorry Francesco. And thanks for the confirmation!&lt;/p&gt;</comment>
                            <comment id="13881009" author="draiwn" created="Fri, 24 Jan 2014 14:40:51 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;It still have the same issue with the latest RC1 build from the trunk today (01/24)&lt;/p&gt;

&lt;p&gt;The console output:&lt;br/&gt;
The web application &lt;span class=&quot;error&quot;&gt;&amp;#91;/api&amp;#93;&lt;/span&gt; created a ThreadLocal with key of type &lt;span class=&quot;error&quot;&gt;&amp;#91;java.lang.ThreadLocal&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;java.lang.ThreadLocal@7d993bfd&amp;#93;&lt;/span&gt;) and a value of type &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.logging.log4j.core.async.AsyncLogger.Info&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.logging.log4j.core.async.AsyncLogger$Info@57319f76&amp;#93;&lt;/span&gt;) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to try and avoid a probable memory leak.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="13886235" author="beamerblvd" created="Thu, 30 Jan 2014 04:06:49 +0000"  >&lt;p&gt;Remko,&lt;/p&gt;

&lt;p&gt;Nulling out the reference to the &lt;tt&gt;ThreadLocal&lt;/tt&gt; is not enough (in fact, it&apos;s not even necessary). If it were enough, then once the object holding the reference was eligible for garbage collection the &lt;tt&gt;ThreadLocal&lt;/tt&gt; would go away&#8212;but it doesn&apos;t.&lt;/p&gt;

&lt;p&gt;To remove a &lt;tt&gt;ThreadLocal&lt;/tt&gt;&apos;s contents, you must call the &lt;tt&gt;remove&lt;/tt&gt; method on the &lt;tt&gt;ThreadLocal&lt;/tt&gt;. There is no reason to null out the &lt;tt&gt;ThreadLocal&lt;/tt&gt; instance once &lt;tt&gt;remove&lt;/tt&gt; has been called.&lt;/p&gt;

&lt;p&gt;I&apos;ll have this fixed shortly.&lt;/p&gt;</comment>
                            <comment id="13886236" author="beamerblvd" created="Thu, 30 Jan 2014 04:08:20 +0000"  >&lt;p&gt;Fixed with r1562688. Please verify and close.&lt;/p&gt;</comment>
                            <comment id="13886239" author="remkop@yahoo.com" created="Thu, 30 Jan 2014 04:16:38 +0000"  >&lt;p&gt;Nick, nice catch! Thanks! &lt;/p&gt;

&lt;p&gt;Mickael, can you verify?&lt;/p&gt;</comment>
                            <comment id="13886245" author="mikekloster" created="Thu, 30 Jan 2014 04:27:55 +0000"  >&lt;p&gt;Yes, I will pull and verify tonight.&lt;/p&gt;</comment>
                            <comment id="13886725" author="draiwn" created="Thu, 30 Jan 2014 16:19:51 +0000"  >&lt;p&gt;Hi all,&lt;/p&gt;

&lt;p&gt;I can confirm all is ok now, well done Nick, thanks! &lt;br/&gt;
Juste one thing, trunk head is broken and doesn&apos;t compile, r1562688 is ok &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13886825" author="garydgregory" created="Thu, 30 Jan 2014 17:57:54 +0000"  >&lt;p&gt;Do you mean that &apos;mvn clean compile&apos; gives you errors?&lt;/p&gt;
</comment>
                            <comment id="13887064" author="remkop@yahoo.com" created="Thu, 30 Jan 2014 21:20:19 +0000"  >&lt;p&gt;Trunk built ok for me just now.&lt;br/&gt;
Do you still have the error?&lt;/p&gt;

&lt;p&gt;EDIT: I meant, do you still have the error stacktrace? I think there may still be some JUnit tests that usually pass but occasionally fail. One of the Rolling appender tests had a timing issue, there may be other similar issues in the tests...&lt;/p&gt;</comment>
                            <comment id="13887571" author="draiwn" created="Fri, 31 Jan 2014 08:57:38 +0000"  >&lt;p&gt;Yes update today to last revision (r1563090), still have the compilation error:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;ERROR&amp;#93;&lt;/span&gt; Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:3.1:compile (default-compile) on project log4j-core: Compilation failure&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;ERROR&amp;#93;&lt;/span&gt; log4j/log4j-core/src/main/java/org/apache/logging/log4j/core/appender/db/jdbc/FactoryMethodConnectionSource.java:&lt;span class=&quot;error&quot;&gt;&amp;#91;126,17&amp;#93;&lt;/span&gt; method does not override or implement a method from a supertype&lt;/p&gt;

</comment>
                            <comment id="13887578" author="remkop@yahoo.com" created="Fri, 31 Jan 2014 09:14:34 +0000"  >&lt;p&gt;Ah, I see it now...&lt;/p&gt;

&lt;p&gt;That method actually has a comment:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// method must be present to compile on Java 7, @Override must be absent to compile on Java 6&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but an &lt;tt&gt;@Override&lt;/tt&gt; annotation was added in r1562689.&lt;/p&gt;

&lt;p&gt;I&apos;m at work and cannot commit now. I&apos;ll remove it if it is still there when I get home, unless someone else beats me to it...&lt;/p&gt;

&lt;p&gt;Thanks for the heads-up!&lt;/p&gt;</comment>
                            <comment id="13887681" author="remkop@yahoo.com" created="Fri, 31 Jan 2014 12:07:52 +0000"  >&lt;p&gt;Removed the @Override to fix the compilation problem in revision 1563115.&lt;/p&gt;

&lt;p&gt;Please verify and close.&lt;/p&gt;</comment>
                            <comment id="13887700" author="draiwn" created="Fri, 31 Jan 2014 12:41:07 +0000"  >&lt;p&gt;It&apos;s ok now, thanks &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13887705" author="remkop@yahoo.com" created="Fri, 31 Jan 2014 12:46:49 +0000"  >&lt;p&gt;Closing this issue.&lt;/p&gt;</comment>
                            <comment id="13887754" author="garydgregory" created="Fri, 31 Jan 2014 13:39:48 +0000"  >&lt;p&gt;oops, my bad on the override. &lt;/p&gt;</comment>
                            <comment id="13887758" author="remkop@yahoo.com" created="Fri, 31 Jan 2014 13:42:45 +0000"  >&lt;p&gt;No problem! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13937102" author="hype" created="Sun, 16 Mar 2014 12:11:09 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I&apos;m still having the same issue with the latest RC1 build from the trunk yesterday (03/15). &lt;br/&gt;
All configuration is the same as author of the issue has. &lt;br/&gt;
I removed log4j*.jar from the jarsToSkip list in catalina.properties.&lt;br/&gt;
The version of Servlet API is 3.0.&lt;br/&gt;
Also I tried with tomcat 7.0.29 and 7.0.51 and result is the same. &lt;/p&gt;

&lt;p&gt;Console output:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SEVERE: The web application [/Server] created a ThreadLocal with key of type [java.lang.ThreadLocal] (value [java.lang.ThreadLocal@cca1713]) and a value of type [org.apache.logging.log4j.core.async.AsyncLogger.Info] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info@27b0e6f4]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and avoid a probable memory leak.
&#1100;&#1088;&#1025; 16, 2014 4:01:03 PM org.apache.catalina.loader.WebappClassLoader checkThread LocalMapForLeaks
SEVERE: The web application [/Server] created a ThreadLocal with key of type [java.lang.ThreadLocal] (value [java.lang.ThreadLocal@cca1713]) and a value of type [org.apache.logging.log4j.core.async.AsyncLogger.Info] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info@4f0ab187]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and avoid a probable memory leak.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13937105" author="remkop@yahoo.com" created="Sun, 16 Mar 2014 12:17:06 +0000"  >&lt;p&gt;Re-opened for investigation.&lt;/p&gt;</comment>
                            <comment id="13939754" author="hype" created="Tue, 18 Mar 2014 20:44:16 +0000"  >&lt;p&gt;Also I see the following message while Tomcat is deploying webapp:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SEVERE: The web application [/Server] appears to have started a thread named [AsyncLogger-1] but has failed to stop it. This is very likely to create a memory leak.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14038520" author="remkop@yahoo.com" created="Fri, 20 Jun 2014 06:23:47 +0000"  >&lt;p&gt;Ilya, can you tell me where the log4j2 jar files are located?&lt;/p&gt;

&lt;p&gt;If you use AsyncLoggers (with -DLog4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector to make all loggers asynchronous), you should not put the log4j2 jar files in the application server&apos;s shared lib directory - see &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-493&quot; title=&quot;Problem with AsyncLogger when web app is deployed/undeployed multiple times&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-493&quot;&gt;&lt;del&gt;LOG4J2-493&lt;/del&gt;&lt;/a&gt;.  As a workaround please put the log4j2 jar files in WEB-INF/lib of your web application.&lt;/p&gt;

&lt;p&gt;Another way to deal with this is to not use the system property to set  Log4jContextSelector, but instead in your configuration use &amp;lt;AsyncRoot&amp;gt; and &amp;lt;AsyncLogger&amp;gt; elements.&lt;br/&gt;
This is using a different mechanism that supports loading/unloading web apps better (but be aware that in rc1 this mechanism still has a known issue &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-392&quot; title=&quot;Intermittent errors with appenders&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-392&quot;&gt;&lt;del&gt;LOG4J2-392&lt;/del&gt;&lt;/a&gt;, this is fixed in &lt;del&gt;soon to be released&lt;/del&gt; rc2).&lt;/p&gt;</comment>
                            <comment id="14042104" author="hype" created="Tue, 24 Jun 2014 13:35:47 +0000"  >&lt;p&gt;Remko, I have &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &amp;lt;context-param&amp;gt;
        &amp;lt;param-name&amp;gt;Log4jContextSelector&amp;lt;/param-name&amp;gt;
        &amp;lt;param-value&amp;gt;org.apache.logging.log4j.core.async.AsyncLoggerContextSelector&amp;lt;/param-value&amp;gt;
    &amp;lt;/context-param&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;in web.xml and &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;...
    &amp;lt;Loggers&amp;gt;
        &amp;lt;Root level=&lt;span class=&quot;code-quote&quot;&gt;&quot;debug&quot;&lt;/span&gt;&amp;gt;
            &amp;lt;AppenderRef ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;RollingRandomAccessFile&quot;&lt;/span&gt; level=&lt;span class=&quot;code-quote&quot;&gt;&quot;debug&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;/Root&amp;gt;
    &amp;lt;/Loggers&amp;gt;
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in log4j2.xml. log4j2*.jar files are located in WEB-INF/lib of my web app.&lt;/p&gt;

&lt;p&gt;If I remove AsyncLoggerContextSelector from my web.xml and change log4j2.xml to&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;...
    &amp;lt;Loggers&amp;gt;
        &amp;lt;AsyncRoot level=&lt;span class=&quot;code-quote&quot;&gt;&quot;debug&quot;&lt;/span&gt; includeLocation=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;&amp;gt;
            &amp;lt;AppenderRef ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;RollingRandomAccessFile&quot;&lt;/span&gt; level=&lt;span class=&quot;code-quote&quot;&gt;&quot;debug&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;/AsyncRoot&amp;gt;
    &amp;lt;/Loggers&amp;gt;
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ll get an error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR An exception occurred processing Appender RollingRandomAccessFile java.lang.NullPointerException
        at org.apache.logging.log4j.core.pattern.NameAbbreviator$MaxElementAbbreviator.abbreviate(NameAbbreviator.java:182)
        at org.apache.logging.log4j.core.pattern.NamePatternConverter.abbreviate(NamePatternConverter.java:53)
        at org.apache.logging.log4j.core.pattern.LoggerPatternConverter.format(LoggerPatternConverter.java:64)
        at org.apache.logging.log4j.core.pattern.PatternFormatter.format(PatternFormatter.java:36)
        at org.apache.logging.log4j.core.layout.PatternLayout.toSerializable(PatternLayout.java:209)
        at org.apache.logging.log4j.core.layout.PatternLayout.toSerializable(PatternLayout.java:52)
        at org.apache.logging.log4j.core.layout.AbstractStringLayout.toByteArray(AbstractStringLayout.java:45)
        at org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.append(AbstractOutputStreamAppender.java:118)
        at org.apache.logging.log4j.core.appender.RollingRandomAccessFileAppender.append(RollingRandomAccessFileAppender.java:96)
        at org.apache.logging.log4j.core.config.AppenderControl.callAppender(AppenderControl.java:97)
        at org.apache.logging.log4j.core.config.LoggerConfig.callAppenders(LoggerConfig.java:423)
        at org.apache.logging.log4j.core.async.AsyncLoggerConfig.asyncCallAppenders(AsyncLoggerConfig.java:117)
        at org.apache.logging.log4j.core.async.AsyncLoggerConfigHelper$Log4jEventWrapperHandler.onEvent(AsyncLoggerConfigHelper.java:222)
        at org.apache.logging.log4j.core.async.AsyncLoggerConfigHelper$Log4jEventWrapperHandler.onEvent(AsyncLoggerConfigHelper.java:207)
        at com.lmax.disruptor.BatchEventProcessor.run(BatchEventProcessor.java:133)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Am I doing something wrong?&lt;/p&gt;

&lt;p&gt;PS I;m using log4j2 rc1.&lt;/p&gt;</comment>
                            <comment id="14042248" author="ralph.goers@dslextreme.com" created="Tue, 24 Jun 2014 15:25:53 +0000"  >&lt;p&gt;Can you show the configuration of the Appender?&lt;/p&gt;</comment>
                            <comment id="14042267" author="hype" created="Tue, 24 Jun 2014 15:47:48 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;?xml version=&lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt; encoding=&lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;?&amp;gt;
&amp;lt;Configuration status=&lt;span class=&quot;code-quote&quot;&gt;&quot;WARN&quot;&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;Server&quot;&lt;/span&gt; packages=&quot;&quot;&amp;gt;
    &amp;lt;Appenders&amp;gt;
        &amp;lt;RollingRandomAccessFile name=&lt;span class=&quot;code-quote&quot;&gt;&quot;RollingRandomAccessFile&quot;&lt;/span&gt;
                                 fileName=&lt;span class=&quot;code-quote&quot;&gt;&quot;server.log&quot;&lt;/span&gt;
                                 filePattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;$${date:yyyy-MM}/server-%d{yyyy-MM-dd}-%i.log.zip&quot;&lt;/span&gt;
                                 immediateFlush=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;
                                 append=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;&amp;gt;
            &amp;lt;PatternLayout&amp;gt;
                &amp;lt;Pattern&amp;gt;%d{dd-MM-yyyy HH:mm:ss} %-5p [%X{sid}] %-30c{1} %-30M %4L %m%n&amp;lt;/Pattern&amp;gt;
            &amp;lt;/PatternLayout&amp;gt;
            &amp;lt;Policies&amp;gt;
                &amp;lt;TimeBasedTriggeringPolicy modulate=&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt; interval=&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;/&amp;gt;
                &amp;lt;SizeBasedTriggeringPolicy size=&lt;span class=&quot;code-quote&quot;&gt;&quot;30 MB&quot;&lt;/span&gt;/&amp;gt;
            &amp;lt;/Policies&amp;gt;
            &amp;lt;DefaultRolloverStrategy max=&lt;span class=&quot;code-quote&quot;&gt;&quot;10&quot;&lt;/span&gt; compressionLevel=&lt;span class=&quot;code-quote&quot;&gt;&quot;5&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;/RollingRandomAccessFile&amp;gt;
    &amp;lt;/Appenders&amp;gt;
    &amp;lt;Loggers&amp;gt;
        &amp;lt;Root level=&lt;span class=&quot;code-quote&quot;&gt;&quot;info&quot;&lt;/span&gt;&amp;gt;
            &amp;lt;AppenderRef ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;RollingRandomAccessFile&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;/Root&amp;gt;
    &amp;lt;/Loggers&amp;gt;
&amp;lt;/Configuration&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14042297" author="ralph.goers@dslextreme.com" created="Tue, 24 Jun 2014 16:09:24 +0000"  >&lt;p&gt;Interesting. The only conclusion I can come to is that the logger name field is null, although I can&apos;t say why.  What version of Log4j 2 are you using?&lt;/p&gt;</comment>
                            <comment id="14042333" author="hype" created="Tue, 24 Jun 2014 16:37:48 +0000"  >&lt;p&gt;I&apos;m using RC1, but I tried this also with RC2 snapshot from trunk a month ago.&lt;/p&gt;</comment>
                            <comment id="14058535" author="remkop@yahoo.com" created="Fri, 11 Jul 2014 08:01:54 +0000"  >&lt;p&gt;Ilya, the NullPointerException was caused by an issue in RC1 when combining AsyncLoggerConfig with AsyncLogger. This was fixed in RC2 with &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-669&quot; title=&quot;NPE when combining AsyncLoggerConfig with AsyncLogger&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-669&quot;&gt;&lt;del&gt;LOG4J2-669&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Using RC2, and after putting the log4j2 jar files in WEB-INF/lib of your web application, are you still seeing the ThreadLocal memory leak warning on Tomcat?&lt;/p&gt;</comment>
                            <comment id="14058638" author="hype" created="Fri, 11 Jul 2014 10:47:50 +0000"  >&lt;p&gt;Remko, I&apos;ve just downloaded log4j2 binary and tried to reproduce the issue.&lt;br/&gt;
I have:&lt;br/&gt;
1. log4j*.jar in WEB-INF/lib&lt;br/&gt;
2. AsyncRoot in my log4j2.xml:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &amp;lt;Loggers&amp;gt;
        &amp;lt;AsyncRoot level=&lt;span class=&quot;code-quote&quot;&gt;&quot;debug&quot;&lt;/span&gt;&amp;gt;
            &amp;lt;AppenderRef ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;RollingRandomAccessFile&quot;&lt;/span&gt; level=&lt;span class=&quot;code-quote&quot;&gt;&quot;debug&quot;&lt;/span&gt;/&amp;gt;
        &amp;lt;/AsyncRoot&amp;gt;
    &amp;lt;/Loggers&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;3. removed Log4jContextSelector context-param from web.xml.&lt;/p&gt;

&lt;p&gt;Now after redeploying my artifact I got:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Jul 11, 2014 1:23:10 PM org.apache.catalina.loader.WebappClassLoader clearReferencesThreads
SEVERE: The web application [/Server] appears to have started a thread named [AsyncLoggerConfig-1] but has failed to stop it. This is very likely to create a memory leak.
Jul 11, 2014 1:23:10 PM org.apache.catalina.loader.WebappClassLoader clearReferencesThreads
SEVERE: The web application [/Server] appears to have started a thread named [MySQL Statement Cancellation Timer] but has failed to stop it. This is very likely to create a memory leak.
Jul 11, 2014 1:23:10 PM org.apache.catalina.loader.WebappClassLoader checkThreadLocalMapForLeaks
SEVERE: The web application [/Server] created a ThreadLocal with key of type [java.lang.ThreadLocal] (value [java.lang.ThreadLocal@1bf7b4f9]) and a value of type [org.apache.logging.log4j.core.async.AsyncLogger.Info] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info@238a55c7]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and avoid a probable memory leak.
Jul 11, 2014 1:23:10 PM org.apache.catalina.loader.WebappClassLoader checkThreadLocalMapForLeaks
SEVERE: The web application [/Server] created a ThreadLocal with key of type [java.lang.ThreadLocal] (value [java.lang.ThreadLocal@1bf7b4f9]) and a value of type [org.apache.logging.log4j.core.async.AsyncLogger.Info] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info@4f058e0b]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and avoid a probable memory leak.
Jul 11, 2014 1:23:10 PM org.apache.catalina.loader.WebappClassLoader checkThreadLocalMapForLeaks
SEVERE: The web application [/Server] created a ThreadLocal with key of type [java.lang.ThreadLocal] (value [java.lang.ThreadLocal@1bf7b4f9]) and a value of type [org.apache.logging.log4j.core.async.AsyncLogger.Info] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info@49971b88]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and avoid a probable memory leak.
Jul 11, 2014 1:23:10 PM org.apache.catalina.loader.WebappClassLoader checkThreadLocalMapForLeaks
SEVERE: The web application [/Server] created a ThreadLocal with key of type [java.lang.ThreadLocal] (value [java.lang.ThreadLocal@1bf7b4f9]) and a value of type [org.apache.logging.log4j.core.async.AsyncLogger.Info] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info@5f90a376]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and avoid a probable memory leak.
Jul 11, 2014 1:23:10 PM org.apache.catalina.loader.WebappClassLoader checkThreadLocalMapForLeaks
SEVERE: The web application [/Server] created a ThreadLocal with key of type [java.lang.ThreadLocal] (value [java.lang.ThreadLocal@1bf7b4f9]) and a value of type [org.apache.logging.log4j.core.async.AsyncLogger.Info] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info@10dbc8fe]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and avoid a probable memory leak.
Jul 11, 2014 1:23:10 PM org.apache.catalina.loader.WebappClassLoader checkThreadLocalMapForLeaks
SEVERE: The web application [/Server] created a ThreadLocal with key of type [java.lang.ThreadLocal] (value [java.lang.ThreadLocal@1bf7b4f9]) and a value of type [org.apache.logging.log4j.core.async.AsyncLogger.Info] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info@4d68a457]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and avoid a probable memory leak.
Jul 11, 2014 1:23:10 PM org.apache.catalina.loader.WebappClassLoader checkThreadLocalMapForLeaks
SEVERE: The web application [/Server] created a ThreadLocal with key of type [java.lang.ThreadLocal] (value [java.lang.ThreadLocal@1bf7b4f9]) and a value of type [org.apache.logging.log4j.core.async.AsyncLogger.Info] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info@10fd7375]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and avoid a probable memory leak.
Jul 11, 2014 1:23:10 PM org.apache.catalina.loader.WebappClassLoader checkThreadLocalMapForLeaks
SEVERE: The web application [/Server] created a ThreadLocal with key of type [java.lang.ThreadLocal] (value [java.lang.ThreadLocal@1bf7b4f9]) and a value of type [org.apache.logging.log4j.core.async.AsyncLogger.Info] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info@6fa70f09]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and avoid a probable memory leak.
Jul 11, 2014 1:23:10 PM org.apache.catalina.loader.WebappClassLoader checkThreadLocalMapForLeaks
SEVERE: The web application [/Server] created a ThreadLocal with key of type [java.lang.ThreadLocal] (value [java.lang.ThreadLocal@1bf7b4f9]) and a value of type [org.apache.logging.log4j.core.async.AsyncLogger.Info] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info@40cc5123]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; and avoid a probable memory leak.
Jul 11, 2014 1:23:13 PM org.apache.catalina.startup.HostConfig undeploy
INFO: Undeploying context [/Server]

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14058659" author="remkop@yahoo.com" created="Fri, 11 Jul 2014 11:25:25 +0000"  >&lt;p&gt;Okay, I will need to investigate again. Thanks for checking!&lt;/p&gt;

&lt;p&gt;By the way, I noticed that you are still combining async loggers with async loggerConfigs. Only one is sufficient.&lt;/p&gt;

&lt;p&gt;If you have AsyncRoot in your log4j2.xml, you can remove the &lt;tt&gt;Log4jContextSelector&lt;/tt&gt; = &lt;tt&gt;org.apache.logging.log4j.core.async.AsyncLoggerContextSelector&lt;/tt&gt; setting from your web.xml&lt;/p&gt;</comment>
                            <comment id="14058665" author="hype" created="Fri, 11 Jul 2014 11:32:17 +0000"  >&lt;p&gt;Remko, thank you very much. You guys are doing a great job!&lt;/p&gt;</comment>
                            <comment id="14058687" author="garydgregory" created="Fri, 11 Jul 2014 11:52:09 +0000"  >&lt;blockquote&gt;
&lt;p&gt;By the way, I noticed that you are still combining async loggers with async loggerConfigs. Only one is sufficient.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=remkop%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;remkop@yahoo.com&quot;&gt;remkop@yahoo.com&lt;/a&gt;: Is this documented on the site? It would be good to know when to use each kind of configuration.&lt;/p&gt;</comment>
                            <comment id="14058705" author="remkop@yahoo.com" created="Fri, 11 Jul 2014 12:16:22 +0000"  >&lt;p&gt;Yes, it is on the Async Loggers page in the &lt;a href=&quot;http://logging.apache.org/log4j/2.x/manual/async.html#AllAsync&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Making All Loggers Asynchronous&lt;/a&gt; section, immediately following the sample config. &lt;/p&gt;</comment>
                            <comment id="14058708" author="garydgregory" created="Fri, 11 Jul 2014 12:21:12 +0000"  >&lt;p&gt;The &quot;Requires disruptor-3.0.0.jar or higher on the classpath.&quot; should be updated to match the version in the POM.&lt;/p&gt;
</comment>
                            <comment id="14143185" author="remkop@yahoo.com" created="Mon, 22 Sep 2014 13:23:36 +0000"  >&lt;p&gt;The full solution for this issue is probably to implement a ref count mechanism in AsyncLogger, similar to what AsyncLoggerConfigHelper currently does. AbstractConfiguration.stop() and .start() can then call AsyncLogger.stop() and .start(). This would also fix &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-493&quot; title=&quot;Problem with AsyncLogger when web app is deployed/undeployed multiple times&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-493&quot;&gt;&lt;del&gt;LOG4J2-493&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Ref count mechanisms are fiddly and easy to get wrong though. An alternative that would just fix this issue (and not &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-493&quot; title=&quot;Problem with AsyncLogger when web app is deployed/undeployed multiple times&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-493&quot;&gt;&lt;del&gt;LOG4J2-493&lt;/del&gt;&lt;/a&gt;) may be to clear the ThreadLocals held by AsyncLogger when stop() is called, and register the background thread ThreadLocal (AsyncLogger#initInfoForExecutorThread) when the AsyncLogger is started.&lt;/p&gt;

&lt;p&gt;I need to look at this some more before I make any changes.&lt;/p&gt;</comment>
                            <comment id="14146168" author="remkop@yahoo.com" created="Wed, 24 Sep 2014 10:16:16 +0000"  >&lt;p&gt;I&apos;ve looked at this and I don&apos;t think it is possible to clear the ThreadLocals held by AsyncLogger. There is no &lt;tt&gt;ThreadLocal.clear()&lt;/tt&gt; method that would remove the data held for all threads, only a &lt;tt&gt;remove&lt;/tt&gt; method that would remove the data held for the current thread.&lt;/p&gt;

&lt;p&gt;So basically this issue depends on the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-493&quot; title=&quot;Problem with AsyncLogger when web app is deployed/undeployed multiple times&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-493&quot;&gt;&lt;del&gt;LOG4J2-493&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Note that there are two workarounds for this issue (similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-493&quot; title=&quot;Problem with AsyncLogger when web app is deployed/undeployed multiple times&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-493&quot;&gt;&lt;del&gt;LOG4J2-493&lt;/del&gt;&lt;/a&gt;):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Put the log4j2 jar files in WEB-INF/lib of your web application.&lt;/li&gt;
	&lt;li&gt;Or: do &lt;em&gt;not&lt;/em&gt; use async loggers by setting system property Log4jContextSelector, instead use async loggers by using &amp;lt;AsyncLogger&amp;gt; and &amp;lt;AsyncRoot&amp;gt; in the configuration.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Either of the above workarounds will prevent the memory leak.&lt;/p&gt;</comment>
                            <comment id="14616394" author="remkop@yahoo.com" created="Tue, 7 Jul 2015 09:10:49 +0000"  >&lt;p&gt;I am thinking we can address this issue by wrapping the &lt;tt&gt;AsyncLogger$Info&lt;/tt&gt; values in a &lt;tt&gt;SoftReference&lt;/tt&gt; before wrapping them in a &lt;tt&gt;ThreadLocal&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;We can replace the existing ThreadLocal with the SoftThreadLocal class I &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12743627/LOG4J2-812-patch.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;proposed&lt;/a&gt; for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-812&quot; title=&quot;Performance optimization: avoid use of synchronized SimpleDateFormat in Dat&#8203;ePatternCo&#8203;nverter &quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-812&quot;&gt;&lt;del&gt;LOG4J2-812&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14632124" author="garydgregory" created="Fri, 17 Jul 2015 23:50:05 +0000"  >&lt;p&gt;Is this something we want in 2.4 or do we need more time to think of a better solution?&lt;/p&gt;</comment>
                            <comment id="14954672" author="jansohn" created="Tue, 13 Oct 2015 09:04:11 +0000"  >&lt;p&gt;There seems to be a regression with v2.4. I&apos;m getting ThreadLocal warnings which I didn&apos;t get with v2.3 (including the log4j JARs in WEB-INF/lib).&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Okt 13, 2015 10:55:19 AM org.apache.catalina.loader.WebappClassLoaderBase clearReferencesThreads
WARNUNG: The web application [webapp] appears to have started a thread named [AsyncLogger-1] but has failed to stop it. This is very likely to create a memory leak. Stack trace of thread:
 sun.misc.Unsafe.park(Native Method)
 java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
 java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)
 com.lmax.disruptor.BlockingWaitStrategy.waitFor(BlockingWaitStrategy.java:45)
 com.lmax.disruptor.ProcessingSequenceBarrier.waitFor(ProcessingSequenceBarrier.java:55)
 com.lmax.disruptor.BatchEventProcessor.run(BatchEventProcessor.java:123)
 java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
 java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
 java.lang.Thread.run(Thread.java:745)
Okt 13, 2015 10:55:19 AM org.apache.catalina.loader.WebappClassLoaderBase checkThreadLocalMapForLeaks
SCHWERWIEGEND: The web application [webapp] created a ThreadLocal with key of type [org.apache.logging.log4j.core.layout.PatternLayout$1] (value [org.apache.logging.log4j.core.layout.PatternLayout$1@cb6ea7]) and a value of type [java.lang.StringBuilder] (value [[2015-10-13T10:55:12,364] INFO  9387[localhost-startStop-1][] - org.hibernate.validator.internal.util.Version.&amp;lt;clinit&amp;gt;(Version.java:17) - HV000001: Hibernate Validator 5.2.1.Final
]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to try and avoid a probable memory leak.
Okt 13, 2015 10:55:19 AM org.apache.catalina.loader.WebappClassLoaderBase checkThreadLocalMapForLeaks
SCHWERWIEGEND: The web application [webapp] created a ThreadLocal with key of type [org.apache.logging.log4j.core.async.AsyncLogger$Info$1] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info$1@136a1c9]) and a value of type [org.apache.logging.log4j.core.async.AsyncLogger.Info] (value [org.apache.logging.log4j.core.async.AsyncLogger$Info@597fb9]) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to try and avoid a probable memory leak.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Should I open a new issue?&lt;/p&gt;</comment>
                            <comment id="14954933" author="remkop@yahoo.com" created="Tue, 13 Oct 2015 13:35:08 +0000"  >&lt;p&gt;Yes, could you raise a separate issue for the regression? Thank you!&lt;/p&gt;</comment>
                            <comment id="14954961" author="garydgregory" created="Tue, 13 Oct 2015 13:57:43 +0000"  >&lt;p&gt;I thought this was fixed in 2.4.1 by &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1142&quot; title=&quot;ThreadLocals in Layout implementations may cause memory leaks in web containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1142&quot;&gt;&lt;del&gt;LOG4J2-1142&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14955025" author="jansohn" created="Tue, 13 Oct 2015 14:25:31 +0000"  >&lt;p&gt;I get the same ThreadLocal warnings with 2.4.1. I&apos;ll open a separate issue with some code to reproduce as soon as I find some spare time.&lt;/p&gt;</comment>
                            <comment id="14955050" author="remkop@yahoo.com" created="Tue, 13 Oct 2015 14:48:10 +0000"  >&lt;p&gt;Gary, &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1142&quot; title=&quot;ThreadLocals in Layout implementations may cause memory leaks in web containers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1142&quot;&gt;&lt;del&gt;LOG4J2-1142&lt;/del&gt;&lt;/a&gt; fixed the ThreadLocal in AbstractStringLayout. I overlooked a similar case that was introduced in AsyncLogger in 2.4.&lt;/p&gt;</comment>
                            <comment id="14956717" author="jansohn" created="Wed, 14 Oct 2015 11:15:25 +0000"  >&lt;p&gt;I opened a new issue for the regression: &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1159&quot; title=&quot;ThreadLocal leaks in Tomcat8 (even if Async Loggers are not used)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1159&quot;&gt;&lt;del&gt;LOG4J2-1159&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14966241" author="remkop@yahoo.com" created="Wed, 21 Oct 2015 04:54:10 +0000"  >&lt;p&gt;Current status (as of Log4j 2.4/2.4.1 - need to check with earlier versions):&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Web application contains the log4j configuration and jar files&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;When configuration file uses AsyncRoot/AsyncLogger: No ThreadLocal or other leaks in Tomcat.&lt;/li&gt;
	&lt;li&gt;When making all loggers async with LoggerContextSelector system property: Tomcat warns at SEVERE level about a ThreadLocal leak (AsyncLogger$Info). Tracked in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1172&quot; title=&quot;ThreadLocal leak [AsyncLogger$Info] on Tomcat when using AsyncLoggerContextSelector&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1172&quot;&gt;&lt;del&gt;LOG4J2-1172&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Web container classpath contains the log4j configuration and jar files&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;When configuration file uses AsyncRoot/AsyncLogger: The first web application starts the Disruptor background thread [AsyncLoggerConfig-1] but does not stop it until all web apps are stopped. Tomcat warns at SEVERE level that &quot;This is very likely to create a memory leak.&quot;  Tracked in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-323&quot; title=&quot;ThreadLocal-leak on tomcat shutdown when using async logging&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-323&quot;&gt;&lt;del&gt;LOG4J2-323&lt;/del&gt;&lt;/a&gt; (this issue).&lt;/li&gt;
	&lt;li&gt;When making all loggers async with LoggerContextSelector system property: The first web application starts the Disruptor background thread [AsyncLogger-1]. Logging works until the first web app (which can be any web app) is stopped and the Disruptor is shut down. After that logging no longer works. Log4jServletContainerInitializer and Log4jWebInitializerImpl try to start but fail to initialize a logger context. This is the case even if the &lt;tt&gt;log4jConfiguration&lt;/tt&gt; context parameter is set and correctly recognized. Tracked in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-493&quot; title=&quot;Problem with AsyncLogger when web app is deployed/undeployed multiple times&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-493&quot;&gt;&lt;del&gt;LOG4J2-493&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14971360" author="remkop@yahoo.com" created="Fri, 23 Oct 2015 17:00:55 +0000"  >&lt;p&gt;Fixed the memory leak that occurred when the logging jars are placed in the container&apos;s classpath and the configuration file uses AsyncRoot/AsyncLogger.&lt;/p&gt;

&lt;p&gt;The problem was that the first web application started the Disruptor background thread &lt;span class=&quot;error&quot;&gt;&amp;#91;AsyncLoggerConfig-1&amp;#93;&lt;/span&gt; but did not stop it until all web apps are stopped. Tomcat warns at SEVERE level that &quot;This is very likely to create a memory leak.&quot;&lt;/p&gt;

&lt;p&gt;Each web application now has its own Disruptor which is stopped/started together with the web app.&lt;/p&gt;

&lt;p&gt;Fixed in master in commit 0812a679.&lt;/p&gt;

&lt;p&gt;I created a separate ticket &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1172&quot; title=&quot;ThreadLocal leak [AsyncLogger$Info] on Tomcat when using AsyncLoggerContextSelector&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1172&quot;&gt;&lt;del&gt;LOG4J2-1172&lt;/del&gt;&lt;/a&gt; to track the remaining ThreadLocal leak.&lt;/p&gt;</comment>
                            <comment id="14973563" author="remkop@yahoo.com" created="Mon, 26 Oct 2015 02:18:49 +0000"  >&lt;p&gt;Quick summary of the AsyncLoggerConfig redesign (these are similar in principle to the &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-493?focusedCommentId=14969000&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14969000&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;changes for AsyncLogger&lt;/a&gt; but affect different classes.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The Disruptor is no longer a singleton: each AsyncLoggerConfigHelper instance has a separate Disruptor instance.&lt;/li&gt;
	&lt;li&gt;This Helper is no longer counting references. Starting/stopping a AsyncLoggerConfigHelper will start/stop its Disruptor.&lt;/li&gt;
	&lt;li&gt;AsyncLoggerConfig objects in the same configuration use the same shared AsyncLoggerConfigHelper instance. They obtain it from the Configuration in their constructor.&lt;/li&gt;
	&lt;li&gt;AbstractConfiguration creates and owns an AsyncLoggerConfigHelper (only if necessary - if it detects at least one AsyncLoggerConfig among its LoggerConfigs).&lt;/li&gt;
	&lt;li&gt;Deploying/undeploying a web app will start/stop its Configuration, which starts/stops its AsyncLoggerConfigHelper, which starts/stops its Disruptor.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12673743">LOG4J2-425</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12907475">LOG4J2-1172</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12688172">LOG4J2-493</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12907281">LOG4J2-1171</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13326345">LOG4J2-2919</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                                                <inwardlinks description="is superceded by">
                                        <issuelink>
            <issuekey id="12904828">LOG4J2-1159</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>340482</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 4 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1mq27:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>340800</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>