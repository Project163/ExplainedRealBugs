<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:37:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1457] Class loader deadlock when using async logging and extended stack trace pattern</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1457</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;We&apos;ve encountered a class loading deadlock. Please review attached thread dump. Is it possible to have an option of pre-initializing the exception&apos;s thread stack on the caller&apos;s thread? It&apos;s hard to predict what libraries are doing in their classes&apos; static initializers and may eventually end up logging and causing deadlock.&lt;/p&gt;

&lt;p&gt;In the attached thread dump here are the threads of interest:&lt;br/&gt;
&quot;Log4j2-AsyncLogger&lt;span class=&quot;error&quot;&gt;&amp;#91;AsyncContext@18b4aac2&amp;#93;&lt;/span&gt;1&quot; #16 daemon prio=5 os_prio=0 tid=0x00007ff870c7b000 nid=0x79f3 in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007ff839142000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;br/&gt;
        at java.lang.Class.forName0(Native Method)&lt;br/&gt;
...&lt;br/&gt;
and&lt;br/&gt;
&quot;1A03340:Company:japan&quot; #568 prio=5 os_prio=0 tid=0x00007ff871677000 nid=0x725 runnable &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007ff74bd27000&amp;#93;&lt;/span&gt;&lt;br/&gt;
...&amp;lt;clinit&amp;gt;...&lt;/p&gt;</description>
                <environment>&lt;p&gt;On CentOS 6.7 and Java 1.8.0_60.&lt;/p&gt;</environment>
        <key id="12987175">LOG4J2-1457</key>
            <summary>Class loader deadlock when using async logging and extended stack trace pattern</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mattsicker">Matt Sicker</assignee>
                                    <reporter username="leonfin">Leon Finker</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Jul 2016 14:52:42 +0000</created>
                <updated>Thu, 8 Sep 2016 17:19:37 +0000</updated>
                            <resolved>Thu, 8 Sep 2016 15:30:57 +0000</resolved>
                                    <version>2.6.1</version>
                                    <fixVersion>2.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15364522" author="ralph.goers@dslextreme.com" created="Wed, 6 Jul 2016 16:04:20 +0000"  >&lt;p&gt;The workaround for this would be to modify your pattern layout configuration to not use the extended stack trace and just use %ex. This will mean you won&apos;t get the extra information on what jar file and version are being used but it should be faster and will not try to load the classes.&lt;/p&gt;

&lt;p&gt;In looking at the thread dump I can&apos;t tell what thread got the exception that is being logged or what classes are involved. The only clue I can find is that there are several runnable threads doing:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
	at x.core.services.x.GemFirexMapEntryFactory.createValue(GemFirexMapEntryFactory.java:22)
	at com.x.x.persistence.map.MapHandler.toValue(MapHandler.java:118)
	at com.x.x.persistence.map.cache.CachedStructure.put(CachedStructure.java:148)
	at com.x.x.persistence.map.cache.CachedMapPersister.persist(CachedMapPersister.java:110)
	at com.x.x.persistence.map.ManagedPersister.persist(ManagedPersister.java:121)
	at com.x.x.dispatcher.GuaranteedDispatcher.dispatch(GuaranteedDispatcher.java:114)
	at com.x.x.prosumer.SubjectProducerDelegate.send(SubjectProducerDelegate.java:220)
	at com.x.x.prosumer.SubjectProducerDelegate.send(SubjectProducerDelegate.java:204)
	at com.x.x.prosumer.SubjectProducerDelegate.send(SubjectProducerDelegate.java:184)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since I don&apos;t have access to that code I can&apos;t really say what might be going on. Do you have the ability to see what the getValue method might be doing?&lt;/p&gt;

&lt;p&gt;One possible way to try to fix this would be to not delegate to an async logger if the logging call includes an exception. However, I am not sure why that wouldn&apos;t just then block in the thread where the exception is thrown - unless the cause of this is that the async logger threads are using a different class loader than the application that threw the exception. All the classes involved in the exception should have already been loaded by the class loader - unless there is something wrong with the class and the exception being thrown has to do with loading it.&lt;/p&gt;</comment>
                            <comment id="15364613" author="leonfin" created="Wed, 6 Jul 2016 16:50:03 +0000"  >&lt;p&gt;Yes it looks like many of those threads are locked on the class loader in GemFirexMapEntryFactory.createValue. Because they all say    java.lang.Thread.State: RUNNABLE, but in Object.wait(). And the code in that method creates the class that has the &amp;lt;clinit&amp;gt;:&lt;br/&gt;
at x.core.services.x.GemFirexMapEntryFactory.createValue(GemFirexMapEntryFactory.java:22)&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; @Override
    public MapValue createValue(byte[] value) {
        if (value == null) {
            throw new IllegalArgumentException(&quot;value is null&quot;);
        }
        return new xMessageWrapper(value);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And the xMessageWrapper has the static initializer that is deadlocked on waiting for the disruptor available slot:&lt;br/&gt;
	at tradingscreen.core.services.tube.xMessageWrapper.&amp;lt;clinit&amp;gt;(xMessageWrapper.java:31)&lt;/p&gt;

&lt;p&gt;This one caused the exception to be logged at warning. But the log event didn&apos;t make it to the disruptor buffer yet from the callstack:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   java.lang.Thread.State: TIMED_WAITING (parking)
	at sun.misc.Unsafe.park(Native Method)
	at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:338)
	at com.lmax.disruptor.MultiProducerSequencer.next(MultiProducerSequencer.java:136)
	at com.lmax.disruptor.MultiProducerSequencer.next(MultiProducerSequencer.java:105)
	at com.lmax.disruptor.RingBuffer.publishEvent(RingBuffer.java:450)
	at com.lmax.disruptor.dsl.Disruptor.publishEvent(Disruptor.java:315)
	at org.apache.logging.log4j.core.async.AsyncLoggerDisruptor.enqueueLogMessageInfo(AsyncLoggerDisruptor.java:203)
	at org.apache.logging.log4j.core.async.AsyncLogger.handleRingBufferFull(AsyncLogger.java:170)
	at org.apache.logging.log4j.core.async.AsyncLogger.publish(AsyncLogger.java:162)
	at org.apache.logging.log4j.core.async.AsyncLogger.logWithThreadLocalTranslator(AsyncLogger.java:157)
	at org.apache.logging.log4j.core.async.AsyncLogger.logMessage(AsyncLogger.java:127)
	at org.apache.logging.log4j.spi.ExtendedLoggerWrapper.logMessage(ExtendedLoggerWrapper.java:217)
	at org.apache.logging.log4j.spi.AbstractLogger.logIfEnabled(AbstractLogger.java:1827)
	at org.apache.logging.log4j.spi.AbstractLogger.warn(AbstractLogger.java:2505)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So still not sure why it deadlocks.&lt;/p&gt;</comment>
                            <comment id="15364804" author="ralph.goers@dslextreme.com" created="Wed, 6 Jul 2016 18:21:20 +0000"  >&lt;p&gt;I found &lt;a href=&quot;https://bugs.openjdk.java.net/browse/JDK-8072592&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugs.openjdk.java.net/browse/JDK-8072592&lt;/a&gt;, but you have indicated in the email thread that you do not create any custom ClassLoaders and are only using the standard ClassLoaders provided by the JVM.&lt;/p&gt;

&lt;p&gt;I am thinking that for the extended stack trace to work, these classes need to be resolved before control is passed to the AsyncLogger.&lt;/p&gt;</comment>
                            <comment id="15364943" author="leonfin" created="Wed, 6 Jul 2016 19:32:47 +0000"  >&lt;p&gt;Any reason that we need to run the class initializer for the extended logging info? Based on the JDK-8072592, why not pass false for initialize parameter to:&lt;br/&gt;
at java.lang.Class.forName(Class.java:348)&lt;br/&gt;
at org.apache.logging.log4j.core.util.Loader.initializeClass(Loader.java:241)&lt;/p&gt;
</comment>
                            <comment id="15364978" author="ralph.goers@dslextreme.com" created="Wed, 6 Jul 2016 20:03:14 +0000"  >&lt;p&gt;That is a very good observation.  Do you think you could make a local modification to do that and see if the problem goes away?&lt;/p&gt;</comment>
                            <comment id="15365057" author="leonfin" created="Wed, 6 Jul 2016 20:51:47 +0000"  >&lt;p&gt;I was able to reproduce it consistently in debugger. I&apos;ve set a conditional breakpoint in:&lt;br/&gt;
	at org.apache.logging.log4j.core.util.Loader.initializeClass(Loader.java:241)&lt;br/&gt;
The condition being that the className.contains the class name that has the static initializer.&lt;/p&gt;

&lt;p&gt;Another breakpoint was in the static initializer of the class in question. I also added a for loop to make sure to fill up the disruptor buffer from initializer (-DAsyncLogger.RingBufferSize=512):&lt;br/&gt;
 static {&lt;br/&gt;
        Exception e = new Exception();&lt;br/&gt;
        for(int i =0; i&amp;lt;1024; ++i) &lt;/p&gt;
{
            logger.error(e);
        }
&lt;p&gt;    }&lt;br/&gt;
For the logger was carefull not to specify the class name in question, but simply:&lt;br/&gt;
private static Logger logger = Logger.getLogger(&quot;test&quot;);&lt;/p&gt;

&lt;p&gt;Once the breakpoint in class static initializer was hit, I let it log the exception once and kept it suspended. This caused the breakpoint in initializeClass to be hit. I kept it suspended. I then switched back to the thread with static initializer and let it go through the loop. This filled up the buffer and blocked the class initializer. I then resumed the thread with initializeClass. They have both deadlocked.&lt;/p&gt;

&lt;p&gt;Then I have made local log4j2 changes to load class without initializer. The deadlock doesn&apos;t happen any longer. So this does solve the issue. Even if the other thread is still in breakpoint in class initializer, the call to Class.forName(className, false, loader); still succeeds and doesn&apos;t block anymore.&lt;/p&gt;

&lt;p&gt;I now realize what caused the bug to show up. Apparently there were two exceptions logged from the static initializer and the second exception log happened just at the time when the ring buffer was full. This caused the deadlock.&lt;/p&gt;
</comment>
                            <comment id="15368535" author="leonfin" created="Fri, 8 Jul 2016 21:39:35 +0000"  >&lt;p&gt;To summarize, the only request out of this jira is to change the initialize parameter to false to solve class loader deadlock problems with async logging and concurrent logging from class&apos; static initializer:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;public final class Loader {
     public static Class&amp;lt;?&amp;gt; initializeClass(final String className, final ClassLoader loader)
             throws ClassNotFoundException {
-        return Class.forName(className, true, loader);
+        return Class.forName(className, false, loader);
     }

     public static Class&amp;lt;?&amp;gt; loadSystemClass(final String className) throws ClassNotFoundException {
         try {
-            return Class.forName(className, true, ClassLoader.getSystemClassLoader());
+            return Class.forName(className, false, ClassLoader.getSystemClassLoader());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15369313" author="garydgregory" created="Sat, 9 Jul 2016 22:04:19 +0000"  >&lt;p&gt;Hi Leon,&lt;/p&gt;

&lt;p&gt;Have you tried running all tests with &lt;tt&gt;mvn clean test&lt;/tt&gt; to make sure all tests pass?&lt;/p&gt;

&lt;p&gt;Gary&lt;/p&gt;</comment>
                            <comment id="15370154" author="leonfin" created="Mon, 11 Jul 2016 04:36:49 +0000"  >&lt;p&gt;Hi Gary,&lt;/p&gt;

&lt;p&gt;With the change, all tests succeed except one: org.apache.logging.log4j.core.ExtendedLevelTest (the levels are part of c;ass static initializer that must run).&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Expected: a collection with size &amp;lt;1&amp;gt;
     but: collection size was &amp;lt;0&amp;gt;
	at org.apache.logging.log4j.core.ExtendedLevelTest.testLevelLogging(ExtendedLevelTest.java:58).testLevelLogging:58
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It&apos;s because Loader.initializeClass is also called as part of configuration initialization for example. In that case we do want to run the class static initializer. We only don&apos;t want to run it when extended stack is being created for logging (of user classes).&lt;/p&gt;

&lt;p&gt;So in this case we do want to run static initializer:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.logging.log4j.core.util.Loader.initializeClass(java.lang.String, java.lang.ClassLoader) line: 241	
org.apache.logging.log4j.core.config.xml.XmlConfiguration(org.apache.logging.log4j.core.config.AbstractConfiguration).initialize() line: 210	
org.apache.logging.log4j.core.config.xml.XmlConfiguration(org.apache.logging.log4j.core.config.AbstractConfiguration).start() line: 231	
org.apache.logging.log4j.core.LoggerContext.setConfiguration(org.apache.logging.log4j.core.config.Configuration) line: 496	
org.apache.logging.log4j.core.LoggerContext.start(org.apache.logging.log4j.core.config.Configuration) line: 249	
org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(java.lang.String, java.lang.ClassLoader, java.lang.Object, boolean, java.net.URI, java.lang.String) line: 239	
org.apache.logging.log4j.core.config.Configurator.initialize(java.lang.String, java.lang.ClassLoader, java.net.URI, java.lang.Object) line: 157	
org.apache.logging.log4j.core.config.Configurator.initialize(java.lang.String, java.lang.ClassLoader, java.lang.String, java.lang.Object) line: 130	
org.apache.logging.log4j.core.config.Configurator.initialize(java.lang.String, java.lang.ClassLoader, java.lang.String) line: 100	
org.apache.logging.log4j.junit.LoggerContextRule$1.evaluate() line: 92	
org.junit.rules.RunRules.evaluate() line: 20	
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;But in this case must not run the static initializer of user classes that are part of the exceptions:&lt;/p&gt;

&lt;p&gt;&quot;Log4j2-AsyncLogger&lt;span class=&quot;error&quot;&gt;&amp;#91;AsyncContext@18b4aac2&amp;#93;&lt;/span&gt;1&quot; #16 daemon prio=5 os_prio=0 tid=0x00007ff870c7b000 nid=0x79f3 in Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007ff839142000&amp;#93;&lt;/span&gt;   java.lang.Thread.State: RUNNABLE&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;	at java.lang.Class.forName0(Native Method)
	at java.lang.Class.forName(Class.java:348)
	at org.apache.logging.log4j.core.util.Loader.initializeClass(Loader.java:241)
	at org.apache.logging.log4j.core.impl.ThrowableProxy.loadClass(ThrowableProxy.java:487)
	at org.apache.logging.log4j.core.impl.ThrowableProxy.toExtendedStackTrace(ThrowableProxy.java:617)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15371040" author="leonfin" created="Mon, 11 Jul 2016 15:57:08 +0000"  >&lt;p&gt;Proposing only the following changes. Basically, add an argument to Loader.initializeClass(...boolean initialize...). And call it with false from ThrowableProxy use case. All tests succeed. &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; .../src/main/java/org/apache/logging/log4j/core/util/Loader.java      | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git c/log4j-core/src/main/java/org/apache/logging/log4j/core/util/Loader.java w/log4j-core/src/main/java/org/apache/logging/log4j/core/util/Loader.java
index bb35752..5670f63 100644
--- c/log4j-core/src/main/java/org/apache/logging/log4j/core/util/Loader.java
+++ w/log4j-core/src/main/java/org/apache/logging/log4j/core/util/Loader.java
@@ -236,9 +236,9 @@ public final class Loader {
      * @return The class.
      * @throws ClassNotFoundException if the class could not be found.
      */
-    public static Class&amp;lt;?&amp;gt; initializeClass(final String className, final ClassLoader loader)
+    public static Class&amp;lt;?&amp;gt; initializeClass(final String className, boolean initialize, final ClassLoader loader)
             throws ClassNotFoundException {
-        return Class.forName(className, true, loader);
+        return Class.forName(className, initialize, loader);
     }
 
     /**
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; .../org/apache/logging/log4j/core/config/AbstractConfiguration.java     | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git c/log4j-core/src/main/java/org/apache/logging/log4j/core/config/AbstractConfiguration.java w/log4j-core/src/main/java/org/apache/logging/log4j/core/config/AbstractConfiguration.java
index a152ea7..6acf3b8 100644
--- c/log4j-core/src/main/java/org/apache/logging/log4j/core/config/AbstractConfiguration.java
+++ w/log4j-core/src/main/java/org/apache/logging/log4j/core/config/AbstractConfiguration.java
@@ -207,7 +207,7 @@ public abstract class AbstractConfiguration extends AbstractFilterable implement
             for (final PluginType&amp;lt;?&amp;gt; type : plugins.values()) {
                 try {
                     // Cause the class to be initialized if it isn&apos;t already.
-                    Loader.initializeClass(type.getPluginClass().getName(), type.getPluginClass().getClassLoader());
+                    Loader.initializeClass(type.getPluginClass().getName(), true, type.getPluginClass().getClassLoader());
                 } catch (final Exception e) {
                     LOGGER.error(&quot;Unable to initialize {} due to {}&quot;, type.getPluginClass().getName(), e.getClass()
                             .getSimpleName(), e);

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; .../main/java/org/apache/logging/log4j/core/impl/ThrowableProxy.java  | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git c/log4j-core/src/main/java/org/apache/logging/log4j/core/impl/ThrowableProxy.java w/log4j-core/src/main/java/org/apache/logging/log4j/core/impl/ThrowableProxy.java
index 28f8e56..6133d7a 100644
--- c/log4j-core/src/main/java/org/apache/logging/log4j/core/impl/ThrowableProxy.java
+++ w/log4j-core/src/main/java/org/apache/logging/log4j/core/impl/ThrowableProxy.java
@@ -484,7 +484,7 @@ public class ThrowableProxy implements Serializable {
         Class&amp;lt;?&amp;gt; clazz;
         if (lastLoader != null) {
             try {
-                clazz = Loader.initializeClass(className, lastLoader);
+                clazz = Loader.initializeClass(className, false, lastLoader);
                 if (clazz != null) {
                     return clazz;
                 }
@@ -504,7 +504,7 @@ public class ThrowableProxy implements Serializable {
 
     private Class&amp;lt;?&amp;gt; initializeClass(final String className) {
         try {
-            return Loader.initializeClass(className, this.getClass().getClassLoader());
+            return Loader.initializeClass(className, false, this.getClass().getClassLoader());
         } catch (final ClassNotFoundException ignore) {
             return null;
         } catch (final NoClassDefFoundError ignore) {

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15371261" author="garydgregory" created="Mon, 11 Jul 2016 17:41:35 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=leonfin&quot; class=&quot;user-hover&quot; rel=&quot;leonfin&quot;&gt;leonfin&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Can you provide a patch file including a unit test? That might be tricky I know due to how Maven deals with classpaths.&lt;/p&gt;

&lt;p&gt;Thank you,&lt;br/&gt;
Gary&lt;/p&gt;</comment>
                            <comment id="15371375" author="jvz" created="Mon, 11 Jul 2016 18:36:13 +0000"  >&lt;p&gt;Doesn&apos;t Loader.loadClass() do the same thing as using false in Class.forName()?&lt;/p&gt;</comment>
                            <comment id="15371540" author="leonfin" created="Mon, 11 Jul 2016 20:23:36 +0000"  >&lt;p&gt;Loader.loadClass() could call Class.forName(className), which is equivalent to Class.forName(className, true, currentLoader). &lt;/p&gt;

&lt;p&gt;Or Loader.loadClass could call getThreadContextClassLoader().loadClass(className), which ends up in ClassLoader:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; protected Class&amp;lt;?&amp;gt; loadClass(String name, boolean resolve)
        throws ClassNotFoundException
    {
        synchronized (getClassLoadingLock(name)) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That should also deadlock the same since it wants to acquire the class loader+name lock.&lt;/p&gt;</comment>
                            <comment id="15371716" author="leonfin" created="Mon, 11 Jul 2016 21:57:07 +0000"  >&lt;p&gt;Hi Gary, please review &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1457&quot; title=&quot;Class loader deadlock when using async logging and extended stack trace pattern&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1457&quot;&gt;&lt;del&gt;LOG4J2-1457&lt;/del&gt;&lt;/a&gt;.patch&lt;br/&gt;
Thank you&lt;/p&gt;</comment>
                            <comment id="15371766" author="jvz" created="Mon, 11 Jul 2016 22:18:48 +0000"  >&lt;p&gt;I think it would make more sense to make a separate method in Loader (or LoaderUtil in log4j-api) for this. Something like &lt;tt&gt;lazyLoadClass&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15371899" author="ralph.goers@dslextreme.com" created="Mon, 11 Jul 2016 23:35:49 +0000"  >&lt;p&gt;The patch looks fine to me. I don&apos;t think a separate method is warranted given how infrequently it is called. &lt;/p&gt;</comment>
                            <comment id="15371962" author="jvz" created="Tue, 12 Jul 2016 00:23:01 +0000"  >&lt;p&gt;Now that I look more closely, the only place calling with true instead of false could most likely work with false as well. I don&apos;t see why AbstractConfiguration needs to make sure classes are initialized as that will happen as soon as we call &lt;tt&gt;newInstance()&lt;/tt&gt; anyways during configuration parsing.&lt;/p&gt;</comment>
                            <comment id="15372003" author="remkop@yahoo.com" created="Tue, 12 Jul 2016 01:00:30 +0000"  >&lt;p&gt;Very nice detective work on the deadlock, Leon! Thumbs up!&lt;/p&gt;

&lt;p&gt;Question following up on Matt&apos;s comment: is there anything that could go wrong if you load a class without initializing it? As Matt pointed out, my understanding is also that the class would auto-initialize when an instance is created or a static method is called or any of the other conditions for initialization is met...&lt;/p&gt;</comment>
                            <comment id="15372064" author="leonfin" created="Tue, 12 Jul 2016 02:15:30 +0000"  >&lt;p&gt;Yes that&apos;s what I tried at first. But then this test failed:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Expected: a collection with size &amp;lt;1&amp;gt;
     but: collection size was &amp;lt;0&amp;gt;
	at org.apache.logging.log4j.core.ExtendedLevelTest.testLevelLogging(ExtendedLevelTest.java:58).testLevelLogging:58
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The stack trace that leads to the class load is:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        at org.apache.logging.log4j.core.util.Loader.initializeClass(Loader.java:242)
        at org.apache.logging.log4j.core.config.AbstractConfiguration.initialize(AbstractConfiguration.java:210)
        at org.apache.logging.log4j.core.config.AbstractConfiguration.start(AbstractConfiguration.java:231)
        at org.apache.logging.log4j.core.LoggerContext.setConfiguration(LoggerContext.java:496)
        at org.apache.logging.log4j.core.LoggerContext.start(LoggerContext.java:249)
        at org.apache.logging.log4j.core.impl.Log4jContextFactory.getContext(Log4jContextFactory.java:239)
        at org.apache.logging.log4j.core.config.Configurator.initialize(Configurator.java:158)
        at org.apache.logging.log4j.core.config.Configurator.initialize(Configurator.java:130)
        at org.apache.logging.log4j.core.config.Configurator.initialize(Configurator.java:100)
        at org.apache.logging.log4j.junit.LoggerContextRule$1.evaluate(LoggerContextRule.java:92)
        at org.junit.rules.RunRules.evaluate(RunRules.java:20)
        at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The call is to load the plugins:&lt;br/&gt;
Loader.initializeClass(type.getPluginClass().getName(), type.getPluginClass().getClassLoader());&lt;br/&gt;
...&lt;br/&gt;
Specifically this plugin for the test:&lt;br/&gt;
PluginType &lt;span class=&quot;error&quot;&gt;&amp;#91;pluginClass=class org.apache.logging.log4j.test.ExtendedLevels, key=extendedlevel, elementName=ExtendedLevel, isObjectPrintable=false, isDeferChildren==false, category=level&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;ExtendedLevels class declares few static fields as Levels. So unless static initializer runs for ExtendedLevels, the test will not work. The @Plugin annotated classes are auto processed. &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;@Plugin(name=&quot;ExtendedLevel&quot;, category=&quot;Level&quot;)
public class ExtendedLevels {

    public static final Level NOTE = Level.forName(&quot;NOTE&quot;, 350);
    public static final Level DETAIL = Level.forName(&quot;DETAIL&quot;, 450);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15372135" author="jvz" created="Tue, 12 Jul 2016 03:45:08 +0000"  >&lt;p&gt;I don&apos;t think that unit test is correct. The &lt;a href=&quot;https://logging.apache.org/log4j/2.x/manual/customloglevels.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;documentation&lt;/a&gt; for custom log levels shows that you have to include it in the config file, but this test relies on the class being initialized in order to add the custom levels instead of referencing the plugin elements.&lt;/p&gt;</comment>
                            <comment id="15383307" author="remkop@yahoo.com" created="Mon, 18 Jul 2016 23:45:07 +0000"  >&lt;p&gt;I assume we want to include this in the next release so I&apos;ve set the fix version. Who will take care of this one?&lt;/p&gt;</comment>
                            <comment id="15383339" author="jvz" created="Tue, 19 Jul 2016 00:07:29 +0000"  >&lt;p&gt;Well, I&apos;ve got a decent idea on how to fix that test, and the patch itself is pretty easy to integrate at that point (flipping the boolean in &lt;tt&gt;initializeClass()&lt;/tt&gt;. I can probably handle it within the next couple days.&lt;/p&gt;</comment>
                            <comment id="15427455" author="remkop@yahoo.com" created="Fri, 19 Aug 2016 01:26:37 +0000"  >&lt;p&gt;If this has been addressed, can we mark it as Resolved?&lt;/p&gt;</comment>
                            <comment id="15466930" author="remkop@yahoo.com" created="Tue, 6 Sep 2016 09:21:59 +0000"  >&lt;p&gt;What is the status of this issue?&lt;/p&gt;</comment>
                            <comment id="15467880" author="leonfin" created="Tue, 6 Sep 2016 16:39:27 +0000"  >&lt;p&gt;The fix is pretty simple either with patch attached, or as Matt suggested to fix one unit test and flip the boolean passed to initializeClass. &lt;/p&gt;</comment>
                            <comment id="15473951" author="leonfin" created="Thu, 8 Sep 2016 14:05:11 +0000"  >&lt;p&gt;Matt, can this make it into 2.7? &lt;/p&gt;</comment>
                            <comment id="15474007" author="jvz" created="Thu, 8 Sep 2016 14:27:58 +0000"  >&lt;p&gt;Yeah, I&apos;ll take a look at this again today.&lt;/p&gt;</comment>
                            <comment id="15474097" author="jvz" created="Thu, 8 Sep 2016 15:04:13 +0000"  >&lt;p&gt;Taking a closer look at this issue again, I could simply remove the initialization of custom log level plugins ahead of time as the documentation states that you need to specify them in your log4j config file anyways.&lt;/p&gt;

&lt;p&gt;Edit: wait, I have this backwards. That&apos;s the code that can remain unchanged.&lt;/p&gt;</comment>
                            <comment id="15474173" author="jvz" created="Thu, 8 Sep 2016 15:30:57 +0000"  >&lt;p&gt;I&apos;ve added your unit tests along with a simpler fix in ThrowableProxy to the master branch in commit 284067cbdb5f13c41225e22c2a60d79cd43f1383. Please verify and close.&lt;/p&gt;</comment>
                            <comment id="15474441" author="leonfin" created="Thu, 8 Sep 2016 17:11:41 +0000"  >&lt;p&gt;Confirmed. NOTE: now that log42 is using DefaultAsyncQueueFullPolicy with EventRoute.SYNCHRONOUS, the deadlock will not happen in any case. In order to reproduce one would have to use EventRoute.ENQUEUE, with which I tested this fix. Before this fix deadlock happens. After this fix deadlock doesn&apos;t happen.&lt;/p&gt;</comment>
                            <comment id="15474457" author="jvz" created="Thu, 8 Sep 2016 17:19:37 +0000"  >&lt;p&gt;Thanks for the confirmation and the help fixing this!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12817270" name="LOG4J2-1457.patch" size="8314" author="leonfin" created="Mon, 11 Jul 2016 21:57:07 +0000"/>
                            <attachment id="12816437" name="threaddump.txt" size="833860" author="leonfin" created="Wed, 6 Jul 2016 14:56:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 10 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30llb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>