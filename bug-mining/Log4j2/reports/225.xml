<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:32:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-377] NPE during shutdown.</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-377</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;NPE in Log4j2-core during shutdown.&lt;/p&gt;

&lt;p&gt;g! Exception in thread &quot;Thread-2&quot; java.lang.NullPointerException&lt;br/&gt;
	at org.apache.felix.framework.BundleWiringImpl.diagnoseClassLoadError(BundleWiringImpl.java:2625)&lt;br/&gt;
	at org.apache.felix.framework.BundleWiringImpl.access$700(BundleWiringImpl.java:75)&lt;br/&gt;
	at org.apache.felix.framework.BundleWiringImpl$BundleClassLoader.loadClass(BundleWiringImpl.java:1967)&lt;br/&gt;
	at java.lang.ClassLoader.loadClass(ClassLoader.java:247)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:210)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:437)&lt;br/&gt;
Exception in thread &quot;Thread-6&quot; java.lang.NullPointerException&lt;br/&gt;
	at org.apache.felix.framework.BundleWiringImpl.diagnoseClassLoadError(BundleWiringImpl.java:2625)&lt;br/&gt;
	at org.apache.felix.framework.BundleWiringImpl.access$700(BundleWiringImpl.java:75)&lt;br/&gt;
	at org.apache.felix.framework.BundleWiringImpl$BundleClassLoader.loadClass(BundleWiringImpl.java:1967)&lt;br/&gt;
	at java.lang.ClassLoader.loadClass(ClassLoader.java:247)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:210)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:437)&lt;/p&gt;

&lt;p&gt;It&apos;s a ClassLoader-issue. I guess that log4j2-core uses the bootstrap-classloader but not the bundle-classloaer.&lt;/p&gt;</description>
                <environment>&lt;p&gt;OSGi R5 / R4 (Apache Felix 4.x)&lt;/p&gt;</environment>
        <key id="12665901">LOG4J2-377</key>
            <summary>NPE during shutdown.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rol">Roland Weiglhofer</reporter>
                        <labels>
                    </labels>
                <created>Wed, 28 Aug 2013 11:39:23 +0000</created>
                <updated>Sun, 5 Jan 2014 22:47:46 +0000</updated>
                            <resolved>Sun, 5 Jan 2014 21:26:17 +0000</resolved>
                                    <version>2.0-beta9</version>
                                    <fixVersion>2.0-rc1</fixVersion>
                    <fixVersion>2.0</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13752325" author="rol" created="Wed, 28 Aug 2013 12:08:32 +0000"  >&lt;p&gt;... or the class loader is not checked for null (e.g. in the LogManager line 59).&lt;/p&gt;</comment>
                            <comment id="13752334" author="rol" created="Wed, 28 Aug 2013 12:14:22 +0000"  >&lt;p&gt;(Addendum: Null-checks are required because the bootstrap classloader is often defined as null. See javadoc for getClassLoader() )&lt;/p&gt;</comment>
                            <comment id="13754634" author="rol" created="Fri, 30 Aug 2013 12:20:12 +0000"  >&lt;p&gt;I have seen the issue again in my logfiles. But this time with a slightly different trace.&lt;/p&gt;

&lt;p&gt;This sounds very interesting:&lt;br/&gt;
Caused by: java.lang.ClassNotFoundException: Unable to load class &apos;org.apache.logging.log4j.core.config.NullConfiguration&apos; Because The bundle wiring for org.apache.logging.log4j api is no longer valid.&lt;br/&gt;
Wires are between resolved dependent bundles. If one bundle is stopped the wire is invalid. The OSGi-container stopps bundles in order of their dependencies. Could it be that some dependency-definitions are missing in the POMs? Could it be that the core holds an unreleased zombie-instance of a classloader and tries to instanciate something which is no longer in the classpath because the provider bundle is stopped? I don&apos;t know what is going on, but thinking out loud.&lt;/p&gt;

&lt;p&gt;g! Exception in thread &quot;Thread-6&quot; java.lang.NoClassDefFoundError: org/apache/logging/log4j/core/config/NullConfiguration&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:210)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:437)&lt;br/&gt;
Caused by: java.lang.ClassNotFoundException: Unable to load class &apos;org.apache.logging.log4j.core.config.NullConfiguration&apos; because the bundle wiring for org.apache.logging.log4j-api is no longer valid.&lt;br/&gt;
	at org.apache.felix.framework.BundleWiringImpl.findClassOrResourceByDelegation(BundleWiringImpl.java:1494)&lt;br/&gt;
	at org.apache.felix.framework.BundleWiringImpl.access$400(BundleWiringImpl.java:75)&lt;br/&gt;
	at org.apache.felix.framework.BundleWiringImpl$BundleClassLoader.loadClass(BundleWiringImpl.java:1955)&lt;br/&gt;
	at java.lang.ClassLoader.loadClass(ClassLoader.java:247)&lt;br/&gt;
	... 2 more&lt;br/&gt;
Exception in thread &quot;Thread-2&quot; java.lang.NoClassDefFoundError: org/apache/logging/log4j/core/config/NullConfiguration&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext.stop(LoggerContext.java:210)&lt;br/&gt;
	at org.apache.logging.log4j.core.LoggerContext$ShutdownThread.run(LoggerContext.java:437)&lt;/p&gt;</comment>
                            <comment id="13754773" author="ralph.goers@dslextreme.com" created="Fri, 30 Aug 2013 15:09:06 +0000"  >&lt;p&gt;I&apos;m not sure what is going on there but the easy way to address this would be to declare a static Configuration in LoggerContext that is set to a NullConfiguration. Then during stop instead of doing a new just set the configuration to point to the static NullConfiguration.  &lt;/p&gt;

&lt;p&gt;Is it possible you could give that a try and see if it solves the problem?&lt;/p&gt;</comment>
                            <comment id="13757863" author="rol" created="Wed, 4 Sep 2013 15:20:07 +0000"  >&lt;p&gt;Hello Ralph,&lt;br/&gt;
I added the NullConfiguration to my BundleActivator-class as you suggested.&lt;/p&gt;

&lt;p&gt;  private static Configuration   logconfig = new NullConfiguration();&lt;/p&gt;

&lt;p&gt;  @Override&lt;br/&gt;
  public void stop(BundleContext context) throws Exception &lt;/p&gt;
{
    ...
    LoggerContext logcontext = (LoggerContext) LogManager.getContext();
    logcontext.updateLoggers(logconfig);
  }

&lt;p&gt;I tested it and it works now. But it is just a workaround.&lt;/p&gt;</comment>
                            <comment id="13862623" author="jvz" created="Sun, 5 Jan 2014 18:36:52 +0000"  >&lt;p&gt;This should fix this bug. The main idea is to load NullConfiguration as soon as possible so that during shutdown we&apos;ll still have an instance to use regardless of classpath.&lt;/p&gt;</comment>
                            <comment id="13862659" author="remkop@yahoo.com" created="Sun, 5 Jan 2014 21:26:17 +0000"  >&lt;p&gt;Applied the fix described in the comments and the patch.&lt;br/&gt;
I haven&apos;t been able to test this yet, but the change seems benign so I went ahead.&lt;/p&gt;

&lt;p&gt;Fixed in revision 1555633.&lt;br/&gt;
Please verify and close.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12677546">LOG4J2-440</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12621528" name="0001-Fix-LOG4J2-377.patch" size="1637" author="mattsicker" created="Sun, 5 Jan 2014 18:36:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>345840</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 46 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1nmzb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>346141</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>