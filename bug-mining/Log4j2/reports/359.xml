<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:33:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-658] shutdown hook called too early</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-658</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;Hi&lt;/p&gt;

&lt;p&gt;this issue follow few mail exchanges from the commons list. Here the interesting part for log4j2:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Here what I do (we can move it to another thread since that&apos;s 100% log4j2 related): &lt;br/&gt;
unzip apache-tomee-1.7.0-SNAPSHOT-webprofile.zip &amp;amp;&amp;amp; &lt;br/&gt;
cd apache-tomee-webprofile-1.7.0-SNAPSHOT/ &amp;amp;&amp;amp; &lt;br/&gt;
rm conf/logging.properties  &amp;amp;&amp;amp; &lt;br/&gt;
echo &apos;openejb.log.factory=log4j&apos;&amp;gt;conf/system.properties &amp;amp;&amp;amp; &lt;br/&gt;
cp ~/log4j2.xml conf/log4j2.xml &amp;amp;&amp;amp; &lt;br/&gt;
cp ~/.m2/repository/org/apache/logging/log4j/log4j-api/2.0-rc2-SNAPSHOT/log4j-api-2.0-rc2-SNAPSHOT.jar lib/ &amp;amp;&amp;amp; &lt;br/&gt;
cp ~/.m2/repository/org/apache/logging/log4j/log4j-core/2.0-rc2-SNAPSHOT/log4j-core-2.0-rc2-SNAPSHOT.jar lib/ &amp;amp;&amp;amp; &lt;br/&gt;
cp ~/.m2/repository/org/apache/logging/log4j/log4j-1.2-api/2.0-rc2-SNAPSHOT/log4j-1.2-api-2.0-rc2-SNAPSHOT.jar lib/ &amp;amp;&amp;amp; &lt;br/&gt;
./bin/catalina.sh&lt;/p&gt;

&lt;p&gt;it makes server starting with log4j2 logs, if you ctrl+c logs are not printed. Sure it is cause context is closed too early and then loggers have NullConfiguration. (If I debug in java.lang.ApplicationShutdownHooks#runHooks to wait all hooks exec it works)&lt;/p&gt;&lt;/blockquote&gt;


&lt;p&gt;Basically the issue is that when shutting down with ctrl+C some logs are swallowed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12717897">LOG4J2-658</key>
            <summary>shutdown hook called too early</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="mattsicker">Matt Sicker</assignee>
                                    <reporter username="romain.manni-bucau">Romain Manni-Bucau</reporter>
                        <labels>
                    </labels>
                <created>Mon, 2 Jun 2014 12:56:10 +0000</created>
                <updated>Wed, 3 Mar 2021 07:20:09 +0000</updated>
                                            <version>2.0-rc1</version>
                    <version>2.0-rc2</version>
                    <version>2.0.2</version>
                                                    <component>Core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="14104719" author="romain.manni-bucau" created="Wed, 20 Aug 2014 22:32:49 +0000"  >&lt;p&gt;Potential &quot;solutions&quot;:&lt;/p&gt;

&lt;p&gt;1) try to move context.stop from run() to join() in LoggerContext#ShutdownThread (doesn&apos;t fully solve the issue but can help if we have some luck that container hook is joined before log4j one)&lt;br/&gt;
2) cleanup everything which needs cleanup (means for console appender for instance it would be a noop, i think the same for file would work ensuring we flush it, for jdbc appender we can&apos;t help that much since we need to close everything)&lt;br/&gt;
3) the best but clearly more impacting: integrate with containers when possible (tomcat using a Listener, tomee using @Observes and extension mecanism, etc...)&lt;br/&gt;
4) a bit hacky but should work: instead of Runtime shutdown hook and thanks to sun.misc.SharedSecrets.getJavaLangAccess().registerShutdownHook(x, y) use directly java.lang.Shutdown to add the hook after Application hooks (0, 1, 2 are taken so 9 (=MAX_SYSTEM_HOOKS - 1) should be fine. If not we can add a noop shutdown hook and then wrap by reflectionjava.lang.Shutdown#hooks&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; to call real log4j shutdown hook after applications ones)&lt;/p&gt;

&lt;p&gt;last is the one with the best easiness/efficiency ratio IMHO.&lt;/p&gt;</comment>
                            <comment id="14104920" author="jvz" created="Thu, 21 Aug 2014 01:35:58 +0000"  >&lt;p&gt;In regards to 4, I downloaded the OpenJDK 1.6 source and there is no registerShutdownHook method in JavaLangAccess.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/*
 * Copyright (c) 2003, 2006, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
 * particular file as subject to the &lt;span class=&quot;code-quote&quot;&gt;&quot;Classpath&quot;&lt;/span&gt; exception as provided
 * by Oracle in the LICENSE file that accompanied &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; more details (a copy is included in the LICENSE file that
 * accompanied &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; work; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; you need additional information or have any
 * questions.
 */

&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; sun.misc;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.security.AccessControlContext;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; sun.reflect.ConstantPool;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; sun.reflect.annotation.AnnotationType;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; sun.nio.ch.Interruptible;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; JavaLangAccess {
    &lt;span class=&quot;code-comment&quot;&gt;/** Return the constant pool &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a class. */&lt;/span&gt;
    ConstantPool getConstantPool(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; klass);

    /**
     * Set the AnnotationType instance corresponding to &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; class.
     * (This method only applies to annotation types.)
     */
    void setAnnotationType(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; klass, AnnotationType annotationType);

    /**
     * Get the AnnotationType instance corresponding to &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; class.
     * (This method only applies to annotation types.)
     */
    AnnotationType getAnnotationType(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; klass);

    /**
     * Returns the elements of an &lt;span class=&quot;code-keyword&quot;&gt;enum&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;or &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the
     * &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; object does not represent an &lt;span class=&quot;code-keyword&quot;&gt;enum&lt;/span&gt; type;
     * the result is uncloned, cached, and shared by all callers.
     */
    &amp;lt;E &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Enum&amp;lt;E&amp;gt;&amp;gt; E[] getEnumConstantsShared(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;E&amp;gt; klass);

    &lt;span class=&quot;code-comment&quot;&gt;/** Set thread&apos;s blocker field. */&lt;/span&gt;
    void blockedOn(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; t, Interruptible b);

    /**
     * Returns a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; with the given &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; and an
     * inherited AccessControlContext.
     */
    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; newThreadWithAcc(&lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; target, AccessControlContext acc);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, I was previously unaware of the &lt;tt&gt;java.lang.Shutdown&lt;/tt&gt; class. That looks interesting.&lt;/p&gt;</comment>
                            <comment id="14104939" author="jvz" created="Thu, 21 Aug 2014 01:53:46 +0000"  >&lt;p&gt;Also, this bug may actually warrant a higher priority due to the audit logging features. I&apos;m going to take a look into this.&lt;/p&gt;</comment>
                            <comment id="14104942" author="jvz" created="Thu, 21 Aug 2014 01:57:41 +0000"  >&lt;p&gt;In regards to #1, you can&apos;t override any of the &lt;tt&gt;Thread.join&lt;/tt&gt; methods. They&apos;re all final.&lt;/p&gt;</comment>
                            <comment id="14104947" author="jvz" created="Thu, 21 Aug 2014 02:04:53 +0000"  >&lt;p&gt;One possible hackish solution would be to reflectively take some control over the &lt;tt&gt;java.lang.Shutdown.hooks&lt;/tt&gt; field. In JDK6, it&apos;s an ArrayList, so if we subclasses ArrayList and forced our own shutdown hook to always be the last one in the list, that could be one possible solution. I&apos;ll go look at the newer JDKs as well to see if we can rely on that in OpenJDK.&lt;/p&gt;

&lt;p&gt;Edit: JDK7 and JDK8 use &lt;tt&gt;Runnable[]&lt;/tt&gt; instead of &lt;tt&gt;ArrayList&amp;lt;Runnable&amp;gt;&lt;/tt&gt;. Plus, the static method &lt;tt&gt;Shutdown.add&lt;/tt&gt; has a different signature in 6 versus 7/8. In 6, it takes a Runnable. In 7+, it takes an int (for the index in the array), a boolean to indicate if the hook can be registered during shutdown, and then the Runnable.&lt;/p&gt;

&lt;p&gt;ApplicationShutdownHooks is not a great place to try and insert the shutdown hook as it uses IdentityHashMap to store the hooks. That means (at least in JDK6) the order of shutdown hooks is basically random. The hash used in that class is the default hash code, not the one returned by Object.hashCode(). Plus, that gets modified based on the current size of the backing array for the map. So, that&apos;s a no-go in terms of forcing our hook to be last without replacing its IdentityHashMap instance with a subclass.&lt;/p&gt;

&lt;p&gt;JDK7 is where the mentioned registerShutdownHook method was added to JavaLangAccess. Plus, based on its signature, it looks like it just gives access to &lt;tt&gt;Shutdown.add&lt;/tt&gt;. That might be accessible through reflection.&lt;/p&gt;</comment>
                            <comment id="14105017" author="jvz" created="Thu, 21 Aug 2014 04:17:00 +0000"  >&lt;p&gt;Just to spice things up, apparently the version of the JDK I&apos;m using (1.8.0_05-b13) has YET ANOTHER different signature for Shutdown.add. Thus, to address this, I&apos;ve implemented this using more generic parameter injection that makes certain assumptions about the various types and what parameter they&apos;re supposed to be. I also have this working with a predictable shutdown hook order thanks to using an ArrayList instead of a Set of some sort.&lt;/p&gt;

&lt;p&gt;To accomplish this, I&apos;ve introduced a &lt;tt&gt;ShutdownRegistrationStrategy&lt;/tt&gt; interface along with two implementations: a default one that just uses &lt;tt&gt;Runtime.getRuntime().addShutdownHook()&lt;/tt&gt;, and another one for OpenJDK that attempts to register shutdown hooks using the very last possible system shutdown hook slot. Since this is still a work in progress, here&apos;s a preview of how I abused reflection (once again!) to dig deep into OpenJDK:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;OpenJdkShutdownRegistrationStrategy &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; ShutdownRegistrationStrategy {

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Collection&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;&amp;gt; HOOKS = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;&amp;gt;();
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; LOCK = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;();

    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; shutdown = Loader.loadSystemClass(&lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.Shutdown&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; hookIndex = calculateHookIndex(shutdown);
            registerMainShutdownHook(shutdown, hookIndex);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Exception e) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ExceptionInInitializerError(e);
        }
    }

    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; method is only relevant &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; JDK7+ where the system shutdown hooks field is a fixed-size array
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; calculateHookIndex(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; shutdown) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Field maxSystemHooks = shutdown.getDeclaredField(&lt;span class=&quot;code-quote&quot;&gt;&quot;MAX_SYSTEM_HOOKS&quot;&lt;/span&gt;);
            maxSystemHooks.setAccessible(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxHooks = maxSystemHooks.getInt(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; maxHooks &amp;gt; 0 ? maxHooks - 1 : 0;
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (NoSuchFieldException e) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; 0;
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IllegalAccessException e) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; 0;
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void registerMainShutdownHook(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; shutdown, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; hookIndex)
        &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; NoSuchMethodException, InvocationTargetException, IllegalAccessException {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Method add = getAddMethod(shutdown);
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt;[] paramTypes = add.getParameterTypes();
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] params = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[paramTypes.length];
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; paramTypes.length; i++) {
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; type = paramTypes[i];
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (type.equals(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;.class)) {
                params[i] = hookIndex;
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (type.equals(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;.class)) {
                params[i] = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (type.equals(&lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;.class)) {
                params[i] = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MainShutdownHook();
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                params[i] = type.&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
            }
        }
        add.invoke(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, params);
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Method getAddMethod(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; shutdown) {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Method[] methods = shutdown.getDeclaredMethods();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Method method : methods) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (method.getName().equals(&lt;span class=&quot;code-quote&quot;&gt;&quot;add&quot;&lt;/span&gt;)) {
                method.setAccessible(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; method;
            }
        }
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NoSuchMethodError(&lt;span class=&quot;code-quote&quot;&gt;&quot;No Shutdown.add() method could be found!&quot;&lt;/span&gt;);
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void registerShutdownHook(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; hook) {
        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (LOCK) {
            HOOKS.add(hook);
        }
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void unregisterShutdownHook(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; hook) {
        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (LOCK) {
            HOOKS.remove(hook);
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MainShutdownHook &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; {
        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
            &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (LOCK) {
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; hook : HOOKS) {
                    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                        hook.run();
                    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Throwable t) {
                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (t &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ThreadDeath) {
                            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; (ThreadDeath) t;
                        }
                    }
                }
            }
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14105044" author="romain.manni-bucau" created="Thu, 21 Aug 2014 05:07:12 +0000"  >&lt;p&gt;Looks good, is it pushed?&lt;/p&gt;</comment>
                            <comment id="14105356" author="remkop@yahoo.com" created="Thu, 21 Aug 2014 13:13:57 +0000"  >&lt;p&gt;To be frank, several things about this approach sound fragile to me. First, there is the assumption that the log4j shutdown hook must run last. Why last? Perhaps some other user comes up with a use case where they &lt;em&gt;have&lt;/em&gt; to run their hook &lt;em&gt;after&lt;/em&gt; the log4j shutdown hook, who knows...&lt;/p&gt;

&lt;p&gt;Second, there doesn&apos;t seem to be a clean way to enforce a certain shutdown hook execution order. Having different logic for different JVM implementations, based on reflection and depending on JVM implementation details feels like a &quot;last-resort&quot; kind of solution.&lt;/p&gt;

&lt;p&gt;How about a different approach?&lt;/p&gt;

&lt;p&gt;Let&apos;s assume most users don&apos;t care about the shutdown order. For most users it is okay to register the current shutdown hook by default.&lt;/p&gt;

&lt;p&gt;Users who &lt;em&gt;do&lt;/em&gt; care are (I assume), users who are running their own shutdown logic.&lt;br/&gt;
Why don&apos;t we provide a way for these users to:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Disable the default shutdown hook. (How about a static method &lt;tt&gt;Log4jShutdownHook.unregister()&lt;/tt&gt; for example?)&lt;/li&gt;
	&lt;li&gt;Manually call the log4j shutdown logic from their custom shutdown hook. This could be as simple as &lt;tt&gt;new Log4jShutdownHook().run();&lt;/tt&gt;) to be called from inside the user custom shutdown hook when they are finished with whatever they need to do before shutting down logging.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14105367" author="garydgregory" created="Thu, 21 Aug 2014 13:34:06 +0000"  >&lt;p&gt;I have to admit that I feel the trepidations as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=remkop%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;remkop@yahoo.com&quot;&gt;remkop@yahoo.com&lt;/a&gt;. I feel we should at least provide the kind of API mechanisms Remko suggests. I want to control when stuff gets shutdown. Whether or not we fiddle the system to make our hook run last can be a separate matter. It also does make sense to run the Log4J hook last. I mean, I do want to see as much logging as possible from all components until the very end. But... I am sure someone will want to do something after log4j shuts down... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14105448" author="romain.manni-bucau" created="Thu, 21 Aug 2014 15:12:51 +0000"  >&lt;p&gt;About fragile comment: yes and no. Something to keep in mind when releasing but while it supports API breakage it is fine IMHO.&lt;/p&gt;

&lt;p&gt;I&apos;m 100% ok with unregister method while I don&apos;t have to spend time learning how to setup my login ie alternative is point 3) which means integrate with all potential environments as automatically as possible. What should absolutely be avoided is to ask the user to do it IMHO - typically in a container you can&apos;t do it without hacking yourself the listener/container hook which would be a failure.&lt;/p&gt;

&lt;p&gt;About shutdown logic I think we should provide it since that&apos;s a quick win for all platforms with a try {} catch(Throwable) &lt;/p&gt;
{runtime.addShutdownHook()}
&lt;p&gt; as fallback if api broke again in future version logging an info or warn message saying &quot;using standard shutdown hook since this jvm version xx.yy doesn&apos;t have xx method&quot;.&lt;/p&gt;
</comment>
                            <comment id="14105629" author="remkop@yahoo.com" created="Thu, 21 Aug 2014 17:23:53 +0000"  >&lt;p&gt;Looking at the original problem description I noticed this is happening with log4j2-rc2. I believe that in a later release we disable the shutdown hook when log4j-web is used. (I can&apos;t find a mention of this in the release notes, so I don&apos;t know which version.) &lt;/p&gt;

&lt;p&gt;(This is achieved with a property &lt;tt&gt;log4j.shutdownHookEnabled=false&lt;/tt&gt; defined in /log4j-web/src/main/resources/log4j2.component.properties)&lt;/p&gt;

&lt;p&gt;This would prevent the problem mentioned in the problem description.&lt;/p&gt;</comment>
                            <comment id="14105666" author="romain.manni-bucau" created="Thu, 21 Aug 2014 17:42:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=remkop%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;remkop@yahoo.com&quot;&gt;remkop@yahoo.com&lt;/a&gt; I don&apos;t get you. Use case is to configure container logs with log4j2 so cases are:&lt;br/&gt;
1) no webapps &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; - empty container, ejbmodules, ears...&lt;br/&gt;
2) same issues with &quot;Main&quot; softwares&lt;/p&gt;

&lt;p&gt;BTW in this regard log4j-web should check log4j classloader is webapp one or not to disable shutdown hook.&lt;/p&gt;

&lt;p&gt;In one word: log4j-web doesn&apos;t solve original issue and issue is still here on trunk&lt;/p&gt;</comment>
                            <comment id="14105726" author="jvz" created="Thu, 21 Aug 2014 18:25:11 +0000"  >&lt;p&gt;The default strategy is to use the Runtime methods as we currently do. This would be an alternative strategy. Providing the general interface allows for further customization in various container environments so that shutdown can be handled properly.&lt;/p&gt;</comment>
                            <comment id="14105771" author="romain.manni-bucau" created="Thu, 21 Aug 2014 18:54:30 +0000"  >&lt;p&gt;Well it means we never know if it will work properly. I&apos;d prefer to try to make it working deterministicly and if something went wrong on the unsecured path use it as fallback&lt;/p&gt;</comment>
                            <comment id="14105807" author="remkop@yahoo.com" created="Thu, 21 Aug 2014 19:08:55 +0000"  >&lt;p&gt;Romain, you are right, sorry. Looks like I did not understand the problem description correctly.&lt;/p&gt;

&lt;p&gt;Can you help me clarify this issue? What is the commons list? So, the goal of this issue is to migrate the logging that is used internally by TomcatEE from the current mechanism to log4j2? And one of the issues identified during this migration is that TomcatEE performs logging in JVM shutdown hooks (I am guessing), so if the logging system has its own shutdown hook after which no logging can take place it may result in TomcatEE&apos;s shutdown log messages getting lost.&lt;/p&gt;

&lt;p&gt;Would that be a better description of this issue?&lt;/p&gt;</comment>
                            <comment id="14105831" author="romain.manni-bucau" created="Thu, 21 Aug 2014 19:34:00 +0000"  >&lt;p&gt;Working on JCache implementation in JCS project I popped up the issue that it would be nice to drop commons-logging for a little facade to be able to switch it. I had in mind TomEE integration which mandates JUL by default but should support slf4j, log4j etc...(yes at this point I fogot about log4j2). Then somebody on commons list (because commons-jcs project) said &quot;and log4j2&quot;. He was right. A bit later I checked tomee log4j support with log4j2 implementation and got two main glitches after the one I was able to fix in TomEE projects:&lt;br/&gt;
1) I lost all my shutdown messages (which can be quite important since it ensure everything is cleanup including resources)&lt;br/&gt;
2) PropertyConfigurator is now a no-op impl so tomee default config (conf/logging.properties) is ignored - this one is less important since there are ways to workaround it more or less&lt;/p&gt;


&lt;p&gt;Regarding TomEE: it is actually a tomcat behavior. Tomcat adds a shutdown hook to kill the server when ctrl+c is hitten. Since depending the JVMs hooks can be executed concurrently then you have no guarantee log4j didn&apos;t shutdown before tomcat (and actually since it is faster it is pretty sure).&lt;/p&gt;

&lt;p&gt;Side note: I have the same situtation at work with several tooling using shutdown hooks, that&apos;s why I said it is a general java issue and integrating with each framework/container is too hard IMHO.&lt;/p&gt;</comment>
                            <comment id="14106067" author="jvz" created="Thu, 21 Aug 2014 22:27:31 +0000"  >&lt;p&gt;The theory I have behind taking the very last possible shutdown slot is that there are use cases where you don&apos;t want logging to be stopped until everything is shut down. Being able to delay this until after everything has had a chance to shut down and clean up means that no log events will be lost (unless perhaps the process is kill-9&apos;d).&lt;/p&gt;

&lt;p&gt;Think of it this way: many developers use server containers like Tomcat, Jetty, JBoss, Weblogic, etc., which all use &lt;tt&gt;Runtime.getRuntime().addShutdownHook()&lt;/tt&gt; as it is. They each provide their own proprietary method to adding your own hooks into their shutdown hook so that you get a more predictable shutdown hook ordering.&lt;/p&gt;

&lt;p&gt;What&apos;s neat about providing a custom strategy (not just the OpenJdk one I wrote) is that it allows for exotic shutdown strategies such as using a PriorityQueue to order the shutdown hooks and other customizable behavior. Plus, it makes it that much easier for server containers to use Log4j 2 as their main logging system by simply providing their own implementation of the strategy.&lt;/p&gt;</comment>
                            <comment id="14106464" author="romain.manni-bucau" created="Fri, 22 Aug 2014 05:04:09 +0000"  >&lt;p&gt;I don&apos;t follow you sorry. They have proprietary api for shutdown but then you dont need any API since it doesnt use shutdown hook.&lt;/p&gt;

&lt;p&gt;Big drawback of it are:&lt;br/&gt;
1) you need tointegrate with everybody, with all versions&lt;br/&gt;
2) in some container (think to tomcat) you need a specific config&lt;/p&gt;

&lt;p&gt;2) is a regression to me&lt;/p&gt;</comment>
                            <comment id="14106512" author="ralph.goers@dslextreme.com" created="Fri, 22 Aug 2014 05:58:32 +0000"  >&lt;p&gt;A log4j2.component.properties can be included in any jar to set log4j.shutdownHookEnabled=false.  You can create a jar that only includes that.&lt;/p&gt;

&lt;p&gt;I don&apos;t think it is Log4j&apos;s responsibility to figure out the nuances of every container to figure out the appropriate time to shutdown Log4j. All the shutdown hook does is insure that the stop() method is called on the LoggerContext. That can easily be called at the appropriate time if Log4j 2 is being hooked into the container.&lt;/p&gt;

&lt;p&gt;I don&apos;t think I understand the comment about a regression. What is a regression? That the container requires a specific config? How is that a regression in Log4j?&lt;/p&gt;</comment>
                            <comment id="14106533" author="romain.manni-bucau" created="Fri, 22 Aug 2014 06:25:08 +0000"  >&lt;p&gt;the question is not technical, take the place of an operator/integrator. What was he doing to work with log4j: add jar + config.&lt;/p&gt;

&lt;p&gt;If to ensure it works he needs something more then it will not be done and log4j will be considered as broken (I saw it so much time @work) so it has to work by default.&lt;/p&gt;

&lt;p&gt;as log4j-web need to check log4j classloader == webapp one before removing the shutdown hook default shutdown hook has to work whatever JVM/container it is.&lt;/p&gt;

&lt;p&gt;Log4j needs to integrate with the jvm. Harder it is (= more user has to do), less the solution is acceptable.&lt;/p&gt;</comment>
                            <comment id="14106656" author="remkop@yahoo.com" created="Fri, 22 Aug 2014 09:14:34 +0000"  >&lt;p&gt;Romain, can I clarify again what you are trying to achieve?  If I understand correctly, the reason you were trying to route TomcatEE logging to log4j2 is to investigate whether it is possible to use a different logging API than commons logging, and integration the JCache logging with the container logging, am I correct? So, you were investigating migrating JCache to log4j2? Or migrating TomcatEE to log4j2?&lt;/p&gt;

&lt;p&gt;You routed all TomcatEE container logging to log4j2. That worked except that the log4j2 shutdown hook was not disabled and log messages during the shutdown sequence were lost.  As Ralph mentioned, one solution is to create a jar that only contains a log4j2.component.properties file whose contents is log4j.shutdownHookEnabled=false. &lt;/p&gt;

&lt;p&gt;I am sure we would all like other Apache projects to use log4j2 and are willing to make changes to facilitate that, but I don&apos;t think building something fragile in log4j2 is the best solution. Perhaps it would be better to include some of the Tomcat/TomcatEE people in this conversation?&lt;/p&gt;</comment>
                            <comment id="14106727" author="romain.manni-bucau" created="Fri, 22 Aug 2014 11:11:35 +0000"  >&lt;p&gt;Well my goal was larger than this issue: keep supporting logging framework pluggability in tomee (todfay slf4j, jul, log4j1 with fallback for log4j2 but this issue needs to be fixed to get a real log4j2 support). JCache was just the factor making me looking deeper to log4j2 (thanks for it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;). Idea is set a system property and add log4j jars/config and it should work.&lt;/p&gt;

&lt;p&gt;About log4j.shutdownHookEnabled=false: it is wrong it works since logging can be asynchronous and in this case stop needs to flush messages (why I&apos;m fighting so much to get a working solution even if not as sexy as expected).&lt;/p&gt;

&lt;p&gt;We can inlcude guys from TomEE, who do you want? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
</comment>
                            <comment id="14106792" author="remkop@yahoo.com" created="Fri, 22 Aug 2014 12:45:49 +0000"  >&lt;p&gt;Oh! Async logging in log4j2 auto-flushes when the queue is empty. If that was the concern then a shutdown hook is actually not necessary. &lt;/p&gt;

&lt;p&gt;I have no idea who to include. You probably know better than me. Who in the Tomcat/TomcatEE team would be interested in using log4j2 for Tomcat internal logging?&lt;/p&gt;</comment>
                            <comment id="14106903" author="romain.manni-bucau" created="Fri, 22 Aug 2014 14:35:07 +0000"  >&lt;p&gt;Well regarding TomEE we&apos;ll not use log4j2 internally we&apos;ll stick to JUL but we&apos;ll make it easy for users to switch when needed.&lt;/p&gt;

&lt;p&gt;auto flushes when the queue is empty? If stop &lt;a href=&quot;http://svn.apache.org/repos/asf/logging/log4j/log4j2/trunk/log4j-core/src/main/java/org/apache/logging/log4j/core/async/AsyncLoggerContext.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/logging/log4j/log4j2/trunk/log4j-core/src/main/java/org/apache/logging/log4j/core/async/AsyncLoggerContext.java&lt;/a&gt; is not called then you potentially lost messages, no?&lt;/p&gt;</comment>
                            <comment id="14106917" author="remkop@yahoo.com" created="Fri, 22 Aug 2014 14:51:33 +0000"  >&lt;p&gt;Async loggers and the async appender will flush when the queue is empty. No need to call LoggerContext.stop() for that. &lt;/p&gt;

&lt;p&gt;The stop method may be necessary if you need to close sockets or something (some apps log to a remote machine). For the DB connections of JdbcAppender you&apos;d use a pool which is responsible for closing resources. Files I think are closed by the JVM when the process is killed. &lt;/p&gt;</comment>
                            <comment id="14107116" author="romain.manni-bucau" created="Fri, 22 Aug 2014 17:17:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=remkop%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;remkop@yahoo.com&quot;&gt;remkop@yahoo.com&lt;/a&gt; can you point me the code out? if you kill the app the app the queue will not be empty. In particular cause threads are daemon.&lt;/p&gt;</comment>
                            <comment id="14107230" author="romain.manni-bucau" created="Fri, 22 Aug 2014 18:16:48 +0000"  >&lt;p&gt;Hmm&lt;/p&gt;

&lt;p&gt;checked on the jvm i use (1.7.0.67) and Shutdown impl is generally good but highly depends on java.lang.ApplicationShutdownHooks#hooks which doesn&apos;t guarantee any order. So basically if stop is called too early (ie hook of log4j passed before other ones) then you have lost logs.&lt;/p&gt;</comment>
                            <comment id="14107232" author="jvz" created="Fri, 22 Aug 2014 18:21:20 +0000"  >&lt;p&gt;That&apos;s why I started that shutdown strategy class that hooks in even later. It&apos;s either that or subclass IdentityHashMap with overrides for iteration and then injecting that into ApplicationShutdownHooks.&lt;/p&gt;</comment>
                            <comment id="14107367" author="romain.manni-bucau" created="Fri, 22 Aug 2014 19:40:17 +0000"  >&lt;p&gt;@Matt it is fine for me while it works &lt;b&gt;by default&lt;/b&gt;, it was only my point&lt;/p&gt;</comment>
                            <comment id="14107561" author="remkop@yahoo.com" created="Fri, 22 Aug 2014 21:43:20 +0000"  >&lt;p&gt;I still think that the simplest thing is to not register the log4j shutdown hook. &lt;/p&gt;

&lt;p&gt;True, if the application&apos;s shutdown hook is logging a lot, uses async logging, and has a slow appender configured (eg a database) there is a possibility not all shutdown logs are persisted. &lt;/p&gt;

&lt;p&gt;Should log4j now bend over backwards and use reflection and JVM implementation details to try to make its shutdown hook run last? (By the way, are shutdown hooks run in parallel or in sequence? Can we make the log4j2 shutdown hook start after all other hooks are finished?)  &lt;/p&gt;

&lt;p&gt;I&apos;m not convinced. &lt;br/&gt;
This is a pretty theoretical use case. Is it really a good idea to put mission critical log messages in your shutdown hook? The shutdown hook javadocs specifically warn against this:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Shutdown hooks run at a delicate time in the life cycle of a virtual machine and should therefore be coded defensively. (...) They should also not rely blindly upon services that may have registered their own shutdown hooks and therefore may themselves in the process of shutting down. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The thing is, even if we did all this hacky stuff and got our shutdown hook to run last, what does this do? Calling LoggerContext.stop() will essentially just wait for the async logger&apos;s background thread to clear its backlog of events remaining in the queue. However, there&apos;s no guarantee that the JVM will give us enough time to finish all this work. Again, from the Runtime.addShutdownHook() javadocs:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Shutdown hooks should also finish their work quickly. (...) When the virtual machine is terminated due to user logoff or system shutdown the underlying operating system may only allow a fixed amount of time in which to shut down and exit. (...)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Shutdown hooks may not even be run at all. &lt;br/&gt;
So there are still no guarantees that there are no lost log messages...&lt;/p&gt;

&lt;p&gt;If we really want to implement this, fine, but I honestly don&apos;t think there&apos;s much point. &lt;br/&gt;
(sorry, this got longer than intended)&lt;/p&gt;</comment>
                            <comment id="14107568" author="jvz" created="Fri, 22 Aug 2014 21:47:12 +0000"  >&lt;p&gt;I still think the main idea to take from this is providing an SPI class (ShutdownRegistrationStrategy in this case) that containers and such can implement to hook into their own custom shutdown logic. That way it&apos;s easily extensible and all we really need to support is the standard Runtime method of doing so.&lt;/p&gt;

&lt;p&gt;And shutdown hooks are run in sequence (not the Runtime ones, the system ones), each in a synchronization block. Then again, it&apos;s not like there&apos;s many threads (if any) to deal with at shutdown other than daemon threads.&lt;/p&gt;</comment>
                            <comment id="14107608" author="garydgregory" created="Fri, 22 Aug 2014 22:23:16 +0000"  >&lt;p&gt;It seems like the simplest solution for now would be to not register a hook, which means that all log events will be processed until such time that the JVM goes away.&lt;/p&gt;

&lt;p&gt;I would only be worried that files, sockets and such not get properly closed. Could that happen?&lt;/p&gt;</comment>
                            <comment id="14107660" author="ralph.goers@dslextreme.com" created="Fri, 22 Aug 2014 23:09:40 +0000"  >&lt;p&gt;Things like the HTMLLayout, XMLLayout, or JSONLayout will not have the appropriate footer content written if their stop method isn&apos;t called. Most other things will probably be OK. After all, I don&apos;t think Log4j 1.x has support for shutdown and it has been used for years.&lt;/p&gt;</comment>
                            <comment id="14107875" author="remkop@yahoo.com" created="Sat, 23 Aug 2014 05:45:15 +0000"  >&lt;p&gt;I actually think its fine the way it is since apps (incl app containers) have the ability to switch off the shutdown hook. If desirable/requested we can provide a programmatic api for apps/app containers to decide the exact timing of log4j2 shutdown processing.  If, say, TomcatEE would approach us and say &quot;we need this because we&apos;re thinking of migrating&quot; then that would be a good time to have a conversation on what that api should look like. &lt;/p&gt;</comment>
                            <comment id="14107914" author="romain.manni-bucau" created="Sat, 23 Aug 2014 07:27:18 +0000"  >&lt;p&gt;Two comments:&lt;br/&gt;
1) SPI: useless IMO since in container you use the container spi to force stop, not shutdown hook&lt;br/&gt;
but&lt;br/&gt;
2) it means as I said integrating with all containers =&amp;gt; not working out of the box&lt;br/&gt;
so&lt;br/&gt;
3) log4j2 is not usable in production whatever soft it is since that&apos;s in the &quot;main&quot; classloader&lt;/p&gt;

&lt;p&gt;Doing reflection on the jvm doesnt cost log4j2 a lot and the gain is huge, it is really less than all we wrote in these comments.&lt;/p&gt;

&lt;p&gt;PS: Shutdown hooks are not run in parallel but order is not predictable, that&apos;s the only issue.&lt;/p&gt;</comment>
                            <comment id="14714176" author="jansohn" created="Wed, 26 Aug 2015 15:35:40 +0000"  >&lt;p&gt;Are there any plans on fixing this issue? Switching off the shutdown hook does not work in our environment (see &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1098&quot; title=&quot;log4j.shutdownHookEnabled=false from log4j-web ignored?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1098&quot;&gt;LOG4J2-1098&lt;/a&gt;) so at the moment we have no possibility to see cleanup log messages from the contextDestroyed method in our ServletContextListener when the web application is shut down.&lt;/p&gt;

&lt;p&gt;For us this is a major flaw...&lt;/p&gt;</comment>
                            <comment id="14715176" author="ralph.goers@dslextreme.com" created="Wed, 26 Aug 2015 17:13:12 +0000"  >&lt;p&gt;1. To be honest, I am not sure if this has been already addressed or not. Matt implemented the shutdown registry and it seems to be working. But I am not sure if it completely solves the issue or not.&lt;/p&gt;

&lt;p&gt;2. Robin, Please see my update to &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1098&quot; title=&quot;log4j.shutdownHookEnabled=false from log4j-web ignored?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1098&quot;&gt;LOG4J2-1098&lt;/a&gt;. I don&apos;t think the problem you are having is related to the shutdown registry.&lt;/p&gt;</comment>
                            <comment id="14954574" author="jansohn" created="Tue, 13 Oct 2015 07:52:53 +0000"  >&lt;p&gt;OK, so the shutdown hook does seem to be disabled but it doesn&apos;t prevent the Log4jServletContextListener to close the LoggerContext too early. Log messages from our listener&apos;s contextDestroyed method are still swallowed.&lt;/p&gt;</comment>
                            <comment id="14955253" author="jvz" created="Tue, 13 Oct 2015 16:47:54 +0000"  >&lt;p&gt;The Log4jServletContextListener should be the last thing to shut down if it&apos;s the first listener for your web app, but there may be a different problem in log4j-web trying to shut down the LoggerContext too early somewhere else. I&apos;ll investigate.&lt;/p&gt;</comment>
                            <comment id="15057614" author="erikkemperman" created="Tue, 15 Dec 2015 08:30:53 +0000"  >&lt;p&gt;Were there any discoveries here? I&apos;m seeing much the same problem in a Spring/Jetty deployment, with log4j-web in place. Jetty&apos;s ShutdownThread triggers Spring&apos;s ContextCleanupListener, which has in its class initializer a call to commons.logging.LogFactory.getLog. This ends up requesting a Logger from log4j, via jcl, but that throws a FATAL IllegalStateException because shutdown already in progress.&lt;/p&gt;

&lt;p&gt;In short, &quot;log4j-web trying to shut down the LoggerContext&quot; too early sounds just about right. If I add shutdownHook=&quot;disable&quot; in my log4j2.xml, I don&apos;t see this exception, but then we&apos;re missing our logs shutdown/cleanup.&lt;/p&gt;</comment>
                            <comment id="15057624" author="romain.manni-bucau" created="Tue, 15 Dec 2015 08:38:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=erikkemperman&quot; class=&quot;user-hover&quot; rel=&quot;erikkemperman&quot;&gt;erikkemperman&lt;/a&gt; on tomee side we integrated directly with log4j2 flushing all logs at container shutdown (means worse case we miss shutdown hooks logs)&lt;/p&gt;</comment>
                            <comment id="15057750" author="erikkemperman" created="Tue, 15 Dec 2015 09:59:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rmannibucau&quot; class=&quot;user-hover&quot; rel=&quot;rmannibucau&quot;&gt;rmannibucau&lt;/a&gt; Thanks for your reply, that sounds like an improvement. Would prefer not to intervene in this manner with what seems to me to be a pretty common usecase.&lt;/p&gt;</comment>
                            <comment id="15097771" author="idans" created="Thu, 14 Jan 2016 07:39:32 +0000"  >&lt;p&gt;Hi all &lt;/p&gt;

&lt;p&gt;Not sure if this is the right place to comment , So I&apos;ll just go ahead and do that  anyways&lt;br/&gt;
I&apos;m suffering from the same issue , Log4jServletContextListener calls contextDestroyed upon app shutdown and from that point on no log4j2 takes place beyond that point ( verified that with status set to trace )&lt;/p&gt;

&lt;p&gt;shutdownHook is set to disable via the Configuration xml node in the log4j2.xml config file&lt;/p&gt;

&lt;p&gt;Regarding spring , this seems to take place after servlet termination ( so beans defined in spring dispatcher servlet shut down ) but in parallel/before the spring ContextLoaderListener shutdown so no logging there.&lt;/p&gt;

&lt;p&gt;What about proposing a temporal workaround ? deferring shutdown by invoking asynchronously from the contextDestroyed method and setting a configurable timer ( via context-param config ) ?&lt;/p&gt;</comment>
                            <comment id="15101929" author="ralph.goers@dslextreme.com" created="Fri, 15 Jan 2016 15:34:38 +0000"  >&lt;p&gt;Using a timer makes it likely that it would be hit or miss whether the shutdown logic would run at all as the timer task may get terminated by the JVM and the JVM itself could complete shutdown before the timer is fired.&lt;/p&gt;</comment>
                            <comment id="17294041" author="ralph.goers@dslextreme.com" created="Tue, 2 Mar 2021 23:19:46 +0000"  >&lt;p&gt;It has been 5 years since this issue was last updated. Will close if there are no further updates.&lt;/p&gt;</comment>
                            <comment id="17294337" author="romain.manni-bucau" created="Wed, 3 Mar 2021 07:20:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgoers&quot; class=&quot;user-hover&quot; rel=&quot;rgoers&quot;&gt;rgoers&lt;/a&gt;&#160;it hasn&apos;t been solved AFAIK?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>396099</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1w727:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>396225</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>