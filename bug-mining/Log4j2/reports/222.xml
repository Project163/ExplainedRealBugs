<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:32:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-485] toString methods that perform logging can deadlock AsyncAppender</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-485</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;During analysis of &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-471&quot; title=&quot;toString methods that perform logging can deadlock AsyncLogger&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-471&quot;&gt;&lt;del&gt;LOG4J2-471&lt;/del&gt;&lt;/a&gt;, I found the same issue can happen with AsyncAppender. Summary of the problem:&lt;/p&gt;

&lt;p&gt;Application thread A calls &lt;tt&gt;Logger.log()&lt;/tt&gt;, which puts LogEvents in a queue. Appender thread B takes LogEvents off the queue, converts them to a byte[] array and saves this byte array to disk. The conversion from a LogEvent to a byte[] array may itself result in calls to &lt;tt&gt;Logger.log()&lt;/tt&gt; (particularly if logging is done from the &lt;tt&gt;toString()&lt;/tt&gt; method of an object that is being logged).&lt;br/&gt;
Here is where the problem occurs: if the Appender thread calls &lt;tt&gt;Logger.log()&lt;/tt&gt; when processing LogEvents from the queue, and it happens that the queue is full, then in blocking mode, the Appender thread will block until space is available in the queue. Unfortunately space will only become available if the Appender consumes LogEvents, but the Appender thread is blocked... resulting in deadlock.&lt;/p&gt;

&lt;p&gt;It is possible to configure &lt;tt&gt;AsyncAppender&lt;/tt&gt; with &lt;tt&gt;blocking=&quot;false&quot;&lt;/tt&gt;, which will log to an errorAppender when the queue is full, but a better solution would be to prevent deadlock in the above scenario.&lt;/p&gt;

&lt;p&gt;The problem can be reproduced with this program:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; demo.deadlock;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.logging.log4j.LogManager;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.logging.log4j.Logger;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;DeadlockDemo {
    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Logger sLog = LogManager.getLogger(DeadlockDemo.class);

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;(Sysout) Before throwing ex...&quot;&lt;/span&gt;);
            sLog.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;(Log) Before throwing ex...&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000);

            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LoggingEx();
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception ex) {
            sLog.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Caught a {} problem&quot;&lt;/span&gt;, ex, ex);
            sLog.error(ex, ex);
        }
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;(Sysout) After catching ex&quot;&lt;/span&gt;);
        sLog.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;(Log) After catching ex&quot;&lt;/span&gt;);
        
        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000);
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;(Sysout) After 1 sec...&quot;&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// I still see &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
&lt;/span&gt;        sLog.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;(Log) After 1 sec...&quot;&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// causes deadlock on my laptop
&lt;/span&gt;        
        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000);
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;(Sysout) After 2 sec...&quot;&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// I don&apos;t see &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; output
&lt;/span&gt;        sLog.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;(Log) After 2 sec...&quot;&lt;/span&gt;);
        sLog.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Done. Completed without deadlock.&quot;&lt;/span&gt;);
    }
    
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LoggingEx &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Logger exLog = LogManager.getLogger(LoggingEx.class);
        
        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; toString() {
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;(Sysout) Before LoggingEx calling logger.debug 300 times...&quot;&lt;/span&gt;);

            &lt;span class=&quot;code-comment&quot;&gt;// fill up AsyncAppender queue (128 slots)
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 300; i++) {
                exLog.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;(Log) in LoggingEx.toString() {}...&quot;&lt;/span&gt;, i);
            }
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;(Sysout) After LoggingEx called logger.debug 300 times...&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000);
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
                e.printStackTrace();
            }
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;oops&quot;&lt;/span&gt;;
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;... and this log4j2.xml config:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;?xml version=&lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt; encoding=&lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;?&amp;gt;
&amp;lt;configuration status=&lt;span class=&quot;code-quote&quot;&gt;&quot;TRACE&quot;&lt;/span&gt; name=&lt;span class=&quot;code-quote&quot;&gt;&quot;deadlock-demo&quot;&lt;/span&gt; packages=&quot;&quot;&amp;gt;
  &amp;lt;appenders&amp;gt;
      &amp;lt;Console name=&lt;span class=&quot;code-quote&quot;&gt;&quot;STDOUT&quot;&lt;/span&gt; target=&lt;span class=&quot;code-quote&quot;&gt;&quot;SYSTEM_OUT&quot;&lt;/span&gt;&amp;gt;
        &amp;lt;PatternLayout pattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;%m%n&quot;&lt;/span&gt;/&amp;gt;
      &amp;lt;/Console&amp;gt;
    &amp;lt;Async name=&lt;span class=&quot;code-quote&quot;&gt;&quot;Async&quot;&lt;/span&gt; bufferSize=&lt;span class=&quot;code-quote&quot;&gt;&quot;128&quot;&lt;/span&gt; errorRef=&lt;span class=&quot;code-quote&quot;&gt;&quot;STDOUT&quot;&lt;/span&gt;&amp;gt;
      &amp;lt;appenderRef ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;STDOUT&quot;&lt;/span&gt; /&amp;gt;
    &amp;lt;/Async&amp;gt;
  &amp;lt;/appenders&amp;gt;
  &amp;lt;loggers&amp;gt;
    &amp;lt;root level=&lt;span class=&quot;code-quote&quot;&gt;&quot;DEBUG&quot;&lt;/span&gt;&amp;gt;
      &amp;lt;appenderRef ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;Async&quot;&lt;/span&gt; /&amp;gt;
    &amp;lt;/root&amp;gt;
  &amp;lt;/loggers&amp;gt;
&amp;lt;/configuration&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Output:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;(Sysout) Before throwing ex...
(Log) Before throwing ex...
(Sysout) Before LoggingEx calling logger.debug 300 times...
(Log) in LoggingEx.toString() 0...
(Log) in LoggingEx.toString() 1...
(Log) in LoggingEx.toString() 2...
...(omitted)
(Log) in LoggingEx.toString() 169...
(Log) in LoggingEx.toString() 170...
(Sysout) After LoggingEx called logger.debug 300 times...
(Log) in LoggingEx.toString() 171...
(Log) in LoggingEx.toString() 172...
...(omitted)
(Log) in LoggingEx.toString() 298...
(Log) in LoggingEx.toString() 299...
Caught a oops problem
demo.deadlock.DeadlockDemo$LoggingEx
	at demo.deadlock.DeadlockDemo.main(DeadlockDemo.java:32) [bin/:?]
(Sysout) After catching ex
(Sysout) Before LoggingEx calling logger.debug 300 times...
(Sysout) After 1 sec...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;... and the application hangs.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12687348">LOG4J2-485</key>
            <summary>toString methods that perform logging can deadlock AsyncAppender</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="rpopma">Remko Popma</reporter>
                        <labels>
                    </labels>
                <created>Sun, 5 Jan 2014 06:08:06 +0000</created>
                <updated>Sun, 5 Jan 2014 08:19:10 +0000</updated>
                            <resolved>Sun, 5 Jan 2014 08:16:31 +0000</resolved>
                                    <version>2.0-beta9</version>
                                    <fixVersion>2.0-rc1</fixVersion>
                    <fixVersion>2.0</fixVersion>
                                    <component>Appenders</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13862514" author="remkop@yahoo.com" created="Sun, 5 Jan 2014 08:16:31 +0000"  >&lt;p&gt;I applied the same idea as in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-471&quot; title=&quot;toString methods that perform logging can deadlock AsyncLogger&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-471&quot;&gt;&lt;del&gt;LOG4J2-471&lt;/del&gt;&lt;/a&gt; here: &lt;br/&gt;
Use a threadlocal variable to detect whether we&apos;re about to add a LogEvent to the queue from the Appender thread. If that is the case and the queue is full, then bypass the queue and do the Appender thread work directly (callAppenders).&lt;/p&gt;

&lt;p&gt;As with &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-471&quot; title=&quot;toString methods that perform logging can deadlock AsyncLogger&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-471&quot;&gt;&lt;del&gt;LOG4J2-471&lt;/del&gt;&lt;/a&gt;, I have been unable to create JUnit tests for the deadlock scenario, and instead I used the DeadLockDemo class in the description above to verify the solution. Without the patch the demo class reliably deadlocks, with the patch there is no deadlock.&lt;/p&gt;

&lt;p&gt;Fixed in revision 1555468.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12685928">LOG4J2-471</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>366347</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 46 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1r5d3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>366658</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>