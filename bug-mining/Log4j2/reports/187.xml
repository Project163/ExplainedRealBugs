<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:31:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-359] Log4jServletContextListener does not work on Weblogic 12.1.1 (12c) with web-app version &quot;2.5&quot;</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-359</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;I have Weblogic 12c running. My web-app is version &quot;2.5&quot;.&lt;/p&gt;

&lt;p&gt;Following is a snippet from my web.xml &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;&amp;lt;web-app &lt;span class=&quot;code-keyword&quot;&gt;xmlns:xsi&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&lt;/span&gt;
	xmlns=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://java.sun.com/xml/ns/javaee&quot;&lt;/span&gt;
	xsi:schemaLocation=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;&lt;/span&gt;
	id=&lt;span class=&quot;code-quote&quot;&gt;&quot;WebApp_ID&quot;&lt;/span&gt; version=&lt;span class=&quot;code-quote&quot;&gt;&quot;2.5&quot;&lt;/span&gt;&amp;gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;display-name&amp;gt;&lt;/span&gt;pec-service&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/display-name&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;context-param&amp;gt;&lt;/span&gt;
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;param-name&amp;gt;&lt;/span&gt;log4jConfiguration&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/param-name&amp;gt;&lt;/span&gt;
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;param-value&amp;gt;&lt;/span&gt;file:/C:/log4j/dev.log4j.xml&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/param-value&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/context-param&amp;gt;&lt;/span&gt;

	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;listener&amp;gt;&lt;/span&gt; 
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;listener-class&amp;gt;&lt;/span&gt;org.apache.logging.log4j.core.web.Log4jServletContextListener&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/listener-class&amp;gt;&lt;/span&gt; 
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/listener&amp;gt;&lt;/span&gt;	

	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;filter&amp;gt;&lt;/span&gt;
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;filter-name&amp;gt;&lt;/span&gt;log4jServletFilter&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/filter-name&amp;gt;&lt;/span&gt;
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;filter-class&amp;gt;&lt;/span&gt;org.apache.logging.log4j.core.web.Log4jServletFilter&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/filter-class&amp;gt;&lt;/span&gt; 
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/filter&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;filter-mapping&amp;gt;&lt;/span&gt;
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;filter-name&amp;gt;&lt;/span&gt;log4jServletFilter&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/filter-name&amp;gt;&lt;/span&gt; 
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;url-pattern&amp;gt;&lt;/span&gt;/*&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/url-pattern&amp;gt;&lt;/span&gt;
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;dispatcher&amp;gt;&lt;/span&gt;REQUEST&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/dispatcher&amp;gt;&lt;/span&gt;
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;dispatcher&amp;gt;&lt;/span&gt;FORWARD&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/dispatcher&amp;gt;&lt;/span&gt; 
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;dispatcher&amp;gt;&lt;/span&gt;INCLUDE&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/dispatcher&amp;gt;&lt;/span&gt;
		&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;dispatcher&amp;gt;&lt;/span&gt;ERROR&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/dispatcher&amp;gt;&lt;/span&gt;
	&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/filter-mapping&amp;gt;&lt;/span&gt;
	
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/web-app&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, on my server startup I am getting the following error - &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;Aug 16, 2013 3:12:32 PM PDT&amp;gt; &amp;lt;Warning&amp;gt; &amp;lt;HTTP&amp;gt; &amp;lt;BEA-101162&amp;gt; &amp;lt;User defined listener org.apache.logging.log4j.core.web.Log4jServletContextListener failed: java.lang.IllegalStateException: Context destroyed before it was initialized..
java.lang.IllegalStateException: Context destroyed before it was initialized.
	at org.apache.logging.log4j.core.web.Log4jServletContextListener.contextDestroyed(Log4jServletContextListener.java:51)
	at weblogic.servlet.internal.EventsManager$FireContextListenerAction.run(EventsManager.java:583)
	at weblogic.security.acl.internal.AuthenticatedSubject.doAs(AuthenticatedSubject.java:321)
	at weblogic.security.service.&lt;span class=&quot;code-object&quot;&gt;SecurityManager&lt;/span&gt;.runAs(&lt;span class=&quot;code-object&quot;&gt;SecurityManager&lt;/span&gt;.java:120)
	at weblogic.servlet.provider.WlsSubjectHandle.run(WlsSubjectHandle.java:57)
	Truncated. see log file &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; complete stacktrace
&amp;gt; 
&amp;lt;Aug 16, 2013 3:12:32 PM PDT&amp;gt; &amp;lt;Error&amp;gt; &amp;lt;Deployer&amp;gt; &amp;lt;BEA-149265&amp;gt; &amp;lt;Failure occurred in the execution of deployment request with ID &lt;span class=&quot;code-quote&quot;&gt;&quot;1376691143681&quot;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; task &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;. Error is: &lt;span class=&quot;code-quote&quot;&gt;&quot;weblogic.application.ModuleException&quot;&lt;/span&gt;
weblogic.application.ModuleException
	at weblogic.servlet.internal.WebAppModule.startContexts(WebAppModule.java:1708)
	at weblogic.servlet.internal.WebAppModule.start(WebAppModule.java:781)
	at weblogic.application.internal.flow.ModuleStateDriver$3.next(ModuleStateDriver.java:213)
	at weblogic.application.internal.flow.ModuleStateDriver$3.next(ModuleStateDriver.java:208)
	at weblogic.application.utils.StateMachineDriver.nextState(StateMachineDriver.java:35)
	Truncated. see log file &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; complete stacktrace
Caused By: java.lang.NullPointerException
	at org.apache.logging.log4j.core.web.Log4jServletContainerInitializer.onStartup(Log4jServletContainerInitializer.java:44)
	at weblogic.servlet.internal.WebAppServletContext.initContainerInitializer(WebAppServletContext.java:1271)
	at weblogic.servlet.internal.WebAppServletContext.initContainerInitializers(WebAppServletContext.java:1229)
	at weblogic.servlet.internal.WebAppServletContext.preloadResources(WebAppServletContext.java:1726)
	at weblogic.servlet.internal.WebAppServletContext.start(WebAppServletContext.java:2740)
	Truncated. see log file &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; complete stacktrace
&amp;gt; 
&amp;lt;Aug 16, 2013 3:12:32 PM PDT&amp;gt; &amp;lt;Error&amp;gt; &amp;lt;Deployer&amp;gt; &amp;lt;BEA-149202&amp;gt; &amp;lt;Encountered an exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; attempting to commit the 7 task &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the application &lt;span class=&quot;code-quote&quot;&gt;&quot;_auto_generated_ear_&quot;&lt;/span&gt;.&amp;gt; 
&amp;lt;Aug 16, 2013 3:12:32 PM PDT&amp;gt; &amp;lt;Warning&amp;gt; &amp;lt;Deployer&amp;gt; &amp;lt;BEA-149004&amp;gt; &amp;lt;Failures were detected &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; initiating start task &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; application &lt;span class=&quot;code-quote&quot;&gt;&quot;_auto_generated_ear_&quot;&lt;/span&gt;.&amp;gt; 
&amp;lt;Aug 16, 2013 3:12:32 PM PDT&amp;gt; &amp;lt;Warning&amp;gt; &amp;lt;Deployer&amp;gt; &amp;lt;BEA-149078&amp;gt; &amp;lt;Stack trace &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; message 149004
weblogic.application.ModuleException
	at weblogic.servlet.internal.WebAppModule.startContexts(WebAppModule.java:1708)
	at weblogic.servlet.internal.WebAppModule.start(WebAppModule.java:781)
	at weblogic.application.internal.flow.ModuleStateDriver$3.next(ModuleStateDriver.java:213)
	at weblogic.application.internal.flow.ModuleStateDriver$3.next(ModuleStateDriver.java:208)
	at weblogic.application.utils.StateMachineDriver.nextState(StateMachineDriver.java:35)
	Truncated. see log file &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; complete stacktrace
Caused By: java.lang.NullPointerException
	at org.apache.logging.log4j.core.web.Log4jServletContainerInitializer.onStartup(Log4jServletContainerInitializer.java:44)
	at weblogic.servlet.internal.WebAppServletContext.initContainerInitializer(WebAppServletContext.java:1271)
	at weblogic.servlet.internal.WebAppServletContext.initContainerInitializers(WebAppServletContext.java:1229)
	at weblogic.servlet.internal.WebAppServletContext.preloadResources(WebAppServletContext.java:1726)
	at weblogic.servlet.internal.WebAppServletContext.start(WebAppServletContext.java:2740)
	Truncated. see log file &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; complete stacktrace
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If I remove the listener &amp;amp; the filter, it works fine.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;&lt;br/&gt;
I did some research and found that even though the web-app is version &quot;2.5&quot;, the &lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Log4jServletContainerInitializer&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; is getting invoked. &lt;/font&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12664156">LOG4J2-359</key>
            <summary>Log4jServletContextListener does not work on Weblogic 12.1.1 (12c) with web-app version &quot;2.5&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="beamerblvd">Nick Williams</assignee>
                                    <reporter username="abhinav.shah@gmail.com">Abhinav Shah</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Aug 2013 22:15:19 +0000</created>
                <updated>Mon, 19 Oct 2015 21:29:05 +0000</updated>
                            <resolved>Tue, 28 Jan 2014 04:35:06 +0000</resolved>
                                    <version>2.0-beta8</version>
                                    <fixVersion>2.0-rc1</fixVersion>
                                        <due></due>
                            <votes>3</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13742668" author="beamerblvd" created="Fri, 16 Aug 2013 22:27:26 +0000"  >&lt;p&gt;Thanks for the thorough bug report. This may simply be a documentation issue. After re-reading the relevant part of the spec, it would seem that Servlet 3.0+ containers must invoke any &lt;tt&gt;Log4jServletContainerInitializer&lt;/tt&gt; implementations even if the web-app version is 2.5. This seems like a bad decision on the part of the spec committee, but if it&apos;s the case the documentation will have to be refactored. I need to discuss it with some fellow Java EE experts and confirm my suspicions.&lt;/p&gt;

&lt;p&gt;In the meantime, can you take the &lt;tt&gt;&amp;lt;listener&amp;gt;&lt;/tt&gt;, &lt;tt&gt;&amp;lt;filter&amp;gt;&lt;/tt&gt;, and &lt;tt&gt;&amp;lt;filter-mapping&amp;gt;&lt;/tt&gt; out of your deployment descriptor and see if it starts working? Note that you might starting seeing a different error (&lt;tt&gt;NullPointerException&lt;/tt&gt;) due to bug &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-344&quot; title=&quot;Log4j2 doesnt work with Weblogic 12c&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-344&quot;&gt;&lt;del&gt;LOG4J2-344&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13742677" author="abhinav.shah@gmail.com" created="Fri, 16 Aug 2013 22:33:54 +0000"  >&lt;p&gt;Thanks Nick. I already mentioned that if I remove the listener &amp;amp; the filter, it works fine.&lt;/p&gt;</comment>
                            <comment id="13742680" author="beamerblvd" created="Fri, 16 Aug 2013 22:38:48 +0000"  >&lt;p&gt;Oh. Haha. I missed that part, somehow. Thanks!&lt;/p&gt;</comment>
                            <comment id="13742828" author="ralph.goers@dslextreme.com" created="Sat, 17 Aug 2013 03:42:02 +0000"  >&lt;p&gt;Nick, Log4jServletContainerInitializer is adding Log4jServletContextListener as a listener but then appears to act as if its contextInitialized method is not going to be called. From my reading and in looking at &lt;a href=&quot;http://svn.apache.org/repos/asf/tomcat/trunk/test/org/apache/catalina/startup/TestListener.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/tomcat/trunk/test/org/apache/catalina/startup/TestListener.java&lt;/a&gt; that doesn&apos;t appear to be the case. Shouldn&apos;t the onStartup method look like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onStartup(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt;&amp;gt; classes, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ServletContext servletContext) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; ServletException {
        servletContext.log(&lt;span class=&quot;code-quote&quot;&gt;&quot;Log4jServletContainerInitializer starting up Log4j in Servlet 3.0+ environment.&quot;&lt;/span&gt;);
        servletContext.addListener(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Log4jServletContextListener());

        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; FilterRegistration.Dynamic filter = servletContext.addFilter(&lt;span class=&quot;code-quote&quot;&gt;&quot;log4jServletFilter&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Log4jServletFilter());
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (filter != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            filter.addMappingForUrlPatterns(EnumSet.allOf(DispatcherType.class), &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;/*&quot;&lt;/span&gt;);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Of course, if the user also configures the ServletContextListener in web.xml also then it will still try to initialize and destroy twice, but that can be handled pretty easily.&lt;/p&gt;</comment>
                            <comment id="13755213" author="abhinav.shah@gmail.com" created="Fri, 30 Aug 2013 22:38:05 +0000"  >&lt;p&gt;Ok I fixed this issue. Since I am not a contributor to log4j2, I am just going to attach the source files here.&lt;/p&gt;</comment>
                            <comment id="13755214" author="abhinav.shah@gmail.com" created="Fri, 30 Aug 2013 22:38:44 +0000"  >&lt;p&gt;Issue fixed. &lt;/p&gt;</comment>
                            <comment id="13755244" author="beamerblvd" created="Fri, 30 Aug 2013 23:16:10 +0000"  >&lt;p&gt;I shouldn&apos;t have closed this as duplicate. There is a separate issues here, which needs to be resolved in documentation.&lt;/p&gt;</comment>
                            <comment id="13755272" author="abhinav.shah@gmail.com" created="Fri, 30 Aug 2013 23:48:24 +0000"  >&lt;p&gt;Attaching svn patch.&lt;/p&gt;</comment>
                            <comment id="13755281" author="beamerblvd" created="Sat, 31 Aug 2013 00:08:45 +0000"  >&lt;p&gt;Your IDE has reformatted the JavaDoc and Java code in the file. This makes it very difficult to separate out the changes you made from the reformatting. Please correct this. Patches should not reformat code that doesn&apos;t change. You will likely need to disable this auto-reformatting in your IDE, or change the settings to reflect the Log4j coding standards (for example, 120-character lines, not 80-character lines as it appears your IDE is enforcing).&lt;/p&gt;</comment>
                            <comment id="13755309" author="abhinav.shah@gmail.com" created="Sat, 31 Aug 2013 00:48:18 +0000"  >&lt;p&gt;Nick. I just removed all the code formatting. Attaching new patch.&lt;/p&gt;</comment>
                            <comment id="13755416" author="ralph.goers@dslextreme.com" created="Sat, 31 Aug 2013 05:28:53 +0000"  >&lt;p&gt;The problem with this patch is that nothing gets control when the servlet is undeployed or shutdown. That is why I suggested removing the initialization of the WebInitializer from the onStartup method.&lt;/p&gt;</comment>
                            <comment id="13755447" author="abhinav.shah@gmail.com" created="Sat, 31 Aug 2013 06:48:51 +0000"  >&lt;p&gt;Ralph,&lt;br/&gt;
Even if we remove the initialization code from the WebInitializer, there will still be two instances of the WebInitializer. One from web.xml and another which gets added from the Log4jServletContextInitializer. So the issue will still be there.&lt;/p&gt;</comment>
                            <comment id="13755535" author="beamerblvd" created="Sat, 31 Aug 2013 15:44:28 +0000"  >&lt;p&gt;The problem is purely in documentation. The documentation just needs to be changed to say that if you&apos;re running on a Servlet 3.0 or newer environment, you don&apos;t have to manually initialize Log4j; one should &lt;em&gt;not&lt;/em&gt; put the Log4j listener and filter in &lt;tt&gt;web.xml&lt;/tt&gt; in a Servlet 3.0 or newer environment.&lt;/p&gt;</comment>
                            <comment id="13755543" author="abhinav.shah@gmail.com" created="Sat, 31 Aug 2013 16:03:54 +0000"  >&lt;p&gt;Nick,&lt;br/&gt;
This goes back to the original problem. In a servlet 3.0+ environment, but if your web.xml has version attribute 2.5, you would need a listener.&lt;/p&gt;

&lt;p&gt;I am running weblogic 12c on my desktop. However I am setting version attribute as 2.5 in my web.xml so that my code runs on the production servers which are running old version of weblogic. So I need the ability to have listener configured in web.xml.&lt;/p&gt;

&lt;p&gt;PS: this same problem exists in glassfish 4.0.&lt;/p&gt;</comment>
                            <comment id="13755546" author="beamerblvd" created="Sat, 31 Aug 2013 16:12:39 +0000"  >&lt;p&gt;Okay. I think I understand something that perhaps I didn&apos;t understand before. It sounds like in a Servlet 3.0 environment with version 2.5 in web.xml, the container calls &lt;tt&gt;onStartup&lt;/tt&gt; on the initializer, but ignores the listener that it adds programmatically. This behavior is confusing and arbitrary, and I suspect other containers don&apos;t do it this exact same way.&lt;/p&gt;

&lt;p&gt;Because of what I perceive to be a high likelihood of uncertainty in this situation (Servlet 3.0+ container with 2.5- application), I think Abhinav&apos;s patch is essentially correct. However, I would extend it further: the initializer just needs to do &lt;em&gt;nothing&lt;/em&gt; in &lt;tt&gt;onStartup&lt;/tt&gt; if the Servlet version is less than 3. No adding a listener, no adding a filter. This way, the behavior is guaranteed to be consistent across containers.&lt;/p&gt;

&lt;p&gt;I&apos;ll make this change.&lt;/p&gt;</comment>
                            <comment id="13755559" author="beamerblvd" created="Sat, 31 Aug 2013 17:25:11 +0000"  >&lt;p&gt;Thanks for the patch. I tweaked it slightly to provide more extensive testing, ensure the feature is used correctly, and ensure that it does nothing at all if the application version is not 3.0 or greater. This is fixed in trunk. Can you check out, build, verify and close?&lt;/p&gt;</comment>
                            <comment id="13755562" author="ralph.goers@dslextreme.com" created="Sat, 31 Aug 2013 18:01:31 +0000"  >&lt;p&gt;I still don&apos;t think this is correct. In a servlet 3.0 environment it would still be valid for the user to specify a servlet context listener in their web.xml would it not? In that case the problem still exists.&lt;/p&gt;

&lt;p&gt;I also have to say that the more I think about this the less comfortable I am in having the initializer run automagically in a servlet 3.0 container. I am thinking perhaps the user should have to provide the initializer instead of us. If the log4j jar is outside the WEB-INF/lib of the application then the log4j initializer&apos;s onStartup method will be invoked when every new application is started. This is likely to be undesirable.  Does Spring automatically start initialization just because the spring jars are present in a servlet 3.0 environment?&lt;/p&gt;</comment>
                            <comment id="13755572" author="beamerblvd" created="Sat, 31 Aug 2013 18:22:47 +0000"  >&lt;p&gt;1. No, it would not be valid to specify the listener in &lt;tt&gt;web.xml&lt;/tt&gt; in a Servlet 3.0 application (the container doesn&apos;t matter, only the effective application version).&lt;br/&gt;
2. It would also be completely unnecessary for them to manually specify the listener in &lt;tt&gt;web.xml&lt;/tt&gt; in a Servlet 3.0 application. Doing so would not provide them any benefit, as they can customize the behavior using context parameters without manually specifying the listener.&lt;br/&gt;
3. If they &lt;em&gt;did&lt;/em&gt; manually specify the listener in &lt;tt&gt;web.xml&lt;/tt&gt;, it would not have any negative impact on the application working correctly, because the second call to initialize the &lt;tt&gt;Log4jWebInitializer&lt;/tt&gt; is ignored. The problem present in this bug was specifically that the &lt;em&gt;filter&lt;/em&gt; was being added twice (which might not be immediately clear since the errors were all in the listener and the initializer). It&apos;s important for the filter to be added so that it executes before any filters defined in &lt;tt&gt;web.xml&lt;/tt&gt;, so adding it in the initializer is the safest route. In Servlet 2.5 applications the filter won&apos;t be added in the initializer (and neither will the listener). In Servlet 3.0+ applications, Log4j makes in clear with a specific error message that the user must not specify the filter in &lt;tt&gt;web.xml&lt;/tt&gt;.&lt;br/&gt;
4. The &lt;tt&gt;Log4jWebInitializer&lt;/tt&gt; &lt;em&gt;must&lt;/em&gt; run automatically in a &lt;tt&gt;ServletContainerInitializer&lt;/tt&gt;. This is not an option. The reason for this is that other &lt;tt&gt;ServletContainerInitializer&lt;/tt&gt; implementations, such as the one provided by Spring Framework, may trigger behavior that causes logging to take place. If this happens before the initializer runs, all bets are off. Log4j will not start up correctly and will cause errors on shutdown.&lt;/p&gt;</comment>
                            <comment id="13755578" author="ralph.goers@dslextreme.com" created="Sat, 31 Aug 2013 18:53:17 +0000"  >&lt;p&gt;First, I don&apos;t understand how it is invalid to specify a servlet context listener in the web.xml. I don&apos;t believe they were removed from the spec. Someone upgrading from 2.5 to 3 is quite likely to just change the version number and leave the rest alone. &lt;/p&gt;

&lt;p&gt;Although you are indeed preventing the error by now detecting that the filter is being added a second time, I don&apos;t understand why you are throwing an exception. Just log a warning. The application shouldn&apos;t fail because they manually specified it.&lt;/p&gt;

&lt;p&gt;I understand that the ServletContainerInitializer must run automatically.  I just really don&apos;t like it being the default behavior of just having the log4j core jar being present. I am quite sure it is going to cause problems for some users.  In Spring&apos;s case it only initializes WebApplicationInitializer classes. If the web app has none it is effectively a no-op. In our case if the log4j jar is in the container&apos;s class path then every app will initialize whether it actually uses log4j or not and whether it has a configuration or not.&lt;/p&gt;</comment>
                            <comment id="13755580" author="ralph.goers@dslextreme.com" created="Sat, 31 Aug 2013 18:57:50 +0000"  >&lt;p&gt;Further thoughts on this.&lt;/p&gt;

&lt;p&gt;I&apos;d probably be more in favor of this if the initializer looked for a configuration being present and exited if it couldn&apos;t find one. But what if a user wants to create their own configuration factory?  They can&apos;t override our initializer or replace it because it is embedded in the jar. Unless you provide extension points for users then this is just going to create a mess.&lt;/p&gt;

&lt;p&gt;I don&apos;t recall seeing it in the spec, but is there some way a user can insure that their servlet container initializer runs first?  If we are going to keep this I would like to see examples of how users can perform customizations.&lt;/p&gt;</comment>
                            <comment id="13755597" author="ralph.goers@dslextreme.com" created="Sat, 31 Aug 2013 20:51:09 +0000"  >&lt;p&gt;So I found your questions and the answers on SCI ordering at &lt;a href=&quot;http://www.mail-archive.com/users@tomcat.apache.org/msg106625.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/users@tomcat.apache.org/msg106625.html&lt;/a&gt; and now I am really confused. From what I understand even if Log4j and Spring both provide initializers there is still no guarantee that Log4j will initialize before Spring. It would seem to me that the only way to solve that would be to provide a Spring WebApplicationInitializer that is guaranteed to be the first one called. If that is done then the Log4j ServletContainerInitializer is redundant. &lt;/p&gt;

&lt;p&gt;Am I misunderstanding something?&lt;/p&gt;</comment>
                            <comment id="13755609" author="ralph.goers@dslextreme.com" created="Sat, 31 Aug 2013 21:21:34 +0000"  >&lt;p&gt;I am inclined to think that we need to introduce a Log4jWebInitializer annotation and do exactly what Spring is doing to allow applications to wire in stuff at startup.  However, we also need to allow for the whole thing to be bypassed if it has already been done, such as if a Spring WebApplicationInitializer sets up logging.&lt;/p&gt;</comment>
                            <comment id="13755625" author="beamerblvd" created="Sat, 31 Aug 2013 22:53:06 +0000"  >&lt;p&gt;So. Many. Questions. And stop editing comments hours later! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m going to address the ordering issue, first. You are correct that, &lt;em&gt;according to the spec&lt;/em&gt;, the order that SCIs are executed in is unspecified. This is an oversight that I &lt;a href=&quot;https://java.net/jira/browse/SERVLET_SPEC-79&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;intend to lobby hard to have corrected in Servlet 3.2&lt;/a&gt; (and judging by the Tomcat mailing list, I&apos;ll have some backup). However, in practice, this is not actually the case. If you read the responses to the message you link to, you will see that Tomcat orders SCIs according to the web-fragment ordering. This is legal, because the spec doesn&apos;t prohibit it, it just doesn&apos;t require it. Furthermore, five of the eight major containers (Tomcat, TomEE, JBoss, WebLogic, and WebSphere) order SCIs according to the web-fragment ordering. After further inspection, it appears that GlassFish, Jetty, and Resin &lt;em&gt;do&lt;/em&gt; execute them in &quot;random&quot; order (&lt;b&gt;ugh&lt;/b&gt;). However, with that said, this &quot;random&quot; order is actually alphabetic by JAR name, and log4j*.jar comes before spring*.jar. So, &lt;b&gt;most&lt;/b&gt; users will &lt;b&gt;never&lt;/b&gt; see a problem with ordering.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;(Yes, I&apos;m operating under the assumption that Spring&apos;s SCI is the one we&apos;re most concerned about. I&apos;ve yet to see any other SCIs in any other third-party libraries or in containers that could result in inadvertent initialization of Log4j. I am, nevertheless, filing improvement requests with GlassFish, Jetty, and Resin asking them to follow what other containers do.)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;With that out of the way, I&apos;m not saying it&apos;s &quot;invalid to specify a servlet context listener in the &lt;tt&gt;web.xml&lt;/tt&gt;&quot; in Servlet 3.0+. I&apos;m saying it&apos;s invalid (but harmless) to re-define &lt;b&gt;Log4j&apos;s&lt;/b&gt; listener in &lt;tt&gt;web.xml&lt;/tt&gt; in Servlet 3.0+. I&apos;m not completely opposed to changing the exception to a warning, but I don&apos;t agree with the idea, either. Added in the SCI, it ensures that the filter runs before any filters in &lt;tt&gt;web.xml&lt;/tt&gt;. It also ensures that it runs before any filters in other SCIs (with the ordering issue kept in mind, of course). The exception lets the user know in no uncertain terms that Log4j might not work correctly because the filter wasn&apos;t defined early enough, and that they can very simply fix the issue by taking the filter out of their &lt;tt&gt;web.xml&lt;/tt&gt;. That&apos;s my stance.&lt;/p&gt;

&lt;p&gt;Web applications cannot define their own &lt;tt&gt;ServletContainerInitializer&lt;/tt&gt; implementations without putting them in a JAR file within WEB-INF/lib, so we can&apos;t reasonably expect a user to do this. An annotation is a potential idea, but I just don&apos;t see the necessity. The existing code &lt;em&gt;is&lt;/em&gt; capable of initializing correctly. Just because there was a bug doesn&apos;t mean the whole concept is fatally flawed. I &lt;b&gt;strongly&lt;/b&gt; stand behind the idea of the user not having to do &lt;b&gt;anything&lt;/b&gt; other than add &lt;tt&gt;log4j2.xml&lt;/tt&gt; to their application unless they need to customize behavior (which they can do using the context parameters; they don&apos;t need to override the existing initializer to do this). If they &lt;em&gt;really&lt;/em&gt; need to stop Log4j from auto-initializing in Servlet 3.0+, we don&apos;t have to provide a mechanism to support this. They can use &lt;tt&gt;&amp;lt;absolute-ordering&amp;gt;&lt;/tt&gt; in &lt;tt&gt;web.xml&lt;/tt&gt; to exclude the Log4j web-fragment. I&apos;m okay with adding an example of doing this to the documentation.&lt;/p&gt;

&lt;p&gt;I &lt;b&gt;do&lt;/b&gt; agree that the initializer should not do anything if the Log4j JARs come from the container and the application isn&apos;t actually using Log4j. What is the &lt;b&gt;correct&lt;/b&gt; way to detect this? I believe this is sufficient, but I could be wrong:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If the Log4j context parameters are specified, the application obviously intends to use Log4j, so initialize it.&lt;/li&gt;
	&lt;li&gt;If the Log4j context parameters are not specified but one of the standard configuration files is present, the application obviously intends to use Log4j, so initialize it.&lt;/li&gt;
	&lt;li&gt;Otherwise, don&apos;t initialize Log4j.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If this is correct, this leads me to a question. How do I look for the &quot;standard configuration&quot; without Log4j initializing the null or default configuration if it doesn&apos;t find one?&lt;/p&gt;</comment>
                            <comment id="13755633" author="ralph.goers@dslextreme.com" created="Sun, 1 Sep 2013 01:22:39 +0000"  >&lt;p&gt;Sorry for editing the comments but I keep finding typos or need to add more detail. For example, when I said annotation in my last comment it really should have been &quot;interface&quot; as that is what @HandleTypes expects. &lt;/p&gt;

&lt;p&gt;First, I hate relying on behaviors that can change from release to release rather than something in the spec, so I applaude your effort to get that corrected. &lt;/p&gt;

&lt;p&gt;I disagree that it is invalid to define Log4j&apos;s listener in web.xml. It may be undesirable but it is not invalid. Again, logging a warning that says that it might not work correctly is preferable to aborting the application. Shouldn&apos;t it behave essentially as it does in 2.5?&lt;/p&gt;

&lt;p&gt;You are saying we can&apos;t reasonably expect users to create jars that they place in WEB-INF/lib? You can&apos;t be serious. I do that all the time. &lt;/p&gt;

&lt;p&gt;I don&apos;t think it is any more unreasonable to expect an application to provide an initializer for Log4j than it is for Spring, although it will occur less frequently.&lt;/p&gt;

&lt;p&gt;The problem with locating the &quot;proper&quot; configuration file is that you don&apos;t know whether it is json, xml or something else so you essentially have to run through all the same logic that ConfigurationFactory does. What if the user wants to place the Log4j jar in the container but then provide a custom configuration factory in one of the web apps? Right now we don&apos;t support that but it wouldn&apos;t be a big deal to add a new Configurator method that accepts a ConfigurationFactory as an argument. The user would then want to set this up in their own Log4jInitializer by doing:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onStartup(ServletContext servletContext) {
    ConfigurationFactory factory = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyConfigurationFactory(servletContext.getInitParam(&lt;span class=&quot;code-quote&quot;&gt;&quot;MyInitData&quot;&lt;/span&gt;));
    LoggerContext context = Configurator.initialize(servletContext.getServletContextName(), servletContext.getClassLoader(), factory, servletContext);
    servletContext.setAttribute(org.apache.logging.log4j.core.helpers.Constants.LOG4J_SERVLET_CONTEXT, context);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I strongly believe that if we are going to have a ServletContainerInitializer at all that it must support this kind of flexibility. In addition, we also need to allow the user to do the same sort of thing from a Spring WebApplicationInitializer. Notice that this could be handled by checking whether the ServletContext attribute for the LoggerContext has been set.   &lt;/p&gt;</comment>
                            <comment id="13757982" author="abhinav.shah@gmail.com" created="Wed, 4 Sep 2013 17:18:19 +0000"  >&lt;p&gt;There was an issue with using servletContext.getMajorVersion(), as it gives the major version of the Servlet API that this servlet container supports.&lt;/p&gt;

&lt;p&gt;This returns 3 in a servlet 3 environment even though web.xml version attribute is 2.5.&lt;/p&gt;

&lt;p&gt;I changed it to use servletContext.getEffectiveMajorVersion() instead. &lt;br/&gt;
I tested and it works as expected.&lt;/p&gt;</comment>
                            <comment id="13757984" author="abhinav.shah@gmail.com" created="Wed, 4 Sep 2013 17:19:20 +0000"  >&lt;p&gt;Please check-in the patch I have attached.&lt;/p&gt;</comment>
                            <comment id="13759177" author="abhinav.shah@gmail.com" created="Thu, 5 Sep 2013 16:00:33 +0000"  >&lt;p&gt;This patch is not working with Weblogic 12c. It works with Glassfish 4.0.&lt;br/&gt;
Weblogic for some reason does not give the right &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; servletContext.getEffectiveMajorVersion() &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;.&lt;br/&gt;
With web.xml version attribute = 2.5, &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; servletContext.getEffectiveMajorVersion()  &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; should have returned 2, but Weblogic gives 3.&lt;/p&gt;

&lt;p&gt;Glassfish on other hand returns 2 as expected.&lt;/p&gt;

&lt;p&gt;We need to find a new fix.&lt;/p&gt;</comment>
                            <comment id="13883743" author="beamerblvd" created="Tue, 28 Jan 2014 04:35:06 +0000"  >&lt;p&gt;This is fixed with r1561933. Unfortunately, WebLogic is simply not spec compliant here. There&apos;s no standard way other than &lt;tt&gt;getEffectiveMajorVersion&lt;/tt&gt; to detect the Servlet version. However, a new setting being added (which will be documented) as part of a separate bug allows you to disable auto-initialization, which you can do as a work around in WebLogic with you set the Servlet version to 2.5. Meanwhile, I suggest you report this bug with &lt;tt&gt;getEffectiveMajorVersion&lt;/tt&gt; to Oracle/WebLogic. I have seen others complaining about it online, but no responses from Oracle.&lt;/p&gt;</comment>
                            <comment id="14964089" author="galo galarza" created="Mon, 19 Oct 2015 21:29:05 +0000"  >&lt;p&gt;Muchas GRACIAS Nick Williams&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12654377">LOG4J2-293</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12669209">SYNCOPE-414</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12663178">LOG4J2-344</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12601406" name="LOG4J2-359.patch" size="3177" author="abhinav.shah@gmail.com" created="Wed, 4 Sep 2013 17:18:19 +0000"/>
                            <attachment id="12600873" name="Log4jServletContainerInitializer.java" size="2464" author="abhinav.shah@gmail.com" created="Fri, 30 Aug 2013 22:38:44 +0000"/>
                            <attachment id="12600874" name="Log4jServletContainerInitializerTest.java" size="4016" author="abhinav.shah@gmail.com" created="Fri, 30 Aug 2013 22:38:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>344157</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 5 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ncmf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>344458</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>