<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:42:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-3083] Why the logger get by Slf4j LoggerFactory.getILoggerFactory() can only use current LoggerContext</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-3083</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;In SpringBoot project with &lt;ins&gt;test&lt;/ins&gt; profile,&lt;/p&gt;

&lt;p&gt;org.slf4j.LoggerFactory.getLogger(&quot;xxx&quot;) can get test profile LoggerContext and read configuration from log4j2-test.xml.&lt;/p&gt;

&lt;p&gt;But&lt;/p&gt;

&lt;p&gt;org.slf4j.LoggerFactory.getILoggerFactory().getLogger(&quot;xxx&quot;) can only get current LoggerContext and read configuration from log4j2.xml.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Is it designed like this? Why?&lt;/p&gt;</description>
                <environment>&lt;p&gt;Spring Boot&#160;2.4.5&lt;/p&gt;

&lt;p&gt;Slf4j&lt;/p&gt;</environment>
        <key id="13374938">LOG4J2-3083</key>
            <summary>Why the logger get by Slf4j LoggerFactory.getILoggerFactory() can only use current LoggerContext</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ckozak">Carter Kozak</assignee>
                                    <reporter username="hao5ang">wanghao</reporter>
                        <labels>
                            <label>newbie</label>
                    </labels>
                <created>Sun, 25 Apr 2021 19:03:22 +0000</created>
                <updated>Mon, 9 Aug 2021 07:46:00 +0000</updated>
                            <resolved>Wed, 4 Aug 2021 13:49:29 +0000</resolved>
                                    <version>2.13.3</version>
                    <version>2.14.1</version>
                                    <fixVersion>2.15.0</fixVersion>
                                    <component>SLF4J Bridge</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17332806" author="ralph.goers@dslextreme.com" created="Mon, 26 Apr 2021 23:08:07 +0000"  >&lt;p&gt;I have no idea, but Log4j doesn&apos;t control what configuration files you can access via Spring profiles.&#160; Looking at the SLF4J code I see no difference in what the two methods you are referencing actually do. LoggerFactory.getLogger() call getILoggerFactory() under the covers and then calls getLogger().&#160;&lt;/p&gt;

&lt;p&gt;Closing as none of this has anything to do with Log4j.&lt;/p&gt;</comment>
                            <comment id="17333211" author="hao5ang" created="Tue, 27 Apr 2021 12:54:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rgoers&quot; class=&quot;user-hover&quot; rel=&quot;rgoers&quot;&gt;rgoers&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Although these two methods eventually call the same method, their call stacks are different, resulting in different LoggerContext obtained by Log4jLoggerFactory.getContext() in the log4j-slf4j-impl package, and different configuration files are used in the end.&lt;br/&gt;
I think this is an implementation issue of log4j-slf4j-impl.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Log4jLoggerFactory.java&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// code placeholder
&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; FQCN = Log4jLoggerFactory.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName();
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; PACKAGE = &lt;span class=&quot;code-quote&quot;&gt;&quot;org.slf4j&quot;&lt;/span&gt;;

@Override
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; LoggerContext getContext() {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; anchor = StackLocatorUtil.getCallerClass(FQCN, PACKAGE);
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; anchor == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? LogManager.getContext() : getContext(StackLocatorUtil.getCallerClass(anchor));
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17334487" author="ralph.goers@dslextreme.com" created="Wed, 28 Apr 2021 06:27:57 +0000"  >&lt;p&gt;StackLocatorUtil.getCallerClass() walks the stack until it finds the FQCN. It then skips any stack entries that match the FQCN. It then stops when it has a stack element that matches the package. That seems wrong. It should be looking for the first class that doesn&apos;t match the package to find the caller.&#160; I will need to create a unit test to verify this is a bug.&lt;/p&gt;

&lt;p&gt;That said, I would think this would always result in the wrong class being used as it should always end up referencing org.slf4j.LoggerFactory.&lt;/p&gt;</comment>
                            <comment id="17334719" author="ckozak" created="Wed, 28 Apr 2021 13:04:26 +0000"  >&lt;p&gt;I recently modified this code, but I tried not to modify the algorithm much, so I likely didn&apos;t make the issue any better. In hindsight I should have thought to add a status-logger trace  level line to print the anchor class for easier debugging.&lt;/p&gt;

&lt;p&gt;&amp;gt; StackLocatorUtil.getCallerClass() walks the stack until it finds the FQCN. It then skips any stack entries that match the FQCN. It then stops when it has a stack element that matches the package. That seems wrong. It should be looking for the first class that doesn&apos;t match the package to find the caller.  I will need to create a unit test to verify this is a bug.&lt;/p&gt;

&lt;p&gt;My understanding was that we wanted to find Log4jLoggerFactory, walk up (through the AbstractLoggerFactory call) until we found slf4j code, which we expect to be org.slf4j.LoggerFactory.getLogger(String). In this case, calls come from non-slf4j sources which means we traverse the entire stack (fairly expensive), come up with no anchor class, and use the default context. I think you&apos;re right that we want to use a set of opt-out package prefixes rather than opt-in, so that we can walk the tree to find the first class that&apos;s neither from org.apache.logging.log4j nor org.slf4j.&lt;/p&gt;

&lt;p&gt;I can take this issue given my recent work in this area of the codebase.&lt;/p&gt;
</comment>
                            <comment id="17354078" author="ralph.goers@dslextreme.com" created="Sun, 30 May 2021 17:14:20 +0000"  >&lt;p&gt;The goal of getCallerClass is as it sounds - to obtain the Class that called getLogger(). We need that Class to determine the ClassLoader which is how ClassLoaderContextSelector will determine which LoggerContext to use.&lt;/p&gt;

&lt;p&gt;I guess we should set up a unit test that verifies whether the current code works or not and will verify the fix if it doesn&apos;t. I&apos;d be sort of surprised if there isn&apos;t already a test, but there may not be one for this exact case.&lt;/p&gt;</comment>
                            <comment id="17392332" author="ckozak" created="Tue, 3 Aug 2021 14:20:25 +0000"  >&lt;p&gt;I don&apos;t see any direct testing of the slf4j caller lookup implementation, this makes sense because I believe it&apos;s currently broken. It&apos;s particularly difficult to test because we map from caller location to a class, to a classloader which is used to locate the logger context, so it&apos;s hard to validate across so many layers of indirection.&lt;/p&gt;

&lt;p&gt;I&apos;ve got a work-in-progress test which leverages trace-level status-logger logging of the detected caller class to verify our expectations. Unfortunately this doesn&apos;t work with all tests yet because the slf4j-impl module tests also depend on log4j-to-slf4j for OverflowTest (expecting LoggerFactory.getLogger to throw an exception when log4j-to-slf4j is present).&lt;/p&gt;

&lt;p&gt;The second problem is that it&apos;s difficult to test all codepaths &amp;#8211; I don&apos;t think our tests validate code in the java9 modules unless that code is explicitly tested. multi-release jars are difficult to test, and I&apos;ve only managed to make multirelease jar testing work using gradle since that&apos;s what we use at work, although that mr-jar setup isn&apos;t particularly maintainable or easy to work with.&lt;/p&gt;</comment>
                            <comment id="17392338" author="ckozak" created="Tue, 3 Aug 2021 14:36:19 +0000"  >&lt;p&gt;Regarding the &lt;tt&gt;log4j-to-slf4j&lt;/tt&gt; problem, I see our configuration in pom.xml which excludes the module from everything except &lt;tt&gt;OverflowTest.java&lt;/tt&gt;, however my IDE is unable to pick that up. That&apos;s a relief, I had thought our tests weren&apos;t running as expected &amp;#8211; this makes things much easier.&lt;/p&gt;

&lt;p&gt;I can likely get sufficient coverage of the java9 code by porting it to the master branch where we no longer need multirelease jars. It will be unfortunate that tests don&apos;t run directly against the release-2.x code, but the coverage should give us some degree of confidence.&lt;/p&gt;</comment>
                            <comment id="17392408" author="jvz" created="Tue, 3 Aug 2021 16:36:49 +0000"  >&lt;p&gt;Look for any tests with the phrase &quot;location test&quot; or &quot;LocationTest&quot; in it for numerous examples of verifying the caller location in different situations. And yes, some of these were added after noticing it was broken in other areas in the past.&lt;/p&gt;</comment>
                            <comment id="17392564" author="ckozak" created="Tue, 3 Aug 2021 21:58:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mattsicker&quot; class=&quot;user-hover&quot; rel=&quot;mattsicker&quot;&gt;mattsicker&lt;/a&gt; I&apos;m not sure those give us quite what I was looking for, the location information is easier to verify because it&apos;s included in log events, however the caller information we collect to select the correct context doesn&apos;t appear to be verified there. Very possible that I&apos;ve missed something though!&lt;br/&gt;
I think I&apos;ve managed a reasonable test in this PR which also gives us logging we can use to verify in production environments: &lt;a href=&quot;https://github.com/apache/logging-log4j2/pull/553&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/logging-log4j2/pull/553&lt;/a&gt; What do you think?&lt;/p&gt;</comment>
                            <comment id="17393171" author="jira-bot" created="Wed, 4 Aug 2021 13:46:24 +0000"  >&lt;p&gt;Commit 609ff5f284e5e916c01b24feeb383cfeebc7d0cb in logging-log4j2&apos;s branch refs/heads/release-2.x from Carter Kozak&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=609ff5f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=609ff5f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3083&quot; title=&quot;Why the logger get by Slf4j LoggerFactory.getILoggerFactory() can only use current LoggerContext&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3083&quot;&gt;&lt;del&gt;LOG4J2-3083&lt;/del&gt;&lt;/a&gt; Fix slf4j calling class lookup using both accessors&lt;/p&gt;

&lt;p&gt;`LoggerFactory.getLogger(name/class)` as well as&lt;br/&gt;
`LoggerFactory.getILoggerFactory().getLogger(name)`.&lt;/p&gt;</comment>
                            <comment id="17393173" author="jira-bot" created="Wed, 4 Aug 2021 13:46:33 +0000"  >&lt;p&gt;Commit 839dfb856cf46682062bd7f8746c0157a355aae4 in logging-log4j2&apos;s branch refs/heads/master from Carter Kozak&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=839dfb8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=839dfb8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-3083&quot; title=&quot;Why the logger get by Slf4j LoggerFactory.getILoggerFactory() can only use current LoggerContext&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-3083&quot;&gt;&lt;del&gt;LOG4J2-3083&lt;/del&gt;&lt;/a&gt; Fix slf4j calling class lookup using both accessors&lt;/p&gt;

&lt;p&gt;`LoggerFactory.getLogger(name/class)` as well as&lt;br/&gt;
`LoggerFactory.getILoggerFactory().getLogger(name)`.&lt;/p&gt;</comment>
                            <comment id="17393175" author="ckozak" created="Wed, 4 Aug 2021 13:49:29 +0000"  >&lt;p&gt;I&apos;ve merged a fix into release-2.x and master. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hao5ang&quot; class=&quot;user-hover&quot; rel=&quot;hao5ang&quot;&gt;hao5ang&lt;/a&gt; could you use the latest 2.15 snapshot artifacts and close this ticket if the problem is resolved?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 15 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0qfk0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>