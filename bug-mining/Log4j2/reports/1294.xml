<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:40:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-2266] Log4j2 throws NoClassDefFoundError in Java 8</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-2266</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;During Unit Tests run using JDK 8 and Log4j2 v2.10.0 - getting this as part of exception stack:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;java.lang.NoClassDefFoundError: Could not initialize class &lt;br/&gt;
 org.apache.logging.log4j.util.PropertiesUtil&lt;br/&gt;
 &#160;&#160; &#160;at org.apache.logging.log4j.status.StatusLogger.&amp;lt;clinit&amp;gt;(StatusLogger.java:71)&lt;br/&gt;
 &#160;&#160; &#160;at org.apache.logging.log4j.LogManager.&amp;lt;clinit&amp;gt;(LogManager.java:60)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;and issue seems to be somehow related to what is reported so far against JDK 9 here: &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2129&quot; title=&quot;Log4j2 throws NoClassDefFoundError in Java 9&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2129&quot;&gt;&lt;del&gt;LOG4J2-2129&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If some patch on top of v2.10.0 is available to test - please let me know where to download it from.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;While running same UTs with same JDK 8 and v2.8.2 - issue is not observed.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And question which I have here - why not introduce JDK8 compatibility runtime mode while things with JDK9 are not yet that stable? So it could continue use same logic as of v2.8.2 around that ServiceLoader and not cause side effects.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13139890">LOG4J2-2266</key>
            <summary>Log4j2 throws NoClassDefFoundError in Java 8</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="andrejusc">Andrejus Chaliapinas</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 Feb 2018 12:33:56 +0000</created>
                <updated>Sat, 20 Aug 2022 18:35:42 +0000</updated>
                            <resolved>Thu, 31 Jan 2019 03:19:47 +0000</resolved>
                                    <version>2.10.0</version>
                                    <fixVersion>2.11.2</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16372179" author="ralph.goers@dslextreme.com" created="Wed, 21 Feb 2018 23:13:53 +0000"  >&lt;p&gt;I&apos;m unclear what you are doing - unit tests of what?  All the Log4j 2 unit tests pass when building with Java 8 - I do it all the time.&lt;/p&gt;</comment>
                            <comment id="16372582" author="andrejusc" created="Thu, 22 Feb 2018 09:21:34 +0000"  >&lt;p&gt;Sorry for my unlear point about unit tests - those are mine for my project, using JUnit+Powermock combination. When Log4j2 v2.8.2 is in classpath - they work. When Log4j2 v2.10.0 - some of them fail with above error.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I didn&apos;t yet attempt to build master branch with JDK9 as according to Matt I could do rebuild with only JDK9 if I&apos;d like to add some extra debugging/etc. to understand issue better myself. Curently I&apos;m just using JDK8.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;That&apos;s why my proposal is to introduce JDK8 compatibility setting, which will allow logic around ServiceLoader to work the way it was for v2.8.2 and leave JDK9 specifics aside and for those who really needs that/tries that. Does it make sense for you?&lt;/p&gt;</comment>
                            <comment id="16372880" author="ralph.goers@dslextreme.com" created="Thu, 22 Feb 2018 14:42:46 +0000"  >&lt;p&gt;I don&apos;t see how the error you are getting could be in any way related to the Java 9 support. Log4j API does not require Java 9 to run and PropertiesUtil is included as part of the Log4j API jar and is compiled with the Java 7 compiler so I am a bit puzzled as to how you could be getting a NoClassDefFoundError.&lt;/p&gt;</comment>
                            <comment id="16372977" author="andrejusc" created="Thu, 22 Feb 2018 15:55:02 +0000"  >&lt;p&gt;Ralph - previously we were discussing ServiceLoader logic, introduced for purposes of JDK9, side effects under this bug: &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2104&quot; title=&quot;LoaderUtil getClassLoaders() method and while loops&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2104&quot;&gt;&lt;del&gt;LOG4J2-2104&lt;/del&gt;&lt;/a&gt;, which is still open.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;According to PowerMock documentation &lt;a href=&quot;http://powermock.github.io/:&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://powermock.github.io/:&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&quot;PowerMock uses a custom classloader...&quot;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;and current Log4j2 performed changes around ServiceLoader closely related to classloading resolution. So my thinking here is that new logic breaks in some way visibility of classes within classloaders hierarchy.&lt;/p&gt;

&lt;p&gt;If I could put some debug switch while getting this error to generate more logs for troubleshooting - please let me know which to set andI&apos;ll collect those.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16373009" author="ralph.goers@dslextreme.com" created="Thu, 22 Feb 2018 16:19:02 +0000"  >&lt;p&gt;Can you attach a test project I could use to look into the error?&lt;/p&gt;</comment>
                            <comment id="16373396" author="andrejusc" created="Thu, 22 Feb 2018 20:33:30 +0000"  >&lt;p&gt;I&apos;m trying to minimize some code and did now directly such in my test class within static {} clause to mimic what Log4j2 was trying to do:&lt;/p&gt;

&lt;p&gt;try &lt;/p&gt;
{
&#160; PropertiesUtil PROPS = new PropertiesUtil(&quot;log4j2.StatusLogger.properties&quot;);
}
&lt;p&gt; catch (Throwable e) &lt;/p&gt;
{
&#160; e.printStackTrace();
}

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;and got upper stack as reported for this bug, but actual root cause like such:&lt;/p&gt;

&lt;p&gt;java.util.ServiceConfigurationError: org.apache.logging.log4j.util.PropertySource: Provider org.apache.logging.log4j.util.EnvironmentPropertySource not a subtype&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at java.util.ServiceLoader.fail(ServiceLoader.java:239)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at java.util.ServiceLoader.access$300(ServiceLoader.java:185)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at java.util.ServiceLoader$LazyIterator.nextService(ServiceLoader.java:376)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at java.util.ServiceLoader$LazyIterator.next(ServiceLoader.java:404)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at java.util.ServiceLoader$1.next(ServiceLoader.java:480)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.logging.log4j.util.PropertiesUtil$Environment.&amp;lt;init&amp;gt;(PropertiesUtil.java:319)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.logging.log4j.util.PropertiesUtil$Environment.&amp;lt;init&amp;gt;(PropertiesUtil.java:310)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.logging.log4j.util.PropertiesUtil.&amp;lt;init&amp;gt;(PropertiesUtil.java:69)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.logging.log4j.util.PropertiesUtil.&amp;lt;clinit&amp;gt;(PropertiesUtil.java:49)&lt;/p&gt;

&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;and that brings me back to where I&apos;ve started looking into similar issues initially for v2.9.1, i.e. &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2055&quot; title=&quot;ServiceConfigurationError in Tomcat when Log4j is used as the logging implementation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2055&quot;&gt;&lt;del&gt;LOG4J2-2055&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I cannot provide test project out of my complex code, but I think issue now should be more or less clear.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And line 375 inside ServiceLoader class for JDK8 is:&lt;/p&gt;

&lt;p&gt;if (!service.isAssignableFrom(c)) &lt;/p&gt;
{
&#160;&#160;&#160; fail(service,
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &quot;Provider &quot; + cn&#160; + &quot; not a subtype&quot;);
}

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;So if Log4j2 v2.10.0 is supposed to still work with JDK8 as before - we need to fix this obviously. if you may have some patch to try in form of jar with compiled classes - I could do that, cause not yet using JDK9 to build things myself.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16373411" author="ralph.goers@dslextreme.com" created="Thu, 22 Feb 2018 20:42:09 +0000"  >&lt;p&gt;The code in question here has nothing to do with Java 9 support. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jvz&quot; class=&quot;user-hover&quot; rel=&quot;jvz&quot;&gt;jvz&lt;/a&gt; implemented it for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-1431&quot; title=&quot;Simplify log4j system property naming scheme&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-1431&quot;&gt;&lt;del&gt;LOG4J2-1431&lt;/del&gt;&lt;/a&gt;. I suspect it needs the same fix I implemented for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2055&quot; title=&quot;ServiceConfigurationError in Tomcat when Log4j is used as the logging implementation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2055&quot;&gt;&lt;del&gt;LOG4J2-2055&lt;/del&gt;&lt;/a&gt; to go through all the class loaders. I am wondering if this is also related to the problems with OSGi as I recall having to work some magic there to get ServlceLoader to work.  To be honest, I have no idea why ServiceLoader is being used here.&lt;/p&gt;</comment>
                            <comment id="16373458" author="andrejusc" created="Thu, 22 Feb 2018 21:14:37 +0000"  >&lt;p&gt;I could see that new introduced difference in v2.10.0 comparing to v2.9.1 is presence of META-INF/services/org.apache.logging.log4j.util.PropertySource entry within log4j-api-2.10.0.jar with content of:&lt;/p&gt;

&lt;p&gt;org.apache.logging.log4j.util.EnvironmentPropertySource&lt;br/&gt;
org.apache.logging.log4j.util.SystemPropertiesPropertySource&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;and so that potentially explains this new phenomena of ServiceConfigurationError.&lt;/p&gt;</comment>
                            <comment id="16373804" author="jvz" created="Fri, 23 Feb 2018 01:49:42 +0000"  >&lt;p&gt;Do you have any duplicate log4j-api jars on your classpath? As for your environment, are you using JUnit, TestNG, or something else? And how do you run the tests? (i.e., via command line, or the IDE, or something else)&lt;/p&gt;

&lt;p&gt;As for why ServiceLoader is used here, it&apos;s to allow extensions by containers/etc. to add in more global property sources (e.g., etcd config lookup).&lt;/p&gt;</comment>
                            <comment id="16373957" author="ralph.goers@dslextreme.com" created="Fri, 23 Feb 2018 05:45:24 +0000"  >&lt;p&gt;Matt, PropertiesUtil was modified to use ServiceLoader.load without specifying a ClassLoader. That is problematic for OSGi users. See &lt;a href=&quot;http://blog.osgi.org/2013/02/javautilserviceloader-in-osgi.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://blog.osgi.org/2013/02/javautilserviceloader-in-osgi.html&lt;/a&gt; for an explanation. When I implemented the Provider binding for LogManager I took this into account. In addition, it is possible that the implementation might not be found int the same ClassLoader as the caller. To handle this I tried to find all the ClassLoaders I could and loop through them. The mistake I made that is referenced in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2055&quot; title=&quot;ServiceConfigurationError in Tomcat when Log4j is used as the logging implementation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2055&quot;&gt;&lt;del&gt;LOG4J2-2055&lt;/del&gt;&lt;/a&gt; is that I end up looking at the same ClassLoader twice. That shouldn&apos;t be a big deal but it isn&apos;t correct and needs to be fixed.  Please take a look at ProviderUtil for how it deals with the ClassLoader. You will have to look at the Activator class in Log4j-API to see how it deals with Providers. You will need to do something similar for PropertySource to work properly in OSGi. I used the link above to guide me in getting the Provider to work with OSGi.&lt;/p&gt;

&lt;p&gt;I should add that the reporter mentioned he has a custom ClassLoader. That is most likely the source of the problem, not duplicate jars. I suspect that ClassLoader is not the ThreadContext ClassLoader and so ServiceLoader can&apos;t find the jars because the ThreadContext ClassLoader doesn&apos;t own them.&lt;/p&gt;</comment>
                            <comment id="16374133" author="andrejusc" created="Fri, 23 Feb 2018 09:28:20 +0000"  >&lt;p&gt;Matt - I&apos;ve double-checked and used also verbose class loading and could confirm that there are no duplicate log4j-api jars in my classpath. And that PropertiesUtil/StatusLogger/LogManager are all loaded from same jar.&lt;/p&gt;

&lt;p&gt;I think Ralph has summarized quite well what could be root cause in this case and that some similar previous fix is needed here. If you could provide some patch to try - I could try that.&lt;/p&gt;</comment>
                            <comment id="16374851" author="jvz" created="Fri, 23 Feb 2018 19:03:27 +0000"  >&lt;p&gt;If we need to go through the trouble of finding a ClassLoader for ServiceLoader, then we ought to make a wrapper class around ServiceLoader because that makes it nearly useless.&lt;/p&gt;</comment>
                            <comment id="16374962" author="ralph.goers@dslextreme.com" created="Fri, 23 Feb 2018 21:02:59 +0000"  >&lt;p&gt;If that is how you want to solve it I have no problem with that. Note that ServiceLoader&apos;s load(someClass) method should never be used, only the method that accepts a ClassLoader.&lt;/p&gt;

&lt;p&gt;Also, fixing the service loader part won&apos;t fix the OSGi portion of the issue.&lt;/p&gt;</comment>
                            <comment id="16375040" author="andrejusc" created="Fri, 23 Feb 2018 22:27:58 +0000"  >&lt;p&gt;See this interesting discussion about ServiceLoader usage and folks reporting such approach limitations:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/7039467/java-serviceloader-with-multiple-classloaders&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/7039467/java-serviceloader-with-multiple-classloaders&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16381686" author="andrejusc" created="Thu, 1 Mar 2018 08:47:38 +0000"  >&lt;p&gt;Any further thoughts here?&lt;/p&gt;</comment>
                            <comment id="16382077" author="jvz" created="Thu, 1 Mar 2018 14:40:53 +0000"  >&lt;p&gt;The fix seems agreed upon. If you would like to submit a pull request or patch, that would be great. Otherwise, I&apos;ll take this issue later.&lt;/p&gt;</comment>
                            <comment id="16382482" author="andrejusc" created="Thu, 1 Mar 2018 19:16:56 +0000"  >&lt;p&gt;Sorry, I&apos;m not yet using JDK9 to be able to compile/change code. If you could address this later - that will be appreciated.&lt;/p&gt;</comment>
                            <comment id="16382507" author="jvz" created="Thu, 1 Mar 2018 19:28:23 +0000"  >&lt;p&gt;If you have Docker, you can run the Docker build to test it out.&lt;/p&gt;</comment>
                            <comment id="16428304" author="ralph.goers@dslextreme.com" created="Fri, 6 Apr 2018 13:20:50 +0000"  >&lt;p&gt;Although the symptoms are not the same, the fix for this is the same as for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2152&quot; title=&quot;ServiceConfigurationError in Tomcat when Log4j is used as the logging implementation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2152&quot;&gt;&lt;del&gt;LOG4J2-2152&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16533223" author="jira-bot" created="Thu, 5 Jul 2018 03:05:38 +0000"  >&lt;p&gt;Commit 2a051c2c70856863161402ccb8c1315d942e061a in logging-log4j2&apos;s branch refs/heads/&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2266&quot; title=&quot;Log4j2 throws NoClassDefFoundError in Java 8&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2266&quot;&gt;&lt;del&gt;LOG4J2-2266&lt;/del&gt;&lt;/a&gt; from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ralph.goers%40dslextreme.com&quot; class=&quot;user-hover&quot; rel=&quot;ralph.goers@dslextreme.com&quot;&gt;ralph.goers@dslextreme.com&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=2a051c2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=logging-log4j2.git;h=2a051c2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2266&quot; title=&quot;Log4j2 throws NoClassDefFoundError in Java 8&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2266&quot;&gt;&lt;del&gt;LOG4J2-2266&lt;/del&gt;&lt;/a&gt; - Use classloaders when loading properties&lt;/p&gt;</comment>
                            <comment id="16533224" author="ralph.goers@dslextreme.com" created="Thu, 5 Jul 2018 03:06:19 +0000"  >&lt;p&gt;I have created what I believe is the fix for this and committed it to branch &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2266&quot; title=&quot;Log4j2 throws NoClassDefFoundError in Java 8&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2266&quot;&gt;&lt;del&gt;LOG4J2-2266&lt;/del&gt;&lt;/a&gt;. Please review.&lt;/p&gt;</comment>
                            <comment id="16728972" author="geker" created="Wed, 26 Dec 2018 10:19:35 +0000"  >&lt;p&gt;This bug is back at the version 2.11.1. I use jdk8 with a custom Classloader to load log4j.&lt;/p&gt;

&lt;p&gt;When i use 2.8.2 and 2.11.0 ,every thing&#160; was ok,but i update to 2.11.1.the Exception occur.&#160;&lt;/p&gt;

&lt;p&gt;I don&apos;t fint the root cause , i think the&#160; bug i meet is&#160; the same as this issue&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;tt&gt;Caused by: java.lang.NoClassDefFoundError: Could not initialize class org.apache.logging.log4j.util.PropertiesUtil&lt;/tt&gt;&lt;br/&gt;
 {{ at org.apache.logging.log4j.status.StatusLogger.&amp;lt;clinit&amp;gt;(StatusLogger.java:78)}}&lt;br/&gt;
 {{ at org.apache.logging.log4j.LogManager.&amp;lt;clinit&amp;gt;(LogManager.java:60)}}&lt;br/&gt;
 {{ at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)}}&lt;br/&gt;
 {{ at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)}}&lt;br/&gt;
 {{ at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)}}&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="16729031" author="ralph.goers@dslextreme.com" created="Wed, 26 Dec 2018 13:05:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=geker&quot; class=&quot;user-hover&quot; rel=&quot;geker&quot;&gt;geker&lt;/a&gt; what is your environment?&lt;/p&gt;

&lt;p&gt;2.11.2 hasn&#8217;t been released so I assume you are trying the latest code on the release-2.x branch?&lt;/p&gt;</comment>
                            <comment id="16729116" author="geker" created="Wed, 26 Dec 2018 17:26:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ralph.goers%40dslextreme.com&quot; class=&quot;user-hover&quot; rel=&quot;ralph.goers@dslextreme.com&quot;&gt;ralph.goers@dslextreme.com&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am very sorry, I mistake&#160; type the version i used. the 2.11.1 has the Exception again,and 2.11.0 is ok.&lt;/p&gt;</comment>
                            <comment id="16729132" author="ralph.goers@dslextreme.com" created="Wed, 26 Dec 2018 18:37:06 +0000"  >&lt;p&gt;That is OK. What does your custom Classloader do? The fix that was added specifies to use the ClassLoader of the PropertySource class. That will be the ClassLoader that logged Log4j. I suspect that that isn&apos;t good enough as the properties might be provided by a different ClassLoader. OTOH, it isn&apos;t clear at all why you would be getting this failure since Log4j is creating these objects.&#160;&lt;/p&gt;

&lt;p&gt;Is it possible you could step through the call to PropertiesUtil to see where the failure is happening and what the underlying exception is?&lt;/p&gt;</comment>
                            <comment id="16730086" author="geker" created="Fri, 28 Dec 2018 07:32:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ralph.goers%40dslextreme.com&quot; class=&quot;user-hover&quot; rel=&quot;ralph.goers@dslextreme.com&quot;&gt;ralph.goers@dslextreme.com&lt;/a&gt;&#160; I initialize&#160; the log4j2 as code below.&#160;&#160;In brief,I&apos;am initialize the LoggerContextFactory in CustomClassloader by Reflection. The code will cause NoClassDefFoundError&#160; on version 2.11.1.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;tt&gt;private Object initCoreLoggerContext(ClassLoader customloader) throws Exception {&lt;/tt&gt;&lt;br/&gt;
 {{&#160; }}&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160; Class&amp;lt;?&amp;gt; logManagerClazz =&#160; &#160; &#160; customloader.loadClass(&quot;org.apache.logging.log4j.LogManager&quot;);&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; Method getFactoryMethod = logManagerClazz.getDeclaredMethod(&quot;getFactory&quot;, (Class&amp;lt;?&amp;gt;[]) null);&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; Object factory = invokeRelectMethod(getFactoryMethod, null);&lt;/tt&gt;&lt;br/&gt;
 {{ }}}&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;As I change the&#160;ContextClassLoader the&#160; Exception is gone .Everything is&#160; going to be&#160; OK. I don&apos;t konw why .&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;tt&gt;private Object initCoreLoggerContext(ClassLoader customloader) throws Exception {&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; ClassLoader beforeLoader = Thread.currentThread().getContextClassLoader();&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; Thread.currentThread().setContextClassLoader(customloader);&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160; Class&amp;lt;?&amp;gt; logManagerClazz =&#160; &#160; &#160; customloader.loadClass(&quot;org.apache.logging.log4j.LogManager&quot;);&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; Method getFactoryMethod = logManagerClazz.getDeclaredMethod(&quot;getFactory&quot;, (Class&amp;lt;?&amp;gt;[]) null);&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; Object factory = invokeRelectMethod(getFactoryMethod, null);&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160; Thread.currentThread().setContextClassLoader(beforeLoader);&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;}&lt;/tt&gt;&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="16730087" author="ralph.goers@dslextreme.com" created="Fri, 28 Dec 2018 07:37:28 +0000"  >&lt;p&gt;What is the &quot;loader&quot; variable set to? And out of curiosity what are you doing with the factory method? What is going on that requires you to use Reflection? Is there a possibility that Log4j might not be available?&lt;/p&gt;</comment>
                            <comment id="16730175" author="geker" created="Fri, 28 Dec 2018 10:30:15 +0000"  >&lt;p&gt;Sorry &#160;i&#160;was too careless ,&quot;loader&quot;&#160; is the&#160; argument customloader &#65288;also&#160; AppClassLoader&#160; mentioned below&#160;&#65289;.&lt;/p&gt;

&lt;p&gt;It&apos;s&#160; a little complicate.&#160; &#160;My&#160; AppServer&#160; have the Classloader&#160;hierarchy like&#160; tomcat&#65292;which&#160; children will try to&#160; load their own dependence &#160;first ,if absent&#160; parent try&#160;.&lt;/p&gt;

&lt;p&gt;The Server and AppN having their own logging config xml&#12290;So the AppN&apos;s&#160;LoggerContextFactory&#160; must&#160; be load by the AppNClassloader and initialized&#160; by reflection.&#160;&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ServerClassLoader&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160;/&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; \&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; \&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160;/&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; \&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; \&lt;/p&gt;

&lt;p&gt;&#160; &#160;App1ClassLoader&#160; &#160;App2ClassLoader&#160; &#160; &#160;.... AppN&lt;/p&gt;</comment>
                            <comment id="16750043" author="pradeepshankar" created="Wed, 23 Jan 2019 14:26:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ralph.goers%40dslextreme.com&quot; class=&quot;user-hover&quot; rel=&quot;ralph.goers@dslextreme.com&quot;&gt;ralph.goers@dslextreme.com&lt;/a&gt; this continues to be a open item with JDK 8 and log4j 2.11.0. We also have a powermock which uses custom class loader to load specific classes and fails to initialize.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;ERROR&amp;#93;&lt;/span&gt; Caused by: java.lang.NoClassDefFoundError: Could not initialize class org.apache.logging.log4j.util.PropertiesUtil&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;ERROR&amp;#93;&lt;/span&gt; at org.apache.logging.log4j.status.StatusLogger.&amp;lt;clinit&amp;gt;(StatusLogger.java:78)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;ERROR&amp;#93;&lt;/span&gt; at org.apache.logging.log4j.LogManager.&amp;lt;clinit&amp;gt;(LogManager.java:60)&lt;/p&gt;

&lt;p&gt;&#160;NOTE: tests with 2.11.1 and JDK8 also fails with the same error.&#160;&lt;/p&gt;

&lt;p&gt;We see that LOG4j2-2129 has been fixed under - &lt;a href=&quot;https://blogs.apache.org/logging/entry/log4j-2-11-released.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://blogs.apache.org/logging/entry/log4j-2-11-released.&lt;/a&gt;&#160;However, it does not seem to be working for jdk8 combination.&#160;&lt;/p&gt;</comment>
                            <comment id="16756817" author="jira-bot" created="Thu, 31 Jan 2019 03:18:54 +0000"  >&lt;p&gt;Commit 0eee16740007326988e2689e81e859ca03ae5bb6 in logging-log4j2&apos;s branch refs/heads/master from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=0eee167&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=0eee167&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2266&quot; title=&quot;Log4j2 throws NoClassDefFoundError in Java 8&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2266&quot;&gt;&lt;del&gt;LOG4J2-2266&lt;/del&gt;&lt;/a&gt; - Load PropertySources from any accessible ClassLoader and handle any exceptions&lt;/p&gt;</comment>
                            <comment id="16756818" author="jira-bot" created="Thu, 31 Jan 2019 03:19:08 +0000"  >&lt;p&gt;Commit dfced487bdb422c56334922411e10447bdb64969 in logging-log4j2&apos;s branch refs/heads/release-2.x from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=dfced48&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=dfced48&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2266&quot; title=&quot;Log4j2 throws NoClassDefFoundError in Java 8&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2266&quot;&gt;&lt;del&gt;LOG4J2-2266&lt;/del&gt;&lt;/a&gt; - Load PropertySources from any accessible ClassLoader and handle any exceptions&lt;/p&gt;</comment>
                            <comment id="16756819" author="ralph.goers@dslextreme.com" created="Thu, 31 Jan 2019 03:19:47 +0000"  >&lt;p&gt;I have modified PropertiesUtil so that this error should no longer happen.&lt;/p&gt;</comment>
                            <comment id="16783501" author="jira-bot" created="Mon, 4 Mar 2019 16:14:05 +0000"  >&lt;p&gt;Commit ad3e48a7eb69dd2848da09d838dbb869a1d145c6 in logging-log4j2&apos;s branch refs/heads/&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-913&quot; title=&quot;Allow to load log4j2 configuration from a centralized repository, like a database or a webservice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-913&quot;&gt;&lt;del&gt;LOG4J2-913&lt;/del&gt;&lt;/a&gt; from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=ad3e48a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=ad3e48a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2266&quot; title=&quot;Log4j2 throws NoClassDefFoundError in Java 8&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2266&quot;&gt;&lt;del&gt;LOG4J2-2266&lt;/del&gt;&lt;/a&gt; - Load PropertySources from any accessible ClassLoader and handle any exceptions&lt;/p&gt;</comment>
                            <comment id="16833225" author="jira-bot" created="Sun, 5 May 2019 05:27:24 +0000"  >&lt;p&gt;Commit 23ec2ac7a480854591c794c966edd046b5bba952 in logging-log4j2&apos;s branch refs/heads/release-2.x from Ralph Goers&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=23ec2ac&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=logging-log4j2.git;h=23ec2ac&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-2266&quot; title=&quot;Log4j2 throws NoClassDefFoundError in Java 8&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-2266&quot;&gt;&lt;del&gt;LOG4J2-2266&lt;/del&gt;&lt;/a&gt; - Load PropertySources from any accessible ClassLoader and handle any exceptions&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13477578">LOG4J2-3579</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 28 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3qf3b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>