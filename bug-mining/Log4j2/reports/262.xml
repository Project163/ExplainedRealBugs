<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:32:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-555] Location-based functionality broken in AbstractLoggerWrapper subclasses</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-555</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;&lt;b&gt;How to reproduce&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Create a custom logger that extends &lt;tt&gt;AbstractLoggerWrapper&lt;/tt&gt; (or generate one with the tool attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-519&quot; title=&quot;Custom/Extended Loggers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-519&quot;&gt;&lt;del&gt;LOG4J2-519&lt;/del&gt;&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;In the custom logger provide a public method that invokes the &lt;tt&gt;log(Level, String)&lt;/tt&gt; method&lt;/li&gt;
	&lt;li&gt;Configure a pattern layout that uses location, like %C for the logger FQCN&lt;/li&gt;
	&lt;li&gt;From a sample app, call the public method on your custom logger.&lt;/li&gt;
	&lt;li&gt;The output will show the class name of the custom logger instead of the class name of the calling class in the sample application.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Cause&lt;/b&gt;&lt;br/&gt;
&lt;tt&gt;AbstractLogger&lt;/tt&gt;&apos;s FQCN field is &lt;tt&gt;static final&lt;/tt&gt; and initialized to &lt;tt&gt;AbstractLogger.class.getName()&lt;/tt&gt;. Then, in &lt;tt&gt;Log4jLogEvent#calcLocation()&lt;/tt&gt;, when walking over the stack trace elements, the element &lt;em&gt;following&lt;/em&gt; the FQCN is returned. So only loggers that directly subclass from &lt;tt&gt;AbstractLogger&lt;/tt&gt; will work correctly. Loggers that inherit from &lt;tt&gt;AbstractLoggerWrapper&lt;/tt&gt; are two levels removed from &lt;tt&gt;AbstractLogger&lt;/tt&gt; and the &lt;tt&gt;calcLocation()&lt;/tt&gt; method will not work correctly.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Solution&lt;/b&gt;&lt;br/&gt;
I think &lt;tt&gt;AbstractLogger&lt;/tt&gt;&apos;s FQCN field should be made non-static, and initialized to &lt;tt&gt;getClass().getName()&lt;/tt&gt; in the constructor of &lt;tt&gt;AbstractLogger&lt;/tt&gt;. &lt;tt&gt;Log4jLogEvent#calcLocation()&lt;/tt&gt; can then be modified to return the &lt;tt&gt;StackElement&lt;/tt&gt; whose class name matches the FQCN, instead of the next element. Location-based functionality should then work for arbitrarily deep subclass hierarchies of AbstractLogger.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12698163">LOG4J2-555</key>
            <summary>Location-based functionality broken in AbstractLoggerWrapper subclasses</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="rpopma">Remko Popma</reporter>
                        <labels>
                    </labels>
                <created>Sun, 2 Mar 2014 06:20:39 +0000</created>
                <updated>Wed, 4 Jun 2014 13:29:16 +0000</updated>
                            <resolved>Sun, 23 Mar 2014 04:57:43 +0000</resolved>
                                    <version>2.0-rc1</version>
                                    <fixVersion>2.0-rc2</fixVersion>
                                    <component>API</component>
                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13917300" author="ralph.goers@dslextreme.com" created="Sun, 2 Mar 2014 06:28:24 +0000"  >&lt;p&gt;AbstractLogger is correct.  Applications that invoke its methods will work correctly.  The problem here is that all the calls from a custom logger should use the log(final Marker marker, final String fqcn, final Level level, final Message data, final Throwable t) method of AbstractLoggerWrapper and provide the fqcn.&lt;/p&gt;

&lt;p&gt;I should add that at one point AbstractLogger had code similar to what you are suggesting. It generally did not work because in most cases the application is not calling a method in the subclass but is directly calling a method in AbstractLogger, thus the FQCN needs to be for AbstractLogger, not the subclass.&lt;/p&gt;

&lt;p&gt;I should also add that when AbstractLogger was first written it only had a single abstract log method. Last year all the other log methods were added to allow callers more flexibility to log at a specific level.  We should document that those methods are for users and should never be used by a Logger implementation.&lt;/p&gt;</comment>
                            <comment id="13917313" author="remkop@yahoo.com" created="Sun, 2 Mar 2014 07:17:40 +0000"  >&lt;p&gt;Interesting! I see the difficulty now: apps may call a method in the subclass or in AbstractLogger, so any stacktrace-walking should work for both.&lt;/p&gt;

&lt;p&gt;If custom loggers &lt;em&gt;must&lt;/em&gt; use the &lt;tt&gt;log(Marker, String, Level, Message, Throwable)&lt;/tt&gt; method, &lt;tt&gt;AbstractLogger&lt;/tt&gt; should at least make its &lt;tt&gt;MessageFactory&lt;/tt&gt; available to subclasses. The fact that this is not available was what made me call the other &lt;tt&gt;log&lt;/tt&gt; methods in the custom logger in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-519&quot; title=&quot;Custom/Extended Loggers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-519&quot;&gt;&lt;del&gt;LOG4J2-519&lt;/del&gt;&lt;/a&gt;. EDIT: I overlooked the getter method for this.&lt;/p&gt;

&lt;p&gt;Still, it seems a bit... fragile to ask subclasses to use only that particular method. I&apos;ll think a bit more if there isn&apos;t an alternative. Thanks for the explanation!&lt;/p&gt;</comment>
                            <comment id="13917362" author="remkop@yahoo.com" created="Sun, 2 Mar 2014 11:10:44 +0000"  >&lt;p&gt;With hindsight I probably saw the &lt;tt&gt;getMessageFactory&lt;/tt&gt; method but thought I could avoid using it. &lt;/p&gt;

&lt;p&gt;I just updated the Generate tool in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-519&quot; title=&quot;Custom/Extended Loggers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-519&quot;&gt;&lt;del&gt;LOG4J2-519&lt;/del&gt;&lt;/a&gt; and having to go through the &lt;tt&gt;log(Marker, String, Level, Message, Throwable)&lt;/tt&gt; method was quite painful. Method implementations are now three or four lines instead of one line, and there is a need to pass &lt;tt&gt;null&lt;/tt&gt; parameters now. &lt;/p&gt;

&lt;p&gt;I&apos;m not complaining, just noticing that the previous implementation was more intuitive so documentation is probably necessary if the longer and less intuitive implementation is the only correct way to do things.&lt;/p&gt;</comment>
                            <comment id="13917398" author="garydgregory" created="Sun, 2 Mar 2014 12:50:13 +0000"  >&lt;p&gt;methods 3 or 4 lines: no opportunity for refactoring?&lt;/p&gt;</comment>
                            <comment id="13917419" author="remkop@yahoo.com" created="Sun, 2 Mar 2014 14:12:27 +0000"  >&lt;p&gt;I keep thinking there must be a more robust way to achieve this... So far, the best I&apos;ve been able to come up with is instead of having a single FQCN, we can have a &lt;tt&gt;Set&lt;/tt&gt; of all FQCNs of the class hierarchy of loggers that extend AbstractLogger. When a logger instance is constructed, it builds that Set in the constructor, starting with &lt;tt&gt;getClass()&lt;/tt&gt;, then keep calling &lt;tt&gt;cls.getParent()&lt;/tt&gt; until either &lt;tt&gt;AbstractLogger&lt;/tt&gt; is found or &lt;tt&gt;null&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;So for a generated extended logger the set would be { &lt;tt&gt;ExtendedLogger, AbstractLoggerWrapper, AbstractLogger&lt;/tt&gt; }, and for a &quot;normal&quot; logger obtained from &lt;tt&gt;LogManager&lt;/tt&gt; the set would be { &lt;tt&gt;core.Logger, AbstractLogger&lt;/tt&gt; }.&lt;/p&gt;

&lt;p&gt;Unfortunately this breaks down for custom loggers that don&apos;t extend from &lt;tt&gt;AbstractLoggerWrapper&lt;/tt&gt; but instead &lt;em&gt;have an&lt;/em&gt; &lt;tt&gt;AbstractLoggerWrapper&lt;/tt&gt; field that they delegate calls to. How to add the FQCN of such custom loggers to the FQCN Set of the &lt;tt&gt;AbstractLoggerWrapper&lt;/tt&gt; that they delegate to? (And wouldn&apos;t this just move the problem: now custom logger authors need to remember to add the custom logger FQCN to the FQCN Set of its &lt;tt&gt;AbstractLoggerWrapper&lt;/tt&gt; field, which is almost as bad as saying &quot;don&apos;t use these methods, you can call only this one&quot;...) &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;And then of course there is the cost-benefit trade-off: how much effort to spend on this... Perhaps just updating the docs is good enough. I just wanted to write my thoughts down, I may revisit this later.&lt;/p&gt;</comment>
                            <comment id="13917569" author="remkop@yahoo.com" created="Sun, 2 Mar 2014 21:29:04 +0000"  >&lt;p&gt;Hey Gary! I missed your comment. Yeah, I know! The generated code now basically looks very similar to the AbstractLogger implementation of the convenience methods for the built-in levels:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void customLevel(...) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (logger.isEnabled(lots, of, parameters)) {
        Message msg = createMessage();
        logger.log(marker, fqcn, level, msg, throwable);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Where before it looked like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void customLevel(...) {
    logger.log(available, parameters);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Perhaps a nice solution for this would also allow the code in AbstractLogger to be simplified...&lt;/p&gt;

&lt;p&gt;Refactoring may be possible, both in the Generate tool and in AbstractLogger. Be aware there are some subtleties with the Throwable that may or may not be the last parameter in logging methods that take a varargs parameter.&lt;/p&gt;</comment>
                            <comment id="13918817" author="bruce.brouwer" created="Tue, 4 Mar 2014 00:30:11 +0000"  >&lt;p&gt;I am also very interested in knowing where this lands. I&apos;m working on &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-547&quot; title=&quot;Update LoggerStream API&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-547&quot;&gt;&lt;del&gt;LOG4J2-547&lt;/del&gt;&lt;/a&gt;, the LoggerStream API. In a sense I am writing a logger wrapper, but I am unable to extend AbstractLoggerWrapper or AbstractLogger as I need to extend Writer or OutputStream.&lt;/p&gt;</comment>
                            <comment id="13918962" author="remkop@yahoo.com" created="Tue, 4 Mar 2014 02:57:58 +0000"  >&lt;p&gt;I do have a refactoring in mind that would replace the four lines of code with one line. This would be applicable to both the Generate tool and  AbstractLogger. The goal is merely to reduce the almost-but-not-quite-duplicate code and still work correctly for the FQCN issue mentioned in this ticket. Not sure it it will help you with the stream stuff. &lt;/p&gt;

&lt;p&gt;Work is extremely busy now and I may not be able to work on this in the next few weeks. &lt;/p&gt;</comment>
                            <comment id="13923081" author="bruce.brouwer" created="Thu, 6 Mar 2014 21:21:48 +0000"  >&lt;p&gt;Would it be crazy to use a Java Proxy to proxy the loggers and have the proxy figure out the call stack? This should work fine when you&apos;re just dealing with the Logger interface. I don&apos;t know exactly what kind of performance impact this would create. Maybe there would be a way to detect if a logger is using a location pattern layout like %C and only proxy it if necessary. &lt;/p&gt;

&lt;p&gt;This wouldn&apos;t help for the extended loggers unless they implemented an interface. For those it could fall back to using cglib (most likely would be an optional dependency)&lt;/p&gt;

&lt;p&gt;I don&apos;t know if this is worth exploring, but I thought I would throw it out as an idea. &lt;/p&gt;</comment>
                            <comment id="13923094" author="bruce.brouwer" created="Thu, 6 Mar 2014 21:30:22 +0000"  >&lt;p&gt;As for the Set idea, I think that is close to what we need (sans proxies). I don&apos;t want this to walk up the class hierarchy, though. For what I was working on for &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-547&quot; title=&quot;Update LoggerStream API&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-547&quot;&gt;&lt;del&gt;LOG4J2-547&lt;/del&gt;&lt;/a&gt; regarding the LoggerStream, I would be providing a subclass of Writer or OutputStream (e.g. LoggerWriter or LoggerOutputStream). These may wrap another Writer or OutputStream. If you simply walked up the class hierarchy of LoggerWriter, you would be watching for FQCNs of Writer, such as the wrapped Writer would also extend. This might cause this locator logic to incorrectly identify which class stack element was the outer most call stack used for locating caller information. &lt;/p&gt;

&lt;p&gt;I think it would be better if we simply gave the FQCN parameter a collection of FQCNs. If I knew I extended every method of AbstractLogger, then why bother checking for AbstractLogger in the call stack. &lt;/p&gt;</comment>
                            <comment id="13923194" author="remkop@yahoo.com" created="Thu, 6 Mar 2014 22:41:07 +0000"  >&lt;p&gt;I won&apos;t have time to work out the details for another 2 weeks or so, so let me draw the big picture of the refactoring I have in mind.&lt;/p&gt;

&lt;p&gt;The goal of the refactoring is to reduce the lines of code in the convenience methods (what is currently almost, but not quite duplicate code). These methods would end up delegating to a single &lt;tt&gt;doLog()&lt;/tt&gt; method (in both AbstractLogger and Extended/Custom Loggers, not sure about the Writers). For example, the current code in AbstractLogger looks like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void error(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; message, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;... params) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isEnabled(Level.ERROR, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, message, params)) {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Message msg = messageFactory.newMessage(message, params);
        log(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, FQCN, Level.ERROR, msg, msg.getThrowable());
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the above would become&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void error(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; message, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;... params) {
    doLog(Enabled.stringVarargs, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, FQCN, Level.ERROR, MsgBuilder.stringVarargs,
            message, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, params);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The idea is to create enums for all &lt;tt&gt;isEnabled()&lt;/tt&gt; methods, and passing this enum value to the &lt;tt&gt;doLog&lt;/tt&gt; method instead of calling the &lt;tt&gt;isEnabled&lt;/tt&gt; method directly in &lt;tt&gt;error()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The new &lt;tt&gt;doLog&lt;/tt&gt; method would look something like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void doLog(Enabled enabled, Marker marker, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; FQCN, Level level, MsgBuilder builder,
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; message, Throwable throwable, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;... params) {
    Message msg = builder.build(message, throwable, params);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (enabled.isEnabled(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, level, marker, msg, throwable)) {
        log(marker, FQCN, level, msg, msg.getThrowable());
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Each of the 5 enum values for &lt;tt&gt;Enabled&lt;/tt&gt; has a different implementation of the &lt;tt&gt;isEnabled&lt;/tt&gt; method that ignores some parameters, so we end up with the same behaviour as what AbstractLogger currently does, with a few extra method invocations in between (that Hotspot can easily optimize out).&lt;/p&gt;

&lt;p&gt;A similar enum mechanism can be used to create the &lt;tt&gt;Message&lt;/tt&gt; object (tentatively named &lt;tt&gt;MsgBuilder&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;So the trade-off is we gain a simpler implementation for the existing convenience methods&lt;br/&gt;
(6 levels times 14 methods = 84 methods where we go from 3-4 lines to 1 line).&lt;/p&gt;

&lt;p&gt;And in return we need to add the new &lt;tt&gt;doLog&lt;/tt&gt; method above as well as enums for Enabled and MsgBuilder. The enums can be public static inner classes of AbstractLogger so they can be re-used in Extended/Custom loggers.&lt;/p&gt;

&lt;p&gt;This also means there would be no need to track FQCNs in the class hierarchy. I&apos;m kind of moving away from any kind of central FQCN tracking. It is much simpler if each AbstractLogger subclass manages its own FQCN.&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="13924811" author="remkop@yahoo.com" created="Sat, 8 Mar 2014 12:04:39 +0000"  >&lt;p&gt;Inspired by Gary&apos;s call for a refactoring, please find attached patch. This eliminates most of the semi-duplicate code in AbstractLogger and reduces the class length by 115 lines.&lt;/p&gt;

&lt;p&gt;It also provides a clear example to follow for custom/extended logger authors (I hope). At least the code generated by the tool attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-519&quot; title=&quot;Custom/Extended Loggers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-519&quot;&gt;&lt;del&gt;LOG4J2-519&lt;/del&gt;&lt;/a&gt; can be reduced by following the same pattern.&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="13924944" author="ralph.goers@dslextreme.com" created="Sat, 8 Mar 2014 17:57:44 +0000"  >&lt;p&gt;Have you run before and after on the performance tests - especially SimplePerfTest.  Any time you make changes to the API that change the code that checks for logging being enabled you need to run this - ideally on a few different machines.&lt;/p&gt;

&lt;p&gt;The first couple of times I ran the test with the patch applied it seemed slower, but after running it a few more times it appears there isn&apos;t much difference, at least on my machine.&lt;/p&gt;</comment>
                            <comment id="13925106" author="remkop@yahoo.com" created="Sun, 9 Mar 2014 04:21:31 +0000"  >&lt;p&gt;I completely agree that if there is any performance impact at all, we should not do this.&lt;/p&gt;

&lt;p&gt;Also, to clarify, I really don&apos;t want to over-complicate things. The idea I mentioned in an earlier comment of having a set of FQCNs was just a thought experiment and I now think that the benefit for custom loggers is not worth any added complexity. Custom loggers are a rare case and simply documenting &quot;custom loggers must use the abstract &lt;tt&gt;log(Marker, String, Level, Message, Throwable)&lt;/tt&gt; method because they must specify &lt;em&gt;their own&lt;/em&gt; FQCN&quot; is probably sufficient.&lt;/p&gt;

&lt;p&gt;The attached patch reduces complexity a little bit in many places (7 x 14 methods) and adds complexity in one place (the enums and the &lt;tt&gt;doLog&lt;/tt&gt; method). I&apos;d like feedback on whether other people think this is a good trade-off. Perhaps this is just a matter of taste? Anyway, feedback welcome.&lt;/p&gt;

&lt;p&gt;I&apos;ll do some performance testing and post the results.&lt;/p&gt;</comment>
                            <comment id="13925138" author="remkop@yahoo.com" created="Sun, 9 Mar 2014 07:27:55 +0000"  >&lt;p&gt;I did some performance tests but did not see any significant difference. SimplePerfTest gave very similar results before and after applying the patch.&lt;/p&gt;

&lt;p&gt;I also ran the &lt;tt&gt;org.apache.logging.log4j.core.async.perftest.PerfTestDriver&lt;/tt&gt; tests with &lt;tt&gt;-DLog4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector&lt;/tt&gt; to make all loggers asynchronous. Again the differences between before and after are within the standard deviation:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Before&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;After (1)&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;After (2)&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Ops/sec&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;stdev&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Ops/sec&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;stdev&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Ops/sec&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;stdev&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1 thread&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	4,306,635&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	680,748&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	4,035,179&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	154,953&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	4,727,986&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	1,274,861&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2 threads&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	3,177,743&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	2,204,713&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	2,223,271&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	722,988&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	2,786,508&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	700,968&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;4 threads&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	3,020,324&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	1,960,143&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	3,443,250&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	1,643,893&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	3,839,109&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;	2,997,553&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;So I guess it is just a matter of do we like the original code better or the new code better?&lt;/p&gt;</comment>
                            <comment id="13925271" author="ralph.goers@dslextreme.com" created="Sun, 9 Mar 2014 18:16:32 +0000"  >&lt;p&gt;The change does make the code a little less error prone. However, I really am surprised there isn&apos;t a hit to SimplePerfTest given extra calls and parameters are being introduced. But I can&apos;t argue with test results.  I guess I&apos;m +0.5 on this.&lt;/p&gt;</comment>
                            <comment id="13925346" author="remkop@yahoo.com" created="Sun, 9 Mar 2014 22:27:31 +0000"  >&lt;p&gt;Hotspot compiles to native code if the method is &quot;hot&quot; enough (&amp;gt;40,000 or 50,000 calls). During the compile, I expect the extra method invocations are optimized away. &lt;/p&gt;

&lt;p&gt;In fact, since SimplePerfTest uses the DefaultConfiguration (level=ERROR) but the test logs at DEBUG level, I wouldn&apos;t be surprised if Hotspot optimizes the whole loop away because it isn&apos;t actually causing any side-effects (doing any work)...&lt;/p&gt;

&lt;p&gt;You&apos;d be surprised at how different what actually gets executed looks from the original java source.  &lt;a href=&quot;http://m.youtube.com/watch?v=UwB0OSmkOtQ&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://m.youtube.com/watch?v=UwB0OSmkOtQ&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13925424" author="bruce.brouwer" created="Mon, 10 Mar 2014 03:43:18 +0000"  >&lt;p&gt;That MsgBuilder stuff looks interesting. I&apos;m not sure I&apos;m for it yet. It is not incompatible with my ideas.&lt;/p&gt;

&lt;p&gt;I&apos;m working on my own patch for this that I will post soon and I hope to receive feedback.&lt;/p&gt;

&lt;p&gt;There are a few things I&apos;m trying to do to make it easier for things using the wrapper. &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Instead of FQCN invading the API, which isn&apos;t terribly flexible, I&apos;ve created a SourceLocator interface and related classes. This way custom loggers could use multiple FQCNs or something completely different.&lt;/li&gt;
	&lt;li&gt;Make the interface LoggerProvider in the spi package which extends Logger and which AbstractLogger implements. This has a few more isEnabled and log methods available which make it possible for extended loggers to use efficiently. LoggerContext would start to return LoggerProvider instead of just Logger, and other code would stop casting to AbstractLogger and could instead use the LoggerProvider interface.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;That second point ends up making more methods public on the concrete implementations. I had an alternative idea in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-562&quot; title=&quot;Improve ability to create custom extended logger&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-562&quot;&gt;&lt;del&gt;LOG4J2-562&lt;/del&gt;&lt;/a&gt; that would prevent these methods from needing to go public. I&apos;ll post my patch soon. I&apos;ll try to get performance numbers, too. &lt;/p&gt;</comment>
                            <comment id="13925443" author="remkop@yahoo.com" created="Mon, 10 Mar 2014 04:36:36 +0000"  >&lt;p&gt;The enums (like MsgBuilder) use the double-dispatch pattern as a clean way to avoid introducing a conditional. Avoiding a branch means the CPU doesn&apos;t need to do branch prediction (potential cache miss/pipeline stall).&lt;/p&gt;

&lt;p&gt;The purpose of the refactoring in the patch was to&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;reduce semi-duplicate code in many AbstractLogger methods&lt;/li&gt;
	&lt;li&gt;extract elements of the &lt;tt&gt;if(isEnabled(...){log(...);}_&lt;/tt&gt; pattern so these elements can be re-used in extended/custom loggers&lt;/li&gt;
	&lt;li&gt;these reusable elements in turn make managing the FQCN less onerous for custom/extended loggers: these loggers don&apos;t need to repeat the  &lt;tt&gt;if(isEnabled(...){log(...);}_&lt;/tt&gt; pattern but instead can have a one-line implementation that calls the &lt;tt&gt;doLog(...)&lt;/tt&gt; method.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;So to me, this patch solves the FQCN problem this ticket was created for. If we decide to reject this patch I don&apos;t mind not having a solution but just keeping things the way they are. I don&apos;t think the FQCN is a huge problem and I would not be in favor of much added complexity just to make FQCN easier to manage for the rare use case of custom/extended loggers. Any extra classes/interfaces should carry their own weight so to speak and have benefits other than FQCN, IMHO. &lt;/p&gt;

&lt;p&gt;Would the stream/writer loggers benefit from the patch attached here? (I haven&apos;t checked...)&lt;/p&gt;</comment>
                            <comment id="13932795" author="bruce.brouwer" created="Thu, 13 Mar 2014 02:21:45 +0000"  >&lt;p&gt;I&apos;ve attached my patch that takes care of the FQCN issues. AbstractLogger is reduced by 171 lines and it does not involve that fun little enum trick that Remko proposed. This has impact to anything that extends AbstractLogger, which is included in my patch. I haven&apos;t finished checking all the tests as I&apos;m getting some weird testing errors that I think are unrelated to my changes, but I&apos;ll check yet. &lt;/p&gt;

&lt;p&gt;My initial performance numbers show it is just as fast as before, but I&apos;ll post more complete numbers later.&lt;/p&gt;</comment>
                            <comment id="13932812" author="remkop@yahoo.com" created="Thu, 13 Mar 2014 02:44:24 +0000"  >&lt;p&gt;At first glance this accomplishes the same as what I was trying to do, but without the enums. It looks simpler. I need to take a more detailed look later, but just looking at AbstractLogger I like your patch better than my solution. &lt;/p&gt;</comment>
                            <comment id="13934113" author="garydgregory" created="Thu, 13 Mar 2014 21:29:45 +0000"  >&lt;p&gt;With Bruce&apos;s patch I get:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Failed tests:
  RewriteAppenderTest.rewriteTest:83 Incorrect number of events. Expected 1, got 0
  JSONRoutingAppender2Test.routingTest:79 Incorrect number of events. Expected 1, got 0
  JSONRoutingAppenderTest.routingTest:79 Incorrect number of events. Expected 1, got 0
  RoutingAppenderTest.routingTest:79 Incorrect number of events. Expected 1, got 0
  RoutingAppenderWithJndiTest.routingTest:103 Incorrect number of events. Expected 1, got 0
  RoutingDefaultAppenderTest.routingTest:79 Incorrect number of events. Expected 1, got 0

Tests run: 539, Failures: 6, Errors: 0, Skipped: 12

[INFO] ------------------------------------------------------------------------
[INFO] Reactor Summary:
[INFO]
[INFO] Apache Log4j 2 .................................... SUCCESS [  1.136 s]
[INFO] Apache Log4j API .................................. SUCCESS [ 47.379 s]
[INFO] Apache Log4j Core ................................. FAILURE [09:06 min]
[INFO] Apache Log4J Core OSGi Async ...................... SKIPPED
[INFO] Apache Log4J Core OSGi JPA ........................ SKIPPED
[INFO] Apache Log4j 1.x Compatibility API ................ SKIPPED
[INFO] Apache Log4J 1.x Compatibility Bundle ............. SKIPPED
[INFO] Apache Log4J Core OSGi Net ........................ SKIPPED
[INFO] Apache Log4J Core OSGi CouchDB .................... SKIPPED
[INFO] Apache Log4J Core OSGi MongoDB .................... SKIPPED
[INFO] Apache Log4J Core OSGi ............................ SKIPPED
[INFO] Apache Log4j to SLF4J Adapter ..................... SKIPPED
[INFO] Apache Log4j to SLF4J ............................. SKIPPED
[INFO] Apache Log4j SLF4J Binding ........................ SKIPPED
[INFO] Apache Log4j for SLF4J ............................ SKIPPED
[INFO] Apache Log4J Core OSGi Bundles .................... SKIPPED
[INFO] Apache Log4j Commons Logging Bridge ............... SKIPPED
[INFO] Apache Log4j Flume NG Bridge ...................... SKIPPED
[INFO] Apache Log4j Tag Library .......................... SKIPPED
[INFO] Apache Log4j JMX GUI .............................. SKIPPED
[INFO] Apache Log4j Samples .............................. SKIPPED
[INFO] Apache Log4j Samples: Flume - Common .............. SKIPPED
[INFO] Apache Log4j Samples: Flume - Remote .............. SKIPPED
[INFO] Apache Log4j Samples: Flume - Embedded ............ SKIPPED
[INFO] Apache Log4j 2 BOM ................................ SKIPPED
[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Can you provide another patch?&lt;/p&gt;</comment>
                            <comment id="13934515" author="bruce.brouwer" created="Fri, 14 Mar 2014 03:22:11 +0000"  >&lt;p&gt;I fixed the problems with the failing tests. Everything now passes. &lt;/p&gt;</comment>
                            <comment id="13935921" author="bruce.brouwer" created="Sat, 15 Mar 2014 01:27:32 +0000"  >&lt;p&gt;I wanted to give an overview of what my patch is trying to do:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Simplify most logger methods to be one line of code&lt;/li&gt;
	&lt;li&gt;Allow classes that wrap a logger (e.g. using AbstractLoggerWrapper) to use one line of code to log. To accomplish this, I created all the variants of the log(...) methods that now take a FQCN as the first parameter.&lt;/li&gt;
	&lt;li&gt;Created an interface called LoggerProvider that AbstractLogger implements. This I think makes it a bit clearer what extra methods are needed beyond what is in the Logger interface to succesfully wrap a logger. This also allows for different (future) logger implementations that don&apos;t need to extend AbstractLogger.&lt;/li&gt;
	&lt;li&gt;I changed LoggerContext to return LoggerProvider. Most people don&apos;t tend to go after the LoggerContext, so most people won&apos;t see this. But by doing this here, it makes it clear that loggers coming from here are guaranteed to have this extra functionality, and it eliminates some casting done in the code&lt;/li&gt;
	&lt;li&gt;I tried to fix some of the method parameter ordering to be consistent: fqcn, level, marker, message, ... This patch doesn&apos;t cover all cases where this could be done but in the cases were I was changing method signatures anyway, I thought I would make the order consistent.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;You may notice that this patch includes a change to log4j-jcl Log4jLog.java. This was not absolutely necessary, but it seemed somehow wrong to me to rely on the fact that the method signatures of jcl match up perfectly to log4j2. The patch implementation also prevents leaking a bunch of other public methods into the implementation coming from AbstractLogger and AbstractLoggerWrapper. If others don&apos;t agree with me, it would be easy to revert Log4jLog.java back to what it was before, but instead of the first constructor parameter being AbstractLogger, it would change to LoggerProvider. &lt;/p&gt;

&lt;p&gt;I also just noticed that log4j-to-slf4j SLF4JLogger.logMessage has an unnecessary switch statement. That should probably be cleaned up as switching it to simply call logger.log(FQCN, level, getMarker(marker), ...) would actually be more performant, not only because it eliminates the switch statement, but it would also go through fewer method invocations. Do you want me to provide an updated patch that does this?&lt;/p&gt;

&lt;p&gt;Finally, I ran PerfTestDriver, just the &quot;Loggers all async&quot; tests. I am not sure what the best thing is to do to communicate performance, but this is what I did. I was kind of surprised to see that this patch is actually consistently more performant than the current log4j2 code (at least that&apos;s how I&apos;m reading it). &lt;/p&gt;

&lt;h5&gt;&lt;a name=&quot;Original%3A&quot;&gt;&lt;/a&gt;Original:&lt;/h5&gt;
&lt;p&gt;1. Log4j2: Loggers all async (single thread): throughput: 12,746,429 ops/sec. latency(ns): avg=980.2 99% &amp;lt; 8192.0 99.99% &amp;lt; 1101004.8 (494079 samples)&lt;br/&gt;
2. Log4j2: Loggers all async (4 threads): throughput: 6,603,641 ops/sec. latency(ns): avg=3157.4 99% &amp;lt; 5120.0 99.99% &amp;lt; 8703180.8 (3376684 samples)&lt;br/&gt;
3. Log4j2: Loggers all async (2 threads): throughput: 3,505,632 ops/sec. latency(ns): avg=1103.5 99% &amp;lt; 5324.8 99.99% &amp;lt; 2516582.4 (2339717 samples)&lt;/p&gt;

&lt;h5&gt;&lt;a name=&quot;After%3A&quot;&gt;&lt;/a&gt;After:&lt;/h5&gt;
&lt;p&gt;1. Log4j2: Loggers all async (single thread): throughput: 13,612,251 ops/sec. latency(ns): avg=8463.0 99% &amp;lt; 8192.0 99.99% &amp;lt; 2936012.8 (344455 samples)&lt;br/&gt;
2. Log4j2: Loggers all async (4 threads): throughput: 7,395,284 ops/sec. latency(ns): avg=2690.5 99% &amp;lt; 5939.2 99.99% &amp;lt; 8231321.6 (5952262 samples)&lt;br/&gt;
3. Log4j2: Loggers all async (2 threads): throughput: 4,639,382 ops/sec. latency(ns): avg=1079.2 99% &amp;lt; 6144.0 99.99% &amp;lt; 2464153.6 (2312163 samples)&lt;/p&gt;</comment>
                            <comment id="13935983" author="remkop@yahoo.com" created="Sat, 15 Mar 2014 04:29:22 +0000"  >&lt;p&gt;Thanks for the overview. It is helpful to not only know what you are doing but also why you are doing it.&lt;/p&gt;

&lt;p&gt;Thanks also for running the performance test. These numbers tend to vary between runs, and I suspect the difference between before and after is not significant. (Meaning that your changes did not make performance worse. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ) Some platforms are more consistent than others, but for example on my Windows laptop I see large differences between runs. What OS &amp;amp; hardware (cpu, #cores) did you use?&lt;/p&gt;

&lt;p&gt;I should update the performance test to print only throughput with standard deviation and omit the (useless) latency numbers. The same test framework also has a latency-only test mode but currently processing/pretty-printing those results is not automated yet.&lt;/p&gt;

&lt;p&gt;A final note on performance testing: I&apos;ve started to look at &lt;a href=&quot;http://openjdk.java.net/projects/code-tools/jmh/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JMH&lt;/a&gt; for benchmarking log4j performance. Looks promising.&lt;/p&gt;</comment>
                            <comment id="13936211" author="bruce.brouwer" created="Sat, 15 Mar 2014 14:55:54 +0000"  >&lt;p&gt;I ran the performance test on my Windows 7 64-bit laptop while plugged in. It is a single-proc, 4 core Intel i7 2.7GHz machine with 8GB RAM.&lt;/p&gt;</comment>
                            <comment id="13937433" author="garydgregory" created="Mon, 17 Mar 2014 03:58:03 +0000"  >&lt;p&gt;I think I like &lt;tt&gt;log4j2-555-bbrouwer-2.patch&lt;/tt&gt; so far.  All tests pass with the patch applied to trunk. I&apos;d like to spend more time looking at this. Hopefully we&apos;ll get more feedback from the others.&lt;/p&gt;</comment>
                            <comment id="13937728" author="bruce.brouwer" created="Mon, 17 Mar 2014 12:12:29 +0000"  >&lt;p&gt;After thinking some more about my change to log4j-jcl Log4jLog, I could quite easily be convinced to revert that back to extending AbstractLoggerWrapper. I could see some convenience in simply casting Log4jLog between jcl&apos;s Log and log4j&apos;s Logger interface. For example, if I was using jcl&apos;s interface to log4j, I could simply cast to a jcl Log to log4j&apos;s Logger to use the different logger streams depicted in &lt;a href=&quot;https://issues.apache.org/jira/browse/LOG4J2-547&quot; title=&quot;Update LoggerStream API&quot; class=&quot;issue-link&quot; data-issue-key=&quot;LOG4J2-547&quot;&gt;&lt;del&gt;LOG4J2-547&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;However, if we do that, then we should probably do the same thing to log4j-slf4j-impl&apos;s SLF4JLogger so it can also be cast to log4j&apos;s Logger interface. I suppose this change could be tracked in a separate JIRA. &lt;/p&gt;

&lt;p&gt;So what do people think? Should these alternate logging implementations be made so it is easy to cast to log4j&apos;s Logger interface, or should we try to keep the interface to these alternate logging implementations as free as possible of log4j public methods? &lt;/p&gt;

&lt;p&gt;Oh, and I now see that my comment about log4j-to-slf4j SLF4JLogger.logMessage was in error. It is fine as it is (which is how it remains in the patch)&lt;/p&gt;

&lt;p&gt;I also see that I was remiss in finishing up JavaDoc. If people like the direction of &lt;tt&gt;log4j-555-bbrouwer-2.patch&lt;/tt&gt;, I can make a new patch, or I will commit to submitting a documentation patch if this is applied before that new patch.&lt;/p&gt;</comment>
                            <comment id="13943949" author="remkop@yahoo.com" created="Sat, 22 Mar 2014 06:30:10 +0000"  >&lt;p&gt;I&apos;ve finished reviewing log4j-555-bbrouwer-2.patch. &lt;br/&gt;
Things I liked:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;simplified code, reduced duplication in AbstractLogger and slf4j-impl.SLF4JLogger&lt;/li&gt;
	&lt;li&gt;LoggerProvider interface removes need to cast to AbstractLogger when extending/customizing Logger&lt;/li&gt;
	&lt;li&gt;clearer distinction between &quot;external&quot; API &lt;tt&gt;log&lt;/tt&gt; methods for users and &quot;internal&quot; API &lt;tt&gt;logMessage&lt;/tt&gt; method for extenders (but see below)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;TBD:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;del&gt;in AbstractLogger the &lt;tt&gt;debug/trace/info/...(Object objMessage)&lt;/tt&gt; methods now call &lt;tt&gt;log(FQCN, Level.XXX, null, messageFactory.newMessage(objMessage), null);&lt;/tt&gt; so a Message object may be created unnecessarily if &lt;tt&gt;isEnabled&lt;/tt&gt; later returns false.&lt;/del&gt; EDIT: this looks like a mistake, not a design issue: these methods can just call &lt;tt&gt;AbstractLogger.log(String, Level, Marker, Object, Throwable)&lt;/tt&gt; (line 1313 of patched AbstractLogger) without calling messageFactory.newMessage(objMessage)&lt;/li&gt;
	&lt;li&gt;the new (internal API) &lt;tt&gt;log&lt;/tt&gt; methods introduced in the LoggerProvider interface are confusingly similar to the external API &lt;tt&gt;log&lt;/tt&gt; methods (same method name, only the order of parameters is different). How about renaming them to &lt;tt&gt;logIfEnabled&lt;/tt&gt; or something else?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13944058" author="garydgregory" created="Sat, 22 Mar 2014 13:48:36 +0000"  >&lt;p&gt;Thank you for the review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=remkop%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;remkop@yahoo.com&quot;&gt;remkop@yahoo.com&lt;/a&gt;. These are all good points.&lt;/p&gt;

&lt;p&gt;WRT&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;in AbstractLogger the debug/trace/info/...(Object objMessage) methods now call log(FQCN, Level.XXX, null, messageFactory.newMessage(message), null); so a Message object may be created unnecessarily if isEnabled later returns false&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I wonder if we should fix this. On one hand:&lt;br/&gt;
This would have to be fixed because creating objects for nothing will be a giant GC hit, to be considered a leak IMO. &lt;/p&gt;

&lt;p&gt;OTOH, this would assume the call site is not guarded with a &lt;tt&gt;isDebugEnabled()&lt;/tt&gt; for example, so the &apos;leak&apos; can be fixed by adding the guard clause.&lt;/p&gt;

&lt;p&gt;It depends what we define the contract for this method and class to be WRT to bullet proofing against this kind of &apos;leak&apos;.&lt;/p&gt;

&lt;p&gt;The code with patch is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    /**
     * Logs a message object with the {@link Level#DEBUG DEBUG} level.
     * 
     * @param message the message object to log.
     */
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void debug(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; message) {
        log(FQCN, Level.DEBUG, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, messageFactory.newMessage(message), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The obvious fix is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void debug(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; message) {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isEnabled(Level.DEBUG)) {
            log(FQCN, Level.DEBUG, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, messageFactory.newMessage(message), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But we have both:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;org.apache.logging.log4j.spi.AbstractLogger.log(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Level, Marker, Message, Throwable)
org.apache.logging.log4j.spi.AbstractLogger.log(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Level, Marker, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, Throwable)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Why not:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void debug(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; message) {
        log(FQCN, Level.DEBUG, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, message, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;?&lt;/p&gt;

&lt;p&gt;A local build with the patch and this change builds OK with &apos;mvn test&apos;.&lt;/p&gt;</comment>
                            <comment id="13944086" author="garydgregory" created="Sat, 22 Mar 2014 14:22:29 +0000"  >&lt;p&gt;All of Bruce&apos;s &quot;2&quot; patch plus my changes. Bruce: verify that I did not drop anything...&lt;/p&gt;</comment>
                            <comment id="13944095" author="remkop@yahoo.com" created="Sat, 22 Mar 2014 14:49:04 +0000"  >&lt;p&gt;Gary, looks like our messages crossed. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  I agree with your solution to avoid the potentially unnecessary call to &lt;tt&gt;messageFactory.newMessage&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Bruce, one more small thing I noticed: line 1160 of AbstractLogger in log4j-555-bbrouwer-2.patch:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void log(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Level level, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Marker marker, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; message, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Throwable t) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isEnabled(level, marker, message, t)) {
        logMessage(FQCN, level, marker, message, t);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Should this not be the below instead?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void log(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Level level, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Marker marker, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; message, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Throwable t) {
    log(FQCN, level, marker, message, t);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Finally, I strongly feel we should have a different name for the &quot;internal API&quot; &lt;tt&gt;LoggerProvider.log&lt;/tt&gt; methods (used by implementers/extenders) and the &quot;external API&quot; &lt;tt&gt;Logger.log&lt;/tt&gt; methods (used by users). I propose we rename the LoggerProvider &lt;tt&gt;log&lt;/tt&gt; methods to &lt;tt&gt;logIfEnabled&lt;/tt&gt;. Other names would be fine too, just not &quot;log&quot; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;If nobody objects I will rename the LoggerProvider &lt;tt&gt;log&lt;/tt&gt; methods to &lt;tt&gt;logIfEnabled&lt;/tt&gt; and commit Bruce&apos;s &quot;2&quot; patch plus Gary&apos;s changes tomorrow (my tomorrow, that is Saturday night US time).&lt;/p&gt;</comment>
                            <comment id="13944149" author="bruce.brouwer" created="Sat, 22 Mar 2014 17:15:34 +0000"  >&lt;p&gt;All good points from everyone. Yes, it appears that all of the points that everyone made are things I simply missed. I am also ok with renaming the LoggerProvider &lt;tt&gt;log&lt;/tt&gt; methods to &lt;tt&gt;logIfEnabled&lt;/tt&gt;. I definitely appreciate all the extra eyes reviewing my code. I&apos;m not planning on providing another patch as it sounds like Remko will clean it up. &lt;/p&gt;</comment>
                            <comment id="13944339" author="remkop@yahoo.com" created="Sun, 23 Mar 2014 04:57:43 +0000"  >&lt;p&gt;Fixed in revision 1580445, based on log4j2-555-bbrouwer-2.patch with Gary&apos;s changes.&lt;/p&gt;

&lt;p&gt;I also modified log4j-1.2-api Category (slightly different from the patch):&lt;br/&gt;
&lt;tt&gt;forcedLog&lt;/tt&gt; (line 337) now calls &lt;tt&gt;logger.logMessage&lt;/tt&gt; instead of logger.logIfEnabled.&lt;br/&gt;
&lt;tt&gt;maybeLog&lt;/tt&gt; (line 431) now calls &lt;tt&gt;logger.logMessage&lt;/tt&gt; instead of logger.logIfEnabled.&lt;/p&gt;</comment>
                            <comment id="14017686" author="remkop@yahoo.com" created="Wed, 4 Jun 2014 13:29:16 +0000"  >&lt;p&gt;Renamed LoggerProvider to ExtendedLogger and renamed AbstractLoggerProvider back to AbstractLogger after discussion on the log4j-dev mailing list.&lt;br/&gt;
Committed in revision 1600200.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12698650">LOG4J2-562</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12633537" name="LOG4J2-555-delegate.patch" size="44149" author="rpopma" created="Sat, 8 Mar 2014 12:04:39 +0000"/>
                            <attachment id="12634629" name="log4j2-555-bbrouwer-2.patch" size="132871" author="bruce.brouwer" created="Fri, 14 Mar 2014 03:22:11 +0000"/>
                            <attachment id="12634333" name="log4j2-555-bbrouwer.patch" size="128505" author="bruce.brouwer" created="Thu, 13 Mar 2014 02:22:13 +0000"/>
                            <attachment id="12636204" name="log4j2-555-gg-v3.diff" size="130247" author="ggregory" created="Sat, 22 Mar 2014 14:22:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>376632</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 25 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1swfj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>376927</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>