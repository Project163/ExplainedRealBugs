<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:30:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-149] SMTPManager buffer access not synchronized; can result in empty emails</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-149</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;If multiple error events are logged against the same SMTPAppender/Manager at the same time, one email will contain both error messages, while the second will be empty (no events).&lt;/p&gt;

&lt;p&gt;The original SMTPAppender patch included synchronization against the CyclicBuffer to prevent such simultaneous access from multiple threads. This appears to have been lost in the merge/refactor. Patch (to follow shortly) re-introduces synchronization against the CyclicBuffer in the narrowest possible scope.&lt;/p&gt;</description>
                <environment>&lt;p&gt;N/A&lt;/p&gt;</environment>
        <key id="12627431">LOG4J2-149</key>
            <summary>SMTPManager buffer access not synchronized; can result in empty emails</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rgoers">Ralph Goers</assignee>
                                    <reporter username="ssevertson">Scott Severtson</reporter>
                        <labels>
                    </labels>
                <created>Mon, 14 Jan 2013 14:06:52 +0000</created>
                <updated>Fri, 1 Feb 2013 16:36:04 +0000</updated>
                            <resolved>Tue, 15 Jan 2013 19:13:08 +0000</resolved>
                                    <version>2.0-beta4</version>
                                    <fixVersion>2.0-beta4</fixVersion>
                                    <component>Appenders</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13552665" author="ssevertson" created="Mon, 14 Jan 2013 14:07:33 +0000"  >&lt;p&gt;Re-introduce CyclicBuffer synchronization to prevent empty error emails.&lt;/p&gt;</comment>
                            <comment id="13552667" author="ssevertson" created="Mon, 14 Jan 2013 14:08:23 +0000"  >&lt;p&gt;BTW, this issue is &lt;b&gt;not&lt;/b&gt; hypothetical - we experienced this twice today on a highly-threaded component of our software.&lt;/p&gt;</comment>
                            <comment id="13552812" author="garydgregory" created="Mon, 14 Jan 2013 15:52:35 +0000"  >&lt;p&gt;The question is likely for Ralph.&lt;/p&gt;

&lt;p&gt;It seems wrong that SMTPAppender.isFiltered(LogEvent) adds the log event to the cyclic buffer.&lt;/p&gt;

&lt;p&gt;Perhaps a touch of comments would help &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Gary&lt;/p&gt;
</comment>
                            <comment id="13552816" author="ssevertson" created="Mon, 14 Jan 2013 15:55:31 +0000"  >&lt;p&gt;It is in the JavaDoc.&lt;/p&gt;

&lt;p&gt;    /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Capture all events in CyclicBuffer&lt;br/&gt;
     */&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;--Scott&lt;/p&gt;</comment>
                            <comment id="13552831" author="garydgregory" created="Mon, 14 Jan 2013 16:15:27 +0000"  >&lt;p&gt;Well, yeah, I&apos;ve read that much &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I would have thought that the appender&apos;s append would add the event and that the manager would flush itself when the buffer reaches some threshold.&lt;/p&gt;

&lt;p&gt;Instead adding the event during the isFiltered call fells like a hack because if you call isFiltered more than once for a given event, you&apos;ll get two log events in the buffer. The buffer itself could easily check for that condition of course, but then it would be carrying more complex semantics than a &quot;cyclic buffer&quot;.&lt;/p&gt;

&lt;p&gt;Gary&lt;/p&gt;</comment>
                            <comment id="13552845" author="ssevertson" created="Mon, 14 Jan 2013 16:27:04 +0000"  >&lt;p&gt;But, if the event is filtered by .isFiltered, then .append is never called. Is there a better place to intercept &lt;b&gt;all&lt;/b&gt; messages (only once)?&lt;/p&gt;</comment>
                            <comment id="13552861" author="garydgregory" created="Mon, 14 Jan 2013 16:41:38 +0000"  >&lt;p&gt;It does not sound right that if the log event is added to the manager not matter what is isFiltered returns. &lt;/p&gt;

&lt;p&gt;If isFiltered returns true, then append is called and all is well.&lt;/p&gt;

&lt;p&gt;If isFiltered return false, the log event should not make it to the manager. &lt;/p&gt;

&lt;p&gt;Am I missing something here?&lt;/p&gt;

&lt;p&gt;I realize that this is now a different issue than I originally wondered about...&lt;/p&gt;

&lt;p&gt;Gary&lt;/p&gt;</comment>
                            <comment id="13552869" author="ssevertson" created="Mon, 14 Jan 2013 16:49:18 +0000"  >&lt;p&gt;It&apos;s re-creating the functionality from Log4J 1.x - previous (lower priority) log events are buffered, but only events above the filter theshold trigger an alert email (containing both the triggering event, and the previous X log events).&lt;/p&gt;</comment>
                            <comment id="13552908" author="garydgregory" created="Mon, 14 Jan 2013 17:25:24 +0000"  >&lt;p&gt;Ah... I see, I need to go back to filter school it seems. I see how filters play in the big picture now.&lt;/p&gt;

&lt;p&gt;Reading &lt;a href=&quot;https://logging.apache.org/log4j/2.x/manual/filters.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://logging.apache.org/log4j/2.x/manual/filters.html&lt;/a&gt; I have this follow up.&lt;/p&gt;

&lt;p&gt;No matter what happens with other filters in steps 1-4, the appender isFilter method will always be called? If yes, then all is well because the log event will be added. &lt;/p&gt;</comment>
                            <comment id="13552911" author="ssevertson" created="Mon, 14 Jan 2013 17:27:12 +0000"  >&lt;p&gt;Probably a question for Ralph - I&apos;m not entirely sure.&lt;/p&gt;</comment>
                            <comment id="13552919" author="ralph.goers@dslextreme.com" created="Mon, 14 Jan 2013 17:42:06 +0000"  >&lt;p&gt;It took me by surprise too when I first saw how the SMTPAppender worked, but I understand what it is trying to do. There isn&apos;t any danger of the isFilter method being called twice - that is only going to happen in the AppenderControl.  Note that this will NOT capture events that have been filtered by a global Filter, Logger Filter or Appender-ref Filter as they will never make it this far.  You would have to create a special global filter to capture the events if you really want to capture everything.&lt;/p&gt;

&lt;p&gt;As for the patch, I&apos;m not sure what it is accomplishing.  The CyclicBuffer add and removeAll methods are synchronized so wrapping those calls in a synchronized block doesn&apos;t do anything useful.  Removing buffer as a parameter from two methods and then having writeBuffer just reference the member variable also should accomplish nothing.  So I&apos;m not ready to apply this patch until I understand how it fixes the problem.&lt;/p&gt;

&lt;p&gt;It would also be helpful to have a test that demonstrates the problem.&lt;/p&gt;</comment>
                            <comment id="13552924" author="ssevertson" created="Mon, 14 Jan 2013 17:50:05 +0000"  >&lt;p&gt;Ralph is correct - the patch doesn&apos;t actually solve the problem. Sorry for the false start.&lt;/p&gt;

&lt;p&gt;FYI, I removed the parameter from a few methods to make it more clear what was being synchronized on (the SMTPManager.buffer instance variable), versus synchronizing on the passed-in variable. I didn&apos;t catch that synchronization had been moved to the CyclicBuffer itself.&lt;/p&gt;

&lt;p&gt;I&apos;ll do what I can to create a test app later. However, it&apos;s easy to describe the problem:&lt;br/&gt;
Thread 1: App sends log message #1&lt;br/&gt;
Thread 1: Log4J calls isFiltered(message #1) (appends to buffer)&lt;br/&gt;
Thread 2: App sends log message #2&lt;br/&gt;
Thread 2: Log4J calls isFiltered(message #2) (appends to buffer)&lt;br/&gt;
Thread 1: Log4J calls append(message #1) (clears buffer, delivers &lt;b&gt;both&lt;/b&gt; messages)&lt;br/&gt;
Thread 2: Log4J calls append(message #2) (empty buffer, delivers no messages)&lt;/p&gt;

&lt;p&gt;Any thoughts on a possible approach to preventing the above scenario?&lt;/p&gt;</comment>
                            <comment id="13552928" author="ralph.goers@dslextreme.com" created="Mon, 14 Jan 2013 17:54:36 +0000"  >&lt;p&gt;Yeah. The way to handle this is to only add messages that match the filter to the buffer.&lt;/p&gt;</comment>
                            <comment id="13553280" author="ssevertson" created="Mon, 14 Jan 2013 23:46:55 +0000"  >&lt;p&gt;So, we came up with two possible approaches to solve this issue:&lt;/p&gt;

&lt;p&gt;1. Make CyclicBuffer smarter, replacing .removeAll() with .removeTo(T item). This would allow SMTPManager to only remove events &lt;b&gt;up to&lt;/b&gt; the triggering event, leaving anything appended after in the buffer. However, this has a couple issues:&lt;br/&gt;
  a. Empty or nonsensical emails (not containing the target event) could still occur, if the CyclicBuffer is too small, and more events are written to the buffer between the .isFiltered call and the .append call. This is actually an issue with the current implementation as well.&lt;br/&gt;
  b. Log4jLogEvent would need to (at a minimum) implement a .equals method, so we can actually find the target event in the CyclicBuffer. I&apos;m not sure if .equals was omitted purposefully.&lt;br/&gt;
  b. The .removeTo code would be a bit more complex than the current .removeAll implementation.&lt;/p&gt;

&lt;p&gt;2. Don&apos;t append non-filtered items in the .isFiltered method; instead, wait and append them to the buffer just before the current .removeAll call. This would ensure that at least the triggering event is reported. However, this also has an issue: Currently, CyclicBuffer claims to be thread-safe, as all mutating methods are synchronized. As .add would be called just before .removeAll, the calling code in SMTPManager would need to instead hold a synchronization lock (similar to my previous bad patch for this issue). Alternatively, .removeAll() could become an atomic .removeAllAndInclude(T item), preserving the thread-safety of CyclicBuffer, at the cost of some reusability of the class (the method doesn&apos;t seem to make sense for general use cases).&lt;/p&gt;

&lt;p&gt;I&apos;ve done a proof of concept with #2, which only required changing a few lines in a couple files. I did &lt;b&gt;not&lt;/b&gt; yet make an atomic .removeAllAndInclude, but could if this alternative is desired.&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="13553288" author="ralph.goers@dslextreme.com" created="Mon, 14 Jan 2013 23:54:54 +0000"  >&lt;p&gt;I had already started making the changes for approach # 2 this morning but $work got in the way.  I&apos;m headed to the airport in a few hours and will be in a class the next two days so won&apos;t be very prompt with emails from 9-5 Pacific time.  However, my approach to #2 sounds a little different as the triggering event is never added to the cyclic buffer but is instead passed to the writeContent method where it is written after the buffer.  I suspect adding the event to the buffer as you describe will result in a race condition.&lt;/p&gt;</comment>
                            <comment id="13553313" author="ssevertson" created="Tue, 15 Jan 2013 00:16:53 +0000"  >&lt;p&gt;Patch to always log the triggering event.&lt;/p&gt;</comment>
                            <comment id="13553315" author="ssevertson" created="Tue, 15 Jan 2013 00:18:01 +0000"  >&lt;p&gt;The only downside with that approach is that the message can contain CyclicBuffer.ring.length + 1 messages (i.e. one more than the configured buffer size). However, that&apos;s the approach I ended up settling on as well. Patch above.&lt;/p&gt;</comment>
                            <comment id="13553344" author="ralph.goers@dslextreme.com" created="Tue, 15 Jan 2013 00:39:13 +0000"  >&lt;p&gt;Your patch looks correct but it looks like Gary made some updates to the file and your patch won&apos;t apply. Can you please update to the latest source and regenerate the patch?&lt;/p&gt;</comment>
                            <comment id="13553359" author="ssevertson" created="Tue, 15 Jan 2013 00:58:31 +0000"  >&lt;p&gt;The patch was generated against SVN revision #1433251, and &quot;svn update&quot; found no additional changes beyond that. I compared the previously attached patch with a regenerated patch, and there were no differences. Not sure what you&apos;re seeing?&lt;/p&gt;</comment>
                            <comment id="13553377" author="garydgregory" created="Tue, 15 Jan 2013 01:18:33 +0000"  >&lt;p&gt;FWIW: The version of SMTPManager on my machine is 1433252.&lt;/p&gt;

&lt;p&gt;Could this be a sync issue between the EU and US version of the repo?&lt;/p&gt;

&lt;p&gt;Gary&lt;/p&gt;</comment>
                            <comment id="13553390" author="ssevertson" created="Tue, 15 Jan 2013 01:39:01 +0000"  >&lt;p&gt;Maybe. I just checked out a clean copy of log4j2 trunk, and the patch applied cleanly for me.&lt;/p&gt;</comment>
                            <comment id="13554131" author="ralph.goers@dslextreme.com" created="Tue, 15 Jan 2013 18:50:01 +0000"  >&lt;p&gt;My fault. I hadn&apos;t done the svn up to pick up Gary&apos;s changes.&lt;/p&gt;</comment>
                            <comment id="13554174" author="ralph.goers@dslextreme.com" created="Tue, 15 Jan 2013 19:13:08 +0000"  >&lt;p&gt;Patch applied. Please verify and close.&lt;/p&gt;</comment>
                            <comment id="13568857" author="ssevertson" created="Fri, 1 Feb 2013 16:36:04 +0000"  >&lt;p&gt;We can confirm that at least one log message appears in every email.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12564813" name="SMTPAppender-always-log-last-event.patch" size="4898" author="ssevertson" created="Tue, 15 Jan 2013 00:16:53 +0000"/>
                            <attachment id="12564707" name="SMTPManager-buffer-synchronization.patch" size="2375" author="ssevertson" created="Mon, 14 Jan 2013 14:07:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>304215</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 42 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i17k5r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>252235</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>