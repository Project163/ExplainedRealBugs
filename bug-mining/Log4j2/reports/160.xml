<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:31:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-336] AsyncLogger.log fail with NullPointerException after double reconfigure</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-336</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;Using reconfigure() to select log files at runtime.&lt;br/&gt;
After the second reconfigure, the next log fails with a NullPointerException in &lt;tt&gt;org.apache.logging.log4j.core.async.AsyncLoggerConfigHelper:253&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;It appears that the disruptor has been nulled and not been brought back up by the second &lt;tt&gt;reconfigure()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Trying to get a minimal test case I came up with the following log4j2.xml:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;?xml version=&lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt; encoding=&lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt; ?&amp;gt;
&amp;lt;configuration status=&lt;span class=&quot;code-quote&quot;&gt;&quot;debug&quot;&lt;/span&gt;&amp;gt;
  &amp;lt;appenders&amp;gt;
    &amp;lt;Console name=&lt;span class=&quot;code-quote&quot;&gt;&quot;console&quot;&lt;/span&gt; target=&lt;span class=&quot;code-quote&quot;&gt;&quot;SYSTEM_OUT&quot;&lt;/span&gt;&amp;gt;
      &amp;lt;PatternLayout pattern=&lt;span class=&quot;code-quote&quot;&gt;&quot;%d\{ABSOLUTE\} %6p %c %x - %m%n&quot;&lt;/span&gt;/&amp;gt;
    &amp;lt;/Console&amp;gt;
  &amp;lt;/appenders&amp;gt;
  &amp;lt;loggers&amp;gt;
    &amp;lt;asyncroot level=&lt;span class=&quot;code-quote&quot;&gt;&quot;WARN&quot;&lt;/span&gt;&amp;gt;
      &amp;lt;appender-ref ref=&lt;span class=&quot;code-quote&quot;&gt;&quot;console&quot;&lt;/span&gt; /&amp;gt;
    &amp;lt;/asyncroot&amp;gt;
  &amp;lt;/loggers&amp;gt;
&amp;lt;/configuration&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The following Java class did NOT bring up the error, instead it threw a different exception (stack trace below):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.logging.log4j.LogManager;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.logging.log4j.Logger;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.logging.log4j.core.LoggerContext;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Log4jAsyncReconfTest {
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Logger log = LogManager.getLogger(Log4jAsyncReconfTest.class);
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InterruptedException {
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;);
        LoggerContext ctx = (LoggerContext) LogManager.getContext(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        ctx.reconfigure();
        ctx.reconfigure();
        log.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Danger!&quot;&lt;/span&gt;);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;hr /&gt;
&lt;p&gt;throws:&lt;/p&gt;

&lt;p&gt;java.util.concurrent.RejectedExecutionException: Task com.lmax.disruptor.BatchEventProcessor@7ea4461e rejected from java.util.concurrent.ThreadPoolExecutor@52f79c86&lt;span class=&quot;error&quot;&gt;&amp;#91;Terminated, pool size = 0, active threads = 0, queued tasks = 0, completed tasks = 1&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2048)&lt;br/&gt;
at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:821)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1372)&lt;br/&gt;
	at java.util.concurrent.Executors$DelegatedExecutorService.execute(Executors.java:628)&lt;br/&gt;
	at com.lmax.disruptor.dsl.EventProcessorInfo.start(EventProcessorInfo.java:77)&lt;br/&gt;
	at com.lmax.disruptor.dsl.Disruptor.start(Disruptor.java:263)&lt;br/&gt;
	at org.apache.logging.log4j.core.async.AsyncLoggerConfigHelper.initDisruptor(AsyncLoggerConfigHelper.java:119)&lt;/p&gt;</description>
                <environment>&lt;p&gt;LUbuntu 13.04, OpenJDK 7&lt;/p&gt;</environment>
        <key id="12662313">LOG4J2-336</key>
            <summary>AsyncLogger.log fail with NullPointerException after double reconfigure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="llogiq">Andre Bogus</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Aug 2013 08:32:36 +0000</created>
                <updated>Wed, 14 Aug 2013 14:03:05 +0000</updated>
                            <resolved>Wed, 14 Aug 2013 12:20:13 +0000</resolved>
                                    <version>2.0-beta8</version>
                                    <fixVersion>2.0-beta9</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13733030" author="remkop@yahoo.com" created="Thu, 8 Aug 2013 01:22:55 +0000"  >&lt;p&gt;Thanks for finding this. &lt;/p&gt;

&lt;p&gt;On reconfiguration, a new Disruptor instance is created, but no new thread pool is created. The new Disruptor instances references the old thread pool, which has been shut down (or is in the middle of shutting down), resulting in various errors. The solution is to create a new thread pool object every time a new Disruptor instance is created.&lt;/p&gt;</comment>
                            <comment id="13733218" author="llogiq" created="Thu, 8 Aug 2013 07:15:26 +0000"  >&lt;p&gt;You&apos;re very welcome. Thanks for working on this. So I presume this will be fixed with 2.0beta9? If so, when can we expect it to be available?&lt;/p&gt;</comment>
                            <comment id="13733291" author="remkop@yahoo.com" created="Thu, 8 Aug 2013 09:09:47 +0000"  >&lt;p&gt;Yes, this will be fixed with beta9. Not sure when that will be, community decision. Perhaps a few weeks from now?&lt;/p&gt;

&lt;p&gt;BTW, sorry I haven&apos;t had time to run your test case, but I assume you see the same issue (or worse) when making all loggers Async Loggers? (by setting -DLog4jContextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector)?&lt;/p&gt;</comment>
                            <comment id="13739082" author="remkop@yahoo.com" created="Wed, 14 Aug 2013 00:36:24 +0000"  >&lt;p&gt;I was finally able to track this down to an unbalanced number of calls to LoggerConfig#startFilter and #stopFilter. In o.a.l.l.c.c.BaseConfiguration, the #stop() method explicitly calls the #stopFilter() method on the root logger, but there is no equivalent call to root#startFilter in the BaseConfiguration#start() method.&lt;/p&gt;

&lt;p&gt;This means that the reference count (used to determine when to shut down or create new Disruptor instances) is incorrect when the configuration contains a &lt;tt&gt;&amp;lt;asyncRoot&amp;gt;&lt;/tt&gt; element.&lt;/p&gt;

&lt;p&gt;Proposed solution:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// o.a.l.l.c.c.BaseConfiguration
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void start() {
    setup();
    doConfigure();
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; LoggerConfig logger : loggers.values()) {
        logger.startFilter();
    }
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Appender appender : appenders.values()) {
        appender.start();
    }
    root.startFilter(); &lt;span class=&quot;code-comment&quot;&gt;// add &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; line
&lt;/span&gt;    startFilter();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that the #startFilter and #stopFilter methods may be called twice for the root logger. Not ideal, but better than stopping twice for every start. Based on current usage I don&apos;t see any problems. FYI, currently AsyncLoggerConfig is the only LoggerConfig that overrides the default #startFilter and #stopFilter implementation.&lt;/p&gt;</comment>
                            <comment id="13739338" author="llogiq" created="Wed, 14 Aug 2013 07:12:28 +0000"  >&lt;p&gt;Hi again. Good job on finding this. If I may ask a stupid question, why does log4j need to explicitly stop the root filter?&lt;/p&gt;</comment>
                            <comment id="13739580" author="remkop@yahoo.com" created="Wed, 14 Aug 2013 12:03:56 +0000"  >&lt;p&gt;Andre, during a reconfigure, new Appenders and LoggerConfig objects are created and started, and the old ones are all stopped, including the old root LoggerConfig. &lt;/p&gt;</comment>
                            <comment id="13739591" author="llogiq" created="Wed, 14 Aug 2013 12:11:56 +0000"  >&lt;p&gt;Allow me to rephrase my question: Why is the root LoggerConfig not part of the loggers Map by default?&lt;/p&gt;</comment>
                            <comment id="13739596" author="remkop@yahoo.com" created="Wed, 14 Aug 2013 12:20:13 +0000"  >&lt;p&gt;Fixed in revision 1513832.&lt;br/&gt;
Please verify and close.&lt;/p&gt;</comment>
                            <comment id="13739604" author="remkop@yahoo.com" created="Wed, 14 Aug 2013 12:35:27 +0000"  >&lt;p&gt;Andre, one reason I can see is that it is possible to create a configuration without a root element. In that case a default root element is created automatically (with a console Appender, ERROR level and a default layout). In this scenario the root logger is not part of the loggers Map.&lt;/p&gt;

&lt;p&gt;As far as I can tell, the root logger would be part of the loggers Map if a &lt;tt&gt;&amp;lt;root&amp;gt;&lt;/tt&gt; (or &lt;tt&gt;&amp;lt;asyncRoot&amp;gt;&lt;/tt&gt;) logger is configured in the configuration file.&lt;/p&gt;</comment>
                            <comment id="13739682" author="llogiq" created="Wed, 14 Aug 2013 13:59:51 +0000"  >&lt;p&gt;Wouldn&apos;t adding a default root logger into the loggers Map even if one isn&apos;t configured be a more general solution? Edit: I&apos;ve just checked out the trunk, will compile, verify and hopefully close this issue shortly.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>342317</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 15 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1n1av:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>342622</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>