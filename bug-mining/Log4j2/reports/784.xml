<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 19:36:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[LOG4J2-1342] ReusableParameterizedMessage should preserve parameters when used with Async Loggers</title>
                <link>https://issues.apache.org/jira/browse/LOG4J2-1342</link>
                <project id="12310790" key="LOG4J2">Log4j 2</project>
                    <description>&lt;p&gt;&lt;b&gt;Problem&lt;/b&gt;&lt;br/&gt;
Some layouts (like CsvParameterLayout) need access to the message parameters. With the current garbage-free asynchronous logging implementation the formatted message text is passed correctly, but parameter information is no longer passed on.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Analysis&lt;/b&gt;&lt;br/&gt;
ReusableParameterizedMessage instances are mutable by design and their contents may be overwritten with the next call to &lt;tt&gt;Logger.log&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;For synchronous logging this is not an issue since the message contents will have been fully processed by the appenders before this happens.&lt;/p&gt;

&lt;p&gt;With asynchronous logging, the log event and its contents need to be handed off to the background thread, and we need to ensure that this data is not modified by another call to &lt;tt&gt;Logger.log&lt;/tt&gt; before the background thread can process it. Different async logging mechanisms handle this in different ways:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Async Appender&lt;/b&gt;&lt;br/&gt;
This appender takes a snapshot of the LogEvent before enqueueing it. This is implemented by invoking &lt;tt&gt;Log4jLogEvent.serialize(LogEvent)&lt;/tt&gt;. The Message contents is turned into text with &lt;tt&gt;Message.getFormattedString()&lt;/tt&gt; and a new &lt;tt&gt;SimpleMessage&lt;/tt&gt; is created with this text. In the process, any parameters of the original message are lost.&lt;/p&gt;

&lt;p&gt;This mechanism does not try to be garbage-free, so one solution would be to add a method &lt;tt&gt;createMemento() : Message&lt;/tt&gt; to ReusableMessage. ReusableParameterizedMessage could implement this to copy the parameter values into the memento copy.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;All Loggers Async&lt;/b&gt;&lt;br/&gt;
This has a ring buffer with pre-allocated RingBufferLogEvent objects. Values are copied into these RingBufferLogEvents for each call to &lt;tt&gt;Logger.log&lt;/tt&gt;. If the message is a ReusableMessage, RingBufferLogEvent will call &lt;tt&gt;message.formatTo(StringBuilder&lt;/tt&gt; to copy the formatted message text to a StringBuilder held by the the RingBufferLogEvent. This only copies the formatted text, any parameters of the original message are lost.&lt;/p&gt;

&lt;p&gt;Potential solution: RingBufferLogEvent could have an Object[] array field to hold parameters. When the RingBufferLogEvent is populated, the ReusableMessage could swap its parameter array with the RingBufferLogEvent&apos;s parameter array.&lt;/p&gt;

&lt;p&gt;There needs to be a method in ReusableMessage to allow this swap.&lt;/p&gt;

&lt;p&gt;Consideration: when RingBufferLogEvent.clear() is called, the array elements need to be nulled out to prevent memory leaks.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Mixed Sync/Async Loggers&lt;/b&gt;&lt;br/&gt;
This has a ring buffer with pre-allocated Log4jEventWrapper objects. In classic mode, when &lt;tt&gt;Logger.log&lt;/tt&gt; is called a new Log4jLogEvent is created and set in the Log4jEventWrapper. In garbage-free mode, the Log4jEventWrapper is pre-allocated with MutableLogEvent objects and the values from the &lt;tt&gt;Logger.log&lt;/tt&gt; call are copied into the ringbuffer&apos;s MutableLogEvent. In that case we have the same problem as with &lt;em&gt;All Loggers Async&lt;/em&gt;: If the message is a ReusableMessage, RingBufferLogEvent will call &lt;tt&gt;message.formatTo(StringBuilder&lt;/tt&gt; to copy the formatted message text to a StringBuilder held by the the RingBufferLogEvent. This only copies the formatted text, any parameters of the original message are lost.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12954878">LOG4J2-1342</key>
            <summary>ReusableParameterizedMessage should preserve parameters when used with Async Loggers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rpopma">Remko Popma</assignee>
                                    <reporter username="rpopma">Remko Popma</reporter>
                        <labels>
                    </labels>
                <created>Thu, 31 Mar 2016 07:14:01 +0000</created>
                <updated>Fri, 22 Apr 2016 06:11:38 +0000</updated>
                            <resolved>Fri, 22 Apr 2016 06:09:58 +0000</resolved>
                                    <version>2.6</version>
                                    <fixVersion>2.6</fixVersion>
                                    <component>API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="15253420" author="remkop@yahoo.com" created="Fri, 22 Apr 2016 06:09:58 +0000"  >&lt;p&gt;Fixed in master.&lt;/p&gt;

&lt;p&gt;The following methods were added to &lt;tt&gt;ReusableMessage&lt;/tt&gt;:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;memento() - takes immutable snapshot, for use by AsyncAppender&lt;/li&gt;
	&lt;li&gt;swapParameters(Object[] emptyReplacement) : Object[]&lt;/li&gt;
	&lt;li&gt;getParameterCount()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Layouts that want to be garbage-free and have access to the original parameters should use this pattern:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] DUMMY = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[10];
...
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void encode(LogEvent event, ByteBufferDestination destination) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (event.getMessage() &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ReusableMessage) {
        ReusableMessage reusable = (ReusableMessage) event.getMessage();
        &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] params = reusable.swapParameters(DUMMY);
        reusable.swapParameters(params); &lt;span class=&quot;code-comment&quot;&gt;// swap back, or DUMMY will be modified by other thread later
&lt;/span&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; reusable.getParameterCount(); i++) {
            doSomethingWithParam(i, params[i]);
        }
    }
    ....
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12956077">LOG4J2-1353</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311120" key="com.pyxis.greenhopper.jira:gh-epic-link">
                        <customfieldname>Epic Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>LOG4J2-1270</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 30 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2vg07:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>