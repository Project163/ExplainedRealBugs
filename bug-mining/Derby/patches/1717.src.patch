diff --git a/java/engine/org/apache/derby/impl/store/access/btree/BTreeController.java b/java/engine/org/apache/derby/impl/store/access/btree/BTreeController.java
index c9db4c64d..ab829e905 100644
--- a/java/engine/org/apache/derby/impl/store/access/btree/BTreeController.java
+++ b/java/engine/org/apache/derby/impl/store/access/btree/BTreeController.java
@@ -381,8 +381,8 @@ public class BTreeController extends OpenBTree implements ConglomerateController
         LeafControlRow originalLeaf = leaf;
         while (leaf != null) {
             if (slot == 0) {
+                LeafControlRow oldLeaf = leaf;
                 try {
-                    LeafControlRow oldLeaf = leaf;
                     //slot is pointing before the first slot
                     //get left sibiling
                     leaf = (LeafControlRow) leaf.getLeftSibling(this);
@@ -400,7 +400,14 @@ public class BTreeController extends OpenBTree implements ConglomerateController
                     // of the loop body to get the slot number rechecked.
                     continue;
                 } catch (WaitError we) {
-                    throw StandardException.plainWrapException(we);
+                    // DERBY-4097: Couldn't latch the left sibling without
+                    // waiting. Release all latches and rescan from top of
+                    // B-tree to prevent deadlock.
+                    if (newLeaf) {
+                        oldLeaf.release();
+                    }
+                    originalLeaf.release();
+                    return RESCAN_REQUIRED;
                 }
             }
             rh = leaf.page.fetchFromSlot(null, slot, rows, null, true);
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/NullableUniqueConstraintTest.java b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/NullableUniqueConstraintTest.java
index 0ca5b8ba0..a13194b34 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/NullableUniqueConstraintTest.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/NullableUniqueConstraintTest.java
@@ -473,7 +473,11 @@ public class NullableUniqueConstraintTest extends BaseJDBCTestCase {
         // The error happened most frequently in the second iteration, but
         // it didn't always, so we repeat it ten times to increase the
         // likelihood of triggering the bug.
-        for (int i = 0; i < 10; i++) {
+        // DERBY-4097: Increase the number of iterations to increase the
+        // likelihood of exposing another timing-dependent problem with a
+        // WaitError caused by a conflict between the post-commit thread
+        // and the user thread.
+        for (int i = 0; i < 100; i++) {
             for (int j = 0; j < 1000; j++) {
                 insert.setInt(1, j);
                 insert.addBatch();
