diff --git a/build.xml b/build.xml
index a8e9582d1..69e22aa77 100644
--- a/build.xml
+++ b/build.xml
@@ -2329,6 +2329,9 @@
     <!-- Set a dummy value for the JaCoCo agent option when running without
          JaCoCo for code coverage. Required because ant doesn't (yet) handle
          empty variables passed to jvmarg. See also target jacoco-enable. -->
+    <!-- The purpose of the system property derby.tests.jacoco.agent is to
+         allow the Derby test framework to pass on the correct -javaagent
+         option when spawning VMs. -->
     <condition property="derby.tests.jacoco.agent" value="-Dderby.dummy.prop=X">
       <not>
         <isset property="derby.tests.jacoco.agent"/>            
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/RuntimeInfoTest.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/RuntimeInfoTest.policy
index ecf6beb02..1f11f9108 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/RuntimeInfoTest.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/RuntimeInfoTest.policy
@@ -375,6 +375,11 @@ grant {
   permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
+// Grant the required permissions for JaCoCo (code coverage tool).
+grant {
+  permission java.io.FilePermission "${jacoco.active}${user.dir}${/}*", "read, write";
+};
+
 // When inserting XML values that use external DTD's, the JAXP parser
 // needs permission to read the DTD files.  We assume that all DTD
 // files will be copied to extin/ by whichever tests need them.  So
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SecureServerTest.java b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SecureServerTest.java
index 8c85bc91f..6bc4394b7 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SecureServerTest.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SecureServerTest.java
@@ -330,7 +330,7 @@ public class SecureServerTest extends BaseJDBCTestCase
 
         assertEquals( myName + ": serverCameUp = " + serverCameUp, _outcome.serverShouldComeUp(), serverCameUp );
 
-        if (!runsWithEmma()) {
+        if (!(runsWithEmma() || runsWithJaCoCo())) {
             // With Emma we run without the security manager, so we can't
             // assert on seeing it.
             assertTrue( myName + "\nExpected: " +
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SysinfoTest.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SysinfoTest.policy
index 659e98e29..b1949d695 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SysinfoTest.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SysinfoTest.policy
@@ -381,6 +381,11 @@ grant {
   permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
+// Grant the required permissions for JaCoCo (code coverage tool).
+grant {
+  permission java.io.FilePermission "${jacoco.active}${user.dir}${/}*", "read, write";
+};
+
 // When inserting XML values that use external DTD's, the JAXP parser
 // needs permission to read the DTD files.  We assume that all DTD
 // files will be copied to extin/ by whichever tests need them.  So
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/jdbc4/noAbortPermission.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/jdbc4/noAbortPermission.policy
index 8662d7db8..35b80442d 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/jdbc4/noAbortPermission.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/jdbc4/noAbortPermission.policy
@@ -368,6 +368,11 @@ grant {
   permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
+// Grant the required permissions for JaCoCo (code coverage tool).
+grant {
+  permission java.io.FilePermission "${jacoco.active}${user.dir}${/}*", "read, write";
+};
+
 // When inserting XML values that use external DTD's, the JAXP parser
 // needs permission to read the DTD files.  We assume that all DTD
 // files will be copied to extin/ by whichever tests need them.  So
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/LDAPTests.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/LDAPTests.policy
index 9b3df63c9..5e70e32fb 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/LDAPTests.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/LDAPTests.policy
@@ -348,6 +348,11 @@ grant {
   permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
+// Grant the required permissions for JaCoCo (code coverage tool).
+grant {
+  permission java.io.FilePermission "${jacoco.active}${user.dir}${/}*", "read, write";
+};
+
 // When inserting XML values that use external DTD's, the JAXP parser
 // needs permission to read the DTD files.  We assume that all DTD
 // files will be copied to extin/ by whichever tests need them.  So
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SecurityPolicyReloadingTest.initial.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SecurityPolicyReloadingTest.initial.policy
index 224af6c39..cde62b096 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SecurityPolicyReloadingTest.initial.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SecurityPolicyReloadingTest.initial.policy
@@ -105,3 +105,8 @@ grant {
     permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
     permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
+
+// Grant the required permissions for JaCoCo (code coverage tool).
+grant {
+  permission java.io.FilePermission "${jacoco.active}${user.dir}${/}*", "read, write";
+};
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/store/Derby3980DeadlockTest.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/store/Derby3980DeadlockTest.policy
index 98f054cb1..ae748108c 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/store/Derby3980DeadlockTest.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/store/Derby3980DeadlockTest.policy
@@ -370,6 +370,11 @@ grant {
   permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
+// Grant the required permissions for JaCoCo (code coverage tool).
+grant {
+  permission java.io.FilePermission "${jacoco.active}${user.dir}${/}*", "read, write";
+};
+
 // When inserting XML values that use external DTD's, the JAXP parser
 // needs permission to read the DTD files.  We assume that all DTD
 // files will be copied to extin/ by whichever tests need them.  So
diff --git a/java/testing/org/apache/derbyTesting/functionTests/util/derby_tests.policy b/java/testing/org/apache/derbyTesting/functionTests/util/derby_tests.policy
index e16fe7084..4cc862bf9 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/util/derby_tests.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/util/derby_tests.policy
@@ -416,6 +416,11 @@ grant {
   permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
+// Grant the required permissions for JaCoCo (code coverage tool).
+grant {
+  permission java.io.FilePermission "${jacoco.active}${user.dir}${/}*", "read, write";
+};
+
 // When inserting XML values that use external DTD's, the JAXP parser
 // needs permission to read the DTD files.  We assume that all DTD
 // files will be copied to extin/ by whichever tests need them.  So
diff --git a/java/testing/org/apache/derbyTesting/junit/BaseTestCase.java b/java/testing/org/apache/derbyTesting/junit/BaseTestCase.java
index 3650f9485..695f798d3 100644
--- a/java/testing/org/apache/derbyTesting/junit/BaseTestCase.java
+++ b/java/testing/org/apache/derbyTesting/junit/BaseTestCase.java
@@ -817,9 +817,7 @@ public abstract class BaseTestCase
     }
 
     public static boolean runsWithJaCoCo() {
-        String agentProp = getSystemProperty(JACOCO_AGENT_PROP);
-        // Additional logic due to the use of a dummy property in build.xml
-        return agentProp != null && agentProp.startsWith("-javaagent");
+        return SecurityManagerSetup.jacocoEnabled;
     }
 
     /**
diff --git a/java/testing/org/apache/derbyTesting/junit/NetworkServerTestSetup.java b/java/testing/org/apache/derbyTesting/junit/NetworkServerTestSetup.java
index d83215d7d..537a19979 100644
--- a/java/testing/org/apache/derbyTesting/junit/NetworkServerTestSetup.java
+++ b/java/testing/org/apache/derbyTesting/junit/NetworkServerTestSetup.java
@@ -331,7 +331,8 @@ final public class NetworkServerTestSetup extends BaseTestSetup {
         // running with Emma we don't run with the security manager, as the
         // default server policy doesn't contain needed permissions and,
         // additionally, Emma sources do not use doPrivileged blocks anyway.
-        if (!TestConfiguration.loadingFromJars() || BaseTestCase.runsWithEmma())
+        if (!TestConfiguration.loadingFromJars() ||
+                BaseTestCase.runsWithEmma() || BaseTestCase.runsWithJaCoCo())
         {
             boolean setNoSecurityManager = true;
             for (int i = 0; i < systemProperties.length; i++)
diff --git a/java/testing/org/apache/derbyTesting/junit/SecurityManagerSetup.java b/java/testing/org/apache/derbyTesting/junit/SecurityManagerSetup.java
index 356d35540..f2501b93f 100644
--- a/java/testing/org/apache/derbyTesting/junit/SecurityManagerSetup.java
+++ b/java/testing/org/apache/derbyTesting/junit/SecurityManagerSetup.java
@@ -88,7 +88,20 @@ public final class SecurityManagerSetup extends TestSetup {
 		externalSecurityManagerInstalled = determineClasspath();
         
 	}
-	
+
+    static final boolean jacocoEnabled = checkIfJacocoIsRunning();
+    private static boolean checkIfJacocoIsRunning() {
+        return ((Boolean)AccessController.doPrivileged(new PrivilegedAction() {
+                public Object run() {
+                    if (getURL("org.jacoco.agent.rt.RT") != null) {
+                        System.setProperty("jacoco.active", "");
+                        return Boolean.TRUE;
+                    }
+                    return Boolean.FALSE;
+                }
+		})).booleanValue();
+    }
+
 	private final String decoratorPolicyResource;
     /** An additional policy to install (may be {@code null}). */
     private final String additionalPolicyResource;
@@ -339,7 +352,7 @@ public final class SecurityManagerSetup extends TestSetup {
         if (emma != null) {
             classPathSet.setProperty("emma.active", "");
         }
-		
+
         /* When inserting XML values that use external DTD's, the JAXP
          * parser needs permission to read the DTD files.  So here we set
          * a property to hold the location of the JAXP implementation
@@ -430,6 +443,8 @@ public final class SecurityManagerSetup extends TestSetup {
             return getURL(Class.forName(className));
         } catch (ClassNotFoundException e) {
             return null;
+        } catch (NoClassDefFoundError e) {
+            return null;
         }
     }
 	
