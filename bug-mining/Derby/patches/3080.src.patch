diff --git a/java/engine/org/apache/derby/impl/jdbc/EmbedConnection.java b/java/engine/org/apache/derby/impl/jdbc/EmbedConnection.java
index f9c78dc5f..8320cebd0 100644
--- a/java/engine/org/apache/derby/impl/jdbc/EmbedConnection.java
+++ b/java/engine/org/apache/derby/impl/jdbc/EmbedConnection.java
@@ -37,6 +37,7 @@ import org.apache.derby.iapi.services.property.PropertyUtil;
 import org.apache.derby.iapi.jdbc.AuthenticationService;
 import org.apache.derby.iapi.jdbc.EngineConnection;
 import org.apache.derby.security.DatabasePermission;
+import org.apache.derby.iapi.security.SecurityUtil;
 
 import org.apache.derby.iapi.db.Database;
 import org.apache.derby.impl.db.SlaveDatabase;
@@ -2892,6 +2893,9 @@ public class EmbedConnection implements EngineConnection
 	*/
 	public final ContextManager getContextManager() {
 
+        // Verify that we have permission to execute this method.
+        SecurityUtil.checkDerbyInternalsPrivilege();
+
 		if (SanityManager.DEBUG)
 			SanityManager.ASSERT(!isClosed(), "connection is closed");
 
diff --git a/java/engine/org/apache/derby/jdbc/EmbedXAResource.java b/java/engine/org/apache/derby/jdbc/EmbedXAResource.java
index c5ed2bc0c..9e8edfd06 100644
--- a/java/engine/org/apache/derby/jdbc/EmbedXAResource.java
+++ b/java/engine/org/apache/derby/jdbc/EmbedXAResource.java
@@ -672,9 +672,11 @@ class EmbedXAResource implements XAResource {
                     throw wrapInXAException(sqle);
                 }
                 
-                tranState = new XATransactionState(
-                    con.realConnection.getContextManager(),
-                    con.realConnection, this, xid_im);
+                tranState = new XATransactionState
+                    (
+                     getContextManager( con.realConnection ),
+                     con.realConnection, this, xid_im
+                     );
                 if (!ra.addConnection(xid_im, tranState))
                     throw new XAException(XAException.XAER_DUPID);
                 
@@ -938,23 +940,34 @@ class EmbedXAResource implements XAResource {
      */
     private  static  ContextService    getContextService()
     {
-        if ( System.getSecurityManager() == null )
-        {
-            return ContextService.getFactory();
-        }
-        else
-        {
-            return AccessController.doPrivileged
-                (
-                 new PrivilegedAction<ContextService>()
+        return AccessController.doPrivileged
+            (
+             new PrivilegedAction<ContextService>()
+             {
+                 public ContextService run()
                  {
-                     public ContextService run()
-                     {
-                         return ContextService.getFactory();
-                     }
+                     return ContextService.getFactory();
                  }
-                 );
-        }
+             }
+             );
+    }
+
+    /**
+     * Privileged lookup of the ContextManager. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextManager    getContextManager( final EmbedConnection conn )
+    {
+        return AccessController.doPrivileged
+            (
+             new PrivilegedAction<ContextManager>()
+             {
+                 public ContextManager run()
+                 {
+                     return conn.getContextManager();
+                 }
+             }
+             );
     }
 
 }
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/ConstraintCharacteristicsTest.java b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/ConstraintCharacteristicsTest.java
index 6caa75e58..8abddee22 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/ConstraintCharacteristicsTest.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/ConstraintCharacteristicsTest.java
@@ -21,6 +21,8 @@
 
 package org.apache.derbyTesting.functionTests.tests.lang;
 
+import java.security.AccessController;
+import java.security.PrivilegedAction;
 import java.sql.Connection;
 import java.sql.DatabaseMetaData;
 import java.sql.DriverManager;
@@ -408,11 +410,7 @@ public class ConstraintCharacteristicsTest extends BaseJDBCTestCase
 
         s.executeUpdate("alter table t alter constraint c enforced ");
 
-        final ContextManager contextManager =
-                ((EmbedConnection)c).getContextManager();
-        final LanguageConnectionContext lcc =
-                (LanguageConnectionContext)contextManager.getContext(
-                "LanguageConnectionContext");
+        final LanguageConnectionContext lcc = getLCC( c );
         final GenericPreparedStatement derbyPs =
                 (GenericPreparedStatement)lcc.getLastActivation().
                 getPreparedStatement();
@@ -2831,5 +2829,25 @@ public class ConstraintCharacteristicsTest extends BaseJDBCTestCase
         }
 
     }
+    
+    /**
+     * Privileged lookup of the LCC from a Connection.
+     */
+    public  static  LanguageConnectionContext    getLCC( final Connection conn )
+    {
+        return AccessController.doPrivileged
+            (
+             new PrivilegedAction<LanguageConnectionContext>()
+             {
+                 public LanguageConnectionContext run()
+                 {
+                     final ContextManager contextManager =
+                         ((EmbedConnection)conn).getContextManager();
+                     return (LanguageConnectionContext)
+                         contextManager.getContext( "LanguageConnectionContext" );
+                 }
+             }
+             );
+    }
 }
 
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/NewOptimizerOverridesTest.java b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/NewOptimizerOverridesTest.java
index d07b75863..fd6d27ab3 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/NewOptimizerOverridesTest.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/NewOptimizerOverridesTest.java
@@ -527,8 +527,7 @@ public class NewOptimizerOverridesTest  extends GeneratedColumnsHelper
     /** Get an xml-based picture of the plan chosen for the last query. The query is identified by its JDBC ResultSet */
     public  static  Document    getLastQueryPlan( Connection conn, ResultSet rs ) throws Exception
     {
-        ContextManager      contextManager = ((EmbedConnection) conn).getContextManager();
-        LanguageConnectionContext   lcc = (LanguageConnectionContext) contextManager.getContext( "LanguageConnectionContext" );
+        LanguageConnectionContext   lcc = ConstraintCharacteristicsTest.getLCC( conn );
         org.apache.derby.iapi.sql.ResultSet derbyRS = lcc.getLastActivation().getResultSet();
 
         Document    doc = DocumentBuilderFactory.newInstance().newDocumentBuilder().newDocument();
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/NoDBInternalsPermissionTest.java b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/NoDBInternalsPermissionTest.java
index bc7bab7f8..97fbc38a0 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/NoDBInternalsPermissionTest.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/NoDBInternalsPermissionTest.java
@@ -32,6 +32,7 @@ import org.apache.derbyTesting.junit.SecurityManagerSetup;
 import org.apache.derbyTesting.junit.TestConfiguration;
 
 import org.apache.derby.iapi.services.context.ContextService;
+import org.apache.derby.impl.jdbc.EmbedConnection;
 
 /**
  * <p>
@@ -124,4 +125,19 @@ public class NoDBInternalsPermissionTest extends GeneratedColumnsHelper
         catch (AccessControlException e) { println( "Caught an AccessControlException" ); }
     }
 
+    /**
+     * <p>
+     * Verify that user code can't call EmbedConnection.getContextManager().
+     * </p>
+     */
+    public  void    test_002_EmbedConnection()
+        throws Exception
+    {
+        Connection  conn = getConnection();
+        try {
+            ((EmbedConnection) conn).getContextManager();
+            fail( "Should have raised an AccessControlException" );
+        }
+        catch (AccessControlException e) { println( "Caught an AccessControlException" ); }
+    }
 }
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/resultSetReader.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/resultSetReader.policy
index b04156fb8..fd78c7e21 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/resultSetReader.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/resultSetReader.policy
@@ -226,6 +226,9 @@ grant codeBase "${derbyTesting.codejar}derbytools.jar" {
 grant codeBase "${derbyTesting.testjar}derbyTesting.jar" {
   // Access all properties using System.getProperties
   permission java.util.PropertyPermission "*", "read, write";
+
+  // Needed to look up the LanguageConnectionContext
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
   
   // Access all files under ${user.dir}to write the test directory structure
   permission java.io.FilePermission "${user.dir}${/}-", "read,write,delete"; 
