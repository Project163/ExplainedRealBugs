diff --git a/java/engine/org/apache/derby/impl/sql/compile/SubqueryNode.java b/java/engine/org/apache/derby/impl/sql/compile/SubqueryNode.java
index f278ecddb..04e29e721 100644
--- a/java/engine/org/apache/derby/impl/sql/compile/SubqueryNode.java
+++ b/java/engine/org/apache/derby/impl/sql/compile/SubqueryNode.java
@@ -622,7 +622,25 @@ class SubqueryNode extends ValueNode
 		boolean		flattenable;
 		ValueNode	topNode = this;
 
-		resultSet = resultSet.preprocess(numTables, null, (FromList) null);
+        final boolean haveOrderBy; // need to remember for flattening decision
+
+        // Push the order by list down to the ResultSet
+        if (orderByList != null) {
+            haveOrderBy = true;
+            // If we have more than 1 ORDERBY columns, we may be able to
+            // remove duplicate columns, e.g., "ORDER BY 1, 1, 2".
+            if (orderByList.size() > 1)
+            {
+                orderByList.removeDupColumns();
+            }
+
+            resultSet.pushOrderByList(orderByList);
+            orderByList = null;
+        } else {
+            haveOrderBy = false;
+        }
+
+        resultSet = resultSet.preprocess(numTables, null, (FromList) null);
 
         if (leftOperand != null)
         {
@@ -684,7 +702,7 @@ class SubqueryNode extends ValueNode
 		 */
 		flattenable = (resultSet instanceof RowResultSetNode) &&
 					  underTopAndNode && !havingSubquery &&
-                      orderByList == null &&
+                      !haveOrderBy &&
                       offset == null &&
                       fetchFirst == null &&
 					  !isWhereExistsAnyInWithWhereSubquery() &&
@@ -756,7 +774,7 @@ class SubqueryNode extends ValueNode
 
 		flattenable = (resultSet instanceof SelectNode) &&
  			          !((SelectNode)resultSet).hasWindows() &&
-                      orderByList == null &&
+                      !haveOrderBy &&
                       offset == null &&
                       fetchFirst == null &&
 					  underTopAndNode && !havingSubquery &&
@@ -855,20 +873,6 @@ class SubqueryNode extends ValueNode
 
         resultSet.pushQueryExpressionSuffix();
 
-		// Push the order by list down to the ResultSet
-		if (orderByList != null) {
-			// If we have more than 1 ORDERBY columns, we may be able to
-			// remove duplicate columns, e.g., "ORDER BY 1, 1, 2".
-			if (orderByList.size() > 1)
-			{
-				orderByList.removeDupColumns();
-			}
-
-			resultSet.pushOrderByList(orderByList);
-			orderByList = null;
-		}
-
-
         resultSet.pushOffsetFetchFirst( offset, fetchFirst, hasJDBClimitClause );
 
 		/* We transform the leftOperand and the select list for quantified 
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/OLAPTest.java b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/OLAPTest.java
index 34a61e52d..c9d883195 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/OLAPTest.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/OLAPTest.java
@@ -588,11 +588,37 @@ public class OLAPTest extends BaseJDBCTestCase {
             "select * from t4 t_1 join t4 t_2 on " +
             "                     t_1.a = row_number() over () + t_2.a");
 
-        // DERBY-6565
+        // DERBY-6565: NPE before
         assertStatementError(
                 LANG_WINDOW_FUNCTION_CONTEXT_ERROR,
                 s,
                 "update t3 set y = y - row_number() over ()");
+
+        // DERBY-6688: subquery using SubqueryNode rather than FromSubquery
+        // had problems with presence of window function in order by.
+
+        JDBC.assertFullResultSet(s.executeQuery("select * from t3"),
+                new String[][]{{"4"},{"5"},{"6"},{"7"},{"8"}});
+
+        // failed prior to DERBY-6688
+        s.executeUpdate(
+            "update t3 set y = y - " +
+            "    (select y from t3 order by row_number() over () " +
+            "     fetch first 1 row only)");
+        JDBC.assertFullResultSet(s.executeQuery("select * from t3"),
+                new String[][]{{"0"},{"1"},{"2"},{"3"},{"4"}});
+
+        // Used to work before
+        JDBC.assertFullResultSet(s.executeQuery(
+            "select * from  " +
+            "    (select y from t3 order by row_number() over () fetch first 1 row only) tt"),
+            new String[][]{{"0"}});
+
+        // failed prior to DERBY-6688
+        JDBC.assertFullResultSet(s.executeQuery(
+            "select * from t3 where y = " +
+                "    (select y from t3 order by row_number() over () fetch first row only)"),
+            new String[][]{{"0"}});
     }
 
 
