diff --git a/java/testing/org/apache/derbyTesting/functionTests/master/encryptDatabase.out b/java/testing/org/apache/derbyTesting/functionTests/master/encryptDatabase.out
deleted file mode 100644
index 2c5b114ec..000000000
--- a/java/testing/org/apache/derbyTesting/functionTests/master/encryptDatabase.out
+++ /dev/null
@@ -1,135 +0,0 @@
-ij> --
---   Licensed to the Apache Software Foundation (ASF) under one or more
---   contributor license agreements.  See the NOTICE file distributed with
---   this work for additional information regarding copyright ownership.
---   The ASF licenses this file to You under the Apache License, Version 2.0
---   (the "License"); you may not use this file except in compliance with
---   the License.  You may obtain a copy of the License at
---
---      http://www.apache.org/licenses/LICENSE-2.0
---
---   Unless required by applicable law or agreed to in writing, software
---   distributed under the License is distributed on an "AS IS" BASIS,
---   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
---   See the License for the specific language governing permissions and
---   limitations under the License.
---
--- test database encryption
--- for bug 3668 - you couldn't change the password without exiting out of db create session
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Thursday, Wednesday');
-0 rows inserted/updated/deleted
-ij> disconnect;
-ij> connect 'jdbc:derby:;shutdown=true';
-ERROR XJ015: Derby system shutdown.
-ij> -- test for bug 3668
--- try the old password, should fail
-connect 'jdbc:derby:wombat;bootPassword=Thursday';
-ERROR XJ040: Failed to start database 'wombat' with class loader XXXX,  see the next exception for details.
-ERROR XBM06: Startup failed. An encrypted database cannot be accessed without the correct boot password.  
-ij> connect 'jdbc:derby:wombat;bootPassword=Wednesday';
-ij> -- switch back to old password
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Wednesday, Thursday');
-0 rows inserted/updated/deleted
-ij> create table t1 ( a char(20));
-0 rows inserted/updated/deleted
-ij> -- make sure we cannot access the secret key
-values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY('bootPassword');
-1                                                                                                                               
---------------------------------------------------------------------------------------------------------------------------------
-NULL                                                                                                                            
-ij> values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY('encryptedBootPassword');
-1                                                                                                                               
---------------------------------------------------------------------------------------------------------------------------------
-NULL                                                                                                                            
-ij> insert into t1 values ('hello world');
-1 row inserted/updated/deleted
-ij> -- change the secret key
--- these should fail
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', null);
-ERROR XBCX5: Cannot change boot password to null.
-ij> call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'wrongkey, ');
-ERROR XBCX2: Initializing cipher with a boot password that is too short. The password must be at least 8 characters long.    
-ij> call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Thursday');
-ERROR XBCX7: Wrong format for changing boot password.  Format must be : old_boot_password, new_boot_password.
-ij> call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Thursday , ');
-ERROR XBCX2: Initializing cipher with a boot password that is too short. The password must be at least 8 characters long.    
-ij> call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Thursday , short');
-ERROR XBCX2: Initializing cipher with a boot password that is too short. The password must be at least 8 characters long.    
-ij> call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Thursdya , derbypwd');
-ERROR XBCXA: Wrong boot password.
-ij> call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Thursdayx , derbypwd');
-ERROR XBCXA: Wrong boot password.
-ij> call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'xThursday , derbypwd');
-ERROR XBCXA: Wrong boot password.
-ij> call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'thursday , derbypwd');
-ERROR XBCXA: Wrong boot password.
-ij> -- this should work
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', ' Thursday , Saturday');
-0 rows inserted/updated/deleted
-ij> -- this should fail
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Thursday , derbypwd');
-ERROR XBCXA: Wrong boot password.
-ij> -- change it again
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Saturday,derbypwd');
-0 rows inserted/updated/deleted
-ij> -- make sure we cannot access the secret key
-values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY('bootPassword');
-1                                                                                                                               
---------------------------------------------------------------------------------------------------------------------------------
-NULL                                                                                                                            
-ij> values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY('encryptedBootPassword');
-1                                                                                                                               
---------------------------------------------------------------------------------------------------------------------------------
-NULL                                                                                                                            
-ij> disconnect;
-ij> connect 'jdbc:derby:;shutdown=true';
-ERROR XJ015: Derby system shutdown.
-ij> connect 'jdbc:derby:wombat';
-ERROR XJ040: Failed to start database 'wombat' with class loader XXXX,  see the next exception for details.
-ERROR XBM06: Startup failed. An encrypted database cannot be accessed without the correct boot password.  
-ij> connect 'jdbc:derby:wombat;bootPassword=Thursday';
-ERROR XJ040: Failed to start database 'wombat' with class loader XXXX,  see the next exception for details.
-ERROR XBM06: Startup failed. An encrypted database cannot be accessed without the correct boot password.  
-ij> connect 'jdbc:derby:wombat;bootPassword=Saturday';
-ERROR XJ040: Failed to start database 'wombat' with class loader XXXX,  see the next exception for details.
-ERROR XBM06: Startup failed. An encrypted database cannot be accessed without the correct boot password.  
-ij> connect 'jdbc:derby:wombat;bootPassword=derbypwd';
-ij> values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY('bootPassword');
-1                                                                                                                               
---------------------------------------------------------------------------------------------------------------------------------
-NULL                                                                                                                            
-ij> values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY('encryptedBootPassword');
-1                                                                                                                               
---------------------------------------------------------------------------------------------------------------------------------
-NULL                                                                                                                            
-ij> -- change it again, make sure it trims white spaces
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', '   derbypwd   ,  bbderbypwdx  ');
-0 rows inserted/updated/deleted
-ij> call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'bbderbypwdx, derbypwdxx ');
-0 rows inserted/updated/deleted
-ij> values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY('bootPassword');
-1                                                                                                                               
---------------------------------------------------------------------------------------------------------------------------------
-NULL                                                                                                                            
-ij> values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY('encryptedBootPassword');
-1                                                                                                                               
---------------------------------------------------------------------------------------------------------------------------------
-NULL                                                                                                                            
-ij> disconnect;
-ij> connect 'jdbc:derby:;shutdown=true';
-ERROR XJ015: Derby system shutdown.
-ij> connect 'jdbc:derby:wombat;bootPassword=derbypwd';
-ERROR XJ040: Failed to start database 'wombat' with class loader XXXX,  see the next exception for details.
-ERROR XBM06: Startup failed. An encrypted database cannot be accessed without the correct boot password.  
-ij> connect 'jdbc:derby:wombat;bootPassword=derbypwdxx';
-ij> select * from t1;
-A                   
---------------------
-hello world         
-ij> -- test that you cannot change the encryption provider or algorithm after database creation
--- this should not work
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('encryptionAlgorithm', 'DES/blabla/NoPadding');
-ERROR XBCXD: The encryption algorithm cannot be changed after the database is created.
-ij> call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('encryptionProvider', 'com.pom.aplomb');
-ERROR XBCXE: The encryption provider cannot be changed after the database is created.
-ij> 
diff --git a/java/testing/org/apache/derbyTesting/functionTests/suites/encryption.runall b/java/testing/org/apache/derbyTesting/functionTests/suites/encryption.runall
index 457dd2530..110e8710a 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/suites/encryption.runall
+++ b/java/testing/org/apache/derbyTesting/functionTests/suites/encryption.runall
@@ -1,3 +1,2 @@
 unit/T_Cipher.unit
-store/encryptDatabase.sql
 store/EncryptionTest.java
diff --git a/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionAES.properties b/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionAES.properties
deleted file mode 100644
index 759359a87..000000000
--- a/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionAES.properties
+++ /dev/null
@@ -1,21 +0,0 @@
-# Licensed to the Apache Software Foundation (ASF) under one or more
-# contributor license agreements.  See the NOTICE file distributed with
-# this work for additional information regarding copyright ownership.
-# The ASF licenses this file to you under the Apache License, Version 2.0
-# (the "License"); you may not use this file except in compliance with
-# the License.  You may obtain a copy of the License at
-#
-#     http://www.apache.org/licenses/LICENSE-2.0
-#
-# Unless required by applicable law or agreed to in writing, software
-# distributed under the License is distributed on an "AS IS" BASIS,
-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-# See the License for the specific language governing permissions and
-# limitations under the License.
-
-encryption=true
-testEncryptionAlgorithm=AES/CBC/NoPadding
-testJavaFlags=testDataEncryption=Thursday
-runwithibm13=false
-runwithjdk13=false
-runwithjdk14=false
diff --git a/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionAES.runall b/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionAES.runall
deleted file mode 100644
index b17f0ad2f..000000000
--- a/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionAES.runall
+++ /dev/null
@@ -1 +0,0 @@
-store/encryptDatabase.sql
diff --git a/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionBlowfish.runall b/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionBlowfish.runall
index 551d958c4..80f438b73 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionBlowfish.runall
+++ b/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionBlowfish.runall
@@ -1,2 +1 @@
 unit/T_CipherBlowfish.unit
-store/encryptDatabase.sql
diff --git a/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionCFB.runall b/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionCFB.runall
index 8af76afd0..d7ac4604d 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionCFB.runall
+++ b/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionCFB.runall
@@ -1,2 +1 @@
 unit/T_CipherCFB.unit
-store/encryptDatabase.sql
diff --git a/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionDES.runall b/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionDES.runall
index c953ec0c2..6cb7112e4 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionDES.runall
+++ b/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionDES.runall
@@ -1,2 +1 @@
 unit/T_CipherDES.unit
-store/encryptDatabase.sql
diff --git a/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionECB.runall b/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionECB.runall
index ccbd44223..8ebb0cf20 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionECB.runall
+++ b/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionECB.runall
@@ -1,2 +1 @@
 unit/T_CipherECB.unit
-store/encryptDatabase.sql
diff --git a/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionOFB.runall b/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionOFB.runall
index eb528345d..dc2438a5e 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionOFB.runall
+++ b/java/testing/org/apache/derbyTesting/functionTests/suites/encryptionOFB.runall
@@ -1,2 +1 @@
 unit/T_CipherOFB.unit
-store/encryptDatabase.sql
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/store/EncryptDatabaseTest.java b/java/testing/org/apache/derbyTesting/functionTests/tests/store/EncryptDatabaseTest.java
new file mode 100644
index 000000000..97e1212b3
--- /dev/null
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/store/EncryptDatabaseTest.java
@@ -0,0 +1,325 @@
+/*
+
+   Derby - Class org.apache.derbyTesting.functionTests.tests.store.EncryptDatabaseTest
+
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to you under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+
+ */
+
+package org.apache.derbyTesting.functionTests.tests.store;
+
+import java.sql.SQLException;
+import java.sql.Statement;
+import java.util.Arrays;
+import java.util.List;
+import javax.sql.DataSource;
+import junit.framework.Test;
+import junit.framework.TestSuite;
+import org.apache.derbyTesting.junit.*;
+
+
+/**
+ * Database encryption testing, mainly that handling of bootPassword works ok
+ * across encryption algorithms. Converted from {@code encryptDatabase.sql} in
+ * old harness, which was used in suites for the different algoritms,
+ * e.g. {@code encryptionECB}.  DERBY-2687.
+ */
+
+public class EncryptDatabaseTest  extends BaseJDBCTestCase
+{
+    // SQL states 
+    private static final String ENCRYPTION_NOCHANGE_ALGORITHM = "XBCXD";
+    private static final String ENCRYPTION_NOCHANGE_PROVIDER = "XBCXE";
+    private static final String ILLEGAL_BP_LENGTH = "XBCX2";
+    private static final String NULL_BOOT_PASSWORD = "XBCX5";
+    private static final String WRONG_BOOT_PASSWORD = "XBCXA";
+    private static final String WRONG_PASSWORD_CHANGE_FORMAT = "XBCX7";
+
+    
+    public EncryptDatabaseTest(String name) {
+        super(name);
+    }
+
+    
+    /**
+     * Construct top level suite in this JUnit test
+     *
+     * @return A suite containing embedded suites
+     */
+    public static Test suite() {
+        TestSuite suite = new TestSuite("EncryptDatabase");
+        suite.addTest(wrapTest());
+        suite.addTest(wrapTest("DESede/CBC/NoPadding")); // from encryption
+        suite.addTest(wrapTest("DESede/CFB/NoPadding")); // from encryptionCFB
+        suite.addTest(wrapTest("DES/OFB/NoPadding"));    // from encryptionOFB
+        suite.addTest(wrapTest("DES/ECB/NoPadding"));    // from encryptionECB
+        suite.addTest(wrapTest("DES/CBC/NoPadding"));    // from encryptionDES
+        suite.addTest(wrapTest("Blowfish/CBC/NoPadding")); // from e..Blowfish
+        suite.addTest(wrapTest("AES/CBC/NoPadding"));    // from encryptionAES
+        suite.addTest(wrapTest("AES/OFB/NoPadding"));
+        return suite;
+    }
+
+    
+    private static Test wrapTest() {
+        return Decorator.encryptedDatabaseBpw(
+                          TestConfiguration.embeddedSuite(
+                              EncryptDatabaseTest.class),
+                          "Thursday"); // only initial bootPassword, though..
+    }
+
+
+    private static Test wrapTest(String encryptionMethod) {
+        return Decorator.encryptedDatabaseBpw(
+                          TestConfiguration.embeddedSuite(
+                              EncryptDatabaseTest.class),
+                          encryptionMethod,
+                          "Thursday"); // only initial bootPassword, though..
+    }
+
+
+    public void testEncryption() throws SQLException {
+
+        // for bug 3668 - you couldn't change the password without exiting
+        // out of db create session
+
+        Statement s = createStatement();
+        s.executeUpdate("call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+                        "'bootPassword', 'Thursday, Wednesday')");
+
+        TestConfiguration.getCurrent().shutdownEngine();
+
+        // -- test for bug 3668
+        // -- try the old password, should fail
+        assertFailedBoot("Thursday");
+
+        assertSuccessfulBoot("Wednesday");
+        s = createStatement();
+
+        // -- switch back to old password
+        s.executeUpdate("call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+                        "'bootPassword', 'Wednesday, Thursday')");
+
+        // create table t1 ( a char(20));
+        s.executeUpdate("create table t1 ( a char(20))");
+
+        // -- make sure we cannot access the secret key
+
+        JDBC.assertSingleValueResultSet(
+            s.executeQuery("values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY(" +
+                           "'bootPassword')"),
+            null);
+
+        JDBC.assertSingleValueResultSet(
+            s.executeQuery("values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY(" +
+                           "'encryptedBootPassword')"),
+            null);
+
+        s.executeUpdate("insert into t1 values ('hello world')");
+
+        // -- change the secret key
+
+        // -- these should fail
+
+        assertFailedStatement(
+            s,
+            "call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+            "'bootPassword', null)",
+            NULL_BOOT_PASSWORD);
+
+        assertFailedStatement(
+            s,
+            "call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+            "'bootPassword', 'wrongkey, ')",
+            ILLEGAL_BP_LENGTH);
+
+        assertFailedStatement(
+            s,
+            "call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+            "'bootPassword', 'Thursday')",
+            WRONG_PASSWORD_CHANGE_FORMAT);
+
+        assertFailedStatement(
+            s,
+            "call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+            "'bootPassword', 'Thursday , ')",
+            ILLEGAL_BP_LENGTH);
+
+        assertFailedStatement(
+            s,
+            "call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+            "'bootPassword', 'Thursday , short')",
+            ILLEGAL_BP_LENGTH);
+
+        assertFailedStatement(
+            s,
+            "call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+            "'bootPassword', 'Thursdya , derbypwd')",
+            WRONG_BOOT_PASSWORD);
+
+        assertFailedStatement(
+            s,
+            "call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+            "'bootPassword', 'Thursdayx , derbypwd')",
+            WRONG_BOOT_PASSWORD);
+
+        assertFailedStatement(
+            s,
+            "call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+            "'bootPassword', 'xThursday , derbypwd')",
+            WRONG_BOOT_PASSWORD);
+
+        assertFailedStatement(
+            s,
+            "call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+            "'bootPassword', 'thursday , derbypwd')",
+            WRONG_BOOT_PASSWORD);
+
+        s.executeUpdate("call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+                        "'bootPassword', ' Thursday , Saturday')");
+
+        assertFailedStatement(
+            s,
+            "call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+            "'bootPassword', 'Thursday , derbypwd')",
+            WRONG_BOOT_PASSWORD);
+
+
+        // -- change it again
+
+        s.executeUpdate("call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+                        "'bootPassword', 'Saturday,derbypwd')");
+
+        // -- make sure we cannot access the secret key
+        JDBC.assertSingleValueResultSet(
+            s.executeQuery("values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY(" +
+                           "'bootPassword')"),
+            null);
+
+        JDBC.assertSingleValueResultSet(
+            s.executeQuery("values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY(" +
+                           "'encryptedBootPassword')"),
+            null);
+
+
+        TestConfiguration.getCurrent().shutdownEngine();
+
+        assertFailedBoot(null);
+        assertFailedBoot("Thursday");
+        assertFailedBoot("Saturday");
+        assertSuccessfulBoot("derbypwd");
+
+        s = createStatement();
+
+        JDBC.assertSingleValueResultSet(
+            s.executeQuery("values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY(" +
+                           "'bootPassword')"),
+            null);
+
+        JDBC.assertSingleValueResultSet(
+            s.executeQuery("values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY(" +
+                           "'encryptedBootPassword')"),
+            null);
+
+        // -- change it again, make sure it trims white spaces
+
+        s.executeUpdate("call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+                        "'bootPassword', '   derbypwd   ,  bbderbypwdx  ')");
+        s.executeUpdate("call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+                        "'bootPassword', 'bbderbypwdx, derbypwdxx ')");
+
+
+        JDBC.assertSingleValueResultSet(
+            s.executeQuery("values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY(" +
+                           "'bootPassword')"),
+            null);
+
+        JDBC.assertSingleValueResultSet(
+            s.executeQuery("values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY(" +
+                           "'encryptedBootPassword')"),
+            null);
+
+        TestConfiguration.getCurrent().shutdownEngine();
+
+        assertFailedBoot("derbypwd");
+        assertSuccessfulBoot("derbypwdxx");
+
+        s = createStatement();
+
+        JDBC.assertSingleValueResultSet(
+            s.executeQuery("select * from t1"),
+            "hello world");
+
+        // test that you cannot change the encryption provider or algorithm
+        // after database creation
+
+        assertFailedStatement(
+            s,
+            "call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+            "'encryptionAlgorithm', 'DES/blabla/NoPadding')",
+            ENCRYPTION_NOCHANGE_ALGORITHM);
+
+        assertFailedStatement(
+            s,
+            "call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(" +
+            "'encryptionProvider', 'com.pom.aplomb')",
+            ENCRYPTION_NOCHANGE_PROVIDER);
+    }
+
+
+    private void assertFailedBoot(String bootPassword) throws SQLException {
+        DataSource ds = JDBCDataSource.getDataSource();
+
+        JDBCDataSource.setBeanProperty(
+                ds, "connectionAttributes",
+                (bootPassword != null ? "bootPassword=" + bootPassword
+                 : "")); // "": lest we inherit bootPassword from current config
+
+
+        try {
+            ds.getConnection();
+            fail("boot worked: unexpected");
+        } catch (SQLException e) {
+
+            String [] accepted = new String[]{
+                "XBM06",  // normal: wrong bootpassword
+                "XJ040"}; // Java error during boot: DERBY-2687
+                          // Remove when DERBY-5622 is fixed.
+            boolean found = Arrays.asList(accepted).contains(e.getSQLState()); 
+
+            if (!found) {
+                throw e;
+            }
+        }
+    }
+
+
+    private static void assertSuccessfulBoot(String bootPassword)
+            throws SQLException {
+
+        DataSource ds = JDBCDataSource.getDataSource();
+        JDBCDataSource.setBeanProperty(
+            ds, "connectionAttributes", "bootPassword=" + bootPassword);
+        ds.getConnection().close();
+    }
+
+
+    private static void assertFailedStatement(Statement s,
+                                              String sql,
+                                              String state) {
+        assertStatementError(state, s, sql);
+    }
+}
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/store/_Suite.java b/java/testing/org/apache/derbyTesting/functionTests/tests/store/_Suite.java
index b049a4835..bdfef05d6 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/store/_Suite.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/store/_Suite.java
@@ -95,6 +95,7 @@ public class _Suite extends BaseTestCase  {
             suite.addTest(EncryptionKeyBlowfishTest.suite());
             suite.addTest(EncryptionKeyDESTest.suite());
             suite.addTest(EncryptionAESTest.suite());
+            suite.addTest(EncryptDatabaseTest.suite());
         }
 
         return suite;
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/store/encryptDatabase.sql b/java/testing/org/apache/derbyTesting/functionTests/tests/store/encryptDatabase.sql
deleted file mode 100644
index adfb609b5..000000000
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/store/encryptDatabase.sql
+++ /dev/null
@@ -1,103 +0,0 @@
---
---   Licensed to the Apache Software Foundation (ASF) under one or more
---   contributor license agreements.  See the NOTICE file distributed with
---   this work for additional information regarding copyright ownership.
---   The ASF licenses this file to You under the Apache License, Version 2.0
---   (the "License"); you may not use this file except in compliance with
---   the License.  You may obtain a copy of the License at
---
---      http://www.apache.org/licenses/LICENSE-2.0
---
---   Unless required by applicable law or agreed to in writing, software
---   distributed under the License is distributed on an "AS IS" BASIS,
---   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
---   See the License for the specific language governing permissions and
---   limitations under the License.
---
-
-
--- test database encryption
-
--- for bug 3668 - you couldn't change the password without exiting out of db create session
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Thursday, Wednesday');
-
-disconnect;
-connect 'jdbc:derby:;shutdown=true';
-
--- test for bug 3668
--- try the old password, should fail
-connect 'jdbc:derby:wombat;bootPassword=Thursday';
-connect 'jdbc:derby:wombat;bootPassword=Wednesday';
--- switch back to old password
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Wednesday, Thursday');
-
-create table t1 ( a char(20));
-
--- make sure we cannot access the secret key
-values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY('bootPassword');
-values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY('encryptedBootPassword');
-
-insert into t1 values ('hello world');
-
--- change the secret key
-
--- these should fail
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', null);
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'wrongkey, ');
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Thursday');
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Thursday , ');
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Thursday , short');
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Thursdya , derbypwd');
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Thursdayx , derbypwd');
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'xThursday , derbypwd');
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'thursday , derbypwd');
-
--- this should work
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', ' Thursday , Saturday');
-
--- this should fail
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Thursday , derbypwd');
-
--- change it again
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'Saturday,derbypwd');
-
-
--- make sure we cannot access the secret key
-values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY('bootPassword');
-values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY('encryptedBootPassword');
-
-disconnect;
-connect 'jdbc:derby:;shutdown=true';
-
-connect 'jdbc:derby:wombat';
-connect 'jdbc:derby:wombat;bootPassword=Thursday';
-connect 'jdbc:derby:wombat;bootPassword=Saturday';
-connect 'jdbc:derby:wombat;bootPassword=derbypwd';
-
-values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY('bootPassword');
-values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY('encryptedBootPassword');
-
--- change it again, make sure it trims white spaces
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', '   derbypwd   ,  bbderbypwdx  ');
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('bootPassword', 'bbderbypwdx, derbypwdxx ');
-
-values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY('bootPassword');
-values SYSCS_UTIL.SYSCS_GET_DATABASE_PROPERTY('encryptedBootPassword');
-
-disconnect;
-connect 'jdbc:derby:;shutdown=true';
-
-connect 'jdbc:derby:wombat;bootPassword=derbypwd';
-connect 'jdbc:derby:wombat;bootPassword=derbypwdxx';
-select * from t1;
-
--- test that you cannot change the encryption provider or algorithm after database creation
--- this should not work
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('encryptionAlgorithm', 'DES/blabla/NoPadding');
-call SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY('encryptionProvider', 'com.pom.aplomb');
-
-
-
-
-
-
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/store/encryptDatabase_app.properties b/java/testing/org/apache/derbyTesting/functionTests/tests/store/encryptDatabase_app.properties
deleted file mode 100644
index cd0b998e4..000000000
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/store/encryptDatabase_app.properties
+++ /dev/null
@@ -1,20 +0,0 @@
-# Licensed to the Apache Software Foundation (ASF) under one or more
-# contributor license agreements.  See the NOTICE file distributed with
-# this work for additional information regarding copyright ownership.
-# The ASF licenses this file to you under the Apache License, Version 2.0
-# (the "License"); you may not use this file except in compliance with
-# the License.  You may obtain a copy of the License at
-#
-#     http://www.apache.org/licenses/LICENSE-2.0
-#
-# Unless required by applicable law or agreed to in writing, software
-# distributed under the License is distributed on an "AS IS" BASIS,
-# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-# See the License for the specific language governing permissions and
-# limitations under the License.
-
-ij.database=jdbc:derby:wombat;create=true;dataEncryption=true;bootPassword=Thursday
-
-
-ij.showNoConnectionsAtStart=true
-ij.showNoCountForSelect=true
diff --git a/java/testing/org/apache/derbyTesting/junit/Decorator.java b/java/testing/org/apache/derbyTesting/junit/Decorator.java
index a0366a50c..38a9d4c58 100644
--- a/java/testing/org/apache/derbyTesting/junit/Decorator.java
+++ b/java/testing/org/apache/derbyTesting/junit/Decorator.java
@@ -56,17 +56,37 @@ public class Decorator {
      * @return decorated tests
      */
     public static Test encryptedDatabase(Test test)
+    {
+        return encryptedDatabaseBpw(test, getBootPhrase(16));
+    }
+
+    /**
+     * Decorate a set of tests to use an encrypted
+     * single use database. This is to run tests
+     * using encryption as a general test and
+     * not specific tests of how encryption is handled.
+     * E.g. tests of setting various URL attributes
+     * would be handled in a specific test.
+     * <BR>
+     * The database will use the default encryption
+     * algorithm.
+     * 
+     * @param test test to decorate
+     * @param bootPassword boot passphrase to use
+     * @return decorated tests
+     */
+    public static Test encryptedDatabaseBpw(Test test, String bootPassword)
     {
         if (JDBC.vmSupportsJSR169())
             return new TestSuite("no encryption support");
 
         Properties attributes = new Properties();
         attributes.setProperty("dataEncryption", "true");
-        attributes.setProperty("bootPassword", getBootPhrase(16));
+        attributes.setProperty("bootPassword", bootPassword);
 
         return attributesDatabase(attributes, test);
     }
-    
+
     /**
      * Decorate a set of tests to use an encrypted
      * single use database. This is to run tests
@@ -85,15 +105,38 @@ public class Decorator {
      * @return decorated tests
      */
     public static Test encryptedDatabase(Test test, final String algorithm)
+    {
+        return encryptedDatabaseBpw(test, algorithm, getBootPhrase(16));
+    }
+
+
+    /**
+     * Decorate a set of tests to use an encrypted
+     * single use database. This is to run tests
+     * using encryption as a general test and
+     * not specific tests of how encryption is handled.
+     * E.g. tests of setting various URL attributes
+     * would be handled in a specific test.
+     * <BR>
+     * The database will use the specified encryption
+     * algorithm.
+     * 
+     * @param test test to decorate
+     * @param bootPassword boot passphrase to use
+     * @return decorated tests
+     */
+    public static Test encryptedDatabaseBpw(Test test,
+                                            final String algorithm,
+                                            String bootPassword)
     {
         Properties attributes = new Properties();
         attributes.setProperty("dataEncryption", "true");
-        attributes.setProperty("bootPassword", getBootPhrase(64));
+        attributes.setProperty("bootPassword", bootPassword);
         attributes.setProperty("encryptionAlgorithm", algorithm);
 
         return attributesDatabase(attributes, test);
     }
-    
+
     private static String getBootPhrase(int length)
     {
         Random rand = new Random();
