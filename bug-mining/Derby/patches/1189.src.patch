diff --git a/java/engine/org/apache/derby/impl/jdbc/EmbedConnection.java b/java/engine/org/apache/derby/impl/jdbc/EmbedConnection.java
index 92c699ed2..b604d733c 100644
--- a/java/engine/org/apache/derby/impl/jdbc/EmbedConnection.java
+++ b/java/engine/org/apache/derby/impl/jdbc/EmbedConnection.java
@@ -326,6 +326,7 @@ public abstract class EmbedConnection implements EngineConnection
 				tr = new TransactionResourceImpl(driver, url, info);
 				active = true;
 				setupContextStack();
+				context = pushConnectionContext(tr.getContextManager());
 
 				if (!bootDatabase(info, false))
 				{
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/DboPowersTest.java b/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/DboPowersTest.java
index 0b037df71..ab0cf83ad 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/DboPowersTest.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/DboPowersTest.java
@@ -22,6 +22,7 @@
 package org.apache.derbyTesting.functionTests.tests.jdbcapi;
 
 import java.sql.SQLException;
+import java.sql.Connection;
 import javax.sql.DataSource;
 import junit.framework.Test;
 import junit.framework.TestSuite;
@@ -445,8 +446,9 @@ public class DboPowersTest extends BaseJDBCTestCase
         JDBCDataSource.setBeanProperty(ds, "user", user);
         JDBCDataSource.setBeanProperty(ds, "password", password);
 
+        Connection con = null;
         try {
-            ds.getConnection();
+            con = ds.getConnection();
             vetEncryptionAttempt(user, null);
         } catch (SQLException e) {
             vetEncryptionAttempt(user, e);
@@ -454,6 +456,12 @@ public class DboPowersTest extends BaseJDBCTestCase
             return;
         }
 
+        try {
+            derby3038(con);
+        } catch (SQLException e) {
+            fail("derby3038 regression: " + e);
+        } 
+
         // we managed to encrypt: bring db down and up again to verify
         bringDbDown();
         bringDbUp(bootPassword);
@@ -753,4 +761,35 @@ public class DboPowersTest extends BaseJDBCTestCase
             break;
         }
     }
+
+
+    /**
+     * Make and call a stored procedure which opens a nested
+     * connection to expose DERBY-3038.
+     */
+    private void derby3038(Connection con) throws SQLException {
+
+        java.sql.Statement s = con.createStatement();
+
+        try {
+            s.executeUpdate
+                ("CREATE PROCEDURE DERBY3038PROC () " + 
+                 "LANGUAGE JAVA PARAMETER STYLE JAVA EXTERNAL NAME '" +
+                 DboPowersTest.class.getName() + ".derby3038Proc' " + 
+                 "READS SQL DATA");
+            s.executeUpdate("CALL DERBY3038PROC()");
+        } finally {
+            s.close();
+        }
+    }
+
+
+    public static void derby3038Proc() 
+        throws SQLException {
+
+        // Before fixing DERNY-3038 this connect would fail.
+        Connection con = java.sql.DriverManager.
+            getConnection("jdbc:default:connection");
+        con.close();
+    }
 }
