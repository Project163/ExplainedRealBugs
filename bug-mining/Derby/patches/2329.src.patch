diff --git a/java/engine/org/apache/derby/impl/db/DatabaseContextImpl.java b/java/engine/org/apache/derby/impl/db/DatabaseContextImpl.java
index bf894fbe6..acfbd87b0 100644
--- a/java/engine/org/apache/derby/impl/db/DatabaseContextImpl.java
+++ b/java/engine/org/apache/derby/impl/db/DatabaseContextImpl.java
@@ -24,6 +24,7 @@ package org.apache.derby.impl.db;
 import org.apache.derby.iapi.services.context.ContextImpl;
 import org.apache.derby.iapi.services.context.ContextManager;
 import org.apache.derby.iapi.services.context.ContextService;
+import org.apache.derby.iapi.sql.dictionary.DataDictionary;
 import org.apache.derby.iapi.services.monitor.Monitor;
 import org.apache.derby.iapi.db.Database;
 import org.apache.derby.iapi.db.DatabaseContext;
@@ -55,6 +56,20 @@ final class DatabaseContextImpl extends ContextImpl implements DatabaseContext
 
         popMe();
         
+        if (se.getSeverity() >= ExceptionSeverity.DATABASE_SEVERITY) {
+            // DERBY-5108: Shut down the istat daemon thread before shutting
+            // down the various modules belonging to the database. An active
+            // istat daemon thread at the time of shutdown may result in
+            // containers being reopened after the container cache has been
+            // shut down. On certain platforms, this results in database
+            // files that can't be deleted until the VM exits.
+            DataDictionary dd = db.getDataDictionary();
+            // dd is null if the db is an active slave db (replication)
+            if (dd != null) {
+                dd.disableIndexStatsRefresher();
+            }
+        }
+
         if (se.getSeverity() == ExceptionSeverity.DATABASE_SEVERITY) {
 		    ContextService.getFactory().notifyAllActiveThreads(this);
             // This may be called multiple times, but is short-circuited
diff --git a/java/engine/org/apache/derby/impl/sql/catalog/DataDictionaryImpl.java b/java/engine/org/apache/derby/impl/sql/catalog/DataDictionaryImpl.java
index 1371c2624..b5bebda5c 100644
--- a/java/engine/org/apache/derby/impl/sql/catalog/DataDictionaryImpl.java
+++ b/java/engine/org/apache/derby/impl/sql/catalog/DataDictionaryImpl.java
@@ -13768,12 +13768,13 @@ public final class	DataDictionaryImpl
 
     /** {@inheritDoc} */
     public void disableIndexStatsRefresher() {
-        indexStatsUpdateDisabled = true;
-        // NOTE: This will stop the automatic updates of index statistics,
-        //       but users can still do this explicitly (i.e. by invoking
-        //       the SYSCS_UTIL.SYSCS_UPDATE_STATISTICS system procedure).
-        // Set at boot time, we expect it to be non-null.
-        indexRefresher.stop();
+        if (!indexStatsUpdateDisabled) {
+            indexStatsUpdateDisabled = true;
+            // NOTE: This will stop the automatic updates of index statistics,
+            //       but users can still do this explicitly (i.e. by invoking
+            //       the SYSCS_UTIL.SYSCS_UPDATE_STATISTICS system procedure).
+            indexRefresher.stop();
+        }
     }
 
     /** {@inheritDoc} */
