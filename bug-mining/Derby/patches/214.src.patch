diff --git a/java/drda/org/apache/derby/impl/drda/DDMReader.java b/java/drda/org/apache/derby/impl/drda/DDMReader.java
index ca413cf17..75c704549 100644
--- a/java/drda/org/apache/derby/impl/drda/DDMReader.java
+++ b/java/drda/org/apache/derby/impl/drda/DDMReader.java
@@ -1372,6 +1372,11 @@ class DDMReader
 	 */
 	protected void skipDss() throws DRDAProtocolException
 	{
+		while (dssIsContinued)
+		{
+			skipBytes((int)dssLength);
+			readDSSContinuationHeader();
+		}
 		skipBytes((int)dssLength);
 		topDdmCollectionStack = EMPTY_STACK;
 		ddmScalarLen = 0;
@@ -1482,6 +1487,7 @@ class DDMReader
 	private void ensureBLayerDataInBuffer (int desiredDataSize, boolean adjustLen) 
 		throws DRDAProtocolException
 	{
+		ensureALayerDataInBuffer (desiredDataSize);
 		if (dssIsContinued) 
 		{
 			if (desiredDataSize > dssLength) 
@@ -1491,10 +1497,6 @@ class DDMReader
 				compressBLayerData (continueDssHeaderCount);
 			}
 		}
-		else 
-		{
-			ensureALayerDataInBuffer (desiredDataSize);
-		}
 		if (adjustLen)
 			adjustLengths(desiredDataSize);
 	}
@@ -1734,8 +1736,11 @@ class DDMReader
 				                               "fill",
 				                               5);
 			}
-			count += actualBytesRead;
-			totalBytesRead += actualBytesRead;
+			if (actualBytesRead != -1)
+			{
+				count += actualBytesRead;
+				totalBytesRead += actualBytesRead;
+			}
 
 		}
 		while ((totalBytesRead < minimumBytesNeeded) && (actualBytesRead != -1));
diff --git a/java/testing/org/apache/derbyTesting/functionTests/master/DerbyNet/jdk15/prepStmt.out b/java/testing/org/apache/derbyTesting/functionTests/master/DerbyNet/jdk15/prepStmt.out
index 90cd471f7..088b5bc5d 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/master/DerbyNet/jdk15/prepStmt.out
+++ b/java/testing/org/apache/derbyTesting/functionTests/master/DerbyNet/jdk15/prepStmt.out
@@ -76,4 +76,5 @@ setObject Method sets the designated parameter with the Object
 Negative test setString with Invalid Timestamp:20
 SQLState: 22007 message: The syntax of the string representation of a datetime value is incorrect.
 Test jira614 completed successfully -- no Distributed Protocol Exception occurred
+Jira170: caught expected table not found
 prepStmt Test Ends
diff --git a/java/testing/org/apache/derbyTesting/functionTests/master/DerbyNetClient/jdk15/prepStmt.out b/java/testing/org/apache/derbyTesting/functionTests/master/DerbyNetClient/jdk15/prepStmt.out
index 90cd471f7..088b5bc5d 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/master/DerbyNetClient/jdk15/prepStmt.out
+++ b/java/testing/org/apache/derbyTesting/functionTests/master/DerbyNetClient/jdk15/prepStmt.out
@@ -76,4 +76,5 @@ setObject Method sets the designated parameter with the Object
 Negative test setString with Invalid Timestamp:20
 SQLState: 22007 message: The syntax of the string representation of a datetime value is incorrect.
 Test jira614 completed successfully -- no Distributed Protocol Exception occurred
+Jira170: caught expected table not found
 prepStmt Test Ends
diff --git a/java/testing/org/apache/derbyTesting/functionTests/master/prepStmt.out b/java/testing/org/apache/derbyTesting/functionTests/master/prepStmt.out
index 2707ba796..d46f85f20 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/master/prepStmt.out
+++ b/java/testing/org/apache/derbyTesting/functionTests/master/prepStmt.out
@@ -76,4 +76,5 @@ setObject Method sets the designated parameter with the Object
 Negative test setString with Invalid Timestamp:20
 SQLState: 22007 message: The syntax of the string representation of a datetime value is incorrect.
 Test jira614 completed successfully -- no Distributed Protocol Exception occurred
+Jira170: caught expected table not found
 prepStmt Test Ends
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/prepStmt.java b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/prepStmt.java
index 7faeddf80..400bc260b 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/prepStmt.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/prepStmt.java
@@ -309,6 +309,7 @@ public class prepStmt
 			test5130(conn);
 			test5172(conn);
 			jira614Test(conn);
+			jira170Test(conn);
 			conn.close();
 			// refresh conn before cleaning up
 			conn = ij.startJBMS();
@@ -744,5 +745,47 @@ public class prepStmt
 		    buf.append(c);
 	    return buf.toString();
     }
+    // Jira-170 has to do with how the server handles re-synchronization of
+    // the data stream when an enormous parameter value follows a failed
+    // prepare statement. Note that it is deliberate here that we are preparing
+    // a statement referring to a non-existing table.
+    private static void jira170Test(Connection conn)
+        throws Exception
+    {
+        Statement stmt = conn.createStatement();
+        PreparedStatement ps = null ;
+	    try {
+		    stmt.execute("drop table jira170");
+	    } catch (Throwable t) { }
+        // Create a huge array of chars to be used as the input parameter
+        char []cData = new char[1000000];
+        for (int i = 0; i < cData.length; i++)
+            cData[i] = Character.forDigit(i%10, 10);
+        // The behavior of this test program depends on how the JDBC driver
+        // handles statement prepares. The DB2 Universal JDBC driver implements
+        // something called "deferred prepares" by default. This means that it
+        // doesn't do the prepare of the statement until the statement is
+        // actually executed. Other drivers, such as the standard Derby client
+        // driver, do the prepare at the time of the prepare. This means that,
+        // depending on which driver we're using and what the driver's
+        // configuration is, we'll get the "table not found" error either on
+        // the prepare or on the execute. It doesn't really matter for the
+        // purposes of the test, because the whole point is that we *dont*
+        // get a DRDA Protocol Exception, but rather a table-not-found
+        // exception.
+        try {
+            ps = conn.prepareStatement("insert into jira170 values (?)");
+            ps.setString(1, new String(cData));
+            ps.execute();
+            System.out.println("Test Jira170 failed: no exception when trying to execute a failed prepare with an enormous parameter");
+        }
+        catch (SQLException e)
+        {
+            if (e.getSQLState().equals("42X05"))
+                System.out.println("Jira170: caught expected table not found");
+            else
+                e.printStackTrace();
+        }
+    }
 }
 
