diff --git a/java/drda/org/apache/derby/drda/server.policy b/java/drda/org/apache/derby/drda/server.policy
index b47390ad1..2b7683dc9 100644
--- a/java/drda/org/apache/derby/drda/server.policy
+++ b/java/drda/org/apache/derby/drda/server.policy
@@ -22,6 +22,7 @@ grant codeBase "${derby.install.url}derby.jar"
   permission java.lang.RuntimePermission "createClassLoader";
   permission java.util.PropertyPermission "derby.*", "read";
   permission java.util.PropertyPermission "user.dir", "read";
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
 
   // The next two properties are used to determine if the VM is 32 or 64 bit.
   //
diff --git a/java/drda/org/apache/derby/drda/template.policy b/java/drda/org/apache/derby/drda/template.policy
index 9a42602d7..3b82e0120 100644
--- a/java/drda/org/apache/derby/drda/template.policy
+++ b/java/drda/org/apache/derby/drda/template.policy
@@ -24,6 +24,7 @@ grant codeBase "${derby.install.url}derby.jar"
   // These permissions are needed for everyday, embedded Derby usage.
   //
   permission java.lang.RuntimePermission "createClassLoader";
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
 
   // Next, the permission to read "derby.*" properties is granted to
   // derby.jar. This is necessary for the engine to read derby properties.
diff --git a/java/engine/org/apache/derby/catalog/Java5SystemProcedures.java b/java/engine/org/apache/derby/catalog/Java5SystemProcedures.java
index bc810badc..560e65544 100644
--- a/java/engine/org/apache/derby/catalog/Java5SystemProcedures.java
+++ b/java/engine/org/apache/derby/catalog/Java5SystemProcedures.java
@@ -21,12 +21,15 @@
 
 package org.apache.derby.catalog;
 
+import java.security.AccessController;
+import java.security.PrivilegedAction;
 import java.sql.SQLException;
 
 import org.apache.derby.iapi.sql.dictionary.OptionalTool;
 import org.apache.derby.iapi.error.PublicAPI;
 import org.apache.derby.iapi.error.StandardException;
 import org.apache.derby.iapi.reference.SQLState;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.services.loader.ClassFactory;
 import org.apache.derby.iapi.services.loader.ClassFactoryContext;
@@ -93,7 +96,7 @@ public  class   Java5SystemProcedures
         throws SQLException
     {
         try {
-			ClassFactoryContext cfc = (ClassFactoryContext) ContextService.getContext( ClassFactoryContext.CONTEXT_ID );
+			ClassFactoryContext cfc = (ClassFactoryContext) getContext( ClassFactoryContext.CONTEXT_ID );
             ClassFactory    classFactory = cfc.getClassFactory();
 
             String              toolClassName = findToolClassName( toolName, optionalArgs );            
@@ -183,5 +186,31 @@ public  class   Java5SystemProcedures
     ///////////////////////////////////////////////////////////////////////////////////
 
     private static  StandardException wrap( Throwable t )   { return StandardException.plainWrapException( t ); }
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContext( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContext( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContext( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
 
diff --git a/java/engine/org/apache/derby/diag/DiagUtil.java b/java/engine/org/apache/derby/diag/DiagUtil.java
index 0a30c6d65..aeb8051e4 100644
--- a/java/engine/org/apache/derby/diag/DiagUtil.java
+++ b/java/engine/org/apache/derby/diag/DiagUtil.java
@@ -21,8 +21,12 @@
 
 package org.apache.derby.diag;
 
+import java.security.AccessController;
+import java.security.PrivilegedAction;
+
 import org.apache.derby.iapi.error.StandardException;
 import org.apache.derby.iapi.reference.SQLState;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.sql.conn.LanguageConnectionContext;
 import org.apache.derby.iapi.sql.dictionary.DataDictionary;
@@ -41,7 +45,7 @@ abstract    class   DiagUtil
     static void    checkAccess()   throws StandardException
     {
         LanguageConnectionContext lcc = (LanguageConnectionContext)
-            ContextService.getContextOrNull(LanguageConnectionContext.CONTEXT_ID);
+            getContextOrNull(LanguageConnectionContext.CONTEXT_ID);
         DataDictionary  dd = lcc.getDataDictionary();
 
         if ( dd.usesSqlAuthorization() )
@@ -56,6 +60,32 @@ abstract    class   DiagUtil
         }
     }
 
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContextOrNull( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContextOrNull( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContextOrNull( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
 
 
diff --git a/java/engine/org/apache/derby/diag/StatementCache.java b/java/engine/org/apache/derby/diag/StatementCache.java
index acb2eaf7b..6b8f01010 100644
--- a/java/engine/org/apache/derby/diag/StatementCache.java
+++ b/java/engine/org/apache/derby/diag/StatementCache.java
@@ -21,6 +21,8 @@
 
 package org.apache.derby.diag;
 
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.sql.ResultSetMetaData;
 import java.sql.Timestamp;
 import java.sql.Types;
@@ -31,6 +33,7 @@ import java.util.Vector;
 import org.apache.derby.iapi.error.StandardException;
 import org.apache.derby.iapi.reference.Limits;
 import org.apache.derby.iapi.services.cache.CacheManager;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.sql.ResultColumnDescriptor;
 import org.apache.derby.iapi.sql.conn.LanguageConnectionContext;
@@ -78,7 +81,7 @@ public final class StatementCache extends VTITemplate {
         DiagUtil.checkAccess();
         
         LanguageConnectionContext lcc = (LanguageConnectionContext)
-            ContextService.getContextOrNull(LanguageConnectionContext.CONTEXT_ID);
+            getContextOrNull(LanguageConnectionContext.CONTEXT_ID);
 
         CacheManager statementCache =
             lcc.getLanguageConnectionFactory().getStatementCache();
@@ -181,4 +184,30 @@ public final class StatementCache extends VTITemplate {
 
 		return metadata;
 	}
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContextOrNull( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContextOrNull( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContextOrNull( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/iapi/security/SecurityUtil.java b/java/engine/org/apache/derby/iapi/security/SecurityUtil.java
index 34e381976..b4f9510c1 100644
--- a/java/engine/org/apache/derby/iapi/security/SecurityUtil.java
+++ b/java/engine/org/apache/derby/iapi/security/SecurityUtil.java
@@ -38,6 +38,7 @@ import javax.security.auth.Subject;
 import org.apache.derby.authentication.SystemPrincipal;
 import org.apache.derby.catalog.AliasInfo;
 import org.apache.derby.iapi.error.StandardException;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.sql.conn.Authorizer;
 import org.apache.derby.iapi.sql.conn.LanguageConnectionContext;
@@ -46,12 +47,19 @@ import org.apache.derby.iapi.sql.dictionary.DataDictionary;
 import org.apache.derby.iapi.sql.dictionary.StatementPermission;
 import org.apache.derby.iapi.sql.dictionary.StatementRoutinePermission;
 import org.apache.derby.iapi.util.IdUtil;
+import org.apache.derby.security.SystemPermission;
 
 /**
  * This class provides helper functions for security-related features.
  */
 public class SecurityUtil {
 
+    /**
+     * Permission to access Derby contexts (permissions are immutable).
+     */
+    private final static SystemPermission USE_DERBY_INTERNALS = new SystemPermission
+        ( SystemPermission.ENGINE, SystemPermission.USE_DERBY_INTERNALS );
+
     /**
      * Creates a (read-only) Subject representing a given user
      * as a System user within Derby.
@@ -181,7 +189,7 @@ public class SecurityUtil {
         throws StandardException
     {
         LanguageConnectionContext lcc = (LanguageConnectionContext)
-				ContextService.getContextOrNull( LanguageConnectionContext.CONTEXT_ID );
+				getContextOrNull( LanguageConnectionContext.CONTEXT_ID );
 
         if ( lcc.usesSqlAuthorization() )
         {
@@ -203,5 +211,41 @@ public class SecurityUtil {
         }
     }
 
+    /**
+     * Verify that we have been granted permission to use Derby internals
+     */
+    public  static  void    checkDerbyInternalsPrivilege()
+    {
+        if ( System.getSecurityManager() != null )
+        {
+            AccessController.checkPermission( USE_DERBY_INTERNALS );
+        }
+    }
+
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContextOrNull( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContextOrNull( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContextOrNull( contextID );
+                     }
+                 }
+                 );
+        }
+    }
 
 }
diff --git a/java/engine/org/apache/derby/iapi/services/context/ContextService.java b/java/engine/org/apache/derby/iapi/services/context/ContextService.java
index a63359f2a..c2ef476d9 100644
--- a/java/engine/org/apache/derby/iapi/services/context/ContextService.java
+++ b/java/engine/org/apache/derby/iapi/services/context/ContextService.java
@@ -27,6 +27,7 @@ import java.util.HashSet;
 import java.util.Stack;
 
 import org.apache.derby.iapi.error.ShutdownException;
+import org.apache.derby.iapi.security.SecurityUtil;
 import org.apache.derby.iapi.services.monitor.Monitor;
 import org.apache.derby.shared.common.sanity.SanityManager;
 import org.apache.derby.iapi.services.stream.HeaderPrintWriter;
@@ -189,7 +190,11 @@ public final class ContextService //OLD extends Hashtable
 	/**
 		So it can be given to us and taken away...
 	 */
-	public static void stop() {
+	public static void stop()
+    {
+        // Verify that we have permission to execute this method.
+        SecurityUtil.checkDerbyInternalsPrivilege();
+        
 		// For some unknown reason, the ContextManager and
 		// ContextService objects will not be garbage collected
 		// without the next two lines.
@@ -203,7 +208,11 @@ public final class ContextService //OLD extends Hashtable
         }
 	}
 
-	public static ContextService getFactory() {
+	public static ContextService getFactory()
+    {
+        // Verify that we have permission to execute this method.
+        SecurityUtil.checkDerbyInternalsPrivilege();
+        
 		ContextService csf = factory;
 
 		if (csf == null)
@@ -216,8 +225,11 @@ public final class ContextService //OLD extends Hashtable
 
 		@return The requested context, null if it doesn't exist.
 	*/
-	public static Context getContext(String contextId) {
-
+	public static Context getContext(String contextId)
+    {
+        // Verify that we have permission to execute this method.
+        SecurityUtil.checkDerbyInternalsPrivilege();
+        
 		ContextManager cm = getFactory().getCurrentContextManager();
 
         if( cm == null)
@@ -235,7 +247,11 @@ public final class ContextService //OLD extends Hashtable
 
 		@return The requested context, null if it doesn't exist.
 	*/
-	public static Context getContextOrNull(String contextId) {
+	public static Context getContextOrNull(String contextId)
+    {
+        // Verify that we have permission to execute this method.
+        SecurityUtil.checkDerbyInternalsPrivilege();
+        
 		ContextService csf = factory;
 
 		if (csf == null)
diff --git a/java/engine/org/apache/derby/iapi/services/io/FormatIdInputStream.java b/java/engine/org/apache/derby/iapi/services/io/FormatIdInputStream.java
index 7a265f8c6..4dae489ed 100644
--- a/java/engine/org/apache/derby/iapi/services/io/FormatIdInputStream.java
+++ b/java/engine/org/apache/derby/iapi/services/io/FormatIdInputStream.java
@@ -26,12 +26,15 @@ import java.io.IOException;
 import java.io.InputStream;
 import java.io.ObjectInputStream;
 import java.io.StreamCorruptedException;
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import org.apache.derby.iapi.services.monitor.Monitor;
 import org.apache.derby.iapi.error.StandardException;
 import org.apache.derby.iapi.services.loader.ClassFactory;
 import org.apache.derby.iapi.services.loader.ClassFactoryContext;
 import org.apache.derby.iapi.types.Resetable;
 
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 /**
   A stream for reading objects with format id tags which was
@@ -201,7 +204,7 @@ public final class FormatIdInputStream extends DataInputStream
 		if (cf == null) {
 
 			ClassFactoryContext cfc =
-				(ClassFactoryContext) ContextService.getContextOrNull
+				(ClassFactoryContext) getContextOrNull
 				                                  (ClassFactoryContext.CONTEXT_ID);
 
 			if (cfc != null)
@@ -255,4 +258,30 @@ public final class FormatIdInputStream extends DataInputStream
 
         return(new FormatIdInputStream(new_input_stream));
     }
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContextOrNull( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContextOrNull( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContextOrNull( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/iapi/sql/conn/ConnectionUtil.java b/java/engine/org/apache/derby/iapi/sql/conn/ConnectionUtil.java
index 7665feac8..343422ee8 100644
--- a/java/engine/org/apache/derby/iapi/sql/conn/ConnectionUtil.java
+++ b/java/engine/org/apache/derby/iapi/sql/conn/ConnectionUtil.java
@@ -21,12 +21,15 @@
 
 package org.apache.derby.iapi.sql.conn;
 
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.error.StandardException;
 import org.apache.derby.iapi.services.i18n.MessageService;
 import org.apache.derby.iapi.reference.SQLState;
 import org.apache.derby.iapi.error.ExceptionSeverity;
 
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.sql.SQLException;
 
 public class ConnectionUtil {
@@ -42,7 +45,7 @@ public class ConnectionUtil {
 		throws SQLException {
 
 			LanguageConnectionContext lcc = (LanguageConnectionContext)
-				ContextService.getContextOrNull(LanguageConnectionContext.CONTEXT_ID);
+				getContextOrNull(LanguageConnectionContext.CONTEXT_ID);
 
 			if (lcc == null)
 				throw new SQLException(
@@ -54,4 +57,30 @@ public class ConnectionUtil {
 
 			return lcc;
 	}
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContextOrNull( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContextOrNull( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContextOrNull( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/iapi/sql/dictionary/IndexRowGenerator.java b/java/engine/org/apache/derby/iapi/sql/dictionary/IndexRowGenerator.java
index a33491ea4..4dd425da2 100644
--- a/java/engine/org/apache/derby/iapi/sql/dictionary/IndexRowGenerator.java
+++ b/java/engine/org/apache/derby/iapi/sql/dictionary/IndexRowGenerator.java
@@ -24,10 +24,13 @@ package org.apache.derby.iapi.sql.dictionary;
 import java.io.IOException;
 import java.io.ObjectInput;
 import java.io.ObjectOutput;
+import java.security.AccessController;
+import java.security.PrivilegedAction;
 
 import org.apache.derby.catalog.IndexDescriptor;
 import org.apache.derby.catalog.types.IndexDescriptorImpl;
 import org.apache.derby.iapi.error.StandardException;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.services.io.Formatable;
 import org.apache.derby.iapi.services.io.FormatableBitSet;
@@ -394,7 +397,7 @@ public class IndexRowGenerator implements IndexDescriptor, Formatable
 			ExecutionContext	ec;
 
 			ec = (ExecutionContext)
-					ContextService.getContext(ExecutionContext.CONTEXT_ID);
+					getContext(ExecutionContext.CONTEXT_ID);
 			ef = ec.getExecutionFactory();
 		}
 		return ef;
@@ -432,4 +435,30 @@ public class IndexRowGenerator implements IndexDescriptor, Formatable
 		return StoredFormatIds.INDEX_ROW_GENERATOR_V01_ID;
 	}
 
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContext( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContext( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContext( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/iapi/sql/dictionary/SPSDescriptor.java b/java/engine/org/apache/derby/iapi/sql/dictionary/SPSDescriptor.java
index 017763c6c..d093e47e6 100644
--- a/java/engine/org/apache/derby/iapi/sql/dictionary/SPSDescriptor.java
+++ b/java/engine/org/apache/derby/iapi/sql/dictionary/SPSDescriptor.java
@@ -21,6 +21,10 @@
 
 package org.apache.derby.iapi.sql.dictionary;
 
+import java.security.PrivilegedAction;
+import java.security.AccessController;
+import java.security.AccessControlException;
+import java.security.AccessControlContext;
 import java.sql.Timestamp;
 import java.util.ArrayList;
 import java.util.List;
@@ -683,7 +687,7 @@ public class SPSDescriptor extends UniqueSQLObjectDescriptor
 			(!valid ||
 			 (preparedStatement == null)))
 		{
-			ContextManager cm = ContextService.getFactory().getCurrentContextManager();
+			ContextManager cm = getContextService().getCurrentContextManager();
 
 			/*
 			** Find the language connection context.  Get
@@ -1159,6 +1163,30 @@ public class SPSDescriptor extends UniqueSQLObjectDescriptor
 	// getDescriptorName! 
     @Override
 	public String getDescriptorName() { return name; }
-	
+
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
 }
 
diff --git a/java/engine/org/apache/derby/iapi/sql/dictionary/TableDescriptor.java b/java/engine/org/apache/derby/iapi/sql/dictionary/TableDescriptor.java
index 07e0c6cb3..3c78af567 100644
--- a/java/engine/org/apache/derby/iapi/sql/dictionary/TableDescriptor.java
+++ b/java/engine/org/apache/derby/iapi/sql/dictionary/TableDescriptor.java
@@ -21,6 +21,8 @@
 
 package org.apache.derby.iapi.sql.dictionary;
 
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.util.List;
 
 import org.apache.derby.catalog.Dependable;
@@ -32,6 +34,7 @@ import org.apache.derby.iapi.reference.SQLState;
 import org.apache.derby.iapi.services.io.FormatableBitSet;
 import org.apache.derby.iapi.services.io.StoredFormatIds;
 import org.apache.derby.shared.common.sanity.SanityManager;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.services.property.PropertyUtil;
 import org.apache.derby.iapi.sql.StatementType;
@@ -169,7 +172,7 @@ public class TableDescriptor extends UniqueSQLObjectDescriptor
 	private FormatableBitSet referencedColumnMapGet() {
 
         LanguageConnectionContext lcc =
-            (LanguageConnectionContext)ContextService.getContextOrNull(
+            (LanguageConnectionContext)getContextOrNull(
                 LanguageConnectionContext.CONTEXT_ID);
 
         if (SanityManager.DEBUG) {
@@ -184,7 +187,7 @@ public class TableDescriptor extends UniqueSQLObjectDescriptor
 		(FormatableBitSet newReferencedColumnMap) {
 
         LanguageConnectionContext lcc =
-            (LanguageConnectionContext)ContextService.getContextOrNull(
+            (LanguageConnectionContext)getContextOrNull(
                 LanguageConnectionContext.CONTEXT_ID);
 
         if (SanityManager.DEBUG) {
@@ -1527,5 +1530,31 @@ public class TableDescriptor extends UniqueSQLObjectDescriptor
         return tableID.toANSIidentifier();
     }
 
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContextOrNull( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContextOrNull( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContextOrNull( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
 
diff --git a/java/engine/org/apache/derby/iapi/sql/dictionary/TriggerDescriptor.java b/java/engine/org/apache/derby/iapi/sql/dictionary/TriggerDescriptor.java
index 4d4f51a0b..3a1e1be00 100644
--- a/java/engine/org/apache/derby/iapi/sql/dictionary/TriggerDescriptor.java
+++ b/java/engine/org/apache/derby/iapi/sql/dictionary/TriggerDescriptor.java
@@ -39,6 +39,7 @@ import org.apache.derby.iapi.services.io.StoredFormatIds;
 import org.apache.derby.iapi.sql.depend.DependencyManager;
 import org.apache.derby.iapi.sql.conn.LanguageConnectionContext;
 import org.apache.derby.iapi.store.access.TransactionController;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 
 import org.apache.derby.iapi.sql.compile.CompilerContext;
@@ -48,6 +49,8 @@ import org.apache.derby.iapi.sql.compile.Visitable;
 import java.io.ObjectOutput;
 import java.io.ObjectInput;
 import java.io.IOException;
+import java.security.AccessController;
+import java.security.PrivilegedAction;
 
 /**
  * A trigger.
@@ -956,7 +959,7 @@ public class TriggerDescriptor extends UniqueSQLObjectDescriptor
  		if (dd == null)
  		{
   			LanguageConnectionContext lcc = (LanguageConnectionContext)
-				ContextService.getContext(LanguageConnectionContext.CONTEXT_ID);
+				getContext(LanguageConnectionContext.CONTEXT_ID);
   			dd = lcc.getDataDictionary();
 			setDataDictionary(dd);
   		}
@@ -1040,5 +1043,31 @@ public class TriggerDescriptor extends UniqueSQLObjectDescriptor
 	/** @see TupleDescriptor#getDescriptorName */
 	public String getDescriptorName() { return name; }
 	
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContext( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContext( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContext( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
 
diff --git a/java/engine/org/apache/derby/iapi/store/access/DiskHashtable.java b/java/engine/org/apache/derby/iapi/store/access/DiskHashtable.java
index 2b4208b82..1c10ff45c 100644
--- a/java/engine/org/apache/derby/iapi/store/access/DiskHashtable.java
+++ b/java/engine/org/apache/derby/iapi/store/access/DiskHashtable.java
@@ -20,6 +20,8 @@
  */
 package org.apache.derby.iapi.store.access;
 
+import java.security.AccessController;
+import java.security.PrivilegedAction;
 import java.util.ArrayList;
 import java.util.Enumeration;
 import java.util.List;
@@ -32,6 +34,7 @@ import org.apache.derby.iapi.types.SQLInteger;
 import org.apache.derby.iapi.types.RowLocation;
 import org.apache.derby.iapi.types.StringDataValue;
 
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.services.io.FormatableBitSet;
 import org.apache.derby.shared.common.sanity.SanityManager;
@@ -93,7 +96,7 @@ public class DiskHashtable
         this.remove_duplicates          = remove_duplicates;
         this.keepAfterCommit            = keepAfterCommit;
         LanguageConnectionContext lcc   = (LanguageConnectionContext)
-            ContextService.getContextOrNull(
+            getContextOrNull(
                 LanguageConnectionContext.CONTEXT_ID);
 
         keepStatistics = (lcc != null) && lcc.getRunTimeStatisticsMode();
@@ -393,6 +396,32 @@ public class DiskHashtable
         return new ElementEnum();
     }
 
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContextOrNull( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContextOrNull( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContextOrNull( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
     private class ElementEnum implements Enumeration<Object>
     {
         private ScanController scan;
diff --git a/java/engine/org/apache/derby/iapi/types/ClobStreamHeaderGenerator.java b/java/engine/org/apache/derby/iapi/types/ClobStreamHeaderGenerator.java
index e897698d9..64fc617b8 100644
--- a/java/engine/org/apache/derby/iapi/types/ClobStreamHeaderGenerator.java
+++ b/java/engine/org/apache/derby/iapi/types/ClobStreamHeaderGenerator.java
@@ -20,10 +20,14 @@
 */
 package org.apache.derby.iapi.types;
 
+import java.security.AccessController;
+import java.security.PrivilegedAction;
+
 import java.io.IOException;
 import java.io.ObjectOutput;
 import org.apache.derby.iapi.db.DatabaseContext;
 import org.apache.derby.iapi.error.StandardException;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.sql.dictionary.DataDictionary;
 
@@ -255,7 +259,7 @@ public final class ClobStreamHeaderGenerator
      */
     private void determineHeaderFormat() {
         DatabaseContext dbCtx = (DatabaseContext)
-                ContextService.getContext(DatabaseContext.CONTEXT_ID);
+                getContext(DatabaseContext.CONTEXT_ID);
         if (dbCtx == null) {
             throw new IllegalStateException("No context, unable to determine " +
                     "which stream header format to generate");
@@ -279,4 +283,30 @@ public final class ClobStreamHeaderGenerator
             callbackDVD.setStreamHeaderFormat(isPreDerbyTenFive);
         }
     }
+
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContext( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContext( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContext( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/iapi/types/DataValueFactoryImpl.java b/java/engine/org/apache/derby/iapi/types/DataValueFactoryImpl.java
index db9af4bff..8b01728e7 100644
--- a/java/engine/org/apache/derby/iapi/types/DataValueFactoryImpl.java
+++ b/java/engine/org/apache/derby/iapi/types/DataValueFactoryImpl.java
@@ -34,6 +34,9 @@ import org.apache.derby.iapi.services.monitor.Monitor;
 import org.apache.derby.iapi.reference.Attribute;
 import org.apache.derby.iapi.reference.SQLState;
 
+import java.security.AccessController;
+import java.security.PrivilegedAction;
+
 import java.sql.Blob;
 import java.sql.Clob;
 import java.sql.Date;
@@ -47,6 +50,7 @@ import java.util.Properties;
 import java.util.Locale;
 
 import org.apache.derby.iapi.db.DatabaseContext;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 
 /**
@@ -1143,11 +1147,36 @@ public final class DataValueFactoryImpl implements DataValueFactory, ModuleContr
         {
                 if (localeFinder == null)
                 {
-                        DatabaseContext dc = (DatabaseContext) ContextService.getContext(DatabaseContext.CONTEXT_ID);
+                        DatabaseContext dc = (DatabaseContext) getContext(DatabaseContext.CONTEXT_ID);
                         if( dc != null)
                             localeFinder = dc.getDatabase();
                 }
 
                 return localeFinder;
         }
+    
+    /**
+     * Privileged lookup of a Context. Package protected so that user code
+     * can't call this entry point.
+     */
+    static  Context    getContext( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContext( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContext( contextID );
+                     }
+                 }
+                 );
+        }
+    }
 }
diff --git a/java/engine/org/apache/derby/iapi/types/NumberDataType.java b/java/engine/org/apache/derby/iapi/types/NumberDataType.java
index 34ffff5ee..a50aef99a 100644
--- a/java/engine/org/apache/derby/iapi/types/NumberDataType.java
+++ b/java/engine/org/apache/derby/iapi/types/NumberDataType.java
@@ -22,8 +22,11 @@
 package org.apache.derby.iapi.types;
 
 import java.math.BigDecimal;
+import java.security.AccessController;
+import java.security.PrivilegedAction;
 
 import org.apache.derby.iapi.error.StandardException;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.shared.common.sanity.SanityManager;
 import org.apache.derby.iapi.reference.SQLState;
@@ -568,7 +571,7 @@ public abstract class NumberDataType extends DataType
      */
      private static boolean useDB2Limits() throws StandardException {
          LanguageConnectionContext lcc =
-             (LanguageConnectionContext)ContextService.getContextOrNull(
+             (LanguageConnectionContext)getContextOrNull(
                  LanguageConnectionContext.CONTEXT_ID);
          if (lcc != null) {
              return !lcc.getDataDictionary().checkVersion(
@@ -581,5 +584,31 @@ public abstract class NumberDataType extends DataType
              return false;
          }
     }
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContextOrNull( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContextOrNull( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContextOrNull( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
 
diff --git a/java/engine/org/apache/derby/iapi/types/SQLBinary.java b/java/engine/org/apache/derby/iapi/types/SQLBinary.java
index 4f9bc8c1b..9d6717047 100644
--- a/java/engine/org/apache/derby/iapi/types/SQLBinary.java
+++ b/java/engine/org/apache/derby/iapi/types/SQLBinary.java
@@ -1294,7 +1294,7 @@ abstract class SQLBinary
                     getLength(), desiredWidth);
 
             StatementContext statementContext = (StatementContext)
-                ContextService.getContext(ContextId.LANG_STATEMENT);
+                DataValueFactoryImpl.getContext(ContextId.LANG_STATEMENT);
             statementContext.getActivation().
                     getResultSet().addWarning(warning);
         }
diff --git a/java/engine/org/apache/derby/iapi/types/SQLChar.java b/java/engine/org/apache/derby/iapi/types/SQLChar.java
index 049883aee..a5fc99519 100644
--- a/java/engine/org/apache/derby/iapi/types/SQLChar.java
+++ b/java/engine/org/apache/derby/iapi/types/SQLChar.java
@@ -1944,7 +1944,7 @@ readingLoop:
                 warning.initCause(se);
 
                 StatementContext statementContext = (StatementContext)
-                    ContextService.getContext(ContextId.LANG_STATEMENT);
+                    DataValueFactoryImpl.getContext(ContextId.LANG_STATEMENT);
                 statementContext.getActivation().
                         getResultSet().addWarning(warning);
             }
@@ -3096,7 +3096,7 @@ readingLoop:
         if (localeFinder == null)
         {
             DatabaseContext dc = (DatabaseContext) 
-                ContextService.getContext(DatabaseContext.CONTEXT_ID);
+                DataValueFactoryImpl.getContext(DatabaseContext.CONTEXT_ID);
             if( dc != null)
                 localeFinder = dc.getDatabase();
         }
diff --git a/java/engine/org/apache/derby/iapi/types/SQLDate.java b/java/engine/org/apache/derby/iapi/types/SQLDate.java
index 243fc31c4..d82451d83 100644
--- a/java/engine/org/apache/derby/iapi/types/SQLDate.java
+++ b/java/engine/org/apache/derby/iapi/types/SQLDate.java
@@ -554,7 +554,7 @@ public final class SQLDate extends DataType
 
 		if (theValue != null)
 		{
-            DatabaseContext databaseContext = (DatabaseContext) ContextService.getContext(DatabaseContext.CONTEXT_ID);
+            DatabaseContext databaseContext = (DatabaseContext) DataValueFactoryImpl.getContext(DatabaseContext.CONTEXT_ID);
             parseDate( theValue,
                        false,
                        (databaseContext == null) ? null : databaseContext.getDatabase(),
diff --git a/java/engine/org/apache/derby/iapi/types/SQLTime.java b/java/engine/org/apache/derby/iapi/types/SQLTime.java
index 4865ce582..d6e7a2a39 100644
--- a/java/engine/org/apache/derby/iapi/types/SQLTime.java
+++ b/java/engine/org/apache/derby/iapi/types/SQLTime.java
@@ -605,7 +605,7 @@ public final class SQLTime extends DataType
 		restoreToNull();
 		if (theValue != null)
         {
-            DatabaseContext databaseContext = (DatabaseContext) ContextService.getContext(DatabaseContext.CONTEXT_ID);
+            DatabaseContext databaseContext = (DatabaseContext) DataValueFactoryImpl.getContext(DatabaseContext.CONTEXT_ID);
             parseTime( theValue,
                        false,
                        (databaseContext == null) ? null : databaseContext.getDatabase(),
diff --git a/java/engine/org/apache/derby/iapi/types/SQLTimestamp.java b/java/engine/org/apache/derby/iapi/types/SQLTimestamp.java
index f5de899cc..a4902ae2b 100644
--- a/java/engine/org/apache/derby/iapi/types/SQLTimestamp.java
+++ b/java/engine/org/apache/derby/iapi/types/SQLTimestamp.java
@@ -655,7 +655,7 @@ public final class SQLTimestamp extends DataType
 
 		if (theValue != null)
 		{
-            DatabaseContext databaseContext = (DatabaseContext) ContextService.getContext(DatabaseContext.CONTEXT_ID);
+            DatabaseContext databaseContext = (DatabaseContext) DataValueFactoryImpl.getContext(DatabaseContext.CONTEXT_ID);
             parseTimestamp( theValue,
                             false,
                             (databaseContext == null) ? null : databaseContext.getDatabase(),
diff --git a/java/engine/org/apache/derby/iapi/util/InterruptStatus.java b/java/engine/org/apache/derby/iapi/util/InterruptStatus.java
index c94fb7707..f83d81ba2 100644
--- a/java/engine/org/apache/derby/iapi/util/InterruptStatus.java
+++ b/java/engine/org/apache/derby/iapi/util/InterruptStatus.java
@@ -21,10 +21,14 @@
 
 package org.apache.derby.iapi.util;
 
+import java.security.AccessController;
+import java.security.PrivilegedAction;
+
 import org.apache.derby.iapi.error.StandardException;
 import org.apache.derby.iapi.error.ShutdownException;
 import org.apache.derby.iapi.reference.SQLState;
 import org.apache.derby.shared.common.sanity.SanityManager;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.sql.conn.LanguageConnectionContext;
 
@@ -77,7 +81,7 @@ public class InterruptStatus {
     public static void setInterrupted() {
         LanguageConnectionContext lcc = null;
         try {
-            lcc = (LanguageConnectionContext)ContextService.getContextOrNull(
+            lcc = (LanguageConnectionContext)getContextOrNull(
                 LanguageConnectionContext.CONTEXT_ID);
 
         } catch (ShutdownException e) {
@@ -188,7 +192,7 @@ public class InterruptStatus {
         LanguageConnectionContext lcc = null;
         try {
             lcc =
-                (LanguageConnectionContext)ContextService.getContextOrNull(
+                (LanguageConnectionContext)getContextOrNull(
                     LanguageConnectionContext.CONTEXT_ID);
         } catch (ShutdownException e) {
             // Ignore. DERBY-4911 Restoring interrupt flag is moot anyway if we
@@ -235,7 +239,7 @@ public class InterruptStatus {
         if (SanityManager.DEBUG) {
             LanguageConnectionContext ctxLcc = null;
             try {
-                ctxLcc = (LanguageConnectionContext)ContextService.
+                ctxLcc = (LanguageConnectionContext)
                     getContextOrNull(LanguageConnectionContext.CONTEXT_ID);
 
                 SanityManager.ASSERT(
@@ -287,4 +291,30 @@ public class InterruptStatus {
         }
 
     }
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContextOrNull( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContextOrNull( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContextOrNull( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/impl/db/BasicDatabase.java b/java/engine/org/apache/derby/impl/db/BasicDatabase.java
index 5b0d9fbdb..1edad4274 100644
--- a/java/engine/org/apache/derby/impl/db/BasicDatabase.java
+++ b/java/engine/org/apache/derby/impl/db/BasicDatabase.java
@@ -74,6 +74,7 @@ import java.io.File;
 import java.io.IOException;
 import java.io.Serializable;
 import java.security.AccessController;
+import java.security.PrivilegedAction;
 import java.security.PrivilegedActionException;
 import java.security.PrivilegedExceptionAction;
 import java.sql.SQLException;
@@ -584,7 +585,7 @@ public class BasicDatabase implements ModuleControl, ModuleSupportable, Property
 	{
 		
 		TransactionController tc = af.getTransaction(
-				ContextService.getFactory().getCurrentContextManager());
+				getContextService().getCurrentContextManager());
 
 		String  upgradeID = null;
 		UUID	databaseID;
@@ -784,7 +785,7 @@ public class BasicDatabase implements ModuleControl, ModuleSupportable, Property
 		throws StandardException {
 
 		TransactionController tc = af.getTransaction(
-                    ContextService.getFactory().getCurrentContextManager());
+                    getContextService().getCurrentContextManager());
 		Properties dbProps = tc.getProperties();
 		tc.commit();
 		tc.destroy();
@@ -834,7 +835,7 @@ public class BasicDatabase implements ModuleControl, ModuleSupportable, Property
 
 		long generationId = fid.getGenerationId();
 
-        ContextManager cm = ContextService.getFactory().getCurrentContextManager();
+        ContextManager cm = getContextService().getCurrentContextManager();
 		FileResource fr = af.getTransaction(cm).getFileHandler();
 
         String externalName = JarUtil.mkExternalName(
@@ -941,4 +942,29 @@ public class BasicDatabase implements ModuleControl, ModuleSupportable, Property
         catch (PrivilegedActionException pae) { throw StandardException.plainWrapException( pae ); }
     }
 
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/impl/db/DatabaseContextImpl.java b/java/engine/org/apache/derby/impl/db/DatabaseContextImpl.java
index acfbd87b0..c512f1b48 100644
--- a/java/engine/org/apache/derby/impl/db/DatabaseContextImpl.java
+++ b/java/engine/org/apache/derby/impl/db/DatabaseContextImpl.java
@@ -31,6 +31,8 @@ import org.apache.derby.iapi.db.DatabaseContext;
 import org.apache.derby.iapi.error.StandardException;
 import org.apache.derby.iapi.error.ExceptionSeverity;
 
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 
 /**
 	A context that shutdowns down the database on a databsae exception.
@@ -71,7 +73,7 @@ final class DatabaseContextImpl extends ContextImpl implements DatabaseContext
         }
 
         if (se.getSeverity() == ExceptionSeverity.DATABASE_SEVERITY) {
-		    ContextService.getFactory().notifyAllActiveThreads(this);
+		    getContextService().notifyAllActiveThreads(this);
             // This may be called multiple times, but is short-circuited
             // in the monitor.
 		    Monitor.getMonitor().shutdown(db);
@@ -90,4 +92,30 @@ final class DatabaseContextImpl extends ContextImpl implements DatabaseContext
 	}
 
 	public Database getDatabase() {return db;}
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/impl/db/SlaveDatabase.java b/java/engine/org/apache/derby/impl/db/SlaveDatabase.java
index 798ecc135..d0e9d4d91 100644
--- a/java/engine/org/apache/derby/impl/db/SlaveDatabase.java
+++ b/java/engine/org/apache/derby/impl/db/SlaveDatabase.java
@@ -35,6 +35,9 @@ import org.apache.derby.iapi.sql.conn.LanguageConnectionContext;
 
 import org.apache.derby.jdbc.InternalDriver;
 
+import java.security.PrivilegedAction;
+import java.security.AccessController;
+
 import java.sql.SQLException;
 import java.util.Properties;
 import org.apache.derby.iapi.reference.MessageId;
@@ -222,7 +225,7 @@ public class SlaveDatabase extends BasicDatabase {
             throw StandardException.
                 newException(SQLState.REPLICATION_STOPSLAVE_NOT_INITIATED);
         }
-        pushDbContext(ContextService.getFactory().
+        pushDbContext(getContextService().
                       getCurrentContextManager());
     }
 
@@ -308,8 +311,8 @@ public class SlaveDatabase extends BasicDatabase {
             ContextManager bootThreadCm = null;
             try {
 
-                bootThreadCm = ContextService.getFactory().newContextManager();
-                ContextService.getFactory().
+                bootThreadCm = getContextService().newContextManager();
+                getContextService().
                     setCurrentContextManager(bootThreadCm);
 
                 bootBasicDatabase(create, params); // will be blocked
@@ -319,7 +322,7 @@ public class SlaveDatabase extends BasicDatabase {
                 inReplicationSlaveMode = false; 
 
                 if (bootThreadCm != null) {
-                    ContextService.getFactory().
+                    getContextService().
                         resetCurrentContextManager(bootThreadCm);
                     bootThreadCm = null;
                 }
@@ -446,4 +449,30 @@ public class SlaveDatabase extends BasicDatabase {
         // active
         super.boot(create, params);
     }
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/impl/jdbc/authentication/AuthenticationServiceBase.java b/java/engine/org/apache/derby/impl/jdbc/authentication/AuthenticationServiceBase.java
index a4fa24b44..46889b8a6 100644
--- a/java/engine/org/apache/derby/impl/jdbc/authentication/AuthenticationServiceBase.java
+++ b/java/engine/org/apache/derby/impl/jdbc/authentication/AuthenticationServiceBase.java
@@ -29,6 +29,7 @@ import org.apache.derby.iapi.reference.Limits;
 
 import org.apache.derby.iapi.error.StandardException;
 
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.services.daemon.Serviceable;
 
@@ -54,6 +55,8 @@ import org.apache.derby.iapi.sql.dictionary.UserDescriptor;
 
 import java.security.MessageDigest;
 import java.security.NoSuchAlgorithmException;
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 
 import java.io.Serializable;
 import java.io.UnsupportedEncodingException;
@@ -300,7 +303,7 @@ public abstract class AuthenticationServiceBase
         if ( store == null ) { return null; }
         else
         {
-            return store.getTransaction( ContextService.getFactory().getCurrentContextManager() );
+            return store.getTransaction( getContextService().getCurrentContextManager() );
         }
     }
 
@@ -344,7 +347,7 @@ public abstract class AuthenticationServiceBase
 
 		  if (store != null)
 			tc = store.getTransaction(
-                ContextService.getFactory().getCurrentContextManager());
+                getContextService().getCurrentContextManager());
 
 		  propertyValue =
 			PropertyUtil.getDatabaseProperty(tc, key);
@@ -667,7 +670,7 @@ public abstract class AuthenticationServiceBase
      */
     private static DataDictionary getDataDictionary() {
         LanguageConnectionContext lcc = (LanguageConnectionContext)
-            ContextService.getContext(LanguageConnectionContext.CONTEXT_ID);
+            getContext(LanguageConnectionContext.CONTEXT_ID);
         return lcc.getDataDictionary();
     }
 
@@ -817,4 +820,55 @@ public abstract class AuthenticationServiceBase
         return StringUtil.toHexString(passwordSubstitute, 0,
                                       passwordSubstitute.length);
     }
+
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContext( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContext( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContext( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/impl/services/daemon/IndexStatisticsDaemonImpl.java b/java/engine/org/apache/derby/impl/services/daemon/IndexStatisticsDaemonImpl.java
index d8c204965..ff321621f 100644
--- a/java/engine/org/apache/derby/impl/services/daemon/IndexStatisticsDaemonImpl.java
+++ b/java/engine/org/apache/derby/impl/services/daemon/IndexStatisticsDaemonImpl.java
@@ -21,6 +21,8 @@
 package org.apache.derby.impl.services.daemon;
 
 import java.io.PrintWriter;
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.sql.Connection;
 import java.util.ArrayList;
 import java.util.List;
@@ -227,7 +229,7 @@ public class IndexStatisticsDaemonImpl
         this.db = db;
         this.dbOwner = userName;
         this.databaseName = databaseName;
-        this.ctxMgr = ContextService.getFactory().newContextManager();
+        this.ctxMgr = getContextService().newContextManager();
         this.timeOfCreation = System.currentTimeMillis();
         trace(0, "created{log=" + doLog + ", traceLog=" +
                 traceToDerbyLog + ", traceOut=" + traceToStdOut +
@@ -843,7 +845,7 @@ public class IndexStatisticsDaemonImpl
         // Implement the outer-level exception handling here.
         try {
             // DERBY-5088: Factory-call may fail.
-            ctxService = ContextService.getFactory();
+            ctxService = getContextService();
             ctxService.setCurrentContextManager(ctxMgr);
             processingLoop();
         } catch (ShutdownException se) {
@@ -1334,6 +1336,31 @@ public class IndexStatisticsDaemonImpl
                 "> " + trace;
     }
 
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }    
+
     /**
      * Support class used to compare keys when scanning indexes.
      */
diff --git a/java/engine/org/apache/derby/impl/services/daemon/SingleThreadDaemonFactory.java b/java/engine/org/apache/derby/impl/services/daemon/SingleThreadDaemonFactory.java
index 1a43e3e7c..39ad56e49 100644
--- a/java/engine/org/apache/derby/impl/services/daemon/SingleThreadDaemonFactory.java
+++ b/java/engine/org/apache/derby/impl/services/daemon/SingleThreadDaemonFactory.java
@@ -37,7 +37,7 @@ public class SingleThreadDaemonFactory implements DaemonFactory
 	
 	public SingleThreadDaemonFactory()
 	{
-		contextService = ContextService.getFactory();
+		contextService = getContextService();
 	}
 
 	/*
@@ -71,5 +71,30 @@ public class SingleThreadDaemonFactory implements DaemonFactory
 		daemonThread.start();
 		return daemon;
 	}
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
 }
 
diff --git a/java/engine/org/apache/derby/impl/services/locks/Deadlock.java b/java/engine/org/apache/derby/impl/services/locks/Deadlock.java
index e9da7ccb7..e514e67f1 100644
--- a/java/engine/org/apache/derby/impl/services/locks/Deadlock.java
+++ b/java/engine/org/apache/derby/impl/services/locks/Deadlock.java
@@ -27,10 +27,13 @@ import org.apache.derby.iapi.error.StandardException;
 import org.apache.derby.iapi.reference.SQLState;
 
 import org.apache.derby.iapi.sql.conn.LanguageConnectionContext;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.store.access.TransactionController;
 import org.apache.derby.iapi.store.access.TransactionInfo;
 
+import java.security.AccessController;
+import java.security.PrivilegedAction;
 import java.util.Hashtable;
 import java.util.Dictionary;
 import java.util.Stack;
@@ -444,7 +447,7 @@ inner:		for (;;) {
 
 
 		LanguageConnectionContext lcc = (LanguageConnectionContext)
-			ContextService.getContext(LanguageConnectionContext.CONTEXT_ID);
+			getContext(LanguageConnectionContext.CONTEXT_ID);
 
 		TableNameInfo tabInfo = null;
 		TransactionInfo[] tt = null;
@@ -563,4 +566,29 @@ inner:		for (;;) {
 		sb.append(data);
 	}
 
+    /**
+     * Privileged lookup of a Context. Must be package protected so that user code
+     * can't call this entry point.
+     */
+    static  Context    getContext( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContext( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContext( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 } 
diff --git a/java/engine/org/apache/derby/impl/services/locks/Timeout.java b/java/engine/org/apache/derby/impl/services/locks/Timeout.java
index e9f7d7bc6..6c82b18ee 100644
--- a/java/engine/org/apache/derby/impl/services/locks/Timeout.java
+++ b/java/engine/org/apache/derby/impl/services/locks/Timeout.java
@@ -160,7 +160,7 @@ public final class Timeout
 
         // need language here to print out tablenames
         LanguageConnectionContext lcc = (LanguageConnectionContext)
-            ContextService.getContext(LanguageConnectionContext.CONTEXT_ID);
+            Deadlock.getContext(LanguageConnectionContext.CONTEXT_ID);
         if( lcc != null )
             tc = lcc.getTransactionExecute();
 
diff --git a/java/engine/org/apache/derby/impl/services/monitor/BaseMonitor.java b/java/engine/org/apache/derby/impl/services/monitor/BaseMonitor.java
index 02b1829e3..6cf279953 100644
--- a/java/engine/org/apache/derby/impl/services/monitor/BaseMonitor.java
+++ b/java/engine/org/apache/derby/impl/services/monitor/BaseMonitor.java
@@ -31,6 +31,8 @@ import java.io.PrintWriter;
 import java.lang.reflect.InvocationTargetException;
 import java.lang.reflect.Method;
 import java.net.URL;
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.security.AccessControlException;
 import java.util.ArrayList;
 import java.util.Collections;
@@ -198,7 +200,7 @@ abstract class BaseMonitor
 		Monitor.getStream().println(LINE);
 		(services.get(0)).shutdown();
 
-		ContextService.stop();
+		stopContextService();
 		Monitor.clearMonitor();
 	}
 
@@ -2053,7 +2055,7 @@ nextModule:
 	public ResourceBundle getBundle(String messageId) {
 		ContextManager cm;
 		try {
-			cm = ContextService.getFactory().getCurrentContextManager();
+			cm = getContextService().getCurrentContextManager();
 		} catch (ShutdownException se) {
 			cm = null;
 		}
@@ -2080,6 +2082,57 @@ nextModule:
         return thread.getThreadGroup() == daemonGroup;
     }
 
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }    
+
+    /**
+     * Privileged shutdown of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  void    stopContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            ContextService.stop();
+        }
+        else
+        {
+            AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Object>()
+                 {
+                     public Object run()
+                     {
+                         ContextService.stop();
+                         return null;
+                     }
+                 }
+                 );
+        }
+    }    
+
 	/**
 		Initialize the monitor wrt the current environemnt.
 		Returns false if the monitor cannot be initialized, true otherwise.
diff --git a/java/engine/org/apache/derby/impl/services/reflect/UpdateLoader.java b/java/engine/org/apache/derby/impl/services/reflect/UpdateLoader.java
index 0cf81c9bb..87eed30dd 100644
--- a/java/engine/org/apache/derby/impl/services/reflect/UpdateLoader.java
+++ b/java/engine/org/apache/derby/impl/services/reflect/UpdateLoader.java
@@ -21,6 +21,7 @@
 
 package org.apache.derby.impl.services.reflect;
 
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.services.monitor.Monitor;
 import org.apache.derby.iapi.services.stream.HeaderPrintWriter;
@@ -40,6 +41,7 @@ import org.apache.derby.iapi.reference.Property;
 
 import java.io.InputStream;
 import java.security.AccessController;
+import java.security.PrivilegedAction;
 
 import org.apache.derby.iapi.reference.MessageId;
 import org.apache.derby.iapi.reference.Module;
@@ -307,7 +309,7 @@ final class UpdateLoader implements LockOwner {
 		if (lf == null)
 			return false;
 
-		ClassFactoryContext cfc = (ClassFactoryContext) ContextService.getContextOrNull(ClassFactoryContext.CONTEXT_ID);
+		ClassFactoryContext cfc = (ClassFactoryContext) getContextOrNull(ClassFactoryContext.CONTEXT_ID);
 
 		// This method can be called from outside of the database
 		// engine, in which case tc will be null. In that case
@@ -379,7 +381,7 @@ final class UpdateLoader implements LockOwner {
 	private String getClasspath()
 		throws StandardException {
 
-		ClassFactoryContext cfc = (ClassFactoryContext) ContextService.getContextOrNull(ClassFactoryContext.CONTEXT_ID);
+		ClassFactoryContext cfc = (ClassFactoryContext) getContextOrNull(ClassFactoryContext.CONTEXT_ID);
 
 		PersistentSet ps = cfc.getPersistentSet();
 		
@@ -398,7 +400,7 @@ final class UpdateLoader implements LockOwner {
 	JarReader getJarReader() {
 		if (jarReader == null) {
 
-			ClassFactoryContext cfc = (ClassFactoryContext) ContextService.getContextOrNull(ClassFactoryContext.CONTEXT_ID);
+			ClassFactoryContext cfc = (ClassFactoryContext) getContextOrNull(ClassFactoryContext.CONTEXT_ID);
 
 			jarReader = cfc.getJarReader(); 
 		}
@@ -425,6 +427,31 @@ final class UpdateLoader implements LockOwner {
         return false;
     }
     
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContextOrNull( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContextOrNull( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContextOrNull( contextID );
+                     }
+                 }
+                 );
+        }
+    }
 }
 
 
diff --git a/java/engine/org/apache/derby/impl/sql/GenericPreparedStatement.java b/java/engine/org/apache/derby/impl/sql/GenericPreparedStatement.java
index 591abef97..69a6c2f3b 100644
--- a/java/engine/org/apache/derby/impl/sql/GenericPreparedStatement.java
+++ b/java/engine/org/apache/derby/impl/sql/GenericPreparedStatement.java
@@ -21,6 +21,8 @@
 
 package org.apache.derby.impl.sql;
 
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.sql.SQLWarning;
 import java.sql.Timestamp;
 import java.util.ArrayList;
@@ -1237,7 +1239,7 @@ recompileOutOfDatePlan:
 			if (!isValid || (inUseCount != 0))
 				return;
 
-			ContextManager cm = ContextService.getFactory().getCurrentContextManager();
+			ContextManager cm = getContextService().getCurrentContextManager();
 			LanguageConnectionContext lcc = 
 				(LanguageConnectionContext) 
 				(cm.getContext(LanguageConnectionContext.CONTEXT_ID));
@@ -1392,4 +1394,30 @@ recompileOutOfDatePlan:
     public long getInitialRowCount(int rsNum, long currentRowCount) {
         return rowCountStats.getInitialRowCount(rsNum, currentRowCount);
     }
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/impl/sql/GenericStorablePreparedStatement.java b/java/engine/org/apache/derby/impl/sql/GenericStorablePreparedStatement.java
index bd7f3b9e9..8c4b8d168 100644
--- a/java/engine/org/apache/derby/impl/sql/GenericStorablePreparedStatement.java
+++ b/java/engine/org/apache/derby/impl/sql/GenericStorablePreparedStatement.java
@@ -49,6 +49,7 @@ import org.apache.derby.iapi.reference.SQLState;
 
 import org.apache.derby.iapi.services.loader.GeneratedClass;
 import org.apache.derby.iapi.services.loader.ClassFactory;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 
 import org.apache.derby.iapi.services.io.StoredFormatIds;
@@ -58,6 +59,8 @@ import org.apache.derby.iapi.services.io.Formatable;
 
 import org.apache.derby.iapi.services.monitor.Monitor;
 
+import java.security.AccessController;
+import java.security.PrivilegedAction;
 import java.sql.Timestamp;
 import java.io.ObjectOutput;
 import java.io.ObjectInput;
@@ -152,7 +155,7 @@ public class GenericStorablePreparedStatement
 		throws StandardException
 	{
 		LanguageConnectionContext lcc =
-			(LanguageConnectionContext) ContextService.getContext
+			(LanguageConnectionContext) getContext
 				                                  (LanguageConnectionContext.CONTEXT_ID);
 		ClassFactory classFactory = lcc.getLanguageConnectionFactory().getClassFactory();
 
@@ -278,4 +281,29 @@ public class GenericStorablePreparedStatement
 			return "";
 		}
 	} 
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContext( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContext( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContext( contextID );
+                     }
+                 }
+                 );
+        }
+    }
 }
diff --git a/java/engine/org/apache/derby/impl/sql/LanguageDbPropertySetter.java b/java/engine/org/apache/derby/impl/sql/LanguageDbPropertySetter.java
index e640efba0..9829ed949 100644
--- a/java/engine/org/apache/derby/impl/sql/LanguageDbPropertySetter.java
+++ b/java/engine/org/apache/derby/impl/sql/LanguageDbPropertySetter.java
@@ -27,11 +27,14 @@ import org.apache.derby.iapi.reference.Property;
 import org.apache.derby.iapi.reference.SQLState;
 import org.apache.derby.iapi.services.daemon.Serviceable;
 import org.apache.derby.shared.common.sanity.SanityManager;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.error.StandardException;
 import org.apache.derby.iapi.sql.conn.LanguageConnectionContext;
 import org.apache.derby.iapi.sql.dictionary.DataDictionary;
 import org.apache.derby.iapi.store.access.TransactionController;
+import java.security.AccessController;
+import java.security.PrivilegedAction;
 import java.io.Serializable;
 import java.util.Dictionary;
 
@@ -63,7 +66,7 @@ public class LanguageDbPropertySetter implements PropertySetCallback
 		if (key.trim().equals(Property.SQL_AUTHORIZATION_PROPERTY))
 		{
 			LanguageConnectionContext lcc = (LanguageConnectionContext)
-					ContextService.getContext(LanguageConnectionContext.CONTEXT_ID);
+					getContext(LanguageConnectionContext.CONTEXT_ID);
 
 			if (lcc.usesSqlAuthorization() && !Boolean.valueOf((String)value).booleanValue())
 				throw StandardException.newException(SQLState.PROPERTY_UNSUPPORTED_CHANGE,
@@ -103,4 +106,29 @@ public class LanguageDbPropertySetter implements PropertySetCallback
 	{
 		return null;
 	}
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContext( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContext( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContext( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/impl/sql/catalog/DataDictionaryImpl.java b/java/engine/org/apache/derby/impl/sql/catalog/DataDictionaryImpl.java
index 6d78da20e..81b11fad4 100644
--- a/java/engine/org/apache/derby/impl/sql/catalog/DataDictionaryImpl.java
+++ b/java/engine/org/apache/derby/impl/sql/catalog/DataDictionaryImpl.java
@@ -24,6 +24,8 @@ package org.apache.derby.impl.sql.catalog;
 import java.io.File;
 import java.io.IOException;
 import java.io.InputStream;
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.security.MessageDigest;
 import java.security.NoSuchAlgorithmException;
 import java.security.SecureRandom;
@@ -63,6 +65,7 @@ import org.apache.derby.iapi.services.cache.CacheManager;
 import org.apache.derby.iapi.services.cache.Cacheable;
 import org.apache.derby.iapi.services.cache.CacheableFactory;
 import org.apache.derby.iapi.services.context.ContextManager;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.services.daemon.IndexStatisticsDaemon;
 import org.apache.derby.iapi.services.io.FormatableBitSet;
@@ -701,7 +704,7 @@ public final class	DataDictionaryImpl
 		 * We assume the System boot process has created a context
 		 * manager already, but not that contexts we need are there.
 		 */
-		ContextService csf = ContextService.getFactory();
+		ContextService csf = getContextService();
 
 		ContextManager cm = csf.getCurrentContextManager();
 		if (SanityManager.DEBUG)
@@ -4501,7 +4504,7 @@ public final class	DataDictionaryImpl
 	public void invalidateAllSPSPlans() throws StandardException
 	{
 		LanguageConnectionContext lcc = (LanguageConnectionContext) 
-			ContextService.getContext(LanguageConnectionContext.CONTEXT_ID);
+			getContext(LanguageConnectionContext.CONTEXT_ID);
 		invalidateAllSPSPlans(lcc);
 	}
 
@@ -9523,7 +9526,7 @@ public final class	DataDictionaryImpl
             // print the lock table
             // will get a NullPointerException if lcc doesn't yet exist e.g. at boot time
             LanguageConnectionContext lcc = (LanguageConnectionContext)
-                ContextService.getContext(LanguageConnectionContext.CONTEXT_ID);
+                getContext(LanguageConnectionContext.CONTEXT_ID);
             if (lcc != null)
             {
                 long currentTime = System.currentTimeMillis();
@@ -10508,7 +10511,7 @@ public final class	DataDictionaryImpl
 
 	private static LanguageConnectionContext getLCC() {
 		return (LanguageConnectionContext) 
-					ContextService.getContextOrNull(LanguageConnectionContext.CONTEXT_ID);
+					getContextOrNull(LanguageConnectionContext.CONTEXT_ID);
 	}
 
     private SchemaDescriptor newSystemSchemaDesc(
@@ -14518,4 +14521,79 @@ public final class	DataDictionaryImpl
              );
     }
 
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContextOrNull( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContextOrNull( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContextOrNull( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContext( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContext( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContext( contextID );
+                     }
+                 }
+                 );
+        }
+    }
 }
diff --git a/java/engine/org/apache/derby/impl/sql/catalog/SequenceUpdater.java b/java/engine/org/apache/derby/impl/sql/catalog/SequenceUpdater.java
index d349b6c4a..edf88ecc0 100644
--- a/java/engine/org/apache/derby/impl/sql/catalog/SequenceUpdater.java
+++ b/java/engine/org/apache/derby/impl/sql/catalog/SequenceUpdater.java
@@ -20,6 +20,8 @@
  */
 package org.apache.derby.impl.sql.catalog;
 
+import java.security.AccessController;
+import java.security.PrivilegedAction;
 import java.util.HashMap;
 
 import org.apache.derby.catalog.SequencePreallocator;
@@ -30,6 +32,7 @@ import org.apache.derby.iapi.reference.SQLState;
 import org.apache.derby.iapi.services.cache.Cacheable;
 import org.apache.derby.iapi.services.cache.CacheManager;
 import org.apache.derby.iapi.services.context.ContextManager;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.services.i18n.MessageService;
 import org.apache.derby.iapi.services.monitor.Monitor;
@@ -469,7 +472,7 @@ public abstract class SequenceUpdater implements Cacheable
 				SanityManager.ASSERT( oldValue == null, "We should be flushing unused sequence values here." );
 			}
             
-            ContextService csf = ContextService.getFactory();
+            ContextService csf = getContextService();
             ContextManager cm = csf.getCurrentContextManager();
             AccessFactory af = _dd.af;
             TransactionController   dummyTransaction = af.getTransaction( cm );
@@ -592,7 +595,7 @@ public abstract class SequenceUpdater implements Cacheable
 	private static LanguageConnectionContext getLCC()
     {
 		return (LanguageConnectionContext) 
-					ContextService.getContextOrNull(LanguageConnectionContext.CONTEXT_ID);
+					getContextOrNull(LanguageConnectionContext.CONTEXT_ID);
 	}
 
     /** Report an unimplemented feature */
@@ -601,6 +604,57 @@ public abstract class SequenceUpdater implements Cacheable
         return StandardException.newException( SQLState.BTREE_UNIMPLEMENTED_FEATURE );
     }
 
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContextOrNull( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContextOrNull( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContextOrNull( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
     ///////////////////////////////////////////////////////////////////////////////////
     //
     // INNER CLASSES
diff --git a/java/engine/org/apache/derby/impl/sql/compile/MaxMinAggregateDefinition.java b/java/engine/org/apache/derby/impl/sql/compile/MaxMinAggregateDefinition.java
index c81d74909..e690d5045 100644
--- a/java/engine/org/apache/derby/impl/sql/compile/MaxMinAggregateDefinition.java
+++ b/java/engine/org/apache/derby/impl/sql/compile/MaxMinAggregateDefinition.java
@@ -22,6 +22,7 @@
 package org.apache.derby.impl.sql.compile;
 
 import org.apache.derby.iapi.reference.ClassName;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.sql.conn.LanguageConnectionContext;
 import org.apache.derby.iapi.types.DataTypeDescriptor;
@@ -59,7 +60,7 @@ class MaxMinAggregateDefinition
 				StringBuffer aggregatorClass) 
 	{
 		LanguageConnectionContext lcc = (LanguageConnectionContext)
-			ContextService.getContext(LanguageConnectionContext.CONTEXT_ID);
+			QueryTreeNode.getContext(LanguageConnectionContext.CONTEXT_ID);
 
 			/*
 			** MIN and MAX may return null
@@ -99,4 +100,5 @@ class MaxMinAggregateDefinition
 	{
 		return(isMax);
 	}
+    
 }
diff --git a/java/engine/org/apache/derby/impl/sql/compile/OptimizerTracer.java b/java/engine/org/apache/derby/impl/sql/compile/OptimizerTracer.java
index f9d2c3a1e..f5995c5aa 100644
--- a/java/engine/org/apache/derby/impl/sql/compile/OptimizerTracer.java
+++ b/java/engine/org/apache/derby/impl/sql/compile/OptimizerTracer.java
@@ -28,6 +28,7 @@ import java.security.PrivilegedAction;
 import java.sql.SQLException;
 import org.apache.derby.iapi.db.OptimizerTrace;
 import org.apache.derby.iapi.reference.SQLState;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.services.i18n.MessageService;
 import org.apache.derby.iapi.services.loader.ClassFactory;
@@ -107,7 +108,7 @@ public	class   OptimizerTracer  implements OptionalTool
             String  customOptTraceName = configurationParameters[ 1 ];
 
             try {
-                ClassFactoryContext cfc = (ClassFactoryContext) ContextService.getContext( ClassFactoryContext.CONTEXT_ID );
+                ClassFactoryContext cfc = (ClassFactoryContext) getContext( ClassFactoryContext.CONTEXT_ID );
                 ClassFactory    classFactory = cfc.getClassFactory();
 
                 tracer = (OptTrace) classFactory.loadApplicationClass( customOptTraceName ).newInstance();
@@ -199,5 +200,30 @@ public	class   OptimizerTracer  implements OptionalTool
 
         return new SQLException( errorMessage, sqlState );
     }
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContext( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContext( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContext( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
 
diff --git a/java/engine/org/apache/derby/impl/sql/compile/QueryTreeNode.java b/java/engine/org/apache/derby/impl/sql/compile/QueryTreeNode.java
index f78e5569f..2ce3e3d1e 100644
--- a/java/engine/org/apache/derby/impl/sql/compile/QueryTreeNode.java
+++ b/java/engine/org/apache/derby/impl/sql/compile/QueryTreeNode.java
@@ -21,6 +21,8 @@
 
 package	org.apache.derby.impl.sql.compile;
 
+import java.security.AccessController;
+import java.security.PrivilegedAction;
 import java.sql.Types;
 import java.util.ArrayList;
 import java.util.List;
@@ -37,6 +39,8 @@ import org.apache.derby.iapi.reference.SQLState;
 import org.apache.derby.iapi.services.classfile.VMOpcode;
 import org.apache.derby.iapi.services.compiler.MethodBuilder;
 import org.apache.derby.iapi.services.context.ContextManager;
+import org.apache.derby.iapi.services.context.Context;
+import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.services.i18n.MessageService;
 import org.apache.derby.iapi.services.loader.ClassFactory;
 import org.apache.derby.iapi.services.loader.ClassInspector;
@@ -1593,4 +1597,28 @@ public abstract class QueryTreeNode implements Visitable
         return visitor.getNodes();
     }
 
+    /**
+     * Privileged lookup of a Context. Must be package protected so that user code
+     * can't call this entry point.
+     */
+    static  Context    getContext( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContext( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContext( contextID );
+                     }
+                 }
+                 );
+        }
+    }
 }
diff --git a/java/engine/org/apache/derby/impl/sql/compile/SumAvgAggregateDefinition.java b/java/engine/org/apache/derby/impl/sql/compile/SumAvgAggregateDefinition.java
index fb9cb3797..764f96813 100644
--- a/java/engine/org/apache/derby/impl/sql/compile/SumAvgAggregateDefinition.java
+++ b/java/engine/org/apache/derby/impl/sql/compile/SumAvgAggregateDefinition.java
@@ -67,7 +67,7 @@ class SumAvgAggregateDefinition
 			TypeId compType = inputType.getTypeId();
 		
 			CompilerContext cc = (CompilerContext)
-				ContextService.getContext(CompilerContext.CONTEXT_ID);
+				QueryTreeNode.getContext(CompilerContext.CONTEXT_ID);
 			TypeCompilerFactory tcf = cc.getTypeCompilerFactory();
 			TypeCompiler tc = tcf.getTypeCompiler(compType);
 		
diff --git a/java/engine/org/apache/derby/impl/sql/compile/UserAggregateDefinition.java b/java/engine/org/apache/derby/impl/sql/compile/UserAggregateDefinition.java
index e33f06298..af0bec9b4 100644
--- a/java/engine/org/apache/derby/impl/sql/compile/UserAggregateDefinition.java
+++ b/java/engine/org/apache/derby/impl/sql/compile/UserAggregateDefinition.java
@@ -100,7 +100,7 @@ class UserAggregateDefinition implements AggregateDefinition
 		try
 		{
 			CompilerContext cc = (CompilerContext)
-				ContextService.getContext(CompilerContext.CONTEXT_ID);
+				QueryTreeNode.getContext(CompilerContext.CONTEXT_ID);
             ClassFactory    classFactory = cc.getClassFactory();
             TypeCompilerFactory tcf = cc.getTypeCompilerFactory();
 
diff --git a/java/engine/org/apache/derby/impl/sql/execute/GenericConstantActionFactory.java b/java/engine/org/apache/derby/impl/sql/execute/GenericConstantActionFactory.java
index 4eba70d92..3160d9ec3 100644
--- a/java/engine/org/apache/derby/impl/sql/execute/GenericConstantActionFactory.java
+++ b/java/engine/org/apache/derby/impl/sql/execute/GenericConstantActionFactory.java
@@ -23,6 +23,7 @@ package org.apache.derby.impl.sql.execute;
 
 import org.apache.derby.iapi.error.StandardException;
 
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 
 import org.apache.derby.iapi.sql.conn.Authorizer;
@@ -52,6 +53,8 @@ import org.apache.derby.impl.sql.compile.TableName;
 import java.util.List;
 import java.util.Properties;
 
+import java.security.AccessController;
+import java.security.PrivilegedAction;
 import java.sql.Timestamp;
 
 /**
@@ -1005,7 +1008,7 @@ public class GenericConstantActionFactory
 	static protected Authorizer getAuthorizer()
 	{
 		LanguageConnectionContext lcc = (LanguageConnectionContext)
-			ContextService.getContext(LanguageConnectionContext.CONTEXT_ID);
+			getContext(LanguageConnectionContext.CONTEXT_ID);
 		return lcc.getAuthorizer();
 	}
 
@@ -1196,4 +1199,29 @@ public class GenericConstantActionFactory
 		return new MergeConstantAction( matchingClauses );
 	}
 
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContext( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContext( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContext( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/impl/sql/execute/JarUtil.java b/java/engine/org/apache/derby/impl/sql/execute/JarUtil.java
index cdbb4a53a..eb16bac48 100644
--- a/java/engine/org/apache/derby/impl/sql/execute/JarUtil.java
+++ b/java/engine/org/apache/derby/impl/sql/execute/JarUtil.java
@@ -28,6 +28,7 @@ import java.io.InputStream;
 import java.net.MalformedURLException;
 import java.net.URL;
 import java.security.AccessController;
+import java.security.PrivilegedAction;
 import java.security.PrivilegedActionException;
 import java.util.HashMap;
 import java.util.Iterator;
@@ -39,6 +40,7 @@ import org.apache.derby.iapi.reference.Property;
 import org.apache.derby.iapi.reference.SQLState;
 import org.apache.derby.iapi.security.Securable;
 import org.apache.derby.iapi.security.SecurityUtil;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.services.io.FileUtil;
 import org.apache.derby.iapi.services.loader.ClassFactory;
@@ -438,7 +440,7 @@ public class JarUtil
 
         if (!upgrading) {
             LanguageConnectionContext lcc =
-                (LanguageConnectionContext)ContextService.getContextOrNull(
+                (LanguageConnectionContext)getContextOrNull(
                     LanguageConnectionContext.CONTEXT_ID);
 
             // DERBY-5357 UUIDs introduced in jar file names in 10.9
@@ -499,4 +501,30 @@ public class JarUtil
                 new File(oldFile.getPath()),
                 new File(newFile.getPath()), null);
     }
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContextOrNull( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContextOrNull( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContextOrNull( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/impl/store/access/RAMAccessManager.java b/java/engine/org/apache/derby/impl/store/access/RAMAccessManager.java
index 121eaf3fc..6acae540d 100644
--- a/java/engine/org/apache/derby/impl/store/access/RAMAccessManager.java
+++ b/java/engine/org/apache/derby/impl/store/access/RAMAccessManager.java
@@ -30,6 +30,7 @@ import org.apache.derby.iapi.services.cache.CacheFactory;
 import org.apache.derby.iapi.services.cache.CacheManager;
 
 import org.apache.derby.iapi.services.context.ContextManager;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.services.daemon.Serviceable;
 import org.apache.derby.iapi.services.locks.LockFactory;
@@ -66,6 +67,8 @@ import org.apache.derby.catalog.UUID;
 import org.apache.derby.iapi.reference.SQLState;
 import org.apache.derby.iapi.reference.Attribute;
 
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.util.Dictionary;
 import java.util.Enumeration;
 import java.util.Hashtable;
@@ -548,16 +551,16 @@ public abstract class RAMAccessManager
      */
     RAMTransactionContext getCurrentTransactionContext() {
         RAMTransactionContext rtc =
-            (RAMTransactionContext) ContextService.getContext(
+            (RAMTransactionContext) getContext(
                 AccessFactoryGlobals.RAMXACT_INTERNAL_CONTEXT_ID);
 
         if (rtc == null) {
-            rtc = (RAMTransactionContext) ContextService.getContext(
+            rtc = (RAMTransactionContext) getContext(
                     AccessFactoryGlobals.RAMXACT_CHILD_CONTEXT_ID);
         }
 
         if (rtc == null) {
-            rtc = (RAMTransactionContext) ContextService.getContext(
+            rtc = (RAMTransactionContext) getContext(
                     AccessFactoryGlobals.RAMXACT_CONTEXT_ID);
         }
 
@@ -1053,7 +1056,7 @@ public abstract class RAMAccessManager
         // Create the conglom conglom from within a separate system xact
         RAMTransaction tc =
             (RAMTransaction) getAndNameTransaction(
-                ContextService.getFactory().getCurrentContextManager(),
+                getContextService().getCurrentContextManager(),
                 AccessFactoryGlobals.USER_TRANS_NAME);
 
         // looking up lock_mode is dependant on access booting, but
@@ -1272,4 +1275,56 @@ public abstract class RAMAccessManager
 		return new CacheableConglomerate(this);
 	}
 
+    // ///////////////////////////////////////////////////////////////
+
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContext( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContext( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContext( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/impl/store/raw/RawStore.java b/java/engine/org/apache/derby/impl/store/raw/RawStore.java
index 6576f8c93..f343aaac0 100644
--- a/java/engine/org/apache/derby/impl/store/raw/RawStore.java
+++ b/java/engine/org/apache/derby/impl/store/raw/RawStore.java
@@ -24,6 +24,7 @@ package org.apache.derby.impl.store.raw;
 import org.apache.derby.iapi.services.daemon.DaemonFactory;
 import org.apache.derby.iapi.services.daemon.DaemonService;
 import org.apache.derby.iapi.services.context.ContextManager;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.services.crypto.CipherFactoryBuilder;
 import org.apache.derby.iapi.services.crypto.CipherFactory;
@@ -67,6 +68,7 @@ import org.apache.derby.iapi.reference.MessageId;
 import org.apache.derby.iapi.reference.Property;
 
 import java.security.AccessController;
+import java.security.PrivilegedAction;
 import java.security.PrivilegedActionException;
 import java.security.SecureRandom;
 
@@ -508,7 +510,7 @@ public final class RawStore implements RawStoreFactory, ModuleControl, ModuleSup
         RawTransaction t = 
                 xactFactory.findUserTransaction(
                 this,
-                ContextService.getFactory().getCurrentContextManager(), 
+                getContextService().getCurrentContextManager(), 
                 AccessFactoryGlobals.USER_TRANS_NAME);
 
         //back up blocking operations are unlogged operations.
@@ -629,7 +631,7 @@ public final class RawStore implements RawStoreFactory, ModuleControl, ModuleSup
 		// to open the container through page cache
 		RawTransaction t = 
             xactFactory.findUserTransaction(this,
-                ContextService.getFactory().getCurrentContextManager(), 
+                getContextService().getCurrentContextManager(), 
                 AccessFactoryGlobals.USER_TRANS_NAME);
 
 		try {
@@ -809,7 +811,7 @@ public final class RawStore implements RawStoreFactory, ModuleControl, ModuleSup
                 createBackupDirectory(backupJarDir);
 
                 LanguageConnectionContext lcc = 
-                    (LanguageConnectionContext)ContextService.getContextOrNull(
+                    (LanguageConnectionContext)getContextOrNull(
                         LanguageConnectionContext.CONTEXT_ID);
         
                 // DERBY-5357 UUIDs introduced in jar file names in 10.9
@@ -1655,7 +1657,7 @@ public final class RawStore implements RawStoreFactory, ModuleControl, ModuleSup
         RawTransaction transaction =
             xactFactory.startTransaction(
                    this,
-                    ContextService.getFactory().getCurrentContextManager(),
+                    getContextService().getCurrentContextManager(),
                     AccessFactoryGlobals.USER_TRANS_NAME);
 
         try 
@@ -2824,4 +2826,56 @@ public final class RawStore implements RawStoreFactory, ModuleControl, ModuleSup
             }
         }
     }
+    
+    /**
+     * Privileged lookup of the ContextService. Private so that user code
+     * can't call this entry point.
+     */
+    private static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContextOrNull( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContextOrNull( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContextOrNull( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/impl/store/raw/data/D_DiagnosticUtil.java b/java/engine/org/apache/derby/impl/store/raw/data/D_DiagnosticUtil.java
index 8192c94ff..8666c26ae 100644
--- a/java/engine/org/apache/derby/impl/store/raw/data/D_DiagnosticUtil.java
+++ b/java/engine/org/apache/derby/impl/store/raw/data/D_DiagnosticUtil.java
@@ -193,7 +193,7 @@ public class D_DiagnosticUtil
 
             TransactionController tc =
                 store_module.getTransaction(
-                    ContextService.getFactory().getCurrentContextManager());
+                    FileContainer.getContextService().getCurrentContextManager());
 
             ConglomerateController open_table = 
                 tc.openConglomerate(
@@ -243,7 +243,8 @@ public class D_DiagnosticUtil
 			RawStoreFactory store_module = (RawStoreFactory)
 				Monitor.findServiceModule(module, RawStoreFactory.MODULE);
 
-			xact = store_module.startInternalTransaction(ContextService.getFactory().getCurrentContextManager());
+			xact = store_module.startInternalTransaction
+                (FileContainer.getContextService().getCurrentContextManager());
 
 			ContainerKey id = new ContainerKey(segmentid, containerid);
 			ContainerHandle container = 
@@ -332,7 +333,7 @@ public class D_DiagnosticUtil
             {
                 TransactionController tc = 
                     store_module.getTransaction(
-                        ContextService.getFactory().getCurrentContextManager());
+                        FileContainer.getContextService().getCurrentContextManager());
 
                 conglom_id = tc.findConglomid(containerid);
             }
@@ -409,7 +410,7 @@ public class D_DiagnosticUtil
             {
                 TransactionController tc =
                     store_module.getTransaction(
-                        ContextService.getFactory().getCurrentContextManager());
+                        FileContainer.getContextService().getCurrentContextManager());
 
                 container_id = tc.findContainerid(conglomid);
             }
diff --git a/java/engine/org/apache/derby/impl/store/raw/data/FileContainer.java b/java/engine/org/apache/derby/impl/store/raw/data/FileContainer.java
index ec216254b..68aaad83e 100644
--- a/java/engine/org/apache/derby/impl/store/raw/data/FileContainer.java
+++ b/java/engine/org/apache/derby/impl/store/raw/data/FileContainer.java
@@ -62,6 +62,9 @@ import org.apache.derby.iapi.util.ByteArray;
 import java.io.IOException;
 import java.io.DataInput;
 
+import java.security.PrivilegedAction;
+import java.security.AccessController;
+
 import java.util.Properties;
 import java.util.zip.CRC32;
 
@@ -1157,7 +1160,7 @@ abstract class FileContainer
             (af == null) ? 
                 null : 
                 af.getTransaction(
-                        ContextService.getFactory().getCurrentContextManager());
+                        getContextService().getCurrentContextManager());
 
 		pageSize = 
 			PropertyUtil.getServiceInt(tc, createArgs,
@@ -3546,4 +3549,30 @@ abstract class FileContainer
 	protected abstract void backupContainer(BaseContainerHandle handle,	
                                             String backupLocation)
 	    throws StandardException;
+    
+    /**
+     * Privileged lookup of the ContextService. Must be limited to
+     * package visibility so that user code
+     * can't call this entry point.
+     */
+    static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
 }
diff --git a/java/engine/org/apache/derby/impl/store/raw/data/RFResource.java b/java/engine/org/apache/derby/impl/store/raw/data/RFResource.java
index f1697cf09..f1a192406 100644
--- a/java/engine/org/apache/derby/impl/store/raw/data/RFResource.java
+++ b/java/engine/org/apache/derby/impl/store/raw/data/RFResource.java
@@ -73,7 +73,7 @@ class RFResource implements FileResource {
             }
 
             ContextManager cm = 
-                ContextService.getFactory().getCurrentContextManager();
+                FileContainer.getContextService().getCurrentContextManager();
 
             RawTransaction tran = 
                 factory.getRawStoreFactory().getXactFactory().findUserTransaction(
@@ -156,7 +156,7 @@ class RFResource implements FileResource {
             throw StandardException.newException(SQLState.FILE_READ_ONLY);
 
         ContextManager cm =
-            ContextService.getFactory().getCurrentContextManager();
+            FileContainer.getContextService().getCurrentContextManager();
 
         RawTransaction tran =
             factory.getRawStoreFactory().getXactFactory().findUserTransaction(
@@ -188,7 +188,7 @@ class RFResource implements FileResource {
 			throw StandardException.newException(SQLState.FILE_READ_ONLY);
 
 			
-		ContextManager cm = ContextService.getFactory().getCurrentContextManager();
+		ContextManager cm = FileContainer.getContextService().getCurrentContextManager();
 
         RawTransaction tran = 
             factory.getRawStoreFactory().getXactFactory().findUserTransaction(
diff --git a/java/engine/org/apache/derby/impl/store/raw/data/StreamFileContainer.java b/java/engine/org/apache/derby/impl/store/raw/data/StreamFileContainer.java
index 0da013253..a490aa479 100644
--- a/java/engine/org/apache/derby/impl/store/raw/data/StreamFileContainer.java
+++ b/java/engine/org/apache/derby/impl/store/raw/data/StreamFileContainer.java
@@ -68,6 +68,7 @@ import java.io.IOException;
 import java.io.EOFException;
 import java.io.InvalidClassException;
 import java.io.Externalizable;
+import java.security.PrivilegedAction;
 import java.security.AccessController;
 import java.security.PrivilegedExceptionAction;
 import java.security.PrivilegedActionException;
@@ -409,7 +410,7 @@ class StreamFileContainer implements TypedFormat, PrivilegedExceptionAction<Obje
             (af == null) ? 
                 null : 
                 af.getTransaction(
-                    ContextService.getFactory().getCurrentContextManager());
+                    getContextService().getCurrentContextManager());
 
 		bufferSize = 
 			PropertyUtil.getServiceInt(tc, prop,
@@ -1197,4 +1198,29 @@ class StreamFileContainer implements TypedFormat, PrivilegedExceptionAction<Obje
         return null;
     }
 
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/impl/store/raw/log/LogToFile.java b/java/engine/org/apache/derby/impl/store/raw/log/LogToFile.java
index 443fd4457..4b0b05b4c 100644
--- a/java/engine/org/apache/derby/impl/store/raw/log/LogToFile.java
+++ b/java/engine/org/apache/derby/impl/store/raw/log/LogToFile.java
@@ -89,6 +89,7 @@ import java.io.FileNotFoundException;
 import java.net.MalformedURLException;
 import java.net.URL;
 import java.security.AccessController;
+import java.security.PrivilegedAction;
 import java.security.PrivilegedActionException;
 
 import java.util.Properties;
@@ -884,7 +885,7 @@ public final class LogToFile implements LogFactory, ModuleControl, ModuleSupport
 				RawTransaction recoveryTransaction =
                     tf.startTransaction(
                         rawStoreFactory,
-                        ContextService.getFactory().getCurrentContextManager(),
+                        getContextService().getCurrentContextManager(),
                         AccessFactoryGlobals.USER_TRANS_NAME);
 
 				// make this transaction aware that it is a recovery transaction
@@ -1671,7 +1672,7 @@ public final class LogToFile implements LogFactory, ModuleControl, ModuleSupport
 			// start a checkpoint transaction 
 			if (needCPTran)
 				cptran = tf.startInternalTransaction(rsf,
-				ContextService.getFactory().getCurrentContextManager());
+				getContextService().getCurrentContextManager());
 
 			/////////////////////////////////////////////////////
 			// gather a snapshot of the various interesting points of the log
@@ -4956,7 +4957,7 @@ public final class LogToFile implements LogFactory, ModuleControl, ModuleSupport
 			{
 				TransactionController tc = null;
 				tc = af.getTransaction(
-                        ContextService.getFactory().getCurrentContextManager());
+                        getContextService().getCurrentContextManager());
 				tc.setProperty(Property.LOG_ARCHIVE_MODE , "true", true);
 			}
 		}
@@ -4970,7 +4971,7 @@ public final class LogToFile implements LogFactory, ModuleControl, ModuleSupport
 		if (af != null)
 		{
 			TransactionController tc = null;
-			tc = af.getTransaction(ContextService.getFactory().getCurrentContextManager());
+			tc = af.getTransaction(getContextService().getCurrentContextManager());
 			tc.setProperty(Property.LOG_ARCHIVE_MODE , "false", true);
 		}
         logArchived = false;
@@ -5954,4 +5955,30 @@ public final class LogToFile implements LogFactory, ModuleControl, ModuleSupport
         }
         return sb.toString();
     }
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/impl/store/raw/xact/XactFactory.java b/java/engine/org/apache/derby/impl/store/raw/xact/XactFactory.java
index 85c139e84..a2319a6ff 100644
--- a/java/engine/org/apache/derby/impl/store/raw/xact/XactFactory.java
+++ b/java/engine/org/apache/derby/impl/store/raw/xact/XactFactory.java
@@ -60,6 +60,8 @@ import org.apache.derby.iapi.error.StandardException;
 
 import org.apache.derby.iapi.util.InterruptStatus;
 
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.util.Properties;
 import java.util.concurrent.atomic.AtomicLong;
 
@@ -138,7 +140,7 @@ public class XactFactory implements TransactionFactory, ModuleControl, ModuleSup
                     properties);
 		
 
-		contextFactory = ContextService.getFactory();
+		contextFactory = getContextService();
 
 		lockFactory = 
             (LockFactory) Monitor.bootServiceModule(false, this,
@@ -1161,4 +1163,30 @@ public class XactFactory implements TransactionFactory, ModuleControl, ModuleSup
 		}
 	}
 	
+    
+    /**
+     * Privileged lookup of the ContextService. Private so that user code
+     * can't call this entry point.
+     */
+    private static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/jdbc/EmbedXAResource.java b/java/engine/org/apache/derby/jdbc/EmbedXAResource.java
index 62ac8f175..c5ed2bc0c 100644
--- a/java/engine/org/apache/derby/jdbc/EmbedXAResource.java
+++ b/java/engine/org/apache/derby/jdbc/EmbedXAResource.java
@@ -21,6 +21,8 @@
 
 package org.apache.derby.jdbc;
 
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.sql.ResultSet;
 import java.sql.SQLException;
 
@@ -94,7 +96,7 @@ class EmbedXAResource implements XAResource {
             // RM also does not know about this xid.
             if (inDoubtCM == null)
                 throw new XAException(XAException.XAER_NOTA);
-            ContextService csf = ContextService.getFactory();
+            ContextService csf = getContextService();
             csf.setCurrentContextManager(inDoubtCM);
             try {
                 rm.commit(inDoubtCM, xid_im, onePhase);
@@ -406,7 +408,7 @@ class EmbedXAResource implements XAResource {
             if (inDoubtCM == null)
                 throw new XAException(XAException.XAER_NOTA);
             
-            ContextService csf = ContextService.getFactory();
+            ContextService csf = getContextService();
             
             csf.setCurrentContextManager(inDoubtCM);
             try {
@@ -456,7 +458,7 @@ class EmbedXAResource implements XAResource {
             if (inDoubtCM == null)
                 throw new XAException(XAException.XAER_NOTA);
             
-            ContextService csf = ContextService.getFactory();
+            ContextService csf = getContextService();
             
             csf.setCurrentContextManager(inDoubtCM);
             try {
@@ -929,4 +931,30 @@ class EmbedXAResource implements XAResource {
         currentXid = aCurrentXid;
     }
 
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/engine/org/apache/derby/jdbc/EmbeddedDriver.java b/java/engine/org/apache/derby/jdbc/EmbeddedDriver.java
index b776581b7..5ec624e84 100644
--- a/java/engine/org/apache/derby/jdbc/EmbeddedDriver.java
+++ b/java/engine/org/apache/derby/jdbc/EmbeddedDriver.java
@@ -91,7 +91,6 @@ import org.apache.derby.impl.jdbc.Util;
 public class EmbeddedDriver  implements Driver {
 
 	static {
-
 		EmbeddedDriver.boot();
 	}
 
@@ -196,7 +195,14 @@ public class EmbeddedDriver  implements Driver {
             pw = new PrintWriter(System.err, true);
         }
 
-        new JDBCBoot().boot(Attribute.PROTOCOL, pw);
+        try {
+            new JDBCBoot().boot(Attribute.PROTOCOL, pw);
+        }
+        catch (Throwable t)
+        {
+            t.printStackTrace( pw );
+            if ( t instanceof RuntimeException ) { throw (RuntimeException) t; }
+        }
 	}
 
     ////////////////////////////////////////////////////////////////////
diff --git a/java/engine/org/apache/derby/jdbc/InternalDriver.java b/java/engine/org/apache/derby/jdbc/InternalDriver.java
index 4c5cc92c0..bd9e38e9c 100644
--- a/java/engine/org/apache/derby/jdbc/InternalDriver.java
+++ b/java/engine/org/apache/derby/jdbc/InternalDriver.java
@@ -22,8 +22,10 @@
 
 package org.apache.derby.jdbc;
 
+import java.security.AccessController;
 import java.security.AccessControlException;
 import java.security.Permission;
+import java.security.PrivilegedAction;
 import java.sql.CallableStatement;
 import java.sql.Connection;
 import java.sql.DatabaseMetaData;
@@ -122,7 +124,7 @@ public class InternalDriver implements ModuleControl, Driver {
 	}
 
 	public InternalDriver() {
-		contextServiceFactory = ContextService.getFactory();
+		contextServiceFactory = getContextService();
 	}
 
 	/*
@@ -965,5 +967,31 @@ public class InternalDriver implements ModuleControl, Driver {
         return InternalDriver.deregister;
     }
 
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 
 }
diff --git a/java/engine/org/apache/derby/security/SystemPermission.java b/java/engine/org/apache/derby/security/SystemPermission.java
index 7b698affc..92b07284b 100644
--- a/java/engine/org/apache/derby/security/SystemPermission.java
+++ b/java/engine/org/apache/derby/security/SystemPermission.java
@@ -95,6 +95,11 @@ final public class SystemPermission extends BasicPermission {
      */
     public static final String MONITOR = "monitor";
 
+    /**
+     * Action (<code>"useDerbyInternals"</code>) by the engine to lookup Derby contexts.
+     */
+    public static final String USE_DERBY_INTERNALS = "usederbyinternals";
+
     /**
      * The legal system permission names.
      */
@@ -115,6 +120,7 @@ final public class SystemPermission extends BasicPermission {
         LEGAL_ACTIONS.add(CONTROL);
         LEGAL_ACTIONS.add(MONITOR);
         LEGAL_ACTIONS.add(SHUTDOWN);
+        LEGAL_ACTIONS.add( USE_DERBY_INTERNALS );
     }
     
     /** Constant representing {@code SystemPermission("engine, "monitor")}. */
@@ -141,7 +147,7 @@ final public class SystemPermission extends BasicPermission {
      * @see BasicPermission#BasicPermission(String)
      */
     public SystemPermission(String name, String actions) {
-        super(name);
+        super( name );
         validateNameAndActions(name, actions);
     }
 
@@ -191,6 +197,7 @@ final public class SystemPermission extends BasicPermission {
         // Get all the legal actions that are in actionSet, in the order
         // of LEGAL_ACTIONS.
         List<String> legalActions = new ArrayList<String>(LEGAL_ACTIONS);
+
         legalActions.retainAll(actionSet);
 
         return buildActionsString(legalActions);
@@ -400,4 +407,19 @@ final public class SystemPermission extends BasicPermission {
             }
         }
     }
+
+    @Override
+    public String toString()
+    {
+        return getClass().getName() +
+            "( " +
+            doubleQuote( getName() ) +
+            ", " +
+            doubleQuote( actions ) +
+            " )";
+    }
+    private String  doubleQuote( String raw )
+    {
+        return "\"" + raw + "\"";
+    }
 }
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/GetCurrentPropertiesTest.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/GetCurrentPropertiesTest.policy
index 244c47cc7..8e6dc1858 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/GetCurrentPropertiesTest.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/GetCurrentPropertiesTest.policy
@@ -51,6 +51,7 @@ grant codeBase "${derbyTesting.codejar}derby.jar" {
   permission java.util.PropertyPermission "java.class.path", "read";//sysinfo
   permission java.util.PropertyPermission "java.runtime.version", "read";//sysinfo
   permission java.util.PropertyPermission "java.fullversion", "read";//sysinfo
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
   
   // unit tests (e.g. store/T_RecoverFullLog) set this property 
   // (called from derbyTesting.jar through code in derby.jar)
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/NetworkServerControlApiTest.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/NetworkServerControlApiTest.policy
index 6f9ff3f39..4ef1ad340 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/NetworkServerControlApiTest.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/NetworkServerControlApiTest.policy
@@ -51,6 +51,7 @@ grant codeBase "${derbyTesting.codejar}derby.jar" {
   permission java.util.PropertyPermission "java.class.path", "read";//sysinfo
   permission java.util.PropertyPermission "java.runtime.version", "read";//sysinfo
   permission java.util.PropertyPermission "java.fullversion", "read";//sysinfo
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
   
   // unit tests (e.g. store/T_RecoverFullLog) set this property 
   // (called from derbyTesting.jar through code in derby.jar)
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/RuntimeInfoTest.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/RuntimeInfoTest.policy
index d17d58837..2a16d4214 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/RuntimeInfoTest.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/RuntimeInfoTest.policy
@@ -55,6 +55,7 @@ permission java.util.PropertyPermission "derby.storage.jvmInstanceId",
   permission java.util.PropertyPermission "java.class.path", "read";//sysinfo
   permission java.util.PropertyPermission "java.runtime.version", "read";//sysinfo
   permission java.util.PropertyPermission "java.fullversion", "read";//sysinfo
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
   
   // unit tests (e.g. store/T_RecoverFullLog) set this property 
   // (called from derbyTesting.jar through code in derby.jar)
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SecureServerTest.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SecureServerTest.policy
index 7d2a95909..049dd9ee5 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SecureServerTest.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SecureServerTest.policy
@@ -55,6 +55,7 @@ grant codeBase "${derbyTesting.codejar}derby.jar" {
   permission java.util.PropertyPermission "java.class.path", "read";//sysinfo
   permission java.util.PropertyPermission "java.runtime.version", "read";//sysinfo
   permission java.util.PropertyPermission "java.fullversion", "read";//sysinfo
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
   
   // unit tests (e.g. store/T_RecoverFullLog) set this property 
   // (called from derbyTesting.jar through code in derby.jar)
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/ServerPropertiesTest.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/ServerPropertiesTest.policy
index 4ba862843..197a66807 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/ServerPropertiesTest.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/ServerPropertiesTest.policy
@@ -51,6 +51,7 @@ grant codeBase "${derbyTesting.codejar}derby.jar" {
   permission java.util.PropertyPermission "java.class.path", "read";//sysinfo
   permission java.util.PropertyPermission "java.runtime.version", "read, write";//sysinfo
   permission java.util.PropertyPermission "java.fullversion", "read, write";//sysinfo
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
   
   // unit tests (e.g. store/T_RecoverFullLog) set this property 
   // (called from derbyTesting.jar through code in derby.jar)
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SysinfoTest.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SysinfoTest.policy
index ce66ce3f0..4acdcc747 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SysinfoTest.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SysinfoTest.policy
@@ -54,6 +54,7 @@ grant codeBase "${derbyTesting.codejar}derby.jar" {
   permission java.util.PropertyPermission "java.class.path", "read";//sysinfo
   permission java.util.PropertyPermission "java.runtime.version", "read";//sysinfo
   permission java.util.PropertyPermission "java.fullversion", "read";//sysinfo
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
   
   // unit tests (e.g. store/T_RecoverFullLog) set this property 
   // (called from derbyTesting.jar through code in derby.jar)
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/engine/noDeregisterPermission.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/engine/noDeregisterPermission.policy
index 31e950738..495fee6d3 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/engine/noDeregisterPermission.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/engine/noDeregisterPermission.policy
@@ -37,6 +37,7 @@ grant codeBase "${derbyTesting.codejar}derby.jar" {
   permission java.util.PropertyPermission "java.class.path", "read";//sysinfo
   permission java.util.PropertyPermission "java.runtime.version", "read";//sysinfo
   permission java.util.PropertyPermission "java.fullversion", "read";//sysinfo
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
   
   // unit tests (e.g. store/T_RecoverFullLog) set this property 
   // (called from derbyTesting.jar through code in derby.jar)
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/jdbc4/noAbortPermission.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/jdbc4/noAbortPermission.policy
index 35b80442d..6a80e8261 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/jdbc4/noAbortPermission.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/jdbc4/noAbortPermission.policy
@@ -36,6 +36,7 @@ grant codeBase "${derbyTesting.codejar}derby.jar" {
   permission java.util.PropertyPermission "java.class.path", "read";//sysinfo
   permission java.util.PropertyPermission "java.runtime.version", "read";//sysinfo
   permission java.util.PropertyPermission "java.fullversion", "read";//sysinfo
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
   
   // unit tests (e.g. store/T_RecoverFullLog) set this property 
   // (called from derbyTesting.jar through code in derby.jar)
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/LDAPTests.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/LDAPTests.policy
index 588fbeb49..7c2fe4d12 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/LDAPTests.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/LDAPTests.policy
@@ -54,6 +54,7 @@ grant codeBase "${derbyTesting.codejar}derby.jar" {
   permission java.util.PropertyPermission "java.class.path", "read";//sysinfo
   permission java.util.PropertyPermission "java.runtime.version", "read";//sysinfo
   permission java.util.PropertyPermission "java.fullversion", "read";//sysinfo
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
   
   // unit tests (e.g. store/T_RecoverFullLog) set this property 
   // (called from derbyTesting.jar through code in derby.jar)
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/NoDBInternalsPermissionTest.java b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/NoDBInternalsPermissionTest.java
new file mode 100644
index 000000000..bc7bab7f8
--- /dev/null
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/NoDBInternalsPermissionTest.java
@@ -0,0 +1,127 @@
+/*
+
+   Derby - Class org.apache.derbyTesting.functionTests.tests.lang.NoDBInternalsPermissionTest
+
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to you under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+
+ */
+
+package org.apache.derbyTesting.functionTests.tests.lang;
+
+import java.io.File;
+import java.security.AccessControlException;
+import java.sql.Connection;
+import java.sql.DriverManager;
+import java.sql.SQLException;
+import junit.framework.Test;
+import org.apache.derbyTesting.junit.BaseTestSuite;
+import org.apache.derbyTesting.junit.SecurityManagerSetup;
+import org.apache.derbyTesting.junit.TestConfiguration;
+
+import org.apache.derby.iapi.services.context.ContextService;
+
+/**
+ * <p>
+ * Test backup and restore of databases with Lucene indexes.
+ * </p>
+ */
+public class NoDBInternalsPermissionTest extends GeneratedColumnsHelper
+{
+    ///////////////////////////////////////////////////////////////////////////////////
+    //
+    // CONSTANTS
+    //
+    ///////////////////////////////////////////////////////////////////////////////////
+
+    private static  final   String      POLICY_FILE = "org/apache/derbyTesting/functionTests/tests/lang/no_derby_internals.policy";
+
+    ///////////////////////////////////////////////////////////////////////////////////
+    //
+    // STATE
+    //
+    ///////////////////////////////////////////////////////////////////////////////////
+
+    ///////////////////////////////////////////////////////////////////////////////////
+    //
+    // CONSTRUCTOR
+    //
+    ///////////////////////////////////////////////////////////////////////////////////
+
+    /**
+     * Create a new instance.
+     */
+
+    public NoDBInternalsPermissionTest( String name )
+    {
+        super( name );
+    }
+
+    ///////////////////////////////////////////////////////////////////////////////////
+    //
+    // JUnit BEHAVIOR
+    //
+    ///////////////////////////////////////////////////////////////////////////////////
+
+
+    /**
+     * Construct top level suite in this JUnit test
+     */
+    public static Test suite()
+    {
+        BaseTestSuite suite = (BaseTestSuite)TestConfiguration.embeddedSuite( NoDBInternalsPermissionTest.class );
+
+        Test        secureTest = new SecurityManagerSetup( suite, POLICY_FILE );
+
+        return secureTest;
+    }
+
+    ///////////////////////////////////////////////////////////////////////////////////
+    //
+    // TESTS
+    //
+    ///////////////////////////////////////////////////////////////////////////////////
+
+    /**
+     * <p>
+     * Verify that user code can't call static entry points in ContextService.
+     * </p>
+     */
+    public  void    test_001_ContextService()
+        throws Exception
+    {
+        try {
+            ContextService.stop();
+            fail( "Should have raised an AccessControlException" );
+        }
+        catch (AccessControlException e) { println( "Caught an AccessControlException" ); }
+        try {
+            ContextService.getFactory();
+            fail( "Should have raised an AccessControlException" );
+        }
+        catch (AccessControlException e) { println( "Caught an AccessControlException" ); }
+        try {
+            ContextService.getContext( "some context id"  );
+            fail( "Should have raised an AccessControlException" );
+        }
+        catch (AccessControlException e) { println( "Caught an AccessControlException" ); }
+        try {
+            ContextService.getContextOrNull( "some context id" );
+            fail( "Should have raised an AccessControlException" );
+        }
+        catch (AccessControlException e) { println( "Caught an AccessControlException" ); }
+    }
+
+}
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SecurityPolicyReloadingTest.initial.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SecurityPolicyReloadingTest.initial.policy
index cde62b096..cfcaa12b2 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SecurityPolicyReloadingTest.initial.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SecurityPolicyReloadingTest.initial.policy
@@ -29,6 +29,7 @@ grant codeBase "${derbyTesting.codejar}derby.jar"
       "write"; 
   permission java.io.FilePermission "${derby.system.home}","read";
   permission java.io.FilePermission "${derby.system.home}${/}-", "read,write,delete";
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
 
 // getProtectionDomain is an optional permission needed for printing classpath information
 // to derby.log
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SecurityPolicyReloadingTest.modified.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SecurityPolicyReloadingTest.modified.policy
index 7c6252d00..107ba354c 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SecurityPolicyReloadingTest.modified.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SecurityPolicyReloadingTest.modified.policy
@@ -29,6 +29,7 @@ grant codeBase "${derbyTesting.codejar}derby.jar"
       "write"; 
   permission java.io.FilePermission "${derby.system.home}","read";
   permission java.io.FilePermission "${derby.system.home}${/}-", "read,write,delete";
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
 
 // getProtectionDomain is an optional permission needed for printing classpath
 // information to derby.log
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SecurityPolicyReloadingTest.unreloadable.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SecurityPolicyReloadingTest.unreloadable.policy
index e60cc59ba..f44ea84c2 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SecurityPolicyReloadingTest.unreloadable.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SecurityPolicyReloadingTest.unreloadable.policy
@@ -51,6 +51,7 @@ permission java.util.PropertyPermission "derby.storage.jvmInstanceId",
   permission java.util.PropertyPermission "java.class.path", "read";//sysinfo
   permission java.util.PropertyPermission "java.runtime.version", "read";//sysinfo
   permission java.util.PropertyPermission "java.fullversion", "read";//sysinfo
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
   
   // unit tests (e.g. store/T_RecoverFullLog) set this property 
   // (called from derbyTesting.jar through code in derby.jar)
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/_Suite.java b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/_Suite.java
index 4b985e003..ac01af559 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/_Suite.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/_Suite.java
@@ -259,6 +259,7 @@ public class _Suite extends BaseTestCase  {
         suite.addTest(LuceneSuite.suite());
         suite.addTest(ConsistencyCheckerTest.suite());
         suite.addTest(Derby5866TriggerOrderTest.suite());
+        suite.addTest(NoDBInternalsPermissionTest.suite());
         return suite;
 	}
 }
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/luceneSupport.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/luceneSupport.policy
index 4847a8d07..63bb749fe 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/luceneSupport.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/luceneSupport.policy
@@ -55,6 +55,7 @@ grant codeBase "${derbyTesting.codejar}derby.jar" {
   permission java.util.PropertyPermission "java.class.path", "read";//sysinfo
   permission java.util.PropertyPermission "java.runtime.version", "read";//sysinfo
   permission java.util.PropertyPermission "java.fullversion", "read";//sysinfo
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
   
   // unit tests (e.g. store/T_RecoverFullLog) set this property 
   // (called from derbyTesting.jar through code in derby.jar)
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/no_derby_internals.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/no_derby_internals.policy
new file mode 100644
index 000000000..9e9a55c2d
--- /dev/null
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/no_derby_internals.policy
@@ -0,0 +1,470 @@
+//
+// *  Derby - Class org.apache.derbyTesting.functionTests.util.no_derby_internals.policy
+// *  
+// * Licensed to the Apache Software Foundation (ASF) under one
+// * or more contributor license agreements.  See the NOTICE file
+// * distributed with this work for additional information
+// * regarding copyright ownership.  The ASF licenses this file
+// * to you under the Apache License, Version 2.0 (the
+// * "License"); you may not use this file except in compliance
+// * with the License.  You may obtain a copy of the License at
+// *
+// *   http://www.apache.org/licenses/LICENSE-2.0
+// *
+// * Unless required by applicable law or agreed to in writing,
+// * software distributed under the License is distributed on an
+// * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+// * KIND, either express or implied.  See the License for the
+// * specific language governing permissions and limitations
+// * under the License.
+// *
+
+//
+// Policy file which does not grant the testing jar the userderbyinternals system permission.
+//
+// The test harness sets up four variables used by this policy file
+//
+// derbyTesting.codejar - URL to the jar files when they are in the classpath
+// derbyTesting.codeclasses - URL to the classes directory when it is in the classpath
+//
+// Only one of derbyTesting.codejar and derbyTesting.codeclasses will be valid, the
+// other will be set to a bogus URL like file://unused
+//
+// derbyTesting.codedir - File location of either derbyTesting.codejar or derbyTesting.codeclasses.
+// Only required due to a BUG (see below for more info).
+//
+// derbyTesting.jaxpjar - URL to the jar file containing the JAXP implementation
+//     for XML-based tests (ex. lang/XMLBindingTest.java).
+//
+// derbyTesting.serverhost - Host name or ip where network server is started 
+// derbyTesting.clienthost - specifies the clients ip address/hostName. 
+//     when testing with networkserver on a remote host, this needs to be passed in 
+//     with the NetworkServerControl start command
+
+//
+// Permissions for the embedded engine (derby.jar)
+//
+grant codeBase "${derbyTesting.codejar}derby.jar" {
+  permission java.util.PropertyPermission "derby.*", "read";
+  permission java.util.PropertyPermission "derby.storage.jvmInstanceId", 
+      "write"; 
+  // The next two properties are used to determine if the VM is 32 or 64 bit.
+  permission java.util.PropertyPermission "sun.arch.data.model", "read";
+  permission java.util.PropertyPermission "os.arch", "read";
+  permission java.util.PropertyPermission "java.class.path", "read";//sysinfo
+  permission java.util.PropertyPermission "java.runtime.version", "read";//sysinfo
+  permission java.util.PropertyPermission "java.fullversion", "read";//sysinfo
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
+  
+  // unit tests (e.g. store/T_RecoverFullLog) set this property 
+  // (called from derbyTesting.jar through code in derby.jar)
+  permission java.util.PropertyPermission "derbyTesting.unittest.*", "write";
+
+  permission java.lang.RuntimePermission "createClassLoader";
+
+  // getProtectionDomain is an optional permission needed for printing classpath
+  // information to derby.log
+  permission java.lang.RuntimePermission "getProtectionDomain";
+
+  // permissions so that we can set the context class loader to
+  // null for daemon threads to avoid class loader leak.
+  // DERBY-3745
+  permission java.lang.RuntimePermission "getClassLoader";
+  permission java.lang.RuntimePermission "setContextClassLoader";
+
+  permission java.security.SecurityPermission "getPolicy";
+  
+  permission java.io.FilePermission "${derby.system.home}${/}derby.properties", "read";
+  permission java.io.FilePermission "${derby.system.home}${/}derby.log", "read, write, delete";
+  // [DERBY-2000] The write permission was added to allow creation of the
+  // derby.system.home directory when running tests under a security manager.
+  permission java.io.FilePermission "${derby.system.home}", "read, write";
+  
+  // all databases under derby.system.home 
+  permission java.io.FilePermission "${derby.system.home}${/}-", "read, write, delete";
+
+  // Import/export and other support files from these locations in tests
+  permission java.io.FilePermission "${user.dir}${/}extin${/}-", "read";
+  permission java.io.FilePermission "${user.dir}${/}extinout${/}-", "read,  write, delete";
+  permission java.io.FilePermission "${user.dir}${/}extout${/}-", "read,write";
+  permission java.io.FilePermission "${user.dir}${/}extinout", "read,write";
+
+  // needed to create a temp file in order to open a database in a jar file
+  permission java.io.FilePermission "${java.io.tmpdir}${/}-", "read,write,delete";
+  
+  // These permissions are needed to load the JCE for encryption with Sun and IBM JDK131.
+  // JDK14 has the JCE  preloaded
+  permission java.security.SecurityPermission "insertProvider.SunJCE";
+  permission java.security.SecurityPermission "insertProvider.IBMJCE";
+  
+//
+// Permissions needed for JMX based management and monitoring, which is only
+// available for JVMs supporting "platform management", that is J2SE 5.0 or better.
+//
+// Allows this code to create an MBeanServer:
+//
+  permission javax.management.MBeanServerPermission "createMBeanServer";
+//
+// Allows access to Derby's built-in MBeans, within the domain org.apache.derby.
+// Derby must be allowed to register and unregister these MBeans.
+// To fine tune this permission, see the javadoc of javax.management.MBeanPermission
+// or the JMX Instrumentation and Agent Specification.
+//
+  permission javax.management.MBeanPermission "org.apache.derby.*#[org.apache.derby:*]","registerMBean,unregisterMBean";
+//
+// Trusts Derby code to be a source of MBeans and to register these in the MBean server.
+//
+  permission javax.management.MBeanTrustPermission "register";
+
+  // Gives permission for jmx to be used against Derby but
+  // only if JMX authentication is not being used.
+  // In that case the application would need to create
+  // a whole set of fine-grained permissions to allow specific
+  // users access to MBeans and actions they perform.
+  permission org.apache.derby.security.SystemPermission "jmx", "control";
+  permission org.apache.derby.security.SystemPermission "engine", "monitor";
+  permission org.apache.derby.security.SystemPermission "server", "monitor";  
+ 
+  // These permissions are needed by AssertFailure to dump the thread stack
+  // traces upon failure.
+  permission java.lang.RuntimePermission "getStackTrace";
+  permission java.lang.RuntimePermission "modifyThreadGroup";
+
+  // Needed by FileUtil#limitAccessToOwner
+  permission java.lang.RuntimePermission "accessUserInformation";
+  permission java.lang.RuntimePermission "getFileStoreAttributes";
+
+  // This permission is needed to call the Connection.abort(Executor) method added by JDBC 4.1
+  permission java.sql.SQLPermission "callAbort";
+
+  // This permission is needed to call DriverManager.deregisterDriver()
+  // on Java SE 8 and later.
+  permission java.sql.SQLPermission "deregisterDriver";
+};
+
+//
+// Permissions for the network server (derbynet.jar)
+//
+grant codeBase "${derbyTesting.codejar}derbynet.jar" {
+  permission java.util.PropertyPermission "java.class.path", "read";//sysinfo
+  permission java.util.PropertyPermission "java.runtime.version", "read";//sysinfo
+  permission java.util.PropertyPermission "java.fullversion", "read";//sysinfo
+  permission java.util.PropertyPermission "derby.__serverStartedFromCmdLine", "write";
+  
+  // accept is needed for the server accepting connections
+  // connect is needed for ping command (which is in the server jar)
+  // listen is needed for the server listening on the network port
+  permission java.net.SocketPermission "127.0.0.1", "accept,connect";
+  permission java.net.SocketPermission "localhost", "accept,connect,listen";
+  permission java.net.SocketPermission "${derbyTesting.clienthost}", "accept,connect";
+  permission java.net.SocketPermission "${derbyTesting.serverhost}", "accept,connect";
+
+  // Need to be able to write to trace file for NetworkServerControlApiTest
+  permission java.io.FilePermission "${user.dir}${/}system${/}trace", "read,write";
+  permission java.io.FilePermission "${user.dir}${/}system${/}trace${/}-", "read,write";
+
+  // Need read/write to trace file for RestrictiveFilePermissionsTest
+  permission java.io.FilePermission "${user.dir}${/}system${/}RFPT_db_tracefiles_restr", "read,write";
+  permission java.io.FilePermission "${user.dir}${/}system${/}RFPT_db_tracefiles_lax", "read,write";
+  permission java.io.FilePermission "${user.dir}${/}system${/}RFPT_db_tracefiles_restr${/}-", "read,write";
+  permission java.io.FilePermission "${user.dir}${/}system${/}RFPT_db_tracefiles_lax${/}-", "read,write";
+
+    // Needed for NetworkServerMBean access (see JMX section above)
+  permission org.apache.derby.security.SystemPermission "server", "control,monitor";
+
+  // For NetworkServerControlApiTest:
+  // Needed by FileUtil#limitAccessToOwner
+  permission java.lang.RuntimePermission "accessUserInformation";
+  permission java.lang.RuntimePermission "getFileStoreAttributes";
+};
+
+//
+// Permissions for the network client (derbyclient.jar)
+//
+grant codeBase "${derbyTesting.clientjar}derbyclient.jar" {
+  permission java.net.SocketPermission "127.0.0.1", "connect,resolve";
+  permission java.net.SocketPermission "localhost", "connect,resolve";
+  permission java.net.SocketPermission "${derbyTesting.serverhost}", "connect,resolve";
+
+  // DERBY-1883: Since some classes that are included in both derby.jar and
+  // derbyclient.jar read properties, derbyclient.jar needs permission to read
+  // derby.* properties to avoid failures when it is listed before derby.jar in
+  // the classpath.
+  permission java.util.PropertyPermission "derby.*", "read";
+
+  // DERBY-2302: derbyclient.jar needs to be able to read the user.dir property in order to
+  // do tracing in that directory. Also, it needs read/write permissions in user.dir in order
+  // to create the trace files in that directory.
+  permission java.util.PropertyPermission "user.dir", "read";
+  permission java.io.FilePermission "${user.dir}${/}-", "read, write"; 
+  
+  // These permissions are needed by AssertFailure to dump the thread stack
+  // traces upon failure.
+  permission java.lang.RuntimePermission "getStackTrace";
+  permission java.lang.RuntimePermission "modifyThreadGroup";
+
+  // This permission is needed to call the Connection.abort(Executor) method added by JDBC 4.1
+  permission java.sql.SQLPermission "callAbort";
+  
+};
+
+//
+// Permissions for the tools (derbytools.jar)
+// Ideally this would be more secure, for now the
+// focus is on getting the engine & network server secure.
+//
+grant codeBase "${derbyTesting.codejar}derbytools.jar" {
+  // Access all properties using System.getProperties -
+  // ij enumerates the properties in order to open connections
+  // for any property set in ij.connection.* and set protocols
+  // for any property in ij.protocol.*
+  permission java.util.PropertyPermission "*", "read, write";
+  
+  // Read all files under ${user.dir}
+  permission java.io.FilePermission "${user.dir}${/}-", "read";
+  
+  // IjTestCases read, write, and delete ij's output in the extinout dir
+  permission java.io.FilePermission "${user.dir}${/}extinout${/}-", "read, write, delete";
+ 
+  // ij needs permission to read the sql files in this jar
+  permission java.io.FilePermission "${derbyTesting.testjarpath}", "read";
+  
+
+};
+
+//
+// Permissions for the tests (derbyTesting.jar)
+// We are liberal here, it's not a goal to make the test harness
+// or tests secure.
+//
+grant codeBase "${derbyTesting.testjar}derbyTesting.jar" {
+  // Access all properties using System.getProperties
+  permission java.util.PropertyPermission "*", "read, write";
+  
+  // Access all files under ${user.dir}to write the test directory structure
+  permission java.io.FilePermission "${user.dir}${/}-", "read,write,delete"; 
+
+  // Tests need to be able to exec a java program. DERBY-6295: Also give them
+  // read permission so that detailed error message is shown.
+  permission java.io.FilePermission "${java.home}${/}-", "execute, read";
+
+  // When running with useprocess=false need to install and uninstall
+  // the security manager and allow setIO to change the system err and out
+  // streams. Currently the nist suite runs with useprocess=false.
+  permission java.lang.RuntimePermission "setSecurityManager";
+  permission java.security.SecurityPermission "getPolicy";
+  permission java.lang.RuntimePermission "setIO";  
+
+  // Needed by ClasspathSetup to change the classloader
+  permission java.lang.RuntimePermission "createClassLoader";
+  permission java.lang.RuntimePermission "setContextClassLoader";
+
+  // These permissions are needed to dump the thread stack
+  // traces upon failure.
+  permission java.lang.RuntimePermission "getStackTrace";
+  permission java.lang.RuntimePermission "modifyThreadGroup";
+  
+  // Allow MBeanTest to register the application management MBean.
+  permission javax.management.MBeanServerPermission "createMBeanServer";
+  permission javax.management.MBeanPermission "org.apache.derby.mbeans.Management#[org.apache.derby:type=Management]","registerMBean,unregisterMBean";
+  permission javax.management.MBeanPermission "org.apache.derby.mbeans.Management#-[-]", "instantiate";
+  permission javax.management.MBeanTrustPermission "register";
+   
+  // And to find and use Derby's MBeans
+  permission javax.management.MBeanPermission "org.apache.derby.mbeans.*#[org.apache.derby:*]", "getAttribute,setAttribute,invoke";
+  permission javax.management.MBeanPermission "org.apache.derby.mbeans.*#-[org.apache.derby:*]", "getMBeanInfo";
+  permission javax.management.MBeanPermission "-#-[-]", "queryNames";
+  permission javax.management.MBeanPermission "org.apache.derby.mbeans.*#-[org.apache.derby:*]", "queryNames";
+  
+  // Test code needs this as well for the platform MBeanServer
+  // tests where the testing code is in the stack frame.
+  permission org.apache.derby.security.SystemPermission "jmx", "control";
+  permission org.apache.derby.security.SystemPermission "engine", "monitor";
+  permission org.apache.derby.security.SystemPermission "server", "control,monitor";
+
+  // useful for debugging
+  //permission java.lang.RuntimePermission "getProtectionDomain";
+
+  // This permission is needed to call the Connection.abort(Executor) method added by JDBC 4.1
+  permission java.sql.SQLPermission "callAbort";
+  
+  // Needed by FileUtil#limitAccessToOwner
+  permission java.lang.RuntimePermission "accessUserInformation";
+  permission java.lang.RuntimePermission "getFileStoreAttributes";
+
+  // Needed by NetworkServerTestSetup when probing ports.
+  permission java.net.SocketPermission "localhost", "listen";
+
+  // Needed by ClasspathSetup for freeing resources.
+  permission java.lang.RuntimePermission "closeClassLoader";
+
+  // Needed by AutoloadTest to get at spawned process pid (Unixen) and call jstack:
+  permission java.lang.RuntimePermission "accessDeclaredMembers";
+  permission java.lang.reflect.ReflectPermission "suppressAccessChecks";
+  // Presumes we have a JDK: First "..": back up past "jre"
+  permission java.io.FilePermission "${java.home}${/}..${/}bin${/}-", "execute, read";
+};
+
+//
+// super-set of the jar permissions for running out of the classes directory
+//
+grant codeBase "${derbyTesting.codeclasses}" {
+  // Access all properties using System.getProperties
+  permission java.util.PropertyPermission "*", "read, write";
+  
+  permission java.util.PropertyPermission "derby.*", "read";
+  permission java.lang.RuntimePermission "createClassLoader";
+
+  // permissions so that we can set the context class loader to
+  // null for daemon threads to avoid class loader leak.
+  // DERBY-3745
+  permission java.lang.RuntimePermission "getClassLoader";
+  permission java.lang.RuntimePermission "setContextClassLoader";
+
+  permission java.security.SecurityPermission "getPolicy";
+   
+  permission java.io.FilePermission "${derby.system.home}${/}derby.properties", "read";
+  permission java.io.FilePermission "${derby.system.home}${/}derby.log", "read, write, delete";
+  permission java.io.FilePermission "${derby.system.home}", "read";
+  permission java.io.FilePermission "${derby.system.home}${/}-", "read, write, delete";
+
+  // combination of client and server side.
+  permission java.net.SocketPermission "127.0.0.1", "accept,connect,resolve";
+  permission java.net.SocketPermission "localhost", "accept,connect,resolve,listen";
+  permission java.net.SocketPermission "${derbyTesting.clienthost}", "accept,connect";
+  permission java.net.SocketPermission "${derbyTesting.serverhost}", "connect,resolve";
+  
+  // Access all files under ${user.dir}to write the test directory structure
+  // Also covers extin, extout and extinout locations
+  permission java.io.FilePermission "${user.dir}${/}-", "read,write,delete"; 
+   
+  // Tests need to be able to exec a java program. DERBY-6295: Also give them
+  // read permission so that detailed error message is shown.
+  permission java.io.FilePermission "${java.home}${/}-", "execute, read";
+
+  // needed to create a temp file in order to open a database in a jar file
+  permission java.io.FilePermission "${java.io.tmpdir}${/}-", "read,write,delete";
+
+  // These permissions are needed to load the JCE for encryption with Sun and IBM JDK131.
+  // JDK14 has the JCE  preloaded
+  permission java.security.SecurityPermission "insertProvider.SunJCE";
+  permission java.security.SecurityPermission "insertProvider.IBMJCE";
+
+  // When running with useprocess=false need to install and uninstall
+  // the security manager and allow setIO to change the system err and out
+  // streams. Currently the nist suite runs with useprocess=false.
+  permission java.lang.RuntimePermission "setSecurityManager";
+  permission java.lang.RuntimePermission "setIO"; 
+
+  // These permissions are needed by stress.multi to dump the thread stack
+  // traces upon failure.
+  permission java.lang.RuntimePermission "getStackTrace";
+  permission java.lang.RuntimePermission "modifyThreadGroup";
+  
+    // Allow MBeanTest to register the application management MBean.
+  permission javax.management.MBeanServerPermission "createMBeanServer";
+  permission javax.management.MBeanPermission "org.apache.derby.mbeans.Management#[org.apache.derby:type=Management]","registerMBean,unregisterMBean";
+  permission javax.management.MBeanPermission "org.apache.derby.mbeans.Management#-[-]", "instantiate";
+  permission javax.management.MBeanTrustPermission "register";
+  
+  // Allows access to Derby's built-in MBeans, within the domain org.apache.derby.
+  permission javax.management.MBeanPermission "org.apache.derby.*#[org.apache.derby:*]","registerMBean,unregisterMBean";
+  
+   
+  // And to find and use Derby's MBeans
+  permission javax.management.MBeanPermission "org.apache.derby.mbeans.*#[org.apache.derby:*]", "getAttribute,setAttribute,invoke";
+  permission javax.management.MBeanPermission "org.apache.derby.mbeans.*#-[org.apache.derby:*]", "getMBeanInfo";
+  permission javax.management.MBeanPermission "-#-[-]", "queryNames";
+  permission javax.management.MBeanPermission "org.apache.derby.mbeans.*#-[org.apache.derby:*]", "queryNames";
+  
+  // Test code needs this as well for the platform MBeanServer
+  // tests where the testing code is in the stack frame.
+  permission org.apache.derby.security.SystemPermission "jmx", "control";
+  permission org.apache.derby.security.SystemPermission "engine", "monitor";
+  permission org.apache.derby.security.SystemPermission "server", "control,monitor";
+
+  // Needed by FileUtil#limitAccessToOwner
+  permission java.lang.RuntimePermission "accessUserInformation";
+  permission java.lang.RuntimePermission "getFileStoreAttributes";
+
+  // This permission is needed to call DriverManager.deregisterDriver()
+  // on Java SE 8 and later.
+  permission java.sql.SQLPermission "deregisterDriver";
+
+  // Needed by ClasspathSetup for freeing resources.
+  permission java.lang.RuntimePermission "closeClassLoader";
+};
+
+// JUnit jar file tries to read junit.properties in the user's
+// home directory and seems to require permission to read the
+// property user.home as well.
+// junit.swingui.TestRunner writes to .junitsession on exit.
+grant codeBase "${derbyTesting.junit}" {
+    permission java.util.PropertyPermission "user.home", "read";
+    permission java.io.FilePermission "${user.home}${/}junit.properties", "read";
+    permission java.io.FilePermission "${user.home}${/}.junitsession", "write";
+
+    // This permission is needed when running the tests using ant 1.7
+    permission java.io.FilePermission "${user.dir}${/}*", "write";
+};
+
+// Ant's junit runner requires setOut to redirect the System output streams
+// to the forked JVM used when running junit tests inside Ant. Ant requires
+// forking the JVM if you want to run tests in a different directory than the
+// current one.
+grant codeBase "${derbyTesting.antjunit}" {
+    permission java.lang.RuntimePermission "setIO";
+
+    // This permission is needed when running the tests using ant 1.7
+    permission java.io.FilePermission "${user.dir}${/}*", "write";
+};
+
+// Starting with Ant 1.9.3, write permission has to be granted to ant.jar
+// as well so that Ant's JUnit runner can write test results to a file.
+// Only needed when running the tests under Ant. See DERBY-6685.
+grant codeBase "${derbyTesting.ant}" {
+    permission java.io.FilePermission "${user.dir}${/}*", "write";
+};
+
+// functionTests.tests.lang.RoutineSecurityTest requires this grant
+// to check to see if permissions are granted through generated code
+// through this mechanism.
+grant {
+    permission java.util.PropertyPermission "derbyRoutineSecurityTest.yes", "read";
+};
+
+// These permissions are needed when testing code instrumented with EMMA.
+// They will only be used if the emma.active system property property is
+// set, which should be set to "" for the permissions to be correct. Must
+// be granted to all code bases because EMMA doesn't use doPrivileged
+// blocks around the code that needs the permissions.
+grant {
+  permission java.util.PropertyPermission "${emma.active}user.dir", "read";
+  permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
+  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
+};
+
+// Grant the required permissions for JaCoCo (code coverage tool).
+grant {
+  permission java.io.FilePermission "${jacoco.active}${user.dir}${/}*", "read, write";
+};
+
+// When inserting XML values that use external DTD's, the JAXP parser
+// needs permission to read the DTD files.  We assume that all DTD
+// files will be copied to extin/ by whichever tests need them.  So
+// grant the JAXP parser permissions to read that directory.
+grant codeBase "${derbyTesting.jaxpjar}" {
+  permission java.io.FilePermission "${user.dir}${/}extin${/}-", "read";
+};
+
+// Permissions for package-private tests run from 'classes.pptesting'
+grant codeBase "${derbyTesting.ppcodeclasses}" {
+
+  // Needed for ProtocolTest - allows connection to a server
+  permission java.net.SocketPermission "127.0.0.1", "connect,resolve";
+  permission java.net.SocketPermission "localhost", "connect,resolve";
+  permission java.net.SocketPermission "${derbyTesting.serverhost}", "connect,resolve";
+
+  // Allows reading support files in 'extin'
+  permission java.io.FilePermission "${user.dir}${/}extin${/}-", "read";
+};
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/resultSetReader.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/resultSetReader.policy
index a89849466..b04156fb8 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/resultSetReader.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/resultSetReader.policy
@@ -39,6 +39,7 @@ grant codeBase "${derbyTesting.codejar}derby.jar" {
   permission java.util.PropertyPermission "java.class.path", "read";//sysinfo
   permission java.util.PropertyPermission "java.runtime.version", "read";//sysinfo
   permission java.util.PropertyPermission "java.fullversion", "read";//sysinfo
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
   
   // unit tests (e.g. store/T_RecoverFullLog) set this property 
   // (called from derbyTesting.jar through code in derby.jar)
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/store/Derby3980DeadlockTest.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/store/Derby3980DeadlockTest.policy
index ad2585ac2..a85dcbb92 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/store/Derby3980DeadlockTest.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/store/Derby3980DeadlockTest.policy
@@ -55,6 +55,7 @@ grant codeBase "${derbyTesting.codejar}derby.jar" {
   permission java.util.PropertyPermission "java.class.path", "read";//sysinfo
   permission java.util.PropertyPermission "java.runtime.version", "read";//sysinfo
   permission java.util.PropertyPermission "java.fullversion", "read";//sysinfo
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
   
   // unit tests (e.g. store/T_RecoverFullLog) set this property 
   // (called from derbyTesting.jar through code in derby.jar)
diff --git a/java/testing/org/apache/derbyTesting/functionTests/util/PropertyUtil.java b/java/testing/org/apache/derbyTesting/functionTests/util/PropertyUtil.java
index 186e4a366..0dba37626 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/util/PropertyUtil.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/util/PropertyUtil.java
@@ -20,6 +20,11 @@
  */
 
 package org.apache.derbyTesting.functionTests.util;
+
+import java.security.AccessController;
+import java.security.PrivilegedAction;
+
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.sql.conn.LanguageConnectionContext;
 import java.io.Serializable;
@@ -31,15 +36,41 @@ public abstract class PropertyUtil extends org.apache.derby.iapi.util.PropertyUt
 	public static Serializable getDatabasePropertyDefault(String k) throws Exception
 	{
         LanguageConnectionContext lcc =
-			(LanguageConnectionContext) ContextService.getContextOrNull(LanguageConnectionContext.CONTEXT_ID);
+			(LanguageConnectionContext) getContextOrNull(LanguageConnectionContext.CONTEXT_ID);
 		if (lcc == null) throw new Exception("getPropertyDefault only works in a connection");
 		return lcc.getTransactionExecute().getPropertyDefault(k);
 	}
 	public static void setDatabasePropertyDefault(String k,Serializable v) throws Exception
 	{
         LanguageConnectionContext lcc =
-			(LanguageConnectionContext) ContextService.getContextOrNull(LanguageConnectionContext.CONTEXT_ID);
+			(LanguageConnectionContext) getContextOrNull(LanguageConnectionContext.CONTEXT_ID);
 		if (lcc == null) throw new Exception("getPropertyDefault only works in a connection");
 		lcc.getTransactionExecute().setPropertyDefault(k,v);
 	}
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContextOrNull( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContextOrNull( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContextOrNull( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/testing/org/apache/derbyTesting/functionTests/util/T_ConsistencyChecker.java b/java/testing/org/apache/derbyTesting/functionTests/util/T_ConsistencyChecker.java
index 32b8ccbc6..eb0d15c31 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/util/T_ConsistencyChecker.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/util/T_ConsistencyChecker.java
@@ -21,9 +21,12 @@
 
 package org.apache.derbyTesting.functionTests.util;
 
+import java.security.AccessController;
+import java.security.PrivilegedAction;
 
 import org.apache.derby.iapi.error.StandardException;
 import org.apache.derby.iapi.reference.SQLState;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.services.io.FormatableBitSet;
 import org.apache.derby.iapi.sql.conn.LanguageConnectionContext;
@@ -239,7 +242,7 @@ public class T_ConsistencyChecker
 		throws StandardException
 	{
 		lcc = (LanguageConnectionContext)
-			ContextService.getContext(LanguageConnectionContext.CONTEXT_ID);
+			getContext(LanguageConnectionContext.CONTEXT_ID);
 		tc = lcc.getTransactionExecute();
 
 		dd = lcc.getDataDictionary();
@@ -455,7 +458,7 @@ public class T_ConsistencyChecker
         TransactionController   tc;
 
         lcc = (LanguageConnectionContext)
-            ContextService.getContext(LanguageConnectionContext.CONTEXT_ID);
+           getContext(LanguageConnectionContext.CONTEXT_ID);
         tc = lcc.getTransactionExecute();
 
         numOpens = tc.countOpens(TransactionController.OPEN_TOTAL);
@@ -489,7 +492,7 @@ public class T_ConsistencyChecker
         StringBuffer            debugBuf = new StringBuffer();
 
         LanguageConnectionContext lcc = (LanguageConnectionContext)
-             ContextService.getContext(LanguageConnectionContext.CONTEXT_ID);
+             getContext(LanguageConnectionContext.CONTEXT_ID);
 
         dd = lcc.getDataDictionary();
         dm = dd.getDependencyManager();
@@ -507,4 +510,30 @@ public class T_ConsistencyChecker
 
         return debugBuf.toString();
     }
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContext( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContext( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContext( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/testing/org/apache/derbyTesting/functionTests/util/derby_tests.policy b/java/testing/org/apache/derbyTesting/functionTests/util/derby_tests.policy
index e1cf35005..3fb727159 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/util/derby_tests.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/util/derby_tests.policy
@@ -55,6 +55,7 @@ grant codeBase "${derbyTesting.codejar}derby.jar" {
   permission java.util.PropertyPermission "java.class.path", "read";//sysinfo
   permission java.util.PropertyPermission "java.runtime.version", "read";//sysinfo
   permission java.util.PropertyPermission "java.fullversion", "read";//sysinfo
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
   
   // unit tests (e.g. store/T_RecoverFullLog) set this property 
   // (called from derbyTesting.jar through code in derby.jar)
@@ -241,6 +242,9 @@ grant codeBase "${derbyTesting.testjar}derbyTesting.jar" {
   // Access all properties using System.getProperties
   permission java.util.PropertyPermission "*", "read, write";
   
+  // Need by various tests which call the ContextService
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
+
   // Access all files under ${user.dir}to write the test directory structure
   permission java.io.FilePermission "${user.dir}${/}-", "read,write,delete"; 
 
diff --git a/java/testing/org/apache/derbyTesting/unitTests/harness/BasicUnitTestManager.java b/java/testing/org/apache/derbyTesting/unitTests/harness/BasicUnitTestManager.java
index dc67e4370..6a4379e07 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/harness/BasicUnitTestManager.java
+++ b/java/testing/org/apache/derbyTesting/unitTests/harness/BasicUnitTestManager.java
@@ -28,6 +28,8 @@ import org.apache.derby.iapi.error.StandardException;
 import org.apache.derby.iapi.services.monitor.Monitor;
 import org.apache.derby.shared.common.sanity.SanityManager;
 import org.apache.derby.iapi.services.stream.HeaderPrintWriter;
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.util.Date;
 import java.util.Enumeration;
 import java.util.Properties;
@@ -70,7 +72,7 @@ public class BasicUnitTestManager implements UnitTestManager, ModuleControl
 
 		output = Monitor.getStream();
 
-		contextService = ContextService.getFactory();
+		contextService = getContextService();
 
 		this.currentOutput = output;
 
@@ -285,5 +287,31 @@ public class BasicUnitTestManager implements UnitTestManager, ModuleControl
 		this.performanceReportOn = performanceReportOn;
 		return;
 	}	
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
 
diff --git a/java/testing/org/apache/derbyTesting/unitTests/harness/T_Bomb.java b/java/testing/org/apache/derbyTesting/unitTests/harness/T_Bomb.java
index 921eec0d7..44c3c38d2 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/harness/T_Bomb.java
+++ b/java/testing/org/apache/derbyTesting/unitTests/harness/T_Bomb.java
@@ -26,6 +26,8 @@ import org.apache.derby.iapi.services.context.ContextService;
 
 import org.apache.derby.iapi.services.context.Context;
 
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.util.Vector;
 
 public class T_Bomb implements Runnable { 
@@ -115,7 +117,7 @@ public class T_Bomb implements Runnable {
 	private void blowUp()
 	{
 			performLastGasp();
-			ContextService csf = ContextService.getFactory();
+			ContextService csf = getContextService();
 			if (csf != null)
 			{
 				System.out.println("ran out of time");
@@ -146,4 +148,30 @@ public class T_Bomb implements Runnable {
 		} //end for
 
 	}
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/testing/org/apache/derbyTesting/unitTests/junit/MissingPermissionsTest.policy b/java/testing/org/apache/derbyTesting/unitTests/junit/MissingPermissionsTest.policy
index ec64bfeac..9fa40b43a 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/junit/MissingPermissionsTest.policy
+++ b/java/testing/org/apache/derbyTesting/unitTests/junit/MissingPermissionsTest.policy
@@ -23,6 +23,7 @@ grant codeBase "${derbyTesting.codejar}derby.jar"
   permission java.lang.RuntimePermission "setSecurityManager";
   permission java.util.PropertyPermission "derby.*", "read";
   permission java.util.PropertyPermission "user.dir", "read";
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
 
   // The next two properties are used to determine if the VM is 32 or 64 bit.
   //
diff --git a/java/testing/org/apache/derbyTesting/unitTests/junit/MissingPermissionsTest1.policy b/java/testing/org/apache/derbyTesting/unitTests/junit/MissingPermissionsTest1.policy
index 5ccfb92f5..d0454878f 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/junit/MissingPermissionsTest1.policy
+++ b/java/testing/org/apache/derbyTesting/unitTests/junit/MissingPermissionsTest1.policy
@@ -21,6 +21,7 @@ grant codeBase "${derbyTesting.codejar}derby.jar"
   //
   permission java.lang.RuntimePermission "createClassLoader";
   permission java.lang.RuntimePermission "setSecurityManager";
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
   //
   // **** Removed these for this test:
   //      permission java.util.PropertyPermission "derby.*", "read";
diff --git a/java/testing/org/apache/derbyTesting/unitTests/junit/MissingPermissionsTest2.policy b/java/testing/org/apache/derbyTesting/unitTests/junit/MissingPermissionsTest2.policy
index 5cf5cf2c9..637aae4f6 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/junit/MissingPermissionsTest2.policy
+++ b/java/testing/org/apache/derbyTesting/unitTests/junit/MissingPermissionsTest2.policy
@@ -23,6 +23,7 @@ grant codeBase "${derbyTesting.codejar}derby.jar"
   permission java.lang.RuntimePermission "setSecurityManager";
   permission java.util.PropertyPermission "derby.*", "read";
   permission java.util.PropertyPermission "user.dir", "read";
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
 
   // The next two properties are used to determine if the VM is 32 or 64 bit.
   //
diff --git a/java/testing/org/apache/derbyTesting/unitTests/junit/SystemPrivilegesPermissionTest.policy b/java/testing/org/apache/derbyTesting/unitTests/junit/SystemPrivilegesPermissionTest.policy
index 4f8e3df2e..f12b97ba4 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/junit/SystemPrivilegesPermissionTest.policy
+++ b/java/testing/org/apache/derbyTesting/unitTests/junit/SystemPrivilegesPermissionTest.policy
@@ -89,6 +89,7 @@ grant codeBase "${derbyTesting.testjar}derbyTesting.jar" {
 grant codeBase "${derbyTesting.codejar}derby.jar" {
   // System Privileges framework needs to run "doAsPrivileged"
   //permission javax.security.auth.AuthPermission "doAsPrivileged";
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
 
   // System Privileges framework needs to resolve relative directory names,
   // which requires a property-read permission
diff --git a/java/testing/org/apache/derbyTesting/unitTests/junit/SystemPrivilegesPermissionTest1.policy b/java/testing/org/apache/derbyTesting/unitTests/junit/SystemPrivilegesPermissionTest1.policy
index c662909dc..d7ef67278 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/junit/SystemPrivilegesPermissionTest1.policy
+++ b/java/testing/org/apache/derbyTesting/unitTests/junit/SystemPrivilegesPermissionTest1.policy
@@ -69,6 +69,7 @@ grant codeBase "${derbyTesting.testjar}derbyTesting.jar" {
 grant codeBase "${derbyTesting.codejar}derby.jar" {
   // System Privileges framework needs to run "doAsPrivileged"
   //permission javax.security.auth.AuthPermission "doAsPrivileged";
+  permission org.apache.derby.security.SystemPermission "engine", "usederbyinternals";
 
   // System Privileges framework needs to resolve relative directory names,
   // which requires a property-read permission
diff --git a/java/testing/org/apache/derbyTesting/unitTests/store/T_AccessFactory.java b/java/testing/org/apache/derbyTesting/unitTests/store/T_AccessFactory.java
index c68d5e59b..fc462b780 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/store/T_AccessFactory.java
+++ b/java/testing/org/apache/derbyTesting/unitTests/store/T_AccessFactory.java
@@ -46,6 +46,8 @@ import org.apache.derby.iapi.reference.Property;
 import org.apache.derby.iapi.reference.SQLState;
 import org.apache.derby.iapi.services.io.FormatableBitSet;
 import org.apache.derby.iapi.services.i18n.MessageService;
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.io.Serializable;
 import java.util.Hashtable;
 import java.util.Properties;
@@ -119,7 +121,7 @@ public class T_AccessFactory extends T_Generic
 		try {
 
             ContextManager cm = 
-                    ContextService.getFactory().getCurrentContextManager();
+                    getContextService().getCurrentContextManager();
 
 			tc = store.getAndNameTransaction(
                     cm, AccessFactoryGlobals.USER_TRANS_NAME);
@@ -2980,7 +2982,7 @@ public class T_AccessFactory extends T_Generic
 
         TransactionController current_xact = 
             store.getTransaction(
-                ContextService.getFactory().getCurrentContextManager());
+                getContextService().getCurrentContextManager());
 
         // get a nested user transaction
         TransactionController child_tc = 
@@ -2988,7 +2990,7 @@ public class T_AccessFactory extends T_Generic
 
         TransactionController current_xact_after_nest = 
             store.getTransaction(
-                ContextService.getFactory().getCurrentContextManager());
+                getContextService().getCurrentContextManager());
 
         if (current_xact_after_nest != current_xact)
         {
@@ -3337,9 +3339,9 @@ public class T_AccessFactory extends T_Generic
 
 
 		// get another transaction going
-		ContextManager cm2 = ContextService.getFactory().newContextManager();
+		ContextManager cm2 = getContextService().newContextManager();
 
-		ContextService.getFactory().setCurrentContextManager(cm2);
+		getContextService().setCurrentContextManager(cm2);
 
 		TransactionController tc2 = null;
 		ConglomerateController cc2 = null;
@@ -3368,7 +3370,7 @@ public class T_AccessFactory extends T_Generic
 				throw lfe;
 		}
 		finally {
-			ContextService.getFactory().resetCurrentContextManager(cm2);
+			getContextService().resetCurrentContextManager(cm2);
 		}
 
 
@@ -3382,7 +3384,7 @@ public class T_AccessFactory extends T_Generic
 		// now really commit the transaction
 		tc.commit();
 		
-		ContextService.getFactory().setCurrentContextManager(cm2);
+		getContextService().setCurrentContextManager(cm2);
 
 		try {
 		cc2.fetch(rowloc, r1.getRowArray(), (FormatableBitSet)null);
@@ -3391,7 +3393,7 @@ public class T_AccessFactory extends T_Generic
 		tc2.destroy();
 		}
 		finally {
-			ContextService.getFactory().resetCurrentContextManager(cm2);
+			getContextService().resetCurrentContextManager(cm2);
 		}
 
 		REPORT("(commitTest) succeeded");
@@ -4367,4 +4369,30 @@ public class T_AccessFactory extends T_Generic
 		return s;
 	}
 
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/testing/org/apache/derbyTesting/unitTests/store/T_FileSystemData.java b/java/testing/org/apache/derbyTesting/unitTests/store/T_FileSystemData.java
index 23ba7be5f..d02775a49 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/store/T_FileSystemData.java
+++ b/java/testing/org/apache/derbyTesting/unitTests/store/T_FileSystemData.java
@@ -44,6 +44,8 @@ import org.apache.derby.iapi.store.access.conglomerate.LogicalUndo;
 import org.apache.derby.iapi.reference.Property;
 
 import java.io.*;
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.util.Properties;
 /**
 	An Impl unittest for rawstore data that is based on the FileSystem
@@ -87,7 +89,7 @@ public class T_FileSystemData extends T_MultiThreadedIterations {
 		 throws StandardException
 	{
 		super.boot(create, startParams);
-		contextService = ContextService.getFactory();
+		contextService = getContextService();
 	}
 
 
@@ -1105,4 +1107,30 @@ public class T_FileSystemData extends T_MultiThreadedIterations {
 			return;
         }
 	}
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/testing/org/apache/derbyTesting/unitTests/store/T_Heap.java b/java/testing/org/apache/derbyTesting/unitTests/store/T_Heap.java
index cef465507..0cbfc7cbd 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/store/T_Heap.java
+++ b/java/testing/org/apache/derbyTesting/unitTests/store/T_Heap.java
@@ -46,6 +46,8 @@ import org.apache.derby.iapi.store.access.TransactionController;
 
 import org.apache.derby.iapi.reference.Property;
 
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.util.Properties;
 
 public class T_Heap extends T_Generic
@@ -96,7 +98,7 @@ public class T_Heap extends T_Generic
 		try {
 
             tc = store.getTransaction(
-                    ContextService.getFactory().getCurrentContextManager());
+                    getContextService().getCurrentContextManager());
 
             if (t_001(tc))
 			{
@@ -145,4 +147,30 @@ public class T_Heap extends T_Generic
 
         return(test_result);
     }
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/testing/org/apache/derbyTesting/unitTests/store/T_RawStoreFactory.java b/java/testing/org/apache/derbyTesting/unitTests/store/T_RawStoreFactory.java
index 829f49868..f4a21ea87 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/store/T_RawStoreFactory.java
+++ b/java/testing/org/apache/derbyTesting/unitTests/store/T_RawStoreFactory.java
@@ -59,6 +59,8 @@ import org.apache.derby.iapi.reference.Property;
 import org.apache.derby.iapi.services.io.FormatableBitSet;
 
 import java.io.*;
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.util.Properties;
 
 /**
@@ -120,7 +122,7 @@ public class T_RawStoreFactory extends T_MultiThreadedIterations {
 		 throws StandardException
 	{
 		super.boot(create, startParams);
-		contextService = ContextService.getFactory();
+		contextService = getContextService();
 	}
 
 	/*
@@ -7633,5 +7635,31 @@ public class T_RawStoreFactory extends T_MultiThreadedIterations {
 		PASS(testInfo);
 	}
 
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
 
diff --git a/java/testing/org/apache/derbyTesting/unitTests/store/T_RecoverBadLog.java b/java/testing/org/apache/derbyTesting/unitTests/store/T_RecoverBadLog.java
index 796d9ecfa..ce5bd5475 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/store/T_RecoverBadLog.java
+++ b/java/testing/org/apache/derbyTesting/unitTests/store/T_RecoverBadLog.java
@@ -51,6 +51,8 @@ import org.apache.derby.iapi.store.access.Qualifier;
 import java.io.IOException;
 import java.io.RandomAccessFile;
 import java.io.File;
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.util.Properties;
 
 
@@ -226,7 +228,7 @@ public class T_RecoverBadLog extends T_Generic {
 		}
 
 		try {
-			contextService = ContextService.getFactory();
+			contextService = getContextService();
 
 			File ifile = new File(infoPath);
 
@@ -1827,6 +1829,32 @@ public class T_RecoverBadLog extends T_Generic {
 		
 	}
 
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
 
 
diff --git a/java/testing/org/apache/derbyTesting/unitTests/store/T_RecoverFullLog.java b/java/testing/org/apache/derbyTesting/unitTests/store/T_RecoverFullLog.java
index 0c4de75b1..5678d2fde 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/store/T_RecoverFullLog.java
+++ b/java/testing/org/apache/derbyTesting/unitTests/store/T_RecoverFullLog.java
@@ -51,6 +51,8 @@ import org.apache.derby.iapi.store.access.conglomerate.LogicalUndo;
 import java.io.IOException;
 import java.io.RandomAccessFile;
 import java.io.File;
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.util.Properties;
 
 
@@ -165,7 +167,7 @@ public class T_RecoverFullLog extends T_Generic {
 
 		try {
 
-			contextService = ContextService.getFactory();
+			contextService = getContextService();
 
 			File ifile = new File(infoPath);
 			
@@ -862,6 +864,32 @@ public class T_RecoverFullLog extends T_Generic {
 	}
 
 
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 
 }
 
diff --git a/java/testing/org/apache/derbyTesting/unitTests/store/T_Recovery.java b/java/testing/org/apache/derbyTesting/unitTests/store/T_Recovery.java
index dceab6e28..932e1f021 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/store/T_Recovery.java
+++ b/java/testing/org/apache/derbyTesting/unitTests/store/T_Recovery.java
@@ -59,6 +59,8 @@ import org.apache.derby.iapi.reference.Attribute;
 import org.apache.derby.iapi.services.io.FormatableBitSet;
 
 import java.io.*;
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.util.Properties;
 
 
@@ -174,7 +176,7 @@ public class T_Recovery extends T_Generic {
 			// see if we are testing encryption
 			startParams = T_Util.setEncryptionParam(startParams);
 
-			contextService = ContextService.getFactory();
+			contextService = getContextService();
 
 			if (testRecovery)
 			{
@@ -4085,6 +4087,32 @@ public class T_Recovery extends T_Generic {
 
 	}
 
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
 
 
diff --git a/java/testing/org/apache/derbyTesting/unitTests/store/T_SortController.java b/java/testing/org/apache/derbyTesting/unitTests/store/T_SortController.java
index db6733386..d9b49ab5d 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/store/T_SortController.java
+++ b/java/testing/org/apache/derbyTesting/unitTests/store/T_SortController.java
@@ -144,7 +144,7 @@ public class T_SortController extends T_Generic
 		}
 
 		tc = store.getTransaction(
-                ContextService.getFactory().getCurrentContextManager());
+                getContextService().getCurrentContextManager());
 
 		if (!sortExample(tc))
 			failcount++;
@@ -838,6 +838,32 @@ public class T_SortController extends T_Generic
 
 		return (!mismatch && !toofew && !toomany);
 	}
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
 
 
diff --git a/java/testing/org/apache/derbyTesting/unitTests/store/T_StreamFile.java b/java/testing/org/apache/derbyTesting/unitTests/store/T_StreamFile.java
index 16dca21df..feabed14d 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/store/T_StreamFile.java
+++ b/java/testing/org/apache/derbyTesting/unitTests/store/T_StreamFile.java
@@ -50,6 +50,8 @@ import org.apache.derby.iapi.services.io.FormatableBitSet;
 import org.apache.derby.iapi.services.io.DynamicByteArrayOutputStream;
 
 import java.io.*;
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.util.Properties;
 
 /**
@@ -92,7 +94,7 @@ public class T_StreamFile extends T_MultiThreadedIterations {
 	public void boot(boolean create, Properties startParams)
 		 throws StandardException {
 		super.boot(create, startParams);
-		contextService = ContextService.getFactory();
+		contextService = getContextService();
 	}
 
 
@@ -389,4 +391,30 @@ public class T_StreamFile extends T_MultiThreadedIterations {
 		
 		PASS("SF002");
 	}
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
diff --git a/java/testing/org/apache/derbyTesting/unitTests/store/T_XA.java b/java/testing/org/apache/derbyTesting/unitTests/store/T_XA.java
index 5c68f6374..d9a4d5571 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/store/T_XA.java
+++ b/java/testing/org/apache/derbyTesting/unitTests/store/T_XA.java
@@ -42,6 +42,8 @@ import org.apache.derby.iapi.services.io.FormatIdUtil;
 
 import org.apache.derby.iapi.error.StandardException; 
 
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.util.Properties; 
 
 import javax.transaction.xa.XAResource;
@@ -179,7 +181,7 @@ public class T_XA extends T_Generic
         REPORT("(XATest_1) starting");
 
         ContextManager cm = 
-                ContextService.getFactory().getCurrentContextManager();
+                getContextService().getCurrentContextManager();
 
         // COMMIT AN IDLE TRANSACTION.
 
@@ -272,7 +274,7 @@ public class T_XA extends T_Generic
     {
         REPORT("(XATest_2) starting");
         ContextManager cm = 
-                ContextService.getFactory().getCurrentContextManager();
+                getContextService().getCurrentContextManager();
 
         // COMMIT AN IDLE TRANSACTION.
 
@@ -437,7 +439,7 @@ public class T_XA extends T_Generic
         REPORT("(XATest_3) starting");
 
         ContextManager cm = 
-                ContextService.getFactory().getCurrentContextManager();
+                getContextService().getCurrentContextManager();
 
         // ABORT AN IDLE TRANSACTION.
 
@@ -557,7 +559,7 @@ public class T_XA extends T_Generic
         REPORT("(XATest_4) starting");
 
         ContextManager cm = 
-                ContextService.getFactory().getCurrentContextManager();
+                getContextService().getCurrentContextManager();
 
         // ABORT AN IDLE TRANSACTION.
 
@@ -827,7 +829,7 @@ public class T_XA extends T_Generic
         }
 
         ContextManager cm = 
-                ContextService.getFactory().getCurrentContextManager();
+                getContextService().getCurrentContextManager();
 
         // COMMIT AN IDLE TRANSACTION.
 
@@ -1068,7 +1070,7 @@ public class T_XA extends T_Generic
         REPORT("(XATest_5) starting");
 
         ContextManager cm = 
-                ContextService.getFactory().getCurrentContextManager();
+                getContextService().getCurrentContextManager();
 
         TransactionController   tc = store.getTransaction(cm);
 
@@ -1180,6 +1182,32 @@ public class T_XA extends T_Generic
         REPORT("(XATest_6) finishing");
     }
 
+    
+    /**
+     * Privileged lookup of the ContextService. Package protected so that user code
+     * can't call this entry point.
+     */
+    static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+
 }
 
 class commit_method
@@ -1230,10 +1258,10 @@ class commit_method
 
                 SanityManager.ASSERT(
                     cm == 
-                    ContextService.getFactory().getCurrentContextManager(),
+                    T_XA.getContextService().getCurrentContextManager(),
                     "cm = " + cm +
                     "current = " + 
-                        ContextService.getFactory().getCurrentContextManager());
+                        T_XA.getContextService().getCurrentContextManager());
             }
 
             ((XAResourceManager) store.getXAResourceManager()).commit(
@@ -1275,10 +1303,10 @@ class commit_method
 
                 SanityManager.ASSERT(
                     cm == 
-                    ContextService.getFactory().getCurrentContextManager(),
+                    T_XA.getContextService().getCurrentContextManager(),
                     "cm = " + cm +
                     "current = " + 
-                        ContextService.getFactory().getCurrentContextManager());
+                        T_XA.getContextService().getCurrentContextManager());
             }
 
             ((XAResourceManager) store.getXAResourceManager()).rollback(
diff --git a/java/testing/org/apache/derbyTesting/unitTests/store/T_b2i.java b/java/testing/org/apache/derbyTesting/unitTests/store/T_b2i.java
index cf9f74cb1..be95caeb9 100644
--- a/java/testing/org/apache/derbyTesting/unitTests/store/T_b2i.java
+++ b/java/testing/org/apache/derbyTesting/unitTests/store/T_b2i.java
@@ -39,6 +39,7 @@ import org.apache.derby.iapi.services.monitor.Monitor;
 
 import org.apache.derby.shared.common.sanity.SanityManager;
 import org.apache.derby.iapi.services.stream.HeaderPrintWriter;
+import org.apache.derby.iapi.services.context.Context;
 import org.apache.derby.iapi.services.context.ContextService;
 import org.apache.derby.iapi.services.context.ContextManager;
 import org.apache.derby.iapi.services.io.FormatIdUtil;
@@ -68,6 +69,8 @@ import org.apache.derby.impl.store.access.conglomerate.TemplateRow;
 import org.apache.derby.iapi.types.SQLChar;
 
 
+import java.security.PrivilegedAction;
+import java.security.AccessController;
 import java.util.Properties;
 
 
@@ -111,7 +114,7 @@ public class T_b2i extends T_MultiIterations
 			store_module = Monitor.createPersistentService(
 				getModuleToTestProtocolName(), testService, startParams);
 			
-			contextService = ContextService.getFactory();
+			contextService = getContextService();
 
 		} catch (StandardException mse) {
 			throw T_Fail.exceptionFail(mse);
@@ -855,7 +858,7 @@ public class T_b2i extends T_MultiIterations
             }
             catch (StandardException e)
             {
-                ContextService contextFactory = ContextService.getFactory();
+                ContextService contextFactory = getContextService();
 
                 // Get the context manager.
                 ContextManager cm = contextFactory.getCurrentContextManager();
@@ -3261,7 +3264,7 @@ public class T_b2i extends T_MultiIterations
 					throw e;
 
                 ContextService contextFactory = 
-                    ContextService.getFactory();
+                    getContextService();
 
                 // Get the context manager.
                 ContextManager cm = contextFactory.getCurrentContextManager();
@@ -5096,12 +5099,64 @@ public class T_b2i extends T_MultiIterations
      * @return {@code true} if the database is active, {@code false} otherwise
      */
     public boolean isdbActive() {
-        LanguageConnectionContext lcc = (LanguageConnectionContext) ContextService
-                .getContextOrNull(LanguageConnectionContext.CONTEXT_ID);
+        LanguageConnectionContext lcc = (LanguageConnectionContext)
+                getContextOrNull(LanguageConnectionContext.CONTEXT_ID);
         Database db = (Database) (lcc != null ? lcc.getDatabase() : null);
         return (db != null ? db.isActive() : false);
     }
 
+    
+    /**
+     * Privileged lookup of the ContextService. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  ContextService    getContextService()
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getFactory();
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<ContextService>()
+                 {
+                     public ContextService run()
+                     {
+                         return ContextService.getFactory();
+                     }
+                 }
+                 );
+        }
+    }
+    
+    /**
+     * Privileged lookup of a Context. Must be private so that user code
+     * can't call this entry point.
+     */
+    private  static  Context    getContextOrNull( final String contextID )
+    {
+        if ( System.getSecurityManager() == null )
+        {
+            return ContextService.getContextOrNull( contextID );
+        }
+        else
+        {
+            return AccessController.doPrivileged
+                (
+                 new PrivilegedAction<Context>()
+                 {
+                     public Context run()
+                     {
+                         return ContextService.getContextOrNull( contextID );
+                     }
+                 }
+                 );
+        }
+    }
+
+
 }
 
 class T_CreateConglomRet 
