diff --git a/java/engine/org/apache/derby/iapi/error/StandardException.java b/java/engine/org/apache/derby/iapi/error/StandardException.java
index c11484b7e..26fc9533c 100644
--- a/java/engine/org/apache/derby/iapi/error/StandardException.java
+++ b/java/engine/org/apache/derby/iapi/error/StandardException.java
@@ -657,6 +657,19 @@ public class StandardException extends Exception
         return(SQLState.LOCK_TIMEOUT.equals(getSQLState()));
     }
 
+    /**
+     * Is this a self-deadlock exception caused by a nested transaction
+     * being blocked by its parent's locks.
+     * <p>
+     *
+     * @return true if this exception is a self-deadlock.
+     *
+     **/
+    public final boolean isSelfDeadlock() {
+
+        return(SQLState.SELF_DEADLOCK.equals(getSQLState()));
+    }
+
     /**
      * Is this a lock timeout or lock deadlock exception.
      * <p>
diff --git a/java/engine/org/apache/derby/iapi/services/locks/LockOwner.java b/java/engine/org/apache/derby/iapi/services/locks/LockOwner.java
index 967d18ef0..1955910ce 100644
--- a/java/engine/org/apache/derby/iapi/services/locks/LockOwner.java
+++ b/java/engine/org/apache/derby/iapi/services/locks/LockOwner.java
@@ -51,4 +51,20 @@ public interface LockOwner {
      * {@code false} otherwise
      */
     boolean noWait();
+
+
+    /**
+     * <p>
+     * Return true if this is a nested owner, e.g., a nested user transaction.
+     * </p>
+     */
+    public boolean isNestedOwner();
+
+    /**
+     * <p>
+     * Return true if this owner nests under another owner.
+     * </p>
+     */
+    public boolean nestsUnder( LockOwner other );
+
 }
diff --git a/java/engine/org/apache/derby/iapi/sql/dictionary/SPSDescriptor.java b/java/engine/org/apache/derby/iapi/sql/dictionary/SPSDescriptor.java
index 36fef1aba..017763c6c 100644
--- a/java/engine/org/apache/derby/iapi/sql/dictionary/SPSDescriptor.java
+++ b/java/engine/org/apache/derby/iapi/sql/dictionary/SPSDescriptor.java
@@ -750,7 +750,10 @@ public class SPSDescriptor extends UniqueSQLObjectDescriptor
                         nestedTC.rollbackToSavePoint(savepoint, false, null);
                     }
 
-                    if (nestedTC != null && se.isLockTimeout())
+                    if (
+                        (nestedTC != null) &&
+                        ( se.isLockTimeout() || se.isSelfDeadlock() )
+                        )
 					{
                         // Locks were set nowait, so a lock timeout here
                         // means that some lock request in the nested 
diff --git a/java/engine/org/apache/derby/iapi/store/raw/RawStoreFactory.java b/java/engine/org/apache/derby/iapi/store/raw/RawStoreFactory.java
index 409534704..664353952 100644
--- a/java/engine/org/apache/derby/iapi/store/raw/RawStoreFactory.java
+++ b/java/engine/org/apache/derby/iapi/store/raw/RawStoreFactory.java
@@ -660,6 +660,7 @@ public interface RawStoreFactory extends Corruptable {
         context is popped off the stack.
         </UL>
 
+        @param parentTransaction parent transaction
         @param compatibilitySpace compatibility space to use for locks.
         @param contextMgr is the context manager to use.  An exception will be
         thrown if context is not the current context.
@@ -674,6 +675,7 @@ public interface RawStoreFactory extends Corruptable {
     */
 
     public Transaction startNestedReadOnlyUserTransaction(
+    Transaction parentTransaction,
     CompatibilitySpace compatibilitySpace,
     ContextManager contextMgr,
     String         transName)
@@ -720,6 +722,7 @@ public interface RawStoreFactory extends Corruptable {
         context is popped off the stack.
         </UL>
 
+        @param parentTransaction parent transaction
         @param contextMgr is the context manager to use.  An exception will be
         thrown if context is not the current context.
         @param transName is the name of the transaction. This name will be 
@@ -737,6 +740,7 @@ public interface RawStoreFactory extends Corruptable {
     */
 
     public Transaction startNestedUpdateUserTransaction(
+    Transaction parentTransaction,
     ContextManager contextMgr,
     String         transName,
     boolean        flush_log_on_xact_end)
diff --git a/java/engine/org/apache/derby/iapi/store/raw/xact/TransactionFactory.java b/java/engine/org/apache/derby/iapi/store/raw/xact/TransactionFactory.java
index a9676b84a..948d14732 100644
--- a/java/engine/org/apache/derby/iapi/store/raw/xact/TransactionFactory.java
+++ b/java/engine/org/apache/derby/iapi/store/raw/xact/TransactionFactory.java
@@ -95,6 +95,8 @@ public interface TransactionFactory extends Corruptable {
         method will push a transaction context as described in
         RawStoreFactory.startNestedTransaction
 
+		@param rsf                      the RawStoreFactory
+		@param parentTransaction   the parent transaction
 		@param compatibilitySpace   compatibility space to use for locks.
         @param contextMgr           is the context manager to use.  It must be 
                                     the current context manager.
@@ -107,6 +109,7 @@ public interface TransactionFactory extends Corruptable {
 	*/
 	public RawTransaction startNestedReadOnlyUserTransaction(
     RawStoreFactory rsf,
+    RawTransaction parentTransaction,
     CompatibilitySpace compatibilitySpace,
     ContextManager  contextMgr,
     String          transName)
@@ -117,6 +120,8 @@ public interface TransactionFactory extends Corruptable {
         will push a transaction context as described in
         RawStoreFactory.startNestedTransaction
 
+		@param rsf                      the RawStoreFactory
+		@param parentTransaction   the parent transaction
         @param contextMgr               is the context manager to use.  It must
                                         be the current context manager.
         @param transName                is the transaction name. It will be 
@@ -134,6 +139,7 @@ public interface TransactionFactory extends Corruptable {
 	*/
 	public RawTransaction startNestedUpdateUserTransaction(
     RawStoreFactory rsf,
+    RawTransaction parentTransaction,
     ContextManager  contextMgr,
     String          transName,
     boolean         flush_log_on_xact_end)
diff --git a/java/engine/org/apache/derby/impl/services/locks/ConcurrentLockSet.java b/java/engine/org/apache/derby/impl/services/locks/ConcurrentLockSet.java
index 6578327e5..4efb452ab 100644
--- a/java/engine/org/apache/derby/impl/services/locks/ConcurrentLockSet.java
+++ b/java/engine/org/apache/derby/impl/services/locks/ConcurrentLockSet.java
@@ -319,6 +319,7 @@ final class ConcurrentLockSet implements LockTable {
 		LockControl control;
 		Lock lockItem;
         String  lockDebug = null;
+        boolean blockedByParent = false;
 
         Entry entry = getEntry(ref);
         try {
@@ -355,12 +356,23 @@ final class ConcurrentLockSet implements LockTable {
 				return lockItem;
 			}
 
-			if (AbstractPool.noLockWait(timeout, compatibilitySpace)) {
-
+            //
+            // This logic supports the use-case of DERBY-6554.
+            //
+            blockedByParent =
+                (timeout == 0) &&
+                compatibilitySpace.getOwner().isNestedOwner() &&
+                control.blockedByParent( lockItem );
+
+			if (
+                AbstractPool.noLockWait(timeout, compatibilitySpace) ||
+                blockedByParent
+                )
+            {
     			// remove all trace of lock
     			control.giveUpWait(lockItem, this);
 
-                if (SanityManager.DEBUG) 
+               if (SanityManager.DEBUG) 
                 {
                     if (SanityManager.DEBUG_ON("DeadlockTrace"))
                     {
@@ -391,11 +403,17 @@ final class ConcurrentLockSet implements LockTable {
                     }
                 }
 
-				return null;
+               return null;
 			}
 
         } finally {
             entry.unlock();
+            
+            if ( blockedByParent )
+            {
+                throw StandardException.newException
+                    ( SQLState.SELF_DEADLOCK );
+            }
         }
 
 		boolean deadlockWait = false;
diff --git a/java/engine/org/apache/derby/impl/services/locks/LockControl.java b/java/engine/org/apache/derby/impl/services/locks/LockControl.java
index f4200260e..e5814c940 100644
--- a/java/engine/org/apache/derby/impl/services/locks/LockControl.java
+++ b/java/engine/org/apache/derby/impl/services/locks/LockControl.java
@@ -24,6 +24,7 @@ package org.apache.derby.impl.services.locks;
 import org.apache.derby.iapi.services.locks.CompatibilitySpace;
 import org.apache.derby.iapi.services.locks.Lockable;
 import org.apache.derby.iapi.services.locks.Latch;
+import org.apache.derby.iapi.services.locks.LockOwner;
 
 import org.apache.derby.shared.common.sanity.SanityManager;
 
@@ -599,6 +600,42 @@ final class LockControl implements Control {
 		return null;
 	}
 
+    /**
+     * <p>
+     * Returns true if the childLock is blocked because its parent owns
+     * a conficting lock.
+     * This code was written to support the fix to DERBY-6554. The only known
+     * way that this condition arises is when a write attempt by a nested user
+     * transaction is blocked by a read lock held by the main transaction.
+     * This only happens while trying to write to SYS.SYSSEQUENCES while
+     * managing sequence generators.
+     * </p>
+     */
+    public boolean blockedByParent( Lock childLock )
+    {
+        if ( granted == null ) { return false; }
+        
+        LockOwner   childOwner = childLock.getCompatabilitySpace().getOwner();
+        Object          requestedQualifier = childLock.getQualifier();
+
+        for ( Lock grantedLock : granted )
+        {
+            LockOwner   ownerOfGrant = grantedLock.getCompatabilitySpace().getOwner();
+
+            if ( childOwner.nestsUnder( ownerOfGrant ) )
+            {
+                Object  grantedQualifier = grantedLock.getQualifier();
+
+                if ( !grantedLock.getLockable().requestCompatible( requestedQualifier, grantedQualifier ) )
+                {
+                    return true;
+                }
+            }
+        }
+
+        return false;
+    }
+
 //EXCLUDE-START-lockdiag- 
 	/**
 	 * make a shallow clone of myself
diff --git a/java/engine/org/apache/derby/impl/services/reflect/UpdateLoader.java b/java/engine/org/apache/derby/impl/services/reflect/UpdateLoader.java
index fe5eebbf5..0cf81c9bb 100644
--- a/java/engine/org/apache/derby/impl/services/reflect/UpdateLoader.java
+++ b/java/engine/org/apache/derby/impl/services/reflect/UpdateLoader.java
@@ -414,6 +414,17 @@ final class UpdateLoader implements LockOwner {
     public boolean noWait() {
         return false;
     }
+    
+    public boolean isNestedOwner()
+    {
+        return false;
+    }
+
+    public boolean nestsUnder( LockOwner other )
+    {
+        return false;
+    }
+    
 }
 
 
diff --git a/java/engine/org/apache/derby/impl/sql/catalog/SequenceUpdater.java b/java/engine/org/apache/derby/impl/sql/catalog/SequenceUpdater.java
index f5631d96e..8e3ebc313 100644
--- a/java/engine/org/apache/derby/impl/sql/catalog/SequenceUpdater.java
+++ b/java/engine/org/apache/derby/impl/sql/catalog/SequenceUpdater.java
@@ -449,6 +449,7 @@ public abstract class SequenceUpdater implements Cacheable
         if ( nestedTransaction != null )
         {
             boolean retval = false;
+            boolean escalateToParentTransaction = false;
             
             try
             {
@@ -456,7 +457,20 @@ public abstract class SequenceUpdater implements Cacheable
             }
             catch (StandardException se)
             {
-                if ( !se.isLockTimeout() ) { throw se; }
+                if ( !se.isLockTimeout() )
+                {
+                    if ( se.isSelfDeadlock() )
+                    {
+                        // We're blocked by a lock held by our parent transaction.
+                        // Escalate into the parent transaction now. See DERBY-6554.
+                        escalateToParentTransaction = true;
+                    }
+                    else
+                    {
+                        Monitor.logThrowable( se );
+                        throw se;
+                    }
+                }
             }
             finally
             {
@@ -467,6 +481,11 @@ public abstract class SequenceUpdater implements Cacheable
                 nestedTransaction.commit();
                 nestedTransaction.destroy();
 
+                if ( escalateToParentTransaction )
+                {
+                    retval = updateCurrentValueOnDisk( executionTransaction, oldValue, newValue, false );
+                }
+
                 return retval;
             }
         }
diff --git a/java/engine/org/apache/derby/impl/sql/execute/InsertResultSet.java b/java/engine/org/apache/derby/impl/sql/execute/InsertResultSet.java
index 77a1c08fa..e0253bc5f 100644
--- a/java/engine/org/apache/derby/impl/sql/execute/InsertResultSet.java
+++ b/java/engine/org/apache/derby/impl/sql/execute/InsertResultSet.java
@@ -820,7 +820,10 @@ class InsertResultSet extends DMLWriteResultSet implements TargetResultSet
 					throw se;
 				}
 
-				if (se.getMessageId().equals(SQLState.LOCK_TIMEOUT))
+				if (
+                    se.getMessageId().equals(SQLState.LOCK_TIMEOUT) ||
+                    se.getMessageId().equals(SQLState.SELF_DEADLOCK)
+                    )
 				{
 					// if we couldn't do this with a nested xaction, retry with
 					// parent-- we need to wait this time!
diff --git a/java/engine/org/apache/derby/impl/store/access/RAMTransaction.java b/java/engine/org/apache/derby/impl/store/access/RAMTransaction.java
index 631002825..e41c78337 100644
--- a/java/engine/org/apache/derby/impl/store/access/RAMTransaction.java
+++ b/java/engine/org/apache/derby/impl/store/access/RAMTransaction.java
@@ -1431,9 +1431,8 @@ public class RAMTransaction
     long    conglomId)
         throws StandardException
     {
-        findExistingConglomerate(conglomId).purgeConglomerate(
-            this, 
-            rawtran);
+        findExistingConglomerate(conglomId).purgeConglomerate
+            ( this, rawtran );
 
 		return;
     }
@@ -2320,10 +2319,12 @@ public class RAMTransaction
         Transaction child_rawtran = 
             ((readOnly) ?
                 accessmanager.getRawStore().startNestedReadOnlyUserTransaction(
+                    rawtran, 
                     getLockSpace(), 
                     cm,
                     AccessFactoryGlobals.NESTED_READONLY_USER_TRANS) :
                 accessmanager.getRawStore().startNestedUpdateUserTransaction(
+                    rawtran, 
                     cm, 
                     AccessFactoryGlobals.NESTED_UPDATE_USER_TRANS,
                     flush_log_on_xact_end));
diff --git a/java/engine/org/apache/derby/impl/store/access/heap/HeapController.java b/java/engine/org/apache/derby/impl/store/access/heap/HeapController.java
index 860a44527..1f23f6617 100644
--- a/java/engine/org/apache/derby/impl/store/access/heap/HeapController.java
+++ b/java/engine/org/apache/derby/impl/store/access/heap/HeapController.java
@@ -549,10 +549,17 @@ public class HeapController
     protected boolean lockRowAtSlotNoWaitExclusive(RecordHandle rh)
         throws StandardException
     {
-        return(
-            open_conglom.getContainer().getLockingPolicy().
-                lockRecordForWrite(
-                    open_conglom.getRawTran(), rh, false, false));
+        try {
+            return(
+                   open_conglom.getContainer().getLockingPolicy().
+                   lockRecordForWrite
+                   ( open_conglom.getRawTran(), rh, false, false) );
+        }
+        catch (StandardException se)
+        {
+            if ( se.isSelfDeadlock() ) { return false; }
+            else { throw se; }
+        }
     }
     protected void removePage(Page page)
         throws StandardException
diff --git a/java/engine/org/apache/derby/impl/store/raw/RawStore.java b/java/engine/org/apache/derby/impl/store/raw/RawStore.java
index 1663d60ac..6576f8c93 100644
--- a/java/engine/org/apache/derby/impl/store/raw/RawStore.java
+++ b/java/engine/org/apache/derby/impl/store/raw/RawStore.java
@@ -435,25 +435,31 @@ public final class RawStore implements RawStoreFactory, ModuleControl, ModuleSup
 	}
 
 	public Transaction startNestedReadOnlyUserTransaction(
+    Transaction parentTransaction,
     CompatibilitySpace compatibilitySpace,
     ContextManager  contextMgr,
     String          transName)
         throws StandardException
     {
 		return(
-            xactFactory.startNestedReadOnlyUserTransaction(
-                this, compatibilitySpace, contextMgr, transName));
+            xactFactory.startNestedReadOnlyUserTransaction
+            (
+             this, (RawTransaction) parentTransaction, compatibilitySpace, contextMgr, transName)
+            );
 	}
 
 	public Transaction startNestedUpdateUserTransaction(
+    Transaction parentTransaction,
     ContextManager  contextMgr,
     String          transName,
     boolean         flush_log_on_xact_end)
         throws StandardException
     {
 		return(
-            xactFactory.startNestedUpdateUserTransaction(
-                this, contextMgr, transName, flush_log_on_xact_end));
+            xactFactory.startNestedUpdateUserTransaction
+            (
+             this, (RawTransaction) parentTransaction, contextMgr, transName, flush_log_on_xact_end)
+            );
 	}
 
 	public Transaction findUserTransaction(
diff --git a/java/engine/org/apache/derby/impl/store/raw/xact/InternalXact.java b/java/engine/org/apache/derby/impl/store/raw/xact/InternalXact.java
index 1ba7e0cf4..4171ebfb8 100644
--- a/java/engine/org/apache/derby/impl/store/raw/xact/InternalXact.java
+++ b/java/engine/org/apache/derby/impl/store/raw/xact/InternalXact.java
@@ -56,7 +56,7 @@ public class InternalXact extends Xact
     DataValueFactory    dataValueFactory) 
     {
 		super(
-            xactFactory, logFactory, dataFactory, dataValueFactory, 
+            xactFactory, null, logFactory, dataFactory, dataValueFactory, 
             false, null, false);
 
 		// always want to hold latches & containers open past the commit/abort
diff --git a/java/engine/org/apache/derby/impl/store/raw/xact/Xact.java b/java/engine/org/apache/derby/impl/store/raw/xact/Xact.java
index 89084816f..b47fa8e34 100644
--- a/java/engine/org/apache/derby/impl/store/raw/xact/Xact.java
+++ b/java/engine/org/apache/derby/impl/store/raw/xact/Xact.java
@@ -179,6 +179,9 @@ public class Xact extends RawTransaction implements Limit, LockOwner {
 	// id that is valid locally in this raw store.
 	private volatile TransactionId	myId;
 
+    // id of parent transaction if this is a nested user transaction
+    private volatile TransactionId parentTransactionId;
+
 	protected Logger		logger;		// the object we use to access the log.
 
 
@@ -272,8 +275,9 @@ public class Xact extends RawTransaction implements Limit, LockOwner {
 	** Constructor
 	*/
 
-	protected Xact(
+    protected Xact(
     XactFactory         xactFactory, 
+    Xact          parentTransaction, 
     LogFactory          logFactory, 
     DataFactory         dataFactory,
     DataValueFactory    dataValueFactory,
@@ -285,6 +289,10 @@ public class Xact extends RawTransaction implements Limit, LockOwner {
 		super();
 
 		this.xactFactory            = xactFactory;
+        if ( parentTransaction != null )
+        {
+            parentTransactionId = parentTransaction.getId();
+        }
 		this.logFactory             = logFactory;
 		this.dataFactory            = dataFactory;
 		this.dataValueFactory       = dataValueFactory;
@@ -2834,6 +2842,19 @@ public class Xact extends RawTransaction implements Limit, LockOwner {
 		logFactory.checkpointInRFR(cinstant, redoLWM, undoLWM, dataFactory);
 	}
 
+    public boolean isNestedOwner()
+    {
+        return (parentTransactionId != null );
+    }
+
+    public boolean nestsUnder( LockOwner other )
+    {
+        if ( parentTransactionId == null ) { return false; }
+        else if ( !(other instanceof Xact) ) { return false; }
+        {
+            return parentTransactionId.equals( ((Xact) other).getId() );
+        }
+    }
 }
 
 class LockCount {
diff --git a/java/engine/org/apache/derby/impl/store/raw/xact/XactFactory.java b/java/engine/org/apache/derby/impl/store/raw/xact/XactFactory.java
index d18e6dc5b..85c139e84 100644
--- a/java/engine/org/apache/derby/impl/store/raw/xact/XactFactory.java
+++ b/java/engine/org/apache/derby/impl/store/raw/xact/XactFactory.java
@@ -253,6 +253,7 @@ public class XactFactory implements TransactionFactory, ModuleControl, ModuleSup
      * Common work done to create local or global transactions.
      *
      * @param rsf    the raw store factory creating this xact.
+     * @param parentTransaction parent transaction (if this is a nested user transaction)
      * @param cm     the current context manager to associate the xact with.
      * @param compatibilitySpace 
      *               if null, use the transaction being created, else if 
@@ -262,6 +263,7 @@ public class XactFactory implements TransactionFactory, ModuleControl, ModuleSup
      **/
     private Xact startCommonTransaction(
     RawStoreFactory     rsf, 
+    Xact                    parentTransaction, 
     ContextManager      cm,
     boolean             readOnly,
     CompatibilitySpace  compatibilitySpace,
@@ -284,7 +286,7 @@ public class XactFactory implements TransactionFactory, ModuleControl, ModuleSup
 
 		Xact xact = 
             new Xact(
-                this, logFactory, dataFactory, dataValueFactory, 
+                this, parentTransaction, logFactory, dataFactory, dataValueFactory, 
                 readOnly, compatibilitySpace, flush_log_on_xact_end);
 
         xact.setTransName(transName);
@@ -304,6 +306,7 @@ public class XactFactory implements TransactionFactory, ModuleControl, ModuleSup
         return(
             startCommonTransaction(
                 rsf, 
+                null, 
                 cm, 
                 false,              // user xact always read/write 
                 null, 
@@ -315,6 +318,7 @@ public class XactFactory implements TransactionFactory, ModuleControl, ModuleSup
 
 	public RawTransaction startNestedReadOnlyUserTransaction(
     RawStoreFactory rsf,
+    RawTransaction parentTransaction,
     CompatibilitySpace compatibilitySpace,
     ContextManager  cm,
     String          transName)
@@ -323,6 +327,7 @@ public class XactFactory implements TransactionFactory, ModuleControl, ModuleSup
         return(
             startCommonTransaction(
                 rsf, 
+                (Xact) parentTransaction, 
                 cm, 
                 true, 
                 compatibilitySpace, 
@@ -335,6 +340,7 @@ public class XactFactory implements TransactionFactory, ModuleControl, ModuleSup
 
 	public RawTransaction startNestedUpdateUserTransaction(
     RawStoreFactory rsf,
+    RawTransaction parentTransaction,
     ContextManager  cm,
     String          transName,
     boolean         flush_log_on_xact_end)
@@ -343,6 +349,7 @@ public class XactFactory implements TransactionFactory, ModuleControl, ModuleSup
         return(
             startCommonTransaction(
                 rsf, 
+                (Xact) parentTransaction, 
                 cm, 
                 false, 
                 null, 
@@ -373,6 +380,7 @@ public class XactFactory implements TransactionFactory, ModuleControl, ModuleSup
         Xact xact =
             startCommonTransaction(
                 rsf, 
+                null, 
                 cm, 
                 false, 
                 null, 
@@ -426,7 +434,7 @@ public class XactFactory implements TransactionFactory, ModuleControl, ModuleSup
 
 		Xact xact = 
             new Xact(
-                this, logFactory, dataFactory, dataValueFactory, 
+                this, null, logFactory, dataFactory, dataValueFactory, 
                 false, null, false);
 
 		// hold latches etc. past commit in NTT
diff --git a/java/engine/org/apache/derby/loc/messages.xml b/java/engine/org/apache/derby/loc/messages.xml
index 039a534a7..b78c298a1 100644
--- a/java/engine/org/apache/derby/loc/messages.xml
+++ b/java/engine/org/apache/derby/loc/messages.xml
@@ -1126,6 +1126,11 @@ Guide.
                 <arg>tableDump</arg>
             </msg>
 
+            <msg>
+                <name>40XL2</name>
+                <text>Self-deadlock.</text>
+            </msg>
+
             <msg>
                 <name>40XT0</name>
                 <text>An internal error was identified by RawStore module.</text>
diff --git a/java/shared/org/apache/derby/shared/common/reference/SQLState.java b/java/shared/org/apache/derby/shared/common/reference/SQLState.java
index 79b0ee5eb..16b59306c 100644
--- a/java/shared/org/apache/derby/shared/common/reference/SQLState.java
+++ b/java/shared/org/apache/derby/shared/common/reference/SQLState.java
@@ -271,6 +271,7 @@ public interface SQLState {
 	String DEADLOCK = "40001";
 	String LOCK_TIMEOUT = "40XL1";
     String LOCK_TIMEOUT_LOG = "40XL1.T.1";
+    String SELF_DEADLOCK = "40XL2";
 
 	/*
 	** Store - access.protocol.Interface statement exceptions
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SequenceTest.java b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SequenceTest.java
index d6005fb24..f1c7e5147 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SequenceTest.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/SequenceTest.java
@@ -643,6 +643,67 @@ public class SequenceTest extends GeneratedColumnsHelper {
         expectCompilationError( conn, OBJECT_DOES_NOT_EXIST, "values next value for seq_6137" );
     }
     
+    /**
+     * Verify that a sequence can be used in the same transaction
+     * which created it.
+     */
+    public void test_17_6554() throws Exception
+    {
+        Connection alphaConn = openUserConnection( ALPHA );
+        Connection betaConn = openUserConnection( BETA );
+
+        alphaConn.setAutoCommit( false );
+        betaConn.setAutoCommit( false );
+
+        String  createSequence = "create sequence seq6554";
+        String  nextValueFor = "values next value for seq6554";
+        String[][]  nextValueForResults =
+            new String[][]
+            {
+                { "-2147483648" },
+            }; 
+
+        goodStatement( alphaConn, createSequence );
+        assertResults( alphaConn, nextValueFor, nextValueForResults, true );
+        alphaConn.rollback();
+
+        goodStatement( betaConn, createSequence );
+        assertResults( betaConn, nextValueFor, nextValueForResults, true );
+        betaConn.rollback();
+
+        // now try creating and using the sequence inside the nested
+        // transaction context of a database procedure
+
+        goodStatement
+            (
+             alphaConn,
+             "create procedure createSequence( sequenceName varchar( 128 ) )\n" +
+             "language java parameter style java modifies sql data\n" +
+             "external name 'org.apache.derbyTesting.functionTests.tests.lang.SequenceTest.createSequence'\n"
+             );
+        goodStatement( alphaConn, "grant execute on procedure createSequence to public" );
+        alphaConn.commit();
+
+        String  runProcedure = "call alpha.createSequence( 'seq6554_2' )";
+        String  postProcedureQuery= "values next value for seq6554_2";
+        String[][]  postProcedureResults =
+            new String[][]
+            {
+                { "-2147483647" },
+            };
+
+        goodStatement( alphaConn, runProcedure );
+        assertResults( alphaConn, postProcedureQuery, postProcedureResults, true );
+        alphaConn.rollback();
+        
+        goodStatement( betaConn, runProcedure );
+        assertResults( betaConn, postProcedureQuery, postProcedureResults, true );
+        betaConn.rollback();
+
+        alphaConn.setAutoCommit( true );
+        betaConn.setAutoCommit( true );
+    }
+    
     /**
      * Verify that sequence numbers pick up where they left off after eviction from
      * the sequence cache.
