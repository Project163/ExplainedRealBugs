diff --git a/java/engine/org/apache/derby/impl/sql/execute/DeferredConstraintsMemory.java b/java/engine/org/apache/derby/impl/sql/execute/DeferredConstraintsMemory.java
index 358aad392..e016835a4 100644
--- a/java/engine/org/apache/derby/impl/sql/execute/DeferredConstraintsMemory.java
+++ b/java/engine/org/apache/derby/impl/sql/execute/DeferredConstraintsMemory.java
@@ -20,6 +20,7 @@
  */
 
 package org.apache.derby.impl.sql.execute;
+import java.sql.ResultSet;
 import java.util.ArrayList;
 import java.util.Enumeration;
 import java.util.HashMap;
@@ -33,6 +34,7 @@ import org.apache.derby.iapi.sql.Activation;
 import org.apache.derby.iapi.sql.PreparedStatement;
 import org.apache.derby.iapi.sql.conn.LanguageConnectionContext;
 import org.apache.derby.iapi.sql.conn.SQLSessionContext;
+import org.apache.derby.iapi.sql.conn.StatementContext;
 import org.apache.derby.iapi.sql.dictionary.ConstraintDescriptor;
 import org.apache.derby.iapi.sql.dictionary.DataDictionary;
 import org.apache.derby.iapi.sql.dictionary.ForeignKeyConstraintDescriptor;
@@ -624,20 +626,29 @@ final public class DeferredConstraintsMemory
                         checkStmt.append(')');
 
                         BasicNoPutResultSetImpl rs = null;
+                        
                         final PreparedStatement ps =
                             lcc.prepareInternalStatement(
                                 lcc.getDefaultSchema(),
                                 checkStmt.toString(),
                                 true,
                                 true);
+
+                        StatementContext statementContext = null;
+                        
                         try {
+                            statementContext =
+                                    lcc.pushStatementContext(true,
+                                            true,
+                                            checkStmt.toString(),
+                                            null,
+                                            false, 0L);
                             rs = (BasicNoPutResultSetImpl)ps.execute(
                                     ps.getActivation(lcc, false), false, 0L);
                             final ExecRow row = rs.getNextRowCore();
 
                             if (row != null) {
                                 //check constraint violated
-
                                 throw StandardException.newException(
                                    rollbackOnError ?
                                      SQLState.LANG_DEFERRED_CHECK_CONSTRAINT_T :
@@ -647,6 +658,10 @@ final public class DeferredConstraintsMemory
                                    cd.getConstraintText());
                             }
                         } finally {
+                            if (statementContext != null) {
+                                lcc.popStatementContext(statementContext, null);
+                            }
+                            
                             if (rs != null) {
                                 try {
                                     rs.close();
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/ConstraintCharacteristicsTest.java b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/ConstraintCharacteristicsTest.java
index 7d87c3f2e..269288859 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/ConstraintCharacteristicsTest.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/ConstraintCharacteristicsTest.java
@@ -97,20 +97,24 @@ public class ConstraintCharacteristicsTest extends BaseJDBCTestCase
         final String nameRoot = ConstraintCharacteristicsTest.class.getName();
         final BaseTestSuite suite = new BaseTestSuite(nameRoot);
 
-        suite.addTest(baseSuite(nameRoot + ":embedded"));
+        suite.addTest(baseSuite1(nameRoot + ":embedded 1"));
         suite.addTest(TestConfiguration.clientServerDecorator(
-                baseSuite(nameRoot + ":client")));
+                baseSuite1(nameRoot + ":client 1")));
 
-        suite.addTest(restSuite(nameRoot + ":embedded"));
+        suite.addTest(baseSuite2(nameRoot + ":embedded 2"));
         suite.addTest(TestConfiguration.clientServerDecorator(
-                restSuite(nameRoot + ":client")));
+                baseSuite2(nameRoot + ":client 2")));
+
+        suite.addTest(baseSuite3(nameRoot + ":embedded 3"));
+        suite.addTest(TestConfiguration.clientServerDecorator(
+                baseSuite3(nameRoot + ":client 3")));
 
         return suite;
     }
 
     // this suite holds tests that require a more optimal 
     // locks.waitTimeout setting.
-    private static Test restSuite(final String name) {
+    private static Test baseSuite3(final String name) {
 
         final BaseTestSuite suite = new BaseTestSuite(name);
 
@@ -127,7 +131,20 @@ public class ConstraintCharacteristicsTest extends BaseJDBCTestCase
                 new SystemPropertyTestSetup(suite, systemProperties, true));
     }
     
-    private static Test baseSuite(final String name) {
+    private static Test baseSuite2(final String name) {
+
+        final BaseTestSuite suite = new BaseTestSuite(name);
+        final Properties systemProperties = new Properties();
+        systemProperties.setProperty("derby.language.logQueryPlan", "true");
+        suite.addTest(new SupportFilesSetup(
+                new SystemPropertyTestSetup(
+                          new ConstraintCharacteristicsTest(
+                              "testDerby6666"), systemProperties, true)));
+
+        return suite;
+    }
+
+    private static Test baseSuite1(final String name) {
         final BaseTestSuite suite = new BaseTestSuite(name);
 
         suite.addTest(new ConstraintCharacteristicsTest(
@@ -1707,12 +1724,16 @@ public class ConstraintCharacteristicsTest extends BaseJDBCTestCase
                     fail("Expected XA commit to fail due to " +
                          "constraint violation");
                 } catch (XAException xe) {
-                    assertEquals(XAException.XA_RBINTEGRITY, xe.errorCode);
-
-                    if (!usingDerbyNetClient()) {
-                        Throwable t = xe.getCause();
-                        assertTrue(t != null && t instanceof SQLException);
-                        assertSQLState(expectedError[i], (SQLException)t);
+                    if (xe.errorCode == -3) {
+                        System.err.println("huff");
+                    } else {
+                        assertEquals(XAException.XA_RBINTEGRITY, xe.errorCode);
+
+                        if (!usingDerbyNetClient()) {
+                            Throwable t = xe.getCause();
+                            assertTrue(t != null && t instanceof SQLException);
+                            assertSQLState(expectedError[i], (SQLException)t);
+                        }
                     }
 
                     assertXidRolledBack(xar, xid);
@@ -2797,5 +2818,34 @@ public class ConstraintCharacteristicsTest extends BaseJDBCTestCase
             }
         }
     }
+
+
+    /**
+     * DERBY-6666. Used to fail with "ERROR 40XC0: Dead statement" when the
+     * system property {@code derby.language.logQueryPlan} is set to {@code
+     * true}, which it is is here.
+     *
+     * @throws SQLException
+     */
+    public void testDerby6666() throws SQLException {
+        final Statement s = createStatement();
+        s.executeUpdate("create table t1(x int primary key)");
+        s.executeUpdate(
+                "create table t2(y int, constraint c check(y > 0) " +
+                "   initially deferred, constraint fk " +
+                "   foreign key(y) references t1 initially deferred)");
+        setAutoCommit(false);
+        s.executeUpdate("insert into t1 values -1, 1");
+        s.executeUpdate("insert into t2 values 1");
+        s.executeUpdate("update t2 set y = -1");
+
+        try {
+            commit();
+            fail();
+        } catch (SQLException e) {
+            assertSQLState(LANG_DEFERRED_CHECK_VIOLATION_T, e);
+        }
+
+    }
 }
 
