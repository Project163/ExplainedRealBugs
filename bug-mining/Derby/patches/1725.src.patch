diff --git a/java/build/org/apache/derbyBuild/splitmessages.java b/java/build/org/apache/derbyBuild/splitmessages.java
index 52c76b11c..8587a3841 100644
--- a/java/build/org/apache/derbyBuild/splitmessages.java
+++ b/java/build/org/apache/derbyBuild/splitmessages.java
@@ -119,6 +119,7 @@ public class splitmessages {
         clientMessageIds.add(SQLState.LANG_STRING_TOO_LONG);
         clientMessageIds.add(SQLState.INVALID_COLUMN_ARRAY_LENGTH);
         clientMessageIds.add(SQLState.PROPERTY_INVALID_VALUE);
+        clientMessageIds.add(SQLState.LANG_SUBSTR_START_ADDING_LEN_OUT_OF_RANGE);
     }
 
 	public static void main(String[] args) throws Exception {
diff --git a/java/client/org/apache/derby/client/am/Clob.java b/java/client/org/apache/derby/client/am/Clob.java
index c09a335a7..e84cf4b5a 100644
--- a/java/client/org/apache/derby/client/am/Clob.java
+++ b/java/client/org/apache/derby/client/am/Clob.java
@@ -21,14 +21,13 @@
 
 package org.apache.derby.client.am;
 
-import java.io.BufferedInputStream;
-import java.io.BufferedReader;
-import java.io.InputStream;
+
 import java.io.IOException;
 import java.io.Reader;
 import java.sql.SQLException;
-import org.apache.derby.shared.common.reference.SQLState;
+
 import org.apache.derby.client.net.EncodedInputStream;
+import org.apache.derby.shared.common.reference.SQLState;
 
 public class Clob extends Lob implements java.sql.Clob {
     //---------------------navigational members-----------------------------------
@@ -625,7 +624,18 @@ public class Clob extends Lob implements java.sql.Clob {
                 new ClientMessageId(SQLState.BLOB_POSITION_TOO_LARGE),
                 new Long(pos));
         }
-        if ((offset < 0) || offset > str.length() ) {
+        
+        if (str == null) {
+            throw new SqlException(agent_.logWriter_,
+                    new ClientMessageId(
+                            SQLState.BLOB_NULL_PATTERN_OR_SEARCH_STR));
+        }
+        
+        if (str.length() == 0) {
+            return 0;
+        }
+        
+        if ((offset < 0) || offset >= str.length() ) {
             throw new SqlException(agent_.logWriter_,
                 new ClientMessageId(SQLState.BLOB_INVALID_OFFSET),
                 new Integer(offset));
@@ -636,6 +646,13 @@ public class Clob extends Lob implements java.sql.Clob {
                 new ClientMessageId(SQLState.BLOB_NONPOSITIVE_LENGTH),
                 new Integer(len));
         }
+        
+        if (offset + len > str.length()) {
+            throw new SqlException(agent_.logWriter_,
+                    new ClientMessageId(
+                            SQLState.LANG_SUBSTR_START_ADDING_LEN_OUT_OF_RANGE),
+                    new Integer(offset), new Integer(len), str);
+        }
 
         if (len == 0) {
             return 0;
diff --git a/java/engine/org/apache/derby/impl/jdbc/EmbedClob.java b/java/engine/org/apache/derby/impl/jdbc/EmbedClob.java
index aeb715fdf..81f2b7516 100644
--- a/java/engine/org/apache/derby/impl/jdbc/EmbedClob.java
+++ b/java/engine/org/apache/derby/impl/jdbc/EmbedClob.java
@@ -546,9 +546,40 @@ restartScan:
     public int setString(long pos, String str, int offset, int len)
             throws SQLException {
         checkValidity();
-        if (pos < 1)
+        if (pos < 1) {
             throw Util.generateCsSQLException(
                 SQLState.BLOB_BAD_POSITION, new Long(pos));
+        }
+        
+        if (pos > length() + 1) {
+            throw Util.generateCsSQLException(
+        	    SQLState.BLOB_POSITION_TOO_LARGE);
+        }
+        
+        if (str == null) {
+            throw Util.generateCsSQLException(
+        	    SQLState.BLOB_NULL_PATTERN_OR_SEARCH_STR);
+        }
+        
+        if (str.length() == 0) {
+            return 0;
+        }
+        
+        if (offset < 0 || offset >= str.length()) {
+            throw Util.generateCsSQLException(SQLState.BLOB_INVALID_OFFSET);
+        }
+        
+        if (len < 0) {
+            throw Util.generateCsSQLException(
+        	    SQLState.BLOB_NONPOSITIVE_LENGTH);
+        }
+        
+        if (len + offset > str.length()) {
+            throw Util.generateCsSQLException(
+                    SQLState.LANG_SUBSTR_START_ADDING_LEN_OUT_OF_RANGE,
+                    new Integer(offset), new Integer(len), str);
+        }
+        
         try {
             if (!this.clob.isWritable()) {
                 makeWritableClobClone();
diff --git a/java/engine/org/apache/derby/loc/messages.xml b/java/engine/org/apache/derby/loc/messages.xml
index e3e679eff..6b074cd45 100644
--- a/java/engine/org/apache/derby/loc/messages.xml
+++ b/java/engine/org/apache/derby/loc/messages.xml
@@ -673,6 +673,14 @@ Guide.
                 <text>The second or third argument of the SUBSTR function is out of range.</text>
             </msg>
 
+            <msg>
+                <name>22011.S.1</name>
+                <text>The range specified for the substring with offset {0} and len {1} is out of range for the String: {2}.</text>
+                <arg>offset</arg>
+                <arg>len</arg>
+                <arg>str</arg>
+            </msg>
+            
             <msg>
                 <name>22012</name>
                 <text>Attempt to divide by zero.</text>
diff --git a/java/shared/org/apache/derby/shared/common/reference/SQLState.java b/java/shared/org/apache/derby/shared/common/reference/SQLState.java
index 47244b423..5d45e7225 100644
--- a/java/shared/org/apache/derby/shared/common/reference/SQLState.java
+++ b/java/shared/org/apache/derby/shared/common/reference/SQLState.java
@@ -699,6 +699,7 @@ public interface SQLState {
 	String LANG_DATE_SYNTAX_EXCEPTION                                  = "22007.S.181";
     String LANG_INVALID_FUNCTION_ARGUMENT                              = "22008.S";
 	String LANG_SUBSTR_START_OR_LEN_OUT_OF_RANGE                        = "22011";
+	String LANG_SUBSTR_START_ADDING_LEN_OUT_OF_RANGE                        = "22011.S.1";
 	String LANG_DIVIDE_BY_ZERO                                         = "22012";
     String LANG_SQRT_OF_NEG_NUMBER                                     = "22013";
     String LANG_INVALID_PARAMETER_FOR_SEARCH_POSITION                  = "22014";
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/ClobTest.java b/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/ClobTest.java
index 2c75ffcdd..3a37efca8 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/ClobTest.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/ClobTest.java
@@ -385,6 +385,108 @@ public class ClobTest
         //insertDataWithToken(token, prefix, 2*1024-7, SET_CHARACTER_STREAM);
         executeTestPositionWithStringToken(token, prefix);
     }
+    
+    /**
+     * Test setString() refuses wrong offset. 
+     */
+    public void testSetStringOnWrongOffset() throws SQLException {
+        clob.setString(1, "TEST");
+        long upperLimit = clob.length() + 1;
+        String str = "AGAIN";
+        
+        try {
+            clob.setString(upperLimit, str, -1, 2);
+            fail("setString() refuses negative offset!");
+        } catch (SQLException e) {
+            assertSQLState("XJ078", e);
+        }
+        
+        try {
+            clob.setString(upperLimit, str, str.length() + 1, 1);
+            fail("setString() refuses offset greater than str.length()!");
+        } catch (SQLException e) {
+            assertSQLState("XJ078", e);
+        }
+        
+        //if (offset + len) == str.length(), it's accepted.
+        clob.setString(upperLimit, str, str.length() - 1, 1);
+        
+        try {
+            clob.setString(upperLimit, str, str.length(), 0);
+            fail("offset should be smaller than the length of str");
+        } catch (SQLException e) {
+            assertSQLState("XJ078", e);
+        }
+        
+        try {
+            clob.setString(upperLimit, str, str.length() - 1, 2);
+            fail("setString() refuses offset + len > str.length()!");
+        } catch (SQLException e) {
+            assertSQLState("22011", e);
+        }
+    }
+    
+    /**
+     * Test setString() refuses wrong len. 
+     */
+    public void testSetStringWithWrongLen() throws SQLException {
+        clob.setString(1, "TEST");
+        long upperLimit = clob.length() + 1;
+        String str = "AGAIN";
+        
+        try {
+            clob.setString(upperLimit, str, 0, -1);
+            fail("setString() refuses negative len!");
+        } catch (SQLException e) {
+            assertSQLState("XJ071", e);
+        }
+        
+        try {
+            clob.setString(upperLimit, str, 0, str.length() + 1);
+            fail("setString() refuses wrong len out of range!");
+        } catch (SQLException e) {
+            assertSQLState("22011", e);
+        }
+    }
+    
+    /**
+     * Test setString() refuses pos bigger than clob.length() + 1.
+     */
+    public void testSetStringWithBigPos() throws SQLException {
+        clob.setString(1, "TEST");
+        long upperLimit = clob.length() + 1;
+        
+        try {
+            clob.setString(upperLimit + 1, "AGAIN", 0, 2);
+            fail("pos is out of range!");
+        } catch (SQLException e) {
+            assertSQLState("XJ076", e);
+        }
+    }
+    
+    /**
+     * Test setStrinng() refuses a Null String.
+     */
+    public void testSetStringWithNull() throws SQLException {
+        clob.setString(1, "TEST");
+        long upperLimit = clob.length() + 1;
+        
+        try {
+            clob.setString(upperLimit, null, 0, 2);
+            fail("can not accepted null String!");
+        } catch (SQLException e) {
+            assertSQLState("XJ072", e);
+        }
+    }
+    
+    /**
+     * Test setString() accepts a empty String, and just return 0.
+     */
+    public void testSetStringWithEmptyString() throws SQLException {
+        clob.setString(1, "TEST");
+        long upperLimit = clob.length() + 1;              
+        assertEquals(0, clob.setString(upperLimit, "", 0, 0));           
+    }
 
     /**
      * Truncating a Clob to the empty string.
