diff --git a/java/engine/org/apache/derby/impl/sql/compile/MergeNode.java b/java/engine/org/apache/derby/impl/sql/compile/MergeNode.java
index 16838d8c5..f3ae58d03 100644
--- a/java/engine/org/apache/derby/impl/sql/compile/MergeNode.java
+++ b/java/engine/org/apache/derby/impl/sql/compile/MergeNode.java
@@ -388,11 +388,30 @@ public final class MergeNode extends DMLModStatementNode
 
             // window function not allowed
             SelectNode.checkNoWindowFunctions(mcn, "matching clause");
+
+            // aggregates not allowed
+            checkNoAggregates(mcn);
         }
         
         bindLeftJoin( dd );
 	}
 
+
+    static void checkNoAggregates(QueryTreeNode clause)
+            throws StandardException {
+
+        // Clause cannot contain window aggregates except inside subqueries
+        HasNodeVisitor visitor = new HasNodeVisitor(AggregateNode.class,
+                                                    SubqueryNode.class);
+        clause.accept(visitor);
+
+        if (visitor.hasNode()) {
+            throw StandardException.newException(
+                    SQLState.LANG_NO_AGGREGATES_IN_MERGE_MATCHING_CLAUSE);
+        }
+    }
+
+
     /////////////////////////////////////
     //
     // TABLE AND CORRELATION CHECKS
diff --git a/java/engine/org/apache/derby/loc/messages.xml b/java/engine/org/apache/derby/loc/messages.xml
index 8db848174..084460d21 100644
--- a/java/engine/org/apache/derby/loc/messages.xml
+++ b/java/engine/org/apache/derby/loc/messages.xml
@@ -2882,6 +2882,11 @@ Guide.
                 <arg>triggerName</arg>
             </msg>
 
+            <msg>
+                <name>42Z09</name>
+                <text>Aggregates are not permitted in the MERGE matching clause.</text>
+            </msg>
+
             <msg>
                 <name>42Z15</name>
                 <text>Invalid type specified for column '{0}'. The type of a column may not be changed.  </text>
diff --git a/java/shared/org/apache/derby/shared/common/reference/SQLState.java b/java/shared/org/apache/derby/shared/common/reference/SQLState.java
index 9f104a1e0..24142d317 100644
--- a/java/shared/org/apache/derby/shared/common/reference/SQLState.java
+++ b/java/shared/org/apache/derby/shared/common/reference/SQLState.java
@@ -1051,6 +1051,7 @@ public interface SQLState {
 	String LANG_USER_AGGREGATE_MULTIPLE_DISTINCTS                      = "42Z02";
 	String LANG_NO_AGGREGATES_IN_ON_CLAUSE                             = "42Z07";
 	String LANG_NO_BULK_INSERT_REPLACE_WITH_TRIGGER                    = "42Z08";
+    String LANG_NO_AGGREGATES_IN_MERGE_MATCHING_CLAUSE                 = "42Z09";
 
 	// MORE GENERIC LANGUAGE STUFF
 	String LANG_UDT_BUILTIN_CONFLICT										   = "42Z10";
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/MergeStatementTest.java b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/MergeStatementTest.java
index 817fa775e..7b6f72e4d 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/MergeStatementTest.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/MergeStatementTest.java
@@ -29,6 +29,7 @@ import java.sql.DriverManager;
 import java.sql.PreparedStatement;
 import java.sql.ResultSet;
 import java.sql.SQLException;
+import java.sql.Statement;
 import java.util.ArrayList;
 import java.util.Arrays;
 import junit.framework.Test;
@@ -78,6 +79,7 @@ public class MergeStatementTest extends GeneratedColumnsHelper
     private static  final   String      NO_DCL_IN_MERGE = "42XAQ";
     private static  final   String      PARAMETER_NOT_SET = "07000";
     private static  final   String      CARDINALITY_VIOLATION = "21000";
+    private static  final   String      NO_AGGREGATE_IN_MATCHING = "42Z09";
 
     private static  final   String[]    TRIGGER_HISTORY_COLUMNS = new String[] { "ACTION", "ACTION_VALUE" };
 
@@ -9505,6 +9507,23 @@ public class MergeStatementTest extends GeneratedColumnsHelper
         goodStatement( dboConnection, "drop table t1_060" );
         goodStatement( dboConnection, "drop table t2_060" );
     }
+
+    public void test_061_Derby6693() throws SQLException {
+        Statement s = createStatement();
+
+        try {
+            s.execute("create table t2(x int)");
+            s.execute("create table t1(x int)");
+            s.execute("insert into t2 values 3,4");
+            assertCompileError(
+                    NO_AGGREGATE_IN_MATCHING,
+                    "merge into t1 using t2 on (t1.x=t2.x) " +
+                    "when not matched then insert values (max(t2.x))");
+        } finally {
+            dropTable("t1");
+            dropTable("t2");
+        }
+    }
     
     ///////////////////////////////////////////////////////////////////////////////////
     //
