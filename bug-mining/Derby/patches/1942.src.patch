diff --git a/java/engine/org/apache/derby/impl/sql/execute/TableScanResultSet.java b/java/engine/org/apache/derby/impl/sql/execute/TableScanResultSet.java
index 7dad89f46..e3e514321 100644
--- a/java/engine/org/apache/derby/impl/sql/execute/TableScanResultSet.java
+++ b/java/engine/org/apache/derby/impl/sql/execute/TableScanResultSet.java
@@ -682,7 +682,15 @@ class TableScanResultSet extends ScanResultSet
 				}
 	        	scanController.close();
 				scanController = null; // should not access after close
-				activation.clearIndexScanInfo();
+
+                // Updatable index scans are cached in the activation for
+                // easy access from IndexChanger. Remember to clear the cached
+                // info here, but only if this is the result set that cached
+                // it in the first place (DERBY-4585).
+                if (forUpdate && isKeyed) {
+                    activation.clearIndexScanInfo();
+                }
+
 			}
 			scanControllerOpened = false;
 			startPosition = null;
diff --git a/java/testing/org/apache/derbyTesting/functionTests/master/delete.out b/java/testing/org/apache/derbyTesting/functionTests/master/delete.out
index 31506ae5f..3507c524d 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/master/delete.out
+++ b/java/testing/org/apache/derbyTesting/functionTests/master/delete.out
@@ -314,4 +314,53 @@ drop table bug171_employee;
 0 rows inserted/updated/deleted
 ij> drop table bug171_bonuses;
 0 rows inserted/updated/deleted
+ij> --
+-- Test case for DERBY-4585
+--
+create table d4585_t1 (id int primary key, a int);
+0 rows inserted/updated/deleted
+ij> create table d4585_t2 (id int primary key, b int,
+                       constraint fk_t2 foreign key (b) references d4585_t1);
+0 rows inserted/updated/deleted
+ij> create table d4585_t3 (id int primary key, c int);
+0 rows inserted/updated/deleted
+ij> create table d4585_t4 (d int references d4585_t2);
+0 rows inserted/updated/deleted
+ij> insert into d4585_t1 values (16,51),(30,12),(39,24),(48,1),(53,46),(61,9);
+6 rows inserted/updated/deleted
+ij> insert into d4585_t2 values
+    (2,16),(3,61),(4,16),(6,30),(7,16),(10,48),(13,30),(15,48),(17,61),
+    (18,30),(21,48),(22,53),(23,61),(25,48),(26,30),(27,48),(29,16),(31,39),
+    (33,30),(35,61),(37,30),(40,53),(42,53),(45,16),(49,30),(54,53),(57,53),
+    (58,61),(60,30),(63,61),(64,30);
+31 rows inserted/updated/deleted
+ij> insert into d4585_t3 values
+    (1,50),(5,50),(8,50),(9,50),(11,36),(12,50),(14,50),(19,50),(20,50),
+    (24,36),(28,50),(32,50),(34,50),(38,50),(41,50),(43,50),(46,36),(47,36),
+    (51,36),(52,50),(55,36),(56,44),(59,36),(62,36);
+24 rows inserted/updated/deleted
+ij> insert into d4585_t4 values (7), (33), (57);
+3 rows inserted/updated/deleted
+ij> -- The query below resulted in a NullPointerException if a certain query plan
+-- was chosen. Use an optimizer override to force that plan.
+delete from d4585_t4 where d in
+  (select id from d4585_t2 --derby-properties constraint=fk_t2
+    where b in (select t1.id
+                       from d4585_t1 t1, d4585_t3 t3
+                       where t1.a=t3.id and t3.c=36));
+2 rows inserted/updated/deleted
+ij> -- Verify that the correct rows were deleted.
+select * from d4585_t4;
+D          
+-----------
+33         
+ij> -- Clean up
+drop table d4585_t4;
+0 rows inserted/updated/deleted
+ij> drop table d4585_t3;
+0 rows inserted/updated/deleted
+ij> drop table d4585_t2;
+0 rows inserted/updated/deleted
+ij> drop table d4585_t1;
+0 rows inserted/updated/deleted
 ij> 
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/delete.sql b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/delete.sql
index 892b21adb..922ab7502 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/delete.sql
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/delete.sql
@@ -230,3 +230,44 @@ autocommit on;
 
 drop table bug171_employee;
 drop table bug171_bonuses;
+
+--
+-- Test case for DERBY-4585
+--
+create table d4585_t1 (id int primary key, a int);
+create table d4585_t2 (id int primary key, b int,
+                       constraint fk_t2 foreign key (b) references d4585_t1);
+create table d4585_t3 (id int primary key, c int);
+create table d4585_t4 (d int references d4585_t2);
+
+insert into d4585_t1 values (16,51),(30,12),(39,24),(48,1),(53,46),(61,9);
+
+insert into d4585_t2 values
+    (2,16),(3,61),(4,16),(6,30),(7,16),(10,48),(13,30),(15,48),(17,61),
+    (18,30),(21,48),(22,53),(23,61),(25,48),(26,30),(27,48),(29,16),(31,39),
+    (33,30),(35,61),(37,30),(40,53),(42,53),(45,16),(49,30),(54,53),(57,53),
+    (58,61),(60,30),(63,61),(64,30);
+
+insert into d4585_t3 values
+    (1,50),(5,50),(8,50),(9,50),(11,36),(12,50),(14,50),(19,50),(20,50),
+    (24,36),(28,50),(32,50),(34,50),(38,50),(41,50),(43,50),(46,36),(47,36),
+    (51,36),(52,50),(55,36),(56,44),(59,36),(62,36);
+
+insert into d4585_t4 values (7), (33), (57);
+
+-- The query below resulted in a NullPointerException if a certain query plan
+-- was chosen. Use an optimizer override to force that plan.
+delete from d4585_t4 where d in
+  (select id from d4585_t2 --derby-properties constraint=fk_t2
+    where b in (select t1.id
+                       from d4585_t1 t1, d4585_t3 t3
+                       where t1.a=t3.id and t3.c=36));
+
+-- Verify that the correct rows were deleted.
+select * from d4585_t4;
+
+-- Clean up
+drop table d4585_t4;
+drop table d4585_t3;
+drop table d4585_t2;
+drop table d4585_t1;
