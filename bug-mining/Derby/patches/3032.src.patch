diff --git a/java/engine/org/apache/derby/impl/sql/compile/MergeNode.java b/java/engine/org/apache/derby/impl/sql/compile/MergeNode.java
index 15f9b1659..16838d8c5 100644
--- a/java/engine/org/apache/derby/impl/sql/compile/MergeNode.java
+++ b/java/engine/org/apache/derby/impl/sql/compile/MergeNode.java
@@ -385,6 +385,9 @@ public final class MergeNode extends DMLModStatementNode
             FromList    dummyFromList = cloneFromList( dd, dflTarget );
             FromBaseTable   dummyTargetTable = (FromBaseTable) dummyFromList.elementAt( TARGET_TABLE_INDEX );
             mcn.bind( dd, this, dummyFromList, dummyTargetTable );
+
+            // window function not allowed
+            SelectNode.checkNoWindowFunctions(mcn, "matching clause");
         }
         
         bindLeftJoin( dd );
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/OLAPTest.java b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/OLAPTest.java
index c9d883195..76492b514 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/OLAPTest.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/OLAPTest.java
@@ -619,6 +619,11 @@ public class OLAPTest extends BaseJDBCTestCase {
             "select * from t3 where y = " +
                 "    (select y from t3 order by row_number() over () fetch first row only)"),
             new String[][]{{"0"}});
+
+        // DERBY-6689: NPE before
+        assertStatementError(LANG_WINDOW_FUNCTION_CONTEXT_ERROR,
+            s,
+            "merge into t2 using t3 on (t2.x=t3.y) when not matched then insert values (row_number() over ())");
     }
 
 
