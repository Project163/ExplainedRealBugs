diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/RuntimeInfoTest.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/RuntimeInfoTest.policy
index f512e84d5..ecf6beb02 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/RuntimeInfoTest.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/RuntimeInfoTest.policy
@@ -122,13 +122,6 @@ permission java.util.PropertyPermission "derby.storage.jvmInstanceId",
   permission org.apache.derby.security.SystemPermission "engine", "monitor";
   permission org.apache.derby.security.SystemPermission "server", "monitor";  
  
-  // These permissions are needed when testing code instrumented with EMMA.
-  // They will only be used if the emma.active system property property is set,
-  // which should be set to "" for the permissions to be correct.
-  permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-  permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
-  
   // These permissions are needed by AssertFailure to dump the thread stack
   // traces upon failure.
   permission java.lang.RuntimePermission "getStackTrace";
@@ -251,9 +244,6 @@ grant codeBase "${derbyTesting.testjar}derbyTesting.jar" {
   permission org.apache.derby.security.SystemPermission "jmx", "control";
   permission org.apache.derby.security.SystemPermission "engine", "monitor";
   permission org.apache.derby.security.SystemPermission "server", "control,monitor";
-  
-  // These permissions are needed when testing code instrumented with EMMA.
-  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
 //
@@ -343,11 +333,6 @@ grant codeBase "${derbyTesting.junit}" {
 
     // This permission is needed when running the tests using ant 1.7
     permission java.io.FilePermission "${user.dir}${/}*", "write";
-  
-    // These permissions are needed when testing code instrumented with EMMA.
-    permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-    permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
 // Due to a problem running tests/derbynet/CompatibilityTest in the old test
@@ -367,11 +352,6 @@ grant codeBase "${derbyTesting.antjunit}" {
 
     // This permission is needed when running the tests using ant 1.7
     permission java.io.FilePermission "${user.dir}${/}*", "write";
-
-    // These permissions are needed when testing code instrumented with EMMA.
-    permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-    permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
 // functionTests.tests.lang.RoutineSecurityTest requires this grant
@@ -384,6 +364,17 @@ grant {
   permission java.io.FilePermission "<<ALL FILES>>", "execute";
 };
 
+// These permissions are needed when testing code instrumented with EMMA.
+// They will only be used if the emma.active system property property is
+// set, which should be set to "" for the permissions to be correct. Must
+// be granted to all code bases because EMMA doesn't use doPrivileged
+// blocks around the code that needs the permissions.
+grant {
+  permission java.util.PropertyPermission "${emma.active}user.dir", "read";
+  permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
+  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
+};
+
 // When inserting XML values that use external DTD's, the JAXP parser
 // needs permission to read the DTD files.  We assume that all DTD
 // files will be copied to extin/ by whichever tests need them.  So
@@ -392,16 +383,6 @@ grant codeBase "${derbyTesting.jaxpjar}" {
   permission java.io.FilePermission "${user.dir}${/}extin${/}-", "read";
 };
 
-
-// These permissions are needed when testing code instrumented with EMMA.
-// They are all related to writing coverage statistics to a file that by default
-// is named coverage.ec placed in the directory where the test is executed.
-grant codeBase "${derbyTesting.emma}" {
-    permission java.util.PropertyPermission "user.dir", "read";
-    permission java.io.FilePermission "${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "writeFileDescriptor";
-};
-
 // Permissions for package-private tests run from 'classes.pptesting'
 grant codeBase "${derbyTesting.ppcodeclasses}" {
 
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SysinfoTest.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SysinfoTest.policy
index 4a0389851..659e98e29 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SysinfoTest.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/derbynet/SysinfoTest.policy
@@ -121,13 +121,6 @@ grant codeBase "${derbyTesting.codejar}derby.jar" {
   permission org.apache.derby.security.SystemPermission "engine", "monitor";
   permission org.apache.derby.security.SystemPermission "server", "monitor";  
  
-  // These permissions are needed when testing code instrumented with EMMA.
-  // They will only be used if the emma.active system property property is set,
-  // which should be set to "" for the permissions to be correct.
-  permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-  permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
-  
   // These permissions are needed by AssertFailure to dump the thread stack
   // traces upon failure.
   permission java.lang.RuntimePermission "getStackTrace";
@@ -250,9 +243,6 @@ grant codeBase "${derbyTesting.testjar}derbyTesting.jar" {
   permission org.apache.derby.security.SystemPermission "engine", "monitor";
   permission org.apache.derby.security.SystemPermission "server", "control,monitor";
   
-  // These permissions are needed when testing code instrumented with EMMA.
-  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
-  
   //client side: test execs another jvm with relative path
   permission java.io.FilePermission "<<ALL FILES>>", "execute";
 };
@@ -348,11 +338,6 @@ grant codeBase "${derbyTesting.junit}" {
     // This permission is needed when running the tests using ant 1.7
     permission java.io.FilePermission "${user.dir}${/}*", "write";
   
-    // These permissions are needed when testing code instrumented with EMMA.
-    permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-    permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
-    
     //client side: test execs another jvm with relative path
     permission java.io.FilePermission "<<ALL FILES>>", "execute";
 };
@@ -374,11 +359,6 @@ grant codeBase "${derbyTesting.antjunit}" {
 
     // This permission is needed when running the tests using ant 1.7
     permission java.io.FilePermission "${user.dir}${/}*", "write";
-
-    // These permissions are needed when testing code instrumented with EMMA.
-    permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-    permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
 // functionTests.tests.lang.RoutineSecurityTest requires this grant
@@ -390,6 +370,17 @@ grant {
 
 };
 
+// These permissions are needed when testing code instrumented with EMMA.
+// They will only be used if the emma.active system property property is
+// set, which should be set to "" for the permissions to be correct. Must
+// be granted to all code bases because EMMA doesn't use doPrivileged
+// blocks around the code that needs the permissions.
+grant {
+  permission java.util.PropertyPermission "${emma.active}user.dir", "read";
+  permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
+  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
+};
+
 // When inserting XML values that use external DTD's, the JAXP parser
 // needs permission to read the DTD files.  We assume that all DTD
 // files will be copied to extin/ by whichever tests need them.  So
@@ -398,16 +389,6 @@ grant codeBase "${derbyTesting.jaxpjar}" {
   permission java.io.FilePermission "${user.dir}${/}extin${/}-", "read";
 };
 
-
-// These permissions are needed when testing code instrumented with EMMA.
-// They are all related to writing coverage statistics to a file that by default
-// is named coverage.ec placed in the directory where the test is executed.
-grant codeBase "${derbyTesting.emma}" {
-    permission java.util.PropertyPermission "user.dir", "read";
-    permission java.io.FilePermission "${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "writeFileDescriptor";
-};
-
 // Permissions for package-private tests run from 'classes.pptesting'
 grant codeBase "${derbyTesting.ppcodeclasses}" {
 
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/jdbc4/noAbortPermission.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/jdbc4/noAbortPermission.policy
index c6b02eb75..8662d7db8 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/jdbc4/noAbortPermission.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/jdbc4/noAbortPermission.policy
@@ -103,13 +103,6 @@ grant codeBase "${derbyTesting.codejar}derby.jar" {
   permission org.apache.derby.security.SystemPermission "engine", "monitor";
   permission org.apache.derby.security.SystemPermission "server", "monitor";  
  
-  // These permissions are needed when testing code instrumented with EMMA.
-  // They will only be used if the emma.active system property property is set,
-  // which should be set to "" for the permissions to be correct.
-  permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-  permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
-  
   // These permissions are needed by AssertFailure to dump the thread stack
   // traces upon failure.
   permission java.lang.RuntimePermission "getStackTrace";
@@ -247,9 +240,6 @@ grant codeBase "${derbyTesting.testjar}derbyTesting.jar" {
   // applications which have not been granted the privilege to
   // abort physical connections.
   //permission java.sql.SQLPermission "callAbort";
-  
-  // These permissions are needed when testing code instrumented with EMMA.
-  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
 //
@@ -339,11 +329,6 @@ grant codeBase "${derbyTesting.junit}" {
 
     // This permission is needed when running the tests using ant 1.7
     permission java.io.FilePermission "${user.dir}${/}*", "write";
-  
-    // These permissions are needed when testing code instrumented with EMMA.
-    permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-    permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
 // Due to a problem running tests/derbynet/CompatibilityTest in the old test
@@ -363,11 +348,6 @@ grant codeBase "${derbyTesting.antjunit}" {
 
     // This permission is needed when running the tests using ant 1.7
     permission java.io.FilePermission "${user.dir}${/}*", "write";
-
-    // These permissions are needed when testing code instrumented with EMMA.
-    permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-    permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
 // functionTests.tests.lang.RoutineSecurityTest requires this grant
@@ -377,6 +357,17 @@ grant {
     permission java.util.PropertyPermission "derbyRoutineSecurityTest.yes", "read";
 };
 
+// These permissions are needed when testing code instrumented with EMMA.
+// They will only be used if the emma.active system property property is
+// set, which should be set to "" for the permissions to be correct. Must
+// be granted to all code bases because EMMA doesn't use doPrivileged
+// blocks around the code that needs the permissions.
+grant {
+  permission java.util.PropertyPermission "${emma.active}user.dir", "read";
+  permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
+  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
+};
+
 // When inserting XML values that use external DTD's, the JAXP parser
 // needs permission to read the DTD files.  We assume that all DTD
 // files will be copied to extin/ by whichever tests need them.  So
@@ -385,16 +376,6 @@ grant codeBase "${derbyTesting.jaxpjar}" {
   permission java.io.FilePermission "${user.dir}${/}extin${/}-", "read";
 };
 
-
-// These permissions are needed when testing code instrumented with EMMA.
-// They are all related to writing coverage statistics to a file that by default
-// is named coverage.ec placed in the directory where the test is executed.
-grant codeBase "${derbyTesting.emma}" {
-    permission java.util.PropertyPermission "user.dir", "read";
-    permission java.io.FilePermission "${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "writeFileDescriptor";
-};
-
 // Permissions for package-private tests run from 'classes.pptesting'
 grant codeBase "${derbyTesting.ppcodeclasses}" {
 
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/LDAPTests.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/LDAPTests.policy
index f16024d48..9b3df63c9 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/LDAPTests.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/LDAPTests.policy
@@ -114,13 +114,6 @@ grant codeBase "${derbyTesting.codejar}derby.jar" {
   permission org.apache.derby.security.SystemPermission "engine", "monitor";
   permission org.apache.derby.security.SystemPermission "server", "monitor";  
  
-  // These permissions are needed when testing code instrumented with EMMA.
-  // They will only be used if the emma.active system property property is set,
-  // which should be set to "" for the permissions to be correct.
-  permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-  permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
-
   // resolve is needed to run ldap related tests 
   permission java.net.SocketPermission "${derbyTesting.ldapServer}", "connect, resolve";
 };
@@ -230,9 +223,6 @@ grant codeBase "${derbyTesting.testjar}derbyTesting.jar" {
   permission org.apache.derby.security.SystemPermission "engine", "monitor";
   permission org.apache.derby.security.SystemPermission "server", "control,monitor";
   
-  // These permissions are needed when testing code instrumented with EMMA.
-  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
-
   // resolve is needed to run ldap related tests
   permission java.net.SocketPermission "${derbyTesting.ldapServer}", "connect, resolve";
 };
@@ -317,11 +307,6 @@ grant codeBase "${derbyTesting.junit}" {
     // This permission is needed when running the tests using ant 1.7
     permission java.io.FilePermission "${user.dir}${/}*", "write";
   
-    // These permissions are needed when testing code instrumented with EMMA.
-    permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-    permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
-
   // resolve is needed to run ldap related tests
   permission java.net.SocketPermission "${derbyTesting.ldapServer}", "connect, resolve";
 };
@@ -343,11 +328,6 @@ grant codeBase "${derbyTesting.antjunit}" {
 
     // This permission is needed when running the tests using ant 1.7
     permission java.io.FilePermission "${user.dir}${/}*", "write";
-
-    // These permissions are needed when testing code instrumented with EMMA.
-    permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-    permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
 // functionTests.tests.lang.RoutineSecurityTest requires this grant
@@ -357,6 +337,17 @@ grant {
     permission java.util.PropertyPermission "derbyRoutineSecurityTest.yes", "read";
 };
 
+// These permissions are needed when testing code instrumented with EMMA.
+// They will only be used if the emma.active system property property is
+// set, which should be set to "" for the permissions to be correct. Must
+// be granted to all code bases because EMMA doesn't use doPrivileged
+// blocks around the code that needs the permissions.
+grant {
+  permission java.util.PropertyPermission "${emma.active}user.dir", "read";
+  permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
+  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
+};
+
 // When inserting XML values that use external DTD's, the JAXP parser
 // needs permission to read the DTD files.  We assume that all DTD
 // files will be copied to extin/ by whichever tests need them.  So
@@ -364,13 +355,3 @@ grant {
 grant codeBase "${derbyTesting.jaxpjar}" {
   permission java.io.FilePermission "${user.dir}${/}extin${/}-", "read";
 };
-
-
-// These permissions are needed when testing code instrumented with EMMA.
-// They are all related to writing coverage statistics to a file that by default
-// is named coverage.ec placed in the directory where the test is executed.
-grant codeBase "${derbyTesting.emma}" {
-    permission java.util.PropertyPermission "user.dir", "read";
-    permission java.io.FilePermission "${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "writeFileDescriptor";
-};
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/RoutineSecurityTest.java b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/RoutineSecurityTest.java
index fde650614..fb4980d51 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/RoutineSecurityTest.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/RoutineSecurityTest.java
@@ -96,8 +96,11 @@ public class RoutineSecurityTest extends BaseJDBCTestCase {
         
         String[] restricted = {
                 "derby.system.home", // not granted to all code on the stack
-                "user.dir",  // restricted by jvm
-                // "user.home",  // restricted by jvm
+                // DERBY-5514: Property read permission on user.dir is granted
+                // to all code bases when running code instrumented with EMMA,
+                // so reading the property will succeed under EMMA.
+                // "user.dir",  // restricted by jvm
+                "user.home",  // restricted by jvm
                 "java.class.path", // restricted by jvm
                 "java.home",  // restricted by jvm
                 "derbyRoutineSecurityTest.no", // not granted at all
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/store/Derby3980DeadlockTest.policy b/java/testing/org/apache/derbyTesting/functionTests/tests/store/Derby3980DeadlockTest.policy
index b9d488c60..6f025ba38 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/store/Derby3980DeadlockTest.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/store/Derby3980DeadlockTest.policy
@@ -124,13 +124,6 @@ grant codeBase "${derbyTesting.codejar}derby.jar" {
   permission org.apache.derby.security.SystemPermission "engine", "monitor";
   permission org.apache.derby.security.SystemPermission "server", "monitor";  
  
-  // These permissions are needed when testing code instrumented with EMMA.
-  // They will only be used if the emma.active system property property is set,
-  // which should be set to "" for the permissions to be correct.
-  permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-  permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
-  
   // These permissions are needed by AssertFailure to dump the thread stack
   // traces upon failure.
   permission java.lang.RuntimePermission "getStackTrace";
@@ -253,9 +246,6 @@ grant codeBase "${derbyTesting.testjar}derbyTesting.jar" {
   permission org.apache.derby.security.SystemPermission "jmx", "control";
   permission org.apache.derby.security.SystemPermission "engine", "monitor";
   permission org.apache.derby.security.SystemPermission "server", "control,monitor";
-  
-  // These permissions are needed when testing code instrumented with EMMA.
-  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
 //
@@ -341,11 +331,6 @@ grant codeBase "${derbyTesting.junit}" {
 
     // This permission is needed when running the tests using ant 1.7
     permission java.io.FilePermission "${user.dir}${/}-", "read, write, delete";
-  
-    // These permissions are needed when testing code instrumented with EMMA.
-    permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-    permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
 // Due to a problem running tests/derbynet/CompatibilityTest in the old test
@@ -365,11 +350,6 @@ grant codeBase "${derbyTesting.antjunit}" {
 
     // This permission is needed when running the tests using ant 1.7
     permission java.io.FilePermission "${user.dir}${/}*", "write";
-
-    // These permissions are needed when testing code instrumented with EMMA.
-    permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-    permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
 // functionTests.tests.lang.RoutineSecurityTest requires this grant
@@ -379,6 +359,17 @@ grant {
     permission java.util.PropertyPermission "derbyRoutineSecurityTest.yes", "read";
 };
 
+// These permissions are needed when testing code instrumented with EMMA.
+// They will only be used if the emma.active system property property is
+// set, which should be set to "" for the permissions to be correct. Must
+// be granted to all code bases because EMMA doesn't use doPrivileged
+// blocks around the code that needs the permissions.
+grant {
+  permission java.util.PropertyPermission "${emma.active}user.dir", "read";
+  permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
+  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
+};
+
 // When inserting XML values that use external DTD's, the JAXP parser
 // needs permission to read the DTD files.  We assume that all DTD
 // files will be copied to extin/ by whichever tests need them.  So
@@ -387,16 +378,6 @@ grant codeBase "${derbyTesting.jaxpjar}" {
   permission java.io.FilePermission "${user.dir}${/}extin${/}-", "read";
 };
 
-
-// These permissions are needed when testing code instrumented with EMMA.
-// They are all related to writing coverage statistics to a file that by default
-// is named coverage.ec placed in the directory where the test is executed.
-grant codeBase "${derbyTesting.emma}" {
-    permission java.util.PropertyPermission "user.dir", "read";
-    permission java.io.FilePermission "${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "writeFileDescriptor";
-};
-
 // Permissions for package-private tests run from 'classes.pptesting'
 grant codeBase "${derbyTesting.ppcodeclasses}" {
 
diff --git a/java/testing/org/apache/derbyTesting/functionTests/util/derby_tests.policy b/java/testing/org/apache/derbyTesting/functionTests/util/derby_tests.policy
index b5274512d..5c8fee2db 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/util/derby_tests.policy
+++ b/java/testing/org/apache/derbyTesting/functionTests/util/derby_tests.policy
@@ -122,13 +122,6 @@ grant codeBase "${derbyTesting.codejar}derby.jar" {
   permission org.apache.derby.security.SystemPermission "engine", "monitor";
   permission org.apache.derby.security.SystemPermission "server", "monitor";  
  
-  // These permissions are needed when testing code instrumented with EMMA.
-  // They will only be used if the emma.active system property property is set,
-  // which should be set to "" for the permissions to be correct.
-  permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-  permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
-  
   // These permissions are needed by AssertFailure to dump the thread stack
   // traces upon failure.
   permission java.lang.RuntimePermission "getStackTrace";
@@ -281,9 +274,6 @@ grant codeBase "${derbyTesting.testjar}derbyTesting.jar" {
   // This permission is needed to call the Connection.abort(Executor) method added by JDBC 4.1
   permission java.sql.SQLPermission "callAbort";
   
-  // These permissions are needed when testing code instrumented with EMMA.
-  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
-
   // Needed by FileUtil#limitAccessToOwner
   permission java.lang.RuntimePermission "accessUserInformation";
   permission java.lang.RuntimePermission "getFileStoreAttributes";
@@ -380,11 +370,6 @@ grant codeBase "${derbyTesting.junit}" {
 
     // This permission is needed when running the tests using ant 1.7
     permission java.io.FilePermission "${user.dir}${/}*", "write";
-  
-    // These permissions are needed when testing code instrumented with EMMA.
-    permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-    permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
 // Due to a problem running tests/derbynet/CompatibilityTest in the old test
@@ -404,11 +389,6 @@ grant codeBase "${derbyTesting.antjunit}" {
 
     // This permission is needed when running the tests using ant 1.7
     permission java.io.FilePermission "${user.dir}${/}*", "write";
-
-    // These permissions are needed when testing code instrumented with EMMA.
-    permission java.util.PropertyPermission "${emma.active}user.dir", "read";
-    permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
 };
 
 // functionTests.tests.lang.RoutineSecurityTest requires this grant
@@ -418,6 +398,17 @@ grant {
     permission java.util.PropertyPermission "derbyRoutineSecurityTest.yes", "read";
 };
 
+// These permissions are needed when testing code instrumented with EMMA.
+// They will only be used if the emma.active system property property is
+// set, which should be set to "" for the permissions to be correct. Must
+// be granted to all code bases because EMMA doesn't use doPrivileged
+// blocks around the code that needs the permissions.
+grant {
+  permission java.util.PropertyPermission "${emma.active}user.dir", "read";
+  permission java.io.FilePermission "${emma.active}${user.dir}${/}coverage.ec", "read, write";
+  permission java.lang.RuntimePermission "${emma.active}writeFileDescriptor";
+};
+
 // When inserting XML values that use external DTD's, the JAXP parser
 // needs permission to read the DTD files.  We assume that all DTD
 // files will be copied to extin/ by whichever tests need them.  So
@@ -426,16 +417,6 @@ grant codeBase "${derbyTesting.jaxpjar}" {
   permission java.io.FilePermission "${user.dir}${/}extin${/}-", "read";
 };
 
-
-// These permissions are needed when testing code instrumented with EMMA.
-// They are all related to writing coverage statistics to a file that by default
-// is named coverage.ec placed in the directory where the test is executed.
-grant codeBase "${derbyTesting.emma}" {
-    permission java.util.PropertyPermission "user.dir", "read";
-    permission java.io.FilePermission "${user.dir}${/}coverage.ec", "read, write";
-    permission java.lang.RuntimePermission "writeFileDescriptor";
-};
-
 // Permissions for package-private tests run from 'classes.pptesting'
 grant codeBase "${derbyTesting.ppcodeclasses}" {
 
diff --git a/java/testing/org/apache/derbyTesting/junit/SecurityManagerSetup.java b/java/testing/org/apache/derbyTesting/junit/SecurityManagerSetup.java
index 5b3ae7c3b..8d23f169e 100644
--- a/java/testing/org/apache/derbyTesting/junit/SecurityManagerSetup.java
+++ b/java/testing/org/apache/derbyTesting/junit/SecurityManagerSetup.java
@@ -277,7 +277,6 @@ public final class SecurityManagerSetup extends TestSetup {
         URL emma = getURL("com.vladium.emma.EMMAException");
         if (emma != null) {
             classPathSet.setProperty("emma.active", "");
-            classPathSet.setProperty("derbyTesting.emma", emma.toExternalForm());
         }
 		
         /* When inserting XML values that use external DTD's, the JAXP
