diff --git a/java/engine/org/apache/derby/impl/sql/compile/UpdateNode.java b/java/engine/org/apache/derby/impl/sql/compile/UpdateNode.java
index be17d0962..28c137b19 100644
--- a/java/engine/org/apache/derby/impl/sql/compile/UpdateNode.java
+++ b/java/engine/org/apache/derby/impl/sql/compile/UpdateNode.java
@@ -35,13 +35,11 @@ import org.apache.derby.iapi.services.classfile.VMOpcode;
 import org.apache.derby.iapi.services.compiler.MethodBuilder;
 import org.apache.derby.iapi.services.context.ContextManager;
 import org.apache.derby.iapi.services.io.FormatableBitSet;
-import org.apache.derby.shared.common.sanity.SanityManager;
 import org.apache.derby.iapi.sql.StatementType;
 import org.apache.derby.iapi.sql.compile.CompilerContext;
 import org.apache.derby.iapi.sql.compile.TagFilter;
 import org.apache.derby.iapi.sql.conn.Authorizer;
 import org.apache.derby.iapi.sql.conn.LanguageConnectionContext;
-import org.apache.derby.iapi.sql.dictionary.AliasDescriptor;
 import org.apache.derby.iapi.sql.dictionary.CheckConstraintDescriptor;
 import org.apache.derby.iapi.sql.dictionary.ColumnDescriptor;
 import org.apache.derby.iapi.sql.dictionary.ColumnDescriptorList;
@@ -49,16 +47,16 @@ import org.apache.derby.iapi.sql.dictionary.ConglomerateDescriptor;
 import org.apache.derby.iapi.sql.dictionary.ConstraintDescriptor;
 import org.apache.derby.iapi.sql.dictionary.ConstraintDescriptorList;
 import org.apache.derby.iapi.sql.dictionary.DataDictionary;
-import org.apache.derby.iapi.sql.dictionary.TriggerDescriptorList;
 import org.apache.derby.iapi.sql.dictionary.TableDescriptor;
 import org.apache.derby.iapi.sql.dictionary.TriggerDescriptor;
+import org.apache.derby.iapi.sql.dictionary.TriggerDescriptorList;
 import org.apache.derby.iapi.sql.execute.ConstantAction;
 import org.apache.derby.iapi.sql.execute.ExecPreparedStatement;
 import org.apache.derby.iapi.store.access.StaticCompiledOpenConglomInfo;
 import org.apache.derby.iapi.store.access.TransactionController;
-import org.apache.derby.iapi.types.DataTypeDescriptor;
 import org.apache.derby.iapi.types.TypeId;
 import org.apache.derby.iapi.util.ReuseFactory;
+import org.apache.derby.shared.common.sanity.SanityManager;
 import org.apache.derby.vti.DeferModification;
 
 /**
@@ -549,6 +547,9 @@ public final class UpdateNode extends DMLModStatementNode
         //
         if ( inMatchingClause() ) { associateAddedColumns(); }
 
+        // SQL 2011, section 6.10, SR 4b.
+        SelectNode.checkNoWindowFunctions(resultSet, "<update source>");
+
 		/* Bind the expressions */
 		super.bindExpressions();
 
diff --git a/java/engine/org/apache/derby/impl/sql/compile/WindowResultSetNode.java b/java/engine/org/apache/derby/impl/sql/compile/WindowResultSetNode.java
index e37c7ccd6..7ac709dcf 100644
--- a/java/engine/org/apache/derby/impl/sql/compile/WindowResultSetNode.java
+++ b/java/engine/org/apache/derby/impl/sql/compile/WindowResultSetNode.java
@@ -21,6 +21,7 @@
 package org.apache.derby.impl.sql.compile;
 
 import java.util.ArrayList;
+import java.util.Iterator;
 import java.util.List;
 import org.apache.derby.iapi.error.StandardException;
 import org.apache.derby.iapi.reference.ClassName;
@@ -58,6 +59,7 @@ class WindowResultSetNode extends SingleChildResultSetNode
      *
      * @exception StandardException     Thrown on error
      */
+    @SuppressWarnings("LeakingThisInConstructor")
     WindowResultSetNode(ResultSetNode            bottomPR,
                         WindowDefinitionNode     windowDef,
                         List<WindowFunctionNode> windowFuncCalls,
@@ -82,7 +84,7 @@ class WindowResultSetNode extends SingleChildResultSetNode
         setResultColumns( childResult.getResultColumns() );
         childResult.setResultColumns(newBottomRCL);
 
-        // Wrao purselved int a project/restrict as per convention.
+        // Wrap ourselves in a project/restrict as per convention.
         addNewPRNode();
 
         // Add the extra result columns required
@@ -92,7 +94,7 @@ class WindowResultSetNode extends SingleChildResultSetNode
     /**
      * Add a new PR node.  Put the new PR under any sort.
      *
-     * @exception standard exception
+     * @throws StandardException standard error policy
      */
     private void addNewPRNode()
         throws StandardException
@@ -167,9 +169,7 @@ class WindowResultSetNode extends SingleChildResultSetNode
         ResultColumnList bottomRCL  = childResult.getResultColumns();
         ResultColumnList windowingRCL = getResultColumns();
 
-        for (int i= 0; i< uniqueCols.size(); i++) {
-            ValueNode crOrVcn = uniqueCols.get(i);
-
+        for (ValueNode crOrVcn : uniqueCols) {
             ResultColumn newRC = new ResultColumn(
                     "##UnWindowingColumn",
                     crOrVcn,
@@ -209,15 +209,18 @@ class WindowResultSetNode extends SingleChildResultSetNode
 
 
     /**
+     * @param uniqueColRefs list of unique column references
+     * @param cand the candidate to check is present in list
      * @return {@code true} if an equivalent column reference to {@code cand}
      *         is already present in {@code uniqueColRefs}
+     * @throws StandardException standard error policy
      */
     private boolean colRefAlreadySeen(List<ValueNode> uniqueColRefs,
                                       ColumnReference cand)
             throws StandardException {
 
-        for (int i= 0; i< uniqueColRefs.size(); i++) {
-            ColumnReference cr = (ColumnReference)uniqueColRefs.get(i);
+        for (ValueNode uniqueColRef : uniqueColRefs) {
+            ColumnReference cr = (ColumnReference) uniqueColRef;
 
             if (cr.isEquivalent(cand)) {
                 return true;
@@ -229,6 +232,8 @@ class WindowResultSetNode extends SingleChildResultSetNode
     /**
      * Substitute new result columns for window function calls and add the
      * result columns to childResult's list of columns.
+     *
+     * @throws StandardException standard error policy
      */
     private void addNewColumns() throws StandardException {
         /*
@@ -246,8 +251,7 @@ class WindowResultSetNode extends SingleChildResultSetNode
                 ResultSetNode.class);
         parent.getResultColumns().accept(replaceCallsVisitor);
 
-        for (int i=0; i < windowFuncCalls.size(); i++) {
-            WindowFunctionNode winFunc = windowFuncCalls.get(i);
+        for (WindowFunctionNode winFunc : windowFuncCalls) {
 
             if (SanityManager.DEBUG) {
                 SanityManager.ASSERT(
@@ -307,10 +311,6 @@ class WindowResultSetNode extends SingleChildResultSetNode
     }
 
 
-    /**
-     * override
-     * @see QueryTreeNode#generate
-     */
     @Override
     void generate(ActivationClassBuilder acb, MethodBuilder mb)
             throws StandardException
diff --git a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/OLAPTest.java b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/OLAPTest.java
index e4673c0fa..34a61e52d 100644
--- a/java/testing/org/apache/derbyTesting/functionTests/tests/lang/OLAPTest.java
+++ b/java/testing/org/apache/derbyTesting/functionTests/tests/lang/OLAPTest.java
@@ -587,6 +587,12 @@ public class OLAPTest extends BaseJDBCTestCase {
             s,
             "select * from t4 t_1 join t4 t_2 on " +
             "                     t_1.a = row_number() over () + t_2.a");
+
+        // DERBY-6565
+        assertStatementError(
+                LANG_WINDOW_FUNCTION_CONTEXT_ERROR,
+                s,
+                "update t3 set y = y - row_number() over ()");
     }
 
 
