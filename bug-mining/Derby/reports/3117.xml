<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 14:50:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DERBY-6741] User code can get the ContextManager from an EmbedConnection</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6741</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;EmbedConnection.getContextManager() is a public method. Exposing internals like the ContextManager is a security risk.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12741986">DERBY-6741</key>
            <summary>User code can get the ContextManager from an EmbedConnection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rhillegas">Richard N. Hillegas</assignee>
                                    <reporter username="rhillegas">Richard N. Hillegas</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Sep 2014 23:09:42 +0000</created>
                <updated>Fri, 17 Jul 2015 00:22:51 +0000</updated>
                            <resolved>Wed, 21 Jan 2015 23:36:28 +0000</resolved>
                                                    <fixVersion>10.12.1.1</fixVersion>
                                    <component>JDBC</component>
                    <component>Services</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14140697" author="rhillegas" created="Fri, 19 Sep 2014 15:03:20 +0000"  >&lt;p&gt;Attaching derby-6741-01-aa-usederbyinternals.diff. This patch guards this method with a check for usederbyinternals permission. I am running tests now.&lt;/p&gt;

&lt;p&gt;I could not make the method private because it is used by EmbedXAResource.&lt;/p&gt;

&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/impl/jdbc/EmbedConnection.java&lt;br/&gt;
M       java/engine/org/apache/derby/jdbc/EmbedXAResource.java&lt;/p&gt;

&lt;p&gt;Add check for usederbyinternals.&lt;/p&gt;

&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/ConstraintCharacteristicsTest.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/NewOptimizerOverridesTest.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/resultSetReader.policy&lt;/p&gt;

&lt;p&gt;Corresponding changes to tests.&lt;/p&gt;

&lt;p&gt;-------------&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/NoDBInternalsPermissionTest.java&lt;/p&gt;

&lt;p&gt;New test to verify that user code can&apos;t call EmbedConnection.getContextManager().&lt;/p&gt;</comment>
                            <comment id="14140872" author="jira-bot" created="Fri, 19 Sep 2014 16:57:04 +0000"  >&lt;p&gt;Commit 1626274 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhillegas&quot; class=&quot;user-hover&quot; rel=&quot;rhillegas&quot;&gt;rhillegas&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1626274&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1626274&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6741&quot; title=&quot;User code can get the ContextManager from an EmbedConnection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6741&quot;&gt;&lt;del&gt;DERBY-6741&lt;/del&gt;&lt;/a&gt;: Add a privilege barrier to prevent users from getting a ContextManager from an embedded connection object; tests passed cleanly on derby-6741-01-aa-usederbyinternals.diff.&lt;/p&gt;</comment>
                            <comment id="14286333" author="myrna" created="Wed, 21 Jan 2015 21:41:38 +0000"  >&lt;p&gt;Is there more work needed for this issue?&lt;/p&gt;</comment>
                            <comment id="14623467" author="bryanpendleton" created="Sat, 11 Jul 2015 16:19:39 +0000"  >&lt;p&gt;With OpenJDK 1.8.0_45 running on Fedora22, I see highly intermittent&lt;br/&gt;
failures in &lt;/p&gt;

&lt;p&gt;    NoDBInternalsPermissionTest.test_002_EmbedConnection&lt;/p&gt;

&lt;p&gt;My error is:&lt;/p&gt;

&lt;p&gt;java.security.AccessControlException: access denied org.apache.derby.security.SystemPermission( &quot;engine&quot;, &quot;usederbyinternals&quot; )&lt;br/&gt;
        at java.security.AccessControlContext.checkPermission(AccessControlContext.java:457) &lt;br/&gt;
        at java.security.AccessController.checkPermission(AccessController.java:884) &lt;br/&gt;
        at org.apache.derby.iapi.security.SecurityUtil.checkDerbyInternalsPrivilege(SecurityUtil.java:221)&lt;br/&gt;
        at org.apache.derby.iapi.services.monitor.Monitor.getMonitorLite(Monitor.java:339)&lt;br/&gt;
        at org.apache.derby.iapi.services.property.PropertyUtil$2.run(PropertyUtil.java:719)&lt;br/&gt;
        at org.apache.derby.iapi.services.property.PropertyUtil$2.run(PropertyUtil.java:716)&lt;br/&gt;
        at java.security.AccessController.doPrivileged(Native Method)&lt;/p&gt;

&lt;p&gt;The error is quite hard to reproduce, and seems only to happen in large suite runs.&lt;/p&gt;

&lt;p&gt;Any thoughts on what might be happening?&lt;/p&gt;</comment>
                            <comment id="14623851" author="rhillegas" created="Sun, 12 Jul 2015 15:29:05 +0000"  >&lt;p&gt;Hi Bryan,&lt;/p&gt;

&lt;p&gt;That test is supposed to raise (and catch) an AccessControlException. It looks like the exception was raised but not caught. Can you post the whole stack trace?&lt;/p&gt;

&lt;p&gt;I usually run tests with 1.7. I&apos;ve switched to 1.8 and am running a full test run now.  Will let you know what I see.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="14623921" author="rhillegas" created="Sun, 12 Jul 2015 17:55:26 +0000"  >&lt;p&gt;I ran the full regression suite on my macbook pro using this Oracle vm: 1.8.0-b132. I did not see any errors in NoDBInternalsPermissionTest. However, I did see this instability:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;There was 1 failure:
1) spawnProcess:JDBCDriversEmbeddedTest(org.apache.derbyTesting.functionTests.tests.jdbcapi.AutoloadTest)junit.framework.AssertionFailedError: subprocess run failed: exit code==143

[ (stdout subprocess) .......]

[ (stderr subprocess) ]



[Subprocess 4416 hanging, jstack result:2015-07-12 09:46:12
Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.0-b70 mixed mode):

&quot;Attach Listener&quot; #18 daemon prio=9 os_prio=31 tid=0x00007fb8459af000 nid=0x410b waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;Service Thread&quot; #8 daemon prio=9 os_prio=31 tid=0x00007fb84388f800 nid=0x5603 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;C1 CompilerThread2&quot; #7 daemon prio=9 os_prio=31 tid=0x00007fb843867000 nid=0x5403 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;C2 CompilerThread1&quot; #6 daemon prio=9 os_prio=31 tid=0x00007fb843866800 nid=0x5203 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;C2 CompilerThread0&quot; #5 daemon prio=9 os_prio=31 tid=0x00007fb843870800 nid=0x5003 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;Signal Dispatcher&quot; #4 daemon prio=9 os_prio=31 tid=0x00007fb84384b800 nid=0x4e03 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;Finalizer&quot; #3 daemon prio=8 os_prio=31 tid=0x00007fb843848000 nid=0x3e03 in Object.wait() [0x000000011eb38000]
   java.lang.Thread.State: WAITING (on object monitor)
	at java.lang.Object.wait(Native Method)
	- waiting on &amp;lt;0x0000000780122798&amp;gt; (a java.lang.ref.ReferenceQueue$Lock)
	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:142)
	- locked &amp;lt;0x0000000780122798&amp;gt; (a java.lang.ref.ReferenceQueue$Lock)
	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:158)
	at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:209)

&quot;Reference Handler&quot; #2 daemon prio=10 os_prio=31 tid=0x00007fb843847800 nid=0x3c03 in Object.wait() [0x000000011ea35000]
   java.lang.Thread.State: WAITING (on object monitor)
	at java.lang.Object.wait(Native Method)
	- waiting on &amp;lt;0x0000000780138d68&amp;gt; (a java.lang.ref.Reference$Lock)
	at java.lang.Object.wait(Object.java:502)
	at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:157)
	- locked &amp;lt;0x0000000780138d68&amp;gt; (a java.lang.ref.Reference$Lock)

&quot;main&quot; #1 prio=5 os_prio=31 tid=0x00007fb845800000 nid=0x1d03 waiting on condition [0x000000010b042000]
   java.lang.Thread.State: TIMED_WAITING (sleeping)
	at java.lang.Thread.sleep(Native Method)
	at org.apache.derbyTesting.junit.NetworkServerTestSetup.waitForAvailablePort(NetworkServerTestSetup.java:276)
	at org.apache.derbyTesting.junit.NetworkServerTestSetup.waitForAvailablePort(NetworkServerTestSetup.java:244)
	at org.apache.derbyTesting.junit.NetworkServerTestSetup.setUp(NetworkServerTestSetup.java:203)
	at junit.extensions.TestSetup$1.protect(TestSetup.java:20)
	at junit.extensions.TestSetup.run(TestSetup.java:25)
	at org.apache.derbyTesting.junit.BaseTestSetup.run(BaseTestSetup.java:58)
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)
	at junit.extensions.TestSetup.run(TestSetup.java:25)

&quot;VM Thread&quot; os_prio=31 tid=0x00007fb843843000 nid=0x3a03 runnable 

&quot;GC task thread#0 (ParallelGC)&quot; os_prio=31 tid=0x00007fb84580d000 nid=0x3203 runnable 

&quot;GC task thread#1 (ParallelGC)&quot; os_prio=31 tid=0x00007fb84580e000 nid=0x3403 runnable 

&quot;GC task thread#2 (ParallelGC)&quot; os_prio=31 tid=0x00007fb84580e800 nid=0x3603 runnable 

&quot;GC task thread#3 (ParallelGC)&quot; os_prio=31 tid=0x00007fb84580f000 nid=0x3803 runnable 

&quot;VM Periodic Task Thread&quot; os_prio=31 tid=0x00007fb84384a800 nid=0x5803 waiting on condition 

JNI global references: 48

End of jstack output]


	at org.apache.derbyTesting.functionTests.tests.jdbcapi.AutoloadTest.spawnProcess(AutoloadTest.java:319)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at org.apache.derbyTesting.junit.BaseTestCase.runBare(BaseTestCase.java:120)
	at org.apache.derbyTesting.junit.BaseJDBCTestCase.runBareOverridable(BaseJDBCTestCase.java:443)
	at org.apache.derbyTesting.junit.BaseJDBCTestCase.runBare(BaseJDBCTestCase.java:460)
	at junit.extensions.TestDecorator.basicRun(TestDecorator.java:24)
	at junit.extensions.TestSetup$1.protect(TestSetup.java:21)
	at junit.extensions.TestSetup.run(TestSetup.java:25)

FAILURES!!!
Tests run: 13851,  Failures: 1,  Errors: 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I will try to reproduce the NoDBInternalsPermissionTest heisenbug on my Ubuntu laptop.&lt;/p&gt;

&lt;p&gt;Making some wild guesses about what might be going on: It could be that there&apos;s some instability related to the resetting of the security manager which happens between tests. That instability might be sensitive to the order in which tests are run. That order, in turn, may vary between VMs. Maybe it varies between runs on the Linux VM.&lt;/p&gt;</comment>
                            <comment id="14624081" author="rhillegas" created="Mon, 13 Jul 2015 00:45:01 +0000"  >&lt;p&gt;I ran the full tests on my ubuntu laptop on the Oracle 1.8.0_45-b14 vm. I didn&apos;t see any errors.&lt;/p&gt;</comment>
                            <comment id="14624127" author="bryanpendleton" created="Mon, 13 Jul 2015 02:09:18 +0000"  >&lt;p&gt;Thanks Rick. If I can provoke it again, I&apos;ll capture more details.&lt;/p&gt;</comment>
                            <comment id="14625687" author="bryanpendleton" created="Tue, 14 Jul 2015 02:04:36 +0000"  >&lt;p&gt;I saw another failure in my test run. Attached are the derby.log and&lt;br/&gt;
error-stacktrace.out from fail/Embedded_40/NoDBInternalsPermissionTest/test_002_EmbedConnection&lt;/p&gt;</comment>
                            <comment id="14625693" author="bryanpendleton" created="Tue, 14 Jul 2015 02:12:22 +0000"  >&lt;p&gt;It looks like the critical line is line 138 of NoDBInternalsPermissionTest.java,&lt;br/&gt;
which is not inside the try {} block. &lt;/p&gt;

&lt;p&gt;That is, perhaps:&lt;/p&gt;

&lt;p&gt;    public  void    test_002_EmbedConnection()&lt;br/&gt;
        throws Exception&lt;br/&gt;
    {&lt;br/&gt;
        Connection  conn = getConnection();&lt;br/&gt;
        try &lt;/p&gt;
{
            ((EmbedConnection) conn).getContextManager();
            fail( &quot;Should have raised an AccessControlException&quot; );
        }
&lt;p&gt;        catch (AccessControlException e) &lt;/p&gt;
{ println( &quot;Caught an AccessControlException&quot; ); }&lt;br/&gt;
    }&lt;br/&gt;
&lt;br/&gt;
should be:&lt;br/&gt;
&lt;br/&gt;
    public  void    test_002_EmbedConnection()&lt;br/&gt;
        throws Exception&lt;br/&gt;
    {&lt;br/&gt;
        try {
            Connection  conn = getConnection();
            ((EmbedConnection) conn).getContextManager();
            fail( &quot;Should have raised an AccessControlException&quot; );
        }&lt;br/&gt;
        catch (AccessControlException e) { println( &quot;Caught an AccessControlException&quot; ); }
&lt;p&gt;    }&lt;/p&gt;</comment>
                            <comment id="14626993" author="rhillegas" created="Tue, 14 Jul 2015 20:26:37 +0000"  >&lt;p&gt;Hi Bryan,&lt;/p&gt;

&lt;p&gt;There is a similar code block in NoDBInternalsPermissionTest.test_005_EmbedConnection_getLCC(). There the call to getConnection() is inside the try block. Could you move the getConnection() in NoDBInternalsPermissionTest.test_002_EmbedConnection() inside the try block and see if that makes the problem go away on your machine?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="14627498" author="bryanpendleton" created="Wed, 15 Jul 2015 04:33:24 +0000"  >&lt;p&gt;Indeed, that makes the test reliable for me.&lt;/p&gt;</comment>
                            <comment id="14630589" author="jira-bot" created="Fri, 17 Jul 2015 00:22:51 +0000"  >&lt;p&gt;Commit 1691466 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bryanpendleton&quot; class=&quot;user-hover&quot; rel=&quot;bryanpendleton&quot;&gt;bryanpendleton&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1691466&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1691466&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6741&quot; title=&quot;User code can get the ContextManager from an EmbedConnection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6741&quot;&gt;&lt;del&gt;DERBY-6741&lt;/del&gt;&lt;/a&gt;: User code can get the ContextManager from an EmbedConnection&lt;/p&gt;

&lt;p&gt;This change adjusts NoDBInternalsPermissionTest so that the try block in&lt;br/&gt;
test_002_EmbedConnection covers the getConnection() call. At least in my&lt;br/&gt;
particular configuration, the getConnection() call can raise the (expected)&lt;br/&gt;
AccessControlException due to this test&apos;s security policy.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12725352">DERBY-6648</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12670014" name="derby-6741-01-aa-usederbyinternals.diff" size="8559" author="rhillegas" created="Fri, 19 Sep 2014 15:03:20 +0000"/>
                            <attachment id="12745164" name="derby.log" size="1674289" author="bryanpendleton" created="Tue, 14 Jul 2015 02:04:36 +0000"/>
                            <attachment id="12745163" name="error-stacktrace.out" size="4672" author="bryanpendleton" created="Tue, 14 Jul 2015 02:04:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10361"><![CDATA[Security]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 18 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i204r3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>