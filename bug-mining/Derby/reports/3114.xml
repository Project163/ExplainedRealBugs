<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 14:50:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DERBY-6783] WHEN clause in CREATE TRIGGER for UPDATE is not working for the sql script below</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6783</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Following sql script was shared on derby-user(&lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/db-derby-user/201412.mbox/%3c548ABA6D.8000509@zoho.com%3e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.apache.org/mod_mbox/db-derby-user/201412.mbox/%3c548ABA6D.8000509@zoho.com%3e&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;The UPDATE TRIGGER  with the WHEN clause below does not fire as expected. Same script works fine on DB2.&lt;br/&gt;
ij version 10.11 &lt;br/&gt;
 ij&amp;gt; connect &apos;jdbc:derby:MyDbTest;create=true&apos;; &lt;br/&gt;
 ij&amp;gt; CREATE TABLE t1 (id INTEGER, done_date DATE, status CHAR(1)); &lt;br/&gt;
 0 rows inserted/updated/deleted &lt;br/&gt;
 ij&amp;gt; CREATE TRIGGER tr1 AFTER UPDATE OF status ON t1 REFERENCING NEW AS newrow FOR EACH ROW WHEN (newrow.status=&apos;d&apos;) UPDATE t1 SET done_date=current_date WHERE id=newrow.id; &lt;br/&gt;
 0 rows inserted/updated/deleted &lt;br/&gt;
 ij&amp;gt; insert into t1 values (1, null, &apos;a&apos;); &lt;br/&gt;
 1 row inserted/updated/deleted &lt;br/&gt;
 ij&amp;gt; SELECT * FROM t1; &lt;br/&gt;
 ID         |DONE_DATE |STA&amp;amp; &lt;br/&gt;
 --------------------------- &lt;br/&gt;
 1          |NULL      |a    &lt;/p&gt;

&lt;p&gt; 1 row selected &lt;br/&gt;
 ij&amp;gt; UPDATE t1 SET status=&apos;d&apos;; &lt;br/&gt;
 1 row inserted/updated/deleted &lt;br/&gt;
 ij&amp;gt; SELECT * FROM t1; &lt;br/&gt;
 ID         |DONE_DATE |STA&amp;amp; &lt;br/&gt;
 --------------------------- &lt;br/&gt;
 1          |NULL      |d    &lt;/p&gt;

&lt;p&gt; 1 row selected &lt;br/&gt;
 ij&amp;gt; exit; &lt;/p&gt;</description>
                <environment></environment>
        <key id="12761462">DERBY-6783</key>
            <summary>WHEN clause in CREATE TRIGGER for UPDATE is not working for the sql script below</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mac777">Abhinav Gupta</assignee>
                                    <reporter username="mamtas">Mamta A. Satoor</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Dec 2014 22:05:59 +0000</created>
                <updated>Sat, 1 Oct 2016 17:53:22 +0000</updated>
                            <resolved>Sat, 18 Jul 2015 18:25:48 +0000</resolved>
                                    <version>10.11.1.1</version>
                                    <fixVersion>10.12.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14250299" author="mamtas" created="Wed, 17 Dec 2014 18:48:14 +0000"  >&lt;p&gt;WHEN clause was added in release 10.11 so this issue is specific to 10.11.&lt;/p&gt;</comment>
                            <comment id="14550547" author="mac777" created="Tue, 19 May 2015 14:43:13 +0000"  >&lt;p&gt;Test Case for Derby-6783.&lt;/p&gt;</comment>
                            <comment id="14553518" author="bryanpendleton" created="Thu, 21 May 2015 02:14:11 +0000"  >&lt;p&gt;Abhinav, would it be easier to write a test case for this scenario if we used&lt;br/&gt;
a different data type for the second column (&quot;done_date&quot;) of T1?&lt;/p&gt;

&lt;p&gt;For example, could we make the schema for T1 be:  (id INTEGER, result VARCHAR(10), status CHAR(1));&lt;br/&gt;
And then change the trigger from &quot;SET done_date=current_date&quot; to&lt;br/&gt;
&quot;set result=&apos;completed&apos; &quot;?&lt;/p&gt;

&lt;p&gt;If the bug still reproduces with a string column rather than a date column,&lt;br/&gt;
perhaps that makes it easier to write the test code in your new test case?&lt;/p&gt;</comment>
                            <comment id="14556685" author="mac777" created="Fri, 22 May 2015 19:30:40 +0000"  >&lt;p&gt;Hi Bryan,&lt;/p&gt;

&lt;p&gt;Could please guide me on how to run derby from different sandbox. I&apos;ve&lt;br/&gt;
created a sandbox for this bug and I&apos;ve made few changes to try out but I&apos;m&lt;br/&gt;
not sure how to go about it after rebuilding the code.&lt;/p&gt;

&lt;p&gt;Thank you,&lt;/p&gt;

&lt;p&gt;Abhinav.&lt;/p&gt;

&lt;p&gt;On Thu, May 21, 2015 at 7:45 AM, Bryan Pendleton (JIRA) &amp;lt;jira@apache.org&amp;gt;&lt;/p&gt;
</comment>
                            <comment id="14557129" author="bryanpendleton" created="Sat, 23 May 2015 04:46:43 +0000"  >&lt;p&gt;Since your new test case is added to one of the existing Derby JUnit test suites&lt;br/&gt;
(TriggerWhenClauseTest.java), it should be pretty straightforward to run it. You&lt;br/&gt;
should be able to follow the instructions here:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;http://wiki.apache.org/db-derby/DerbyJUnitTesting#Running_Tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://wiki.apache.org/db-derby/DerbyJUnitTesting#Running_Tests&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So for example in your case I think you should be able to do:&lt;/p&gt;

&lt;p&gt;    ant -Dderby.junit.testclass=org.apache.derbyTesting.functionTests.tests.lang.TriggerWhenClauseTest junit-single&lt;/p&gt;</comment>
                            <comment id="14557858" author="bryanpendleton" created="Sun, 24 May 2015 21:49:20 +0000"  >&lt;p&gt;I was able to download the latest testcase and apply it; when I run it with ant, I get:&lt;/p&gt;

&lt;p&gt;java.sql.SQLSyntaxErrorException: Column &apos;DONE_DATE&apos; is either not in any table&lt;br/&gt;
in the FROM list or appears within a join specification and is outside the scope&lt;br/&gt;
 of the join specification or appears in a HAVING clause and is not in the GROUP&lt;br/&gt;
 BY list. If this is a CREATE or ALTER TABLE  statement then &apos;DONE_DATE&apos; is not&lt;br/&gt;
a column in the target table.&lt;/p&gt;

&lt;p&gt;in fail\Embedded_40\TriggerWhenClauseTest\testDerby6783\error-stacktrace.out&lt;/p&gt;

&lt;p&gt;When I change the last query in the new test case from  &apos;SELECT done_date FROM t1&apos;&lt;br/&gt;
to &apos;SELECT result FROM t1&apos;, the new test case then runs, and I get:&lt;/p&gt;

&lt;p&gt;junit.framework.AssertionFailedError: Column value mismatch @ column &apos;RESULT&apos;, row 1:&lt;br/&gt;
    Expected: &amp;gt;completed&amp;lt;&lt;br/&gt;
    Found:    &amp;gt;null&amp;lt;&lt;/p&gt;

&lt;p&gt;in my error-stacktrace.out, which I think is the expected behavior since we haven&apos;t fixed the bug yet.&lt;/p&gt;

&lt;p&gt;So I think the new test case demonstrates the bug, once the typo in the last SQL statement is fixed.&lt;/p&gt;</comment>
                            <comment id="14562268" author="bryanpendleton" created="Thu, 28 May 2015 04:15:26 +0000"  >&lt;p&gt;Updated test case, together with print statements in the&lt;br/&gt;
trigger execution logic to demonstrate where the logic&lt;br/&gt;
goes wrong. See my message to derby-dev for detailed&lt;br/&gt;
description of my results with this patch.&lt;/p&gt;</comment>
                            <comment id="14564136" author="bryanpendleton" created="Fri, 29 May 2015 03:13:37 +0000"  >&lt;p&gt;In DataDictionaryImpl.getTriggerActionString, there is some very complex logic&lt;br/&gt;
which computes the &quot;table position&quot; of each column in the trigger versus the&lt;br/&gt;
&quot;trigger position&quot; of that column (the terms &quot;table position&quot; and &quot;trigger position&quot;&lt;br/&gt;
are mine; they do not arise directly in the code).&lt;/p&gt;

&lt;p&gt;In this code, in our test case, the data structures correctly represent that the&lt;br/&gt;
STATUS column is column 3 in the base table:&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Trigger column is STATUS, so columnDescriptor is columnName: STATUS&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; columnPosition: 3&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; columnType: CHAR(1)&lt;/p&gt;

&lt;p&gt;But then, at the point where that method builds the &quot;triggerColsAndTriggerActionCols&quot;&lt;br/&gt;
variable, it thinks that &quot;STATUS&quot; is the only column that will be retrieved, and so&lt;br/&gt;
it sets the column position to 1.&lt;/p&gt;

&lt;p&gt;But, in fact, the execution of the query retrieves &lt;b&gt;two&lt;/b&gt; columns: ID and STATUS, to&lt;br/&gt;
the correct column position should have been 2.&lt;/p&gt;

&lt;p&gt;So I think that the bug arises in DataDictionaryImpl.getTriggerActionString.&lt;/p&gt;

&lt;p&gt;Interestingly, we seem to call this routine &lt;b&gt;twice&lt;/b&gt;: once with the set of columns (ID,STATUS),&lt;br/&gt;
and once with only (STATUS) in the column list.&lt;/p&gt;

&lt;p&gt;So possibly the flaw is that either (a) we should only be calling this routine once, or&lt;br/&gt;
(b) we should be calling it twice, but in each case the column list should be&lt;br/&gt;
(ID,STATUS), but in the second case the column list is wrong, it is only (STATUS).&lt;/p&gt;

&lt;p&gt;Abhinav, perhaps you can focus your attention on DataDictionaryImpl.getTriggerActionString&lt;br/&gt;
for a while and tell me what you think about how this method is interpreting the trigger&lt;br/&gt;
definition in this particular test case.&lt;/p&gt;</comment>
                            <comment id="14565214" author="bryanpendleton" created="Fri, 29 May 2015 18:53:10 +0000"  >&lt;p&gt;Here&apos;s a workaround: If the trigger definition is changed to:&lt;/p&gt;

&lt;p&gt;   CREATE TRIGGER tr1 AFTER UPDATE OF status ON t1 &lt;br/&gt;
         REFERENCING NEW AS newrow FOR EACH ROW &lt;br/&gt;
        WHEN (newrow.id &amp;gt; 0 and newrow.status=&apos;d&apos;) &lt;br/&gt;
        UPDATE t1 SET done_date=current_date WHERE id=newrow.id;&lt;/p&gt;

&lt;p&gt;then everything works fine.&lt;/p&gt;

&lt;p&gt;The reason this workaround works is that it causes the set of columns&lt;br/&gt;
in the trigger&apos;s WHEN clause (id, status) to be the same as the set&lt;br/&gt;
of columns in the trigger&apos;s REFERENCING clause (id, status).&lt;/p&gt;</comment>
                            <comment id="14565277" author="bryanpendleton" created="Fri, 29 May 2015 19:41:11 +0000"  >&lt;p&gt;My theory is that the root cause of this bug is the following code from CreateTriggerNode.bindReferencesClause():&lt;/p&gt;

&lt;p&gt;            //Now that we have verified that are no invalid column references&lt;br/&gt;
            //for trigger columns, let&apos;s go ahead and transform the OLD/NEW&lt;br/&gt;
            //transient table references in the trigger action sql.&lt;br/&gt;
            transformedActionText = getDataDictionary().getTriggerActionString(a&lt;br/&gt;
ctionNode,&lt;br/&gt;
                    oldTableName,&lt;br/&gt;
                    newTableName,&lt;br/&gt;
                    originalActionText,&lt;br/&gt;
                    referencedColInts,&lt;br/&gt;
                    referencedColsInTriggerAction,&lt;br/&gt;
                    actionNode.getBeginOffset(),&lt;br/&gt;
                    triggerTableDescriptor,&lt;br/&gt;
                    triggerEventMask,&lt;br/&gt;
                    true,&lt;br/&gt;
                    actionTransformations);&lt;/p&gt;

&lt;p&gt;            // If there is a WHEN clause, we need to transform its text too.&lt;br/&gt;
            if (whenClause != null) &lt;/p&gt;
{
                transformedWhenText =
                    getDataDictionary().getTriggerActionString(
                            whenClause, oldTableName, newTableName,
                            originalWhenText, referencedColInts,
                            referencedColsInTriggerAction,
                            whenClause.getBeginOffset(),
                            triggerTableDescriptor, triggerEventMask, true,
                            whenClauseTransformations);
            }

&lt;p&gt;Note that this code calls getTriggerActionString() twice.&lt;/p&gt;

&lt;p&gt;The first time, we are working with the Trigger &quot;action node&quot;, which references the column &quot;id&quot;:&lt;/p&gt;

&lt;p&gt;    UPDATE t1 SET done_date=current_date WHERE id=newrow.id;&lt;/p&gt;

&lt;p&gt;and also references the column &quot;status&quot;:&lt;/p&gt;

&lt;p&gt;    AFTER UPDATE OF status ON t1&lt;/p&gt;

&lt;p&gt;The second time, we are working with the Trigger &quot;when node&quot;, which references the column &quot;status&quot;:&lt;/p&gt;

&lt;p&gt;    WHEN (newrow.status=&apos;d&apos;)&lt;/p&gt;

&lt;p&gt;and also references the column &quot;status&quot;:&lt;/p&gt;

&lt;p&gt;    AFTER UPDATE OF status ON t1&lt;/p&gt;

&lt;p&gt;The net result is that, the first time through, we determine that we will have two columns (id, status),&lt;br/&gt;
but the second time through, we incorrectly determine that the &apos;newrow&apos; will have only one column (status),&lt;br/&gt;
and therefore we generate the reference to column 1, thinking we will be referencing the column &quot;status&quot;,&lt;br/&gt;
but instead we end up referencing the column &quot;id&quot;.&lt;/p&gt;

&lt;p&gt;To fix this bug, we have to somehow change the compilation of the trigger so that it&lt;br/&gt;
computes the set of columns that we will need in &apos;newrow&apos; exactly once, and use that&lt;br/&gt;
set of columns for compiling both the action node and the when node, instead of&lt;br/&gt;
computing their column sets independently.&lt;/p&gt;</comment>
                            <comment id="14582775" author="bryanpendleton" created="Fri, 12 Jun 2015 01:11:36 +0000"  >&lt;p&gt;Hi Abhinav, I spent some time today studying your latest patch.&lt;/p&gt;

&lt;p&gt;I think we are making progress!&lt;/p&gt;

&lt;p&gt;I made a few small changes to your patch, and have attached mine.&lt;/p&gt;

&lt;p&gt;1) In CreateTriggerNode, I removed the &quot;whenCols&quot; variable, and just&lt;br/&gt;
   used the &quot;cols&quot; variable in both places, because I think we want to&lt;br/&gt;
   combine the two sets of variables into one list.&lt;/p&gt;

&lt;p&gt;2) In DataDictionaryImpl.examineTriggerNodeAndCols(), I added a&lt;br/&gt;
   couple lines of code to initialize triggerColsAndTriggerActionCols&lt;br/&gt;
   from referencedColsInTriggerAction, if it is passed, so that the&lt;br/&gt;
   columns we computed in the first invocation get carried through&lt;br/&gt;
   into the second invocation.&lt;/p&gt;

&lt;p&gt;3) In DataDictionaryImpl.getTriggerActionString(), I changed the&lt;br/&gt;
   handling of &quot;cols = null&quot;. We still want to execute most of the code&lt;br/&gt;
   in this method even if cols = null, but in that case we need to&lt;br/&gt;
   set triggerColsAndTriggerActionCols to contain the entire set of&lt;br/&gt;
   columns in the table.&lt;/p&gt;

&lt;p&gt;The overall set of changes from your patch to mine was very small;&lt;br/&gt;
the easiest way to see this is to &quot;diff the diffs&quot; &amp;#8211; that is, download&lt;br/&gt;
your patch and my patch and put them together in a directory&lt;br/&gt;
and diff them.&lt;/p&gt;

&lt;p&gt;With the patch that I&apos;ve attached, we now pass all of the test&lt;br/&gt;
cases in TriggerWhenClauseTest except for the new &quot;testDerby6783_1&quot;&lt;br/&gt;
test, which I think is a brand new test that you have just added. That&lt;br/&gt;
test gets the error:&lt;/p&gt;

&lt;p&gt;ERROR 22001: A truncation error was encountered trying to shrink CHAR &apos;20&apos; to length 1.&lt;/p&gt;

&lt;p&gt;So clearly there are still some issues with our patch, but I felt like&lt;br/&gt;
this was good progress and wanted to share it with you.&lt;/p&gt;

&lt;p&gt;Do try to download my latest patch and let me know what you think!&lt;/p&gt;</comment>
                            <comment id="14593024" author="bryanpendleton" created="Fri, 19 Jun 2015 05:19:00 +0000"  >&lt;p&gt;Slightly-tweaked copy of 6783_moreTests.diff; see the discussion&lt;br/&gt;
on derby-dev for some background about the change related to&lt;br/&gt;
 sortTriggerColsAndTriggerActionCols()&lt;/p&gt;</comment>
                            <comment id="14595231" author="bryanpendleton" created="Sun, 21 Jun 2015 22:35:22 +0000"  >&lt;p&gt;I realize that I suggested on the derby-dev list that we take this opportunity&lt;br/&gt;
to clean up the comments in DataDictionaryImpl, but upon further reflection&lt;br/&gt;
I decided that I had made a not-so-good suggestion when I said that.&lt;/p&gt;

&lt;p&gt;Although your new comments were in fact easier to read, they made the&lt;br/&gt;
overall diff substantially larger and harder to read, and I thought this&lt;br/&gt;
made it harder to read the diff and understand precisely what we were&lt;br/&gt;
changing.&lt;/p&gt;

&lt;p&gt;So I restored the original comments.&lt;/p&gt;

&lt;p&gt;I also removed the parts of the overall patch which were simply&lt;br/&gt;
diagnostic traces that we had added during our study of the behavior.&lt;/p&gt;

&lt;p&gt;So the latest &quot;cleanedUpDiff.patch&quot; is just the code changes and test&lt;br/&gt;
changes that I think we really want to keep, with the other changes removed.&lt;/p&gt;

&lt;p&gt;I still feel like the return code of examineTriggerNodeAndCols&lt;br/&gt;
should not be &quot;String&quot;, but should instead be &quot;int []&quot;, but I think&lt;br/&gt;
we could address that separately.&lt;/p&gt;

&lt;p&gt;Please have a very close look at &quot;cleanedUpDiff.patch&quot; to make sure&lt;br/&gt;
that I didn&apos;t break anything with my changes.&lt;/p&gt;

&lt;p&gt;I think what remains, then, is to run as many of the existing tests&lt;br/&gt;
as we can, to verify that we haven&apos;t broken anything that was&lt;br/&gt;
known to work prior to our changes, and to consider whether there&lt;br/&gt;
are any additional tests that we wish to write.&lt;/p&gt;

&lt;p&gt;I think we are getting very close!&lt;/p&gt;</comment>
                            <comment id="14595248" author="bryanpendleton" created="Sun, 21 Jun 2015 23:50:44 +0000"  >&lt;p&gt;With the latest patch I get an error in org.apache.derbyTesting.functionTests.tests.lang.TriggerTest.testDerby5578InvalidateAllStatementsProc. &lt;/p&gt;

&lt;p&gt;I attached the &apos;error-stacktrace.out&apos; from the failed test.&lt;/p&gt;</comment>
                            <comment id="14597586" author="mac777" created="Tue, 23 Jun 2015 12:36:40 +0000"  >&lt;p&gt;Hi Bryan,&lt;/p&gt;

&lt;p&gt;In the error-stacktrace.out, it shows that the error occurs at line 379 of&lt;br/&gt;
TriggerTest.java. That happens to be an update command.&lt;/p&gt;

&lt;p&gt;       s.executeUpdate(&quot;update atdc_16_tab1 set b1=22,c1=222&quot;);&lt;/p&gt;

&lt;p&gt;If I run the queries of this particular test in ij, I don&apos;t get any error&lt;br/&gt;
and the output is correct.&lt;/p&gt;

&lt;p&gt;So I&apos;m currently trying to understand that if the update command executes&lt;br/&gt;
correctly on ij, why does it give an error in the test run.&lt;/p&gt;

&lt;p&gt;On Mon, Jun 22, 2015 at 5:21 AM, Bryan Pendleton (JIRA) &amp;lt;jira@apache.org&amp;gt;&lt;/p&gt;
</comment>
                            <comment id="14597992" author="bryanpendleton" created="Tue, 23 Jun 2015 17:22:02 +0000"  >&lt;p&gt;Yes, this particular test is exercising some behaviors about statement query plan caching&lt;br/&gt;
that may be hard to exactly reproduce in ij.&lt;/p&gt;

&lt;p&gt;Have you tried running TriggerTest itself directly? You should be able to do:&lt;/p&gt;

&lt;p&gt;    java -cp &apos;$DERBY_TRUNK/tools/java/junit.jar:$DERBY_TRUNK/classes&apos; junit.textui.TestRunner&lt;br/&gt;
        org.apache.derbyTesting.functionTests.tests.lang.TriggerTest&lt;/p&gt;

&lt;p&gt;where you might have to fix up the &quot;$DERBY_TRUNK&quot; syntax in your case to match the exactly&lt;br/&gt;
location of your derby trunk directory.&lt;/p&gt;</comment>
                            <comment id="14604846" author="mac777" created="Sun, 28 Jun 2015 19:14:28 +0000"  >&lt;p&gt;A short description for workingPatch.patch&lt;/p&gt;

&lt;p&gt;The intent of this patch is to successfully run sql queries in derby that trigger updates in a table, affecting only a certain rows of data that is determined by the when clause. This patch tries to cover a wide range of possible ways in which rows are conditionally updated after an event. Before this patch such trigger commands failed to execute correctly and left the data in an inconsistent state. &lt;/p&gt;</comment>
                            <comment id="14604889" author="jira-bot" created="Sun, 28 Jun 2015 20:21:54 +0000"  >&lt;p&gt;Commit 1688062 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bryanpendleton&quot; class=&quot;user-hover&quot; rel=&quot;bryanpendleton&quot;&gt;bryanpendleton&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1688062&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1688062&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6783&quot; title=&quot;WHEN clause in CREATE TRIGGER for UPDATE is not working for the sql script below&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6783&quot;&gt;&lt;del&gt;DERBY-6783&lt;/del&gt;&lt;/a&gt;: WHEN clause in CREATE TRIGGER for UPDATE is not working.&lt;/p&gt;

&lt;p&gt;This patch was contributed by Abhinav Gupta (abhinavgupta2004 at gmail dot com)&lt;/p&gt;

&lt;p&gt;The main challenge raised by this issue involved the analysis of which&lt;br/&gt;
columns are referenced by the trigger. Trigger statements can reference&lt;br/&gt;
columns in a number of ways, including the &quot;AFTER UPDATE OF&quot; clause, the&lt;br/&gt;
trigger&apos;s action statement, and the trigger&apos;s &quot;WHEN&quot; clause.&lt;/p&gt;

&lt;p&gt;When the WHEN clause support was introduced, this added a new way in which&lt;br/&gt;
a TRIGGER could reference columns, and the compiler code which translated&lt;br/&gt;
the trigger&apos;s logic into specific column references at runtime wasn&apos;t&lt;br/&gt;
getting the right set of columns.&lt;/p&gt;

&lt;p&gt;The intent of this patch is to successfully run sql queries in Derby that&lt;br/&gt;
trigger updates in a table, affecting only a certain rows of data that&lt;br/&gt;
is determined by the when clause. This patch tries to cover a wide range&lt;br/&gt;
of possible ways in which rows are conditionally updated after an event.&lt;/p&gt;

&lt;p&gt;Before this patch such trigger commands failed to execute correctly and&lt;br/&gt;
left the data in an inconsistent state.&lt;/p&gt;</comment>
                            <comment id="14604893" author="bryanpendleton" created="Sun, 28 Jun 2015 20:23:19 +0000"  >&lt;p&gt;This patch seems to be working well for me. Thanks for all the hard&lt;br/&gt;
work on this, Abhinav! This was a challenging first project to take&lt;br/&gt;
on within Derby, but it represents substantial improvement to the&lt;br/&gt;
TRIGGER support, I believe. &lt;/p&gt;

&lt;p&gt;Committed revision 1688062.&lt;/p&gt;</comment>
                            <comment id="14632557" author="bryanpendleton" created="Sat, 18 Jul 2015 18:25:48 +0000"  >&lt;p&gt;I believe we&apos;ve completed all of our intended work for this issue.&lt;/p&gt;</comment>
                            <comment id="14632738" author="alex k." created="Sun, 19 Jul 2015 08:42:34 +0000"  >&lt;p&gt;Thanks Abhinav and Bryan. I&apos;ll try to build Derby on the specified revision and test triggers with my real world use cases as soon as I can.&lt;/p&gt;

&lt;p&gt;Edit: It works for all my use cases!&lt;/p&gt;</comment>
                            <comment id="15476554" author="knutanders" created="Fri, 9 Sep 2016 09:52:07 +0000"  >&lt;p&gt;[ Automatically closing all resolved issues that haven&apos;t been updated in more than six months. ]&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12738827">DERBY-6726</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12313741">DERBY-534</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12738406" name="6783.diff" size="52274" author="mac777" created="Mon, 8 Jun 2015 18:20:29 +0000"/>
                            <attachment id="12740737" name="6783_allTestsPass.diff" size="59819" author="mac777" created="Fri, 19 Jun 2015 21:30:10 +0000"/>
                            <attachment id="12740506" name="6783_moreTests.diff" size="59729" author="mac777" created="Thu, 18 Jun 2015 22:38:03 +0000"/>
                            <attachment id="12740575" name="6783_moreTests_bryan.diff" size="59892" author="bryanpendleton" created="Fri, 19 Jun 2015 05:19:00 +0000"/>
                            <attachment id="12738641" name="6783_newTest.diff" size="53610" author="mac777" created="Tue, 9 Jun 2015 19:27:22 +0000"/>
                            <attachment id="12739150" name="6783_newTest_bryan.diff" size="55469" author="bryanpendleton" created="Fri, 12 Jun 2015 01:11:36 +0000"/>
                            <attachment id="12740116" name="6783_newTests.diff" size="56143" author="mac777" created="Wed, 17 Jun 2015 13:57:17 +0000"/>
                            <attachment id="12740937" name="cleanedUpDiff.patch" size="16339" author="bryanpendleton" created="Sun, 21 Jun 2015 22:35:22 +0000"/>
                            <attachment id="12735788" name="diagnostics.diff" size="9113" author="bryanpendleton" created="Thu, 28 May 2015 04:15:26 +0000"/>
                            <attachment id="12740939" name="error-stacktrace.out" size="6487" author="bryanpendleton" created="Sun, 21 Jun 2015 23:50:44 +0000"/>
                            <attachment id="12736999" name="sortFunction.diff" size="16530" author="mac777" created="Tue, 2 Jun 2015 20:24:25 +0000"/>
                            <attachment id="12735212" name="testTriggerWhenClause.diff" size="1798" author="mac777" created="Mon, 25 May 2015 20:57:58 +0000"/>
                            <attachment id="12742245" name="workingPatch.patch" size="35216" author="mac777" created="Fri, 26 Jun 2015 22:20:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>13.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 10 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23e13:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>