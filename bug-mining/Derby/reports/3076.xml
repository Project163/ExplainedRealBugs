<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 14:49:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DERBY-6569] NULLIF may return incorrect results if first operand calls non-deterministic function</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6569</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The SQL standard doesn&apos;t allow non-deterministic function calls in the operands of NULLIF. Derby does however allow such calls, but the results may not be as one might expect.&lt;/p&gt;

&lt;p&gt;Take an expression such as NULLIF(expr, 1). It shouldn&apos;t ever return 1. If expr is 1, it should return NULL, and if expr is not 1, it should return expr.&lt;/p&gt;

&lt;p&gt;If expr contains a call to a non-deterministic function, it may actually end up returning 1 sometimes:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij&amp;gt; SELECT NULLIF(INT(RANDOM()*2), 1) FROM SYS.SYSTABLES;
1          
-----------
1          
1          
1          
NULL       
NULL       
NULL       
NULL       
0          
1          
NULL       
NULL       
0          
0          
NULL       
0          
1          
0          
NULL       
1          
0          
NULL       
NULL       
NULL       

23 rows selected
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12713291">DERBY-6569</key>
            <summary>NULLIF may return incorrect results if first operand calls non-deterministic function</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="knutanders">Knut Anders Hatlen</reporter>
                        <labels>
                            <label>derby_backport_reject_10_11</label>
                    </labels>
                <created>Fri, 9 May 2014 11:11:11 +0000</created>
                <updated>Fri, 9 Sep 2016 09:51:27 +0000</updated>
                            <resolved>Wed, 17 Sep 2014 11:29:46 +0000</resolved>
                                    <version>10.10.2.0</version>
                                    <fixVersion>10.12.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13993526" author="knutanders" created="Fri, 9 May 2014 11:14:59 +0000"  >&lt;p&gt;One might argue that this is not a bug, since the behaviour is not specified by the SQL standard.&lt;/p&gt;

&lt;p&gt;In any case, it would be useful to find a way to make NULLIF evaluate the expressions in its operands only once, as that would also improve the performance of valid NULLIF expressions. That mechanism may also be useful when implementing simple case expressions (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1576&quot; title=&quot;Extend the CASE expression syntax for &amp;quot;simple case&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1576&quot;&gt;&lt;del&gt;DERBY-1576&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="13995063" author="knutanders" created="Mon, 12 May 2014 13:13:22 +0000"  >&lt;p&gt;The attached patch, &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12644410/12644410_d6569-1a.diff&quot; title=&quot;d6569-1a.diff attached to DERBY-6569&quot;&gt;d6569-1a.diff&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;, attempts to fix this issue by introducing a new node type, called CachedValueNode, that can be used to wrap nodes that get inserted multiple places in a rewritten tree, and makes them evaluate only once.&lt;/p&gt;

&lt;p&gt;CachedValueNode is just a thin wrapper around a ValueNode, and for the most part it just forwards calls to the wrapped ValueNode. The only piece of own logic in the new class is located in the generateExpression() method. That method generates different code on the first call than it does on subsequent calls. On the first call, it sets up a field in the activation class, and generates code that evaluates the expression in the wrapped node and stores the result in the field. On subsequent calls, it only generates code to read the cached value from the field.&lt;/p&gt;

&lt;p&gt;All the regression tests pass with the patch. I&apos;m not 100% sure that there aren&apos;t more ValueNode methods that need to be overridden, but I haven&apos;t found any case yet where this approach breaks down.&lt;/p&gt;

&lt;p&gt;I believe the CachedValueNode class will be useful for implementing simple case expressions (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1576&quot; title=&quot;Extend the CASE expression syntax for &amp;quot;simple case&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1576&quot;&gt;&lt;del&gt;DERBY-1576&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="13995111" author="knutanders" created="Mon, 12 May 2014 14:35:54 +0000"  >&lt;p&gt;So there seems to be more methods that have to be overridden in CachedValueNode. For example, if I take the test case for &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4594&quot; title=&quot;ArrayIndexOutOfBoundsException thrown in PreparedStatement execution&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4594&quot;&gt;&lt;del&gt;DERBY-4594&lt;/del&gt;&lt;/a&gt; and replace COALESCE with NULLIF, I get an assert failure with the patch:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ij&amp;gt; SELECT R.report_id, ER.entity_id FROM reports AS R LEFT JOIN entity_reports AS ER ON R.report_id = ER.report_id WHERE R.details LIKE &apos;%Details%&apos; AND NULLIF(er.entity_id, 0) != 1;
ERROR XJ001: Java exception: &apos;ASSERT FAILED sourceResultSetNumber expected to be &amp;gt;= 0 for ER.ENTITY_ID: org.apache.derby.shared.common.sanity.AssertFailure&apos;.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Probably it&apos;s because the categorize() method isn&apos;t overridden, as that&apos;s what originally was the problem with CoalesceFunctionNode in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-4594&quot; title=&quot;ArrayIndexOutOfBoundsException thrown in PreparedStatement execution&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-4594&quot;&gt;&lt;del&gt;DERBY-4594&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13999052" author="dagw" created="Thu, 15 May 2014 18:33:22 +0000"  >&lt;p&gt;I thought this would clearly be a bug since the standard requires non-deterministic value for &amp;lt;value_expression&amp;gt; contained in the &amp;lt;case abbreviation&amp;gt; ? &lt;span class=&quot;error&quot;&gt;&amp;#91;2011: 6.12 SR 1a, 1c&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="14001534" author="knutanders" created="Mon, 19 May 2014 09:26:05 +0000"  >&lt;p&gt;Yes, I&apos;m inclined to agree that it&apos;s a bug. Although some might call it an extension. And to further complicate things: CREATE FUNCTION didn&apos;t get support for the DETERMINISTIC keyword until Derby 10.5 (&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3570&quot; title=&quot;Implement DETERMINISTIC keyword for procedures and functions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3570&quot;&gt;&lt;del&gt;DERBY-3570&lt;/del&gt;&lt;/a&gt;), so all functions created by old applications are implicitly declared non-deterministic.&lt;/p&gt;

&lt;p&gt;If we forbid non-deterministic function calls in NULLIF, as the standard requires, we should have a release note that tells users to rewrite affected applications either by redeclaring functions as deterministic if that&apos;s what they really are, or by restructuring their query so that the non-deterministic expression is not contained in the NULLIF expression. For example, the problematic expression in the issue description could be rewritten from &lt;tt&gt;SELECT NULLIF(INT(RANDOM()*2), 1) FROM SYS.SYSTABLES&lt;/tt&gt; to &lt;tt&gt;SELECT NULLIF(R, 1) FROM (SELECT INT(RANDOM()*2) FROM SYS.SYSTABLES) S(R)&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;We could do that. I&apos;m just a little worried about the backward compatibility given that all functions created with Derby 10.4 and earlier will be disallowed in NULLIF and require application changes.&lt;/p&gt;</comment>
                            <comment id="14001536" author="knutanders" created="Mon, 19 May 2014 09:28:44 +0000"  >&lt;p&gt;I&apos;m removing the wrong query result flag, since this is in the realm of undefined behaviour. Adding the deviation from standard flag instead.&lt;/p&gt;</comment>
                            <comment id="14135185" author="knutanders" created="Tue, 16 Sep 2014 09:23:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-1576&quot; title=&quot;Extend the CASE expression syntax for &amp;quot;simple case&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-1576&quot;&gt;&lt;del&gt;DERBY-1576&lt;/del&gt;&lt;/a&gt; added the CachedValueNode class to help prevent multiple evaluations of an expression. The updated patch &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12669012/12669012_d6569-1b.diff&quot; title=&quot;d6569-1b.diff attached to DERBY-6569&quot;&gt;d6569-1b.diff&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; wraps the left operand of the NULLIF expression in such a node. All tests ran cleanly with the patch.&lt;/p&gt;

&lt;p&gt;Even though the standard doesn&apos;t allow non-deterministic expressions in a NULLIF expression, I don&apos;t think we will enforce that limitation because of the previously discussed backward compatibility implications. I intend to check in this patch so that we at least don&apos;t get confusing/unexpected results if NULLIF is used on non-deterministic expressions.&lt;/p&gt;</comment>
                            <comment id="14137076" author="jira-bot" created="Wed, 17 Sep 2014 11:29:06 +0000"  >&lt;p&gt;Commit 1625520 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;knutanders&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1625520&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1625520&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6569&quot; title=&quot;NULLIF may return incorrect results if first operand calls non-deterministic function&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6569&quot;&gt;&lt;del&gt;DERBY-6569&lt;/del&gt;&lt;/a&gt;: NULLIF may return incorrect results if first operand calls non-deterministic function&lt;/p&gt;

&lt;p&gt;Make sure the left operand of the NULLIF expression is only evaluated&lt;br/&gt;
once, so that it does not matter if it is non-deterministic.&lt;/p&gt;</comment>
                            <comment id="14137095" author="knutanders" created="Wed, 17 Sep 2014 11:33:21 +0000"  >&lt;p&gt;Marking as not for backport. Since the fix only affects queries whose behaviour is undefined by the standard, backporting it doesn&apos;t sound worthwhile.&lt;/p&gt;</comment>
                            <comment id="15476522" author="knutanders" created="Fri, 9 Sep 2016 09:51:27 +0000"  >&lt;p&gt;[ Automatically closing all resolved issues that haven&apos;t been updated in more than six months. ]&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12346504">DERBY-1576</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12644410" name="d6569-1a.diff" size="9729" author="knutanders" created="Mon, 12 May 2014 13:13:22 +0000"/>
                            <attachment id="12669012" name="d6569-1b.diff" size="2986" author="knutanders" created="Tue, 16 Sep 2014 09:23:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10367"><![CDATA[Deviation from standard]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>391607</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 10 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1vg1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>391819</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>