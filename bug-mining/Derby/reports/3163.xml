<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 14:51:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DERBY-6977] Autogenerated index name occasionally generates a name which already exists</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6977</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;This has been happening for as long as I can remember, but v10.13.1.1 is the version we&apos;re currently at and I still see builds fail at random due to this.&lt;/p&gt;

&lt;p&gt;In a migration, we execute this statement:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE TABLE GuidMappingCache (
    guidhigh  BIGINT NOT NULL,
    guidlow BIGINT NOT NULL,
    luceneid INTEGER NOT NULL,
    PRIMARY KEY (guidhigh, guidlow)
)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This randomly fails with the following sort of error:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.sql.SQLException: Index &apos;SQL171110050418720&apos; already exists in Schema &apos;APP&apos;.
	at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)
	at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Unknown Source)
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source)
	at org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source)
	at org.apache.derby.impl.jdbc.ConnectionChild.handleException(Unknown Source)
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(Unknown Source)
	at OurCode.execute(...)
Caused by: ERROR X0Y32: Index &apos;SQL171110050418720&apos; already exists in Schema &apos;APP&apos;.
	at org.apache.derby.iapi.error.StandardException.newException(Unknown Source)
	at org.apache.derby.iapi.error.StandardException.newException(Unknown Source)
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.duplicateDescriptorException(Unknown Source)
	at org.apache.derby.impl.sql.catalog.DataDictionaryImpl.addDescriptor(Unknown Source)
	at org.apache.derby.impl.sql.execute.CreateIndexConstantAction.executeConstantAction(Unknown Source)
	at org.apache.derby.impl.sql.execute.CreateConstraintConstantAction.executeConstantAction(Unknown Source)
	at org.apache.derby.impl.sql.execute.CreateTableConstantAction.executeConstantAction(Unknown Source)
	at org.apache.derby.impl.sql.execute.MiscResultSet.open(Unknown Source)
	at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(Unknown Source)
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)
	... 37 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The last time someone was looking into this, it was somehow very reproducible for them but not for anyone else. I&apos;m now seeing it occasionally on tests on our build farm. As usual, no matter how many times I run the test here, I can&apos;t get the same failure to occur.&lt;/p&gt;

&lt;p&gt;How is this value being generated?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13117475">DERBY-6977</key>
            <summary>Autogenerated index name occasionally generates a name which already exists</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="trejkaz">Trejkaz</reporter>
                        <labels>
                    </labels>
                <created>Fri, 10 Nov 2017 05:09:37 +0000</created>
                <updated>Tue, 14 Nov 2017 00:44:29 +0000</updated>
                                            <version>10.13.1.1</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16247866" author="rhillegas" created="Fri, 10 Nov 2017 18:06:24 +0000"  >&lt;p&gt;The value is being generated by some convoluted, bogus-looking code in DataDictionaryImpl.getSystemSQLName(). I don&apos;t know why the DataDictionary doesn&apos;t use a UUID generator. I will try replacing this code with something UUID-based and see if that breaks anything. Thanks for bringing this weird code to my attention.&lt;/p&gt;</comment>
                            <comment id="16247874" author="rhillegas" created="Fri, 10 Nov 2017 18:18:05 +0000"  >&lt;p&gt;Attaching derby-6977-01-aa-useUUID.diff. This patch removes the bogus logic and replaces it with a UUID-based scheme. I am running tests now.&lt;/p&gt;

&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/iapi/sql/dictionary/DataDictionary.java&lt;br/&gt;
M       java/engine/org/apache/derby/impl/sql/catalog/DataDictionaryImpl.java&lt;/p&gt;</comment>
                            <comment id="16248297" author="bryanpendleton" created="Sat, 11 Nov 2017 03:17:50 +0000"  >&lt;p&gt;Cool! So the problem arises if you create two different sequences within the same millisecond? Or tenth of a millisecond? Or hundredth? &lt;/p&gt;

&lt;p&gt;I read through your patch and it looks nice and clean to me. +1 to commit.&lt;/p&gt;

&lt;p&gt;I guess that, once we generate the sequence name, it is just a string?&lt;/p&gt;

&lt;p&gt;So, if we change the name generator, we have no upgrade issues?&lt;/p&gt;
</comment>
                            <comment id="16248332" author="trejkaz" created="Sat, 11 Nov 2017 05:06:29 +0000"  >&lt;p&gt;It turns out if you create two sequences in the same DataDictionary instance, that is safe because it&apos;s synchronising it, and doing some convoluted hacks to avoid the same timestamp being used twice... But when we run migrations, the database is opened for the migration, migrated, and then closed, and then the next migration runs, and so forth, so it&apos;s a new instance each time.&lt;/p&gt;

&lt;p&gt;So I think this error must have occurred when we ran two migrations in a row, both of them created an autogenerated index, and both occurred within the same 10ms interval, with the constructor of DataDictionaryImpl creating the same values for all the other stuff as well. This last bit probably explains why it was so hard to reproduce for me.&lt;/p&gt;

&lt;p&gt;But it turns out you can reproduce it in isolation by creating a new DataDictionaryImpl and then getSystemSQLName, then creating a new DataDictionaryImpl and calling it again, and repeating that until the two instances happen to get the same ID, which for me happens almost immediately.&lt;/p&gt;

&lt;p&gt;Using a UUID definitely seems like a good solution.&lt;/p&gt;</comment>
                            <comment id="16248558" author="rhillegas" created="Sat, 11 Nov 2017 15:28:58 +0000"  >&lt;p&gt;Thanks for the feedback, Bryan and Trejkaz. To answer Bryan&apos;s questions:&lt;/p&gt;

&lt;p&gt;BP&amp;gt; I guess that, once we generate the sequence name, it is just a string?&lt;/p&gt;

&lt;p&gt;Right. It is stored as a string and is a valid delimited identifier. One advantage of the scheme being retired is that the index name was case-insensitive and could be used in metadata queries without being double-quoted. That seemed like a small advantage at the cost of complicated and (apparently) buggy code.&lt;/p&gt;

&lt;p&gt;BP&amp;gt; So, if we change the name generator, we have no upgrade issues?&lt;/p&gt;

&lt;p&gt;I will run the upgrade tests, upgrading from all official releases back until Derby was open-sourced. I will ponder whether there are any upgrade issues. Right now, I am correcting several tests which expected the old style of index names. So far, I have not uncovered any clues about the motivation for the old style. It goes back to the initial open-sourcing of Derby.&lt;/p&gt;</comment>
                            <comment id="16248586" author="bryanpendleton" created="Sat, 11 Nov 2017 16:35:50 +0000"  >&lt;p&gt;Would it help to force the new UUID value to uppercase when we use it as a sequence name? I mean, would it help for the metadata query behavior that you noticed?&lt;/p&gt;</comment>
                            <comment id="16248638" author="rhillegas" created="Sat, 11 Nov 2017 19:46:24 +0000"  >&lt;p&gt;No, that wouldn&apos;t help. The stringified UUID by itself contains dashes. Dashes can&apos;t appear in non-delimited identifiers because the lexer interprets them as minus signs. The upper-cased UUID string would still need to be double-quoted.&lt;/p&gt;</comment>
                            <comment id="16248639" author="rhillegas" created="Sat, 11 Nov 2017 19:47:03 +0000"  >&lt;p&gt;Attaching derby-6977-01-ab-useUUID.diff. This patch adjusts some tests to account for the naming style for system-generated constraint indexes. I also stripped the leading SQL off the generated name. It is now just a UUID. I am re-running the tests.&lt;/p&gt;

&lt;p&gt;Touches the following additional files:&lt;/p&gt;

&lt;p&gt;M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/AlterTableTest.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/SelectivityTest.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/junit/JDBC.java&lt;/p&gt;</comment>
                            <comment id="16248994" author="rhillegas" created="Sun, 12 Nov 2017 21:28:48 +0000"  >&lt;p&gt;I believe that I have discovered the reason for the convoluted logic. It is explained in a comment in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6974&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/DERBY-6974&lt;/a&gt;. Search for IBM bug number 5622. The logic was added because the original Cloudscape constraint names (which were probably UUIDs) were too long to be db2-compatible.&lt;/p&gt;</comment>
                            <comment id="16248996" author="rhillegas" created="Sun, 12 Nov 2017 22:14:23 +0000"  >&lt;p&gt;Attaching derby-6977-01-ac-useUUID.diff. This patch adds the SQL prefix back in and adds a strictly increasing numeric string. The extra numeric string does not affect the uniqueness of the generated name, it merely guarantees deterministic regression test results. For some reason, I cannot get the following tests to succeed, even though the .out files produced by the test runs are identical to the test canons. I will have to look into this. If someone knows what&apos;s special about these tests, I would appreciate a clue here.&lt;/p&gt;

&lt;p&gt;  derbynetclientmats/dblook_test_net&lt;br/&gt;
  derbynetclientmats/dblook_test_net_territory&lt;/p&gt;

&lt;p&gt;Touches the following files:&lt;/p&gt;

&lt;p&gt;M       java/engine/org/apache/derby/iapi/sql/dictionary/DataDictionary.java&lt;br/&gt;
M       java/engine/org/apache/derby/impl/sql/catalog/DataDictionaryImpl.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/harness/Sed.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/master/DerbyNetClient/dblook_test_net.out&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/master/DerbyNetClient/dblook_test_net_territory.out&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/functionTests/tests/lang/SelectivityTest.java&lt;br/&gt;
M       java/testing/org/apache/derbyTesting/junit/JDBC.java&lt;/p&gt;</comment>
                            <comment id="16249022" author="rhillegas" created="Mon, 13 Nov 2017 00:34:59 +0000"  >&lt;p&gt;Attaching SUBMISSIONS/derby-6977-01-ad-useUUID.diff. This patch tweaks JDBC.java to recognize the new format of the constraint names as system-generated names. That turns on the name-masking logic for several tests. Re-running tests...&lt;/p&gt;

&lt;p&gt;Oddly enough, I did NOT see diffs in &lt;/p&gt;

&lt;p&gt;  derbynetclientmats/dblook_test_net&lt;br/&gt;
  derbynetclientmats/dblook_test_net_territory&lt;/p&gt;</comment>
                            <comment id="16249085" author="bryanpendleton" created="Mon, 13 Nov 2017 03:54:56 +0000"  >&lt;p&gt;We used to have very odd, unreproducible test problems with the dblook_test_net_territory tests, e.g., &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5593&quot; title=&quot;dblook_test_net_territory fails with extra lines ERROR: deleting: seg0  ERROR: deleting: wombat_new&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5593&quot;&gt;DERBY-5593&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Perhaps you just hit a little turbulence in your test runs and bumped into an old familiar friend.&lt;/p&gt;</comment>
                            <comment id="16250582" author="rhillegas" created="Tue, 14 Nov 2017 00:43:08 +0000"  >&lt;p&gt;Tests passed cleanly for me on derby-6977-01-ad-useUUID.diff. The upgrade tests also passed using all official releases as starting points.&lt;/p&gt;</comment>
                            <comment id="16250585" author="jira-bot" created="Tue, 14 Nov 2017 00:44:29 +0000"  >&lt;p&gt;Commit 1815172 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhillegas&quot; class=&quot;user-hover&quot; rel=&quot;rhillegas&quot;&gt;rhillegas&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1815172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1815172&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6977&quot; title=&quot;Autogenerated index name occasionally generates a name which already exists&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6977&quot;&gt;DERBY-6977&lt;/a&gt;: Eliminate collisions on generated names for constraints; commit derby-6977-01-ad-useUUID.diff.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12897123" name="derby-6977-01-aa-useUUID.diff" size="6858" author="rhillegas" created="Fri, 10 Nov 2017 18:17:34 +0000"/>
                            <attachment id="12897213" name="derby-6977-01-ab-useUUID.diff" size="17577" author="rhillegas" created="Sat, 11 Nov 2017 19:46:51 +0000"/>
                            <attachment id="12897259" name="derby-6977-01-ac-useUUID.diff" size="65575" author="rhillegas" created="Sun, 12 Nov 2017 22:14:09 +0000"/>
                            <attachment id="12897265" name="derby-6977-01-ad-useUUID.diff" size="65582" author="rhillegas" created="Mon, 13 Nov 2017 00:34:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3mmmf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>