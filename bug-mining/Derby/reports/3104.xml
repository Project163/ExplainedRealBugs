<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 14:50:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DERBY-5165] Prepared XA transaction locks are not kept across DB restart</title>
                <link>https://issues.apache.org/jira/browse/DERBY-5165</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Steps to reproduce:&lt;/p&gt;

&lt;p&gt;1-perform update with XA, using, say Xid xid1&lt;br/&gt;
2-prepare xid1 with XA but do NOT commit&lt;br/&gt;
3-restart Derby DB&lt;br/&gt;
4-the updates of step 1 will be visible&lt;/p&gt;

&lt;p&gt;When xid1 is rolled back after step 3 then the updates are gone. So my conclusion is that the transaction is not committed yet, but the updates are visible after prepare. This is a violation of the XA semantics.&lt;/p&gt;</description>
                <environment>Mac OSX </environment>
        <key id="12503005">DERBY-5165</key>
            <summary>Prepared XA transaction locks are not kept across DB restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mikem">Mike Matrigali</assignee>
                                    <reporter username="guypardon">Guy Pardon</reporter>
                        <labels>
                            <label>derby_backport_reject_10_11</label>
                            <label>derby_triage10_11</label>
                    </labels>
                <created>Thu, 31 Mar 2011 13:22:10 +0000</created>
                <updated>Fri, 9 Sep 2016 09:52:31 +0000</updated>
                            <resolved>Fri, 12 Dec 2014 20:15:29 +0000</resolved>
                                    <version>10.6.2.1</version>
                                    <fixVersion>10.12.1.1</fixVersion>
                                    <component>Store</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13015398" author="knutanders" created="Mon, 4 Apr 2011 13:24:54 +0000"  >&lt;p&gt;I&apos;m able to reproduce this. See attached program, Derby5165.java. If I change step 1 to perform an insert instead of an update, step 4 times out as expected. But if an update is performed, step 4 is able to read the new value before it has been committed.&lt;/p&gt;</comment>
                            <comment id="13212280" author="mikem" created="Tue, 21 Feb 2012 01:24:14 +0000"  >&lt;p&gt;10.9 derby triage.  Verified atttached repro demonstrates the problem.&lt;/p&gt;</comment>
                            <comment id="14082500" author="myrna" created="Fri, 1 Aug 2014 16:58:37 +0000"  >&lt;p&gt;I thought I&apos;d try to make a junit test case based on Knut&apos;s java program.&lt;br/&gt;
However, I am stuck because of the unfinished xar.prepare...&lt;/p&gt;

&lt;p&gt;The test case shows the problem occurs by doing a xar.prepare &lt;b&gt;after&lt;/b&gt; an xar.end.&lt;br/&gt;
If I use this test case in a defaultSuite, it will try to exercise the test case twice, and the second time it will fail with an XAER_DUPID (for the client-server iteration).&lt;br/&gt;
I am assuming that this will also/possibly interfere with any subsequent tests.&lt;br/&gt;
How do I correctly stop this XA Resource? As it&apos;s already xar.end-ed?&lt;/p&gt;

&lt;p&gt;I tried: &lt;br/&gt;
xa.rollback: gave me an arrayindexoutofboundsException&lt;br/&gt;
xar.forget, xar.commit, or xar.end returned an XAException (complaining that a transaction is still active. If I catch this and ignore, it again returns XAER_DUPID for the client-server test)&lt;/p&gt;</comment>
                            <comment id="14082693" author="dagw" created="Fri, 1 Aug 2014 18:32:55 +0000"  >&lt;p&gt;The arrayindexoutofboundsException sounds like a bug - maybe you need to fix that first?&lt;/p&gt;</comment>
                            <comment id="14104123" author="mikem" created="Wed, 20 Aug 2014 16:57:16 +0000"  >&lt;p&gt;probably not going to have much luck getting this to work in the &quot;default&quot; configuration, and&lt;br/&gt;
also not going to run well repeated without some coding for unique XA XID&apos;s.  The caller provides&lt;br/&gt;
the XA XID&apos;s so if test is to be run multiple times in same db, the test will have to figure out a way&lt;br/&gt;
to provide unique ones each time.&lt;/p&gt;

&lt;p&gt;I would make first step to get test to run ONCE as a simple junit test, and it should  create and destroy&lt;br/&gt;
it&apos;s own database as part of its work.  It should use the code that was added to allow tests to run in &lt;br/&gt;
separate process to a point, then crash to exercise recovery, and come back up and test after recovery.&lt;br/&gt;
I know tests were added to use some infrastructure for this in the past, looking for the example.&lt;/p&gt;</comment>
                            <comment id="14104126" author="mikem" created="Wed, 20 Aug 2014 16:59:18 +0000"  >&lt;p&gt;See the OCRecoveryTest for framework that may work.&lt;/p&gt;</comment>
                            <comment id="14104574" author="myrna" created="Wed, 20 Aug 2014 21:03:35 +0000"  >&lt;p&gt;Thanks for your input Mike.&lt;br/&gt;
I was trying to add this as a test case to jdbcapi.XATransactionTest because it seemed similar to various other test cases in that class, but I&apos;ll move it to its own class and use a singleUseDatabase Decorator.&lt;br/&gt;
I worry that this will still hold resources after the test is done, but at least it won&apos;t affect other tests like it&apos;s doing now.&lt;br/&gt;
I am wondering though if a forced crash by a forked jvm process is needed? The steps in the description just says to restart the database, and Knut&apos;s repro shuts down the database and that reproduces the behavior, would that be sufficient?&lt;br/&gt;
The reason for minimizing use of the construct/mechanism of OCRecoveryTest is that it uses textui.TestRunner -m option which is not something that can be upgraded to JUNIT 4 - (in case we ever do that). &lt;/p&gt;</comment>
                            <comment id="14104649" author="mikem" created="Wed, 20 Aug 2014 21:39:17 +0000"  >&lt;p&gt;if original test shuts down cleanly and repro&apos;s then forced crash not necessary.  Though doing a forced crash as an add on test might be interesting, just to verify that works too.&lt;/p&gt;

&lt;p&gt;In the real world JVM&apos;s running derby crash all the time (really more likely exited by some non-derby thread of control), so the more testing we do with JVM&apos;s shutting down without clean shutdown the better.  But first off better to just get the test to show what you want, and it seems like crash not necessary.  I often just use the word crash when I am thinking about a derby db going down not cleanly such that there is work for &lt;br/&gt;
recovery to do when it comes up.  XA is an interesting case in that even if you shut down cleanly there may be work to do in recovery.&lt;/p&gt;

&lt;p&gt;For this specific bug it is Derby&apos;s job on reboot to reclaim all the locks on all the changed data of any XA transaction that is in prepared but uncommitted state.  In some cases as pointed out by this bug Derby is not doing that.&lt;/p&gt;</comment>
                            <comment id="14106033" author="myrna" created="Thu, 21 Aug 2014 22:06:48 +0000"  >&lt;p&gt;Attaching an attempt at a junit test for this.&lt;br/&gt;
It only shuts down the database rather than use a forked process but it uses specifically named singleUse databases which get cleaned up when the test is done.&lt;/p&gt;

&lt;p&gt;I made two test cases based on Knut&apos;s repro - one using an update which shows the current problem (with TODO&apos;s marking where this test needs to be changed once the bug is fixed), and one using the insert which shows the expected time-out behavior.&lt;/p&gt;

&lt;p&gt;I have not tried to run this in a suite yet.&lt;br/&gt;
Test Patch ready for review.&lt;/p&gt;</comment>
                            <comment id="14111241" author="myrna" created="Tue, 26 Aug 2014 20:15:11 +0000"  >&lt;p&gt;I tried the test in jdbcapi._Suite and it runs fine. That is - I uncommented the &apos;fail ...&apos; line, but then renamed that &apos;test...&apos; case to &apos;xtest...&apos;, so it&apos;s not getting executed. &lt;/p&gt;</comment>
                            <comment id="14120130" author="jira-bot" created="Wed, 3 Sep 2014 17:35:09 +0000"  >&lt;p&gt;Commit 1622301 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=myrna&quot; class=&quot;user-hover&quot; rel=&quot;myrna&quot;&gt;myrna&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1622301&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1622301&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5165&quot; title=&quot;Prepared XA transaction locks are not kept across DB restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5165&quot;&gt;&lt;del&gt;DERBY-5165&lt;/del&gt;&lt;/a&gt;; Prepared XA transaction locks are not kept across DB restart&lt;br/&gt;
   Adding a test case (currently not enabled) based on the repro provided.&lt;/p&gt;</comment>
                            <comment id="14128980" author="jira-bot" created="Wed, 10 Sep 2014 19:42:35 +0000"  >&lt;p&gt;Commit 1624105 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=myrna&quot; class=&quot;user-hover&quot; rel=&quot;myrna&quot;&gt;myrna&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1624105&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1624105&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5165&quot; title=&quot;Prepared XA transaction locks are not kept across DB restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5165&quot;&gt;&lt;del&gt;DERBY-5165&lt;/del&gt;&lt;/a&gt;; Prepared XA transaction locks are not kept across DB restart&lt;br/&gt;
   Adding License comment to the test&lt;/p&gt;</comment>
                            <comment id="14191989" author="jira-bot" created="Fri, 31 Oct 2014 16:14:04 +0000"  >&lt;p&gt;Commit 1635803 from mikem@apache.org in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1635803&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1635803&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-5165&quot; title=&quot;Prepared XA transaction locks are not kept across DB restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-5165&quot;&gt;&lt;del&gt;DERBY-5165&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Update code to reclaim locks on prepared but not committed XA transaction&lt;br/&gt;
update locks on recovery reboot following crash.  Enable checked in test&lt;br/&gt;
that demonstrated the bug, which was verified to fail before the change&lt;br/&gt;
and pass after the change.&lt;/p&gt;</comment>
                            <comment id="15476579" author="knutanders" created="Fri, 9 Sep 2016 09:52:31 +0000"  >&lt;p&gt;[ Automatically closing all resolved issues that haven&apos;t been updated in more than six months. ]&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12738856">DERBY-6727</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12663520" name="DERBY-5165Test.diff" size="8646" author="myrna" created="Thu, 21 Aug 2014 22:06:48 +0000"/>
                            <attachment id="12475354" name="Derby5165.java" size="2672" author="knutanders" created="Mon, 4 Apr 2011 13:24:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10367"><![CDATA[Deviation from standard]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>24686</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10422"><![CDATA[High Value Fix]]></customfieldvalue>
    <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 10 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i06iun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35988</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10051"><![CDATA[Urgent]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>