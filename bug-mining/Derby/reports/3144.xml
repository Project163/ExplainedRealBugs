<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 14:51:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DERBY-6884] SYSCS_IMPORT_TABLE_LOBS_FROM_EXTFILE can&apos;t import more than Integer.MAX_VALUE bytes of blob data</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6884</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Using SYSCS_EXPORT_TABLE_LOBS_TO_EXTFILE to export a table containing a blob column, SYSCS_IMPORT_TABLE_LOBS_FROM_EXTFILE  will fail with a NumberFormatException if the offset for a blob record is &amp;gt; Integer.MAX_VALUE.  This is because ImportReadData.initExternalLobFile() is parsing the offset as an Integer.&lt;/p&gt;

&lt;p&gt;The stack trace and a program to reproduce are below.&lt;/p&gt;

&lt;p&gt;java.lang.NumberFormatException: For input string: &quot;2147483770&quot;&lt;br/&gt;
	at java.lang.NumberFormatException.forInputString(NumberFormatException.java:65) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_45&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.lang.Integer.parseInt(Integer.java:583) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_45&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.lang.Integer.parseInt(Integer.java:615) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_45&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.impl.load.ImportReadData.initExternalLobFile(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.impl.load.ImportReadData.getBlobColumnFromExtFile(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.impl.load.ImportAbstract.getBlob(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.impl.load.Import.getBlob(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.iapi.types.SQLBlob.setValueFromResultSet(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.VTIResultSet.populateFromResultSet(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.VTIResultSet.getNextRowCore(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.getNextRowCore(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.NormalizeResultSet.getNextRowCore(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.NoPutResultSetImpl.getNextRowFromRowSource(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.impl.store.access.heap.HeapController.load(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.impl.store.access.heap.Heap.load(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.impl.store.access.RAMTransaction.loadConglomerate(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.impl.store.access.RAMTransaction.recreateAndLoadConglomerate(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.InsertResultSet.bulkInsertCore(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.InsertResultSet.open(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;derby-10.11.1.1.jar:na&amp;#93;&lt;/span&gt;&lt;br/&gt;
	... 36 common frames omitted&lt;/p&gt;

&lt;p&gt;==================================&lt;br/&gt;
package blob;&lt;/p&gt;

&lt;p&gt;import java.io.BufferedInputStream;&lt;br/&gt;
import java.io.File;&lt;br/&gt;
import java.io.FileInputStream;&lt;br/&gt;
import java.io.IOException;&lt;br/&gt;
import java.sql.*;&lt;/p&gt;

&lt;p&gt;public final class DerbyIssue {&lt;br/&gt;
    // derby url&lt;br/&gt;
    public static final String DBURL = &quot;jdbc:derby:testdb;create=true&quot;;&lt;br/&gt;
    // any random binary file such as a large image or document&lt;br/&gt;
    public static final String BLOB_DATA_FILE = &quot;...&quot;;&lt;br/&gt;
    public static final String EXPORT_TABLE_FILE = &quot;table-data&quot;;&lt;br/&gt;
    public static final String EXPORT_BLOB_FILE = &quot;blob-data&quot;;&lt;/p&gt;

&lt;p&gt;    public static void main(String... args) throws Exception &lt;/p&gt;
{
        final DerbyIssue test = new DerbyIssue();
        test.run();
    }

&lt;p&gt;    public void run() throws Exception {&lt;br/&gt;
        Class.forName(&quot;org.apache.derby.jdbc.ClientDriver&quot;).getConstructor().newInstance();&lt;/p&gt;

&lt;p&gt;        try(final Connection con = DriverManager.getConnection(DBURL)) {&lt;br/&gt;
            try (final Statement stmt = con.createStatement()) &lt;/p&gt;
{
                stmt.execute(&quot;CREATE TABLE TESTBLOB(id BIGINT, content BLOB)&quot;);
            }

&lt;p&gt;            System.out.printf(&quot;inserting test data%n&quot;);&lt;/p&gt;

&lt;p&gt;            try (final PreparedStatement pstmt = con.prepareStatement(&quot;INSERT INTO TESTBLOB (id, content) VALUES (?, ?)&quot;)) {&lt;br/&gt;
                long id = 1;&lt;br/&gt;
                long byteCount = 0;&lt;br/&gt;
                final File content = new File(BLOB_DATA_FILE);&lt;br/&gt;
                while (byteCount &amp;lt; Integer.MAX_VALUE) {&lt;br/&gt;
                    insertBlob(pstmt, id, content);&lt;br/&gt;
                    id++;&lt;br/&gt;
                    byteCount += content.length();&lt;br/&gt;
                    if (id % 100 == 0) &lt;/p&gt;
{
                        System.out.printf(&quot;%d%n&quot;, byteCount);
                    }
&lt;p&gt;                }&lt;br/&gt;
                insertBlob(pstmt, id, content);&lt;br/&gt;
                byteCount += content.length();&lt;/p&gt;

&lt;p&gt;                System.out.printf(&quot;%d bytes written to testblob table%n&quot;, byteCount);&lt;br/&gt;
            }&lt;/p&gt;

&lt;p&gt;            final File exportFile = new File(EXPORT_TABLE_FILE);&lt;br/&gt;
            final File blobFile = new File(EXPORT_BLOB_FILE);&lt;br/&gt;
            try (final CallableStatement stmt = con.prepareCall(&lt;br/&gt;
                    &quot;CALL SYSCS_UTIL.SYSCS_EXPORT_TABLE_LOBS_TO_EXTFILE (null, ?, ?, null, null, null, ?)&quot;)) &lt;/p&gt;
{
                stmt.setString(1, &quot;TESTBLOB&quot;);
                stmt.setString(2, exportFile.toString());
                stmt.setString(3, blobFile.toString());
                stmt.execute();
            }

&lt;p&gt;            System.out.printf(&quot;testblob table exported%n&quot;);&lt;/p&gt;

&lt;p&gt;            try (final Statement stmt = con.createStatement()) &lt;/p&gt;
{
                stmt.execute(&quot;TRUNCATE TABLE TESTBLOB&quot;);
            }

&lt;p&gt;            System.out.printf(&quot;testblob table truncated%n&quot;);&lt;/p&gt;

&lt;p&gt;            try (final CallableStatement stmt = con.prepareCall(&lt;br/&gt;
                    &quot;CALL SYSCS_UTIL.SYSCS_IMPORT_TABLE_LOBS_FROM_EXTFILE (null, ?, ?, null, null, null, 0)&quot;)) &lt;/p&gt;
{
                stmt.setString(1, &quot;TESTBLOB&quot;);
                stmt.setString(2, exportFile.toString());
                stmt.execute();
            }

&lt;p&gt;            System.out.printf(&quot;testblob data imported%n&quot;);&lt;br/&gt;
        }&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;    private void insertBlob(PreparedStatement pstmt, long id, File content) throws IOException, SQLException {&lt;br/&gt;
        try(BufferedInputStream contentStream = new BufferedInputStream(new FileInputStream(content))) &lt;/p&gt;
{
            pstmt.setLong(1, id);
            pstmt.setBinaryStream(2, contentStream);
            pstmt.executeUpdate();
        }
&lt;p&gt;    }&lt;br/&gt;
}&lt;/p&gt;</description>
                <environment></environment>
        <key id="12959665">DERBY-6884</key>
            <summary>SYSCS_IMPORT_TABLE_LOBS_FROM_EXTFILE can&apos;t import more than Integer.MAX_VALUE bytes of blob data</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanpendleton">Bryan Pendleton</assignee>
                                    <reporter username="ehowe">Edward Howe</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Apr 2016 14:37:15 +0000</created>
                <updated>Tue, 3 May 2016 03:22:34 +0000</updated>
                            <resolved>Tue, 3 May 2016 03:22:34 +0000</resolved>
                                    <version>10.11.1.1</version>
                                    <fixVersion>10.13.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15246933" author="bryanpendleton" created="Tue, 19 Apr 2016 01:37:29 +0000"  >&lt;p&gt;The problem reproduces for me, just as described, using the&lt;br/&gt;
current head of trunk on Windows, with JDK 1.8.0_77-b03&lt;/p&gt;

&lt;p&gt;I attached a re-formatted version of the repro program, which&lt;br/&gt;
was easier for me to read and follow, as &quot;DerbyIssue.java&quot;.&lt;/p&gt;

&lt;p&gt;I also removed the explicit load of the Derby ClientDriver which&lt;br/&gt;
appears to be unnecessary with the repro program, as it uses&lt;br/&gt;
the EmbeddedDriver and hence can run with just derby.jar.&lt;/p&gt;

&lt;p&gt;Also, to be clear: to run the repro program, you need to edit&lt;br/&gt;
the program text to replace the three dots in the next line with&lt;br/&gt;
the name of a valid file in your test directory.&lt;/p&gt;

&lt;p&gt;    public static final String BLOB_DATA_FILE = &quot;...&quot;;&lt;/p&gt;

&lt;p&gt;I used a 75 MB PDF file that I happened to have sitting around.&lt;/p&gt;

&lt;p&gt;The program cleverly loops, counting the size of the blobs&lt;br/&gt;
that it has inserted, until it has more than 2 GB of them, so it&lt;br/&gt;
doesn&apos;t really matter what file you use, but you have to pick a file.&lt;/p&gt;

&lt;p&gt;It would be nice to figure out a clever way to have a smaller repro,&lt;br/&gt;
as this repro takes several minutes to run on my system, but&lt;br/&gt;
for the purposes of demonstrating the bug the repro was great &amp;#8211; thanks!&lt;/p&gt;</comment>
                            <comment id="15247051" author="bryanpendleton" created="Tue, 19 Apr 2016 02:49:56 +0000"  >&lt;p&gt;I&apos;m not really familiar with the code in this part of Derby, but I&lt;br/&gt;
took the famous approach of trying to &quot;do the simplest thing&lt;br/&gt;
that could possibly work&quot;, and made the trivial change to the&lt;br/&gt;
&quot;lobOffset&quot; and &quot;lobLength&quot; fields in the ImportReadData class.&lt;/p&gt;

&lt;p&gt;Attached &apos;trivial.diff&apos; is the result.&lt;/p&gt;

&lt;p&gt;With this patch applied, the test program passes.&lt;/p&gt;

&lt;p&gt;I&apos;m not willing to say this is the correct answer; in particular,&lt;br/&gt;
I had to down-cast the offset and length fields to int in order&lt;br/&gt;
to pass them to ImportLobFile.getString(), which expects int&lt;br/&gt;
values for accessing clob data.&lt;/p&gt;

&lt;p&gt;But it did make the test program pass, so maybe it&apos;s a&lt;br/&gt;
start toward a fix of some sort.&lt;/p&gt;

&lt;p&gt;I did no other testing at all.&lt;/p&gt;</comment>
                            <comment id="15249904" author="bryanpendleton" created="Wed, 20 Apr 2016 13:40:50 +0000"  >&lt;p&gt;With the patch applied, I ran the tools test suite, and there were no failures.&lt;/p&gt;

&lt;p&gt;This suggests that a simple path forward might be:&lt;br/&gt;
1) Convert the repro into a new test case in ImportExportLobTest.java&lt;br/&gt;
2) Commit the new test case, and the trivial diff&lt;/p&gt;

&lt;p&gt;I do worry that there may be other similar problems lurking though, so I&lt;br/&gt;
intend to (at least) produce a variant of the test case which uses a set of CLOB&lt;br/&gt;
columns rather than a set of BLOB columns, to check to see if there is a CLOB&lt;br/&gt;
variant of this job lurking.&lt;/p&gt;</comment>
                            <comment id="15251768" author="knutanders" created="Thu, 21 Apr 2016 12:07:46 +0000"  >&lt;p&gt;I agree that the casts from long to int look a bit suspicious. Wouldn&apos;t they end up as negative values? The test case doesn&apos;t seem to exercise that part of the code, so it&apos;s difficult to verify that it works correctly. (I replaced the modified lines in getClobColumnFromExtFileAsString() with &quot;throw new RuntimeException()&quot;, and the test case still passed.)&lt;/p&gt;</comment>
                            <comment id="15263398" author="bryanpendleton" created="Fri, 29 Apr 2016 01:53:41 +0000"  >&lt;p&gt;I finally got some time to try to develop a &quot;clob&quot; version of the repro&lt;br/&gt;
program, and, as I think we all expected, it fails in a similar fashion:&lt;/p&gt;

&lt;p&gt;Caused by: java.lang.NumberFormatException: For input string: &quot;2147487744&quot;&lt;br/&gt;
        at java.lang.NumberFormatException.forInputString(NumberFormatException.java:65)&lt;br/&gt;
        at java.lang.Integer.parseInt(Integer.java:583)&lt;br/&gt;
        at java.lang.Integer.parseInt(Integer.java:615)&lt;br/&gt;
        at org.apache.derby.impl.load.ImportReadData.initExternalLobFile(ImportReadData.java:1040)&lt;br/&gt;
        at org.apache.derby.impl.load.ImportReadData.getClobColumnFromExtFileAsString(ImportReadData.java:953)&lt;br/&gt;
        at org.apache.derby.impl.load.ImportAbstract.getString(ImportAbstract.java:167)&lt;br/&gt;
        at org.apache.derby.impl.load.Import.getString(Import.java:45)&lt;br/&gt;
        at org.apache.derby.iapi.types.SQLChar.setValueFromResultSet(SQLChar.java:1466)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.VTIResultSet.populateFromResultSet(VTIResultSet.java:688)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.VTIResultSet.getNextRowCore(VTIResultSet.java:461)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.ProjectRestrictResultSet.getNextRowCore(ProjectRestrictResultSet.java:287)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.NormalizeResultSet.getNextRowCore(NormalizeResultSet.java:188)&lt;br/&gt;
... (I truncated the stack trace)&lt;/p&gt;

&lt;p&gt;So there is clearly more work to be done, to address the issues on the CLOB side.&lt;/p&gt;</comment>
                            <comment id="15263399" author="bryanpendleton" created="Fri, 29 Apr 2016 01:56:52 +0000"  >&lt;p&gt;Attached is my first try at writing a regression test for these problems.&lt;/p&gt;

&lt;p&gt;Unfortunately, although this regression test appears to demonstrate&lt;br/&gt;
the problem with &quot;clob&quot; data when the external file exceeds Integer.MAX_VALUE&lt;br/&gt;
in size, the test is problematic: it takes more than 1 hour to run.&lt;/p&gt;

&lt;p&gt;I hope that I can improve the test program, because obviously&lt;br/&gt;
a test that takes an hour is not appropriate to put into our&lt;br/&gt;
test suite.&lt;/p&gt;

&lt;p&gt;My first ideas are (a) to not commit so often, and (b) to write a&lt;br/&gt;
smaller number of larger clob objects.&lt;/p&gt;

&lt;p&gt;I&apos;ll try some of those ideas, and see if the runtime of the test&lt;br/&gt;
is improved at all.&lt;/p&gt;

&lt;p&gt;Once I get a reliable test, including the &quot;blob&quot; version should&lt;br/&gt;
be straightforward.&lt;/p&gt;</comment>
                            <comment id="15264183" author="mikem" created="Fri, 29 Apr 2016 15:19:39 +0000"  >&lt;p&gt;there use to be a test suite for tests like this - especially clob/blob testing.  Even if you make it run fast, not everyone/everywhere will have the disk space to run it.  The suite was meant to at least be run once per release and more often by some nightly testing framework if possible - not sure if anyone runs it any more.&lt;/p&gt;</comment>
                            <comment id="15264991" author="bryanpendleton" created="Sat, 30 Apr 2016 00:07:12 +0000"  >&lt;p&gt;I think the test suite you might be referring to is the &quot;largeDataTests&quot;&lt;/p&gt;

&lt;p&gt;Unfortunately, all the references I can find to those tests are &amp;gt; 5 years old,&lt;br/&gt;
and my memory of how to run the old &quot;runall&quot; tests is fading.&lt;/p&gt;

&lt;p&gt;Still, I agree with you in principle; I&apos;ll do more research here.&lt;/p&gt;</comment>
                            <comment id="15264997" author="bryanpendleton" created="Sat, 30 Apr 2016 00:13:20 +0000"  >&lt;p&gt;Maybe something like:&lt;/p&gt;

&lt;p&gt;  java org.apache.derbyTesting.functionTests.harness.RunSuite largeData&lt;/p&gt;

&lt;p&gt;might work?&lt;/p&gt;</comment>
                            <comment id="15265479" author="bryanpendleton" created="Sat, 30 Apr 2016 20:39:48 +0000"  >&lt;p&gt;I believe I&apos;ve got the test able to reproduce both the CLOB and BLOB issues.&lt;/p&gt;

&lt;p&gt;However, it still takes a very long time to run.&lt;/p&gt;

&lt;p&gt;And, I don&apos;t have enough disk space on my (virtual) machine to run the test anymore,&lt;br/&gt;
so I&apos;ll need to add some more disk space.&lt;/p&gt;

&lt;p&gt;It&apos;s clear that these tests don&apos;t belong in the regular test suite, so I&apos;ll look into&lt;br/&gt;
placing these tests into the &quot;largeData&quot; suite suggested by Mike.&lt;/p&gt;</comment>
                            <comment id="15265596" author="bryanpendleton" created="Sun, 1 May 2016 03:47:31 +0000"  >&lt;p&gt;I&apos;ve moved the test cases to their own test program, so that&lt;br/&gt;
they won&apos;t be run by the regular test suites, but can still be&lt;br/&gt;
run as desired.&lt;/p&gt;

&lt;p&gt;Just as Knut Anders predicted, with &apos;trivial.diff&apos; applied, the&lt;br/&gt;
behavior of the CLOB test case changes from the integer&lt;br/&gt;
parse error to a &quot;Negative seek offset&quot; error, due to casting&lt;br/&gt;
the value from a long to an int producing a negative value.&lt;/p&gt;

&lt;p&gt;I&apos;ll try turning my attention to that detail later; for now I just&lt;br/&gt;
wanted to record the progress I&apos;d made.&lt;/p&gt;

&lt;p&gt;A snip from the stack trace is below.&lt;/p&gt;

&lt;p&gt;Caused by: java.io.IOException: Negative seek offset&lt;br/&gt;
        at java.io.RandomAccessFile.seek(RandomAccessFile.java:555)&lt;br/&gt;
        at org.apache.derby.impl.load.ImportFileInputStream.seek(ImportLobFile.java:266)&lt;br/&gt;
        at org.apache.derby.impl.load.ImportLobFile.getString(ImportLobFile.java:132)&lt;br/&gt;
        at org.apache.derby.impl.load.ImportReadData.getClobColumnFromExtFileAsString(ImportReadData.java:959)&lt;/p&gt;</comment>
                            <comment id="15265819" author="bryanpendleton" created="Sun, 1 May 2016 16:36:01 +0000"  >&lt;p&gt;After thinking about it some more in the clear light of morning, I took&lt;br/&gt;
a closer look at the reference pages for the CLOB and BLOB data types.&lt;/p&gt;

&lt;p&gt;Both data types are limited to 2GB as their maximum length.&lt;/p&gt;

&lt;p&gt;So I think the only actual problem here is the offset in the external&lt;br/&gt;
file, which needs to be a long to allow for external files &amp;gt; 2GB in size.&lt;/p&gt;

&lt;p&gt;The &apos;JustChangeOffset.diff&apos; patch contains a modification to the offset&lt;br/&gt;
field only; the length field is left as an int.&lt;/p&gt;

&lt;p&gt;This makes the code diff very small.&lt;/p&gt;

&lt;p&gt;I&apos;ll run various tests and see how it behaves.&lt;/p&gt;</comment>
                            <comment id="15266628" author="knutanders" created="Mon, 2 May 2016 13:41:35 +0000"  >&lt;p&gt;JustChangeOffset.diff looks good to me. Except that jardriftcheck fails when building the jar files, because of the new class in derbyTesting.jar. +1 to commit when that&apos;s fixed.&lt;/p&gt;

&lt;p&gt;A couple of nits:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;--- java/engine/org/apache/derby/impl/load/ImportLobFile.java	(revision 1741376)
+++ java/engine/org/apache/derby/impl/load/ImportLobFile.java	(working copy)
@@ -128,7 +128,7 @@
      * @param length  length of the the data.
      * @exception  IOException  on any I/O error.     
      */
-    public String getString(int offset, int length) throws IOException {
+    public String getString(long offset, int length) throws IOException {
         lobInputStream.seek(offset);
         lobLimitIn.clearLimit();
         lobLimitIn.setLimit((int) length);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;While you&apos;re at it, maybe also remove the redundant cast of length to int in the above call to setLimit(), so that readers don&apos;t have to spend cycles figuring out what the purpose of the cast is?&lt;/p&gt;

&lt;p&gt;You might also want to clean up the indentation in the test case. It uses a mix of tabs and spaces, and it doesn&apos;t always seem to agree with itself if tabs are 4 or 8 characters wide.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+        PreparedStatement ps = getConnection().prepareStatement(
+                     &quot;insert into DERBY_6884_TESTCLOB values(? , ?)&quot; );
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;BaseJDBCTestCase has a helper method for preparing statments, so the above could have been replaced with the slightly simpler&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        PreparedStatement ps = prepareStatement(
                     &lt;span class=&quot;code-quote&quot;&gt;&quot;insert into DERBY_6884_TESTCLOB values(? , ?)&quot;&lt;/span&gt; );
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then you don&apos;t have to close the prepared statement manually in the test case.&lt;/p&gt;</comment>
                            <comment id="15268016" author="jira-bot" created="Tue, 3 May 2016 03:20:12 +0000"  >&lt;p&gt;Commit 1742057 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bryanpendleton&quot; class=&quot;user-hover&quot; rel=&quot;bryanpendleton&quot;&gt;bryanpendleton&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1742057&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1742057&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6884&quot; title=&quot;SYSCS_IMPORT_TABLE_LOBS_FROM_EXTFILE can&amp;#39;t import more than Integer.MAX_VALUE bytes of blob data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6884&quot;&gt;&lt;del&gt;DERBY-6884&lt;/del&gt;&lt;/a&gt;: SYSCS_IMPORT_TABLE_LOBS_FROM_EXTFILE can&apos;t import lob data&lt;/p&gt;

&lt;p&gt;This change modifies the ImportLobFile.getString() and&lt;br/&gt;
ImportReadData.initExternalLobFile() methods so that they use a Java &quot;long&quot;&lt;br/&gt;
variable for the offset into the external lob file; prior to this change&lt;br/&gt;
they were using a Java &quot;int&quot; variable and hence would malfunction when the&lt;br/&gt;
lob offsets exceeded Integer.MAX_VALUE ( 2,147,483,647 ).&lt;/p&gt;

&lt;p&gt;The regression test which demonstrates these problems is a bit slow to run;&lt;br/&gt;
on my system, it takes approximately 15 minutes to execute, and requires&lt;br/&gt;
about 10 GB of available disk space during the test run. Therefore, the&lt;br/&gt;
test cases are placed in a new test program (Derby6884Test), which is not&lt;br/&gt;
listed in the &quot;standard&quot; system test suites, but rather is only added to the&lt;br/&gt;
&quot;largedata&quot; suite. The new test can also be run by itself, e.g.:&lt;/p&gt;

&lt;p&gt;ant -Dderby.junit.testclass=org.apache.derbyTesting.functionTests.tests.largedata.Derby6884Test junit-clean junit-single&lt;/p&gt;</comment>
                            <comment id="15268019" author="bryanpendleton" created="Tue, 3 May 2016 03:22:34 +0000"  >&lt;p&gt;Thanks Knut Anders for the careful review and good suggestions.&lt;/p&gt;

&lt;p&gt;The blank/tab thing continues to confound my editor settings, I&apos;m afraid.&lt;br/&gt;
Since the test program is entirely new source, I decided to use only&lt;br/&gt;
spaces in that (small) source file. That way, it is at least internally&lt;br/&gt;
consistent.&lt;/p&gt;

&lt;p&gt;The code changes in question are small, and could easily be&lt;br/&gt;
back-ported to earlier releases, but I am not planning to do that&lt;br/&gt;
at this time.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12799412" name="DerbyIssue.java" size="2952" author="bryanpendleton" created="Tue, 19 Apr 2016 01:37:29 +0000"/>
                            <attachment id="12801657" name="JustChangeOffset.diff" size="9031" author="bryanpendleton" created="Sun, 1 May 2016 16:36:01 +0000"/>
                            <attachment id="12801368" name="firstTryAtTest.diff" size="3097" author="bryanpendleton" created="Fri, 29 Apr 2016 01:56:52 +0000"/>
                            <attachment id="12801627" name="testForLargeDataSuite.diff" size="7146" author="bryanpendleton" created="Sun, 1 May 2016 03:47:31 +0000"/>
                            <attachment id="12799422" name="trivial.diff" size="1906" author="bryanpendleton" created="Tue, 19 Apr 2016 02:49:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10421"><![CDATA[Seen in production]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10423"><![CDATA[Newcomer]]></customfieldvalue>
    <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 29 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2w9if:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>