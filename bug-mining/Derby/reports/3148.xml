<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 14:51:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DERBY-6890] ALTER TABLE DROP COLUMN corrupts secondary index collation information</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6890</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;For a database with &quot;collation=/territory=&quot; information configured via&lt;br/&gt;
the JDBC Connection URL at database connection time, individual&lt;br/&gt;
columns in tables and indexes in the database have collation identification&lt;br/&gt;
which is stored as part of the table/index conglomerate.&lt;/p&gt;

&lt;p&gt;When an ALTER TABLE DROP COLUMN statement is run against&lt;br/&gt;
such a database, the drop column processing performs logic which&lt;br/&gt;
re-builds all of the (remaining) secondary indexes for that table&lt;br/&gt;
to reflect their new state following the removal of that column.&lt;/p&gt;

&lt;p&gt;This index rebuild process does not properly re-configure the&lt;br/&gt;
collation information for column(s) in those index(es), leaving&lt;br/&gt;
the indexes in a corrupt state.&lt;/p&gt;

&lt;p&gt;As a workaround, following the ALTER TABLE DROP COLUMN, the&lt;br/&gt;
damaged secondary indexes can be dropped and recreated explicitly.&lt;/p&gt;

&lt;p&gt;== Original issue description below ==&lt;/p&gt;

&lt;p&gt;After issue &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3888&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/DERBY-3888&lt;/a&gt; was fixed, we want to use the &apos;GENERATED BY DEFAULT&apos; feature &lt;br/&gt;
for our tables.  &lt;/p&gt;

&lt;p&gt;To migrate our tables, we use this sql: &lt;br/&gt;
     ALTER TABLE MODULE ADD COLUMN ID_TEMP BIGINT GENERATED BY DEFAULT AS IDENTITY;&lt;br/&gt;
     UPDATE MODULE SET ID_TEMP = ID;&lt;br/&gt;
     ALTER TABLE MODULE ALTER COLUMN ID_TEMP NOT NULL;&lt;br/&gt;
     ALTER TABLE MODULE DROP ID;&lt;br/&gt;
     RENAME COLUMN MODULE.ID_TEMP TO ID;&lt;/p&gt;

&lt;p&gt;But after I applied it, I started to get this exception:&lt;br/&gt;
Caused by: org.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED type of inserted column&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; = org.apache.derby.iapi.types.CollatorSQLVarchartype of template column&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; = org.apache.derby.iapi.types.SQLVarchar&lt;br/&gt;
	at org.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(SanityManager.java:162)&lt;br/&gt;
	at org.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(SanityManager.java:147)&lt;br/&gt;
	at org.apache.derby.impl.store.access.btree.OpenBTree.isIndexableRowConsistent(OpenBTree.java:519)&lt;br/&gt;
	at org.apache.derby.impl.store.access.btree.BTreeController.doIns(BTreeController.java:679)&lt;br/&gt;
	at org.apache.derby.impl.store.access.btree.BTreeController.insert(BTreeController.java:1372)&lt;br/&gt;
	at org.apache.derby.impl.store.access.btree.index.B2IController.insert(B2IController.java:210)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.IndexChanger.insertAndCheckDups(IndexChanger.java:565)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.IndexChanger.doInsert(IndexChanger.java:393)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.IndexChanger.insert(IndexChanger.java:713)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.IndexSetChanger.insert(IndexSetChanger.java:268)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.RowChangerImpl.insertRow(RowChangerImpl.java:458)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.InsertResultSet.normalInsertCore(InsertResultSet.java:881)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.InsertResultSet.open(InsertResultSet.java:452)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:473)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:352)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1340)&lt;br/&gt;
	... 30 more&lt;/p&gt;

&lt;p&gt;I attached Test.groovy class which shows this issue. &lt;/p&gt;

&lt;p&gt;also I found this workaround: &lt;br/&gt;
we need to drop all indexes and create them again, after we applied this pk column update.&lt;/p&gt;




</description>
                <environment>Mac OS X 10.11.5&lt;br/&gt;
JDK: Oracle 1.8.0_92</environment>
        <key id="12973322">DERBY-6890</key>
            <summary>ALTER TABLE DROP COLUMN corrupts secondary index collation information</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanpendleton">Bryan Pendleton</assignee>
                                    <reporter username="akoyro">Andrei Koiro</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 May 2016 06:57:31 +0000</created>
                <updated>Thu, 15 Sep 2016 15:25:09 +0000</updated>
                            <resolved>Sat, 18 Jun 2016 16:02:08 +0000</resolved>
                                    <version>10.12.1.1</version>
                                    <fixVersion>10.13.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15311354" author="bryanpendleton" created="Wed, 1 Jun 2016 23:30:23 +0000"  >&lt;p&gt;I tried to edit the reproduction script into the&lt;br/&gt;
AlterTableTest.java test suite in the Derby regression tests.&lt;/p&gt;

&lt;p&gt;The new test case (attached as testRepro.diff) does not&lt;br/&gt;
reproduce the problem, however.&lt;/p&gt;

&lt;p&gt;I am not sure if I made a simple mistake in translating from&lt;br/&gt;
the Groovy-language test program into pure Java, or if there&lt;br/&gt;
is something more subtle going on.&lt;/p&gt;

&lt;p&gt;Perhaps somebody else can compare my testRepro.diff against&lt;br/&gt;
Test.groovy and see how to make a reproducible test case in pure Java.&lt;/p&gt;</comment>
                            <comment id="15312034" author="andrey.koyro" created="Thu, 2 Jun 2016 09:41:40 +0000"  >&lt;p&gt;I will chech it today&lt;/p&gt;




&lt;p&gt;&amp;#8211; &lt;br/&gt;
Best regards&lt;br/&gt;
Andrey&lt;/p&gt;</comment>
                            <comment id="15312447" author="akoyro" created="Thu, 2 Jun 2016 15:07:50 +0000"  >&lt;p&gt;I made a few experiments and see that the exception depends on number of INSERTs in one commit, or may be it depends on length (or chars) of this &apos;title&apos;. &lt;br/&gt;
I am not sure. &lt;/p&gt;

&lt;p&gt;Anyway, I have adjusted this test, on my env it throws the exception always. I have ported it to java, See Test.java.&lt;/p&gt;</comment>
                            <comment id="15313406" author="bryanpendleton" created="Fri, 3 Jun 2016 00:41:40 +0000"  >&lt;p&gt;Hi Andrei,&lt;/p&gt;

&lt;p&gt;Thanks very much for the updated Test.java. It reproduces the problem for me, too, now.&lt;/p&gt;

&lt;p&gt;I think the problem may be closely related to this: &quot;;collation=TERRITORY_BASED:SECONDARY&quot;&lt;/p&gt;

&lt;p&gt;When I remove the &quot;collation=&quot; from the JDBC Connection URL, the Test.java program no longer&lt;br/&gt;
reproduces the problem for me.&lt;/p&gt;

&lt;p&gt;Can you confirm that finding when you get a chance?&lt;/p&gt;</comment>
                            <comment id="15313420" author="bryanpendleton" created="Fri, 3 Jun 2016 00:58:12 +0000"  >&lt;p&gt;Since it appears that this problem is related to collation sequence handling,&lt;br/&gt;
I moved the test case from the AlterTableTest suite to the CollationTest suite.&lt;/p&gt;

&lt;p&gt;The modified test reliably reproduces the problem for me.&lt;/p&gt;

&lt;p&gt;I didn&apos;t experiment with backing down the statement count from 295;&lt;br/&gt;
perhaps fewer INSERT statements would work.&lt;/p&gt;

&lt;p&gt;Regardless, the crucial point is that I now see the same failure that&lt;br/&gt;
Andrei described.&lt;/p&gt;

&lt;p&gt;Unfortunately, collation sequence handling is not all that familiar&lt;br/&gt;
to me, so I will have to study the code in more detail to understand&lt;br/&gt;
more about what is going wrong.&lt;/p&gt;</comment>
                            <comment id="15313485" author="akoyro" created="Fri, 3 Jun 2016 02:27:05 +0000"  >&lt;p&gt;Hi Bryan&lt;/p&gt;

&lt;p&gt;Yes, you are right, if I use the default collation I don&apos;t get this exception.  But TERRITORY_BASED:SECONDARY allows case insensitive queries and I should create my db with this collation.&lt;/p&gt;

&lt;p&gt;And one more, in my test there are two commented out statements:&lt;br/&gt;
//          !!!!!!!!!!! WORKAROUND !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&lt;br/&gt;
//		s.execute(&quot;DROP INDEX Module_title&quot;);&lt;br/&gt;
//		s.execute(&quot;CREATE INDEX Module_title ON Module(title)&quot;);&lt;/p&gt;

&lt;p&gt;If you uncomment these lines this exception goes away. &lt;/p&gt;
</comment>
                            <comment id="15315143" author="bryanpendleton" created="Sat, 4 Jun 2016 00:07:02 +0000"  >&lt;p&gt;The Btree code is complaining because it has two objects, one which is a SQLVarchar,&lt;br/&gt;
and one which is a CollatorSQLVarchar. Below are the stack traces of the places where&lt;br/&gt;
I think those two different objects are being created.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;java.lang.Exception: CollatorSQLVarchar constructor&lt;br/&gt;
	at org.apache.derby.iapi.types.CollatorSQLVarchar.&amp;lt;init&amp;gt;(CollatorSQLVarchar.java:57)&lt;br/&gt;
	at org.apache.derby.iapi.types.SQLVarchar.getValue(SQLVarchar.java:91)&lt;br/&gt;
	at org.apache.derby.iapi.types.DataTypeDescriptor.getNull(DataTypeDescriptor.java:1024)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.NormalizeResultSet.getCachedDestination(NormalizeResultSet.java:401)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.NormalizeResultSet.normalizeRow(NormalizeResultSet.java:378)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.NormalizeResultSet.getNextRowCore(NormalizeResultSet.java:191)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.DMLWriteResultSet.getNextRowCore(DMLWriteResultSet.java:148)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.InsertResultSet.getNextRowCore(InsertResultSet.java:1082)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.InsertResultSet.open(InsertResultSet.java:451)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:472)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:351)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1339)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1709)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeLargeUpdate(EmbedPreparedStatement.java:320)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeUpdate(EmbedPreparedStatement.java:309)&lt;br/&gt;
	at Test.testDerby6890(Test.java:49)&lt;br/&gt;
	at Test.main(Test.java:73)&lt;/p&gt;

&lt;p&gt;java.lang.Exception: Simple SQLVarchar constructor&lt;br/&gt;
	at org.apache.derby.iapi.types.SQLVarchar.&amp;lt;init&amp;gt;(SQLVarchar.java:117)&lt;br/&gt;
	at org.apache.derby.iapi.types.DataValueFactoryImpl.getNullDVDWithUCS_BASICcollation(DataValueFactoryImpl.java:1125)&lt;br/&gt;
	at org.apache.derby.iapi.types.DataValueFactoryImpl.getNull(DataValueFactoryImpl.java:1073)&lt;br/&gt;
	at org.apache.derby.impl.store.access.conglomerate.TemplateRow.allocate_objects(TemplateRow.java:96)&lt;br/&gt;
	at org.apache.derby.impl.store.access.conglomerate.TemplateRow.newRow(TemplateRow.java:199)&lt;br/&gt;
	at org.apache.derby.impl.store.access.conglomerate.OpenConglomerateScratchSpace.get_template(OpenConglomerateScratchSpace.java:210)&lt;br/&gt;
	at org.apache.derby.impl.store.access.btree.BTreeController.doIns(BTreeController.java:675)&lt;br/&gt;
	at org.apache.derby.impl.store.access.btree.BTreeController.insert(BTreeController.java:1372)&lt;br/&gt;
	at org.apache.derby.impl.store.access.btree.index.B2IController.insert(B2IController.java:210)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.IndexChanger.insertAndCheckDups(IndexChanger.java:565)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.IndexChanger.doInsert(IndexChanger.java:393)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.IndexChanger.insert(IndexChanger.java:713)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.IndexSetChanger.insert(IndexSetChanger.java:268)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.RowChangerImpl.insertRow(RowChangerImpl.java:458)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.InsertResultSet.normalInsertCore(InsertResultSet.java:881)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.InsertResultSet.open(InsertResultSet.java:452)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.executeStmt(GenericPreparedStatement.java:472)&lt;br/&gt;
	at org.apache.derby.impl.sql.GenericPreparedStatement.execute(GenericPreparedStatement.java:351)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1339)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(EmbedPreparedStatement.java:1709)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeLargeUpdate(EmbedPreparedStatement.java:320)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeUpdate(EmbedPreparedStatement.java:309)&lt;br/&gt;
	at Test.testDerby6890(Test.java:49)&lt;br/&gt;
	at Test.main(Test.java:73)&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="15315563" author="bryanpendleton" created="Sat, 4 Jun 2016 16:30:30 +0000"  >&lt;p&gt;I haven&apos;t really developed a good intuitive theory about this bug yet.&lt;/p&gt;

&lt;p&gt;It seems that the problem lies with the Module_title index, for several reasons:&lt;br/&gt;
1) The proximate cause of the problem is that when we go to manufacture&lt;br/&gt;
   a &quot;template&quot; row for the Module_title index, the template is manufactured&lt;br/&gt;
   with a simple SQLVarchar datatype, rather than a CollatorSQLVarchar datatype.&lt;br/&gt;
2) If we drop and recreate the Module_title index, the problem goes away&lt;/p&gt;

&lt;p&gt;And surely the problem must be with one of the alteration statements that&lt;br/&gt;
are issued (ALTER TABLE, RENAME COLUMN).&lt;/p&gt;

&lt;p&gt;But none of those alteration statements are performed against the Module_title&lt;br/&gt;
index, so I don&apos;t have a clear idea about how this (unrelated?) secondary&lt;br/&gt;
index is getting damaged by the alter statements that should only be affecting&lt;br/&gt;
(a) the base table, and (b) the system-generated primary key constraint index.&lt;/p&gt;

&lt;p&gt;And another big problem with my intuitive grasp of this bug is that the collation&lt;br/&gt;
and territory information for a database is supposed to be database-wide, not&lt;br/&gt;
table-by-table and index-by-index, so I don&apos;t understand how we could get&lt;br/&gt;
into a situation where some of the tables and indexes in the database think&lt;br/&gt;
they have one sort of collation/territory configuration, while other tables/indexes&lt;br/&gt;
think they have a different configuration.&lt;/p&gt;

&lt;p&gt;Perhaps the next step is to back WAY up, and study what happens with the&lt;br/&gt;
&apos;collation=&apos; attribute on the connection URL at database creation time.&lt;/p&gt;</comment>
                            <comment id="15315667" author="bryanpendleton" created="Sat, 4 Jun 2016 22:21:59 +0000"  >&lt;p&gt;Possibly things go wrong in the ALTER TABLE DROP COLUMN ID statement,&lt;br/&gt;
which causes us to run this section of code:&lt;/p&gt;

&lt;p&gt;	at org.apache.derby.impl.sql.execute.AlterTableConstantAction.updateIndex(AlterTableConstantAction.java:2780)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.AlterTableConstantAction.updateAllIndexes(AlterTableConstantAction.java:2694)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.AlterTableConstantAction.compressTable(AlterTableConstantAction.java:2456)&lt;br/&gt;
	at org.apache.derby.impl.sql.execute.AlterTableConstantAction.dropColumnFromTable(AlterTableConstantAction.java:1725)&lt;/p&gt;

&lt;p&gt;In AlterTableConstantAction.compressTable, there is some special code for&lt;br/&gt;
the DROP COLUMN case which adjusts the collation IDs for the base table &lt;br/&gt;
to reflect the impact that dropping this column has on the remaining columns.&lt;/p&gt;

&lt;p&gt;(That is, we remove the collation ID for the dropped column, and slide all&lt;br/&gt;
subsequent collation ids for the remaining columns in the base table down&lt;br/&gt;
by one to compensate).&lt;/p&gt;

&lt;p&gt;But I don&apos;t see, yet, any similar code which adjusts the collation ids for&lt;br/&gt;
the columns of the secondary indexes.&lt;/p&gt;

&lt;p&gt;So my working theory is that it&apos;s AlterTableConstantAction.compress, when&lt;br/&gt;
called for the DROP COLUMN case, that is corrupting the collation ids&lt;br/&gt;
for the secondary index columns.&lt;/p&gt;</comment>
                            <comment id="15315699" author="bryanpendleton" created="Sun, 5 Jun 2016 01:30:37 +0000"  >&lt;p&gt;The support for adjusting the collation identifiers&lt;br/&gt;
during ALTER TABLE DROP COLUMN was part&lt;br/&gt;
of &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-2537&quot; title=&quot;implement pushing collation info to store, storing collation info in store metadata, and creating templates based on store metadata&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-2537&quot;&gt;&lt;del&gt;DERBY-2537&lt;/del&gt;&lt;/a&gt;, so linking this issue to that.&lt;/p&gt;</comment>
                            <comment id="15315971" author="bryanpendleton" created="Sun, 5 Jun 2016 18:12:29 +0000"  >&lt;p&gt;OK, I think I see the problem now, though I don&apos;t yet know how to fix it.&lt;/p&gt;

&lt;p&gt;The test performs an ALTER TABLE DROP COLUMN ID statement. Before&lt;br/&gt;
that statement, the Module table has columns (ID, TITLE, ID_TEMP).&lt;br/&gt;
After that statement, the Module table will have columns (TITLE, ID_TEMP).&lt;/p&gt;

&lt;p&gt;Near the end of ALTER TABLE DROP COLUMN ID, we are going to&lt;br/&gt;
rebuild all the indexes on table Module. At this point, since we are dropping the&lt;br/&gt;
primary key column ID, we are also discarding the system-generated index&lt;br/&gt;
for the primary key, so there is only 1 index on table Module, namely the&lt;br/&gt;
Module_title index on Module(title).&lt;/p&gt;

&lt;p&gt;This index processing sets up a sorter for each remaining index, in&lt;br/&gt;
preparation to scanning the base table and reloading each index. This&lt;br/&gt;
work is done by AlterTableConstantAction.setUpAllSorts().&lt;/p&gt;

&lt;p&gt;But the data structures at this point are confused. The table descriptor&lt;br/&gt;
(td.getColumnDescriptorList) is still showing (ID,TITLE,ID_TEMP), but&lt;br/&gt;
the collation ids are expecting to work with the columns (TITLE,ID_TEMP).&lt;br/&gt;
When we go to set up the sorter for the Module_title index, we look at&lt;br/&gt;
the information about the first column, expecting that to be the information&lt;br/&gt;
for the TITLE column, but instead the column we get from the column&lt;br/&gt;
descriptor list is the first column in the *&lt;b&gt;old&lt;/b&gt;* table, which is the ID column,&lt;br/&gt;
and hence we rebuild the Module_title index using the collation information&lt;br/&gt;
from the ID column, rather than the TITLE column.&lt;/p&gt;

&lt;p&gt;Since ID is a BIGINT, not a string, it has no collation information, so the&lt;br/&gt;
new index that we build says that the first column has no collation&lt;br/&gt;
information, but then when the test later tries to update the index, the&lt;br/&gt;
store (rightfully) complains because column TITLE is a string column&lt;br/&gt;
and so it *&lt;b&gt;should&lt;/b&gt;* have had collation information.&lt;/p&gt;

&lt;p&gt;So either, at this point, we should be using collation information that&lt;br/&gt;
is still based off the original table column description list, or we should&lt;br/&gt;
be referencing the new (post-DROP COLUMN) column descriptor list.&lt;/p&gt;

&lt;p&gt;We call&lt;/p&gt;</comment>
                            <comment id="15315989" author="bryanpendleton" created="Sun, 5 Jun 2016 19:20:08 +0000"  >&lt;p&gt;Updated issue title and description.&lt;/p&gt;</comment>
                            <comment id="15316002" author="bryanpendleton" created="Sun, 5 Jun 2016 20:02:18 +0000"  >&lt;p&gt;Attached &apos;doesntPassTests.diff&apos; is not for commit, but may&lt;br/&gt;
show a possible path forward.&lt;/p&gt;

&lt;p&gt;The idea of this patch is to move the computation of&lt;br/&gt;
the index collation ids out of &apos;setUpAllSorts&apos; and into&lt;br/&gt;
&apos;getAffectedIndexes&apos;. This allows us to compute the index&lt;br/&gt;
collation ids before we have re-numbered the index&lt;br/&gt;
columns, thus getting the correct collation id information.&lt;/p&gt;

&lt;p&gt;With this patch in place, the reproduction script passes,&lt;br/&gt;
which is nice. However, there is a test failure in AlterTableTest,&lt;br/&gt;
in test &quot;testDropColumn&quot;, at line 3096 of AlterTableTest.java,&lt;br/&gt;
with the output:&lt;/p&gt;

&lt;p&gt;org.apache.derby.shared.common.sanity.AssertFailure: ASSERT FAILED sizeof_ids = 2;collationIds.length = 4&lt;br/&gt;
        at org.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(SanityManager.java:162)&lt;br/&gt;
        at org.apache.derby.shared.common.sanity.SanityManager.THROWASSERT(SanityManager.java:147)&lt;br/&gt;
        at org.apache.derby.impl.store.access.conglomerate.ConglomerateUtil.createCollationIds(ConglomerateUtil.java:227)&lt;br/&gt;
        at org.apache.derby.impl.store.access.btree.index.B2I.create(B2I.java:592)&lt;br/&gt;
        at org.apache.derby.impl.store.access.btree.index.B2IFactory.createConglomerate(B2IFactory.java:225)&lt;br/&gt;
        at org.apache.derby.impl.store.access.RAMTransaction.createConglomerate(RAMTransaction.java:803)&lt;br/&gt;
        at org.apache.derby.impl.store.access.RAMTransaction.recreateAndLoadConglomerate(RAMTransaction.java:880)&lt;br/&gt;
        at org.apache.derby.impl.store.access.RAMTransaction.createAndLoadConglomerate(RAMTransaction.java:844)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.AlterTableConstantAction.updateIndex(AlterTableConstantAction.java:2786)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.AlterTableConstantAction.updateAllIndexes(AlterTableConstantAction.java:2700)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.AlterTableConstantAction.compressTable(AlterTableConstantAction.java:2462)&lt;br/&gt;
        at org.apache.derby.impl.sql.execute.AlterTableConstantAction.dropColumnFromTable(AlterTableConstantAction.java:1725)&lt;/p&gt;

&lt;p&gt;But maybe this is progress anyway, so I&apos;m recording it here.&lt;/p&gt;</comment>
                            <comment id="15316012" author="bryanpendleton" created="Sun, 5 Jun 2016 20:59:19 +0000"  >&lt;p&gt;Attached &apos;fixIndexCollation.diff&apos; is a patch proposal.&lt;/p&gt;

&lt;p&gt;It passes both AlterTableTest and CollationTest, as well as&lt;br/&gt;
the reproduction script (which is included as a new test in&lt;br/&gt;
CollationTest by this patch).&lt;/p&gt;

&lt;p&gt;I&apos;m running a more complete set of tests to see what else pops out.&lt;/p&gt;

&lt;p&gt;The idea of the fix is as described before, to move the collation&lt;br/&gt;
id computation for the indexes from setUpAllSorts into getAffectedIndexes,&lt;br/&gt;
with the additional complexity that if an index includes the column&lt;br/&gt;
which is being dropped, we must (carefully) omit that column from&lt;br/&gt;
the collation id array that we build. This fixup is now performed at&lt;br/&gt;
the same point in the code where we fixup the column position data,&lt;br/&gt;
which seems more appropriate than where it was before this patch.&lt;/p&gt;

&lt;p&gt;This is complex, subtle code. But maybe this patch is viable.&lt;/p&gt;</comment>
                            <comment id="15316073" author="bryanpendleton" created="Sun, 5 Jun 2016 23:21:20 +0000"  >&lt;p&gt;The patch isn&apos;t completely viable; the tests show that certain code paths&lt;br/&gt;
through SYSCS_COMPRESS_TABLE now fail because the collation ids&lt;br/&gt;
aren&apos;t getting set at all, and thus we get a NullPointerException.&lt;/p&gt;

&lt;p&gt;But overall, the patch seems like it has a lot of potential. I&apos;ll need to&lt;br/&gt;
track down those NPEs, though.&lt;/p&gt;</comment>
                            <comment id="15318539" author="bryanpendleton" created="Tue, 7 Jun 2016 14:17:25 +0000"  >&lt;p&gt;Attached &apos;proposed.diff&apos; passes regression tests and is, I think,&lt;br/&gt;
a viable candidate for commit.&lt;/p&gt;

&lt;p&gt;Although the actual number of lines of code changes is small,&lt;br/&gt;
the code paths through ALTER TABLE are complex, and&lt;br/&gt;
affect at least SYSCS_COMPRESS_TABLE, TRUNCATE TABLE,&lt;br/&gt;
and ALTER TABLE DROP COLUMN.&lt;/p&gt;

&lt;p&gt;If anyone has the time to review the patch, that would be great.&lt;/p&gt;</comment>
                            <comment id="15319869" author="rhillegas" created="Wed, 8 Jun 2016 02:19:27 +0000"  >&lt;p&gt;Hi Bryan,&lt;/p&gt;

&lt;p&gt;I have taken a quick look at the patch and it seems to be complicated enough for the problem described. But this is tricky code and I always make mistakes myself when I&apos;m in AlterTableConstantAction. Fortunately, the existing regression tests usually flag my blunders. I recommend adding more test cases. Maybe a test case for ALTER TABLE ADD COLUMN in the presence of an index on a column with a collation. Thanks.&lt;/p&gt;</comment>
                            <comment id="15319985" author="bryanpendleton" created="Wed, 8 Jun 2016 04:43:21 +0000"  >&lt;p&gt;Thanks for the review, Rick. I agree that some additional test cases would&lt;br/&gt;
be valuable in this area. I will think on this for a bit.&lt;/p&gt;</comment>
                            <comment id="15323714" author="bryanpendleton" created="Fri, 10 Jun 2016 01:40:43 +0000"  >&lt;p&gt;I spent some time looking through the test cases in CollationTest2.java. From what&lt;br/&gt;
I can tell, they are a pretty extensive set of test cases for this area of the code.&lt;/p&gt;

&lt;p&gt;However, those test cases didn&apos;t reveal this bug.&lt;/p&gt;

&lt;p&gt;I&apos;m going to try to dig into the specific ALTER TABLE related test cases in CollationTest2&lt;br/&gt;
and try to understand why the existing test cases didn&apos;t trip this bug.&lt;/p&gt;

&lt;p&gt;And then my hope is to extend and augment those test cases, rather than writing&lt;br/&gt;
a bunch of new test cases, because that seems a bit simpler overall.&lt;/p&gt;

&lt;p&gt;I think that we want to cover:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ALTER TABLE DROP COLUMN&lt;/li&gt;
	&lt;li&gt;SYSCS_COMPRESS_TABLE&lt;/li&gt;
	&lt;li&gt;TRUNCATE TABLE&lt;br/&gt;
other ALTER TABLE actions, such as ADD COLUMN, ALTER COLUMN, RENAME COLUMN&lt;/li&gt;
	&lt;li&gt;different patterns of secondary indexes, both system-generated and user defined&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15326084" author="bryanpendleton" created="Sat, 11 Jun 2016 23:52:10 +0000"  >&lt;p&gt;Yay! After a few false starts, I was able to modify CollationTest2.java&lt;br/&gt;
so that it, too, reproduces this bug. Attached CollationTest2.diff is&lt;br/&gt;
the test change.&lt;/p&gt;

&lt;p&gt;I am still only able to demonstrate problems in the DROP COLUMN case;&lt;br/&gt;
the various other tests in CollationTest2.java (TRUNCATE TABLE,&lt;br/&gt;
ADD COLUMN, COMPRESS, etc.) are not revealing any additional issues.&lt;/p&gt;

&lt;p&gt;Next step will be to unify these test changes with the already-constructed&lt;br/&gt;
patch to get a more complete patch with better test coverage.&lt;/p&gt;</comment>
                            <comment id="15337487" author="bryanpendleton" created="Sat, 18 Jun 2016 03:27:05 +0000"  >&lt;p&gt;Attached &apos;ready.diff&apos; is the change I propose to commit. Tests are clean.&lt;/p&gt;</comment>
                            <comment id="15337991" author="jira-bot" created="Sat, 18 Jun 2016 16:00:22 +0000"  >&lt;p&gt;Commit 1749069 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bryanpendleton&quot; class=&quot;user-hover&quot; rel=&quot;bryanpendleton&quot;&gt;bryanpendleton&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1749069&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1749069&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6890&quot; title=&quot;ALTER TABLE DROP COLUMN corrupts secondary index collation information&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6890&quot;&gt;&lt;del&gt;DERBY-6890&lt;/del&gt;&lt;/a&gt;: ALTER TABLE DROP COLUMN corrupts secondary index collation data.&lt;/p&gt;

&lt;p&gt;During ALTER TABLE DROP COLUMN, we rebuild all the indexes on the table. Some&lt;br/&gt;
indexes may be entirely dropped, some indexes may be rebuilt with a subset&lt;br/&gt;
of columns, some indexes are simply rebuild with essentially the same content.&lt;/p&gt;

&lt;p&gt;The issue is that the index rebuild logic was incorrectly setting the&lt;br/&gt;
collation data for each index. So the indexes had the right data, but the&lt;br/&gt;
wrong collation information, causing them to be damaged.&lt;/p&gt;

&lt;p&gt;This change moves the computation of the index collation ids out of the&lt;br/&gt;
setUpAllSorts method, into the getAffectedIndexes method, where it is simpler&lt;br/&gt;
to compute the index collation ids appropriately, because the code in that&lt;br/&gt;
location already has logic to manipulate both the old (pre-DROP) and new&lt;br/&gt;
(post-DROP) table descriptions, and so it is straightforward to compute the&lt;br/&gt;
correct collation ids there.&lt;/p&gt;

&lt;p&gt;As part of this change, an old test case in CollationTest2, which was marked&lt;br/&gt;
with the comment &quot;this test does not work yet&quot;, and was disabled, is changed&lt;br/&gt;
(un-commented) and is now enabled.&lt;/p&gt;

&lt;p&gt;I found no new problems with this test case. I believe that, at the time&lt;br/&gt;
that comment was written, there were bugs in Derby that have since been&lt;br/&gt;
repaired, and hence it is appropriate to enable this test case at this time.&lt;/p&gt;</comment>
                            <comment id="15337992" author="bryanpendleton" created="Sat, 18 Jun 2016 16:02:08 +0000"  >&lt;p&gt;I think this patch is as good as I can make it for now, and so I&apos;m&lt;br/&gt;
committing it to get additional experience with it in the trunk.&lt;/p&gt;</comment>
                            <comment id="15492043" author="ari" created="Thu, 15 Sep 2016 01:54:47 +0000"  >&lt;p&gt;Will there be a 10.13 release in 2016, or perhaps a backport of bug fixes to another 10.12 release?&lt;/p&gt;</comment>
                            <comment id="15493653" author="rhillegas" created="Thu, 15 Sep 2016 15:25:09 +0000"  >&lt;p&gt;Hi Ari,&lt;/p&gt;

&lt;p&gt;I believe that Bryan has volunteered to manage a 10.13.1 release this fall. See &lt;a href=&quot;http://apache-database.10148.n7.nabble.com/Proposal-for-a-Derby-10-13-release-this-fall-td146404.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-database.10148.n7.nabble.com/Proposal-for-a-Derby-10-13-release-this-fall-td146404.html&lt;/a&gt;. He has not proposed a schedule yet: &lt;a href=&quot;http://wiki.apache.org/db-derby/DerbyTenThirteenOneRelease&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://wiki.apache.org/db-derby/DerbyTenThirteenOneRelease&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12366919">DERBY-2537</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12807870" name="CollationTest.diff" size="2441" author="bryanpendleton" created="Fri, 3 Jun 2016 00:58:12 +0000"/>
                            <attachment id="12809653" name="CollationTest2.diff" size="3534" author="bryanpendleton" created="Sat, 11 Jun 2016 23:52:10 +0000"/>
                            <attachment id="12806581" name="Test.groovy" size="1863" author="akoyro" created="Fri, 27 May 2016 07:00:01 +0000"/>
                            <attachment id="12807739" name="Test.java" size="2351" author="akoyro" created="Thu, 2 Jun 2016 15:08:37 +0000"/>
                            <attachment id="12808216" name="doesntPassTests.diff" size="4369" author="bryanpendleton" created="Sun, 5 Jun 2016 20:02:18 +0000"/>
                            <attachment id="12808217" name="fixIndexCollation.diff" size="5039" author="bryanpendleton" created="Sun, 5 Jun 2016 20:59:19 +0000"/>
                            <attachment id="12808683" name="proposed.diff" size="5463" author="bryanpendleton" created="Tue, 7 Jun 2016 14:17:25 +0000"/>
                            <attachment id="12811510" name="ready.diff" size="8997" author="bryanpendleton" created="Sat, 18 Jun 2016 03:27:05 +0000"/>
                            <attachment id="12807556" name="testRepro.diff" size="1982" author="bryanpendleton" created="Wed, 1 Jun 2016 23:30:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 9 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yl1r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>