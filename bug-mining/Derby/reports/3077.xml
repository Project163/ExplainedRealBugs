<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 14:49:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DERBY-6737] CLOB retrieve exceptions after moving cursor around</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6737</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;The version we are running is a bit older (10.8.2.2), but I have tried latest version of Derby @ 10.11.1.1 with it&apos;s JDBC drivers that are included with it.  I am having problems with CLOB after moving the cursor forward/backwards. The CLOB(s) themselves are roughly 500000+ characters each. &lt;/p&gt;

&lt;p&gt;Sample Code: &lt;br/&gt;
------------------------------------------------------------------------------------------- &lt;br/&gt;
import java.sql.Clob; &lt;br/&gt;
import java.sql.Connection; &lt;br/&gt;
import java.sql.DriverManager; &lt;br/&gt;
import java.sql.ResultSet; &lt;br/&gt;
import java.sql.Statement; &lt;/p&gt;

&lt;p&gt;public class testZ { &lt;br/&gt;
        private static String dbURL = &quot;jdbc:derby://9.42.11.34:1527/TestDB;create=true;user=test;password=test&quot;; &lt;/p&gt;

&lt;p&gt;        public static void main(String[] args) { &lt;br/&gt;
                try &lt;/p&gt;
{ 
                        Class.forName(&quot;org.apache.derby.jdbc.ClientDriver&quot;).newInstance(); 
                        Connection conn = DriverManager.getConnection(dbURL); 
                        conn.setAutoCommit(false); 
                        Statement stmt = conn.createStatement(ResultSet.TYPE_SCROLL_SENSITIVE, ResultSet.CONCUR_READ_ONLY); 
                        ResultSet rs = stmt.executeQuery(&quot;select * from TESTCLOB where EVENTID=30266&quot;);	
                        rs.last(); 
                        System.out.println(rs.getRow()); 
                        rs.first(); 
                        
                        Clob clob = rs.getClob(&quot;GROUPASC&quot;); 
                        int len = (int) ((java.sql.Clob) clob).length(); 
                        String clobData = ((java.sql.Clob) clob).getSubString(1, len); 
                        System.out.println(&quot;Clob Data: &quot; + clobData);	
                }
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{ 
                        e.printStackTrace(); 
                } &lt;br/&gt;
        } &lt;br/&gt;
} &lt;br/&gt;
--------------------------------------------------------------------------------------------- &lt;br/&gt;
&lt;br/&gt;
Notice I am moving the cursor around. I wanted to get the size of the result set prior to getting the Clob data. So I do a rs.last() and rs.getNum() to get the size of the result set. I then move the cursor back to the first row and obtain the Clob data for first row. If I remove the rs.first() statement and get the Clob data of the rs.last() row, it works fine.  It seems as long as I go forward (not backwards), the CLOB data is retrievable. Note from the code, I am using ResultSet.TYPE_SCROLL_SENSITIVE. I have tried TYPE_SCROLL_INSENSITIVE, but with the same problem.  I also tried enabling/disabling the auto commit, also still have this error. For this code, I am getting the following error: &lt;br/&gt;
&lt;br/&gt;
java.sql.SQLException: You cannot invoke other java.sql.Clob/java.sql.Blob methods after calling the free() method or after the Blob/Clob&apos;s transaction has been committed or rolled back. &lt;br/&gt;
        at org.apache.derby.client.am.SQLExceptionFactory.getSQLException(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.am.SqlException.getSQLException(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.am.ClientClob.length(Unknown Source) &lt;br/&gt;
        at testZ.main(testZ.java:25) &lt;br/&gt;
Caused by: ERROR XJ215: You cannot invoke other java.sql.Clob/java.sql.Blob methods after calling the free() method or after the Blob/Clob&apos;s transaction has been committed or rolled back. &lt;br/&gt;
        at org.apache.derby.client.am.CallableLocatorProcedures.handleInvalidLocator(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.am.CallableLocatorProcedures.clobGetLength(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.am.ClientClob.getLocatorLength(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.am.Lob.sqlLength(Unknown Source) &lt;br/&gt;
        ... 2 more &lt;br/&gt;
Caused by: ERROR 38000: The exception &apos;java.sql.SQLException: The locator that was supplied for this CLOB/BLOB is invalid&apos; was thrown while evaluating an expression. &lt;br/&gt;
        at org.apache.derby.client.am.ClientStatement.completeExecute(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.net.NetStatementReply.parseEXCSQLSTTreply(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.net.NetStatementReply.readExecuteCall(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.net.StatementReply.readExecuteCall(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.net.NetStatement.readExecuteCall_(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.am.ClientStatement.readExecuteCall(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.am.ClientPreparedStatement.flowExecute(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.am.ClientPreparedStatement.executeX(Unknown Source) &lt;br/&gt;
        ... 5 more &lt;br/&gt;
Caused by: ERROR XJ217: The locator that was supplied for this CLOB/BLOB is invalid &lt;br/&gt;
        at org.apache.derby.client.am.SqlException.&amp;lt;init&amp;gt;(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.am.SqlException.&amp;lt;init&amp;gt;(Unknown Source) &lt;br/&gt;
        ... 13 more &lt;br/&gt;
&lt;br/&gt;
On a related note, when a result set contains a CLOB, when doing a rs.last()/rs.first(), and then calling rs.next(), we get a &quot;Container has been closed.&quot; SQL exception. &lt;br/&gt;
&lt;br/&gt;
Sample class: &lt;br/&gt;
---------------------------------------------------------------------------------------------- &lt;br/&gt;
import java.sql.Connection; &lt;br/&gt;
import java.sql.DriverManager; &lt;br/&gt;
import java.sql.ResultSet; &lt;br/&gt;
import java.sql.Statement; &lt;br/&gt;
&lt;br/&gt;
public class testZ { &lt;br/&gt;
        private static String dbURL = &quot;jdbc:derby://9.42.11.34:1088/TestDB;create=true;user=test;password=derbypass&quot;;     &lt;br/&gt;
        &lt;br/&gt;
        public static void main(String[] args) { &lt;br/&gt;
                try { &lt;br/&gt;
                        Class.forName(&quot;org.apache.derby.jdbc.ClientDriver&quot;).newInstance(); &lt;br/&gt;
                        Connection conn = DriverManager.getConnection(dbURL); &lt;br/&gt;
                        &lt;br/&gt;
                        Statement stmt = conn.createStatement(ResultSet.TYPE_SCROLL_SENSITIVE, ResultSet.CONCUR_READ_ONLY); &lt;br/&gt;
                        //GROUPASC is column with CLOBS &lt;br/&gt;
                        ResultSet rs = stmt.executeQuery(&quot;select GROUPASC from RE_EVENTGROUPASC where EVENTID=5 OR EVENTID=6&quot;); &lt;br/&gt;
                        //ResultSet rs = stmt.executeQuery(&quot;select EVENTID from RELATEDEVENTS.RE_EVENTGROUPASC where EVENTID=29419 OR EVENTID=29420&quot;); &lt;br/&gt;
                        &lt;br/&gt;
                        rs.last(); &lt;br/&gt;
                        rs.first();	&lt;br/&gt;
                        &lt;br/&gt;
                        if (!rs.next()) { 
                        //exception here	
                        } &lt;br/&gt;
                        &lt;br/&gt;
                        rs.close(); &lt;br/&gt;
                        stmt.close(); &lt;br/&gt;
                        conn.close(); &lt;br/&gt;
                } catch (Exception e) {                         e.printStackTrace();                 }
&lt;p&gt; &lt;br/&gt;
        } &lt;br/&gt;
} &lt;br/&gt;
---------------------------------------------------------------------------------------------- &lt;/p&gt;

&lt;p&gt;Note there are two queries (one is commented out). The GROUPASC is the column with the CLOB data type. When I call the second one (without the CLOB column), it works fine. Only happens with CLOBs! &lt;/p&gt;

&lt;p&gt;java.sql.SQLTransactionRollbackException: Container has been closed. &lt;br/&gt;
        at org.apache.derby.client.am.SQLExceptionFactory.getSQLException(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.am.SqlException.getSQLException(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.am.ClientResultSet.next(Unknown Source) &lt;br/&gt;
        at testZ.main(testZ.java:23) &lt;br/&gt;
Caused by: ERROR 40XD0: Container has been closed. &lt;br/&gt;
        at org.apache.derby.client.am.ClientResultSet.completeSqlca(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.net.NetResultSetReply.parseFetchError(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.net.NetResultSetReply.parseCNTQRYreply(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.net.NetResultSetReply.readScrollableFetch(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.net.ResultSetReply.readScrollableFetch(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.net.NetResultSet.readScrollableFetch_(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.am.ClientResultSet.flowGetRowset(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.am.ClientResultSet.getNextRowset(Unknown Source) &lt;br/&gt;
        at org.apache.derby.client.am.ClientResultSet.nextX(Unknown Source) &lt;br/&gt;
        ... 2 more &lt;/p&gt;


&lt;p&gt;See posting on derby user forums:&lt;br/&gt;
&lt;a href=&quot;http://apache-database.10148.n7.nabble.com/CLOB-data-errors-after-moving-cursor-around-td142101.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-database.10148.n7.nabble.com/CLOB-data-errors-after-moving-cursor-around-td142101.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I tried searching the forums and the existing defects, and couldn&apos;t find this issue is already being tracked. Thanks!&lt;/p&gt;</description>
                <environment>Linux/x64</environment>
        <key id="12741501">DERBY-6737</key>
            <summary>CLOB retrieve exceptions after moving cursor around</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="knutanders">Knut Anders Hatlen</assignee>
                                    <reporter username="bfabec">Brian Fabec</reporter>
                        <labels>
                    </labels>
                <created>Mon, 15 Sep 2014 14:57:51 +0000</created>
                <updated>Fri, 9 Sep 2016 09:51:14 +0000</updated>
                            <resolved>Thu, 18 Sep 2014 07:36:42 +0000</resolved>
                                    <version>10.8.2.2</version>
                    <version>10.11.1.1</version>
                                    <fixVersion>10.11.1.3</fixVersion>
                    <fixVersion>10.12.1.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14134001" author="knutanders" created="Mon, 15 Sep 2014 15:23:47 +0000"  >&lt;p&gt;Attached is a standalone test case that reproduces the bug.&lt;/p&gt;

&lt;p&gt;Some things to notice:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;it only reproduces with the client driver, not with the embedded driver&lt;/li&gt;
	&lt;li&gt;it only reproduces if the SELECT statement returns a single row, not if it returns multiple rows&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14135468" author="knutanders" created="Tue, 16 Sep 2014 14:00:40 +0000"  >&lt;p&gt;Since the select statement in the repro returns a single row, ResultSet.last() and ResultSet.first() moves the position to the same row. When calling first(), the client driver will first release all unpublished locators on the row that it moves from. Later, it sees that it already has fetched the row that it&apos;s moving to (since it&apos;s the same row as the one it&apos;s moving from), and skips fetching it from the server. This is ok for non-LOB values, but it causes problems with LOBs because a released locator cannot be reused. I think the fix is to make the result set positioning methods always fetch the row from the server if the result contains a LOB.&lt;/p&gt;</comment>
                            <comment id="14136962" author="knutanders" created="Wed, 17 Sep 2014 08:49:26 +0000"  >&lt;p&gt;The attached patch (&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12669369/12669369_d6737-1a.diff&quot; title=&quot;d6737-1a.diff attached to DERBY-6737&quot;&gt;d6737-1a.diff&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;) makes scrollable result sets always re-fetch the row from the server when moving the position, if it has LOB columns. It also adds a test case that verifies that it fixes the bug.&lt;/p&gt;

&lt;p&gt;All regression tests ran cleanly with the patch.&lt;/p&gt;</comment>
                            <comment id="14138644" author="jira-bot" created="Thu, 18 Sep 2014 07:36:11 +0000"  >&lt;p&gt;Commit 1625904 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;knutanders&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1625904&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1625904&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6737&quot; title=&quot;CLOB retrieve exceptions after moving cursor around&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6737&quot;&gt;&lt;del&gt;DERBY-6737&lt;/del&gt;&lt;/a&gt;: CLOB retrieve exceptions after moving cursor around&lt;/p&gt;

&lt;p&gt;Always fetch the row again from the server when moving the position of&lt;br/&gt;
a scrollable result set that contains LOB columns.&lt;/p&gt;

&lt;p&gt;Without this fix, if one of the absolute positioning methods is used&lt;br/&gt;
(first(), last() or absolute(int)), and the old position is the same&lt;br/&gt;
as the new position, the result set will use the values it already has&lt;br/&gt;
for the row on that position. Any locators will have been released,&lt;br/&gt;
though, so accessing LOBs in the row will fail with &apos;invalid locator&apos;.&lt;/p&gt;

&lt;p&gt;By fetching the row again from the server, we get a fresh and valid&lt;br/&gt;
locator for the LOB columns in that row.&lt;/p&gt;</comment>
                            <comment id="14144545" author="jira-bot" created="Tue, 23 Sep 2014 08:28:50 +0000"  >&lt;p&gt;Commit 1626964 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=knutanders&quot; class=&quot;user-hover&quot; rel=&quot;knutanders&quot;&gt;knutanders&lt;/a&gt; in branch &apos;code/branches/10.11&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1626964&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1626964&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6737&quot; title=&quot;CLOB retrieve exceptions after moving cursor around&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6737&quot;&gt;&lt;del&gt;DERBY-6737&lt;/del&gt;&lt;/a&gt;: CLOB retrieve exceptions after moving cursor around&lt;/p&gt;

&lt;p&gt;Merged revision 1625904 from trunk.&lt;/p&gt;</comment>
                            <comment id="15476508" author="knutanders" created="Fri, 9 Sep 2016 09:51:14 +0000"  >&lt;p&gt;[ Automatically closing all resolved issues that haven&apos;t been updated in more than six months. ]&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12668778" name="Derby6737.java" size="1168" author="knutanders" created="Mon, 15 Sep 2014 15:23:47 +0000"/>
                            <attachment id="12669369" name="d6737-1a.diff" size="5725" author="knutanders" created="Wed, 17 Sep 2014 08:49:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 10 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i201u7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10051"><![CDATA[Urgent]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>