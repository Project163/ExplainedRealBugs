<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 14:51:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DERBY-6934] Lock conflicts between Statement.getGeneratedKeys() and sequence-generator-based identity columns</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6934</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Lock conflicts between Statement.getGeneratedKeys() and sequence-generator-based identity columns&lt;/p&gt;

&lt;p&gt;Statement.getGeneratedKeys() is implemented on top of IDENTITY_VAL_LOCAL(), which does not play well with sequence generators. This is a problem for applications built on top of Hibernate. That is because Hibernate calls Statement.getGeneratedKeys() after inserting into a table with an identity-generator. This issue was raised on the following email thread: &lt;a href=&quot;http://apache-database.10148.n7.nabble.com/Identity-column-and-40XL1-error-td147382.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-database.10148.n7.nabble.com/Identity-column-and-40XL1-error-td147382.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To see the lock contention, put IVL and derby.jar on the classpath and run the program like this:&lt;/p&gt;

&lt;p&gt;  java IVL 10 100&lt;/p&gt;

&lt;p&gt;That will start up 10 threads, each inserting 100 times into a table with an identity column and then calling Statement.getGeneratedKeys(). Here is sample output from that experiment:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Running experiment with 10 threads and 100 inserts per thread.
Preparing &apos;create table t
(
	keyCol bigint generated always as identity,
	threadIDCol varchar(50),
	counterCol int
)&apos;...
Starting thread0
Starting thread1
Starting thread2
Starting thread3
Starting thread4
Starting thread5
Starting thread6
Starting thread7
Starting thread8
Starting thread9
thread9 caught exception A lock could not be obtained within the time requested
thread5 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread0 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread6 caught exception A lock could not be obtained within the time requested
thread1 caught exception A lock could not be obtained within the time requested
thread7 caught exception A lock could not be obtained within the time requested
thread5 caught exception A lock could not be obtained within the time requested
thread8 caught exception A lock could not be obtained within the time requested
thread9 caught exception A lock could not be obtained within the time requested
thread6 caught exception A lock could not be obtained within the time requested
thread1 caught exception A lock could not be obtained within the time requested
thread2 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread5 caught exception A lock could not be obtained within the time requested
thread1 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread5 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread1 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread6 caught exception A lock could not be obtained within the time requested
thread2 caught exception A lock could not be obtained within the time requested
thread0 caught exception A lock could not be obtained within the time requested
thread9 caught exception A lock could not be obtained within the time requested
thread7 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread9 caught exception A lock could not be obtained within the time requested
thread6 caught exception A lock could not be obtained within the time requested
thread1 caught exception A lock could not be obtained within the time requested
thread0 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread9 caught exception A lock could not be obtained within the time requested
thread2 caught exception A lock could not be obtained within the time requested
thread7 caught exception A lock could not be obtained within the time requested
thread5 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread8 caught exception A lock could not be obtained within the time requested
thread0 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread7 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread9 caught exception A lock could not be obtained within the time requested
thread2 caught exception A lock could not be obtained within the time requested
thread1 caught exception A lock could not be obtained within the time requested
thread6 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread6 caught exception A lock could not be obtained within the time requested
thread5 caught exception A lock could not be obtained within the time requested
thread0 caught exception A lock could not be obtained within the time requested
thread9 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread1 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread6 caught exception A lock could not be obtained within the time requested
thread0 caught exception A lock could not be obtained within the time requested
thread1 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread7 caught exception A lock could not be obtained within the time requested
thread2 caught exception A lock could not be obtained within the time requested
thread9 caught exception A lock could not be obtained within the time requested
thread8 caught exception A lock could not be obtained within the time requested
thread5 caught exception A lock could not be obtained within the time requested
thread1 caught exception A lock could not be obtained within the time requested
thread0 caught exception A lock could not be obtained within the time requested
thread6 caught exception A lock could not be obtained within the time requested
thread5 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread8 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread1 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread2 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread9 caught exception A lock could not be obtained within the time requested
thread6 caught exception A lock could not be obtained within the time requested
thread7 caught exception A lock could not be obtained within the time requested
thread2 caught exception A lock could not be obtained within the time requested
thread8 caught exception A lock could not be obtained within the time requested
thread0 caught exception A lock could not be obtained within the time requested
thread5 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread9 caught exception A lock could not be obtained within the time requested
thread7 caught exception A lock could not be obtained within the time requested
thread6 caught exception A lock could not be obtained within the time requested
thread0 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread5 caught exception A lock could not be obtained within the time requested
thread6 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread2 caught exception A lock could not be obtained within the time requested
thread9 caught exception A lock could not be obtained within the time requested
thread7 caught exception A lock could not be obtained within the time requested
thread1 caught exception A lock could not be obtained within the time requested
thread5 caught exception A lock could not be obtained within the time requested
thread0 caught exception A lock could not be obtained within the time requested
thread8 caught exception A lock could not be obtained within the time requested
thread0 caught exception A lock could not be obtained within the time requested
thread1 caught exception A lock could not be obtained within the time requested
thread9 caught exception A lock could not be obtained within the time requested
thread2 caught exception A lock could not be obtained within the time requested
thread7 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread6 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread0 caught exception A lock could not be obtained within the time requested
thread5 caught exception A lock could not be obtained within the time requested
thread1 caught exception A lock could not be obtained within the time requested
thread7 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread6 caught exception A lock could not be obtained within the time requested
thread9 caught exception A lock could not be obtained within the time requested
thread0 caught exception A lock could not be obtained within the time requested
thread7 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread2 caught exception A lock could not be obtained within the time requested
thread8 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread7 caught exception A lock could not be obtained within the time requested
thread0 caught exception A lock could not be obtained within the time requested
thread1 caught exception A lock could not be obtained within the time requested
thread6 caught exception A lock could not be obtained within the time requested
thread9 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread9 caught exception A lock could not be obtained within the time requested
thread5 caught exception A lock could not be obtained within the time requested
thread9 caught exception A lock could not be obtained within the time requested
thread5 caught exception A lock could not be obtained within the time requested
thread5&apos;s last good key was 797
thread8 caught exception A lock could not be obtained within the time requested
thread4 caught exception A lock could not be obtained within the time requested
thread6 caught exception A lock could not be obtained within the time requested
thread8 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread1 caught exception A lock could not be obtained within the time requested
thread0 caught exception A lock could not be obtained within the time requested
thread6 caught exception A lock could not be obtained within the time requested
thread8 caught exception A lock could not be obtained within the time requested
thread1 caught exception A lock could not be obtained within the time requested
thread3 caught exception A lock could not be obtained within the time requested
thread2 caught exception A lock could not be obtained within the time requested
thread9 caught exception A lock could not be obtained within the time requested
thread6 caught exception A lock could not be obtained within the time requested
thread8 caught exception A lock could not be obtained within the time requested
thread1&apos;s last good key was 813
thread0 caught exception A lock could not be obtained within the time requested
thread3&apos;s last good key was 826
thread4&apos;s last good key was 830
thread0&apos;s last good key was 838
thread9&apos;s last good key was 840
thread2&apos;s last good key was 842
thread8&apos;s last good key was 843
thread7&apos;s last good key was 846
thread6&apos;s last good key was 849
Done!
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13073651">DERBY-6934</key>
            <summary>Lock conflicts between Statement.getGeneratedKeys() and sequence-generator-based identity columns</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rhillegas">Richard N. Hillegas</reporter>
                        <labels>
                    </labels>
                <created>Sat, 20 May 2017 17:28:20 +0000</created>
                <updated>Wed, 4 Jul 2018 22:01:58 +0000</updated>
                                            <version>10.13.1.1</version>
                                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16018858" author="rhillegas" created="Sun, 21 May 2017 15:07:20 +0000"  >&lt;p&gt;The lock contention disappears if you set the pre-allocation range to the maximum possble value:&lt;/p&gt;

&lt;p&gt;  -Dderby.language.sequence.preallocator=2147483647&lt;/p&gt;

&lt;p&gt;This is a workaround for in-memory databases.&lt;/p&gt;</comment>
                            <comment id="16018924" author="rhillegas" created="Sun, 21 May 2017 18:04:32 +0000"  >&lt;p&gt;In addition to its concurrency problems, Statement.getGeneratedKeys() returns the wrong result. This is because it is implemented on top of the limited functionality of IDENTITY_VAL_LOCAL(). IDENTITY_VAL_LOCAL() retrieves the last identity value generated for a single row INSERT issued by the session. It could return an identity value generated for another table. It ignores multi-row INSERTs.&lt;/p&gt;

&lt;p&gt;In contrast, Statement.getGeneratedKeys() is supposed to return a ResultSet of the identity values generated by the current statement. So, there should be multiple key values for a multi-row INSERT.&lt;/p&gt;

&lt;p&gt;Attaching Derby_6934.java, a program which demonstrates this defect. Here is the program&apos;s output:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Preparing &apos;create table t
(
	keyCol bigint generated always as identity,
	counterCol int
)&apos;...
&apos;insert into t(counterCol) values (100)&apos; produced these keys: [[1]] vs. expected result: [[1]]
&apos;insert into t(counterCol) values (200), (201)&apos; produced these keys: [[1]] vs. expected result: [[2],[3]]
&apos;insert into t(counterCol) values (300), (301), (302)&apos; produced these keys: [[1]] vs. expected result: [[4],[5],[6]]
&apos;insert into t(counterCol) values (400)&apos; produced these keys: [[7]] vs. expected result: [[7]]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16018947" author="bryanpendleton" created="Sun, 21 May 2017 18:41:55 +0000"  >&lt;p&gt;Hi Rick,&lt;/p&gt;

&lt;p&gt;Some of the issues you&apos;re exploring with Statement.getGeneratedKeys seem very similar to the discussions we had in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6849&quot; title=&quot;Statement.RETURN_GENERATED_KEYS returns a 1 row result set even if there are no auto-generated fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6849&quot;&gt;DERBY-6849&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-3609&quot; title=&quot;Wrong functionality of auto-generated keys support&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-3609&quot;&gt;DERBY-3609&lt;/a&gt;. It might be worth looking back over those notes as part of the exercise you&apos;re engaged in now?&lt;/p&gt;</comment>
                            <comment id="16020443" author="rhillegas" created="Tue, 23 May 2017 00:13:00 +0000"  >&lt;p&gt;Thanks for those pointers, Bryan. I will take a look at Knut&apos;s candidate patch for derby-3609. I agree with you that some sort of system table function, wrapped around that code, would be an adequate solution for the client driver.&lt;/p&gt;</comment>
                            <comment id="16421754" author="jira-bot" created="Sun, 1 Apr 2018 17:35:41 +0000"  >&lt;p&gt;Commit 1828145 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhillegas&quot; class=&quot;user-hover&quot; rel=&quot;rhillegas&quot;&gt;rhillegas&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1828145&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1828145&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6934&quot; title=&quot;Lock conflicts between Statement.getGeneratedKeys() and sequence-generator-based identity columns&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6934&quot;&gt;DERBY-6934&lt;/a&gt;: Add module descriptors to product jars; commit derby-6945-25-ab-moduleDescriptors.diff.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12393506">DERBY-3609</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12925139">DERBY-6849</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13113208">DERBY-6975</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13170141">DERBY-7002</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12869179" name="Derby_6934.java" size="2513" author="rhillegas" created="Sun, 21 May 2017 18:07:10 +0000"/>
                            <attachment id="12869131" name="IVL.java" size="3785" author="rhillegas" created="Sat, 20 May 2017 17:29:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10421"><![CDATA[Seen in production]]></customfieldvalue>
    <customfieldvalue key="10366"><![CDATA[Wrong query result]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10424"><![CDATA[Repro attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 33 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3f9dr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310050" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Urgency</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10052"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            </customfields>
    </item>
</channel>
</rss>