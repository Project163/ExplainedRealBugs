<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 14:51:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DERBY-6902] Value out of range error (22003) on DELETE with expression in WHERE clause</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6902</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I&apos;ve ran into the problem from the subject, which appears to be a bug, using the latest 10.12.1.1 release.&lt;/p&gt;

&lt;p&gt;Given the table:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;table&lt;/span&gt; test (
  id &lt;span class=&quot;code-keyword&quot;&gt;bigint&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;primary&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;key&lt;/span&gt;,
  big_number &lt;span class=&quot;code-keyword&quot;&gt;bigint&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,
  small_number &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The following DELETE statement will fail with &lt;em&gt;The resulting value is outside the range for the data type INTEGER&lt;/em&gt; (22003):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;delete&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; test
&lt;span class=&quot;code-keyword&quot;&gt;where&lt;/span&gt; big_number &amp;lt; ? - small_number * 1000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.sql.SQLDataException: The resulting value is outside the range &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the data type INTEGER.
    at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(Unknown Source)
    at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Unknown Source)
    at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(Unknown Source)
    at org.apache.derby.impl.jdbc.EmbedResultSet.noStateChangeException(Unknown Source)
    at org.apache.derby.impl.jdbc.EmbedPreparedStatement.setLong(Unknown Source)
    at sample.PlainJdbcTest.delete(PlainJdbcTest.java:36)
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.lang.reflect.Method.invoke(Method.java:498)
    at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)
    at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
    at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)
    at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
    at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
    at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
    at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)
    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)
    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)
    at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
    at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
    at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
    at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
    at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
    at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
    at org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecuter.runTestClass(JUnitTestClassExecuter.java:114)
    at org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecuter.execute(JUnitTestClassExecuter.java:57)
    at org.gradle.api.internal.tasks.testing.junit.JUnitTestClassProcessor.processTestClass(JUnitTestClassProcessor.java:66)
    at org.gradle.api.internal.tasks.testing.SuiteTestClassProcessor.processTestClass(SuiteTestClassProcessor.java:51)
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.lang.reflect.Method.invoke(Method.java:498)
    at org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:35)
    at org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:24)
    at org.gradle.internal.dispatch.ContextClassLoaderDispatch.dispatch(ContextClassLoaderDispatch.java:32)
    at org.gradle.internal.dispatch.ProxyDispatchAdapter$DispatchingInvocationHandler.invoke(ProxyDispatchAdapter.java:93)
    at com.sun.proxy.$Proxy2.processTestClass(Unknown Source)
    at org.gradle.api.internal.tasks.testing.worker.TestWorker.processTestClass(TestWorker.java:109)
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.lang.reflect.Method.invoke(Method.java:498)
    at org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:35)
    at org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:24)
    at org.gradle.internal.remote.internal.hub.MessageHub$Handler.run(MessageHub.java:377)
    at org.gradle.internal.concurrent.ExecutorPolicy$CatchAndRecordFailures.onExecute(ExecutorPolicy.java:54)
    at org.gradle.internal.concurrent.StoppableExecutorImpl$1.run(StoppableExecutorImpl.java:40)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: ERROR 22003: The resulting value is outside the range &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the data type INTEGER.
    at org.apache.derby.iapi.error.StandardException.newException(Unknown Source)
    at org.apache.derby.iapi.error.StandardException.newException(Unknown Source)
    at org.apache.derby.iapi.types.DataType.outOfRange(Unknown Source)
    at org.apache.derby.iapi.types.SQLInteger.setValue(Unknown Source)
    ... 47 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Minimal project to reproduce the error is available here:&lt;br/&gt;
&lt;a href=&quot;https://github.com/vpavic-samples/derby-delete-error-22003&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/vpavic-samples/derby-delete-error-22003&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Vedran&lt;/p&gt;</description>
                <environment></environment>
        <key id="12994890">DERBY-6902</key>
            <summary>Value out of range error (22003) on DELETE with expression in WHERE clause</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="KasuniHemasika">Kasuni Hemasika</assignee>
                                    <reporter username="vpavic">Vedran Pavic</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Aug 2016 13:03:50 +0000</created>
                <updated>Wed, 27 Sep 2017 22:37:15 +0000</updated>
                                            <version>10.12.1.1</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15408711" author="rhillegas" created="Fri, 5 Aug 2016 00:50:10 +0000"  >&lt;p&gt;Thanks for filing this issue, Vedran. Can you supply the values which you used to populate the table and set the ? parameter of the delete statement? Thanks.&lt;/p&gt;</comment>
                            <comment id="15408767" author="bryanpendleton" created="Fri, 5 Aug 2016 02:02:02 +0000"  >&lt;p&gt;Based on the code in the description section, I reproduced the&lt;br/&gt;
problem with the attached &quot;repro.java&quot;.&lt;/p&gt;

&lt;p&gt;When I run this program with the current Derby trunk, and with&lt;br/&gt;
the following &apos;println&apos; statement inserted into the out-of-range&lt;br/&gt;
throw statement in SQLInteger.setValue(), I get the exception output&lt;br/&gt;
that I&apos;ve pasted below.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setValue(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; theValue) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; StandardException
        {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (theValue &amp;gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE || theValue &amp;lt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MIN_VALUE) {
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Value &quot;&lt;/span&gt; + theValue + &lt;span class=&quot;code-quote&quot;&gt;&quot; is either &amp;gt; &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE + &lt;span class=&quot;code-quote&quot;&gt;&quot;or &amp;lt; &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MIN_VALUE);
                        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; outOfRange();
                }

                value = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)theValue;
                isnull = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
&lt;p&gt;C:\Users\Bryan\derby\issues\&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6902&quot; title=&quot;Value out of range error (22003) on DELETE with expression in WHERE clause&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6902&quot;&gt;DERBY-6902&lt;/a&gt;&amp;gt;java -cp .;c:\Users\Bryan\derby\trunk\classes repro&lt;br/&gt;
Value 1470362049757 is either &amp;gt; 2147483647or &amp;lt; -2147483648&lt;br/&gt;
java.sql.SQLDataException: The resulting value is outside the range for the data type INTEGER.&lt;br/&gt;
        at org.apache.derby.impl.jdbc.SQLExceptionFactory.getSQLException(SQLExceptionFactory.java:84)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Util.java:230)&lt;/p&gt;

&lt;p&gt;        at org.apache.derby.impl.jdbc.TransactionResourceImpl.wrapInSQLException(TransactionResourceImpl.java:424)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedResultSet.noStateChangeException(EmbedResultSet.java:4728)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.setLong(EmbedPreparedStatement.java:453)&lt;br/&gt;
        at repro.main(repro.java:30)&lt;br/&gt;
Caused by: ERROR 22003: The resulting value is outside the range for the data type INTEGER.&lt;br/&gt;
        at org.apache.derby.iapi.error.StandardException.newException(StandardException.java:290)&lt;br/&gt;
        at org.apache.derby.iapi.error.StandardException.newException(StandardException.java:285)&lt;br/&gt;
        at org.apache.derby.iapi.types.DataType.outOfRange(DataType.java:1271)&lt;br/&gt;
        at org.apache.derby.iapi.types.SQLInteger.setValue(SQLInteger.java:329)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.setLong(EmbedPreparedStatement.java:450)&lt;br/&gt;
        ... 1 more&lt;br/&gt;
SQLState:22003&lt;br/&gt;
Error Code:20000&lt;br/&gt;
Message:The resulting value is outside the range for the data type INTEGER.&lt;br/&gt;
Cause:ERROR 22003: The resulting value is outside the range for the data type INTEGER.&lt;br/&gt;
ERROR 22003: The resulting value is outside the range for the data type INTEGER.&lt;/p&gt;

&lt;p&gt;        at org.apache.derby.iapi.error.StandardException.newException(StandardException.java:290)&lt;br/&gt;
        at org.apache.derby.iapi.error.StandardException.newException(StandardException.java:285)&lt;br/&gt;
        at org.apache.derby.iapi.types.DataType.outOfRange(DataType.java:1271)&lt;br/&gt;
        at org.apache.derby.iapi.types.SQLInteger.setValue(SQLInteger.java:329)&lt;br/&gt;
        at org.apache.derby.impl.jdbc.EmbedPreparedStatement.setLong(EmbedPreparedStatement.java:450)&lt;br/&gt;
        at repro.main(repro.java:30)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I guess the part I don&apos;t totally understand is:&lt;/p&gt;

&lt;p&gt;The program does &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                PreparedStatement delete = conn.prepareStatement(
                                &lt;span class=&quot;code-quote&quot;&gt;&quot;delete from test &quot;&lt;/span&gt; +
                                &lt;span class=&quot;code-quote&quot;&gt;&quot;where big_number &amp;lt; ? - small_number * 1000&quot;&lt;/span&gt;);
                delete.setLong(1, &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Evidently the SQL compiler has decided that the &apos;?&apos; substitution parameter&lt;br/&gt;
should be a INTEGER type, but the user expects it to be a BIGINT, I think.&lt;/p&gt;</comment>
                            <comment id="15409077" author="vpavic" created="Fri, 5 Aug 2016 07:40:56 +0000"  >&lt;p&gt;Thank for the feedback.&lt;/p&gt;

&lt;p&gt;Rick - I did not need to populate the table with data, since it behaves the same regardless of whether there are any records or not (one part of the original comment suggested otherwise, sorry for that, I&apos;ve updated it). The parameter is &lt;tt&gt;System.currentTimeMillis()&lt;/tt&gt;, as show in sample project on Github.&lt;/p&gt;

&lt;p&gt;Bryan - yes, it should be BIGINT, as indicated by &lt;tt&gt;PreparedStatement#setLong&lt;/tt&gt; and the fact that left hand side of the expression is a BIGINT.&lt;/p&gt;

&lt;p&gt;To give more background, we need this statement in a library that supports multiple RDBMSs so we need to use standard SQL and have found this issue with Derby and H2. PostgreSQL, Oracle, MySQL/MariaDB and HSQLDB handle it without any problems.&lt;/p&gt;</comment>
                            <comment id="15660446" author="bryanpendleton" created="Sat, 12 Nov 2016 23:11:40 +0000"  >&lt;p&gt;I&apos;ve been spending some time thinking about the statement:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;delete from test where big_number &amp;lt; ? - small_number * 1000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When you look at this as an abstract parse tree, you have something like the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                                    &amp;lt;
      big_number                               expression
          
                                                       ?    -     expression

                                                            small_number * 1000 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That is, at the time that we are contemplating how to handle &lt;br/&gt;
the parameter marker &quot;?&quot;, what we know from the parse tree &lt;br/&gt;
is that it is the left-hand side of a binary arithmetic operator ( ?  - &quot;expression&quot; )&lt;/p&gt;

&lt;p&gt;And, we know that the right-hand side of that operator is an &lt;br/&gt;
expression ( small_number * 1000 ), which has the type &apos;integer&apos;.&lt;/p&gt;

&lt;p&gt;Although, higher up the tree, the results of our expression will be&lt;br/&gt;
compared  ( big_number &amp;lt; expression ) to a BIGINT is not visible&lt;br/&gt;
to us, in the parse tree, because we are a *&lt;b&gt;sub-expression&lt;/b&gt;* of the&lt;br/&gt;
higher-level expression.&lt;/p&gt;

&lt;p&gt;So treating the parameter marker as INTEGER, rather than BIGINT,&lt;br/&gt;
actually seems correct to me, upon this further reflection.&lt;/p&gt;

&lt;p&gt;Two other points:&lt;/p&gt;

&lt;p&gt;First, here is the code tree which performs this type analysis, for&lt;br/&gt;
others to consider:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Chose type=INTEGER NOT NULL&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.ParameterNode.setType(ParameterNode.java:156)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.BinaryOperatorNode.bindExpression(BinaryOperatorNode.java:307)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.BinaryArithmeticOperatorNode.bindExpression(BinaryArithmeticOperatorNode.java:132)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.BinaryOperatorNode.bindExpression(BinaryOperatorNode.java:286)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.BinaryComparisonOperatorNode.bindExpression(BinaryComparisonOperatorNode.java:142)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.SelectNode.bindExpressions(SelectNode.java:602)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.DMLStatementNode.bindExpressions(DMLStatementNode.java:209)&lt;br/&gt;
        at org.apache.derby.impl.sql.compile.DeleteNode.bindStatement(DeleteNode.java:297)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Secondly, if you change the critical statement from&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;delete from test where big_number &amp;lt; ? - small_number * 1000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;delete from test where big_number &amp;lt; ? - &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;( small_number as bigint) * 1000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;then all is well, because the BinaryOperatorNode which is processing the&lt;br/&gt;
subtraction operator sees a &quot;right-hand side&quot; of type BIGINT, and so it&lt;br/&gt;
marks the parameter marker as type BIGINT.&lt;/p&gt;

&lt;p&gt;tl;dr It isn&apos;t obvious to me that this is a bug in Derby; I would appreciate the&lt;br/&gt;
opinions of others about  how the SQL and JDBC specs describe the&lt;br/&gt;
type analysis that is to occur here.&lt;/p&gt;</comment>
                            <comment id="15662162" author="bryanpendleton" created="Sun, 13 Nov 2016 21:50:13 +0000"  >&lt;p&gt;I converted the repro.java script into a new test case in&lt;br/&gt;
the ParameterMappingTest suite. The only slightly&lt;br/&gt;
interesting part was that in the Embedded configuration,&lt;br/&gt;
the out-of-range exception occurs during the setLong()&lt;br/&gt;
call, while in the Client-Server configuration, it occurs&lt;br/&gt;
one step later, in the executeUpdate() call.&lt;/p&gt;</comment>
                            <comment id="15665846" author="rhillegas" created="Tue, 15 Nov 2016 02:55:57 +0000"  >&lt;p&gt;Hi Bryan,&lt;/p&gt;

&lt;p&gt;Numeric comparisons are described in the 2011 SQL Standard, part 2, section 8.2 (&amp;lt;comparison predicate&amp;gt;), General Rule 2: &quot;Numbers are compared with respect to their algebraic value.&quot; That says to me that numbers must ultimately be promoted to the biggest, most general numeric type on either side of the comparison operator, just as they are promoted in Java. I don&apos;t think that the JDBC spec provides any guidance here.&lt;/p&gt;

&lt;p&gt;The problem with this comparison is that ? is an untyped number. Is it an integer? Is it a large fixed numeric (decimal)? Is it a floating point number? Derby doesn&apos;t have enough information to promote the expressions. The following ought to work, though:&lt;/p&gt;

&lt;p&gt;  big_number &amp;lt; cast(? as bigint) - small_number * 1000&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="15665972" author="bryanpendleton" created="Tue, 15 Nov 2016 03:56:22 +0000"  >&lt;p&gt;Thanks Rick, that is quite helpful and clear.&lt;/p&gt;

&lt;p&gt;I had one variation on the CAST technique in my test already,&lt;br/&gt;
but I hadn&apos;t verified that casting the parameter marker itself&lt;br/&gt;
worked properly.&lt;/p&gt;

&lt;p&gt;Attached &apos;anotherTestCase.diff&apos; adds that test case, too, uneventfully.&lt;/p&gt;

&lt;p&gt;I think I&apos;m persuaded by the experiments that all is working as we&lt;br/&gt;
expect here. I intend to submit the new test case to ensure we have&lt;br/&gt;
that test coverage, and will then resolve this issue accordingly.&lt;/p&gt;</comment>
                            <comment id="15668936" author="jira-bot" created="Wed, 16 Nov 2016 01:07:31 +0000"  >&lt;p&gt;Commit 1769904 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bryanpendleton&quot; class=&quot;user-hover&quot; rel=&quot;bryanpendleton&quot;&gt;bryanpendleton&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1769904&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1769904&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6902&quot; title=&quot;Value out of range error (22003) on DELETE with expression in WHERE clause&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6902&quot;&gt;DERBY-6902&lt;/a&gt;: Value out of range error&lt;/p&gt;

&lt;p&gt;This change adds several new test cases to ParameterMappingTest, derived&lt;br/&gt;
from the original scenario described in the issue.&lt;/p&gt;

&lt;p&gt;These test cases are designed to demonstrate the particular exception&lt;br/&gt;
discussed in the issue, as well as to demonstrate several ways to use&lt;br/&gt;
a CAST operator so that the query executes as desired.&lt;/p&gt;</comment>
                            <comment id="15669728" author="vpavic" created="Wed, 16 Nov 2016 07:38:01 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I&apos;d just like the stress again &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6902?focusedCommentId=15409077&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15409077&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;the original background&lt;/a&gt; to this issue:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;To give more background, we need this statement in a library that supports multiple RDBMSs so we need to use standard SQL and have found this issue with Derby and H2. PostgreSQL, Oracle, MySQL/MariaDB and HSQLDB handle it without any problems.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Using &lt;tt&gt;CAST&lt;/tt&gt; will not result in a standard and portable SQL due to the fact that even though &lt;tt&gt;CAST&lt;/tt&gt; is standard, &lt;tt&gt;BIGINT&lt;/tt&gt; isn&apos;t.&lt;/p&gt;

&lt;p&gt;Also I&apos;m not sure I understand this claim:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The problem with this comparison is that ? is an untyped number. Is it an integer? Is it a large fixed numeric (decimal)? Is it a floating point number? Derby doesn&apos;t have enough information to promote the expressions.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;How&apos;s there not enough information when the parameter is clearly defined as &lt;tt&gt;long&lt;/tt&gt;, which translates to &lt;tt&gt;BIGINT&lt;/tt&gt;?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;delete.setLong(1, &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="15672359" author="rhillegas" created="Thu, 17 Nov 2016 01:36:25 +0000"  >&lt;p&gt;Hi Vedran,&lt;/p&gt;

&lt;p&gt;BIGINT is a Standard datatype. See the list of Standard datatypes in the 2011 Standard, part 2, section 4.4.1 (Introduction to Number): NUMERIC, DECIMAL, SMALLINT, INTEGER, BIGINT, FLOAT, REAL, or DOUBLE PRECISION.&lt;/p&gt;

&lt;p&gt;My guess is that the compiler (during Connection.prepareStatement()) guessed a datatype for the ? (the guessed datatype was INTEGER). That decision was already baked in by the time that you called PreparedStatement.setLong().&lt;/p&gt;

&lt;p&gt;If your application has to run against a database which doesn&apos;t support BIGINT, then you might consider CASTing the ? to INTEGER and invoking delete.setInt().&lt;/p&gt;

&lt;p&gt;Hope this helps,&lt;br/&gt;
-Rick&lt;/p&gt;</comment>
                            <comment id="15672524" author="bryanpendleton" created="Thu, 17 Nov 2016 03:06:58 +0000"  >&lt;p&gt;This discussion has inspired more test cases of interest to me,&lt;br/&gt;
so I attached them as &apos;moreTestCases.diff&apos;. The new test cases&lt;br/&gt;
did not reveal any behaviors that I felt were incorrect, but others&lt;br/&gt;
may find them interesting to contemplate.&lt;/p&gt;

&lt;p&gt;In addition to Rick&apos;s suggestions, I wanted to suggest an&lt;br/&gt;
algebraic re-formulation of the original query:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;delete from test6902 where big_number + small_number * 1000 &amp;lt; ?
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this case, the normal operator precedence arranges for the&lt;br/&gt;
parameter to be clearly recognized as a BIGINT, without any&lt;br/&gt;
CAST operator needed. At least, that&apos;s how it seems to me.&lt;/p&gt;</comment>
                            <comment id="15678345" author="jira-bot" created="Sat, 19 Nov 2016 01:43:10 +0000"  >&lt;p&gt;Commit 1770458 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bryanpendleton&quot; class=&quot;user-hover&quot; rel=&quot;bryanpendleton&quot;&gt;bryanpendleton&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1770458&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1770458&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6902&quot; title=&quot;Value out of range error (22003) on DELETE with expression in WHERE clause&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6902&quot;&gt;DERBY-6902&lt;/a&gt;: Value out of range error&lt;/p&gt;

&lt;p&gt;This change adds still more new test cases to ParameterMappingTest, derived&lt;br/&gt;
from the original scenario described in the issue.&lt;/p&gt;

&lt;p&gt;The new test cases explore some datatype conversions from string-to-integer.&lt;/p&gt;

&lt;p&gt;They also look at some other variations on the original query from the&lt;br/&gt;
issue, demonstrating that the details of the phrasing of the query affect&lt;br/&gt;
the query compiler&apos;s decisions about intermediate data types.&lt;/p&gt;</comment>
                            <comment id="15714388" author="vpavic" created="Fri, 2 Dec 2016 08:01:08 +0000"  >&lt;p&gt;Hi Rick,&lt;/p&gt;

&lt;p&gt;Thanks for the feedback - I stand corrected on the &lt;tt&gt;BIGINT&lt;/tt&gt; and standard, I must&apos;ve been referring to older version of the standard when I researched since I clearly remember using a SQL validator which complained about &lt;tt&gt;BIGINT&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Bryan, thanks for the suggestion. Reformulation of the statement is something I&apos;ve been considering as well however I&apos;m hesitant to do so since the original statement is perfectly valid and from the client perspective it expresses the best what the statement actually does. The fact is still that of all the RDBMS vendors I&apos;ve thrown this at only Derby and H2 are unable to execute it which suggests the two are exceptions to the rule.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="16182099" author="kasunihemasika" created="Wed, 27 Sep 2017 06:53:02 +0000"  >&lt;p&gt;Hi all,&lt;/p&gt;

&lt;p&gt;So what is the best option you are suggesting? To fix the bug or to cast the statement?&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="16183379" author="rhillegas" created="Wed, 27 Sep 2017 22:37:15 +0000"  >&lt;p&gt;Derby doesn&apos;t have enough information to promote the expression. CASTing is an adequate workaround in my opinion.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12838915" name="anotherTestCast.diff" size="1987" author="bryanpendleton" created="Tue, 15 Nov 2016 03:56:22 +0000"/>
                            <attachment id="12839298" name="moreTestCases.diff" size="2386" author="bryanpendleton" created="Thu, 17 Nov 2016 03:06:58 +0000"/>
                            <attachment id="12838692" name="newTestCase.diff" size="1559" author="bryanpendleton" created="Sun, 13 Nov 2016 21:50:13 +0000"/>
                            <attachment id="12822222" name="repro.java" size="1424" author="bryanpendleton" created="Fri, 5 Aug 2016 02:02:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 7 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i31wo7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>