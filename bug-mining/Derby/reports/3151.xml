<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 14:51:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DERBY-6879] Engine deadlock between XA timeout handling and cleanupOnError</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6879</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Deadlock between XA timer cleanup task and the ContextManager.cleanupOnError&lt;/p&gt;

&lt;p&gt;Found one Java-level deadlock:&lt;br/&gt;
=============================&lt;br/&gt;
&quot;DRDAConnThread_34&quot;:&lt;br/&gt;
  waiting to lock monitor 0x0000000104b14d18 (object 0xfffffffd9090f058, a org.apache.derby.jdbc.XATransactionState),&lt;br/&gt;
  which is held by &quot;Timer-0&quot;&lt;br/&gt;
&quot;Timer-0&quot;:&lt;br/&gt;
  waiting to lock monitor 0x00000001038b96e8 (object 0xfffffffd9090d8b0, a org.apache.derby.impl.jdbc.EmbedConnection40),&lt;br/&gt;
  which is held by &quot;DRDAConnThread_34&quot;&lt;/p&gt;

&lt;p&gt;Java stack information for the threads listed above:&lt;br/&gt;
===================================================&lt;br/&gt;
&quot;DRDAConnThread_34&quot;:&lt;br/&gt;
     at org.apache.derby.jdbc.XATransactionState.cleanupOnError(Unknown Source)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0xfffffffd9090f058&amp;gt; (a org.apache.derby.jdbc.XATransactionState)&lt;br/&gt;
     at org.apache.derby.iapi.services.context.ContextManager.cleanupOnError(Unknown Source)&lt;br/&gt;
     at org.apache.derby.impl.jdbc.TransactionResourceImpl.cleanupOnError(Unknown Source)&lt;br/&gt;
     at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(Unknown Source)&lt;br/&gt;
     at org.apache.derby.impl.jdbc.EmbedConnection.handleException(Unknown Source)&lt;br/&gt;
     at org.apache.derby.impl.jdbc.ConnectionChild.handleException(Unknown Source)&lt;br/&gt;
     at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0xfffffffd9090d8b0&amp;gt; (a org.apache.derby.impl.jdbc.EmbedConnection40)&lt;br/&gt;
     at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(Unknown Source)&lt;br/&gt;
     at org.apache.derby.impl.jdbc.EmbedPreparedStatement.execute(Unknown Source)&lt;br/&gt;
     at org.apache.derby.iapi.jdbc.BrokeredPreparedStatement.execute(Unknown Source)&lt;br/&gt;
     at org.apache.derby.impl.drda.DRDAStatement.execute(Unknown Source)&lt;br/&gt;
     at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTTobjects(Unknown Source)&lt;br/&gt;
     at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLSTT(Unknown Source)&lt;br/&gt;
     at org.apache.derby.impl.drda.DRDAConnThread.processCommands(Unknown Source)&lt;br/&gt;
     at org.apache.derby.impl.drda.DRDAConnThread.run(Unknown Source)&lt;br/&gt;
&quot;Timer-0&quot;:&lt;br/&gt;
     at org.apache.derby.impl.jdbc.EmbedConnection.xa_rollback(Unknown Source)&lt;/li&gt;
	&lt;li&gt;waiting to lock &amp;lt;0xfffffffd9090d8b0&amp;gt; (a org.apache.derby.impl.jdbc.EmbedConnection40)&lt;br/&gt;
     at org.apache.derby.jdbc.XATransactionState.cancel(Unknown Source)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0xfffffffd9090f058&amp;gt; (a org.apache.derby.jdbc.XATransactionState)&lt;br/&gt;
     at org.apache.derby.jdbc.XATransactionState$CancelXATransactionTask.run(Unknown Source)&lt;br/&gt;
     at java.util.TimerThread.mainLoop(Timer.java:555)&lt;br/&gt;
     at java.util.TimerThread.run(Timer.java:505)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Found 1 deadlock.&lt;/p&gt;


&lt;p&gt;This deadlock caused Derby to create 18000 transaction recovery logs because of the XA transaction that did not cleanup in the timeout.  Rebooting the system would cause a 50 hour boot up time to process the transaction logs so recovery had to be done by going to a backup database before the issue occurred.&lt;/p&gt;

</description>
                <environment>Solaris 10.5 on Oracle M5000 </environment>
        <key id="12954263">DERBY-6879</key>
            <summary>Engine deadlock between XA timeout handling and cleanupOnError</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bbergquist">Brett Bergquist</assignee>
                                    <reporter username="bbergquist">Brett Bergquist</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Mar 2016 11:04:08 +0000</created>
                <updated>Tue, 9 Aug 2016 00:04:33 +0000</updated>
                            <resolved>Tue, 9 Aug 2016 00:04:32 +0000</resolved>
                                    <version>10.10.2.0</version>
                                    <fixVersion>10.13.1.0</fixVersion>
                                    <component>Services</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15215851" author="bbergquist" created="Tue, 29 Mar 2016 11:07:11 +0000"  >&lt;p&gt;I am examining the locking pattern to determine a different locking pattern to eliminate the deadlock.  Initially it looks like the timer task should grab the lock on the connection before locking the XATransactionState.&lt;/p&gt;
</comment>
                            <comment id="15342733" author="bbergquist" created="Tue, 21 Jun 2016 21:19:05 +0000"  >&lt;p&gt;In XATransactionState.java, we have:&lt;/p&gt;

&lt;p&gt;        /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Runs the cancel task of the global transaction&lt;br/&gt;
         */&lt;br/&gt;
        public void run() 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {            try {
                    xaState.cancel(MessageId.CONN_XA_TRANSACTION_TIMED_OUT);
            } catch (Throwable th) {
                Monitor.logThrowable(th);
            }&lt;br/&gt;
        }&lt;br/&gt;
&lt;br/&gt;
and the &quot;cancel&quot; method looks like:&lt;br/&gt;
&lt;br/&gt;
    synchronized void cancel(String messageId) throws XAException {&lt;br/&gt;
...&lt;br/&gt;
            try {
                conn.xa_rollback();
            } catch (SQLException sqle) {&lt;br/&gt;
&lt;br/&gt;
and the &quot;xa_rollback&quot; method looks like:&lt;br/&gt;
&lt;br/&gt;
	public final void xa_rollback() throws SQLException {&lt;br/&gt;
		synchronized (getConnectionSynchronization())&lt;br/&gt;
		{&lt;br/&gt;
&lt;br/&gt;
So when the timer expires, the lock pattern is to lock the XATransactionState and then the EmbedConnection object.   &lt;br/&gt;
&lt;br/&gt;
When an exception such as a lock timeout occurs when using a XA transaction and cleanupOnError code is called, the call stack looks like:&lt;br/&gt;
&lt;br/&gt;
&quot;DRDAConnThread_3&quot; #15 prio=5 os_prio=64 tid=0x0000000103d5b000 nid=0x19 waiting for monitor entry &lt;span class=&quot;error&quot;&gt;&amp;#91;0xffffffff1a9fe000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: BLOCKED (on object monitor)&lt;br/&gt;
	at org.apache.derby.jdbc.XATransactionState.cleanupOnError(XATransactionState.java:155)&lt;br/&gt;
	- waiting to lock &amp;lt;0xffffffff4d0aead8&amp;gt; (a org.apache.derby.jdbc.XATransactionState)&lt;br/&gt;
	at org.apache.derby.iapi.services.context.ContextManager.cleanupOnError(ContextManager.java:343)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.cleanupOnError(TransactionResourceImpl.java:461)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.TransactionResourceImpl.handleException(TransactionResourceImpl.java:344)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedConnection.handleException(EmbedConnection.java:2400)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.ConnectionChild.handleException(ConnectionChild.java:85)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(EmbedStatement.java:1437)&lt;br/&gt;
	- locked &amp;lt;0xffffffff4d01b698&amp;gt; (a org.apache.derby.impl.jdbc.EmbedConnection40)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.execute(EmbedStatement.java:711)&lt;br/&gt;
	- locked &amp;lt;0xffffffff4d01b698&amp;gt; (a org.apache.derby.impl.jdbc.EmbedConnection40)&lt;br/&gt;
	at org.apache.derby.impl.jdbc.EmbedStatement.executeLargeUpdate(EmbedStatement.java:190)&lt;br/&gt;
	at org.apache.derby.iapi.jdbc.BrokeredStatement.executeLargeUpdate(BrokeredStatement.java:633)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAConnThread.parseEXCSQLIMM(DRDAConnThread.java:5393)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAConnThread.processCommands(DRDAConnThread.java:759)&lt;br/&gt;
	at org.apache.derby.impl.drda.DRDAConnThread.run(DRDAConnThread.java:295)&lt;br/&gt;
&lt;br/&gt;
So here the lock pattern is locking the EmbedConnection40 (which is an EmbedConnection) and then the XATransactionState.   &lt;br/&gt;
&lt;br/&gt;
So we have just the opposite pattern and a deadlock occurs.   &lt;br/&gt;
&lt;br/&gt;
I have been able to get this to reproduce in a test application.   Using a normal non-XA connection, I query and lock many (10000) rows in a large table.   Using a separate XA connection, I try to delete those same rows.  I have &quot;derby.jdbc.xaTransactionTimeout=30&quot; in my derby.properties to have a very short transaction timeout.  I have the &quot;derby.locks.waitTimeout=60&quot; in my derby.properties.&lt;br/&gt;
&lt;br/&gt;
When I run the test application, it locks up the 10000 rows in one transaction that is not committed through the first non-XA connection.   The second XA connection tries to delete these rows.  Since the &quot;derby.jdbc.xaTransactionTimeout&quot; is 30 seconds, the XA transaction is going to timeout at 30 seconds, but the &quot;derby.locks.waitTimeout&quot; is going to cause the XA transaction to try wait for 60 seconds to obtain the locks that it needs. &lt;br/&gt;
&lt;br/&gt;
The timeout of the XA transaction is going to cause a SQLTransactionRollbackException to be recognized on the XA connection and it will try to then call the cleanup code.   But alas, the EmbedConnection is locked and it will try to lock the XATransactionState in the cleanup code and the XATransactionState is lock in the timeout task and will attempt to call &quot;xa_rollback&quot; on the XA connection.  Deadlock.&lt;br/&gt;
&lt;br/&gt;
I have a simple workaround and that is to change&lt;br/&gt;
&lt;br/&gt;
        /**&lt;br/&gt;
         * Runs the cancel task of the global transaction&lt;br/&gt;
         */&lt;br/&gt;
        public void run() {&lt;br/&gt;
            try {                    xaState.cancel(MessageId.CONN_XA_TRANSACTION_TIMED_OUT);            } catch (Throwable th) {
                Monitor.logThrowable(th);
            }&lt;br/&gt;
        }&lt;br/&gt;
&lt;br/&gt;
to&lt;br/&gt;
&lt;br/&gt;
        public void run() {&lt;br/&gt;
            try {&lt;br/&gt;
                synchronized (xaState.conn) {
                    xaState.cancel(MessageId.CONN_XA_TRANSACTION_TIMED_OUT);
                }&lt;br/&gt;
            } catch (Throwable th) {                Monitor.logThrowable(th);            }        }&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This changes the timeout task to first lock on the connection and then XATransactionState.   &lt;/p&gt;

&lt;p&gt;I would actually prefer to somehow add a new method to &quot;EmbedConnection&quot; that would acquire its lock which would then call back into XATransactionState.cancel to perform the cancel which would also change the lock pattern, but I am struggling to find out how to get from an EmbedConnection back to the XATransactionState.&lt;/p&gt;
</comment>
                            <comment id="15345486" author="bryanpendleton" created="Thu, 23 Jun 2016 00:39:06 +0000"  >&lt;p&gt;Hi Brett, thanks for all the time and effort on this!&lt;/p&gt;

&lt;p&gt;The evidence seems indisputable, and your analysis and explanation seem airtight.&lt;/p&gt;

&lt;p&gt;I agree with your conclusion that CancelXATransactionTask.run needs to lock the&lt;br/&gt;
connection before it calls the xaState.cancel method.&lt;/p&gt;

&lt;p&gt;I guess that your remaining questions boil down to:&lt;br/&gt;
1) How can we clean up the proposed change so that the locking on the connection&lt;br/&gt;
is a bit more elegantly encapsulated in the EmbedConnection class, and&lt;br/&gt;
2) How can we wrap all this up to get it committed&lt;/p&gt;

&lt;p&gt;Taking the second question first, it seems like your testing approach is a pretty&lt;br/&gt;
good one. Is it conceivable that you could package that up as a new test case&lt;br/&gt;
for the existing XA suites? Perhaps lowering the lock timeout so that the&lt;br/&gt;
test runs slightly faster?&lt;/p&gt;

&lt;p&gt;W.r.t. the coding aspect of expressing the synchronization point, would it&lt;br/&gt;
help to provide a new interface here?&lt;/p&gt;

&lt;p&gt;For example, could we make a &quot;Cancelable&quot; interface, with a single method&lt;br/&gt;
named &quot;cancel( MessageId msg )&quot;. Then we could make XATransactionState&lt;br/&gt;
implement Cancelable, and we could add a new method to EmbedConnection&lt;br/&gt;
along the lines of:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void cancel( Canceable c, MessageId m ) {
        c.cancel( m );
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and then CancelXATransactionTask.run turns into&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            xaState.conn.cancel( xaState, MessageId.CONN_XA_TRANSACTION_TIMED_OUT ); 
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; ( Throwable th ) { Monitor.logThrowable(th); }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I hope this is all making (some) sense.&lt;/p&gt;</comment>
                            <comment id="15346247" author="bbergquist" created="Thu, 23 Jun 2016 10:44:01 +0000"  >&lt;p&gt;I like your suggestion for the Cancelable which &quot;feels&quot; right in having the control be from the Embed connection.  I will pursue that.&lt;/p&gt;

&lt;p&gt;As for testing, the condition can be replicated simply and quickly:&lt;/p&gt;

&lt;p&gt;1. Set the &quot;derby.locks.waitTimeout&quot; so some value.&lt;br/&gt;
2. Set the &quot;derby.jdbc.xaTransactionTimeout&quot; to a value less than &quot;derby.locks.waitTimeout&quot; (in my last test, I used 60 second and 30 seconds but these could easily be 20 seconds and 10 seconds).&lt;br/&gt;
3. Lock a table exclusively in one statement with autoCommit disabled using a non-XA connection&lt;br/&gt;
4. Try to lock the same table exclusively with another statement using a XA connection&lt;/p&gt;

&lt;p&gt;What I am having trouble with is detecting the actual Java deadlock.   Normally I use &quot;jstack&quot; to determine such.  I looked through the test cases and don&apos;t see any such usage but may have missed it.  Any ideas in this area for the test case will be appreciated.&lt;/p&gt;
</comment>
                            <comment id="15346607" author="bbergquist" created="Thu, 23 Jun 2016 15:26:49 +0000"  >&lt;p&gt;I think I can write up a test using the capability in the ThreadMXBean.  This has the ability to look for deadlocks.  I am looking at the current tests to see how this might be done.&lt;/p&gt;</comment>
                            <comment id="15347036" author="bbergquist" created="Thu, 23 Jun 2016 19:35:14 +0000"  >&lt;p&gt;I am questioning if this is the final correct answer.  In this one case, the cleanUpOnError is being called by connection that is executing a statement so the locking is connection and then XATransactionState.  When a timeout occurs, the locking is XATransactionState and then the connection.  When both occur at the same time the deadlock occurs.  My proposed fix handles this situation.&lt;/p&gt;

&lt;p&gt;There is other possibilities.   So for example, code calls XAResource.commit.   This has the locking pattern of XATransactionState and then  connection.   So if the timeout were to occur during this time, then there would now be a deadlock here because the proposed solution is going to lock the connection and then the XATransacttionState.&lt;/p&gt;

&lt;p&gt;The original deadlock problem can only occur if the XATransactionState.cleanupOnError is called while the connection is locked and executing and a cleanup needs to be performed.&lt;/p&gt;</comment>
                            <comment id="15350206" author="bbergquist" created="Sun, 26 Jun 2016 19:24:13 +0000"  >&lt;p&gt;Here is a patch that adds a test for this issue.  Once the test is applied, then the XATest suite will fail as the added test will trigger a Java level deadlock in Derby. &lt;/p&gt;

&lt;p&gt;The patch also adds a DeadlockWatchdog.java class that is used by the new test to detect the Java level deadlock and exit the test using System.exit(1) so that the test run does not hang.&lt;/p&gt;

&lt;p&gt;Once &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6879&quot; title=&quot;Engine deadlock between XA timeout handling and cleanupOnError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6879&quot;&gt;&lt;del&gt;DERBY-6879&lt;/del&gt;&lt;/a&gt; is fixed then the deadlock will no longer occur and the XATest suite will pass.&lt;/p&gt;</comment>
                            <comment id="15350236" author="bryanpendleton" created="Sun, 26 Jun 2016 20:54:32 +0000"  >&lt;p&gt;I downloaded and applied the patch successfully, and tried running XATest. Here&apos;s what I see:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;junit-single:&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Running org.apache.derbyTesting.functionTests.tests.jdbcapi.XATest&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Watchdog failed: java.security.AccessControlException: access denied&lt;br/&gt;
 (&quot;java.lang.management.ManagementPermission&quot; &quot;monitor&quot;)&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Running org.apache.derbyTesting.functionTests.tests.jdbcapi.XATest&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 0 sec&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Test org.apache.derbyTesting.functionTests.tests.jdbcapi.XATest FAILED (crashed)&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="15350269" author="bbergquist" created="Sun, 26 Jun 2016 22:04:13 +0000"  >&lt;p&gt;Brian I just downloaded the trunk fresh on my Mac (I developed the patch on Windows 7) and downloaded and applied the patch and ran:&lt;/p&gt;

&lt;p&gt;ant -Dderby.junit.testclass=org.apache.derbyTesting.functionTests.tests.jdbcapi.XATest junit-clean all buildjars junit-single junit-html&lt;/p&gt;

&lt;p&gt;and it worked for me.  This is the tail end of that run:&lt;/p&gt;

&lt;p&gt;...&lt;br/&gt;
junit-single:&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Running org.apache.derbyTesting.functionTests.tests.jdbcapi.XATest&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Deadlock detected&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Running org.apache.derbyTesting.functionTests.tests.jdbcapi.XATest&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 0 sec&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Test org.apache.derbyTesting.functionTests.tests.jdbcapi.XATest FAILED (crashed)&lt;/p&gt;

&lt;p&gt;junit-init-nocp:&lt;/p&gt;

&lt;p&gt;junit-init:&lt;/p&gt;

&lt;p&gt;emit-junit-classpath-jars:&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;echo&amp;#93;&lt;/span&gt; Running with jars: /Users/brett/Development/svn/derby/trunk/jars/sane&lt;br/&gt;
     &lt;span class=&quot;error&quot;&gt;&amp;#91;echo&amp;#93;&lt;/span&gt; CLASSPATH (environment variable): ${env.CLASSPATH}&lt;/p&gt;

&lt;p&gt;emit-junit-classpath:&lt;/p&gt;

&lt;p&gt;junit-sysinfo:&lt;/p&gt;

&lt;p&gt;junit-html:&lt;/p&gt;

&lt;p&gt;...&lt;/p&gt;

&lt;p&gt;So maybe there is an environmental issue.  I am using&lt;/p&gt;

&lt;p&gt;Bretts-MacBook-Pro:trunk brett$ java -version&lt;br/&gt;
java version &quot;1.8.0_92&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.8.0_92-b14)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 25.92-b14, mixed mode)&lt;br/&gt;
Bretts-MacBook-Pro:trunk brett$ &lt;/p&gt;
</comment>
                            <comment id="15350279" author="bbergquist" created="Sun, 26 Jun 2016 22:33:24 +0000"  >&lt;p&gt;The error that you got is the error that happens without the &lt;/p&gt;

&lt;p&gt; permission java.lang.management.ManagementPermission &quot;monitor&quot;;&lt;/p&gt;

&lt;p&gt;in &lt;/p&gt;

&lt;p&gt;./java/testing/org/apache/derbyTesting/functionTests/tests/jdbcapi/XATest.policy&lt;/p&gt;</comment>
                            <comment id="15350303" author="bbergquist" created="Mon, 27 Jun 2016 00:16:06 +0000"  >&lt;p&gt;After examining the code for quite some time and still not completely understanding the context stack, I believe that the best solution is in XATransactionState to always synchronize on the connection first and then the XATransactionState instance for all of the methods that interact with the connection.  My reasoning is that it will be very difficult to change the locking pattern whereby an EmbedConnection is executing a SQL statement where the connection is synchronized on when executing a statement, and then detects an error and the context stack is processed calling cleanupOnError (which in XATransactionState is going to synchronize on the XATransactionState.&lt;/p&gt;

&lt;p&gt;So if that locking pattern cannot be changed, the XATransactionState locking pattern needs to be changed to first synchronize on the connection and then on the XATransactionState.  But all synchronization needs to be changed to that pattern so that another possible deadlock is not introduced.&lt;/p&gt;</comment>
                            <comment id="15350325" author="bryanpendleton" created="Mon, 27 Jun 2016 01:32:56 +0000"  >&lt;p&gt;I agree, it&apos;s as though the policy isn&apos;t being deployed as part of the test.&lt;/p&gt;

&lt;p&gt;To be honest, the mechanism that the test harness uses for custom policies&lt;br/&gt;
like these is a bit murky to me.&lt;/p&gt;

&lt;p&gt;In my previous experiment, I was running with classes. So I ran &apos;ant buildjars&apos;&lt;br/&gt;
and then ran the test again, and it worked perfectly.&lt;/p&gt;

&lt;p&gt;So then I ran &apos;ant cleanjars&apos;, and ran the test again, and it got the&lt;br/&gt;
security policy problem.&lt;/p&gt;

&lt;p&gt;So maybe it&apos;s a build error on my part, but it seems like something about&lt;br/&gt;
the policy is causing it not to be picked up in all cases on my machine.&lt;/p&gt;

&lt;p&gt;By the way, when I did &apos;ant buildjars&apos;, I had to run &apos;ant refreshjardriftcheck&apos;,&lt;br/&gt;
because the new DeadlockWatchdog class in derbyTesting.jar was noticed by the&lt;br/&gt;
jar drift detector. I think that&apos;s unrelated to why I was getting the&lt;br/&gt;
security policy error in the non-jar configuration, but I mention it anyway.&lt;/p&gt;</comment>
                            <comment id="15355255" author="bbergquist" created="Wed, 29 Jun 2016 13:45:00 +0000"  >&lt;p&gt;My thoughts about always synchronizing on the connection first will not work.  It does fix the immediate problem, but now when XA transaction is going to be to be timed out, the &quot;cancel&quot; waits for the connection to be able to be synchronized.  If the connection is executing a long running SQL statement, then the cancel actually waits for the completion before the &quot;cancel&quot; attempts to cancel.  So while it does solve the deadlock, it introduces another anomaly and as such is not the correct solution.&lt;/p&gt;</comment>
                            <comment id="15362702" author="bbergquist" created="Tue, 5 Jul 2016 16:16:55 +0000"  >&lt;p&gt;I have attached a revised patch with an updated test case and the resolution of the issue.&lt;/p&gt;

&lt;p&gt;The final solution I came up with was to modify XATransactionState.cancel.   The change removes the method level synchronization and instead synchronizes on the instance for handle the cancelling and rollback work against the XATransactionState, releases the synchronization state and performs the connection level rollback (which synchronizes on the connection), and then again synchronizes on the XATransactionState to return the connection.&lt;/p&gt;

&lt;p&gt;The change ensure that XATransactionState.cancel does not hold a lock on the XATransactionState instance while waiting for the lock on the EmbedConnection.&lt;/p&gt;</comment>
                            <comment id="15362707" author="bbergquist" created="Tue, 5 Jul 2016 16:19:01 +0000"  >&lt;p&gt;The patch also makes the CancelXATransactionTask.cancel and the CancelXATransactionTask.run methods synchronized.  Without this there is the possibility that the &quot;xaState&quot; could become null within &quot;cancel&quot; but be accessed within &quot;run&quot; and a NPE could occur.&lt;/p&gt;</comment>
                            <comment id="15363096" author="bbergquist" created="Tue, 5 Jul 2016 19:39:36 +0000"  >&lt;p&gt;The patch was no good so I removed it.   I will upload another shortly.&lt;/p&gt;</comment>
                            <comment id="15363176" author="bbergquist" created="Tue, 5 Jul 2016 20:34:38 +0000"  >&lt;p&gt;The patch &quot;derby-6897-2016-07-05.diff&quot; is now ready for review.  I had an issue with EOL with the previous incarnation of the patch that I deleted.  &lt;/p&gt;

&lt;p&gt;I also attached the output of the &quot;svn status&quot; to show the files modified/added.&lt;/p&gt;</comment>
                            <comment id="15364860" author="bbergquist" created="Wed, 6 Jul 2016 18:41:13 +0000"  >&lt;p&gt;All tests passed with this patch in place for me.&lt;/p&gt;</comment>
                            <comment id="15365542" author="bryanpendleton" created="Thu, 7 Jul 2016 03:31:01 +0000"  >&lt;p&gt;Hi Brett, thanks for the patch, and for the detailed explanation of your thinking on this.&lt;/p&gt;

&lt;p&gt;I don&apos;t really feel qualified to offer very deep comments on your patch, but here are&lt;br/&gt;
a few cursory comments:&lt;/p&gt;

&lt;p&gt;1) I believe we generally don&apos;t include @author tags in our code in Derby. Assuming that&apos;s&lt;br/&gt;
   OK, maybe you could remove that tag?&lt;/p&gt;

&lt;p&gt;2) It seems like the change to derbyTesting.jar.lastcontents is bigger than it needs to&lt;br/&gt;
   be; it looks like the contents of that file got sorted differently and so org.apache.derby&lt;br/&gt;
   classes ended up in a different order relative to org.apache.derbyTesting. I wonder&lt;br/&gt;
   if that&apos;s an artifact of the platform you are working on &amp;#8211; do you use Windows?&lt;/p&gt;

&lt;p&gt;3) I think that there is also a &apos;insane&apos; version of derbyTesting.jar.lastcontents, which&lt;br/&gt;
   needs to have the same trivial change as the &apos;sane&apos; version &amp;#8211; that is, DeadlockWatchdog.class&lt;br/&gt;
   needs to be added there, too.&lt;/p&gt;

&lt;p&gt;4) It seems like, at around line 410 of XATransactionState.java, you added braces&lt;br/&gt;
   around the call to Monitor.logTextMessage. Was that just a stylistic thing? Or is&lt;br/&gt;
   there a deeper change there that I&apos;m not understanding?&lt;/p&gt;

&lt;p&gt;Is there any other particular review you feel would be useful at this point? Assuming&lt;br/&gt;
that I can successfully apply your patch, and build and run the tests, is there more&lt;br/&gt;
work that you think is needed prior to commiting your change?&lt;/p&gt;</comment>
                            <comment id="15367630" author="bbergquist" created="Fri, 8 Jul 2016 12:57:31 +0000"  >&lt;p&gt;I will update the patch Brian.&lt;/p&gt;

&lt;p&gt;&quot;1&quot; snuck in there via my IDE.&lt;/p&gt;

&lt;p&gt;&quot;2&quot; I am working on windows and the change to &quot;derbyTesting.jar.lastcontents&quot; was done by running the ANT target &quot;refreshjardriftcheck&quot; which was prompted when it saw the new DeadlockWatchdog.class&quot;.   So any re-ordering was done by that target, possibly because of being developed on Windows.   I can manually fix that file so only have the DeadlockWatchdog.class being added.&lt;/p&gt;

&lt;p&gt;&quot;3&quot; Is there some document on the &quot;sane&quot; versus &quot;insane&quot; builds?   I understand what they are doing and by looking at the &quot;build.xml&quot; I see how to trigger each, but I can only find one reference in the &quot;BUILDING.html&quot;.   There seems to me to be a lot of &quot;magic&quot; on building/testing that I found as an impediment to contributing.&lt;/p&gt;

&lt;p&gt;&quot;4&apos; the IDE snuck this in when reformatting this section according to my coding guidelines. Looking through the history of the code when I was comparing the source from 10.10.2.0 to the trunk I braces being removed for no apparent reason.   On the change between revisions 1364916 and 1364917, I see a brace being added for a bare &quot;if&quot;.   &lt;/p&gt;

&lt;p&gt;Personally since doing software development since 1984, I have come to the conclusion that having the braces always has no downside and always has an upside when code is added to an &quot;if&quot; (it ensures that the code is added to content of the &quot;if&quot; and you don&apos;t have to add anything else).  Also according to the coding standard referenced on&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://wiki.apache.org/db-derby/DerbyContributorChecklist&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://wiki.apache.org/db-derby/DerbyContributorChecklist&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;which links to:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.oracle.com/technetwork/java/javase/documentation/codeconventions-142311.html#449&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.oracle.com/technetwork/java/javase/documentation/codeconventions-142311.html#449&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;having the &quot;braces&quot; is according to the coding standards.  I will remove the added braces however.   &lt;/p&gt;

&lt;p&gt;As far as further review, just a sanity check on the change is good.  &lt;/p&gt;

&lt;p&gt;The original problem to be solved is that a connection in that is performing a XA transaction that discovers an error that must be cleaned up is going to have a lock on a EmbedConnection and will then require a lock on the XATransactionState and if the same XA transaction times out (because of the XA transaction timer value) while the original XA transaction is being worked, then the timeout handling is going to have a lock on the XATransactionState and then require a lock on the EmbedConnection, triggering the deadlock.&lt;/p&gt;

&lt;p&gt;The change in the patch fixes this problem is the smallest way that I know of by altering the locking on the XATransactionState when invoked via the timeout by removing the synchronization on the &quot;cancel&quot; method and inline synchronizing on the &quot;XATransactionState&quot; to while its internals are being altered, then releasing the lock to allow the EmbedConnection.rollback to be invoked without the lock and finally acquiring the lock again to finish cleaning up the &quot;XATransactionState&quot;.&lt;/p&gt;</comment>
                            <comment id="15367656" author="bbergquist" created="Fri, 8 Jul 2016 13:18:15 +0000"  >&lt;p&gt;New patch file attached that fixes the issues that Brian mentioned in his review.  I also added a couple of comments to the &quot;cancel&quot; method to indicate the new synchronization change and reference to &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6879&quot; title=&quot;Engine deadlock between XA timeout handling and cleanupOnError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6879&quot;&gt;&lt;del&gt;DERBY-6879&lt;/del&gt;&lt;/a&gt; of what the change is for.&lt;/p&gt;</comment>
                            <comment id="15367687" author="bryanpendleton" created="Fri, 8 Jul 2016 13:39:40 +0000"  >&lt;p&gt;Thanks Brett!&lt;/p&gt;

&lt;p&gt;I&apos;m no fan of brace or whitespace wars, either, sorry if I left that impression. I was&lt;br/&gt;
simply doing a close reading and trying to make sure I didn&apos;t overlook anything.&lt;/p&gt;

&lt;p&gt;The note in BUILDING.html is the only doc I know of w.r.t. sane vs insane. From a&lt;br/&gt;
coding point of view, a sane build causes code like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (SanityManager.DEBUG) {
                SanityManager.ASSERT(stream != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to actually do something, while in an insane build that code is neutered, and&lt;br/&gt;
in fact with modern compilers is essentially eliminated entirely. If you compare&lt;br/&gt;
the file size of the class files and jars in a sane build vs an insane build, you&lt;br/&gt;
should see a non-trivial difference, and test runs should have different elapsed&lt;br/&gt;
times, too.&lt;/p&gt;

&lt;p&gt;It sounds like you&apos;re ready to go. I&apos;ll get to work on commiting this patch soon,&lt;br/&gt;
probably this weekend.&lt;/p&gt;</comment>
                            <comment id="15368764" author="jira-bot" created="Sat, 9 Jul 2016 00:05:06 +0000"  >&lt;p&gt;Commit 1751977 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bryanpendleton&quot; class=&quot;user-hover&quot; rel=&quot;bryanpendleton&quot;&gt;bryanpendleton&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1751977&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1751977&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6879&quot; title=&quot;Engine deadlock between XA timeout handling and cleanupOnError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6879&quot;&gt;&lt;del&gt;DERBY-6879&lt;/del&gt;&lt;/a&gt;: Engine deadlock between XA timeout handling and cleanupOnError&lt;/p&gt;

&lt;p&gt;This patch was contributed by Brett Bergquist (brett at thebergquistfamily dot com)&lt;/p&gt;

&lt;p&gt;The original problem to be solved is that a connection that is performing a&lt;br/&gt;
XA transaction that discovers an error that must be cleaned up is going to&lt;br/&gt;
have a lock on a EmbedConnection and will then require a lock on the&lt;br/&gt;
XATransactionState.&lt;/p&gt;

&lt;p&gt;And if the same XA transaction times out (because of the XA transaction&lt;br/&gt;
timer value) while the original XA transaction is being worked, then the&lt;br/&gt;
timeout handling is going to have a lock on the XATransactionState and then&lt;br/&gt;
require a lock on the EmbedConnection, triggering the deadlock.&lt;/p&gt;

&lt;p&gt;The change in the patch fixes this problem by altering the locking on&lt;br/&gt;
the XATransactionState when invoked via the timeout by removing the&lt;br/&gt;
synchronization on the &quot;cancel&quot; method and instead using inline&lt;br/&gt;
synchronization on the &quot;XATransactionState&quot; while its internals are being&lt;br/&gt;
altered.&lt;/p&gt;

&lt;p&gt;Then, it releases the XATransactionState lock to allow the&lt;br/&gt;
EmbedConnection.rollback method to be invoked without the lock.&lt;/p&gt;

&lt;p&gt;Finally, it acquires the lock again to finish cleaning up the XATransactionState.&lt;/p&gt;</comment>
                            <comment id="15368768" author="bryanpendleton" created="Sat, 9 Jul 2016 00:06:51 +0000"  >&lt;p&gt;I had no further suggestions to offer after re-reading Brett&apos;s latest patch,&lt;br/&gt;
and all of my test results were clean, so I&apos;ve committed the patch.&lt;/p&gt;

&lt;p&gt;Thank you for this contribution, Brett! And, more importantly, thanks&lt;br/&gt;
again for all the hard work to diagnose the problem, build new test cases&lt;br/&gt;
and testing infrastructure, and really going the extra distance to contribute&lt;br/&gt;
as thorough an improvement as this.&lt;/p&gt;</comment>
                            <comment id="15368858" author="jira-bot" created="Sat, 9 Jul 2016 01:25:33 +0000"  >&lt;p&gt;Commit 1751978 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bryanpendleton&quot; class=&quot;user-hover&quot; rel=&quot;bryanpendleton&quot;&gt;bryanpendleton&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1751978&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1751978&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6879&quot; title=&quot;Engine deadlock between XA timeout handling and cleanupOnError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6879&quot;&gt;&lt;del&gt;DERBY-6879&lt;/del&gt;&lt;/a&gt;: Engine deadlock between XA timeout handling and cleanupOnError&lt;/p&gt;

&lt;p&gt;This patch was contributed by Brett Bergquist (brett at thebergquistfamily dot com)&lt;/p&gt;

&lt;p&gt;The original problem to be solved is that a connection that is performing a&lt;br/&gt;
XA transaction that discovers an error that must be cleaned up is going to&lt;br/&gt;
have a lock on a EmbedConnection and will then require a lock on the&lt;br/&gt;
XATransactionState.&lt;/p&gt;

&lt;p&gt;And if the same XA transaction times out (because of the XA transaction&lt;br/&gt;
timer value) while the original XA transaction is being worked, then the&lt;br/&gt;
timeout handling is going to have a lock on the XATransactionState and then&lt;br/&gt;
require a lock on the EmbedConnection, triggering the deadlock.&lt;/p&gt;

&lt;p&gt;The change in the patch fixes this problem by altering the locking on&lt;br/&gt;
the XATransactionState when invoked via the timeout by removing the&lt;br/&gt;
synchronization on the &quot;cancel&quot; method and instead using inline&lt;br/&gt;
synchronization on the &quot;XATransactionState&quot; while its internals are being&lt;br/&gt;
altered.&lt;/p&gt;

&lt;p&gt;Then, it releases the XATransactionState lock to allow the&lt;br/&gt;
EmbedConnection.rollback method to be invoked without the lock.&lt;/p&gt;

&lt;p&gt;Finally, it acquires the lock again to finish cleaning up the XATransactionState.&lt;/p&gt;</comment>
                            <comment id="15368860" author="bryanpendleton" created="Sat, 9 Jul 2016 01:26:06 +0000"  >&lt;p&gt;Had to do follow-on commit 1751978 because I forgot to &apos;svn add&apos;&lt;br/&gt;
the two new files. Mea culpa.&lt;/p&gt;</comment>
                            <comment id="15380886" author="bryanpendleton" created="Sat, 16 Jul 2016 18:28:39 +0000"  >&lt;p&gt;Hi Brett,&lt;/p&gt;

&lt;p&gt;While running the overall suite overnight I had a test failure&lt;br/&gt;
with the new test. I zipped up the output and attached it as&lt;br/&gt;
&apos;testFail.zip&apos;.&lt;/p&gt;

&lt;p&gt;Can you see anything in there that explains what happened?&lt;/p&gt;

&lt;p&gt;thanks,&lt;/p&gt;

&lt;p&gt;bryan&lt;/p&gt;</comment>
                            <comment id="15380914" author="bbergquist" created="Sat, 16 Jul 2016 19:49:11 +0000"  >&lt;p&gt;The exception is a XAER_DUPID being reported from line 1271 on XaTest.java which looks like:&lt;/p&gt;

&lt;p&gt;        // Get a second connection and global xact&lt;br/&gt;
        // and try to select causing lock timeout&lt;br/&gt;
        XAConnection xaconn2 = xads.getXAConnection();&lt;br/&gt;
        XAResource xar2 = xaconn2.getXAResource();&lt;br/&gt;
        xar2.setTransactionTimeout(2);&lt;br/&gt;
        Xid xid2 = XATestUtil.getXid(6879, 11, 51);&lt;br/&gt;
        Connection conn2 = xaconn2.getConnection();&lt;br/&gt;
        // Set to serializable so we get lock timeout&lt;br/&gt;
        conn2.setTransactionIsolation(Connection.TRANSACTION_SERIALIZABLE);&lt;br/&gt;
        xar2.start(xid2, XAResource.TMNOFLAGS);&lt;/p&gt;

&lt;p&gt;So the &quot;xar2.start&quot; is the one failing with a duplicate XID.   I don&apos;t know how this could happen unless the test were being run twice at the same time.   Not that this code is before anything that triggers the &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6879&quot; title=&quot;Engine deadlock between XA timeout handling and cleanupOnError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6879&quot;&gt;&lt;del&gt;DERBY-6879&lt;/del&gt;&lt;/a&gt; issue.  It is just creating and starting a XA transaction with a specific XID.   &lt;/p&gt;</comment>
                            <comment id="15380926" author="bbergquist" created="Sat, 16 Jul 2016 20:11:49 +0000"  >&lt;p&gt;Brian, it looks like there is a timing issue in XATransactionState.cancel with the new code.&lt;/p&gt;

&lt;p&gt;       if (needsRollback) {&lt;br/&gt;
            // While the rollback is performed on the connection, &lt;br/&gt;
            //  this XATransactionState is ont synchronized to work around &lt;br/&gt;
            //  the issue reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6879&quot; title=&quot;Engine deadlock between XA timeout handling and cleanupOnError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6879&quot;&gt;&lt;del&gt;DERBY-6879&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
            try &lt;/p&gt;
{
                // Rollback the global transaction
                conn.xa_rollback();
            }
&lt;p&gt; catch (SQLException sqle) &lt;/p&gt;
{
                XAException ex = new XAException(XAException.XAER_RMERR);
                ex.initCause(sqle);
                throw ex;
            }
&lt;p&gt;        }&lt;/p&gt;

&lt;p&gt;The &quot;conn.xa_rollback&quot; is throwing a SQL exception.  &lt;/p&gt;

&lt;p&gt;For now, I think we should rollback the patch and disable this test until I can reproduce this issue consistently and debug it.&lt;/p&gt;</comment>
                            <comment id="15380976" author="bryanpendleton" created="Sat, 16 Jul 2016 22:58:43 +0000"  >&lt;p&gt;Good, I&apos;m glad you have a theory to consider.&lt;/p&gt;

&lt;p&gt;I don&apos;t see any need to rollback your previous work just yet. It&apos;s only in main,&lt;br/&gt;
not in any released builds, and so it&apos;s only being seen by developers like us who&lt;br/&gt;
are building and working with main.&lt;/p&gt;

&lt;p&gt;I&apos;m happy to leave the code as it is while we think about the issues for the time being.&lt;/p&gt;

&lt;p&gt;The intermittent test failure is not causing anyone any problems that I am aware of.&lt;/p&gt;</comment>
                            <comment id="15381594" author="bbergquist" created="Mon, 18 Jul 2016 00:46:09 +0000"  >&lt;p&gt;I was able to get this to reproduce periodically by causing stress on my test system while running the tests over and over.   &lt;/p&gt;

&lt;p&gt;There is a timing issue that is opened up because of the lack of synchronization on the XATransactionState inside of &apos;cancel&apos; while calling the &quot;conn.rollback&quot;.  &lt;/p&gt;

&lt;p&gt; I have taken a different approach for a fix.  &lt;/p&gt;

&lt;p&gt;The problem occurs if a timeout occurs calling &quot;cancel&quot; and if an error occurs on the clients connection causing the &quot;cleanupOnError&quot; to be called at the same time.  Recognizing this, the patch in the &quot;cancel&quot; method checks to see if the &quot;cleanUpOnError&quot; is being invoked and if so, the cancel is skipped.  This makes sense as if &quot;cleanupOnError&quot; is being called, then the transaction will end anyways as there the error handling code on the client is being processed, so it does not need to be cancelled.&lt;/p&gt;

&lt;p&gt;The patch also adds a check in the &quot;cleanupOnError&quot; method to check to see if the &quot;cancel&quot; is being invoked.  If so, then the cleanup on the XATransactionState by this method is skipped.   this makes sense as if the transaction is being cancelled, then there is no need to mark the XATransactionState with the cleanup error information.&lt;/p&gt;

&lt;p&gt;The patch also disassociates the XID from ResourceAdapter earlier in the &quot;cancel&quot;.   The logic behind this is that once the &quot;cancel&quot; starts processing any client code that access the XA transaction, really should not see the XA transaction.   So a call to  &quot;XATransaction.end&quot; for example, after the XA transaction times out and is cancelled, the client code is going to received a XAException.XAER_NOTA.   Note that this is not a change in except in timing of where the XID is removed in &quot;cancel&quot; in that it previously was done at the end of &quot;cancel&quot; and now it is being done in the beginning of &quot;cancel&quot;.  This eliminate any possibly that client code can access a XA transaction after it is starting to be cancelled.  Also note that this does not change the error that a client would receive if the XA transaction were cancelled and then seconds later after the cancel completed, the client were to access the XA transaction; it would receive a XAException.XAER_NOTA.&lt;/p&gt;

&lt;p&gt;The patch creates a new private static class that is used to track if &quot;cancel&quot; or &quot;cleanupOnError&quot; has been invoked.  The methods are synchronized so that there is no timing issue on checking and recording the state.&lt;/p&gt;
</comment>
                            <comment id="15381596" author="bbergquist" created="Mon, 18 Jul 2016 00:49:56 +0000"  >&lt;p&gt;The patch that fixes the issue.   I have run all tests in the &quot;rg.apache.derbyTesting.functionTests.tests.jdbcapi._Suite&quot; over and over while stressing the system.  &lt;/p&gt;

&lt;p&gt;I will run the full test suite now and update but I believe that there will be no issues as the XATransactionState is only accessed by tests in this suite.&lt;/p&gt;</comment>
                            <comment id="15382101" author="bbergquist" created="Mon, 18 Jul 2016 11:22:55 +0000"  >&lt;p&gt;Both the junit based and the old test harness tests passed with no errors.&lt;/p&gt;</comment>
                            <comment id="15383354" author="bryanpendleton" created="Tue, 19 Jul 2016 00:16:06 +0000"  >&lt;p&gt;I found the 07-17 diff to be a bit hard to concentrate on,&lt;br/&gt;
because the re-indentation of some code led to a large&lt;br/&gt;
diff file. Attached &apos;diff-0717-ignore-whitespace.diff&apos; is&lt;br/&gt;
the result of doing &apos;svn diff -x -w&apos; after applying the&lt;br/&gt;
&apos;derby-6879-2016-07-17.diff&apos;; it is significantly smaller&lt;br/&gt;
and might help anyone who is looking at this diff.&lt;/p&gt;</comment>
                            <comment id="15383536" author="jira-bot" created="Tue, 19 Jul 2016 03:55:38 +0000"  >&lt;p&gt;Commit 1753333 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bryanpendleton&quot; class=&quot;user-hover&quot; rel=&quot;bryanpendleton&quot;&gt;bryanpendleton&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1753333&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1753333&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6879&quot; title=&quot;Engine deadlock between XA timeout handling and cleanupOnError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6879&quot;&gt;&lt;del&gt;DERBY-6879&lt;/del&gt;&lt;/a&gt;: Engine deadlock between XA timeout handling and cleanupOnError&lt;/p&gt;

&lt;p&gt;This patch was contributed by Brett Bergquist (brett at thebergquistfamily dot com)&lt;/p&gt;

&lt;p&gt;This change is a follow-up to revision 1751977.&lt;/p&gt;

&lt;p&gt;The problem with that revision occurs if a timeout occurs calling &quot;cancel&quot;&lt;br/&gt;
and if an error occurs on the clients connection causing the &quot;cleanupOnError&quot;&lt;br/&gt;
to be called at the same time.&lt;/p&gt;

&lt;p&gt;This change creates a new private static class that is used to track if&lt;br/&gt;
&quot;cancel&quot; or &quot;cleanupOnError&quot; has been invoked. The methods are synchronized&lt;br/&gt;
so that there is no timing issue on checking and recording the state.&lt;/p&gt;</comment>
                            <comment id="15383540" author="bryanpendleton" created="Tue, 19 Jul 2016 03:57:42 +0000"  >&lt;p&gt;I read through the patch, and also built it and ran the jdbcapi tests myself multiple times.&lt;/p&gt;

&lt;p&gt;I have no additional improvements to suggest, so I committed the patch.&lt;/p&gt;

&lt;p&gt;Brett, thanks for the quick follow-up.&lt;/p&gt;</comment>
                            <comment id="15411301" author="kristwaa" created="Mon, 8 Aug 2016 05:14:35 +0000"  >&lt;p&gt;Hi. What&apos;s the state of this issue now? It&apos;s still reported as unresolved and unassigned by JIRA.&lt;/p&gt;</comment>
                            <comment id="15411923" author="bbergquist" created="Mon, 8 Aug 2016 15:05:10 +0000"  >&lt;p&gt;I don&apos;t know the proper procedure on this Kristian.   All of the code is complete and been committed by Bryan and it there have been no issues in the regression tests that I know of.  Also, I have put a patched version of this into our production environments and there have been no issues there either.&lt;/p&gt;

&lt;p&gt;I think it is ready to be marked as resolved.&lt;/p&gt;</comment>
                            <comment id="15412692" author="bryanpendleton" created="Tue, 9 Aug 2016 00:04:33 +0000"  >&lt;p&gt;Thanks for the reminder, Kristian. As Brett noted, we&apos;ve completed&lt;br/&gt;
all the intended work for this issue. Marking resolved as fixed in 10.13.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12816294" name="derby-6879-2016-07-05.diff" size="29702" author="bbergquist" created="Tue, 5 Jul 2016 20:34:38 +0000"/>
                            <attachment id="12816821" name="derby-6879-2016-07-08.diff" size="29933" author="bbergquist" created="Fri, 8 Jul 2016 13:18:15 +0000"/>
                            <attachment id="12818485" name="derby-6879-2016-07-17.diff" size="17604" author="bbergquist" created="Mon, 18 Jul 2016 00:49:56 +0000"/>
                            <attachment id="12813568" name="derby-6879-test.diff" size="24637" author="bbergquist" created="Sun, 26 Jun 2016 19:24:13 +0000"/>
                            <attachment id="12818713" name="diff-0717-ignore-whitespace.diff" size="5714" author="bryanpendleton" created="Tue, 19 Jul 2016 00:16:06 +0000"/>
                            <attachment id="12816295" name="svnstatus.txt" size="425" author="bbergquist" created="Tue, 5 Jul 2016 20:34:38 +0000"/>
                            <attachment id="12818415" name="testFail.zip" size="465677" author="bryanpendleton" created="Sat, 16 Jul 2016 18:28:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10365"><![CDATA[Crash]]></customfieldvalue>
    <customfieldvalue key="10364"><![CDATA[Data corruption]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 15 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2vc7b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>