<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 14:51:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DERBY-6981] SQLSTATE: XJ001, SQLERRMC: java.lang.NullPointerException��XJ001.U</title>
                <link>https://issues.apache.org/jira/browse/DERBY-6981</link>
                <project id="10594" key="DERBY">Derby</project>
                    <description>&lt;p&gt;Original error mesage:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.sql.SQLException: DERBY SQL error: ERRORCODE: 0, SQLSTATE: XJ001, SQLERRMC: java.lang.NullPointerException��XJ001.U at org.apache.derby.client.am.SQLExceptionFactory.getSQLException(Unknown Source) at org.apache.derby.client.am.SqlException.getSQLException(Unknown Source) at org.apache.derby.client.am.ClientResultSet.next(Unknown Source) at org.ziptie.provider.credentials.internal.test1.main(test1.java:43) Caused by: ERROR XJ001: DERBY SQL error: ERRORCODE: 0, SQLSTATE: XJ001, SQLERRMC: java.lang.NullPointerException��XJ001.U at org.apache.derby.client.am.ClientResultSet.completeSqlca(Unknown Source) at org.apache.derby.client.net.NetResultSetReply.parseFetchError(Unknown Source) at org.apache.derby.client.net.NetResultSetReply.parseCNTQRYreply(Unknown Source) at org.apache.derby.client.net.NetResultSetReply.readFetch(Unknown Source) at org.apache.derby.client.net.ResultSetReply.readFetch(Unknown Source) at org.apache.derby.client.net.NetResultSet.readFetch_(Unknown Source) at org.apache.derby.client.net.NetResultSet.flowFetch(Unknown Source) at org.apache.derby.client.net.NetCursor.getMoreData_(Unknown Source) at org.apache.derby.client.am.Cursor.stepNext(Unknown Source) at org.apache.derby.client.am.Cursor.next(Unknown Source) at org.apache.derby.client.am.ClientResultSet.nextX(Unknown Source)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6735&quot; title=&quot;NPE when the select list contains ROW_NUMBER and subquery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6735&quot;&gt;DERBY-6735&lt;/a&gt;&#160;is very similar bug.&lt;/p&gt;

&lt;p&gt;DDL&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE TABLE TEST1
(
ID &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PRIMARY KEY NOT NULL,
LASTUPDATE timestamp
)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I have attached test Code:&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12908509/12908509_derby-test.java&quot; title=&quot;derby-test.java attached to DERBY-6981&quot;&gt;derby-test.java&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;test Code with embeded derby :&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12908510/12908510_Main.java&quot; title=&quot;Main.java attached to DERBY-6981&quot;&gt;Main.java&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;sup&gt;Full code on my&#160;intellij&#160;:&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12908511/12908511_Test1.zip&quot; title=&quot;Test1.zip attached to DERBY-6981&quot;&gt;Test1.zip&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;:&lt;/sup&gt;&lt;/p&gt;

&lt;p&gt;Another database (PostgreSQL) has no problem.&lt;/p&gt;

&lt;p&gt;I also put a workaround in the code.&lt;/p&gt;</description>
                <environment>OSX,CentOS</environment>
        <key id="13134953">DERBY-6981</key>
            <summary>SQLSTATE: XJ001, SQLERRMC: java.lang.NullPointerException��XJ001.U</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanpendleton">Bryan Pendleton</assignee>
                                    <reporter username="masterchief24">Roger Sanghee Kim</reporter>
                        <labels>
                            <label>newbie</label>
                    </labels>
                <created>Wed, 31 Jan 2018 02:07:01 +0000</created>
                <updated>Wed, 1 May 2019 16:08:30 +0000</updated>
                            <resolved>Thu, 8 Feb 2018 02:50:05 +0000</resolved>
                                    <version>10.12.1.1</version>
                                    <fixVersion>10.15.1.3</fixVersion>
                                    <component>JDBC</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16346277" author="bryanpendleton" created="Wed, 31 Jan 2018 05:26:35 +0000"  >&lt;p&gt;I took the provided derby-test.java and tweaked it slightly. I ran it as follows:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160; &#160;&#160;javac -cp .;\users\bryan\derby\trunk\classes test1.java&lt;/p&gt;

&lt;p&gt;&#160; &#160;&#160;java -cp .;\users\bryan\derby\trunk\classes test1&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It produced the following output:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Insert 3&lt;br/&gt;
3: 1517299200000 -&amp;gt; 1517376190493&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;m not really sure what the program was supposed to do, but it didn&apos;t produce a NullPointerException for me.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;However, an important difference is that I ran the program in Embedded mode, not in Client/Server mode.&lt;/p&gt;</comment>
                            <comment id="16346335" author="masterchief24" created="Wed, 31 Jan 2018 06:43:28 +0000"  >&lt;p&gt;Hi. I have attached the version of EmbeddedDriver for easy testing.&lt;br/&gt;
 Test results are the same between Server/Client and EmbeddedDriver.&lt;/p&gt;</comment>
                            <comment id="16346918" author="bryanpendleton" created="Wed, 31 Jan 2018 14:36:43 +0000"  >&lt;p&gt;Yes, it reproduces for me now. I see the following in my derby.log:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Wed Jan 31 06:35:24 PST 2018 Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;main,5,main&amp;#93;&lt;/span&gt; (XID = 212), (SESSIONID = 1), (DATABASE = test), (DRDAID = null), Faile&lt;br/&gt;
d Statement is: SELECT id, LASTUPDATE FROM test1 WHERE id = ? FOR UPDATE OF id, LASTUPDATE with 1 parameters begin parameter #1: 3 :end parameter&#160;&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
 at org.apache.derby.iapi.store.access.BackingStoreHashtable.remove(BackingStoreHashtable.java:968)&lt;br/&gt;
 at org.apache.derby.impl.sql.execute.TableScanResultSet.getNextRowCore(TableScanResultSet.java:520)&lt;br/&gt;
 at org.apache.derby.impl.sql.execute.IndexRowToBaseRowResultSet.getNextRowCore(IndexRowToBaseRowResultSet.java:346)&lt;br/&gt;
 at org.apache.derby.impl.sql.execute.BasicNoPutResultSetImpl.getNextRow(BasicNoPutResultSetImpl.java:488)&lt;br/&gt;
 at org.apache.derby.impl.jdbc.EmbedResultSet.movePosition(EmbedResultSet.java:450)&lt;br/&gt;
 at org.apache.derby.impl.jdbc.EmbedResultSet.next(EmbedResultSet.java:394)&lt;br/&gt;
 at Main.main(Main.java:123)&lt;/p&gt;</comment>
                            <comment id="16348010" author="bryanpendleton" created="Thu, 1 Feb 2018 04:53:47 +0000"  >&lt;p&gt;I don&apos;t fully understand what&apos;s going wrong here, but I (sort of) know how to fix it.&lt;/p&gt;

&lt;p&gt;The problem involves:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The use of a CONCUR_UPDATABLE result set and a SELECT ... FOR UPDATE statement, which triggers some tricky code in TableScanResultSet&lt;/li&gt;
	&lt;li&gt;The fact that we execute the query multiple times, closing and reopening result sets on the same prepared statement&lt;/li&gt;
	&lt;li&gt;A bug (I think) in the TableScanResultSet.close() logic.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The tricky code in TableScanResultSet is very very old code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/** 
 * This field is used by beetle 3865, updateable cursor using index. It 
 * is a hash table containing updated rows that are thrown into &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; 
 * direction of the index scan, and as a result we&apos;ll hit it again but 
 * should skip it. The hash table will spill to disk &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it grows too big 
 * to be kept in memory. 
 */ 
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; BackingStoreHashtable past2FutureTbl;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And the bug (I think) in TableScanResultSet.close() is that when the past2FutureTbl object is lazy-initialized, so when we close() it, we also have to null out the variable, so that the next time we reopen this result set, we will re-allocate and re-initialize a new past2FutureTbl hashtable.&lt;/p&gt;

&lt;p&gt;That is, I think the fix is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Index: java/engine/org/apache/derby/impl/sql/execute/TableScanResultSet.java =================================================================== 
--- java/engine/org/apache/derby/impl/sql/execute/TableScanResultSet.java (revision 1805254) 
+++ java/engine/org/apache/derby/impl/sql/execute/TableScanResultSet.java (working copy) 
@@ -625,6 +625,7 @@
 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (past2FutureTbl != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
 { 
past2FutureTbl.close(); 
+ past2FutureTbl = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
 }
 }
 &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I haven&apos;t run any real tests on this, just verified that if I null-out past2FutureTbl at this point, this particular test case passes.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Rick, what do you think?&lt;/p&gt;</comment>
                            <comment id="16348037" author="bryanpendleton" created="Thu, 1 Feb 2018 05:34:32 +0000"  >&lt;p&gt;Attached &apos;patch1.diff&apos; is a patch proposal, containing the proposed change to TableScanResultSet.close as well as the reproduction script from this issue, refactored into the UpdatableResultSetTest suite.&lt;/p&gt;

&lt;p&gt;The test case fails without the change to TableScanResultSet.java, and passes with it.&lt;/p&gt;

&lt;p&gt;I haven&apos;t done any other testing (my environment is a bit flaky right now).&lt;/p&gt;

&lt;p&gt;If this patch proposal seems like a reasonable path forward, I&apos;ll try to run more tests.&lt;/p&gt;</comment>
                            <comment id="16349224" author="rhillegas" created="Thu, 1 Feb 2018 20:40:42 +0000"  >&lt;p&gt;Hi Bryan,&lt;/p&gt;

&lt;p&gt;Thanks for digging into this. Your analysis sounds solid to me. It definitely looks like a bug to close the hashtable without nulling out that variable immediately afterward. Thanks.&lt;/p&gt;</comment>
                            <comment id="16351432" author="jira-bot" created="Sat, 3 Feb 2018 16:09:49 +0000"  >&lt;p&gt;Commit 1823037 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bryanpendleton&quot; class=&quot;user-hover&quot; rel=&quot;bryanpendleton&quot;&gt;bryanpendleton&lt;/a&gt; in branch &apos;code/trunk&apos;&lt;br/&gt;
[ &lt;a href=&quot;https://svn.apache.org/r1823037&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/r1823037&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/DERBY-6981&quot; title=&quot;SQLSTATE: XJ001, SQLERRMC: java.lang.NullPointerException��XJ001.U&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DERBY-6981&quot;&gt;&lt;del&gt;DERBY-6981&lt;/del&gt;&lt;/a&gt;: NullPointerException when re-executing PreparedStatement query.&lt;/p&gt;

&lt;p&gt;TableScanResultSet&apos;s past2FutureTbl is a hash table containing updated&lt;br/&gt;
rows that are thrown into the future direction of the index scan, so&lt;br/&gt;
that the scan knows it&apos;s seen these rows already and should skip them&lt;br/&gt;
subsequently.&lt;/p&gt;

&lt;p&gt;When the TableScanResultSet.close() method was called, it was closing the&lt;br/&gt;
past2FutureTbl, but not clearing the pointer, which caused the lazy&lt;br/&gt;
initialization of the past2FutureTbl to be incorrectly performed the&lt;br/&gt;
next time the same TableScanResultSet was opened and scanned, resulting&lt;br/&gt;
in the NullPointerException in the underlying BackingStoreHashtable code&lt;br/&gt;
in that second scan.&lt;/p&gt;

&lt;p&gt;The fix is to clear the old instance and freshly initialize a new instance,&lt;br/&gt;
each time the TableScanResultSet is closed and reopened.&lt;/p&gt;</comment>
                            <comment id="16356415" author="bryanpendleton" created="Thu, 8 Feb 2018 02:50:05 +0000"  >&lt;p&gt;Thanks Rick for the review! I&apos;m not planning any additional work at this time, resolving.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12908510" name="Main.java" size="5487" author="masterchief24" created="Wed, 31 Jan 2018 06:37:32 +0000"/>
                            <attachment id="12908511" name="Test1.zip" size="5960591" author="masterchief24" created="Wed, 31 Jan 2018 06:39:29 +0000"/>
                            <attachment id="12908509" name="derby-test.java" size="2273" author="masterchief24" created="Wed, 31 Jan 2018 06:34:29 +0000"/>
                            <attachment id="12967568" name="derby.pdf" size="57401" author="ozinger" created="Wed, 1 May 2019 16:08:30 +0000"/>
                            <attachment id="12908723" name="patch1.diff" size="2265" author="bryanpendleton" created="Thu, 1 Feb 2018 05:32:28 +0000"/>
                            <attachment id="12908498" name="test1.java" size="2573" author="bryanpendleton" created="Wed, 31 Jan 2018 05:24:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310200" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Bug behavior facts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10365"><![CDATA[Crash]]></customfieldvalue>
    <customfieldvalue key="10362"><![CDATA[Performance]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                <customfield id="customfield_12310090" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Issue &amp; fix info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10423"><![CDATA[Newcomer]]></customfieldvalue>
    <customfieldvalue key="10427"><![CDATA[Workaround attached]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3pknj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>