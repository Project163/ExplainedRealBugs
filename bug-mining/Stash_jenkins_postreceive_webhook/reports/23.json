{"url":"https://api.github.com/repos/mohamicorp/stash-jenkins-postreceive-webhook/issues/108","repository_url":"https://api.github.com/repos/mohamicorp/stash-jenkins-postreceive-webhook","labels_url":"https://api.github.com/repos/mohamicorp/stash-jenkins-postreceive-webhook/issues/108/labels{/name}","comments_url":"https://api.github.com/repos/mohamicorp/stash-jenkins-postreceive-webhook/issues/108/comments","events_url":"https://api.github.com/repos/mohamicorp/stash-jenkins-postreceive-webhook/issues/108/events","html_url":"https://github.com/mohamicorp/stash-jenkins-postreceive-webhook/issues/108","id":59205010,"node_id":"MDU6SXNzdWU1OTIwNTAxMA==","number":108,"title":"NoSuchElementException when pushing remote merge","user":{"login":"bbaetz","id":304030,"node_id":"MDQ6VXNlcjMwNDAzMA==","avatar_url":"https://avatars.githubusercontent.com/u/304030?v=4","gravatar_id":"","url":"https://api.github.com/users/bbaetz","html_url":"https://github.com/bbaetz","followers_url":"https://api.github.com/users/bbaetz/followers","following_url":"https://api.github.com/users/bbaetz/following{/other_user}","gists_url":"https://api.github.com/users/bbaetz/gists{/gist_id}","starred_url":"https://api.github.com/users/bbaetz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bbaetz/subscriptions","organizations_url":"https://api.github.com/users/bbaetz/orgs","repos_url":"https://api.github.com/users/bbaetz/repos","events_url":"https://api.github.com/users/bbaetz/events{/privacy}","received_events_url":"https://api.github.com/users/bbaetz/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2015-02-27T08:30:12Z","updated_at":"2015-03-02T13:49:28Z","closed_at":"2015-03-02T13:48:28Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When merging locally and then pushing to stash (3.6.1), the hook doesn't run properly, and instead logs an error.\n\nthe problem is that https://developer.atlassian.com/static/javadoc/stash/3.7.0/api/reference/com/atlassian/stash/event/RepositoryRefsChangedEvent.html#getRefChanges%28%29 states that \"Note: While the returned collection will never be null, it may be empty. For example, a remotely merged pull request will have an empty set of changes.\" but the code does:\n\n```\nRefChange refCh = event.getRefChanges().iterator().next();\n```\n\nwhich fails when the collection is empty. (probably also related to #80, since it only pulls one ref out of the collection)\n\nNot sure what the fix is for this - its easy to just skip empty collections (or when its a PullRequestMergedEvent AND isMergedRemotely) but I'm not sure if that would miss the push entirely if that's the only event. (If we get multiple events then it would all be good - need to test; at least a few of the examples I've look at here haven't fired the Jenkins job but I need to confirm on Monday)\n\nto reproduce:\n- create a branch off a repo\n- commit to the branch\n- create a pull requst in stash\n- merge the branch to master locally\n- push\n\nStash will close the pull request as 'remotely merged' but the hook won't fire.\n\n2015-02-27 17:08:08,562 ERROR [AtlassianEvent::thread-11]  c.a.s.i.e.AsyncBatchingInvokersTransformer There was an exception thrown trying to dispatch event 'com.atlassian.stash.event.pull.PullRequestMergedEvent[source=com.atlassian.stash.internal.pull.DefaultPullRequestService@4fa699c4]' for the invoker 'SingleParameterMethodListenerInvoker{method=public void com.nerdwin15.stash.webhook.RepositoryChangeListener.onRefsChangedEvent(com.atlassian.stash.event.RepositoryRefsChangedEvent), listener=com.nerdwin15.stash.webhook.RepositoryChangeListener@56837901}'.\njava.lang.RuntimeException: java.util.NoSuchElementException\n        at com.atlassian.event.internal.SingleParameterMethodListenerInvoker.invoke(SingleParameterMethodListenerInvoker.java:50) ~[atlassian-event-2.3.5.jar:na]\n        at com.atlassian.stash.internal.event.AsyncBatchingInvokersTransformer$AsyncInvokerBatch.invoke(AsyncBatchingInvokersTransformer.java:100) ~[stash-platform-3.6.1.jar:na]\n        at com.atlassian.event.internal.AsynchronousAbleEventDispatcher$1$1.run(AsynchronousAbleEventDispatcher.java:48) [atlassian-event-2.3.5.jar:na]\n        at com.atlassian.sal.core.executor.ThreadLocalDelegateRunnable.run(ThreadLocalDelegateRunnable.java:38) [sal-core-2.13.3.jar:na]\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [na:1.7.0_55]\n        at java.lang.Thread.run(Thread.java:745) [na:1.7.0_55]\n        ... 1 frame trimmed\nCaused by: java.util.NoSuchElementException: null\n        at java.util.Collections$EmptyIterator.next(Collections.java:3006) ~[na:1.7.0_55]\n        at com.nerdwin15.stash.webhook.RepositoryChangeListener.onRefsChangedEvent(RepositoryChangeListener.java:48) ~[na:na]\n        at com.atlassian.event.internal.SingleParameterMethodListenerInvoker.invoke(SingleParameterMethodListenerInvoker.java:36) ~[atlassian-event-2.3.5.jar:na]\n        ... 6 common frames omitted\n","closed_by":{"login":"mikesir87","id":746837,"node_id":"MDQ6VXNlcjc0NjgzNw==","avatar_url":"https://avatars.githubusercontent.com/u/746837?v=4","gravatar_id":"","url":"https://api.github.com/users/mikesir87","html_url":"https://github.com/mikesir87","followers_url":"https://api.github.com/users/mikesir87/followers","following_url":"https://api.github.com/users/mikesir87/following{/other_user}","gists_url":"https://api.github.com/users/mikesir87/gists{/gist_id}","starred_url":"https://api.github.com/users/mikesir87/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikesir87/subscriptions","organizations_url":"https://api.github.com/users/mikesir87/orgs","repos_url":"https://api.github.com/users/mikesir87/repos","events_url":"https://api.github.com/users/mikesir87/events{/privacy}","received_events_url":"https://api.github.com/users/mikesir87/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/mohamicorp/stash-jenkins-postreceive-webhook/issues/108/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/mohamicorp/stash-jenkins-postreceive-webhook/issues/108/timeline","performed_via_github_app":null,"state_reason":"completed"}