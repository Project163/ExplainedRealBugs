{"url":"https://api.github.com/repos/xunit/xunit/issues/869","repository_url":"https://api.github.com/repos/xunit/xunit","labels_url":"https://api.github.com/repos/xunit/xunit/issues/869/labels{/name}","comments_url":"https://api.github.com/repos/xunit/xunit/issues/869/comments","events_url":"https://api.github.com/repos/xunit/xunit/issues/869/events","html_url":"https://github.com/xunit/xunit/issues/869","id":158500263,"node_id":"MDU6SXNzdWUxNTg1MDAyNjM=","number":869,"title":"IAsyncLifetime fixtures are potentially initialised more than once","user":{"login":"Sumo-MBryant","id":7024366,"node_id":"MDQ6VXNlcjcwMjQzNjY=","avatar_url":"https://avatars.githubusercontent.com/u/7024366?v=4","gravatar_id":"","url":"https://api.github.com/users/Sumo-MBryant","html_url":"https://github.com/Sumo-MBryant","followers_url":"https://api.github.com/users/Sumo-MBryant/followers","following_url":"https://api.github.com/users/Sumo-MBryant/following{/other_user}","gists_url":"https://api.github.com/users/Sumo-MBryant/gists{/gist_id}","starred_url":"https://api.github.com/users/Sumo-MBryant/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Sumo-MBryant/subscriptions","organizations_url":"https://api.github.com/users/Sumo-MBryant/orgs","repos_url":"https://api.github.com/users/Sumo-MBryant/repos","events_url":"https://api.github.com/users/Sumo-MBryant/events{/privacy}","received_events_url":"https://api.github.com/users/Sumo-MBryant/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":75574707,"node_id":"MDU6TGFiZWw3NTU3NDcwNw==","url":"https://api.github.com/repos/xunit/xunit/labels/Bug","name":"Bug","color":"FEF2C0","default":false,"description":"A fault in an existing feature"},{"id":241290899,"node_id":"MDU6TGFiZWwyNDEyOTA4OTk=","url":"https://api.github.com/repos/xunit/xunit/labels/Core%20framework","name":"Core framework","color":"BFD4F2","default":false,"description":"xunit.v3.core"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/xunit/xunit/milestones/25","html_url":"https://github.com/xunit/xunit/milestone/25","labels_url":"https://api.github.com/repos/xunit/xunit/milestones/25/labels","id":1877254,"node_id":"MDk6TWlsZXN0b25lMTg3NzI1NA==","number":25,"title":"2.2-beta3","description":"","creator":{"login":"bradwilson","id":16944,"node_id":"MDQ6VXNlcjE2OTQ0","avatar_url":"https://avatars.githubusercontent.com/u/16944?v=4","gravatar_id":"","url":"https://api.github.com/users/bradwilson","html_url":"https://github.com/bradwilson","followers_url":"https://api.github.com/users/bradwilson/followers","following_url":"https://api.github.com/users/bradwilson/following{/other_user}","gists_url":"https://api.github.com/users/bradwilson/gists{/gist_id}","starred_url":"https://api.github.com/users/bradwilson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bradwilson/subscriptions","organizations_url":"https://api.github.com/users/bradwilson/orgs","repos_url":"https://api.github.com/users/bradwilson/repos","events_url":"https://api.github.com/users/bradwilson/events{/privacy}","received_events_url":"https://api.github.com/users/bradwilson/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":16,"state":"closed","created_at":"2016-07-11T23:23:23Z","updated_at":"2016-10-17T19:17:51Z","due_on":null,"closed_at":"2016-10-16T20:11:57Z"},"comments":1,"created_at":"2016-06-04T11:17:45Z","updated_at":"2016-07-11T23:28:15Z","closed_at":"2016-07-11T23:27:46Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"If a test class includes more than one IAsyncLifetime implementing class fixtures, all existing class fixtures will have their `InitializeAsync()` calls re-invoked, and on test clean-up the number of calls to `InitializeAsync()` won't match the number of calls to `DisposeAsync()`.\n\nFor example, if a class includes three class fixtures `AlphaFixture`, `BetaFixture`, and `GammaFixture`. `AlphaFixture` will be invoked 3 times, `BetaFixture` twice, and `GammaFixture` once.\n\nCollection fixtures are also affected.\n\nHere is a test reproducing the bug: \n\n``` cs\nusing System;\nusing System.Threading.Tasks;\nusing Xunit;\n\nnamespace Xunit.AsyncFixture.Bug\n{\n    public class AsyncFixture<T> : IAsyncLifetime\n    {\n        public int TimesInitialised { get; set; } = 0;\n\n        public Task InitializeAsync()\n        {\n            ++TimesInitialised;\n            return Task.CompletedTask;\n        }\n\n        public Task DisposeAsync()\n        {\n            return Task.CompletedTask;\n        }\n    }\n\n    public class Alpha { }\n    public class Beta { }\n    public class Gamma { }\n\n    /// <remarks>\n    /// This test asserts that each class fixture should only have its InitializeAsync() function called once.\n    /// </remarks>\n    public class AsyncBugTests : IClassFixture<AsyncFixture<Alpha>>, IClassFixture<AsyncFixture<Beta>>, IClassFixture<AsyncFixture<Gamma>>\n    {\n        public AsyncBugTests(AsyncFixture<Alpha> alpha, AsyncFixture<Beta> beta, AsyncFixture<Gamma> gamma)\n        {\n            Assert.Equal(1, alpha.TimesInitialised);\n            Assert.Equal(1, beta.TimesInitialised);\n            Assert.Equal(1, gamma.TimesInitialised);\n        }\n\n        [Fact]\n        public void Test()\n        {\n        }\n    }\n}\n```\n\nA workaround for this issue is to create a composite test fixture that initialises each fixture only once. Another workaround would be to ignore repeated calls to `InitializeAsync()` in the fixture.\n\nA second potential bug is that async test fixtures are initialised serially and not in parallel, reducing the benefit of supporting async fixtures.\n\nI would expect following test to only take 2 seconds to execute but due to the combination of both bugs takes 5 seconds.\n\n``` cs\nusing System;\nusing System.Threading.Tasks;\nusing Xunit;\n\nnamespace Xunit.Async.TimingBug\n{\n    public class AsyncFixture<T> : IAsyncLifetime\n    {\n        public async Task InitializeAsync()\n        {\n            await Task.Delay(1000);\n        }\n\n        public async Task DisposeAsync()\n        {\n            await Task.Delay(1000);\n        }\n    }\n\n    public class Alpha { }\n    public class Beta { }\n\n    public class AsyncBugTests : IClassFixture<AsyncFixture<Alpha>>, IClassFixture<AsyncFixture<Beta>>\n    {\n        [Fact]\n        public void Test()\n        {\n        }\n    }\n}\n```\n","closed_by":{"login":"bradwilson","id":16944,"node_id":"MDQ6VXNlcjE2OTQ0","avatar_url":"https://avatars.githubusercontent.com/u/16944?v=4","gravatar_id":"","url":"https://api.github.com/users/bradwilson","html_url":"https://github.com/bradwilson","followers_url":"https://api.github.com/users/bradwilson/followers","following_url":"https://api.github.com/users/bradwilson/following{/other_user}","gists_url":"https://api.github.com/users/bradwilson/gists{/gist_id}","starred_url":"https://api.github.com/users/bradwilson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bradwilson/subscriptions","organizations_url":"https://api.github.com/users/bradwilson/orgs","repos_url":"https://api.github.com/users/bradwilson/repos","events_url":"https://api.github.com/users/bradwilson/events{/privacy}","received_events_url":"https://api.github.com/users/bradwilson/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/xunit/xunit/issues/869/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/xunit/xunit/issues/869/timeline","performed_via_github_app":null,"state_reason":"completed"}