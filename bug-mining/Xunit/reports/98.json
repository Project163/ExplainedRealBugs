{"url":"https://api.github.com/repos/xunit/xunit/issues/877","repository_url":"https://api.github.com/repos/xunit/xunit","labels_url":"https://api.github.com/repos/xunit/xunit/issues/877/labels{/name}","comments_url":"https://api.github.com/repos/xunit/xunit/issues/877/comments","events_url":"https://api.github.com/repos/xunit/xunit/issues/877/events","html_url":"https://github.com/xunit/xunit/issues/877","id":160038823,"node_id":"MDU6SXNzdWUxNjAwMzg4MjM=","number":877,"title":"MaxConcurrencySyncContext isn't always concurrent (race)...","user":{"login":"TimLovellSmith","id":2711795,"node_id":"MDQ6VXNlcjI3MTE3OTU=","avatar_url":"https://avatars.githubusercontent.com/u/2711795?v=4","gravatar_id":"","url":"https://api.github.com/users/TimLovellSmith","html_url":"https://github.com/TimLovellSmith","followers_url":"https://api.github.com/users/TimLovellSmith/followers","following_url":"https://api.github.com/users/TimLovellSmith/following{/other_user}","gists_url":"https://api.github.com/users/TimLovellSmith/gists{/gist_id}","starred_url":"https://api.github.com/users/TimLovellSmith/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimLovellSmith/subscriptions","organizations_url":"https://api.github.com/users/TimLovellSmith/orgs","repos_url":"https://api.github.com/users/TimLovellSmith/repos","events_url":"https://api.github.com/users/TimLovellSmith/events{/privacy}","received_events_url":"https://api.github.com/users/TimLovellSmith/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2016-06-13T20:35:08Z","updated_at":"2016-06-27T16:39:51Z","closed_at":"2016-06-27T16:39:51Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I noticed my CPU utilization wasn't looking very high no matter how I set parallelism with xunit 2.1 so I ran a performance analysis on my tests and if I understand my results correctly, I found that while I have many worker threads, they seem to spend a lot of time waiting on the autoreset event `MaxConcurrencySyncContext.workReady` - which suggest that either work isn't actually getting added to the work queue fast enough, or there is some bug with the usage of the autoreset event.\n\nI initially wondered if it is a problem with the usage of the autoresetevent in this code. It seems like one state that could maybe be reached that would cause inefficiency is that there might be many work items on the queue, but the queue's event might _not_ be set, and there might be worker threads which are waiting on the event. \n\nThe question is how can this state arise? I can easily think of one way, which is an initialization race condition:\n-At startup a large bunch of items could be added to the queue at startup, and event.set() gets called\n-At startup the worker threads are also just starting up, and might not yet be waiting on the event, so no threads, or perhaps just one or two threads, get unblocked and starts processing work items.\n-As long as no more work is added to the queue, no more worker threads realize there is work to do.\n\nOne way to fix the initialization race condition is to reverse the order of the code and have worker threads always check the queue at startup, then only wait on the event when they believe the queue is empty.\n\nHowever this still leaves _another_ race condition possible in theory... Suppose you have line numbers and pseudocode :\n1. check the queue\n2. wait on the event\n3. loop\n\nSuppose two threads have their instruction counter pointing at the beginning of line 2, and then two new work items are added to the queue. workReady gets set twice, but no thread can yet be woken up because no thread is waiting. Therefore, only the first thread that executes line 2 and waits on the event will actually see that work is ready, loop, and dequeue work.\n","closed_by":{"login":"bradwilson","id":16944,"node_id":"MDQ6VXNlcjE2OTQ0","avatar_url":"https://avatars.githubusercontent.com/u/16944?v=4","gravatar_id":"","url":"https://api.github.com/users/bradwilson","html_url":"https://github.com/bradwilson","followers_url":"https://api.github.com/users/bradwilson/followers","following_url":"https://api.github.com/users/bradwilson/following{/other_user}","gists_url":"https://api.github.com/users/bradwilson/gists{/gist_id}","starred_url":"https://api.github.com/users/bradwilson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bradwilson/subscriptions","organizations_url":"https://api.github.com/users/bradwilson/orgs","repos_url":"https://api.github.com/users/bradwilson/repos","events_url":"https://api.github.com/users/bradwilson/events{/privacy}","received_events_url":"https://api.github.com/users/bradwilson/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/xunit/xunit/issues/877/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/xunit/xunit/issues/877/timeline","performed_via_github_app":null,"state_reason":"completed"}