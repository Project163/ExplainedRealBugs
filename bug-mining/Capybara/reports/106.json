{"url":"https://api.github.com/repos/teamcapybara/capybara/issues/2562","repository_url":"https://api.github.com/repos/teamcapybara/capybara","labels_url":"https://api.github.com/repos/teamcapybara/capybara/issues/2562/labels{/name}","comments_url":"https://api.github.com/repos/teamcapybara/capybara/issues/2562/comments","events_url":"https://api.github.com/repos/teamcapybara/capybara/issues/2562/events","html_url":"https://github.com/teamcapybara/capybara/issues/2562","id":1261793517,"node_id":"I_kwDOAAWDXs5LNXDt","number":2562,"title":"Using switch_to_frame(some_frame) persists across tests, even when current test has finished and the browser window is closed/reset","user":{"login":"henrahmagix","id":1429026,"node_id":"MDQ6VXNlcjE0MjkwMjY=","avatar_url":"https://avatars.githubusercontent.com/u/1429026?v=4","gravatar_id":"","url":"https://api.github.com/users/henrahmagix","html_url":"https://github.com/henrahmagix","followers_url":"https://api.github.com/users/henrahmagix/followers","following_url":"https://api.github.com/users/henrahmagix/following{/other_user}","gists_url":"https://api.github.com/users/henrahmagix/gists{/gist_id}","starred_url":"https://api.github.com/users/henrahmagix/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henrahmagix/subscriptions","organizations_url":"https://api.github.com/users/henrahmagix/orgs","repos_url":"https://api.github.com/users/henrahmagix/repos","events_url":"https://api.github.com/users/henrahmagix/events{/privacy}","received_events_url":"https://api.github.com/users/henrahmagix/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-06-06T12:44:01Z","updated_at":"2022-06-12T23:45:05Z","closed_at":"2022-06-12T23:45:05Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Meta\r\nCapybara Version: 3.32.2\r\n<!-- 2.8.1? -->\r\nDriver Information (and browser if relevant): selenium-webdriver 3.142.7\r\n<!-- selenium-webdriver 2.53.4 with Firefox 47.0.1? capybara-webkit? Poltergeist? -->\r\n\r\n## Expected Behavior\r\n\r\nTest 1 visits a url with an iframe, calls `switch_to_frame(find('#test_iframe'))`, does some assertions, then ends.\r\nTest 2 visits the same url, does not switch to the iframe, and instead opens a new window and switches to it, does some assertions, then ends.\r\n\r\nBoth tests pass regardless of the order they're run in.\r\n\r\n## Actual Behavior\r\n\r\nWhen tests are run in order (1 then 2), the following error is raised when Test 2 calls `within_window`:\r\n```\r\nCapybara::ScopeError:\r\n  Window cannot be switched inside a `within_frame` block\r\n# /Users/me/.rbenv/versions/2.6.10/gemsets/my_gemset/gems/capybara-3.32.2/lib/capybara/session.rb:910:in `_switch_to_window'\r\n# /Users/me/.rbenv/versions/2.6.10/gemsets/my_gemset/gems/capybara-3.32.2/lib/capybara/session.rb:529:in `within_window'\r\n# /Users/me/.rbenv/versions/2.6.10/gemsets/my_gemset/gems/capybara-3.32.2/lib/capybara/dsl.rb:58:in `block (2 levels) in <module:DSL>'\r\n```\r\n\r\nWhen tests are run in reverse order (2 then 1), no error is raised.\r\n\r\n## Steps to reproduce\r\n<!--\r\nPlease be sure to include the code that is creating the issue along with HTML the code is being run against\r\n-->\r\nRun the following suite with RSpec and Capybara and a browser driver capable of executing JavaScript, with the tests run in order of defined. It should all pass, but the third test fails as per above.\r\n\r\nThe tests \"1\" and \"2\" explained above are the second and third tests in this file below; I added the third test at the start just to confirm that the method by which I'm opening and switching to a new actually works (which it does).\r\n\r\n`bundle exec rspec --order=defined this_test_suite_spec.rb`\r\n```rb\r\n# this_test_suite_spec.rb\r\ndescribe 'visiting example.com and inserting an iframe' do\r\n\r\n  before do\r\n    visit 'http://example.com:80'\r\n    execute_script(\"document.body.innerHTML = '<iframe id=\\\"test_iframe\\\" src=\\\"http://example.com:80\\\"></iframe>';\")\r\n\r\n    if in_iframe\r\n      switch_to_frame(find('#test_iframe'))\r\n    end\r\n  end\r\n\r\n  context 'when not in iframe' do\r\n    let(:in_iframe) { false }\r\n\r\n    it 'can open a new window' do\r\n      expect do\r\n        within_window(open_new_window) { puts \"this will pass\" }\r\n      end.not_to raise_error\r\n    end\r\n  end\r\n\r\n  context 'when in iframe' do\r\n    let(:in_iframe) { true }\r\n\r\n    it 'cannot open a new window' do\r\n      expect do\r\n        within_window(open_new_window) { puts \"this will fail\" }\r\n      end.to raise_error(Capybara::ScopeError, 'Window cannot be switched inside a `within_frame` block')\r\n    end\r\n  end\r\n\r\n  context 'when not in iframe after being in iframe' do\r\n    let(:in_iframe) { false }\r\n\r\n    it 'can open a new window' do\r\n      expect do\r\n        within_window(open_new_window) { puts \"this should pass even though the previous test switches to an iframe and does not switch back\" }\r\n      end.not_to raise_error\r\n    end\r\n  end\r\nend\r\n```\r\n","closed_by":{"login":"twalpole","id":16556,"node_id":"MDQ6VXNlcjE2NTU2","avatar_url":"https://avatars.githubusercontent.com/u/16556?v=4","gravatar_id":"","url":"https://api.github.com/users/twalpole","html_url":"https://github.com/twalpole","followers_url":"https://api.github.com/users/twalpole/followers","following_url":"https://api.github.com/users/twalpole/following{/other_user}","gists_url":"https://api.github.com/users/twalpole/gists{/gist_id}","starred_url":"https://api.github.com/users/twalpole/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/twalpole/subscriptions","organizations_url":"https://api.github.com/users/twalpole/orgs","repos_url":"https://api.github.com/users/twalpole/repos","events_url":"https://api.github.com/users/twalpole/events{/privacy}","received_events_url":"https://api.github.com/users/twalpole/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/teamcapybara/capybara/issues/2562/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/teamcapybara/capybara/issues/2562/timeline","performed_via_github_app":null,"state_reason":"completed"}