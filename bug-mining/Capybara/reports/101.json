{"url":"https://api.github.com/repos/teamcapybara/capybara/issues/2227","repository_url":"https://api.github.com/repos/teamcapybara/capybara","labels_url":"https://api.github.com/repos/teamcapybara/capybara/issues/2227/labels{/name}","comments_url":"https://api.github.com/repos/teamcapybara/capybara/issues/2227/comments","events_url":"https://api.github.com/repos/teamcapybara/capybara/issues/2227/events","html_url":"https://github.com/teamcapybara/capybara/issues/2227","id":464880245,"node_id":"MDU6SXNzdWU0NjQ4ODAyNDU=","number":2227,"title":"Capybara hangs with multiple drivers if there are not enough threads","user":{"login":"trcarden","id":460530,"node_id":"MDQ6VXNlcjQ2MDUzMA==","avatar_url":"https://avatars.githubusercontent.com/u/460530?v=4","gravatar_id":"","url":"https://api.github.com/users/trcarden","html_url":"https://github.com/trcarden","followers_url":"https://api.github.com/users/trcarden/followers","following_url":"https://api.github.com/users/trcarden/following{/other_user}","gists_url":"https://api.github.com/users/trcarden/gists{/gist_id}","starred_url":"https://api.github.com/users/trcarden/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/trcarden/subscriptions","organizations_url":"https://api.github.com/users/trcarden/orgs","repos_url":"https://api.github.com/users/trcarden/repos","events_url":"https://api.github.com/users/trcarden/events{/privacy}","received_events_url":"https://api.github.com/users/trcarden/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2019-07-06T18:40:35Z","updated_at":"2019-08-22T17:13:50Z","closed_at":"2019-07-08T17:59:01Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Meta\r\nCapybara Version: 3.25.0\r\nDriver Information Latest ChromeDriver on Chrome 75\r\nPuma:  4.0.0\r\n## Expected Behavior\r\n\r\nI can run the test suite successfully\r\n\r\n## Actual Behavior\r\n\r\nThe test suite errors out with `Net::ReadTimeout with #<TCPSocket:(closed)>` or sometimes `Net::OpenTimeout`\r\n\r\n```bash\r\n  # [Redacted]/gems/webmock-3.5.1/lib/webmock/http_lib_adapters/net_http.rb:136:in `start_with_connect_without_finish'\r\n  # [Redacted]/gems/webmock-3.5.1/lib/webmock/http_lib_adapters/net_http.rb:104:in `request'\r\n  # [Redacted]/gems/capybara-3.25.0/lib/capybara/server.rb:54:in `block in responsive?'\r\n  # [Redacted]/gems/webmock-3.5.1/lib/webmock/http_lib_adapters/net_http.rb:123:in `start_without_connect'\r\n  # [Redacted]/gems/webmock-3.5.1/lib/webmock/http_lib_adapters/net_http.rb:150:in `start'\r\n  # [Redacted]/gems/capybara-3.25.0/lib/capybara/server/checker.rb:36:in `make_request'\r\n  # [Redacted]/gems/capybara-3.25.0/lib/capybara/server/checker.rb:32:in `https_request'\r\n  # [Redacted]/gems/capybara-3.25.0/lib/capybara/server/checker.rb:16:in `rescue in request'\r\n  # [Redacted]/gems/capybara-3.25.0/lib/capybara/server/checker.rb:13:in `request'\r\n  # [Redacted]/gems/capybara-3.25.0/lib/capybara/server.rb:54:in `responsive?'\r\n  # [Redacted]/gems/capybara-3.25.0/lib/capybara/server.rb:71:in `boot'\r\n  # [Redacted]/gems/capybara-3.25.0/lib/capybara/session.rb:91:in `initialize'\r\n  # [Redacted]/gems/capybara-3.25.0/lib/capybara.rb:415:in `new'\r\n  # [Redacted]/gems/capybara-3.25.0/lib/capybara.rb:415:in `block in session_pool'\r\n  # [Redacted]/gems/capybara-3.25.0/lib/capybara.rb:312:in `current_session'\r\n  # [Redacted]/gems/capybara-3.25.0/lib/capybara/dsl.rb:46:in `page'\r\n  # [Redacted]/gems/capybara-3.25.0/lib/capybara/dsl.rb:51:in `block (2 levels) in <module:DSL>'\r\n  # ./spec/system/store/widget_spec.rb:21:in `block (3 levels) in <main>'\r\n  # ./spec/rails_helper.rb:254:in `block (2 levels) in <top (required)>'\r\n  # ------------------\r\n  # --- Caused by: ---\r\n  # Net::ReadTimeout:\r\n  #   Net::ReadTimeout with #<TCPSocket:(closed)>\r\n  #   [Redacted]/gems/webmock-3.5.1/lib/webmock/http_lib_adapters/net_http.rb:284:in `rbuf_fill'\r\n```\r\n\r\n## Steps to reproduce\r\n\r\n1. Create a test suite with 3 or more drivers (say one for chrome with iOS emulation, one with Android emulation and one for desktop -- you can use any drivers you want but just need to be 3 different registered drivers)\r\n\r\n2. Enable SSL with Capybara using technique found here (https://github.com/teamcapybara/capybara/pull/2028). \r\n\r\n3. Run suite and wait for the timeouts\r\n\r\n## Example 3 drivers\r\n\r\n```ruby\r\nCapybara.register_driver :chrome do |app|\r\n  options = Selenium::WebDriver::Chrome::Options.new\r\n  options.add_argument('--window-size=1400,1400')\r\n  Capybara::Selenium::Driver.new(app, browser: :chrome, options: options)\r\nend\r\n\r\nCapybara.register_driver :chrome2 do |app|\r\n  options = Selenium::WebDriver::Chrome::Options.new\r\n  options.add_argument('--window-size=1920,1080')\r\n  Capybara::Selenium::Driver.new(app, browser: :chrome, options: options)\r\nend\r\n\r\nCapybara.register_driver :chrome3 do |app|\r\n  options = Selenium::WebDriver::Chrome::Options.new\r\n  options.add_emulation(device_name: 'Pixel 2')\r\n  Capybara::Selenium::Driver.new(app, browser: :chrome, options: options)\r\nend\r\n```\r\n\r\n## Example suite\r\n\r\n```ruby\r\ndescribe 'Thing' do\r\n  context 'chrome' do\r\n    before do\r\n      Capybara.current_driver = :chrome\r\n      visit root_path\r\n    end\r\n\r\n    it 'truth' do\r\n      expect(true).to be_truthy\r\n    end\r\n  end\r\n\r\n  context 'chrome2' do\r\n    before do\r\n      Capybara.current_driver = :chrome2\r\n      visit root_path\r\n    end\r\n\r\n    it 'truth' do\r\n      expect(true).to be_truthy\r\n    end\r\n  end\r\n\r\n  context 'chrome3' do\r\n    before do\r\n      Capybara.current_driver = :chrome3\r\n      visit root_path\r\n    end\r\n\r\n    it 'truth' do\r\n      expect(true).to be_truthy\r\n    end\r\n  end\r\n\r\nend\r\n```\r\n\r\n## Leads\r\n\r\nI noticed when we boot a capybara session using SSL you get this:\r\n```ruby\r\nError in reactor loop escaped: System error: Undefined error: 0 - 0 (Puma::MiniSSL::SSLError)\r\n[Redacted]/gems/puma-4.0.0/lib/puma/minissl.rb:43:in `read'\r\n[Redacted]/gems/puma-4.0.0/lib/puma/minissl.rb:43:in `engine_read_all'\r\n[Redacted]/gems/puma-4.0.0/lib/puma/minissl.rb:54:in `read_nonblock'\r\n[Redacted]/gems/puma-4.0.0/lib/puma/minissl.rb:129:in `read_and_drop'\r\n[Redacted]/gems/puma-4.0.0/lib/puma/minissl.rb:146:in `close'\r\n[Redacted]/gems/puma-4.0.0/lib/puma/client.rb:138:in `close'\r\n[Redacted]/gems/puma-4.0.0/lib/puma/reactor.rb:265:in `rescue in block in run_internal'\r\n[Redacted]/gems/puma-4.0.0/lib/puma/reactor.rb:218:in `block in run_internal'\r\n[Redacted]/gems/puma-4.0.0/lib/puma/reactor.rb:157:in `each'\r\n[Redacted]/gems/puma-4.0.0/lib/puma/reactor.rb:157:in `run_internal'\r\n[Redacted]/gems/puma-4.0.0/lib/puma/reactor.rb:311:in `block in run_in_thread'\r\n```\r\n\r\nI also notice from time to time that Puma keeps connections open for a long time and prevents terminating the server even if the webpage is fully loaded. \r\n\r\nI also noticed if you revert back to just HTTP this doesn't happen (at least not at 3 drivers, maybe at a higher level).\r\n\r\nTaken together my hypothesis was that we were using up all the threads on the server (either with stale connections, or not having enough connections to begin with for the number of drivers specified for usage -- especially if we make a HTTP request, fail and then make a HTTPS request like it looks like we are doing).\r\n\r\n## Workaround\r\n\r\n### Option 1\r\n\r\n```ruby\r\nconfig.after :each do\r\n  Capybara.current_session.driver.quit\r\nend\r\n```\r\nIf I shutdown the browsers after each test everything seems to work. Which lead me to believe that the server's default 4 threads might be an issue\r\n\r\n### Option 2\r\n```ruby\r\nCapybara.configure do |config|\r\n  key_file = Rails.root.join('config', 'certs', 'insecure.key')\r\n  cert_file = Rails.root.join('config', 'certs', 'insecure.crt')\r\n  config.server = :puma, {\r\n    Host: \"ssl://#{Capybara.server_host}?key=#{key_file}&cert=#{cert_file}\",\r\n    Threads: '0:10'\r\n  }\r\nend\r\n```\r\n\r\nIncreasing the max thread count also seemed to resolve the issue.\r\n\r\n## Idea\r\n\r\nMaybe some combo of increasing the default number of threads and shutting down drivers if there are more than a few open would help resolve the issue.\r\n\r\n\r\n\r\n\r\n","closed_by":{"login":"twalpole","id":16556,"node_id":"MDQ6VXNlcjE2NTU2","avatar_url":"https://avatars.githubusercontent.com/u/16556?v=4","gravatar_id":"","url":"https://api.github.com/users/twalpole","html_url":"https://github.com/twalpole","followers_url":"https://api.github.com/users/twalpole/followers","following_url":"https://api.github.com/users/twalpole/following{/other_user}","gists_url":"https://api.github.com/users/twalpole/gists{/gist_id}","starred_url":"https://api.github.com/users/twalpole/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/twalpole/subscriptions","organizations_url":"https://api.github.com/users/twalpole/orgs","repos_url":"https://api.github.com/users/twalpole/repos","events_url":"https://api.github.com/users/twalpole/events{/privacy}","received_events_url":"https://api.github.com/users/twalpole/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/teamcapybara/capybara/issues/2227/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/teamcapybara/capybara/issues/2227/timeline","performed_via_github_app":null,"state_reason":"completed"}