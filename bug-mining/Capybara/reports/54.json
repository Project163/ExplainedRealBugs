{"url":"https://api.github.com/repos/teamcapybara/capybara/issues/725","repository_url":"https://api.github.com/repos/teamcapybara/capybara","labels_url":"https://api.github.com/repos/teamcapybara/capybara/issues/725/labels{/name}","comments_url":"https://api.github.com/repos/teamcapybara/capybara/issues/725/comments","events_url":"https://api.github.com/repos/teamcapybara/capybara/issues/725/events","html_url":"https://github.com/teamcapybara/capybara/issues/725","id":4963604,"node_id":"MDU6SXNzdWU0OTYzNjA0","number":725,"title":"Nested calls to synchronize cause exponential delays (retries**2)","user":{"login":"TylerRick","id":14151,"node_id":"MDQ6VXNlcjE0MTUx","avatar_url":"https://avatars.githubusercontent.com/u/14151?v=4","gravatar_id":"","url":"https://api.github.com/users/TylerRick","html_url":"https://github.com/TylerRick","followers_url":"https://api.github.com/users/TylerRick/followers","following_url":"https://api.github.com/users/TylerRick/following{/other_user}","gists_url":"https://api.github.com/users/TylerRick/gists{/gist_id}","starred_url":"https://api.github.com/users/TylerRick/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TylerRick/subscriptions","organizations_url":"https://api.github.com/users/TylerRick/orgs","repos_url":"https://api.github.com/users/TylerRick/repos","events_url":"https://api.github.com/users/TylerRick/events{/privacy}","received_events_url":"https://api.github.com/users/TylerRick/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":37720,"node_id":"MDU6TGFiZWwzNzcyMA==","url":"https://api.github.com/repos/teamcapybara/capybara/labels/Bug","name":"Bug","color":"f00808","default":false,"description":null}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/teamcapybara/capybara/milestones/5","html_url":"https://github.com/teamcapybara/capybara/milestone/5","labels_url":"https://api.github.com/repos/teamcapybara/capybara/milestones/5/labels","id":32502,"node_id":"MDk6TWlsZXN0b25lMzI1MDI=","number":5,"title":"Capybara 2.0","description":"","creator":{"login":"jnicklas","id":134,"node_id":"MDQ6VXNlcjEzNA==","avatar_url":"https://avatars.githubusercontent.com/u/134?v=4","gravatar_id":"","url":"https://api.github.com/users/jnicklas","html_url":"https://github.com/jnicklas","followers_url":"https://api.github.com/users/jnicklas/followers","following_url":"https://api.github.com/users/jnicklas/following{/other_user}","gists_url":"https://api.github.com/users/jnicklas/gists{/gist_id}","starred_url":"https://api.github.com/users/jnicklas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jnicklas/subscriptions","organizations_url":"https://api.github.com/users/jnicklas/orgs","repos_url":"https://api.github.com/users/jnicklas/repos","events_url":"https://api.github.com/users/jnicklas/events{/privacy}","received_events_url":"https://api.github.com/users/jnicklas/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":10,"state":"closed","created_at":"2011-08-30T09:21:56Z","updated_at":"2012-10-30T16:35:34Z","due_on":null,"closed_at":"2012-10-30T16:35:34Z"},"comments":4,"created_at":"2012-06-08T02:51:57Z","updated_at":"2019-08-17T14:14:19Z","closed_at":"2012-07-12T14:21:35Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### 128-second hangs before finally failing with `ElementNotFound`\n\nI've noticed that sometimes capybara will **appear to hang forever** (it's not actually forever but it's a really long time) when it looks for an element and can't find it. This is pretty frustrating when my cucumber test run just hangs indefinitely for no apparent reason.\n\nA [simple test scenario](https://github.com/TylerRick/capybara_nested_synchronize_bug/blob/master/features/step_definitions/reproduce_bug_steps.rb) that _should_ only take about [`11 s`](https://gist.github.com/2893016) to fail ends up taking a whopping [`128 s`](https://gist.github.com/2892966) before it finally fails with a `Capybara::ElementNotFound` error !\n\n(In my case, I'm actually doing something where I _expect_ it to not find the element, so I have to wait that long before I can rescue the `Capybara::ElementNotFound` error and move on with the rest of my test...)\n\nAfter hours of debugging, I managed to distill this down to a [reproducible scenario](https://github.com/TylerRick/capybara_nested_synchronize_bug). But I still don't understand completely what's going on...\n\nIt seems to be the combination of `within` and a `find` that it doesn't like... although I've done  `find`s inside of `within`s  without problems before so I don't know what exactly is wrong with this scenario...\n## So what's going on?\n\nFrom what I can tell, it looks like this code in synchronize that is supposed to retry a search query a certain number of times (40), ends up getting called somewhat recursively and so it ends up retrying the query 40*40 times:\n\n``` ruby\n      def synchronize(seconds=Capybara.default_wait_time)\n        retries = (seconds.to_f / 0.05).round\n\n        begin\n          yield\n        rescue => e\n          raise e unless driver.wait?\n          raise e unless driver.invalid_element_errors.include?(e.class) or e.is_a?(Capybara::ElementNotFound)\n          raise e if retries.zero?\n          sleep(0.05)\n          reload if Capybara.automatic_reload\n          retries -= 1\n          retry\n        end\n      end\n```\n\nInstead of just doing `retries` number of retries (`Capybara.default_wait_time / 0.05` == `40` in my case) , it appears to be doing approximately `retries**2` (`40**2` == `1600`) number of retries!\n## Debug output\n\nYou can observe this in the output from running rake cucumber with some debug output added (see [workaround.rb](https://github.com/TylerRick/capybara_nested_synchronize_bug/blob/master/lib/workaround.rb) for the debugging code that created the output and [gist](https://gist.github.com/2892966) for the full output)...\n\nThe first section (before the \"=========\") shows how it is _supposed_ to work, and does normally work... You can see the retries number counting from 40 all the way down to 0.\n\nThe second section (after the \"=========\") shows what happens when it _doesn't_ work how I think it's supposed to work... You can see the retries number from the **inner loop** (lines starting with 1) counting from 40 all the way down to 0. But as soon as the inner loop completes, the **outer loop** (lines starting with 0) begin counting down, each time executing the inner loop all over again...\n\n```\nfirst number indicates the nesting level\n\\/\n1 retries=1 e=#<Capybara::ElementNotFound: no select box with id, name, or label 'select_that_doesnt_exist' found>\n1 retries=0 e=#<Capybara::ElementNotFound: no select box with id, name, or label 'select_that_doesnt_exist' found>\n0 retries=40 e=#<Capybara::ElementNotFound: no select box with id, name, or label 'select_that_doesnt_exist' found>\n1 retries=40 e=#<Capybara::ElementNotFound: no select box with id, name, or label 'select_that_doesnt_exist' found>\n1 retries=39 e=#<Capybara::ElementNotFound: no select box with id, name, or label 'select_that_doesnt_exist' found>\n1 retries=38 e=#<Capybara::ElementNotFound: no select box with id, name, or label 'select_that_doesnt_exist' found>\n...\n```\n\nHere's a [gist](https://gist.github.com/2892996) showing the relevant lines from `caller` that show where synchronize is being called.\n## Workaround\n\nMy [workaround](https://github.com/TylerRick/capybara_nested_synchronize_bug/blob/master/lib/workaround.rb) basically involved preventing the **inner** loops from looping at all if it detected we were already in an **outer** synchronize retry \"loop\"\n\nBasically I just changed:\n\n``` ruby\n          raise e if retries.zero?\n```\n\nto:\n\n``` ruby\n          raise e if retries.zero? or @synchronize_nesting > 0\n```\n## Solution?\n\nMy workaround probably isn't the correct solution to the problem, since I don't really understand what's going on but it seems to at least fix the problem for me...\n\nCan you please provide/suggest a better solution or tell me what I'm doing wrong?\n\n(Note: This only affects the Selenium Webdriver driver, of course, not Rack Test.)\n","closed_by":{"login":"jnicklas","id":134,"node_id":"MDQ6VXNlcjEzNA==","avatar_url":"https://avatars.githubusercontent.com/u/134?v=4","gravatar_id":"","url":"https://api.github.com/users/jnicklas","html_url":"https://github.com/jnicklas","followers_url":"https://api.github.com/users/jnicklas/followers","following_url":"https://api.github.com/users/jnicklas/following{/other_user}","gists_url":"https://api.github.com/users/jnicklas/gists{/gist_id}","starred_url":"https://api.github.com/users/jnicklas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jnicklas/subscriptions","organizations_url":"https://api.github.com/users/jnicklas/orgs","repos_url":"https://api.github.com/users/jnicklas/repos","events_url":"https://api.github.com/users/jnicklas/events{/privacy}","received_events_url":"https://api.github.com/users/jnicklas/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/teamcapybara/capybara/issues/725/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/teamcapybara/capybara/issues/725/timeline","performed_via_github_app":null,"state_reason":"completed"}