{"url":"https://api.github.com/repos/teamcapybara/capybara/issues/632","repository_url":"https://api.github.com/repos/teamcapybara/capybara","labels_url":"https://api.github.com/repos/teamcapybara/capybara/issues/632/labels{/name}","comments_url":"https://api.github.com/repos/teamcapybara/capybara/issues/632/comments","events_url":"https://api.github.com/repos/teamcapybara/capybara/issues/632/events","html_url":"https://github.com/teamcapybara/capybara/issues/632","id":3086492,"node_id":"MDU6SXNzdWUzMDg2NDky","number":632,"title":"Only reset sessions if they've been used?","user":{"login":"jdelStrother","id":2377,"node_id":"MDQ6VXNlcjIzNzc=","avatar_url":"https://avatars.githubusercontent.com/u/2377?v=4","gravatar_id":"","url":"https://api.github.com/users/jdelStrother","html_url":"https://github.com/jdelStrother","followers_url":"https://api.github.com/users/jdelStrother/followers","following_url":"https://api.github.com/users/jdelStrother/following{/other_user}","gists_url":"https://api.github.com/users/jdelStrother/gists{/gist_id}","starred_url":"https://api.github.com/users/jdelStrother/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdelStrother/subscriptions","organizations_url":"https://api.github.com/users/jdelStrother/orgs","repos_url":"https://api.github.com/users/jdelStrother/repos","events_url":"https://api.github.com/users/jdelStrother/events{/privacy}","received_events_url":"https://api.github.com/users/jdelStrother/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2012-02-03T17:56:22Z","updated_at":"2019-08-17T22:14:16Z","closed_at":"2012-07-10T08:06:19Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi,\n\nI introduced some :js specs into our spec suite recently and found our spec run times increased way more than I'd expect.  After looking into it, I think it's caused by Capybara.reset_sessions! being a bit over-eager.  For example, if I run a :js test (resulting in capybara adding a Selenium session to its session_pool), any subsequent controller specs (which will call session.reset! on all session_pool sessions) result in Selenium clearing cookies and visiting about:blank, on each individual example, despite them using the regular Rack driver rather than the selenium one.\n\nHow about keeping track of which sessions have been accessed and only resetting those ones at the end of each example?  AFAICT, the only public way to access a session is via Capybara.current_session, in which case something like this would be sufficient - \n\n``` diff\n\ndiff --git a/lib/capybara.rb b/lib/capybara.rb\nindex f1203de..73a8fd9 100644\n--- a/lib/capybara.rb\n+++ b/lib/capybara.rb\n@@ -248,7 +248,17 @@ module Capybara\n     # @return [Capybara::Session]     The currently used session\n     #\n     def current_session\n-      session_pool[\"#{current_driver}:#{session_name}:#{app.object_id}\"] ||= Capybara::Session.new(current_driver, app)\n+      session = (session_pool[\"#{current_driver}:#{session_name}:#{app.object_id}\"] ||= Capybara::Session.new(current_driver, app))\n+      sessions_to_reset << session\n+      session\n+    end\n+\n+    ##\n+    #\n+    # The list of sessions that will need resetting next time reset_sessions is called\n+    #\n+    def sessions_to_reset\n+      @sessions_to_reset ||= Set.new\n     end\n\n     ##\n@@ -257,7 +267,8 @@ module Capybara\n     # as cookies.\n     #\n     def reset_sessions!\n-      session_pool.each { |mode, session| session.reset! }\n+      sessions_to_reset.each{ |session| session.reset! }\n+      sessions_to_reset.clear\n     end\n     alias_method :reset!, :reset_sessions!\n\n```\n\nThis cuts our 4-minute spec-suite back down to around 3 minutes, or a saving of nearly 0.1s per example.  WDYT?\n","closed_by":{"login":"jnicklas","id":134,"node_id":"MDQ6VXNlcjEzNA==","avatar_url":"https://avatars.githubusercontent.com/u/134?v=4","gravatar_id":"","url":"https://api.github.com/users/jnicklas","html_url":"https://github.com/jnicklas","followers_url":"https://api.github.com/users/jnicklas/followers","following_url":"https://api.github.com/users/jnicklas/following{/other_user}","gists_url":"https://api.github.com/users/jnicklas/gists{/gist_id}","starred_url":"https://api.github.com/users/jnicklas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jnicklas/subscriptions","organizations_url":"https://api.github.com/users/jnicklas/orgs","repos_url":"https://api.github.com/users/jnicklas/repos","events_url":"https://api.github.com/users/jnicklas/events{/privacy}","received_events_url":"https://api.github.com/users/jnicklas/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/teamcapybara/capybara/issues/632/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/teamcapybara/capybara/issues/632/timeline","performed_via_github_app":null,"state_reason":"completed"}