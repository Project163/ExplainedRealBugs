diff --git a/.changeset/rotten-walls-itch.md b/.changeset/rotten-walls-itch.md
new file mode 100644
index 000000000..29e94df7c
--- /dev/null
+++ b/.changeset/rotten-walls-itch.md
@@ -0,0 +1,5 @@
+---
+'@sveltejs/kit': patch
+---
+
+fix: set environment variables before postbuild analysis
diff --git a/packages/kit/src/core/env.js b/packages/kit/src/core/env.js
index 9dc66f55a..5b2c56bbb 100644
--- a/packages/kit/src/core/env.js
+++ b/packages/kit/src/core/env.js
@@ -44,7 +44,7 @@ export function create_dynamic_module(type, dev_values) {
 		);
 		return `export const env = {\n${keys.join(',\n')}\n}`;
 	}
-	return `export { env } from '${runtime_base}/env-${type}.js';`;
+	return `export { ${type}_env as env } from '${runtime_base}/shared.js';`;
 }
 
 /**
diff --git a/packages/kit/src/core/postbuild/index.js b/packages/kit/src/core/postbuild/index.js
index d62bcdae9..05424a242 100644
--- a/packages/kit/src/core/postbuild/index.js
+++ b/packages/kit/src/core/postbuild/index.js
@@ -10,7 +10,8 @@ import {
 import { load_config } from '../config/index.js';
 import { prerender } from './prerender.js';
 
-const [, , client_out_dir, manifest_path, results_path, verbose, env] = process.argv;
+const [, , client_out_dir, manifest_path, results_path, verbose, env_json] = process.argv;
+const env = JSON.parse(env_json);
 
 /** @type {import('types').SSRManifest} */
 const manifest = (await import(pathToFileURL(manifest_path).href)).manifest;
@@ -33,6 +34,12 @@ const { Server } = await import(pathToFileURL(`${server_root}/server/index.js`).
 // essential we do this before analysing the code
 internal.set_building(true);
 
+// set env, in case it's used in initialisation
+const entries = Object.entries(env);
+const prefix = config.env.publicPrefix;
+internal.set_private_env(Object.fromEntries(entries.filter(([k]) => !k.startsWith(prefix))));
+internal.set_public_env(Object.fromEntries(entries.filter(([k]) => k.startsWith(prefix))));
+
 // analyse routes
 for (const route of manifest._.routes) {
 	if (route.endpoint) {
diff --git a/packages/kit/src/core/postbuild/prerender.js b/packages/kit/src/core/postbuild/prerender.js
index fb65f48b3..4af035800 100644
--- a/packages/kit/src/core/postbuild/prerender.js
+++ b/packages/kit/src/core/postbuild/prerender.js
@@ -50,7 +50,7 @@ const REDIRECT = 3;
  *   prerender_map: import('types').PrerenderMap;
  *   client_out_dir: string;
  *   verbose: string;
- *   env: string;
+ *   env: Record<string, string>;
  * }} opts
  * @returns
  */
@@ -92,7 +92,7 @@ export async function prerender({
 	internal.set_paths(config.paths);
 
 	const server = new Server(manifest);
-	await server.init({ env: JSON.parse(env) });
+	await server.init({ env });
 
 	const handle_http_error = normalise_error_handler(
 		log,
diff --git a/packages/kit/src/core/sync/write_server.js b/packages/kit/src/core/sync/write_server.js
index 6cb05a8ee..1b80f7a5a 100644
--- a/packages/kit/src/core/sync/write_server.js
+++ b/packages/kit/src/core/sync/write_server.js
@@ -24,7 +24,7 @@ const server_template = ({
 	error_page
 }) => `
 import root from './root.svelte';
-import { set_building, set_paths, set_version } from '${runtime_directory}/shared.js';
+import { set_building, set_paths, set_private_env, set_public_env, set_version } from '${runtime_directory}/shared.js';
 
 set_paths(${s(config.kit.paths)});
 set_version(${s(config.kit.version.name)});
@@ -57,7 +57,7 @@ export function get_hooks() {
 	return ${hooks ? `import(${s(hooks)})` : '{}'};
 }
 
-export { set_building, set_paths };
+export { set_building, set_paths, set_private_env, set_public_env };
 `;
 
 // TODO need to re-run this whenever src/app.html or src/error.html are
diff --git a/packages/kit/src/runtime/client/start.js b/packages/kit/src/runtime/client/start.js
index b9f3e4d75..1083898a9 100644
--- a/packages/kit/src/runtime/client/start.js
+++ b/packages/kit/src/runtime/client/start.js
@@ -1,8 +1,7 @@
 import { DEV } from 'esm-env';
 import { create_client } from './client.js';
 import { init } from './singletons.js';
-import { set_paths, set_version } from '../shared.js';
-import { set_public_env } from '../env-public.js';
+import { set_paths, set_version, set_public_env } from '../shared.js';
 
 /**
  * @param {{
diff --git a/packages/kit/src/runtime/env-private.js b/packages/kit/src/runtime/env-private.js
deleted file mode 100644
index 7352ceb17..000000000
--- a/packages/kit/src/runtime/env-private.js
+++ /dev/null
@@ -1,6 +0,0 @@
-export let env = {};
-
-/** @type {(environment: Record<string, string>) => void} */
-export function set_private_env(environment) {
-	env = environment;
-}
diff --git a/packages/kit/src/runtime/env-public.js b/packages/kit/src/runtime/env-public.js
deleted file mode 100644
index 800f6262a..000000000
--- a/packages/kit/src/runtime/env-public.js
+++ /dev/null
@@ -1,7 +0,0 @@
-/** @type {Record<string, string>} */
-export let env = {};
-
-/** @type {(environment: Record<string, string>) => void} */
-export function set_public_env(environment) {
-	env = environment;
-}
diff --git a/packages/kit/src/runtime/env/dynamic/private.js b/packages/kit/src/runtime/env/dynamic/private.js
index 971d61ed5..d05b2fd8b 100644
--- a/packages/kit/src/runtime/env/dynamic/private.js
+++ b/packages/kit/src/runtime/env/dynamic/private.js
@@ -1 +1 @@
-export { env } from '../../env-private.js';
+export { private_env as env } from '../../shared.js';
diff --git a/packages/kit/src/runtime/env/dynamic/public.js b/packages/kit/src/runtime/env/dynamic/public.js
index 34dc1950b..ba6c33230 100644
--- a/packages/kit/src/runtime/env/dynamic/public.js
+++ b/packages/kit/src/runtime/env/dynamic/public.js
@@ -1 +1 @@
-export { env } from '../../env-public.js';
+export { public_env as env } from '../../shared.js';
diff --git a/packages/kit/src/runtime/server/index.js b/packages/kit/src/runtime/server/index.js
index 7290beaf3..cd2db2db8 100644
--- a/packages/kit/src/runtime/server/index.js
+++ b/packages/kit/src/runtime/server/index.js
@@ -1,6 +1,5 @@
 import { respond } from './respond.js';
-import { set_private_env } from '../env-private.js';
-import { set_public_env } from '../env-public.js';
+import { set_private_env, set_public_env } from '../shared.js';
 import { options, get_hooks } from '__GENERATED__/server-internal.js';
 
 export class Server {
diff --git a/packages/kit/src/runtime/server/page/render.js b/packages/kit/src/runtime/server/page/render.js
index 55bba9a9d..9c911ebb1 100644
--- a/packages/kit/src/runtime/server/page/render.js
+++ b/packages/kit/src/runtime/server/page/render.js
@@ -7,8 +7,7 @@ import { s } from '../../../utils/misc.js';
 import { Csp } from './csp.js';
 import { uneval_action_response } from './actions.js';
 import { clarify_devalue_error } from '../utils.js';
-import { assets, base, version } from '../../shared.js';
-import { env } from '../../env-public.js';
+import { assets, base, version, public_env } from '../../shared.js';
 import { text } from '../../../exports/index.js';
 
 // TODO rename this function/module
@@ -258,7 +257,7 @@ export async function render_response({
 
 	if (page_config.csr) {
 		const opts = [
-			`env: ${s(env)}`,
+			`env: ${s(public_env)}`,
 			`paths: ${s({ assets, base })}`,
 			`target: document.querySelector('[data-sveltekit-hydrate="${target}"]').parentNode`,
 			`version: ${s(version)}`
@@ -368,7 +367,7 @@ export async function render_response({
 		body,
 		assets: resolved_assets,
 		nonce: /** @type {string} */ (csp.nonce),
-		env
+		env: public_env
 	});
 
 	// TODO flush chunks as early as we can
diff --git a/packages/kit/src/runtime/shared.js b/packages/kit/src/runtime/shared.js
index 277ab3656..0cb8fd91d 100644
--- a/packages/kit/src/runtime/shared.js
+++ b/packages/kit/src/runtime/shared.js
@@ -3,6 +3,12 @@ export let base = '';
 export let building = false;
 export let version = '';
 
+/** @type {Record<string, string>} */
+export let private_env = {};
+
+/** @type {Record<string, string>} */
+export let public_env = {};
+
 /** @param {string} stack */
 export let fix_stack_trace = (stack) => stack;
 
@@ -17,6 +23,16 @@ export function set_building(value) {
 	building = value;
 }
 
+/** @type {(environment: Record<string, string>) => void} */
+export function set_private_env(environment) {
+	private_env = environment;
+}
+
+/** @type {(environment: Record<string, string>) => void} */
+export function set_public_env(environment) {
+	public_env = environment;
+}
+
 /** @param {string} value */
 export function set_version(value) {
 	version = value;
diff --git a/packages/kit/test/apps/basics/.env b/packages/kit/test/apps/basics/.env
index a406fc245..9bfc91723 100644
--- a/packages/kit/test/apps/basics/.env
+++ b/packages/kit/test/apps/basics/.env
@@ -5,3 +5,5 @@ PUBLIC_STATIC="accessible anywhere/replaced at build time"
 PUBLIC_DYNAMIC="accessible anywhere/evaluated at run time"
 
 PUBLIC_THEME="groovy"
+
+SOME_JSON='{"answer":42}'
\ No newline at end of file
diff --git a/packages/kit/test/apps/basics/src/routes/+layout.server.js b/packages/kit/test/apps/basics/src/routes/+layout.server.js
index d30920705..f6d2446b6 100644
--- a/packages/kit/test/apps/basics/src/routes/+layout.server.js
+++ b/packages/kit/test/apps/basics/src/routes/+layout.server.js
@@ -1,4 +1,15 @@
 import { error, redirect } from '@sveltejs/kit';
+import { env } from '$env/dynamic/private';
+import { SOME_JSON } from '$env/static/private';
+
+// https://github.com/sveltejs/kit/issues/8646
+if (JSON.parse(SOME_JSON).answer !== 42) {
+	throw new Error('failed to parse env var');
+}
+
+if (JSON.parse(env.SOME_JSON).answer !== 42) {
+	throw new Error('failed to parse env var');
+}
 
 /** @type {import('./$types').LayoutServerLoad} */
 export async function load({ cookies }) {
diff --git a/packages/kit/types/internal.d.ts b/packages/kit/types/internal.d.ts
index 85734650f..267b400a6 100644
--- a/packages/kit/types/internal.d.ts
+++ b/packages/kit/types/internal.d.ts
@@ -32,6 +32,8 @@ export interface ServerModule {
 export interface ServerInternalModule {
 	set_building(building: boolean): void;
 	set_paths(paths: { base: string; assets: string }): void;
+	set_private_env(environment: Record<string, string>): void;
+	set_public_env(environment: Record<string, string>): void;
 	set_version(version: string): void;
 	set_fix_stack_trace(fix_stack_trace: (stack: string) => string): void;
 }
