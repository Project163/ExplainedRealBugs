diff --git a/documentation/docs/30-advanced/40-service-workers.md b/documentation/docs/30-advanced/40-service-workers.md
index bc23abf68..b200201c1 100644
--- a/documentation/docs/30-advanced/40-service-workers.md
+++ b/documentation/docs/30-advanced/40-service-workers.md
@@ -21,7 +21,7 @@ Inside the service worker you have access to the [`$service-worker` module](/doc
 The following example caches the built app and any files in `static` eagerly, and caches all other requests as they happen. This would make each page work offline once visited.
 
 ```js
-// @ts-nocheck Official TS Service Worker typings are still a work in progress.
+// @errors: 2339
 import { build, files, version } from '$service-worker';
 
 // Create a unique cache name for this deployment
diff --git a/documentation/docs/30-advanced/50-server-only-modules.md b/documentation/docs/30-advanced/50-server-only-modules.md
index 97d7d22b2..c14a4f21d 100644
--- a/documentation/docs/30-advanced/50-server-only-modules.md
+++ b/documentation/docs/30-advanced/50-server-only-modules.md
@@ -26,7 +26,7 @@ export const atlantisCoordinates = [/* redacted */];
 ```
 
 ```js
-// @errors: 2307 7006
+// @errors: 2307 7006 7005
 /// file: src/routes/utils.js
 export { atlantisCoordinates } from '$lib/server/secrets.js';
 
diff --git a/documentation/docs/60-appendix/10-migrating.md b/documentation/docs/60-appendix/10-migrating.md
index 298281930..e74a7badc 100644
--- a/documentation/docs/60-appendix/10-migrating.md
+++ b/documentation/docs/60-appendix/10-migrating.md
@@ -160,7 +160,7 @@ declare module 'html-minifier';
 // @filename: index.js
 // ---cut---
 import { minify } from 'html-minifier';
-import { prerendering } from '$app/environment';
+import { building } from '$app/environment';
 
 const minification_options = {
 	collapseBooleanAttributes: true,
@@ -183,16 +183,16 @@ const minification_options = {
 
 /** @type {import('@sveltejs/kit').Handle} */
 export async function handle({ event, resolve }) {
-	const response = await resolve(event);
-
-	if (prerendering && response.headers.get('content-type') === 'text/html') {
-		return new Response(minify(await response.text(), minification_options), {
-			status: response.status,
-			headers: response.headers
-		});
-	}
-
-	return response;
+	let page = '';
+
+	return resolve(event, {
+		transformPageChunk: ({ html, done }) => {
+			html += page;
+			if (done) {
+				return building ? minify(page, minification_options) : page;
+			}
+		}
+	});
 }
 ```
 
diff --git a/packages/kit/types/ambient.d.ts b/packages/kit/types/ambient.d.ts
index 175de0fea..efcc1904d 100644
--- a/packages/kit/types/ambient.d.ts
+++ b/packages/kit/types/ambient.d.ts
@@ -160,8 +160,17 @@ declare module '$app/forms' {
 	 * Usage:
 	 *
 	 * ```js
-	 * const response = await fetch('/form?/action', { method: 'POST', body: formData });
-	 * const result = deserialize(await response.text());
+	 * import { deserialize } from '$app/forms';
+	 *
+	 * async function handleSubmit(event) {
+	 *   const response = await fetch('/form?/action', {
+	 *     method: 'POST',
+	 *     body: new FormData(event.target)
+	 *   });
+	 *
+	 *   const result = deserialize(await response.text());
+	 *   // ...
+	 * }
 	 * ```
 	 */
 	export function deserialize<
@@ -220,6 +229,8 @@ declare module '$app/navigation' {
 	 *
 	 * ```ts
 	 * // Example: Match '/path' regardless of the query parameters
+	 * import { invalidate } from '$app/navigation';
+	 *
 	 * invalidate((url) => url.pathname === '/path');
 	 * ```
 	 * @param url The invalidated URL
@@ -356,6 +367,7 @@ declare module '@sveltejs/kit/hooks' {
 	 * /// file: src/hooks.server.js
 	 * import { sequence } from '@sveltejs/kit/hooks';
 	 *
+	 * /// type: import('@sveltejs/kit').Handle
 	 * async function first({ event, resolve }) {
 	 * 	console.log('first pre-processing');
 	 * 	const result = await resolve(event, {
@@ -369,6 +381,7 @@ declare module '@sveltejs/kit/hooks' {
 	 * 	return result;
 	 * }
 	 *
+	 * /// type: import('@sveltejs/kit').Handle
 	 * async function second({ event, resolve }) {
 	 * 	console.log('second pre-processing');
 	 * 	const result = await resolve(event, {
diff --git a/packages/kit/types/index.d.ts b/packages/kit/types/index.d.ts
index 8befad4c5..5fc271531 100644
--- a/packages/kit/types/index.d.ts
+++ b/packages/kit/types/index.d.ts
@@ -464,8 +464,7 @@ export interface KitConfig {
 		 *         }
 		 *
 		 *         // otherwise fail the build
-		 *           throw new Error(message);
-		 *         }
+		 *         throw new Error(message);
 		 *       }
 		 *     }
 		 *   }
diff --git a/packages/kit/types/private.d.ts b/packages/kit/types/private.d.ts
index 9ea82c8a5..2927959e0 100644
--- a/packages/kit/types/private.d.ts
+++ b/packages/kit/types/private.d.ts
@@ -192,11 +192,12 @@ export interface PrerenderHttpErrorHandler {
 		path: string;
 		referrer: string | null;
 		referenceType: 'linked' | 'fetched';
+		message: string;
 	}): void;
 }
 
 export interface PrerenderMissingIdHandler {
-	(details: { path: string; id: string; referrers: string[] }): void;
+	(details: { path: string; id: string; referrers: string[]; message: string }): void;
 }
 
 export type PrerenderHttpErrorHandlerValue = 'fail' | 'warn' | 'ignore' | PrerenderHttpErrorHandler;
diff --git a/sites/kit.svelte.dev/src/lib/docs/server/index.js b/sites/kit.svelte.dev/src/lib/docs/server/index.js
index 4cd03af5b..f93b217f2 100644
--- a/sites/kit.svelte.dev/src/lib/docs/server/index.js
+++ b/sites/kit.svelte.dev/src/lib/docs/server/index.js
@@ -119,12 +119,28 @@ export async function read_file(file) {
 			} else if (language === 'js' || language === 'ts') {
 				try {
 					const injected = [];
-					if (source.includes('$app/') || source.includes('@sveltejs/kit/')) {
+					if (
+						source.includes('$app/') ||
+						source.includes('$service-worker') ||
+						source.includes('@sveltejs/kit/')
+					) {
 						injected.push(
 							`// @filename: ambient-kit.d.ts`,
 							`/// <reference types="@sveltejs/kit" />`
 						);
 					}
+
+					if (source.includes('$env/')) {
+						// TODO we're hardcoding static env vars that are used in code examples
+						// in the types, which isn't... totally ideal, but will do for now
+						injected.push(
+							`declare module '$env/dynamic/private' { export const env: Record<string, string> }`,
+							`declare module '$env/dynamic/public' { export const env: Record<string, string> }`,
+							`declare module '$env/static/private' { export const API_KEY: string }`,
+							`declare module '$env/static/public' { export const PUBLIC_BASE_URL: string }`
+						);
+					}
+
 					if (source.includes('./$types') && !source.includes('@filename: $types.d.ts')) {
 						const params = parse_route_id(options.file || `+page.${language}`)
 							.params.map((param) => `${param.name}: string`)
@@ -142,11 +158,18 @@ export async function read_file(file) {
 							`export type Actions = Kit.Actions<{${params}}>;`
 						);
 					}
-					if (!options.file) {
-						// No named file -> assume that the code is not meant to be type checked
-						// If we don't do this, twoslash would throw errors for e.g. some snippets in `types/ambient.d.ts`
-						injected.push('// @noErrors');
+
+					// special case — we need to make allowances for code snippets coming
+					// from e.g. ambient.d.ts
+					if (file.endsWith('30-modules.md')) {
+						injected.push('// @errors: 7006 7031');
+					}
+
+					// another special case
+					if (source.includes('$lib/types')) {
+						injected.push(`declare module '$lib/types' { export interface User {} }`);
 					}
+
 					if (injected.length) {
 						const injected_str = injected.join('\n');
 						if (source.includes('// @filename:')) {
