{"url":"https://api.github.com/repos/sveltejs/kit/issues/12260","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/12260/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/12260/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/12260/events","html_url":"https://github.com/sveltejs/kit/issues/12260","id":2316225732,"node_id":"I_kwDOEiPr8c6KDszE","number":12260,"title":"svelte.config.js version changes cause most client chunks to generate a new hash despite no other changes","user":{"login":"rory-orennia","id":93952948,"node_id":"U_kgDOBZmbtA","avatar_url":"https://avatars.githubusercontent.com/u/93952948?v=4","gravatar_id":"","url":"https://api.github.com/users/rory-orennia","html_url":"https://github.com/rory-orennia","followers_url":"https://api.github.com/users/rory-orennia/followers","following_url":"https://api.github.com/users/rory-orennia/following{/other_user}","gists_url":"https://api.github.com/users/rory-orennia/gists{/gist_id}","starred_url":"https://api.github.com/users/rory-orennia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rory-orennia/subscriptions","organizations_url":"https://api.github.com/users/rory-orennia/orgs","repos_url":"https://api.github.com/users/rory-orennia/repos","events_url":"https://api.github.com/users/rory-orennia/events{/privacy}","received_events_url":"https://api.github.com/users/rory-orennia/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2428470026,"node_id":"MDU6TGFiZWwyNDI4NDcwMDI2","url":"https://api.github.com/repos/sveltejs/kit/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2024-05-24T20:42:17Z","updated_at":"2024-10-16T07:35:03Z","closed_at":null,"author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Updated bug report\r\nChanging the version in svelte.config.js and rebuilding the exact same code results in most client chunks also being updated with a new hash. The cause seems to be the version check code being updated to look for a new version, and then most client chunks directly or indirectly importing that change.\r\n\r\n\r\n## Initial bug report\r\n### Describe the bug\r\n\r\nIf you build the same project twice, you get different files out even though nothing has changed.\r\n\r\nI was trying to break my project up using manualChunks to create a vendor.js file with the hope that while we're deploying multiple times a day,  our dependencies rarely change so clients would reuse many of the same js files they'd already have cached from previous visits.  In practice this doesn't work because some base level thing that many pieces inherit from is constantly changing so you never get the same vendor.js file out between builds.\r\n\r\nThe issue seems to be around a randomly generated key in the output like `globalThis.__sveltekit_zp1tl` where that hash changes every build. That shows up as the main difference in entry.{hash}.js which many other files then import.\r\n![image](https://github.com/sveltejs/kit/assets/93952948/17279952-05fb-40d0-b065-eb0e4eb27da9)\r\n![image](https://github.com/sveltejs/kit/assets/93952948/9e14b7f8-4413-43af-8471-2bd934afc616)\r\n\r\nI thought this should work since Richard Harris actually raised this bug with Vite: https://github.com/vitejs/vite/issues/11911\r\n\r\n### Reproduction\r\n\r\n1. `pnpm create svelte@latest deterministic-build`\r\n2. press enter a bunch.  none of these settings matter.  Same issue appears in Typescript vs JS, adding eslint, etc, or even doing it in npm instead of pnpm\r\n3. `cd deterministic-build`\r\n4. `pnpm i`\r\n5. `pnpm build`.  copy output\r\n6. `pnpm build`.  copy output\r\n7. compare outputs.  Notice some files change\r\n\r\n### Logs\r\n\r\n```Shell\r\n> deterministic-build@0.0.1 build\r\n> vite build\r\n\r\nvite v5.2.11 building SSR bundle for production...\r\n\"confetti\" is imported from external module \"@neoconfetti/svelte\" but never used in \"src/routes/sverdle/+page.svelte\".\r\n✓ 109 modules transformed.\r\nvite v5.2.11 building for production...\r\n✓ 92 modules transformed.\r\n.svelte-kit/output/client/_app/version.json                                                         0.03 kB │ gzip:  0.05 kB\r\n.svelte-kit/output/client/.vite/manifest.json                                                       7.12 kB │ gzip:  0.99 kB\r\n.svelte-kit/output/client/_app/immutable/assets/fira-mono-greek-ext-400-normal.CsqI23CO.woff2       7.51 kB\r\n.svelte-kit/output/client/_app/immutable/assets/fira-mono-cyrillic-400-normal.36-45Uyg.woff2        9.10 kB\r\n.svelte-kit/output/client/_app/immutable/assets/fira-mono-greek-400-normal.C3zng6O6.woff2          10.52 kB\r\n.svelte-kit/output/client/_app/immutable/assets/fira-mono-latin-ext-400-normal.D6XfiR-_.woff2      11.36 kB\r\n.svelte-kit/output/client/_app/immutable/assets/fira-mono-cyrillic-ext-400-normal.B04YIrm4.woff2   15.77 kB\r\n.svelte-kit/output/client/_app/immutable/assets/fira-mono-latin-400-normal.DKjLVgQi.woff2          16.28 kB\r\n.svelte-kit/output/client/_app/immutable/assets/fira-mono-all-400-normal.B2mvLtSD.woff             77.36 kB\r\n.svelte-kit/output/client/_app/immutable/assets/svelte-welcome.0pIiHnVF.webp                      115.47 kB\r\n.svelte-kit/output/client/_app/immutable/assets/svelte-welcome.VNiyy3gC.png                       360.81 kB\r\n.svelte-kit/output/client/_app/immutable/assets/5.CU6psp88.css                                      0.80 kB │ gzip:  0.35 kB\r\n.svelte-kit/output/client/_app/immutable/assets/2.Cs8KR-Bb.css                                      1.47 kB │ gzip:  0.53 kB\r\n.svelte-kit/output/client/_app/immutable/assets/4.DOkkq0IA.css                                      3.78 kB │ gzip:  1.06 kB\r\n.svelte-kit/output/client/_app/immutable/assets/0.CT0x_Q5c.css                                      5.15 kB │ gzip:  1.66 kB\r\n.svelte-kit/output/client/_app/immutable/chunks/index.R8ovVqwX.js                                   0.03 kB │ gzip:  0.05 kB\r\n.svelte-kit/output/client/_app/immutable/entry/start.kuqVoxG5.js                                    0.07 kB │ gzip:  0.08 kB\r\n.svelte-kit/output/client/_app/immutable/chunks/stores.CyV73Wv9.js                                  0.23 kB │ gzip:  0.17 kB\r\n.svelte-kit/output/client/_app/immutable/chunks/index.Ice1EKvx.js                                   0.51 kB │ gzip:  0.34 kB\r\n.svelte-kit/output/client/_app/immutable/nodes/1.DgAi-rhN.js                                        0.84 kB │ gzip:  0.52 kB\r\n.svelte-kit/output/client/_app/immutable/nodes/3.BqQOub2U.js                                        1.57 kB │ gzip:  0.96 kB\r\n.svelte-kit/output/client/_app/immutable/chunks/scheduler.Dk-snqIU.js                               2.25 kB │ gzip:  1.05 kB\r\n.svelte-kit/output/client/_app/immutable/nodes/5.CwxmUzn6.js                                        2.35 kB │ gzip:  1.11 kB\r\n.svelte-kit/output/client/_app/immutable/nodes/2.BMQFqo-e.js                                        5.48 kB │ gzip:  2.60 kB\r\n.svelte-kit/output/client/_app/immutable/chunks/index.DDRweiI9.js                                   6.09 kB │ gzip:  2.57 kB\r\n.svelte-kit/output/client/_app/immutable/entry/app.D6zuvAPi.js                                      6.64 kB │ gzip:  2.65 kB\r\n.svelte-kit/output/client/_app/immutable/nodes/0.qacZO6So.js                                        8.77 kB │ gzip:  3.57 kB\r\n.svelte-kit/output/client/_app/immutable/nodes/4.D_o_hs5U.js                                       17.08 kB │ gzip:  7.07 kB\r\n.svelte-kit/output/client/_app/immutable/chunks/entry.DI0Mx0P3.js                                  27.97 kB │ gzip: 10.97 kB\r\n✓ built in 248ms\r\n.svelte-kit/output/server/.vite/manifest.json                                                       7.17 kB\r\n.svelte-kit/output/server/_app/immutable/assets/fira-mono-greek-ext-400-normal.CsqI23CO.woff2       7.51 kB\r\n.svelte-kit/output/server/_app/immutable/assets/fira-mono-cyrillic-400-normal.36-45Uyg.woff2        9.10 kB\r\n.svelte-kit/output/server/_app/immutable/assets/fira-mono-greek-400-normal.C3zng6O6.woff2          10.52 kB\r\n.svelte-kit/output/server/_app/immutable/assets/fira-mono-latin-ext-400-normal.D6XfiR-_.woff2      11.36 kB\r\n.svelte-kit/output/server/_app/immutable/assets/fira-mono-cyrillic-ext-400-normal.B04YIrm4.woff2   15.77 kB\r\n.svelte-kit/output/server/_app/immutable/assets/fira-mono-latin-400-normal.DKjLVgQi.woff2          16.28 kB\r\n.svelte-kit/output/server/_app/immutable/assets/fira-mono-all-400-normal.B2mvLtSD.woff             77.36 kB\r\n.svelte-kit/output/server/_app/immutable/assets/svelte-welcome.0pIiHnVF.webp                      115.47 kB\r\n.svelte-kit/output/server/_app/immutable/assets/svelte-welcome.VNiyy3gC.png                       360.81 kB\r\n.svelte-kit/output/server/_app/immutable/assets/_page.CU6psp88.css                                  0.80 kB\r\n.svelte-kit/output/server/_app/immutable/assets/_page.BBloWWo2.css                                  1.45 kB\r\n.svelte-kit/output/server/_app/immutable/assets/_page.DOkkq0IA.css                                  3.78 kB\r\n.svelte-kit/output/server/_app/immutable/assets/_layout.c5uvFHuT.css                                5.40 kB\r\n.svelte-kit/output/server/chunks/prod-ssr.js                                                        0.04 kB\r\n.svelte-kit/output/server/entries/pages/_page.ts.js                                                 0.05 kB\r\n.svelte-kit/output/server/chunks/index3.js                                                          0.08 kB\r\n.svelte-kit/output/server/entries/pages/about/_page.ts.js                                           0.13 kB\r\n.svelte-kit/output/server/entries/pages/sverdle/how-to-play/_page.ts.js                             0.13 kB\r\n.svelte-kit/output/server/chunks/client.js                                                          0.28 kB\r\n.svelte-kit/output/server/internal.js                                                               0.31 kB\r\n.svelte-kit/output/server/entries/fallbacks/error.svelte.js                                         0.47 kB\r\n.svelte-kit/output/server/chunks/stores.js                                                          0.54 kB\r\n.svelte-kit/output/server/entries/pages/about/_page.svelte.js                                       1.07 kB\r\n.svelte-kit/output/server/chunks/index2.js                                                          1.33 kB\r\n.svelte-kit/output/server/chunks/index.js                                                           2.10 kB\r\n.svelte-kit/output/server/chunks/ssr.js                                                             4.00 kB\r\n.svelte-kit/output/server/chunks/exports.js                                                         5.96 kB\r\n.svelte-kit/output/server/chunks/internal.js                                                        6.03 kB\r\n.svelte-kit/output/server/entries/pages/sverdle/how-to-play/_page.svelte.js                         6.47 kB\r\n.svelte-kit/output/server/entries/pages/_page.svelte.js                                            13.48 kB\r\n.svelte-kit/output/server/entries/pages/_layout.svelte.js                                          14.67 kB\r\n.svelte-kit/output/server/entries/pages/sverdle/_page.svelte.js                                    23.42 kB\r\n.svelte-kit/output/server/index.js                                                                 90.30 kB\r\n.svelte-kit/output/server/entries/pages/sverdle/_page.server.ts.js                                146.12 kB\r\n✓ built in 1.01s\r\n\r\nRun npm run preview to preview your production build locally.\r\n\r\n> Using @sveltejs/adapter-auto\r\n  Could not detect a supported production environment. See https://kit.svelte.dev/docs/adapters to learn how to configure your app to run on the platform of your choosing\r\n  ✔ done\r\n```\r\n\r\n\r\n### System Info\r\n\r\n```Shell\r\nSystem:\r\n    OS: macOS 14.4.1\r\n    CPU: (16) arm64 Apple M3 Max\r\n    Memory: 2.59 GB / 64.00 GB\r\n    Shell: 5.9 - /bin/zsh\r\n  Binaries:\r\n    Node: 21.6.0 - /usr/local/bin/node\r\n    npm: 10.3.0 - /usr/local/bin/npm\r\n    pnpm: 9.1.0 - ~/Library/pnpm/pnpm\r\n  Browsers:\r\n    Chrome: 125.0.6422.78\r\n    Safari: 17.4.1\r\n  npmPackages:\r\n    @sveltejs/adapter-auto: ^3.0.0 => 3.2.1\r\n    @sveltejs/kit: ^2.0.0 => 2.5.10\r\n    @sveltejs/vite-plugin-svelte: ^3.0.0 => 3.1.0\r\n    svelte: ^4.2.7 => 4.2.17\r\n    vite: ^5.0.3 => 5.2.11\r\n```\r\n\r\n\r\n### Severity\r\n\r\nserious, but I can work around it\r\n\r\n### Additional Information\r\n\r\n_No response_","closed_by":{"login":"dummdidumm","id":5968653,"node_id":"MDQ6VXNlcjU5Njg2NTM=","avatar_url":"https://avatars.githubusercontent.com/u/5968653?v=4","gravatar_id":"","url":"https://api.github.com/users/dummdidumm","html_url":"https://github.com/dummdidumm","followers_url":"https://api.github.com/users/dummdidumm/followers","following_url":"https://api.github.com/users/dummdidumm/following{/other_user}","gists_url":"https://api.github.com/users/dummdidumm/gists{/gist_id}","starred_url":"https://api.github.com/users/dummdidumm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dummdidumm/subscriptions","organizations_url":"https://api.github.com/users/dummdidumm/orgs","repos_url":"https://api.github.com/users/dummdidumm/repos","events_url":"https://api.github.com/users/dummdidumm/events{/privacy}","received_events_url":"https://api.github.com/users/dummdidumm/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/12260/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/12260/timeline","performed_via_github_app":null,"state_reason":"reopened"}