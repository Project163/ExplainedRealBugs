{"url":"https://api.github.com/repos/sveltejs/kit/issues/11310","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/11310/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/11310/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/11310/events","html_url":"https://github.com/sveltejs/kit/issues/11310","id":2041778037,"node_id":"I_kwDOEiPr8c55sw91","number":11310,"title":"Unexpected import behaviour in \"non-ssr\" routes","user":{"login":"SourceR85","id":1261013,"node_id":"MDQ6VXNlcjEyNjEwMTM=","avatar_url":"https://avatars.githubusercontent.com/u/1261013?v=4","gravatar_id":"","url":"https://api.github.com/users/SourceR85","html_url":"https://github.com/SourceR85","followers_url":"https://api.github.com/users/SourceR85/followers","following_url":"https://api.github.com/users/SourceR85/following{/other_user}","gists_url":"https://api.github.com/users/SourceR85/gists{/gist_id}","starred_url":"https://api.github.com/users/SourceR85/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SourceR85/subscriptions","organizations_url":"https://api.github.com/users/SourceR85/orgs","repos_url":"https://api.github.com/users/SourceR85/repos","events_url":"https://api.github.com/users/SourceR85/events{/privacy}","received_events_url":"https://api.github.com/users/SourceR85/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2428470032,"node_id":"MDU6TGFiZWwyNDI4NDcwMDMy","url":"https://api.github.com/repos/sveltejs/kit/labels/documentation","name":"documentation","color":"0075ca","default":true,"description":"Improvements or additions to documentation"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2023-12-14T14:08:07Z","updated_at":"2025-01-06T10:37:08Z","closed_at":"2025-01-06T10:37:08Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nThe Bug (or maybe a documentation issue?):\r\n\r\nI've exported `ssr=false` in my root +layout.\r\nIf I import (via statement/top-level) in any sub-route's +page.js/.ts a dependency that uses at the top level a browser API (more precise: any none-node API),\r\nthe build failing \"evaluating SSR\" with an error:\r\n```\r\nReferenceError [Error]: (the unknown API) is not defined\r\n```\r\n\r\nI expected, that SSR should be turned off for the page.js/.ts in that case :thinking:\n\n### Reproduction\n\nHere you can find a prepared example for this miss-behaviour:\r\nhttps://github.com/SourceR85/pwa-load\r\n\r\nAt the end, it's pretty easy to replicate:\r\n1. create a project with `npm create svelte@latest xxx`\r\n2. add `export const ssr=false;` to a +layout.js/.ts\r\n3. write some code, that depends (at the module scope) on non-node API's\r\n4. Import that code in a \"SPA\" +page.js/.ts route, somewhere within the +layout path\n\n### Logs\n\n```Shell\n❯ npm run build\r\n\r\n> pwa-load@0.0.1 build\r\n> vite build\r\n\r\n\r\nvite v4.5.1 building SSR bundle for production...\r\n✓ 75 modules transformed.\r\n\r\nnode:internal/event_target:1083\r\n  process.nextTick(() => { throw err; });\r\n                           ^\r\nReferenceError [Error]: localStorage is not defined\r\n    at file:///home/sourcer/dev/playground/pwa-load/.svelte-kit/output/server/entries/pages/_page.ts.js:4:24\r\n    at ModuleJob.run (node:internal/modules/esm/module_job:217:25)\r\n    at async ModuleLoader.import (node:internal/modules/esm/loader:316:24)\r\n    at async analyse (file:///home/sourcer/dev/playground/pwa-load/node_modules/@sveltejs/kit/src/core/postbuild/analyse.js:60:16)\r\n    at async MessagePort.<anonymous> (file:///home/sourcer/dev/playground/pwa-load/node_modules/@sveltejs/kit/src/utils/fork.js:22:16)\r\nEmitted 'error' event on Worker instance at:\r\n    at [kOnErrorMessage] (node:internal/worker:326:10)\r\n    at [kOnMessage] (node:internal/worker:337:37)\r\n    at MessagePort.<anonymous> (node:internal/worker:232:57)\r\n    at [nodejs.internal.kHybridDispatch] (node:internal/event_target:807:20)\r\n    at exports.emitMessage (node:internal/per_context/messageport:23:28)\r\n\r\nNode.js v20.9.0\n```\n\n\n### System Info\n\n```Shell\nSystem:\r\n  OS: Linux 6.6 Fedora Linux 39 (KDE Plasma)\r\n  CPU: (16) x64 AMD Ryzen 7 6800HS Creator Edition\r\n  Memory: 3.05 GB / 13.34 GB\r\n  Container: Yes\r\n  Shell: 5.9 - /usr/bin/zsh\r\nBinaries:\r\n  Node: 20.9.0 - ~/.fnm/node-versions/v20.9.0/installation/bin/node\r\n  Yarn: 1.22.21 - ~/.fnm/node-versions/v20.9.0/installation/bin/yarn\r\n  npm: 10.1.0 - ~/.fnm/node-versions/v20.9.0/installation/bin/npm\r\n  pnpm: 8.12.1 - ~/.fnm/node-versions/v20.9.0/installation/bin/pnpm\r\n  bun: 1.0.1 - ~/.bun/bin/bun\r\nnpmPackages:\r\n  @sveltejs/adapter-auto: 2.1.1 => 2.1.1 \r\n  @sveltejs/kit: 1.30.3 => 1.30.3 \r\n  svelte: 4.2.8 => 4.2.8 \r\n  vite: 4.5.1 => 4.5.1\n```\n\n\n### Severity\n\nserious, but I can work around it\n\n### Additional Information\n\n_No response_","closed_by":{"login":"dummdidumm","id":5968653,"node_id":"MDQ6VXNlcjU5Njg2NTM=","avatar_url":"https://avatars.githubusercontent.com/u/5968653?v=4","gravatar_id":"","url":"https://api.github.com/users/dummdidumm","html_url":"https://github.com/dummdidumm","followers_url":"https://api.github.com/users/dummdidumm/followers","following_url":"https://api.github.com/users/dummdidumm/following{/other_user}","gists_url":"https://api.github.com/users/dummdidumm/gists{/gist_id}","starred_url":"https://api.github.com/users/dummdidumm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dummdidumm/subscriptions","organizations_url":"https://api.github.com/users/dummdidumm/orgs","repos_url":"https://api.github.com/users/dummdidumm/repos","events_url":"https://api.github.com/users/dummdidumm/events{/privacy}","received_events_url":"https://api.github.com/users/dummdidumm/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/11310/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/11310/timeline","performed_via_github_app":null,"state_reason":"completed"}