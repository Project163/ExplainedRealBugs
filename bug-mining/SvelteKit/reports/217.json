{"url":"https://api.github.com/repos/sveltejs/kit/issues/7272","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/7272/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/7272/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/7272/events","html_url":"https://github.com/sveltejs/kit/issues/7272","id":1410272076,"node_id":"I_kwDOEiPr8c5UDwtM","number":7272,"title":"Have `error` helper redirect to error page when thrown in `handle` hook for an underlying `load` request","user":{"login":"theetrain","id":12798751,"node_id":"MDQ6VXNlcjEyNzk4NzUx","avatar_url":"https://avatars.githubusercontent.com/u/12798751?v=4","gravatar_id":"","url":"https://api.github.com/users/theetrain","html_url":"https://github.com/theetrain","followers_url":"https://api.github.com/users/theetrain/followers","following_url":"https://api.github.com/users/theetrain/following{/other_user}","gists_url":"https://api.github.com/users/theetrain/gists{/gist_id}","starred_url":"https://api.github.com/users/theetrain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/theetrain/subscriptions","organizations_url":"https://api.github.com/users/theetrain/orgs","repos_url":"https://api.github.com/users/theetrain/repos","events_url":"https://api.github.com/users/theetrain/events{/privacy}","received_events_url":"https://api.github.com/users/theetrain/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2428470032,"node_id":"MDU6TGFiZWwyNDI4NDcwMDMy","url":"https://api.github.com/repos/sveltejs/kit/labels/documentation","name":"documentation","color":"0075ca","default":true,"description":"Improvements or additions to documentation"},{"id":2575933385,"node_id":"MDU6TGFiZWwyNTc1OTMzMzg1","url":"https://api.github.com/repos/sveltejs/kit/labels/error%20handling","name":"error handling","color":"aff99a","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sveltejs/kit/milestones/2","html_url":"https://github.com/sveltejs/kit/milestone/2","labels_url":"https://api.github.com/repos/sveltejs/kit/milestones/2/labels","id":6044960,"node_id":"MDk6TWlsZXN0b25lNjA0NDk2MA==","number":2,"title":"1.0","description":"stuff we need to nail down before launch","creator":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":628,"state":"closed","created_at":"2020-10-29T01:17:50Z","updated_at":"2022-12-19T11:47:29Z","due_on":null,"closed_at":"2022-12-19T11:47:29Z"},"comments":2,"created_at":"2022-10-15T19:42:24Z","updated_at":"2022-11-10T16:27:18Z","closed_at":"2022-11-10T16:27:18Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the problem\r\n\r\nSimilar to #6738 \r\n\r\nThe documentation for `+error.svelte` and `Loading data > errors` is clear in covering behaviours of the `error` helper function in that it directs users to the nearest `+error.svelte` page when thrown in any `load` method, or returns an error Response object when thrown in an endpoint. \r\n\r\nThrough trial and error, I learned when an `error` is thrown in `handle` it returns an error response no matter if the request if for a `load` or `endpoint` or something else. For pages, this leads to a generic 500-error page.\r\n\r\nDemonstration: https://stackblitz.com/edit/sveltekit-handle-error?file=README.md,src%2Fhooks.server.js&terminal=dev\r\n\r\nMy specific context is I have a `src/routes/[branch]/+layout.svelte` file whose `handle` method connects to a database based on the `branch` param. If I cannot connect to the database with this `branch` value, the DB connection throws an error, and I want that to translate to a 404 error in SvelteKit.\r\n\r\n### Describe the proposed solution\r\n\r\nHave the behaviour of `throw error()` correspond to the request's context when called in `handle`. This would mean:\r\n\r\n1. When the request is a page `load`, then `throw error()` routes to the nearest `+error.svelte` with an error message when thrown in `handle`.\r\n2. When the request is an endpoint, then `throw error()` returns its error message to the requester when thrown in `handle`.\r\n\r\n### Alternatives considered\r\n\r\nThis isn't an earnest ask since I already have a decent workaround as suggested here: https://github.com/sveltejs/kit/issues/6738#issuecomment-1249399240.\r\n\r\nGiven the file structure `src/routes/[branch]/someotherpage`:\r\n\r\n1. Add a `src/routes/+error.svelte` page to catch and display errors thrown in `src/routes/[branch]` or deeper.\r\n2. Pass an error message to `event.locals` in the handle hook:\r\n\r\n    ```js\r\n    import { error } from '@sveltejs/kit';\r\n    \r\n    export async function handle({ event, resolve }) {\r\n      try {\r\n        event.locals.db = await dbConnect(branch)\r\n      } catch (err) {\r\n        // add error to be later thrown in the layout `load` \r\n        event.locals.error = [404, `Branch \"${branch}\" does not exist.`]\r\n        const response = await resolve(event)\r\n        return response\r\n      }\r\n    }\r\n    ```\r\n\r\n3. Handle error in `src/routes/[branch]/+layout.server.js`\r\n\r\n    ```js\r\n    import { error } from '@sveltejs/kit'\r\n    \r\n    /** @type {import('./$types').LayoutServerLoad} */\r\n    export async function load ({ locals }) {\r\n      if (locals.error?.length > 0) {\r\n        // this uses the spread operator since `locals.error`\r\n        // is an array of parameters\r\n        throw error(...locals.error)\r\n      }\r\n      // ...\r\n    }\r\n    ```\r\n\r\nDemonstration of workaround: https://stackblitz.com/edit/sveltekit-handle-error-workaround?file=src%2Fhooks.server.js,src%2Froutes%2F[branch]%2F%2Bpage.server.js&terminal=dev\r\n\r\n### Importance\r\n\r\nnice to have\r\n\r\n### Additional Information\r\n\r\nMore personal context for posterity not directly related to this issue: https://github.com/sveltejs/kit/issues/6788#issue-1372268840\r\n\r\nIf this proposal sounds favourable, then great. If it's something that won't be implemented, then I'd like to at least help clarify the behaviour of `error` somewhere in the docs when it comes to being thrown in `handle`, `load`, or a server endpoint. Along with documentation, I hope the alternative explained above can help others in the future. \r\n\r\nAs always, thank you SvelteKit maintainers for your time and efforts!","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/7272/reactions","total_count":2,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/7272/timeline","performed_via_github_app":null,"state_reason":"completed"}