{"url":"https://api.github.com/repos/sveltejs/kit/issues/9183","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/9183/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/9183/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/9183/events","html_url":"https://github.com/sveltejs/kit/issues/9183","id":1597025333,"node_id":"I_kwDOEiPr8c5fMKw1","number":9183,"title":"fetch inside a server hook throws error instead of forwarding request to proxied API","user":{"login":"DamianoPellegrini","id":41305552,"node_id":"MDQ6VXNlcjQxMzA1NTUy","avatar_url":"https://avatars.githubusercontent.com/u/41305552?v=4","gravatar_id":"","url":"https://api.github.com/users/DamianoPellegrini","html_url":"https://github.com/DamianoPellegrini","followers_url":"https://api.github.com/users/DamianoPellegrini/followers","following_url":"https://api.github.com/users/DamianoPellegrini/following{/other_user}","gists_url":"https://api.github.com/users/DamianoPellegrini/gists{/gist_id}","starred_url":"https://api.github.com/users/DamianoPellegrini/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DamianoPellegrini/subscriptions","organizations_url":"https://api.github.com/users/DamianoPellegrini/orgs","repos_url":"https://api.github.com/users/DamianoPellegrini/repos","events_url":"https://api.github.com/users/DamianoPellegrini/events{/privacy}","received_events_url":"https://api.github.com/users/DamianoPellegrini/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2428470026,"node_id":"MDU6TGFiZWwyNDI4NDcwMDI2","url":"https://api.github.com/repos/sveltejs/kit/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-02-23T15:03:22Z","updated_at":"2023-02-25T13:46:57Z","closed_at":"2023-02-25T13:46:57Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\nI have an app served behind a reverse proxy. Any call to `/api` gets forwarded to the API server, the others are forwarded to sveltekit.\r\n\r\nGiven an relative API endpoint `/api/endpoint`:\r\n\r\n- Calling `event.fetch` inside a `load` or action handler works fine\r\n- Calling `event.fetch` directly inside the `hooks.server.ts` gives a 404 error without making an HTTP request (I DON'T have any route on `/api/endpoint/+server.ts`, as it should be forwarded to the API server by the proxy) \r\n\r\nWhen calling `event.fetch` inside a `load` function I can see by logging `event.url.href` that the request to the same endpoint pass through `hooks.server.ts` just fine.\r\n\r\nI think the issue is caused by fetch that shorts internal requests to their handler as said in the ([docs](https://kit.svelte.dev/docs/load#making-fetch-requests)):\r\n\r\n> internal requests (e.g. for +server.js routes) go direct to the handler function when running on the server, without the overhead of an HTTP call.\r\n\r\nIt seems to do that only if `fetch` is called inside `hooks.server.ts`, should be the same behaviour regardless of where `fetch` is called?\r\n\r\nAs a solution maybe sveltekit should short-hand requests to an handler only if the route exists?\r\n\r\n\r\n\r\n### Reproduction\r\n\r\nExample:\r\n\r\n- api.domain2.com - API server\r\n- domain.com/api - Proxied API server\r\n- domain.com - sveltekit app\r\n\r\nProxy configuration for development:\r\n\r\n```typescript\r\n// vite.config.ts\r\n\r\nimport { sveltekit } from '@sveltejs/kit/vite';\r\nimport { defineConfig } from 'vite';\r\n\r\nexport default defineConfig({\r\n  plugins: [sveltekit()],\r\n  server: {\r\n    proxy: {\r\n      '/api': {\r\n        target: 'http://api.domain2.com',\r\n        changeOrigin: false,\r\n        rewrite: (path) => path.replace(/^\\/api/, '')\r\n      }\r\n    }\r\n  }\r\n});\r\n```\r\n\r\n```typescript\r\n// src/hooks.server.ts\r\n\r\nimport type { Handle } from '@sveltejs/kit';\r\n\r\nexport const handle = (async ({ event, resolve }) => {\r\n  console.log('Server Hook:', event.url.href);\r\n\r\n  if (!event.locals.obj && event.url.pathname.startsWith('/private')) {\r\n    try {\r\n      const objResp = await event.fetch('/api/endpoint');\r\n      if (!objResp.ok) throw objResp;\r\n      event.locals.obj = await objResp.json();\r\n    } catch {\r\n      event.locals.obj = null;\r\n    }\r\n  }\r\n\r\n  const response = await resolve(event);\r\n  return response;\r\n}) satisfies Handle;\r\n```\r\n\r\nThis works fine:\r\n```typescript\r\n// src/private/+layout.server.ts\r\n\r\nimport type { LayoutServerLoad } from './$types';\r\n\r\nexport const load = (async ({ fetch }) => {\r\n\r\n  const resp = await fetch('/api/endpoint');\r\n        \r\n  const obj = await resp.json();\r\n\r\n  return { obj };\r\n}) satisfies LayoutServerLoad;\r\n```\r\n\r\n### Logs\r\n\r\n```Shell\r\nServer Hook: http://localhost:5173/private\r\nServer Hook: http://localhost:5173/api/endpoint\r\nError: Not found: /api/endpoint\r\n    at resolve (/@fs/Users/damiano/Developer/dpdev/accounts/node_modules/.pnpm/@sveltejs+kit@1.5.3_svelte@3.55.1+vite@4.1.1/node_modules/@sveltejs/kit/src/runtime/server/respond.js:396:13)\r\n    at resolve (/@fs/Users/damiano/Developer/dpdev/accounts/node_modules/.pnpm/@sveltejs+kit@1.5.3_svelte@3.55.1+vite@4.1.1/node_modules/@sveltejs/kit/src/runtime/server/respond.js:237:5)\r\n    at Object.handle (/Users/damiano/Developer/dpdev/accounts/ui/src/hooks.server.ts:22:24)\r\n    at Module.respond (/@fs/Users/damiano/Developer/dpdev/accounts/node_modules/.pnpm/@sveltejs+kit@1.5.3_svelte@3.55.1+vite@4.1.1/node_modules/@sveltejs/kit/src/runtime/server/respond.js:234:40)\r\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)\r\n    at async fetch (/@fs/Users/damiano/Developer/dpdev/accounts/node_modules/.pnpm/@sveltejs+kit@1.5.3_svelte@3.55.1+vite@4.1.1/node_modules/@sveltejs/kit/src/runtime/server/fetch.js:134:16)\r\n    at async Object.eval [as fetch] (/@fs/Users/damiano/Developer/dpdev/accounts/node_modules/.pnpm/@sveltejs+kit@1.5.3_svelte@3.55.1+vite@4.1.1/node_modules/@sveltejs/kit/src/runtime/server/fetch.js:27:10)\r\n    at async Object.handle (/Users/damiano/Developer/dpdev/accounts/ui/src/hooks.server.ts:14:29)\r\n    at async Module.respond (/@fs/Users/damiano/Developer/dpdev/accounts/node_modules/.pnpm/@sveltejs+kit@1.5.3_svelte@3.55.1+vite@4.1.1/node_modules/@sveltejs/kit/src/runtime/server/respond.js:234:20)\r\n    at async file:///Users/damiano/Developer/dpdev/accounts/node_modules/.pnpm/@sveltejs+kit@1.5.3_svelte@3.55.1+vite@4.1.1/node_modules/@sveltejs/kit/src/exports/vite/dev/index.js:495:22\r\n```\r\n\r\n\r\n### System Info\r\n\r\n```Shell\r\nSystem:\r\n    OS: macOS 13.1\r\n    CPU: (10) arm64 Apple M1 Pro\r\n    Memory: 97.48 MB / 16.00 GB\r\n    Shell: 5.8.1 - /bin/zsh\r\n  Binaries:\r\n    Node: 19.6.1 - /opt/homebrew/bin/node\r\n    Yarn: 1.22.19 - /opt/homebrew/bin/yarn\r\n    npm: 9.4.0 - /opt/homebrew/bin/npm\r\n  Browsers:\r\n    Firefox Developer Edition: 110.0\r\n    Safari: 16.2\r\n```\r\n\r\n\r\n### Severity\r\n\r\nserious, but I can work around it\r\n\r\n### Additional Information\r\n\r\nAs a workaround you can define a route that calls fetch directly:\r\n```typescript\r\n// src/workaround/[...path]/+server.ts\r\nimport type { RequestHandler } from './$types';\r\n\r\nexport const GET = (({ params, url }) => {\r\n  return fetch(`/${params.path + url.search}`);\r\n}) satisfies RequestHandler;\r\n```\r\n\r\n```typescript\r\n// src/hooks.server.ts\r\n\r\nimport type { Handle } from '@sveltejs/kit';\r\n\r\nexport const handle = (async ({ event, resolve }) => {\r\n  console.log('Server Hook:', event.url.href);\r\n\r\n  if (!event.locals.obj && event.url.pathname.startsWith('/private')) {\r\n    try {\r\n      const objResp = await event.fetch('/workaround/api/endpoint');\r\n      if (!objResp.ok) throw objResp;\r\n      event.locals.obj = await objResp.json();\r\n    } catch {\r\n      event.locals.obj = null;\r\n    }\r\n  }\r\n\r\n  const response = await resolve(event);\r\n  return response;\r\n}) satisfies Handle;\r\n```","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/9183/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/9183/timeline","performed_via_github_app":null,"state_reason":"completed"}