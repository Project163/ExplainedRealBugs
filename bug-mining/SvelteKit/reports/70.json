{"url":"https://api.github.com/repos/sveltejs/kit/issues/5870","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/5870/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/5870/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/5870/events","html_url":"https://github.com/sveltejs/kit/issues/5870","id":1335503228,"node_id":"I_kwDOEiPr8c5Pmil8","number":5870,"title":"content length mismatch when use load.fetch","user":{"login":"jasonlyu123","id":36730922,"node_id":"MDQ6VXNlcjM2NzMwOTIy","avatar_url":"https://avatars.githubusercontent.com/u/36730922?v=4","gravatar_id":"","url":"https://api.github.com/users/jasonlyu123","html_url":"https://github.com/jasonlyu123","followers_url":"https://api.github.com/users/jasonlyu123/followers","following_url":"https://api.github.com/users/jasonlyu123/following{/other_user}","gists_url":"https://api.github.com/users/jasonlyu123/gists{/gist_id}","starred_url":"https://api.github.com/users/jasonlyu123/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasonlyu123/subscriptions","organizations_url":"https://api.github.com/users/jasonlyu123/orgs","repos_url":"https://api.github.com/users/jasonlyu123/repos","events_url":"https://api.github.com/users/jasonlyu123/events{/privacy}","received_events_url":"https://api.github.com/users/jasonlyu123/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-08-11T05:55:51Z","updated_at":"2022-08-16T13:45:46Z","closed_at":"2022-08-16T13:45:46Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\nWhen using `load.fetch` to load external resources. The `content-length` header of the page would be piped to the fetch call. This usually won't be a problem. But there's some edge case where you would send a post request to the page. Maybe accidentally forgot to preventDefault on a form. This would cause a fetch failed error thrown by node undici, which is kind of hard to debug if you don't know what `load.fetch` does behind the scene. \r\n\r\nThe case of why I found the issue is also an edge case. For some reason the reverse proxy I am using appends a `'content-length': 0` header to the proxied request which causes the same problem. \r\n\r\n### Reproduction\r\n\r\nhttps://github.com/jasonlyu123/kit-load-content-length-issue\r\n\r\nsubmit the search form on the index page. A fetch-failed error would be thrown but It won't happen when you refresh the page because then it's a get request which in theory doesn't have a `content-length` header. \r\n\r\n### Logs\r\n\r\n_No response_\r\n\r\n### System Info\r\n\r\n```shell\r\nSystem:\r\n    OS: Windows 10 10.0.22000\r\n    CPU: (16) x64 AMD Ryzen 7 4800HS with Radeon Graphics\r\n    Memory: 3.18 GB / 15.42 GB\r\n  Binaries:\r\n    Node: 16.13.1 - C:\\Program Files\\nodejs\\node.EXE\r\n    Yarn: 1.22.10 - ~\\AppData\\Roaming\\npm\\yarn.CMD\r\n    npm: 8.1.2 - C:\\Program Files\\nodejs\\npm.CMD\r\n  Browsers:\r\n    Edge: Spartan (44.22000.120.0), Chromium (104.0.1293.47)\r\n    Internet Explorer: 11.0.22000.120\r\n  npmPackages:\r\n    @sveltejs/adapter-auto: next => 1.0.0-next.64\r\n    @sveltejs/kit: next => 1.0.0-next.405\r\n    svelte: ^3.44.0 => 3.49.0\r\n    vite: ^3.0.0 => 3.0.5\r\n```\r\n\r\n\r\n### Severity\r\n\r\nannoyance\r\n\r\n### Additional Information\r\n\r\nProbably can be fixed by adding `content-length` to the blacklist here. Can't find a drawback for removing `content-length` header here. Can anyone think of one? \r\n\r\nhttps://github.com/sveltejs/kit/blob/87552ef7efd2f6b38dd7e3f7a90bc9fd5ceb12f3/packages/kit/src/runtime/server/page/load_node.js#L128-L135\r\n\r\nSince this file is being split in the big update and it's an edge case. Guess it would be easier to handle it after that. ","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/5870/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/5870/timeline","performed_via_github_app":null,"state_reason":"completed"}