{"url":"https://api.github.com/repos/sveltejs/kit/issues/14505","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/14505/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/14505/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/14505/events","html_url":"https://github.com/sveltejs/kit/issues/14505","id":3442005454,"node_id":"I_kwDOEiPr8c7NKNXO","number":14505,"title":"Cannot use `getRequestEvent` in kit 2.43.0","user":{"login":"sillvva","id":5138384,"node_id":"MDQ6VXNlcjUxMzgzODQ=","avatar_url":"https://avatars.githubusercontent.com/u/5138384?v=4","gravatar_id":"","url":"https://api.github.com/users/sillvva","html_url":"https://github.com/sillvva","followers_url":"https://api.github.com/users/sillvva/followers","following_url":"https://api.github.com/users/sillvva/following{/other_user}","gists_url":"https://api.github.com/users/sillvva/gists{/gist_id}","starred_url":"https://api.github.com/users/sillvva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sillvva/subscriptions","organizations_url":"https://api.github.com/users/sillvva/orgs","repos_url":"https://api.github.com/users/sillvva/repos","events_url":"https://api.github.com/users/sillvva/events{/privacy}","received_events_url":"https://api.github.com/users/sillvva/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2025-09-22T17:33:41Z","updated_at":"2025-09-22T18:11:08Z","closed_at":"2025-09-22T18:11:08Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nAfter upgrading from `@sveltejs/kit` 2.42.2 to 2.43.0, I get the following error in my local dev environment. It is hitting this error in one of my `hooks.server.ts` handles. \n```\nInternal Error {\n  error: Error: Can only read the current request event inside functions invoked during `handle`, such as server `load` functions, actions, endpoints, and other server hooks.\n      at getRequestEvent (/Users/sillvva/Projects/ddal-svelte/node_modules/.pnpm/@sveltejs+kit@2.43.0_@sveltejs+vite-plugin-svelte@6.2.0_svelte@5.39.4_vite@7.1.7_@types_357898af6df0adae12b9a5a39d6c1d29/node_modules/@sveltejs/kit/src/exports/internal/event.js:39:9)\n      at run (/Users/sillvva/Projects/ddal-svelte/src/lib/server/effect/runtime.ts:48:16)\n      at authHandler (/Users/sillvva/Projects/ddal-svelte/src/hooks.server.ts:43:2)\n      at file:///Users/sillvva/Projects/ddal-svelte/node_modules/.pnpm/@sveltejs+kit@2.43.0_@sveltejs+vite-plugin-svelte@6.2.0_svelte@5.39.4_vite@7.1.7_@types_357898af6df0adae12b9a5a39d6c1d29/node_modules/@sveltejs/kit/src/exports/hooks/sequence.js:103:7\n      at AsyncLocalStorage.run (node:internal/async_local_storage/async_hooks:91:14)\n      at with_request_store (file:///Users/sillvva/Projects/ddal-svelte/node_modules/.pnpm/@sveltejs+kit@2.43.0_@sveltejs+vite-plugin-svelte@6.2.0_svelte@5.39.4_vite@7.1.7_@types_357898af6df0adae12b9a5a39d6c1d29/node_modules/@sveltejs/kit/src/exports/internal/event.js:65:20)\n      at fn (file:///Users/sillvva/Projects/ddal-svelte/node_modules/.pnpm/@sveltejs+kit@2.43.0_@sveltejs+vite-plugin-svelte@6.2.0_svelte@5.39.4_vite@7.1.7_@types_357898af6df0adae12b9a5a39d6c1d29/node_modules/@sveltejs/kit/src/exports/hooks/sequence.js:102:19)\n      at Object.record_span (/Users/sillvva/Projects/ddal-svelte/node_modules/.pnpm/@sveltejs+kit@2.43.0_@sveltejs+vite-plugin-svelte@6.2.0_svelte@5.39.4_vite@7.1.7_@types_357898af6df0adae12b9a5a39d6c1d29/node_modules/@sveltejs/kit/src/runtime/telemetry/record_span.js:9:10)\n      at apply_handle (file:///Users/sillvva/Projects/ddal-svelte/node_modules/.pnpm/@sveltejs+kit@2.43.0_@sveltejs+vite-plugin-svelte@6.2.0_svelte@5.39.4_vite@7.1.7_@types_357898af6df0adae12b9a5a39d6c1d29/node_modules/@sveltejs/kit/src/exports/hooks/sequence.js:97:25)\n      at resolve (file:///Users/sillvva/Projects/ddal-svelte/node_modules/.pnpm/@sveltejs+kit@2.43.0_@sveltejs+vite-plugin-svelte@6.2.0_svelte@5.39.4_vite@7.1.7_@types_357898af6df0adae12b9a5a39d6c1d29/node_modules/@sveltejs/kit/src/exports/hooks/sequence.js:128:12),\n```\nThe `run` function is a custom function getting called in the handle that calls `getRequestEvent` to get the locals. I use `getRequestEvent`, because the `run` function is used in multiple places, not just hooks.\n```ts\nconst authHandler: Handle = async ({ event, resolve }) =>\n\trun(function* () {\n\t\tconst Auth = yield* AuthService;\n\t\tconst auth = yield* Auth.auth();\n\t\treturn svelteKitHandler({ event, resolve, auth, building });\n\t});\n```\nDowngrading to 2.42.2 fixes the error.\n\n### Reproduction\n\nIn the reproduction, I get a slightly different error:\nhttps://stackblitz.com/edit/sveltejs-kit-template-default-yym6ubrm?file=src%2Froutes%2F%2Blayout.svelte\n```\nError: Could not get the request store. This is an internal error.\n    at get_request_store (node_modules/@sveltejs/kit/src/exports/internal/event.js:54:9)\n    at wrapper (node_modules/@sveltejs/kit/src/runtime/app/server/remote/query.js:80:71)\n    at eval (src/routes/+page.svelte:18:78)\n    at Renderer.child (node_modules/svelte/src/internal/server/renderer.js:141:18)\n    at Renderer.async (node_modules/svelte/src/internal/server/renderer.js:119:8)\n    at eval (src/routes/+page.svelte:17:15)\n    at Renderer.child (node_modules/svelte/src/internal/server/renderer.js:141:18)\n    at Renderer.component (node_modules/svelte/src/internal/server/renderer.js:166:22)\n    at _page (src/routes/+page.svelte:15:13)\n```\n\n### Logs\n\n```Shell\n\n```\n\n### System Info\n\n```Shell\nSystem:\n    OS: macOS 26.0\n    CPU: (16) arm64 Apple M4 Max\n    Memory: 1.12 GB / 48.00 GB\n    Shell: 5.9 - /bin/zsh\n  Binaries:\n    Node: 22.12.0 - ~/.nvm/versions/node/v22.12.0/bin/node\n    npm: 10.9.0 - ~/.nvm/versions/node/v22.12.0/bin/npm\n    pnpm: 10.11.0 - ~/.nvm/versions/node/v22.12.0/bin/pnpm\n    bun: 1.2.20 - ~/.bun/bin/bun\n  Browsers:\n    Safari: 26.0\n  npmPackages:\n    @sveltejs/adapter-node: ^5.3.2 => 5.3.2 \n    @sveltejs/kit: ^2.42.2 => 2.42.2 \n    @sveltejs/vite-plugin-svelte: ^6.2.0 => 6.2.0 \n    svelte: ^5.39.4 => 5.39.4 \n    vite: ^7.1.7 => 7.1.7\n```\n\n### Severity\n\nblocking an upgrade\n\n### Additional Information\n\n_No response_","closed_by":{"login":"dummdidumm","id":5968653,"node_id":"MDQ6VXNlcjU5Njg2NTM=","avatar_url":"https://avatars.githubusercontent.com/u/5968653?v=4","gravatar_id":"","url":"https://api.github.com/users/dummdidumm","html_url":"https://github.com/dummdidumm","followers_url":"https://api.github.com/users/dummdidumm/followers","following_url":"https://api.github.com/users/dummdidumm/following{/other_user}","gists_url":"https://api.github.com/users/dummdidumm/gists{/gist_id}","starred_url":"https://api.github.com/users/dummdidumm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dummdidumm/subscriptions","organizations_url":"https://api.github.com/users/dummdidumm/orgs","repos_url":"https://api.github.com/users/dummdidumm/repos","events_url":"https://api.github.com/users/dummdidumm/events{/privacy}","received_events_url":"https://api.github.com/users/dummdidumm/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/14505/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/14505/timeline","performed_via_github_app":null,"state_reason":"completed"}