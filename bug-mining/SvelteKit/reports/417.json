{"url":"https://api.github.com/repos/sveltejs/kit/issues/10284","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/10284/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/10284/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/10284/events","html_url":"https://github.com/sveltejs/kit/issues/10284","id":1781228935,"node_id":"I_kwDOEiPr8c5qK2WH","number":10284,"title":"Node-adapted app crashes on request if referenced ADDRESS_HEADER is missing","user":{"login":"Conduitry","id":16696352,"node_id":"MDQ6VXNlcjE2Njk2MzUy","avatar_url":"https://avatars.githubusercontent.com/u/16696352?v=4","gravatar_id":"","url":"https://api.github.com/users/Conduitry","html_url":"https://github.com/Conduitry","followers_url":"https://api.github.com/users/Conduitry/followers","following_url":"https://api.github.com/users/Conduitry/following{/other_user}","gists_url":"https://api.github.com/users/Conduitry/gists{/gist_id}","starred_url":"https://api.github.com/users/Conduitry/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Conduitry/subscriptions","organizations_url":"https://api.github.com/users/Conduitry/orgs","repos_url":"https://api.github.com/users/Conduitry/repos","events_url":"https://api.github.com/users/Conduitry/events{/privacy}","received_events_url":"https://api.github.com/users/Conduitry/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2428470026,"node_id":"MDU6TGFiZWwyNDI4NDcwMDI2","url":"https://api.github.com/repos/sveltejs/kit/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2873676120,"node_id":"MDU6TGFiZWwyODczNjc2MTIw","url":"https://api.github.com/repos/sveltejs/kit/labels/pkg:adapter-node","name":"pkg:adapter-node","color":"FDECD3","default":false,"description":""},{"id":3229640667,"node_id":"MDU6TGFiZWwzMjI5NjQwNjY3","url":"https://api.github.com/repos/sveltejs/kit/labels/p1-important","name":"p1-important","color":"2C3488","default":false,"description":"SvelteKit cannot be used by a large number of people, basic functionality is missing, etc."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-06-29T17:18:26Z","updated_at":"2023-06-30T09:31:08Z","closed_at":"2023-06-30T09:31:08Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\nMaking a request to a non-prerendered page of a Node-adapter application with `ADDRESS_HEADER` set to a header that's not present in the request crashes the application. This happens even if the user code does not use `getClientAddress` anywhere.\r\n\r\n### Reproduction\r\n\r\n1. Start with the default demo app\r\n2. Swap out the auto adapter for the Node adapter\r\n3. Build it with `npm run build`\r\n4. Start it with `ADDRESS_HEADER=blah node build`\r\n5. Run `curl localhost:3000/sverdle`\r\n\r\nThis crashes the server for me. Interestingly, `curl localhost:3000` does _not_ crash the server, presumably because that page is prerendered.\r\n\r\n### Logs\r\n\r\n```Shell\r\nError: Address header was specified with ADDRESS_HEADER=blah but is absent from request\r\n    at Array.ssr (file:///.../build/handler.js:1198:9)\r\n```\r\n\r\n\r\n### System Info\r\n\r\n```Shell\r\nSystem:\r\n    OS: Linux 5.15 Ubuntu 22.04.2 LTS 22.04.2 LTS (Jammy Jellyfish)\r\n    CPU: (16) x64 AMD Ryzen 9 4900HS with Radeon Graphics\r\n    Memory: 14.28 GB / 19.25 GB\r\n    Container: Yes\r\n    Shell: 5.1.16 - /bin/bash\r\n  Binaries:\r\n    Node: 20.3.1\r\n    Yarn: 1.22.19\r\n    npm: 9.6.7\r\n    pnpm: 8.6.3\r\n  npmPackages:\r\n    @sveltejs/adapter-node: ^1.0.0 => 1.2.4\r\n    @sveltejs/kit: ^1.20.4 => 1.21.0\r\n    svelte: ^4.0.0 => 4.0.1\r\n    vite: ^4.3.6 => 4.3.9\r\n```\r\n\r\n\r\n### Severity\r\n\r\nserious, but I can work around it\r\n\r\n### Additional Information\r\n\r\nI think we should just move the check for the header referenced in `ADDRESS_HEADER` into the `getClientAddress` callback we pass back from the adapted output. We definitely don't want to crash the app. Another possibility would be to make that be an instant 500 without calling any of the underlying SvelteKit code (and without waiting for `getClientAddress()` to be called), but that doesn't seem quite necessary (maybe the user wants to handle that case!) and I'm not sure what a nice way to do that would be without duplicating SvelteKIt's `error.html` templating logic.\r\n\r\nI'm working around this for now by simply using the appropriate headers directly - with my own fallbacks if they don't exist - rather than trying to use `getClientAddress()`.","closed_by":{"login":"dummdidumm","id":5968653,"node_id":"MDQ6VXNlcjU5Njg2NTM=","avatar_url":"https://avatars.githubusercontent.com/u/5968653?v=4","gravatar_id":"","url":"https://api.github.com/users/dummdidumm","html_url":"https://github.com/dummdidumm","followers_url":"https://api.github.com/users/dummdidumm/followers","following_url":"https://api.github.com/users/dummdidumm/following{/other_user}","gists_url":"https://api.github.com/users/dummdidumm/gists{/gist_id}","starred_url":"https://api.github.com/users/dummdidumm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dummdidumm/subscriptions","organizations_url":"https://api.github.com/users/dummdidumm/orgs","repos_url":"https://api.github.com/users/dummdidumm/repos","events_url":"https://api.github.com/users/dummdidumm/events{/privacy}","received_events_url":"https://api.github.com/users/dummdidumm/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/10284/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/10284/timeline","performed_via_github_app":null,"state_reason":"completed"}