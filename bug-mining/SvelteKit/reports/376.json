{"url":"https://api.github.com/repos/sveltejs/kit/issues/9098","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/9098/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/9098/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/9098/events","html_url":"https://github.com/sveltejs/kit/issues/9098","id":1589986808,"node_id":"I_kwDOEiPr8c5exUX4","number":9098,"title":"Snapshots are saved when tab becomes hidden, not when it is unloaded","user":{"login":"Conduitry","id":16696352,"node_id":"MDQ6VXNlcjE2Njk2MzUy","avatar_url":"https://avatars.githubusercontent.com/u/16696352?v=4","gravatar_id":"","url":"https://api.github.com/users/Conduitry","html_url":"https://github.com/Conduitry","followers_url":"https://api.github.com/users/Conduitry/followers","following_url":"https://api.github.com/users/Conduitry/following{/other_user}","gists_url":"https://api.github.com/users/Conduitry/gists{/gist_id}","starred_url":"https://api.github.com/users/Conduitry/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Conduitry/subscriptions","organizations_url":"https://api.github.com/users/Conduitry/orgs","repos_url":"https://api.github.com/users/Conduitry/repos","events_url":"https://api.github.com/users/Conduitry/events{/privacy}","received_events_url":"https://api.github.com/users/Conduitry/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2428470026,"node_id":"MDU6TGFiZWwyNDI4NDcwMDI2","url":"https://api.github.com/repos/sveltejs/kit/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":3229642339,"node_id":"MDU6TGFiZWwzMjI5NjQyMzM5","url":"https://api.github.com/repos/sveltejs/kit/labels/p2-nice-to-have","name":"p2-nice-to-have","color":"A7463B","default":false,"description":"SvelteKit cannot be used by a small number of people, quality of life improvements, etc."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2023-02-17T21:33:47Z","updated_at":"2023-03-08T13:33:24Z","closed_at":"2023-03-08T13:33:24Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nThe data for snapshots is currently saved when the `visibilitychange` event fires and we have `document.visibilityState === 'hidden'`. This isn't quite what we want.\r\n\r\nThis will fire prematurely if someone switches to another tab in their browser, or minimizes it. There's no need to persist the state yet in these cases.\r\n\r\nMore seriously: It will fail to fire on Firefox when the user closes the tab. We're not persisting the snapshot data in that case, and if they restore the tab, it will not get the restored data. Interestingly, it _does_ get persisted when refreshing the page in Firefox.\r\n\r\nIn Chrome, this even appears to also be fired when closing the tab, so we don't see the same issue there.\n\n### Reproduction\n\nNone currently, apologies. This should occur with the snapshots example https://kit.svelte.dev/docs/snapshots as-is.\n\n### Logs\n\n```Shell\nn/a\n```\n\n\n### System Info\n\n```Shell\nSystem:\r\n    OS: Linux 5.15 Ubuntu 20.04.5 LTS (Focal Fossa)\r\n    CPU: (8) x64 Intel(R) Core(TM) i7-10510U CPU @ 1.80GHz\r\n    Memory: 3.92 GB / 7.66 GB\r\n    Container: Yes\r\n    Shell: 5.0.17 - /bin/bash\r\n  Binaries:\r\n    Node: 18.8.0 - ~/.bin/nodejs/current/bin/node\r\n    Yarn: 1.22.19 - ~/.bin/nodejs/current/bin/yarn\r\n    npm: 8.18.0 - ~/.bin/nodejs/current/bin/npm\r\n  npmPackages:\r\n    @sveltejs/adapter-node: 1.1.7 => 1.1.7 \r\n    @sveltejs/kit: 1.5.0 => 1.5.0 \r\n    svelte: 3.55.1 => 3.55.1 \r\n    vite: 4.1.1 => 4.1.1\n```\n\n\n### Severity\n\nannoyance\n\n### Additional Information\n\nIs `beforeunload` considered bad form for this? Do we have other options? It would be nice to switch to something that doesn't have the false positives and false negatives of `document.visibilityState`.","closed_by":{"login":"dummdidumm","id":5968653,"node_id":"MDQ6VXNlcjU5Njg2NTM=","avatar_url":"https://avatars.githubusercontent.com/u/5968653?v=4","gravatar_id":"","url":"https://api.github.com/users/dummdidumm","html_url":"https://github.com/dummdidumm","followers_url":"https://api.github.com/users/dummdidumm/followers","following_url":"https://api.github.com/users/dummdidumm/following{/other_user}","gists_url":"https://api.github.com/users/dummdidumm/gists{/gist_id}","starred_url":"https://api.github.com/users/dummdidumm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dummdidumm/subscriptions","organizations_url":"https://api.github.com/users/dummdidumm/orgs","repos_url":"https://api.github.com/users/dummdidumm/repos","events_url":"https://api.github.com/users/dummdidumm/events{/privacy}","received_events_url":"https://api.github.com/users/dummdidumm/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/9098/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/9098/timeline","performed_via_github_app":null,"state_reason":"completed"}