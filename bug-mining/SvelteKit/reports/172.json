{"url":"https://api.github.com/repos/sveltejs/kit/issues/7072","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/7072/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/7072/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/7072/events","html_url":"https://github.com/sveltejs/kit/issues/7072","id":1390040616,"node_id":"I_kwDOEiPr8c5S2lYo","number":7072,"title":"Provide the default callback to `enhance`","user":{"login":"geoffrich","id":4992896,"node_id":"MDQ6VXNlcjQ5OTI4OTY=","avatar_url":"https://avatars.githubusercontent.com/u/4992896?v=4","gravatar_id":"","url":"https://api.github.com/users/geoffrich","html_url":"https://github.com/geoffrich","followers_url":"https://api.github.com/users/geoffrich/followers","following_url":"https://api.github.com/users/geoffrich/following{/other_user}","gists_url":"https://api.github.com/users/geoffrich/gists{/gist_id}","starred_url":"https://api.github.com/users/geoffrich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/geoffrich/subscriptions","organizations_url":"https://api.github.com/users/geoffrich/orgs","repos_url":"https://api.github.com/users/geoffrich/repos","events_url":"https://api.github.com/users/geoffrich/events{/privacy}","received_events_url":"https://api.github.com/users/geoffrich/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2428470046,"node_id":"MDU6TGFiZWwyNDI4NDcwMDQ2","url":"https://api.github.com/repos/sveltejs/kit/labels/feature%20/%20enhancement","name":"feature / enhancement","color":"a2eeef","default":false,"description":"New feature or request"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sveltejs/kit/milestones/3","html_url":"https://github.com/sveltejs/kit/milestone/3","labels_url":"https://api.github.com/repos/sveltejs/kit/milestones/3/labels","id":6045098,"node_id":"MDk6TWlsZXN0b25lNjA0NTA5OA==","number":3,"title":"non-urgent","description":"stuff that's not time-sensitive","creator":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":121,"closed_issues":235,"state":"open","created_at":"2020-10-29T02:28:56Z","updated_at":"2025-10-03T09:31:01Z","due_on":null,"closed_at":null},"comments":5,"created_at":"2022-09-28T23:07:32Z","updated_at":"2022-09-30T16:49:01Z","closed_at":"2022-09-30T16:49:01Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the problem\n\nI've seen people try to add a loading state via enhance a couple times. They do something like this:\r\n\r\n```\r\n<form use:enhance={() => {\r\n  loading = true;\r\n  return () => {\r\n    loading = false;\r\n  }\r\n}}>\r\n```\r\n\r\n\r\nHowever, they don't realize that once you return a callback from the function passed to enhance, the default behavior after a form submission no longer applies and you have to do the following yourself:\r\n\r\n- run `invalidateAll` if the result was a success\r\n- run `applyAction` if the current location matches or the result was a redirect/error\r\n\r\nThis logic currently happens in the [default callback](https://github.com/sveltejs/kit/blob/fdb166cb80949c2f54093a7787bcd5eb43524666/packages/kit/src/runtime/app/forms.js#L26-L40).\r\n\r\nThis means if you want to extend `enhance`, e.g. to add a loading state, you have to duplicate that logic, even if your customizations are minimal:\r\n\r\n```diff\r\n<form use:enhance={() => {\r\n  loading = true;\r\n  return ({action, result}) => {\r\n+    if (result.type === 'success') {\r\n+      await invalidateAll();\r\n+    }\r\n+\r\n+    if (\r\n+      location.origin + location.pathname === action.origin + action.pathname ||\r\n+      result.type === 'redirect' ||\r\n+      result.type === 'error'\r\n+    ) {\r\n+      applyAction(result);\r\n+    }\r\n\r\n    loading = false;\r\n  }\r\n}}>\r\n```\r\n\r\n(You could remove the check around `applyAction` and always apply it, but I don't like how that diverges you from the default `enhance` behavior, perhaps without even realizing it).\r\n\r\nYou can abstract this into a custom action that wraps `enhance` to reduce the boilerplate, but you won't get any updates that are made to the default callback behavior, e.g. the changes in https://github.com/sveltejs/kit/pull/6828.\r\n\r\nAll you wanted to do was toggle a loading state, but now you have to maintain the default `enhance` behavior as well.\r\n\r\nOf course, there are cases where you want to customize the invalidate or `applyAction` behavior. However, I suspect those cases are more the exception than the norm.\n\n### Describe the proposed solution\n\nProvide an additional argument to the callback returned from enhance. Name is bikesheddable, but for the purposes of this issue I'll call it `defaultBehavior`. The implementation of this method is the same as [fallback_callback](https://github.com/sveltejs/kit/blob/fdb166cb80949c2f54093a7787bcd5eb43524666/packages/kit/src/runtime/app/forms.js#L26-L40). People who want to add some logic after a form submission _and_ preserve the default behavior could call this method instead of recreating the logic themselves. This way, if the default behavior is updated, custom actions calling this method get it for free.\r\n\r\nThe example above would then look like this:\r\n\r\n```html\r\n<form use:enhance={() => {\r\n  loading = true;\r\n  return ({action, result, defaultBehavior}) => {\r\n    defaultBehavior();\r\n    loading = false;\r\n  }\r\n}}>\r\n```\r\n\r\nIf people want to write enhance callbacks that _always_ do the default callback behavior, then they could create their own action that calls `defaultBehavior` without having to track any updates to the behavior.\r\n\r\n\n\n### Alternatives considered\n\nOne alternative is to keep the status quo and require the user to duplicate the default behavior if desired.\r\n\r\nAnother alternative is to call `fallback_callback` automatically after the returned callback runs, but also pass a `cancel` arg to the returned callback that would prevent that behavior if desired. \r\n\r\n```html\r\n<form use:enhance={() => {\r\n  loading = true;\r\n  return ({action, result, cancel}) => {\r\n    // invalidate & applyAction called automatically, unless cancel is called\r\n    loading = false;\r\n  }\r\n}}>\r\n```\r\n\r\nThis makes the default case simpler. However, this has a few downsides:\r\n\r\n- it's a breaking change for people returning a callback that didn't want `invalidateAll` and `applyAction` called\r\n- because we need to run the provided callback to find out if `cancel` was called, there isn't a good way to run code after invalidation & applying the action has completed. Supplying `defaultBehavior` gives the user control over when invalidation happens.\n\n### Importance\n\nwould make my life easier\n\n### Additional Information\n\n_No response_","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/7072/reactions","total_count":10,"+1":10,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/7072/timeline","performed_via_github_app":null,"state_reason":"completed"}