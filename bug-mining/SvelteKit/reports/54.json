{"url":"https://api.github.com/repos/sveltejs/kit/issues/5399","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/5399/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/5399/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/5399/events","html_url":"https://github.com/sveltejs/kit/issues/5399","id":1296543977,"node_id":"I_kwDOEiPr8c5NR7Dp","number":5399,"title":"next.360 build fails with \"Maximum call stack size exceeded\" for large dynamic imports","user":{"login":"KeithAndreRose","id":37423459,"node_id":"MDQ6VXNlcjM3NDIzNDU5","avatar_url":"https://avatars.githubusercontent.com/u/37423459?v=4","gravatar_id":"","url":"https://api.github.com/users/KeithAndreRose","html_url":"https://github.com/KeithAndreRose","followers_url":"https://api.github.com/users/KeithAndreRose/followers","following_url":"https://api.github.com/users/KeithAndreRose/following{/other_user}","gists_url":"https://api.github.com/users/KeithAndreRose/gists{/gist_id}","starred_url":"https://api.github.com/users/KeithAndreRose/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/KeithAndreRose/subscriptions","organizations_url":"https://api.github.com/users/KeithAndreRose/orgs","repos_url":"https://api.github.com/users/KeithAndreRose/repos","events_url":"https://api.github.com/users/KeithAndreRose/events{/privacy}","received_events_url":"https://api.github.com/users/KeithAndreRose/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2022-07-06T22:13:33Z","updated_at":"2022-07-19T18:03:31Z","closed_at":"2022-07-19T18:03:31Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nStarting in next.360 my CI/CD build script failed with `[vite-plugin-svelte-kit] Maximum call stack size exceeded`\r\nI poked around and found it coming from recurse calls to the [`traverse`](https://github.com/sveltejs/kit/pull/5138/files#diff-08e4e1af2fd899a06cbc43d3abf8637e7a8d36429aa6845527b144bcd3c4373aR48) procedure added apart of #5138\r\n\r\nI modified the `traverse` function to debug\r\n```js\r\nfunction traverse(file, add_js) {\r\n  const chunk = manifest[file];\r\n  console.log('traversing chunk', {chunk})\r\n    \r\n  if (imports.has(chunk.file)) return;\r\n  if (add_js) imports.add(chunk.file);\r\n\r\n  if (chunk.css) {\r\n    chunk.css.forEach((file) => {\r\n      console.log('adding stylesheet', {file})\r\n      return stylesheets.add(file)\r\n   });\r\n }\r\n\r\n  if (chunk.imports) {\r\n    chunk.imports.forEach((file) => {\r\n      console.log('traversing import', {file})\r\n        return traverse(file, add_js)\r\n      });\r\n  }\r\n\r\n  if (add_dynamic_css && chunk.dynamicImports) {\r\n    chunk.dynamicImports.forEach((file) => {\r\n      console.log('traversing dynamic import', {file})\r\n        return traverse(file, false)\r\n      });\r\n    }\r\n}\r\n```\r\nand these where the last few lines.\r\n\r\n<img width=\"890\" alt=\"Screen Shot 2022-07-06 at 5 42 57 PM\" src=\"https://user-images.githubusercontent.com/37423459/177648624-2cff8e29-e1d5-4410-8a04-ad0cab2106be.png\">\r\n\r\nI had been dynamically importing [`monaco-editor`](https://github.com/microsoft/monaco-editor) in one my layouts. There are workaround importing via cdnjs however being able to dynamically import it is a lot more desired.\r\n\r\nScript to reproduce with starter project added below.\n\n### Reproduction\n\n```\r\nnpm create svelte my-app\r\ncd my-app\r\ncat <<EOT > src/routes/__layout.svelte\r\n<script>\r\n  import { onMount } from 'svelte';\r\n  onMount(async () => {\r\n    const monaco = await import('monaco-editor/esm/vs/editor/editor.main')\r\n    console.log({monaco})\r\n  })\r\n</script>\r\n\r\n<main>\r\n  <slot />\r\n</main>\r\nEOT\r\nnpm add monaco-editor\r\nnpm run build\r\n```\n\n### Logs\n\n```shell\n✓ 844 modules transformed.\r\n.svelte-kit/output/server/manifest.json                         1.77 KiB\r\n.svelte-kit/output/server/index.js                              73.11 KiB\r\n.svelte-kit/output/server/entries/endpoints/todos/index.js      1.33 KiB\r\n.svelte-kit/output/server/entries/pages/__layout.svelte.js      0.25 KiB\r\n.svelte-kit/output/server/entries/fallbacks/error.svelte.js     0.72 KiB\r\n.svelte-kit/output/server/entries/pages/about.svelte.js         1.51 KiB\r\n.svelte-kit/output/server/entries/pages/index.svelte.js         9.71 KiB\r\n.svelte-kit/output/server/entries/pages/todos/index.svelte.js   9.70 KiB\r\n.svelte-kit/output/server/chunks/index-6892bb9c.js              3.86 KiB\r\n.svelte-kit/output/server/chunks/hooks-ff4815b6.js              0.46 KiB\r\n[vite-plugin-svelte-kit] Maximum call stack size exceeded\r\n➜  my-app\n```\n\n\n### System Info\n\n```shell\nSystem:\r\n    OS: macOS 12.5\r\n    CPU: (8) x64 Intel(R) Core(TM) i5-8257U CPU @ 1.40GHz\r\n    Memory: 36.78 MB / 16.00 GB\r\n    Shell: 5.8.1 - /bin/zsh\r\n  Binaries:\r\n    Node: 18.4.0 - ~/.nvm/versions/node/v18.4.0/bin/node\r\n    Yarn: 1.22.10 - /usr/local/bin/yarn\r\n    npm: 8.12.1 - ~/.nvm/versions/node/v18.4.0/bin/npm\r\n  Browsers:\r\n    Brave Browser: 103.1.40.107\r\n    Chrome: 103.0.5060.114\r\n    Firefox Nightly: 84.0a1\r\n    Safari: 15.6\r\n  npmPackages:\r\n    @sveltejs/adapter-auto: next => 1.0.0-next.54 \r\n    @sveltejs/kit: next => 1.0.0-next.360 \r\n    svelte: ^3.46.0 => 3.48.0 \r\n    vite: ^2.9.13 => 2.9.13\n```\n\n\n### Severity\n\nserious, but I can work around it\n\n### Additional Information\n\n_No response_","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/5399/reactions","total_count":8,"+1":8,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/5399/timeline","performed_via_github_app":null,"state_reason":"completed"}