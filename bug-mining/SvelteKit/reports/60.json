{"url":"https://api.github.com/repos/sveltejs/kit/issues/3371","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/3371/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/3371/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/3371/events","html_url":"https://github.com/sveltejs/kit/issues/3371","id":1105071915,"node_id":"I_kwDOEiPr8c5B3g8r","number":3371,"title":"Line numbers in browser stack trace are off by 2 for .js files","user":{"login":"Vages","id":3520744,"node_id":"MDQ6VXNlcjM1MjA3NDQ=","avatar_url":"https://avatars.githubusercontent.com/u/3520744?v=4","gravatar_id":"","url":"https://api.github.com/users/Vages","html_url":"https://github.com/Vages","followers_url":"https://api.github.com/users/Vages/followers","following_url":"https://api.github.com/users/Vages/following{/other_user}","gists_url":"https://api.github.com/users/Vages/gists{/gist_id}","starred_url":"https://api.github.com/users/Vages/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Vages/subscriptions","organizations_url":"https://api.github.com/users/Vages/orgs","repos_url":"https://api.github.com/users/Vages/repos","events_url":"https://api.github.com/users/Vages/events{/privacy}","received_events_url":"https://api.github.com/users/Vages/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2428470026,"node_id":"MDU6TGFiZWwyNDI4NDcwMDI2","url":"https://api.github.com/repos/sveltejs/kit/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":3229640667,"node_id":"MDU6TGFiZWwzMjI5NjQwNjY3","url":"https://api.github.com/repos/sveltejs/kit/labels/p1-important","name":"p1-important","color":"2C3488","default":false,"description":"SvelteKit cannot be used by a large number of people, basic functionality is missing, etc."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sveltejs/kit/milestones/2","html_url":"https://github.com/sveltejs/kit/milestone/2","labels_url":"https://api.github.com/repos/sveltejs/kit/milestones/2/labels","id":6044960,"node_id":"MDk6TWlsZXN0b25lNjA0NDk2MA==","number":2,"title":"1.0","description":"stuff we need to nail down before launch","creator":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":628,"state":"closed","created_at":"2020-10-29T01:17:50Z","updated_at":"2022-12-19T11:47:29Z","due_on":null,"closed_at":"2022-12-19T11:47:29Z"},"comments":3,"created_at":"2022-01-16T14:48:55Z","updated_at":"2022-07-21T18:16:42Z","closed_at":"2022-07-21T18:16:42Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\nWhen displaying stack traces in the browser, the line numbers are _sometimes_ off by 2. See reproduction repo below.\r\n\r\n#### capitalize-test: always off by 2 in browser\r\n\r\nTry opening capitalize-test (probably http://localhost:3000/capitalize-test) in your browser. The stacktrace output in the browser will always be as follows (note the line 2 in `/src/routes/_capitalize.js:2:22`, while the line actually occurs on line 4 in the file):\r\n\r\n```\r\nCannot read property 'toUpperCase' of undefined\r\n\r\nTypeError: Cannot read property 'toUpperCase' of undefined\r\n    at Module.capitalize (/src/routes/_capitalize.js:2:22)\r\n    at capitalize-test.svelte:5:16\r\n    at Object.$$render (<path-to-parent-folder>/offset-demo/node_modules/svelte/internal/index.js:1745:22)\r\n    at Object.default (root.svelte:43:47)\r\n    at eval (/.svelte-kit/runtime/components/layout.svelte:8:41)\r\n    at Object.$$render (<path-to-parent-folder>/offset-demo/node_modules/svelte/internal/index.js:1745:22)\r\n    at root.svelte:37:45\r\n    at $$render (<path-to-parent-folder>/offset-demo/node_modules/svelte/internal/index.js:1745:22)\r\n    at Object.render (<path-to-parent-folder>/offset-demo/node_modules/svelte/internal/index.js:1753:26)\r\n    at render_response (file://<path-to-parent-folder>/offset-demo/node_modules/@sveltejs/kit/dist/chunks/index.js:651:28)\r\n```\r\n\r\nThe output in the terminal from the dev server correctly displays line 4 in the stack trace:\r\n\r\n```\r\nCannot read property 'toUpperCase' of undefined\r\nTypeError: Cannot read property 'toUpperCase' of undefined\r\n    at Module.capitalize (/src/routes/_capitalize.js:4:22)\r\n    at capitalize-test.svelte:5:16\r\n    at Object.$$render (<path-to-parent-folder>/offset-demo/node_modules/svelte/internal/index.js:1745:22)\r\n    at Object.default (root.svelte:43:47)\r\n    at eval (/.svelte-kit/runtime/components/layout.svelte:8:41)\r\n    at Object.$$render (<path-to-parent-folder>/offset-demo/node_modules/svelte/internal/index.js:1745:22)\r\n    at root.svelte:37:45\r\n    at $$render (<path-to-parent-folder>/offset-demo/node_modules/svelte/internal/index.js:1745:22)\r\n    at Object.render (<path-to-parent-folder>/offset-demo/node_modules/svelte/internal/index.js:1753:26)\r\n    at render_response (file://<path-to-parent-folder>/offset-demo/node_modules/@sveltejs/kit/dist/chunks/index.js:651:28)\r\n```\r\n\r\nTry refreshing a couple of times. It should not make a difference to the server or browser output.\r\n\r\n#### on-line-1-test: \r\n\r\n##### off by 2 in browser on first load\r\n\r\nTry opening on-line-1-test (probably http://localhost:3000/on-line-1-test) in your browser. The stacktrace output in the browser is as follows on the first try:\r\n\r\n```\r\nLine must be greater than or equal to 1, got -1\r\n\r\nTypeError: Line must be greater than or equal to 1, got -1\r\n    at BasicSourceMapConsumer.SourceMapConsumer_findMapping [as _findMapping] (<path-to-parent-folder>/offset-demo/node_modules/vite/dist/node/chunks/dep-0351185a.js:58884:13)\r\n    at BasicSourceMapConsumer.SourceMapConsumer_originalPositionFor [as originalPositionFor] (<path-to-parent-folder>/offset-demo/node_modules/vite/dist/node/chunks/dep-0351185a.js:58953:22)\r\n    at <path-to-parent-folder>/offset-demo/node_modules/vite/dist/node/chunks/dep-0351185a.js:59894:34\r\n    at String.replace (<anonymous>)\r\n    at <path-to-parent-folder>/offset-demo/node_modules/vite/dist/node/chunks/dep-0351185a.js:59882:21\r\n    at Array.map (<anonymous>)\r\n    at ssrRewriteStacktrace (<path-to-parent-folder>/offset-demo/node_modules/vite/dist/node/chunks/dep-0351185a.js:59881:10)\r\n    at instantiateModule (<path-to-parent-folder>/offset-demo/node_modules/vite/dist/node/chunks/dep-0351185a.js:60105:28)\r\n```\r\n\r\nThe dev server gives roughly the same output.\r\n\r\n```\r\nTypeError: Cannot read property 'toUpperCase' of undefined\r\n    at /src/routes/_error-on-line-1.js:1:11\r\n    at instantiateModule (<path-to-parent-folder>/offset-demo/node_modules/vite/dist/node/chunks/dep-0351185a.js:60102:15)\r\nLine must be greater than or equal to 1, got -1\r\nTypeError: Line must be greater than or equal to 1, got -1\r\n    at BasicSourceMapConsumer.SourceMapConsumer_findMapping [as _findMapping] (<path-to-parent-folder>/offset-demo/node_modules/vite/dist/node/chunks/dep-0351185a.js:58884:13)\r\n    at BasicSourceMapConsumer.SourceMapConsumer_originalPositionFor [as originalPositionFor] (<path-to-parent-folder>/offset-demo/node_modules/vite/dist/node/chunks/dep-0351185a.js:58953:22)\r\n    at <path-to-parent-folder>/offset-demo/node_modules/vite/dist/node/chunks/dep-0351185a.js:59894:34\r\n    at String.replace (<anonymous>)\r\n    at <path-to-parent-folder>/offset-demo/node_modules/vite/dist/node/chunks/dep-0351185a.js:59882:21\r\n    at Array.map (<anonymous>)\r\n    at ssrRewriteStacktrace (<path-to-parent-folder>/offset-demo/node_modules/vite/dist/node/chunks/dep-0351185a.js:59881:10)\r\n    at instantiateModule (<path-to-parent-folder>/offset-demo/node_modules/vite/dist/node/chunks/dep-0351185a.js:60105:28)\r\n```\r\n\r\n##### Works if you refresh the page or open it in a new tab\r\n\r\nIf you refresh the page, you get an error message in the browser that looks correct to me (and no output from the dev server), but varies slightly by browser.\r\n\r\n###### Firefox\r\n```\r\nundefined has no properties\r\n\r\n@http://localhost:3000/src/routes/_error-on-line-1.js:1:1\r\n```\r\n\r\n###### Chrome\r\n```\r\nCannot read properties of undefined (reading 'toUpperCase')\r\nTypeError: Cannot read properties of undefined (reading 'toUpperCase')\r\n    at http://localhost:3000/src/routes/_error-on-line-1.js:1:11\r\n```\r\n\r\n###### Safari\r\n```\r\nundefined is not an object (evaluating 'undefined.toUpperCase')\r\nmodule code@http://localhost:3000/src/routes/_error-on-line-1.js:1:10\r\nevaluate@[native code]\r\nmoduleEvaluation@[native code]\r\nmoduleEvaluation@[native code]\r\n@[native code]\r\nasyncFunctionResume@[native code]\r\n@[native code]\r\npromiseReactionJobWithoutPromise@[native code]\r\npromiseReactionJob@[native code]\r\n```\r\n\r\n#### This applies to all supported node versions\r\n\r\nI have tried this with node versions 14, 16 and 17. The behavior is exactly the same in all cases.\r\n\r\n\r\n### Reproduction\r\n\r\n```bash\r\ngit clone https://github.com/Vages/offset-demo.git\r\ncd offset-demo\r\nnpm install\r\nnpm run dev\r\n```\r\n\r\nNavigate to the routes `capitalize-test` and `on-line-1-test`, probably found at these URLs:\r\n\r\n- http://localhost:3000/capitalize-test\r\n- http://localhost:3000/on-line-1-test\r\n\r\n### Logs\r\n\r\n_No response_\r\n\r\n### System Info\r\n\r\n```shell\r\nSystem:\r\n    OS: macOS 12.1\r\n    CPU: (16) x64 Intel(R) Core(TM) i9-9880H CPU @ 2.30GHz\r\n    Memory: 259.40 MB / 32.00 GB\r\n    Shell: 5.8 - /bin/zsh\r\n  Binaries:\r\n    Node: 14.18.3 - ~/.asdf/installs/nodejs/14.18.3/bin/node\r\n    Yarn: 1.22.4 - ~/.asdf/shims/yarn\r\n    npm: 6.14.15 - ~/.asdf/plugins/nodejs/shims/npm\r\n    Watchman: 2022.01.03.00 - /usr/local/bin/watchman\r\n  Browsers:\r\n    Chrome: 97.0.4692.71\r\n    Firefox: 95.0.2\r\n    Firefox Developer Edition: 70.0\r\n    Safari: 15.2\r\n  npmPackages:\r\n    @sveltejs/adapter-auto: next => 1.0.0-next.10 \r\n    @sveltejs/kit: next => 1.0.0-next.231 \r\n    svelte: ^3.44.0 => 3.46.2\r\n```\r\n\r\n\r\n### Severity\r\n\r\nserious, but I can work around it\r\n\r\n### Additional Information\r\n\r\n#### Possibly related issue\r\n\r\nI was able to find this Vite PR (from Rich Harris, accidentally â€“ or perhaps not), which compensates for stack trace offsets in node versions later than 13: https://github.com/vitejs/vite/pull/2266 I thought there could possibly be something different about node versions 14 and later and tried running the following script (named `offset.js`) in node versions 12 through 16.\r\n\r\n```\r\nlet offset\r\ntry {\r\n  new Function('throw new Error(1)')()\r\n} catch (e) {\r\n  // in Node 12, stack traces account for the function wrapper.\r\n  // in Node 13 and later, the function wrapper adds two lines,\r\n  // which must be subtracted to generate a valid mapping\r\n  console.log(e.stack);\r\n  const match = /:(\\d+):\\d+\\)$/.exec(e.stack.split('\\n')[1])\r\n  offset = match ? +match[1] - 1 : 0\r\n}\r\nconsole.log(offset);\r\n```\r\n\r\nThe output was consistent from versions 14 and on:\r\n\r\n```\r\nError: 1\r\n    at eval (eval at <anonymous> (<path-to-parent-folder>/offset.js:3:3), <anonymous>:3:7)\r\n    at Object.<anonymous> (<path-to-parent-folder>/offset.js:3:37)\r\n    at Module._compile (internal/modules/cjs/loader.js:1085:14)\r\n    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1114:10)\r\n    at Module.load (internal/modules/cjs/loader.js:950:32)\r\n    at Function.Module._load (internal/modules/cjs/loader.js:790:12)\r\n    at Function.executeUserEntryPoint [as runMain] (internal/modules/run_main.js:76:12)\r\n    at internal/main/run_main_module.js:17:47\r\n2\r\n```\r\n\r\nIf you put `offset.js` in a folder with a package.json containing the following, \r\n\r\n```json\r\n{\r\n  \"type\": \"module\"\r\n}\r\n```\r\n\r\n... you get the following stack trace instead:\r\n\r\n```\r\nError: 1\r\n    at eval (eval at <anonymous> (file://<path-to-parent-folder>/offset.js:3:3), <anonymous>:3:7)\r\n    at file://<path-to-parent-folder>/offset.js:3:37\r\n    at ModuleJob.run (internal/modules/esm/module_job.js:183:25)\r\n    at async Loader.import (internal/modules/esm/loader.js:178:24)\r\n    at async Object.loadESM (internal/process/esm_loader.js:68:5)\r\n2\r\n```","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/3371/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/3371/timeline","performed_via_github_app":null,"state_reason":"completed"}