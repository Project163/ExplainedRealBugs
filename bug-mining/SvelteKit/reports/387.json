{"url":"https://api.github.com/repos/sveltejs/kit/issues/9555","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/9555/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/9555/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/9555/events","html_url":"https://github.com/sveltejs/kit/issues/9555","id":1646862957,"node_id":"I_kwDOEiPr8c5iKSJt","number":9555,"title":"Better support for form action redirects inside handle() hook","user":{"login":"abirtley","id":19584280,"node_id":"MDQ6VXNlcjE5NTg0Mjgw","avatar_url":"https://avatars.githubusercontent.com/u/19584280?v=4","gravatar_id":"","url":"https://api.github.com/users/abirtley","html_url":"https://github.com/abirtley","followers_url":"https://api.github.com/users/abirtley/followers","following_url":"https://api.github.com/users/abirtley/following{/other_user}","gists_url":"https://api.github.com/users/abirtley/gists{/gist_id}","starred_url":"https://api.github.com/users/abirtley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abirtley/subscriptions","organizations_url":"https://api.github.com/users/abirtley/orgs","repos_url":"https://api.github.com/users/abirtley/repos","events_url":"https://api.github.com/users/abirtley/events{/privacy}","received_events_url":"https://api.github.com/users/abirtley/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2428470026,"node_id":"MDU6TGFiZWwyNDI4NDcwMDI2","url":"https://api.github.com/repos/sveltejs/kit/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2023-03-30T03:54:56Z","updated_at":"2023-04-17T17:39:45Z","closed_at":"2023-04-17T17:39:44Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the problem\r\n\r\nI would like to use hooks to handle things like ensuring session validity. This way, I can be sure that security settings are applied sitewide, and not have to remember to apply them in every single form action handler.\r\n\r\nBut hooks don't play nicely with redirects when it's a form action handler.\r\n\r\nLet's say you have this handler:\r\n\r\n```ts\r\n// hooks.server.ts\r\nexport const handle = async () => {\r\n  if (!isLoggedIn()) {\r\n    throw redirect(303, '/login');\r\n  }\r\n};\r\n```\r\n\r\nand these actions:\r\n\r\n```ts\r\n// +page.server.ts\r\nexport const actions = {\r\n  alwaysRedirects: async () => {\r\n    throw redirect(303, '/');\r\n  },\r\n  sometimesRedirects: async () => ({data: 'foo'}),\r\n};\r\n```\r\n\r\nand a `.svelte` file that has `<Form use:enhance=...>` and calls `applyAction(result)` if `result.type === 'redirect'`\r\n\r\nIt plays out as follows:\r\n\r\n* If your form action is `/?alwaysRedirects`, you always get redirected ✅\r\n* If your form action is `/sometimesRedirects`, and you are logged in, you get `{data: 'foo'}`  ✅\r\n* If your form action is `/sometimesRedirects`, and you are logged *out*, then:\r\n  * If javascript is disabled, you get redirected as you would expect ✅\r\n  * if javascript is enabled, `applyAction(result)` doesn't work because `result` is `{\"type\":\"error\",\"error\":Error('SyntaxError: Unexpected token '<', \"<!DOCTYPE \"... is not valid JSON')'}` ❌\r\n\r\nI believe this is because `throw redirect()` [is handled differently when you're in a form action handler vs when you're in a generic endpoint](https://github.com/sveltejs/kit/issues/7932#issuecomment-1336347727). So, when you throw a redirect from inside the `handle()` hook, SvelteKit doesn't \"know\" that it's a form action, and so doesn't return the redirect information in a format that the client javascript understands. Instead, the client tries to parse the `/` route (which has been returned as HTML) as JSON, and fails.\r\n\r\n### Describe the proposed solution\r\n\r\nI would like to see:\r\n\r\n* Documentation telling me how I can achieve this using existing functionality (I have looked...)\r\n\r\nFailing that, I would like to see:\r\n\r\n* If you throw a redirect inside the `handle()` hook, and you happen to be handling a form action at the time, the response is returned to the client in a manner that lets them redirect using `applyAction()`, as if the redirect were thrown inside the action handler itself.\r\n  * This could potentially be done using my header inspection and JSON object returning workaround, discussed below. If this is a \"good first issue\", I'd be happy to take this on with a small pointer in the right direction.\r\n\r\nI guess you could also have a separate hook for form actions, inside which `throw redirect(...)` would work as expected.\r\n\r\n### Alternatives considered\r\n\r\nMy current workaround is to inspect the request headers and, if an enhanced form is detected, return a Svelte redirect object instead of an actual redirect.\r\n\r\n```ts\r\n// inside handle() in hooks.server.ts\r\n\r\nif (!isLoggedIn()) {\r\n  const javascriptFormSubmission = event.request.headers.get('x-sveltekit-action') === 'true';\r\n  if (javascriptFormSubmission) {\r\n    return new Response(\r\n      JSON.stringify({\r\n        type: 'redirect',\r\n        status: 303,\r\n        location: '/login',\r\n      } satisfies ActionResult)\r\n    );\r\n  } else {\r\n    throw redirect(303, `/login`);\r\n  }\r\n}\r\n```\r\n\r\n### Importance\r\n\r\nnice to have\r\n\r\n### Additional Information\r\n\r\nThis is currently a nice-to-have, given the workaround is pretty simple, but I thought I'd write it up here in case other people encounter the same issue.","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/9555/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/9555/timeline","performed_via_github_app":null,"state_reason":"completed"}