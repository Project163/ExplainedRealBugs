{"url":"https://api.github.com/repos/sveltejs/kit/issues/5308","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/5308/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/5308/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/5308/events","html_url":"https://github.com/sveltejs/kit/issues/5308","id":1288018178,"node_id":"I_kwDOEiPr8c5MxZkC","number":5308,"title":"Shared config object is mutated","user":{"login":"benmccann","id":322311,"node_id":"MDQ6VXNlcjMyMjMxMQ==","avatar_url":"https://avatars.githubusercontent.com/u/322311?v=4","gravatar_id":"","url":"https://api.github.com/users/benmccann","html_url":"https://github.com/benmccann","followers_url":"https://api.github.com/users/benmccann/followers","following_url":"https://api.github.com/users/benmccann/following{/other_user}","gists_url":"https://api.github.com/users/benmccann/gists{/gist_id}","starred_url":"https://api.github.com/users/benmccann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benmccann/subscriptions","organizations_url":"https://api.github.com/users/benmccann/orgs","repos_url":"https://api.github.com/users/benmccann/repos","events_url":"https://api.github.com/users/benmccann/events{/privacy}","received_events_url":"https://api.github.com/users/benmccann/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2428470026,"node_id":"MDU6TGFiZWwyNDI4NDcwMDI2","url":"https://api.github.com/repos/sveltejs/kit/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-06-28T23:54:23Z","updated_at":"2022-07-05T19:54:20Z","closed_at":"2022-07-05T19:54:20Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\nSvelteKit's `vite/index.js` stores the config in `vite_user_config` and passes it into multiple builds. Vite mutates the config causing unexpected values for latter builds. This doesn't seem to be an issue for most users, but does cause issues with `vite-plugin-pwa`\r\n\r\n### Reproduction\r\n\r\nUpdate `svelte.config.js` for the site to the one below. Note that you need to comment out SvelteKit's `process.exit` for the Vite plugin to be invoked\r\n```\r\nimport * as path from 'path';\r\nimport adapter from '@sveltejs/adapter-auto';\r\nimport { imagetools } from 'vite-imagetools';\r\n\r\nlet viteConfig;\r\n\r\n/** @type {import('@sveltejs/kit').Config} */\r\nconst config = {\r\n\tkit: {\r\n\t\tadapter: adapter(),\r\n\r\n\t\tprerender: {\r\n\t\t\tdefault: true,\r\n\t\t\tentries: ['*', '/content.json']\r\n\t\t},\r\n\r\n\t\tvite: {\r\n\t\t\tplugins: [imagetools(), {\r\n\t\t\t\tname: \"vite-plugin-pwa\",\r\n\t\t\t\tenforce: \"post\",\r\n\t\t\t\tapply: \"build\",\r\n\t\t\t\tasync configResolved(config) {\r\n\t\t\t\t\tviteConfig = config;\r\n\t\t\t\t},\r\n\t\t\t\tasync closeBundle() {\r\n\t\t\t\t\tconsole.log(`IS SSR? ${viteConfig.build.ssr}`)\r\n\t\t\t\t}\r\n\t\t\t}],\r\n\r\n\t\t\tresolve: {\r\n\t\t\t\talias: {\r\n\t\t\t\t\t$img: path.resolve('src/images')\r\n\t\t\t\t}\r\n\t\t\t},\r\n\r\n\t\t\tserver: {\r\n\t\t\t\tfs: {\r\n\t\t\t\t\tstrict: false\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n};\r\n\r\nexport default config;\r\n```\r\n\r\n### Suggested Solution\r\n\r\nThe config above isn't one that can be cloned. Instead we need to do something like leave `vite-plugin-svelte-kit` in place, but make `writeBundle` a no-op unless it's the client build (or equivalently split the config stuff out into a separate plugin that's used for the server build as well)\r\n\r\n### System Info\r\n\r\n```shell\r\n`master`\r\n```\r\n\r\n\r\n### Severity\r\n\r\nPrevents https://github.com/userquin/pwa-sveltekit-vite from working\r\n\r\n### Additional Information\r\n\r\n_No response_","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/5308/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/5308/timeline","performed_via_github_app":null,"state_reason":"completed"}