{"url":"https://api.github.com/repos/sveltejs/kit/issues/7216","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/7216/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/7216/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/7216/events","html_url":"https://github.com/sveltejs/kit/issues/7216","id":1403590977,"node_id":"I_kwDOEiPr8c5TqRlB","number":7216,"title":"Unable to use firebase-admin + adapter-node (cannot be made external)","user":{"login":"CaptainCodeman","id":304910,"node_id":"MDQ6VXNlcjMwNDkxMA==","avatar_url":"https://avatars.githubusercontent.com/u/304910?v=4","gravatar_id":"","url":"https://api.github.com/users/CaptainCodeman","html_url":"https://github.com/CaptainCodeman","followers_url":"https://api.github.com/users/CaptainCodeman/followers","following_url":"https://api.github.com/users/CaptainCodeman/following{/other_user}","gists_url":"https://api.github.com/users/CaptainCodeman/gists{/gist_id}","starred_url":"https://api.github.com/users/CaptainCodeman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CaptainCodeman/subscriptions","organizations_url":"https://api.github.com/users/CaptainCodeman/orgs","repos_url":"https://api.github.com/users/CaptainCodeman/repos","events_url":"https://api.github.com/users/CaptainCodeman/events{/privacy}","received_events_url":"https://api.github.com/users/CaptainCodeman/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2428470026,"node_id":"MDU6TGFiZWwyNDI4NDcwMDI2","url":"https://api.github.com/repos/sveltejs/kit/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2873676120,"node_id":"MDU6TGFiZWwyODczNjc2MTIw","url":"https://api.github.com/repos/sveltejs/kit/labels/pkg:adapter-node","name":"pkg:adapter-node","color":"FDECD3","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sveltejs/kit/milestones/2","html_url":"https://github.com/sveltejs/kit/milestone/2","labels_url":"https://api.github.com/repos/sveltejs/kit/milestones/2/labels","id":6044960,"node_id":"MDk6TWlsZXN0b25lNjA0NDk2MA==","number":2,"title":"1.0","description":"stuff we need to nail down before launch","creator":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":628,"state":"closed","created_at":"2020-10-29T01:17:50Z","updated_at":"2022-12-19T11:47:29Z","due_on":null,"closed_at":"2022-12-19T11:47:29Z"},"comments":6,"created_at":"2022-10-10T19:01:20Z","updated_at":"2022-10-19T15:52:06Z","closed_at":"2022-10-19T13:58:13Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nTrying to use adapter-node with firebase-admin has been broken since the switch from esbuild to rollup (pinning to v92 of adapter-node works).\r\n\r\nWith the pinned version, the firebase-admin imports are retained in the server chunks, e.g.\r\n\r\n```ts\r\nimport { initializeApp } from \"firebase-admin/app\";\r\n```\r\n\r\nBut with any version after that, the firebase package is bundled in to the server code (but incorrectly, which causes an error).\r\n\r\nThe symptom is the error below, but the issue is really that firebase-admin is being bundled in no matter what.\r\n\r\n```\r\nError [ERR_MODULE_NOT_FOUND]: Cannot find package 'string_decoder' imported from /Users/simon/dev/thread-bare/experiment/build/server/chunks/2-2a51a21d.js\r\n    at new NodeError (node:internal/errors:393:5)\r\n    at packageResolve (node:internal/modules/esm/resolve:860:9)\r\n    at moduleResolve (node:internal/modules/esm/resolve:909:20)\r\n    at defaultResolve (node:internal/modules/esm/resolve:1124:11)\r\n    at nextResolve (node:internal/modules/esm/loader:163:28)\r\n    at ESMLoader.resolve (node:internal/modules/esm/loader:837:30)\r\n    at ESMLoader.getModuleJob (node:internal/modules/esm/loader:424:18)\r\n    at ModuleWrap.<anonymous> (node:internal/modules/esm/module_job:76:40)\r\n    at link (node:internal/modules/esm/module_job:75:36)\r\n```\n\n### Reproduction\n\nhttps://github.com/CaptainCodeman/svelte-kit-firebase-admin-external\n\n### Logs\n\n_No response_\n\n### System Info\n\n```shell\nSystem:\r\n    OS: macOS 12.6\r\n    CPU: (6) x64 Intel(R) Core(TM) i5-8500B CPU @ 3.00GHz\r\n    Memory: 1.68 GB / 32.00 GB\r\n    Shell: 5.8.1 - /bin/zsh\r\n  Binaries:\r\n    Node: 18.10.0 - ~/Library/pnpm/node\r\n    npm: 8.19.2 - ~/Library/pnpm/npm\r\n  Browsers:\r\n    Brave Browser: 102.1.39.111\r\n    Chrome: 106.0.5249.91\r\n    Chrome Canary: 108.0.5351.0\r\n    Firefox: 105.0.1\r\n    Safari: 16.0\r\n    Safari Technology Preview: 16.4\r\n  npmPackages:\r\n    @sveltejs/adapter-node: next => 1.0.0-next.96 \r\n    @sveltejs/kit: next => 1.0.0-next.512 \r\n    svelte: ^3.44.0 => 3.51.0 \r\n    vite: ^3.1.0 => 3.1.7\n```\n\n\n### Severity\n\nblocking an upgrade\n\n### Additional Information\n\nI tried to \"server module\" all the things, and also set thing to `external` in vite.config.js, but nothing seems to prevent it being bundled in. I've also tried changing it to be a devDependency (which I think would be incorrect, but was clutching at straws).","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/7216/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/7216/timeline","performed_via_github_app":null,"state_reason":"completed"}