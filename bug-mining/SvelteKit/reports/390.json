{"url":"https://api.github.com/repos/sveltejs/kit/issues/9463","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/9463/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/9463/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/9463/events","html_url":"https://github.com/sveltejs/kit/issues/9463","id":1632986351,"node_id":"I_kwDOEiPr8c5hVWTv","number":9463,"title":"Prerendered load function included in .svelte-kit/output/server","user":{"login":"jhwz","id":52683873,"node_id":"MDQ6VXNlcjUyNjgzODcz","avatar_url":"https://avatars.githubusercontent.com/u/52683873?v=4","gravatar_id":"","url":"https://api.github.com/users/jhwz","html_url":"https://github.com/jhwz","followers_url":"https://api.github.com/users/jhwz/followers","following_url":"https://api.github.com/users/jhwz/following{/other_user}","gists_url":"https://api.github.com/users/jhwz/gists{/gist_id}","starred_url":"https://api.github.com/users/jhwz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhwz/subscriptions","organizations_url":"https://api.github.com/users/jhwz/orgs","repos_url":"https://api.github.com/users/jhwz/repos","events_url":"https://api.github.com/users/jhwz/events{/privacy}","received_events_url":"https://api.github.com/users/jhwz/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2428470026,"node_id":"MDU6TGFiZWwyNDI4NDcwMDI2","url":"https://api.github.com/repos/sveltejs/kit/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-03-20T22:57:46Z","updated_at":"2023-04-17T21:27:18Z","closed_at":"2023-04-17T21:27:18Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\nIf you have a prerendered load function file, such as `+page.server.ts` the file is still included in `.svelte-kit/output/server` leading to errors when trying to adapt the output for another environment (in my case cloudflare pages).\r\n\r\nThis wasn't the case in version `1.4.0`, the issue seemed to be introduced after that.\r\n\r\n### Reproduction\r\n\r\n```sh\r\ngit clone https://github.com/jhwz/sveltekit-retains-prerender-assets\r\ncd sveltekit-retains-prerender-assets\r\nnpm i\r\nnpm run build\r\n```\r\n\r\n\r\n### Logs\r\n\r\n```Shell\r\nnpm run build\r\n\r\n> sveltekit-retains-prerender-assets@0.0.1 build\r\n> vite build\r\n\r\n\r\nvite v4.2.1 building SSR bundle for production...\r\n✓ 51 modules transformed.\r\n11:52:53 am [vite-plugin-svelte] ssr compile done.\r\npackage                                 files     time    avg\r\nsveltekit-retains-prerender-assets          5   36.6ms  7.3ms\r\n\r\nvite v4.2.1 building for production...\r\n✓ 42 modules transformed.\r\n11:52:54 am [vite-plugin-svelte] dom compile done.\r\npackage                                 files     time     avg\r\nsveltekit-retains-prerender-assets          3   32.2ms  10.7ms\r\n@sveltejs/kit                               2   13.7ms   6.8ms\r\n.svelte-kit/output/client/_app/version.json                                   0.03 kB\r\n.svelte-kit/output/client/vite-manifest.json                                  3.19 kB\r\n.svelte-kit/output/client/_app/immutable/chunks/2.b8de9f3d.js                 0.08 kB │ gzip: 0.10 kB\r\n.svelte-kit/output/client/_app/immutable/chunks/1.0b92327f.js                 0.08 kB │ gzip: 0.10 kB\r\n.svelte-kit/output/client/_app/immutable/chunks/0.982a38f9.js                 0.09 kB │ gzip: 0.10 kB\r\n.svelte-kit/output/client/_app/immutable/chunks/3.a583bede.js                 0.09 kB │ gzip: 0.10 kB\r\n.svelte-kit/output/client/_app/immutable/entry/test-page.svelte.d7818323.js   0.43 kB │ gzip: 0.31 kB\r\n.svelte-kit/output/client/_app/immutable/entry/_page.svelte.3e0ed68a.js       0.44 kB │ gzip: 0.32 kB\r\n.svelte-kit/output/client/_app/immutable/entry/layout.svelte.b0368388.js      0.54 kB │ gzip: 0.36 kB\r\n.svelte-kit/output/client/_app/immutable/entry/error.svelte.d45f1c66.js       0.98 kB │ gzip: 0.57 kB\r\n.svelte-kit/output/client/_app/immutable/chunks/singletons.0f64ce76.js        2.81 kB │ gzip: 1.44 kB\r\n.svelte-kit/output/client/_app/immutable/entry/app.eb989bb1.js                5.76 kB │ gzip: 2.27 kB\r\n.svelte-kit/output/client/_app/immutable/chunks/index.847936d9.js             7.06 kB │ gzip: 2.86 kB\r\n.svelte-kit/output/client/_app/immutable/entry/start.c881a30f.js             23.31 kB │ gzip: 9.28 kB\r\n✓ built in 274ms\r\n.svelte-kit/output/server/vite-manifest.json                      1.67 kB\r\n.svelte-kit/output/server/internal.js                             0.19 kB\r\n.svelte-kit/output/server/entries/pages/test/_page.server.ts.js   0.22 kB\r\n.svelte-kit/output/server/entries/pages/_page.svelte.js           0.22 kB\r\n.svelte-kit/output/server/entries/fallbacks/layout.svelte.js      0.24 kB\r\n.svelte-kit/output/server/entries/pages/test/_page.svelte.js      0.35 kB\r\n.svelte-kit/output/server/entries/fallbacks/error.svelte.js       0.83 kB\r\n.svelte-kit/output/server/chunks/index.js                         3.27 kB\r\n.svelte-kit/output/server/chunks/internal.js                      5.33 kB\r\n.svelte-kit/output/server/index.js                               84.89 kB\r\n\r\nRun npm run preview to preview your production build locally.\r\n\r\n> Using @sveltejs/adapter-cloudflare\r\n✘ [ERROR] Could not resolve \"fs\"\r\n\r\n    .svelte-kit/output/server/entries/pages/test/_page.server.ts.js:1:29:\r\n      1 │ import { readFileSync } from \"fs\";\r\n        ╵                              ~~~~\r\n\r\n  The package \"fs\" wasn't found on the file system but is built into node. Are you trying to bundle\r\n  for node? You can use \"platform: 'node'\" to do that, which will remove this error.\r\n\r\nerror during build:\r\nError: Build failed with 1 error:\r\n.svelte-kit/output/server/entries/pages/test/_page.server.ts.js:1:29: ERROR: Could not resolve \"fs\"\r\n    at failureErrorWithLog (/Users/joel/Desktop/sveltekit-retains-prerender-assets/node_modules/@sveltejs/adapter-cloudflare/node_modules/esbuild/lib/main.js:1604:15)\r\n    at /Users/joel/Desktop/sveltekit-retains-prerender-assets/node_modules/@sveltejs/adapter-cloudflare/node_modules/esbuild/lib/main.js:1056:28\r\n    at /Users/joel/Desktop/sveltekit-retains-prerender-assets/node_modules/@sveltejs/adapter-cloudflare/node_modules/esbuild/lib/main.js:1001:67\r\n    at buildResponseToResult (/Users/joel/Desktop/sveltekit-retains-prerender-assets/node_modules/@sveltejs/adapter-cloudflare/node_modules/esbuild/lib/main.js:1054:7)\r\n    at /Users/joel/Desktop/sveltekit-retains-prerender-assets/node_modules/@sveltejs/adapter-cloudflare/node_modules/esbuild/lib/main.js:1166:14\r\n    at responseCallbacks.<computed> (/Users/joel/Desktop/sveltekit-retains-prerender-assets/node_modules/@sveltejs/adapter-cloudflare/node_modules/esbuild/lib/main.js:701:9)\r\n    at handleIncomingPacket (/Users/joel/Desktop/sveltekit-retains-prerender-assets/node_modules/@sveltejs/adapter-cloudflare/node_modules/esbuild/lib/main.js:756:9)\r\n    at Socket.readFromStdout (/Users/joel/Desktop/sveltekit-retains-prerender-assets/node_modules/@sveltejs/adapter-cloudflare/node_modules/esbuild/lib/main.js:677:7)\r\n    at Socket.emit (node:events:527:28)\r\n    at addChunk (node:internal/streams/readable:315:12)\r\n```\r\n\r\n\r\n### System Info\r\n\r\n```Shell\r\nSystem:\r\n    OS: macOS 13.1\r\n    CPU: (8) arm64 Apple M1\r\n    Memory: 314.41 MB / 16.00 GB\r\n    Shell: 5.8.1 - /bin/zsh\r\n  Binaries:\r\n    Node: 16.16.0 - ~/.nvm/versions/node/v16.16.0/bin/node\r\n    npm: 8.19.2 - ~/.nvm/versions/node/v16.16.0/bin/npm\r\n  Browsers:\r\n    Brave Browser: 111.1.49.120\r\n    Chrome: 111.0.5563.64\r\n    Safari: 16.2\r\n  npmPackages:\r\n    @sveltejs/adapter-cloudflare: ^2.2.0 => 2.2.0 \r\n    @sveltejs/kit: ^1.5.0 => 1.13.0 \r\n    svelte: ^3.54.0 => 3.57.0 \r\n    vite: ^4.2.0 => 4.2.1 \r\n```\r\n\r\n\r\n### Severity\r\n\r\nblocking an upgrade\r\n\r\n### Additional Information\r\n\r\n_No response_","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/9463/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/9463/timeline","performed_via_github_app":null,"state_reason":"completed"}