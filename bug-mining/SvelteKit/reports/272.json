{"url":"https://api.github.com/repos/sveltejs/kit/issues/7929","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/7929/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/7929/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/7929/events","html_url":"https://github.com/sveltejs/kit/issues/7929","id":1474193674,"node_id":"I_kwDOEiPr8c5X3mkK","number":7929,"title":"Don't enforce url-encoding of cookies","user":{"login":"jb297686","id":108226444,"node_id":"U_kgDOBnNnjA","avatar_url":"https://avatars.githubusercontent.com/u/108226444?v=4","gravatar_id":"","url":"https://api.github.com/users/jb297686","html_url":"https://github.com/jb297686","followers_url":"https://api.github.com/users/jb297686/followers","following_url":"https://api.github.com/users/jb297686/following{/other_user}","gists_url":"https://api.github.com/users/jb297686/gists{/gist_id}","starred_url":"https://api.github.com/users/jb297686/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jb297686/subscriptions","organizations_url":"https://api.github.com/users/jb297686/orgs","repos_url":"https://api.github.com/users/jb297686/repos","events_url":"https://api.github.com/users/jb297686/events{/privacy}","received_events_url":"https://api.github.com/users/jb297686/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sveltejs/kit/milestones/2","html_url":"https://github.com/sveltejs/kit/milestone/2","labels_url":"https://api.github.com/repos/sveltejs/kit/milestones/2/labels","id":6044960,"node_id":"MDk6TWlsZXN0b25lNjA0NDk2MA==","number":2,"title":"1.0","description":"stuff we need to nail down before launch","creator":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":628,"state":"closed","created_at":"2020-10-29T01:17:50Z","updated_at":"2022-12-19T11:47:29Z","due_on":null,"closed_at":"2022-12-19T11:47:29Z"},"comments":3,"created_at":"2022-12-03T19:15:05Z","updated_at":"2022-12-13T15:26:02Z","closed_at":"2022-12-13T15:26:01Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the problem\r\n\r\nWith #7736 we moved from being opinionated that cookies should _not_ be url-encoded to being opinionated that they _should_ be url-encoded.  This means that authentication will now fail if we forward a cookie to a backend service that requires that cookies are _not_ url-encoded.  Url-encoding cookies may be very common but it is not universal so it makes sense to allow for either case.\r\n\r\nWe currently respect the `encode` option passed when calling `cookies.set()` so it's possible to set a cookie that is not url-encoded, but if that cookie later comes back from the client and we 'forward' it to a backend service using `fetch` it will get url-encoded.\r\n\r\nExample flow, with a backend service that insists on non-url-encoded cookies:\r\n```\r\nbackend service\r\n     |\r\n(response with non-url-encoded cookie) (cookie=foo+bar)\r\n     |\r\n     v\r\nsveltekit node app\r\n     |\r\n(cookie set using cookies.set() with { encode: (value) => value }, i.e. no encoding) (cookie=foo+bar)\r\n     |\r\n     v\r\nbrowser\r\n     |\r\n(request, returning cookie just as it was when the browser received it) (cookie=foo+bar)\r\n     |\r\n     v\r\nsveltekit node app\r\n     |\r\n(external fetch request, url-encoding of cookie is enforced) (cookie=foo%2Bbar)\r\n     |\r\n     v\r\nbackend service declines authentication as it expects non-url-encoded cookie\r\n```\r\n\r\n### Describe the proposed solution\r\n\r\nBe unopinionated about whether cookies should be url-encoded.  For cookies sent by the browser don't decode them when we parse them and don't encode them later - just leave them as they are.  For explicit header cookies let people specify their own encoder function if they want to, just as they can when adding to `new_cookies` by calling `cookies.set()`.\r\n\r\n```diff\r\n// kit/packages/kit/src/runtime/server/cookie.js\r\nexport function get_cookies(request, url, dev, trailing_slash) {\r\n\tconst header = request.headers.get('cookie') ?? '';\r\n-\tconst initial_cookies = parse(header, { decode });\r\n+\tconst initial_cookies = parse(header, { decode: (value) => value });  // i.e. don't decode\r\n```\r\nand\r\n\r\n```diff\r\n// kit/packages/kit/src/runtime/server/cookie.js\r\n\t/**\r\n\t * @param {URL} destination\r\n\t * @param {string | null} header\r\n+\t * @param {function} header_encode\r\n\t */\r\n-\tfunction get_cookie_header(destination, header) {\r\n+\tfunction get_cookie_header(destination, header, header_encode) {\r\n\t\t/** @type {Record<string, string>} */\r\n\t\tconst combined_cookies = {};\r\n\r\n\t\t// cookies sent by the user agent have lowest precedence\r\n\t\tfor (const name in initial_cookies) {\r\n-\t\t\tcombined_cookies[name] = encode(initial_cookies[name]);\r\n+\t\t\tcombined_cookies[name] = initial_cookies[name]; \r\n\t\t}\r\n\r\n\t\t// cookies previous set during this event with cookies.set have higher precedence\r\n\t\tfor (const key in new_cookies) {\r\n\t\t\tconst cookie = new_cookies[key];\r\n\t\t\tif (!domain_matches(destination.hostname, cookie.options.domain)) continue;\r\n\t\t\tif (!path_matches(destination.pathname, cookie.options.path)) continue;\r\n\r\n\t\t\tconst encoder = cookie.options.encode || encode;\r\n\t\t\tcombined_cookies[cookie.name] = encoder(cookie.value);\r\n\t\t}\r\n\r\n\t\t// explicit header has highest precedence\r\n\t\tif (header) {\r\n\t\t\tconst parsed = parse(header, { decode });\r\n+\t\t\tconst encoder = header_encode || encode;\r\n\t\t\tfor (const name in parsed) {\r\n-\t\t\t\tcombined_cookies[name] = encode(parsed[name]);\r\n+\t\t\t\tcombined_cookies[name] = encoder(parsed[name]);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn Object.entries(combined_cookies)\r\n\t\t\t.map(([name, value]) => `${name}=${value}`)\r\n\t\t\t.join('; ');\r\n\t}\r\n\r\n```\r\nThe `'serialized cookie header should be url-encoded'` test in kit/packages/kit/src/runtime/server/cookie.spec.js would need to be removed.\r\n\r\n### Alternatives considered\r\n\r\nNot doing any decoding/encoding of cookies by default, but if url-encoding cookies is very common it probably makes sense to leave that as the default behavior for `cookies.set()` and for explicit header cookies.\r\n\r\n### Importance\r\n\r\nwould make my life easier\r\n\r\n### Additional Information\r\n\r\nIf this change makes sense I'm willing to work on a PR.","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/7929/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/7929/timeline","performed_via_github_app":null,"state_reason":"completed"}