{"url":"https://api.github.com/repos/sveltejs/kit/issues/9393","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/9393/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/9393/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/9393/events","html_url":"https://github.com/sveltejs/kit/issues/9393","id":1619045686,"node_id":"I_kwDOEiPr8c5ggK02","number":9393,"title":"adapter-node sends cache headers when static files are 404","user":{"login":"cdemi","id":8025435,"node_id":"MDQ6VXNlcjgwMjU0MzU=","avatar_url":"https://avatars.githubusercontent.com/u/8025435?v=4","gravatar_id":"","url":"https://api.github.com/users/cdemi","html_url":"https://github.com/cdemi","followers_url":"https://api.github.com/users/cdemi/followers","following_url":"https://api.github.com/users/cdemi/following{/other_user}","gists_url":"https://api.github.com/users/cdemi/gists{/gist_id}","starred_url":"https://api.github.com/users/cdemi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cdemi/subscriptions","organizations_url":"https://api.github.com/users/cdemi/orgs","repos_url":"https://api.github.com/users/cdemi/repos","events_url":"https://api.github.com/users/cdemi/events{/privacy}","received_events_url":"https://api.github.com/users/cdemi/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-03-10T14:11:34Z","updated_at":"2023-03-15T08:28:45Z","closed_at":"2023-03-15T08:28:45Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nDuring gradual deployment of an app with multiple instances, it is possible to load the main page from one server and the second request for static content goes to a server that has the old code deployed on it. \r\n\r\nThe old server, with the old code, does not yet have the new file, therefore it returns 404. So far, so good.\r\n\r\nThe problem arises, that with the return of 404, it also sends cache-control header with a high max-age and immutable. The browser and intermediate CDNs cache this response as much as they can.\r\n\r\nhttps://github.com/sveltejs/kit/blob/29ffc78560a99ce387b10a24f48b7f01205f51e7/packages/adapter-node/src/handler.js#L40-L42\r\n\r\nTherefore even after the new server gets the new app, the CDNs and the browser need to force cache clear in order to be able to get the new static files.\r\n\r\nIt would make sense that unless the response is 2xx, the cache header is not sent\n\n### Reproduction\n\nThis can be reproduced easily by creating an empty project with adapter-node and requesting an asset that does not exist\n\n### Logs\n\n_No response_\n\n### System Info\n\n```Shell\nSystem:\r\n    OS: Windows 10 10.0.22624\r\n    CPU: (32) x64 AMD Ryzen 9 5950X 16-Core Processor\r\n    Memory: 41.70 GB / 63.92 GB\r\n  Binaries:\r\n    Node: 19.0.1 - C:\\Program Files\\nodejs\\node.EXE\r\n    Yarn: 1.22.10 - ~\\AppData\\Roaming\\npm\\yarn.CMD\r\n    npm: 8.19.2 - C:\\Program Files\\nodejs\\npm.CMD\r\n  Browsers:\r\n    Edge: Spartan (44.22621.1391.0), Chromium (109.0.1518.78)\r\n    Internet Explorer: 11.0.22621.1\r\n  npmPackages:\r\n    @sveltejs/adapter-node: ^1.2.0 => 1.2.0\r\n    @sveltejs/kit: ^1.8.8 => 1.8.8\r\n    svelte: ^3.55.1 => 3.55.1\r\n    vite: ^4.1.4 => 4.1.4\n```\n\n\n### Severity\n\nserious, but I can work around it\n\n### Additional Information\n\n_No response_","closed_by":{"login":"dummdidumm","id":5968653,"node_id":"MDQ6VXNlcjU5Njg2NTM=","avatar_url":"https://avatars.githubusercontent.com/u/5968653?v=4","gravatar_id":"","url":"https://api.github.com/users/dummdidumm","html_url":"https://github.com/dummdidumm","followers_url":"https://api.github.com/users/dummdidumm/followers","following_url":"https://api.github.com/users/dummdidumm/following{/other_user}","gists_url":"https://api.github.com/users/dummdidumm/gists{/gist_id}","starred_url":"https://api.github.com/users/dummdidumm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dummdidumm/subscriptions","organizations_url":"https://api.github.com/users/dummdidumm/orgs","repos_url":"https://api.github.com/users/dummdidumm/repos","events_url":"https://api.github.com/users/dummdidumm/events{/privacy}","received_events_url":"https://api.github.com/users/dummdidumm/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/9393/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/9393/timeline","performed_via_github_app":null,"state_reason":"completed"}