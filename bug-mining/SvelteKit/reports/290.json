{"url":"https://api.github.com/repos/sveltejs/kit/issues/8286","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/8286/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/8286/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/8286/events","html_url":"https://github.com/sveltejs/kit/issues/8286","id":1514035129,"node_id":"I_kwDOEiPr8c5aPle5","number":8286,"title":"API endpoint, called from the server, with cache-header cannot be cleared","user":{"login":"arackaf","id":11261266,"node_id":"MDQ6VXNlcjExMjYxMjY2","avatar_url":"https://avatars.githubusercontent.com/u/11261266?v=4","gravatar_id":"","url":"https://api.github.com/users/arackaf","html_url":"https://github.com/arackaf","followers_url":"https://api.github.com/users/arackaf/followers","following_url":"https://api.github.com/users/arackaf/following{/other_user}","gists_url":"https://api.github.com/users/arackaf/gists{/gist_id}","starred_url":"https://api.github.com/users/arackaf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arackaf/subscriptions","organizations_url":"https://api.github.com/users/arackaf/orgs","repos_url":"https://api.github.com/users/arackaf/repos","events_url":"https://api.github.com/users/arackaf/events{/privacy}","received_events_url":"https://api.github.com/users/arackaf/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2428470026,"node_id":"MDU6TGFiZWwyNDI4NDcwMDI2","url":"https://api.github.com/repos/sveltejs/kit/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2022-12-29T20:32:56Z","updated_at":"2023-01-09T18:29:05Z","closed_at":"2023-01-09T18:29:05Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nThis is similar to, but different than https://github.com/sveltejs/kit/issues/7784 \r\n\r\nI have an api endpoint that looks like this \r\n\r\n```js\r\nexport async function GET({ url, setHeaders, request }) {\r\n\tconsole.log('ENDPOINT', x++);\r\n\r\n\tconst search = url.searchParams.get('search') || '';\r\n\r\n\tsetHeaders({\r\n\t\t'cache-control': 'max-age=60',\r\n\t\tVary: 'todos-cache'\r\n\t});\r\n\tconst todos = await getTodos(search);\r\n\treturn json(todos);\r\n}\r\n```\r\n\r\nThis endpoint is called from a SHARED loader. So the first time I view a page, the fetch is called from SvelteKit's internals, on the server. With the cache-control header, as above, these results are cached for 60 seconds. Even a call to invalidate to the api endpoint url does not clear that cached entry. Even adding a depends call in the shared loader, and called invalidate on that does not clear the cached entry. Even manually passing a different value of the header on each call (to test) does not clear the cached entry.\r\n\r\nIs this by design? Note that I'm not talking about browser caching. I can already modify the header I'm Vary'ing on (todos-cache) on the client, and successfully clear the cache, which works.\r\n\r\nThe only workaround I've found is to just not add the cache-control header at all, depending on whether the loader is running client-side, or server-side (which I can surmise by snooping around the headers).\r\n\r\nAgain, mainly trying to surmise if this is by design. If it is, by all means close this. If not, I'd be happy to whip up a minimal repro. \n\n### Reproduction\n\nn/a, for now (if this is not by design I'd be happy to make one).\n\n### Logs\n\n```Shell\nn/a\n```\n\n\n### System Info\n\n```Shell\nSystem:\r\n    OS: macOS 13.0.1\r\n    CPU: (16) x64 Intel(R) Core(TM) i9-9980HK CPU @ 2.40GHz\r\n    Memory: 151.88 MB / 16.00 GB\r\n    Shell: 5.8.1 - /bin/zsh\r\n  Binaries:\r\n    Node: 16.14.2 - /usr/local/Cellar/nvm/0.38.0/versions/node/v16.14.2/bin/node\r\n    Yarn: 1.22.17 - /usr/local/Cellar/nvm/0.38.0/versions/node/v16.11.1/bin/yarn\r\n    npm: 8.18.0 - ~/Documents/node_modules/.bin/npm\r\n  Browsers:\r\n    Chrome: 108.0.5359.124\r\n    Firefox: 108.0.1\r\n  npmPackages:\r\n    @sveltejs/adapter-auto: ^1.0.0 => 1.0.0 \r\n    @sveltejs/kit: ^1.0.1 => 1.0.1 \r\n    svelte: ^3.54.0 => 3.55.0 \r\n    vite: ^4.0.0 => 4.0.3\n```\n\n\n### Severity\n\nannoyance\n\n### Additional Information\n\n_No response_","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/8286/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/8286/timeline","performed_via_github_app":null,"state_reason":"completed"}