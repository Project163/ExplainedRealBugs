{"url":"https://api.github.com/repos/sveltejs/kit/issues/6844","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/6844/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/6844/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/6844/events","html_url":"https://github.com/sveltejs/kit/issues/6844","id":1375138595,"node_id":"I_kwDOEiPr8c5R9vMj","number":6844,"title":"Invalidate all + redirects not working as expected.","user":{"login":"smblee","id":9781750,"node_id":"MDQ6VXNlcjk3ODE3NTA=","avatar_url":"https://avatars.githubusercontent.com/u/9781750?v=4","gravatar_id":"","url":"https://api.github.com/users/smblee","html_url":"https://github.com/smblee","followers_url":"https://api.github.com/users/smblee/followers","following_url":"https://api.github.com/users/smblee/following{/other_user}","gists_url":"https://api.github.com/users/smblee/gists{/gist_id}","starred_url":"https://api.github.com/users/smblee/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smblee/subscriptions","organizations_url":"https://api.github.com/users/smblee/orgs","repos_url":"https://api.github.com/users/smblee/repos","events_url":"https://api.github.com/users/smblee/events{/privacy}","received_events_url":"https://api.github.com/users/smblee/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-09-15T22:06:57Z","updated_at":"2022-09-21T16:45:30Z","closed_at":"2022-09-21T16:45:30Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\ndiscord thread: https://discord.com/channels/457912077277855764/1020064864066093196\r\n\r\nHey all - I think i ran into a bug or unexpected behavior that i can't wrap my head around.\r\n\r\nThe app is structured so that the root `/` acts as a central \"router\" to determine current user's state and redirect them to appropriate landing pages.\r\n\r\nThe child pages also have their own redirection logic, and if user somehow got to the page directly, user is redirected back to the router `/`.\r\n\r\nThere is a notion of \"profiles\" and user can switch between the profiles using a switcher component (think AWS, switching between profiles with different permissions). \r\n\r\nThis component should \r\n`set the profile id in cookie from client side` => `invalidate/rerender the current page (client sided, via invalidateAll())` => `if the current page has any redirection logic, redirect with new profile; if page can render with new profile, render with new data, etc.`\r\n\r\nThe problem I am running into is, I call `invalidateAll()`, invalidation/rerunning nested layout code runs as expected (with the new profile id value), but at the very end of redirects, the `profile id` is seen as the previous value (which causes the \"redirect loop\" error, even when there really isn't a loop). \r\n\r\n### Reproduction\r\n\r\nhttps://github.com/smblee/sveltekit-invalidate-all-bug\r\n\r\nI reproduced it as close to my current repo as possible.\r\n\r\nSay there are the following pages `/` (router, doesn't actually render), `notset` (ONLY when no profile set),`signup` (ONLY when profile is not-onboarded),  `onboarded-home` (ONLY when profile is onboarded).\r\n\r\ntry going from `Set not onboarded profile` => `Set onboarded profile` or the other way around. (it will always fail on the first try, in one direction).\r\n\r\nyou will fail with the following log trace: (\r\nit can seem a bit overwhelming, but it's pretty simple. I basically logged the location and current profile id value at that time in code. and any redirection that happens)\r\n\r\n```\r\n+layout |  not-onboarded-id\r\n(student)/+layout |  not-onboarded-id\r\n(student)/signup/+page |  not-onboarded-id\r\nSelector.svelte:11 ---------------------------\r\nSelector.svelte:12 SETTING PROFILE: START\r\nSelector.svelte:13 prev: not-onboarded-id\r\nSelector.svelte:14 expected: onboarded-id\r\nSelector.svelte:17 SETTING PROFILE: SET COOKIE\r\nSelector.svelte:18 cookie: profileId=onboarded-id\r\nSelector.svelte:19 SETTING PROFILE: INVALIDATE ALL START\r\n+layout |  onboarded-id\r\n(student)/+layout |  onboarded-id\r\n(student)/signup/+page |  onboarded-id\r\n(student)/signup/+page | redirecting to /\r\nSelector.svelte:21 SETTING PROFILE: INVALIDATE ALL ENDED\r\nSelector.svelte:22 ---------------------------\r\n+layout |  onboarded-id\r\n+page |  onboarded-id\r\n+page | redirecting to /onboarded-home\r\n(student)/(onboarded)/+layout |  not-onboarded-id                   <------ should be `onboarded-id`\r\n+(student)/(onboarded)/+layout | redirecting to /\r\n+page |  not-onboarded-id                               <------ should be `onboarded-id`\r\n+page | redirecting to /signup\r\n+layout |  onboarded-id\r\n\r\nError: Redirect loop...\r\n```\r\n\r\n\r\n### Logs\r\n\r\n_No response_\r\n\r\n### System Info\r\n\r\n```shell\r\nSystem:\r\n    OS: macOS 12.5\r\n    CPU: (10) arm64 Apple M1 Pro\r\n    Memory: 109.05 MB / 32.00 GB\r\n    Shell: 5.8.1 - /bin/zsh\r\n  Binaries:\r\n    Node: 16.15.1 - ~/.nvm/versions/node/v16.15.1/bin/node\r\n    npm: 8.11.0 - ~/.nvm/versions/node/v16.15.1/bin/npm\r\n  Browsers:\r\n    Chrome: 105.0.5195.125\r\n    Safari: 15.6\r\n  npmPackages:\r\n    @sveltejs/adapter-auto: next => 1.0.0-next.75\r\n    @sveltejs/kit: next => 1.0.0-next.483\r\n    svelte: ^3.44.0 => 3.50.1\r\n    vite: ^3.1.0 => 3.1.1\r\n```\r\n\r\n\r\n### Severity\r\n\r\nblocking an upgrade\r\n\r\n### Additional Information\r\n\r\n_No response_","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/6844/reactions","total_count":4,"+1":4,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/6844/timeline","performed_via_github_app":null,"state_reason":"completed"}