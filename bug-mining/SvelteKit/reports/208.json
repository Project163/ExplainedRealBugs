{"url":"https://api.github.com/repos/sveltejs/kit/issues/6726","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/6726/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/6726/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/6726/events","html_url":"https://github.com/sveltejs/kit/issues/6726","id":1368751977,"node_id":"I_kwDOEiPr8c5RlX9p","number":6726,"title":"The `beforeNavigate`/`afterNavigate` `type` is problematic","user":{"login":"aradalvand","id":26527405,"node_id":"MDQ6VXNlcjI2NTI3NDA1","avatar_url":"https://avatars.githubusercontent.com/u/26527405?v=4","gravatar_id":"","url":"https://api.github.com/users/aradalvand","html_url":"https://github.com/aradalvand","followers_url":"https://api.github.com/users/aradalvand/followers","following_url":"https://api.github.com/users/aradalvand/following{/other_user}","gists_url":"https://api.github.com/users/aradalvand/gists{/gist_id}","starred_url":"https://api.github.com/users/aradalvand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aradalvand/subscriptions","organizations_url":"https://api.github.com/users/aradalvand/orgs","repos_url":"https://api.github.com/users/aradalvand/repos","events_url":"https://api.github.com/users/aradalvand/events{/privacy}","received_events_url":"https://api.github.com/users/aradalvand/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2428470026,"node_id":"MDU6TGFiZWwyNDI4NDcwMDI2","url":"https://api.github.com/repos/sveltejs/kit/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sveltejs/kit/milestones/2","html_url":"https://github.com/sveltejs/kit/milestone/2","labels_url":"https://api.github.com/repos/sveltejs/kit/milestones/2/labels","id":6044960,"node_id":"MDk6TWlsZXN0b25lNjA0NDk2MA==","number":2,"title":"1.0","description":"stuff we need to nail down before launch","creator":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":628,"state":"closed","created_at":"2020-10-29T01:17:50Z","updated_at":"2022-12-19T11:47:29Z","due_on":null,"closed_at":"2022-12-19T11:47:29Z"},"comments":3,"created_at":"2022-09-10T23:17:28Z","updated_at":"2022-11-04T19:25:56Z","closed_at":"2022-11-04T19:25:56Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\nIf you click on a link to an external URL on the page, or if you do a `goto` to an external URL, two successive `beforeNavigate` events will fire, the first one will have a `type` of `link`/`goto`, and the second one `unload`:\r\n\r\n![image](https://user-images.githubusercontent.com/26527405/189504822-e145fd9c-51fc-4ad4-8860-d473875442d6.png)\r\n\r\nThis behavior is strange, to say the least.\r\nFirst of all, `beforeNavigate` firing twice for the same navigation action is... well, awkward and unexpected.\r\nAnd if you have a navigation loader that you want to show only during client-side routing, you can't simply do this:\r\n\r\n```js\r\nbeforeNavigation(({ type } => {\r\n    if (type == 'unload') return;\r\n    // Show loader\r\n});\r\n```\r\nBecause then the loader would also appear for external, native browser navigations.\r\nThe behavior is inconsistent with the \"promise\" @Rich-Harris made [here](https://github.com/sveltejs/kit/issues/4383#issuecomment-1072594489):\r\n\r\n> Yep, type === 'unload' and !client would be equivalent. **All other types would be client-side navigations**\r\n\r\n(emphasis mine)\r\n\r\nThis is now not the case, an instance of `beforeNavigate` firing with a `type` of something other than `unload` (like `link` in the example I provided above) COULD be a case of non-client-side navigation.\r\n\r\nInstead, the API should've probably been designed such that we had `unload` as a separate boolean flag, alongside the `type` property, and then the event would only fire once when unloading would happen:\r\n```js\r\nbeforeNavigate({ unload, type } => {\r\n    if (unload) return; // e.g. If the user clicked on an external link, here `unload` is `true` and `type` is `link`.\r\n    // Show loader\r\n});\r\n```\r\n\r\nPlease feel free to let me know if I'm missing something. Thank you.\r\n\r\n### Reproduction\r\n\r\nExplained above\r\n\r\n### Logs\r\n\r\n_No response_\r\n\r\n### System Info\r\n\r\n```shell\r\nSystem:\r\n    OS: Linux 5.15 Ubuntu 20.04.4 LTS (Focal Fossa)\r\n    CPU: (4) x64 Intel(R) Core(TM) i7-7500U CPU @ 2.70GHz\r\n    Memory: 461.70 MB / 3.77 GB\r\n    Container: Yes\r\n    Shell: 5.8 - /usr/bin/zsh\r\n  Binaries:\r\n    Node: 16.15.1 - /usr/bin/node\r\n    Yarn: 1.22.15 - /usr/bin/yarn\r\n    npm: 8.11.0 - /usr/bin/npm\r\n  npmPackages:\r\n    @sveltejs/adapter-auto: next => 1.0.0-next.64 \r\n    @sveltejs/adapter-node: ^1.0.0-next.86 => 1.0.0-next.86 \r\n    @sveltejs/kit: next => 1.0.0-next.480 \r\n    svelte: ^3.44.0 => 3.49.0 \r\n    vite: ^3.1.0-beta.1 => 3.1.0\r\n```\r\n\r\n\r\n### Severity\r\n\r\nserious, but i can work around it\r\n\r\n### Additional Information\r\n\r\n_No response_","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/6726/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/6726/timeline","performed_via_github_app":null,"state_reason":"completed"}