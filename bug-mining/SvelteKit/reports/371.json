{"url":"https://api.github.com/repos/sveltejs/kit/issues/9350","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/9350/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/9350/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/9350/events","html_url":"https://github.com/sveltejs/kit/issues/9350","id":1613261099,"node_id":"I_kwDOEiPr8c5gKGkr","number":9350,"title":"HTTP 307 redirects break when normalizing URLs","user":{"login":"lxhom","id":73352734,"node_id":"MDQ6VXNlcjczMzUyNzM0","avatar_url":"https://avatars.githubusercontent.com/u/73352734?v=4","gravatar_id":"","url":"https://api.github.com/users/lxhom","html_url":"https://github.com/lxhom","followers_url":"https://api.github.com/users/lxhom/followers","following_url":"https://api.github.com/users/lxhom/following{/other_user}","gists_url":"https://api.github.com/users/lxhom/gists{/gist_id}","starred_url":"https://api.github.com/users/lxhom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lxhom/subscriptions","organizations_url":"https://api.github.com/users/lxhom/orgs","repos_url":"https://api.github.com/users/lxhom/repos","events_url":"https://api.github.com/users/lxhom/events{/privacy}","received_events_url":"https://api.github.com/users/lxhom/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-03-07T11:30:05Z","updated_at":"2023-03-07T15:20:03Z","closed_at":"2023-03-07T15:16:42Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\n<details><summary>HTTP 307 description if you're not familiar with it</summary>\r\n\r\n> [HTTP](https://developer.mozilla.org/en-US/docs/Glossary/HTTP) 307 Temporary Redirect redirect status response code indicates that the resource requested has been temporarily moved to the URL given by the [Location](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Location) headers.\r\n> \r\n> ***The method and the body of the original request are reused to perform the redirected request***. In the cases where you want the method used to be changed to [GET](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/GET), use [303 See Other](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/303) instead. This is useful when you want to give an answer to a [PUT](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/PUT) method that is not the uploaded resources, but a confirmation message (like \"You successfully uploaded XYZ\").\r\n> \r\n> (from [MDN: HTTP 307 Temporary Redirect](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/307))\r\n\r\n</details>\r\n\r\nMy use case is a bit complicated, but I need to redirect a POST request like this:\r\n\r\n```\r\nPOST server1.com/path -> HTTP 307, Location: server2.com/path\r\nPOST server2.com/path -> HTTP 200\r\n```\r\n\r\nThis works with SvelteKit, except when it normalizes paths:\r\n\r\n```\r\nPOST server1.com/path/ -> HTTP 307, Location: server2.com/path/\r\nPOST server2.com/path/ -> HTTP 301, Location: server2.com/path, X-SvelteKit-Normalize: 1\r\nGET  server2.com/path  -> HTTP 405\r\n```\r\n\r\nThis is due to this condition:\r\n\r\nhttps://github.com/sveltejs/kit/blob/748e174aeef47a08df865885fa8d58211b8d9a4e/packages/kit/src/runtime/server/respond.js#L214-L225\r\n\r\nThis should check if the original request is a 307, and use 307 too if that is the case.\r\n\r\n### Reproduction\r\n\r\nWithout normalization:\r\n\r\n```\r\n❯ curl -Lvd \"a\" localhost:3000/from\r\n> POST /from HTTP/1.1\r\n> Host: localhost:3000\r\n> \r\n< HTTP/1.1 307 Temporary Redirect\r\n< location: http://localhost:3000/to\r\n< \r\n* Issue another request to this URL: 'http://localhost:3000/to'\r\n> POST /to HTTP/1.1\r\n> Host: localhost:3000\r\n> \r\n< HTTP/1.1 200 OK\r\n< \r\nPosted!\r\n```\r\nWith normalization:\r\n```\r\n❯ curl -Lvd \"a\" localhost:3000/from/\r\n> POST /from/ HTTP/1.1\r\n> Host: localhost:3000\r\n> \r\n< HTTP/1.1 301 Moved Permanently\r\n< location: /from\r\n< x-sveltekit-normalize: 1\r\n< \r\n* Issue another request to this URL: 'http://localhost:3000/from'\r\n* Switch from POST to GET\r\n> GET /from HTTP/1.1\r\n> Host: localhost:3000\r\n> \r\n< HTTP/1.1 405 Method Not Allowed\r\n< \r\nGET method not allowed    \r\n```\r\n\r\nFor example code see https://github.com/lxhom/sk-307-demo/commit/f8d580edb5627fd57d6904a488540b3db5d96121 (the commit only includes the changed files from a base SK project)\r\n\r\n### Logs\r\n\r\n_No response_\r\n\r\n### System Info\r\n\r\n```Shell\r\nSystem:\r\n    OS: Linux 6.1 Arch Linux (btw)\r\n    CPU: (4) x64 AMD A8-7410 APU with AMD Radeon R5 Graphics\r\n    Memory: 818.83 MB / 6.74 GB\r\n    Container: Yes\r\n    Shell: 5.8 - /usr/local/bin/zsh\r\n  Binaries:\r\n    Node: 19.4.0 - ~/.nvm/versions/node/v19.4.0/bin/node\r\n    Yarn: 1.22.19 - /usr/bin/yarn\r\n    npm: 9.2.0 - ~/.nvm/versions/node/v19.4.0/bin/npm\r\n  Browsers:\r\n    Firefox: 109.0\r\n    Chrome: 110\r\n```\r\n\r\n\r\n### Severity\r\n\r\nserious, but I can work around it\r\n\r\n### Additional Information\r\n\r\nI'd submit this as a PR (because this seems really easy), but I'm rather new to SK and I don't know if this would break other stuff.","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/9350/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/9350/timeline","performed_via_github_app":null,"state_reason":"completed"}