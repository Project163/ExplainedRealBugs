{"url":"https://api.github.com/repos/sveltejs/kit/issues/4910","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/4910/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/4910/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/4910/events","html_url":"https://github.com/sveltejs/kit/issues/4910","id":1235582878,"node_id":"I_kwDOEiPr8c5JpX-e","number":4910,"title":"replace `transformPage` with `transformPageChunk` or similar","user":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":3229640667,"node_id":"MDU6TGFiZWwzMjI5NjQwNjY3","url":"https://api.github.com/repos/sveltejs/kit/labels/p1-important","name":"p1-important","color":"2C3488","default":false,"description":"SvelteKit cannot be used by a large number of people, basic functionality is missing, etc."},{"id":3229669367,"node_id":"MDU6TGFiZWwzMjI5NjY5MzY3","url":"https://api.github.com/repos/sveltejs/kit/labels/breaking%20change","name":"breaking change","color":"F859C7","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sveltejs/kit/milestones/2","html_url":"https://github.com/sveltejs/kit/milestone/2","labels_url":"https://api.github.com/repos/sveltejs/kit/milestones/2/labels","id":6044960,"node_id":"MDk6TWlsZXN0b25lNjA0NDk2MA==","number":2,"title":"1.0","description":"stuff we need to nail down before launch","creator":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":628,"state":"closed","created_at":"2020-10-29T01:17:50Z","updated_at":"2022-12-19T11:47:29Z","due_on":null,"closed_at":"2022-12-19T11:47:29Z"},"comments":1,"created_at":"2022-05-13T18:59:34Z","updated_at":"2022-07-22T13:35:05Z","closed_at":"2022-07-22T13:35:04Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the problem\n\nSvelteKit should have the ability to stream HTML. That could take several forms:\r\n\r\n1. We immediately flush the contents of `src/app.html` up to `%svelte.head%`, plus the `<link>` elements that preload .js and .css files for the page (which we could determine as soon as the route is matched with some fairly minor changes), then flush the rest all in one go once the page is done rendering. This improves TTFB and lets the browser get a head start on fetching resources\r\n2. We immediately flush the top (as in 1), then render a placeholder element for any `<svelte:head>` content discovered during rendering, then flush up to `%svelte.body%`, then flush the rest once the page renders\r\n3. We do 2, but instead of rendering the whole body synchronously, we render layouts as soon as they're ready, meaning that in many cases we could flush a `<nav>` bar etc before the main content is ready\r\n\r\nThere's also a version where Svelte itself supports streaming rendering, and we pause on `{#await ...}` blocks, but that's a far more involved conversation that we don't need to have today.\r\n\r\nIn fact, we don't need to decide _any_ of this stuff today; we just need to identify the things that block us from implementing these ideas. 3 is impossible as long as we have `$page.stuff` (more on that in a separate issue), but all three versions are impossible as long as we have the `transformPage` API since it expects the entire page to be buffered.\n\n### Describe the proposed solution\n\nInstead of `transformPage`, we could have something like `transformPageChunk` or `transformMarkup` which operates on a chunk at a time. In the common case, it would behave exactly the same:\r\n\r\n```js\r\nexport async function handle({ event, resolve }) {\r\n  return resolve(event, {\r\n    transformMarkup: ({ html }) => html.replace(/cloud/g, 'butt')\r\n  });\r\n}\r\n```\r\n\r\nWe can guarantee that the chunks are sensible (the entirety of a layout up to the `<slot/>` or following it, for example) so that it's not necessary to handle the case where one chunk contains 'clo' and the next contains 'ud'. That said, in some rare cases it might be necessary to buffer content, which means we would need to include a flag for the final chunk:\r\n\r\n\r\n```js\r\nexport async function handle({ event, resolve }) {\r\n  let buffer = '';\r\n  return resolve(event, {\r\n    transformMarkup: ({ html, last }) => {\r\n      if (last) return minify(buffer + html);\r\n      else buffer += html;\r\n    }\r\n  });\r\n}\r\n```\r\n\r\n(Realistically, you'd probably just disable streaming in those situations, but `last` costs nothing.)\r\n\r\nUntil streaming is implemented (which probably won't happen straight away as it involves lots of decisions — is it driven by config? by a `resolve` option? do we do version 1, 2, or 3?) this function would behave exactly the same way as `transformPage` currently does.\n\n### Alternatives considered\n\nKeep the current API, but opt out of streaming when `transformPage` is provided. I think that would be a mistake; there are lots of valid uses for transforming markup that are no less valid in a streaming context.\n\n### Importance\n\nwould make my life easier\n\n### Additional Information\n\nAside: streaming implies everything gets a 200 response except early 404s. Apparently the way to make this not matter is to inject a `<meta name=\"robots\" content=\"noindex\">` into the page — doesn't matter where — if you encounter an error during rendering.\r\n\r\nAnother aside: out-of-order streaming (as suggested in 2, where we inject a placeholder element for `<svelte:head>` content, then render snippets of code that inject the HTML into the head once it's ready) relies on JavaScript. It should therefore a) be behind an option, and b) be disabled for search engine bots, since reliance on JS is bad for SEO despite some alarmingly common misconceptions. (We would probably need to make the list of bot UAs configurable.)","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/4910/reactions","total_count":2,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/4910/timeline","performed_via_github_app":null,"state_reason":"completed"}