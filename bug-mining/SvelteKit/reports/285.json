{"url":"https://api.github.com/repos/sveltejs/kit/issues/8398","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/8398/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/8398/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/8398/events","html_url":"https://github.com/sveltejs/kit/issues/8398","id":1524678279,"node_id":"I_kwDOEiPr8c5a4L6H","number":8398,"title":"Route invalidation check is broken due to comparing to intent id, not url and route","user":{"login":"Algoinde","id":10269970,"node_id":"MDQ6VXNlcjEwMjY5OTcw","avatar_url":"https://avatars.githubusercontent.com/u/10269970?v=4","gravatar_id":"","url":"https://api.github.com/users/Algoinde","html_url":"https://github.com/Algoinde","followers_url":"https://api.github.com/users/Algoinde/followers","following_url":"https://api.github.com/users/Algoinde/following{/other_user}","gists_url":"https://api.github.com/users/Algoinde/gists{/gist_id}","starred_url":"https://api.github.com/users/Algoinde/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Algoinde/subscriptions","organizations_url":"https://api.github.com/users/Algoinde/orgs","repos_url":"https://api.github.com/users/Algoinde/repos","events_url":"https://api.github.com/users/Algoinde/events{/privacy}","received_events_url":"https://api.github.com/users/Algoinde/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2428470026,"node_id":"MDU6TGFiZWwyNDI4NDcwMDI2","url":"https://api.github.com/repos/sveltejs/kit/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-01-08T21:03:06Z","updated_at":"2023-01-10T00:09:02Z","closed_at":"2023-01-09T10:07:47Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\nWhen investigating the invalidation mishappenings in my project, I came upon these lines:\r\n\r\nhttps://github.com/sveltejs/kit/blame/4ff91b0e98f571b5e3b0f6e4fc30481426fd6255/packages/kit/src/runtime/client/client.js#L712\r\n\r\nThe `id` in that function is taken from `intent` that is returned from `get_navigation_intent`. The `id` in this intent from what I see is used as a cache key. It is, in fact, a URL, not a route ID:\r\n\r\n```js\r\nfunction get_navigation_intent(url, invalidating) {\r\n\tif (is_external_url(url, base)) return;\r\n\r\n\tconst path = decode_pathname(url.pathname.slice(base.length) || '/');\r\n\r\n\tfor (const route of routes) {\r\n\t\tconst params = route.exec(path);\r\n\r\n\t\tif (params) {\r\n\t\t\tconst id = url.pathname + url.search;\r\n\t\t\t/** @type {import('./types').NavigationIntent} */\r\n\t\t\tconst intent = { id, invalidating, route, params: decode_params(params), url };\r\n\t\t\treturn intent;\r\n\t\t}\r\n\t}\r\n}\r\n```\r\n\r\nLater this is used in the aforementioned comparison:\r\n\r\n```js\r\n//id == '/whatever/url/you/have/1/1231/'\r\n//current.route.id == '/[page]/url/[who]/[verb]/[id]/[subid]'\r\nconst url_changed = current.url ? id !== current.url.pathname + current.url.search : false;\r\nconst route_changed = current.route ? id !== current.route.id : false;\r\n```\r\nAs a result of this, `route_changed` is *always* true, which I think will invalidate any layouts all the time if they happen to have something that accesses `event.route.id` in the stack.\r\n\r\n### Reproduction\r\n\r\nhttps://stackblitz.com/edit/sveltejs-kit-template-default-4tqaxj?file=src/routes/stuff/+layout.js\r\n\r\nSwitch between `about` and `notAbout` in the header.\r\n\r\n![route.id](https://user-images.githubusercontent.com/10269970/211219730-115ee1dd-5d48-4af9-9f9e-b198c83206fa.gif)\r\n\r\n### System Info\r\n\r\n```Shell\r\nSystem:\r\n    OS: Linux 4.4 Ubuntu 22.04 LTS 22.04 LTS (Jammy Jellyfish)\r\n    CPU: (12) x64 AMD Ryzen 5 3600X 6-Core Processor\r\n    Memory: 7.40 GB / 31.95 GB\r\n    Container: Yes\r\n    Shell: 5.8.1 - /usr/bin/zsh\r\n  Binaries:\r\n    Node: 16.16.0 - ~/.nvm/versions/node/v16.16.0/bin/node\r\n    Yarn: 1.22.19 - ~/.nvm/versions/node/v16.16.0/bin/yarn\r\n    npm: 8.11.0 - ~/.nvm/versions/node/v16.16.0/bin/npm\r\n  npmPackages:\r\n    @sveltejs/adapter-node: ^1.0.0-next.106 => 1.0.0-next.106\r\n    @sveltejs/kit: ^1.0.0-next.589 => 1.0.0-next.589\r\n    svelte: ^3.54.0 => 3.55.0\r\n    vite: ^4.0.0 => 4.0.3\r\n```\r\n\r\n\r\n### Severity\r\n\r\nannoyance","closed_by":{"login":"dummdidumm","id":5968653,"node_id":"MDQ6VXNlcjU5Njg2NTM=","avatar_url":"https://avatars.githubusercontent.com/u/5968653?v=4","gravatar_id":"","url":"https://api.github.com/users/dummdidumm","html_url":"https://github.com/dummdidumm","followers_url":"https://api.github.com/users/dummdidumm/followers","following_url":"https://api.github.com/users/dummdidumm/following{/other_user}","gists_url":"https://api.github.com/users/dummdidumm/gists{/gist_id}","starred_url":"https://api.github.com/users/dummdidumm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dummdidumm/subscriptions","organizations_url":"https://api.github.com/users/dummdidumm/orgs","repos_url":"https://api.github.com/users/dummdidumm/repos","events_url":"https://api.github.com/users/dummdidumm/events{/privacy}","received_events_url":"https://api.github.com/users/dummdidumm/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/8398/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/8398/timeline","performed_via_github_app":null,"state_reason":"completed"}