{"url":"https://api.github.com/repos/sveltejs/kit/issues/5584","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/5584/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/5584/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/5584/events","html_url":"https://github.com/sveltejs/kit/issues/5584","id":1307422434,"node_id":"I_kwDOEiPr8c5N7a7i","number":5584,"title":"Vite envPrefix other than `VITE_` breaks version check during navigation in production","user":{"login":"AndrewLester","id":23221268,"node_id":"MDQ6VXNlcjIzMjIxMjY4","avatar_url":"https://avatars.githubusercontent.com/u/23221268?v=4","gravatar_id":"","url":"https://api.github.com/users/AndrewLester","html_url":"https://github.com/AndrewLester","followers_url":"https://api.github.com/users/AndrewLester/followers","following_url":"https://api.github.com/users/AndrewLester/following{/other_user}","gists_url":"https://api.github.com/users/AndrewLester/gists{/gist_id}","starred_url":"https://api.github.com/users/AndrewLester/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndrewLester/subscriptions","organizations_url":"https://api.github.com/users/AndrewLester/orgs","repos_url":"https://api.github.com/users/AndrewLester/repos","events_url":"https://api.github.com/users/AndrewLester/events{/privacy}","received_events_url":"https://api.github.com/users/AndrewLester/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2022-07-18T05:24:41Z","updated_at":"2022-07-18T22:05:36Z","closed_at":"2022-07-18T22:05:36Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\nChanging the Vite `envPrefix` config option to anything other than `VITE_` raises an error when navigating to any page that raises a 400 or above exception (in production). The error occurs in the version check, which makes a request to `/undefined`, and fails with a `Version check failed: 404` error.\r\n\r\n### Reproduction\r\n\r\nhttps://stackblitz.com/edit/sveltejs-kit-template-default-4lm8dn?file=src/routes/index.svelte\r\n\r\n**Must be in preview mode**\r\n1. `npm run build`\r\n2. `npm run preview`\r\n3. Open the result in a new tab.\r\n4. Click `Click me to 400!`, which just links to `/about`, which returns a status of 400.\r\n5. No navigation occurs because of an error. It *should* take you to the error page I've setup. Check the console for the details.\r\n\r\n\r\n\r\n### Logs\r\nBrowser console:\r\n```shell\r\nFailed to load resource: the server responded with a status of 404 (Not Found)        /undefined\r\nstart-45898ec4.js:1 Uncaught (in promise) Error: Version check failed: 404\r\n    at Object.o [as check] (start-45898ec4.js:1:10425)\r\n    at async ge (start-45898ec4.js:1:14144)\r\n    at async be (start-45898ec4.js:1:20380)\r\n```\r\n\r\n\r\n### System Info\r\n\r\n```shell\r\nSystem:\r\n    OS: Linux 5.0 undefined\r\n    CPU: (4) x64 Intel(R) Core(TM) i9-9880H CPU @ 2.30GHz\r\n    Memory: 0 Bytes / 0 Bytes\r\n    Shell: 1.0 - /bin/jsh\r\n  Binaries:\r\n    Node: 16.14.2 - /usr/local/bin/node\r\n    Yarn: 1.22.10 - /bin/yarn\r\n    npm: 7.17.0 - /bin/npm\r\n  npmPackages:\r\n    @sveltejs/adapter-node: * => 1.0.0-next.81 \r\n    @sveltejs/kit: next => 1.0.0-next.377 \r\n    svelte: ^3.46.0 => 3.49.0 \r\n    vite: ^3.0.0 => 3.0.0\r\n```\r\n\r\n\r\n### Severity\r\n\r\nannoyance\r\n\r\n### Additional Information\r\n\r\nThis code can be found inside my built `start.js` file (when `envPrefix` != `VITE_`):\r\n```js\r\nconst {set: r, subscribe: e} = de(!1)\r\n      , t = +{\r\n        BASE_URL: \"/_app/\",\r\n        MODE: \"production\",\r\n        DEV: !1,\r\n        PROD: !0\r\n    }.VITE_SVELTEKIT_APP_VERSION_POLL_INTERVAL\r\n      , a = {\r\n        BASE_URL: \"/_app/\",\r\n        MODE: \"production\",\r\n        DEV: !1,\r\n        PROD: !0\r\n    }.VITE_SVELTEKIT_APP_VERSION;\r\n```\r\n\r\nWhen the `envPrefix` is `VITE_`, it looks like this:\r\n```js\r\nconst {set: s, subscribe: e} = de(!1)\r\n      , t = \"1658120225477\";\r\nlet a;\r\n```\r\n\r\nI came across this issue with the static adapter and a fallback 404 page. The page was in SPA mode, and navigated automatically to its current URL upon start, which then resulted in a 404. The version check was then sent which errored out. I think the reproduction above is simpler, but may not be very common.","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/5584/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/5584/timeline","performed_via_github_app":null,"state_reason":"completed"}