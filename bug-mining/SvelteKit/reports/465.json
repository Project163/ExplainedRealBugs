{"url":"https://api.github.com/repos/sveltejs/kit/issues/9508","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/9508/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/9508/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/9508/events","html_url":"https://github.com/sveltejs/kit/issues/9508","id":1640013807,"node_id":"I_kwDOEiPr8c5hwJ_v","number":9508,"title":"data-sveltekit-preload-data=\"hover\" results in unexpected hard navigation when network is sketchy / offline","user":{"login":"leereamsnyder","id":870668,"node_id":"MDQ6VXNlcjg3MDY2OA==","avatar_url":"https://avatars.githubusercontent.com/u/870668?v=4","gravatar_id":"","url":"https://api.github.com/users/leereamsnyder","html_url":"https://github.com/leereamsnyder","followers_url":"https://api.github.com/users/leereamsnyder/followers","following_url":"https://api.github.com/users/leereamsnyder/following{/other_user}","gists_url":"https://api.github.com/users/leereamsnyder/gists{/gist_id}","starred_url":"https://api.github.com/users/leereamsnyder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leereamsnyder/subscriptions","organizations_url":"https://api.github.com/users/leereamsnyder/orgs","repos_url":"https://api.github.com/users/leereamsnyder/repos","events_url":"https://api.github.com/users/leereamsnyder/events{/privacy}","received_events_url":"https://api.github.com/users/leereamsnyder/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2428470026,"node_id":"MDU6TGFiZWwyNDI4NDcwMDI2","url":"https://api.github.com/repos/sveltejs/kit/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"},{"id":2850697519,"node_id":"MDU6TGFiZWwyODUwNjk3NTE5","url":"https://api.github.com/repos/sveltejs/kit/labels/router","name":"router","color":"0052cc","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sveltejs/kit/milestones/4","html_url":"https://github.com/sveltejs/kit/milestone/4","labels_url":"https://api.github.com/repos/sveltejs/kit/milestones/4/labels","id":6613611,"node_id":"MDk6TWlsZXN0b25lNjYxMzYxMQ==","number":4,"title":"soon","description":"stuff we want to do as soon as time allows","creator":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":78,"closed_issues":167,"state":"open","created_at":"2021-03-31T19:50:44Z","updated_at":"2025-10-03T13:11:43Z","due_on":null,"closed_at":null},"comments":6,"created_at":"2023-03-24T20:47:05Z","updated_at":"2024-03-12T14:56:19Z","closed_at":"2024-03-12T14:56:18Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nWhen using `data-sveltekit-preload-data=\"hover\"`, you can invoke an unexpected hard navigation when the network is unavailable. When you're offline, and hover over a link, SvelteKit tries to preload the data/code, that fails (because you're offline, of course), and then it tries to load the error page (which also fails), and the eventual fallback is a hard navigation to the link's `href`, which I would not expect to happen while you are just hovering over a link.\r\n\r\nThis requires a certain combination of circumstances:\r\n\r\n- root layout has a load function (this does not happen without that)\r\n- you are using `data-sveltekit-preload-data=\"hover\"` either on the link or set globally on the `body` (it's still a problem with `\"tap\"`, but it's way more obviously a bug with `\"hover\"`, because you're not clicking on the link)\r\n- the link goes to a different page route\r\n- you are offline or under some other adverse network situation, such that the preload requests and the subsequent requests for the error page all fail\r\n\r\nWhat appears to be happening stepping through the code in `client/client.js`, it looks like when you try to preload the data on a link, SvelteKit is eventually doing `load_route()`, which sends you via a `catch` block to `load_root_error_page()`, which has [a conditional when your root layout has a load function](https://github.com/sveltejs/kit/blob/c0612a8f846f3eba8bf2d23f30d713e1ae14dd7b/packages/kit/src/runtime/client/client.js#L984-L1007) that lands you in `native_navigation`.\r\n\r\nSo, this is easiest to reproduce when offline, but it could happen in other adverse network situations.\n\n### Reproduction\n\nhttps://github.com/leereamsnyder/sveltekit-offline-preload-bug\r\n\r\nThis is a skeleton SvelteKit project, with [the addition of a simple layout load fn](https://github.com/leereamsnyder/sveltekit-offline-preload-bug/commit/b1f7c562913b29aa4c489ab1b0468b7c0e239827).\r\n\r\nThe readme has repro steps, copied here:\r\n\r\n1. `npm install`\r\n1. `npm run dev`\r\n1. Open up http://localhost:5173 in Chrome (this is most straightforward in Chrome)\r\n1. In the command palette (CMD + SHIFT + P), choose **Go Offline**, or select **Offline** from the throttling selector in the **Network** panel, typically next to **Disable cache**\r\n1. Hover over the **Sverdle** link in the nav. In a flash, SvelteKit will do a hard navigation to`http://localhost:5173/sverdle`, which will fail because you're offline\n\n### Logs\n\n_No response_\n\n### System Info\n\n```Shell\nSystem:\r\n    OS: macOS 13.2\r\n    CPU: (10) arm64 Apple M1 Pro\r\n    Memory: 112.14 MB / 16.00 GB\r\n    Shell: 5.8.1 - /bin/zsh\r\n  Binaries:\r\n    Node: 18.13.0 - /opt/homebrew/bin/node\r\n    Yarn: 1.22.19 - /opt/homebrew/bin/yarn\r\n    npm: 8.19.3 - /opt/homebrew/bin/npm\r\n  Browsers:\r\n    Chrome: 111.0.5563.110\r\n    Safari: 16.3\r\n    Safari Technology Preview: 16.4\r\n  npmPackages:\r\n    @sveltejs/adapter-auto: ^2.0.0 => 2.0.0 \r\n    @sveltejs/kit: ^1.5.0 => 1.13.0 \r\n    svelte: ^3.54.0 => 3.57.0 \r\n    vite: ^4.2.0 => 4.2.1\n```\n\n\n### Severity\n\nserious, but I can work around it\n\n### Additional Information\n\nJust to be clear, I don't expect SvelteKit to, ya know, _work_ when the network is unavailable.\r\n\r\nIt's the unexpected hard navigation that happens when you just hover over a link that's the problem.\r\n\r\nThis is not a throrough or ironclad workaround, but to the extent that the browser will tell you that you're offline with built-in APIs, you can mitigate this by turning preload behavior `\"off\"` when detected. I have a component like this floating around that changes the `data-sveltekit-preload-data` on the `<body>`:\r\n\r\n```js\r\nimport { onMount } from 'svelte'\r\n\r\n  onMount(() => {\r\n    const originalPreloadData = document.body.getAttribute('data-sveltekit-preload-data')\r\n\r\n    // this is not often accurate!\r\n    if (navigator.onLine === false) {\r\n      document.body.setAttribute('data-sveltekit-preload-data', 'off')\r\n    }\r\n\r\n    window.addEventListener('offline', () => {\r\n      document.body.setAttribute('data-sveltekit-preload-data', 'off')\r\n    })\r\n\r\n    window.addEventListener('online', () => {\r\n      document.body.setAttribute('data-sveltekit-preload-data', originalPreloadData)\r\n    })\r\n  })\r\n```","closed_by":{"login":"dummdidumm","id":5968653,"node_id":"MDQ6VXNlcjU5Njg2NTM=","avatar_url":"https://avatars.githubusercontent.com/u/5968653?v=4","gravatar_id":"","url":"https://api.github.com/users/dummdidumm","html_url":"https://github.com/dummdidumm","followers_url":"https://api.github.com/users/dummdidumm/followers","following_url":"https://api.github.com/users/dummdidumm/following{/other_user}","gists_url":"https://api.github.com/users/dummdidumm/gists{/gist_id}","starred_url":"https://api.github.com/users/dummdidumm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dummdidumm/subscriptions","organizations_url":"https://api.github.com/users/dummdidumm/orgs","repos_url":"https://api.github.com/users/dummdidumm/repos","events_url":"https://api.github.com/users/dummdidumm/events{/privacy}","received_events_url":"https://api.github.com/users/dummdidumm/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/9508/reactions","total_count":15,"+1":15,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/9508/timeline","performed_via_github_app":null,"state_reason":"completed"}