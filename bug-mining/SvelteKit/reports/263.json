{"url":"https://api.github.com/repos/sveltejs/kit/issues/7971","repository_url":"https://api.github.com/repos/sveltejs/kit","labels_url":"https://api.github.com/repos/sveltejs/kit/issues/7971/labels{/name}","comments_url":"https://api.github.com/repos/sveltejs/kit/issues/7971/comments","events_url":"https://api.github.com/repos/sveltejs/kit/issues/7971/events","html_url":"https://github.com/sveltejs/kit/issues/7971","id":1479686945,"node_id":"I_kwDOEiPr8c5YMjsh","number":7971,"title":"Respect cache options in subsequent_fetch","user":{"login":"cristovao-trevisan","id":4981855,"node_id":"MDQ6VXNlcjQ5ODE4NTU=","avatar_url":"https://avatars.githubusercontent.com/u/4981855?v=4","gravatar_id":"","url":"https://api.github.com/users/cristovao-trevisan","html_url":"https://github.com/cristovao-trevisan","followers_url":"https://api.github.com/users/cristovao-trevisan/followers","following_url":"https://api.github.com/users/cristovao-trevisan/following{/other_user}","gists_url":"https://api.github.com/users/cristovao-trevisan/gists{/gist_id}","starred_url":"https://api.github.com/users/cristovao-trevisan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cristovao-trevisan/subscriptions","organizations_url":"https://api.github.com/users/cristovao-trevisan/orgs","repos_url":"https://api.github.com/users/cristovao-trevisan/repos","events_url":"https://api.github.com/users/cristovao-trevisan/events{/privacy}","received_events_url":"https://api.github.com/users/cristovao-trevisan/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2428470026,"node_id":"MDU6TGFiZWwyNDI4NDcwMDI2","url":"https://api.github.com/repos/sveltejs/kit/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-12-06T17:22:24Z","updated_at":"2022-12-09T16:58:01Z","closed_at":"2022-12-09T16:58:01Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\r\n\r\nFound two bugs in cache implementation at client-side [fetcher.js](https://github.com/sveltejs/kit/blob/1dfa20e7d8e27fbdca99067619b16e1ca125f4a2/packages/kit/src/runtime/client/fetcher.js):\r\n\r\n- Current implementation of subsequent_fetch considers only max-age and ignores the cache option\r\n- Cache `delete` and `get` are using different keys\r\n\r\nAbout the cache option (RequestCache from RequestInit), I think it should redo the request if it's set to 'no-store', 'no-cache' or 'reload'.\r\nAnother option is to let the browser handle the cache entirely, but I assume there's a reason to be a cache object (and that's why I didn't create a PR). \r\n\r\n### Reproduction\r\nI've created a very simple example to explain the issue that I have in my private app. To better explain the issue here a few facts of my application (which should be a very common case):\r\n- I have a separate backend (not running in kit) that provides user data (among other stuff), but the example uses +server.ts to simulate the backend\r\n- Authentication is done using http-only cookies\r\n- To check auth, kit calls an API that returns user data (name, image, etc). In the example only name is used\r\n- I want to load this user data in the layout and cache it (don't need to request at every navigation)\r\n- I use max-age in the API to cache this data\r\n- There's a profile page in which the user can update it's own info, e.g. it's name\r\n- The profile update form sends a POST/PUT request to the backend, then it reloads user data (layout load through invalidation)\r\n\r\nHere the problem arises: If max-age is set, the user data is not being reloaded by invalidateAll even if I set `{ cache: 'reload' }` in fetch options.\r\n\r\n### Example\r\nThe example bellow does 3 things to demonstrate this:\r\n- Calls invalidateAll on form submit (use:enhance)\r\n- Calls invalidateAll on page load (just to make sure)\r\n- Calls fetch directly on page load, using `cache: 'reload'`, to show that the response is different from what's on the screen (thus returned by +page.js)\r\n\r\n> https://github.com/cristovao-trevisan/kit-issue-report\r\n\r\nSubmitting the form with a different name does not update the page data. By navigating back and forward and looking at the console you can see that the invalidateAll function does not take effect (because the resource is cached), even after reloading the HTTP cache.\r\nReloading the page does update the data. \r\n\r\n![image](https://user-images.githubusercontent.com/4981855/205979384-41d454c9-ae0d-49a9-9d4f-3c2b5cf72353.png)\r\n\r\n![image](https://user-images.githubusercontent.com/4981855/205979491-50cf88c5-77dc-4f68-979a-5349825aac49.png)\r\n\r\n\r\n\r\n\r\n### Logs\r\n\r\n_No response_\r\n\r\n### System Info\r\n\r\n```Shell\r\nSystem:\r\n    OS: Linux 6.0 Arch Linux\r\n    CPU: (4) x64 Intel(R) Core(TM) i3-5010U CPU @ 2.10GHz\r\n    Memory: 1.19 GB / 7.68 GB\r\n    Container: Yes\r\n    Shell: 5.9 - /usr/bin/zsh\r\n  Binaries:\r\n    Node: 18.12.1 - ~/.nvm/versions/node/v18.12.1/bin/node\r\n    npm: 8.19.2 - ~/.nvm/versions/node/v18.12.1/bin/npm\r\n  Browsers:\r\n    Brave Browser: 108.1.46.134\r\n    Firefox: 107.0.1\r\n  npmPackages:\r\n    @sveltejs/adapter-auto: next => 1.0.0-next.90 \r\n    @sveltejs/kit: next => 1.0.0-next.572 \r\n    svelte: ^3.53.1 => 3.53.1 \r\n    vite: ^3.2.4 => 3.2.5\r\n```\r\n\r\n\r\n### Severity\r\n\r\nserious, but I can work around it\r\n\r\n> The current work around is to remove the max-age header and request user info at every navigation\r\n\r\n### Additional Information\r\n\r\n_No response_","closed_by":{"login":"Rich-Harris","id":1162160,"node_id":"MDQ6VXNlcjExNjIxNjA=","avatar_url":"https://avatars.githubusercontent.com/u/1162160?v=4","gravatar_id":"","url":"https://api.github.com/users/Rich-Harris","html_url":"https://github.com/Rich-Harris","followers_url":"https://api.github.com/users/Rich-Harris/followers","following_url":"https://api.github.com/users/Rich-Harris/following{/other_user}","gists_url":"https://api.github.com/users/Rich-Harris/gists{/gist_id}","starred_url":"https://api.github.com/users/Rich-Harris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rich-Harris/subscriptions","organizations_url":"https://api.github.com/users/Rich-Harris/orgs","repos_url":"https://api.github.com/users/Rich-Harris/repos","events_url":"https://api.github.com/users/Rich-Harris/events{/privacy}","received_events_url":"https://api.github.com/users/Rich-Harris/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sveltejs/kit/issues/7971/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sveltejs/kit/issues/7971/timeline","performed_via_github_app":null,"state_reason":"completed"}