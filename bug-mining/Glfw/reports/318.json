{"url":"https://api.github.com/repos/glfw/glfw/issues/1710","repository_url":"https://api.github.com/repos/glfw/glfw","labels_url":"https://api.github.com/repos/glfw/glfw/issues/1710/labels{/name}","comments_url":"https://api.github.com/repos/glfw/glfw/issues/1710/comments","events_url":"https://api.github.com/repos/glfw/glfw/issues/1710/events","html_url":"https://github.com/glfw/glfw/issues/1710","id":631287163,"node_id":"MDU6SXNzdWU2MzEyODcxNjM=","number":1710,"title":"Key repeat timer race condition causing freeze","user":{"login":"annacrombie","id":10382483,"node_id":"MDQ6VXNlcjEwMzgyNDgz","avatar_url":"https://avatars.githubusercontent.com/u/10382483?v=4","gravatar_id":"","url":"https://api.github.com/users/annacrombie","html_url":"https://github.com/annacrombie","followers_url":"https://api.github.com/users/annacrombie/followers","following_url":"https://api.github.com/users/annacrombie/following{/other_user}","gists_url":"https://api.github.com/users/annacrombie/gists{/gist_id}","starred_url":"https://api.github.com/users/annacrombie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/annacrombie/subscriptions","organizations_url":"https://api.github.com/users/annacrombie/orgs","repos_url":"https://api.github.com/users/annacrombie/repos","events_url":"https://api.github.com/users/annacrombie/events{/privacy}","received_events_url":"https://api.github.com/users/annacrombie/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":36425440,"node_id":"MDU6TGFiZWwzNjQyNTQ0MA==","url":"https://api.github.com/repos/glfw/glfw/labels/bug","name":"bug","color":"b60205","default":true,"description":"Bug reports and bugfix pull requests"},{"id":37364584,"node_id":"MDU6TGFiZWwzNzM2NDU4NA==","url":"https://api.github.com/repos/glfw/glfw/labels/verified","name":"verified","color":"0e8a16","default":false,"description":"Reproduced or otherwise verified bugs"},{"id":89092389,"node_id":"MDU6TGFiZWw4OTA5MjM4OQ==","url":"https://api.github.com/repos/glfw/glfw/labels/Wayland","name":"Wayland","color":"ffbc00","default":false,"description":""},{"id":1572895686,"node_id":"MDU6TGFiZWwxNTcyODk1Njg2","url":"https://api.github.com/repos/glfw/glfw/labels/input","name":"input","color":"d4c5f9","default":false,"description":"Keyboard, joystick or mouse"}],"state":"closed","locked":false,"assignee":{"login":"elmindreda","id":133714,"node_id":"MDQ6VXNlcjEzMzcxNA==","avatar_url":"https://avatars.githubusercontent.com/u/133714?v=4","gravatar_id":"","url":"https://api.github.com/users/elmindreda","html_url":"https://github.com/elmindreda","followers_url":"https://api.github.com/users/elmindreda/followers","following_url":"https://api.github.com/users/elmindreda/following{/other_user}","gists_url":"https://api.github.com/users/elmindreda/gists{/gist_id}","starred_url":"https://api.github.com/users/elmindreda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elmindreda/subscriptions","organizations_url":"https://api.github.com/users/elmindreda/orgs","repos_url":"https://api.github.com/users/elmindreda/repos","events_url":"https://api.github.com/users/elmindreda/events{/privacy}","received_events_url":"https://api.github.com/users/elmindreda/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"elmindreda","id":133714,"node_id":"MDQ6VXNlcjEzMzcxNA==","avatar_url":"https://avatars.githubusercontent.com/u/133714?v=4","gravatar_id":"","url":"https://api.github.com/users/elmindreda","html_url":"https://github.com/elmindreda","followers_url":"https://api.github.com/users/elmindreda/followers","following_url":"https://api.github.com/users/elmindreda/following{/other_user}","gists_url":"https://api.github.com/users/elmindreda/gists{/gist_id}","starred_url":"https://api.github.com/users/elmindreda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elmindreda/subscriptions","organizations_url":"https://api.github.com/users/elmindreda/orgs","repos_url":"https://api.github.com/users/elmindreda/repos","events_url":"https://api.github.com/users/elmindreda/events{/privacy}","received_events_url":"https://api.github.com/users/elmindreda/received_events","type":"User","user_view_type":"public","site_admin":false},{"login":"linkmauve","id":7755816,"node_id":"MDQ6VXNlcjc3NTU4MTY=","avatar_url":"https://avatars.githubusercontent.com/u/7755816?v=4","gravatar_id":"","url":"https://api.github.com/users/linkmauve","html_url":"https://github.com/linkmauve","followers_url":"https://api.github.com/users/linkmauve/followers","following_url":"https://api.github.com/users/linkmauve/following{/other_user}","gists_url":"https://api.github.com/users/linkmauve/gists{/gist_id}","starred_url":"https://api.github.com/users/linkmauve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/linkmauve/subscriptions","organizations_url":"https://api.github.com/users/linkmauve/orgs","repos_url":"https://api.github.com/users/linkmauve/repos","events_url":"https://api.github.com/users/linkmauve/events{/privacy}","received_events_url":"https://api.github.com/users/linkmauve/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/glfw/glfw/milestones/21","html_url":"https://github.com/glfw/glfw/milestone/21","labels_url":"https://api.github.com/repos/glfw/glfw/milestones/21/labels","id":7448663,"node_id":"MI_kwDOAJFXBc4AcahX","number":21,"title":"3.3.7","description":"","creator":{"login":"elmindreda","id":133714,"node_id":"MDQ6VXNlcjEzMzcxNA==","avatar_url":"https://avatars.githubusercontent.com/u/133714?v=4","gravatar_id":"","url":"https://api.github.com/users/elmindreda","html_url":"https://github.com/elmindreda","followers_url":"https://api.github.com/users/elmindreda/followers","following_url":"https://api.github.com/users/elmindreda/following{/other_user}","gists_url":"https://api.github.com/users/elmindreda/gists{/gist_id}","starred_url":"https://api.github.com/users/elmindreda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elmindreda/subscriptions","organizations_url":"https://api.github.com/users/elmindreda/orgs","repos_url":"https://api.github.com/users/elmindreda/repos","events_url":"https://api.github.com/users/elmindreda/events{/privacy}","received_events_url":"https://api.github.com/users/elmindreda/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":26,"state":"closed","created_at":"2021-12-01T20:57:27Z","updated_at":"2024-02-05T14:25:36Z","due_on":null,"closed_at":"2022-03-20T21:22:51Z"},"comments":1,"created_at":"2020-06-05T03:38:48Z","updated_at":"2021-12-15T20:36:16Z","closed_at":"2021-12-14T08:33:43Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Some info about my environment:\r\n\r\nI'm running `sway version 1.4-f681d529`, and the latest master of glfw built with wayland support.  My program is single threaded and calls glfwPollEvents every frame, which is capped at 30 fps.\r\n\r\nOccasionally my glfw program will completely freeze.  Attaching with gdb revealed the following backtrace:\r\n\r\n```\r\n#0  __cp_end () at src/thread/x86_64/syscall_cp.s:29\r\n#1  0x00007fafcbcacc6d in __syscall_cp_c (nr=0, u=8, v=140721514594888, w=<optimized out>,\r\n    x=<optimized out>, y=<optimized out>, z=0) at src/thread/pthread_cancel.c:33\r\n#2  0x00007fafcbcb2b16 in read (fd=<optimized out>, buf=<optimized out>, count=<optimized out>)\r\n    at src/unistd/read.c:6\r\n#3  0x000055777d5240c8 in handleEvents ()\r\n#4  0x000055777d524c8e in _glfwPlatformPollEvents ()\r\n#5  0x000055777d51d825 in glfwPollEvents ()\r\n#6  0x000055777d4fbb18 in opengl_ui_handle_input (ctx=0x7fafcbc4bde0, km=0x7ffc47e3c388,\r\n    hf=0x7fafcbc4bc80) at ../client/ui/opengl/ui.c:125\r\n#7  0x000055777d4ee559 in ui_handle_input (ctx=0x7fafcbc4bda0, km=0x7ffc47e3c388,\r\n    hf=0x7fafcbc4bc80) at ../client/ui/common.c:82\r\n#8  0x000055777d4eda24 in main (argc=3, argv=0x7ffc47e3eb78) at ../client/main.c:65\r\n```\r\n\r\nAfter doing some digging I think I found a race condition.  When I hold a key, the repeat timer is properly set and detected with poll().  However, if I release the key after glfw has polled the repeat timerfd, but before the timerfd is read, the key handling code disarms the timer and the resulting read blocks, freezing my program.\r\n\r\nPrintf debugging supports my hypothesis:\r\n\r\n[src/wl_window.c](https://github.com/glfw/glfw/blob/master/src/wl_window.c#L746)\r\n\r\n```\r\n  if (poll(fds, 3, timeout) > 0) {\r\n       printf(\"done polling\\n\");\r\n\r\n       ...\r\n       if (fds[1].revents & POLLIN)\r\n       {\r\n            printf(\"about to read\\n\");\r\n->          read_ret = read(_glfw.wl.timerfd, &repeats, sizeof(repeats));\r\n```\r\n\r\n[src/wl_init.c](https://github.com/glfw/glfw/blob/master/src/wl_init.c#L598)\r\n\r\n```\r\n    printf(\"setting timer: %ld, %ld, %ld, %ld\\n\", timer.it_value.tv_sec,\r\n\t    timer.it_value.tv_nsec, timer.it_interval.tv_sec,\r\n\t    timer.it_interval.tv_nsec);\r\n\r\n    timerfd_settime(_glfw.wl.timerfd, 0, &timer, NULL);\r\n```\r\n\r\noutput:\r\n```\r\n...\r\ndone polling\r\ndone polling\r\ndone polling\r\nsetting timer: 0, 600000000, 0, 40000000\r\ndone polling\r\ndone polling\r\ndone polling\r\ndone polling\r\ndone polling\r\ndone polling\r\ndone polling\r\ndone polling\r\ndone polling\r\ndone polling\r\ndone polling\r\ndone polling\r\ndone polling\r\ndone polling\r\ndone polling\r\ndone polling\r\ndone polling\r\ndone polling\r\ndone polling\r\nabout to read\r\ndone polling\r\nabout to read\r\ndone polling\r\nabout to read\r\ndone polling\r\nabout to read\r\ndone polling\r\nsetting timer: 0, 0, 0, 0\r\nabout to read\r\n```\r\n\r\nI have fixed this problem for now by simply setting O_NONBLOCK on the timerfd, but I'm not sure if that is the best solution.","closed_by":{"login":"linkmauve","id":7755816,"node_id":"MDQ6VXNlcjc3NTU4MTY=","avatar_url":"https://avatars.githubusercontent.com/u/7755816?v=4","gravatar_id":"","url":"https://api.github.com/users/linkmauve","html_url":"https://github.com/linkmauve","followers_url":"https://api.github.com/users/linkmauve/followers","following_url":"https://api.github.com/users/linkmauve/following{/other_user}","gists_url":"https://api.github.com/users/linkmauve/gists{/gist_id}","starred_url":"https://api.github.com/users/linkmauve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/linkmauve/subscriptions","organizations_url":"https://api.github.com/users/linkmauve/orgs","repos_url":"https://api.github.com/users/linkmauve/repos","events_url":"https://api.github.com/users/linkmauve/events{/privacy}","received_events_url":"https://api.github.com/users/linkmauve/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/glfw/glfw/issues/1710/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/glfw/glfw/issues/1710/timeline","performed_via_github_app":null,"state_reason":"completed"}