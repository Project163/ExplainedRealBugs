{"url":"https://api.github.com/repos/glfw/glfw/issues/1649","repository_url":"https://api.github.com/repos/glfw/glfw","labels_url":"https://api.github.com/repos/glfw/glfw/issues/1649/labels{/name}","comments_url":"https://api.github.com/repos/glfw/glfw/issues/1649/comments","events_url":"https://api.github.com/repos/glfw/glfw/issues/1649/events","html_url":"https://github.com/glfw/glfw/issues/1649","id":569377475,"node_id":"MDU6SXNzdWU1NjkzNzc0NzU=","number":1649,"title":"Cocoa pre-window-creation event processing fix causes glfwPostEmptyEvent to crash program when called from non-main thread","user":{"login":"dmitshur","id":1924134,"node_id":"MDQ6VXNlcjE5MjQxMzQ=","avatar_url":"https://avatars.githubusercontent.com/u/1924134?v=4","gravatar_id":"","url":"https://api.github.com/users/dmitshur","html_url":"https://github.com/dmitshur","followers_url":"https://api.github.com/users/dmitshur/followers","following_url":"https://api.github.com/users/dmitshur/following{/other_user}","gists_url":"https://api.github.com/users/dmitshur/gists{/gist_id}","starred_url":"https://api.github.com/users/dmitshur/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dmitshur/subscriptions","organizations_url":"https://api.github.com/users/dmitshur/orgs","repos_url":"https://api.github.com/users/dmitshur/repos","events_url":"https://api.github.com/users/dmitshur/events{/privacy}","received_events_url":"https://api.github.com/users/dmitshur/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":36425440,"node_id":"MDU6TGFiZWwzNjQyNTQ0MA==","url":"https://api.github.com/repos/glfw/glfw/labels/bug","name":"bug","color":"b60205","default":true,"description":"Bug reports and bugfix pull requests"},{"id":37361162,"node_id":"MDU6TGFiZWwzNzM2MTE2Mg==","url":"https://api.github.com/repos/glfw/glfw/labels/macOS","name":"macOS","color":"1d76db","default":false,"description":""},{"id":37364584,"node_id":"MDU6TGFiZWwzNzM2NDU4NA==","url":"https://api.github.com/repos/glfw/glfw/labels/verified","name":"verified","color":"0e8a16","default":false,"description":"Reproduced or otherwise verified bugs"}],"state":"closed","locked":false,"assignee":{"login":"elmindreda","id":133714,"node_id":"MDQ6VXNlcjEzMzcxNA==","avatar_url":"https://avatars.githubusercontent.com/u/133714?v=4","gravatar_id":"","url":"https://api.github.com/users/elmindreda","html_url":"https://github.com/elmindreda","followers_url":"https://api.github.com/users/elmindreda/followers","following_url":"https://api.github.com/users/elmindreda/following{/other_user}","gists_url":"https://api.github.com/users/elmindreda/gists{/gist_id}","starred_url":"https://api.github.com/users/elmindreda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elmindreda/subscriptions","organizations_url":"https://api.github.com/users/elmindreda/orgs","repos_url":"https://api.github.com/users/elmindreda/repos","events_url":"https://api.github.com/users/elmindreda/events{/privacy}","received_events_url":"https://api.github.com/users/elmindreda/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"elmindreda","id":133714,"node_id":"MDQ6VXNlcjEzMzcxNA==","avatar_url":"https://avatars.githubusercontent.com/u/133714?v=4","gravatar_id":"","url":"https://api.github.com/users/elmindreda","html_url":"https://github.com/elmindreda","followers_url":"https://api.github.com/users/elmindreda/followers","following_url":"https://api.github.com/users/elmindreda/following{/other_user}","gists_url":"https://api.github.com/users/elmindreda/gists{/gist_id}","starred_url":"https://api.github.com/users/elmindreda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elmindreda/subscriptions","organizations_url":"https://api.github.com/users/elmindreda/orgs","repos_url":"https://api.github.com/users/elmindreda/repos","events_url":"https://api.github.com/users/elmindreda/events{/privacy}","received_events_url":"https://api.github.com/users/elmindreda/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/glfw/glfw/milestones/13","html_url":"https://github.com/glfw/glfw/milestone/13","labels_url":"https://api.github.com/repos/glfw/glfw/milestones/13/labels","id":1805405,"node_id":"MDk6TWlsZXN0b25lMTgwNTQwNQ==","number":13,"title":"3.4","description":"","creator":{"login":"elmindreda","id":133714,"node_id":"MDQ6VXNlcjEzMzcxNA==","avatar_url":"https://avatars.githubusercontent.com/u/133714?v=4","gravatar_id":"","url":"https://api.github.com/users/elmindreda","html_url":"https://github.com/elmindreda","followers_url":"https://api.github.com/users/elmindreda/followers","following_url":"https://api.github.com/users/elmindreda/following{/other_user}","gists_url":"https://api.github.com/users/elmindreda/gists{/gist_id}","starred_url":"https://api.github.com/users/elmindreda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elmindreda/subscriptions","organizations_url":"https://api.github.com/users/elmindreda/orgs","repos_url":"https://api.github.com/users/elmindreda/repos","events_url":"https://api.github.com/users/elmindreda/events{/privacy}","received_events_url":"https://api.github.com/users/elmindreda/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":91,"state":"closed","created_at":"2016-06-02T16:19:22Z","updated_at":"2024-04-15T13:42:33Z","due_on":null,"closed_at":"2024-02-23T12:42:01Z"},"comments":1,"created_at":"2020-02-22T18:55:08Z","updated_at":"2020-03-16T01:07:54Z","closed_at":"2020-03-12T01:16:54Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Issue #1543 was resolved by commit 6e6805000ac7ddf39c8c5f6be3e877770cba5083.\r\n\r\nCommit 6e6805000ac7ddf39c8c5f6be3e877770cba5083 adds the following code to `_glfwPlatformPostEmptyEvent`:\r\n\r\n```diff\r\n+    if (!_glfw.ns.finishedLaunching)\r\n+        [NSApp run];\r\n```\r\n\r\nI'm not sure if this is safe to do.\r\n\r\n`glfwPostEmptyEvent` is [documented](https://www.glfw.org/docs/latest/group__window.html#gab5997a25187e9fd5c6f2ecbbc8dfd7e9) to be safe to call from any thread. Documentation for `NSApp.run` itself doesn't say anything about what thread it may be run on, but in practice, it seems to call another method, which is not safe to call on non-main thread, and throws NSInternalInconsistencyException.\r\n\r\nConsider the following trivial Go program (sorry, I don't remember how to write threaded code in C by now) that uses GLFW 3.3.2 and calls `glfwPostEmptyEvent` on non-main thread:\r\n\r\n```Go\r\npackage main\r\n\r\nimport (\r\n\t\"log\"\r\n\t\"runtime\"\r\n\r\n\t\"github.com/go-gl/glfw/v3.3/glfw\"\r\n)\r\n\r\nfunc init() { runtime.LockOSThread() } // arrange for main function to run main thread\r\n\r\nfunc main() {\r\n\terr := glfw.Init()\r\n\tif err != nil {\r\n\t\tlog.Fatalln(err)\r\n\t}\r\n\tdefer glfw.Terminate()\r\n\r\n\tgo glfw.PostEmptyEvent() // call PostEmptyEvent in non-main thread\r\n\r\n\tselect {} // wait forever\r\n}\r\n```\r\n\r\nIt was tested on macOS 10.15.3 with Xcode 11.3.1.\r\n\r\nBefore commit 6e6805000ac7ddf39c8c5f6be3e877770cba5083, it works fine.\r\n\r\nAfter commit 6e6805000ac7ddf39c8c5f6be3e877770cba5083, it crashes with:\r\n\r\n```\r\n$ go run .                                     \r\n2020-02-22 13:50:10.100 m[22196:92162] *** Assertion failure in +[NSUndoManager _endTopLevelGroupings], /BuildRoot/Library/Caches/com.apple.xbs/Sources/Foundation/Foundation-1674.114/Foundation/Misc.subproj/NSUndoManager.m:363\r\n2020-02-22 13:50:10.100 m[22196:92162] *** Terminating app due to uncaught exception 'NSInternalInconsistencyException', reason: '+[NSUndoManager(NSInternal) _endTopLevelGroupings] is only safe to invoke on the main thread.'\r\n*** First throw call stack:\r\n(\r\n\t0   CoreFoundation                      0x00007fff394778ab __exceptionPreprocess + 250\r\n\t1   libobjc.A.dylib                     0x00007fff6f731805 objc_exception_throw + 48\r\n\t2   CoreFoundation                      0x00007fff394a0d10 +[NSException raise:format:arguments:] + 88\r\n\t3   Foundation                          0x00007fff3bb99241 -[NSAssertionHandler handleFailureInMethod:object:file:lineNumber:description:] + 191\r\n\t4   Foundation                          0x00007fff3bad7d5e +[NSUndoManager(NSPrivate) _endTopLevelGroupings] + 440\r\n\t5   AppKit                              0x00007fff365b016c -[NSApplication run] + 864\r\n\t6   m                                   0x00000000040b0046 _glfwPlatformPostEmptyEvent + 54\r\n\t7   m                                   0x000000000405cc90 runtime.asmcgocall + 112\r\n)\r\nlibc++abi.dylib: terminating with uncaught exception of type NSException\r\nSIGABRT: abort\r\nPC=0x7fff70be67fa m=3 sigcode=0\r\n```\r\n\r\nThis may be somewhat related to #1588.\r\n\r\n/cc @elmindreda","closed_by":{"login":"elmindreda","id":133714,"node_id":"MDQ6VXNlcjEzMzcxNA==","avatar_url":"https://avatars.githubusercontent.com/u/133714?v=4","gravatar_id":"","url":"https://api.github.com/users/elmindreda","html_url":"https://github.com/elmindreda","followers_url":"https://api.github.com/users/elmindreda/followers","following_url":"https://api.github.com/users/elmindreda/following{/other_user}","gists_url":"https://api.github.com/users/elmindreda/gists{/gist_id}","starred_url":"https://api.github.com/users/elmindreda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elmindreda/subscriptions","organizations_url":"https://api.github.com/users/elmindreda/orgs","repos_url":"https://api.github.com/users/elmindreda/repos","events_url":"https://api.github.com/users/elmindreda/events{/privacy}","received_events_url":"https://api.github.com/users/elmindreda/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/glfw/glfw/issues/1649/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/glfw/glfw/issues/1649/timeline","performed_via_github_app":null,"state_reason":"completed"}