{"url":"https://api.github.com/repos/rspec/rspec-core/issues/556","repository_url":"https://api.github.com/repos/rspec/rspec-core","labels_url":"https://api.github.com/repos/rspec/rspec-core/issues/556/labels{/name}","comments_url":"https://api.github.com/repos/rspec/rspec-core/issues/556/comments","events_url":"https://api.github.com/repos/rspec/rspec-core/issues/556/events","html_url":"https://github.com/rspec/rspec-core/issues/556","id":2867375,"node_id":"MDU6SXNzdWUyODY3Mzc1","number":556,"title":"metadata Procs are called even if the tag is not present and rescued","user":{"login":"eregon","id":168854,"node_id":"MDQ6VXNlcjE2ODg1NA==","avatar_url":"https://avatars.githubusercontent.com/u/168854?v=4","gravatar_id":"","url":"https://api.github.com/users/eregon","html_url":"https://github.com/eregon","followers_url":"https://api.github.com/users/eregon/followers","following_url":"https://api.github.com/users/eregon/following{/other_user}","gists_url":"https://api.github.com/users/eregon/gists{/gist_id}","starred_url":"https://api.github.com/users/eregon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eregon/subscriptions","organizations_url":"https://api.github.com/users/eregon/orgs","repos_url":"https://api.github.com/users/eregon/repos","events_url":"https://api.github.com/users/eregon/events{/privacy}","received_events_url":"https://api.github.com/users/eregon/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":25,"created_at":"2012-01-17T11:28:54Z","updated_at":"2012-03-18T15:07:25Z","closed_at":"2012-02-02T12:43:38Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello,\nI did a quick search so I hope this is no duplicate.\n\nWhen you define a filter with a Proc, such as:\n\n``` ruby\nRSpec.configure do |config|\n  config.filter_run_excluding :fails_on => lambda { |implementations|\n    implementations.include? some_ruby\n  }\nend\n```\n\nThe Proc is called for every example (with `nil` when the example has no :fails_on key in its metadata).\nThis is silenced to the user by the (in my opinion) bad use of the `rescue false` in `rspec/core/matadata.rb` method `filter_applies?` lines 180-190:\n\n``` ruby\ncase value\n...\nwhen Proc\n  if value.arity == 2\n    # Pass the metadata hash to allow the proc to check if it even has the key.\n    # This is necessary for the implicit :if exclusion filter:\n    #   {            } # => run the example\n    #   { :if => nil } # => exclude the example\n    # The value of metadata[:if] is the same in these two cases but\n    # they need to be treated differently.\n    value.call(metadata[key], metadata) rescue false\n  else\n    value.call(metadata[key]) rescue false\n  end\n...\n```\n\nI somewhat understand the issue with :if, but isn't a check such as `key == :if or key == :unless` enough?\n\nSo the NameError that should be produced by calling `nil.include? some_ruby` is eaten silently.\nIt means the filter should actually be written in such a way to handle nil:\n\n``` ruby\n  config.filter_run_excluding :fails_on => lambda { |implementations|\n    implementations and implementations.include? some_ruby\n  }\n```\n\n... which seems very unintuitive for me and might produce inverted filtering.\n\nI believe the Proc should not be called when the example does not have the tag key.\n\nI'm still confused with RSpec tags, partly due to unexpected semantics, so please excuse me if I'm just wrong, but eating errors is never a good idea IMHO (I would much prefer to get the error).\n\nCould someone explain me the rationale behind this?\n","closed_by":{"login":"dchelimsky","id":1075,"node_id":"MDQ6VXNlcjEwNzU=","avatar_url":"https://avatars.githubusercontent.com/u/1075?v=4","gravatar_id":"","url":"https://api.github.com/users/dchelimsky","html_url":"https://github.com/dchelimsky","followers_url":"https://api.github.com/users/dchelimsky/followers","following_url":"https://api.github.com/users/dchelimsky/following{/other_user}","gists_url":"https://api.github.com/users/dchelimsky/gists{/gist_id}","starred_url":"https://api.github.com/users/dchelimsky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dchelimsky/subscriptions","organizations_url":"https://api.github.com/users/dchelimsky/orgs","repos_url":"https://api.github.com/users/dchelimsky/repos","events_url":"https://api.github.com/users/dchelimsky/events{/privacy}","received_events_url":"https://api.github.com/users/dchelimsky/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rspec/rspec-core/issues/556/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rspec/rspec-core/issues/556/timeline","performed_via_github_app":null,"state_reason":"completed"}