diff --git a/Changelog.md b/Changelog.md
index 1c389f42..cdad07d0 100644
--- a/Changelog.md
+++ b/Changelog.md
@@ -54,6 +54,9 @@ Bug Fixes:
 * When a shared example defined in an external file fails, use the host
   example group (from a loaded spec file) for the re-run command to
   ensure the command will actually work. (Myron Marston, #1835)
+* Fix location filtering to work properly for examples defined in
+  a nested example group within a shared example group defined in
+  an external file. (Bradley Schaefer, Xavier Shay, Myron Marston, #1837)
 
 ### 3.1.8 Development
 
diff --git a/lib/rspec/core/metadata_filter.rb b/lib/rspec/core/metadata_filter.rb
index 9b308a94..ec257637 100644
--- a/lib/rspec/core/metadata_filter.rb
+++ b/lib/rspec/core/metadata_filter.rb
@@ -43,9 +43,8 @@ module RSpec
         end
 
         def location_filter_applies?(locations, metadata)
-          # it ignores location filters for other files
-          line_number = example_group_declaration_line(locations, metadata)
-          line_number ? line_number_filter_applies?(line_number, metadata) : true
+          line_numbers = example_group_declaration_lines(locations, metadata)
+          line_numbers ? line_number_filter_applies?(line_numbers, metadata) : true
         end
 
         def line_number_filter_applies?(line_numbers, metadata)
@@ -57,9 +56,10 @@ module RSpec
           Metadata.ascend(metadata).map { |meta| meta[:line_number] }
         end
 
-        def example_group_declaration_line(locations, metadata)
-          return nil unless (parent = metadata.fetch(:example_group) { metadata[:parent_example_group] })
-          locations[File.expand_path(parent[:file_path])]
+        def example_group_declaration_lines(locations, metadata)
+          FlatMap.flat_map(Metadata.ascend(metadata)) do |meta|
+            locations[File.expand_path(meta[:file_path])]
+          end.uniq
         end
 
         def filters_apply?(key, value, metadata)
diff --git a/spec/integration/shared_example_rerun_commands_spec.rb b/spec/integration/shared_example_rerun_commands_spec.rb
index a506c536..29641482 100644
--- a/spec/integration/shared_example_rerun_commands_spec.rb
+++ b/spec/integration/shared_example_rerun_commands_spec.rb
@@ -36,4 +36,31 @@ RSpec.describe 'Shared Example Rerun Commands' do
     command = last_cmd_stdout[/Failed examples:\s+rspec (\S+) #/, 1]
     run_command command
   end
+
+  context "with a shared example containing a context in a separate file" do
+    it "runs the example nested inside the shared" do
+      write_file_formatted 'spec/shared_example.rb', """
+        RSpec.shared_examples_for 'a shared example' do
+          it 'succeeds' do
+          end
+
+          context 'with a nested context' do
+            it 'succeeds (nested)' do
+            end
+          end
+        end
+      """
+
+      write_file_formatted 'spec/simple_spec.rb', """
+        require File.join(File.dirname(__FILE__), 'shared_example.rb')
+
+        RSpec.describe 'top level' do
+          it_behaves_like 'a shared example'
+        end
+      """
+
+      run_command 'spec/simple_spec.rb:3 -fd'
+      expect(last_cmd_stdout).to match(/2 examples, 0 failures/)
+    end
+  end
 end
diff --git a/spec/rspec/core/metadata_filter_spec.rb b/spec/rspec/core/metadata_filter_spec.rb
index 44bc62fb..80032d58 100644
--- a/spec/rspec/core/metadata_filter_spec.rb
+++ b/spec/rspec/core/metadata_filter_spec.rb
@@ -84,10 +84,6 @@ module RSpec
           end
         end
 
-        it "ignores location filters for other files" do
-          expect(filter_applies?(:locations, {"/path/to/other_spec.rb" => [3,5,7]}, example_metadata)).to be_truthy
-        end
-
         it "matches a proc with no arguments that evaluates to true" do
           expect(filter_applies?(:if, lambda { true }, example_metadata)).to be_truthy
         end
diff --git a/spec/support/aruba_support.rb b/spec/support/aruba_support.rb
index 062d89f1..662ddbb9 100644
--- a/spec/support/aruba_support.rb
+++ b/spec/support/aruba_support.rb
@@ -34,6 +34,20 @@ RSpec.shared_context "aruba support" do
     stdout.write(@last_cmd_stdout)
     stderr.write(@last_cmd_stderr)
   end
+
+  def write_file_formatted(file_name, contents)
+    # remove blank line at the start of the string and
+    # strip extra indentation.
+    formatted_contents = unindent(contents.sub(/\A\n/, ""))
+    write_file file_name, formatted_contents
+  end
+
+  # Intended for use with indented heredocs.
+  # taken from Ruby Tapas:
+  # https://rubytapas.dpdcart.com/subscriber/post?id=616#files
+  def unindent(s)
+    s.gsub(/^#{s.scan(/^[ \t]+(?=\S)/).min}/, "")
+  end
 end
 
 RSpec.configure do |c|
