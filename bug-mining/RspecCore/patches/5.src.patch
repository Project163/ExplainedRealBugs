diff --git a/features/command_line/line_number_appended_to_path.feature b/features/command_line/line_number_appended_to_path.feature
index e2fbca9e..87a533c9 100644
--- a/features/command_line/line_number_appended_to_path.feature
+++ b/features/command_line/line_number_appended_to_path.feature
@@ -28,7 +28,6 @@ Feature: line number appended to file path
       end
       """
 
-@wip
   Scenario: nested groups - outer group on declaration line
     When I run "rspec example_spec.rb:1 --format doc"
     Then I should see "3 examples, 0 failures"
@@ -36,7 +35,6 @@ Feature: line number appended to file path
     And I should see "first example in outer group"
     And I should see "example in nested group"
 
-@wip
   Scenario: nested groups - outer group inside block before example
     When I run "rspec example_spec.rb:2 --format doc"
     Then I should see "3 examples, 0 failures"
diff --git a/lib/rspec/core/metadata.rb b/lib/rspec/core/metadata.rb
index e895badf..b7a46c33 100644
--- a/lib/rspec/core/metadata.rb
+++ b/lib/rspec/core/metadata.rb
@@ -4,8 +4,12 @@ module Rspec
 
       def initialize(superclass_metadata=nil)
         @superclass_metadata = superclass_metadata
-        update(@superclass_metadata) if @superclass_metadata
-        store(:example_group, {})
+        if @superclass_metadata
+          update(@superclass_metadata)
+          example_group = {:example_group => @superclass_metadata[:example_group]}
+        end
+
+        store(:example_group, example_group || {})
         store(:behaviour, self[:example_group])
         yield self if block_given?
       end
@@ -83,6 +87,15 @@ EOM
         end
       end
 
+      def relevant_line_numbers(metadata)
+        line_numbers = [metadata[:line_number]]
+        if metadata[:example_group]
+          line_numbers + relevant_line_numbers(metadata[:example_group])
+        else
+          line_numbers
+        end
+      end
+
       def apply_condition(filter_on, filter, metadata=nil)
         metadata ||= self
         case filter
@@ -94,8 +107,7 @@ EOM
           filter.call(metadata[filter_on]) rescue false
         when Fixnum
           if filter_on == :line_number
-            [metadata[:line_number], metadata[:example_group][:line_number]].
-              include?(world.preceding_example_or_group_line(filter))
+            relevant_line_numbers(metadata).include?(world.preceding_declaration_line(filter))
           else
             metadata[filter_on] == filter
           end
diff --git a/lib/rspec/core/world.rb b/lib/rspec/core/world.rb
index b42862bf..f3519c35 100644
--- a/lib/rspec/core/world.rb
+++ b/lib/rspec/core/world.rb
@@ -65,7 +65,7 @@ module Rspec
         examples.reject &all_apply?(conditions)
       end
 
-      def preceding_example_or_group_line(filter_line) 
+      def preceding_declaration_line(filter_line) 
         declaration_line_numbers.inject(nil) do |highest_prior_declaration_line, line|
           line <= filter_line ? line : highest_prior_declaration_line
         end
diff --git a/spec/rspec/core/metadata_spec.rb b/spec/rspec/core/metadata_spec.rb
index 322c23eb..d94bf0c5 100644
--- a/spec/rspec/core/metadata_spec.rb
+++ b/spec/rspec/core/metadata_spec.rb
@@ -76,6 +76,18 @@ module Rspec
         end
       end
 
+      describe "parent example group" do
+        it "nests the parent's example group metadata" do
+          parent = Metadata.new
+          parent.process(Object, 'parent')
+          
+          child = Metadata.new(parent)
+          child.process()
+
+          child[:example_group][:example_group].should == parent[:example_group]
+        end
+      end
+
       describe "file path" do
         it "finds the first spec file in the caller array" do
           m = Metadata.new
@@ -168,7 +180,11 @@ module Rspec
       end
 
       describe "apply_condition" do
-        let(:group_metadata) { Metadata.new.process('group', :caller => ["foo_spec.rb:#{__LINE__}"]) }
+
+
+        let(:parent_group_metadata) { Metadata.new.process('parent group', :caller => ["foo_spec.rb:#{__LINE__}"]) }
+        let(:parent_group_line_number) { __LINE__ -1 }
+        let(:group_metadata) { Metadata.new(parent_group_metadata).process('group', :caller => ["foo_spec.rb:#{__LINE__}"]) }
         let(:group_line_number) { __LINE__ -1 }
         let(:example_metadata) { group_metadata.for_example('example', :caller => ["foo_spec.rb:#{__LINE__}"]) }
         let(:example_line_number) { __LINE__ -1 }
@@ -177,29 +193,34 @@ module Rspec
         let(:world) { Rspec::Core.world }
 
         it "matches the group when the line_number is the example group line number" do
-          world.should_receive(:preceding_example_or_group_line).and_return(group_line_number)
+          world.should_receive(:preceding_declaration_line).and_return(group_line_number)
           # this call doesn't really make sense since apply_condition is only called 
           # for example metadata not group metadata
           group_metadata.apply_condition(:line_number, group_line_number).should be_true
         end
 
+        it "matches the example when the line_number is the grandparent example group line number" do
+          world.should_receive(:preceding_declaration_line).and_return(parent_group_line_number)
+          example_metadata.apply_condition(:line_number, parent_group_line_number).should be_true
+        end
+
         it "matches the example when the line_number is the parent example group line number" do
-          world.should_receive(:preceding_example_or_group_line).and_return(group_line_number)
+          world.should_receive(:preceding_declaration_line).and_return(group_line_number)
           example_metadata.apply_condition(:line_number, group_line_number).should be_true
         end
 
         it "matches the example when the line_number is the example line number" do
-          world.should_receive(:preceding_example_or_group_line).and_return(example_line_number)
+          world.should_receive(:preceding_declaration_line).and_return(example_line_number)
           example_metadata.apply_condition(:line_number, example_line_number).should be_true
         end
         
         it "matches when the line number is between this example and the next" do
-          world.should_receive(:preceding_example_or_group_line).and_return(example_line_number)
+          world.should_receive(:preceding_declaration_line).and_return(example_line_number)
           example_metadata.apply_condition(:line_number, example_line_number + 1).should be_true
         end
         
         it "does not match when the line number matches the next example" do
-          world.should_receive(:preceding_example_or_group_line).and_return(example_line_number + 2)
+          world.should_receive(:preceding_declaration_line).and_return(example_line_number + 2)
           example_metadata.apply_condition(:line_number, example_line_number + 2).should be_false
         end
         
diff --git a/spec/rspec/core/world_spec.rb b/spec/rspec/core/world_spec.rb
index cee764bd..406e8547 100644
--- a/spec/rspec/core/world_spec.rb
+++ b/spec/rspec/core/world_spec.rb
@@ -138,7 +138,7 @@ module Rspec::Core
       
     end
 
-    describe "preceding_example_or_group_line" do
+    describe "preceding_declaration_line" do
       before(:each) do
         @group1_line = 10
         @group2_line = 20
@@ -157,23 +157,23 @@ module Rspec::Core
       end
       
       it "should return nil if no example or group precedes the line" do 
-        @world.preceding_example_or_group_line(@group1_line-1).should == nil
+        @world.preceding_declaration_line(@group1_line-1).should == nil
       end
       
       it "should return the argument line number if a group starts on that line" do
-        @world.preceding_example_or_group_line(@group1_line).should == @group1_line
+        @world.preceding_declaration_line(@group1_line).should == @group1_line
       end
       
       it "should return the argument line number if an example starts on that line" do
-        @world.preceding_example_or_group_line(@group2_example1_line).should == @group2_example1_line
+        @world.preceding_declaration_line(@group2_example1_line).should == @group2_example1_line
       end
       
       it "should return line number of a group that immediately precedes the argument line" do
-        @world.preceding_example_or_group_line(@group2_line+1).should == @group2_line
+        @world.preceding_declaration_line(@group2_line+1).should == @group2_line
       end
       
       it "should return line number of an example that immediately precedes the argument line" do
-        @world.preceding_example_or_group_line(@group2_example1_line+1).should == @group2_example1_line        
+        @world.preceding_declaration_line(@group2_example1_line+1).should == @group2_example1_line        
       end
       
     end
