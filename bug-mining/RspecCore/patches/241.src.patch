diff --git a/Changelog.md b/Changelog.md
index d8529601..1c389f42 100644
--- a/Changelog.md
+++ b/Changelog.md
@@ -51,6 +51,9 @@ Bug Fixes:
   implementation rather than Minitest's. (Jonathan Rochkind, #1822)
 * Fix `NameError` caused when duplicate example group aliases are defined and
   the DSL is not globally exposed. (Aaron Kromer, #1825)
+* When a shared example defined in an external file fails, use the host
+  example group (from a loaded spec file) for the re-run command to
+  ensure the command will actually work. (Myron Marston, #1835)
 
 ### 3.1.8 Development
 
diff --git a/lib/rspec/core/configuration.rb b/lib/rspec/core/configuration.rb
index 6d1f3874..8553b34c 100644
--- a/lib/rspec/core/configuration.rb
+++ b/lib/rspec/core/configuration.rb
@@ -290,7 +290,7 @@ module RSpec
       # @private
       attr_accessor :static_config_filter_manager
       # @private
-      attr_reader :backtrace_formatter, :ordering_manager
+      attr_reader :backtrace_formatter, :ordering_manager, :loaded_spec_files
 
       def initialize
         # rubocop:disable Style/GlobalVars
@@ -306,6 +306,7 @@ module RSpec
 
         @mock_framework = nil
         @files_or_directories_to_run = []
+        @loaded_spec_files = Set.new
         @color = false
         @pattern = '**{,/*/**}/*_spec.rb'
         @exclude_pattern = ''
@@ -1194,7 +1195,12 @@ module RSpec
 
       # @private
       def load_spec_files
-        files_to_run.uniq.each { |f| load File.expand_path(f) }
+        files_to_run.uniq.each do |f|
+          file = File.expand_path(f)
+          load file
+          loaded_spec_files << file
+        end
+
         @spec_files_loaded = true
       end
 
diff --git a/lib/rspec/core/example.rb b/lib/rspec/core/example.rb
index e11748c6..6864ef2b 100644
--- a/lib/rspec/core/example.rb
+++ b/lib/rspec/core/example.rb
@@ -92,6 +92,15 @@ module RSpec
         inspect_output
       end
 
+      # Returns the argument that can be passed to the `rspec` command to rerun this example.
+      def rerun_argument
+        loaded_spec_files = RSpec.configuration.loaded_spec_files
+
+        Metadata.ascend(metadata) do |meta|
+          return meta[:location] if loaded_spec_files.include?(File.expand_path meta[:file_path])
+        end
+      end
+
       # @attr_reader
       #
       # Returns the first exception raised in the context of running this
diff --git a/lib/rspec/core/metadata.rb b/lib/rspec/core/metadata.rb
index b8e19265..a0459f44 100644
--- a/lib/rspec/core/metadata.rb
+++ b/lib/rspec/core/metadata.rb
@@ -50,6 +50,19 @@ module RSpec
         nil
       end
 
+      # @private
+      # Iteratively walks up from the given example metadata through all
+      # example group ancestors, yielding each metadata hash along the way.
+      def self.ascend(example_metadata)
+        yield example_metadata
+        group_metadata = example_metadata.fetch(:example_group)
+
+        loop do
+          yield group_metadata
+          break unless (group_metadata = group_metadata[:parent_example_group])
+        end
+      end
+
       # @private
       # Used internally to build a hash from an args array.
       # Symbols are converted into hash keys with a value of `true`.
diff --git a/lib/rspec/core/notifications.rb b/lib/rspec/core/notifications.rb
index 9793c0b5..f0a678c2 100644
--- a/lib/rspec/core/notifications.rb
+++ b/lib/rspec/core/notifications.rb
@@ -404,8 +404,8 @@ module RSpec::Core
       def colorized_rerun_commands(colorizer=::RSpec::Core::Formatters::ConsoleCodes)
         "\nFailed examples:\n\n" +
         failed_examples.map do |example|
-          colorizer.wrap("rspec #{example.location}",     RSpec.configuration.failure_color) + " " +
-          colorizer.wrap("# #{example.full_description}", RSpec.configuration.detail_color)
+          colorizer.wrap("rspec #{example.rerun_argument}", RSpec.configuration.failure_color) + " " +
+          colorizer.wrap("# #{example.full_description}",   RSpec.configuration.detail_color)
         end.join("\n")
       end
 
diff --git a/spec/integration/shared_example_rerun_commands_spec.rb b/spec/integration/shared_example_rerun_commands_spec.rb
new file mode 100644
index 00000000..a506c536
--- /dev/null
+++ b/spec/integration/shared_example_rerun_commands_spec.rb
@@ -0,0 +1,39 @@
+require 'support/aruba_support'
+
+RSpec.describe 'Shared Example Rerun Commands' do
+  include_context "aruba support"
+  before { clean_current_dir }
+
+  it 'prints a rerun command for shared examples in external files that works to rerun' do
+    write_file "spec/support/shared_examples.rb", """
+      RSpec.shared_examples 'a failing example' do
+        example { expect(1).to eq(2) }
+      end
+    """
+
+    write_file "spec/host_group_spec.rb", """
+      load File.expand_path('../support/shared_examples.rb', __FILE__)
+
+      RSpec.describe 'A group with shared examples' do
+        include_examples 'a failing example'
+      end
+
+      RSpec.describe 'A group with a passing example' do
+        example { expect(1).to eq(1) }
+      end
+    """
+
+    run_command ""
+    expect(last_cmd_stdout).to include("2 examples, 1 failure")
+    run_rerun_command_for_failing_spec
+    expect(last_cmd_stdout).to include("1 example, 1 failure")
+    # There was originally a bug when doing it again...
+    run_rerun_command_for_failing_spec
+    expect(last_cmd_stdout).to include("1 example, 1 failure")
+  end
+
+  def run_rerun_command_for_failing_spec
+    command = last_cmd_stdout[/Failed examples:\s+rspec (\S+) #/, 1]
+    run_command command
+  end
+end
diff --git a/spec/rspec/core/formatters/base_text_formatter_spec.rb b/spec/rspec/core/formatters/base_text_formatter_spec.rb
index 73a3fbf5..bd5d4761 100644
--- a/spec/rspec/core/formatters/base_text_formatter_spec.rb
+++ b/spec/rspec/core/formatters/base_text_formatter_spec.rb
@@ -35,10 +35,28 @@ RSpec.describe RSpec::Core::Formatters::BaseTextFormatter do
         it("fails") { fail }
       end
       line = __LINE__ - 2
+
+      expect(output_from_running example_group).to include("rspec #{RSpec::Core::Metadata::relative_path("#{__FILE__}:#{line}")} # example group fails")
+    end
+
+    context "for an example defined in an file required by the user rather than loaded by rspec" do
+      it "looks through ancestor metadata to find a workable re-run command" do
+        line = __LINE__ + 1
+        example_group = RSpec.describe("example group") do
+          # Using eval in order to make it think this got defined in an external file.
+          instance_eval "it('fails') { fail }", "some/external/file.rb", 1
+        end
+
+        expect(output_from_running example_group).to include("rspec #{RSpec::Core::Metadata::relative_path("#{__FILE__}:#{line}")} # example group fails")
+      end
+    end
+
+    def output_from_running(example_group)
+      allow(RSpec.configuration).to receive(:loaded_spec_files) { [File.expand_path(__FILE__)].to_set }
       example_group.run(reporter)
       examples = example_group.examples
       send_notification :dump_summary, summary_notification(1, examples, examples, [], 0)
-      expect(output.string).to include("rspec #{RSpec::Core::Metadata::relative_path("#{__FILE__}:#{line}")} # example group fails")
+      output.string
     end
   end
 
diff --git a/spec/support/aruba_support.rb b/spec/support/aruba_support.rb
index 5d9a773d..14992328 100644
--- a/spec/support/aruba_support.rb
+++ b/spec/support/aruba_support.rb
@@ -10,12 +10,22 @@ RSpec.shared_context "aruba support" do
   let(:stderr) { StringIO.new }
   let(:stdout) { StringIO.new }
 
+  attr_reader :last_cmd_stdout, :last_cmd_stderr
+
   def run_command(cmd)
+    temp_stdout = StringIO.new
+    temp_stderr = StringIO.new
+
     in_current_dir do
-      RSpec::Core::Runner.run(cmd.split, stderr, stdout)
+      RSpec::Core::Runner.run(cmd.split, temp_stderr, temp_stdout)
     end
   ensure
     RSpec.reset
+
+    @last_cmd_stdout = temp_stdout.string
+    @last_cmd_stderr = temp_stderr.string
+    stdout.write(@last_cmd_stdout)
+    stderr.write(@last_cmd_stderr)
   end
 
   def in_current_dir
diff --git a/spec/support/formatter_support.rb b/spec/support/formatter_support.rb
index c81c88c9..d2b82624 100644
--- a/spec/support/formatter_support.rb
+++ b/spec/support/formatter_support.rb
@@ -194,6 +194,7 @@ module FormatterSupport
                         :full_description  => "Example",
                         :execution_result  => result,
                         :location          => "",
+                        :rerun_argument    => "",
                         :metadata          => {
                           :shared_group_inclusion_backtrace => []
                         }
