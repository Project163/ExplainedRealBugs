diff --git a/Changelog.md b/Changelog.md
index e6d4306b..ac36f115 100644
--- a/Changelog.md
+++ b/Changelog.md
@@ -5,6 +5,9 @@ Bug Fixes:
 
 * Prevent a `TypeError` from occuring when running via the rake task when
   Ruby crashes. (Patrik Wenger, #2161)
+* Only consider example and group declaration lines from a specific file
+  when applying line number filtering, instead of considering all
+  declaration lines from all spec files. (Myron Marston, #2170)
 
 ### 3.5.0.beta1 / 2016-02-06
 [Full Changelog](http://github.com/rspec/rspec-core/compare/v3.4.2...v3.5.0.beta1)
diff --git a/lib/rspec/core/example_group.rb b/lib/rspec/core/example_group.rb
index 9bb216f6..d0e1db6a 100644
--- a/lib/rspec/core/example_group.rb
+++ b/lib/rspec/core/example_group.rb
@@ -347,7 +347,7 @@ module RSpec
         @descendant_filtered_examples = nil
         @_descendants = nil
         @parent_groups = nil
-        @declaration_line_numbers = nil
+        @declaration_locations = nil
       end
 
       # Adds an example to the example group
@@ -613,10 +613,10 @@ module RSpec
       end
 
       # @private
-      def self.declaration_line_numbers
-        @declaration_line_numbers ||= [metadata[:line_number]] +
-          examples.map { |e| e.metadata[:line_number] } +
-          FlatMap.flat_map(children, &:declaration_line_numbers)
+      def self.declaration_locations
+        @declaration_locations ||= [Metadata.location_tuple_from(metadata)] +
+          examples.map { |e| Metadata.location_tuple_from(e.metadata) } +
+          FlatMap.flat_map(children, &:declaration_locations)
       end
 
       # @return [String] the unique id of this example group. Pass
diff --git a/lib/rspec/core/metadata.rb b/lib/rspec/core/metadata.rb
index c164e36b..619628f6 100644
--- a/lib/rspec/core/metadata.rb
+++ b/lib/rspec/core/metadata.rb
@@ -106,6 +106,11 @@ module RSpec
         "#{metadata[:rerun_file_path]}[#{metadata[:scoped_id]}]"
       end
 
+      # @private
+      def self.location_tuple_from(metadata)
+        [metadata[:absolute_file_path], metadata[:line_number]]
+      end
+
       # @private
       # Used internally to populate metadata hashes with computed keys
       # managed by RSpec.
diff --git a/lib/rspec/core/world.rb b/lib/rspec/core/world.rb
index cde98610..c77f75ec 100644
--- a/lib/rspec/core/world.rb
+++ b/lib/rspec/core/world.rb
@@ -96,10 +96,12 @@ module RSpec
       # @api private
       #
       # Find line number of previous declaration.
-      def preceding_declaration_line(_file_name, filter_line)
-        declaration_line_numbers.sort.inject(nil) do |highest_prior_declaration_line, line|
-          line <= filter_line ? line : highest_prior_declaration_line
+      def preceding_declaration_line(absolute_file_name, filter_line)
+        line_numbers = descending_declaration_line_numbers_by_file.fetch(absolute_file_name) do
+          return nil
         end
+
+        line_numbers.find { |num| num <= filter_line }
       end
 
       # @private
@@ -179,8 +181,22 @@ module RSpec
 
     private
 
-      def declaration_line_numbers
-        @declaration_line_numbers ||= FlatMap.flat_map(example_groups, &:declaration_line_numbers)
+      def descending_declaration_line_numbers_by_file
+        @descending_declaration_line_numbers_by_file ||= begin
+          declaration_locations = FlatMap.flat_map(example_groups, &:declaration_locations)
+          hash_of_arrays = Hash.new { |h, k| h[k] = [] }
+
+          # TODO: change `inject` to `each_with_object` when we drop 1.8.7 support.
+          line_nums_by_file = declaration_locations.inject(hash_of_arrays) do |hash, (file_name, line_number)|
+            hash[file_name] << line_number
+            hash
+          end
+
+          line_nums_by_file.each_value do |list|
+            list.sort!
+            list.reverse!
+          end
+        end
       end
 
       def fail_if_config_and_cli_options_invalid
diff --git a/spec/integration/filtering_spec.rb b/spec/integration/filtering_spec.rb
index d9a8a179..cee5189a 100644
--- a/spec/integration/filtering_spec.rb
+++ b/spec/integration/filtering_spec.rb
@@ -96,6 +96,33 @@ RSpec.describe 'Filtering' do
       run_command "spec/a_spec.rb:13 -fd" # selecting :if => false example
       expect(last_cmd_stdout).to include("0 examples, 0 failures").and exclude("ex 1", "ex 2", "ex 3", "ex 4", "ex 5")
     end
+
+    it 'works correctly when line numbers align with a shared example group line number from another file' do
+      write_file_formatted 'spec/support/shared_examples_with_matching_line.rb', "
+        # line 1
+        # line 2
+        # line 3
+        RSpec.shared_examples_for 'shared examples' do # line 4
+          it 'fails' do # line 5
+            fail 'shared example'
+          end
+        end
+      "
+
+      write_file_formatted 'spec/some_spec.rb', "
+        require File.expand_path('../support/shared_examples_with_matching_line', __FILE__) # line 1
+        RSpec.describe 'A group' do # line 2
+          it_behaves_like 'shared examples' # line 3
+          # line 4
+          it 'passes' do # line 5
+            expect(1).to eq(1)
+          end
+        end
+      "
+
+      run_command "spec/some_spec.rb:5"
+      expect(last_cmd_stdout).to include("1 example, 0 failures")
+    end
   end
 
   context "passing a line-number-filtered file and a non-filtered file" do
diff --git a/spec/rspec/core/example_group_spec.rb b/spec/rspec/core/example_group_spec.rb
index eb19b870..26e5f959 100644
--- a/spec/rspec/core/example_group_spec.rb
+++ b/spec/rspec/core/example_group_spec.rb
@@ -1878,7 +1878,7 @@ module RSpec::Core
     def group_ids group
       ids = []
       ['descendant_filtered_examples', 'descendants',
-       'parent_groups', 'declaration_line_numbers', 'before_context_ivars'].each do |method|
+       'parent_groups', 'declaration_locations', 'before_context_ivars'].each do |method|
         ids << group.send(method).object_id
       end
       ids
diff --git a/spec/rspec/core/world_spec.rb b/spec/rspec/core/world_spec.rb
index 6584c012..1b6db1c5 100644
--- a/spec/rspec/core/world_spec.rb
+++ b/spec/rspec/core/world_spec.rb
@@ -119,7 +119,7 @@ module RSpec::Core
         end
       end
 
-      context "with two examples and the second example is registered first" do
+      context "with two groups and the second example is registered first" do
         let(:second_group_declaration_line) { second_group.metadata[:line_number] }
 
         before do
@@ -131,6 +131,40 @@ module RSpec::Core
           expect(preceding_declaration_line(second_group_declaration_line)).to eq(second_group_declaration_line)
         end
       end
+
+      context "with groups from multiple files registered" do
+        another_file = File.join(__FILE__, "another_spec_file.rb")
+
+        let(:group_from_another_file) do
+          instance_eval <<-EOS, another_file, 1
+            RSpec.describe("third group") do
+
+              example("inside of a gropu")
+
+            end
+          EOS
+        end
+
+        before do
+          world.register(group)
+          world.register(group_from_another_file)
+        end
+
+        it "returns nil if given a file name with no declarations" do
+          expect(world.preceding_declaration_line("/some/other/file.rb", 100_000)).to eq(nil)
+        end
+
+        it "considers only declaration lines from the provided files", :aggregate_failures do
+          expect(world.preceding_declaration_line(another_file, 1)).to eq(1)
+          expect(world.preceding_declaration_line(another_file, 2)).to eq(1)
+          expect(world.preceding_declaration_line(another_file, 3)).to eq(3)
+          expect(world.preceding_declaration_line(another_file, 4)).to eq(3)
+          expect(world.preceding_declaration_line(another_file, 5)).to eq(3)
+          expect(world.preceding_declaration_line(another_file, 100_000)).to eq(3)
+
+          expect(world.preceding_declaration_line(__FILE__, group_declaration_line + 1)).to eq(group_declaration_line)
+        end
+      end
     end
 
     describe '#source_cache' do
