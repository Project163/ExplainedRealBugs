{"url":"https://api.github.com/repos/INRIA/spoon/issues/722","repository_url":"https://api.github.com/repos/INRIA/spoon","labels_url":"https://api.github.com/repos/INRIA/spoon/issues/722/labels{/name}","comments_url":"https://api.github.com/repos/INRIA/spoon/issues/722/comments","events_url":"https://api.github.com/repos/INRIA/spoon/issues/722/events","html_url":"https://github.com/INRIA/spoon/issues/722","id":162131591,"node_id":"MDU6SXNzdWUxNjIxMzE1OTE=","number":722,"title":"After the execution of checkShadow the AST is inconsistent","user":{"login":"tdurieux","id":5577568,"node_id":"MDQ6VXNlcjU1Nzc1Njg=","avatar_url":"https://avatars.githubusercontent.com/u/5577568?v=4","gravatar_id":"","url":"https://api.github.com/users/tdurieux","html_url":"https://github.com/tdurieux","followers_url":"https://api.github.com/users/tdurieux/followers","following_url":"https://api.github.com/users/tdurieux/following{/other_user}","gists_url":"https://api.github.com/users/tdurieux/gists{/gist_id}","starred_url":"https://api.github.com/users/tdurieux/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tdurieux/subscriptions","organizations_url":"https://api.github.com/users/tdurieux/orgs","repos_url":"https://api.github.com/users/tdurieux/repos","events_url":"https://api.github.com/users/tdurieux/events{/privacy}","received_events_url":"https://api.github.com/users/tdurieux/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2016-06-24T11:54:07Z","updated_at":"2016-06-29T15:00:06Z","closed_at":"2016-06-29T15:00:06Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I try to had a test that verifies positions of elements in the AST.\nBut after the execution of the test checkShadow the AST is inconsistent. \nSome parents does not point anymore to the correct element.\n\nIt's probably a bug in the shadow implementation (a missing clone?)\n\nI create this test that founds 170 elements that does not have the good parent.\n\n``` java\nprivate void checkParentConsistency(CtPackage pack) {\n        Set<CtElement> inconsistentParents = new HashSet<>();\n        new CtScanner() {\n            private Deque<CtElement> previous = new ArrayDeque();\n            @Override\n            protected void enter(CtElement e) {\n                if (e != null) {\n                    if (!previous.isEmpty()) {\n                        try {\n                            if (e.getParent() != previous.getLast()) {\n                                inconsistentParents.add(e);\n                            }\n                        } catch (ParentNotInitializedException ignore) {\n                            inconsistentParents.add(e);\n                        }\n                    }\n                    previous.add(e);\n                }\n                super.enter(e);\n            }\n\n            @Override\n            protected void exit(CtElement e) {\n                if (e == null) {\n                    return;\n                }\n                if (e.equals(previous.getLast())) {\n                    previous.removeLast();\n                } else {\n                    throw new RuntimeException(\"Inconsistent stack\");\n                }\n                super.exit(e);\n            }\n        }.visitCtPackage(pack);\n        assertEquals(\"All parents have to be consistent\", 0, inconsistentParents.size());\n    }\n```\n","closed_by":{"login":"monperrus","id":803666,"node_id":"MDQ6VXNlcjgwMzY2Ng==","avatar_url":"https://avatars.githubusercontent.com/u/803666?v=4","gravatar_id":"","url":"https://api.github.com/users/monperrus","html_url":"https://github.com/monperrus","followers_url":"https://api.github.com/users/monperrus/followers","following_url":"https://api.github.com/users/monperrus/following{/other_user}","gists_url":"https://api.github.com/users/monperrus/gists{/gist_id}","starred_url":"https://api.github.com/users/monperrus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/monperrus/subscriptions","organizations_url":"https://api.github.com/users/monperrus/orgs","repos_url":"https://api.github.com/users/monperrus/repos","events_url":"https://api.github.com/users/monperrus/events{/privacy}","received_events_url":"https://api.github.com/users/monperrus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/INRIA/spoon/issues/722/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/INRIA/spoon/issues/722/timeline","performed_via_github_app":null,"state_reason":"completed"}