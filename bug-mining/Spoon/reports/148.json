{"url":"https://api.github.com/repos/INRIA/spoon/issues/756","repository_url":"https://api.github.com/repos/INRIA/spoon","labels_url":"https://api.github.com/repos/INRIA/spoon/issues/756/labels{/name}","comments_url":"https://api.github.com/repos/INRIA/spoon/issues/756/comments","events_url":"https://api.github.com/repos/INRIA/spoon/issues/756/events","html_url":"https://github.com/INRIA/spoon/issues/756","id":167050803,"node_id":"MDU6SXNzdWUxNjcwNTA4MDM=","number":756,"title":"Bug with variable declaration resolving after clone","user":{"login":"fedorov-s-n","id":7754933,"node_id":"MDQ6VXNlcjc3NTQ5MzM=","avatar_url":"https://avatars.githubusercontent.com/u/7754933?v=4","gravatar_id":"","url":"https://api.github.com/users/fedorov-s-n","html_url":"https://github.com/fedorov-s-n","followers_url":"https://api.github.com/users/fedorov-s-n/followers","following_url":"https://api.github.com/users/fedorov-s-n/following{/other_user}","gists_url":"https://api.github.com/users/fedorov-s-n/gists{/gist_id}","starred_url":"https://api.github.com/users/fedorov-s-n/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fedorov-s-n/subscriptions","organizations_url":"https://api.github.com/users/fedorov-s-n/orgs","repos_url":"https://api.github.com/users/fedorov-s-n/repos","events_url":"https://api.github.com/users/fedorov-s-n/events{/privacy}","received_events_url":"https://api.github.com/users/fedorov-s-n/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"GerardPaligot","id":1913901,"node_id":"MDQ6VXNlcjE5MTM5MDE=","avatar_url":"https://avatars.githubusercontent.com/u/1913901?v=4","gravatar_id":"","url":"https://api.github.com/users/GerardPaligot","html_url":"https://github.com/GerardPaligot","followers_url":"https://api.github.com/users/GerardPaligot/followers","following_url":"https://api.github.com/users/GerardPaligot/following{/other_user}","gists_url":"https://api.github.com/users/GerardPaligot/gists{/gist_id}","starred_url":"https://api.github.com/users/GerardPaligot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/GerardPaligot/subscriptions","organizations_url":"https://api.github.com/users/GerardPaligot/orgs","repos_url":"https://api.github.com/users/GerardPaligot/repos","events_url":"https://api.github.com/users/GerardPaligot/events{/privacy}","received_events_url":"https://api.github.com/users/GerardPaligot/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"GerardPaligot","id":1913901,"node_id":"MDQ6VXNlcjE5MTM5MDE=","avatar_url":"https://avatars.githubusercontent.com/u/1913901?v=4","gravatar_id":"","url":"https://api.github.com/users/GerardPaligot","html_url":"https://github.com/GerardPaligot","followers_url":"https://api.github.com/users/GerardPaligot/followers","following_url":"https://api.github.com/users/GerardPaligot/following{/other_user}","gists_url":"https://api.github.com/users/GerardPaligot/gists{/gist_id}","starred_url":"https://api.github.com/users/GerardPaligot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/GerardPaligot/subscriptions","organizations_url":"https://api.github.com/users/GerardPaligot/orgs","repos_url":"https://api.github.com/users/GerardPaligot/repos","events_url":"https://api.github.com/users/GerardPaligot/events{/privacy}","received_events_url":"https://api.github.com/users/GerardPaligot/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":8,"created_at":"2016-07-22T13:56:33Z","updated_at":"2016-07-28T12:56:20Z","closed_at":"2016-07-28T12:56:20Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"# Problem\n\nAfter cloning AST subtree variable references are resolved to wrong declaration that makes it difficult to perform further modifications.\n# Example\n\nSuppose there's a code:\n\n```\npublic class A {\n\n    int field;\n\n    public void b(int param) {\n        IntUnaryOperator f1 = x -> x;\n        IntBinaryOperator f2 = (a, b) -> a + b;\n        try {\n            System.out.println(f1.applyAsInt(f2.applyAsInt(field, param)));\n        } catch (RuntimeException e) {\n            throw e;\n        }\n    }\n}\n```\n\nGoal is to clone class `A`, rename copy to `B` and perform some modifications with `B`.\n# Problems with example\n1. Local variables references `f1`, `f2` in `B.b()` still refer to declarations in `A.b()`. The same is true about Catch variable reference `e`\n2. Method parameter reference and and class field reference are resolved to declarations in `A.b()` and `A` correspondingly because they resolves using type reference that points to `A`\n3. Resolving variables using plain field reference (local and catch variables) and dynamic lookup (field and parameter variables) are different strategies, and that's not clear that different variable types use different strategies. Developers who use Spoon API should look to sources to understand it.\n4. In scenario that extensively uses resolving declaration by reference lookups took longer than field read.\n# Proposed solution\n1. remove `setDeclaringType` and `setDeclaringExecutable` methods, references are not declared! (fields and parameters are)\n2. add `setDeclaration` method to `CtVariableReference`\n3. cache declaration in reference if it was already resolved, allow to invalidate cache\n4. set unified resolving strategy for all variable types\n# Prototype code:\n\n```\npublic interface CtVariableReference<T, V extends CtVariable<T>> extends CtReference {\n\n    @Override\n    public V getDeclaration();\n\n    public void setDeclaration(V declaration);\n}\n\npublic abstract class CtVariableReferenceImpl<T, V extends CtVariable<T>> extends CtReferenceImpl implements CtVariableReference<T, V> {\n\n    private V declaration = null;\n\n    @Override\n    public V getDeclaration() {\n        if (declaration == null) {\n            declaration = lookupDeclaration();\n        }\n        return declaration;\n    }\n\n    /**\n     *\n     * @param declaration if not null, set declaration of this variable\n     * reference; if null, set declaration as unknown and lookup it on next call\n     * to `getDeclaration()`\n     *\n     */\n    @Override\n    public void setDeclaration(V declaration) {\n        this.declaration = declaration;\n    }\n\n    protected abstract V lookupDeclaration();\n}\n\npublic class CtLocalVariableReferenceImpl<T> extends CtVariableReferenceImpl<T, CtLocalVariable<T>> implements CtLocalVariableReference<T> {\n\n    @Override\n    protected CtLocalVariable<T> lookupDeclaration() {\n        CtElement element = this;\n        Optional<CtLocalVariable> optional;\n        String name = getSimpleName();\n        do {\n            CtStatementList block = element.getParent(CtStatementList.class);\n            optional = block.getStatements()\n                .stream()\n                .filter(s -> s instanceof CtLocalVariable)\n                .map(s -> (CtLocalVariable) s)\n                .filter(var -> name.equals(var.getSimpleName()))\n                .findFirst();\n            element = block;\n        } while (!optional.isPresent());\n        return optional.get();\n    }\n}\n\npublic class CtCatchVariableReferenceImpl<T> extends CtVariableReferenceImpl<T, CtCatchVariable<T>> implements {\n\n    @Override\n    protected CtCatchVariable<T> lookupDeclaration() {\n        CtElement element = this;\n        String name = getSimpleName();\n        CtCatchVariable var;\n        do {\n            CtCatch catchBlock = element.getParent(CtCatch.class);\n            var = catchBlock.getParameter();\n            element = catchBlock;\n        } while (!name.equals(var.getSimpleName()));\n        return var;\n    }\n}\n\npublic class CtFieldReferenceImpl<T> extends CtVariableReferenceImpl<T, CtField<T>> implements CtFieldReference<T> {\n\n    @Override\n    protected CtField<T> lookupDeclaration() {\n        CtElement element = this;\n        Optional<CtField> optional;\n        String name = getSimpleName();\n        do {\n            CtType type = element.getParent(CtType.class);\n            optional = ((List<CtField>) type.getFields())\n                .stream()\n                .filter(f -> name.equals(f.getSimpleName()))\n                .findFirst();\n            element = type;\n        } while (!optional.isPresent());\n        return optional.get();\n    }\n}\n\npublic class CtParameterReferenceImpl<T> extends CtVariableReferenceImpl<T, CtParameter<T>> implements CtParameterReference<T> {\n\n    @Override\n    protected CtParameter<T> lookupDeclaration() {\n        CtElement element = this;\n        Optional<CtParameter> optional;\n        String name = getSimpleName();\n        do {\n            CtExecutable executable = element.getParent(CtExecutable.class);\n            optional = ((List<CtParameter>) executable.getParameters())\n                .stream()\n                .filter(var -> name.equals(var.getSimpleName()))\n                .findFirst();\n            element = executable;\n        } while (!optional.isPresent());\n        return optional.get();\n    }\n}\n```\n# +/-\n- +Uninfied access to changing declaration\n- +Allows to keep references after cloning\n- -Requires change to API\n- -Introduces lookup failures for local and catch variables (if parent not initialized) \n","closed_by":{"login":"monperrus","id":803666,"node_id":"MDQ6VXNlcjgwMzY2Ng==","avatar_url":"https://avatars.githubusercontent.com/u/803666?v=4","gravatar_id":"","url":"https://api.github.com/users/monperrus","html_url":"https://github.com/monperrus","followers_url":"https://api.github.com/users/monperrus/followers","following_url":"https://api.github.com/users/monperrus/following{/other_user}","gists_url":"https://api.github.com/users/monperrus/gists{/gist_id}","starred_url":"https://api.github.com/users/monperrus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/monperrus/subscriptions","organizations_url":"https://api.github.com/users/monperrus/orgs","repos_url":"https://api.github.com/users/monperrus/repos","events_url":"https://api.github.com/users/monperrus/events{/privacy}","received_events_url":"https://api.github.com/users/monperrus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/INRIA/spoon/issues/756/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/INRIA/spoon/issues/756/timeline","performed_via_github_app":null,"state_reason":"completed"}