{"url":"https://api.github.com/repos/INRIA/spoon/issues/1246","repository_url":"https://api.github.com/repos/INRIA/spoon","labels_url":"https://api.github.com/repos/INRIA/spoon/issues/1246/labels{/name}","comments_url":"https://api.github.com/repos/INRIA/spoon/issues/1246/comments","events_url":"https://api.github.com/repos/INRIA/spoon/issues/1246/events","html_url":"https://github.com/INRIA/spoon/issues/1246","id":218544130,"node_id":"MDU6SXNzdWUyMTg1NDQxMzA=","number":1246,"title":"Compilation bug, spoon silently doesn't compile any source code in environment where new File(\".\") points to the folder without any java sources (for example in tomcat environment where it points to the bin folder)","user":{"login":"gnom7","id":12565937,"node_id":"MDQ6VXNlcjEyNTY1OTM3","avatar_url":"https://avatars.githubusercontent.com/u/12565937?v=4","gravatar_id":"","url":"https://api.github.com/users/gnom7","html_url":"https://github.com/gnom7","followers_url":"https://api.github.com/users/gnom7/followers","following_url":"https://api.github.com/users/gnom7/following{/other_user}","gists_url":"https://api.github.com/users/gnom7/gists{/gist_id}","starred_url":"https://api.github.com/users/gnom7/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gnom7/subscriptions","organizations_url":"https://api.github.com/users/gnom7/orgs","repos_url":"https://api.github.com/users/gnom7/repos","events_url":"https://api.github.com/users/gnom7/events{/privacy}","received_events_url":"https://api.github.com/users/gnom7/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":64529851,"node_id":"MDU6TGFiZWw2NDUyOTg1MQ==","url":"https://api.github.com/repos/INRIA/spoon/labels/bug","name":"bug","color":"fef2c0","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":14,"created_at":"2017-03-31T15:55:08Z","updated_at":"2017-04-03T16:36:03Z","closed_at":"2017-04-03T16:36:03Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello, I have a project that uses spoon 5.3.0. but as for now due to missing org.eclipse.jdt.core/3.12.0.v20160516-2131 (on which spoon relies) in maven repo (and because of that problem some builds on my CI have been failed) I consider switching to spoon 5.6.0, but it seems that I have faced a bug -- when I tested my code in IDE everything was fine, but the same code didn't work in tomcat environment - spoon silently didn't compiled any source code.\r\n\r\nDebugging:\r\nWhen running compile() on SpoonModelBuilder it calls batchCompiler.compile(args); so those args doesn't contain input sources, but \".\"\r\n\r\n```\r\nfinal String[] args = new JDTBuilderImpl() //\r\n\t\t\t\t.classpathOptions(new ClasspathOptions().encoding(this.encoding).classpath(getSourceClasspath()).binaries(getBinaryOutputDirectory())) //\r\n\t\t\t\t.complianceOptions(new ComplianceOptions().compliance(javaCompliance)) //\r\n\t\t\t\t.annotationProcessingOptions(new AnnotationProcessingOptions().compileProcessors()) //\r\n\t\t\t\t.advancedOptions(new AdvancedOptions().preserveUnusedVars().continueExecution().enableJavadoc()) //\r\n\t\t\t\t.sources(new SourceOptions().sources()) // no sources, handled by the JDTBatchCompiler\r\n\t\t\t\t.build();\r\n\r\n\t\tgetFactory().getEnvironment().debugMessage(\"compile args: \" + Arrays.toString(args));\r\n\t\tSystem.setProperty(\"jdt.compiler.useSingleThread\", \"true\");\r\n\t\tbatchCompiler.compile(args);\r\n```\r\nthen in org.eclipse.jdt.internal.compiler.batch.Main it creates `new File(\".\")` from that argument and calls org.eclipse.jdt.internal.compiler.batch.FileFinder which recursively searchs for files with `SuffixConstants.SUFFIX_STRING_JAVA` (\".java\") extension, so when running in tomcat `new File(\".\")` points to tomcat bin folder wich does not contain any .java files (and running in IDE in sandbox project it points to project base dir -- so it contains .java files), then in Main class filesCount == 0 is true (there is no .java files in tomcat bin folder) and compilation termiates even not being started and in IDE filesCount != 0 (project base dir contains .java files) and compilation proceeds. I haven't debugged further more, and I don't know how then compiled files appeared from VALID sources (not from the project base)...\r\nwhen filesCount == 0, the code below in Main class switches proceed flag to false and eclipse compiler dies.\r\n```\r\n\tif (printUsageRequired || (filesCount == 0 && classCount == 0)) {\r\n\t\tif (usageSection ==  null) {\r\n\t\t\tprintUsage(); // default\r\n\t\t} else {\r\n\t\t\tprintUsage(usageSection);\r\n\t\t}\r\n\t\tthis.proceed = false;\r\n\t\treturn;\r\n\t}\r\n```\r\n\r\n```\r\n/*\r\n *  Low-level API performing the actual compilation\r\n */\r\npublic boolean compile(String[] argv) {\r\n\t// decode command line arguments\r\n\ttry {\r\n\t\tconfigure(argv); //!!!! code above is here\r\n\t\tif (this.progress != null)\r\n\t\t\tthis.progress.begin(this.filenames == null ? 0 : this.filenames.length * this.maxRepetition);\r\n\t\tif (this.proceed) { //!!!! the proceed flag was already switched to false....\r\n```\r\nI have used `InputType.FILES - compiles the java files from the file system, which were registered by {@link #addInputSource(File)} and {@link #addTemplateSource(File)}`\r\nand as was said in the above javaDoc `compiler.addInputSource(spoonResource);` method, so it seems to me that I have done all right.\r\n (the same for v5.5.0)\r\n(for v5.4.0 eclipse compiler is missing too)\r\nThe sample of my code is below.\r\n```\r\nSpoonModelBuilder compiler = new Launcher().createCompiler();\r\ncompiler.setSourceClasspath(classpath);\r\ncompiler.addInputSource(new File(\"/sourceFolder\"));\r\ncompiler.setBinaryOutputDirectory(new File(\"/outputFolder\"));\r\ncompiler.compile(SpoonModelBuilder.InputType.FILES);\r\n```\r\n\r\nPlease note that the same code runs fine directly from IDE via main method, and doesn't work when running in tomcat in bean initialization code.\r\n\r\nYou can create small spring-boot project with dummy component with `@PostConstruct` method in which you can try to compile something, like I did (just place resulting jar with project and embedded tomcat in separate empty folder and run `java -jar your.jar`, then add to the folder some .java files and compilation will be performed).\r\nSo the matter is that with such implementation when new File(\".\") folder does not contain java source code spoon will not be able to compile wichever other source code.","closed_by":{"login":"monperrus","id":803666,"node_id":"MDQ6VXNlcjgwMzY2Ng==","avatar_url":"https://avatars.githubusercontent.com/u/803666?v=4","gravatar_id":"","url":"https://api.github.com/users/monperrus","html_url":"https://github.com/monperrus","followers_url":"https://api.github.com/users/monperrus/followers","following_url":"https://api.github.com/users/monperrus/following{/other_user}","gists_url":"https://api.github.com/users/monperrus/gists{/gist_id}","starred_url":"https://api.github.com/users/monperrus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/monperrus/subscriptions","organizations_url":"https://api.github.com/users/monperrus/orgs","repos_url":"https://api.github.com/users/monperrus/repos","events_url":"https://api.github.com/users/monperrus/events{/privacy}","received_events_url":"https://api.github.com/users/monperrus/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/INRIA/spoon/issues/1246/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/INRIA/spoon/issues/1246/timeline","performed_via_github_app":null,"state_reason":"completed"}