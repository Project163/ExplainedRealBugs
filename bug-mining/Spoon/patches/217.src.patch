diff --git a/src/main/java/spoon/support/reflect/declaration/CtTypeImpl.java b/src/main/java/spoon/support/reflect/declaration/CtTypeImpl.java
index 1b04dfc1e..ab507e8eb 100644
--- a/src/main/java/spoon/support/reflect/declaration/CtTypeImpl.java
+++ b/src/main/java/spoon/support/reflect/declaration/CtTypeImpl.java
@@ -59,6 +59,7 @@ import java.util.Collections;
 import java.util.Comparator;
 import java.util.HashSet;
 import java.util.List;
+import java.util.Optional;
 import java.util.Set;
 
 /**
@@ -283,7 +284,7 @@ public abstract class CtTypeImpl<T> extends CtNamedElementImpl implements CtType
 	}
 
 	private boolean shouldIncludeSamePackage(boolean includeSamePackage, CtTypeReference<?> typeRef) {
-		return includeSamePackage || (getPackage() != null && !getPackageReference(typeRef).equals(getPackage().getReference()));
+		return includeSamePackage || (getPackage() != null && !getPackageReference(typeRef).map(v -> v.equals(getPackage().getReference())).orElse(false));
 	}
 
 	private boolean isValidTypeReference(CtTypeReference<?> typeRef) {
@@ -305,13 +306,16 @@ public abstract class CtTypeImpl<T> extends CtNamedElementImpl implements CtType
 	 * @see CtTypeReference#getPackage()
 	 * @since 4.0
 	 */
-	private static CtPackageReference getPackageReference(CtTypeReference<?> tref) {
+	private static Optional<CtPackageReference> getPackageReference(CtTypeReference<?> tref) {
 		CtPackageReference pref = tref.getPackage();
 		while (pref == null) {
 			tref = tref.getDeclaringType();
+			if (tref == null) {
+				return Optional.empty();
+			}
 			pref = tref.getPackage();
 		}
-		return pref;
+		return Optional.of(pref);
 	}
 
 	@Override
diff --git a/src/test/java/spoon/test/ctType/CtTypeTest.java b/src/test/java/spoon/test/ctType/CtTypeTest.java
index 20b1ac5d5..e4cec7d44 100644
--- a/src/test/java/spoon/test/ctType/CtTypeTest.java
+++ b/src/test/java/spoon/test/ctType/CtTypeTest.java
@@ -237,4 +237,16 @@ public class CtTypeTest {
 
 		assertEquals(expectedInterfaceOrder, interfaces);
 	}
+	@Test
+	public void getUsedTypesWithWildcard() {
+		//contract: Wildcard types like "?" shouldn't create a NPE. For more context see issue#3514
+		String input = "src/test/resources/layornos/AllocationStorage.java";
+		Launcher launcher = new Launcher();
+		launcher.getEnvironment().setNoClasspath(true);
+		launcher.addInputResource(input);
+		CtModel model = launcher.buildModel();
+		model.getAllTypes().forEach(type -> {
+			type.getUsedTypes(false);
+			});
+	}
 }
diff --git a/src/test/resources/layornos/AllocationStorage.java b/src/test/resources/layornos/AllocationStorage.java
new file mode 100644
index 000000000..edeb48349
--- /dev/null
+++ b/src/test/resources/layornos/AllocationStorage.java
@@ -0,0 +1,10 @@
+		public class AllocationStorage
+		{
+
+			public void initContainerTemplate()
+			{
+				Class<?> component;
+
+			}
+		}
+	
\ No newline at end of file
