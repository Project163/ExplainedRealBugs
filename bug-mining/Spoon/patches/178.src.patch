diff --git a/src/main/java/spoon/support/compiler/jdt/CompilationUnitWrapper.java b/src/main/java/spoon/support/compiler/jdt/CompilationUnitWrapper.java
index 0abab02a5..2539bb1ca 100644
--- a/src/main/java/spoon/support/compiler/jdt/CompilationUnitWrapper.java
+++ b/src/main/java/spoon/support/compiler/jdt/CompilationUnitWrapper.java
@@ -16,57 +16,42 @@
  */
 package spoon.support.compiler.jdt;
 
-import org.apache.commons.io.IOUtils;
 import org.eclipse.jdt.internal.compiler.batch.CompilationUnit;
-import spoon.Launcher;
+import spoon.reflect.declaration.CtType;
+import spoon.reflect.visitor.DefaultJavaPrettyPrinter;
 
-import java.io.FileInputStream;
-import java.io.FileNotFoundException;
-import java.io.InputStream;
+import java.util.ArrayList;
+import java.util.List;
 
 class CompilationUnitWrapper extends CompilationUnit {
 
 	private final JDTBasedSpoonCompiler jdtCompiler;
+	private CtType type;
 
-	CompilationUnitWrapper(JDTBasedSpoonCompiler jdtCompiler, CompilationUnit wrappedUnit) {
-		super(null, wrappedUnit.fileName != null ? new String(
-				wrappedUnit.fileName) : null, null,
-				wrappedUnit.destinationPath != null ? new String(
-						wrappedUnit.destinationPath) : null, false);
+	CompilationUnitWrapper(JDTBasedSpoonCompiler jdtCompiler, CtType type) {
+		super(null, type.getPosition().getFile() != null ? type.getPosition().getFile().getAbsolutePath() : "",
+				null,
+				null,
+				false);
 		this.jdtCompiler = jdtCompiler;
+		this.type = type;
 	}
 
 	@Override
 	public char[] getContents() {
-		String s = new String(getFileName());
-		if (jdtCompiler.loadedContent.containsKey(s)) {
-			return jdtCompiler.loadedContent.get(s);
+		if (jdtCompiler.loadedContent.containsKey(type.getQualifiedName())) {
+			return jdtCompiler.loadedContent.get(type.getQualifiedName());
 		}
 
-		InputStream stream = null;
-		if (jdtCompiler.factory != null && jdtCompiler.factory.CompilationUnit().getMap().containsKey(s)) {
-			stream = jdtCompiler.getCompilationUnitInputStream(s);
-		} else {
-			try {
-				stream = new FileInputStream(s);
-			} catch (FileNotFoundException e) {
-				Launcher.LOGGER.error(e.getMessage(), e);
-			}
-		}
-
-		if (stream == null) {
-			return super.getContents();
-		}
-
-		try {
-			char[] content = IOUtils.toCharArray(stream);
-			this.jdtCompiler.loadedContent.put(s, content);
-			return content;
-		} catch (Exception e) {
-			Launcher.LOGGER.error(e.getMessage(), e);
-		}
+		DefaultJavaPrettyPrinter printer = new DefaultJavaPrettyPrinter(type.getFactory().getEnvironment());
+		List<CtType<?>> types = new ArrayList<>();
+		types.add(type);
+		printer.calculate(type.getPosition().getCompilationUnit(), types);
 
-		return super.getContents();
+		String result = printer.getResult();
+		char[] content = result.toCharArray();
+		this.jdtCompiler.loadedContent.put(type.getQualifiedName(), content);
+		return content;
 	}
 
 }
diff --git a/src/main/java/spoon/support/compiler/jdt/JDTBatchCompiler.java b/src/main/java/spoon/support/compiler/jdt/JDTBatchCompiler.java
index bb4995bc4..ca8a606e4 100644
--- a/src/main/java/spoon/support/compiler/jdt/JDTBatchCompiler.java
+++ b/src/main/java/spoon/support/compiler/jdt/JDTBatchCompiler.java
@@ -32,13 +32,8 @@ import org.eclipse.jdt.internal.core.util.CommentRecorderParser;
 
 import spoon.Launcher;
 import spoon.compiler.SpoonFile;
-import spoon.reflect.declaration.CtPackage;
 import spoon.reflect.declaration.CtType;
-import spoon.reflect.visitor.DefaultJavaPrettyPrinter;
 
-import java.io.File;
-import java.io.FileWriter;
-import java.io.IOException;
 import java.io.OutputStream;
 import java.io.PrintWriter;
 import java.util.ArrayList;
@@ -103,13 +98,9 @@ class JDTBatchCompiler extends org.eclipse.jdt.internal.compiler.batch.Main {
 		}
 		if (useFactory) {
 			List<CompilationUnit> unitList = new ArrayList<>();
-			for (CompilationUnit unit : units) {
-				addExistingJavaFile(unitList, unit);
-			}
 			for (CtType<?> ctType : jdtCompiler.getFactory().Type().getAll()) {
-				// no valid position, probably built with the intercession API
-				if (ctType.getPosition() == null || ctType.getPosition().getFile() == null) {
-					addVirtualJavaFile(unitList, ctType);
+				if (ctType.isTopLevel()) {
+					unitList.add(new CompilationUnitWrapper(this.jdtCompiler, ctType));
 				}
 			}
 			units = unitList.toArray(new CompilationUnit[unitList.size()]);
@@ -117,51 +108,6 @@ class JDTBatchCompiler extends org.eclipse.jdt.internal.compiler.batch.Main {
 		return units;
 	}
 
-	private void addExistingJavaFile(List<CompilationUnit> unitList, CompilationUnit unit) {
-		unitList.add(new CompilationUnitWrapper(this.jdtCompiler, unit));
-	}
-
-	private void addVirtualJavaFile(List<CompilationUnit> unitList, CtType<?> ctType) {
-		if (ctType.getPosition() != null && ctType.getPosition().getFile() != null) {
-			throw new IllegalArgumentException("are you sure the type is virtual?");
-		}
-		CtPackage pack = ctType.getPackage();
-		File directory = jdtCompiler.getSourceOutputDirectory();
-
-		// create package directory
-		File packageDir;
-		if (pack.isUnnamedPackage()) {
-			packageDir = new File(directory.getAbsolutePath());
-		} else {
-			packageDir = new File(directory.getAbsolutePath() + File.separatorChar + pack.getQualifiedName().replace('.', File.separatorChar));
-		}
-		if (!packageDir.exists()) {
-			if (!packageDir.mkdirs()) {
-				throw new RuntimeException("Error creating output directory");
-			}
-		}
-
-		// print type
-		File file = new File(packageDir.getAbsolutePath() + File.separatorChar + ctType.getSimpleName() + DefaultJavaPrettyPrinter.JAVA_FILE_EXTENSION);
-		FileWriter writer = null;
-		try {
-			writer = new FileWriter(file);
-			writer.write(ctType.toString());
-		} catch (IOException e) {
-			throw new RuntimeException("Error during writing the virtual java file.");
-		} finally {
-			if (writer != null) {
-				try {
-					writer.close();
-				} catch (IOException e) {
-					throw new RuntimeException("Error during writing the virtual java file.");
-				}
-			}
-		}
-
-		addExistingJavaFile(unitList, new CompilationUnit(null, file.getAbsolutePath(), "UTF-8"));
-	}
-
 	public CompilationUnit[] getCompilationUnits(List<SpoonFile> files) {
 		Set<String> fileNames = new HashSet<>();
 		List<SpoonFile> virtualFiles = new ArrayList<>();
diff --git a/src/test/java/spoon/support/compiler/jdt/JDTBatchCompilerTest.java b/src/test/java/spoon/support/compiler/jdt/JDTBatchCompilerTest.java
index 277cab56e..e271f9ddc 100644
--- a/src/test/java/spoon/support/compiler/jdt/JDTBatchCompilerTest.java
+++ b/src/test/java/spoon/support/compiler/jdt/JDTBatchCompilerTest.java
@@ -19,6 +19,6 @@ public class JDTBatchCompilerTest {
 
 		launcher.getFactory().Class().create("spoon.Test");
 		assertTrue(launcher.getModelBuilder().compile());
-		assertTrue(new File("./target/binaries/Test.class").exists());
+		assertTrue(new File("./target/binaries/spoon/Test.class").exists());
 	}
 }
diff --git a/src/test/java/spoon/test/compilation/CompilationTest.java b/src/test/java/spoon/test/compilation/CompilationTest.java
new file mode 100644
index 000000000..e09104aa1
--- /dev/null
+++ b/src/test/java/spoon/test/compilation/CompilationTest.java
@@ -0,0 +1,70 @@
+package spoon.test.compilation;
+
+import org.junit.Assert;
+import org.junit.Test;
+import spoon.Launcher;
+import spoon.reflect.code.BinaryOperatorKind;
+import spoon.reflect.code.CtBinaryOperator;
+import spoon.reflect.code.CtBlock;
+import spoon.reflect.code.CtReturn;
+import spoon.reflect.declaration.CtClass;
+import spoon.reflect.declaration.CtMethod;
+import spoon.reflect.declaration.ModifierKind;
+import spoon.reflect.factory.CodeFactory;
+import spoon.reflect.factory.CoreFactory;
+import spoon.reflect.factory.Factory;
+
+import java.io.File;
+import java.lang.reflect.Method;
+import java.net.URL;
+import java.net.URLClassLoader;
+
+public class CompilationTest {
+
+	@Test
+	public void compileTest() throws Exception {
+		final Launcher launcher = new Launcher();
+		launcher.addInputResource("./src/test/resources/noclasspath/Simple.java");
+		File outputBinDirectory = new File("./target/class-simple");
+		if (!outputBinDirectory.exists()) {
+			outputBinDirectory.mkdirs();
+		}
+		launcher.setBinaryOutputDirectory(outputBinDirectory);
+		launcher.getEnvironment().setShouldCompile(true);
+		launcher.buildModel();
+
+		Factory factory = launcher.getFactory();
+		CoreFactory core = factory.Core();
+		CodeFactory code = factory.Code();
+
+		CtClass simple = factory.Class().get("Simple");
+
+		CtMethod method = core.createMethod();
+		method.addModifier(ModifierKind.PUBLIC);
+		method.setType(factory.Type().integerPrimitiveType());
+		method.setSimpleName("m");
+
+		CtBlock block = core.createBlock();
+		CtReturn aReturn = core.createReturn();
+
+		CtBinaryOperator binaryOperator = code.createBinaryOperator(
+						code.createLiteral(10),
+						code.createLiteral(32),
+						BinaryOperatorKind.PLUS);
+		aReturn.setReturnedExpression(binaryOperator);
+
+		// return 10 + 32;
+		block.addStatement(aReturn);
+		method.setBody(block);
+
+		simple.addMethod(method);
+
+		launcher.getModelBuilder().compile();
+
+		final URLClassLoader urlClassLoader = new URLClassLoader(new URL[] { outputBinDirectory.toURL() });
+
+		Class<?> aClass = urlClassLoader.loadClass("Simple");
+		Method m = aClass.getMethod("m");
+		Assert.assertEquals(42, m.invoke(aClass.newInstance()));
+	}
+}
diff --git a/src/test/resources/noclasspath/Simple.java b/src/test/resources/noclasspath/Simple.java
new file mode 100644
index 000000000..9ec9d5856
--- /dev/null
+++ b/src/test/resources/noclasspath/Simple.java
@@ -0,0 +1,15 @@
+class SkipException extends Exception {
+	private static final long serialVersionUID = 1L;
+
+	Object skipped;
+
+	SkipException(Object e) {
+		super("skipping " + e.toString());
+		skipped = e;
+	}
+
+}
+
+public class Simple {
+
+}
\ No newline at end of file
