{"url":"https://api.github.com/repos/eslint/eslint/issues/10125","repository_url":"https://api.github.com/repos/eslint/eslint","labels_url":"https://api.github.com/repos/eslint/eslint/issues/10125/labels{/name}","comments_url":"https://api.github.com/repos/eslint/eslint/issues/10125/comments","events_url":"https://api.github.com/repos/eslint/eslint/issues/10125/events","html_url":"https://github.com/eslint/eslint/issues/10125","id":308310338,"node_id":"MDU6SXNzdWUzMDgzMTAzMzg=","number":10125,"title":"Declaring shareable configs and plugins in package.json is unreliable","user":{"login":"not-an-aardvark","id":11638619,"node_id":"MDQ6VXNlcjExNjM4NjE5","avatar_url":"https://avatars.githubusercontent.com/u/11638619?v=4","gravatar_id":"","url":"https://api.github.com/users/not-an-aardvark","html_url":"https://github.com/not-an-aardvark","followers_url":"https://api.github.com/users/not-an-aardvark/followers","following_url":"https://api.github.com/users/not-an-aardvark/following{/other_user}","gists_url":"https://api.github.com/users/not-an-aardvark/gists{/gist_id}","starred_url":"https://api.github.com/users/not-an-aardvark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/not-an-aardvark/subscriptions","organizations_url":"https://api.github.com/users/not-an-aardvark/orgs","repos_url":"https://api.github.com/users/not-an-aardvark/repos","events_url":"https://api.github.com/users/not-an-aardvark/events{/privacy}","received_events_url":"https://api.github.com/users/not-an-aardvark/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":45711352,"node_id":"MDU6TGFiZWw0NTcxMTM1Mg==","url":"https://api.github.com/repos/eslint/eslint/labels/enhancement","name":"enhancement","color":"84b6eb","default":true,"description":"This change enhances an existing feature of ESLint"},{"id":82922548,"node_id":"MDU6TGFiZWw4MjkyMjU0OA==","url":"https://api.github.com/repos/eslint/eslint/labels/core","name":"core","color":"c7def8","default":false,"description":"Relates to ESLint's core APIs and features"},{"id":131106229,"node_id":"MDU6TGFiZWwxMzExMDYyMjk=","url":"https://api.github.com/repos/eslint/eslint/labels/accepted","name":"accepted","color":"0052cc","default":false,"description":"There is consensus among the team that this change meets the criteria for inclusion"},{"id":185518888,"node_id":"MDU6TGFiZWwxODU1MTg4ODg=","url":"https://api.github.com/repos/eslint/eslint/labels/breaking","name":"breaking","color":"e11d21","default":false,"description":"This change is backwards-incompatible"},{"id":829215248,"node_id":"MDU6TGFiZWw4MjkyMTUyNDg=","url":"https://api.github.com/repos/eslint/eslint/labels/archived%20due%20to%20age","name":"archived due to age","color":"eeeeee","default":false,"description":"This issue has been archived; please open a new issue for any further discussion"}],"state":"closed","locked":true,"assignee":{"login":"not-an-aardvark","id":11638619,"node_id":"MDQ6VXNlcjExNjM4NjE5","avatar_url":"https://avatars.githubusercontent.com/u/11638619?v=4","gravatar_id":"","url":"https://api.github.com/users/not-an-aardvark","html_url":"https://github.com/not-an-aardvark","followers_url":"https://api.github.com/users/not-an-aardvark/followers","following_url":"https://api.github.com/users/not-an-aardvark/following{/other_user}","gists_url":"https://api.github.com/users/not-an-aardvark/gists{/gist_id}","starred_url":"https://api.github.com/users/not-an-aardvark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/not-an-aardvark/subscriptions","organizations_url":"https://api.github.com/users/not-an-aardvark/orgs","repos_url":"https://api.github.com/users/not-an-aardvark/repos","events_url":"https://api.github.com/users/not-an-aardvark/events{/privacy}","received_events_url":"https://api.github.com/users/not-an-aardvark/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"not-an-aardvark","id":11638619,"node_id":"MDQ6VXNlcjExNjM4NjE5","avatar_url":"https://avatars.githubusercontent.com/u/11638619?v=4","gravatar_id":"","url":"https://api.github.com/users/not-an-aardvark","html_url":"https://github.com/not-an-aardvark","followers_url":"https://api.github.com/users/not-an-aardvark/followers","following_url":"https://api.github.com/users/not-an-aardvark/following{/other_user}","gists_url":"https://api.github.com/users/not-an-aardvark/gists{/gist_id}","starred_url":"https://api.github.com/users/not-an-aardvark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/not-an-aardvark/subscriptions","organizations_url":"https://api.github.com/users/not-an-aardvark/orgs","repos_url":"https://api.github.com/users/not-an-aardvark/repos","events_url":"https://api.github.com/users/not-an-aardvark/events{/privacy}","received_events_url":"https://api.github.com/users/not-an-aardvark/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":16,"created_at":"2018-03-25T00:16:38Z","updated_at":"2019-10-02T22:18:28Z","closed_at":"2019-04-04T20:18:24Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"As of ESLint v4.19.1, all shareable configs and plugins are loaded from the location of the `eslint` package. This behavior is clearly documented, and we advise users that if they want their config/plugin packages to be loaded, they should ensure that the packages are placed where `eslint` can find them.\r\n\r\nHowever, there is a problem with this approach: package managers provide no way for users to ensure that the packages will be placed in a valid way. There are a few common practices that people use to load their configs/plugins, but all of them are actually relying on an implementation detail of a package manager rather than a well-defined behavior.\r\n\r\nFor example, in order to use a config that depends on \"eslint-config-foo\" and \"eslint-plugin-bar\", we recommend putting this in a `package.json` file:\r\n\r\n```json\r\n{\r\n  \"devDependencies\": {\r\n    \"eslint\": \"^4.19.2\",\r\n    \"eslint-config-foo\": \"1.0.0\",\r\n    \"eslint-plugin-bar\": \"1.0.0\"\r\n  }\r\n}\r\n```\r\n\r\nThis `package.json` file imposes a requirement on a package manager: the `eslint`, `eslint-config-foo`, and `eslint-config-bar` packages must be accessible from the root package. However, it does not impose any requirement that the packages are accessible from each other, which is actually what the user needs.\r\n\r\nIt happens to be the case that with the most common package management strategy, the packages are accessible from each other anyway, because the packages are laid out like this:\r\n\r\n```\r\n(my project root)/\r\n├── .eslintrc.json\r\n└── node_modules/\r\n    ├── eslint/\r\n    └── eslint-config-foo/\r\n    └── eslint-plugin-bar/\r\n```\r\n\r\nBut I want to stress that this is an implementation detail of package managers, and not a required behavior. As a result, some package management strategies arrange packages in a way that breaks ESLint. For example, `lerna` would sometimes arrange packages like this:\r\n\r\n```\r\n(monorepo root)/\r\n├── node_modules/\r\n|   ├── eslint/\r\n|   └── eslint-plugin-bar/\r\n└── packages/\r\n    ├── eslint-config-foo/\r\n    |   └── index.js\r\n    └── (my project root)/\r\n        ├── .eslintrc.json\r\n        ├── package.json\r\n        └── node_modules/\r\n            └── eslint-config-foo (symlink to (monorepo root)/packages/eslint-config-foo)\r\n```\r\n\r\nIn this example, `lerna` is fulfilling all of the requirements in `package.json`: `eslint`, `eslint-config-foo`, and `eslint-plugin-bar` are all reachable from `(my project root)/`. However, ESLint fails to run because `eslint-config-foo` is not reachable from `eslint`.\r\n\r\nIt should be noted that adding a `peerDependency` of `eslint` in a config/plugin doesn't help in this case. If `eslint-config-foo` has a `peerDependency` of `eslint`, this imposes a requirement that the same version of `eslint` is reachable from both the project root and from `eslint-config-foo`. However, there is no requrement that `eslint-config-foo` is reachable from `eslint`. In the package layout above, all `peerDependencies` would be satisfied, but `eslint` would still be broken.\r\n\r\nSimilarly, we recommend that shareable configs include all of their plugins as `peerDependencies`, but this is also unreliable, because it only imposes a requirement that the plugin is reachable from the config and the project root. It doesn't impose a requirement that the plugin is reachable from the `eslint` package.\r\n\r\n---\r\n\r\nTo summarize the problem, config file loading is generally fragile when using a package manager, because `eslint` has an unusual requirement about package layout and the user has no way to ensure that the requirement is satisfied. As a result, a lot of people end up getting confused about why `eslint` can't find a package, and while there are solutions that appear to work in most cases, the solutions break down when the user has an uncommon-but-valid package management workflow.\r\n\r\nI think the current plugin/config-loading system was designed when npm (specifically `npm<=2`) was the only prevalent package manager that people used for Node packages. As a result, the current system encourages a pattern with `peerDependencies` that happened to work well when using npm2, but actually relied on implementation details rather than a well-defined behavior. Now that it's common for people to use other package management strategies (such as `lerna` and yarn workspaces), I think it's important that we upgrade to be compliant with how packages are supposed to work, so that users can declare their dependencies robustly. \r\n\r\nWhen discussing this before, we've described it as a distinction between \"local\" and \"global\" installations, and we encourage users to install all packages \"locally\". However, I think this oversimplifies the issue because it assumes that everything will work fine if packages are installed locally. In fact, all of the packages in the examples above have packages installed \"locally\", but they still can cause ESLint to break.\r\n\r\nAfter going back and forth a few times, this problem has convinced me that we should fix the \"global versus local\" issue by resolving all config and plugin names from the location of the config file where they appear. This would make ESLint's behavior consistent with how modules generally work in Node when calling `require` -- the package that contains the module name is in charge of providing it as a dependency. This behavior also has other benefits of a well-designed module system (e.g. it's possible to have nested dependencies, so modules are encapsulated and there isn't a global namespace of module names).\r\n\r\n---\r\n\r\nI think the one major blocker for this change is that ESLint can't currently handle loading multiple plugins with the same name, because users need to be able to uniquely refer to a plugin when they configure its rules. With the current system, this can't occur because plugins need to be reachable from eslint in `node_modules`, which effectively guarantees a namespace without conflicts. (Unfortunately, this method of getting unique plugin names has significant downsides, e.g. it's not possible to load a plugin from a path because it could conflict with a name from `node_modules`.) This issue has also blocked #3458 and #6237.\r\n\r\nTo resolve it, I think we should investigate a solution involving plugin namespaces, (along the lines of https://github.com/eslint/eslint/issues/3458#issuecomment-266594020), where users can more precisely define a rule in a config if necessary, in order to avoid naming conflicts. In my opinion, this would be a much better solution than dumping plugins into a global namespace and making the user avoid conflicts at installation time.","closed_by":{"login":"not-an-aardvark","id":11638619,"node_id":"MDQ6VXNlcjExNjM4NjE5","avatar_url":"https://avatars.githubusercontent.com/u/11638619?v=4","gravatar_id":"","url":"https://api.github.com/users/not-an-aardvark","html_url":"https://github.com/not-an-aardvark","followers_url":"https://api.github.com/users/not-an-aardvark/followers","following_url":"https://api.github.com/users/not-an-aardvark/following{/other_user}","gists_url":"https://api.github.com/users/not-an-aardvark/gists{/gist_id}","starred_url":"https://api.github.com/users/not-an-aardvark/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/not-an-aardvark/subscriptions","organizations_url":"https://api.github.com/users/not-an-aardvark/orgs","repos_url":"https://api.github.com/users/not-an-aardvark/repos","events_url":"https://api.github.com/users/not-an-aardvark/events{/privacy}","received_events_url":"https://api.github.com/users/not-an-aardvark/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/eslint/eslint/issues/10125/reactions","total_count":26,"+1":23,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":3,"eyes":0},"timeline_url":"https://api.github.com/repos/eslint/eslint/issues/10125/timeline","performed_via_github_app":null,"state_reason":"completed"}