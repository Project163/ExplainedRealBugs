{"url":"https://api.github.com/repos/eslint/eslint/issues/16410","repository_url":"https://api.github.com/repos/eslint/eslint","labels_url":"https://api.github.com/repos/eslint/eslint/issues/16410/labels{/name}","comments_url":"https://api.github.com/repos/eslint/eslint/issues/16410/comments","events_url":"https://api.github.com/repos/eslint/eslint/issues/16410/events","html_url":"https://github.com/eslint/eslint/issues/16410","id":1405133760,"node_id":"I_kwDOAKjKDc5TwKPA","number":16410,"title":"Bug: `FlatESLint` `getRulesMetaForResults` fails on anonymous files when option `cwd` is set","user":{"login":"fasttime","id":6367844,"node_id":"MDQ6VXNlcjYzNjc4NDQ=","avatar_url":"https://avatars.githubusercontent.com/u/6367844?v=4","gravatar_id":"","url":"https://api.github.com/users/fasttime","html_url":"https://github.com/fasttime","followers_url":"https://api.github.com/users/fasttime/followers","following_url":"https://api.github.com/users/fasttime/following{/other_user}","gists_url":"https://api.github.com/users/fasttime/gists{/gist_id}","starred_url":"https://api.github.com/users/fasttime/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fasttime/subscriptions","organizations_url":"https://api.github.com/users/fasttime/orgs","repos_url":"https://api.github.com/users/fasttime/repos","events_url":"https://api.github.com/users/fasttime/events{/privacy}","received_events_url":"https://api.github.com/users/fasttime/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":45711350,"node_id":"MDU6TGFiZWw0NTcxMTM1MA==","url":"https://api.github.com/repos/eslint/eslint/labels/bug","name":"bug","color":"fc2929","default":true,"description":"ESLint is working incorrectly"},{"id":82922548,"node_id":"MDU6TGFiZWw4MjkyMjU0OA==","url":"https://api.github.com/repos/eslint/eslint/labels/core","name":"core","color":"c7def8","default":false,"description":"Relates to ESLint's core APIs and features"},{"id":131106229,"node_id":"MDU6TGFiZWwxMzExMDYyMjk=","url":"https://api.github.com/repos/eslint/eslint/labels/accepted","name":"accepted","color":"0052cc","default":false,"description":"There is consensus among the team that this change meets the criteria for inclusion"},{"id":829215248,"node_id":"MDU6TGFiZWw4MjkyMTUyNDg=","url":"https://api.github.com/repos/eslint/eslint/labels/archived%20due%20to%20age","name":"archived due to age","color":"eeeeee","default":false,"description":"This issue has been archived; please open a new issue for any further discussion"},{"id":2786823532,"node_id":"MDU6TGFiZWwyNzg2ODIzNTMy","url":"https://api.github.com/repos/eslint/eslint/labels/repro:yes","name":"repro:yes","color":"7A14E9","default":false,"description":"Issues with a reproducible example"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2022-10-11T19:35:38Z","updated_at":"2023-04-30T19:06:44Z","closed_at":"2022-10-31T18:52:12Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Environment\n\nNode version: v18.10.0\r\nnpm version: v8.19.2\r\nLocal ESLint version: v8.25.0 (Currently used)\r\nGlobal ESLint version: Not found\r\nOperating System: darwin 21.6.0\n\n### What parser are you using?\n\nDefault (Espree)\n\n### What did you do?\n\nUsing `FlatESLint`, the method `getRulesMetaForResults` thows an error for certain values of the option `cwd` when passed a result of an anonymous file. This happens whenever `cwd` is set to a subdirectory of the current directory.\r\n\r\nThe following repro shows the problem.\r\n\r\n```js\r\nimport { join } from 'path';\r\n\r\nconst { default: { FlatESLint } } = await import('eslint/use-at-your-own-risk');\r\n\r\nconst cwd = join(process.cwd(), 'test'); // subdir 'test' doesn't need to exist for this repro.\r\nconst eslint = new FlatESLint({\r\n    cwd,\r\n    overrideConfig: { rules: { 'no-undef': 'warn' } },\r\n    overrideConfigFile: true,\r\n});\r\nconst results = await eslint.lintText('foo()');\r\neslint.getRulesMetaForResults(results); // throws TypeError\r\n```\n\n### What did you expect to happen?\n\nCalling `getRulesMetaForResults` with the result of an anonymous file should not throw an error, regardless of the engine's `cwd`.\n\n### What actually happened?\n\nThe above repro fails with an error like this:\r\n\r\n<pre>\r\n.../node_modules/eslint/lib/config/flat-config-helpers.js:54\r\n    const plugin = config.plugins && config.plugins[pluginName];\r\n                          ^\r\n\r\nTypeError: Cannot read properties of undefined (reading 'plugins')\r\n    at getRuleFromConfig (.../node_modules/eslint/lib/config/flat-config-helpers.js:54:27)\r\n    at FlatESLint.getRulesMetaForResults (.../node_modules/eslint/lib/eslint/flat-eslint.js:703:30)\r\n    at file://.../example.mjs:12:8\r\n</pre>\r\n\n\n### Participation\n\n- [X] I am willing to submit a pull request for this issue.\n\n### Additional comments\n\nWhat strikes me in the implementation are the different values used to call `configs.getConfig` in the case of an anonymous file: `lintText` calls `configs.getConfig` with a full path like `${cwd}/__placeholder__.js`\r\n\r\nhttps://github.com/eslint/eslint/blob/173e82040895ad53b2d9940bfb3fb67a0478f00b/lib/eslint/flat-eslint.js#L956\r\n\r\nwhereas `getRulesMetaForResults` ends up calling `configs.getConfig(\"__placeholder__.js\")`\r\n\r\nhttps://github.com/eslint/eslint/blob/173e82040895ad53b2d9940bfb3fb67a0478f00b/lib/eslint/flat-eslint.js#L689-L699\r\n\r\nThen it finds no config and it fails.\r\n\r\nAnother issue related to this is the unhelpful message of the `TypeError`.\r\nWhen `getRulesMetaForResults` finds no matching config, it could simply tell the user that the results were not created from the current instance of ESLint (not the case here, but still).\r\nThe error message is already there, but it is currently only used in a more limited edge case:\r\n\r\nhttps://github.com/eslint/eslint/blob/173e82040895ad53b2d9940bfb3fb67a0478f00b/lib/eslint/flat-eslint.js#L684\r\n","closed_by":{"login":"nzakas","id":38546,"node_id":"MDQ6VXNlcjM4NTQ2","avatar_url":"https://avatars.githubusercontent.com/u/38546?v=4","gravatar_id":"","url":"https://api.github.com/users/nzakas","html_url":"https://github.com/nzakas","followers_url":"https://api.github.com/users/nzakas/followers","following_url":"https://api.github.com/users/nzakas/following{/other_user}","gists_url":"https://api.github.com/users/nzakas/gists{/gist_id}","starred_url":"https://api.github.com/users/nzakas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nzakas/subscriptions","organizations_url":"https://api.github.com/users/nzakas/orgs","repos_url":"https://api.github.com/users/nzakas/repos","events_url":"https://api.github.com/users/nzakas/events{/privacy}","received_events_url":"https://api.github.com/users/nzakas/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/eslint/eslint/issues/16410/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/eslint/eslint/issues/16410/timeline","performed_via_github_app":null,"state_reason":"completed"}