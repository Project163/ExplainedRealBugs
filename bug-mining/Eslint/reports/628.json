{"url":"https://api.github.com/repos/eslint/eslint/issues/18007","repository_url":"https://api.github.com/repos/eslint/eslint","labels_url":"https://api.github.com/repos/eslint/eslint/issues/18007/labels{/name}","comments_url":"https://api.github.com/repos/eslint/eslint/issues/18007/comments","events_url":"https://api.github.com/repos/eslint/eslint/issues/18007/events","html_url":"https://github.com/eslint/eslint/issues/18007","id":2088100852,"node_id":"I_kwDOAKjKDc58deP0","number":18007,"title":"Change Request: Rule Tester: improve testing of multi-pass fixes","user":{"login":"bradzacher","id":7462525,"node_id":"MDQ6VXNlcjc0NjI1MjU=","avatar_url":"https://avatars.githubusercontent.com/u/7462525?v=4","gravatar_id":"","url":"https://api.github.com/users/bradzacher","html_url":"https://github.com/bradzacher","followers_url":"https://api.github.com/users/bradzacher/followers","following_url":"https://api.github.com/users/bradzacher/following{/other_user}","gists_url":"https://api.github.com/users/bradzacher/gists{/gist_id}","starred_url":"https://api.github.com/users/bradzacher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bradzacher/subscriptions","organizations_url":"https://api.github.com/users/bradzacher/orgs","repos_url":"https://api.github.com/users/bradzacher/repos","events_url":"https://api.github.com/users/bradzacher/events{/privacy}","received_events_url":"https://api.github.com/users/bradzacher/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":45711352,"node_id":"MDU6TGFiZWw0NTcxMTM1Mg==","url":"https://api.github.com/repos/eslint/eslint/labels/enhancement","name":"enhancement","color":"84b6eb","default":true,"description":"This change enhances an existing feature of ESLint"},{"id":64004798,"node_id":"MDU6TGFiZWw2NDAwNDc5OA==","url":"https://api.github.com/repos/eslint/eslint/labels/documentation","name":"documentation","color":"5319e7","default":true,"description":"Relates to ESLint's documentation"},{"id":82922548,"node_id":"MDU6TGFiZWw4MjkyMjU0OA==","url":"https://api.github.com/repos/eslint/eslint/labels/core","name":"core","color":"c7def8","default":false,"description":"Relates to ESLint's core APIs and features"},{"id":131106229,"node_id":"MDU6TGFiZWwxMzExMDYyMjk=","url":"https://api.github.com/repos/eslint/eslint/labels/accepted","name":"accepted","color":"0052cc","default":false,"description":"There is consensus among the team that this change meets the criteria for inclusion"},{"id":829215248,"node_id":"MDU6TGFiZWw4MjkyMTUyNDg=","url":"https://api.github.com/repos/eslint/eslint/labels/archived%20due%20to%20age","name":"archived due to age","color":"eeeeee","default":false,"description":"This issue has been archived; please open a new issue for any further discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2024-01-18T11:35:36Z","updated_at":"2024-09-04T14:14:05Z","closed_at":"2024-03-07T20:41:20Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### ESLint version\r\n\r\nN/A\r\n\r\n### What problem do you want to solve?\r\n\r\nCurrently the rule tester does exactly one fix pass over the code. It's worth noting that this works differently to `Linter.verifyAndFix` which does up to 10 fix passes on the code.\r\n\r\nThis difference is confusing for plugin developers because it's possible and in some cases easy to write a test case for a rule where two reports have overlapping fixes.\r\n\r\nThis causes an issue because the `output` reported by the rule tester does not match the output you would get if you were to fix the code from the CLI. The confusing part is that this behaviour is opaque from the perspective of a consumer of the tester - leading to many people not knowing that their test case isn't actually what they expect - i.e. developers will often just correct the output to what the test asks for without realising what it means.\r\n\r\nNote: It is [documented on the rule tester's docs](https://eslint.org/docs/latest/integrate/nodejs-api#ruletester):\r\n\r\n> Asserts the output that will be produced when using this rule for a single pass of autofixing (e.g. with the --fix command line flag)\r\n\r\nHowever this is kind of vague - eg what does it mean to be a single pass? how does that compare to normal linting from the CLI? etc. Additionally this sentence is fairly buried. The journey to get there is:\r\n1) Custom Rules docs (https://eslint.org/docs/latest/extend/custom-rules)\r\n2) Scroll to the almost bottom to \"Rule Unit Tests\" (https://eslint.org/docs/latest/extend/custom-rules#rule-unit-tests)\r\n3) Click the link taking you to the Rule Tester API doc (https://eslint.org/docs/latest/integrate/nodejs-api#ruletester)\r\n4) Scroll to the `output` property.\r\n5) You've found the sentence\r\n\r\nTBH I doubt most newbies go past step (1) when setting up a new plugin!\r\n\r\n---\r\n\r\nAs an example for @typescript-eslint we have an extension for `space-infix-ops` which applies the rule's logic to type ops. One of our tests looks like this:\r\n```js\r\n    {\r\n      code: `\r\n        type Test=|string|(((() => void)))|string;\r\n      `,\r\n      output: `\r\n        type Test = |string | (((() => void))) | string;\r\n      `,\r\n      errors: [\r\n        {\r\n          messageId: 'missingSpace',\r\n          column: 18,\r\n          line: 2,\r\n        },\r\n        {\r\n          messageId: 'missingSpace',\r\n          column: 19,\r\n          line: 2,\r\n        },\r\n        {\r\n          messageId: 'missingSpace',\r\n          column: 26,\r\n          line: 2,\r\n        },\r\n        {\r\n          messageId: 'missingSpace',\r\n          column: 43,\r\n          line: 2,\r\n        },\r\n      ],\r\n    },\r\n``` \r\n\r\nTo the untrained eye - it's hard to tell that the output isn't actually correct. If you were to run the same code through the CLI it would instead fix to `type Test = | string | (((() => void))) | string;`  - Note the extra space after the first `|`. ([playground](https://typescript-eslint.io/play/#ts=5.3.3&fileType=.tsx&code=C4TwDgpgBAKhDOwC8AfRAnAlgOwOYoAoiCBKKJAPigDcB7TAExObWCzwG4BYAKCA&eslintrc=N4KABGBEBOCuA2BTAzpAXGUEKQAIBcBPABxQGNoBLY-AWhXkoDt8B6ZYgQzMVuYDNKAD1oB7YqgyRE0aKOiRwYAL4hVQA&tsconfig=N4KABGBEDGD2C2AHAlgGwKYCcDyiAuysAdgM6QBcYoEEkJemy0eAcgK6qoDCAFutAGsylBm3TgwAXxCSgA&tokens=false))\r\n\r\n---\r\n\r\nIn one particular case within @typescript-eslint, we actually wanted to test the multi-pass fix behaviour so that we could validate that our fixers would \"layer\" correctly and be applied correctly for some more complex (but common) fix cases. However there's currently no way to do this with the rule tester, and so we had to resort to building our own test on top of `Linter`:\r\n\r\nhttps://github.com/typescript-eslint/typescript-eslint/blob/01556f50376b87eff21c42d121b627e3a6f003f0/packages/eslint-plugin/tests/rules/array-type.test.ts#L1924-L2159\r\n\r\n\r\n### What do you think is the correct solution?\r\n\r\nI can think of a few solutions (not mutually exclusive):\r\n1) Clearly document this limitation with an explanation of what it means and how it compares to CLI linting.\r\n2) Allow rules to opt-in to multi-pass fixing for specific test cases\r\n   - One idea is a simple boolean flag that just turns on multi-pass fixing for that specific case - eg `multipassFixing: true`.\r\n   - Another might be that a rule can specify an array for `output` which declares the code after each fix pass - allowing a test to declare (a) how many passes should occur, (b) how the fixes should look, and (c) the end state of the code\r\n3) Error by default if a test case produces code that requires multiple passes to fix.\r\n    - This would serve as a hint to either split the case up or enable the above flag (if added).\r\n    - It would prevent test cases that aren't properly testing their code paths.\r\n\r\n\r\n### Participation\r\n\r\n- [ ] I am willing to submit a pull request for this change.\r\n\r\n### Additional comments\r\n\r\nExample user issue: https://github.com/typescript-eslint/typescript-eslint/issues/8251","closed_by":{"login":"mdjermanovic","id":44349756,"node_id":"MDQ6VXNlcjQ0MzQ5NzU2","avatar_url":"https://avatars.githubusercontent.com/u/44349756?v=4","gravatar_id":"","url":"https://api.github.com/users/mdjermanovic","html_url":"https://github.com/mdjermanovic","followers_url":"https://api.github.com/users/mdjermanovic/followers","following_url":"https://api.github.com/users/mdjermanovic/following{/other_user}","gists_url":"https://api.github.com/users/mdjermanovic/gists{/gist_id}","starred_url":"https://api.github.com/users/mdjermanovic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdjermanovic/subscriptions","organizations_url":"https://api.github.com/users/mdjermanovic/orgs","repos_url":"https://api.github.com/users/mdjermanovic/repos","events_url":"https://api.github.com/users/mdjermanovic/events{/privacy}","received_events_url":"https://api.github.com/users/mdjermanovic/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/eslint/eslint/issues/18007/reactions","total_count":3,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/eslint/eslint/issues/18007/timeline","performed_via_github_app":null,"state_reason":"completed"}