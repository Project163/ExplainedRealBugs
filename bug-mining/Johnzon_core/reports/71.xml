<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:02:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[JOHNZON-335] JsonGeneratorImpl.prepareValue throws JsonGenerationException when JsonGenerator.write is called from a nested JsonbSerializer</title>
                <link>https://issues.apache.org/jira/browse/JOHNZON-335</link>
                <project id="12315523" key="JOHNZON">Johnzon</project>
                    <description>&lt;p&gt;When using two JsonbSerializers registered in JsonbConfig, with one serializer - the &lt;em&gt;outer serializer&lt;/em&gt; - calling SerializationContext.serialize on an object annotated to be serialized with the other serializer - the &lt;em&gt;inner serializer&lt;/em&gt; - Johnzon fails to write the expected json and throws a JsonGenerationException. This seems to happen upon any JsonGenerator.write method called inside the &lt;em&gt;inner serializer&lt;/em&gt;.&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;OuterTestSerializer &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; JsonbSerializer&amp;lt;OuterTestModel&amp;gt; {
		@Override
		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void serialize(OuterTestModel obj, JsonGenerator generator, SerializationContext ctx) {
			generator.writeStartObject();
			generator.write(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;generated in &lt;span class=&quot;code-keyword&quot;&gt;outer&lt;/span&gt; serializer&quot;&lt;/span&gt;);
			ctx.serialize(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt;&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InnerTestModel(), generator);
			generator.writeEnd();
		}
	}

	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;InnerTestSerializer &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; JsonbSerializer&amp;lt;InnerTestModel&amp;gt; {
		@Override
		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void serialize(InnerTestModel obj, JsonGenerator generator, SerializationContext ctx) {
			generator.writeStartObject();
			generator.write(&lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;generated in &lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt; serializer&quot;&lt;/span&gt;);
			generator.writeEnd();
		}
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Below is the formatted version of the json that&apos;s expected&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-json&quot;&gt;
{
    &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;generated &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; outer serializer&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;inner&quot;&lt;/span&gt;: 
    {
        &lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;generated &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; inner serializer&quot;&lt;/span&gt;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However Johnzon throws this expection&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
javax.json.stream.JsonGenerationException: state IN_OBJECT does not accept a value
	at org.apache.johnzon.core.JsonGeneratorImpl.prepareValue(JsonGeneratorImpl.java:643)
	at org.apache.johnzon.core.JsonGeneratorImpl.writeStartObject(JsonGeneratorImpl.java:137)
	at org.apache.johnzon.mapper.DynamicMappingGenerator$InObjectOrPrimitiveJsonGenerator.writeStartObject(DynamicMappingGenerator.java:109)
	at org.apache.johnzon.mapper.DynamicMappingGenerator$InObjectOrPrimitiveJsonGenerator.ensureStart(DynamicMappingGenerator.java:99)
	at org.apache.johnzon.mapper.DynamicMappingGenerator$InObjectOrPrimitiveJsonGenerator.writeStartObject(DynamicMappingGenerator.java:106)
	at usa.kerby.tk.jhal.JohnzonNestedSerializerTest$InnerTestSerializer.serialize(JohnzonNestedSerializerTest.java:55)
	at usa.kerby.tk.jhal.JohnzonNestedSerializerTest$InnerTestSerializer.serialize(JohnzonNestedSerializerTest.java:52)
	at org.apache.johnzon.jsonb.JohnzonBuilder.lambda$&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;$24(JohnzonBuilder.java:313)
	at org.apache.johnzon.mapper.MappingGeneratorImpl.writeObject(MappingGeneratorImpl.java:97)
	at org.apache.johnzon.mapper.DynamicMappingGenerator.writeObject(DynamicMappingGenerator.java:53)
	at org.apache.johnzon.jsonb.serializer.JohnzonSerializationContext.serialize(JohnzonSerializationContext.java:36)
	at usa.kerby.tk.jhal.JohnzonNestedSerializerTest$OuterTestSerializer.serialize(JohnzonNestedSerializerTest.java:46)
	at usa.kerby.tk.jhal.JohnzonNestedSerializerTest$OuterTestSerializer.serialize(JohnzonNestedSerializerTest.java:41)
	at org.apache.johnzon.jsonb.JohnzonBuilder.lambda$&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;$24(JohnzonBuilder.java:313)
	at org.apache.johnzon.mapper.MappingGeneratorImpl.doWriteObject(MappingGeneratorImpl.java:174)
	at org.apache.johnzon.mapper.Mapper.writeObject(Mapper.java:235)
	at org.apache.johnzon.mapper.Mapper.writeObjectWithGenerator(Mapper.java:208)
	at org.apache.johnzon.mapper.Mapper.writeObject(Mapper.java:203)
	at org.apache.johnzon.mapper.Mapper.writeObjectAsString(Mapper.java:252)
	at org.apache.johnzon.jsonb.JohnzonJsonb.toJson(JohnzonJsonb.java:268)
	at usa.kerby.tk.jhal.JohnzonNestedSerializerTest.testNestedSerializer(JohnzonNestedSerializerTest.java:28)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Tested against Yasson 1.0.8, Johnzon 1.2.9, and Johnzon 1.2.10. Yasson produces the expected JSON. Am I right in thinking this is a bug? &lt;/p&gt;</description>
                <environment></environment>
        <key id="13356590">JOHNZON-335</key>
            <summary>JsonGeneratorImpl.prepareValue throws JsonGenerationException when JsonGenerator.write is called from a nested JsonbSerializer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="TruantKernel">Trevor Kerby</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Feb 2021 21:59:16 +0000</created>
                <updated>Sun, 7 Feb 2021 09:54:22 +0000</updated>
                                            <version>1.2.9</version>
                    <version>1.2.10</version>
                                                    <component>JSON-B</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17278405" author="romain.manni-bucau" created="Wed, 3 Feb 2021 22:59:29 +0000"  >&lt;p&gt;Hi&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think so, can you try reversing both statements as in&#160;&lt;a href=&quot;https://github.com/apache/johnzon/blob/master/johnzon-jsonb/src/test/java/org/apache/johnzon/jsonb/SerializerTest.java#L493&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/johnzon/blob/master/johnzon-jsonb/src/test/java/org/apache/johnzon/jsonb/SerializerTest.java#L493&lt;/a&gt; as a workaroud?&lt;/p&gt;</comment>
                            <comment id="17278669" author="romain.manni-bucau" created="Thu, 4 Feb 2021 08:48:18 +0000"  >&lt;p&gt;Pushed a fix about it on master if you want to give it a try. It is not yet 100% perfect due to the ObjectWriter/Serializer differences but it should make your case working.&lt;/p&gt;</comment>
                            <comment id="17279120" author="truantkernel" created="Thu, 4 Feb 2021 19:59:19 +0000"  >&lt;p&gt;Hello Manni-Bucau&lt;/p&gt;

&lt;p&gt;Thank you for the quick responses and implementation of a work around - it&apos;s very much appreciated, along with all the other times I see your name while looking for solutions to TomEE related problems. I wasn&apos;t sure exactly what you meant by reversing the statements, but I tried flipping the order which I made the calls, and I tried out the more typical route of using annotations to drive the serialization, but I got the same exception, and I couldn&apos;t get the output that I&apos;m looking for, respectively. &lt;/p&gt;

&lt;p&gt;I see the test and it runs well on my end. Again, thank you - I&apos;m going to test it out with some code I wrote that depends on this feature. I do have a few questions if you don&apos;t mind:&lt;/p&gt;

&lt;p&gt;How do I build Johnzon from source? I seem to be missing some plugins that seem to require some authentication.&lt;br/&gt;
Secondly, how can I help contribute to this project?&lt;/p&gt;</comment>
                            <comment id="17279131" author="romain.manni-bucau" created="Thu, 4 Feb 2021 20:21:26 +0000"  >&lt;p&gt;Hello Trevor,&lt;/p&gt;

&lt;p&gt;Normally mvn &lt;span class=&quot;error&quot;&gt;&amp;#91;clean&amp;#93;&lt;/span&gt; install is sufficient to build and you can do PR on github on @apache/johnzon repository.&lt;/p&gt;</comment>
                            <comment id="17279185" author="truantkernel" created="Thu, 4 Feb 2021 21:37:15 +0000"  >&lt;p&gt;Thank you kindly! You&apos;re absolutely right. I had a misconfigured firewall blocking the download of those plugins, but it&apos;s resolved, I packaged the jars I needed, and it seems your workaround solves the problem my project was having with Johnzon. I&apos;ll work on familiarizing myself with the johnzon codebase so I can hopefully give back and contribute to the open source community.&lt;/p&gt;</comment>
                            <comment id="17279240" author="truantkernel" created="Fri, 5 Feb 2021 00:23:17 +0000"  >&lt;p&gt;This doesn&apos;t seem to affect my project so much, but I noticed that this fix works if classes to be serialized are annotated with `@JsonbTypeSerializer`, however it does not work when the serializers for those classes are registered with JsonbConfig. I guess this is because when the config is used, code that would have hit the&#160;SkipEnclosingWriteEnd related fix in MappingGeneratorImpl.doWriteObjectBody instead takes a different path in MappingGeneratorImpl.doWriteObject at &lt;a href=&quot;https://github.com/apache/johnzon/blob/master/johnzon-mapper/src/main/java/org/apache/johnzon/mapper/MappingGeneratorImpl.java#L169&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;L169&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17279421" author="romain.manni-bucau" created="Fri, 5 Feb 2021 07:25:29 +0000"  >&lt;p&gt;Yes, &lt;a href=&quot;https://github.com/apache/johnzon/blob/master/johnzon-mapper/src/main/java/org/apache/johnzon/mapper/MappingGeneratorImpl.java#L173&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/johnzon/blob/master/johnzon-mapper/src/main/java/org/apache/johnzon/mapper/MappingGeneratorImpl.java#L173&lt;/a&gt;&#160;likely needs the same fix and a test&lt;/p&gt;</comment>
                            <comment id="17280277" author="truantkernel" created="Sat, 6 Feb 2021 20:19:49 +0000"  >&lt;p&gt;I wrote a test and tried implementing your fix at that location without much success. I realized though that I misunderstood the problem a bit. The writeStartObject/writeEnd pairs in the InnerTestSerializer and OuterTestSerializer may be somewhat unrelated to the issue - I only included them there because that&apos;s what was necessary to get Yasson to play nice with the test. I say that because I noticed that if the testNestedSerializer test is copied into the master branch prior to your workaround commit from the other day, and those writeStartObject/writeEnd pairs are omitted from the test, then the test passes. The original test that I included on submission of this issue failed on Johnzon regardless of the existence of those writeStartObject/writeEnd pairs in the serializers because the serializers were registered with JsonbConfig - which represents the real issue.&lt;/p&gt;</comment>
                            <comment id="17280427" author="romain.manni-bucau" created="Sun, 7 Feb 2021 09:54:22 +0000"  >&lt;p&gt;Yes, johnzon enforces objects to be objects in current flavor, this is why the fix just skips writeStart/end when relevant.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The registration should lead to the same code at some point and i guess one fix can be to call the config to find the object writer when creating the class model instead of doing it at runtime (makes a lot of sense to me).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This way, annotation or config uses the same code.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If you need help, push a PR with a failling test, ill have a look next week.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13019948" name="JohnzonNestedSerializerTest.java" size="1948" author="TruantKernel" created="Wed, 3 Feb 2021 21:33:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 39 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0nbvk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>