<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:02:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[JOHNZON-216] JsonStreamParserImpl.readString throws ArrayIndexOutOfBoundsException when dealing with string that contains escape characters</title>
                <link>https://issues.apache.org/jira/browse/JOHNZON-216</link>
                <project id="12315523" key="JOHNZON">Johnzon</project>
                    <description>&lt;p&gt;There seems to be a bug within the JsonStreamParserImpl that is allowed in part by how it&#160;is configured within TomEE. Currently TomEE configures it with a maximum string length limit of 8192 bytes by default. It seems that&#160;escape characters (with backslash) do not properly count towards the total length when the string is validated, so it escapes validation. &lt;/p&gt;

&lt;p&gt;To replicate, put the attached file &quot;bad.json&quot; in your user directory and run this.&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void parseEscapeCharacters() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException  {
   File bad = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;user.dir&quot;&lt;/span&gt;)+&lt;span class=&quot;code-quote&quot;&gt;&quot;/bad.json&quot;&lt;/span&gt;);
   &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] badbytes = Files.readAllBytes(bad.toPath());
   &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; test =  &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;(badbytes, StandardCharsets.UTF_8);

   &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; len = 8192;
   BufferStrategy.BufferProvider&amp;lt;&lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;[]&amp;gt; bs = BufferStrategy.QUEUE.newCharProvider(len);
   InputStream stream = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayInputStream(test.getBytes(StandardCharsets.UTF_8));
   JsonStreamParserImpl impl = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JsonStreamParserImpl(stream, len, bs, bs, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
   &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (impl.hasNext())
      impl.next();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Results in&#160;&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.ArrayIndexOutOfBoundsException: 8192

at org.apache.johnzon.core.JsonStreamParserImpl.appendToCopyBuffer(JsonStreamParserImpl.java:158)
at org.apache.johnzon.core.JsonStreamParserImpl.readString(JsonStreamParserImpl.java:592)
at org.apache.johnzon.core.JsonStreamParserImpl.handleQuote(JsonStreamParserImpl.java:695)
at org.apache.johnzon.core.JsonStreamParserImpl.next(JsonStreamParserImpl.java:440)
at org.apache.johnzon.core.JsonStreamParserImpl.next(JsonStreamParserImpl.java:400)
at zzz.parseEscapeCharacters(zzz.java:818)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13241372">JOHNZON-216</key>
            <summary>JsonStreamParserImpl.readString throws ArrayIndexOutOfBoundsException when dealing with string that contains escape characters</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="struberg">Mark Struberg</assignee>
                                    <reporter username="kerickson">Kean Erickson</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 Jun 2019 01:26:51 +0000</created>
                <updated>Sat, 30 Apr 2022 11:55:51 +0000</updated>
                                            <version>1.1.12</version>
                                    <fixVersion>1.2.19</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17170487" author="kerickson" created="Tue, 4 Aug 2020 01:07:12 +0000"  >&lt;p&gt;Still an issue in johnzon version&#160;1.2.8&lt;/p&gt;</comment>
                            <comment id="17170598" author="romain.manni-bucau" created="Tue, 4 Aug 2020 06:57:19 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kerickson&quot; class=&quot;user-hover&quot; rel=&quot;kerickson&quot;&gt;kerickson&lt;/a&gt;, should be fixed on master where you would get &quot;Buffer too small for such a long string&quot; message.&lt;/p&gt;</comment>
                            <comment id="17271652" author="kerickson" created="Mon, 25 Jan 2021 20:13:04 +0000"  >&lt;p&gt;Hi Romain, this did address the issue of escape characters leading to unpredictable results, thank you for addressing that. It would be nice though if a more targetable exception than ArrayIndexOutOfBounds was thrown so that the messaging can be modified without a lot of extra code just to handle for this circumstance. Usually when I see this kind of exception my assumption is that there was a bug somewhere.&lt;/p&gt;</comment>
                            <comment id="17271941" author="romain.manni-bucau" created="Tue, 26 Jan 2021 07:51:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kerickson&quot; class=&quot;user-hover&quot; rel=&quot;kerickson&quot;&gt;kerickson&lt;/a&gt;&#160;guess we can catch it in the mapper root methods and wrap it in a MapperException but not sure you would handle it better (ending as a JsonbException in jsonb impl). Do you have a proposal?&lt;/p&gt;</comment>
                            <comment id="17272342" author="kerickson" created="Tue, 26 Jan 2021 18:57:49 +0000"  >&lt;p&gt;I wonder if the code in question could throw an exception with a name like ContentLengthException. That way we could catch it in a mapper and use our own messaging.&lt;/p&gt;</comment>
                            <comment id="17272793" author="romain.manni-bucau" created="Wed, 27 Jan 2021 11:40:54 +0000"  >&lt;p&gt;Im fine with that but we should also probably make sure it extends current exception probably for backward compat.&lt;/p&gt;

&lt;p&gt;Do you want to do a PR?&lt;/p&gt;</comment>
                            <comment id="17309110" author="kerickson" created="Fri, 26 Mar 2021 02:52:55 +0000"  >&lt;p&gt;Sure, I will see if I have time to arrange something coming up here.&lt;/p&gt;</comment>
                            <comment id="17451596" author="kerickson" created="Wed, 1 Dec 2021 08:10:20 +0000"  >&lt;p&gt;I have not had a chance to get around to the messaging changes, however with Romain&apos;s changes in Johnzon 1.2.14 or earlier, the issue with escape characters does seem to be fixed. Thanks Romain!&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://apache.googlesource.com/johnzon/+/62ed6949eb3e2053c6ea6720ef0125004f20b89a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://apache.googlesource.com/johnzon/+/62ed6949eb3e2053c6ea6720ef0125004f20b89a&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This ticket issue can just be regarding the improvement in messaging when unmarshalling a string that&apos;s larger than a lower character limit (like 8192), I will see if I can get around to that soon.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12972804" name="bad.json" size="16574" author="kerickson" created="Tue, 25 Jun 2019 01:27:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 49 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z042bc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>