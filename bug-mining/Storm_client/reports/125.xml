<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:46:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[STORM-3510] WorkerState.transferLocalBatch backpressure resend logic fix</title>
                <link>https://issues.apache.org/jira/browse/STORM-3510</link>
                <project id="12314820" key="STORM">Apache Storm</project>
                    <description>&lt;p&gt;WorkerState.transferLocalBatch uses an int lastOverflowCount to track the size of the overflow queue, and periodically resend the backpressure status to remote workers if the queue continues to grow.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The current implementation has two problems:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The single variable tracks the receive queue of every executor in the worker, meaning it will be overwritten as tuples are sent to different executors.&lt;/li&gt;
	&lt;li&gt;The variable is locally scoped, and so is not carried over between mini-batches.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This only comes in to effect when the overflow queue grows beyond 10000, which shouldn&apos;t happen unless a backpressure signal isn&apos;t received by an upstream worker, but if it does happen then a backpressure signal is going to be sent for every mini-batch processed.&#160; I do not know if this is the intended behaviour, but the way the code is written seems to indicate that it isn&apos;t.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I have thought of two redesigns to fix these problems and make the behaviour align with how one would interpret the code:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&#160;&lt;b&gt;Change the lastOverflowCount variable to a map of taskId to overflow count&lt;/b&gt; - This will retain the behaviour of resending the backpressure update every mini-batch once over the threshold, if that behaviour is intended.&#160; However, it will increase garbage by creating a new map every time WorkerState.transferLocalBatch is called by the NettyWorker thread.&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;Change the lastOverflowCount variable to a map of taskId to overflow count&lt;/b&gt; &lt;b&gt;and move it to the BackPressureTracker class&lt;/b&gt; - This will retain the counter between batches, and so only resend backpressure status every 10000 received tuples per task.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;My preference is for the second option, as if the intended behaviour is to resend every mini batch it should be rewritten so the intent is explicit from the code.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It is also possible that doing it the second way could run in to concurrency issues i didn&apos;t think of, but as far as i can tell the topology.worker.receiver.thread.count config option isn&apos;t used at all?&#160; If that&apos;s the case and there is only one NettyWorker thread per worker then it should be fine.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I have implemented both methods and attempted to benchmark them with &lt;a href=&quot;https://github.com/yahoo/storm-perf-test&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/yahoo/storm-perf-test&lt;/a&gt; but as i am running all workers on one machine i couldn&apos;t get it to the point that the relevant code was ever called.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13257666">STORM-3510</key>
            <summary>WorkerState.transferLocalBatch backpressure resend logic fix</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cjljohnson">Christopher Johnson</assignee>
                                    <reporter username="cjljohnson">Christopher Johnson</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 19 Sep 2019 13:05:33 +0000</created>
                <updated>Sun, 26 Jan 2025 09:28:39 +0000</updated>
                            <resolved>Tue, 1 Oct 2019 14:39:21 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.2.0</fixVersion>
                                    <component>storm-client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7200">2h</timespent>
                                <comments>
                            <comment id="16933387" author="cjljohnson" created="Thu, 19 Sep 2019 13:39:26 +0000"  >&lt;p&gt;My code for solution 2 is in this pull request:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/storm/pull/3131&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/storm/pull/3131&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16942024" author="srdo" created="Tue, 1 Oct 2019 14:39:21 +0000"  >&lt;p&gt;Thanks for the fix &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cjljohnson&quot; class=&quot;user-hover&quot; rel=&quot;cjljohnson&quot;&gt;cjljohnson&lt;/a&gt;, merged to master&lt;/p&gt;</comment>
                            <comment id="17920483" author="githubbot" created="Sun, 26 Jan 2025 09:28:39 +0000"  >&lt;p&gt;For your information, &lt;a href=&quot;https://issues.apache.org/jira/projects/STORM/issues/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;all STORM issues&lt;/a&gt;  have been transferred to Github: &lt;a href=&quot;https://github.com/apache/storm/issues/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/storm/issues/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here is the direct link to this issue in Github: &lt;a href=&quot;https://github.com/apache/storm/issues//7292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/storm/issues//7292&lt;/a&gt;&lt;br/&gt;
And here is the link to a search for related issues: &lt;a href=&quot;https://github.com/apache/storm/issues/?q=%22STORM-3510%22&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/storm/issues/?q=%22STORM-3510%22&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(Note: this is an automated bulk comment)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z06t80:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>