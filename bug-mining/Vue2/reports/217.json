{"url":"https://api.github.com/repos/vuejs/vue/issues/5851","repository_url":"https://api.github.com/repos/vuejs/vue","labels_url":"https://api.github.com/repos/vuejs/vue/issues/5851/labels{/name}","comments_url":"https://api.github.com/repos/vuejs/vue/issues/5851/comments","events_url":"https://api.github.com/repos/vuejs/vue/issues/5851/events","html_url":"https://github.com/vuejs/vue/issues/5851","id":234819091,"node_id":"MDU6SXNzdWUyMzQ4MTkwOTE=","number":5851,"title":"Memory leak (detached DOM tree) when patching vnodes","user":{"login":"bartsidee","id":521633,"node_id":"MDQ6VXNlcjUyMTYzMw==","avatar_url":"https://avatars.githubusercontent.com/u/521633?v=4","gravatar_id":"","url":"https://api.github.com/users/bartsidee","html_url":"https://github.com/bartsidee","followers_url":"https://api.github.com/users/bartsidee/followers","following_url":"https://api.github.com/users/bartsidee/following{/other_user}","gists_url":"https://api.github.com/users/bartsidee/gists{/gist_id}","starred_url":"https://api.github.com/users/bartsidee/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bartsidee/subscriptions","organizations_url":"https://api.github.com/users/bartsidee/orgs","repos_url":"https://api.github.com/users/bartsidee/repos","events_url":"https://api.github.com/users/bartsidee/events{/privacy}","received_events_url":"https://api.github.com/users/bartsidee/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2017-06-09T12:58:59Z","updated_at":"2017-06-09T14:01:55Z","closed_at":"2017-06-09T14:01:55Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Version\r\n2.3.4\r\n\r\n### Reproduction link\r\n[https://jsfiddle.net/bartsidee/n1tvtwet/](https://jsfiddle.net/bartsidee/n1tvtwet/)\r\n\r\n### Steps to reproduce\r\nWe identified that when a vnod is patched/replaced in the DOM e.g. after a vue-router route update the new vnode is marked with a DOM element reference (_refElm) of the previous vnode (in our case the previous route) causing a detached dom tree (memory leak)\r\n\r\nSteps to reproduce:\r\n1. open attached jsfiddle\r\n2. open chrome dev tools -> memory tab\r\n3. select the 'Home' route\r\n4. make a heap snapshot\r\n5. select the 'Foo' route\r\n6. make a heap snapshot\r\n7. select the last snapshot and use the 'summary' tab\r\n8. in the search box enter 'detached'\r\n9. find the detached tree that has a retainer to '_refElm'\r\n10. if you hover the red HTMLDivElement you will notice it is the dom element of the 'Home' component\r\n\r\nSee below code reference in vuejs:\r\n1. \"patch\" method is triggered which trigger \"patchVnode\" to replace existing root component\r\nhttps://github.com/vuejs/vue/blob/47334085a14eb1ed9525598d592038bb57e84db7/src/core/vdom/patch.js#L612\r\n2. both root components have children, which triggers \"updateChildren\":\r\nhttps://github.com/vuejs/vue/blob/47334085a14eb1ed9525598d592038bb57e84db7/src/core/vdom/patch.js#L484 \r\n3. there are no transitions so a new element is created, triggering \"createElm\":\r\nhttps://github.com/vuejs/vue/blob/47334085a14eb1ed9525598d592038bb57e84db7/src/core/vdom/patch.js#L409\r\n4. important is that \"createElm\" here is passed a DOM element reference \"oldStartVnode.elm\" of the old vnode (previous route) as 4th argument\r\n5. this in turn is link that the old dom element to the new vnode as \"_refElm\" property creating the detached binding causing the leak\r\nhttps://github.com/vuejs/vue/blob/47334085a14eb1ed9525598d592038bb57e84db7/src/core/vdom/patch.js#L109\r\nhttps://github.com/vuejs/vue/blob/12b7122c161548bfc9865357d9b71302d66d4a9f/src/core/instance/init.js#L84\r\n\r\n### What is expected?\r\nwe would expect that VueJS would be conservative of memory usage and prevent detached dom nodes\r\n\r\n### What is actually happening?\r\nwhen patching the vdom and replacing the root node, e.g. using the vue-router we see that the dom element of the previous route is indirectly linked to the new route causing a detached dom tree.\r\n\r\n---\r\nThe leak has a limited impact for normal devices as the reference is only to the last component that is patched, but can have a large impact on for example embedded devices as it prevents to browser to garbage collect to last route increasing the overall memory needed to run the app.\r\n\r\nSo to be clear if we have 3 components:  component 1, component 2, component 3 and component 1 is patched with component 2, vue will keep a detached dom of component 1. If component 2 is patched with component 3, component 2 will also be detached, but component 1 is in this case cleared because only the 'elm' reference transitions from component 2 to component 3.\r\n\r\n<!-- generated by vue-issues. DO NOT REMOVE -->","closed_by":{"login":"yyx990803","id":499550,"node_id":"MDQ6VXNlcjQ5OTU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/499550?v=4","gravatar_id":"","url":"https://api.github.com/users/yyx990803","html_url":"https://github.com/yyx990803","followers_url":"https://api.github.com/users/yyx990803/followers","following_url":"https://api.github.com/users/yyx990803/following{/other_user}","gists_url":"https://api.github.com/users/yyx990803/gists{/gist_id}","starred_url":"https://api.github.com/users/yyx990803/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yyx990803/subscriptions","organizations_url":"https://api.github.com/users/yyx990803/orgs","repos_url":"https://api.github.com/users/yyx990803/repos","events_url":"https://api.github.com/users/yyx990803/events{/privacy}","received_events_url":"https://api.github.com/users/yyx990803/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/vuejs/vue/issues/5851/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/vuejs/vue/issues/5851/timeline","performed_via_github_app":null,"state_reason":"completed"}