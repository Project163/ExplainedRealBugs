[{"url":"https://api.github.com/repos/vuejs/vue/issues/comments/328494069","html_url":"https://github.com/vuejs/vue/issues/6566#issuecomment-328494069","issue_url":"https://api.github.com/repos/vuejs/vue/issues/6566","id":328494069,"node_id":"MDEyOklzc3VlQ29tbWVudDMyODQ5NDA2OQ==","user":{"login":"Kingwl","id":6831019,"node_id":"MDQ6VXNlcjY4MzEwMTk=","avatar_url":"https://avatars.githubusercontent.com/u/6831019?v=4","gravatar_id":"","url":"https://api.github.com/users/Kingwl","html_url":"https://github.com/Kingwl","followers_url":"https://api.github.com/users/Kingwl/followers","following_url":"https://api.github.com/users/Kingwl/following{/other_user}","gists_url":"https://api.github.com/users/Kingwl/gists{/gist_id}","starred_url":"https://api.github.com/users/Kingwl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Kingwl/subscriptions","organizations_url":"https://api.github.com/users/Kingwl/orgs","repos_url":"https://api.github.com/users/Kingwl/repos","events_url":"https://api.github.com/users/Kingwl/events{/privacy}","received_events_url":"https://api.github.com/users/Kingwl/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2017-09-11T10:52:07Z","updated_at":"2017-09-11T10:52:07Z","body":"![qq20170911-185025](https://user-images.githubusercontent.com/6831019/30271250-26f0e358-9722-11e7-8475-ec9f85d8b43b.png)\r\nseems normal","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/vuejs/vue/issues/comments/328494069/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"Kingwl","id":6831019,"node_id":"MDQ6VXNlcjY4MzEwMTk=","avatar_url":"https://avatars.githubusercontent.com/u/6831019?v=4","gravatar_id":"","url":"https://api.github.com/users/Kingwl","html_url":"https://github.com/Kingwl","followers_url":"https://api.github.com/users/Kingwl/followers","following_url":"https://api.github.com/users/Kingwl/following{/other_user}","gists_url":"https://api.github.com/users/Kingwl/gists{/gist_id}","starred_url":"https://api.github.com/users/Kingwl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Kingwl/subscriptions","organizations_url":"https://api.github.com/users/Kingwl/orgs","repos_url":"https://api.github.com/users/Kingwl/repos","events_url":"https://api.github.com/users/Kingwl/events{/privacy}","received_events_url":"https://api.github.com/users/Kingwl/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":1243140457,"node_id":"MDEyOkxhYmVsZWRFdmVudDEyNDMxNDA0NTc=","url":"https://api.github.com/repos/vuejs/vue/issues/events/1243140457","actor":{"login":"HerringtonDarkholme","id":2883231,"node_id":"MDQ6VXNlcjI4ODMyMzE=","avatar_url":"https://avatars.githubusercontent.com/u/2883231?v=4","gravatar_id":"","url":"https://api.github.com/users/HerringtonDarkholme","html_url":"https://github.com/HerringtonDarkholme","followers_url":"https://api.github.com/users/HerringtonDarkholme/followers","following_url":"https://api.github.com/users/HerringtonDarkholme/following{/other_user}","gists_url":"https://api.github.com/users/HerringtonDarkholme/gists{/gist_id}","starred_url":"https://api.github.com/users/HerringtonDarkholme/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/HerringtonDarkholme/subscriptions","organizations_url":"https://api.github.com/users/HerringtonDarkholme/orgs","repos_url":"https://api.github.com/users/HerringtonDarkholme/repos","events_url":"https://api.github.com/users/HerringtonDarkholme/events{/privacy}","received_events_url":"https://api.github.com/users/HerringtonDarkholme/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2017-09-11T12:19:56Z","label":{"name":"need repro","color":"eb6420"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/vuejs/vue/issues/comments/328548042","html_url":"https://github.com/vuejs/vue/issues/6566#issuecomment-328548042","issue_url":"https://api.github.com/repos/vuejs/vue/issues/6566","id":328548042,"node_id":"MDEyOklzc3VlQ29tbWVudDMyODU0ODA0Mg==","user":{"login":"yyx990803","id":499550,"node_id":"MDQ6VXNlcjQ5OTU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/499550?v=4","gravatar_id":"","url":"https://api.github.com/users/yyx990803","html_url":"https://github.com/yyx990803","followers_url":"https://api.github.com/users/yyx990803/followers","following_url":"https://api.github.com/users/yyx990803/following{/other_user}","gists_url":"https://api.github.com/users/yyx990803/gists{/gist_id}","starred_url":"https://api.github.com/users/yyx990803/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yyx990803/subscriptions","organizations_url":"https://api.github.com/users/yyx990803/orgs","repos_url":"https://api.github.com/users/yyx990803/repos","events_url":"https://api.github.com/users/yyx990803/events{/privacy}","received_events_url":"https://api.github.com/users/yyx990803/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2017-09-11T14:32:38Z","updated_at":"2017-09-11T14:32:38Z","body":"Your repro is working as intended...","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/vuejs/vue/issues/comments/328548042/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"yyx990803","id":499550,"node_id":"MDQ6VXNlcjQ5OTU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/499550?v=4","gravatar_id":"","url":"https://api.github.com/users/yyx990803","html_url":"https://github.com/yyx990803","followers_url":"https://api.github.com/users/yyx990803/followers","following_url":"https://api.github.com/users/yyx990803/following{/other_user}","gists_url":"https://api.github.com/users/yyx990803/gists{/gist_id}","starred_url":"https://api.github.com/users/yyx990803/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yyx990803/subscriptions","organizations_url":"https://api.github.com/users/yyx990803/orgs","repos_url":"https://api.github.com/users/yyx990803/repos","events_url":"https://api.github.com/users/yyx990803/events{/privacy}","received_events_url":"https://api.github.com/users/yyx990803/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/vuejs/vue/issues/comments/328571591","html_url":"https://github.com/vuejs/vue/issues/6566#issuecomment-328571591","issue_url":"https://api.github.com/repos/vuejs/vue/issues/6566","id":328571591,"node_id":"MDEyOklzc3VlQ29tbWVudDMyODU3MTU5MQ==","user":{"login":"XGHeaven","id":9291212,"node_id":"MDQ6VXNlcjkyOTEyMTI=","avatar_url":"https://avatars.githubusercontent.com/u/9291212?v=4","gravatar_id":"","url":"https://api.github.com/users/XGHeaven","html_url":"https://github.com/XGHeaven","followers_url":"https://api.github.com/users/XGHeaven/followers","following_url":"https://api.github.com/users/XGHeaven/following{/other_user}","gists_url":"https://api.github.com/users/XGHeaven/gists{/gist_id}","starred_url":"https://api.github.com/users/XGHeaven/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/XGHeaven/subscriptions","organizations_url":"https://api.github.com/users/XGHeaven/orgs","repos_url":"https://api.github.com/users/XGHeaven/repos","events_url":"https://api.github.com/users/XGHeaven/events{/privacy}","received_events_url":"https://api.github.com/users/XGHeaven/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2017-09-11T15:47:10Z","updated_at":"2017-09-11T15:54:16Z","body":"@Kingwl @yyx990803 Sorry about that. I test others case and forgot to change back.\r\n\r\nThe important code is\r\n```html\r\n<div class=\"header\" v-if=\"expand\"> // block 1\r\n  <i @click=\"expand = false, countA++\">Expand is True</i> // element 1\r\n</div>\r\n<div class=\"expand\" v-if=\"!expand\" @click=\"expand = true, countB++\"> // block 2\r\n  <i>Expand is False</i> // element 2\r\n</div>\r\n```\r\n\r\nThere is four case:\r\n\r\n* click event listen on `block 1` and `block2`, works well\r\n* click event listen on `element 1` and `element 2`, works well\r\n* click event listen on `block 1` and `element 2`, change `expand` to true is ok. But cannot change back.\r\n* click event listen on `element 1` and `block 2`, cannot change `expand` to false. But can change `expand` to true.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/vuejs/vue/issues/comments/328571591/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"XGHeaven","id":9291212,"node_id":"MDQ6VXNlcjkyOTEyMTI=","avatar_url":"https://avatars.githubusercontent.com/u/9291212?v=4","gravatar_id":"","url":"https://api.github.com/users/XGHeaven","html_url":"https://github.com/XGHeaven","followers_url":"https://api.github.com/users/XGHeaven/followers","following_url":"https://api.github.com/users/XGHeaven/following{/other_user}","gists_url":"https://api.github.com/users/XGHeaven/gists{/gist_id}","starred_url":"https://api.github.com/users/XGHeaven/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/XGHeaven/subscriptions","organizations_url":"https://api.github.com/users/XGHeaven/orgs","repos_url":"https://api.github.com/users/XGHeaven/repos","events_url":"https://api.github.com/users/XGHeaven/events{/privacy}","received_events_url":"https://api.github.com/users/XGHeaven/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":1243561227,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MTI0MzU2MTIyNw==","url":"https://api.github.com/repos/vuejs/vue/issues/events/1243561227","actor":{"login":"Kingwl","id":6831019,"node_id":"MDQ6VXNlcjY4MzEwMTk=","avatar_url":"https://avatars.githubusercontent.com/u/6831019?v=4","gravatar_id":"","url":"https://api.github.com/users/Kingwl","html_url":"https://github.com/Kingwl","followers_url":"https://api.github.com/users/Kingwl/followers","following_url":"https://api.github.com/users/Kingwl/following{/other_user}","gists_url":"https://api.github.com/users/Kingwl/gists{/gist_id}","starred_url":"https://api.github.com/users/Kingwl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Kingwl/subscriptions","organizations_url":"https://api.github.com/users/Kingwl/orgs","repos_url":"https://api.github.com/users/Kingwl/repos","events_url":"https://api.github.com/users/Kingwl/events{/privacy}","received_events_url":"https://api.github.com/users/Kingwl/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2017-09-11T15:47:10Z","performed_via_github_app":null},{"id":1243561228,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDEyNDM1NjEyMjg=","url":"https://api.github.com/repos/vuejs/vue/issues/events/1243561228","actor":{"login":"Kingwl","id":6831019,"node_id":"MDQ6VXNlcjY4MzEwMTk=","avatar_url":"https://avatars.githubusercontent.com/u/6831019?v=4","gravatar_id":"","url":"https://api.github.com/users/Kingwl","html_url":"https://github.com/Kingwl","followers_url":"https://api.github.com/users/Kingwl/followers","following_url":"https://api.github.com/users/Kingwl/following{/other_user}","gists_url":"https://api.github.com/users/Kingwl/gists{/gist_id}","starred_url":"https://api.github.com/users/Kingwl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Kingwl/subscriptions","organizations_url":"https://api.github.com/users/Kingwl/orgs","repos_url":"https://api.github.com/users/Kingwl/repos","events_url":"https://api.github.com/users/Kingwl/events{/privacy}","received_events_url":"https://api.github.com/users/Kingwl/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2017-09-11T15:47:10Z","performed_via_github_app":null},{"id":1243561230,"node_id":"MDE0Ok1lbnRpb25lZEV2ZW50MTI0MzU2MTIzMA==","url":"https://api.github.com/repos/vuejs/vue/issues/events/1243561230","actor":{"login":"yyx990803","id":499550,"node_id":"MDQ6VXNlcjQ5OTU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/499550?v=4","gravatar_id":"","url":"https://api.github.com/users/yyx990803","html_url":"https://github.com/yyx990803","followers_url":"https://api.github.com/users/yyx990803/followers","following_url":"https://api.github.com/users/yyx990803/following{/other_user}","gists_url":"https://api.github.com/users/yyx990803/gists{/gist_id}","starred_url":"https://api.github.com/users/yyx990803/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yyx990803/subscriptions","organizations_url":"https://api.github.com/users/yyx990803/orgs","repos_url":"https://api.github.com/users/yyx990803/repos","events_url":"https://api.github.com/users/yyx990803/events{/privacy}","received_events_url":"https://api.github.com/users/yyx990803/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"mentioned","commit_id":null,"commit_url":null,"created_at":"2017-09-11T15:47:10Z","performed_via_github_app":null},{"id":1243561232,"node_id":"MDE1OlN1YnNjcmliZWRFdmVudDEyNDM1NjEyMzI=","url":"https://api.github.com/repos/vuejs/vue/issues/events/1243561232","actor":{"login":"yyx990803","id":499550,"node_id":"MDQ6VXNlcjQ5OTU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/499550?v=4","gravatar_id":"","url":"https://api.github.com/users/yyx990803","html_url":"https://github.com/yyx990803","followers_url":"https://api.github.com/users/yyx990803/followers","following_url":"https://api.github.com/users/yyx990803/following{/other_user}","gists_url":"https://api.github.com/users/yyx990803/gists{/gist_id}","starred_url":"https://api.github.com/users/yyx990803/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yyx990803/subscriptions","organizations_url":"https://api.github.com/users/yyx990803/orgs","repos_url":"https://api.github.com/users/yyx990803/repos","events_url":"https://api.github.com/users/yyx990803/events{/privacy}","received_events_url":"https://api.github.com/users/yyx990803/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"subscribed","commit_id":null,"commit_url":null,"created_at":"2017-09-11T15:47:10Z","performed_via_github_app":null},{"id":1246418924,"node_id":"MDEyOkxhYmVsZWRFdmVudDEyNDY0MTg5MjQ=","url":"https://api.github.com/repos/vuejs/vue/issues/events/1246418924","actor":{"login":"yyx990803","id":499550,"node_id":"MDQ6VXNlcjQ5OTU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/499550?v=4","gravatar_id":"","url":"https://api.github.com/users/yyx990803","html_url":"https://github.com/yyx990803","followers_url":"https://api.github.com/users/yyx990803/followers","following_url":"https://api.github.com/users/yyx990803/following{/other_user}","gists_url":"https://api.github.com/users/yyx990803/gists{/gist_id}","starred_url":"https://api.github.com/users/yyx990803/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yyx990803/subscriptions","organizations_url":"https://api.github.com/users/yyx990803/orgs","repos_url":"https://api.github.com/users/yyx990803/repos","events_url":"https://api.github.com/users/yyx990803/events{/privacy}","received_events_url":"https://api.github.com/users/yyx990803/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2017-09-13T02:13:00Z","label":{"name":"bug","color":"fc2929"},"performed_via_github_app":null},{"id":1246418925,"node_id":"MDE0OlVubGFiZWxlZEV2ZW50MTI0NjQxODkyNQ==","url":"https://api.github.com/repos/vuejs/vue/issues/events/1246418925","actor":{"login":"yyx990803","id":499550,"node_id":"MDQ6VXNlcjQ5OTU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/499550?v=4","gravatar_id":"","url":"https://api.github.com/users/yyx990803","html_url":"https://github.com/yyx990803","followers_url":"https://api.github.com/users/yyx990803/followers","following_url":"https://api.github.com/users/yyx990803/following{/other_user}","gists_url":"https://api.github.com/users/yyx990803/gists{/gist_id}","starred_url":"https://api.github.com/users/yyx990803/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yyx990803/subscriptions","organizations_url":"https://api.github.com/users/yyx990803/orgs","repos_url":"https://api.github.com/users/yyx990803/repos","events_url":"https://api.github.com/users/yyx990803/events{/privacy}","received_events_url":"https://api.github.com/users/yyx990803/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"unlabeled","commit_id":null,"commit_url":null,"created_at":"2017-09-13T02:13:00Z","label":{"name":"need repro","color":"eb6420"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/vuejs/vue/issues/comments/329057367","html_url":"https://github.com/vuejs/vue/issues/6566#issuecomment-329057367","issue_url":"https://api.github.com/repos/vuejs/vue/issues/6566","id":329057367,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTA1NzM2Nw==","user":{"login":"yyx990803","id":499550,"node_id":"MDQ6VXNlcjQ5OTU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/499550?v=4","gravatar_id":"","url":"https://api.github.com/users/yyx990803","html_url":"https://github.com/yyx990803","followers_url":"https://api.github.com/users/yyx990803/followers","following_url":"https://api.github.com/users/yyx990803/following{/other_user}","gists_url":"https://api.github.com/users/yyx990803/gists{/gist_id}","starred_url":"https://api.github.com/users/yyx990803/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yyx990803/subscriptions","organizations_url":"https://api.github.com/users/yyx990803/orgs","repos_url":"https://api.github.com/users/yyx990803/repos","events_url":"https://api.github.com/users/yyx990803/events{/privacy}","received_events_url":"https://api.github.com/users/yyx990803/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2017-09-13T04:44:54Z","updated_at":"2017-09-13T04:44:54Z","body":"So, this happens because:\r\n\r\n- The inner click event on `<i>` fires, triggering a 1st update on nextTick (microtask)\r\n- **The microtask is processed before the event bubbles to the outer div**. During the update, a click listener is added to the outer div.\r\n- Because the DOM structure is the same, both the outer div and the inner element are reused.\r\n- The event finally reaches outer div, triggers the listener added by the 1st update, in turn triggering a 2nd update.\r\n\r\nThis is quite tricky in fix, and other libs that leverages microtask for update queueing also have this problem (e.g. Preact). React doesn't seem to have this problem because they use a synthetic event system (probably due to edge cases like this).\r\n\r\nTo work around it, you can simply give the two outer divs different keys to force them to be replaced during updates. This would prevent the bubbled event to be picked up:\r\n\r\n``` html\r\n<div class=\"header\" v-if=\"expand\" key=\"1\"> // block 1\r\n  <i @click=\"expand = false, countA++\">Expand is True</i> // element 1\r\n</div>\r\n<div class=\"expand\" v-if=\"!expand\" @click=\"expand = true, countB++\" key=\"2\"> // block 2\r\n  <i>Expand is False</i> // element 2\r\n</div>\r\n```","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/vuejs/vue/issues/comments/329057367/reactions","total_count":22,"+1":19,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":3,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"yyx990803","id":499550,"node_id":"MDQ6VXNlcjQ5OTU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/499550?v=4","gravatar_id":"","url":"https://api.github.com/users/yyx990803","html_url":"https://github.com/yyx990803","followers_url":"https://api.github.com/users/yyx990803/followers","following_url":"https://api.github.com/users/yyx990803/following{/other_user}","gists_url":"https://api.github.com/users/yyx990803/gists{/gist_id}","starred_url":"https://api.github.com/users/yyx990803/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yyx990803/subscriptions","organizations_url":"https://api.github.com/users/yyx990803/orgs","repos_url":"https://api.github.com/users/yyx990803/repos","events_url":"https://api.github.com/users/yyx990803/events{/privacy}","received_events_url":"https://api.github.com/users/yyx990803/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":1246557992,"node_id":"MDEyOkxhYmVsZWRFdmVudDEyNDY1NTc5OTI=","url":"https://api.github.com/repos/vuejs/vue/issues/events/1246557992","actor":{"login":"yyx990803","id":499550,"node_id":"MDQ6VXNlcjQ5OTU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/499550?v=4","gravatar_id":"","url":"https://api.github.com/users/yyx990803","html_url":"https://github.com/yyx990803","followers_url":"https://api.github.com/users/yyx990803/followers","following_url":"https://api.github.com/users/yyx990803/following{/other_user}","gists_url":"https://api.github.com/users/yyx990803/gists{/gist_id}","starred_url":"https://api.github.com/users/yyx990803/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yyx990803/subscriptions","organizations_url":"https://api.github.com/users/yyx990803/orgs","repos_url":"https://api.github.com/users/yyx990803/repos","events_url":"https://api.github.com/users/yyx990803/events{/privacy}","received_events_url":"https://api.github.com/users/yyx990803/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2017-09-13T05:27:28Z","label":{"name":"improvement","color":"c7def8"},"performed_via_github_app":null},{"id":1279219962,"node_id":"MDExOkNsb3NlZEV2ZW50MTI3OTIxOTk2Mg==","url":"https://api.github.com/repos/vuejs/vue/issues/events/1279219962","actor":{"login":"yyx990803","id":499550,"node_id":"MDQ6VXNlcjQ5OTU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/499550?v=4","gravatar_id":"","url":"https://api.github.com/users/yyx990803","html_url":"https://github.com/yyx990803","followers_url":"https://api.github.com/users/yyx990803/followers","following_url":"https://api.github.com/users/yyx990803/following{/other_user}","gists_url":"https://api.github.com/users/yyx990803/gists{/gist_id}","starred_url":"https://api.github.com/users/yyx990803/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yyx990803/subscriptions","organizations_url":"https://api.github.com/users/yyx990803/orgs","repos_url":"https://api.github.com/users/yyx990803/repos","events_url":"https://api.github.com/users/yyx990803/events{/privacy}","received_events_url":"https://api.github.com/users/yyx990803/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"6e41679a96582da3e0a60bdbf123c33ba0e86b31","commit_url":"https://api.github.com/repos/vuejs/vue/commits/6e41679a96582da3e0a60bdbf123c33ba0e86b31","created_at":"2017-10-05T04:53:06Z","state_reason":null,"performed_via_github_app":null},{"actor":{"login":"ustbhuangyi","id":5359011,"node_id":"MDQ6VXNlcjUzNTkwMTE=","avatar_url":"https://avatars.githubusercontent.com/u/5359011?v=4","gravatar_id":"","url":"https://api.github.com/users/ustbhuangyi","html_url":"https://github.com/ustbhuangyi","followers_url":"https://api.github.com/users/ustbhuangyi/followers","following_url":"https://api.github.com/users/ustbhuangyi/following{/other_user}","gists_url":"https://api.github.com/users/ustbhuangyi/gists{/gist_id}","starred_url":"https://api.github.com/users/ustbhuangyi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ustbhuangyi/subscriptions","organizations_url":"https://api.github.com/users/ustbhuangyi/orgs","repos_url":"https://api.github.com/users/ustbhuangyi/repos","events_url":"https://api.github.com/users/ustbhuangyi/events{/privacy}","received_events_url":"https://api.github.com/users/ustbhuangyi/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2017-11-27T17:44:11Z","updated_at":"2017-11-27T17:44:11Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/DDFE/DDFE-blog/issues/24","repository_url":"https://api.github.com/repos/DDFE/DDFE-blog","labels_url":"https://api.github.com/repos/DDFE/DDFE-blog/issues/24/labels{/name}","comments_url":"https://api.github.com/repos/DDFE/DDFE-blog/issues/24/comments","events_url":"https://api.github.com/repos/DDFE/DDFE-blog/issues/24/events","html_url":"https://github.com/DDFE/DDFE-blog/issues/24","id":277107874,"node_id":"MDU6SXNzdWUyNzcxMDc4NzQ=","number":24,"title":"Vue.js 升级踩坑小记","user":{"login":"ustbhuangyi","id":5359011,"node_id":"MDQ6VXNlcjUzNTkwMTE=","avatar_url":"https://avatars.githubusercontent.com/u/5359011?v=4","gravatar_id":"","url":"https://api.github.com/users/ustbhuangyi","html_url":"https://github.com/ustbhuangyi","followers_url":"https://api.github.com/users/ustbhuangyi/followers","following_url":"https://api.github.com/users/ustbhuangyi/following{/other_user}","gists_url":"https://api.github.com/users/ustbhuangyi/gists{/gist_id}","starred_url":"https://api.github.com/users/ustbhuangyi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ustbhuangyi/subscriptions","organizations_url":"https://api.github.com/users/ustbhuangyi/orgs","repos_url":"https://api.github.com/users/ustbhuangyi/repos","events_url":"https://api.github.com/users/ustbhuangyi/events{/privacy}","received_events_url":"https://api.github.com/users/ustbhuangyi/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2017-11-27T17:44:11Z","updated_at":"2020-09-28T04:56:10Z","closed_at":null,"author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":63568049,"node_id":"MDEwOlJlcG9zaXRvcnk2MzU2ODA0OQ==","name":"DDFE-blog","full_name":"DDFE/DDFE-blog","private":false,"owner":{"login":"DDFE","id":13447209,"node_id":"MDEyOk9yZ2FuaXphdGlvbjEzNDQ3MjA5","avatar_url":"https://avatars.githubusercontent.com/u/13447209?v=4","gravatar_id":"","url":"https://api.github.com/users/DDFE","html_url":"https://github.com/DDFE","followers_url":"https://api.github.com/users/DDFE/followers","following_url":"https://api.github.com/users/DDFE/following{/other_user}","gists_url":"https://api.github.com/users/DDFE/gists{/gist_id}","starred_url":"https://api.github.com/users/DDFE/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DDFE/subscriptions","organizations_url":"https://api.github.com/users/DDFE/orgs","repos_url":"https://api.github.com/users/DDFE/repos","events_url":"https://api.github.com/users/DDFE/events{/privacy}","received_events_url":"https://api.github.com/users/DDFE/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/DDFE/DDFE-blog","description":":clap: welcome to DDFE's blog","fork":false,"url":"https://api.github.com/repos/DDFE/DDFE-blog","forks_url":"https://api.github.com/repos/DDFE/DDFE-blog/forks","keys_url":"https://api.github.com/repos/DDFE/DDFE-blog/keys{/key_id}","collaborators_url":"https://api.github.com/repos/DDFE/DDFE-blog/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/DDFE/DDFE-blog/teams","hooks_url":"https://api.github.com/repos/DDFE/DDFE-blog/hooks","issue_events_url":"https://api.github.com/repos/DDFE/DDFE-blog/issues/events{/number}","events_url":"https://api.github.com/repos/DDFE/DDFE-blog/events","assignees_url":"https://api.github.com/repos/DDFE/DDFE-blog/assignees{/user}","branches_url":"https://api.github.com/repos/DDFE/DDFE-blog/branches{/branch}","tags_url":"https://api.github.com/repos/DDFE/DDFE-blog/tags","blobs_url":"https://api.github.com/repos/DDFE/DDFE-blog/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/DDFE/DDFE-blog/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/DDFE/DDFE-blog/git/refs{/sha}","trees_url":"https://api.github.com/repos/DDFE/DDFE-blog/git/trees{/sha}","statuses_url":"https://api.github.com/repos/DDFE/DDFE-blog/statuses/{sha}","languages_url":"https://api.github.com/repos/DDFE/DDFE-blog/languages","stargazers_url":"https://api.github.com/repos/DDFE/DDFE-blog/stargazers","contributors_url":"https://api.github.com/repos/DDFE/DDFE-blog/contributors","subscribers_url":"https://api.github.com/repos/DDFE/DDFE-blog/subscribers","subscription_url":"https://api.github.com/repos/DDFE/DDFE-blog/subscription","commits_url":"https://api.github.com/repos/DDFE/DDFE-blog/commits{/sha}","git_commits_url":"https://api.github.com/repos/DDFE/DDFE-blog/git/commits{/sha}","comments_url":"https://api.github.com/repos/DDFE/DDFE-blog/comments{/number}","issue_comment_url":"https://api.github.com/repos/DDFE/DDFE-blog/issues/comments{/number}","contents_url":"https://api.github.com/repos/DDFE/DDFE-blog/contents/{+path}","compare_url":"https://api.github.com/repos/DDFE/DDFE-blog/compare/{base}...{head}","merges_url":"https://api.github.com/repos/DDFE/DDFE-blog/merges","archive_url":"https://api.github.com/repos/DDFE/DDFE-blog/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/DDFE/DDFE-blog/downloads","issues_url":"https://api.github.com/repos/DDFE/DDFE-blog/issues{/number}","pulls_url":"https://api.github.com/repos/DDFE/DDFE-blog/pulls{/number}","milestones_url":"https://api.github.com/repos/DDFE/DDFE-blog/milestones{/number}","notifications_url":"https://api.github.com/repos/DDFE/DDFE-blog/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/DDFE/DDFE-blog/labels{/name}","releases_url":"https://api.github.com/repos/DDFE/DDFE-blog/releases{/id}","deployments_url":"https://api.github.com/repos/DDFE/DDFE-blog/deployments","created_at":"2016-07-18T03:41:14Z","updated_at":"2025-10-13T08:28:40Z","pushed_at":"2021-01-19T07:04:57Z","git_url":"git://github.com/DDFE/DDFE-blog.git","ssh_url":"git@github.com:DDFE/DDFE-blog.git","clone_url":"https://github.com/DDFE/DDFE-blog.git","svn_url":"https://github.com/DDFE/DDFE-blog","homepage":"","size":41,"stargazers_count":3964,"watchers_count":3964,"language":null,"has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":false,"forks_count":471,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":40,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":[],"visibility":"public","forks":471,"open_issues":40,"watchers":3964,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"本文并不是什么高深的技术文章，只是记录我最近遇到一个因为 Vue 升级导致我的一个项目踩坑以及我解决问题的过程。文章虽长但不水，写下来的目的是想和大家分享一下我遇到问题时候一个思考的方法和态度。\r\n\r\n> 背景：去年我在慕课网推出了一门 Vue.js 的入门实战课程——[Vue.js 高仿饿了么外卖 App](http://coding.imooc.com/class/74.html) ，这门课程收到了非常不错的反响，于是今年又在慕课网上继续推出了 Vue.js 的高级进阶实战课程——[Vue.js 音乐 App](http://coding.imooc.com/class/107.html)，同样反馈不错。每天晚上下班回家，我会去问答区看一下学生们的问题，发现近期有不少同学反馈了同样的问题，iOS 微信里点击不能播放歌曲了，PC 可以。通常遇到这种问题我会让学生先去访问我的项目的[线上地址](http://ustbhuangyi.com/music/)，看看我的代码会不会有问题，得到的结论是我的线上代码没问题，但他们自己写就不行，并且说已经完全和我的代码做了对比，这就让我觉得十分诡异。没过多久，有些学生就想出了一个办法，在全局 document 绑定一个同步的 click 事件，在 click 事件的回调函数中同步触发一次 audio 的 play 方法，似乎解决了问题，也得到了一些同学的采纳，但是我看到以后的第一反应是不能用这种太 hack 的方式去解决问题，必须找到问题的本质，于是乎我开始了一段很有意思的找问题的过程。\r\n\r\n## 定位问题\r\n\r\n先看现象：同学们写的代码在 iOS 微信浏览器下不能播放，PC 是可以的；我线上的代码是都可以。了解现象后我开始排查问题：\r\n\r\n- 同学们的代码写的有问题？\r\n虽然会有这种可能性，但从 2 个维度被我否决了：1. 同学们也都对比过我的源码的，而且出问题的同学也不是个别现象；2. 如果是代码问题，那么大多可能性是 PC 和移动端都不能播放。\r\n\r\n- 找不同？\r\n这个问题是最新才出现的，同学们开始学习编写课程代码都也是通过 vue-cli 脚手架先初始化代码。接着我大概看了一下新版的脚手架初始化的代码，果然是大不同，webpack 升级到 3+，配置发生了很大的变化。不过依据我的经验，构建工具的升级是不会影响业务代码的，一定还有别的原因。\r\n\r\n- Vue.js 升级？\r\n除了 webpack 配置的不同，最新脚手架初始化的代码用的 Vue.js 版本是 2.5+，而我线上代码的 Vue.js 版本是 2.3+，难道是 Vue.js 导致的问题吗？带着这个疑问我去翻阅了 Vue.js 的 [release log](https://github.com/vuejs/vue/releases)，发现 Vue.js 大大小小版本发布了十几次。如果每个都仔细查看也会很耗时，于是我采用了一个经典的 2 分法的思路去定位，我先把 Vue.js 升级到 2.4.0，发现竟然安装不了（这是 Vue.js 刚升到 2.4 npm 发布的 bug），于是又升级到 2.4.1，然后拿我的手机试了一下，还是可以播放的。接着我把 Vue.js 升级到 2.5.0，手机一试果然不能播放了，（擦。。）我心里默念一句，总算找到问题所在了。\r\n\r\n## 问题的本质\r\n\r\n以上定位到问题大概花了我半小时时间，但是我并没有找到问题的根本原因，于是我翻阅了 Vue.js 2.5 的 [release log](https://github.com/vuejs/vue/releases/tag/v2.5.0)，由于很长就不列了。Vue.js 每次升级主要分成 2 大类，Features & Improvements 和 Bug Fixes。我从上往下依次扫了一遍，把一些关于它核心的改动都点进去看了一下代码的修改，最终锁定了这一条：\r\n\r\n> use MessageChannel for nextTick 6e41679, closes #6566 #6690\r\n\r\n接着我点进去看了一下[改动](https://github.com/vuejs/vue/commit/6e41679a96582da3e0a60bdbf123c33ba0e86b31)，我滴天，改动很大呀，nextTick 的核心实现变了，MutationObserver 不见了，改成了 MessageChannel 的实现。等等，有些同学看到这里，可能会懵，这都是些啥呀。不急，我先简单解释一下 Vue 的 nextTick。\r\n\r\n### nextTick\r\n\r\n介绍 Vue 的 nextTick 之前，我先简单介绍一下 JS 的运行机制：JS 执行是单线程的，它是基于事件循环的。对于事件循环的理解，阮老师有[一篇文章](http://www.ruanyifeng.com/blog/2014/10/event-loop.html)写的很清楚，大致分为以下几个步骤：\r\n\r\n（1）所有同步任务都在主线程上执行，形成一个执行栈（execution context stack）。\r\n\r\n（2）主线程之外，还存在一个\"任务队列\"（task queue）。只要异步任务有了运行结果，就在\"任务队列\"之中放置一个事件。\r\n\r\n（3）一旦\"执行栈\"中的所有同步任务执行完毕，系统就会读取\"任务队列\"，看看里面有哪些事件。那些对应的异步任务，于是结束等待状态，进入执行栈，开始执行。\r\n\r\n（4）主线程不断重复上面的第三步。\r\n\r\n主线程的执行过程就是一个 tick，而所有的异步结果都是通过 “任务队列” 来调度被调度。 消息队列中存放的是一个个的任务（task）。 规范中规定 task 分为两大类，分别是 macro task 和 micro task，并且每个 macro task 结束后，都要清空所有的 micro task。\r\n\r\n关于 macro task 和 micro task 的概念，这里不会细讲，简单通过一段代码演示他们的执行顺序：\r\n\r\n```js\r\nfor (macroTask of macroTaskQueue) {\r\n    // 1. Handle current MACRO-TASK\r\n    handleMacroTask();\r\n      \r\n    // 2. Handle all MICRO-TASK\r\n    for (microTask of microTaskQueue) {\r\n        handleMicroTask(microTask);\r\n    }\r\n}\r\n```\r\n在浏览器环境中，常见的 macro task 有 setTimeout、MessageChannel、postMessage、setImmediate；常见的 micro task 有 MutationObsever 和 Promise.then。对于它们更多的了解，感兴趣的同学可以看[这篇文章](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)。\r\n\r\n回到 Vue 的 nextTick，nextTick 顾名思义，就是下一个 tick，Vue 内部实现了 nextTick，并把它作为一个全局 API 暴露出来，它支持传入一个回调函数，保证回调函数的执行时机是在下一个 tick。官网文档介绍了 Vue.nextTick 的使用场景：\r\n\r\n> Usage: Defer the callback to be executed after the next DOM update cycle. Use it immediately after you’ve changed some data to wait for the DOM update.\r\n使用：在下次 DOM 更新循环结束之后执行延迟回调，在修改数据之后立即使用这个方法，获取更新后的 DOM。\r\n\r\n在 Vue.js 里是数据驱动视图变化，由于 JS 执行是单线程的，在一个 tick 的过程中，它可能会多次修改数据，但 Vue.js 并不会傻到每修改一次数据就去驱动一次视图变化，它会把这些数据的修改全部 push 到一个队列里，然后内部调用 一次 nextTick 去更新视图，所以数据到 DOM 视图的变化是需要在下一个 tick 才能完成。\r\n\r\n接下来，我们来看一下 Vue 的 nextTick 的实现，在 Vue.js 2.5+ 的版本，抽出来一个单独的 [next-tick.js](https://github.com/vuejs/vue/blob/dev/src/core/util/next-tick.js) 文件去实现它，\r\n\r\n``` js\r\n/* @flow */\r\n/* globals MessageChannel */\r\n\r\nimport { noop } from 'shared/util'\r\nimport { handleError } from './error'\r\nimport { isIOS, isNative } from './env'\r\n\r\nconst callbacks = []\r\nlet pending = false\r\n\r\nfunction flushCallbacks () {\r\n  pending = false\r\n  const copies = callbacks.slice(0)\r\n  callbacks.length = 0\r\n  for (let i = 0; i < copies.length; i++) {\r\n    copies[i]()\r\n  }\r\n}\r\n\r\n// Here we have async deferring wrappers using both micro and macro tasks.\r\n// In < 2.4 we used micro tasks everywhere, but there are some scenarios where\r\n// micro tasks have too high a priority and fires in between supposedly\r\n// sequential events (e.g. #4521, #6690) or even between bubbling of the same\r\n// event (#6566). However, using macro tasks everywhere also has subtle problems\r\n// when state is changed right before repaint (e.g. #6813, out-in transitions).\r\n// Here we use micro task by default, but expose a way to force macro task when\r\n// needed (e.g. in event handlers attached by v-on).\r\nlet microTimerFunc\r\nlet macroTimerFunc\r\nlet useMacroTask = false\r\n\r\n// Determine (macro) Task defer implementation.\r\n// Technically setImmediate should be the ideal choice, but it's only available\r\n// in IE. The only polyfill that consistently queues the callback after all DOM\r\n// events triggered in the same loop is by using MessageChannel.\r\n/* istanbul ignore if */\r\nif (typeof setImmediate !== 'undefined' && isNative(setImmediate)) {\r\n  macroTimerFunc = () => {\r\n    setImmediate(flushCallbacks)\r\n  }\r\n} else if (typeof MessageChannel !== 'undefined' && (\r\n  isNative(MessageChannel) ||\r\n  // PhantomJS\r\n  MessageChannel.toString() === '[object MessageChannelConstructor]'\r\n)) {\r\n  const channel = new MessageChannel()\r\n  const port = channel.port2\r\n  channel.port1.onmessage = flushCallbacks\r\n  macroTimerFunc = () => {\r\n    port.postMessage(1)\r\n  }\r\n} else {\r\n  /* istanbul ignore next */\r\n  macroTimerFunc = () => {\r\n    setTimeout(flushCallbacks, 0)\r\n  }\r\n}\r\n\r\n// Determine MicroTask defer implementation.\r\n/* istanbul ignore next, $flow-disable-line */\r\nif (typeof Promise !== 'undefined' && isNative(Promise)) {\r\n  const p = Promise.resolve()\r\n  microTimerFunc = () => {\r\n    p.then(flushCallbacks)\r\n    // in problematic UIWebViews, Promise.then doesn't completely break, but\r\n    // it can get stuck in a weird state where callbacks are pushed into the\r\n    // microtask queue but the queue isn't being flushed, until the browser\r\n    // needs to do some other work, e.g. handle a timer. Therefore we can\r\n    // \"force\" the microtask queue to be flushed by adding an empty timer.\r\n    if (isIOS) setTimeout(noop)\r\n  }\r\n} else {\r\n  // fallback to macro\r\n  microTimerFunc = macroTimerFunc\r\n}\r\n\r\n/**\r\n * Wrap a function so that if any code inside triggers state change,\r\n * the changes are queued using a Task instead of a MicroTask.\r\n */\r\nexport function withMacroTask (fn: Function): Function {\r\n  return fn._withTask || (fn._withTask = function () {\r\n    useMacroTask = true\r\n    const res = fn.apply(null, arguments)\r\n    useMacroTask = false\r\n    return res\r\n  })\r\n}\r\n\r\nexport function nextTick (cb?: Function, ctx?: Object) {\r\n  let _resolve\r\n  callbacks.push(() => {\r\n    if (cb) {\r\n      try {\r\n        cb.call(ctx)\r\n      } catch (e) {\r\n        handleError(e, ctx, 'nextTick')\r\n      }\r\n    } else if (_resolve) {\r\n      _resolve(ctx)\r\n    }\r\n  })\r\n  if (!pending) {\r\n    pending = true\r\n    if (useMacroTask) {\r\n      macroTimerFunc()\r\n    } else {\r\n      microTimerFunc()\r\n    }\r\n  }\r\n  // $flow-disable-line\r\n  if (!cb && typeof Promise !== 'undefined') {\r\n    return new Promise(resolve => {\r\n      _resolve = resolve\r\n    })\r\n  }\r\n}\r\n\r\n```\r\n我们在有之前的知识背景，再理解 nextTick 的实现就不难了，这里有一段很关键的注释：在 Vue 2.4 之前的版本，nextTick 几乎都是基于 micro task 实现的，但由于  micro task 的执行优先级非常高，在某些场景下它甚至要比事件冒泡还要快，就会导致一些诡异的问题，如 issue [#4521](https://github.com/vuejs/vue/issues/4521)、[#6690](https://github.com/vuejs/vue/issues/6690)、[#6566](https://github.com/vuejs/vue/issues/6566)；但是如果全部都改成 macro task，对一些有重绘和动画的场景也会有性能影响，如 issue [#6813](https://github.com/vuejs/vue/issues/6813)。所以最终 nextTick 采取的策略是默认走 micro task，对于一些 DOM 交互事件，如 v-on 绑定的事件回调函数的处理，会强制走 macro task。\r\n\r\n这个强制是怎么做的呢，原来在 Vue.js 在绑定 DOM 事件的时候，默认会给回调的 `handler` 函数调用 `withMacroTask` 方法做一层包装，它保证整个回调函数执行过程中，遇到数据状态的改变，这些改变都会被推到 macro task 中。\r\n\r\n对于 macro task 的执行，Vue.js 优先检测是否支持原生 `setImmediate`，这是一个高版本 IE 和 Edge 才支持的特性，不支持的话再去检测是否支持原生的 `MessageChannel`，如果也不支持的话就会降级为 `setTimeout 0`。\r\n\r\n## nextTick 对 audio 播放的影响\r\n\r\n回到我们的问题，iOS 微信浏览器不能播放歌曲和 nextTick 有什么关系呢？先来看一下我们的歌曲播放这个功能的实现方法。\r\n\r\n我们的代码会有一个播放器组件 player.vue，在这个组件中我们会持有一个 html5 的 audio 标签。由于可调用播放的地方很多，比如在歌曲列表组件、榜单组件、搜索结果组件等等，因此我们用 vuex 对播放相关的数据进行管理。我们把正在播放的列表 `playlist` 和当前播放索引 `currentIndex` 用 state 维护，当前播放的歌曲 `currentSong` 通过它们计算而来：\r\n\r\n``` js\r\n// state.js\r\nconst state = {\r\n  playlist: [],\r\n  currentIndex:0\r\n}\r\n// getters.js\r\nexport const currentSong = (state) => {\r\n  return state.playlist[state.currentIndex] || {}\r\n}\r\n```\r\n然后我们在 player.vue 组件里 watch `currentSong` 的变化去播放歌曲：\r\n\r\n``` js\r\n// player.vue\r\nwatch : {\r\n   currentSong(newSong,oldSong) {\r\n      if (!newSong.id || !newSong.url || newSong.id === oldSong.id) {\r\n          return\r\n       }\r\n       this.$refs.audio.src = newSong.url\r\n       this.$refs.audio.play()\r\n   }\r\n}\r\n```\r\n\r\n这样我们就可以在任何组件中提交对 `playlist` 和 `currentIndex` 的修改来达到播放不同歌曲的目的。那么这么写和 nextTick 有什么关系呢？\r\n\r\n因为在 Vue.js 中，watcher 的回调函数执行默认是异步的，当我们提交对 `playlist` 或者 `currenIndex` 的修改，都会触发 `currentSong` 的变化，但是由于是异步，并不会立刻执行 watcher 的回调函数，而会在 nextTick 后执行。所以当我们点击歌曲列表中的歌曲后，在 click 的事件回调函数中会提交对 `playlist` 和 `currentIndex` 的修改， 经过一系列同步的逻辑执行，最终是在 nextTick 后才会执行 wathcer 的回调，也就是调用 audio 的 play。\r\n\r\n所以本质上，就是用户点击到 audio 的 play 并不是在一个 tick 中完成，并且前面提到 Vue.js 中对 v-on 绑定事件执行的 nextTick 过程会强制使用 macro task。那么到底是不是由于 nextTick 影响了 audio 在 iOS 微信浏览器中的播放呢，\r\n我们就来把化繁为简，写一个简单 demo 来验证这个问题，用的 Vue.js 版本是 2.5+ 的。\r\n\r\n```\r\n<template>\r\n\t<div id=\"app\">\r\n\t\t<audio ref=\"audio\"></audio>\r\n\t    <button @click=\"changeUrl\">click me</button>\r\n\t</div>\r\n</template>\r\n\r\n<script>\r\n\tconst musicList = [\r\n    'http://ws.stream.qqmusic.qq.com/108756223.m4a?fromtag=46',\r\n    'http://ws.stream.qqmusic.qq.com/101787871.m4a?fromtag=46',\r\n    'http://ws.stream.qqmusic.qq.com/718475.m4a?fromtag=46'\r\n  ]\r\n\r\n  export default {\r\n    name: 'app',\r\n    data() {\r\n      return {\r\n        index: 0,\r\n        url: ''\r\n      }\r\n    },\r\n    methods: {\r\n      changeUrl() {\r\n        this.index = (this.index + 1) % musicList.length\r\n        this.url = musicList[this.index]\r\n      }\r\n    },\r\n    watch: {\r\n      url(newUrl) {\r\n        this.$refs.audio.src = newUrl\r\n        this.$refs.audio.play()\r\n      }\r\n    }\r\n  }\r\n</script>\r\n```\r\n这段代码的逻辑非常简单，我们会添加一个 watcher 监听 `url` 变化，当点击按钮的时候，会调用 `changeUrl` 方法，修改 `url`，然后 watcher 的回调函数执行，并调用 audio 的 play 方法。这段代码在 PC 浏览器是可以正常播放歌曲的，但是在 iOS 微信浏览器里却不能播放，这就证实了我们之前的猜想——在用户点击事件的回调函数到 audio 的播放如果经历了 nextTick 在 iOS 微信浏览器下不能播放。\r\n\r\n## macro task 的锅？\r\n\r\n有些同学可能会认为，当用户点击了按钮到播放的过程在 iOS 微信浏览器或者是 iOS safari 浏览器应该需要在同一个 tick 才能执行，果真需要这样吗？我们把上述代码做一个简单的修改：\r\n\r\n``` js\r\nchangeUrl() {\r\n  this.index = (this.index + 1) % musicList.length\r\n  this.url = musicList[this.index]\r\n  \r\n  setTimeout(()=>{\r\n    this.$refs.audio.src = this.url\r\n    this.$refs.audio.play()\r\n  }, 0)\r\n}\r\n```\r\n我们现在不利用 Vue.js 的 nextTick 了，直接来模拟 nextTick 的过程，发现使用 `setTimeout 0` 是可以在 iOS 微信浏览器器、包括 iOS safari 下播放的，然而实际上我们只要在 1000ms 内的延时时间播放都是可以的，但是超过 1000ms，比如 `setTimeout 1001` 又不能播放了，感兴趣的同学可以试试，这个现象的理论依据我还没找到，如果知道理论的同学也非常欢迎留言告诉我。\r\n\r\n所以通过上述的实验，我们发现并不一定要在同一个 tick 执行播放，那么为啥 Vue.js 的 nextTick 是不可以的呢？回到 nextTick 的 macro task 的实现，它优先 `setImmediate`、然后 `MessageChannel`，最后才是 `setTimeout 0`。我们知道，除了高版本 IE 和 Edge，`setImmediate` 是没有原生支持的，除非一些工具对它进行了重新改写。而 `MessageChannel` 的浏览器支持程度还是非常高的，那么我把这段 demo 的异步过程改成用 `MessageChannel` 实现。\r\n\r\n``` js\r\nchangeUrl() {\r\n  this.index = (this.index + 1) % musicList.length\r\n  this.url = musicList[this.index]\r\n  \r\n  let channel = new MessageChannel()\r\n  let port = channel.port2\r\n  channel.port1.onmessage = () => {\r\n    this.$refs.audio.src = this.url\r\n    this.$refs.audio.play()\r\n  }\r\n  port.postMessage(1)\r\n}\r\n```\r\n这段代码在 PC 浏览器是可以播放的，而在 iOS 微信浏览器又不能播放了，调试后发现 `this.$refs.audio.play()` 的逻辑也是可以执行到的，但是歌曲并不能播放，应该是浏览器对 audio 播放在使用 MessageChannel 做异步的一种限制。\r\n\r\n前面提到实现 macro task 还有一种方法是利用 postMessage，它的浏览器支持程度也很好，我们来把 demo 改成利用它来实现。\r\n\r\n``` js\r\nchangeUrl() {\r\n  this.index = (this.index + 1) % musicList.length\r\n  this.url = musicList[this.index]\r\n\r\n  addEventListener('message', () => {\r\n    this.$refs.audio.src = this.url\r\n    this.$refs.audio.play()\r\n  }, false);\r\n  postMessage(1, '*')\r\n}\r\n```\r\n这段代码在 PC 浏览器和 iOS 微信浏览器以及 iOS safari 都可以播放的，说明并不是 macro task 的锅，而是 MessageChannel 的锅。其实 macro task 还有很多实现方式，感兴趣的同学可以看看 core-js 中对于 macro task 的几种[实现方式](https://github.com/zloirock/core-js/blob/master/modules/_task.js#L28-L80)。\r\n\r\n## 如何解决？\r\n\r\n现在我们定位到问题的本质是因为 Vue.js 的 nextTick 中优先使用了 MessageChannel，它会影响 iOS 微信浏览器的播放，那么我们如何用最小成本来解决这个问题呢？\r\n\r\n### Vue.js 的版本降级\r\n\r\n如果是真实运行在生产环境中的项目，毫无疑问这肯定是优先解决问题的首选，因为确实也是因为 Vue.js 的升级才造成这个 bug 的。在我们的实际项目中，我们都是锁死某个 Vue.js 的版本的，除非我们想使用某个 Vue.js 新版的 feature 或者是当前版本遇到了一个严重 bug 而新版已经修复的情况，我们才会考虑升级 Vue.js，并且每次升级都需要经过完整的功能测试。\r\n\r\n为何把 Vue.js 降级到 2.4+ 就没问题呢，因为 Vue.js 2.5 之前的 nextTick 都是优先使用 microtask 的，那么 audio 播放的时机实际上还是在当前 tick，所以当然不会有问题。\r\n\r\n说到版本问题，其实这也是 Vue.js 的一点瑕疵吧，升版本的时候有时候改动过于激进了，比如这次关于 nextTick 的升级，它其实是 Vue.js 一个非常核心的功能，但是它只有单元测试，并没有大量的功能测试 case 覆盖，也只能通过社区帮助反馈问题做改进了。\r\n\r\n### 同步的 watcher\r\n\r\nVue.js 的 watcher 默认是异步的，当然它也提供了同步的 watcher，这样 watcher 的回调函数执行就不需要经历了 nextTick，这样确实可以修复这个 bug，但又会引起别的问题。因为我们的音乐播放器有一个 feature 是可以在播放的过程中切换播放模式，我们支持顺序播放、随机播放、单曲循环三种播放模式，当我们从顺序播放切到随机播放模式的时候，实际上是对播放列表 `playlist` 做了修改，同时也修改了 `currentIndex`，这样可以保证我们在切换模式的时候并不会修改当前歌曲。那么问题来了，由于 `currentSong` 是由 `playlist` 和 `currentIndex` 计算而来的，对它们任何一个修改，都会触发 `currentSong` 的变化，由于我们现在改成同步的 watcher，那么 currentSong 的回调会执行 2 次，这样第一次的修改导致计算出来的歌曲就变成了另外一首了，这个显然也不是我们期望的。所以同步 watcher 也是不可行的。\r\n\r\n### 其它方式\r\n\r\n其实还有很多方式都能“修复”这个问题，比如我们不通过 watcher，改成每次点击通过 event bus 去通知；比如仍然使用同步 watcher，但 currentSong 不通过计算，直接用 state 保留；比如每次点击事件不通过  v-on 绑定，我们直接在 mounted 的钩子函数里利用原生的 addEventListener 去绑定 click 事件。\r\n\r\n当然，上述几个方式都是可行的，但是我并不推荐这么去改，因为这样对业务代码的改动实在太大了，如果我们本身的写法如果是合理的，却要强行改成这些方式，就好像是：我知道了框架的某一个坑，我用一些奇技淫巧绕过了这些坑，这样做也是不合理的。\r\n\r\n框架产生的意义是什么：制定一种友好的开发规范，提升开发效率，让开发人员更加专注业务逻辑的开发。所以优秀的框架不应该限制开发人员对于一些场景下功能的实现方式，仅仅是因为这种实现方式虽然本身合理但可能会触发框架某个坑。\r\n\r\n### 临时的 hack 方法\r\n\r\n由于不想动业务代码，所以我就想了一些比较 hack 的办法，因为是 MessageChannel 的锅，所以我就在 Vue.js 的初始化前，引入了一段 hack.js\r\n\r\n``` js \r\n// hack for global nextTick\r\nfunction noop() {\r\n}\r\n\r\nwindow.MessageChannel = noop\r\nwindow.setImmediate = noop\r\n```\r\n这样的话 Vue.js 在初始化 nextTick 的时候，发现全局的 `setImmediate` 和 `MessageChannel` 被改写了，就自动降级为 `setTimeout 0` 的实现，这样就可以规避掉我们的问题了。当然，这种 hack 方式算是没有办法的办法了，我并不推荐。\r\n\r\n### 给 Vue.js 提 issue\r\n\r\n所以这种情况最合理的就是给 Vue.js 提 issue，我确实也是这么做了，去 Github 上提了一个 [issue](https://github.com/vuejs/vue/issues/7109)，第一次给 Vue.js 提 issue，发现 Vue 官方这块做的还是蛮人性化的，直接给一个提 issue 的[链接](https://new-issue.vuejs.org/)，通过填写一些表单来描述这个 issue，并且推荐了一个很好的复现问题的工具 [CodeSandbox](https://codesandbox.io/s/vue) 。这个 issue 当天就收到了尤大的回复，他表示 Vue.js 的 nextTick 确实会造成这个问题，但是我应该在同一个 tick 完成歌曲的播放，而不应该使用 watcher，接着就 close 了 issue。因为我提 issue 为了更直观的演示核心问题，用的就是上面提到的非常简单的 demo，所以在这种场景下，他说的也没问题，确实没有必要使用 watcher，于是我赶紧又回复了 issue，说明了一下我的真实使用场景，并表明希望从 Vue.js 内核去修复这个问题。可惜的是，尤大目前也并没有再回复这个 issue。\r\n\r\n## 总结\r\n\r\n通过记录我这一次发现问题——定位问题——解决问题的过程，我想给同学带来的思考不仅仅是这个问题本身，还有我们遇到问题后的一些态度。发现问题并不难，很多人在写代码中都会发现问题，那么发现问题后你的第一反应是尝试自己解决，还是去求助，我相信前者肯定更好。那么在解决之前需要定位问题，这里我要提到一个词，叫“面向巧合编程”，很多人遇到问题后会不断尝试这种办法，很可能某个办法就从表象上“解决”了这个问题，却不知道为什么，这种解决问题的方式是很不靠谱的，你可能并没有根本上解决问题，又可能解决了这个问题却又引发另一个问题。所以定位问题的本质就非常关键了，其实这是一个能力，一个好的工程师不仅会写代码，也要会查问题，能快速定位到问题的本质，是一个优秀的工程师的必要条件，这一点不容易，需要平时不断地的积累。在定位到问题的本质后，就要解决问题了，一道题往往有多解，但每种解法是否合理，这也是一个需要思考的过程，多和一些比你厉害的人交流，多积攒一些这方面的经验，这也是一个积累的过程。如果以后你再遇到问题，也用这样的态度去面对的问题，那么你也会很快的成长。\r\n\r\n很多同学学习我的音乐课程后，会问：“黄老师，你什么时候再出新视频呀？”，其实我想说这门课程你真的学完了吗？因为它的定位是一门 Vue.js 的进阶课程，不仅仅是因为课程的项目本身比较复杂，而且项目中很多知识点都可以做延伸的学习，另外项目难免会有一些小 bug 和一些由于接口改动引发的功能不可用的情况，遇到这些问题除了给我提 issue，尝试自己去解决然后给我提 pull request 的方式是不是对自己的提升更大呢？所以这门课程还是值得多去挖掘的，如果真正榨干了这门课的价值再来问我也不迟，当然我也会给你们带来更多干货的课程。\r\n\r\n最后也来小小安利我的这门 Vue.js 进阶课程吧（[慕课网地址](http://coding.imooc.com/class/107.html)），感兴趣的同学可以点进去看看课程介绍。课程的项目是托管在我的 Github 私服的，并不开源，所以外面的一切和这个课程相关的代码都是盗版的。这个源码我是一直维护的，包括最近 Vue.js 的脚手架的升级，以及依赖方接口的一些改造造成的功能不可用问题，都已经得到了解决。简单地截几张截图：\r\n\r\n![vue-music-issue](http://webapp.didistatic.com/static/webapp/shield/vue-music-issue.png)\r\n\r\n这一张是对 issue 的处理，我们在课程推出来后解决了几十个 issue，如果有同学在学习过程中遇到问题建议去翻阅 issue 寻找答案。有一些版本的升级的 issue 我不会关，为了让同学们可以更方便的找到。\r\n\r\n![vue-music-contribute](http://webapp.didistatic.com/static/webapp/shield/vue-music-contribute.jpg)\r\n\r\n这一张是代码提交记录，可以看到除了我还是有一些很不错的同学在一起维护这个项目，这其中有一个同学学习非常主动，自驱力很强，常与我探讨技术问题，最近他也加入了滴滴，在我们部门做了很多的产出。\r\n\r\n更直观的感受这个项目，可以扫描下方的二维码，体验一下接近原生 App 的感觉：\r\n\r\n![二维码](http://qr.api.cli.im/qr?data=http%253A%252F%252Fustbhuangyi.com%252Fmusic&level=H&transparent=false&bgcolor=%23ffffff&forecolor=%23000000&blockpixel=12&marginblock=1&logourl=&size=280&kid=cliim&key=ab1f62311bfc4de5bc301283707c0328)\r\n\r\n我们有一个官方的课程交流群，如果购买了这门课程，欢迎与其它同学一起交流学习，也可以加我的 qq 和微信，交流技术问问题都可以，不过我一般白天很忙，晚上才有时间。\r\n\r\n当然，想关注我的一些动态，也欢迎 follow 我的 [Github](https://github.com/ustbhuangyi)。\r\n\r\n希望同学们一起来支持正版，抵制盗版，我会为大家带来更多优质的课程以及其它的一些形式的技术方向的分享。\r\n\r\n本文参考的一些值得延伸学习的文章：\r\n\r\n[JavaScript 运行机制详解：再谈Event Loop](http://www.ruanyifeng.com/blog/2014/10/event-loop.html)\r\n\r\n[Tasks, microtasks, queues and schedules](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)","reactions":{"url":"https://api.github.com/repos/DDFE/DDFE-blog/issues/24/reactions","total_count":15,"+1":15,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/DDFE/DDFE-blog/issues/24/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"actor":{"login":"EthanDM","id":20825648,"node_id":"MDQ6VXNlcjIwODI1NjQ4","avatar_url":"https://avatars.githubusercontent.com/u/20825648?v=4","gravatar_id":"","url":"https://api.github.com/users/EthanDM","html_url":"https://github.com/EthanDM","followers_url":"https://api.github.com/users/EthanDM/followers","following_url":"https://api.github.com/users/EthanDM/following{/other_user}","gists_url":"https://api.github.com/users/EthanDM/gists{/gist_id}","starred_url":"https://api.github.com/users/EthanDM/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EthanDM/subscriptions","organizations_url":"https://api.github.com/users/EthanDM/orgs","repos_url":"https://api.github.com/users/EthanDM/repos","events_url":"https://api.github.com/users/EthanDM/events{/privacy}","received_events_url":"https://api.github.com/users/EthanDM/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2017-11-30T01:28:18Z","updated_at":"2017-11-30T01:28:18Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/vuejs/vue/issues/7153","repository_url":"https://api.github.com/repos/vuejs/vue","labels_url":"https://api.github.com/repos/vuejs/vue/issues/7153/labels{/name}","comments_url":"https://api.github.com/repos/vuejs/vue/issues/7153/comments","events_url":"https://api.github.com/repos/vuejs/vue/issues/7153/events","html_url":"https://github.com/vuejs/vue/issues/7153","id":277935866,"node_id":"MDU6SXNzdWUyNzc5MzU4NjY=","number":7153,"title":"Input @keydown class binding - Micro/Macro Task","user":{"login":"EthanDM","id":20825648,"node_id":"MDQ6VXNlcjIwODI1NjQ4","avatar_url":"https://avatars.githubusercontent.com/u/20825648?v=4","gravatar_id":"","url":"https://api.github.com/users/EthanDM","html_url":"https://github.com/EthanDM","followers_url":"https://api.github.com/users/EthanDM/followers","following_url":"https://api.github.com/users/EthanDM/following{/other_user}","gists_url":"https://api.github.com/users/EthanDM/gists{/gist_id}","starred_url":"https://api.github.com/users/EthanDM/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EthanDM/subscriptions","organizations_url":"https://api.github.com/users/EthanDM/orgs","repos_url":"https://api.github.com/users/EthanDM/repos","events_url":"https://api.github.com/users/EthanDM/events{/privacy}","received_events_url":"https://api.github.com/users/EthanDM/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2017-11-29T22:48:21Z","updated_at":"2017-11-30T15:48:57Z","closed_at":"2017-11-30T15:48:57Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":11730342,"node_id":"MDEwOlJlcG9zaXRvcnkxMTczMDM0Mg==","name":"vue","full_name":"vuejs/vue","private":false,"owner":{"login":"vuejs","id":6128107,"node_id":"MDEyOk9yZ2FuaXphdGlvbjYxMjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/6128107?v=4","gravatar_id":"","url":"https://api.github.com/users/vuejs","html_url":"https://github.com/vuejs","followers_url":"https://api.github.com/users/vuejs/followers","following_url":"https://api.github.com/users/vuejs/following{/other_user}","gists_url":"https://api.github.com/users/vuejs/gists{/gist_id}","starred_url":"https://api.github.com/users/vuejs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vuejs/subscriptions","organizations_url":"https://api.github.com/users/vuejs/orgs","repos_url":"https://api.github.com/users/vuejs/repos","events_url":"https://api.github.com/users/vuejs/events{/privacy}","received_events_url":"https://api.github.com/users/vuejs/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/vuejs/vue","description":"This is the repo for Vue 2. For Vue 3, go to https://github.com/vuejs/core","fork":false,"url":"https://api.github.com/repos/vuejs/vue","forks_url":"https://api.github.com/repos/vuejs/vue/forks","keys_url":"https://api.github.com/repos/vuejs/vue/keys{/key_id}","collaborators_url":"https://api.github.com/repos/vuejs/vue/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/vuejs/vue/teams","hooks_url":"https://api.github.com/repos/vuejs/vue/hooks","issue_events_url":"https://api.github.com/repos/vuejs/vue/issues/events{/number}","events_url":"https://api.github.com/repos/vuejs/vue/events","assignees_url":"https://api.github.com/repos/vuejs/vue/assignees{/user}","branches_url":"https://api.github.com/repos/vuejs/vue/branches{/branch}","tags_url":"https://api.github.com/repos/vuejs/vue/tags","blobs_url":"https://api.github.com/repos/vuejs/vue/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/vuejs/vue/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/vuejs/vue/git/refs{/sha}","trees_url":"https://api.github.com/repos/vuejs/vue/git/trees{/sha}","statuses_url":"https://api.github.com/repos/vuejs/vue/statuses/{sha}","languages_url":"https://api.github.com/repos/vuejs/vue/languages","stargazers_url":"https://api.github.com/repos/vuejs/vue/stargazers","contributors_url":"https://api.github.com/repos/vuejs/vue/contributors","subscribers_url":"https://api.github.com/repos/vuejs/vue/subscribers","subscription_url":"https://api.github.com/repos/vuejs/vue/subscription","commits_url":"https://api.github.com/repos/vuejs/vue/commits{/sha}","git_commits_url":"https://api.github.com/repos/vuejs/vue/git/commits{/sha}","comments_url":"https://api.github.com/repos/vuejs/vue/comments{/number}","issue_comment_url":"https://api.github.com/repos/vuejs/vue/issues/comments{/number}","contents_url":"https://api.github.com/repos/vuejs/vue/contents/{+path}","compare_url":"https://api.github.com/repos/vuejs/vue/compare/{base}...{head}","merges_url":"https://api.github.com/repos/vuejs/vue/merges","archive_url":"https://api.github.com/repos/vuejs/vue/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/vuejs/vue/downloads","issues_url":"https://api.github.com/repos/vuejs/vue/issues{/number}","pulls_url":"https://api.github.com/repos/vuejs/vue/pulls{/number}","milestones_url":"https://api.github.com/repos/vuejs/vue/milestones{/number}","notifications_url":"https://api.github.com/repos/vuejs/vue/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/vuejs/vue/labels{/name}","releases_url":"https://api.github.com/repos/vuejs/vue/releases{/id}","deployments_url":"https://api.github.com/repos/vuejs/vue/deployments","created_at":"2013-07-29T03:24:51Z","updated_at":"2025-11-09T17:23:38Z","pushed_at":"2024-10-10T07:24:15Z","git_url":"git://github.com/vuejs/vue.git","ssh_url":"git@github.com:vuejs/vue.git","clone_url":"https://github.com/vuejs/vue.git","svn_url":"https://github.com/vuejs/vue","homepage":"http://v2.vuejs.org","size":32152,"stargazers_count":209671,"watchers_count":209671,"language":"TypeScript","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":true,"forks_count":33803,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":612,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["framework","frontend","javascript","vue"],"visibility":"public","forks":33803,"open_issues":612,"watchers":209671,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"### Version\r\n2.5.9\r\n\r\n### Reproduction link\r\n[https://jsfiddle.net/ethandm/21va7wje/](https://jsfiddle.net/ethandm/21va7wje/)\r\n\r\n### Steps to reproduce\r\nEnter a number into the input field. @keydown then fires the keyDwn(e) method, setting this.untouched = false. The green background should be removed on the input field since it has been \"touched.\"\r\n\r\n### What is expected?\r\nThe pressed number should be entered into the input field. Instead, no number is added and it is only after the second press that it is.\r\n\r\nIf the class binding is removed from the input field it has no problem acting as expected, so I don't think it's an issue with @keydown or setting \"this.untouched = false\". In addition, if the class binding is left on and v-model.lazy is set to v-model, it works as expected. However, v-model will not work for my use case.\r\n\r\n### What is actually happening?\r\nThe class binding is set but no number is added to the field as it did in Vue 2.2.6 -> 2.4.4.\r\n\r\nSee here for a reproduction in 2.4.4 and all works as expected with the class binding and v-model.lazy: https://jsfiddle.net/ethandm/8762osgf/\r\n\r\nEDIT: I assume it's related to this release note from v2.5.0:\r\n\r\n> We have changed the implementation of Vue.nextTick to fix a few bugs (related to #6566, #6690). The change involves using a macro task instead of a micro task to defer DOM updates when inside a DOM event handler attached via v-on. This means any Vue updates triggered by state changes inside v-on handlers will be now deferred using a macro task. This may lead to changes in behavior when dealing with native DOM events.\r\n> \r\n> For more details regarding micro/macro tasks, see this blog post.\r\n> \r\n> For the new implementation, see source code for nextTick.\r\n\r\nNow I'm not sure if it's a bug or expected behavior due to the change but will need a solution. Thanks.\r\n\r\n\r\n<!-- generated by vue-issues. DO NOT REMOVE -->","reactions":{"url":"https://api.github.com/repos/vuejs/vue/issues/7153/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/vuejs/vue/issues/7153/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"id":1474454963,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDE0NzQ0NTQ5NjM=","url":"https://api.github.com/repos/vuejs/vue/issues/events/1474454963","actor":{"login":"ztlevi","id":16655096,"node_id":"MDQ6VXNlcjE2NjU1MDk2","avatar_url":"https://avatars.githubusercontent.com/u/16655096?v=4","gravatar_id":"","url":"https://api.github.com/users/ztlevi","html_url":"https://github.com/ztlevi","followers_url":"https://api.github.com/users/ztlevi/followers","following_url":"https://api.github.com/users/ztlevi/following{/other_user}","gists_url":"https://api.github.com/users/ztlevi/gists{/gist_id}","starred_url":"https://api.github.com/users/ztlevi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ztlevi/subscriptions","organizations_url":"https://api.github.com/users/ztlevi/orgs","repos_url":"https://api.github.com/users/ztlevi/repos","events_url":"https://api.github.com/users/ztlevi/events{/privacy}","received_events_url":"https://api.github.com/users/ztlevi/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"4a6a471fc9006c940c6e709c1a1c9de15cd64cf8","commit_url":"https://api.github.com/repos/ztlevi/vue/commits/4a6a471fc9006c940c6e709c1a1c9de15cd64cf8","created_at":"2018-02-14T18:49:54Z","performed_via_github_app":null},{"actor":{"login":"AnnVoV","id":8092366,"node_id":"MDQ6VXNlcjgwOTIzNjY=","avatar_url":"https://avatars.githubusercontent.com/u/8092366?v=4","gravatar_id":"","url":"https://api.github.com/users/AnnVoV","html_url":"https://github.com/AnnVoV","followers_url":"https://api.github.com/users/AnnVoV/followers","following_url":"https://api.github.com/users/AnnVoV/following{/other_user}","gists_url":"https://api.github.com/users/AnnVoV/gists{/gist_id}","starred_url":"https://api.github.com/users/AnnVoV/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AnnVoV/subscriptions","organizations_url":"https://api.github.com/users/AnnVoV/orgs","repos_url":"https://api.github.com/users/AnnVoV/repos","events_url":"https://api.github.com/users/AnnVoV/events{/privacy}","received_events_url":"https://api.github.com/users/AnnVoV/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-04-10T07:48:40Z","updated_at":"2018-04-10T07:48:40Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/kaola-fed/blog/issues/259","repository_url":"https://api.github.com/repos/kaola-fed/blog","labels_url":"https://api.github.com/repos/kaola-fed/blog/issues/259/labels{/name}","comments_url":"https://api.github.com/repos/kaola-fed/blog/issues/259/comments","events_url":"https://api.github.com/repos/kaola-fed/blog/issues/259/events","html_url":"https://github.com/kaola-fed/blog/issues/259","id":312757278,"node_id":"MDU6SXNzdWUzMTI3NTcyNzg=","number":259,"title":"浅析Vue 中的patch和diff(上)","user":{"login":"AnnVoV","id":8092366,"node_id":"MDQ6VXNlcjgwOTIzNjY=","avatar_url":"https://avatars.githubusercontent.com/u/8092366?v=4","gravatar_id":"","url":"https://api.github.com/users/AnnVoV","html_url":"https://github.com/AnnVoV","followers_url":"https://api.github.com/users/AnnVoV/followers","following_url":"https://api.github.com/users/AnnVoV/following{/other_user}","gists_url":"https://api.github.com/users/AnnVoV/gists{/gist_id}","starred_url":"https://api.github.com/users/AnnVoV/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AnnVoV/subscriptions","organizations_url":"https://api.github.com/users/AnnVoV/orgs","repos_url":"https://api.github.com/users/AnnVoV/repos","events_url":"https://api.github.com/users/AnnVoV/events{/privacy}","received_events_url":"https://api.github.com/users/AnnVoV/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":699699638,"node_id":"MDU6TGFiZWw2OTk2OTk2Mzg=","url":"https://api.github.com/repos/kaola-fed/blog/labels/%E5%BE%85%E5%BD%92%E6%A1%A3","name":"待归档","color":"ededed","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-04-10T03:08:07Z","updated_at":"2018-05-29T11:34:16Z","closed_at":null,"author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":46690958,"node_id":"MDEwOlJlcG9zaXRvcnk0NjY5MDk1OA==","name":"blog","full_name":"kaola-fed/blog","private":false,"owner":{"login":"kaola-fed","id":15810303,"node_id":"MDEyOk9yZ2FuaXphdGlvbjE1ODEwMzAz","avatar_url":"https://avatars.githubusercontent.com/u/15810303?v=4","gravatar_id":"","url":"https://api.github.com/users/kaola-fed","html_url":"https://github.com/kaola-fed","followers_url":"https://api.github.com/users/kaola-fed/followers","following_url":"https://api.github.com/users/kaola-fed/following{/other_user}","gists_url":"https://api.github.com/users/kaola-fed/gists{/gist_id}","starred_url":"https://api.github.com/users/kaola-fed/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kaola-fed/subscriptions","organizations_url":"https://api.github.com/users/kaola-fed/orgs","repos_url":"https://api.github.com/users/kaola-fed/repos","events_url":"https://api.github.com/users/kaola-fed/events{/privacy}","received_events_url":"https://api.github.com/users/kaola-fed/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/kaola-fed/blog","description":"kaola blog","fork":false,"url":"https://api.github.com/repos/kaola-fed/blog","forks_url":"https://api.github.com/repos/kaola-fed/blog/forks","keys_url":"https://api.github.com/repos/kaola-fed/blog/keys{/key_id}","collaborators_url":"https://api.github.com/repos/kaola-fed/blog/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/kaola-fed/blog/teams","hooks_url":"https://api.github.com/repos/kaola-fed/blog/hooks","issue_events_url":"https://api.github.com/repos/kaola-fed/blog/issues/events{/number}","events_url":"https://api.github.com/repos/kaola-fed/blog/events","assignees_url":"https://api.github.com/repos/kaola-fed/blog/assignees{/user}","branches_url":"https://api.github.com/repos/kaola-fed/blog/branches{/branch}","tags_url":"https://api.github.com/repos/kaola-fed/blog/tags","blobs_url":"https://api.github.com/repos/kaola-fed/blog/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/kaola-fed/blog/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/kaola-fed/blog/git/refs{/sha}","trees_url":"https://api.github.com/repos/kaola-fed/blog/git/trees{/sha}","statuses_url":"https://api.github.com/repos/kaola-fed/blog/statuses/{sha}","languages_url":"https://api.github.com/repos/kaola-fed/blog/languages","stargazers_url":"https://api.github.com/repos/kaola-fed/blog/stargazers","contributors_url":"https://api.github.com/repos/kaola-fed/blog/contributors","subscribers_url":"https://api.github.com/repos/kaola-fed/blog/subscribers","subscription_url":"https://api.github.com/repos/kaola-fed/blog/subscription","commits_url":"https://api.github.com/repos/kaola-fed/blog/commits{/sha}","git_commits_url":"https://api.github.com/repos/kaola-fed/blog/git/commits{/sha}","comments_url":"https://api.github.com/repos/kaola-fed/blog/comments{/number}","issue_comment_url":"https://api.github.com/repos/kaola-fed/blog/issues/comments{/number}","contents_url":"https://api.github.com/repos/kaola-fed/blog/contents/{+path}","compare_url":"https://api.github.com/repos/kaola-fed/blog/compare/{base}...{head}","merges_url":"https://api.github.com/repos/kaola-fed/blog/merges","archive_url":"https://api.github.com/repos/kaola-fed/blog/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/kaola-fed/blog/downloads","issues_url":"https://api.github.com/repos/kaola-fed/blog/issues{/number}","pulls_url":"https://api.github.com/repos/kaola-fed/blog/pulls{/number}","milestones_url":"https://api.github.com/repos/kaola-fed/blog/milestones{/number}","notifications_url":"https://api.github.com/repos/kaola-fed/blog/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/kaola-fed/blog/labels{/name}","releases_url":"https://api.github.com/repos/kaola-fed/blog/releases{/id}","deployments_url":"https://api.github.com/repos/kaola-fed/blog/deployments","created_at":"2015-11-23T02:04:08Z","updated_at":"2025-08-17T17:46:43Z","pushed_at":"2019-12-17T07:41:42Z","git_url":"git://github.com/kaola-fed/blog.git","ssh_url":"git@github.com:kaola-fed/blog.git","clone_url":"https://github.com/kaola-fed/blog.git","svn_url":"https://github.com/kaola-fed/blog","homepage":"","size":4411,"stargazers_count":720,"watchers_count":720,"language":"JavaScript","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":true,"has_discussions":false,"forks_count":56,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":277,"license":null,"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":[],"visibility":"public","forks":56,"open_issues":277,"watchers":720,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"## 疑问\r\n\r\n1.当我修改了属性值时，vdom立即进行diff,重新渲染视图了吗？\r\n\r\n2.如果1是对的，那重复修改，性能岂不是很差？如果不是，1是如何实现的？\r\n\r\n3.我们的nextTick 具体的实现是怎样的？什么时候需要用到它？\r\n\r\n4.vdom diff的过程是怎样的？\r\n\r\n## 梗概\r\n\r\n关于vue数据更新渲染的几个知识点，先列一下：\r\n\r\n* 数据的更新是实时的，但是渲染是异步的。\r\n\r\n* 一旦数据变化，会把在同一个事件循环event loop中的观察到的watcher 推入一个队列（相同watcher实例不会重复推入）\r\n\r\n* DOM并不是马上更新视图的（想想也不可能，改动一次数据更新一次视图，肯定都是批量操作DOM的），vue 中的nextTick 用到了MicroTask和MacroTask，这需要我们去了解event loop（推荐先阅读下：[Tasks, microtasks, queues and schedules](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)\r\n  ）\r\n\r\n* 整个script是一个主任务, setTimeout 是一个macroTask, promise的回调是microtask, 顺序是\r\n\r\n  主script（第一个主任务） —> microTask （全部执行完）—> UI渲染 —> 下一个macroTask\r\n\r\n  ```javascript\r\n  // 先不看结果，想一下你的输出\r\n  console.log('script start');\r\n\r\n  setTimeout(function() {\r\n    console.log('setTimeout');\r\n  }, 0);\r\n\r\n  Promise.resolve().then(function() {\r\n    console.log('promise1');\r\n  }).then(function() {\r\n    console.log('promise2');\r\n  });\r\n\r\n  console.log('script end');\r\n  // result: \r\n  /**\r\n  * script start\r\n  * script end\r\n  * promise1\r\n  * promise2\r\n  * setTimeout\r\n  */\r\n  ```\r\n\r\n\r\n* 所以dom diff 这个过程是在microtask中去处理的（也有的是强制走macrotask, 本例子走microtask）\r\n* 哪些会走macrotask 哪些会走microtask，为啥要区分，会写在拓展那一小节\r\n\r\n## 例子\r\n接下来，所有的讲解都会围绕下面这个例子\r\n```javascript\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n\t<title></title>\r\n    <style>\r\n        .f-error {\r\n            color: red;\r\n        }\r\n    </style>\r\n</head>\r\n<body>\r\n    <div id=\"test\">\r\n    </div>\r\n    <script type=\"text/javascript\" src=\"./vue.js\"></script>\r\n    <script type=\"x-template\" id=\"temp\">\r\n        <section>\r\n            <div :class=\"{'f-error': a==2}\">{{a+b}}</div>\r\n        </section>\r\n    </script>\r\n    <script type=\"text/javascript\">\r\n        var data = {\r\n            a: 1,\r\n            b: 1\r\n        }\r\n        new Vue({\r\n            el: '#test',\r\n            template: temp,\r\n            data: function() {\r\n                return data;\r\n            },\r\n            mounted() {\r\n                setTimeout(() => {\r\n                    data.a = 2;\r\n                    data.b = 3;\r\n                    this.$nextTick(()=> {\r\n                        console.log(document.querySelector('.f-error'));\r\n                    })\r\n                }, 500);\r\n            }\r\n        });\r\n    </script>\r\n</body>\r\n</html>\r\n```\r\n\r\n## 入口\r\n\r\n#### 当```vm._update(vm._render(), hydrating)```\r\n\r\n经过上一次分享，我们知道通过```vm._render()```方法，我们会获得我们的vdom; 接下去我们进入_update方法；我们看下内部的细节。\r\n\r\n```javascript\r\nVue.prototype._update = function (vnode, hydrating) {\r\n    var vm = this;\r\n    if (vm._isMounted) {\r\n      callHook(vm, 'beforeUpdate');\r\n    }\r\n    ...\r\n    // 初始时，我们是没有prevVnode的， 进入了patch方法\r\n    if (!prevVnode) {\r\n      // initial render\r\n\t  // 初始化渲染，我们看下细节\t\r\n      vm.$el = vm.__patch__(\r\n        vm.$el, vnode, hydrating, false /* removeOnly */,\r\n        vm.$options._parentElm,\r\n        vm.$options._refElm\r\n      );\r\n      // no need for the ref nodes after initial patch\r\n      // this prevents keeping a detached DOM tree in memory (#5851)\r\n      vm.$options._parentElm = vm.$options._refElm = null;\r\n    } else {\r\n      // updates\r\n      vm.$el = vm.__patch__(prevVnode, vnode);\r\n    }\r\n    activeInstance = prevActiveInstance;\r\n    // update __vue__ reference\r\n    if (prevEl) {\r\n      prevEl.__vue__ = null;\r\n    }\r\n    if (vm.$el) {\r\n      vm.$el.__vue__ = vm;\r\n    }\r\n    // if parent is an HOC, update its $el as well\r\n    if (vm.$vnode && vm.$parent && vm.$vnode === vm.$parent._vnode) {\r\n      vm.$parent.$el = vm.$el;\r\n    }\r\n    // updated hook is called by the scheduler to ensure that children are\r\n    // updated in a parent's updated hook.\r\n  };\r\n```\r\n\r\n#### 初始进入patch\r\n\r\n```javascript\r\n// 当我们初始进入patch时，会进入createElm 根据我们的vnode 创建节点\r\nreturn function patch (oldVnode, vnode, hydrating, removeOnly, parentElm, refElm) {\r\n    if (isUndef(vnode)) {\r\n      if (isDef(oldVnode)) { invokeDestroyHook(oldVnode); }\r\n      return\r\n    }\r\n    var isInitialPatch = false;\r\n    var insertedVnodeQueue = [];\r\n\r\n    if (isUndef(oldVnode)) {\r\n      // empty mount (likely as component), create new root element\r\n      isInitialPatch = true;\r\n      createElm(vnode, insertedVnodeQueue, parentElm, refElm);\r\n    } else {\r\n        ...\r\n    }\r\n}\r\n```\r\n\r\n## 数据更新时\r\n\r\n假设我们的数据是```{a:1, b:1}```更新为了```{a:2, b:3}```, 我们下面看下细节\r\n\r\n* a值发生了变化, 进入它的setter ——> 进入 dep.notify() 依赖通知\r\n*  dep.notify() ——> subs[i].update() subs存放的是watcher 实例，进入watcher的update()方法\r\n* watcher.update() ——> 将当前watcher 推入一个队列， 并且将flushSchedulerQueue（冲洗队列）这个动作放入nextTick(一个microtask 中),且将flushSchedulerQueue塞入callback数组\r\n* 继续往下走，b值发生变化，进入它的setter ——> 进入 dep.notify() 依赖通知\r\n* dep.notify() ——> subs[i].update() subs存放的是watcher 实例，进入watcher的update()方法\r\n* watcher.update() ——> 当前watcher已经放入队列，不再放入，继续往下\r\n* 遇到$nextTick(我们的cb) ——> 我们的cb也塞入callback数组\r\n* 主任务（script）全部走完 ——> 开始执行所有microtask\r\n* 开始执行flushCallBacks  ——> flushSchedulerQueue(这里后面有watcher.run()， dom diff, 视图更新) ——> 我们的cb\r\n* 结束\r\n```javascript\r\n/**\r\nmouted() {\r\n    setTimeout(() => {\r\n                    data.a = 2;\r\n                    data.b = 3;\r\n                    this.$nextTick(()=> {\r\n                        console.log(document.querySelector('.f-error'));\r\n                    })\r\n                }, 500);\r\n}\r\n**/\r\n\r\nnew Vue({\r\n\t\tel: '#test',\r\n\t\ttemplate: temp,\r\n\t\tdata: function() {\r\n\t\t\treturn data;\r\n\t\t},\r\n\t\tmethods: {\r\n\t\t\ttest() {\r\n\t\t\t\tdata.a = 2;\r\n\t\t\t\tdata.b = 3;\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n// 当我们data.a 的值改变时，会进入它的setter\r\nset: function reactiveSetter (newVal) {\r\n      var value = getter ? getter.call(obj) : val;\r\n      /* eslint-disable no-self-compare */\r\n      if (newVal === value || (newVal !== newVal && value !== value)) {\r\n        return\r\n      }\r\n      /* eslint-enable no-self-compare */\r\n      if (\"development\" !== 'production' && customSetter) {\r\n        customSetter();\r\n      }\r\n      if (setter) {\r\n        setter.call(obj, newVal);\r\n      } else {\r\n        val = newVal;\r\n      }\r\n      childOb = !shallow && observe(newVal);\r\n      // 当值更新时，dep会通知watcher\r\n      dep.notify();\r\n    }\r\n\r\nDep.prototype.notify = function notify () {\r\n  // stabilize the subscriber list first\r\n  var subs = this.subs.slice();\r\n  // 我们知道subs里面存放着我们的watcher实例， 进入watcher的update方法\t    \r\n  for (var i = 0, l = subs.length; i < l; i++) {\r\n    subs[i].update();\r\n  }\r\n};\r\n\r\nWatcher.prototype.update = function update () {\r\n  /* istanbul ignore else */\r\n  if (this.lazy) {\r\n    this.dirty = true;\r\n  } else if (this.sync) {\r\n    this.run();\r\n  } else {\r\n    // 一般情况下，没有其他配置会进入这里,将我们的watcher推入队列  \r\n    queueWatcher(this);\r\n  }\r\n};\r\n\r\n/**\r\n * Push a watcher into the watcher queue.\r\n * Jobs with duplicate IDs will be skipped unless it's\r\n * pushed when the queue is being flushed.\r\n */\r\nfunction queueWatcher (watcher) {\r\n  var id = watcher.id;\r\n  // 判断这个watcher是否已经放入过队列\r\n  if (has[id] == null) {\r\n    has[id] = true;\r\n    if (!flushing) {\r\n      queue.push(watcher);\r\n    } else {\r\n      // if already flushing, splice the watcher based on its id\r\n      // if already past its id, it will be run next immediately.\r\n      var i = queue.length - 1;\r\n      while (i > index && queue[i].id > watcher.id) {\r\n        i--;\r\n      }\r\n      queue.splice(i + 1, 0, watcher);\r\n    }\r\n    // queue the flush\r\n    if (!waiting) {\r\n      waiting = true;\r\n      // 走到了这里, cb 是flushSchedulerQueue\r\n      nextTick(flushSchedulerQueue);\r\n    }\r\n  }\r\n}\r\n\r\n// 进入了nextTick 方法，这里涉及到EventLoop相关的内容，后面会简单说一下\r\nfunction nextTick (cb, ctx) {\r\n  var _resolve;\r\n  // 将flushSchedulerQueue塞入cb\r\n  callbacks.push(function () {\r\n    if (cb) {\r\n      try {\r\n        cb.call(ctx);\r\n      } catch (e) {\r\n        handleError(e, ctx, 'nextTick');\r\n      }\r\n    } else if (_resolve) {\r\n      _resolve(ctx);\r\n    }\r\n  });\r\n  if (!pending) {\r\n    pending = true;\r\n    // 注意这里，一般情况下使用microTask但某些情境下会强制使用macroTask  \r\n    if (useMacroTask) {\r\n      macroTimerFunc();\r\n    } else {\r\n     // 我们的例子会进入这里， microTimerFunc结果是什么呢？往下看\r\n      microTimerFunc();\r\n    }\r\n  }\r\n  // $flow-disable-line \r\n  if (!cb && typeof Promise !== 'undefined') {\r\n    return new Promise(function (resolve) {\r\n      _resolve = resolve;\r\n    })\r\n  }\r\n}\r\n\r\n// Determine MicroTask defer implementation.\r\n/* istanbul ignore next, $flow-disable-line */\r\nif(typeof Promise !== 'undefined' && isNative(Promise)) {\r\n   var p = Promise.resolve();\r\n    microTimerFunc = function() {\r\n        // 重点注意这里是promise的cb, 是一个microTask, 是在主script执行完才会执行的\r\n        p.then(flushCallbacks);\r\n    } \r\n}\r\n```\r\n\r\ndata.a执行完以后，开始走data.b, 流程都一样，只是当我们遇到watcher的update时有些区别\r\n\r\n```javascript\r\nqueueWatcher(this);\r\nfunction queueWatcher (watcher) {\r\n  var id = watcher.id;\r\n  // 判断这个watcher是否已经放入过队列, 当执行到data.b时已经放入过队列了， 所以不会继续往下走了(这个也很好理解)\r\n  if (has[id] == null) {\r\n    has[id] = true;\r\n    if (!flushing) {\r\n      queue.push(watcher);\r\n    } else {\r\n      // if already flushing, splice the watcher based on its id\r\n      // if already past its id, it will be run next immediately.\r\n      var i = queue.length - 1;\r\n      while (i > index && queue[i].id > watcher.id) {\r\n        i--;\r\n      }\r\n      queue.splice(i + 1, 0, watcher);\r\n    }\r\n    // queue the flush\r\n    if (!waiting) {\r\n      waiting = true;\r\n      // 走到了这里\r\n      nextTick(flushSchedulerQueue);\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n然后进入```this.$nextTick```方法\r\n\r\n```javascript\r\n Vue.prototype.$nextTick = function (fn) {\r\n    return nextTick(fn, this)\r\n  };\r\n\r\nfunction nextTick (cb, ctx) {\r\n  var _resolve;\r\n  // 将我们的cb塞入callbacks\t    \r\n  callbacks.push(function () {\r\n    if (cb) {\r\n      try {\r\n        cb.call(ctx);\r\n      } catch (e) {\r\n        handleError(e, ctx, 'nextTick');\r\n      }\r\n    } else if (_resolve) {\r\n      _resolve(ctx);\r\n    }\r\n  });\r\n  // 因为上一次pending 已经置为true,所以此时不符合条件\r\n  if (!pending) {\r\n    pending = true;\r\n    if (useMacroTask) {\r\n      macroTimerFunc();\r\n    } else {\r\n      microTimerFunc();\r\n    }\r\n  }\r\n  // $flow-disable-line\r\n  if (!cb && typeof Promise !== 'undefined') {\r\n    return new Promise(function (resolve) {\r\n      _resolve = resolve;\r\n    })\r\n  }\r\n}\r\n```\r\n\r\n接下去，就到了我们之前讲到的，主script执行完了开始执行microTask, 进入flushSchedulerQueue方法。（tips: 推荐阅读[Tasks, microtasks, queues and schedules]( https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)更好地了解EventLoop)\r\n\r\n```javascript\r\n//  p.then(flushCallbacks);\r\nfunction flushCallbacks () {\r\n  pending = false;\r\n  var copies = callbacks.slice(0);\r\n  callbacks.length = 0;\r\n  for (var i = 0; i < copies.length; i++) {\r\n    copies[i]();\r\n  }\r\n}\r\n// 开始遍历callbacks 执行其中的cb\r\n// 第一个cb 是 flushSchedulerQueue\r\n// 第二个cb 是 我们的 console.log(document.querySelector('.f-error')); \r\n\r\n// 第一个cb里面，watcher.run 最终会进入vdom的diff, 下一篇具体讲细节\r\nfunction flushSchedulerQueue () {\r\n  flushing = true;\r\n  var watcher, id;\r\n   ...\r\n  // do not cache length because more watchers might be pushed\r\n  // as we run existing watchers\r\n  for (index = 0; index < queue.length; index++) {\r\n    watcher = queue[index];\r\n    id = watcher.id;\r\n    has[id] = null;\r\n    watcher.run();\r\n    // in dev build, check and stop circular updates.\r\n    ...\r\n  }\r\n\r\n  // keep copies of post queues before resetting state\r\n  var activatedQueue = activatedChildren.slice();\r\n  var updatedQueue = queue.slice();\r\n  resetSchedulerState();\r\n\r\n  // call component updated and activated hooks\r\n  callActivatedHooks(activatedQueue);\r\n  callUpdatedHooks(updatedQueue);\r\n\r\n  // devtool hook\r\n  /* istanbul ignore if */\r\n  if (devtools && config.devtools) {\r\n    devtools.emit('flush');\r\n  }\r\n}\r\n// 然后执行了我们的cb, 此时视图已经更新\r\n// <div class='f-error'>5</div>    \r\n```\r\n\r\n## 总结\r\n\r\n这一篇blog主要是为了让大家清楚\r\n\r\n* 1.当数据更新时会将watcher 推入一个队列\r\n* 2.当多个数据更新时，更新完不会立即更新视图\r\n* 3.视图更新发生在nextTick, 利用microTask 实现\r\n* 4.vdom 如何进行diff的将放在下一篇\r\n\r\n## 拓展\r\n\r\n###  思考1：不用nextTick\r\n\r\n如果很好地理解了micoTask 与 macroTask之间的关系，那么也能很清楚的理解假设我们写成下面这样, 为什么不行了，自己试试喽！下一篇，会细致讲解vdom diff 的过程~\r\n\r\n```javascript\r\nmounted() {\r\n                setTimeout(() => {\r\n                    data.a = 2;\r\n                    data.b = 3;\r\n                    console.log(document.querySelector('.f-error'));\r\n                }, 500);\r\n            }\r\n```\r\n\r\n### 思考2： 如果都用MicroTask有什么问题？\r\n\r\n看下这个issue, [@click would trigger event other vnode @click event. #6566](https://github.com/vuejs/vue/issues/6566)\r\n\r\n贴一下代码，**vue的版本是2.4.2**，在此版本下当你点击了‘expand is true’以后，expand click 和 off click都打印出来了，countA与countB都变成了1，文案还是expand is true\r\n\r\n```javascript\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n    <meta charset=\"utf-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width\">\r\n    <title>JS Bin</title>\r\n    <!--<script src=\"https://unpkg.com/vue@2.4.2/dist/vue.js\"></script>-->\r\n    <script src=\"./vue2.4.js\"></script>\r\n</head>\r\n<body>\r\n<div class=\"panel\" id=\"app\">\r\n    <div class=\"header\" v-if=\"expand\">\r\n        <i @click=\"expandClick\">Expand is True</i>\r\n    </div>\r\n\t<!-- 注意这里@click 绑定到了外层 -->\r\n    <div class=\"expand\" v-if=\"!expand\" @click=\"offClick\">\r\n        <i>Expand is False</i>\r\n    </div>\r\n    <div>\r\n        countA: {{countA}}\r\n    </div>\r\n    <div>\r\n        countB: {{countB}}\r\n    </div>\r\n    <div>\r\n        expand: {{expand}}\r\n    </div>\r\n    Please Click `Expand is Ture`.\r\n</div>\r\n</body>\r\n\r\n<script>\r\n    debugger;\r\n    new Vue({\r\n        el: '#app',\r\n        data: {\r\n            expand: true,\r\n            countA: 0,\r\n            countB: 0,\r\n        },\r\n        methods: {\r\n            expandClick() {\r\n                this.expand = false;\r\n                this.countA++;\r\n                console.log('expand click');\r\n            },\r\n            offClick() {\r\n                this.expand = true;\r\n                this.countB++;\r\n                console.log('off click');\r\n            }\r\n        }\r\n    })\r\n</script>\r\n</html>\r\n```\r\n\r\n![](https://haitao.nos.netease.com/825e41f1-3d92-48d2-8661-167c4034457d.jpeg)\r\n\r\n尤大在这个issue下面给了回答，引一下:\r\n\r\n![](https://haitao.nos.netease.com/80e01bdd-2e68-4223-ae18-7f38ed5faf59.png)\r\n\r\n大致原因是：```<i>```标签的点击动作触发了第一次nextTick(microTask), 然后我们得到了新的vdom并进行了渲染；microTask先于冒泡这个task，在microTask生成新dom的过程中，外层div添加了listener; 渲染完成后，冒泡触发了新的listener，所以又进入了新的cb。所以在Vue2.5版本中你会看到event handler使用了macroTask进行包裹\r\n\r\n```javascript\r\n/** Vue.js v2.5.13 **/\r\nfunction add$1 (\r\n  event,\r\n  handler,\r\n  once$$1,\r\n  capture,\r\n  passive\r\n) {\r\n  // 看这里\t      \r\n  handler = withMacroTask(handler);\r\n  if (once$$1) { handler = createOnceHandler(handler, event, capture); }\r\n  target$1.addEventListener(\r\n    event,\r\n    handler,\r\n    supportsPassive\r\n      ? { capture: capture, passive: passive }\r\n      : capture\r\n  );\r\n}\r\n\r\n/**\r\n * Wrap a function so that if any code inside triggers state change,\r\n * the changes are queued using a Task instead of a MicroTask.\r\n */\r\nfunction withMacroTask (fn) {\r\n  return fn._withTask || (fn._withTask = function () {\r\n    useMacroTask = true;\r\n    var res = fn.apply(null, arguments);\r\n    useMacroTask = false;\r\n    return res\r\n  })\r\n}\r\n```\r\n\r\n\r\n\r\n## 参考资料\r\n1.vue2.0 正确理解Vue.nextTick()的用途 http://www.cnblogs.com/minigrasshopper/p/7879545.html\r\n2.从event loop规范探究javaScript异步及浏览器更新渲染时机 https://github.com/aooy/blog/issues/5\r\n3.Promise的队列与setTimeout的队列有何关联？https://www.zhihu.com/question/36972010/answer/71338002\r\n4.JavaScript 运行机制详解：再谈Event Loop http://www.ruanyifeng.com/blog/2014/10/event-loop.html\r\n5.Vue源码详解之nextTick：MutationObserver只是浮云，microtask才是核心！https://github.com/Ma63d/vue-analysis/issues/6\r\nhttps://chuckliu.me/#!/posts/58bd08a2b5187d2fb51c04f9\r\n6.Tasks, microtasks, queues and schedules https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/\r\n7.@click would trigger event other vnode @click event. #6566 https://github.com/vuejs/vue/issues/6566","reactions":{"url":"https://api.github.com/repos/kaola-fed/blog/issues/259/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/kaola-fed/blog/issues/259/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"actor":{"login":"AnnVoV","id":8092366,"node_id":"MDQ6VXNlcjgwOTIzNjY=","avatar_url":"https://avatars.githubusercontent.com/u/8092366?v=4","gravatar_id":"","url":"https://api.github.com/users/AnnVoV","html_url":"https://github.com/AnnVoV","followers_url":"https://api.github.com/users/AnnVoV/followers","following_url":"https://api.github.com/users/AnnVoV/following{/other_user}","gists_url":"https://api.github.com/users/AnnVoV/gists{/gist_id}","starred_url":"https://api.github.com/users/AnnVoV/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AnnVoV/subscriptions","organizations_url":"https://api.github.com/users/AnnVoV/orgs","repos_url":"https://api.github.com/users/AnnVoV/repos","events_url":"https://api.github.com/users/AnnVoV/events{/privacy}","received_events_url":"https://api.github.com/users/AnnVoV/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-04-10T08:17:42Z","updated_at":"2018-04-10T08:17:42Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/AnnVoV/blog/issues/2","repository_url":"https://api.github.com/repos/AnnVoV/blog","labels_url":"https://api.github.com/repos/AnnVoV/blog/issues/2/labels{/name}","comments_url":"https://api.github.com/repos/AnnVoV/blog/issues/2/comments","events_url":"https://api.github.com/repos/AnnVoV/blog/issues/2/events","html_url":"https://github.com/AnnVoV/blog/issues/2","id":312757516,"node_id":"MDU6SXNzdWUzMTI3NTc1MTY=","number":2,"title":"浅析Vue 中的patch和diff(上)","user":{"login":"AnnVoV","id":8092366,"node_id":"MDQ6VXNlcjgwOTIzNjY=","avatar_url":"https://avatars.githubusercontent.com/u/8092366?v=4","gravatar_id":"","url":"https://api.github.com/users/AnnVoV","html_url":"https://github.com/AnnVoV","followers_url":"https://api.github.com/users/AnnVoV/followers","following_url":"https://api.github.com/users/AnnVoV/following{/other_user}","gists_url":"https://api.github.com/users/AnnVoV/gists{/gist_id}","starred_url":"https://api.github.com/users/AnnVoV/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AnnVoV/subscriptions","organizations_url":"https://api.github.com/users/AnnVoV/orgs","repos_url":"https://api.github.com/users/AnnVoV/repos","events_url":"https://api.github.com/users/AnnVoV/events{/privacy}","received_events_url":"https://api.github.com/users/AnnVoV/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":893400418,"node_id":"MDU6TGFiZWw4OTM0MDA0MTg=","url":"https://api.github.com/repos/AnnVoV/blog/labels/mvvm","name":"mvvm","color":"bf630d","default":false,"description":""},{"id":896385125,"node_id":"MDU6TGFiZWw4OTYzODUxMjU=","url":"https://api.github.com/repos/AnnVoV/blog/labels/vue","name":"vue","color":"0e8a16","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-04-10T03:09:39Z","updated_at":"2019-04-08T10:06:18Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":128494456,"node_id":"MDEwOlJlcG9zaXRvcnkxMjg0OTQ0NTY=","name":"blog","full_name":"AnnVoV/blog","private":false,"owner":{"login":"AnnVoV","id":8092366,"node_id":"MDQ6VXNlcjgwOTIzNjY=","avatar_url":"https://avatars.githubusercontent.com/u/8092366?v=4","gravatar_id":"","url":"https://api.github.com/users/AnnVoV","html_url":"https://github.com/AnnVoV","followers_url":"https://api.github.com/users/AnnVoV/followers","following_url":"https://api.github.com/users/AnnVoV/following{/other_user}","gists_url":"https://api.github.com/users/AnnVoV/gists{/gist_id}","starred_url":"https://api.github.com/users/AnnVoV/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AnnVoV/subscriptions","organizations_url":"https://api.github.com/users/AnnVoV/orgs","repos_url":"https://api.github.com/users/AnnVoV/repos","events_url":"https://api.github.com/users/AnnVoV/events{/privacy}","received_events_url":"https://api.github.com/users/AnnVoV/received_events","type":"User","user_view_type":"public","site_admin":false},"html_url":"https://github.com/AnnVoV/blog","description":null,"fork":false,"url":"https://api.github.com/repos/AnnVoV/blog","forks_url":"https://api.github.com/repos/AnnVoV/blog/forks","keys_url":"https://api.github.com/repos/AnnVoV/blog/keys{/key_id}","collaborators_url":"https://api.github.com/repos/AnnVoV/blog/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/AnnVoV/blog/teams","hooks_url":"https://api.github.com/repos/AnnVoV/blog/hooks","issue_events_url":"https://api.github.com/repos/AnnVoV/blog/issues/events{/number}","events_url":"https://api.github.com/repos/AnnVoV/blog/events","assignees_url":"https://api.github.com/repos/AnnVoV/blog/assignees{/user}","branches_url":"https://api.github.com/repos/AnnVoV/blog/branches{/branch}","tags_url":"https://api.github.com/repos/AnnVoV/blog/tags","blobs_url":"https://api.github.com/repos/AnnVoV/blog/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/AnnVoV/blog/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/AnnVoV/blog/git/refs{/sha}","trees_url":"https://api.github.com/repos/AnnVoV/blog/git/trees{/sha}","statuses_url":"https://api.github.com/repos/AnnVoV/blog/statuses/{sha}","languages_url":"https://api.github.com/repos/AnnVoV/blog/languages","stargazers_url":"https://api.github.com/repos/AnnVoV/blog/stargazers","contributors_url":"https://api.github.com/repos/AnnVoV/blog/contributors","subscribers_url":"https://api.github.com/repos/AnnVoV/blog/subscribers","subscription_url":"https://api.github.com/repos/AnnVoV/blog/subscription","commits_url":"https://api.github.com/repos/AnnVoV/blog/commits{/sha}","git_commits_url":"https://api.github.com/repos/AnnVoV/blog/git/commits{/sha}","comments_url":"https://api.github.com/repos/AnnVoV/blog/comments{/number}","issue_comment_url":"https://api.github.com/repos/AnnVoV/blog/issues/comments{/number}","contents_url":"https://api.github.com/repos/AnnVoV/blog/contents/{+path}","compare_url":"https://api.github.com/repos/AnnVoV/blog/compare/{base}...{head}","merges_url":"https://api.github.com/repos/AnnVoV/blog/merges","archive_url":"https://api.github.com/repos/AnnVoV/blog/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/AnnVoV/blog/downloads","issues_url":"https://api.github.com/repos/AnnVoV/blog/issues{/number}","pulls_url":"https://api.github.com/repos/AnnVoV/blog/pulls{/number}","milestones_url":"https://api.github.com/repos/AnnVoV/blog/milestones{/number}","notifications_url":"https://api.github.com/repos/AnnVoV/blog/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/AnnVoV/blog/labels{/name}","releases_url":"https://api.github.com/repos/AnnVoV/blog/releases{/id}","deployments_url":"https://api.github.com/repos/AnnVoV/blog/deployments","created_at":"2018-04-07T03:57:21Z","updated_at":"2024-05-23T02:27:38Z","pushed_at":"2018-05-27T13:51:22Z","git_url":"git://github.com/AnnVoV/blog.git","ssh_url":"git@github.com:AnnVoV/blog.git","clone_url":"https://github.com/AnnVoV/blog.git","svn_url":"https://github.com/AnnVoV/blog","homepage":null,"size":1217,"stargazers_count":24,"watchers_count":24,"language":"JavaScript","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":false,"forks_count":2,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":31,"license":null,"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":[],"visibility":"public","forks":2,"open_issues":31,"watchers":24,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"## 疑问\r\n\r\n1.当我修改了属性值时，vdom立即进行diff,重新渲染视图了吗？\r\n\r\n2.如果1是对的，那重复修改，性能岂不是很差？如果不是，1是如何实现的？\r\n\r\n3.我们的nextTick 具体的实现是怎样的？什么时候需要用到它？\r\n\r\n4.vdom diff的过程是怎样的？\r\n\r\n## 梗概\r\n\r\n关于vue数据更新渲染的几个知识点，先列一下：\r\n\r\n* 数据的更新是实时的，但是渲染是异步的。\r\n\r\n* 一旦数据变化，会把在同一个事件循环event loop中的观察到的watcher 推入一个队列（相同watcher实例不会重复推入）\r\n\r\n* DOM并不是马上更新视图的（想想也不可能，改动一次数据更新一次视图，肯定都是批量操作DOM的），vue 中的nextTick 用到了MicroTask和MacroTask，这需要我们去了解event loop（推荐先阅读下：[Tasks, microtasks, queues and schedules](https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)\r\n  ）\r\n\r\n![](http://www.ruanyifeng.com/blogimg/asset/2014/bg2014100802.png)\r\n\r\n* 整个script是一个主任务, setTimeout 是一个macroTask, promise的回调是microtask, 顺序是:\r\n  主任务Task —> Task为空开始 microTask （全部执行完）—> UI渲染 —> 取一个macroTask执行\r\n\r\n  ```javascript\r\n  // 先不看结果，想一下你的输出\r\n  console.log('script start');\r\n\r\n  setTimeout(function() {\r\n    console.log('setTimeout');\r\n  }, 0);\r\n\r\n  Promise.resolve().then(function() {\r\n    console.log('promise1');\r\n  }).then(function() {\r\n    console.log('promise2');\r\n  });\r\n\r\n  console.log('script end');\r\n  // result: \r\n  /**\r\n  * script start\r\n  * script end\r\n  * promise1\r\n  * promise2\r\n  * setTimeout\r\n  */\r\n  ```\r\n\r\n\r\n* 所以dom diff 这个过程是在microtask中去处理的（也有的是强制走macrotask, 本例子走microtask）\r\n* 哪些会走macrotask 哪些会走microtask，为啥要区分，会写在拓展那一小节\r\n\r\n## 例子\r\n接下来，所有的讲解都会围绕下面这个例子\r\n```javascript\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n\t<title></title>\r\n    <style>\r\n        .f-error {\r\n            color: red;\r\n        }\r\n    </style>\r\n</head>\r\n<body>\r\n    <div id=\"test\">\r\n    </div>\r\n    <script type=\"text/javascript\" src=\"./vue.js\"></script>\r\n    <script type=\"x-template\" id=\"temp\">\r\n        <section>\r\n            <div :class=\"{'f-error': a==2}\">{{a+b}}</div>\r\n        </section>\r\n    </script>\r\n    <script type=\"text/javascript\">\r\n        var data = {\r\n            a: 1,\r\n            b: 1\r\n        }\r\n        new Vue({\r\n            el: '#test',\r\n            template: temp,\r\n            data: function() {\r\n                return data;\r\n            },\r\n            mounted() {\r\n                setTimeout(() => {\r\n                    data.a = 2;\r\n                    data.b = 3;\r\n                    this.$nextTick(()=> {\r\n                        console.log(document.querySelector('.f-error'));\r\n                    })\r\n                }, 500);\r\n            }\r\n        });\r\n    </script>\r\n</body>\r\n</html>\r\n```\r\n\r\n## 入口\r\n\r\n#### 当```vm._update(vm._render(), hydrating)```\r\n\r\n经过上一次分享，我们知道通过```vm._render()```方法，我们会获得我们的vdom; 接下去我们进入_update方法；我们看下内部的细节。\r\n\r\n```javascript\r\nVue.prototype._update = function (vnode, hydrating) {\r\n    var vm = this;\r\n    if (vm._isMounted) {\r\n      callHook(vm, 'beforeUpdate');\r\n    }\r\n    ...\r\n    // 初始时，我们是没有prevVnode的， 进入了patch方法\r\n    if (!prevVnode) {\r\n      // initial render\r\n\t  // 初始化渲染，我们看下细节\t\r\n      vm.$el = vm.__patch__(\r\n        vm.$el, vnode, hydrating, false /* removeOnly */,\r\n        vm.$options._parentElm,\r\n        vm.$options._refElm\r\n      );\r\n      // no need for the ref nodes after initial patch\r\n      // this prevents keeping a detached DOM tree in memory (#5851)\r\n      vm.$options._parentElm = vm.$options._refElm = null;\r\n    } else {\r\n      // updates\r\n      vm.$el = vm.__patch__(prevVnode, vnode);\r\n    }\r\n    activeInstance = prevActiveInstance;\r\n    // update __vue__ reference\r\n    if (prevEl) {\r\n      prevEl.__vue__ = null;\r\n    }\r\n    if (vm.$el) {\r\n      vm.$el.__vue__ = vm;\r\n    }\r\n    // if parent is an HOC, update its $el as well\r\n    if (vm.$vnode && vm.$parent && vm.$vnode === vm.$parent._vnode) {\r\n      vm.$parent.$el = vm.$el;\r\n    }\r\n    // updated hook is called by the scheduler to ensure that children are\r\n    // updated in a parent's updated hook.\r\n  };\r\n```\r\n\r\n#### 初始进入patch\r\n\r\n```javascript\r\n// 当我们初始进入patch时，会进入createElm 根据我们的vnode 创建节点\r\nreturn function patch (oldVnode, vnode, hydrating, removeOnly, parentElm, refElm) {\r\n    if (isUndef(vnode)) {\r\n      if (isDef(oldVnode)) { invokeDestroyHook(oldVnode); }\r\n      return\r\n    }\r\n    var isInitialPatch = false;\r\n    var insertedVnodeQueue = [];\r\n\r\n    if (isUndef(oldVnode)) {\r\n      // empty mount (likely as component), create new root element\r\n      isInitialPatch = true;\r\n      createElm(vnode, insertedVnodeQueue, parentElm, refElm);\r\n    } else {\r\n        ...\r\n    }\r\n}\r\n```\r\n\r\n## 数据更新时\r\n\r\n假设我们的数据是```{a:1, b:1}```更新为了```{a:2, b:3}```, 我们下面看下细节\r\n\r\n* a值发生了变化, 进入它的setter ——> 进入 dep.notify() 依赖通知\r\n*  dep.notify() ——> subs[i].update() subs存放的是watcher 实例，进入watcher的update()方法\r\n* watcher.update() ——> 将当前watcher 推入一个队列， 并且将flushSchedulerQueue（冲洗队列）这个动作放入nextTick(一个microtask 中),且将flushSchedulerQueue塞入callback数组\r\n* 继续往下走，b值发生变化，进入它的setter ——> 进入 dep.notify() 依赖通知\r\n* dep.notify() ——> subs[i].update() subs存放的是watcher 实例，进入watcher的update()方法\r\n* watcher.update() ——> 当前watcher已经放入队列，不再放入，继续往下\r\n* 遇到$nextTick(我们的cb) ——> 我们的cb也塞入callback数组\r\n* 主任务（script）全部走完 ——> 开始执行所有microtask\r\n* 开始执行flushCallBacks  ——> flushSchedulerQueue(这里后面有watcher.run()， dom diff, 视图更新) ——> 我们的cb\r\n* 结束\r\n```javascript\r\n/**\r\nmouted() {\r\n    setTimeout(() => {\r\n                    data.a = 2;\r\n                    data.b = 3;\r\n                    this.$nextTick(()=> {\r\n                        console.log(document.querySelector('.f-error'));\r\n                    })\r\n                }, 500);\r\n}\r\n**/\r\n\r\nnew Vue({\r\n\t\tel: '#test',\r\n\t\ttemplate: temp,\r\n\t\tdata: function() {\r\n\t\t\treturn data;\r\n\t\t},\r\n\t\tmethods: {\r\n\t\t\ttest() {\r\n\t\t\t\tdata.a = 2;\r\n\t\t\t\tdata.b = 3;\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n\r\n// 当我们data.a 的值改变时，会进入它的setter\r\nset: function reactiveSetter (newVal) {\r\n      var value = getter ? getter.call(obj) : val;\r\n      /* eslint-disable no-self-compare */\r\n      if (newVal === value || (newVal !== newVal && value !== value)) {\r\n        return\r\n      }\r\n      /* eslint-enable no-self-compare */\r\n      if (\"development\" !== 'production' && customSetter) {\r\n        customSetter();\r\n      }\r\n      if (setter) {\r\n        setter.call(obj, newVal);\r\n      } else {\r\n        val = newVal;\r\n      }\r\n      childOb = !shallow && observe(newVal);\r\n      // 当值更新时，dep会通知watcher\r\n      dep.notify();\r\n    }\r\n\r\nDep.prototype.notify = function notify () {\r\n  // stabilize the subscriber list first\r\n  var subs = this.subs.slice();\r\n  // 我们知道subs里面存放着我们的watcher实例， 进入watcher的update方法\t    \r\n  for (var i = 0, l = subs.length; i < l; i++) {\r\n    subs[i].update();\r\n  }\r\n};\r\n\r\nWatcher.prototype.update = function update () {\r\n  /* istanbul ignore else */\r\n  if (this.lazy) {\r\n    this.dirty = true;\r\n  } else if (this.sync) {\r\n    this.run();\r\n  } else {\r\n    // 一般情况下，没有其他配置会进入这里,将我们的watcher推入队列  \r\n    queueWatcher(this);\r\n  }\r\n};\r\n\r\n/**\r\n * Push a watcher into the watcher queue.\r\n * Jobs with duplicate IDs will be skipped unless it's\r\n * pushed when the queue is being flushed.\r\n */\r\nfunction queueWatcher (watcher) {\r\n  var id = watcher.id;\r\n  // 判断这个watcher是否已经放入过队列\r\n  if (has[id] == null) {\r\n    has[id] = true;\r\n    if (!flushing) {\r\n      queue.push(watcher);\r\n    } else {\r\n      // if already flushing, splice the watcher based on its id\r\n      // if already past its id, it will be run next immediately.\r\n      var i = queue.length - 1;\r\n      while (i > index && queue[i].id > watcher.id) {\r\n        i--;\r\n      }\r\n      queue.splice(i + 1, 0, watcher);\r\n    }\r\n    // queue the flush\r\n    if (!waiting) {\r\n      waiting = true;\r\n      // 走到了这里, cb 是flushSchedulerQueue\r\n      nextTick(flushSchedulerQueue);\r\n    }\r\n  }\r\n}\r\n\r\n// 进入了nextTick 方法，这里涉及到EventLoop相关的内容，后面会简单说一下\r\nfunction nextTick (cb, ctx) {\r\n  var _resolve;\r\n  // 将flushSchedulerQueue塞入cb\r\n  callbacks.push(function () {\r\n    if (cb) {\r\n      try {\r\n        cb.call(ctx);\r\n      } catch (e) {\r\n        handleError(e, ctx, 'nextTick');\r\n      }\r\n    } else if (_resolve) {\r\n      _resolve(ctx);\r\n    }\r\n  });\r\n  if (!pending) {\r\n    pending = true;\r\n    // 注意这里，一般情况下使用microTask但某些情境下会强制使用macroTask  \r\n    if (useMacroTask) {\r\n      macroTimerFunc();\r\n    } else {\r\n     // 我们的例子会进入这里， microTimerFunc结果是什么呢？往下看\r\n      microTimerFunc();\r\n    }\r\n  }\r\n  // $flow-disable-line \r\n  if (!cb && typeof Promise !== 'undefined') {\r\n    return new Promise(function (resolve) {\r\n      _resolve = resolve;\r\n    })\r\n  }\r\n}\r\n\r\n// Determine MicroTask defer implementation.\r\n/* istanbul ignore next, $flow-disable-line */\r\nif(typeof Promise !== 'undefined' && isNative(Promise)) {\r\n   var p = Promise.resolve();\r\n    microTimerFunc = function() {\r\n        // 重点注意这里是promise的cb, 是一个microTask, 是在主script执行完才会执行的\r\n        p.then(flushCallbacks);\r\n    } \r\n}\r\n```\r\n\r\ndata.a执行完以后，开始走data.b, 流程都一样，只是当我们遇到watcher的update时有些区别\r\n\r\n```javascript\r\nqueueWatcher(this);\r\nfunction queueWatcher (watcher) {\r\n  var id = watcher.id;\r\n  // 判断这个watcher是否已经放入过队列, 当执行到data.b时已经放入过队列了， 所以不会继续往下走了(这个也很好理解)\r\n  if (has[id] == null) {\r\n    has[id] = true;\r\n    if (!flushing) {\r\n      queue.push(watcher);\r\n    } else {\r\n      // if already flushing, splice the watcher based on its id\r\n      // if already past its id, it will be run next immediately.\r\n      var i = queue.length - 1;\r\n      while (i > index && queue[i].id > watcher.id) {\r\n        i--;\r\n      }\r\n      queue.splice(i + 1, 0, watcher);\r\n    }\r\n    // queue the flush\r\n    if (!waiting) {\r\n      waiting = true;\r\n      // 走到了这里\r\n      nextTick(flushSchedulerQueue);\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n然后进入```this.$nextTick```方法\r\n\r\n```javascript\r\n Vue.prototype.$nextTick = function (fn) {\r\n    return nextTick(fn, this)\r\n  };\r\n\r\nfunction nextTick (cb, ctx) {\r\n  var _resolve;\r\n  // 将我们的cb塞入callbacks\t    \r\n  callbacks.push(function () {\r\n    if (cb) {\r\n      try {\r\n        cb.call(ctx);\r\n      } catch (e) {\r\n        handleError(e, ctx, 'nextTick');\r\n      }\r\n    } else if (_resolve) {\r\n      _resolve(ctx);\r\n    }\r\n  });\r\n  // 因为上一次pending 已经置为true,所以此时不符合条件\r\n  if (!pending) {\r\n    pending = true;\r\n    if (useMacroTask) {\r\n      macroTimerFunc();\r\n    } else {\r\n      microTimerFunc();\r\n    }\r\n  }\r\n  // $flow-disable-line\r\n  if (!cb && typeof Promise !== 'undefined') {\r\n    return new Promise(function (resolve) {\r\n      _resolve = resolve;\r\n    })\r\n  }\r\n}\r\n```\r\n\r\n接下去，就到了我们之前讲到的，主script执行完了开始执行microTask, 进入flushSchedulerQueue方法。（tips: 推荐阅读[Tasks, microtasks, queues and schedules]( https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/)更好地了解EventLoop)\r\n\r\n```javascript\r\n//  p.then(flushCallbacks);\r\nfunction flushCallbacks () {\r\n  pending = false;\r\n  var copies = callbacks.slice(0);\r\n  callbacks.length = 0;\r\n  for (var i = 0; i < copies.length; i++) {\r\n    copies[i]();\r\n  }\r\n}\r\n// 开始遍历callbacks 执行其中的cb\r\n// 第一个cb 是 flushSchedulerQueue\r\n// 第二个cb 是 我们的 console.log(document.querySelector('.f-error')); \r\n\r\n// 第一个cb里面，watcher.run 最终会进入vdom的diff, 下一篇具体讲细节\r\nfunction flushSchedulerQueue () {\r\n  flushing = true;\r\n  var watcher, id;\r\n   ...\r\n  // do not cache length because more watchers might be pushed\r\n  // as we run existing watchers\r\n  for (index = 0; index < queue.length; index++) {\r\n    watcher = queue[index];\r\n    id = watcher.id;\r\n    has[id] = null;\r\n    watcher.run();\r\n    // in dev build, check and stop circular updates.\r\n    ...\r\n  }\r\n\r\n  // keep copies of post queues before resetting state\r\n  var activatedQueue = activatedChildren.slice();\r\n  var updatedQueue = queue.slice();\r\n  resetSchedulerState();\r\n\r\n  // call component updated and activated hooks\r\n  callActivatedHooks(activatedQueue);\r\n  callUpdatedHooks(updatedQueue);\r\n\r\n  // devtool hook\r\n  /* istanbul ignore if */\r\n  if (devtools && config.devtools) {\r\n    devtools.emit('flush');\r\n  }\r\n}\r\n// 然后执行了我们的cb, 此时视图已经更新\r\n// <div class='f-error'>5</div>    \r\n```\r\n\r\n## 总结\r\n\r\n这一篇blog主要是为了让大家清楚\r\n\r\n* 1.当数据更新时会将watcher 推入一个队列\r\n* 2.当多个数据更新时，更新完不会立即更新视图\r\n* 3.视图更新发生在nextTick, 利用microTask 实现\r\n* 4.vdom 如何进行diff的将放在下一篇\r\n\r\n## 拓展\r\n\r\n### 思考1：不用nextTick\r\n\r\n如果很好地理解了micoTask 与 macroTask之间的关系，那么也能很清楚的理解假设我们写成下面这样, 为什么不行了，自己试试喽！下一篇，会细致讲解vdom diff 的过程~\r\n\r\n```javascript\r\nmounted() {\r\n                setTimeout(() => {\r\n                    data.a = 2;\r\n                    data.b = 3;\r\n                    console.log(document.querySelector('.f-error'));\r\n                }, 500);\r\n            }\r\n```\r\n\r\n###  思考2： 如果都用MicroTask有什么问题？\r\n\r\n看下这个issue, [@click would trigger event other vnode @click event. #6566](https://github.com/vuejs/vue/issues/6566)\r\n\r\n贴一下代码，**vue的版本是2.4.2**，在此版本下当你点击了‘expand is true’以后，expand click 和 off click都打印出来了，countA与countB都变成了1，文案还是expand is true\r\n\r\n```javascript\r\n<!DOCTYPE html>\r\n<html>\r\n<head>\r\n    <meta charset=\"utf-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width\">\r\n    <title>JS Bin</title>\r\n    <!--<script src=\"https://unpkg.com/vue@2.4.2/dist/vue.js\"></script>-->\r\n    <script src=\"./vue2.4.js\"></script>\r\n</head>\r\n<body>\r\n<div class=\"panel\" id=\"app\">\r\n    <div class=\"header\" v-if=\"expand\">\r\n        <i @click=\"expandClick\">Expand is True</i>\r\n    </div>\r\n\t<!-- 注意这里@click 绑定到了外层 -->\r\n    <div class=\"expand\" v-if=\"!expand\" @click=\"offClick\">\r\n        <i>Expand is False</i>\r\n    </div>\r\n    <div>\r\n        countA: {{countA}}\r\n    </div>\r\n    <div>\r\n        countB: {{countB}}\r\n    </div>\r\n    <div>\r\n        expand: {{expand}}\r\n    </div>\r\n    Please Click `Expand is Ture`.\r\n</div>\r\n</body>\r\n\r\n<script>\r\n    debugger;\r\n    new Vue({\r\n        el: '#app',\r\n        data: {\r\n            expand: true,\r\n            countA: 0,\r\n            countB: 0,\r\n        },\r\n        methods: {\r\n            expandClick() {\r\n                this.expand = false;\r\n                this.countA++;\r\n                console.log('expand click');\r\n            },\r\n            offClick() {\r\n                this.expand = true;\r\n                this.countB++;\r\n                console.log('off click');\r\n            }\r\n        }\r\n    })\r\n</script>\r\n</html>\r\n```\r\n\r\n![](https://haitao.nos.netease.com/825e41f1-3d92-48d2-8661-167c4034457d.jpeg)\r\n\r\n尤大在这个issue下面给了回答，引一下:\r\n\r\n![](https://haitao.nos.netease.com/80e01bdd-2e68-4223-ae18-7f38ed5faf59.png)\r\n\r\n大致原因是：```<i>```标签的点击动作触发了第一次nextTick(microTask), 然后我们得到了新的vdom并进行了渲染；microTask先于冒泡这个task，在microTask生成新dom的过程中，外层div添加了listener; 渲染完成后，冒泡触发了新的listener，所以又进入了新的cb。所以在Vue2.5版本中你会看到event handler使用了macroTask进行包裹\r\n\r\n```javascript\r\n/** Vue.js v2.5.13 **/\r\nfunction add$1 (\r\n  event,\r\n  handler,\r\n  once$$1,\r\n  capture,\r\n  passive\r\n) {\r\n  // 看这里\t      \r\n  handler = withMacroTask(handler);\r\n  if (once$$1) { handler = createOnceHandler(handler, event, capture); }\r\n  target$1.addEventListener(\r\n    event,\r\n    handler,\r\n    supportsPassive\r\n      ? { capture: capture, passive: passive }\r\n      : capture\r\n  );\r\n}\r\n\r\n/**\r\n * Wrap a function so that if any code inside triggers state change,\r\n * the changes are queued using a Task instead of a MicroTask.\r\n */\r\nfunction withMacroTask (fn) {\r\n  return fn._withTask || (fn._withTask = function () {\r\n    useMacroTask = true;\r\n    var res = fn.apply(null, arguments);\r\n    useMacroTask = false;\r\n    return res\r\n  })\r\n}\r\n```\r\n\r\n\r\n\r\n## 参考资料\r\n\r\n1.vue2.0 正确理解Vue.nextTick()的用途 http://www.cnblogs.com/minigrasshopper/p/7879545.html\r\n\r\n2.从event loop规范探究javaScript异步及浏览器更新渲染时机 https://github.com/aooy/blog/issues/5\r\n\r\n3.Promise的队列与setTimeout的队列有何关联？https://www.zhihu.com/question/36972010/answer/71338002\r\n\r\n4.JavaScript 运行机制详解：再谈Event Loop http://www.ruanyifeng.com/blog/2014/10/event-loop.html\r\n\r\n5.Vue源码详解之nextTick：MutationObserver只是浮云，microtask才是核心！https://github.com/Ma63d/vue-analysis/issues/6\r\nhttps://chuckliu.me/#!/posts/58bd08a2b5187d2fb51c04f9\r\n\r\n6.Tasks, microtasks, queues and schedules https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/\r\n\r\n7.@click would trigger event other vnode @click event. #6566 https://github.com/vuejs/vue/issues/6566","reactions":{"url":"https://api.github.com/repos/AnnVoV/blog/issues/2/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/AnnVoV/blog/issues/2/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":1715650657,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDE3MTU2NTA2NTc=","url":"https://api.github.com/repos/vuejs/vue/issues/events/1715650657","actor":{"login":"haoqunjiang","id":3277634,"node_id":"MDQ6VXNlcjMyNzc2MzQ=","avatar_url":"https://avatars.githubusercontent.com/u/3277634?v=4","gravatar_id":"","url":"https://api.github.com/users/haoqunjiang","html_url":"https://github.com/haoqunjiang","followers_url":"https://api.github.com/users/haoqunjiang/followers","following_url":"https://api.github.com/users/haoqunjiang/following{/other_user}","gists_url":"https://api.github.com/users/haoqunjiang/gists{/gist_id}","starred_url":"https://api.github.com/users/haoqunjiang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/haoqunjiang/subscriptions","organizations_url":"https://api.github.com/users/haoqunjiang/orgs","repos_url":"https://api.github.com/users/haoqunjiang/repos","events_url":"https://api.github.com/users/haoqunjiang/events{/privacy}","received_events_url":"https://api.github.com/users/haoqunjiang/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"acc8cab6c9031e4e43a8a26cbfd78fab13e2b50e","commit_url":"https://api.github.com/repos/haoqunjiang/vue/commits/acc8cab6c9031e4e43a8a26cbfd78fab13e2b50e","created_at":"2018-07-04T07:30:38Z","performed_via_github_app":null},{"actor":{"login":"haoqunjiang","id":3277634,"node_id":"MDQ6VXNlcjMyNzc2MzQ=","avatar_url":"https://avatars.githubusercontent.com/u/3277634?v=4","gravatar_id":"","url":"https://api.github.com/users/haoqunjiang","html_url":"https://github.com/haoqunjiang","followers_url":"https://api.github.com/users/haoqunjiang/followers","following_url":"https://api.github.com/users/haoqunjiang/following{/other_user}","gists_url":"https://api.github.com/users/haoqunjiang/gists{/gist_id}","starred_url":"https://api.github.com/users/haoqunjiang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/haoqunjiang/subscriptions","organizations_url":"https://api.github.com/users/haoqunjiang/orgs","repos_url":"https://api.github.com/users/haoqunjiang/repos","events_url":"https://api.github.com/users/haoqunjiang/events{/privacy}","received_events_url":"https://api.github.com/users/haoqunjiang/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2018-07-04T07:34:43Z","updated_at":"2018-07-04T07:34:43Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/vuejs/vue/issues/8450","repository_url":"https://api.github.com/repos/vuejs/vue","labels_url":"https://api.github.com/repos/vuejs/vue/issues/8450/labels{/name}","comments_url":"https://api.github.com/repos/vuejs/vue/issues/8450/comments","events_url":"https://api.github.com/repos/vuejs/vue/issues/8450/events","html_url":"https://github.com/vuejs/vue/pull/8450","id":338161703,"node_id":"MDExOlB1bGxSZXF1ZXN0MTk5MTYyMTYw","number":8450,"title":"fix: always use microtasks for nextTick","user":{"login":"haoqunjiang","id":3277634,"node_id":"MDQ6VXNlcjMyNzc2MzQ=","avatar_url":"https://avatars.githubusercontent.com/u/3277634?v=4","gravatar_id":"","url":"https://api.github.com/users/haoqunjiang","html_url":"https://github.com/haoqunjiang","followers_url":"https://api.github.com/users/haoqunjiang/followers","following_url":"https://api.github.com/users/haoqunjiang/following{/other_user}","gists_url":"https://api.github.com/users/haoqunjiang/gists{/gist_id}","starred_url":"https://api.github.com/users/haoqunjiang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/haoqunjiang/subscriptions","organizations_url":"https://api.github.com/users/haoqunjiang/orgs","repos_url":"https://api.github.com/users/haoqunjiang/repos","events_url":"https://api.github.com/users/haoqunjiang/events{/privacy}","received_events_url":"https://api.github.com/users/haoqunjiang/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":71449830,"node_id":"MDU6TGFiZWw3MTQ0OTgzMA==","url":"https://api.github.com/repos/vuejs/vue/labels/important","name":"important","color":"5319e7","default":false,"description":null},{"id":777055905,"node_id":"MDU6TGFiZWw3NzcwNTU5MDU=","url":"https://api.github.com/repos/vuejs/vue/labels/semver:minor","name":"semver:minor","color":"ade575","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-07-04T07:34:43Z","updated_at":"2023-06-26T21:03:09Z","closed_at":"2018-12-19T18:29:01Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":11730342,"node_id":"MDEwOlJlcG9zaXRvcnkxMTczMDM0Mg==","name":"vue","full_name":"vuejs/vue","private":false,"owner":{"login":"vuejs","id":6128107,"node_id":"MDEyOk9yZ2FuaXphdGlvbjYxMjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/6128107?v=4","gravatar_id":"","url":"https://api.github.com/users/vuejs","html_url":"https://github.com/vuejs","followers_url":"https://api.github.com/users/vuejs/followers","following_url":"https://api.github.com/users/vuejs/following{/other_user}","gists_url":"https://api.github.com/users/vuejs/gists{/gist_id}","starred_url":"https://api.github.com/users/vuejs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vuejs/subscriptions","organizations_url":"https://api.github.com/users/vuejs/orgs","repos_url":"https://api.github.com/users/vuejs/repos","events_url":"https://api.github.com/users/vuejs/events{/privacy}","received_events_url":"https://api.github.com/users/vuejs/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/vuejs/vue","description":"This is the repo for Vue 2. For Vue 3, go to https://github.com/vuejs/core","fork":false,"url":"https://api.github.com/repos/vuejs/vue","forks_url":"https://api.github.com/repos/vuejs/vue/forks","keys_url":"https://api.github.com/repos/vuejs/vue/keys{/key_id}","collaborators_url":"https://api.github.com/repos/vuejs/vue/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/vuejs/vue/teams","hooks_url":"https://api.github.com/repos/vuejs/vue/hooks","issue_events_url":"https://api.github.com/repos/vuejs/vue/issues/events{/number}","events_url":"https://api.github.com/repos/vuejs/vue/events","assignees_url":"https://api.github.com/repos/vuejs/vue/assignees{/user}","branches_url":"https://api.github.com/repos/vuejs/vue/branches{/branch}","tags_url":"https://api.github.com/repos/vuejs/vue/tags","blobs_url":"https://api.github.com/repos/vuejs/vue/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/vuejs/vue/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/vuejs/vue/git/refs{/sha}","trees_url":"https://api.github.com/repos/vuejs/vue/git/trees{/sha}","statuses_url":"https://api.github.com/repos/vuejs/vue/statuses/{sha}","languages_url":"https://api.github.com/repos/vuejs/vue/languages","stargazers_url":"https://api.github.com/repos/vuejs/vue/stargazers","contributors_url":"https://api.github.com/repos/vuejs/vue/contributors","subscribers_url":"https://api.github.com/repos/vuejs/vue/subscribers","subscription_url":"https://api.github.com/repos/vuejs/vue/subscription","commits_url":"https://api.github.com/repos/vuejs/vue/commits{/sha}","git_commits_url":"https://api.github.com/repos/vuejs/vue/git/commits{/sha}","comments_url":"https://api.github.com/repos/vuejs/vue/comments{/number}","issue_comment_url":"https://api.github.com/repos/vuejs/vue/issues/comments{/number}","contents_url":"https://api.github.com/repos/vuejs/vue/contents/{+path}","compare_url":"https://api.github.com/repos/vuejs/vue/compare/{base}...{head}","merges_url":"https://api.github.com/repos/vuejs/vue/merges","archive_url":"https://api.github.com/repos/vuejs/vue/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/vuejs/vue/downloads","issues_url":"https://api.github.com/repos/vuejs/vue/issues{/number}","pulls_url":"https://api.github.com/repos/vuejs/vue/pulls{/number}","milestones_url":"https://api.github.com/repos/vuejs/vue/milestones{/number}","notifications_url":"https://api.github.com/repos/vuejs/vue/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/vuejs/vue/labels{/name}","releases_url":"https://api.github.com/repos/vuejs/vue/releases{/id}","deployments_url":"https://api.github.com/repos/vuejs/vue/deployments","created_at":"2013-07-29T03:24:51Z","updated_at":"2025-11-09T17:23:38Z","pushed_at":"2024-10-10T07:24:15Z","git_url":"git://github.com/vuejs/vue.git","ssh_url":"git@github.com:vuejs/vue.git","clone_url":"https://github.com/vuejs/vue.git","svn_url":"https://github.com/vuejs/vue","homepage":"http://v2.vuejs.org","size":32152,"stargazers_count":209671,"watchers_count":209671,"language":"TypeScript","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":true,"forks_count":33803,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":612,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["framework","frontend","javascript","vue"],"visibility":"public","forks":33803,"open_issues":612,"watchers":209671,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/vuejs/vue/pulls/8450","html_url":"https://github.com/vuejs/vue/pull/8450","diff_url":"https://github.com/vuejs/vue/pull/8450.diff","patch_url":"https://github.com/vuejs/vue/pull/8450.patch","merged_at":"2018-12-19T18:29:01Z"},"body":"fix #7109, #7546, #7707, #7834, #8109\r\nreopen #6566\r\n\r\n**What kind of change does this PR introduce?** (check at least one)\r\n\r\n- [x] Bugfix\r\n- [ ] Feature\r\n- [ ] Code style update\r\n- [ ] Refactor\r\n- [ ] Build-related changes\r\n- [ ] Other, please describe:\r\n\r\n**Does this PR introduce a breaking change?** (check one)\r\n\r\n- [ ] Yes\r\n- [x] No\r\n\r\nIf yes, please describe the impact and migration path for existing applications:\r\n\r\n**The PR fulfills these requirements:**\r\n\r\n- [x] It's submitted to the `dev` branch for v2.x (or to a previous version branch), _not_ the `master` branch\r\n- [x] When resolving a specific issue, it's referenced in the PR's title (e.g. `fix #xxx[,#xxx]`, where \"xxx\" is the issue number)\r\n- [x] All tests are passing: https://github.com/vuejs/vue/blob/dev/.github/CONTRIBUTING.md#development-setup\r\n- [x] New/updated tests are included\r\n\r\nIf adding a **new feature**, the PR's description includes:\r\n- [ ] A convincing reason for adding this feature (to avoid wasting your time, it's best to open a suggestion issue first and wait for approval before working on it)\r\n\r\n**Other information:**\r\n","reactions":{"url":"https://api.github.com/repos/vuejs/vue/issues/8450/reactions","total_count":5,"+1":5,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/vuejs/vue/issues/8450/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":2036433368,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDIwMzY0MzMzNjg=","url":"https://api.github.com/repos/vuejs/vue/issues/events/2036433368","actor":{"login":"yyx990803","id":499550,"node_id":"MDQ6VXNlcjQ5OTU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/499550?v=4","gravatar_id":"","url":"https://api.github.com/users/yyx990803","html_url":"https://github.com/yyx990803","followers_url":"https://api.github.com/users/yyx990803/followers","following_url":"https://api.github.com/users/yyx990803/following{/other_user}","gists_url":"https://api.github.com/users/yyx990803/gists{/gist_id}","starred_url":"https://api.github.com/users/yyx990803/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yyx990803/subscriptions","organizations_url":"https://api.github.com/users/yyx990803/orgs","repos_url":"https://api.github.com/users/yyx990803/repos","events_url":"https://api.github.com/users/yyx990803/events{/privacy}","received_events_url":"https://api.github.com/users/yyx990803/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"850555d1faa9be7d8306adffd95c7dee5e58717f","commit_url":"https://api.github.com/repos/vuejs/vue/commits/850555d1faa9be7d8306adffd95c7dee5e58717f","created_at":"2018-12-19T18:29:06Z","performed_via_github_app":null},{"id":2037149593,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDIwMzcxNDk1OTM=","url":"https://api.github.com/repos/vuejs/vue/issues/events/2037149593","actor":{"login":"yyx990803","id":499550,"node_id":"MDQ6VXNlcjQ5OTU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/499550?v=4","gravatar_id":"","url":"https://api.github.com/users/yyx990803","html_url":"https://github.com/yyx990803","followers_url":"https://api.github.com/users/yyx990803/followers","following_url":"https://api.github.com/users/yyx990803/following{/other_user}","gists_url":"https://api.github.com/users/yyx990803/gists{/gist_id}","starred_url":"https://api.github.com/users/yyx990803/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yyx990803/subscriptions","organizations_url":"https://api.github.com/users/yyx990803/orgs","repos_url":"https://api.github.com/users/yyx990803/repos","events_url":"https://api.github.com/users/yyx990803/events{/privacy}","received_events_url":"https://api.github.com/users/yyx990803/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"b7f7f2756928f409950186c5d641034f362b392a","commit_url":"https://api.github.com/repos/vuejs/vue/commits/b7f7f2756928f409950186c5d641034f362b392a","created_at":"2018-12-20T00:29:39Z","performed_via_github_app":null},{"id":2096743141,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDIwOTY3NDMxNDE=","url":"https://api.github.com/repos/vuejs/vue/issues/events/2096743141","actor":{"login":"f2009","id":28625332,"node_id":"MDQ6VXNlcjI4NjI1MzMy","avatar_url":"https://avatars.githubusercontent.com/u/28625332?v=4","gravatar_id":"","url":"https://api.github.com/users/f2009","html_url":"https://github.com/f2009","followers_url":"https://api.github.com/users/f2009/followers","following_url":"https://api.github.com/users/f2009/following{/other_user}","gists_url":"https://api.github.com/users/f2009/gists{/gist_id}","starred_url":"https://api.github.com/users/f2009/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/f2009/subscriptions","organizations_url":"https://api.github.com/users/f2009/orgs","repos_url":"https://api.github.com/users/f2009/repos","events_url":"https://api.github.com/users/f2009/events{/privacy}","received_events_url":"https://api.github.com/users/f2009/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"d0b1d2adc9d7cbda2f12ae4a7189aca9b86a1eaf","commit_url":"https://api.github.com/repos/f2009/vue/commits/d0b1d2adc9d7cbda2f12ae4a7189aca9b86a1eaf","created_at":"2019-01-25T09:52:53Z","performed_via_github_app":null},{"id":2096744033,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDIwOTY3NDQwMzM=","url":"https://api.github.com/repos/vuejs/vue/issues/events/2096744033","actor":{"login":"f2009","id":28625332,"node_id":"MDQ6VXNlcjI4NjI1MzMy","avatar_url":"https://avatars.githubusercontent.com/u/28625332?v=4","gravatar_id":"","url":"https://api.github.com/users/f2009","html_url":"https://github.com/f2009","followers_url":"https://api.github.com/users/f2009/followers","following_url":"https://api.github.com/users/f2009/following{/other_user}","gists_url":"https://api.github.com/users/f2009/gists{/gist_id}","starred_url":"https://api.github.com/users/f2009/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/f2009/subscriptions","organizations_url":"https://api.github.com/users/f2009/orgs","repos_url":"https://api.github.com/users/f2009/repos","events_url":"https://api.github.com/users/f2009/events{/privacy}","received_events_url":"https://api.github.com/users/f2009/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"2e68b3ce70aedd6a9a48cf39e390e3ae937b9b5a","commit_url":"https://api.github.com/repos/f2009/vue/commits/2e68b3ce70aedd6a9a48cf39e390e3ae937b9b5a","created_at":"2019-01-25T09:53:05Z","performed_via_github_app":null},{"id":2096744044,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDIwOTY3NDQwNDQ=","url":"https://api.github.com/repos/vuejs/vue/issues/events/2096744044","actor":{"login":"f2009","id":28625332,"node_id":"MDQ6VXNlcjI4NjI1MzMy","avatar_url":"https://avatars.githubusercontent.com/u/28625332?v=4","gravatar_id":"","url":"https://api.github.com/users/f2009","html_url":"https://github.com/f2009","followers_url":"https://api.github.com/users/f2009/followers","following_url":"https://api.github.com/users/f2009/following{/other_user}","gists_url":"https://api.github.com/users/f2009/gists{/gist_id}","starred_url":"https://api.github.com/users/f2009/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/f2009/subscriptions","organizations_url":"https://api.github.com/users/f2009/orgs","repos_url":"https://api.github.com/users/f2009/repos","events_url":"https://api.github.com/users/f2009/events{/privacy}","received_events_url":"https://api.github.com/users/f2009/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"ad4576784b6faf46af82533a41f614d45e13e3e3","commit_url":"https://api.github.com/repos/f2009/vue/commits/ad4576784b6faf46af82533a41f614d45e13e3e3","created_at":"2019-01-25T09:53:05Z","performed_via_github_app":null},{"actor":{"login":"ericdrobinson","id":9142587,"node_id":"MDQ6VXNlcjkxNDI1ODc=","avatar_url":"https://avatars.githubusercontent.com/u/9142587?v=4","gravatar_id":"","url":"https://api.github.com/users/ericdrobinson","html_url":"https://github.com/ericdrobinson","followers_url":"https://api.github.com/users/ericdrobinson/followers","following_url":"https://api.github.com/users/ericdrobinson/following{/other_user}","gists_url":"https://api.github.com/users/ericdrobinson/gists{/gist_id}","starred_url":"https://api.github.com/users/ericdrobinson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ericdrobinson/subscriptions","organizations_url":"https://api.github.com/users/ericdrobinson/orgs","repos_url":"https://api.github.com/users/ericdrobinson/repos","events_url":"https://api.github.com/users/ericdrobinson/events{/privacy}","received_events_url":"https://api.github.com/users/ericdrobinson/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2019-08-27T18:24:00Z","updated_at":"2019-08-27T18:24:00Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/vuejs/vue/issues/10366","repository_url":"https://api.github.com/repos/vuejs/vue","labels_url":"https://api.github.com/repos/vuejs/vue/issues/10366/labels{/name}","comments_url":"https://api.github.com/repos/vuejs/vue/issues/10366/comments","events_url":"https://api.github.com/repos/vuejs/vue/issues/10366/events","html_url":"https://github.com/vuejs/vue/issues/10366","id":478179397,"node_id":"MDU6SXNzdWU0NzgxNzkzOTc=","number":10366,"title":"Click Event Triggers on Complex Buttons are ignored in some environments","user":{"login":"ericdrobinson","id":9142587,"node_id":"MDQ6VXNlcjkxNDI1ODc=","avatar_url":"https://avatars.githubusercontent.com/u/9142587?v=4","gravatar_id":"","url":"https://api.github.com/users/ericdrobinson","html_url":"https://github.com/ericdrobinson","followers_url":"https://api.github.com/users/ericdrobinson/followers","following_url":"https://api.github.com/users/ericdrobinson/following{/other_user}","gists_url":"https://api.github.com/users/ericdrobinson/gists{/gist_id}","starred_url":"https://api.github.com/users/ericdrobinson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ericdrobinson/subscriptions","organizations_url":"https://api.github.com/users/ericdrobinson/orgs","repos_url":"https://api.github.com/users/ericdrobinson/repos","events_url":"https://api.github.com/users/ericdrobinson/events{/privacy}","received_events_url":"https://api.github.com/users/ericdrobinson/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":81203481,"node_id":"MDU6TGFiZWw4MTIwMzQ4MQ==","url":"https://api.github.com/repos/vuejs/vue/labels/contribution%20welcome","name":"contribution welcome","color":"009800","default":false,"description":null},{"id":731090450,"node_id":"MDU6TGFiZWw3MzEwOTA0NTA=","url":"https://api.github.com/repos/vuejs/vue/labels/browser%20quirks","name":"browser quirks","color":"d93f0b","default":false,"description":null},{"id":863458406,"node_id":"MDU6TGFiZWw4NjM0NTg0MDY=","url":"https://api.github.com/repos/vuejs/vue/labels/has%20PR","name":"has PR","color":"5319e7","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":31,"created_at":"2019-08-07T23:17:14Z","updated_at":"2022-06-09T07:52:48Z","closed_at":null,"author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":11730342,"node_id":"MDEwOlJlcG9zaXRvcnkxMTczMDM0Mg==","name":"vue","full_name":"vuejs/vue","private":false,"owner":{"login":"vuejs","id":6128107,"node_id":"MDEyOk9yZ2FuaXphdGlvbjYxMjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/6128107?v=4","gravatar_id":"","url":"https://api.github.com/users/vuejs","html_url":"https://github.com/vuejs","followers_url":"https://api.github.com/users/vuejs/followers","following_url":"https://api.github.com/users/vuejs/following{/other_user}","gists_url":"https://api.github.com/users/vuejs/gists{/gist_id}","starred_url":"https://api.github.com/users/vuejs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vuejs/subscriptions","organizations_url":"https://api.github.com/users/vuejs/orgs","repos_url":"https://api.github.com/users/vuejs/repos","events_url":"https://api.github.com/users/vuejs/events{/privacy}","received_events_url":"https://api.github.com/users/vuejs/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/vuejs/vue","description":"This is the repo for Vue 2. For Vue 3, go to https://github.com/vuejs/core","fork":false,"url":"https://api.github.com/repos/vuejs/vue","forks_url":"https://api.github.com/repos/vuejs/vue/forks","keys_url":"https://api.github.com/repos/vuejs/vue/keys{/key_id}","collaborators_url":"https://api.github.com/repos/vuejs/vue/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/vuejs/vue/teams","hooks_url":"https://api.github.com/repos/vuejs/vue/hooks","issue_events_url":"https://api.github.com/repos/vuejs/vue/issues/events{/number}","events_url":"https://api.github.com/repos/vuejs/vue/events","assignees_url":"https://api.github.com/repos/vuejs/vue/assignees{/user}","branches_url":"https://api.github.com/repos/vuejs/vue/branches{/branch}","tags_url":"https://api.github.com/repos/vuejs/vue/tags","blobs_url":"https://api.github.com/repos/vuejs/vue/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/vuejs/vue/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/vuejs/vue/git/refs{/sha}","trees_url":"https://api.github.com/repos/vuejs/vue/git/trees{/sha}","statuses_url":"https://api.github.com/repos/vuejs/vue/statuses/{sha}","languages_url":"https://api.github.com/repos/vuejs/vue/languages","stargazers_url":"https://api.github.com/repos/vuejs/vue/stargazers","contributors_url":"https://api.github.com/repos/vuejs/vue/contributors","subscribers_url":"https://api.github.com/repos/vuejs/vue/subscribers","subscription_url":"https://api.github.com/repos/vuejs/vue/subscription","commits_url":"https://api.github.com/repos/vuejs/vue/commits{/sha}","git_commits_url":"https://api.github.com/repos/vuejs/vue/git/commits{/sha}","comments_url":"https://api.github.com/repos/vuejs/vue/comments{/number}","issue_comment_url":"https://api.github.com/repos/vuejs/vue/issues/comments{/number}","contents_url":"https://api.github.com/repos/vuejs/vue/contents/{+path}","compare_url":"https://api.github.com/repos/vuejs/vue/compare/{base}...{head}","merges_url":"https://api.github.com/repos/vuejs/vue/merges","archive_url":"https://api.github.com/repos/vuejs/vue/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/vuejs/vue/downloads","issues_url":"https://api.github.com/repos/vuejs/vue/issues{/number}","pulls_url":"https://api.github.com/repos/vuejs/vue/pulls{/number}","milestones_url":"https://api.github.com/repos/vuejs/vue/milestones{/number}","notifications_url":"https://api.github.com/repos/vuejs/vue/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/vuejs/vue/labels{/name}","releases_url":"https://api.github.com/repos/vuejs/vue/releases{/id}","deployments_url":"https://api.github.com/repos/vuejs/vue/deployments","created_at":"2013-07-29T03:24:51Z","updated_at":"2025-11-09T17:23:38Z","pushed_at":"2024-10-10T07:24:15Z","git_url":"git://github.com/vuejs/vue.git","ssh_url":"git@github.com:vuejs/vue.git","clone_url":"https://github.com/vuejs/vue.git","svn_url":"https://github.com/vuejs/vue","homepage":"http://v2.vuejs.org","size":32152,"stargazers_count":209671,"watchers_count":209671,"language":"TypeScript","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":false,"has_discussions":true,"forks_count":33803,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":612,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["framework","frontend","javascript","vue"],"visibility":"public","forks":33803,"open_issues":612,"watchers":209671,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"### Version\r\n2.6.10\r\n\r\n### Reproduction link\r\n[https://jsfiddle.net/s7hyqk13/2/](https://jsfiddle.net/s7hyqk13/2/)\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n### Steps to reproduce\r\n1. Configure one of the Adobe CEP [Sample Panels](https://github.com/Adobe-CEP/Samples). The [PProPanel](https://github.com/Adobe-CEP/Samples/tree/master/PProPanel) is a good starting point as it has very clear documentation on how to [set up the environment](https://github.com/Adobe-CEP/Samples/tree/master/PProPanel#2-enable-loading-of-unsigned-panels) for testing.\r\n1. Replace the HTML/JavaScript/CSS contents of the panel project with the contents of the [linked JSFiddle](https://jsfiddle.net/s7hyqk13/2/).\r\n1. Open the panel.\r\n1. Attach a debugger (with the default PProPanel setup this would mean browsing to `localhost:7777` in Chrome).\r\n1. Set the \"_Mouse > `click`_\" **Event Listener Breakpoint** in the \"Sources\" tab of the Chrome Debugger.\r\n1. Click the Vue icon in the center of the silver `div`.\r\n\r\n### What is expected?\r\nMethod bound to the `@click` handler is triggered when the image embedded in the parent div is clicked. \r\n\r\n### What is actually happening?\r\nThe method bound to the `@click` handler is _only_ triggered when clicking outside of the parent div.\r\n\r\n---\r\nThis is a non-trivial bug to reproduce as the only place I've experienced it is in [Adobe CEP](https://github.com/Adobe-CEP/CEP-Resources/blob/master/CEP_9.x/Documentation/CEP%209.0%20HTML%20Extension%20Cookbook.md) extensions (which run NW.js under the hood). That said, it does reproduce 100% of the time there.\r\n\r\nThe debugger (CEP context) seems to show several funny things at around [this line](https://github.com/vuejs/vue/blob/d40b7ddb8177944d1dd50f4f780e6fd92c9455c2/src/platforms/web/runtime/modules/events.js#L69) in the Vue events.js file. Specifically:\r\n\r\n1. The `e.timeStamp` value **does not change** between callbacks for _different buttons/elements_.\r\n1. The `attachedTimestamp` is **_significantly_ larger** than the `e.timeStamp` value.\r\n1. The `attachedTimestamp` value _does_ change when the component is updated (the `e.timeStamp` remains identical).\r\n\r\nI should note that this affects at least [CEP 8.0 and CEP 9.0](https://github.com/Adobe-CEP/CEP-Resources/blob/master/CEP_9.x/Documentation/CEP%209.0%20HTML%20Extension%20Cookbook.md#chromium-embedded-framework-cef) (tested in Premiere Pro).\r\n\r\n**Vue Versions Note:** This broke somewhere between versions 2.5.17 and 2.6.x. If we run a version of 2.5 (2.5.17 and some earlier versions verified), then this issue does not occur. In testing 2.6.x, we've found that this same issue occurs from 2.6.5 to 2.6.10 (latest). Versions of 2.6 prior to 2.6.5 are actually _worse_ in that the buttons basically don't work at all.\r\n\r\n**Important Note:** I should _further_ note that apparently right-clicking to open the basic CEF [not CEP] context menu will cause the `e.timeStamp` values to begin reporting as expected. Once this occurs, the buttons will _also_ work as expected. That said, we shouldn't have to instruct users to right-click prior to interfacing with the extension.\r\n\r\n<!-- generated by vue-issues. DO NOT REMOVE -->","reactions":{"url":"https://api.github.com/repos/vuejs/vue/issues/10366/reactions","total_count":4,"+1":4,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/vuejs/vue/issues/10366/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"id":2632320648,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDI2MzIzMjA2NDg=","url":"https://api.github.com/repos/vuejs/vue/issues/events/2632320648","actor":{"login":"paulkamer","id":475844,"node_id":"MDQ6VXNlcjQ3NTg0NA==","avatar_url":"https://avatars.githubusercontent.com/u/475844?v=4","gravatar_id":"","url":"https://api.github.com/users/paulkamer","html_url":"https://github.com/paulkamer","followers_url":"https://api.github.com/users/paulkamer/followers","following_url":"https://api.github.com/users/paulkamer/following{/other_user}","gists_url":"https://api.github.com/users/paulkamer/gists{/gist_id}","starred_url":"https://api.github.com/users/paulkamer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/paulkamer/subscriptions","organizations_url":"https://api.github.com/users/paulkamer/orgs","repos_url":"https://api.github.com/users/paulkamer/repos","events_url":"https://api.github.com/users/paulkamer/events{/privacy}","received_events_url":"https://api.github.com/users/paulkamer/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"8a77d23619b903f78734f6af36031768379c2b4a","commit_url":"https://api.github.com/repos/paulkamer/vue/commits/8a77d23619b903f78734f6af36031768379c2b4a","created_at":"2019-09-13T13:22:35Z","performed_via_github_app":null},{"actor":{"login":"zauan","id":5928748,"node_id":"MDQ6VXNlcjU5Mjg3NDg=","avatar_url":"https://avatars.githubusercontent.com/u/5928748?v=4","gravatar_id":"","url":"https://api.github.com/users/zauan","html_url":"https://github.com/zauan","followers_url":"https://api.github.com/users/zauan/followers","following_url":"https://api.github.com/users/zauan/following{/other_user}","gists_url":"https://api.github.com/users/zauan/gists{/gist_id}","starred_url":"https://api.github.com/users/zauan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zauan/subscriptions","organizations_url":"https://api.github.com/users/zauan/orgs","repos_url":"https://api.github.com/users/zauan/repos","events_url":"https://api.github.com/users/zauan/events{/privacy}","received_events_url":"https://api.github.com/users/zauan/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-12-02T20:10:49Z","updated_at":"2020-12-02T20:10:49Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/vuejs/core/issues/2513","repository_url":"https://api.github.com/repos/vuejs/core","labels_url":"https://api.github.com/repos/vuejs/core/issues/2513/labels{/name}","comments_url":"https://api.github.com/repos/vuejs/core/issues/2513/comments","events_url":"https://api.github.com/repos/vuejs/core/issues/2513/events","html_url":"https://github.com/vuejs/core/issues/2513","id":731737872,"node_id":"MDU6SXNzdWU3MzE3Mzc4NzI=","number":2513,"title":"Vue 3 does not work well with iframes","user":{"login":"zauan","id":5928748,"node_id":"MDQ6VXNlcjU5Mjg3NDg=","avatar_url":"https://avatars.githubusercontent.com/u/5928748?v=4","gravatar_id":"","url":"https://api.github.com/users/zauan","html_url":"https://github.com/zauan","followers_url":"https://api.github.com/users/zauan/followers","following_url":"https://api.github.com/users/zauan/following{/other_user}","gists_url":"https://api.github.com/users/zauan/gists{/gist_id}","starred_url":"https://api.github.com/users/zauan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zauan/subscriptions","organizations_url":"https://api.github.com/users/zauan/orgs","repos_url":"https://api.github.com/users/zauan/repos","events_url":"https://api.github.com/users/zauan/events{/privacy}","received_events_url":"https://api.github.com/users/zauan/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":962500788,"node_id":"MDU6TGFiZWw5NjI1MDA3ODg=","url":"https://api.github.com/repos/vuejs/core/labels/:sparkles:%20feature%20request","name":":sparkles: feature request","color":"73e29c","default":false,"description":"New feature or request"},{"id":2557590955,"node_id":"MDU6TGFiZWwyNTU3NTkwOTU1","url":"https://api.github.com/repos/vuejs/core/labels/:exclamation:%20p4-important","name":":exclamation: p4-important","color":"8155e0","default":false,"description":"Priority 4: this fixes bugs that violate documented behavior, or significantly improves perf."}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":32,"created_at":"2020-10-28T19:41:10Z","updated_at":"2023-09-13T00:18:25Z","closed_at":"2022-10-14T08:01:29Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":137078487,"node_id":"MDEwOlJlcG9zaXRvcnkxMzcwNzg0ODc=","name":"core","full_name":"vuejs/core","private":false,"owner":{"login":"vuejs","id":6128107,"node_id":"MDEyOk9yZ2FuaXphdGlvbjYxMjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/6128107?v=4","gravatar_id":"","url":"https://api.github.com/users/vuejs","html_url":"https://github.com/vuejs","followers_url":"https://api.github.com/users/vuejs/followers","following_url":"https://api.github.com/users/vuejs/following{/other_user}","gists_url":"https://api.github.com/users/vuejs/gists{/gist_id}","starred_url":"https://api.github.com/users/vuejs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vuejs/subscriptions","organizations_url":"https://api.github.com/users/vuejs/orgs","repos_url":"https://api.github.com/users/vuejs/repos","events_url":"https://api.github.com/users/vuejs/events{/privacy}","received_events_url":"https://api.github.com/users/vuejs/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/vuejs/core","description":"🖖 Vue.js is a progressive, incrementally-adoptable JavaScript framework for building UI on the web.","fork":false,"url":"https://api.github.com/repos/vuejs/core","forks_url":"https://api.github.com/repos/vuejs/core/forks","keys_url":"https://api.github.com/repos/vuejs/core/keys{/key_id}","collaborators_url":"https://api.github.com/repos/vuejs/core/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/vuejs/core/teams","hooks_url":"https://api.github.com/repos/vuejs/core/hooks","issue_events_url":"https://api.github.com/repos/vuejs/core/issues/events{/number}","events_url":"https://api.github.com/repos/vuejs/core/events","assignees_url":"https://api.github.com/repos/vuejs/core/assignees{/user}","branches_url":"https://api.github.com/repos/vuejs/core/branches{/branch}","tags_url":"https://api.github.com/repos/vuejs/core/tags","blobs_url":"https://api.github.com/repos/vuejs/core/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/vuejs/core/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/vuejs/core/git/refs{/sha}","trees_url":"https://api.github.com/repos/vuejs/core/git/trees{/sha}","statuses_url":"https://api.github.com/repos/vuejs/core/statuses/{sha}","languages_url":"https://api.github.com/repos/vuejs/core/languages","stargazers_url":"https://api.github.com/repos/vuejs/core/stargazers","contributors_url":"https://api.github.com/repos/vuejs/core/contributors","subscribers_url":"https://api.github.com/repos/vuejs/core/subscribers","subscription_url":"https://api.github.com/repos/vuejs/core/subscription","commits_url":"https://api.github.com/repos/vuejs/core/commits{/sha}","git_commits_url":"https://api.github.com/repos/vuejs/core/git/commits{/sha}","comments_url":"https://api.github.com/repos/vuejs/core/comments{/number}","issue_comment_url":"https://api.github.com/repos/vuejs/core/issues/comments{/number}","contents_url":"https://api.github.com/repos/vuejs/core/contents/{+path}","compare_url":"https://api.github.com/repos/vuejs/core/compare/{base}...{head}","merges_url":"https://api.github.com/repos/vuejs/core/merges","archive_url":"https://api.github.com/repos/vuejs/core/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/vuejs/core/downloads","issues_url":"https://api.github.com/repos/vuejs/core/issues{/number}","pulls_url":"https://api.github.com/repos/vuejs/core/pulls{/number}","milestones_url":"https://api.github.com/repos/vuejs/core/milestones{/number}","notifications_url":"https://api.github.com/repos/vuejs/core/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/vuejs/core/labels{/name}","releases_url":"https://api.github.com/repos/vuejs/core/releases{/id}","deployments_url":"https://api.github.com/repos/vuejs/core/deployments","created_at":"2018-06-12T13:49:36Z","updated_at":"2025-11-09T16:00:22Z","pushed_at":"2025-11-08T12:04:46Z","git_url":"git://github.com/vuejs/core.git","ssh_url":"git@github.com:vuejs/core.git","clone_url":"https://github.com/vuejs/core.git","svn_url":"https://github.com/vuejs/core","homepage":"https://vuejs.org/","size":37805,"stargazers_count":52103,"watchers_count":52103,"language":"TypeScript","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":8935,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":1033,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":[],"visibility":"public","forks":8935,"open_issues":1033,"watchers":52103,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"### Version\r\n3.0.2\r\n\r\n### Reproduction link\r\n[https://codesandbox.io/s/unruffled-northcutt-cmndl?file=/public/iframe.html](https://codesandbox.io/s/unruffled-northcutt-cmndl?file=/public/iframe.html)\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n### Steps to reproduce\r\n1. Have an app that shows an iframe\r\n2. Create a teleport that will place it's content inside the iframe\r\n3. Add an event like click to the teleport content\r\n4. Immediately after the irame loads, try to click on the teleported element\r\n\r\n### What is expected?\r\nThe click event should fire immediatelly\r\n\r\n### What is actually happening?\r\nThe click is not working until the event.timestamp ( that is generated by the iframe dom ) gets higher than the attached timestamp from the parent window. \r\n\r\n---\r\nMore info can be found here ( https://github.com/vuejs/vue-next/blob/ea5f92ae051be511558569eaf4c2afa2839c3e4d/packages/runtime-dom/src/modules/events.ts#L114 here, inside the iframe the event.timeStamp which is calculated based on the iframe timestamp is lower than the initial invoker.attached = getNow() that is calculated based on the parent frame ). Due to this, events are not firing for the time difference it takes the iframe to load\r\n\r\n<!-- generated by vue-issues. DO NOT REMOVE -->","reactions":{"url":"https://api.github.com/repos/vuejs/core/issues/2513/reactions","total_count":19,"+1":14,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":5},"timeline_url":"https://api.github.com/repos/vuejs/core/issues/2513/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"actor":{"login":"lidlanca","id":8693091,"node_id":"MDQ6VXNlcjg2OTMwOTE=","avatar_url":"https://avatars.githubusercontent.com/u/8693091?v=4","gravatar_id":"","url":"https://api.github.com/users/lidlanca","html_url":"https://github.com/lidlanca","followers_url":"https://api.github.com/users/lidlanca/followers","following_url":"https://api.github.com/users/lidlanca/following{/other_user}","gists_url":"https://api.github.com/users/lidlanca/gists{/gist_id}","starred_url":"https://api.github.com/users/lidlanca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lidlanca/subscriptions","organizations_url":"https://api.github.com/users/lidlanca/orgs","repos_url":"https://api.github.com/users/lidlanca/repos","events_url":"https://api.github.com/users/lidlanca/events{/privacy}","received_events_url":"https://api.github.com/users/lidlanca/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-06-11T05:14:46Z","updated_at":"2021-06-11T05:14:46Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/vuejs/core/issues/3933","repository_url":"https://api.github.com/repos/vuejs/core","labels_url":"https://api.github.com/repos/vuejs/core/issues/3933/labels{/name}","comments_url":"https://api.github.com/repos/vuejs/core/issues/3933/comments","events_url":"https://api.github.com/repos/vuejs/core/issues/3933/events","html_url":"https://github.com/vuejs/core/issues/3933","id":917131195,"node_id":"MDU6SXNzdWU5MTcxMzExOTU=","number":3933,"title":"click event is registered delayed on components opened in new browser windows","user":{"login":"danielSt-dev","id":58980796,"node_id":"MDQ6VXNlcjU4OTgwNzk2","avatar_url":"https://avatars.githubusercontent.com/u/58980796?v=4","gravatar_id":"","url":"https://api.github.com/users/danielSt-dev","html_url":"https://github.com/danielSt-dev","followers_url":"https://api.github.com/users/danielSt-dev/followers","following_url":"https://api.github.com/users/danielSt-dev/following{/other_user}","gists_url":"https://api.github.com/users/danielSt-dev/gists{/gist_id}","starred_url":"https://api.github.com/users/danielSt-dev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielSt-dev/subscriptions","organizations_url":"https://api.github.com/users/danielSt-dev/orgs","repos_url":"https://api.github.com/users/danielSt-dev/repos","events_url":"https://api.github.com/users/danielSt-dev/events{/privacy}","received_events_url":"https://api.github.com/users/danielSt-dev/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":962500786,"node_id":"MDU6TGFiZWw5NjI1MDA3ODY=","url":"https://api.github.com/repos/vuejs/core/labels/:lady_beetle:%20%20bug","name":":lady_beetle:  bug","color":"fcba03","default":false,"description":"Something isn't working"},{"id":3039933290,"node_id":"MDU6TGFiZWwzMDM5OTMzMjkw","url":"https://api.github.com/repos/vuejs/core/labels/%F0%9F%94%A9%20p2-edge-case","name":"🔩 p2-edge-case","color":"E1CBF4","default":false,"description":""}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2021-06-10T09:34:36Z","updated_at":"2023-09-20T00:18:50Z","closed_at":"2022-10-14T08:01:30Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":137078487,"node_id":"MDEwOlJlcG9zaXRvcnkxMzcwNzg0ODc=","name":"core","full_name":"vuejs/core","private":false,"owner":{"login":"vuejs","id":6128107,"node_id":"MDEyOk9yZ2FuaXphdGlvbjYxMjgxMDc=","avatar_url":"https://avatars.githubusercontent.com/u/6128107?v=4","gravatar_id":"","url":"https://api.github.com/users/vuejs","html_url":"https://github.com/vuejs","followers_url":"https://api.github.com/users/vuejs/followers","following_url":"https://api.github.com/users/vuejs/following{/other_user}","gists_url":"https://api.github.com/users/vuejs/gists{/gist_id}","starred_url":"https://api.github.com/users/vuejs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vuejs/subscriptions","organizations_url":"https://api.github.com/users/vuejs/orgs","repos_url":"https://api.github.com/users/vuejs/repos","events_url":"https://api.github.com/users/vuejs/events{/privacy}","received_events_url":"https://api.github.com/users/vuejs/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/vuejs/core","description":"🖖 Vue.js is a progressive, incrementally-adoptable JavaScript framework for building UI on the web.","fork":false,"url":"https://api.github.com/repos/vuejs/core","forks_url":"https://api.github.com/repos/vuejs/core/forks","keys_url":"https://api.github.com/repos/vuejs/core/keys{/key_id}","collaborators_url":"https://api.github.com/repos/vuejs/core/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/vuejs/core/teams","hooks_url":"https://api.github.com/repos/vuejs/core/hooks","issue_events_url":"https://api.github.com/repos/vuejs/core/issues/events{/number}","events_url":"https://api.github.com/repos/vuejs/core/events","assignees_url":"https://api.github.com/repos/vuejs/core/assignees{/user}","branches_url":"https://api.github.com/repos/vuejs/core/branches{/branch}","tags_url":"https://api.github.com/repos/vuejs/core/tags","blobs_url":"https://api.github.com/repos/vuejs/core/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/vuejs/core/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/vuejs/core/git/refs{/sha}","trees_url":"https://api.github.com/repos/vuejs/core/git/trees{/sha}","statuses_url":"https://api.github.com/repos/vuejs/core/statuses/{sha}","languages_url":"https://api.github.com/repos/vuejs/core/languages","stargazers_url":"https://api.github.com/repos/vuejs/core/stargazers","contributors_url":"https://api.github.com/repos/vuejs/core/contributors","subscribers_url":"https://api.github.com/repos/vuejs/core/subscribers","subscription_url":"https://api.github.com/repos/vuejs/core/subscription","commits_url":"https://api.github.com/repos/vuejs/core/commits{/sha}","git_commits_url":"https://api.github.com/repos/vuejs/core/git/commits{/sha}","comments_url":"https://api.github.com/repos/vuejs/core/comments{/number}","issue_comment_url":"https://api.github.com/repos/vuejs/core/issues/comments{/number}","contents_url":"https://api.github.com/repos/vuejs/core/contents/{+path}","compare_url":"https://api.github.com/repos/vuejs/core/compare/{base}...{head}","merges_url":"https://api.github.com/repos/vuejs/core/merges","archive_url":"https://api.github.com/repos/vuejs/core/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/vuejs/core/downloads","issues_url":"https://api.github.com/repos/vuejs/core/issues{/number}","pulls_url":"https://api.github.com/repos/vuejs/core/pulls{/number}","milestones_url":"https://api.github.com/repos/vuejs/core/milestones{/number}","notifications_url":"https://api.github.com/repos/vuejs/core/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/vuejs/core/labels{/name}","releases_url":"https://api.github.com/repos/vuejs/core/releases{/id}","deployments_url":"https://api.github.com/repos/vuejs/core/deployments","created_at":"2018-06-12T13:49:36Z","updated_at":"2025-11-09T16:00:22Z","pushed_at":"2025-11-08T12:04:46Z","git_url":"git://github.com/vuejs/core.git","ssh_url":"git@github.com:vuejs/core.git","clone_url":"https://github.com/vuejs/core.git","svn_url":"https://github.com/vuejs/core","homepage":"https://vuejs.org/","size":37805,"stargazers_count":52103,"watchers_count":52103,"language":"TypeScript","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":8935,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":1033,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":[],"visibility":"public","forks":8935,"open_issues":1033,"watchers":52103,"default_branch":"main","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"### Version\r\n3.1.1\r\n\r\n### Reproduction link\r\n[https://codesandbox.io/s/determined-yonath-3hccx](https://codesandbox.io/s/determined-yonath-3hccx)\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n### Steps to reproduce\r\n1. open child window with a click on \"open,close window\" for the first time and wait 3 seconds\r\n2. click on message --> nothing happens\r\n3. wait 3 seconds and click again --> nothing happens\r\n4. wait another 15 seconds and click again --> alert message in \"main\" window appears (chrome: if devtools are closed, a dot on the tab of main window notifies you, that an alert is there)\r\n\r\nSo you see, there is a relatively long time until the click handler will be registered (about 15-20 seconds)\r\n\r\nNow close the window with a click on \"open,close window\" in main window.\r\n\r\nIf you repeat the above steps, the click handler will only be called after a few minutes (1-2 minutes; if it won't work, leave it open and try it after 5-10 minutes). \r\nWith every close/open new window the time increases.\r\nImportant: Do not click too often after opening the window! It seems that the click eventhandler never gets registered if you click too often.\r\n\r\n**Info**: firefox appears to be faster than chrome. After repeating this 4 times firefox needs about 3 minute that the click event is handled. chrome much more.\r\n\r\n\r\n### What is expected?\r\nclick events should be fired/registered immediately\r\n\r\n### What is actually happening?\r\nit seems the click event will be registered delayed. \r\n\r\n---\r\nI found have a problem with click events on components, that are opened in a new browser window with vue 3.\r\nI open a vue 3 component in a new window like the following code (copied and customized from https://github.com/Shamus03/vue-window-portal):\r\n```html\r\n<template>\r\n    <teleport to=\"body\">\r\n        <div v-if=\"open\" v-show=\"windowLoaded\" ref=\"teleportingContent\">\r\n            <slot></slot>\r\n        </div>\r\n    </teleport>\r\n</template>\r\n```\r\n\r\n```javascript\r\n...\r\nmethods: {\r\n  openPortal() {\r\n    this.windowRef = window.open('', '', '');\r\n    this.windowRef.document.body.innerHTML = '';\r\n    const app = document.createElement('div');\r\n    app.id = 'app';\r\n    app.appendChild(this.$refs.teleportingContent);\r\n    this.windowRef.document.body.appendChild(app);\r\n  }\r\n}\r\n...\r\n```\r\nWith this code the slot component will be attached to the DOM of the new opened window. This works and the vue objects/props are reactive in the new window.\r\n\r\nThe problem is if there is a click-eventhandler on an element, which is attached to DOM of the new window. It seems that the click event is registered delayed.\r\n\r\nIf the window is closed/opened multiple times, the time of the click registration increases every time.\r\n\r\nI want to be able to \"dock off\" some content of the main window to a new window (e. g. from a video conference push two video participants to new windows; move a component to a new window for comparing content in two screens).\r\n\r\n<!-- generated by vue-issues. DO NOT REMOVE -->","reactions":{"url":"https://api.github.com/repos/vuejs/core/issues/3933/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/vuejs/core/issues/3933/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"},{"actor":{"login":"Javey","id":5697987,"node_id":"MDQ6VXNlcjU2OTc5ODc=","avatar_url":"https://avatars.githubusercontent.com/u/5697987?v=4","gravatar_id":"","url":"https://api.github.com/users/Javey","html_url":"https://github.com/Javey","followers_url":"https://api.github.com/users/Javey/followers","following_url":"https://api.github.com/users/Javey/following{/other_user}","gists_url":"https://api.github.com/users/Javey/gists{/gist_id}","starred_url":"https://api.github.com/users/Javey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Javey/subscriptions","organizations_url":"https://api.github.com/users/Javey/orgs","repos_url":"https://api.github.com/users/Javey/repos","events_url":"https://api.github.com/users/Javey/events{/privacy}","received_events_url":"https://api.github.com/users/Javey/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2023-02-10T08:04:04Z","updated_at":"2023-02-10T08:04:04Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/ksc-fe/kpc/issues/788","repository_url":"https://api.github.com/repos/ksc-fe/kpc","labels_url":"https://api.github.com/repos/ksc-fe/kpc/issues/788/labels{/name}","comments_url":"https://api.github.com/repos/ksc-fe/kpc/issues/788/comments","events_url":"https://api.github.com/repos/ksc-fe/kpc/issues/788/events","html_url":"https://github.com/ksc-fe/kpc/issues/788","id":1579197337,"node_id":"I_kwDOB66yZM5eIKOZ","number":788,"title":"Dropdown当trigger=\"click\"时，点击后菜单展示又立即隐藏","user":{"login":"Javey","id":5697987,"node_id":"MDQ6VXNlcjU2OTc5ODc=","avatar_url":"https://avatars.githubusercontent.com/u/5697987?v=4","gravatar_id":"","url":"https://api.github.com/users/Javey","html_url":"https://github.com/Javey","followers_url":"https://api.github.com/users/Javey/followers","following_url":"https://api.github.com/users/Javey/following{/other_user}","gists_url":"https://api.github.com/users/Javey/gists{/gist_id}","starred_url":"https://api.github.com/users/Javey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Javey/subscriptions","organizations_url":"https://api.github.com/users/Javey/orgs","repos_url":"https://api.github.com/users/Javey/repos","events_url":"https://api.github.com/users/Javey/events{/privacy}","received_events_url":"https://api.github.com/users/Javey/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-02-10T08:04:04Z","updated_at":"2023-02-14T03:20:07Z","closed_at":"2023-02-14T03:20:07Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"repository":{"id":128889444,"node_id":"MDEwOlJlcG9zaXRvcnkxMjg4ODk0NDQ=","name":"kpc","full_name":"ksc-fe/kpc","private":false,"owner":{"login":"ksc-fe","id":9412168,"node_id":"MDEyOk9yZ2FuaXphdGlvbjk0MTIxNjg=","avatar_url":"https://avatars.githubusercontent.com/u/9412168?v=4","gravatar_id":"","url":"https://api.github.com/users/ksc-fe","html_url":"https://github.com/ksc-fe","followers_url":"https://api.github.com/users/ksc-fe/followers","following_url":"https://api.github.com/users/ksc-fe/following{/other_user}","gists_url":"https://api.github.com/users/ksc-fe/gists{/gist_id}","starred_url":"https://api.github.com/users/ksc-fe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ksc-fe/subscriptions","organizations_url":"https://api.github.com/users/ksc-fe/orgs","repos_url":"https://api.github.com/users/ksc-fe/repos","events_url":"https://api.github.com/users/ksc-fe/events{/privacy}","received_events_url":"https://api.github.com/users/ksc-fe/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/ksc-fe/kpc","description":"A UI Components Library for Intact, Vue, React and Angular.","fork":false,"url":"https://api.github.com/repos/ksc-fe/kpc","forks_url":"https://api.github.com/repos/ksc-fe/kpc/forks","keys_url":"https://api.github.com/repos/ksc-fe/kpc/keys{/key_id}","collaborators_url":"https://api.github.com/repos/ksc-fe/kpc/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/ksc-fe/kpc/teams","hooks_url":"https://api.github.com/repos/ksc-fe/kpc/hooks","issue_events_url":"https://api.github.com/repos/ksc-fe/kpc/issues/events{/number}","events_url":"https://api.github.com/repos/ksc-fe/kpc/events","assignees_url":"https://api.github.com/repos/ksc-fe/kpc/assignees{/user}","branches_url":"https://api.github.com/repos/ksc-fe/kpc/branches{/branch}","tags_url":"https://api.github.com/repos/ksc-fe/kpc/tags","blobs_url":"https://api.github.com/repos/ksc-fe/kpc/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/ksc-fe/kpc/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/ksc-fe/kpc/git/refs{/sha}","trees_url":"https://api.github.com/repos/ksc-fe/kpc/git/trees{/sha}","statuses_url":"https://api.github.com/repos/ksc-fe/kpc/statuses/{sha}","languages_url":"https://api.github.com/repos/ksc-fe/kpc/languages","stargazers_url":"https://api.github.com/repos/ksc-fe/kpc/stargazers","contributors_url":"https://api.github.com/repos/ksc-fe/kpc/contributors","subscribers_url":"https://api.github.com/repos/ksc-fe/kpc/subscribers","subscription_url":"https://api.github.com/repos/ksc-fe/kpc/subscription","commits_url":"https://api.github.com/repos/ksc-fe/kpc/commits{/sha}","git_commits_url":"https://api.github.com/repos/ksc-fe/kpc/git/commits{/sha}","comments_url":"https://api.github.com/repos/ksc-fe/kpc/comments{/number}","issue_comment_url":"https://api.github.com/repos/ksc-fe/kpc/issues/comments{/number}","contents_url":"https://api.github.com/repos/ksc-fe/kpc/contents/{+path}","compare_url":"https://api.github.com/repos/ksc-fe/kpc/compare/{base}...{head}","merges_url":"https://api.github.com/repos/ksc-fe/kpc/merges","archive_url":"https://api.github.com/repos/ksc-fe/kpc/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/ksc-fe/kpc/downloads","issues_url":"https://api.github.com/repos/ksc-fe/kpc/issues{/number}","pulls_url":"https://api.github.com/repos/ksc-fe/kpc/pulls{/number}","milestones_url":"https://api.github.com/repos/ksc-fe/kpc/milestones{/number}","notifications_url":"https://api.github.com/repos/ksc-fe/kpc/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/ksc-fe/kpc/labels{/name}","releases_url":"https://api.github.com/repos/ksc-fe/kpc/releases{/id}","deployments_url":"https://api.github.com/repos/ksc-fe/kpc/deployments","created_at":"2018-04-10T07:08:51Z","updated_at":"2025-10-31T03:27:46Z","pushed_at":"2025-11-04T03:05:25Z","git_url":"git://github.com/ksc-fe/kpc.git","ssh_url":"git@github.com:ksc-fe/kpc.git","clone_url":"https://github.com/ksc-fe/kpc.git","svn_url":"https://github.com/ksc-fe/kpc","homepage":"https://design.ksyun.com/","size":540791,"stargazers_count":367,"watchers_count":367,"language":"TypeScript","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":true,"has_pages":true,"has_discussions":false,"forks_count":56,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":67,"license":{"key":"mit","name":"MIT License","spdx_id":"MIT","url":"https://api.github.com/licenses/mit","node_id":"MDc6TGljZW5zZTEz"},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["ui-components","ui-design","web-components"],"visibility":"public","forks":56,"open_issues":67,"watchers":367,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"body":"**CodeSandbox**\r\n\r\n\r\n**Description**\r\n原因为：click时，菜单展示，这时会绑定document.click事件用来当用户之后点击空白处时隐藏菜单，但这个事件在首次绑定时就会立即执行。因为浏览器在处理事件回调时，会顺序处理MicroTask然后才冒泡\r\nhttps://github.com/vuejs/vue/issues/6566","reactions":{"url":"https://api.github.com/repos/ksc-fe/kpc/issues/788/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/ksc-fe/kpc/issues/788/timeline","performed_via_github_app":null,"state_reason":"completed"}},"event":"cross-referenced"}]