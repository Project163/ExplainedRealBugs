{"url":"https://api.github.com/repos/vuejs/vue/issues/12825","repository_url":"https://api.github.com/repos/vuejs/vue","labels_url":"https://api.github.com/repos/vuejs/vue/issues/12825/labels{/name}","comments_url":"https://api.github.com/repos/vuejs/vue/issues/12825/comments","events_url":"https://api.github.com/repos/vuejs/vue/issues/12825/events","html_url":"https://github.com/vuejs/vue/issues/12825","id":1406875192,"node_id":"I_kwDOALL9ps5T2zY4","number":12825,"title":"Creating a vm in a detached EffectScope before any other vm is initialized breaks tracking of the activeEffectScope","user":{"login":"Aaron-Pool","id":5634834,"node_id":"MDQ6VXNlcjU2MzQ4MzQ=","avatar_url":"https://avatars.githubusercontent.com/u/5634834?v=4","gravatar_id":"","url":"https://api.github.com/users/Aaron-Pool","html_url":"https://github.com/Aaron-Pool","followers_url":"https://api.github.com/users/Aaron-Pool/followers","following_url":"https://api.github.com/users/Aaron-Pool/following{/other_user}","gists_url":"https://api.github.com/users/Aaron-Pool/gists{/gist_id}","starred_url":"https://api.github.com/users/Aaron-Pool/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Aaron-Pool/subscriptions","organizations_url":"https://api.github.com/users/Aaron-Pool/orgs","repos_url":"https://api.github.com/users/Aaron-Pool/repos","events_url":"https://api.github.com/users/Aaron-Pool/events{/privacy}","received_events_url":"https://api.github.com/users/Aaron-Pool/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2022-10-12T22:25:28Z","updated_at":"2022-10-14T15:26:54Z","closed_at":"2022-10-14T02:51:16Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Version\r\n2.7.12\r\n\r\n### Reproduction link\r\n[Super slim repro on stackblitz](https://stackblitz.com/edit/vitejs-vite-15zdek?file=index.html)\r\n\r\n### Steps to reproduce\r\nJust open the stackblitz reproduction and check the console. You'll see:\r\n\r\n`[Vue warn]: onScopeDispose() is called when there is no active effect scope to be associated with.`\r\n\r\nIn general though, you can cause the issue like so:\r\n1. Create a detached effect scope before creating a regular vue VM\r\n2. Do something in the run block of that scope (like lazily import a file with a store definition) that causes a Vue VM to be created\r\n3. Call `onScopeDispose()`\r\n\r\n### What is expected?\r\nThe active scope tracking should be maintained, and not get \"tricked\" by not having an ancestor VM. \r\n\r\n### What is actually happening?\r\nWhen `setCurrentInstance(vm)` is called, it passes `prev` as the `vm` argument, which is `null`. This leads to `.off` being called on the detached `EffectScope` that Vue 2.7 creates when a VM is initialized. This is _not_ the detached scope that we created manually, mind you. And since `.off` is not supposed to be called on a detached `EffectScope` (it says this in explicitly in code comments), bad stuff happens and Vue's global `activeEffectScope` becomes `undefined`.\r\n\r\n---\r\nThis doesn't currently happen in our app at runtime (though I think it easily could), it happens during our test suite. We try to be as lazy as possible in our test environment when it comes to the code that each test imports, because it substantially helps jest run time, especially when running individual test files. Because of this, we use the `lazy` option of the `commonjs` babel plugin. This means the Vuex store that would normally be instantiated before the detached effect scope ends up getting created after the detached effect scope. But I haven't seen anything in the Vue docs to say I _shouldn't_ be able to create a detached effect scope before any other Vue VM, so I think this is a legitimate bug?\r\n\r\nI'd be willing to work on a PR to fix this, but I'd need guidance, since my limited knowledge base of Vue's internals would probably mean any solutions I would try might break other things.\r\n\r\nUpdate: Just adding a reference to related issue in Vue 3. Not sure how similar the internals of the effect scope implementation/tracking are, [but right here](https://github.com/vuejs/core/pull/5575#issuecomment-1088461788) @posva makes a comment that \"you would never call `off` on a detached effect scope\". But that does, indeed seem to be exactly what Vue 2.7 does. It seems like the buggy behavior the person who brought this up was worried about does indeed occur in some cases.\r\n\r\n<!-- generated by vue-issues. DO NOT REMOVE -->","closed_by":{"login":"yyx990803","id":499550,"node_id":"MDQ6VXNlcjQ5OTU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/499550?v=4","gravatar_id":"","url":"https://api.github.com/users/yyx990803","html_url":"https://github.com/yyx990803","followers_url":"https://api.github.com/users/yyx990803/followers","following_url":"https://api.github.com/users/yyx990803/following{/other_user}","gists_url":"https://api.github.com/users/yyx990803/gists{/gist_id}","starred_url":"https://api.github.com/users/yyx990803/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yyx990803/subscriptions","organizations_url":"https://api.github.com/users/yyx990803/orgs","repos_url":"https://api.github.com/users/yyx990803/repos","events_url":"https://api.github.com/users/yyx990803/events{/privacy}","received_events_url":"https://api.github.com/users/yyx990803/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/vuejs/vue/issues/12825/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/vuejs/vue/issues/12825/timeline","performed_via_github_app":null,"state_reason":"completed"}