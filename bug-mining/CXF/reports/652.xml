<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:42:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-2939] Permgen Leak in JAXB due to recreation of JAXBContexts in CXF</title>
                <link>https://issues.apache.org/jira/browse/CXF-2939</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;From &lt;a href=&quot;http://cxf.547215.n5.nabble.com/REST-web-service-loading-many-classes-for-each-request-CXF-2-2-6-and-jaxb-impl-2-1-5-td2266472.html#a2266472:&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cxf.547215.n5.nabble.com/REST-web-service-loading-many-classes-for-each-request-CXF-2-2-6-and-jaxb-impl-2-1-5-td2266472.html#a2266472:&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If a GC occurs, WeakRefs throw away the JAXBContext. So on the next occasion (where occasion could be one of billions of calls to a CXF/JAXB api) the JAXBContext has to be rebuilt from scratch. &lt;br/&gt;
JAXB (specifically com.sun.xml.bind.v2.runtime.reflect.opt.AccessorInjector) calls com.sun.xml.bind.v2.runtime.reflect.opt.Injector#find to try, if it already created a field or method accessor class. If not it injects a new one into the class loader via com.sun.xml.bind.v2.runtime.reflect.opt.Injector#inject. &lt;br/&gt;
The problem is now that #inject caches the generated accessor in the Injector and find only looks into the Injector (and never again into the class loader, where it used to define the class). But once a GC occurs the Injector throws itself away, too (caching itself in some weak map). &lt;/p&gt;

&lt;p&gt;So it happens that each REST api call after a GC occurred a hundred new classes are created by JAXB - because JAXB on low-level forgets the classes it defines (and keeps them on high-level) and CXF forgets the JAXBContext so that the high-level memory of JAXB is erased as well. &lt;/p&gt;

&lt;p&gt;There are four possible solutions: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Fix the Injector: Actually very easy and my favorite solution. Just let the Injector look into the class loader as well when it cannot find the class in its own memory. BUT to have a bug fixed in JAXB actually sounds scary, how long would that take to get into a version?)&lt;/li&gt;
	&lt;li&gt;Enable CXF to keep only one JAXB context (and not to throw it away) - do not know how to do that&lt;/li&gt;
	&lt;li&gt;Use a workaround to disable bytecode generation by JAXB (-Dcom.sun.xml.bind.v2.bytecode.ClassTailor.noOptimize=true) --&amp;gt; disables the whole bytecode magic Injector stuff and just does reflection - probably with a slight performance impact&lt;/li&gt;
	&lt;li&gt;Do not use JAXB with CXF on a website with significant load&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12471464">CXF-2939</key>
            <summary>Permgen Leak in JAXB due to recreation of JAXBContexts in CXF</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dkulp">Daniel Kulp</assignee>
                                    <reporter username="pvblivs">Stefan Schubert</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Aug 2010 21:26:09 +0000</created>
                <updated>Fri, 8 Apr 2011 11:02:37 +0000</updated>
                            <resolved>Fri, 13 Aug 2010 01:20:58 +0000</resolved>
                                    <version>2.1.5</version>
                                    <fixVersion>2.2.10</fixVersion>
                                    <component>JAX-RS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12897955" author="pvblivs" created="Thu, 12 Aug 2010 21:32:41 +0000"  >&lt;p&gt;This patch just changes WeakHashMaps to HashMaps in two lines. I did not write any tests as testing GC behaviour seemed a little ridiculous to me and the interface to create the JAXBContext is a static. Should I refactor anything that this is testable? Nevertheless testing if the GC doesn&apos;t throw away any Map entries sounds funny &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;But I executed the tests nonetheless. &lt;/p&gt;</comment>
                            <comment id="12913974" author="robneild" created="Thu, 23 Sep 2010 11:14:39 +0000"  >&lt;p&gt;The project I work on has the CXF libraries in the tomcat &quot;shared/lib&quot; area.&lt;/p&gt;

&lt;p&gt;When I upgraded to 2.2.10, restarting WARs in tomcat was broken (JAXBContextImpl.getBeanInfo generates exceptions saying it can&apos;t find beans)&lt;/p&gt;

&lt;p&gt;On investigation I found that with a WeakHashMap, JAXBContext is rebuild when a WAR was stopped and started.&lt;/p&gt;

&lt;p&gt;But using a HashMap means JAXBContext  isn&apos;t re-created on a application restart&lt;/p&gt;


&lt;p&gt;I am guessing people would advise the CXF libraries not be put into the shared classloader area &quot;shared/lib&quot; and should be in each individual application WAR?&lt;/p&gt;</comment>
                            <comment id="12913980" author="sergey_beryozkin" created="Thu, 23 Sep 2010 11:35:35 +0000"  >&lt;p&gt;Are you referring  to CXF JAXRS frontend ? In 2.2.10,  JAXBElementProvider does not use WeakHashMaps... &lt;/p&gt;</comment>
                            <comment id="12913983" author="pvblivs" created="Thu, 23 Sep 2010 11:50:34 +0000"  >&lt;p&gt;Yeah, Sergey - and that is the problem, as I understand it.&lt;/p&gt;

&lt;p&gt;Rob, this reads like a class-loader problem. CXF accesses application specific ressources like annotated beans etc. So it is not really a shared library like log4j or an Oracle jdbc driver for example, which have no runtime dependencies to your web application but only are service dependencies.&lt;/p&gt;

&lt;p&gt;Sorry to say that, but I would not put CXF into shared/lib. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12913991" author="sergey_beryozkin" created="Thu, 23 Sep 2010 12:09:02 +0000"  >&lt;p&gt;Hmm...&lt;/p&gt;

&lt;p&gt;So we&apos;ve solved one problem but have introduced another one...&lt;/p&gt;

&lt;p&gt;To be honest - this is not the problem of the CXF but that of JAXBElementProvider - quickly rebuilding the one from source and replacing HashMap with WeakHashMap will do it if the weak map is expected.&lt;/p&gt;

&lt;p&gt;But there must be a better way to choose between HashMaps and WeakHashMaps if it is what is needed to help users to put the cxf  into the shared lib  &lt;/p&gt;</comment>
                            <comment id="12914057" author="pvblivs" created="Thu, 23 Sep 2010 15:05:30 +0000"  >&lt;p&gt;Does CXF work as a shared lib anyway? Can I deploy a second Webapp using CXF and it works with the shared lib? If not, we should not do anything to enable this.&lt;/p&gt;

&lt;p&gt;If yes, you can think about a shutdown or refresh hook. As far as I know CXF already listens to Spring framework application events. If it is shutting down or refreshing, you could simply evict the context specific caches. Just look at org.apache.cxf.transport.servlet.CXFServlet#onApplicationEvent which is already doing maintenance work on refreshes. It could probably do more&lt;/p&gt;</comment>
                            <comment id="12914234" author="dkulp" created="Thu, 23 Sep 2010 21:28:16 +0000"  >&lt;p&gt;&lt;br/&gt;
&lt;br/&gt;
Well, CXF needs to work as a shared library.  In an OSGi environment, CXF would be another bundle deployed in the OSGi container and thus must be sharable.   Thus, if there are bugs, we need to get them fixed.&lt;/p&gt;</comment>
                            <comment id="13017393" author="sergey_beryozkin" created="Fri, 8 Apr 2011 11:02:37 +0000"  >&lt;p&gt;JAXBProviders are endpoint scoped in 2.4.0 - so no WAR &apos;specific&apos; JAXB contexts will be stored at the shared loader level&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12451952" name="removed_weak_hash_maps.patch" size="1035" author="pvblivs" created="Thu, 12 Aug 2010 21:32:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47258</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 33 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14dwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>233715</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>