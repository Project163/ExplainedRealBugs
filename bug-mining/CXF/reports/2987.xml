<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:23:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-5754] JMSConduit - temporary queue not beeing closed if relpyMessage is null (timeout)</title>
                <link>https://issues.apache.org/jira/browse/CXF-5754</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Our implementation:&lt;br/&gt;
CXF 2.7.11&lt;br/&gt;
JMS Queue on TIBCO&lt;/p&gt;

&lt;p&gt;We have the problem, that if a timeout is raised the temporary queue is not been deleted.&lt;/p&gt;

&lt;p&gt;After code review of the JmsConduit class we have seen, that in case of a timeout, cxf is only raises only an RuntimeException (JmsConduit line 256)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; javax.jms.Message replyMessage = jmsTemplate.receiveSelected(replyToDestination, messageSelector);
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (replyMessage == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Timeout receiving message with correlationId &quot;&lt;/span&gt; + correlationId);
                    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                        doReplyMessage(exchange, replyMessage);
                    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;Is this the problem why the temporary queue is not been closed in case of a timeout? Is there an solution for this problem?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</description>
                <environment></environment>
        <key id="12715691">CXF-5754</key>
            <summary>JMSConduit - temporary queue not beeing closed if relpyMessage is null (timeout)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cschneider">Christian Schneider</assignee>
                                    <reporter username="dhds">Philipp Hahn</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 May 2014 07:08:23 +0000</created>
                <updated>Wed, 19 Apr 2017 14:23:05 +0000</updated>
                            <resolved>Wed, 15 Mar 2017 13:33:10 +0000</resolved>
                                    <version>2.7.11</version>
                                    <fixVersion>3.0.13</fixVersion>
                    <fixVersion>3.1.11</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                                    <component>WS-* Components</component>
                        <due></due>
                            <votes>5</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14053572" author="chris@die-schneider.net" created="Mon, 7 Jul 2014 11:57:59 +0000"  >&lt;p&gt;I have completely redesigned the CXF JMS transport for CXF 3. Can you check if migrating solves the problem? &lt;br/&gt;
If yes. Would it be ok to for you to use CXF 3 or do you need a fix in 2.x?&lt;/p&gt;</comment>
                            <comment id="15549013" author="kalarkar" created="Wed, 5 Oct 2016 15:04:05 +0000"  >&lt;p&gt;on the same issue we are using cxf 3.0.5 and once TIBCO return null cxf class JMSUtil throws Runtime exception and JMSConduit will not clear the correlationMap. This causes a memory leak.&lt;/p&gt;

&lt;p&gt; public static Message receive(Session session,&lt;br/&gt;
                                  Destination replyToDestination,&lt;br/&gt;
                                  String correlationId,&lt;br/&gt;
                                  long receiveTimeout,&lt;br/&gt;
                                  boolean pubSubNoLocal) {&lt;br/&gt;
        ResourceCloser closer = new ResourceCloser();&lt;br/&gt;
        try {&lt;br/&gt;
            String messageSelector = correlationId == null ? null : &quot;JMSCorrelationID = &apos;&quot; + correlationId + &quot;&apos;&quot;;&lt;/p&gt;

&lt;p&gt;            javax.jms.Message replyMessage = consumer.receive(receiveTimeout);&lt;br/&gt;
            if (replyMessage == null) &lt;/p&gt;
{
                throw new RuntimeException(&quot;Timeout receiving message with correlationId &quot;
                                           + correlationId);
            }



&lt;p&gt;in JMSConduit     correlationMap.remove(correlationId);  will not get called.&lt;/p&gt;
</comment>
                            <comment id="15875203" author="sellhorn" created="Tue, 21 Feb 2017 01:22:41 +0000"  >&lt;p&gt;Yes, still an issue in CXF 3.0.4 and 3.0.5&lt;/p&gt;

&lt;p&gt;I have a test that will make calls to a server with a component that processes calls that timeout, you can see the memory increase over a 4 hour period and make the VM get an OOM error.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12853623/12853623_memory-leak-due-to-timeouts-4hrs.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;When you do an analysis on the Eclipse Memory Analyzer, it detects the leak in JMSConduit&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12853625/12853625_eclipse-mem-analyzer.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;The top objects stored in memory turn out to be HashMap related (java.util.HashMap$Node)&lt;/p&gt;</comment>
                            <comment id="15882656" author="dansalt" created="Fri, 24 Feb 2017 13:25:22 +0000"  >&lt;p&gt;Further to Augusto&apos;s comments above (we are in the same team). The code highlighted by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kalarkar&quot; class=&quot;user-hover&quot; rel=&quot;kalarkar&quot;&gt;kalarkar&lt;/a&gt; does indeed appear to be the source of the issue, and patching it to clear up the correlation map on timeouts/exceptions does completely fix the memory leak. This same code also appears in 3.0.12, which we are in the process of moving to (we have deployments on both 3.0.4 and 3.0.12). I actually added code in two places in sendAndReceiveMessage:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;A catch/rethrow around the call to JMSUtil.receive(..), because it will throw an uncaught JMSException on timeout.  If the correlation Id is not null, remove the item from the map and rethrow the exception.&lt;/li&gt;
	&lt;li&gt;In the call to exchange.wait(jmsConfig.getReceiveTimeout()). Code added to remove (if correlationId is not null) the entry from the map in two cases (a) if an InterruptedException is caught, just before we throw a RuntimeException, and (b) in the clause &quot;if (exchange.get(CORRELATED) != Boolean.TRUE)&quot;, just before throwing a RuntimeException.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Resulting code snip looks like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;JMSConduit.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (exchange.isSynchronous()) {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (useSyncReceive) {
                    &lt;span class=&quot;code-comment&quot;&gt;// TODO Not sure &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; replyToDestination is correct here
&lt;/span&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                        javax.jms.Message replyMessage = JMSUtil.receive(session, replyToDestination,
                                correlationId,
                                jmsConfig.getReceiveTimeout(),
                                jmsConfig.isPubSubNoLocal());
                        correlationMap.remove(correlationId);
                        processReplyMessage(exchange, replyMessage);
                    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (RuntimeException e) {
                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (correlationId != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                            correlationMap.remove(correlationId);
                        }
                        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
                    }
                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                        exchange.wait(jmsConfig.getReceiveTimeout());
                    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) {
                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (correlationId != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                            correlationMap.remove(correlationId);
                        }
                        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Interrupted &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; correlating&quot;&lt;/span&gt;, e);
                    }
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (exchange.get(CORRELATED) != &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.TRUE) {
                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (correlationId != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                            correlationMap.remove(correlationId);
                        }
                        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Timeout receiving message with correlationId &quot;&lt;/span&gt;
                                                   + correlationId);
                    }
                }
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15924966" author="dansalt" created="Tue, 14 Mar 2017 20:49:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sergeyb&quot; class=&quot;user-hover&quot; rel=&quot;sergeyb&quot;&gt;sergeyb&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dkulp&quot; class=&quot;user-hover&quot; rel=&quot;dkulp&quot;&gt;dkulp&lt;/a&gt; - any chance you can take a look at this? We currently have this patched but I&apos;d be more comfortable if you could take a look and validate that my suggestion above actually solves the problem correctly. Cheers!&lt;/p&gt;</comment>
                            <comment id="15925054" author="sergey_beryozkin" created="Tue, 14 Mar 2017 21:34:02 +0000"  >&lt;p&gt;Christian, can you check it please ?&lt;/p&gt;</comment>
                            <comment id="15925782" author="dansalt" created="Wed, 15 Mar 2017 09:15:06 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chris%40die-schneider.net&quot; class=&quot;user-hover&quot; rel=&quot;chris@die-schneider.net&quot;&gt;chris@die-schneider.net&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for taking ownership of this issue - much appreciated. Any chance it can also be backported to the 3.0.x stream? We&apos;re currently stuck on 3.0.x until we can move onto Spring 4/Karaf 4.&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Dan&lt;/p&gt;</comment>
                            <comment id="15925787" author="chris@die-schneider.net" created="Wed, 15 Mar 2017 09:17:44 +0000"  >&lt;p&gt;I will back port as soon as we have a working solution on master.&lt;/p&gt;</comment>
                            <comment id="15925795" author="chris@die-schneider.net" created="Wed, 15 Mar 2017 09:27:42 +0000"  >&lt;p&gt;I have just committed a slightly changed version of your changes to master. Can you please check if it works for you and give feedback?&lt;br/&gt;
See &lt;a href=&quot;https://github.com/apache/cxf/commit/a911f8cf5f912e4927269015717dab49bd3148fe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/commit/a911f8cf5f912e4927269015717dab49bd3148fe&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I will backport as soon as you are fine with it.&lt;/p&gt;</comment>
                            <comment id="15925801" author="dansalt" created="Wed, 15 Mar 2017 09:31:58 +0000"  >&lt;p&gt;Will do, thanks for the quick response. Will let you know once we&apos;ve tested it.&lt;/p&gt;</comment>
                            <comment id="15925973" author="dansalt" created="Wed, 15 Mar 2017 11:55:25 +0000"  >&lt;p&gt;Hi Christian,&lt;/p&gt;

&lt;p&gt;I can confirm that using a simple unit test (that aggressively sends request/reply messages to a JMS destination with no consumer, with a short timeout), against an unfixed 3.0.11 JMS transport runs out of memory on a 100mb VM in just under 5 minutes.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12858868/12858868_unfixed-test01.png&quot; width=&quot;300&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;But a modified 3.0.12 (using your fixed code) against the same test is happily running over 20 minutes later - no signs of a leak.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12858869/12858869_fixed-test01.png&quot; width=&quot;400&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;This matches what we saw with our initial patch - so I think we call your fix a success &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Dan&lt;/p&gt;</comment>
                            <comment id="15926183" author="chris@die-schneider.net" created="Wed, 15 Mar 2017 13:33:10 +0000"  >&lt;p&gt;Thanks for validating the change. I have now back ported to 3.1.x and 3.0.x.&lt;/p&gt;</comment>
                            <comment id="15928550" author="kalarkar" created="Thu, 16 Mar 2017 18:07:15 +0000"  >&lt;p&gt;Thanks for resolving this issue. May I know know which version of CXF we need to pick up that contains this fix? &lt;/p&gt;</comment>
                            <comment id="15930362" author="chris@die-schneider.net" created="Fri, 17 Mar 2017 17:45:16 +0000"  >&lt;p&gt;You can see the versions in the fix versions of the issue. Of course we will need thoses releases first.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                            <outwardlinks description="contains">
                                        <issuelink>
            <issuekey id="13010443">CXF-7079</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12853625" name="eclipse-mem-analyzer.png" size="73563" author="sellhorn" created="Tue, 21 Feb 2017 01:21:16 +0000"/>
                            <attachment id="12858869" name="fixed-test01.png" size="329599" author="DanSalt" created="Wed, 15 Mar 2017 11:52:33 +0000"/>
                            <attachment id="12853623" name="memory-leak-due-to-timeouts-4hrs.png" size="56241" author="sellhorn" created="Tue, 21 Feb 2017 01:15:01 +0000"/>
                            <attachment id="12858868" name="unfixed-test01.png" size="198367" author="DanSalt" created="Wed, 15 Mar 2017 11:52:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>393976</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 35 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1vu3z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>394116</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>