<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:34:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-8124] CXF metrics - MetricsContext#stop called twice or without Fault in certain error cases</title>
                <link>https://issues.apache.org/jira/browse/CXF-8124</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;While using the CXF metrics feature with a CXF REST client, in some situation there are incoherent calls to the MetricsContext#stop method. 2 cases can be isolated: server returns a 404 and the response body transmission is interrupted in the middle of the transfer.&lt;/p&gt;

&lt;p&gt;I wrote a unit test that allows to clearly reproduce the 2 use cases. Of course they are failing. The test prints out a stacktrace per call to the MetricsContext#stop method.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;notFoundStatusCode_stopCalledOnceWithFaultObjectInExchange&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO cxf.reproducers.CxfMetricsIssueReproducerTest - MetricsContext#stop called 2 times&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO cxf.reproducers.CxfMetricsIssueReproducerTest - - stop called with time = 16408651 ns, inSize = -1, outSize = 0, exchange that contains a FaultMode = false; callad at:&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;br/&gt;
 at org.apache.cxf.metrics.MetricsContext$$EnhancerByMockitoWithCGLIB$$1997d2d2.stop(&amp;lt;generated&amp;gt;)&lt;br/&gt;
 at org.apache.cxf.metrics.ExchangeMetrics.stop(ExchangeMetrics.java:75)&lt;br/&gt;
 at org.apache.cxf.metrics.interceptors.AbstractMetricsInterceptor.stop(AbstractMetricsInterceptor.java:215)&lt;br/&gt;
 at org.apache.cxf.metrics.interceptors.MetricsMessageInPostInvokeInterceptor.handleMessage(MetricsMessageInPostInvokeInterceptor.java:34)&lt;br/&gt;
 at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:308)&lt;br/&gt;
 at org.apache.cxf.jaxrs.client.ClientMessageObserver.onMessage(ClientMessageObserver.java:56)&lt;br/&gt;
 at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.handleResponseInternal(HTTPConduit.java:1693)&lt;br/&gt;
 at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.handleResponse(HTTPConduit.java:1570)&lt;br/&gt;
 at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.close(HTTPConduit.java:1371)&lt;br/&gt;
 at org.apache.cxf.io.AbstractWrappedOutputStream.close(AbstractWrappedOutputStream.java:77)&lt;br/&gt;
 at org.apache.cxf.metrics.interceptors.CountingOutputStream.close(CountingOutputStream.java:47)&lt;br/&gt;
 at org.apache.cxf.transport.AbstractConduit.close(AbstractConduit.java:56)&lt;br/&gt;
 at org.apache.cxf.transport.http.HTTPConduit.close(HTTPConduit.java:671)&lt;br/&gt;
 at org.apache.cxf.interceptor.MessageSenderInterceptor$MessageSenderEndingInterceptor.handleMessage(MessageSenderInterceptor.java:63)&lt;br/&gt;
 at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:308)&lt;br/&gt;
 at org.apache.cxf.jaxrs.client.AbstractClient.doRunInterceptorChain(AbstractClient.java:709)&lt;br/&gt;
 at org.apache.cxf.jaxrs.client.ClientProxyImpl.doChainedInvocation(ClientProxyImpl.java:887)&lt;br/&gt;
 at org.apache.cxf.jaxrs.client.ClientProxyImpl.invoke(ClientProxyImpl.java:335)&lt;br/&gt;
 at com.sun.proxy.$Proxy22.getBook(Unknown Source)&lt;br/&gt;
 at cxf.reproducers.CxfMetricsIssueReproducerTest.notFoundStatusCode_stopCalledOnceWithFaultObjectInExchange(CxfMetricsIssueReproducerTest.java:151)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO cxf.reproducers.CxfMetricsIssueReproducerTest - - stop called with time = 26412378 ns, inSize = -1, outSize = 0, exchange that contains a FaultMode = true; callad at:&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;br/&gt;
 at org.apache.cxf.metrics.MetricsContext$$EnhancerByMockitoWithCGLIB$$1997d2d2.stop(&amp;lt;generated&amp;gt;)&lt;br/&gt;
 at org.apache.cxf.metrics.ExchangeMetrics.stop(ExchangeMetrics.java:75)&lt;br/&gt;
 at org.apache.cxf.metrics.interceptors.AbstractMetricsInterceptor.stop(AbstractMetricsInterceptor.java:215)&lt;br/&gt;
 at org.apache.cxf.metrics.interceptors.MetricsMessageInPostInvokeInterceptor.handleMessage(MetricsMessageInPostInvokeInterceptor.java:34)&lt;br/&gt;
 at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:308)&lt;br/&gt;
 at org.apache.cxf.interceptor.AbstractFaultChainInitiatorObserver.onMessage(AbstractFaultChainInitiatorObserver.java:112)&lt;br/&gt;
 at org.apache.cxf.jaxrs.client.ClientProxyImpl.checkResponse(ClientProxyImpl.java:434)&lt;br/&gt;
 at org.apache.cxf.jaxrs.client.ClientProxyImpl.handleResponse(ClientProxyImpl.java:990)&lt;br/&gt;
 at org.apache.cxf.jaxrs.client.ClientProxyImpl.doChainedInvocation(ClientProxyImpl.java:895)&lt;br/&gt;
 at org.apache.cxf.jaxrs.client.ClientProxyImpl.invoke(ClientProxyImpl.java:335)&lt;br/&gt;
 at com.sun.proxy.$Proxy22.getBook(Unknown Source)&lt;br/&gt;
 at cxf.reproducers.CxfMetricsIssueReproducerTest.notFoundStatusCode_stopCalledOnceWithFaultObjectInExchange(CxfMetricsIssueReproducerTest.java:151)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;incompleteResponse_stopCalledOnceWithFaultObjectInExchange&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO cxf.reproducers.CxfMetricsIssueReproducerTest - MetricsContext#stop called 1 times&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO cxf.reproducers.CxfMetricsIssueReproducerTest - - stop called with time = 14901568 ns, inSize = -1, outSize = 0, exchange that contains a FaultMode = false; callad at:&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;br/&gt;
 at org.apache.cxf.metrics.MetricsContext$$EnhancerByMockitoWithCGLIB$$1997d2d2.stop(&amp;lt;generated&amp;gt;)&lt;br/&gt;
 at org.apache.cxf.metrics.ExchangeMetrics.stop(ExchangeMetrics.java:75)&lt;br/&gt;
 at org.apache.cxf.metrics.interceptors.AbstractMetricsInterceptor.stop(AbstractMetricsInterceptor.java:215)&lt;br/&gt;
 at org.apache.cxf.metrics.interceptors.MetricsMessageInPostInvokeInterceptor.handleMessage(MetricsMessageInPostInvokeInterceptor.java:34)&lt;br/&gt;
 at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:308)&lt;br/&gt;
 at org.apache.cxf.jaxrs.client.ClientMessageObserver.onMessage(ClientMessageObserver.java:56)&lt;br/&gt;
 at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.handleResponseInternal(HTTPConduit.java:1693)&lt;br/&gt;
 at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.handleResponse(HTTPConduit.java:1570)&lt;br/&gt;
 at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.close(HTTPConduit.java:1371)&lt;br/&gt;
 at org.apache.cxf.io.AbstractWrappedOutputStream.close(AbstractWrappedOutputStream.java:77)&lt;br/&gt;
 at org.apache.cxf.metrics.interceptors.CountingOutputStream.close(CountingOutputStream.java:47)&lt;br/&gt;
 at org.apache.cxf.transport.AbstractConduit.close(AbstractConduit.java:56)&lt;br/&gt;
 at org.apache.cxf.transport.http.HTTPConduit.close(HTTPConduit.java:671)&lt;br/&gt;
 at org.apache.cxf.interceptor.MessageSenderInterceptor$MessageSenderEndingInterceptor.handleMessage(MessageSenderInterceptor.java:63)&lt;br/&gt;
 at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:308)&lt;br/&gt;
 at org.apache.cxf.jaxrs.client.AbstractClient.doRunInterceptorChain(AbstractClient.java:709)&lt;br/&gt;
 at org.apache.cxf.jaxrs.client.ClientProxyImpl.doChainedInvocation(ClientProxyImpl.java:887)&lt;br/&gt;
 at org.apache.cxf.jaxrs.client.ClientProxyImpl.invoke(ClientProxyImpl.java:335)&lt;br/&gt;
 at com.sun.proxy.$Proxy22.getBook(Unknown Source)&lt;br/&gt;
 at cxf.reproducers.CxfMetricsIssueReproducerTest.incompleteResponse_stopCalledOnceWithFaultObjectInExchange(CxfMetricsIssueReproducerTest.java:171)&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13259242">CXF-8124</key>
            <summary>CXF metrics - MetricsContext#stop called twice or without Fault in certain error cases</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="reta">Andriy Redko</assignee>
                                    <reporter username="mederel">Emile de Weerd</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 Sep 2019 11:11:39 +0000</created>
                <updated>Wed, 16 Oct 2019 23:15:52 +0000</updated>
                            <resolved>Mon, 14 Oct 2019 01:47:12 +0000</resolved>
                                    <version>3.1.18</version>
                    <version>3.3.3</version>
                                    <fixVersion>3.2.11</fixVersion>
                    <fixVersion>3.3.4</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16946398" author="reta" created="Tue, 8 Oct 2019 02:01:29 +0000"  >&lt;p&gt;Thanks for the test cases &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mederel&quot; class=&quot;user-hover&quot; rel=&quot;mederel&quot;&gt;mederel&lt;/a&gt;, indeed I could reproduce the issue, for some reason the MetricsMessageInPostInvokeInterceptor interceptor is called twice, once for inbound message, and once for outbound message. Why is that is not clear yet.&lt;/p&gt;</comment>
                            <comment id="16952902" author="mederel" created="Wed, 16 Oct 2019 14:49:12 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reta&quot; class=&quot;user-hover&quot; rel=&quot;reta&quot;&gt;reta&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;thank you for you reactivity!&lt;/p&gt;

&lt;p&gt;I saw the new tests part of the opened PRs, they look like the snippet of code provided here &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I took the latest master code, built it and ran the test against it. One of the 2 use cases has been indeed fixed: &lt;b&gt;notFoundStatusCode_stopCalledOnceWithFaultObjectInExchange&lt;/b&gt;&lt;br/&gt;
However the other is still failing.&lt;/p&gt;

&lt;p&gt;As this is kind of my fault of not having opened another issue for this other case, I will close this issue and open another one. Hope this is satisfactory.&lt;/p&gt;</comment>
                            <comment id="16952904" author="mederel" created="Wed, 16 Oct 2019 14:50:03 +0000"  >&lt;p&gt;Checked &lt;b&gt;notFoundStatusCode_stopCalledOnceWithFaultObjectInExchange&lt;/b&gt; test case and it is passing with latest master code.&lt;/p&gt;</comment>
                            <comment id="16953264" author="reta" created="Wed, 16 Oct 2019 23:15:52 +0000"  >&lt;p&gt;Thanks for confirming the fix, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mederel&quot; class=&quot;user-hover&quot; rel=&quot;mederel&quot;&gt;mederel&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                                                <inwardlinks description="is cloned by">
                                        <issuelink>
            <issuekey id="13262651">CXF-8132</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12981547" name="cxf-metrics-context-stop-issue.tar.xz" size="4068" author="mederel" created="Fri, 27 Sep 2019 11:30:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10062"><![CDATA[Moderate]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 4 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z072y0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>