<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:25:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-6782] Modifications to JAX-WS client request context leak the thread scope</title>
                <link>https://issues.apache.org/jira/browse/CXF-6782</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;As documented in &lt;a href=&quot;https://cxf.apache.org/faq.html#FAQ-AreJAX-WSclientproxiesthreadsafe?&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; page the request context can be made thread local (&lt;cite&gt;Thus, anything set there will affect requests on other threads.&lt;/cite&gt;), but&lt;br/&gt;
I observed that even after having set the property &lt;em&gt;thread.local.request.context&lt;/em&gt; it arrives sometimes that some modifications to the request context leak the thread scope, leading potentially to unpredictable behaviors.&lt;/p&gt;

&lt;p&gt;Digging in the code I found that the reason is the following.&lt;/p&gt;

&lt;p&gt;The class &lt;em&gt;org.apache.cxf.endpoint.ClientImpl&lt;/em&gt; stores the request context entries in a map called &lt;em&gt;currentRequestContext&lt;/em&gt;. After property &lt;em&gt;thread.local.request.context&lt;/em&gt; is set to true a call to &lt;em&gt;getRequestContext()&lt;/em&gt; triggers the creation of another map of type &lt;em&gt;org.apache.cxf.endpoint.ClientImpl.EchoContext&lt;/em&gt; which is associated to the current thread (the mapping is kept in the &lt;em&gt;requestContext&lt;/em&gt; map). This should guarantee the per thread isolation.&lt;br/&gt;
The &lt;em&gt;EchoContext&lt;/em&gt; is initialized with the entries of the shared map, and as its name suggests modifications are echoed back to the shared map. The problem is that when accessing the request context for the first time in a thread all the modifications done on other threads do affect the current thread even after &quot;thread.local.request.context&quot; is set to true, due to the initialization of the thread local map with shared one.&lt;/p&gt;</description>
                <environment>&lt;p&gt;java version &quot;1.7.0_80&quot;&lt;/p&gt;</environment>
        <key id="12939806">CXF-6782</key>
            <summary>Modifications to JAX-WS client request context leak the thread scope</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ffang">Freeman Yue Fang</assignee>
                                    <reporter username="iacopo">Iacopo Rozzo</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Feb 2016 11:30:22 +0000</created>
                <updated>Tue, 1 Aug 2017 16:42:09 +0000</updated>
                            <resolved>Thu, 4 May 2017 03:24:11 +0000</resolved>
                                    <version>3.0.7</version>
                                    <fixVersion>3.1.12</fixVersion>
                    <fixVersion>3.0.14</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15150619" author="iacopo" created="Wed, 17 Feb 2016 15:09:13 +0000"  >&lt;p&gt;Contains a Maven project with a unit test to reproduce the issue.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;tar xzvf CXF-6782_reproducer.tar.gz
cd CXF-6782_reproducer
mvn test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15221583" author="jera" created="Fri, 1 Apr 2016 11:47:49 +0000"  >&lt;p&gt;We have been using CXF version 2.7.18.redhat-1 as packaged in Red Hat JBoss EAP 6.4.6 which also exposes this problem in highly concurrent situations. Enabling &lt;tt&gt;thread.local.request.context&lt;/tt&gt; does help to keep the request context separate per thread, but only for one level deep.&lt;/p&gt;

&lt;p&gt;For example, the &lt;tt&gt;Message.PROTOCOL_HEADERS&lt;/tt&gt; property is set on the request context with a value that is an instance of TreeMap&amp;lt;String, List&amp;lt;String&amp;gt;&amp;gt;. Although the request context itself is separate, this map is modified directly if the key already exists.&lt;/p&gt;

&lt;p&gt;We are seeing this problem when sending SOAP 1.1 requests using the CXF proxy client:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Two requests are sent at approximately the same time&lt;/li&gt;
	&lt;li&gt;Request 1 sets the SOAPAction header by modifying the PROTOCOL_HEADERS TreeMap (which at that point already exists)&lt;/li&gt;
	&lt;li&gt;Request 2 sets the SOAPAction header by modifying the PROTOCOL_HEADERS TreeMap&lt;/li&gt;
	&lt;li&gt;Request 1 performs the HTTP request, sending the wrong SOAPAction header&lt;/li&gt;
	&lt;li&gt;Request 2 is performed successfully&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15616679" author="ranadeep.sharma@gmail.com" created="Fri, 28 Oct 2016 21:40:42 +0000"  >&lt;p&gt;Same issue is reproducible with CXF version 3.1.6 too.&lt;br/&gt;
The said method in ClientImpl.java code for CXF version 3.1.8 has NOT change either. Do we have any ETA when this would be fixed and in which version?&lt;/p&gt;

&lt;p&gt;Most important - Could someone suggest a workaround to ensure the thread local feature works as expected? Say, a way to override ClientImpl.java with following method customization, where a new ConcurrentHashMap is instantiated.&lt;/p&gt;

&lt;p&gt;    public Map&amp;lt;String, Object&amp;gt; getRequestContext() {&lt;br/&gt;
        if (isThreadLocalRequestContext()) {&lt;br/&gt;
            if (!requestContext.containsKey(Thread.currentThread())) &lt;/p&gt;
{
                Map&amp;lt;String, Object&amp;gt; freshRequestContext = new ConcurrentHashMap&amp;lt;String, Object&amp;gt;(8, 0.75f, 4);
                requestContext.put(Thread.currentThread(), new EchoContext(freshRequestContext));
            }
&lt;p&gt;            return requestContext.get(Thread.currentThread());&lt;br/&gt;
        }&lt;br/&gt;
        return currentRequestContext;&lt;br/&gt;
    }&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12788250" name="CXF-6782_reproducer.tar.gz" size="2767" author="iacopo" created="Wed, 17 Feb 2016 15:09:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2sxyv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>