<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:41:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-9162] Reusing a Client with a HttpClientHTTPConduit is not threadsafe in regards to finalization</title>
                <link>https://issues.apache.org/jira/browse/CXF-9162</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;If a RestClient is created with the default HttpClientHTTPConduit it reuses the client by default.&lt;/p&gt;

&lt;p&gt;This, however, is not threadsafe in all cases, which is especially problematic when the client is implicitly closed by the finalizer. Consider the following example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ResourceProblemWithCxfClientWithHttpClientHTTPConduitTest {

    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; URL = &lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8080/&quot;&lt;/span&gt;;
&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Server server;

    @BeforeAll
    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void startServer() {
        &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; serverFactoryBean = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JAXRSServerFactoryBean();
        serverFactoryBean.setResourceClasses(MyServiceImpl.class);
        serverFactoryBean.setAddress(URL);
        server = serverFactoryBean.create();
    }

    @AfterAll
    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void stopServer() {
        server.stop();
    }

    @Test
    void testMultipleProxyCalls() {
        &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; clientFactoryBean = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JAXRSClientFactoryBean();
        clientFactoryBean.setAddress(URL);
        clientFactoryBean.setResourceClass(MyService.class);

        &lt;span class=&quot;code-comment&quot;&gt;// Create the first Client and call the RestService
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; myClient1 = clientFactoryBean.create(MyService.class);
        myClient1.hello();

        &lt;span class=&quot;code-comment&quot;&gt;// Create a second Client, but &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not call yet
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; myClient2 = clientFactoryBean.create(MyService.class);
        &lt;span class=&quot;code-comment&quot;&gt;// Register an async GC with finalizer exec and make client1 eligible &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; gc
&lt;/span&gt;        CompletableFuture.runAsync(() -&amp;gt; {
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.gc();
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.runFinalization();
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.gc();
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;GC&apos;D&quot;&lt;/span&gt;);
        });
        myClient1 = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;

        &lt;span class=&quot;code-comment&quot;&gt;// Now call the second client:
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// -- with Java17, the method very often just blocks forever
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// -- with Java21, it might &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; the following exception:
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// jakarta.ws.rs.ProcessingException: java.io.IOException: IOException invoking http://localhost:8080/hello:
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// shutdownNow
&lt;/span&gt;        myClient2.hello();

        &lt;span class=&quot;code-comment&quot;&gt;// the reason behind seems to be wether the resource-aquiciring of the shared client collides
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// with the cleanup of the first in the finalizer
&lt;/span&gt;    }

    @Path(&quot;&quot;)
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; MyService {

        @GET
        @Path(&lt;span class=&quot;code-quote&quot;&gt;&quot;/hello&quot;&lt;/span&gt;)
        void hello();
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyServiceImpl &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; MyService {

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void hello() {
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;hello&quot;&lt;/span&gt;);
        }
    }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When everything works fine, this code prints the following:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;hello
GC&apos;D
hello&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In many cases, however, it does not, because the GC collects the first client while second tries to acquire the ressource. Here, the garbage collector is aggressively invoked, but this has happend to us in production as well if the GC thinks its cleanup time while the second webclient-invocation starts.&lt;/p&gt;

&lt;p&gt;In the error case, the following can happen:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;On Java 17, the first two statements are printed, then the test hangs forever&lt;/li&gt;
	&lt;li&gt;On Java 21+ which invokes close on the httpclient, all statments are printed followed by an IOException:&#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;17:35:13.284 [main] WARN org.apache.cxf.phase.PhaseInterceptorChain -- Interceptor for {http://rest.itest.appkit.platform.arc.finkonsens.de/}MyService has thrown exception, unwinding now
org.apache.cxf.interceptor.Fault: Could not send Message.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This error always happens when the gc finalizer closes the last running httpclient while a new call tries to acquired the shared client. If you cannot reproduce it with the test case above, then just run it in debug mode and set the following breakpoint with a hit count of 2 and blocking only the active thread, not all threads:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;HttpClientHTTPConduit.RefCount.acquire&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This should block the acquire long enough so that the error will always happen.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13627240">CXF-9162</key>
            <summary>Reusing a Client with a HttpClientHTTPConduit is not threadsafe in regards to finalization</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ffang">Freeman Yue Fang</assignee>
                                    <reporter username="cheesemaster">Eric</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Aug 2025 15:58:55 +0000</created>
                <updated>Sun, 28 Sep 2025 18:43:17 +0000</updated>
                            <resolved>Tue, 9 Sep 2025 16:31:10 +0000</resolved>
                                                    <fixVersion>4.1.4</fixVersion>
                    <fixVersion>3.6.9</fixVersion>
                    <fixVersion>4.0.10</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="18016119" author="ffang" created="Mon, 25 Aug 2025 21:22:07 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cheesemaster&quot; class=&quot;user-hover&quot; rel=&quot;cheesemaster&quot;&gt;cheesemaster&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for raising this issue and the reproducer. Yes, I can see the problem with both JDK17 and JDK21.&lt;/p&gt;

&lt;p&gt;I believe this is caused by the race condition in HttpClientHTTPConduit.RefCount class&lt;/p&gt;

&lt;p&gt;So imagine this timeline:&lt;br/&gt;
Client1 calls release().&lt;br/&gt;
count.decrementAndGet() returns 0.&lt;br/&gt;
Thread enters the shutdown block, but hasn&#8217;t executed it yet.&lt;br/&gt;
Client2 calls acquire() while Client1 is still in the shutdown block.&lt;br/&gt;
count.incrementAndGet() brings count back to 1.&lt;br/&gt;
But it&#8217;s too late &#8212; Client1 is already about to shut down the underlying HttpClient.&lt;/p&gt;

&lt;p&gt;Need to revisit the HttpClientHTTPConduit.RefCount class.&lt;/p&gt;

&lt;p&gt;Freeman&lt;/p&gt;
</comment>
                            <comment id="18016120" author="reta" created="Mon, 25 Aug 2025 21:26:35 +0000"  >&lt;p&gt;Thanks for taking it &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ffang&quot; class=&quot;user-hover&quot; rel=&quot;ffang&quot;&gt;ffang&lt;/a&gt; , I think the fix should be to never use the client that has 0 ref counter on `acquire` call, it basically means the client is being destroyed.&lt;/p&gt;</comment>
                            <comment id="18016121" author="ffang" created="Mon, 25 Aug 2025 21:33:18 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reta&quot; class=&quot;user-hover&quot; rel=&quot;reta&quot;&gt;reta&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Yes, that&apos;s what I&apos;m going to do as well, besides the solution to resolve the race condition. We need do something like&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
         * Acquire a reference. Throws &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; shutdown has begun.
         */
        &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; RefCount&amp;lt;T&amp;gt; acquire() {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shuttingDown) {
                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Client already shutting down&quot;&lt;/span&gt;);
            }
            count++;
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;;
        }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;for the acquire() method to let user know the client is being destroyed and have chance to handle this case accordingly.&lt;/p&gt;

&lt;p&gt;I will send the PR for review once it&apos;s done&lt;/p&gt;

&lt;p&gt;Best Regards&lt;br/&gt;
Freeman &lt;/p&gt;</comment>
                            <comment id="18016130" author="reta" created="Mon, 25 Aug 2025 21:59:41 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ffang&quot; class=&quot;user-hover&quot; rel=&quot;ffang&quot;&gt;ffang&lt;/a&gt; , I think we don&apos;t need `shuttingDown` - it introduces another race condition (and second variable), we should be able to use AtomicLong semantics in order to fix that.&#160;&lt;/p&gt;

&lt;p&gt;&#160;Something along these lines (but we would need to change the construction a bit since it starts with 0 now):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&#160; &#160;RefCount&amp;lt;T&amp;gt; acquire() {
&#160; &#160; &#160; &#160; &#160; &#160; while (true) {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; final long c = count.get();
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; if (c == 0L) {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; throw new IllegalStateException(&quot;The client is already shutdown&quot;);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; } else if (count.compareAndSet(c, c + 1)) {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; break;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }
&#160; &#160; &#160; &#160; &#160; &#160; }
&#160; &#160; &#160; &#160; &#160; &#160; return this;
&#160; &#160; &#160; &#160; } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="18016154" author="ffang" created="Tue, 26 Aug 2025 00:06:55 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reta&quot; class=&quot;user-hover&quot; rel=&quot;reta&quot;&gt;reta&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I just sent my PR&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cxf/pull/2571&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/2571&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We can continue the discussion there.&lt;/p&gt;

&lt;p&gt;Best Regards&lt;br/&gt;
Freeman&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13628963">CXF-9166</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1xemw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>