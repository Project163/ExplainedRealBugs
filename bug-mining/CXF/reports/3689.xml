<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:39:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-8824] CDI beans produced by @Produces methods are generated twice</title>
                <link>https://issues.apache.org/jira/browse/CXF-8824</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;We recently upgraded from CXF 3.1.9 to 3.5.5 and after upgrade encountered this bug.&lt;/p&gt;

&lt;p&gt;Specifically we have some &lt;tt&gt;javax.ws.rs.container.ContainerRequestFilter&lt;/tt&gt; implementations that are built using &lt;tt&gt;@Produces&lt;/tt&gt; methods on our base &lt;tt&gt;javax.ws.rs.core.Application&lt;/tt&gt; class. Since the upgrade we have discovered that these filters are being added to the request interceptor chain twice.&lt;/p&gt;

&lt;p&gt;After debugging I found that all CDI managed beans built by &lt;tt&gt;@Produces&lt;/tt&gt; methods that use the &lt;tt&gt;@Provider&lt;/tt&gt; annotation for discovery are now processed twice.&lt;/p&gt;

&lt;p&gt;It appears to me that the problem is in the current implementation of &lt;tt&gt;JAXRSCdiResourceExtension&lt;/tt&gt;. This implementation has &lt;tt&gt;@Observes&lt;/tt&gt; methods for both &lt;tt&gt;ProcessProducerMethod&lt;/tt&gt; events and &lt;tt&gt;ProcessBean&lt;/tt&gt; events - but &lt;tt&gt;ProcessProducerMethod&lt;/tt&gt; extends &lt;tt&gt;ProcessBean&lt;/tt&gt; so both of these handlers get called for each &lt;tt&gt;ProcessProducerMethod&lt;/tt&gt; event fired by the CDI implementation. This means both handlers add the producer method to the list of &lt;tt&gt;providerBeans&lt;/tt&gt; and the producer method is subsequently called twice when &lt;tt&gt;loadProviders()&lt;/tt&gt; is called and two instances of the provider are passed to the &lt;tt&gt;JAXRSServerFactoryBean&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I believe this behaviour was introduced by this commit:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cxf/commit/4b96a222aea61f9fe80083c4c4bb1519955890ab&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/commit/4b96a222aea61f9fe80083c4c4bb1519955890ab&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;CXF 3.5.5 running in Tomcat 9.0.70 using JBoss Weld 3.1.9 as the CDI implementation.  Using cxf-integration-cdi and CXFCdiServlet&lt;/p&gt;</environment>
        <key id="13527169">CXF-8824</key>
            <summary>CDI beans produced by @Produces methods are generated twice</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="reta">Andriy Redko</assignee>
                                    <reporter username="dmaplesden">David Maplesden</reporter>
                        <labels>
                    </labels>
                <created>Mon, 6 Mar 2023 04:16:25 +0000</created>
                <updated>Mon, 18 Sep 2023 18:48:09 +0000</updated>
                            <resolved>Fri, 31 Mar 2023 19:09:49 +0000</resolved>
                                    <version>3.2.0</version>
                    <version>3.5.5</version>
                                    <fixVersion>3.6.0</fixVersion>
                    <fixVersion>4.0.1</fixVersion>
                    <fixVersion>3.5.6</fixVersion>
                    <fixVersion>3.4.11</fixVersion>
                                    <component>Integration</component>
                    <component>JAX-RS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17696688" author="dmaplesden" created="Mon, 6 Mar 2023 04:23:09 +0000"  >&lt;p&gt;I believe this to be a fairly long standing bug, masked by the fact that many &lt;tt&gt;@Provider&lt;/tt&gt; implementations happen to be tolerant of being initialised twice.&#160; However in the case of some of our &lt;tt&gt;ContainerRequestFilter&lt;/tt&gt; implementations they do not like running twice (specifically some code designed to protect against replay attacks).&lt;/p&gt;

&lt;p&gt;We can work around the issue, but it seems like a good one to fix.&lt;/p&gt;

&lt;p&gt;I don&apos;t understand all the use cases fully, but I suspect the solution is to not listen for &lt;tt&gt;ProcessBean&lt;/tt&gt; events and instead listen only for the specific &lt;tt&gt;ProcessManagedBean&lt;/tt&gt; and &lt;tt&gt;ProcessSessionBean&lt;/tt&gt; events (along with the existing &lt;tt&gt;ProcessProducerMethod&lt;/tt&gt; and &lt;tt&gt;ProcessProducerField&lt;/tt&gt; events).&lt;/p&gt;</comment>
                            <comment id="17697143" author="dmaplesden" created="Mon, 6 Mar 2023 20:58:54 +0000"  >&lt;p&gt;A little more information.  I was debugging our setup with CXF 3.1.12 when I noticed it does not exhibit the same behaviour.  It turns out that under 3.1.12 both the &lt;tt&gt;collect(@Observes final ProcessProducerMethod&amp;lt; T, X &amp;gt; event)&lt;/tt&gt; and &lt;tt&gt;collect(@Observes final ProcessBean&amp;lt; T &amp;gt; event)&lt;/tt&gt; are being called (as I described for 3.5.5) BUT crucially the check for the &lt;tt&gt;Provider&lt;/tt&gt; annotation within &lt;tt&gt;collect(@Observes final ProcessBean&amp;lt; T &amp;gt; event)&lt;/tt&gt;  does not find it, I believe because the annotation does not exist on the producer method itself.&lt;/p&gt;

&lt;p&gt;However in later versions this check was changed (in commit &lt;a href=&quot;https://github.com/apache/cxf/commit/e173fd47157bad61631a2e87415732d524e05c74&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/commit/e173fd47157bad61631a2e87415732d524e05c74&lt;/a&gt;) to resolve &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7921&quot; title=&quot;JAXRS CDI extension ignores interfaces annotations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7921&quot;&gt;&lt;del&gt;CXF-7921&lt;/del&gt;&lt;/a&gt; and now the annotation check does find the &lt;tt&gt;Provider&lt;/tt&gt; on the class returned from the method - hence we are getting the provider bean loaded twice.&lt;/p&gt;</comment>
                            <comment id="17698132" author="reta" created="Thu, 9 Mar 2023 01:14:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dmaplesden&quot; class=&quot;user-hover&quot; rel=&quot;dmaplesden&quot;&gt;dmaplesden&lt;/a&gt; thanks for reporting the issue. Apache CXF CDI extension always inspect the classpath in order to discover JAX-RS annotated resources (providers / features / filters / ...). The use of @Produces interfere with that mechanism although the specification is very clear on handling providers and applications (section 11.2.3, JSR-370):&lt;/p&gt;

&lt;p&gt;&amp;gt; Providers and Application subclasses MUST be singletons or use application scope.&lt;/p&gt;

&lt;p&gt;Which basically means the right way to use the @Produces would be with @Singleton (or just use the automatic discovery but I assume you have reasons to not doing that):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; 
    @Produces @Singleton
    public ContainerRequestFilter containerRequestFilter () {
      ...
    }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Sadly there is still an issue with that on CXF side - the singletons are added multiple times, the fix is on the way.&lt;/p&gt;</comment>
                            <comment id="17698595" author="dmaplesden" created="Thu, 9 Mar 2023 20:31:49 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reta&quot; class=&quot;user-hover&quot; rel=&quot;reta&quot;&gt;reta&lt;/a&gt; - thanks for looking into this.  All of our filters were marked &lt;tt&gt;@ApplicationScope&lt;/tt&gt; and still got initialised twice.  The spec is also very clear in other areas such as when discussing the lifecycle of filters and interceptors in section 6.4:&lt;/p&gt;

&lt;p&gt;&amp;gt; By default, just like all the other providers, a single instance of each filter or entity interceptor is instantiated&lt;br/&gt;
for each JAX-RS application. &lt;/p&gt;

&lt;p&gt;And yes, we worked around the issue by not using the &lt;tt&gt;@Produces&lt;/tt&gt; methods and relying on the automatic CDI discovery - so this isn&apos;t a blocking issue for us, but still feels like something that should work. &lt;/p&gt;</comment>
                            <comment id="17698596" author="reta" created="Thu, 9 Mar 2023 20:38:03 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dmaplesden&quot; class=&quot;user-hover&quot; rel=&quot;dmaplesden&quot;&gt;dmaplesden&lt;/a&gt; , thank you, the fix seems to be addressing the issue, working on test case(s) to finalize it.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 35 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1gcq8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>