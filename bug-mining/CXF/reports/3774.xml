<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:40:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-9110] Memory leak in DelayedCleanerImpl.queue when LoggingFeature is enabled</title>
                <link>https://issues.apache.org/jira/browse/CXF-9110</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;After migration from 3.6.4 to 3.6.5 (4.1.0) the memory leak appears due the DelayedCachedOutputStreamCleaner does not remove Streams from the DelayedCleanerImpl.queue.&lt;/p&gt;

&lt;p&gt;It happened after &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7396&quot; title=&quot;CachedOutputStream doesn&amp;#39;t delete temp files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7396&quot;&gt;&lt;del&gt;CXF-7396&lt;/del&gt;&lt;/a&gt; because of the inequality between BufferedOutputStream and LoggingOutputStream instances in &lt;a href=&quot;https://github.com/apache/cxf/blob/84a53f9c81fcbb87e0286c9e6df75853c09cd93b/core/src/main/java/org/apache/cxf/io/DelayedCachedOutputStreamCleaner.java#L170&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the equals()&lt;/a&gt; method.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13608736">CXF-9110</key>
            <summary>Memory leak in DelayedCleanerImpl.queue when LoggingFeature is enabled</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="yurkom">Yury Molchan</reporter>
                        <labels>
                    </labels>
                <created>Mon, 17 Feb 2025 11:42:22 +0000</created>
                <updated>Thu, 23 Oct 2025 14:04:08 +0000</updated>
                            <resolved>Sat, 1 Mar 2025 02:20:22 +0000</resolved>
                                    <version>4.1.0</version>
                    <version>3.5.10</version>
                    <version>3.6.5</version>
                    <version>4.0.6</version>
                                    <fixVersion>3.5.11</fixVersion>
                    <fixVersion>3.6.6</fixVersion>
                    <fixVersion>4.0.7</fixVersion>
                    <fixVersion>4.1.1</fixVersion>
                                    <component>Core</component>
                    <component>logging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17927767" author="reta" created="Mon, 17 Feb 2025 13:34:22 +0000"  >&lt;p&gt;Thanks for the issue, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yurkom&quot; class=&quot;user-hover&quot; rel=&quot;yurkom&quot;&gt;yurkom&lt;/a&gt;. Why do you think it causes memory leak? The delayed queue cleans everything up (with the delay), although there could be an issue with streams comparison, there should be no leaks.&lt;/p&gt;</comment>
                            <comment id="17927790" author="yurkom" created="Mon, 17 Feb 2025 15:01:07 +0000"  >&lt;p&gt;Yeah, it will be cleaned by default after &lt;a href=&quot;https://github.com/apache/cxf/blob/84a53f9c81fcbb87e0286c9e6df75853c09cd93b/core/src/main/java/org/apache/cxf/io/DelayedCachedOutputStreamCleaner.java#L73&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;30 minutes&lt;/a&gt;. In our real case it is not happened due the OutOfMemoryError raised earlier than cleanup happens. Because the BufferedOutputStream holds in the memory significant amount of bytes, says 20KB, and when the server handles 500 request per second, the memory is consumed in 10MB per second, and until the delayed clean up is completed, it will consume 18GB memory.&lt;/p&gt;

&lt;p&gt;The issue is in that after a response is completed and its OutputStream is closed, the stream from the DelayedCleanerImpl.queue is not removed and holds till timeout.&lt;/p&gt;

&lt;p&gt;If we are configuring to use the minimal time in &lt;a href=&quot;https://github.com/apache/cxf/blob/84a53f9c81fcbb87e0286c9e6df75853c09cd93b/core/src/main/java/org/apache/cxf/io/DelayedCachedOutputStreamCleaner.java#L43&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2 seconds&lt;/a&gt;, it is still raises OutOfMemoryError in our limited memory (512MB), due bigger requests till 10MB.&lt;/p&gt;

&lt;p&gt;So currently, we have to switch off the cleaner by defining &lt;tt&gt;bus.io.CachedOutputStreamCleaner.Delay=0&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17928128" author="yurkom" created="Tue, 18 Feb 2025 15:38:31 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reta&quot; class=&quot;user-hover&quot; rel=&quot;reta&quot;&gt;reta&lt;/a&gt;,&lt;br/&gt;
I have prepared &lt;a href=&quot;https://github.com/apache/cxf/pull/2275&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a pull request&lt;/a&gt; with the test to reproduce the issue and the fix.&lt;/p&gt;</comment>
                            <comment id="17933750" author="yurkom" created="Mon, 10 Mar 2025 07:33:12 +0000"  >&lt;p&gt;Confirmed the fix is working on 3.6.6 and 4.1.1&lt;/p&gt;</comment>
                            <comment id="17933844" author="reta" created="Mon, 10 Mar 2025 11:50:42 +0000"  >&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13077689">CXF-7396</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13632310">CXF-9171</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13074796" name="image (12).png" size="1234134" author="yurkom" created="Mon, 17 Feb 2025 11:43:08 +0000"/>
                            <attachment id="13074795" name="image (13).png" size="1238615" author="yurkom" created="Mon, 17 Feb 2025 11:43:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            35 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1u98w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>