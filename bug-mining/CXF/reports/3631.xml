<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:38:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-8603] ClassLoaderUtils.setThreadContextClassloader attempts to set null class loader</title>
                <link>https://issues.apache.org/jira/browse/CXF-8603</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Created a custom connector for a SOAP Service using CXF for Oracle Identity Manager using their Identity Connector Framework (ICF).&#160; Their framework has a Context Class Loader &quot;watcher&quot; that detects&#160; that the ClassLoaderUtils.setThreadContextClassLoader() method is attempting to set a &quot;null&quot; loader.&#160; This happens when a call is made to invoke a SOAP message:&lt;/p&gt;

&lt;p&gt;&#160; &#160; public void testService() {&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; try {&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; IPersonnelManagement2014 port = getPersonnelManagementPort2014();&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; PersonnelManagementViewUser2Response response = port.viewUser(&quot;xxxxx&quot;, &quot;external&quot;, null, null, null, null);&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;See stacktrace below:&lt;/p&gt;

&lt;p&gt;SEVERE: Attempting to set the CCL of thread &apos;pool-1-thread-9&apos; to nullSEVERE: Attempting to set the CCL of thread &apos;pool-1-thread-9&apos; to nulljava.lang.Throwable at org.identityconnectors.framework.server.impl.CCLWatchThread.setContextClassLoader(CCLWatchThread.java:59) at org.apache.cxf.common.classloader.ClassLoaderUtils.setThreadContextClassloader(ClassLoaderUtils.java:70) at org.apache.cxf.helpers.XPathUtils.getValue(XPathUtils.java:73) at org.apache.cxf.interceptor.ClientFaultConverter.setStackTrace(ClientFaultConverter.java:245) at org.apache.cxf.interceptor.ClientFaultConverter.handleMessage(ClientFaultConverter.java:84) at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:308) at org.apache.cxf.interceptor.AbstractFaultChainInitiatorObserver.onMessage(AbstractFaultChainInitiatorObserver.java:112) at org.apache.cxf.jaxws.handler.soap.SOAPHandlerInterceptor.handleMessage(SOAPHandlerInterceptor.java:137) at org.apache.cxf.jaxws.handler.soap.SOAPHandlerInterceptor.handleMessage(SOAPHandlerInterceptor.java:70) at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:308) at org.apache.cxf.endpoint.ClientImpl.onMessage(ClientImpl.java:829) at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.handleResponseInternal(HTTPConduit.java:1696) at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.handleResponse(HTTPConduit.java:1570) at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.close(HTTPConduit.java:1371) at org.apache.cxf.transport.AbstractConduit.close(AbstractConduit.java:56) at org.apache.cxf.transport.http.HTTPConduit.close(HTTPConduit.java:671) at org.apache.cxf.interceptor.MessageSenderInterceptor$MessageSenderEndingInterceptor.handleMessage(MessageSenderInterceptor.java:63) at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:308) at org.apache.cxf.endpoint.ClientImpl.doInvoke(ClientImpl.java:530) at org.apache.cxf.endpoint.ClientImpl.invoke(ClientImpl.java:441) at org.apache.cxf.endpoint.ClientImpl.invoke(ClientImpl.java:356) at org.apache.cxf.endpoint.ClientImpl.invoke(ClientImpl.java:314) at org.apache.cxf.frontend.ClientProxy.invokeSync(ClientProxy.java:96) at org.apache.cxf.jaxws.JaxWsClientProxy.invoke(JaxWsClientProxy.java:140) at com.sun.proxy.$Proxy40.viewUser(Unknown Source) at com.icsynergy.epic.wsclient.WSClient.testService(WSClient.java:550)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13404330">CXF-8603</key>
            <summary>ClassLoaderUtils.setThreadContextClassloader attempts to set null class loader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ffang">Freeman Yue Fang</assignee>
                                    <reporter username="punched_card">Archie Patrick</reporter>
                        <labels>
                    </labels>
                <created>Thu, 30 Sep 2021 15:47:29 +0000</created>
                <updated>Wed, 22 Dec 2021 20:41:39 +0000</updated>
                            <resolved>Fri, 8 Oct 2021 18:00:59 +0000</resolved>
                                    <version>3.3.11</version>
                                    <fixVersion>3.5.0</fixVersion>
                    <fixVersion>3.4.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17422896" author="ffang" created="Thu, 30 Sep 2021 16:29:27 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=punched_card&quot; class=&quot;user-hover&quot; rel=&quot;punched_card&quot;&gt;punched_card&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for raising this up!&lt;/p&gt;

&lt;p&gt;If we take a close look at the Thread.setContextClassLoader method&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
/**
     * Sets the context &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;. The context
     * &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; can be set when a thread is created, and allows
     * the creator of the thread to provide the appropriate &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;loader,
     * through {@code getContextClassLoader}, to code running in the thread
     * when loading classes and resources.
     *
     * &amp;lt;p&amp;gt;If a security manager is present, its {@link
     * &lt;span class=&quot;code-object&quot;&gt;SecurityManager&lt;/span&gt;#checkPermission(java.security.Permission) checkPermission}
     * method is invoked with a {@link RuntimePermission RuntimePermission}{@code
     * (&lt;span class=&quot;code-quote&quot;&gt;&quot;setContextClassLoader&quot;&lt;/span&gt;)} permission to see &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; setting the context
     * &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; is permitted.
     *
     * @param  cl
     *         the context &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;, or &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;  indicating the
     *         system &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;loader (or, failing that, the bootstrap &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;loader)
     *
     * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt;  SecurityException
     *          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the current thread cannot set the context &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;
     *
     * @since 1.2
     */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setContextClassLoader(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; cl) {
        &lt;span class=&quot;code-object&quot;&gt;SecurityManager&lt;/span&gt; sm = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getSecurityManager();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sm != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            sm.checkPermission(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimePermission(&lt;span class=&quot;code-quote&quot;&gt;&quot;setContextClassLoader&quot;&lt;/span&gt;));
        }
        contextClassLoader = cl;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So when the cl == null(normally means it&apos;s the  the bootstrap class loader), the Thread subclass can fail it.&lt;/p&gt;

&lt;p&gt;So I think we can add a NPE guard in cxf ClassLoaderUtils, so that can honour different Thread subclass implementations.&lt;/p&gt;

&lt;p&gt;Are you interested in sending a PR?&lt;/p&gt;

&lt;p&gt;Best Regards&lt;br/&gt;
Freeman&lt;/p&gt;</comment>
                            <comment id="17425204" author="punched_card" created="Wed, 6 Oct 2021 21:06:15 +0000"  >&lt;p&gt;Hello Freeman,&lt;/p&gt;

&lt;p&gt;I&apos;m not sure adding an &quot;NPE guard&quot; would solve the problem.&#160; Since the ClassLoaderHolder.setThreadContextClassLoader() method always returns the saved CCL in a ClassLoaderHolder, all callers of the setThreadContextClassLoader() are probably expecting a valid CCL to be returned.&#160; Or, did you mean to add something like:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; ClassLoaderHolder setThreadContextClassloader(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; newLoader) {
    ...
    ...
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; l = thread.getContextClassLoader();
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            thread.setContextClassLoader(newLoader);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;( Throwable t ) {
            &lt;span class=&quot;code-comment&quot;&gt;//ignore it??  fail quietly?
&lt;/span&gt;        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ClassLoaderHolder(l, thread);
    ...
    ...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17426231" author="ffang" created="Fri, 8 Oct 2021 15:23:56 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=punched_card&quot; class=&quot;user-hover&quot; rel=&quot;punched_card&quot;&gt;punched_card&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Sorry, I mean add NPE guard before call into org.apache.cxf.common.classloader.ClassLoaderUtils.&lt;/p&gt;

&lt;p&gt;Something like&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
--- a/core/src/main/java/org/apache/cxf/helpers/XPathUtils.java
+++ b/core/src/main/java/org/apache/cxf/helpers/XPathUtils.java
@@ -69,8 +69,10 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;XPathUtils {
     }
 
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; getValue(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; xpathExpression, Node node, QName type) {
-        ClassLoaderHolder loader
-            = ClassLoaderUtils.setThreadContextClassloader(getClassLoader(xpath.getClass()));
+        ClassLoaderHolder loader = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (getClassLoader(xpath.getClass()) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+            loader = ClassLoaderUtils.setThreadContextClassloader(getClassLoader(xpath.getClass()));
+        }
         &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; xpath.evaluate(xpathExpression, node, type);
         } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This similar pattern is also used in several other places inside CXF code base.&lt;/p&gt;

&lt;p&gt;Best Regards&lt;br/&gt;
Freeman&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 5 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0vgpc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>