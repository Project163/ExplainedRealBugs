<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:09:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-5659] IllegalStateException on Async call</title>
                <link>https://issues.apache.org/jira/browse/CXF-5659</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;I&apos;ve come acrossed an odd exception when attempting to use an Async JAX-WS Provider:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.IllegalStateException: s=DISPATCHED i=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; a=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.eclipse.jetty.server.HttpChannelState.complete(HttpChannelState.java:430)
	at org.eclipse.jetty.server.AsyncContextState.complete(AsyncContextState.java:92)
	at org.apache.cxf.transport.http.Servlet3ContinuationProvider$Servlet3Continuation.reset(Servlet3ContinuationProvider.java:131)
	at org.apache.cxf.transport.http.Servlet3ContinuationProvider.complete(Servlet3ContinuationProvider.java:55)
	at org.apache.cxf.transport.http.AbstractHTTPDestination.invoke(AbstractHTTPDestination.java:242)
	at org.apache.cxf.transport.servlet.ServletController.invokeDestination(ServletController.java:248)
	at org.apache.cxf.transport.servlet.ServletController.invoke(ServletController.java:222)
	at org.apache.cxf.transport.servlet.ServletController.invoke(ServletController.java:153)
	at org.apache.cxf.transport.servlet.CXFNonSpringServlet.invoke(CXFNonSpringServlet.java:167)
	at org.apache.cxf.transport.servlet.AbstractHTTPServlet.handleRequest(AbstractHTTPServlet.java:286)
	at org.apache.cxf.transport.servlet.AbstractHTTPServlet.doPost(AbstractHTTPServlet.java:206)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:707)
	at org.apache.cxf.transport.servlet.AbstractHTTPServlet.service(AbstractHTTPServlet.java:262)
	at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:717)
	at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:552)
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)
	at org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:544)
	at org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:221)
	at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1112)
	at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:479)
	at org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:183)
	at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1046)
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)
	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:97)
	at org.eclipse.jetty.server.handler.StatisticsHandler.handle(StatisticsHandler.java:159)
	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:97)
	at org.eclipse.jetty.server.Server.handleAsync(Server.java:516)
	at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:288)
	at org.eclipse.jetty.server.HttpChannel.run(HttpChannel.java:237)
	at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:607)
	at org.eclipse.jetty.util.thread.QueuedThreadPool$3.run(QueuedThreadPool.java:536)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:722)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;From what I&apos;ve been able to determine, it appears it is attempting to call AsyncContext.complete() after AsyncContext.dispatch() has been called from Servlet3Continuation.redispatch()/resume().&lt;/p&gt;

&lt;p&gt;I changed the Servlet3.Continuation.reset() method to this to &apos;fix&apos; it:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void reset() {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isResumed) {
                context.complete();
            }
            obj = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But I&apos;m not sure if that&apos;s correct.&lt;/p&gt;

&lt;p&gt;I also changed the Servlet3Continuation.startAsyncAgain() method, as I spotted it adding a duplicate listener:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        void startAsyncAgain() {
            AsyncContext old = context;
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                context = req.startAsync();
                context.addListener(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IllegalStateException ex) { 
                context = old;
            }
        }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12704228">CXF-5659</key>
            <summary>IllegalStateException on Async call</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="elfarto">Stephen Dawkins</reporter>
                        <labels>
                            <label>continuation</label>
                    </labels>
                <created>Fri, 28 Mar 2014 11:46:12 +0000</created>
                <updated>Fri, 28 Mar 2014 14:14:20 +0000</updated>
                                            <version>2.7.10</version>
                                                    <component>Transports</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13950633" author="sergey_beryozkin" created="Fri, 28 Mar 2014 12:29:34 +0000"  >&lt;p&gt;What Jetty version is it, the one shipped with CXF 2.7.10 distro or earlier ? We have Jetty Servlet 3 tests running, no problems.&lt;/p&gt;

&lt;p&gt;IMHO it is a Jetty being too strict, complete() API docs do not document any exceptions can be thrown, rather, dispatch() docs say ISE can be thrown if complete() has been called, which I read like this: complete() -&amp;gt; dispatch() -&amp;gt; ISE. Calling complete() is needed to clean up the state and onComplete being called when the response has been sent. &lt;/p&gt;

&lt;p&gt;But it may be a genuine bug, I wonder if may be we have a case of  AsyncListener.onTimeout() being called after complete() ?&lt;br/&gt;
I think we can protect a complete() call with a catch block, and ensure onTimeout is not calling redispatch() after complete()&lt;/p&gt;</comment>
                            <comment id="13950652" author="elfarto" created="Fri, 28 Mar 2014 12:53:46 +0000"  >&lt;p&gt;Sorry, I meant to add that. I&apos;m using Jetty 9.1.2.v20140210. Also I forgot to note that the response is getting sent back to the client fine, this exception happens after that.&lt;/p&gt;

&lt;p&gt;The Javadoc for complete() says it&apos;s only valid after startAsync and before dispatch, I&apos;ve stepped through the code, and dispatch is definitely called first. &lt;/p&gt;</comment>
                            <comment id="13950669" author="sergey_beryozkin" created="Fri, 28 Mar 2014 13:12:11 +0000"  >&lt;p&gt;I&apos;ve added a catch block around complete() to prevent any side-effects for now...&lt;/p&gt;

&lt;p&gt;I just wonder how we can prevent ISE at all then if in order to handle the resume()/onTimeout we need to call dispatch() while complete() is needed to reset the state and ensure AsyncListener.onComplete is called...&lt;/p&gt;

&lt;p&gt;I reckon the catch block is the best thing we can do &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. Removing complete() does not seem like the best option to me...&lt;/p&gt;

&lt;p&gt;Cheers, Sergey&lt;/p&gt;
</comment>
                            <comment id="13950671" author="elfarto" created="Fri, 28 Mar 2014 13:16:22 +0000"  >&lt;p&gt;Given the implementation of HttpChannelState.complete() adding a catch won&apos;t help, the IllegalStateException is thrown before any clean up work is done.&lt;/p&gt;</comment>
                            <comment id="13950674" author="sergey_beryozkin" created="Fri, 28 Mar 2014 13:19:56 +0000"  >&lt;p&gt;You mean after AsyncContext.complete() returns ?&lt;/p&gt;</comment>
                            <comment id="13950706" author="elfarto" created="Fri, 28 Mar 2014 13:39:57 +0000"  >&lt;p&gt;Ok, ignore me, it seems even when that IllegalStateException is thrown, Servlet3Continuation.onComplete is still called, so that try/catch around complete should be enough for now.&lt;/p&gt;</comment>
                            <comment id="13950750" author="sergey_beryozkin" created="Fri, 28 Mar 2014 14:09:32 +0000"  >&lt;p&gt;Thanks... I tried to actually remove dispatch(), thinking that may be onTimeout() does not require the listener call dispatch(). Few tests actually passed but few failed. I guess may be we can remove it eventually. But the try/catch block may be just what we need for now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13950755" author="sergey_beryozkin" created="Fri, 28 Mar 2014 14:14:20 +0000"  >&lt;p&gt;Besides I also see this line:  &quot;If startAsync is subsequently called on the dispatched request, then any of the dispatch or complete() methods may be called&quot;. How that correlates with the relevant documentation is very difficult to understand so once again I&apos;m thinking keeping the catch block is the best thing for now.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>382562</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 34 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1twpz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>382830</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>