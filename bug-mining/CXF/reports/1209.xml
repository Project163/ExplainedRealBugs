<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:51:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-4006] Possible classloader leak due to ThreadLocal</title>
                <link>https://issues.apache.org/jira/browse/CXF-4006</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;org.apache.cxf.jaxrs.ext.MessageContextImpl is kept in a ThreadLocal for each HTTP request which means when a CXF-servlet-based webapp is undeployed, the webapp&apos;s classloader leaks. &lt;/p&gt;

&lt;p&gt;(At least, I think that&apos;s what&apos;s going on, I&apos;m not that expert at tracking down memory leaks. Perhaps I have misconfigured something?)&lt;/p&gt;</description>
                <environment>&lt;p&gt;Glassfish&lt;br/&gt;
OpenJDK Runtime Environment (IcedTea6 1.10.4) (fedora-61.1.10.4.fc16-x86_64)&lt;/p&gt;</environment>
        <key id="12537066">CXF-4006</key>
            <summary>Possible classloader leak due to ThreadLocal</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sergey_beryozkin">Sergey Beryozkin</assignee>
                                    <reporter username="artbristol">Art O Cathain</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Jan 2012 15:30:17 +0000</created>
                <updated>Mon, 13 Jan 2014 03:18:48 +0000</updated>
                            <resolved>Wed, 25 Jan 2012 22:02:00 +0000</resolved>
                                    <version>2.5.1</version>
                                    <fixVersion>2.4.7</fixVersion>
                    <fixVersion>2.5.3</fixVersion>
                    <fixVersion>2.6</fixVersion>
                                    <component>JAX-RS</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13179568" author="sergey_beryozkin" created="Wed, 4 Jan 2012 15:42:25 +0000"  >&lt;p&gt;Hi, the thread local value is released by the runtime after the response has been handled, so no leak will occur.&lt;br/&gt;
Do you have some information that shows there could be a leak ?&lt;/p&gt;</comment>
                            <comment id="13179577" author="artbristol" created="Wed, 4 Jan 2012 15:48:31 +0000"  >&lt;p&gt;This snippet is from a Yourkit trace to the GC roots, after undeployment:&lt;/p&gt;

&lt;p&gt;&amp;lt;class&amp;gt; of org.apache.cxf.jaxrs.ext.MessageContextImpl&lt;br/&gt;
value of java.lang.ThreadLocal$ThreadLocalMap$Entry&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;482&amp;#93;&lt;/span&gt; of java.lang.ThreadLocal$ThreadLocalMap$Entry&lt;span class=&quot;error&quot;&gt;&amp;#91;512&amp;#93;&lt;/span&gt;&lt;br/&gt;
table of java.lang.ThreadLocal$ThreadLocalMap&lt;br/&gt;
threadLocals of com.sun.grizzly.http.HttpWorkerThread &lt;span class=&quot;error&quot;&gt;&amp;#91;JNI Global, Stack Local, Thread&amp;#93;&lt;/span&gt;  &quot;http-thread-pool-8080(4)&quot;&lt;/p&gt;</comment>
                            <comment id="13180762" author="sergey_beryozkin" created="Thu, 5 Jan 2012 19:45:08 +0000"  >&lt;p&gt;Hmm, I&apos;m wondering why it seems to be happening on unloading the webapp, this is all cleared Ok during the regular call.&lt;br/&gt;
Dan, Benson, do you have any ideas ? &lt;/p&gt;</comment>
                            <comment id="13188401" author="denis.delangle" created="Wed, 18 Jan 2012 10:49:36 +0000"  >&lt;p&gt;I am having the same kind of issue under Tomcat which is the client, not the server. After undeploying my webapp, I have this message from Tomcat :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;GRAVE: The web application &lt;span class=&quot;error&quot;&gt;&amp;#91;/sipbo&amp;#93;&lt;/span&gt; created a ThreadLocal with key of type &lt;span class=&quot;error&quot;&gt;&amp;#91;java.lang.ThreadLocal&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;java.lang.ThreadLocal@327958ef&amp;#93;&lt;/span&gt;) and a value of type &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.cxf.jaxrs.ext.MessageContextImpl&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.cxf.jaxrs.ext.MessageContextImpl@3cbdcccc&amp;#93;&lt;/span&gt;) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to try and avoid a probable memory leak.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I am creating my client code like this : &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	&lt;span class=&quot;code-comment&quot;&gt;//I create my delegate instance lazily
&lt;/span&gt;	&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; NotificationService getDelegate() { 
	   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (delegate == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
	      delegate = JAXRSClientFactory.create(url, NotificationService.class, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt;(), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
	   }
	}

	&lt;span class=&quot;code-comment&quot;&gt;//I &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to destroy the client when shutting down the webapp
&lt;/span&gt;	@PreDestroy
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void cleanResources() {
		WebClient.getConfig(delegate).getBus().shutdown(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
	}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After searching with VisualVM, it seems that instances of MesageContextImpl are still stored in a ThreadLocalMessageContext referenced in the static field AbstractResourceInfo.setterProxyMap and in the instance field JAXBElementProvider.mc.&lt;/p&gt;

&lt;p&gt;It can be a misuse of the API or it may help solve the bug.&lt;/p&gt;</comment>
                            <comment id="13188412" author="sergey_beryozkin" created="Wed, 18 Jan 2012 11:37:46 +0000"  >&lt;p&gt;Denis, thanks for this info.&lt;/p&gt;

&lt;p&gt;Art, in your case, do you also use WebClient in scope of the server web app ?&lt;/p&gt;</comment>
                            <comment id="13188415" author="artbristol" created="Wed, 18 Jan 2012 11:43:05 +0000"  >&lt;p&gt;Yes, that is one of the cases for which we&apos;re using CXF (so we&apos;re using it as both servlet and client).&lt;/p&gt;</comment>
                            <comment id="13188460" author="sergey_beryozkin" created="Wed, 18 Jan 2012 14:16:36 +0000"  >&lt;p&gt;This has been fixed on the trunk and all the active branches. &lt;br/&gt;
If you can get a chance to try it with the latest snapshot (2.5.x or 2.4.x, etc) then it would help, &lt;br/&gt;
Trunk is building now at &lt;a href=&quot;https://builds.apache.org/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/&lt;/a&gt;, I will schedule the 2.5.2-SNAPSHOT build next&lt;/p&gt;

&lt;p&gt;Cheers, Sergey&lt;/p&gt;</comment>
                            <comment id="13189819" author="denis.delangle" created="Fri, 20 Jan 2012 14:11:17 +0000"  >&lt;p&gt;I tried with version 2.5.3-20120120.065637-1 but still have the same error message.&lt;/p&gt;</comment>
                            <comment id="13193389" author="sergey_beryozkin" created="Wed, 25 Jan 2012 22:02:00 +0000"  >&lt;p&gt;Sorry I did not catch the issue earlier; definitely fixed now, a temp regression spanning last 1-2 releases on 2.4.x/2.5.x&lt;br/&gt;
The leak should be more or less negligible, but the way to eliminate it with the released CXFs is to register a simple JAXBElementProvider (or/and JSONProvider) only which will override setMessageContext method and make it no-op. &lt;/p&gt;

&lt;p&gt;MessageContext is needed to check for custom STAX handlers and may be Marshaller properties. This all can be managed in the custom provider using PhaseInterceptorChain.getCurrentMessage().&lt;/p&gt;

&lt;p&gt;thanks&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12688493">CXF-5492</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>222576</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 43 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0b867:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>63436</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>