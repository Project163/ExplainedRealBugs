<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:47:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-3504] for big attachment, a temporary file is left on disk and keep opend, if the application just close the DataSource&apos;s inputStream and doesn&apos;t consume it; </title>
                <link>https://issues.apache.org/jira/browse/CXF-3504</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;when the client receiving multiple larget attachments from server. here &quot;large&quot; means : attachment size is large enough to be saved as temporary file on disk;&lt;/p&gt;

&lt;p&gt;for the last attachment, if the user application only close the input stream got from DataSource and doesn&apos;t consume the input stream at all, a temporary file will be left on the disk.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12506677">CXF-3504</key>
            <summary>for big attachment, a temporary file is left on disk and keep opend, if the application just close the DataSource&apos;s inputStream and doesn&apos;t consume it; </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ffang">Freeman Yue Fang</assignee>
                                    <reporter username="ext2xhb">ext2</reporter>
                        <labels>
                    </labels>
                <created>Tue, 10 May 2011 03:51:28 +0000</created>
                <updated>Mon, 8 Aug 2011 14:43:40 +0000</updated>
                            <resolved>Wed, 18 May 2011 06:14:32 +0000</resolved>
                                    <version>2.4</version>
                                    <fixVersion>2.4.1</fixVersion>
                    <fixVersion>2.3.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13031007" author="ext2xhb" created="Tue, 10 May 2011 04:28:41 +0000"  >&lt;p&gt;this is the test case&apos;s pom project.&lt;/p&gt;</comment>
                            <comment id="13034767" author="ffang" created="Tue, 17 May 2011 13:50:03 +0000"  >&lt;p&gt;This is caused by still can read MimeBodyPartInputStream after closing it, so that after closing the unread stream , it cache to temp file but have no chance to delete temp file even the process exit.&lt;/p&gt;</comment>
                            <comment id="13035216" author="ffang" created="Wed, 18 May 2011 06:14:32 +0000"  >&lt;p&gt;commit fix&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?rev=1104243&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1104243&amp;amp;view=rev&lt;/a&gt; for trunk&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc?rev=1104252&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1104252&amp;amp;view=rev&lt;/a&gt; for 2.3.x branch&lt;/p&gt;</comment>
                            <comment id="13036126" author="ext2xhb" created="Thu, 19 May 2011 11:49:12 +0000"  >&lt;p&gt;Yes the patch will leave no temporary file on disk. &lt;br/&gt;
But it introduce another problem: the http-connection doesn&apos;t closed; &lt;/p&gt;

&lt;p&gt;After execute the last-attachment input-stream&apos;s close, I can saw a &quot;ESBTABLISHING&quot; status socket, that indicate the socket cannot be closed;&lt;/p&gt;

&lt;p&gt;To understand the problem, let&apos;s check some source code of CXF attachment:&lt;br/&gt;
class AttachmentDeserializer{&lt;br/&gt;
   //because the patch just close MIMEPartInputStream, so the network-inputstream isn&apos;t consumed over; then stream.read() will return another bytes to indicate the &quot;we still have another attachment&quot;(but actually , we didn&apos;t)&lt;br/&gt;
   public boolean hasNext() throws IOException {&lt;br/&gt;
         .......&lt;br/&gt;
        int v = stream.read();&lt;br/&gt;
        if (v == -1) &lt;/p&gt;
{
            return false;
        }
&lt;p&gt;        stream.unread(v);&lt;br/&gt;
        return true;&lt;br/&gt;
    }&lt;br/&gt;
  //now because  attachments.hasNext() will never return false, so the network-stream cannot be closed; &lt;br/&gt;
  public void markClosed(DelegatingInputStream delegatingInputStream){&lt;br/&gt;
        closedCount++;&lt;br/&gt;
        if (closedCount == createCount &amp;amp;&amp;amp; !attachments.hasNext(false)) {&lt;br/&gt;
            int x = stream.read();&lt;br/&gt;
            while (x != -1) &lt;/p&gt;
{
                x = stream.read();
            }
&lt;p&gt;            stream.close();&lt;br/&gt;
            closed = true;&lt;br/&gt;
        }&lt;br/&gt;
  }&lt;br/&gt;
}&lt;/p&gt;</comment>
                            <comment id="13036128" author="ext2xhb" created="Thu, 19 May 2011 11:51:21 +0000"  >&lt;p&gt;maybe while close the MIMEPartInputstream, the close method should consume  all content of Current MIMEPart from underly input stream;&lt;/p&gt;</comment>
                            <comment id="13036148" author="ffang" created="Thu, 19 May 2011 12:30:21 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Actually after closing MIMEPartInputStream, when you try to read this stream, it will always -1, that&apos;s exactly this fix does, you can get more details from&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;.&lt;br/&gt;
And when you observe http-connection doesn&apos;t closed, did you already include my fix from &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-3505&quot; title=&quot;CXF attachment doesn&amp;#39;t compatible with SUN&amp;#39;s  ACTIVATION library&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-3505&quot;&gt;&lt;del&gt;CXF-3505&lt;/del&gt;&lt;/a&gt;? I believe &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-3505&quot; title=&quot;CXF attachment doesn&amp;#39;t compatible with SUN&amp;#39;s  ACTIVATION library&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-3505&quot;&gt;&lt;del&gt;CXF-3505&lt;/del&gt;&lt;/a&gt; fix the http-connection issue.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;http://svn.apache.org/viewvc/cxf/trunk/rt/core/src/main/java/org/apache/cxf/attachment/MimeBodyPartInputStream.java?r1=1104243&amp;amp;r2=1104242&amp;amp;pathrev=1104243&lt;/p&gt;

&lt;p&gt;Freeman&lt;/p&gt;</comment>
                            <comment id="13036634" author="ext2xhb" created="Fri, 20 May 2011 02:37:52 +0000"  >&lt;p&gt;I am sure I have  correct patch for CXF3504 and CXF3505.  there are still socket left not closed;&lt;br/&gt;
Actualy the new problem (http-connection not close ) caused by CXF 3504 &apos;s patch is  different to the CXF3505. &lt;br/&gt;
cxf3505&apos;s bug are always: server socket closed, client not closed(FIN_WAIT socket STATUS); &lt;br/&gt;
the new problem of CXF 3504 &apos;s patch are : server and client both not closed&lt;span class=&quot;error&quot;&gt;&amp;#91;ESTABLISHED SOCKET STATUS&amp;#93;&lt;/span&gt; if you provide a LARGE ENOUGH attachment, you will find &lt;br/&gt;
HERE :LARGE ENOUGH ATTACHMENT means :attatchment&#8217;size should be larger than double size of underly buffer for socket), In my enviroment I using a 64K attachment in JDK5 and windows XP system&#12290; the attachment size is quite different on different operation-system and JDK.&lt;br/&gt;
You can try it by using a very big attachment&lt;span class=&quot;error&quot;&gt;&amp;#91;etc: 10M size (arbitrary)&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="13036639" author="ext2xhb" created="Fri, 20 May 2011 03:01:38 +0000"  >&lt;p&gt;when I reported CXF3504 &amp;amp; CXF3505 bug previously, I just use a &quot;user&apos;s word to say what the problem I have saw outside CXF&quot;. But the underly technical reason which caused CXF3505 &amp;amp; CXF3504 are differnet;&lt;/p&gt;

&lt;p&gt;CXF3505 &apos;s underly reason is: sun&apos;s activation library caused all attachments are delegate to inputstream ( not cached) ;the patch for CXF3505 only fixed: only last attachment using delegate inputstream, other attachments cached. Anyway there is still a attachment(the last) which using delegate inputstream;&lt;/p&gt;

&lt;p&gt;CXF3504&apos;s underly reason is : delegate input stream &apos;s close method doest take care of underly-http-connection and Cacheing mechanism both; the original code of CXF only tare of underly-http-connection &apos;s close; and the new patch of CXF3504 only take care of Cacheing mechanism.&lt;/p&gt;

&lt;p&gt;By the way&#65292; I fixed the patch of CXF3504 and CXF3505 in CXF2.3.3 version. (although I think the trunk source code of CXF2.4 also have the new problem, but I haven&apos;t tried it yet)&lt;/p&gt;
</comment>
                            <comment id="13036656" author="njiang" created="Fri, 20 May 2011 03:48:31 +0000"  >&lt;p&gt;@ext2&lt;br/&gt;
There is not much change of the attachement code between CXF 2.3.x and CXF 2.4.x.&lt;br/&gt;
Can you submit your patch with the test case? We are happy to accept the contribution &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13036722" author="ffang" created="Fri, 20 May 2011 08:36:17 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Ok, I saw the introduced connection can&apos;t release issue, it also only happened when you not actually read the attachment stream but close it directly.&lt;/p&gt;

&lt;p&gt;The fix should be when we close a stream, we needn&apos;t check if there&apos;s hasNext attachment(as we intend to close it, we don&apos;t care if there&apos;s any attachment we don&apos;t read), just mark this stream as closed.&lt;/p&gt;

&lt;p&gt;I will append a new patch, could you verify it works for your scenario?&lt;/p&gt;

&lt;p&gt;Also, if you wanna contribute your patch you mentioned before, I&apos;m very glad to review it.&lt;/p&gt;

&lt;p&gt;Freeman&lt;/p&gt;</comment>
                            <comment id="13036780" author="ffang" created="Fri, 20 May 2011 11:19:12 +0000"  >&lt;p&gt;Or simply read through DelegatingInputStream when you close it, ensure no cache file left on disk and correctly close the connection.&lt;br/&gt;
Append as &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-3504&quot; title=&quot;for big attachment, a temporary file is left on disk and keep opend, if the application just close the DataSource&amp;#39;s inputStream and doesn&amp;#39;t consume it; &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-3504&quot;&gt;&lt;del&gt;CXF-3504&lt;/del&gt;&lt;/a&gt;-new.patch&lt;/p&gt;</comment>
                            <comment id="13036781" author="ext2xhb" created="Fri, 20 May 2011 11:21:31 +0000"  >&lt;p&gt;@FreeMan Fang:&lt;/p&gt;

&lt;p&gt;My private temporary fix is quite different;the strategy I am using is:  &quot;doesn&apos;t make attachments pre cached&quot; but &quot;make delegate input stream always work right&quot;; That&apos;s to say if using sun&apos;s activation. my private fix will still keep all attachment being delegate inputstream(doesn&apos;t cach any one); &lt;br/&gt;
key fixed as following :&lt;/p&gt;

&lt;p&gt;1)avoid recursive calling to DelegateInputStream&apos;s close&lt;br/&gt;
boolean closing = false;&lt;br/&gt;
DelegateInputStream.close{&lt;br/&gt;
  if(!closing){&lt;br/&gt;
     closing = true;&lt;br/&gt;
     is.close();&lt;br/&gt;
     if (!isClosed &amp;amp;&amp;amp; deserializer != null) &lt;/p&gt;
{
       deserializer.markClosed(this);
     }
&lt;p&gt;     isClosed = true;&lt;br/&gt;
  }&lt;br/&gt;
}&lt;br/&gt;
2) consume all underlying bytes while close MIMEPartInputStream()--&amp;gt;(avoid mis read MIME part: for example, if user just close first attachment, and  doesn&apos;t read it, then read second attachment)&lt;/p&gt;

&lt;p&gt;MIMEPartInputStream.close(){&lt;br/&gt;
  while(read() &amp;gt;= 0)&lt;br/&gt;
   ;&lt;br/&gt;
}&lt;br/&gt;
now using sun&apos;s activation will be better than geronimo; because the attachment&apos;s content will never be cached if user doesnt&apos; care about content of the attachment&lt;/p&gt;</comment>
                            <comment id="13037722" author="ext2xhb" created="Mon, 23 May 2011 04:06:30 +0000"  >&lt;p&gt;@FreeMan Fang&lt;br/&gt;
I have tried the new patch. it could works in my scenior;&lt;br/&gt;
Thanks a lot;&lt;/p&gt;</comment>
                            <comment id="13037724" author="ext2xhb" created="Mon, 23 May 2011 04:30:23 +0000"  >&lt;p&gt;@FreeMan Fang:&lt;br/&gt;
by the way, I suggest you&apos;d better to add the checking code of Delegate input stream&apos;s close to avoid recursively close one delegate-input-stream twice; &lt;/p&gt;

&lt;p&gt;Tne delegate-input-stream will be recursived closed twice; to ensure this, you can tracking it use a java-debugger: the calling stack is :&lt;/p&gt;

&lt;p&gt;DelegateInputStream.close-&lt;del&gt;&amp;gt;deserailizer.markClosed()&lt;/del&gt;&lt;del&gt;&amp;gt;attachmentDeserailizer.hasNext()&lt;/del&gt;&lt;del&gt;&amp;gt;attachment.cache()&lt;/del&gt;-&amp;gt;DelegateInputStream.close() &lt;span class=&quot;error&quot;&gt;&amp;#91;here recursive occurs&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Anyway, if we don&apos;t check it, thinks will also work right.(because delegate-input-stream is only used by the last attachment). but it may cause potential problem in future;&lt;/p&gt;
</comment>
                            <comment id="13037823" author="ffang" created="Mon, 23 May 2011 09:47:54 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I think the recursive call is ok here.&lt;/p&gt;

&lt;p&gt;First of all, not all ins in attachment.cache is DelegateInputStream, and we need close the ins in anycase after caching it.&lt;br/&gt;
If the ins in attachment.cache is DelegateInputStream, it&apos;s also fine, the deserializer.markClosed(this) can safely end the call and won&apos;t cause infinite invocation. &lt;/p&gt;

&lt;p&gt;I&apos;ll commit my new patch soon.&lt;/p&gt;

&lt;p&gt;Freeman&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12479894" name="CXF-3504-new.patch" size="633" author="ffang" created="Fri, 20 May 2011 11:20:04 +0000"/>
                            <attachment id="12479886" name="CXF-3504.patch" size="1969" author="ffang" created="Fri, 20 May 2011 08:37:42 +0000"/>
                            <attachment id="12478665" name="attachment-clean.zip" size="13647" author="ext2xhb" created="Tue, 10 May 2011 04:28:41 +0000"/>
                            <attachment id="12478664" name="mtom.wsdl" size="5157" author="ext2xhb" created="Tue, 10 May 2011 03:53:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5858</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 27 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0b94f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>63590</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>