<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:09:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-5684] Flaw in token storing logic when configured to allow token renewal after expiry</title>
                <link>https://issues.apache.org/jira/browse/CXF-5684</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;There seems to be a fundamental flaw in the STS logic for token renewal when configuration allows for renewal beyond token expiration.&lt;/p&gt;

&lt;p&gt;The flaw in logic seems to be in both the SAMLTokenProvider and the SAMLTokenRenewer. In brief, when tokens are added to the default token store, and when allowRenewalAfterExipiry is set to true, the tokens are stored in a way that causes them to expire before you can perform a second token renewal.&lt;/p&gt;

&lt;p&gt;This reason why this flaw does not show up in your system tests is because you are only testing one renewal and the logic for storing a token in SAMLTokenProvider is different than in SAMLTokenRenewer. If you would change your renewal system test to renew the renewed token you would catch this error.&lt;/p&gt;

&lt;p&gt;Here is the relevant code. I will start with SAMLTokenProvider. In the method createToken:&lt;/p&gt;

&lt;p&gt;            if (tokenParameters.getTokenStore() != null &amp;amp;&amp;amp; signatureValue != null&lt;br/&gt;
                &amp;amp;&amp;amp; signatureValue.length &amp;gt; 0) {&lt;br/&gt;
                Date expires = new Date();&lt;br/&gt;
                long currentTime = expires.getTime();&lt;br/&gt;
                expires.setTime(currentTime + (conditionsProvider.getLifetime() * 1000L));&lt;/p&gt;

&lt;p&gt;                SecurityToken securityToken = new SecurityToken(assertion.getId(), null, expires);&lt;/p&gt;

&lt;p&gt;The token is stored with an expiration that is essentially the current time + the lifetime parameter. This means the token is cleared out of the cache after a period of time equal to the &quot;lifetime&quot; setting. If the lifetime setting is larger than token TTL in the request submitted by the STSClient (like in your system test) then renewal will be possible because the token will not get cleared out of the cache before you renew.&lt;/p&gt;

&lt;p&gt;However, consider the logic for storing the token in SAMLRenewer.storeTokenInCache():&lt;/p&gt;

&lt;p&gt;        if (tokenStore != null &amp;amp;&amp;amp; signatureValue != null &amp;amp;&amp;amp; signatureValue.length &amp;gt; 0) {&lt;br/&gt;
            DateTime validTill = null;&lt;br/&gt;
            if (assertion.getSamlVersion().equals(SAMLVersion.VERSION_20)) &lt;/p&gt;
{
                validTill = assertion.getSaml2().getConditions().getNotOnOrAfter();
            }
&lt;p&gt; else &lt;/p&gt;
{
                validTill = assertion.getSaml1().getConditions().getNotOnOrAfter();
            }

&lt;p&gt;            SecurityToken securityToken = new SecurityToken(assertion.getId(), null, validTill.toDate());&lt;/p&gt;

&lt;p&gt;In this case you are setting the token expiration to be exactly equal to the TTL in the request for security token. Which means that when the token expires and you try to renew the token it&apos;s no longer in the cache!&lt;/p&gt;

&lt;p&gt;I believe what should be happening is that you should add the value of the SAMLTokenRenewer maxExpiry field to the &quot;validTill&quot; date. Also the logic in SAMLTokenRenewer should be the same as the logic in SAMLTokenProvider. Right now the logic is duplicated in two different places and that can&apos;t be good for maintainability.&lt;/p&gt;

&lt;p&gt;I hope this is clear enough. The bottom line is that the token cache is using the expiry that you are setting when creating the SecurityToken object to decide when to clear the token out of the cache. If you don&apos;t set this value appropriately the token will not be in the cache when you try to renew it.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux 3.11.0-18-generic x64, Karaf 2.3.2, OpenJDK 64-Bit Server VM version 24.45-b08 &lt;/p&gt;</environment>
        <key id="12707890">CXF-5684</key>
            <summary>Flaw in token storing logic when configured to allow token renewal after expiry</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="coheigea">Colm O hEigeartaigh</assignee>
                                    <reporter username="carma.robot">Carma Robot</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Apr 2014 07:10:44 +0000</created>
                <updated>Fri, 11 Jul 2014 12:50:42 +0000</updated>
                            <resolved>Mon, 14 Apr 2014 14:24:03 +0000</resolved>
                                    <version>2.7.10</version>
                                    <fixVersion>3.0</fixVersion>
                                    <component>STS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13968387" author="coheigea" created="Mon, 14 Apr 2014 14:23:57 +0000"  >
&lt;p&gt;Ok I&apos;ve fixed this for 3.0.0. I&apos;m not going to fix it for 2.7.x as it involves too much of a change as to how tokens are cached. With 2.7.x the logic is that if a token is in the cache, then it is automatically valid. With 3.0.0, expired tokens can be stored in the cache.&lt;/p&gt;

&lt;p&gt;Colm.&lt;/p&gt;</comment>
                            <comment id="13968438" author="carma.robot" created="Mon, 14 Apr 2014 15:34:51 +0000"  >&lt;p&gt;Thanks for the fix in 3.0. I was able to fix this in 2.7.x by coding my own replacement classes. If you like, I can provide those as a potential work around.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>386213</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 32 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1uj73:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>386478</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>