<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:35:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-8259] Blocked thread of JMS transport during jboss shutdown</title>
                <link>https://issues.apache.org/jira/browse/CXF-8259</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;We have a soap over jms webservice implemented with a camel route (Camel 3.2.0) and CXF that uses activemq as message broker. The webservice is deployed on a jboss eap 7.1 with jdk 1.8. Following the CXF upgrade from version 3.3.4 to 3.3.5 (and also with 3.3.6), jboss hangs on shutdown due to a blocking thread of CXF:&lt;/p&gt;

&lt;p&gt;&quot;ServerService Thread Pool &#8211; 82&quot; #231 prio=5 os_prio=0 tid=0x0000000002981800 nid=0x66d2 waiting for monitor entry &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f0d60d2f000&amp;#93;&lt;/span&gt;&lt;br/&gt;
 java.lang.Thread.State: BLOCKED (on object monitor)&lt;br/&gt;
 at org.apache.cxf.transport.AbstractObservable.setMessageObserver(AbstractObservable.java:42)&lt;/p&gt;

&lt;p&gt;Therefore, we can have to kill the Jboss process to complete the shutdown.&lt;br/&gt;
 The connection to activemq is managed by a resource adapter on jboss. Url is configured with a failover as follows:&lt;/p&gt;

&lt;p&gt;failover://(tcp://amqdev.internal:61616,tcp://amqdev.internal:61616,tcp://amqdev.internal:61616)?timeout=1000&amp;amp;initialReconnectDelay=2000&amp;amp;maxReconnectAttempts=2&lt;/p&gt;

&lt;p&gt;Attached you can find the thread dump taken from logs.&lt;br/&gt;
 &#160;&lt;br/&gt;
 &#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13298846">CXF-8259</key>
            <summary>Blocked thread of JMS transport during jboss shutdown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="reta">Andriy Redko</assignee>
                                    <reporter username="aleproscia">Alessandro Proscia</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 Apr 2020 15:06:39 +0000</created>
                <updated>Wed, 22 Dec 2021 20:43:49 +0000</updated>
                            <resolved>Fri, 17 Apr 2020 15:23:44 +0000</resolved>
                                    <version>3.3.5</version>
                    <version>3.3.6</version>
                    <version>3.2.13</version>
                                    <fixVersion>3.2.14</fixVersion>
                    <fixVersion>3.3.7</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>JMS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17085036" author="ffang" created="Thu, 16 Apr 2020 16:01:15 +0000"  >&lt;p&gt;I believe this is caused by the &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-8161&quot; title=&quot;Memory Leak/Thread Leak in JMSDestination &amp;amp; PollingMessageListenerContainer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-8161&quot;&gt;&lt;del&gt;CXF-8161&lt;/del&gt;&lt;/a&gt;, especially this 5a4fd020bc87a552345425541bb62a35b0e5d8b7&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void restartConnection() {
+    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void restartConnection() {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And restartConnection method will always run if something wrong during restartConnection(such as Jms broker is already down in the container) and never release the monitor lock of JMSDestination instance, since JMSDestination is subclass of org.apache.cxf.transport.AbstractObservable, so org.apache.cxf.transport.AbstractObservable will never get the moniter entry lock to finish the endpoint shutdown process. This is how the deadlock comes from.&lt;/p&gt;

&lt;p&gt;Freeman&lt;/p&gt;</comment>
                            <comment id="17085103" author="reta" created="Thu, 16 Apr 2020 17:06:28 +0000"  >&lt;p&gt;Thanks for the hints &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ffang&quot; class=&quot;user-hover&quot; rel=&quot;ffang&quot;&gt;ffang&lt;/a&gt; , I will take a look shortly, remember working with the user on the PR for &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-8161&quot; title=&quot;Memory Leak/Thread Leak in JMSDestination &amp;amp; PollingMessageListenerContainer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-8161&quot;&gt;&lt;del&gt;CXF-8161&lt;/del&gt;&lt;/a&gt;, thanks!&lt;/p&gt;</comment>
                            <comment id="17085105" author="ffang" created="Thu, 16 Apr 2020 17:08:11 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reta&quot; class=&quot;user-hover&quot; rel=&quot;reta&quot;&gt;reta&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for looking into this.&lt;/p&gt;

&lt;p&gt;Probably we can simply move the synchronized keyword from the whole restartConnection method to the code block to createTargetDestinationListener. Like this&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void restartConnection() {
+    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void restartConnection() {
         &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; tries = 0;
         &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; {
             tries++;
             &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
-                deactivate();
-                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.jmsListener = createTargetDestinationListener();
-                LOG.log(Level.INFO, &lt;span class=&quot;code-quote&quot;&gt;&quot;Established JMS connection&quot;&lt;/span&gt;);
+                &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;) {
+                    deactivate();
+                    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.jmsListener = createTargetDestinationListener();
+                    LOG.log(Level.INFO, &lt;span class=&quot;code-quote&quot;&gt;&quot;Established JMS connection&quot;&lt;/span&gt;);
+                }
             } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e1) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So this method won&apos;t hold the lock forever in indefinite while loop.&lt;/p&gt;

&lt;p&gt;Best Regards&lt;br/&gt;
Freeman&lt;/p&gt;</comment>
                            <comment id="17085231" author="reta" created="Thu, 16 Apr 2020 20:10:53 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ffang&quot; class=&quot;user-hover&quot; rel=&quot;ffang&quot;&gt;ffang&lt;/a&gt; , I will try that for sure.&lt;/p&gt;</comment>
                            <comment id="17085301" author="reta" created="Thu, 16 Apr 2020 22:39:15 +0000"  >&lt;p&gt;Ok, so this particular change was flagged as potential deadlock (&lt;a href=&quot;https://github.com/apache/cxf/pull/603/files#diff-fcece95462c2633e642f31c76583896c)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/603/files#diff-fcece95462c2633e642f31c76583896c)&lt;/a&gt; but was missed compelling 100% illustrative case (now we have one). I am not sure we even do need synchronized here, will send the PR without it while continue testing the possible flaws.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13269541">CXF-8161</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13000160" name="jboss.log" size="49556" author="aleproscia" created="Thu, 16 Apr 2020 14:54:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 30 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0dpow:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>