<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:23:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-5525] Client - UntrustedURLConnectionIOException even the HTTPS established with client certificate auth</title>
                <link>https://issues.apache.org/jira/browse/CXF-5525</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Hi,&lt;br/&gt;
I&apos;m facing issue with CXF client. I have a Java client generated from WSDL. The WSDL contains RequireClientCertificate=&quot;true&quot; in the Policy. I&apos;m calling a web service over HTTPS with client certificate authentication. Although HTTPS connection is established and with client certificate authentication (ensured with -Djavax.net.debug=all), calling a WS method throws exception.&lt;br/&gt;
The strange thing is, that the first call succeeded and the second and all other calls, fail with this exception &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/warning.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. The other calls can be done with the same client object or can create new, no matter. The client object is created as follows:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// our custom ssl settings, with client cert auth in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;.
&lt;/span&gt;SSLSocketFactory sslSockF =
createSSLSocketFactoryFromProperties(_properties);
ProductionService service = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ProductionService(
         &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URL(myURL),
         &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; QName(&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//mycompany.com/api/productionService&quot;&lt;/span&gt;,
&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;ProductionService&quot;&lt;/span&gt;));
port = service.getBasicHttpBindingIProductionService();
Client client = ClientProxy.getClient(port);
HTTPConduit http = (HTTPConduit) client.getConduit();
TLSClientParameters tlsParams = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TLSClientParameters();
tlsParams.setDisableCNCheck(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
tlsParams.setSSLSocketFactory(sslSockF);
http.setTlsClientParameters(tlsParams);
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; port;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The exception:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-----------------------------
etc...
Caused by: org.apache.cxf.transport.http.UntrustedURLConnectionIOException: UntrustedURLConnectionIOException invoking https://192.168.101.14/myApplication/services/ProductionService.svc: RequireClientCertificate is set, but no local certificates were negotiated.  Is the server set to ask for client authorization?
 at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
 at sun.reflect.NativeConstructorAccessorImpl.newInstance(Unknown Source)
 at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(Unknown Source)
 at java.lang.reflect.Constructor.newInstance(Unknown Source)
 at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.mapException(HTTPConduit.java:1334)
 at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.close(HTTPConduit.java:1318)
 at org.apache.cxf.transport.AbstractConduit.close(AbstractConduit.java:56)
 at org.apache.cxf.transport.http.HTTPConduit.close(HTTPConduit.java:623)
 at org.apache.cxf.interceptor.MessageSenderInterceptor$MessageSenderEndingInterceptor.handleMessage(MessageSenderInterceptor.java:62)
 at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:271)
 at org.apache.cxf.endpoint.ClientImpl.doInvoke(ClientImpl.java:541)
 at org.apache.cxf.endpoint.ClientImpl.invoke(ClientImpl.java:474)
 at org.apache.cxf.endpoint.ClientImpl.invoke(ClientImpl.java:377)
 at org.apache.cxf.endpoint.ClientImpl.invoke(ClientImpl.java:330)
 at org.apache.cxf.frontend.ClientProxy.invokeSync(ClientProxy.java:96)
 at org.apache.cxf.jaxws.JaxWsClientProxy.invoke(JaxWsClientProxy.java:134)
 ... 14 more
Caused by: org.apache.cxf.transport.http.UntrustedURLConnectionIOException: RequireClientCertificate is set, but no local certificates were negotiated.  Is the server set to ask for client authorization?
 at org.apache.cxf.ws.security.policy.interceptors.HttpsTokenInterceptorProvider$HttpsTokenOutInterceptor$1.establishTrust(HttpsTokenInterceptorProvider.java:117)
 at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.makeTrustDecision(HTTPConduit.java:1680)
 at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.handleHeadersTrustCaching(HTTPConduit.java:1264)
 at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.onFirstWrite(HTTPConduit.java:1234)
 at org.apache.cxf.transport.http.URLConnectionHTTPConduit$URLConnectionWrappedOutputStream.onFirstWrite(URLConnectionHTTPConduit.java:195)
 at org.apache.cxf.io.AbstractWrappedOutputStream.write(AbstractWrappedOutputStream.java:47)
 at org.apache.cxf.io.AbstractThresholdOutputStream.write(AbstractThresholdOutputStream.java:69)
 at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.close(HTTPConduit.java:1291)
 ... 24 more
-----------------------------
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;java 1.6.0_45 and 1.7.0_45 on Windows 8, CXF version 2.7.6&lt;/p&gt;</environment>
        <key id="12691336">CXF-5525</key>
            <summary>Client - UntrustedURLConnectionIOException even the HTTPS established with client certificate auth</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jakub.neubauer">Jakub Neubauer</reporter>
                        <labels>
                    </labels>
                <created>Mon, 27 Jan 2014 09:52:00 +0000</created>
                <updated>Fri, 24 Mar 2017 15:48:39 +0000</updated>
                                                                            <component>Transports</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13979560" author="jakub.neubauer" created="Thu, 24 Apr 2014 10:42:34 +0000"  >&lt;p&gt;Problem is that client certificate verification is done by IIS in later time, not at the beginning of the SSL communication. I&apos;ll try do describe the communication:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;SSL Handshake is done between client and IIS server, but first WITHOUT client certificate verification.&lt;/li&gt;
	&lt;li&gt;Client sends the HTTP request (at least the header, where URL is specified).&lt;/li&gt;
	&lt;li&gt;IIS server recognizes the requested URL and re-initiates the SSL handshake (with SSL message Change_cipher_spec). It works in this way because in IIS you can specify different SSL behaviour for different URLs. So for example, for one endpoint you can configure SSL without client certificate and for second endpoint WITH client certificate.&lt;/li&gt;
	&lt;li&gt;During the second SSL handshake, the client certificate is requested by IIS server and verified.&lt;/li&gt;
	&lt;li&gt;Then the rest of request is processed by IIS server.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Problem is, that CXF client doesn&apos;t count with this behaviour. If certificate authentication is configured in WSDL, the CXF client performs a check that the client certificate was sent during the handshake (in one of the CXF phases - org.apache.cxf.phase.Phase). But it is done just after the FIRST handshake. This check by CXF client is done yet before the request data are sent, it is performed after just the first SSL handshake. But as I described, the first handshake is without client certificate. The certificate is requested by IIS server in second handshake, after URL is known to the IIS server. But CXF client never comes to this point, since it fails on the check after the first handshake - as is seen from the exception stacktrace.&lt;/p&gt;

&lt;p&gt;So, I suggest not doing the check that client certificate was requested by the server - after all, it is the SERVER responsibility to check the certificate - why should the CXF client care about it?&lt;br/&gt;
It means removing the code in the HttpsTokenInterceptorProvider.java, somewhere around line 115:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if (info.getLocalCertificates() == null || info.getLocalCertificates().length == 0) {
  throw new UntrustedURLConnectionIOException( &quot;RequireClientCertificate is set, &quot;
    + &quot;but no local certificates were negotiated.  Is&quot;
    + &quot; the server set to ask for client authorization?&quot;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13979627" author="sergey_beryozkin" created="Thu, 24 Apr 2014 12:12:44 +0000"  >&lt;p&gt;Perhaps a contextual property can be introduced that will allow this interceptor skip the check. &lt;/p&gt;
</comment>
                            <comment id="13985964" author="dkulp" created="Wed, 30 Apr 2014 19:38:32 +0000"  >
&lt;p&gt;I wonder if we call a req.getOutputStream().flush() or similar to flush the headers if the second negotiation would occur and we could get the certs.  Since this is an &quot;on first write&quot; thing, we could even send the first byte of the payload or similar to make sure data is there (to avoid the &quot;0&quot; size block in chunked mode).&lt;/p&gt;

&lt;p&gt;IMO, it&apos;s both the clients and servers responsibility to make sure the cert is used.  I&apos;d certainly prefer to keep the check on by default.   Maybe the option as Sergey suggests.&lt;/p&gt;</comment>
                            <comment id="13986091" author="jakub.neubauer" created="Wed, 30 Apr 2014 21:11:44 +0000"  >&lt;p&gt;I think first byte will be not enough, at least first line is necessary, so that the server can know the request URL and can decide if it will trigger the renegotiation.&lt;br/&gt;
But I didn&apos;t tested, if the first line of request is enough specifically for IIS. The fact that it is enough theoretically, doesn&apos;t mean that IIS behaves so. But hopefully yes.&lt;/p&gt;</comment>
                            <comment id="13986101" author="dkulp" created="Wed, 30 Apr 2014 21:15:25 +0000"  >&lt;p&gt;I&apos;m talking about the first byte of the content which would then cause all the headers to be flushed.&lt;/p&gt;</comment>
                            <comment id="13986109" author="jakub.neubauer" created="Wed, 30 Apr 2014 21:23:01 +0000"  >&lt;p&gt;Actually it was my first idea to call the flush somewhere before the certificate check, but I don&apos;t know CXF in such deep. I saw some buffering in streams, which causes that the payload is sent in some later phase. From the stacktrace it can be seen, that the certificate check is called within HTTPConduit$WrappedOutputStream.close(). That all confused me and made me shy to propose such change anywhere in the code... Maybe more experienced authors will se the right place.&lt;/p&gt;</comment>
                            <comment id="14125349" author="jarrydk" created="Mon, 8 Sep 2014 09:37:19 +0000"  >&lt;p&gt;I experience the same with CXF 2.7.8 on Windows 7 with JDK 1.8.0_05. I also experience the same on wildfly-8.1.0.Final.&lt;/p&gt;</comment>
                            <comment id="14255645" author="istvankis" created="Mon, 22 Dec 2014 11:03:57 +0000"  >&lt;p&gt;Is there any verified workaround for this?&lt;/p&gt;</comment>
                            <comment id="14258865" author="jakub.neubauer" created="Thu, 25 Dec 2014 22:49:01 +0000"  >&lt;p&gt;I used some workaround. Currently I am on holidays, so after that I can send an implementation. The idea was to add some interceptor yet before that one which causes that exception. This interceptor modifies something in the context so that this check is not triggered and the exception does not occur.&lt;/p&gt;</comment>
                            <comment id="14948642" author="kstam" created="Thu, 8 Oct 2015 13:24:28 +0000"  >&lt;p&gt;Hey Jakub, back from holidays yet? I&apos;m running into the same issue and am wondering if you can publish your workaround.&lt;/p&gt;</comment>
                            <comment id="14948686" author="jakub.neubauer" created="Thu, 8 Oct 2015 13:56:43 +0000"  >&lt;p&gt;Ok, maybe dirty, but it works. But that you probably expect from &quot;workaround&quot;, yeah? Can somebody try to analyze if it causes some security flaw? I personally don&apos;t see a problem in it.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;WorkaroundCxfBug5525.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;WorkaroundCxfBug5525 {
	
		&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;CxfBug5525WorkaroundInterceptor &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; AbstractPhaseInterceptor&amp;lt;Message&amp;gt; {
	
			&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; CxfBug5525WorkaroundInterceptor() {
				&lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(Phase.PREPARE_SEND);
			}
			@Override
			&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void handleMessage(Message message) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Fault {
				AssertionInfoMap aim = message.get(AssertionInfoMap.class);
				&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (aim == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) { &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;; }
				Collection&amp;lt;AssertionInfo&amp;gt; ais = aim.get(SP12Constants.HTTPS_TOKEN);
				&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ais == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) { &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;; }
				&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (AssertionInfo ai : ais) {
					&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(!(ai.getAssertion() &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; HttpsToken)) { &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;; }
					HttpsToken token = (HttpsToken)ai.getAssertion();
					token.setRequireClientCertificate(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
				}
			}
		}
	
		/**
		 * See https:&lt;span class=&quot;code-comment&quot;&gt;//issues.apache.org/jira/browse/CXF-5525
&lt;/span&gt;		 *
		 * @param client
		 */
		&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void setupWorkaround(Client client) {
			client.getOutInterceptors().add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CxfBug5525WorkaroundInterceptor());
		}
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can use it like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Client client = ClientProxy.getClient(yourProxyPort);
WorkaroundCxfBug5525.setupWorkaround(client);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14967252" author="kstam" created="Wed, 21 Oct 2015 14:46:35 +0000"  >&lt;p&gt;Thanks Jakub. That worked for me.&lt;/p&gt;</comment>
                            <comment id="15874524" author="florian@fpaetz.de" created="Mon, 20 Feb 2017 13:24:46 +0000"  >&lt;p&gt;After a long debugging session, I got, I searched for this bug. I am using cxf 3.0.11.&lt;br/&gt;
I could establish the workaround. &lt;br/&gt;
Is there any work on this Problem? I think, it would work, using the TLSClientParameters for the check if there is a client certificate.&lt;/p&gt;
</comment>
                            <comment id="15892574" author="coheigea" created="Thu, 2 Mar 2017 16:42:20 +0000"  >&lt;p&gt;Checking TLSClientParameters would not be sufficient IMO. Until we come up with a more satisfactory fix, in the meantime I&apos;ve merged a workaround. You can disable the client check by setting the JAX-WS property &quot;ws-security.disable.require.client.cert.check&quot; to &quot;true&quot;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>370081</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 37 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1rs93:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>370383</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>