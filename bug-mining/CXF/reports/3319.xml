<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:32:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-7784] java.util.ConcurrentModificationException on WebTarget.request()</title>
                <link>https://issues.apache.org/jira/browse/CXF-7784</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;By chance we stumbled over a case, where calling&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
webTarget.request()&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;sometimes may lead to a&#160;&lt;tt&gt;java.util.ConcurrentModificationException&lt;/tt&gt;,&#160;if the &lt;tt&gt;webTarget&lt;/tt&gt; is created in one thread, but the call&#160;to &lt;tt&gt;.request()&lt;/tt&gt; is performed in multiple concurrent threads afterwards. In our environment it was possible to provoke the exception&#160;with&#160;probability of ~10%, if run with 4 threads in parallel.&lt;/p&gt;

&lt;p&gt;The callstack, which we could isolate, was:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.util.ConcurrentModificationException
 at java.util.ArrayList$Itr.checkForComodification(ArrayList.java:909)
 at java.util.ArrayList$Itr.next(ArrayList.java:859)
 at org.apache.cxf.jaxrs.provider.ProviderFactory.injectContextProxies(ProviderFactory.java:638)
 at org.apache.cxf.jaxrs.provider.ProviderFactory.setCommonProviders(ProviderFactory.java:600)
 at org.apache.cxf.jaxrs.client.ClientProviderFactory.setProviders(ClientProviderFactory.java:74)
 at org.apache.cxf.jaxrs.provider.ProviderFactory.setUserProviders(ProviderFactory.java:791)
 at org.apache.cxf.jaxrs.client.spec.ClientImpl$WebTargetImpl.request(ClientImpl.java:282)
 at &amp;lt;&amp;lt;custom-coding-which-calls-webTarget.request()&amp;gt;&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We currently have a workaround with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (webTarget) {
&#160; &#160;webTarget.request();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which isn&apos;t perfect, but good enough for our case.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Is this case known to you? We did not try to reproduce the issue in isolation, yet (as it was hard enough to find it in our application already). If we should give it a try, please notify us.&lt;/p&gt;</description>
                <environment>&lt;ul&gt;
	&lt;li&gt;Hystrix 1.5.9&lt;/li&gt;
	&lt;li&gt;Spring-Boot&#160;1.5.14&lt;/li&gt;
	&lt;li&gt;JAXRS 3.1.14&lt;/li&gt;
&lt;/ul&gt;
</environment>
        <key id="13170659">CXF-7784</key>
            <summary>java.util.ConcurrentModificationException on WebTarget.request()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10008">Information Provided</resolution>
                                        <assignee username="reta">Andriy Redko</assignee>
                                    <reporter username="dschmoigl">Dominic Schmoigl</reporter>
                        <labels>
                            <label>cxf-rt-frontend-jaxrs</label>
                    </labels>
                <created>Sat, 7 Jul 2018 22:32:22 +0000</created>
                <updated>Mon, 18 Sep 2023 18:51:45 +0000</updated>
                            <resolved>Sun, 22 Jul 2018 22:57:02 +0000</resolved>
                                    <version>3.1.14</version>
                                                    <component>JAX-RS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16535960" author="reta" created="Sun, 8 Jul 2018 02:03:56 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dschmoigl&quot; class=&quot;user-hover&quot; rel=&quot;dschmoigl&quot;&gt;dschmoigl&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;The JAX-RS 2.x specification says nothing about thread safety of the Client API so it really runs down to be implementation-specific subject. With respect to CXF, the client APIs are *&lt;b&gt;not thread-safe&lt;/b&gt;* by default: &lt;a href=&quot;http://cxf.apache.org/docs/jax-rs-client-api.html#JAX-RSClientAPI-ThreadSafety.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cxf.apache.org/docs/jax-rs-client-api.html#JAX-RSClientAPI-ThreadSafety.&lt;/a&gt; Hope it helps, thanks!&lt;/p&gt;

&lt;p&gt;Best Regards,&lt;/p&gt;

&lt;p&gt;&#160;&#160;&#160; Andriy Redko&lt;/p&gt;</comment>
                            <comment id="16544469" author="dschmoigl" created="Sun, 15 Jul 2018 08:32:06 +0000"  >&lt;p&gt;Hi Andriy,&lt;/p&gt;

&lt;p&gt;thanks for pointer - well, it helps partially&#160;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I do agree and understand that thread-safety is not ensured by the specification in general. However, on the page you gave the link for it is stated:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;A single client doing multiple invocations without changing the current URI or headers is thread-safe.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;To my mind this is exactly what we are doing:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;On the main class, we are creating a new client using
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
client = ClientBuilder.newClient()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;Still in the main class, we then configure a corresponding WebTarget out of it. There is no proxy configuration involved.&lt;/li&gt;
	&lt;li&gt;That WebTarget then gets distributed to the threads.&lt;/li&gt;
	&lt;li&gt;The threads then do a
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
webTarget.request()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which is the call which fails here in this case.&lt;br/&gt;
 NB: We even don&apos;t get to the point where we would be able to access the&#160;headers of that request (the exception is thrown already earlier).&#160;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;It might be worth to&#160;mention that there may be multiple &quot;main threads&quot; in parallel. Could this have some possible side effect?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;Best regards,&lt;br/&gt;
 Dominic&lt;/p&gt;</comment>
                            <comment id="16544711" author="reta" created="Mon, 16 Jul 2018 00:38:43 +0000"  >&lt;p&gt;Hi Dominic,&lt;/p&gt;

&lt;p&gt;Thanks a lot for digging through the docs, indeed some parts are somewhat unclear (even a bit controversial). Let me take a look at this particular issue, first trying to reproduce it (should not be too hard since you are getting it quite often). I afraid that we may fix this one but (many?) other may pop up. So yeah, could be challenging&#160; ... Do you have a workaround for the time being? (like create client per thread f.e.) Thanks!&lt;/p&gt;

&lt;p&gt;Best Regards,&lt;/p&gt;

&lt;p&gt;&#160;&#160;&#160; Andriy Redko&lt;/p&gt;</comment>
                            <comment id="16544867" author="dschmoigl" created="Mon, 16 Jul 2018 07:01:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;I afraid that we may fix this one but (many?) other may pop up. So yeah, could be challenging ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That&apos;s one of the reasons why I opened this ticket &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; The more bugs we find (and are able to fix) the better.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Do you have a workaround for the time being? (like create client per thread f.e.) Thanks!&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;As described above, it seems a valid approach to &quot;synchronized&quot; around it like&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (webTarget) {
   webTarget.request();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We have done so for now, and so far (for more than one week) we did not encounter the same issue again. Fortunately, the impact is not too severe for us. &lt;br/&gt;
 We are currently also looking into your alternative approach (&quot;create client per thread&quot;), but fortunately our level of suffering is not too&#160;high&#160;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ... as we have the workaround already in place. That&apos;s also why I only created the ticket here with priority &quot;minor&quot; -&#160;we simply would like to give you (all) the chance to look into it and - perhaps - improve the quality in this regard.&lt;/p&gt;</comment>
                            <comment id="16545051" author="reta" created="Mon, 16 Jul 2018 10:43:52 +0000"  >&lt;p&gt;Thanks Dominic, assigning the ticket to myself for further investigation.&lt;/p&gt;</comment>
                            <comment id="16545921" author="reta" created="Tue, 17 Jul 2018 01:31:56 +0000"  >&lt;p&gt;Hey Dominic,&lt;/p&gt;

&lt;p&gt;Good and bad news at the same time. On the good side, surely, I was able to reproduce the issue in the simple test case, thanks to your detailed description. On the bad side, it turned out that the `Client` reuses the same `ClientProviderFactory` instance on each `request()` invocation. And the latter was not designed to be thread-safe, from top to bottom. For sure, we could have added `synchronized` everywhere but this is more like monkey patching rather&#160; than acceptable solution. &lt;/p&gt;

&lt;p&gt;But, one more thing on a good side. It seems like you could go one step further and safely share the `Invocation.Builder` instance, for example:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Invocation.Builder builder = webTarget.request();&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It also qualifies under this statement pretty well as all invocation calls are available&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;A single client doing multiple invocations without changing the current URI or headers is thread-safe.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;And I was not able to spot any concurrent modification exceptions or alike while using `builder` from many threads. I am wondering if this solution would fit to your use case (it should be, right?). Thanks.&lt;/p&gt;

&lt;p&gt;Best Regards,&lt;br/&gt;
&#160;&#160;&#160; Andriy Redko&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16546100" author="dschmoigl" created="Tue, 17 Jul 2018 06:51:49 +0000"  >&lt;p&gt;Thanks for your analysis and your input! We&apos;ll have a look at your proposal and will come back to you.&lt;/p&gt;</comment>
                            <comment id="16546765" author="dschmoigl" created="Tue, 17 Jul 2018 15:11:06 +0000"  >&lt;blockquote&gt;
&lt;p&gt; It seems like you could go one step further and safely share the `Invocation.Builder` instance&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Well, synchronizing on this instance has quite the same impact (and that&apos;s our workaround). &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;It also qualifies under this statement pretty well as all invocation calls are available&lt;br/&gt;
... A single client doing multiple invocations without changing the current URI or headers is thread-safe....&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well, that statement says nothing on the RequestBuilder. That&apos;s why I would suggest to improve the documentation there to say - something like:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;A single client doing multiple invocations without changing the current URI or headers is thread-safe (creating a RequestBuilder is not considered thread-safe, though)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Alternative ideas are also welcome!&lt;/p&gt;</comment>
                            <comment id="16546823" author="reta" created="Tue, 17 Jul 2018 16:02:54 +0000"  >&lt;p&gt;Documentation will certainly need improvements (I&apos;ll do that shortly, no doubts), thanks. Regarding the&#160;&#160;`Invocation.Builder` instance, you don&apos;t need to synchronize over it, at least not supposed to.&lt;/p&gt;

&lt;p&gt;&amp;lt;main thread&amp;gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Invocation.Builder builder = webTarget.request();&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt; &amp;lt;worker thread #1&amp;gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
builder.get()&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt; &amp;lt;worker thread #2&amp;gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
builder.put(...)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt; ....&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16552190" author="reta" created="Sun, 22 Jul 2018 22:57:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dschmoigl&quot; class=&quot;user-hover&quot; rel=&quot;dschmoigl&quot;&gt;dschmoigl&lt;/a&gt; The documentation section has been updated, I also added a test case to stress the Invocation.Builder methods concurrently.&lt;/p&gt;</comment>
                            <comment id="16552413" author="dschmoigl" created="Mon, 23 Jul 2018 07:07:10 +0000"  >&lt;p&gt;Thanks!&lt;br/&gt;
We are currently trying to implement your suggested approach, but are struggling with some other related (non-CXF) issue there. &lt;/p&gt;

&lt;p&gt;BTW: Should the adjusted documentation be already online?&lt;/p&gt;</comment>
                            <comment id="16552626" author="reta" created="Mon, 23 Jul 2018 10:38:21 +0000"  >&lt;p&gt;I think documentation is republished periodically (but not immediately), should be available here &lt;a href=&quot;http://cxf.apache.org/docs/jax-rs-client-api.html#JAX-RSClientAPI-ThreadSafety,&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cxf.apache.org/docs/jax-rs-client-api.html#JAX-RSClientAPI-ThreadSafety,&lt;/a&gt; the Wiki page for it with changes is here &lt;a href=&quot;https://cwiki.apache.org/confluence/display/CXF20DOC/JAX-RS+Client+API#JAX-RSClientAPI-ThreadSafety.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/CXF20DOC/JAX-RS+Client+API#JAX-RSClientAPI-ThreadSafety.&lt;/a&gt; Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 17 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vn5b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>