<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:22:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-7135] ConcurrentModificationException in MessageImpl.calcContextCache() when using JMS Transport and JAXRS Client</title>
                <link>https://issues.apache.org/jira/browse/CXF-7135</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Our platform allows the user to switch transports for a particular proxy based on configuration. We currently allow HTTP and JMS as possible options.&lt;/p&gt;

&lt;p&gt;During recent performance testing, we&apos;ve hit a bug which causes JAXRS Clients over JMS to fail with a ConcurrentModificationException:&lt;/p&gt;

&lt;p&gt;A test case is attached that reproduces our problem.&lt;/p&gt;

&lt;p&gt;Our test executes requests across multiple concurrent threads, switching between JMS and HTTP for both JAXWS and JAXRS Client Proxies. In the test case:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;JAXWS over both HTTP and JMS works fine, both in single and multi-threaded tests.&lt;/li&gt;
	&lt;li&gt;JAXRS works fine across single and multi-threaded tests over HTTP with the &apos;ThreadSafe&apos; flag set on the Client Factory.&lt;/li&gt;
	&lt;li&gt;JAXRS over JMS fails in both single-threaded and multi-threaded mode with error (1) below. In multi-threaded, also fails with (2) below.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;1) The ConnectionFactoryFeature fails to properly set the JMS Connection Factory on the Conduit and results in an error at send-time because no Connection Factory is set. This is because in JAXRS Clients, the InterceptorProvider is neither a Client or Server, it is a ClientConfiguration, so the JMS ConnectionFactoryFeature does not fire either of it&apos;s methods:&lt;/p&gt;

&lt;p&gt;public void initialize(Client client, Bus bus) &lt;br/&gt;
public void initialize(Server server, Bus bus)&lt;/p&gt;

&lt;p&gt;We have worked around this in our code by sub-classing and overriding the method:&lt;br/&gt;
public void initialize(InterceptorProvider interceptorProvider, Bus bus)&lt;/p&gt;

&lt;p&gt;.. and adding code similar to that in the ConnectionFactory feature. This resolves the missing ConnectionFactory problem and JAXRS-over-JMS works fine in single-threaded mode.&lt;/p&gt;

&lt;p&gt;2) Under multi-threaded conditions, the JAXRS Clients fail with the following exception:&lt;/p&gt;

&lt;p&gt;javax.ws.rs.client.ResponseProcessingException: Problem with reading the data, class java.lang.String, ContentType: text/plain.&lt;br/&gt;
	at org.apache.cxf.jaxrs.impl.ResponseImpl.reportMessageHandlerProblem(ResponseImpl.java:438)&lt;br/&gt;
	at org.apache.cxf.jaxrs.impl.ResponseImpl.doReadEntity(ResponseImpl.java:378)&lt;br/&gt;
	at org.apache.cxf.jaxrs.client.AbstractClient.readBody(AbstractClient.java:521)&lt;br/&gt;
	at org.apache.cxf.jaxrs.client.ClientProxyImpl.handleResponse(ClientProxyImpl.java:817)&lt;br/&gt;
	at org.apache.cxf.jaxrs.client.ClientProxyImpl.doChainedInvocation(ClientProxyImpl.java:760)&lt;br/&gt;
	at org.apache.cxf.jaxrs.client.ClientProxyImpl.invoke(ClientProxyImpl.java:228)&lt;br/&gt;
	at com.sun.proxy.$Proxy24.doSimpleMethod(Unknown Source)&lt;br/&gt;
	at com.ge.testcase.ThreadingTest$ThreadedRSJMSTest.run(ThreadingTest.java:132)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;br/&gt;
Caused by: java.util.ConcurrentModificationException&lt;br/&gt;
	at java.util.HashMap$HashIterator.nextNode(HashMap.java:1429)&lt;br/&gt;
	at java.util.HashMap$EntryIterator.next(HashMap.java:1463)&lt;br/&gt;
	at java.util.HashMap$EntryIterator.next(HashMap.java:1461)&lt;br/&gt;
	at java.util.HashMap.putMapEntries(HashMap.java:511)&lt;br/&gt;
	at java.util.HashMap.putAll(HashMap.java:784)&lt;br/&gt;
	at org.apache.cxf.message.MessageImpl$1.putAll(MessageImpl.java:188)&lt;br/&gt;
	at org.apache.cxf.message.MessageImpl.calcContextCache(MessageImpl.java:213)&lt;br/&gt;
	at org.apache.cxf.message.MessageImpl.getContextualProperty(MessageImpl.java:174)&lt;br/&gt;
	at org.apache.cxf.jaxrs.impl.HttpHeadersImpl.getRequestHeaders(HttpHeadersImpl.java:172)&lt;br/&gt;
	at org.apache.cxf.jaxrs.utils.JAXRSUtils.readFromMessageBodyReader(JAXRSUtils.java:1345)&lt;br/&gt;
	at org.apache.cxf.jaxrs.impl.ResponseImpl.doReadEntity(ResponseImpl.java:369)&lt;br/&gt;
	... 7 more&lt;/p&gt;

&lt;p&gt;This occurs even though the &apos;ThreadSafe&apos; property is set via:&lt;/p&gt;

&lt;p&gt;rsClientFactory.setThreadSafe(true);&lt;/p&gt;

&lt;p&gt;Also, interestingly, this exception occurs even if I put the entire Proxy Client invocation in a synchronized block (which should effectively render the Clients single-threaded). &lt;/p&gt;

&lt;p&gt;Finally, one important factor is that this error only happens on the latest 3.0.x release (3.0.11). When I switch my test case to 3.1.8, it does NOT occur. Not sure if this equates to a fix not being back-ported, or a fundamental difference in functionality. Sadly, we&apos;re not able to yet move to 3.1.x, because of running inside the Karaf container, and our dependencies on Camel and Spring 3.x.&lt;/p&gt;

&lt;p&gt;I&apos;ve done quite a large amount of digging through the code to try and narrow down the scope of the problem, and the results above is as far as I could get, unfortunately. My guess/assumption is that there are some JMS-specific objects that are being added to the Request/Response context which are being added/removed in a non-thread safe way. Purely a guess, though.&lt;/p&gt;

&lt;p&gt;Thanks. Please let me know if you need any other information.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Mac OSX 10.11.6. &lt;br/&gt;
Java JDK 1.8.0_71 (64 bit Server)&lt;/p&gt;</environment>
        <key id="13021128">CXF-7135</key>
            <summary>ConcurrentModificationException in MessageImpl.calcContextCache() when using JMS Transport and JAXRS Client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sergey_beryozkin">Sergey Beryozkin</assignee>
                                    <reporter username="DanSalt">Dan Salt</reporter>
                        <labels>
                    </labels>
                <created>Wed, 16 Nov 2016 12:35:17 +0000</created>
                <updated>Wed, 22 Mar 2017 17:25:04 +0000</updated>
                            <resolved>Fri, 25 Nov 2016 14:54:31 +0000</resolved>
                                    <version>3.0.11</version>
                                    <fixVersion>3.0.12</fixVersion>
                                    <component>JAX-RS</component>
                    <component>JMS</component>
                        <due></due>
                            <votes>4</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15670330" author="dansalt" created="Wed, 16 Nov 2016 12:35:54 +0000"  >&lt;p&gt;Test case for this issue&lt;/p&gt;</comment>
                            <comment id="15683097" author="sergey_beryozkin" created="Mon, 21 Nov 2016 10:12:04 +0000"  >&lt;p&gt;I&apos;ve started with updating ConnectionFactoryFeature.&lt;/p&gt;</comment>
                            <comment id="15683527" author="sergey_beryozkin" created="Mon, 21 Nov 2016 12:59:23 +0000"  >&lt;p&gt;I suspect the reason it fails in case of JAX-RS proxy client using JMS transport in 3.0.11 but not in 3.1.8 is that in 3.1.8 Message.getContextualProperty is called somewhere before the in-chain completes (and this is why it works for HTTP too).&lt;/p&gt;

&lt;p&gt;JAX-RS Proxy response processing code was originally implemented to run after the in-chain completes and will be good to move it to the interceptor eventually. But I&apos;m nearly 100% sure that in case of JMS, the fix would be about finding where in 3.1.8 Message.getContextualProperty() is called, and porting the relevant code to 3.1.12-SNAPSHOT   &lt;/p&gt;</comment>
                            <comment id="15683835" author="sergey_beryozkin" created="Mon, 21 Nov 2016 15:18:43 +0000"  >&lt;p&gt;May be I need to lower that &apos;nearly 100%&apos; estimate - adding a custom interceptor which reads an arbitrary contextual property did not help &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15695786" author="yelin66" created="Fri, 25 Nov 2016 12:47:41 +0000"  >&lt;p&gt;I am currently out of the office returning Monday November 28th.&lt;/p&gt;

&lt;p&gt;Sorry for the inconvenience, and I&apos;ll respond to you as soon as I can.&lt;/p&gt;</comment>
                            <comment id="15696036" author="sergey_beryozkin" created="Fri, 25 Nov 2016 14:54:24 +0000"  >&lt;p&gt;Dan provided a fix for a similar JMS related issue earlier for 3.1.x and I ported it to 3.0.x, thanks&lt;/p&gt;</comment>
                            <comment id="15696041" author="dansalt" created="Fri, 25 Nov 2016 14:56:45 +0000"  >&lt;p&gt;Sergey,&lt;/p&gt;

&lt;p&gt;That&apos;s great to hear! Many thanks for the super-fast resolution &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Dan&lt;/p&gt;</comment>
                            <comment id="15696049" author="sergey_beryozkin" created="Fri, 25 Nov 2016 15:00:05 +0000"  >&lt;p&gt;Hi Dan, well, I was preparing to suffer for few more weeks, trying to find the fix &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;, then I found that Dan Kulp&apos;s fix was not ported and this is when I acted really fast &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Cheers, Sergey&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12839166" name="cxf-rsjms-testcase.zip" size="46087" author="DanSalt" created="Wed, 16 Nov 2016 12:35:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 51 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i36ebj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>