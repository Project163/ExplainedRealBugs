<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:11:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-5938] LuceneQueryVisitor is not reusable / not thread-safe</title>
                <link>https://issues.apache.org/jira/browse/CXF-5938</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;LuceneQueryVisitor class is not really reusable in current implementation: it keeps the state of all parsed queries (which is generally fine) but it groups them by property name, returning the first query from the list all the time. That means running two search criteria like &apos;ct=java&apos; and &apos;ct=websockets&apos; causes the result of &apos;ct=java&apos; to be returned in both cases (very easy reproducible).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12733351">CXF-5938</key>
            <summary>LuceneQueryVisitor is not reusable / not thread-safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="reta">Andriy Redko</assignee>
                                    <reporter username="reta">Andriy Redko</reporter>
                        <labels>
                    </labels>
                <created>Mon, 11 Aug 2014 21:46:54 +0000</created>
                <updated>Mon, 16 Feb 2015 16:09:26 +0000</updated>
                            <resolved>Sun, 31 Aug 2014 22:35:00 +0000</resolved>
                                    <version>3.0.1</version>
                                    <fixVersion>3.0.2</fixVersion>
                                    <component>Integration</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14093360" author="reta" created="Mon, 11 Aug 2014 21:47:21 +0000"  >&lt;p&gt;&lt;b&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Sergey Beryozkin&amp;#93;&lt;/span&gt;&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Yeah... hmm...thanks for spotting it. I guess we need to have a new &lt;br/&gt;
method added to SearchConditionVisitor, reset(). IMHO &lt;br/&gt;
SearchConditionVisitor#getQuery() should produce the same result if &lt;br/&gt;
called multiple times, but reset() would ensure the state is cleared.&lt;/p&gt;

&lt;p&gt;And on top of it it is not thread safe, ouch. We&apos;d have to have a &lt;br/&gt;
VisitorState&amp;lt;Stack&amp;lt;List&amp;lt;Query&amp;gt;&amp;gt;&amp;gt; added to LuceneQueryVisitor, have a &lt;br/&gt;
look at SQLPrinterVisitor, it has a LocalVisitorState&amp;lt;StringBuilder&amp;gt; by &lt;br/&gt;
default, so Lucene one would have LocalVisitorState&amp;lt;Stack&amp;lt;List&amp;lt;Query&amp;gt;&amp;gt;&amp;gt; &lt;br/&gt;
by default too, a thread local visitor can be optionally injected too.&lt;/p&gt;</comment>
                            <comment id="14094074" author="sergey_beryozkin" created="Tue, 12 Aug 2014 14:06:29 +0000"  >&lt;p&gt;Hi Andriy, &lt;br/&gt;
It occurred to me a new SearchConditionVisitor.reset() method would be redundant, Lucene (and JPA) visitors should simply reset the state whenever their visit(SearchCondition) is called, do you agree ? reset() method would affect the custom SearchConditionVisitor implementations too, so IMHo we&apos;d better avoid adding it.&lt;br/&gt;
Thanks, Sergey&lt;/p&gt;</comment>
                            <comment id="14094206" author="reta" created="Tue, 12 Aug 2014 15:53:19 +0000"  >&lt;p&gt;Hi Sergey,&lt;/p&gt;

&lt;p&gt;I agree, with thread-local state we don&apos;t need reset() method as call to visit(...) effectively can clean up the state for particular thread leaving other threads unaffected.&lt;br/&gt;
Thanks.&lt;/p&gt;

&lt;p&gt;Best Regards,&lt;br/&gt;
    Andriy Redko&lt;/p&gt;</comment>
                            <comment id="14115273" author="reta" created="Fri, 29 Aug 2014 14:17:49 +0000"  >&lt;p&gt;Hi Sergey,&lt;/p&gt;

&lt;p&gt;Just pushed the fix and tests for this issue. It involved a bit more work (in order to escape &apos;reset&apos;-like method introduction) because it turned out that visit() method could be called recursively as part of complex search condition processing. Please take a look whenever you have time, I would very appreciate your feedback. &lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;Best Regards,&lt;br/&gt;
    Andriy Redko&lt;/p&gt;</comment>
                            <comment id="14115410" author="sergey_beryozkin" created="Fri, 29 Aug 2014 16:30:00 +0000"  >&lt;p&gt;Hi Andriy&lt;/p&gt;

&lt;p&gt;Thanks for starting working on it. &lt;br/&gt;
Why does the visitor has 2 thread local states, this is something I do not understand, can you please clarify ?&lt;/p&gt;

&lt;p&gt;Cheers, Sergey &lt;/p&gt;</comment>
                            <comment id="14115519" author="reta" created="Fri, 29 Aug 2014 17:19:32 +0000"  >&lt;p&gt;Hi Sergey,&lt;/p&gt;

&lt;p&gt;Yes, sure, it is related to the complication mentioned in previous comment. &lt;br/&gt;
So the first thread-local variable holds the stack of the queries and by initial design it is supposed to be the only thread-related variable required. &lt;/p&gt;

&lt;p&gt;The &apos;visit&apos; method also performs cleanup (or reset) of the query stack on each call. Now, it worked fine except the non-primitive search condition case.  In the code of &apos;visit()&apos; method you can see the calls like &apos;condition.accept(this)&apos; which is basically the recursion: eventually it calls &apos;visit()&apos; method of this visitor instance again (and so forth). And because &apos;visit()&apos; cleans the query stack, it led to test failures. To solve the issue I had to find a way to distinguish if the  &apos;visit()&apos; method is called by external callee or it is nested call from the visitor itself, and that&apos;s why the second thread-local variable appeared on the picture.&lt;/p&gt;

&lt;p&gt;Another simpler solution would be to introduce the explicit &apos;reset()&apos; method to clean up query stack for current thread. &lt;br/&gt;
Thanks! &lt;/p&gt;

&lt;p&gt;Best Regards,&lt;br/&gt;
    Andriy Redko&lt;/p&gt;</comment>
                            <comment id="14115788" author="sergey_beryozkin" created="Fri, 29 Aug 2014 20:43:27 +0000"  >&lt;p&gt;Hi Andriy&lt;/p&gt;

&lt;p&gt;Sure, I still remember what happens when visit() is called from within visit() &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;br/&gt;
IMHO we still need to have a single thread local (query stack) state only. &lt;br/&gt;
How about this approach: when a given thread exits a top level visit, i.e, finishes the work, the state gets marked as &apos;closed&apos;.&lt;br/&gt;
If the same thread enters a top-level visit() again and sees a &apos;closed&apos; state it gets cleaned-up. &lt;br/&gt;
In addition to that, I agree, we actually do need to have reset() introduced, so that the client code can proactively clear the state. IMHO calling reset() would need to be optional though. The state can also periodically clean up itself to remove stale entries, but we can deal with the auto-cleanup later on...&lt;/p&gt;

&lt;p&gt;Does it sound reasonable, a single TL state + reset() ?&lt;/p&gt;

&lt;p&gt;Thanks, Sergey&lt;/p&gt;</comment>
                            <comment id="14115928" author="reta" created="Fri, 29 Aug 2014 22:04:33 +0000"  >&lt;p&gt;Hi Sergey,&lt;/p&gt;

&lt;p&gt;Not a problem! With &apos;reset()&apos; all the burden of managing top / inner calls to &apos;visit()&apos; are not necessary anymore and it needs only single thread state. Will do the change promptly! &lt;br/&gt;
I am going to update javadocs so developers should be aware about pairing reset / visit calls in case when reusable visitor instance is required. &lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;Best Regards,&lt;br/&gt;
    Andriy Redko&lt;/p&gt;</comment>
                            <comment id="14116521" author="reta" created="Sat, 30 Aug 2014 18:50:42 +0000"  >&lt;p&gt;Hi Sergey.&lt;/p&gt;

&lt;p&gt;The refactoring has been completed, the code looks much simpler now, thanks! Please let me know what do you think.&lt;br/&gt;
Thanks a bunch!&lt;/p&gt;

&lt;p&gt;Best Regards,&lt;br/&gt;
    Andriy Redko&lt;/p&gt;</comment>
                            <comment id="14116818" author="sergey_beryozkin" created="Sun, 31 Aug 2014 16:53:45 +0000"  >&lt;p&gt;Hi Andriy&lt;/p&gt;

&lt;p&gt;Very nice, thanks, yea, looks much simpler. &lt;br/&gt;
Thanks, Sergey&lt;/p&gt;</comment>
                            <comment id="14117467" author="sergey_beryozkin" created="Mon, 1 Sep 2014 14:58:57 +0000"  >&lt;p&gt;Hi Andriy, &lt;br/&gt;
FYI, I had to do a minor update to Lucene visitor as I was getting NPE in JAXRSClientServerTikaTest, I just pushed down the state initialization down to visit(). &lt;br/&gt;
I&apos;d also like to build upon your earlier idea where you had two TL states and basically combine it into one and have a closed/open state maintained, so that if the the same thread finds a closed state it could safely reset it and as such it would be optional for users to call reset(). It&apos;s a low level priority for me though, it all looks fine IMHO&lt;br/&gt;
Thanks, Sergey&lt;/p&gt;</comment>
                            <comment id="14117616" author="reta" created="Mon, 1 Sep 2014 18:21:04 +0000"  >&lt;p&gt;Hi Sergey,&lt;/p&gt;

&lt;p&gt;My bad, should have caught the NPE myself, thanks for backing me up &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;br/&gt;
I have closed the JIRA after your previous comment, would you like me to reopen it or just create another JIRA to make reset() usage optional?&lt;br/&gt;
Thanks a lot!&lt;/p&gt;

&lt;p&gt;Best Regards,&lt;br/&gt;
    Andriy Redko&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411379</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 12 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1yrvz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411370</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>