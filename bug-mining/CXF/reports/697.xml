<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:43:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-3068] MimeBodyPartInputStream illegally returns &quot;0&quot; from a read call with chunked InputStream</title>
                <link>https://issues.apache.org/jira/browse/CXF-3068</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;I&apos;m having a problem with some MTOM attachments. It started when I upgraded from CXF 2.2.2 to CXF 2.2.3. The bug is that after calling a service which returned an MTOM attachment, when I try to parse the attachment, I sometimes get an error:&lt;/p&gt;

&lt;p&gt;java.io.IOException: Underlying input stream returned zero bytes&lt;br/&gt;
	at sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:268)&lt;br/&gt;
	at sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:306)&lt;br/&gt;
	at sun.nio.cs.StreamDecoder.READ(StreamDecoder.java:158)&lt;br/&gt;
	at java.io.InputStreamReader.READ(InputStreamReader.java:167)&lt;br/&gt;
	at java.io.Reader.READ(Reader.java:123)&lt;br/&gt;
	at org.apache.commons.io.IOUtils.copyLarge(IOUtils.java:1128)&lt;br/&gt;
	at org.apache.commons.io.IOUtils.copy(IOUtils.java:1104)&lt;br/&gt;
	at org.apache.commons.io.IOUtils.copy(IOUtils.java:1050)&lt;br/&gt;
	at org.apache.commons.io.IOUtils.toString(IOUtils.java:359)&lt;br/&gt;
	at com.pragmatics.AsyncUtils.messageToString(AsyncUtils.java:18)&lt;/p&gt;

&lt;p&gt;The error only happens for some attachments - about 25% of them. It&apos;s a seemingly arbitrary 25% - it&apos;s not like, the biggest 25% or the ones that have special characters. I was able to track this down to MimeBodyPartInputStream. MimeBodypartInputStream has some logic in processBuffer for reading the boundary. It goes like this:&lt;/p&gt;

&lt;p&gt;while ((boundaryIndex &amp;lt; boundary.length) &amp;amp;&amp;amp; (value == boundary&lt;span class=&quot;error&quot;&gt;&amp;#91;boundaryIndex&amp;#93;&lt;/span&gt;)) {  if (!hasData(buffer, initialI, i + 1, off, len)) &lt;/p&gt;
{
  return initialI - off;
 }
&lt;p&gt; value = buffer&lt;span class=&quot;error&quot;&gt;&amp;#91;++i&amp;#93;&lt;/span&gt;;&lt;br/&gt;
 boundaryIndex++;&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;So, basically, when MimeBodyPartInputStream finds the start of a boundary, it reads from the stream until either there&apos;s no more characters to read, or until it read the entire boundary. The problem with this logic is that it assumes the entire boundary will be read in the same call to the underlying InputStream. This assumption isn&apos;t always true. Specifically, when I&apos;m fetching an attachment in my application, this MimeBodyPartInputStream is backed by an HttpURLConnection.HttpInputStream. This HttpInputStream sometimes fetches as few as 24 characters, I guess that&apos;s just how the HttpInputStream works. But if these 24 characters happen to fall on one of these MIME boundaries, it can cause problems.&lt;/p&gt;

&lt;p&gt;One problem, which I&apos;m running into here, is that the MimeBodyPartInputStream&apos;s read(byte,int,int) method returns 0, since the only bytes that were read were parts of the MIME boundary. In returning 0, it breaks InputStream&apos;s contract which says states that the read method will only ever return a positive integer (if some bytes were read) or -1 (if no bytes were read.) There are probably other possible problems - it seems like it&apos;s possible MimeBodyPartInputStream might misunderstand whether or not it&apos;s hit a boundary in some cases. I haven&apos;t run into that problem though.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows&lt;/p&gt;</environment>
        <key id="12477477">CXF-3068</key>
            <summary>MimeBodyPartInputStream illegally returns &quot;0&quot; from a read call with chunked InputStream</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dkulp">Daniel Kulp</assignee>
                                    <reporter username="piepera">aaron pieper</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Oct 2010 14:56:57 +0000</created>
                <updated>Mon, 6 Dec 2010 22:48:57 +0000</updated>
                            <resolved>Fri, 15 Oct 2010 18:55:56 +0000</resolved>
                                    <version>2.2.3</version>
                    <version>2.2.4</version>
                    <version>2.2.5</version>
                    <version>2.2.6</version>
                    <version>2.2.7</version>
                    <version>2.2.8</version>
                    <version>2.2.9</version>
                    <version>2.2.10</version>
                                    <fixVersion>2.2.12</fixVersion>
                    <fixVersion>2.3.1</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12921397" author="piepera" created="Fri, 15 Oct 2010 15:05:45 +0000"  >&lt;p&gt;This unit test uses a custom InputStream which only ever returns 2 bytes, regardless of how many are asked for. It demonstrates that MimeBodyInputStream is returning 0 where it should return -1.&lt;/p&gt;

&lt;p&gt;I&apos;m not confident in the assertions in this test, but I&apos;m at least confident that it shouldn&apos;t return 0 like it is doing now.&lt;/p&gt;</comment>
                            <comment id="12921402" author="piepera" created="Fri, 15 Oct 2010 15:15:34 +0000"  >&lt;p&gt;This is a patch which works around the immediate problem by returning &quot;-1&quot; instead of &quot;0&quot; for the edge case where MimeBodyPartInputStream reads a fragment of a MIME boundary. This is a &quot;band-aid&quot; and will not fix any of the underlying problems. MimeBodyPartInputStream&apos;s underlying &quot;boundary-reading logic&quot; is the real culprit, and this patch will probably just cause other other bugs until that underlying logic is fixed.&lt;/p&gt;

&lt;p&gt;I&apos;m not recommending this patch be applied to the CXF baseline, but if anyone wants a quick work-around, this patch might work for you.&lt;/p&gt;</comment>
                            <comment id="12923618" author="piepera" created="Thu, 21 Oct 2010 20:35:13 +0000"  >&lt;p&gt;Thanks Daniel - this fix works great!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12457262" name="MimeBodyPartInputStreamTest.java" size="1022" author="piepera" created="Fri, 15 Oct 2010 15:05:45 +0000"/>
                            <attachment id="12457264" name="cxf-3068-kludge-patch.txt" size="517" author="piepera" created="Fri, 15 Oct 2010 15:15:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10062"><![CDATA[Moderate]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47135</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 5 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0kl87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>118256</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>