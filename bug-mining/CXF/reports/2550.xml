<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:15:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-6395] Call setTimeout() in a second request cause illegalStateException from web container.</title>
                <link>https://issues.apache.org/jira/browse/CXF-6395</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Come from a TCK test case:&lt;br/&gt;
Resource class has two methods:&lt;br/&gt;
static AsyncResponse asyncResponse;&lt;br/&gt;
    @GET&lt;br/&gt;
    @Path(&quot;/suspend&quot;)&lt;br/&gt;
    public void getSuspendResponse(@Suspended AsyncResponse async) &lt;/p&gt;
{
        asyncResponse = async;
    }

&lt;p&gt;    @GET&lt;br/&gt;
    @Path(&quot;/setTimeOut&quot;)&lt;br/&gt;
    public String setTimeOut() &lt;/p&gt;
{
        boolean setTimeout = asyncResponse.setTimeout(10, TimeUnit.SECONDS);
        return String.valueOf(setTimeout)
    }

&lt;p&gt;The first request invokes method getSuspendResponse(), the AsyncResponse is in suspend status. The second request invokes method setTimeOut() to invoke setTimeOut() method of the suspend AsyncRespone. AsyncResponseImp.setTimeout() -&amp;gt; cont.suspend(timeout)(Servlet3ContinuationProvider$Servlet3Continuation) -&amp;gt; context.setTimeout(timeout);&lt;br/&gt;
The the impl class of AsyncContext throw a illegalStateException: called setTimeout after the container-initiated dispatch which called startAsync has returned.&lt;br/&gt;
According to the javadoc of AsyncContext class, seemed the behavior of AsyncContext is correct. We tried to challenge this test case, but was rejected.&lt;/p&gt;

&lt;p&gt;Checked restesay code, found they thought the invocation is illegal, but they provide a work around:&lt;/p&gt;

&lt;p&gt;    protected WeakReference&amp;lt;Thread&amp;gt; creatingThread = new WeakReference&amp;lt;Thread&amp;gt;(Thread.currentThread());&lt;br/&gt;
    protected ScheduledFuture timeoutFuture; // this is to get around TCK tests that call setTimeout in a separate thread which is illegal.&lt;br/&gt;
    protected ScheduledExecutorService asyncScheduler;&lt;/p&gt;

&lt;p&gt;public synchronized boolean setTimeout(long time, TimeUnit unit) throws IllegalStateException {&lt;br/&gt;
......&lt;br/&gt;
        Thread thread = creatingThread.get();&lt;br/&gt;
        if (thread != null &amp;amp;&amp;amp; thread != Thread.currentThread()) {&lt;br/&gt;
            // this is to get around TCK tests that call setTimeout in a separate thread which is illegal.&lt;br/&gt;
            if (timeoutFuture != null &amp;amp;&amp;amp; !timeoutFuture.cancel(false)) &lt;/p&gt;
{
                return false;
            }
&lt;p&gt;            Runnable task = new Runnable() {&lt;br/&gt;
                @Override&lt;br/&gt;
                public void run()&lt;/p&gt;
                {
                    handleTimeout();
                }
&lt;p&gt;            };&lt;br/&gt;
            timeoutFuture = asyncScheduler.schedule(task, time, unit);&lt;br/&gt;
            return true;&lt;br/&gt;
        } else &lt;/p&gt;
{
        ......
        }
&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;Check if current thread is the creating thread of AsyncResponseImpl object, if not, means setTimeout() method is called in a second request, then handle the timeout with a ScheduledExecutorService instead of AsyncContext to avoid the illegalState exception. &lt;/p&gt;

&lt;p&gt;I tried to add above code to setTimeout() method. It&apos;s ok when setTimeout() was called, and handleTimeout() method was called also when timeout. But client can&apos;t get a response which said timeout until connection timeout.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12827910">CXF-6395</key>
            <summary>Call setTimeout() in a second request cause illegalStateException from web container.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sergey_beryozkin">Sergey Beryozkin</assignee>
                                    <reporter username="weiz">Wei Zheng</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 May 2015 03:02:42 +0000</created>
                <updated>Fri, 14 Oct 2016 14:25:21 +0000</updated>
                            <resolved>Fri, 8 May 2015 09:43:42 +0000</resolved>
                                                    <fixVersion>3.1.1</fixVersion>
                    <fixVersion>3.0.6</fixVersion>
                                    <component>JAX-RS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14532328" author="sergey_beryozkin" created="Thu, 7 May 2015 09:32:38 +0000"  >&lt;p&gt;I&apos;m not convinced it is a CXF bug. &lt;br/&gt;
Regarding this comment in the RestEasy code:&lt;br/&gt;
// this is to get around TCK tests that call setTimeout in a separate thread which is illegal.&lt;br/&gt;
So obviously that works for RI (Jersey) if it has this test passing ?&lt;/p&gt;

&lt;p&gt;Can you let me know please if this test works with Tomcat 7 or Tomcat 8 for you ?&lt;/p&gt;

&lt;p&gt;Also note that AsyncContext is reset in Servlet3Continuation if it is not new - hence the internal context state is expected to be reset too.&lt;/p&gt;

&lt;p&gt;I think this is a won&apos;t fix issue.&lt;/p&gt;

&lt;p&gt;Thanks, Sergey&lt;/p&gt;</comment>
                            <comment id="14532783" author="weiz" created="Thu, 7 May 2015 14:41:37 +0000"  >&lt;p&gt;The test can&apos;t work on tomcat 8, but jersey+tomcat 8 can work.&lt;/p&gt;</comment>
                            <comment id="14532896" author="sergey_beryozkin" created="Thu, 7 May 2015 15:47:56 +0000"  >&lt;p&gt;Hmm... I can&apos;t have this test passing with Jetty too... I have an existing test where TimeoutHandler sets another timeout but that I guess is the same thread in action...&lt;/p&gt;</comment>
                            <comment id="14533935" author="weiz" created="Fri, 8 May 2015 06:04:07 +0000"  >&lt;p&gt;Debugged the TimeoutHandler test today, it&apos;s not same thread. I think the key point of the problem is not separate thread, but separate request.&lt;/p&gt;</comment>
                            <comment id="14534112" author="sergey_beryozkin" created="Fri, 8 May 2015 08:38:14 +0000"  >&lt;p&gt;I guess the key difference with the TimeoutHandler is that it sets a timeout on the auto-resumed continuation, in this test we have a timeout called on the pending continuation. The proper lower-level solution is to resume the continuation internally and set a new timeout on it and suspend again as opposed to doing a workaround, will experiment with it... &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10063"><![CDATA[Advanced]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 28 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2eekf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>