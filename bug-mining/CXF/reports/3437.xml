<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:34:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-8077] WSS4JInInterceptor is not thread safe</title>
                <link>https://issues.apache.org/jira/browse/CXF-8077</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;org.apache.cxf.ws.security.wss4j.WSS4JInInterceptor uses a cached property&#160;WSSecurityEngine secEngineOverride.&#160; In the situation that the same instance of&#160;secEngineOverride is used for 2 or more threads,&#160; Following code in&#160;handleMessageInternal() will cause WSS4J to lookup wrong XML document.&lt;/p&gt;

&lt;p&gt;if (soapBody != null) &lt;/p&gt;
{
 engine.setCallbackLookup(new CXFCallbackLookup(soapBody.getOwnerDocument(), soapBody));
 }

&lt;p&gt;In my case, interceptor is used to do X.509 authentication with&#160;Signature for signing. When 2 or more requests comes at the almost the same time, it produces following error for victim thread(s).&lt;/p&gt;

&lt;p&gt;org.apache.cxf.binding.soap.SoapFault: A security error was encountered when verifying the message&lt;br/&gt;
 at org.apache.cxf.ws.security.wss4j.WSS4JUtils.createSoapFault(WSS4JUtils.java:234)&lt;br/&gt;
 at org.apache.cxf.ws.security.wss4j.WSS4JInInterceptor.handleMessageInternal(WSS4JInInterceptor.java:376)&lt;br/&gt;
 at org.apache.cxf.ws.security.wss4j.WSS4JInInterceptor.handleMessage(WSS4JInInterceptor.java:212)&lt;br/&gt;
 at org.apache.cxf.ws.security.wss4j.WSS4JInInterceptor.handleMessage(WSS4JInInterceptor.java:92)&lt;br/&gt;
 at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:308)&lt;br/&gt;
 at org.apache.cxf.transport.ChainInitiationObserver.onMessage(ChainInitiationObserver.java:121)&lt;br/&gt;
 at org.apache.cxf.transport.http.AbstractHTTPDestination.invoke(AbstractHTTPDestination.java:267)&lt;br/&gt;
 at org.apache.cxf.transport.servlet.ServletController.invokeDestination(ServletController.java:234)&lt;br/&gt;
 at org.apache.cxf.transport.servlet.ServletController.invoke(ServletController.java:208)&lt;br/&gt;
 at org.apache.cxf.transport.servlet.ServletController.invoke(ServletController.java:160)&lt;br/&gt;
 at org.apache.cxf.transport.servlet.CXFNonSpringServlet.invoke(CXFNonSpringServlet.java:216)&lt;br/&gt;
 at org.apache.cxf.transport.servlet.AbstractHTTPServlet.handleRequest(AbstractHTTPServlet.java:301)&lt;br/&gt;
 at org.apache.cxf.transport.servlet.AbstractHTTPServlet.doPost(AbstractHTTPServlet.java:220)&lt;br/&gt;
 at javax.servlet.http.HttpServlet.service(HttpServlet.java:660)&lt;br/&gt;
 at org.apache.cxf.transport.servlet.AbstractHTTPServlet.service(AbstractHTTPServlet.java:276)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:231)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)&lt;br/&gt;
 at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:53)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)&lt;br/&gt;
 at org.springframework.boot.actuate.web.trace.servlet.HttpTraceFilter.doFilterInternal(HttpTraceFilter.java:88)&lt;br/&gt;
 at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:109)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)&lt;br/&gt;
 at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:209)&lt;br/&gt;
 at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:178)&lt;br/&gt;
 at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:357)&lt;br/&gt;
 at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:270)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)&lt;br/&gt;
 at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:99)&lt;br/&gt;
 at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:109)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)&lt;br/&gt;
 at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:92)&lt;br/&gt;
 at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:109)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)&lt;br/&gt;
 at org.springframework.web.filter.HiddenHttpMethodFilter.doFilterInternal(HiddenHttpMethodFilter.java:93)&lt;br/&gt;
 at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:109)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)&lt;br/&gt;
 at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.filterAndRecordMetrics(WebMvcMetricsFilter.java:114)&lt;br/&gt;
 at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.doFilterInternal(WebMvcMetricsFilter.java:104)&lt;br/&gt;
 at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:109)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)&lt;br/&gt;
 at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:200)&lt;br/&gt;
 at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:109)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)&lt;br/&gt;
 at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)&lt;br/&gt;
 at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:202)&lt;br/&gt;
 at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:96)&lt;br/&gt;
 at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:490)&lt;br/&gt;
 at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:139)&lt;br/&gt;
 at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:92)&lt;br/&gt;
 at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)&lt;br/&gt;
 at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:343)&lt;br/&gt;
 at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:408)&lt;br/&gt;
 at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66)&lt;br/&gt;
 at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:853)&lt;br/&gt;
 at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1587)&lt;br/&gt;
 at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)&lt;br/&gt;
 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)&lt;br/&gt;
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)&lt;br/&gt;
 at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)&lt;br/&gt;
 at java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
Caused by: org.apache.wss4j.common.ext.WSSecurityException: javax.xml.crypto.URIReferenceException: org.apache.xml.security.utils.resolver.ResourceResolverException: Cannot resolve element with ID id-e41ca583-c6f1-40d5-8acc-f3968287b0cb&lt;br/&gt;
 at org.apache.wss4j.dom.processor.SignatureProcessor.verifyXMLSignature(SignatureProcessor.java:399)&lt;br/&gt;
 at org.apache.wss4j.dom.processor.SignatureProcessor.handleToken(SignatureProcessor.java:232)&lt;br/&gt;
 at org.apache.wss4j.dom.engine.WSSecurityEngine.processSecurityHeader(WSSecurityEngine.java:340)&lt;br/&gt;
 at org.apache.cxf.ws.security.wss4j.WSS4JInInterceptor.handleMessageInternal(WSS4JInInterceptor.java:320)&lt;br/&gt;
 ... 65 common frames omitted&lt;br/&gt;
Caused by: javax.xml.crypto.dsig.XMLSignatureException: javax.xml.crypto.URIReferenceException: org.apache.xml.security.utils.resolver.ResourceResolverException: Cannot resolve element with ID id-e41ca583-c6f1-40d5-8acc-f3968287b0cb&lt;br/&gt;
 at org.apache.jcp.xml.dsig.internal.dom.DOMReference.dereference(DOMReference.java:418)&lt;br/&gt;
 at org.apache.jcp.xml.dsig.internal.dom.DOMReference.validate(DOMReference.java:382)&lt;br/&gt;
 at org.apache.jcp.xml.dsig.internal.dom.DOMXMLSignature.validate(DOMXMLSignature.java:277)&lt;br/&gt;
 at org.apache.wss4j.dom.processor.SignatureProcessor.verifyXMLSignature(SignatureProcessor.java:372)&lt;br/&gt;
 ... 68 common frames omitted&lt;br/&gt;
Caused by: javax.xml.crypto.URIReferenceException: org.apache.xml.security.utils.resolver.ResourceResolverException: Cannot resolve element with ID id-e41ca583-c6f1-40d5-8acc-f3968287b0cb&lt;br/&gt;
 at org.apache.jcp.xml.dsig.internal.dom.DOMURIDereferencer.dereference(DOMURIDereferencer.java:117)&lt;br/&gt;
 at org.apache.jcp.xml.dsig.internal.dom.DOMReference.dereference(DOMReference.java:414)&lt;br/&gt;
 ... 71 common frames omitted&lt;br/&gt;
Caused by: org.apache.xml.security.utils.resolver.ResourceResolverException: Cannot resolve element with ID id-e41ca583-c6f1-40d5-8acc-f3968287b0cb&lt;br/&gt;
 at org.apache.xml.security.utils.resolver.implementations.ResolverFragment.engineResolveURI(ResolverFragment.java:78)&lt;br/&gt;
 at org.apache.xml.security.utils.resolver.ResourceResolver.resolve(ResourceResolver.java:278)&lt;br/&gt;
 at org.apache.jcp.xml.dsig.internal.dom.DOMURIDereferencer.dereference(DOMURIDereferencer.java:110)&lt;br/&gt;
 ... 72 common frames omitted&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I ended up to override&#160;protected WSSecurityEngine getSecurityEngine(boolean utWithCallbacks)&#160; to create&#160;WSSecurityEngine everything to avoid the issue.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It can be fixed using antonymous inner class to replace previous code as following as&#160;a concept.&#160; Please note that calling&#160;new CXFCallbackLookup(soapBody.getOwnerDocument(), soapBody) in each interface method might not be most efficient.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;final Element soapBody = SAAJUtils.getBody(doc);&lt;br/&gt;
 if (soapBody != null) {&lt;br/&gt;
 engine.setCallbackLookup(new CallbackLookup() {&lt;br/&gt;
 @Override&lt;br/&gt;
 public Element getElement(String s, String s1, boolean b) throws WSSecurityException &lt;/p&gt;
{
 return new CXFCallbackLookup(soapBody.getOwnerDocument(), soapBody).getElement(s, s1, b);
 }

&lt;p&gt;@Override&lt;br/&gt;
 public Element getAndRegisterElement(String s, String s1, boolean b, DOMCryptoContext domCryptoContext) throws WSSecurityException &lt;/p&gt;
{
 return new CXFCallbackLookup(soapBody.getOwnerDocument(), soapBody).getAndRegisterElement(s, s1, b, domCryptoContext);
 }

&lt;p&gt;@Override&lt;br/&gt;
 public List&amp;lt;Element&amp;gt; getElements(String s, String s1) throws WSSecurityException &lt;/p&gt;
{
 return new CXFCallbackLookup(soapBody.getOwnerDocument(), soapBody).getElements(s, s1);
 }

&lt;p&gt;@Override&lt;br/&gt;
 public Element getSOAPBody() &lt;/p&gt;
{
 return new CXFCallbackLookup(soapBody.getOwnerDocument(), soapBody).getSOAPBody();
 }
&lt;p&gt; });&lt;br/&gt;
 }&lt;/p&gt;</description>
                <environment></environment>
        <key id="13245843">CXF-8077</key>
            <summary>WSS4JInInterceptor is not thread safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="coheigea">Colm O hEigeartaigh</assignee>
                                    <reporter username="shuminli">Shumin Li</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Jul 2019 17:48:36 +0000</created>
                <updated>Wed, 14 Aug 2019 13:29:57 +0000</updated>
                            <resolved>Fri, 19 Jul 2019 13:45:47 +0000</resolved>
                                    <version>3.3.2</version>
                                    <fixVersion>3.1.18</fixVersion>
                    <fixVersion>3.2.10</fixVersion>
                    <fixVersion>3.3.3</fixVersion>
                                    <component>WS-* Components</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="16888874" author="coheigea" created="Fri, 19 Jul 2019 13:45:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shuminli&quot; class=&quot;user-hover&quot; rel=&quot;shuminli&quot;&gt;shuminli&lt;/a&gt; - If you could confirm the issue is fixed with the latest code / snapshots, that&apos;d be great.&lt;/p&gt;</comment>
                            <comment id="16889878" author="shuminli" created="Mon, 22 Jul 2019 02:41:53 +0000"  >&lt;p&gt;Yes, the SNAPSHOT is working now.&#160; I see you are creating WSSecurityEngine instance each time instead of using cached.&#160; Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 17 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z04tb4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>