<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:22:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-7122] Infinite loop due to AsyncHTTPConduit read timeout with exhausted connection pool</title>
                <link>https://issues.apache.org/jira/browse/CXF-7122</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Using AsyncHTTPConduit, when the underlying connection pool gets exhausted, requests waiting for a connection will lead to an infinite loop if they reach receive timeout.&lt;/p&gt;

&lt;p&gt;The problem occured on all versions of CXF above 3.0.5 (we did not tested other ones). &lt;/p&gt;

&lt;p&gt;Let&apos;s imagine a backend that&apos;s broken and leads to timeout for all requests.&lt;/p&gt;

&lt;p&gt;When handling requests, the cxf worker thread will eventually go in wait state (AsyncHTTPConduit:618), with a timeout that matches the HTTPClientPolicy.setReceiveTimeout() value, waiting for the NIO stack to complete and call notifyAll via responseCallback (AsyncHTTPConduit:455). &lt;br/&gt;
The timeout on the wait is the big problem :&lt;br/&gt;
With our broken backend, the connection pool is exhausted waiting for other requests to timeout. When a new request is made by cxf against this backend, after timeout time this will happen :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;on the one side the reactor threads will get a connection from the pool and try to write to the output stream. Waiting in the pool is not considered as receive timeout.&lt;/li&gt;
	&lt;li&gt;on the other side the cxf worker thread will wake up (because of the timedout wait), and shutdown SharedOutputBuffer and SharedInputBuffer (AsyncHTTPClient:624)&lt;/li&gt;
	&lt;li&gt;reactor threads will go to infinite loop because they will try to produceContent from a shutdown buffer (SharedOutputBuffer:120)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; From there, application recovery is compromised.&lt;/p&gt;

&lt;p&gt; To fix that, timeout should be handled only via the client callback (AsyncHTTPConduit:463).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13017284">CXF-7122</key>
            <summary>Infinite loop due to AsyncHTTPConduit read timeout with exhausted connection pool</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ffang">Freeman Yue Fang</assignee>
                                    <reporter username="willymontaz">William Montaz</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Nov 2016 15:34:44 +0000</created>
                <updated>Sun, 28 Jan 2018 14:21:53 +0000</updated>
                            <resolved>Thu, 10 Nov 2016 02:04:15 +0000</resolved>
                                                    <fixVersion>3.1.9</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                                    <component>Transports</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15629320" author="githubbot" created="Wed, 2 Nov 2016 15:35:13 +0000"  >&lt;p&gt;GitHub user Willymontaz opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cxf/pull/190&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/190&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Fix AsyncHTTPConduit read timeout with exhausted connection pool&lt;/p&gt;

&lt;p&gt;    Fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7122&quot; title=&quot;Infinite loop due to AsyncHTTPConduit read timeout with exhausted connection pool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7122&quot;&gt;&lt;del&gt;CXF-7122&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/Willymontaz/cxf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Willymontaz/cxf&lt;/a&gt; fix-AsyncHTTPConduit-timeout&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cxf/pull/190.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/190.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #190&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit a857349e851ee1aee9fa053e033473d5dae31e3c&lt;br/&gt;
Author: William Montaz &amp;lt;wmontaz@voyages-sncf.com&amp;gt;&lt;br/&gt;
Date:   2016-11-02T14:46:54Z&lt;/p&gt;

&lt;p&gt;    Fix read timeout when underlying Connection Pool cannot provide a connection right away&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15629321" author="willymontaz" created="Wed, 2 Nov 2016 15:35:38 +0000"  >&lt;p&gt;I propose a pull request &lt;a href=&quot;https://github.com/apache/cxf/pull/190&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/190&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15633329" author="githubbot" created="Thu, 3 Nov 2016 16:25:24 +0000"  >&lt;p&gt;Github user Willymontaz closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cxf/pull/190&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/190&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15633335" author="githubbot" created="Thu, 3 Nov 2016 16:25:52 +0000"  >&lt;p&gt;GitHub user Willymontaz reopened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cxf/pull/190&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/190&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Fix AsyncHTTPConduit read timeout with exhausted connection pool&lt;/p&gt;

&lt;p&gt;    Fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7122&quot; title=&quot;Infinite loop due to AsyncHTTPConduit read timeout with exhausted connection pool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7122&quot;&gt;&lt;del&gt;CXF-7122&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/Willymontaz/cxf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Willymontaz/cxf&lt;/a&gt; fix-AsyncHTTPConduit-timeout&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cxf/pull/190.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/190.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #190&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit a857349e851ee1aee9fa053e033473d5dae31e3c&lt;br/&gt;
Author: William Montaz &amp;lt;wmontaz@voyages-sncf.com&amp;gt;&lt;br/&gt;
Date:   2016-11-02T14:46:54Z&lt;/p&gt;

&lt;p&gt;    Fix read timeout when underlying Connection Pool cannot provide a connection right away&lt;/p&gt;

&lt;p&gt;commit db55b103124617476fe817b1e398142eb7ee43a6&lt;br/&gt;
Author: William Montaz &amp;lt;wmontaz@voyages-sncf.com&amp;gt;&lt;br/&gt;
Date:   2016-11-02T17:03:14Z&lt;/p&gt;

&lt;p&gt;    Fix code formatting&lt;/p&gt;

&lt;p&gt;commit 1c34659984b1c3a64463471166a4c772597c0ac8&lt;br/&gt;
Author: William Montaz &amp;lt;wmontaz@voyages-sncf.com&amp;gt;&lt;br/&gt;
Date:   2016-11-03T14:03:52Z&lt;/p&gt;

&lt;p&gt;    Fix timeout handling by non async requests&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15635387" author="ffang" created="Fri, 4 Nov 2016 06:09:35 +0000"  >&lt;p&gt;Hi  William,&lt;/p&gt;

&lt;p&gt;Thanks for the patch, however it can&apos;t resolve the problem you describe.&lt;br/&gt;
For the sync, your final patch didn&apos;t change anything, it still wait the receivedtimeout and shutdown the SharedOutputBuffer. &lt;br/&gt;
For the async, when the code run into getHttpResponse method, this means the client can hold a connection and send out request and the response is back already, so wait there doesn&apos;t make sense.&lt;/p&gt;

&lt;p&gt;What we need to do is that tell the ahc IOReactor don&apos;t repeat the message write process when the SharedOutputBuffer is shutdown due to timeout for both sync and async, we can do it in SharedOutputBuffer, using encoder.complete(); when SharedOutputBuffer is shutdown.&lt;/p&gt;

&lt;p&gt;I will commit soon&lt;/p&gt;

&lt;p&gt;Best Regards&lt;br/&gt;
Freeman&lt;/p&gt;
</comment>
                            <comment id="15635496" author="willymontaz" created="Fri, 4 Nov 2016 07:05:26 +0000"  >&lt;p&gt;Hi Fang,&lt;/p&gt;

&lt;p&gt;thank you for your answer. I disagree on several points :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for the sync, we had no problem, so no need to remove the wait(scPolicy.getReceiveTimeout()). I had to actually put it back because that was breaking the syncTimeout test.&lt;/li&gt;
	&lt;li&gt;for the async, the old code was doing the wait anyway, so the race condition you describe already applies on all previous versions of CXF ? Your analysis seems wrong -&amp;gt; if HttpResponse is given back by the callback, then when the thread enters getHttpResponse, it will found that httpResponse is not null (line 619) and thus will never wait. If httpresponse is null, it will wait. Since both setHttpResponse and getHttpresponse are synchronized, we have correct happens-before relationship. Correct behavior here.&lt;/li&gt;
	&lt;li&gt;the solution you describe does not help with the fact that a thread will timeout even if no real tcp traffic occurs. it can be a pain to debug such a behavior, seing SocketReadTimeoutException in the log without any outgoing request.&lt;/li&gt;
	&lt;li&gt;with the solution you describe, The IOReactor thread can still try to write some stuff in the socket, like headers (that&#8217;s actually what happened when we discovered the problem), and then is told not to do anything more. This is because there is a competition between thread shutting down the buffer and writing to the socket from the buffer. Such a behavior can lead to real troubles since the server will get an incomplete HttpRequest.&lt;br/&gt;
Finally, the solution I provide has been tested on our preproduction platform.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Could you dig further ?&lt;/p&gt;

&lt;p&gt;Thank you&lt;/p&gt;</comment>
                            <comment id="15635539" author="ffang" created="Fri, 4 Nov 2016 07:30:09 +0000"  >&lt;p&gt;Hi  William,&lt;/p&gt;

&lt;p&gt;To demonstrate your patch doesn&apos;t work, please take a look at the AsyncHTTPConduitTest.java I just appended(that use 1 connection intended to mimic the connection ran out situation).&lt;/p&gt;

&lt;p&gt;You can check out the latest CXF master code, revert my last commit, apply your patch, override the AsyncHTTPConduitTest.java I appended here, than run the test with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;mvn clean install -Dtest=AsyncHTTPConduitTest#testTimeoutAsync
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You can debug and see with the 30 secs this test duration, the Infinite loop call into SharedOutputBuffer.produceContent still there&lt;br/&gt;
Or you can add a print log in SharedOutputBuffer.produceContent&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.shutdown) {
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;the SharedOutputBuffer is shutdown&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; -1;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to see the Infinite loop is there more clearly.&lt;/p&gt;

&lt;p&gt;Hope this can clarify&lt;br/&gt;
Freeman&lt;/p&gt;</comment>
                            <comment id="15635570" author="willymontaz" created="Fri, 4 Nov 2016 07:46:02 +0000"  >&lt;p&gt;Thank you, I will be able to test that in a few hours. Beside the fact that my approach to this problem might not be the good one did you take in account my other remarks (ReadTimeoutException even if nothing is written on the socket, partial request written on the socket, etc...) ,&lt;/p&gt;</comment>
                            <comment id="15636082" author="sergey_beryozkin" created="Fri, 4 Nov 2016 11:26:14 +0000"  >&lt;p&gt;Hi William, do you think your patch can help with  ReadTimeoutException/partial writes in addition to the fix provided by Freeman or a new patch may be needed ? thanks &lt;/p&gt;</comment>
                            <comment id="15637147" author="willymontaz" created="Fri, 4 Nov 2016 17:52:14 +0000"  >&lt;p&gt;Hi Sergey, just to give you a little feedback. Since Freeman gave me another test case, I could reproduce the infinite loop on his test case and discovered that Freeman patch still leads to problems and my patch is not sufficient at the moment. The description might be quite long and I have to try a solution against different tests cases that I can access only from office. I will give you more feedback monday. &lt;/p&gt;

&lt;p&gt;Regards&lt;/p&gt;</comment>
                            <comment id="15643233" author="ffang" created="Mon, 7 Nov 2016 06:07:25 +0000"  >&lt;p&gt;Hi William,&lt;/p&gt;

&lt;p&gt;FYI, with your original patch, with the AsyncHTTPConduitTest I appended, you can run into infinite loop also with &lt;br/&gt;
AsyncHTTPConduitTest#testTimeout, so both the sync and async way has the infinite loop issue. If you will re-work a solution, please also consider this.&lt;/p&gt;

&lt;p&gt;Btw, the SocketTimeoutException name may not be appropriate for all case, we can reconsider to use more accurate exception name like RecieveTimeoutException after the real issue get resolved.&lt;/p&gt;

&lt;p&gt;And if you wanna more help from community to resolve the issue you ran into, a reproducer test case definitely would be more helpful.&lt;/p&gt;

&lt;p&gt;Thanks &lt;br/&gt;
Freeman&lt;/p&gt;</comment>
                            <comment id="15643744" author="willymontaz" created="Mon, 7 Nov 2016 10:20:36 +0000"  >&lt;p&gt;Hi Freeman, Sergey,&lt;/p&gt;

&lt;p&gt;The test you provide is a good one. But running it I saw something weird -&amp;gt; even when timeouting, the requests where made against the server and that led me to the reason why the patch I propose was not working on 3.1.xxx or 3.2-SNAPSHOT&lt;/p&gt;

&lt;p&gt;Actually, I first tested my patch on version 3.0.5 of CXF and when backporting to 3.1.x I did not realised a little thing changed in the AsyncHTTPConduit. As you can notice, on version 3.0.5 &lt;a href=&quot;https://github.com/apache/cxf/blob/cxf-3.0.5/rt/transports/http-hc/src/main/java/org/apache/cxf/transport/http/asyncclient/AsyncHTTPConduit.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/blob/cxf-3.0.5/rt/transports/http-hc/src/main/java/org/apache/cxf/transport/http/asyncclient/AsyncHTTPConduit.java&lt;/a&gt; line 220, the RequestConfig sets a SocketTimeout equals to ReceiveTimeout.&lt;/p&gt;

&lt;p&gt;Since my patch relies on using the callback to timeout, it could not work because the underlying socket was not timed out. I think it is also the reason why ReadTimeout was not used when async,&lt;/p&gt;

&lt;p&gt;I updated my merge request to add SocketTimeout.  I also notice there is a ConnectionRequestTimeout, that helps dealing whit waiting for a connection for too long when the pool is exhausted. In my merge request I propose to set it to ReceiveTimeout too, to stay close to the behavior proposed by CXF. But we could actually set a new property to distinguish both.&lt;/p&gt;

&lt;p&gt;I remove the timer task from Freeman&apos;s commit, just as a comment. You want also want to clean this code in a better way.&lt;/p&gt;

&lt;p&gt;Last thing, my project uses version 3.0.x, could we consider backporting this patch on 3.0.x ?&lt;/p&gt;

&lt;p&gt;Thanks &lt;br/&gt;
William&lt;/p&gt;
</comment>
                            <comment id="15643870" author="ffang" created="Mon, 7 Nov 2016 11:03:59 +0000"  >&lt;p&gt;Hi William,&lt;/p&gt;

&lt;p&gt;Thanks for your patch but I&apos;m still -1 for it.&lt;/p&gt;

&lt;p&gt;We can&apos;t setSocketTimeout for RequestConfig because of &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-6910&quot; title=&quot;don&amp;#39;t need setSocketTimeout when create ahc RequestConfig&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-6910&quot;&gt;&lt;del&gt;CXF-6910&lt;/del&gt;&lt;/a&gt;, and we need the TimerTask because of &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7112&quot; title=&quot;AsyncHTTPConduit ignore the ReceiveTimeout when use Async JAXWS api&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7112&quot;&gt;&lt;del&gt;CXF-7112&lt;/del&gt;&lt;/a&gt;. You can find more background there.&lt;/p&gt;

&lt;p&gt;We can&apos;t simply revert those change.&lt;br/&gt;
Could you please re-consider your patch?&lt;/p&gt;

&lt;p&gt;I&apos;m still wondering why my fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7122&quot; title=&quot;Infinite loop due to AsyncHTTPConduit read timeout with exhausted connection pool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7122&quot;&gt;&lt;del&gt;CXF-7122&lt;/del&gt;&lt;/a&gt; doesn&apos;t work for you, if you can provide a reproducer testcase I&apos;d like to take a close look.&lt;/p&gt;

&lt;p&gt;Freeman&lt;/p&gt;</comment>
                            <comment id="15644021" author="willymontaz" created="Mon, 7 Nov 2016 12:16:30 +0000"  >&lt;p&gt;Hi Freeman,&lt;/p&gt;

&lt;p&gt;use your test class, use testAsyncTimeout, debug and set a breakpoint on the getHttpresponse first line (while(httpresponse == null). You will see that even if you consider response timeout in the timer task, the request is still being sent and response is given back to the client. Ok your exception in the timer task hides it but from a client/server perspective everything happened in a nice fashion. If your client timeout, you should close the connection.&lt;/p&gt;

&lt;p&gt;Another thing that does not work, put testTimeoutAsync in this fashion&lt;/p&gt;

&lt;p&gt;    @Test&lt;br/&gt;
    public void testTimeoutAsync() throws Exception {&lt;br/&gt;
        updateAddressPort(g, PORT);&lt;br/&gt;
        HTTPConduit c = (HTTPConduit)ClientProxy.getClient(g).getConduit();&lt;br/&gt;
        c.getClient().setReceiveTimeout(3000);&lt;br/&gt;
        try {&lt;br/&gt;
            long start = System.currentTimeMillis();&lt;br/&gt;
            Response&amp;lt;GreetMeLaterResponse&amp;gt; future = g.greetMeLaterAsync(-5000L);&lt;br/&gt;
            try&lt;/p&gt;
{
                future.get();
            } catch (Exception e){
                System.out.println(&quot;First get timeout&quot;);
            }&lt;br/&gt;
            long firstGet = System.currentTimeMillis();&lt;br/&gt;
            System.out.println(&quot;First get took &quot; + (firstGet - start) + &quot; ms&quot;);&lt;br/&gt;
            Thread.sleep(1000);&lt;br/&gt;
            long startSecond = System.currentTimeMillis();&lt;br/&gt;
            future = g.greetMeLaterAsync(1000);&lt;br/&gt;
            try{                future.get();            }
&lt;p&gt; catch (Exception e)&lt;/p&gt;
{
                System.out.println(&quot;Second get timeout&quot;);
            }
&lt;p&gt;            long secondGet = System.currentTimeMillis();&lt;br/&gt;
            System.out.println(&quot;Second get took &quot; + (secondGet - startSecond) + &quot; ms&quot;);&lt;br/&gt;
            Thread.sleep(30000);&lt;br/&gt;
            future.get();&lt;br/&gt;
            fail();&lt;br/&gt;
        } catch (Exception ex) &lt;/p&gt;
{
            //expected!!!
            ex.printStackTrace();
        }
&lt;p&gt;    }&lt;/p&gt;

&lt;p&gt;We agree that second request should not timeout. The first one took 3 sec and the second one should only take 1 second, but since the connection is not really closed, it is still not available and thus request two will timeout because it is waiting for the connection still held by first request.&lt;/p&gt;</comment>
                            <comment id="15644082" author="willymontaz" created="Mon, 7 Nov 2016 12:44:51 +0000"  >&lt;p&gt;Moreover, we can use SocketTimeout because when the connection is released in the pool, the ConnectionPoolManager extends its timeout. You can clearly see it in the logs and if you want to dig further, you can debug the PoolingNHttpClientConnectionManager line 303 and then the org.apache.http.impl.nio.conn.CPool class that sets the SocketTimeout to 0 to reuse the connection line 78.&lt;/p&gt;

&lt;p&gt;Hopefully, with that, you will consider my patch.&lt;/p&gt;</comment>
                            <comment id="15644164" author="ffang" created="Mon, 7 Nov 2016 13:20:09 +0000"  >&lt;p&gt;Hi William,&lt;/p&gt;

&lt;p&gt;Your last comment is very interesting.&lt;/p&gt;

&lt;p&gt;As it&apos;s not the case when I worked on &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-6910&quot; title=&quot;don&amp;#39;t need setSocketTimeout when create ahc RequestConfig&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-6910&quot;&gt;&lt;del&gt;CXF-6910&lt;/del&gt;&lt;/a&gt;. I just checked the ahc code base with latest commit log, and found this one &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPASYNC-105&quot; title=&quot;socketTimeout is not reset back to default after a request that has specific timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPASYNC-105&quot;&gt;&lt;del&gt;HTTPASYNC-105&lt;/del&gt;&lt;/a&gt; introduce the behavior that when release the connection to pool then reset the SocketTimeout, and this is in ahc 4.1.2 released at June this year. With the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-6939&quot; title=&quot;can&amp;#39;t install cxf-http-async feature&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-6939&quot;&gt;&lt;del&gt;CXF-6939&lt;/del&gt;&lt;/a&gt; we upgrade to use 4.1.2 already so for CXF 3.1.x and 3.2 we should be able to use this new behavior from ahc(this is Good as we can use more universal way to handle the timeout!)&lt;/p&gt;

&lt;p&gt;I will do more test  to confirm this new behavior will work as expected  and looked your patch again based on this new behavior. But I&apos;m not sure with CXF 3.0.x we can upgrade to use ahc 4.1.2, and also I&apos;m wondering if you use CXF 3.0.x how you can see this new behavior from ahc 4.1.2, or you just dig the ahc source?&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Freeman&lt;/p&gt;
</comment>
                            <comment id="15644197" author="willymontaz" created="Mon, 7 Nov 2016 13:37:05 +0000"  >&lt;p&gt;It seems that with CXF 3.0.5 HttpAsyncClient 4.0.2 is used, the code is quite the same except for one line, &lt;/p&gt;

&lt;p&gt;@Override&lt;br/&gt;
    protected void onRelease(final BasicNIOPoolEntry entry) &lt;/p&gt;
{
        final NHttpClientConnection conn = entry.getConnection();
        entry.setSocketTimeout(conn.getSocketTimeout());
        conn.setSocketTimeout(0);
    }

&lt;p&gt;it seems that it is that line that what was corrected in &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPASYNC-105&quot; title=&quot;socketTimeout is not reset back to default after a request that has specific timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPASYNC-105&quot;&gt;&lt;del&gt;HTTPASYNC-105&lt;/del&gt;&lt;/a&gt; (&lt;a href=&quot;https://github.com/ok2c/httpasyncclient/commit/67f4d6e5413d8c6ed6879dc351a81925e4398eeb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ok2c/httpasyncclient/commit/67f4d6e5413d8c6ed6879dc351a81925e4398eeb&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;BUT in &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPASYNC-105&quot; title=&quot;socketTimeout is not reset back to default after a request that has specific timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPASYNC-105&quot;&gt;&lt;del&gt;HTTPASYNC-105&lt;/del&gt;&lt;/a&gt; they mention that the second request does not use any timeout in requestconfig. In CXF, we do specify requestconfig, so it should also be safe on versions 3.0.x !&lt;/p&gt;

&lt;p&gt;Have you also been able to reproduce the tests that fail (the ones where request is not actually timedout at the socket level) ?&lt;/p&gt;

&lt;p&gt;I&apos;m looking forward to your responses&lt;br/&gt;
William &lt;/p&gt;</comment>
                            <comment id="15644288" author="willymontaz" created="Mon, 7 Nov 2016 14:17:38 +0000"  >&lt;p&gt;Freeman,&lt;/p&gt;

&lt;p&gt;for little help in your investigations, I discovered that DefaultClientExchangeHandler only uses ConnectTimeout and ConnectioNRequestTimeout (that time to get the connection from the pool). The SocketTimeout in the request seems to be handled indirectly via org.apache.http.impl.nio.reactor.AbstractIOReactor (see line 491). While the CONNECTION_TTL seems to be handled at CPool level (timeToLive field). It is quite hard to put back everything together.&lt;/p&gt;</comment>
                            <comment id="15646690" author="ffang" created="Tue, 8 Nov 2016 06:37:24 +0000"  >&lt;p&gt;Hi William,&lt;/p&gt;

&lt;p&gt;In ahc 4.0.2 code base, the org.apache.http.impl.nio.conn.CPool is actually&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;CPool &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; AbstractNIOConnPool&amp;lt;HttpRoute, ManagedNHttpClientConnection, CPoolEntry&amp;gt; {

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Log log = LogFactory.getLog(CPool.class);

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; timeToLive;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TimeUnit tunit;

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; CPool(
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ConnectingIOReactor ioreactor,
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; NIOConnFactory&amp;lt;HttpRoute, ManagedNHttpClientConnection&amp;gt; connFactory,
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SocketAddressResolver&amp;lt;HttpRoute&amp;gt; addressResolver,
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; defaultMaxPerRoute, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxTotal,
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; timeToLive, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TimeUnit tunit) {
        &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(ioreactor, connFactory, addressResolver, defaultMaxPerRoute, maxTotal);
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.timeToLive = timeToLive;
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.tunit = tunit;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; CPoolEntry createEntry(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; HttpRoute route, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ManagedNHttpClientConnection conn) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CPoolEntry(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.log, conn.getId(), route, conn, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.timeToLive, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.tunit);
    }

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;There&apos;s no onRelease method in that version, and I found &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPASYNC-88&quot; title=&quot;Race condition caused SocketTimeoutException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPASYNC-88&quot;&gt;&lt;del&gt;HTTPASYNC-88&lt;/del&gt;&lt;/a&gt;(&lt;a href=&quot;https://github.com/ok2c/httpasyncclient/commit/c246f59794cfaad86e718ad9bcc38cf368544d8a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ok2c/httpasyncclient/commit/c246f59794cfaad86e718ad9bcc38cf368544d8a&lt;/a&gt;) actually fixed this and this is in ahc 4.1.0 afterwards.&lt;/p&gt;

&lt;p&gt;With ahc 4.1.0 afterwards, I think we don&apos;t need fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-6910&quot; title=&quot;don&amp;#39;t need setSocketTimeout when create ahc RequestConfig&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-6910&quot;&gt;&lt;del&gt;CXF-6910&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7112&quot; title=&quot;AsyncHTTPConduit ignore the ReceiveTimeout when use Async JAXWS api&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7112&quot;&gt;&lt;del&gt;CXF-7112&lt;/del&gt;&lt;/a&gt;(because ReceivedTimeout we set on ahc RequestConfig won&apos;t affect the connection return to the pool, so that the connection could be actually reused), I will re-consider your patch based on this.&lt;/p&gt;

&lt;p&gt;Freeman&lt;/p&gt;
</comment>
                            <comment id="15646832" author="githubbot" created="Tue, 8 Nov 2016 07:57:06 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cxf/pull/190&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/190&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13133685">CXF-7623</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12837067" name="AsyncHTTPConduitTest.java" size="14311" author="ffang" created="Fri, 4 Nov 2016 07:23:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 2 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i35qlj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>