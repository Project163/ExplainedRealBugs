<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:11:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-5970] review org.apache.cxf.jaxrs.provider.ProviderFactory.Message*ReaderComparator</title>
                <link>https://issues.apache.org/jira/browse/CXF-5970</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Actually the task can be rephrase saying rework org.apache.cxf.jaxrs.provider.ProviderFactory#*Comparators&lt;/p&gt;

&lt;p&gt;Current implementations don&apos;t seem to have an absolute order which means sorting is not as deterministic as it should be under java &amp;gt;= 7.&lt;/p&gt;

&lt;p&gt;Other point is as a user you set a List of providers (you probably already sorted if important) so you want to ensure &lt;b&gt;your&lt;/b&gt; order is respected at runtime (ie org.apache.cxf.jaxrs.provider.ProviderFactory#message&lt;span class=&quot;error&quot;&gt;&amp;#91;Readers|Writers&amp;#93;&lt;/span&gt; respect it).&lt;/p&gt;

&lt;p&gt;If you think this sorting is important maybe introducing in org.apache.cxf.jaxrs.AbstractJAXRSFactoryBean and org.apache.cxf.jaxrs.provider.ProviderFactory a boolean sortProviders can be enough to prevent calling sortXXX().&lt;/p&gt;</description>
                <environment></environment>
        <key id="12736603">CXF-5970</key>
            <summary>review org.apache.cxf.jaxrs.provider.ProviderFactory.Message*ReaderComparator</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="7">Later</resolution>
                                        <assignee username="sergey_beryozkin">Sergey Beryozkin</assignee>
                                    <reporter username="romain.manni-bucau">Romain Manni-Bucau</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Aug 2014 19:35:03 +0000</created>
                <updated>Fri, 31 Mar 2017 19:41:28 +0000</updated>
                            <resolved>Wed, 27 Aug 2014 10:07:34 +0000</resolved>
                                                    <fixVersion>NeedMoreInfo</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14109658" author="sergey_beryozkin" created="Mon, 25 Aug 2014 20:19:04 +0000"  >&lt;p&gt;Hi Romain,&lt;br/&gt;
Can you give me an example please of where the factory loses the expected priority ? Ultimately the runtime must guarantee the providers are sorted correctly,&lt;/p&gt;

&lt;p&gt;Thanks, Sergey&lt;/p&gt;</comment>
                            <comment id="14109687" author="romain.manni-bucau" created="Mon, 25 Aug 2014 20:44:05 +0000"  >&lt;p&gt;if you take the default ones (shared provider factory) then the order is already not respected once sorted.&lt;/p&gt;

&lt;p&gt;That said case popped up using jackson json provider. When using it we want it first but it is using &lt;b&gt;/&lt;/b&gt; so it is hard to get it right with CXF if any other json provider is setup whereever it comes from (scanning or other way).&lt;/p&gt;

&lt;p&gt;Runtime must only ensures q=xxx and subclasses first are respected AFAIK. It means it is easy to use the list index to compare two providers instead of assuming sorting does it in the order and that -1 will be a nice default.&lt;/p&gt;

&lt;p&gt;wdyt?&lt;/p&gt;</comment>
                            <comment id="14109730" author="sergey_beryozkin" created="Mon, 25 Aug 2014 21:05:35 +0000"  >&lt;p&gt;Right, I recall Jackson captures it all (returns true in isReadable AFAIK, if I recall it right it has Consumes/Produces application/json ). The order of the registration must not make a difference as far as selecting the right provider is concerned. Can you please give me a more concrete example ? Say, you have Jackson provider and may be some other custom provider for reading InputStream or some other type and Jackson takes it and then rejects ? Such issues are expected to be fixed by having a CustomProvider&amp;lt;InputStream&amp;gt;, etc&lt;/p&gt;

&lt;p&gt;Thanks, Sergey&lt;/p&gt;</comment>
                            <comment id="14109794" author="romain.manni-bucau" created="Mon, 25 Aug 2014 21:44:42 +0000"  >&lt;p&gt;jackson uses &lt;b&gt;/&lt;/b&gt; as well as fleece (apache json provider).&lt;/p&gt;

&lt;p&gt;issue can be: let say you have provider A supporting types &lt;span class=&quot;error&quot;&gt;&amp;#91;A1, A2&amp;#93;&lt;/span&gt; and provider B supporting types &lt;span class=&quot;error&quot;&gt;&amp;#91;A2, A3&amp;#93;&lt;/span&gt;: if cxf doesn&apos;t repect the ordering of the user how do you say you want A before B or B before A? can depend the case. And with providers using &lt;b&gt;/&lt;/b&gt; to handle the isReadable/isWritable more deeply then it is pretty easy to get this case.&lt;/p&gt;</comment>
                            <comment id="14110674" author="sergey_beryozkin" created="Tue, 26 Aug 2014 13:09:29 +0000"  >&lt;p&gt;Hi Romain&lt;/p&gt;

&lt;p&gt;What is different in your case compared to this:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/cxf/commit/be6b95a6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/cxf/commit/be6b95a6&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks, Sergey&lt;/p&gt;</comment>
                            <comment id="14110691" author="romain.manni-bucau" created="Tue, 26 Aug 2014 13:32:24 +0000"  >&lt;p&gt;I guess registration order can change in my case then change the sorting (I am using scanning to get user providers)&lt;/p&gt;</comment>
                            <comment id="14110769" author="sergey_beryozkin" created="Tue, 26 Aug 2014 14:45:24 +0000"  >&lt;p&gt;But the test confirms that CXF ProviderFactory does not change the order of the registration for providers with identical properties, the providers which are equal candidates. If so then disabling the sorting would not fix the issue anyway, right ? I.e, if the order of providers can not be controlled (say they&apos;ve been auto-discovered) then there&apos;s nothing ProviderFactory can do...&lt;/p&gt;

&lt;p&gt;I&apos;m thinking that may be JAX-RS 2.1 should use @Priority as the final key when sorting MBR and MBW, let me open the enhancement request...&lt;/p&gt;

&lt;p&gt;Cheers, Sergey &lt;/p&gt;</comment>
                            <comment id="14110812" author="romain.manni-bucau" created="Tue, 26 Aug 2014 15:19:08 +0000"  >&lt;p&gt;well, I got it debugging (java 1.7.0_67 IIRC). ordering was really changed. Wonder if new sorting algorithm can be linked to it or if it was really due to mediatype. I&apos;ll try to sort it out tonight.&lt;/p&gt;</comment>
                            <comment id="14111044" author="romain.manni-bucau" created="Tue, 26 Aug 2014 17:56:14 +0000"  >&lt;p&gt;you are right Sergey, the issue is surely linked to the fact tomee was registering JsonProvider which was conflicting then with Jackson&lt;/p&gt;</comment>
                            <comment id="14111290" author="sergey_beryozkin" created="Tue, 26 Aug 2014 20:39:03 +0000"  >&lt;p&gt;Hi Romain, thanks for the confirmation, so we&apos;ll resolve as won&apos;t fix, OK ?&lt;/p&gt;</comment>
                            <comment id="14111927" author="romain.manni-bucau" created="Wed, 27 Aug 2014 06:30:26 +0000"  >&lt;p&gt;maybe the boolean dontSortAtAll would be great otherwise yes&lt;/p&gt;</comment>
                            <comment id="14112105" author="sergey_beryozkin" created="Wed, 27 Aug 2014 10:05:28 +0000"  >&lt;p&gt;Hi, &lt;br/&gt;
I need to have a scenario where sorting causes the spec compliance issues. So far I understand that ProviderFactory does not cause the side-effects by sorting the providers. I&apos;d say if the sorting were causing the issues then it would be a sorting comparator bug as opposed to the sorting itself. See, if we have say &quot;application/json&quot; and &quot;&lt;b&gt;/&lt;/b&gt;&quot; providers, then clearly a provider with &quot;application/json&quot; has to be asked first if it supports reading/writing a given type. If we have MyProvider and OtherProvider&amp;lt;Foo&amp;gt; then again OtherProvider&amp;lt;Foo&amp;gt; should be given a chance first before MyProvider gets Foo and then rejects it. So disabling the sorting would likely cause side-effects as opposed to improvements. And we also have confirmed the order of the providers with the same properties does not get changed. &lt;/p&gt;

&lt;p&gt;Lets fix it with a Later tag then, will be happy to review the issue if we identify a concrete issue with the sorting &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;br/&gt;
Thanks&lt;/p&gt;</comment>
                            <comment id="14112129" author="romain.manni-bucau" created="Wed, 27 Aug 2014 10:55:13 +0000"  >&lt;p&gt;No spec issue but user issues cause typically &lt;b&gt;/&lt;/b&gt;  will move and you don&apos;t always desire it&lt;/p&gt;</comment>
                            <comment id="14112295" author="sergey_beryozkin" created="Wed, 27 Aug 2014 14:40:49 +0000"  >&lt;p&gt;Hi, can you please ping me on #openejb or #cxf or privately to help me understand the issue better. May be I&apos;m missing something, thanks&lt;/p&gt;</comment>
                            <comment id="14112502" author="romain.manni-bucau" created="Wed, 27 Aug 2014 17:28:27 +0000"  >&lt;p&gt;suppose there is an unexpected sort from user point of view: you have foo/bar and &lt;b&gt;/&lt;/b&gt; and you want the &lt;b&gt;/&lt;/b&gt; provider to be called first. With default impl it will be pushed at the end so foo/bar will be called first. This case is not handled at all and since as a user you specify a list then it should be &quot;respectable&quot; by cxf.&lt;/p&gt;</comment>
                            <comment id="14118181" author="sergey_beryozkin" created="Tue, 2 Sep 2014 13:20:11 +0000"  >&lt;p&gt;Hi Romain&lt;/p&gt;

&lt;p&gt;Sorry for a delay. This is what the spec says:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;4.2.3
Declaring Media Type Capabilities

Message body readers and writers MAY restrict the media types they support using the @Consumes and
@Produces annotations respectively. The absence of these annotations is equivalent to their inclusion with
media type (&#8220;*/*&#8221;), i.e. absence implies that any media type is supported. An implementation MUST NOT
use an entity provider for a media type that is not supported by that provider.
When choosing an entity provider an implementation sorts the available providers according to the media
types they declare support for. Sorting of media types follows the general rule: x/y &amp;lt; x/* &amp;lt; */*, i.e. a
provider that explicitly lists a media types is sorted before a provider that lists */*.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As you see, checking custom &quot;&lt;b&gt;/&lt;/b&gt;&quot; providers before custom providers with more specific types is non compliant.&lt;br/&gt;
The moment say TomEE will let it happen you&apos;d get some users asking the next day why my more specific provider is not checked first any longer &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;However, I can imagine a case where a user registers a 3rd party &quot;application/json&quot; provider which takes on processing type A (due to misleading the runtime by asserting it can handle it by returning &apos;true&apos; from isWriteable() and/or  isReadable()) but fails because it actually does not know how to handle A when asked to. And thus a wildcard provider which does know how to handle A will have no chance. Reversing the order might help in such cases, assuming a wildcard provider is &apos;well-behaved&apos; i.e, it won&apos;t do the same with respect to type B which is known to the &quot;application/json&quot; provider but not to this wildcard provider.&lt;/p&gt;

&lt;p&gt;So yes, there&apos;s a possibility that disabling a sorting would help in such edge cases but I don&apos;t think we can ever convince the expert group that the order of the registration should be taken into the consideration, example, as you said, that won&apos;t hold anyway in the auto-discovery cases.&lt;/p&gt;

&lt;p&gt;IMHO, if a user ever faces such a conflict of MBW/MBR providers, the spec compliant way would be to avoid registering one of these providers and for example register a custom JAX-RS 2.0 WriterInterceptor or ReaderInterceptor, check the types there (media types, the entity parameter types) and read or write using a the right provider to avoid the ambiguities. Another option is to register a composite MBR or MBW that will do the same. &lt;/p&gt;

&lt;p&gt;I.e, IMHO the way to sort such cases is to introduce custom higher-level providers that can delegate appropriately as opposed to relying on the order of the registration - the latter might work but will unlikely offer a portable or reliable solution (if we deal with the auto-discovery).&lt;/p&gt;

&lt;p&gt;Having said all of the abovem, I can add the option to disable the sorting (not at the jaxrs:server but at JAXRSServerFactoryBean) to quickly validate that keeping the order of the registration actually helps, this can be handy as a quick test that a more specific provider can be &apos;guilty&apos; of consuming the type it can not actually handle&lt;/p&gt;

&lt;p&gt;Thanks     &lt;/p&gt;






</comment>
                            <comment id="14118198" author="romain.manni-bucau" created="Tue, 2 Sep 2014 13:37:53 +0000"  >&lt;p&gt;sounds fair to me, also means scanning is a mess in most of cases (just drop jackson and you don&apos;t know what you&apos;ll get: jaxb style or not provider) and should never be used but spec implies it (IIRC that&apos;s a  may or a should). Not that happy with that but right CXF can&apos;t help.&lt;/p&gt;

&lt;p&gt;Thanks for your time and review Sergey! We can close this task as will not fix&lt;/p&gt;</comment>
                            <comment id="14118209" author="sergey_beryozkin" created="Tue, 2 Sep 2014 13:52:24 +0000"  >&lt;p&gt;np at all. CXF JAX-RS actually offers few extensions which allow to get the runtime make non-compliant decisions. So having such a boolean flag will let people experiment quickly with re-ordering...&lt;/p&gt;</comment>
                            <comment id="14130313" author="sergey_beryozkin" created="Thu, 11 Sep 2014 17:16:37 +0000"  >&lt;p&gt;I added a &apos;providerComparator&apos; property which can be used to do a custom sort of custom readers or writers, such comparator, if set, has to accept Objects and then cast internally. For now it would work for sorting MBR/MBW but in the future may be for sorting filters too. &lt;br/&gt;
Using this comparator would most likely lead to a non-compliant runtime behaviour but I agree that some 3rd party providers can &apos;mislead&apos; the runtime they can support a given type and then fail thus not giving a chance to some other custom provider. So it should only be used when absolutely needed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Cheers, Sergey &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12749468">TOMEE-1424</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 10 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1zb3r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>