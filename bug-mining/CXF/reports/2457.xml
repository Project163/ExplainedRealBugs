<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:13:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-6189] Improve memory usage of UrlUtils</title>
                <link>https://issues.apache.org/jira/browse/CXF-6189</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;When I run load test, I find that the management of encoding parameters of the urls is consumer memory.&lt;/p&gt;

&lt;p&gt;I do not know if it is possible to optimize this part.&lt;/p&gt;

&lt;p&gt;Throughput of load test : 400 query/s&lt;br/&gt;
~80% GET query with 6 parameters&lt;br/&gt;
~20% POST query with 6 parameters GET and 1 payload&lt;/p&gt;</description>
                <environment></environment>
        <key id="12765737">CXF-6189</key>
            <summary>Improve memory usage of UrlUtils</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sergey_beryozkin">Sergey Beryozkin</assignee>
                                    <reporter username="lpouzac">Lucas Pouzac</reporter>
                        <labels>
                            <label>performance</label>
                    </labels>
                <created>Thu, 8 Jan 2015 11:08:48 +0000</created>
                <updated>Wed, 16 Nov 2016 20:21:03 +0000</updated>
                            <resolved>Wed, 14 Jan 2015 20:58:54 +0000</resolved>
                                    <version>3.0.3</version>
                                    <fixVersion>3.0.4</fixVersion>
                    <fixVersion>3.1</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14269402" author="sergey_beryozkin" created="Thu, 8 Jan 2015 14:55:00 +0000"  >&lt;p&gt;I recall awhile back I saw RestEasy and Oltu using the same code for encoding/decoding - perhaps there&apos;s some other Apache Library is available somewhere where that code has been copied from ? Ultimately this can be tuned by introducing a custom encoding/decoding function with some hard-coded tables. &lt;br/&gt;
How about experimenting with the following: run via UrlDecoder only if a String contains &apos;%&apos; or &apos;+&apos;, for query parameters for a start ? At least we&apos;d save on cases where the parameter has no percent-encoded symbols ?&lt;/p&gt;</comment>
                            <comment id="14269419" author="lpouzac" created="Thu, 8 Jan 2015 15:10:50 +0000"  >&lt;p&gt;It is a good idea in the first time. I think that the value and the key are encoded. &lt;br/&gt;
If you commit a patch, I could test it (3.0.x version) to make a feedback.&lt;/p&gt;</comment>
                            <comment id="14269470" author="lpouzac" created="Thu, 8 Jan 2015 15:56:37 +0000"  >&lt;p&gt;like that ?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; urlDecode(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; value, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; enc) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (value.contains(&lt;span class=&quot;code-quote&quot;&gt;&quot;+&quot;&lt;/span&gt;) || value.contains(&lt;span class=&quot;code-quote&quot;&gt;&quot;%&quot;&lt;/span&gt;)) {
                value = URLDecoder.decode(value, enc);
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (UnsupportedEncodingException e) {
            LOG.warning(&lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-8 encoding can not be used to dec    ode &quot;&lt;/span&gt; + value);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; value;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14269829" author="sergey_beryozkin" created="Thu, 8 Jan 2015 18:34:33 +0000"  >&lt;p&gt;I&apos;d probably do that check in context of the JAX-RS runtime decoding the parameters, &apos;+&apos; does not necessarily have to be decoded, for path components, etc. &lt;br/&gt;
InjectionUtils.decodeValue decodes the parameters. &lt;br/&gt;
Can you give me a favor and update your local snapshot to do that check for queries only (for a start) and see how much do we win really ? &lt;/p&gt;

&lt;p&gt;Thanks, Sergey &lt;/p&gt;</comment>
                            <comment id="14270790" author="lpouzac" created="Fri, 9 Jan 2015 09:07:46 +0000"  >&lt;p&gt;I don&apos;t find difference in the code between the snapshot of January 7 and 8 January.&lt;/p&gt;

&lt;p&gt;Could you add patch in attachement in this JIRA ?&lt;/p&gt;

&lt;p&gt;Thanks, Lucas.&lt;/p&gt;</comment>
                            <comment id="14271473" author="lpouzac" created="Fri, 9 Jan 2015 16:22:24 +0000"  >&lt;p&gt;I explain later &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;# Run complete. Total time: 00:07:34

Benchmark                                                                                         Mode  Samples       Score       Error   Units
o.a.c.UrlUtilsBenchmark.testDecodeAsApacheCodec                                                  thrpt       60  417938,761 &#177;  6580,048   ops/s
o.a.c.UrlUtilsBenchmark.testDecodeAsApacheCodec:@gc.count.profiled                               thrpt       60    1413,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeAsApacheCodec:@gc.count.total                                  thrpt       60     953,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeAsApacheCodec:@gc.time.profiled                                thrpt       60    5418,000 &#177;       NaN      ms
o.a.c.UrlUtilsBenchmark.testDecodeAsApacheCodec:@gc.time.total                                   thrpt       60    3676,000 &#177;       NaN      ms
o.a.c.UrlUtilsBenchmark.testDecodeAsApacheCodecWithByteBuffer                                    thrpt       60  484708,137 &#177; 14683,347   ops/s
o.a.c.UrlUtilsBenchmark.testDecodeAsApacheCodecWithByteBuffer:@gc.count.profiled                 thrpt       60    1321,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeAsApacheCodecWithByteBuffer:@gc.count.total                    thrpt       60     900,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeAsApacheCodecWithByteBuffer:@gc.time.profiled                  thrpt       60    4933,000 &#177;       NaN      ms
o.a.c.UrlUtilsBenchmark.testDecodeAsApacheCodecWithByteBuffer:@gc.time.total                     thrpt       60    3383,000 &#177;       NaN      ms
o.a.c.UrlUtilsBenchmark.testDecodeAsApacheCodecWithByteBufferAndCharBuffer                       thrpt       60  676093,489 &#177; 12207,746   ops/s
o.a.c.UrlUtilsBenchmark.testDecodeAsApacheCodecWithByteBufferAndCharBuffer:@gc.count.profiled    thrpt       60     931,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeAsApacheCodecWithByteBufferAndCharBuffer:@gc.count.total       thrpt       60     618,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeAsApacheCodecWithByteBufferAndCharBuffer:@gc.time.profiled     thrpt       60    3114,000 &#177;       NaN      ms
o.a.c.UrlUtilsBenchmark.testDecodeAsApacheCodecWithByteBufferAndCharBuffer:@gc.time.total        thrpt       60    2115,000 &#177;       NaN      ms
o.a.c.UrlUtilsBenchmark.testDecodeAsCXF3_0_3                                                     thrpt       60  252031,609 &#177;  6479,793   ops/s
o.a.c.UrlUtilsBenchmark.testDecodeAsCXF3_0_3:@gc.count.profiled                                  thrpt       60    1527,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeAsCXF3_0_3:@gc.count.total                                     thrpt       60     994,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeAsCXF3_0_3:@gc.time.profiled                                   thrpt       60    5195,000 &#177;       NaN      ms
o.a.c.UrlUtilsBenchmark.testDecodeAsCXF3_0_3:@gc.time.total                                      thrpt       60    3454,000 &#177;       NaN      ms
o.a.c.UrlUtilsBenchmark.testDecodeAsMarkUtilsCodec                                               thrpt       60  549886,027 &#177; 15235,738   ops/s
o.a.c.UrlUtilsBenchmark.testDecodeAsMarkUtilsCodec:@gc.count.profiled                            thrpt       60     871,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeAsMarkUtilsCodec:@gc.count.total                               thrpt       60     598,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeAsMarkUtilsCodec:@gc.time.profiled                             thrpt       60    3086,000 &#177;       NaN      ms
o.a.c.UrlUtilsBenchmark.testDecodeAsMarkUtilsCodec:@gc.time.total                                thrpt       60    2162,000 &#177;       NaN      ms
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14271583" author="lpouzac" created="Fri, 9 Jan 2015 17:38:07 +0000"  >&lt;p&gt;The best solution for decodeUrl seems to be urlDecodeAsApacheCodecWithByteBufferAndCharBuffer as below.&lt;/p&gt;

&lt;p&gt;It&apos;s a same solution that Apache Commons Codec 1.10 except I replace ByteArrayOuptutStream by ByteBuffer and CharBuffer.  &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/**
 * Radix used in encoding and decoding.
 */
&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; RADIX = 16;

&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; ESCAPE_CHAR = &lt;span class=&quot;code-quote&quot;&gt;&apos;%&apos;&lt;/span&gt;;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; urlDecode(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; value) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; urlDecode(value, &lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;);
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; urlDecode(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; value, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; enc) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (value == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Charset.forName(enc).decode(urlDecode(CharBuffer.wrap(value))).toString();
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ByteBuffer urlDecode(CharBuffer in) {

    ByteBuffer buffer = ByteBuffer.allocate(in.capacity());
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (in.hasRemaining()) {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; b = in.get();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (b == &lt;span class=&quot;code-quote&quot;&gt;&apos;+&apos;&lt;/span&gt;) {
            buffer.put((&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;) &lt;span class=&quot;code-quote&quot;&gt;&apos; &apos;&lt;/span&gt;);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (b == ESCAPE_CHAR) {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; u = digit16((&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;) in.get());
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; l = digit16((&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;) in.get());
                buffer.put((&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;) ((u &amp;lt;&amp;lt; 4) + l));
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ArrayIndexOutOfBoundsException e) {
                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Invalid URL encoding: &quot;&lt;/span&gt;, e);
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            buffer.put((&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;) b);
        }
    }
    buffer.flip();
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; buffer;
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; digit16(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; b) {
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;code-object&quot;&gt;Character&lt;/span&gt;.digit((&lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;) b, RADIX);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (i == -1) {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Invalid URL encoding: not a valid digit (radix &quot;&lt;/span&gt; + RADIX + &lt;span class=&quot;code-quote&quot;&gt;&quot;): &quot;&lt;/span&gt; + b);
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; i;
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;It would still avoid the call if the characters &apos;%&apos; and &apos;+&apos; are not present.&lt;/p&gt;

&lt;p&gt;Regards&lt;/p&gt;</comment>
                            <comment id="14273833" author="sergey_beryozkin" created="Mon, 12 Jan 2015 17:49:19 +0000"  >&lt;p&gt;Hi, it is looking quite neat, thanks. Can you please check &lt;br/&gt;
FormEncodingProviderTest.testReadChineeseChars ?&lt;br/&gt;
This is the only test which is failing for me, I can investigate later on too...&lt;/p&gt;

&lt;p&gt;Thanks, Sergey&lt;/p&gt;</comment>
                            <comment id="14275061" author="sergey_beryozkin" created="Tue, 13 Jan 2015 11:22:36 +0000"  >&lt;p&gt;I&apos;m on it...using ByteBuffer instead of CharBuffer works&lt;/p&gt;</comment>
                            <comment id="14275063" author="lpouzac" created="Tue, 13 Jan 2015 11:27:12 +0000"  >&lt;p&gt;Ok, can you give me an example code? I can not get it to work ...&lt;/p&gt;</comment>
                            <comment id="14275068" author="lpouzac" created="Tue, 13 Jan 2015 11:33:07 +0000"  >&lt;p&gt;Because with only bytebuffer is this test o.a.c.UrlUtilsBenchmark.testDecodeAsApacheCodecWithByteBuffer, no ?&lt;/p&gt;</comment>
                            <comment id="14275075" author="sergey_beryozkin" created="Tue, 13 Jan 2015 11:40:15 +0000"  >&lt;p&gt;I have this code working:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; urlDecode(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; value, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; enc, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isPath) {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] valueBytes = StringUtils.toBytes(value, enc);
        ByteBuffer in = ByteBuffer.wrap(valueBytes);
        ByteBuffer out = ByteBuffer.allocate(in.capacity());
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (in.hasRemaining()) {
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; b = in.get();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isPath &amp;amp;&amp;amp; b == PLUS_CHAR) {
                out.put((&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;) &lt;span class=&quot;code-quote&quot;&gt;&apos; &apos;&lt;/span&gt;);
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (b == ESCAPE_CHAR) {
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; u = digit16((&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;) in.get());
                    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; l = digit16((&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;) in.get());
                    out.put((&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;) ((u &amp;lt;&amp;lt; 4) + l));
                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ArrayIndexOutOfBoundsException e) {
                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Invalid URL encoding: &quot;&lt;/span&gt;, e);
                }
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                out.put((&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;) b);
            }
        }
        out.flip();
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Charset.forName(enc).decode(out).toString();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The test I referred to uses chinese symbols, each of them in this case is 3 bytes, converting String into CharArray loses that info, each char is assumed to have 2 bytes&lt;/p&gt;</comment>
                            <comment id="14275109" author="sergey_beryozkin" created="Tue, 13 Jan 2015 11:59:53 +0000"  >&lt;p&gt;I could not make the test pass with even without casting a char to byte; if you can find a way to get the test passing with CharArray then I&apos;d be fine with that too &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14275121" author="sergey_beryozkin" created="Tue, 13 Jan 2015 12:13:36 +0000"  >&lt;p&gt;Hi, applied your patch with minor modifications, have a look please.&lt;br/&gt;
I think we may still optimize it a little bit; can you give me a favor and experiment with what is faster for values which have no % characters:&lt;br/&gt;
effectively do a copy as we do now or check if &apos;%&apos; is there and if not then just return String. Perhaps it is obvious the 2nd option is faster, though it would make it a bit slower to decode %-encoded values, but given that it is 80% case for non-encoded values then may be we should do a check after all, at least for Path parameters...&lt;/p&gt;</comment>
                            <comment id="14275337" author="lpouzac" created="Tue, 13 Jan 2015 15:09:41 +0000"  >&lt;p&gt;I did some testing and some modifications. For me, I think we need to better optimize the memory usage to be quite a bit slower.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/**
 * V2
 */ 
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; urlDecode(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; value, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; enc, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isPath) {
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; length = 0;
        &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; needEncode = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; value.length(); i++) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (value.charAt(i) == ESCAPE_CHAR) {
                length += 1;
                needEncode = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (value.charAt(i) == PLUS_CHAR) {
                needEncode = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
            }
        }

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (needEncode) {

            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] valueBytes = StringUtils.toBytes(value, enc);
            ByteBuffer in = ByteBuffer.wrap(valueBytes);
            ByteBuffer out = ByteBuffer.allocate(in.capacity() - (2 * length)); &lt;span class=&quot;code-comment&quot;&gt;// MODIFY
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (in.hasRemaining()) {
                &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; b = in.get();
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isPath &amp;amp;&amp;amp; b == PLUS_CHAR) {
                    out.put((&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;) &lt;span class=&quot;code-quote&quot;&gt;&apos; &apos;&lt;/span&gt;);
                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (b == ESCAPE_CHAR) {
                    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; u = digit16(in.get());
                        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; l = digit16(in.get());
                        out.put((&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;) ((u &amp;lt;&amp;lt; 4) + l));
                    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ArrayIndexOutOfBoundsException e) {
                        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Invalid URL encoding: &quot;&lt;/span&gt;, e);
                    }
                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                    out.put(b);
                }
            }
            out.flip();
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Charset.forName(enc).decode(out).toString();
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; value;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For V3, replace&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] valueBytes = value.getBytes(enc);
            ByteBuffer in = ByteBuffer.wrap(valueBytes);
            ByteBuffer out = ByteBuffer.allocate(in.capacity());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;by&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            ByteBuffer in = Charset.forName(enc).encode(CharBuffer.wrap(value));
            ByteBuffer out = ByteBuffer.allocate(in.capacity() - (2 * length));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Result for v3&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Faster than cxf 3.0.3&lt;/li&gt;
	&lt;li&gt;Slower than v1 and v2&lt;/li&gt;
	&lt;li&gt;But Memory usage has decreased.&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;o.a.c.UrlUtilsBenchmark.testDecodeAsCXF3_0_3                              thrpt       60  219953,443 &#177;  4342,013   ops/s
o.a.c.UrlUtilsBenchmark.testDecodeAsCXF3_0_3:@gc.count.profiled           thrpt       60    1344,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeAsCXF3_0_3:@gc.count.total              thrpt       60     927,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeAsCXF3_0_3:@gc.time.profiled            thrpt       60    4917,000 &#177;       NaN      ms
o.a.c.UrlUtilsBenchmark.testDecodeAsCXF3_0_3:@gc.time.total               thrpt       60    3388,000 &#177;       NaN      ms
o.a.c.UrlUtilsBenchmark.testDecodeSergeyBeryozkin                         thrpt       60  430193,040 &#177; 14953,635   ops/s
o.a.c.UrlUtilsBenchmark.testDecodeSergeyBeryozkin:@gc.count.profiled      thrpt       60    1383,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeSergeyBeryozkin:@gc.count.total         thrpt       60     951,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeSergeyBeryozkin:@gc.time.profiled       thrpt       60    5155,000 &#177;       NaN      ms
o.a.c.UrlUtilsBenchmark.testDecodeSergeyBeryozkin:@gc.time.total          thrpt       60    3501,000 &#177;       NaN      ms
o.a.c.UrlUtilsBenchmark.testDecodeSergeyBeryozkinV2                       thrpt       60  425701,711 &#177; 11373,886   ops/s
o.a.c.UrlUtilsBenchmark.testDecodeSergeyBeryozkinV2:@gc.count.profiled    thrpt       60    1213,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeSergeyBeryozkinV2:@gc.count.total       thrpt       60     825,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeSergeyBeryozkinV2:@gc.time.profiled     thrpt       60    4497,000 &#177;       NaN      ms
o.a.c.UrlUtilsBenchmark.testDecodeSergeyBeryozkinV2:@gc.time.total        thrpt       60    3088,000 &#177;       NaN      ms
o.a.c.UrlUtilsBenchmark.testDecodeSergeyBeryozkinV3                       thrpt       60  319130,222 &#177;  6422,034   ops/s
o.a.c.UrlUtilsBenchmark.testDecodeSergeyBeryozkinV3:@gc.count.profiled    thrpt       60     589,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeSergeyBeryozkinV3:@gc.count.total       thrpt       60     388,000 &#177;       NaN  counts
o.a.c.UrlUtilsBenchmark.testDecodeSergeyBeryozkinV3:@gc.time.profiled     thrpt       60    2085,000 &#177;       NaN      ms
o.a.c.UrlUtilsBenchmark.testDecodeSergeyBeryozkinV3:@gc.time.total        thrpt       60    1454,000 &#177;       NaN      ms
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think we should use the v3&lt;/p&gt;</comment>
                            <comment id="14275476" author="lpouzac" created="Tue, 13 Jan 2015 16:20:15 +0000"  >&lt;p&gt;I integrated the latest version of the code (v3) on my application and after a load test, I observe a gain of 3.7% in memory usage with the same condition. (6.15Gb -&amp;gt; 5.92Gb)&lt;/p&gt;</comment>
                            <comment id="14275484" author="sergey_beryozkin" created="Tue, 13 Jan 2015 16:25:40 +0000"  >&lt;p&gt;I wonder if we should actually settle on v2. The memory gain is not major, and given that the memory is generally cheap now, the performance gains are more interesting IMHO, &lt;br/&gt;
v2 is still having a memory gain compared to CXF 3.0.3 and significantly faster.&lt;/p&gt;

&lt;p&gt;Cheers, Sergey&lt;/p&gt;</comment>
                            <comment id="14275496" author="sergey_beryozkin" created="Tue, 13 Jan 2015 16:31:30 +0000"  >&lt;p&gt;Hi Lucas, &lt;br/&gt;
v2 is in, I&apos;m open for v3 if your experience suggests v3 gains are much more important. I&apos;d settle for v2 though &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Let me know...&lt;br/&gt;
Sergey&lt;/p&gt;</comment>
                            <comment id="14275506" author="lpouzac" created="Tue, 13 Jan 2015 16:37:33 +0000"  >&lt;p&gt;Ok thanks, I&apos;ll generalize v2 on all apps and observe the behavior. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Lucas.&lt;/p&gt;</comment>
                            <comment id="14277664" author="sergey_beryozkin" created="Wed, 14 Jan 2015 20:58:33 +0000"  >&lt;p&gt;Hi &lt;br/&gt;
I&apos;ve done a micro optimization to the code checking for escapes, perhaps it can increase a thrpt parameter under some load &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Let me resolve this issue now, we can do something else for this code if needed; please keep your optimization requests coming&lt;br/&gt;
Thanks&lt;/p&gt;</comment>
                            <comment id="14277706" author="lpouzac" created="Wed, 14 Jan 2015 21:21:25 +0000"  >&lt;p&gt;Hi&lt;br/&gt;
Ok thanks!&lt;/p&gt;</comment>
                            <comment id="14277709" author="lpouzac" created="Wed, 14 Jan 2015 21:22:17 +0000"  >&lt;p&gt;Validate&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13021251">CXF-7139</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12691326" name="jmh.tar.gz" size="11043" author="lpouzac" created="Fri, 9 Jan 2015 16:22:24 +0000"/>
                            <attachment id="12690824" name="screenshot-1.png" size="238021" author="lpouzac" created="Thu, 8 Jan 2015 11:09:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10062"><![CDATA[Moderate]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 44 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i242pr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>