<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:40:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-9057] Chunked Stream is closed regularly when Exception is thrown</title>
                <link>https://issues.apache.org/jira/browse/CXF-9057</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;In response to SOAP requests served by Apache CXF we send large datasets streamed directly from a database. Because of the size of the data, chunked encoding is used. Unfortunately when a database error occurs and an exception is thrown while data is sent, the client will receive a regular ending to the chunked data stream. That means he has no way to recognise that an error occurred and that he has only received a partial file.&lt;/p&gt;

&lt;p&gt;To be more specific the response looks somewhat like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
HTTP/1.1 200 OK
Date: Tue, 10 Sep 2024 16:17:45 GMT
Content-Type: multipart/related; type=&lt;span class=&quot;code-quote&quot;&gt;&quot;application/xop+xml&quot;&lt;/span&gt;; boundary=&lt;span class=&quot;code-quote&quot;&gt;&quot;uuid:49aa53f9-ec29-4f1a-bc07-a21256c2f940&quot;&lt;/span&gt;; start=&lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;root.message@cxf.apache.org&amp;gt;&quot;&lt;/span&gt;; start-info=&lt;span class=&quot;code-quote&quot;&gt;&quot;text/xml&quot;&lt;/span&gt;
Transfer-Encoding: chunked
Server: Jetty(10.0.21)

8000

--uuid:49aa53f9-ec29-4f1a-bc07-a21256c2f940
Content-Type: application/xop+xml; charset=UTF-8; type=&lt;span class=&quot;code-quote&quot;&gt;&quot;text/xml&quot;&lt;/span&gt;
Content-Transfer-Encoding: binary
Content-ID: &amp;lt;root.message@cxf.apache.org&amp;gt;

&amp;lt;soap:Envelope xmlns:soap=&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//schemas.xmlsoap.org/soap/envelope/&quot;&lt;/span&gt;&amp;gt;[...]&amp;lt;/soap:Envelope&amp;gt;
&lt;/span&gt;--uuid:49aa53f9-ec29-4f1a-bc07-a21256c2f940
Content-Type:
Content-Transfer-Encoding: binary
Content-ID: &amp;lt;03d4ea67-6e8b-4d1f-91b0-b63208989f95-1@cxf.apache.org&amp;gt;

xxxxxxxxxxxx[...]xxxxxxx
356
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
0

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;That means the response ends with the &quot;0&quot; entry, indicating that the transfer is complete.&lt;/p&gt;

&lt;p&gt;What should happen instead is that the response should be closed without sending the final 0 entry. (&lt;a href=&quot;https://stackoverflow.com/a/17203961/136247&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/a/17203961/136247&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;For example when we use a Servlet to stream data to a client a throw an exception the result will look something like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
HTTP/1.1 200 OK
Date: Fri, 13 Sep 2024 09:31:48 GMT
Content-Type: text/plain;charset=utf-8
Transfer-Encoding: chunked
Server: Jetty(10.0.21)

8
Chunk 1

8
Chunk 2

8
Chunk 3

8
Chunk 4

8
Chunk 5
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here there is no closing 0 marker. As a result clients can recognise the error. (Curl will report &quot;curl: (18) transfer closed with outstanding read data remaining&quot;, Chrome &quot;Failed to load resource: net::ERR_INCOMPLETE_CHUNKED_ENCODING&quot;)&lt;/p&gt;

&lt;p&gt;CXF should do the same and not end the chunked stream regularly, when an exception is thrown.&lt;/p&gt;

&lt;p&gt;I have tested with Tomcat and Jetty. Both show the same behaviour.&lt;/p&gt;

&lt;p&gt;To provide some detail, Exceptions are caught by CXF here:&lt;/p&gt;

&lt;p&gt;org/apache/cxf/phase/PhaseInterceptorChain.java:328&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (RuntimeException ex) {
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!faultOccurred) {
                        faultOccurred = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
                        wrapExceptionAsFault(message, ex);
                    }
                    state = State.ABORTED;
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The exception is logged, but not rethrown.&lt;/p&gt;

&lt;p&gt;If the exception would be thrown, for instance Tomcats ErrorReportValve would shut down the output and thereby prevent the end of the input and closing 0 to be written.&lt;/p&gt;

&lt;p&gt;org/apache/catalina/valves/ErrorReportValve.java:112&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                    &lt;span class=&quot;code-comment&quot;&gt;// Now close immediately to signal to the client that
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// something went wrong
&lt;/span&gt;                    response.getCoyoteResponse().action(ActionCode.CLOSE_NOW,
                            request.getAttribute(RequestDispatcher.ERROR_EXCEPTION));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Without an exception to prevent this, a regular end of the stream will be written by&lt;/p&gt;

&lt;p&gt;org/apache/catalina/connector/CoyoteAdapter.java:371&lt;/p&gt;

&lt;p&gt;response.finishResponse();&lt;/p&gt;

&lt;p&gt;In Summary: CXF ends a chunked encoded stream in a regular way in spite of exceptions occurring, which makes it impossible for clients to recognise that they have downloaded partial and therefore corrupt data.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13592048">CXF-9057</key>
            <summary>Chunked Stream is closed regularly when Exception is thrown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="reta">Andriy Redko</assignee>
                                    <reporter username="johannes.herr">Johannes Herr</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Sep 2024 10:25:54 +0000</created>
                <updated>Sun, 16 Feb 2025 17:51:34 +0000</updated>
                            <resolved>Sun, 16 Feb 2025 17:51:34 +0000</resolved>
                                    <version>3.5.8</version>
                                    <fixVersion>3.5.11</fixVersion>
                    <fixVersion>3.6.6</fixVersion>
                    <fixVersion>4.0.7</fixVersion>
                    <fixVersion>4.1.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17886297" author="reta" created="Wed, 2 Oct 2024 02:13:30 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johannes.herr&quot; class=&quot;user-hover&quot; rel=&quot;johannes.herr&quot;&gt;johannes.herr&lt;/a&gt;, do you by any chance have a reproducible test case (or application) for this issue? thank you&lt;/p&gt;</comment>
                            <comment id="17886376" author="johannes.herr" created="Wed, 2 Oct 2024 13:12:46 +0000"  >&lt;p&gt;Hi Andriy, I will create a small project to demonstrate the problem. Might take until next week though.&lt;/p&gt;</comment>
                            <comment id="17886385" author="reta" created="Wed, 2 Oct 2024 13:39:43 +0000"  >&lt;p&gt;Thank you!&lt;/p&gt;</comment>
                            <comment id="17887378" author="johannes.herr" created="Mon, 7 Oct 2024 15:48:22 +0000"  >&lt;p&gt;I have attached the file &lt;tt&gt;chunked-reproducer.tar.gz&lt;/tt&gt;. To run it:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;tar xzf chunked-reproducer.tar.gz
cd chunked-demo/
mvn test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;tt&gt;ServerMock&lt;/tt&gt; is a Jetty Server with a CXF SOAP-API. It defines a service to download data which will throw an exception, while streaming the result. It also provides a servlet that does the same for comparions.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;ServerMockTest&lt;/tt&gt; defines 3 Test. One uses the generated CXF client to call the streaming service. Here an exception would be expected, which is not thrown. Instead incomplete data is returned.&lt;/p&gt;

&lt;p&gt;The other two test cases use raw sockets to be able to print the server response to stdout. There are not asserts. It is just a demonstration of the differing behaviour of CXF and servlets. One would see the same if one inspects the traffic of the first test case with Wireshark.&lt;/p&gt;

&lt;p&gt;I hope this helps. Let me know if you need anything else.&lt;/p&gt;
</comment>
                            <comment id="17888485" author="reta" created="Fri, 11 Oct 2024 01:41:38 +0000"  >&lt;p&gt;Thanks a lot for the reproducer &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johannes.herr&quot; class=&quot;user-hover&quot; rel=&quot;johannes.herr&quot;&gt;johannes.herr&lt;/a&gt;, looking into the issue.&lt;/p&gt;</comment>
                            <comment id="17914968" author="johannes.herr" created="Tue, 21 Jan 2025 12:39:32 +0000"  >&lt;p&gt;I have tried version 3.5.10 and 3.6.5 and the problem does not seem to be fixed. One can try it with the reproducer project I attached. If you change the version in the pom to one of those two versions, the chunked encoding is still terminated with 0 indicating success and no exception is thrown in &lt;tt&gt;chunked.ServerMockTest#stream_with_error_and_cxf_client&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I have looked into why the test case &lt;tt&gt;org.apache.cxf.systest.jaxws.AttachmentChunkingTest&lt;/tt&gt; included in the fix does not fail in contrast to my reproducer (on tag 3.5.10). The problem seems to be that the server sending the response does not use chunked encoding when sending data. The bug does not apply then.&lt;/p&gt;

&lt;p&gt;This is the response sent by the server in the test case &lt;tt&gt;testChunkingPartialFailure&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;HTTP/1.1 200 OK
Date: Tue, 21 Jan 2025 11:48:59 GMT
Content-Type: text/xml;charset=utf-8
Content-Length: 254
Server: Jetty(9.4.56.v20240826)

&amp;lt;soap:Envelope xmlns:soap=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&amp;gt;&amp;lt;soap:Body&amp;gt;&amp;lt;soap:Fault&amp;gt;&amp;lt;faultcode&amp;gt;soap:Server&amp;lt;/faultcode&amp;gt;&amp;lt;faultstring&amp;gt;Marshalling Error: simulated error during stream processing&amp;lt;/faultstring&amp;gt;&amp;lt;/soap:Fault&amp;gt;&amp;lt;/soap:Body&amp;gt;&amp;lt;/soap:Envelope&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;One can see that a response length is used and no chunked encoding is used. That means the server has buffered the response and not started sending it before the exception occurred. So he could avoid sending a partial response and can return an error messages. (Note that this can not be a fix for the bug, because the application could have been sending 100 GB of data before the exception. So it has to be streamed and cannot be completely buffered.)&lt;/p&gt;

&lt;p&gt;It seems to be sufficient to enable MTOM in the test server to make it use chunked encoding in the unit test. The response looks like this then:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;HTTP/1.1 200 OK
Date: Tue, 21 Jan 2025 12:15:33 GMT
Content-Type: multipart/related; type=&quot;application/xop+xml&quot;; boundary=&quot;uuid:8cf6e9c1-fc0f-4513-bd6d-8a2bf85406f0&quot;; start=&quot;&amp;lt;root.message@cxf.apache.org&amp;gt;&quot;; start-info=&quot;text/xml&quot;
Transfer-Encoding: chunked
Server: Jetty(9.4.56.v20240826)

8000

--uuid:8cf6e9c1-fc0f-4513-bd6d-8a2bf85406f0
Content-Type: application/xop+xml; charset=UTF-8; type=&quot;text/xml&quot;
Content-Transfer-Encoding: binary
Content-ID: &amp;lt;root.message@cxf.apache.org&amp;gt;

&amp;lt;soap:Envelope xmlns:soap=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&amp;gt;&amp;lt;soap:Body&amp;gt;&amp;lt;ns2:downloadNextResponse xmlns:ns2=&quot;http://cxf.apache.org/&quot;&amp;gt;&amp;lt;ns2:downloadNextResponse&amp;gt;&amp;lt;dataContent&amp;gt;&amp;lt;xop:Include xmlns:xop=&quot;http://www.w3.org/2004/08/xop/include&quot; href=&quot;cid:488565d7-85b5-4550-b66c-9db03faa0458-1@cxf.apache.org&quot;/&amp;gt;&amp;lt;/dataContent&amp;gt;&amp;lt;/ns2:downloadNextResponse&amp;gt;&amp;lt;/ns2:downloadNextResponse&amp;gt;&amp;lt;/soap:Body&amp;gt;&amp;lt;/soap:Envelope&amp;gt;
--uuid:8cf6e9c1-fc0f-4513-bd6d-8a2bf85406f0
Content-Type:
Content-Transfer-Encoding: binary
Content-ID: &amp;lt;488565d7-85b5-4550-b66c-9db03faa0458-1@cxf.apache.org&amp;gt;

xxxxx[...]xxxxxxxxxxxxxxxxxx
6301
xxxxxxxx[...]xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The undesired closing 0 is included in the response and the test case fails with &lt;tt&gt;java.lang.AssertionError: expected javax.xml.ws.soap.SOAPFaultException to be thrown, but nothing was thrown&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I have attached a patch with my changes to the class to make it use chunked encoding. (The randomness of the length of the response seems also a bit dangerous here, because if the response is too small Jetty will probably not use chunked encoding, but sent a buffered response.)&lt;/p&gt;</comment>
                            <comment id="17916935" author="reta" created="Sat, 25 Jan 2025 14:34:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johannes.herr&quot; class=&quot;user-hover&quot; rel=&quot;johannes.herr&quot;&gt;johannes.herr&lt;/a&gt; the behavior with letting the exception to pop up (to the container) is more nuanced. Yes, the request will fail, but caller will end up with HTML error page (Jetty is this case):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Jan. 25, 2025 9:28:44 A.M. org.apache.cxf.phase.PhaseInterceptorChain doDefaultLoggingWARNING: Interceptor for {http://cxf.apache.org/}DownloadService#{http://cxf.apache.org/}downloadNext has thrown exception, unwinding noworg.apache.cxf.interceptor.Fault: Response was of unexpected text/html ContentType.  Incoming portion of HTML stream: 

&amp;lt;html&amp;gt;
&amp;lt;head&amp;gt;
&amp;lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html;charset=ISO-8859-1&quot;/&amp;gt;
&amp;lt;title&amp;gt;Error 500 org.apache.cxf.interceptor.Fault: simulated error during stream processing&amp;lt;/title&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;
&amp;lt;h2&amp;gt;HTTP ERROR 500 org.apache.cxf.interceptor.Fault: simulated error during stream processing&amp;lt;/h2&amp;gt;&amp;lt;table&amp;gt;&amp;lt;tr&amp;gt;&amp;lt;th&amp;gt;URI:&amp;lt;/th&amp;gt;&amp;lt;td&amp;gt;http://localhost:9001/SoapContext/SoapPort/DownloadPort&amp;lt;/td&amp;gt;&amp;lt;/tr&amp;gt;&amp;lt;tr&amp;gt;&amp;lt;th&amp;gt;STATUS:&amp;lt;/th&amp;gt;&amp;lt;td&amp;gt;500&amp;lt;/td&amp;gt;&amp;lt;/tr&amp;gt;&amp;lt;tr&amp;gt;&amp;lt;th&amp;gt;MESSAGE:&amp;lt;/th&amp;gt;&amp;lt;td&amp;gt;org.apache.cxf.interceptor.Fault: simulated error during stream processing&amp;lt;/td&amp;gt;&amp;lt;/tr&amp;gt;&amp;lt;/table&amp;gt;&amp;lt;hr/&amp;gt;&amp;lt;a href=&quot;https://jetty.org/&quot;&amp;gt;Powered by Jetty:// 12.0.16&amp;lt;/a&amp;gt;&amp;lt;hr/&amp;gt;
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is unlikely the desired result.&lt;/p&gt;</comment>
                            <comment id="17921293" author="johannes.herr" created="Mon, 27 Jan 2025 08:25:12 +0000"  >&lt;p&gt;Hi Andriy, thanks for looking into this.&lt;/p&gt;

&lt;p&gt;I think it really matters if the response uses chunked encoding or not. My bug report only concerns chunked encoding. When chunked encoding is not used, the servlet container can return whatever it wants to. That means it can return a soap error messages as it is the case right now:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;HTTP/1.1 200 OK
Date: Mon, 27 Jan 2025 08:05:32 GMT
Content-Type: text/xml;charset=utf-8
Content-Length: 254
Server: Jetty(9.4.56.v20240826)

&amp;lt;soap:Envelope xmlns:soap=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&amp;gt;
    &amp;lt;soap:Body&amp;gt;
        &amp;lt;soap:Fault&amp;gt;
            &amp;lt;faultcode&amp;gt;soap:Server&amp;lt;/faultcode&amp;gt;
            &amp;lt;faultstring&amp;gt;Marshalling Error: simulated error during stream processing&amp;lt;/faultstring&amp;gt;
        &amp;lt;/soap:Fault&amp;gt;
    &amp;lt;/soap:Body&amp;gt;
&amp;lt;/soap:Envelope&amp;gt;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;(formatted for readability)&lt;/p&gt;

&lt;p&gt;It could also return an error status 500 and the html error page you posted in your comment. Both are fine, since both indicate to the caller that something went wrong. (Of course the structured soap error contains more relevant information.)&lt;/p&gt;

&lt;p&gt;However, when chunked encoding is used, the server has already sent the http success status and has already transferred parts of the response data. This has already been received and processed by the client, when the error occurs. That means it cannot go back and change the http status or change the data it sent. I therefore doubt, that jetty would try to send the html error page you describe in this case. Thats also not the behaviour my servlet test in the reproducer shows. As far as I have been able to determine, the only thing the webserver can do at this point is close the connection without the final &quot;0&quot; to indicate that the data transfer was not complete.&lt;/p&gt;

&lt;p&gt;CXF sends the final &quot;0&quot; in case of errors at the moment and therefore the client can not distinguish between incomplete and successful downloads:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;HTTP/1.1 200 OK
Date: Mon, 27 Jan 2025 08:03:13 GMT
Content-Type: multipart/related; type=&quot;application/xop+xml&quot;; boundary=&quot;uuid:43c5ed92-e223-4dca-842b-933b7abd32e4&quot;; start=&quot;&amp;lt;root.message@cxf.apache.org&amp;gt;&quot;; start-info=&quot;text/xml&quot;
Transfer-Encoding: chunked
Server: Jetty(9.4.56.v20240826)

301

--uuid:43c5ed92-e223-4dca-842b-933b7abd32e4
Content-Type: application/xop+xml; charset=UTF-8; type=&quot;text/xml&quot;
Content-Transfer-Encoding: binary
Content-ID: &amp;lt;root.message@cxf.apache.org&amp;gt;

&amp;lt;soap:Envelope xmlns:soap=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&amp;gt;
    &amp;lt;soap:Body&amp;gt;
        &amp;lt;ns2:downloadNextResponse xmlns:ns2=&quot;http://cxf.apache.org/&quot;&amp;gt;
            &amp;lt;ns2:downloadNextResponse&amp;gt;
                &amp;lt;dataContent&amp;gt;
                    &amp;lt;xop:Include xmlns:xop=&quot;http://www.w3.org/2004/08/xop/include&quot; href=&quot;cid:e9ebb114-18cb-4134-ba8f-a9e472a710e3-1@cxf.apache.org&quot;/&amp;gt;
                &amp;lt;/dataContent&amp;gt;
            &amp;lt;/ns2:downloadNextResponse&amp;gt;
        &amp;lt;/ns2:downloadNextResponse&amp;gt;
    &amp;lt;/soap:Body&amp;gt;
&amp;lt;/soap:Envelope&amp;gt;
--uuid:43c5ed92-e223-4dca-842b-933b7abd32e4
Content-Type:
Content-Transfer-Encoding: binary
Content-ID: &amp;lt;e9ebb114-18cb-4134-ba8f-a9e472a710e3-1@cxf.apache.org&amp;gt;


0  &amp;lt;-- this should be missing in case of errors
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I guess you are saying a fix for the chunked encoding case (throwing the exception to the servlet container) would break the behaviour when a fixed size response is sent?&lt;br/&gt;
Unfortunately I do not know enough about the cxf implementation to say if one can distinguish between these cases. Could cxf throw the exception only if chunked encoding is used to send the response?&lt;/p&gt;</comment>
                            <comment id="17921373" author="reta" created="Mon, 27 Jan 2025 12:44:19 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johannes.herr&quot; class=&quot;user-hover&quot; rel=&quot;johannes.herr&quot;&gt;johannes.herr&lt;/a&gt; , I am only referring to chunked transfer encoding (where HTML is become the part of multipart response). As of today I don&apos;t have any proof that CXF sends the final &quot;0&quot; - it seems to be done by the servlet container (Jetty fe) when the response is finalized. One of the possible ways to deal with it is not sending the rest of the data at all (I have this draft pull request &lt;a href=&quot;https://github.com/apache/cxf/pull/2234&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/2234&lt;/a&gt; if you are interested in giving it a shot). Thank you.&lt;/p&gt;</comment>
                            <comment id="17921417" author="johannes.herr" created="Mon, 27 Jan 2025 15:08:27 +0000"  >&lt;p&gt;I agree, that the servlet container will write the closing &quot;0&quot;. I have looked into this for Tomcat and written this in the ticket description:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;If the exception would be thrown, for instance Tomcats ErrorReportValve would shut down the output and thereby prevent the end of the input and closing 0 to be written.&lt;/p&gt;

&lt;p&gt;org/apache/catalina/valves/ErrorReportValve.java:112&lt;/p&gt;

&lt;p&gt;                    // Now close immediately to signal to the client that&lt;br/&gt;
                    // something went wrong&lt;br/&gt;
                    response.getCoyoteResponse().action(ActionCode.CLOSE_NOW,&lt;br/&gt;
                            request.getAttribute(RequestDispatcher.ERROR_EXCEPTION));&lt;br/&gt;
Without an exception to prevent this, a regular end of the stream will be written by&lt;/p&gt;

&lt;p&gt;org/apache/catalina/connector/CoyoteAdapter.java:371&lt;/p&gt;

&lt;p&gt;response.finishResponse();&lt;/p&gt;&lt;/blockquote&gt; 

&lt;p&gt;CXF can influence this is by either throwing an exception or not. Looking at the diff your new change seems to do that by avoiding swallowing the exception in &lt;tt&gt;PhaseInterceptorChain.java&lt;/tt&gt; in this case, which seemed to be the root cause of the problem to me.&lt;/p&gt;

&lt;p&gt;I am not really sure what you were trying to say in your previous comment than. We might be misunderstanding each other a bit. &#128517; But the direction of your changes looks good!&lt;/p&gt;</comment>
                            <comment id="17921442" author="reta" created="Mon, 27 Jan 2025 15:55:35 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johannes.herr&quot; class=&quot;user-hover&quot; rel=&quot;johannes.herr&quot;&gt;johannes.herr&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt; CXF can influence this is by either throwing an exception or not. Looking at the diff your new change seems to do that by avoiding swallowing the exception in &lt;tt&gt;PhaseInterceptorChain.java&lt;/tt&gt; in this case, which seemed to be the root cause of the problem to me.&lt;/p&gt;

&lt;p&gt;Correct, this&#160; basically circles back to previous remark: letting the exception through would end up with HTML error (examples in previous comments) injected into the chunked content stream. I believe it is not acceptable solution.&lt;/p&gt;

&lt;p&gt;&amp;gt; I am not really sure what you were trying to say in your previous comment than. We might be misunderstanding each other a bit. &#128517; But the direction of your changes looks good!&lt;/p&gt;

&lt;p&gt;Basically the idea is, try to not send the chunked content (all or part of it) at all if there is an error in the middle: the result that clients see is that the data is not present where it expects it, so exception is raised.&#160; I will spend more time on exploring the consequences and portability of it, but if it does not work out - the only solution I would suggest is to use &quot;marker&quot; content / SHAs to make sure the chunked mtulti-part response is delivered in full.&lt;/p&gt;</comment>
                            <comment id="17921676" author="johannes.herr" created="Tue, 28 Jan 2025 10:22:48 +0000"  >&lt;p&gt;Thank you for the explanation. I understand what you mean now.&lt;/p&gt;

&lt;p&gt;How Jetty behaves when an exception is thrown can be seen in the test chunked.ServerMockTest#stream_with_error_and_raw_socket_from_servlet in my reproducer.&lt;/p&gt;

&lt;p&gt;Basically when it receives and exception Jetty will:&lt;/p&gt;

&lt;p&gt;1) Send an error status and the default error page if it still has the chance. That is, if it has not started sending the response. One can try this if one removes the &lt;tt&gt;flush()&lt;/tt&gt; call in &lt;tt&gt;chunked.ServerMock.StreamingServlet#doGet&lt;/tt&gt;. The test data is small enough to be buffered, so when Jetty receveives the exception it instead sends the stanard error page.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;HTTP/1.1 500 Server Error
Cache-Control: must-revalidate,no-cache,no-store
Content-Type: text/html;charset=iso-8859-1
Content-Length: 2646
Connection: close
Server: Jetty(9.4.56.v20240826)

&amp;lt;html&amp;gt;
&amp;lt;head&amp;gt;
&amp;lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html;charset=ISO-8859-1&quot;/&amp;gt;
&amp;lt;title&amp;gt;Error 500 java.lang.IllegalArgumentException: simulated error&amp;lt;/title&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;&amp;lt;h2&amp;gt;HTTP ERROR 500 java.lang.IllegalArgumentException: simulated error&amp;lt;/h2&amp;gt;
&amp;lt;table&amp;gt;
&amp;lt;tr&amp;gt;&amp;lt;th&amp;gt;URI:&amp;lt;/th&amp;gt;&amp;lt;td&amp;gt;/servlet/endpoint&amp;lt;/td&amp;gt;&amp;lt;/tr&amp;gt;
&amp;lt;tr&amp;gt;&amp;lt;th&amp;gt;STATUS:&amp;lt;/th&amp;gt;&amp;lt;td&amp;gt;500&amp;lt;/td&amp;gt;&amp;lt;/tr&amp;gt;
&amp;lt;tr&amp;gt;&amp;lt;th&amp;gt;MESSAGE:&amp;lt;/th&amp;gt;&amp;lt;td&amp;gt;java.lang.IllegalArgumentException: simulated error&amp;lt;/td&amp;gt;&amp;lt;/tr&amp;gt;
&amp;lt;tr&amp;gt;&amp;lt;th&amp;gt;SERVLET:&amp;lt;/th&amp;gt;&amp;lt;td&amp;gt;chunked.ServerMock$StreamingServlet-4f8969b0&amp;lt;/td&amp;gt;&amp;lt;/tr&amp;gt;
&amp;lt;tr&amp;gt;&amp;lt;th&amp;gt;CAUSED BY:&amp;lt;/th&amp;gt;&amp;lt;td&amp;gt;java.lang.IllegalArgumentException: simulated error&amp;lt;/td&amp;gt;&amp;lt;/tr&amp;gt;
&amp;lt;/table&amp;gt;
&amp;lt;h3&amp;gt;Caused by:&amp;lt;/h3&amp;gt;&amp;lt;pre&amp;gt;java.lang.IllegalArgumentException: simulated error
	at chunked.ServerMock$StreamingServlet.doGet(ServerMock.java:140)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:687)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:790)
	at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:799)
	at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:554)
	at org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:233)
	at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1440)
	at org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:188)
	at org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:505)
	at org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:186)
	at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1355)
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)
	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:127)
	at org.eclipse.jetty.server.Server.handle(Server.java:516)
	at org.eclipse.jetty.server.HttpChannel.lambda$handle$1(HttpChannel.java:487)
	at org.eclipse.jetty.server.HttpChannel.dispatch(HttpChannel.java:732)
	at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:479)
	at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:277)
	at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:311)
	at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:105)
	at org.eclipse.jetty.io.ChannelEndPoint$1.run(ChannelEndPoint.java:104)
	at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:883)
	at org.eclipse.jetty.util.thread.QueuedThreadPool$Runner.run(QueuedThreadPool.java:1034)
	at java.base/java.lang.Thread.run(Thread.java:1583)
&amp;lt;/pre&amp;gt;
&amp;lt;hr/&amp;gt;&amp;lt;a href=&quot;https://jetty.org/&quot;&amp;gt;Powered by Jetty:// 9.4.56.v20240826&amp;lt;/a&amp;gt;&amp;lt;hr/&amp;gt;

&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;2. If flush is used and data has been sent already it would not make sense to include a html page in the middle of some other (maybe binary) data and Jetty does not do that but skips the final 0 instead.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;HTTP/1.1 200 OK
Date: Tue, 28 Jan 2025 09:57:23 GMT
Content-Type: text/plain;charset=utf-8
Transfer-Encoding: chunked
Server: Jetty(9.4.56.v20240826)

7
Data 1

7
Data 2

7
Data 3

7
Data 4

7
Data 5
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Both would result in exceptions in the client instead of silently passing invalid data. I guess the question is if other behaviour is broken? For example can you still send structured error objects as SOAPFaults when using MTOM in cases when you recognise the error before sending data (say the request is invalid or you cannot even connect to the database)? If no existing behaviour is broken this seems a clear improvement.&lt;/p&gt;

&lt;p&gt;I understand that in case 1 where it is still technically possible to send a better error message it would be nice to do that. I do not know if the servlet api provides a way to do that though. At the moment the user seems get an empty file with a success status in this case (error right at the start, while jetty is still buffering):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;HTTP/1.1 200 OK
Date: Tue, 28 Jan 2025 10:13:58 GMT
Content-Type: multipart/related; type=&quot;application/xop+xml&quot;; boundary=&quot;uuid:e362c4ac-b774-47ed-9c09-0057c03dc0af&quot;; start=&quot;&amp;lt;root.message@cxf.apache.org&amp;gt;&quot;; start-info=&quot;text/xml&quot;
Content-Length: 770
Server: Jetty(10.0.21)


--uuid:e362c4ac-b774-47ed-9c09-0057c03dc0af
Content-Type: application/xop+xml; charset=UTF-8; type=&quot;text/xml&quot;
Content-Transfer-Encoding: binary
Content-ID: &amp;lt;root.message@cxf.apache.org&amp;gt;

&amp;lt;soap:Envelope xmlns:soap=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&amp;gt;&amp;lt;soap:Body&amp;gt;&amp;lt;ns2:downloadNextResponse xmlns:ns2=&quot;http://www.example.com/&quot;&amp;gt;&amp;lt;ns2:downloadNextResponse&amp;gt;&amp;lt;dataContent&amp;gt;&amp;lt;xop:Include xmlns:xop=&quot;http://www.w3.org/2004/08/xop/include&quot; href=&quot;cid:306ced0f-c952-4aca-822b-2e7c20f45719-1@cxf.apache.org&quot;/&amp;gt;&amp;lt;/dataContent&amp;gt;&amp;lt;/ns2:downloadNextResponse&amp;gt;&amp;lt;/ns2:downloadNextResponse&amp;gt;&amp;lt;/soap:Body&amp;gt;&amp;lt;/soap:Envelope&amp;gt;
--uuid:e362c4ac-b774-47ed-9c09-0057c03dc0af
Content-Type: 
Content-Transfer-Encoding: binary
Content-ID: &amp;lt;306ced0f-c952-4aca-822b-2e7c20f45719-1@cxf.apache.org&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;(The closing multipart boundary seems missing, but still no error in spite of that.)&lt;/p&gt;

&lt;p&gt;So that is also a silent data corruption. Any kind of exception in the client seems better (if it can be implemented without breaking existing behaviour.)&lt;/p&gt;</comment>
                            <comment id="17922776" author="reta" created="Fri, 31 Jan 2025 16:53:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johannes.herr&quot; class=&quot;user-hover&quot; rel=&quot;johannes.herr&quot;&gt;johannes.herr&lt;/a&gt; thanks for staying with me, I think the option that &lt;a href=&quot;https://github.com/apache/cxf/pull/2234&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/2234&lt;/a&gt; offers is the best tradeoff out there, taking the limitations which current APIs &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; have. The servlet APIs do not provide a way to forceably abort the response stream and CXF has only limited choices to control the container behavior. The suggested fix seem to be playing nicely with reproducer project that you&apos;ve attached. Do you have a chance to try it locally if possible?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; related to &lt;a href=&quot;https://github.com/jakartaee/servlet/issues/98&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jakartaee/servlet/issues/98&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17923763" author="johannes.herr" created="Tue, 4 Feb 2025 16:11:12 +0000"  >&lt;p&gt;I hope I can give it a try later this week.&lt;/p&gt;

&lt;p&gt;Regarding the Apache/GitHub development process - how do I access the branch? Should I clone the master and expect to find a branch matching the pull request name? Is it possible to directly clone/checkout the pull request branch? Also, does a 3.5.x patch branch already exist?&lt;/p&gt;</comment>
                            <comment id="17923855" author="reta" created="Tue, 4 Feb 2025 22:24:12 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johannes.herr&quot; class=&quot;user-hover&quot; rel=&quot;johannes.herr&quot;&gt;johannes.herr&lt;/a&gt; , I have opened this backport pull request to 3.5.x &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. This is one of the ways to check it out and build:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ git fetch origin pull/2256/head:PR-2256
$ git checkout PR-2256
$ mvn -T 12 clean install -DskipTests=true -DskipITs=true  &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/cxf/pull/2256&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/2256&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17924510" author="johannes.herr" created="Thu, 6 Feb 2025 12:12:49 +0000"  >&lt;p&gt;I have included the 3.5.11-SNAPSHOT version in two of our projects and ran the test suites against it. No problems have surfaced.&lt;/p&gt;

&lt;p&gt;My producer behave as intended as desired with 3.5.11-SNAPSHOT. It now throws an exception where it would have silently returned partial data before.&lt;/p&gt;

&lt;p&gt;The included unit test seems to always produce too little data to actually use chunked encoding. It always sends an empty response. (Which of course is also one of the cases one would want to test.)&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;HTTP/1.1 200 OK
Date: Thu, 06 Feb 2025 11:57:27 GMT
Content-Type: multipart/related; type=&quot;application/xop+xml&quot;; boundary=&quot;uuid:691cbcb3-ae72-453a-bfa1-be85d1546ce3&quot;; start=&quot;&amp;lt;root.message@cxf.apache.org&amp;gt;&quot;; start-info=&quot;text/xml&quot;
Connection: close
Content-Length: 0
Server: Jetty(9.4.56.v20240826)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To actually use chunked encoding, I replaced:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ThreadLocalRandom.current().nextBoolean()) {
                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;code-quote&quot;&gt;&quot;simulated error during stream processing&quot;&lt;/span&gt;);
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ThreadLocalRandom.current().nextDouble() &amp;lt; 0.01) {
                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;code-quote&quot;&gt;&quot;simulated error during stream processing&quot;&lt;/span&gt;);
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that the unit test will fail, when chunked encoding is used, because the exception is only thrown when the returned input stream is read.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ByteStreams.toByteArray(downloadNextResponseType.getDataContent().getInputStream())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The tests contain the string:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;jakarta.xml.ws.service.endpoint.address&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;in&lt;br/&gt;
org.apache.cxf.systest.jaxws.AbstractAttachmentChunkingTest#testChunking&lt;br/&gt;
org.apache.cxf.systest.jaxws.AttachmentMtomChunkingTest#testChunkingPartialFailure&lt;/p&gt;

&lt;p&gt;instead of:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;javax.xml.ws.service.endpoint.address&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(In &quot;testChunkingPartialFailure&quot; this is not noticeable, because it expects an exception, which it will get of the string instead of the network problems:&amp;#41;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;javax.xml.ws.soap.SOAPFaultException: Cannot invoke &quot;org.apache.cxf.transport.http.Address.getURL()&quot; because &quot;address&quot; is null
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I have looked at the diff. Unfortunately I do not know the cxf source code enough to be able to assess it.&lt;/p&gt;

&lt;p&gt;So your changes seem to fix the problem very well. Thank you for taking the time to look into the problem!&lt;/p&gt;</comment>
                            <comment id="17925321" author="reta" created="Sat, 8 Feb 2025 21:14:43 +0000"  >&lt;p&gt;Thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johannes.herr&quot; class=&quot;user-hover&quot; rel=&quot;johannes.herr&quot;&gt;johannes.herr&lt;/a&gt; , I will update the tests shortly (sorry, the &quot;jakarta.xml.ws.service.endpoint.address&quot; vs &quot;javax.xml.ws.service.endpoint.address&quot; was the backport issue, will be fixed).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13074186" name="activate-chunked-in-unit-text.patch" size="2976" author="johannes.herr" created="Tue, 21 Jan 2025 12:40:00 +0000"/>
                            <attachment id="13072001" name="chunked-reproducer.tar.gz" size="6259" author="johannes.herr" created="Mon, 7 Oct 2024 15:40:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            39 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1req8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>