<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:29:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-7586] cxf-rt-rs-security-oauth2 preventing application on JBoss from starting if more than 1 PU defined</title>
                <link>https://issues.apache.org/jira/browse/CXF-7586</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Hi, &lt;/p&gt;

&lt;p&gt;We noticed after switchting from cxf 3.1.7 to 3.2.x that our application is not starting anymore.&lt;br/&gt;
After some analysis we found out that the cxf module cxf-rt-rs-security-oauth2 contains a class org.apache.cxf.rs.security.oauth2.grants.code.JPACMTCodeDataProvider which injects an EntityManager using @PersistenceContext without defining a unitName. On our JBoss 6.4 EAP (JBoss 7.x) we get the following error message: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IllegalArgumentException: JBAS011470: Persistence unitName was not specified and there are x persistence unit definitions in application deployment deployment
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With only one persistence unit definition it&apos;s working, but we need multiple PU&apos;s.&lt;/p&gt;

&lt;p&gt;One solution I have in mind is to define a unitName for the PersistenceContext on the org.apache.cxf.rs.security.oauth2.grants.code.JPACMTCodeDataProvider (&quot;CXF_PU&quot;) , so that a PU has to be define explicitly in the persistence.xml, I mean it&apos;s not nice but for us it would be ok. &lt;/p&gt;

&lt;p&gt;Or perhaps there are other macanisms to avoid the persistence context injection if this class is not used? &lt;/p&gt;

&lt;p&gt;It currently prevents us from switchting to the newest cxf version.&lt;/p&gt;

&lt;p&gt;I attached a sample maven project to reproduce this issue on a JBoss 7.x .&lt;/p&gt;

&lt;p&gt;Greetings, Olivier&lt;/p&gt;</description>
                <environment></environment>
        <key id="13124319">CXF-7586</key>
            <summary>cxf-rt-rs-security-oauth2 preventing application on JBoss from starting if more than 1 PU defined</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ollipaq">Olivier Paquet</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Dec 2017 09:36:19 +0000</created>
                <updated>Wed, 7 Feb 2018 14:51:59 +0000</updated>
                            <resolved>Wed, 13 Dec 2017 14:35:09 +0000</resolved>
                                    <version>3.2.0</version>
                    <version>3.2.1</version>
                                    <fixVersion>3.2.2</fixVersion>
                                    <component>JAX-RS Security</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16287591" author="sergey_beryozkin" created="Tue, 12 Dec 2017 13:20:47 +0000"  >&lt;p&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gonzalad&quot; class=&quot;user-hover&quot; rel=&quot;gonzalad&quot;&gt;gonzalad&lt;/a&gt; Hi Adrian, can you have a look please when you get a sec &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ?&lt;/p&gt;</comment>
                            <comment id="16287677" author="gonzalad" created="Tue, 12 Dec 2017 14:25:43 +0000"  >&lt;p&gt;Sure !&lt;/p&gt;</comment>
                            <comment id="16287688" author="gonzalad" created="Tue, 12 Dec 2017 14:35:56 +0000"  >&lt;p&gt;What&apos;s strange is why JBoss 7.x would try to inject entityManager into a non-managed class (i.e. JPACMTCodeDataProvider is not an ejb or other Java EE managed class).&lt;/p&gt;

&lt;p&gt;&lt;del&gt;I&apos;m downloading JBoss AS 7.1.1 Full profile to reproduce the case.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m building JBoss AS 7.1.2 to reproduce the case (see &lt;a href=&quot;https://blog.kaltepoth.de/posts/2013/02/12/building-jboss-as7.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://blog.kaltepoth.de/posts/2013/02/12/building-jboss-as7.html&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="16287796" author="gonzalad" created="Tue, 12 Dec 2017 16:03:14 +0000"  >&lt;p&gt;the problem is that JBoss 7.x scans non managed class.&lt;br/&gt;
imo JBoss shouldn&apos;t scan non managed classes&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;https://jira.spring.io/browse/DATAJPA-213&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jira.spring.io/browse/DATAJPA-213&lt;/a&gt; and &lt;a href=&quot;https://issues.jboss.org/browse/WFLY-1032&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.jboss.org/browse/WFLY-1032&lt;/a&gt; which explains the issue.&lt;/p&gt;

&lt;p&gt;The issue is fixed in Wildfly &lt;a href=&quot;https://issues.jboss.org/browse/AS7-4710&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.jboss.org/browse/AS7-4710&lt;/a&gt;.&lt;br/&gt;
aka just declare &amp;lt;property name=&quot;wildfly.jpa.default-unit&quot; value=&quot;true&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;To current CXF version working with JBoss AS 7.1.2 we need to either : &lt;br/&gt;
a - add a unitName in @PersistenceContext&lt;br/&gt;
b - we remove the @PersistenceContext annotation from JPACMTCodeDataProvider.&lt;br/&gt;
     This would mean that any project using JPACMTCodeDataProvider will need to sublass it to add the @PersistenceContext or inject manually the entityManager&lt;/p&gt;

&lt;p&gt;wdyt ?&lt;/p&gt;</comment>
                            <comment id="16287809" author="sergey_beryozkin" created="Tue, 12 Dec 2017 16:13:46 +0000"  >&lt;p&gt;Hi Adrian, thanks for the super fast investigation.&lt;/p&gt;

&lt;p&gt;Option a) would require the integrators moving to CXF 3.2.2 adding a unit entry in the context configuration ? If yes then probably  it is least intrusive ? Unless manually injecting in the entity manager (as in b)) is even simpler ?&lt;/p&gt;</comment>
                            <comment id="16287870" author="gonzalad" created="Tue, 12 Dec 2017 16:50:41 +0000"  >&lt;p&gt;I&apos;m trying to test both fixes to know which is the smoother.&lt;/p&gt;

&lt;p&gt;But facing some  issues : JBoss AS 7.1.2 runs only on jdk 7, it doesn&apos;t startup on jdk8 (CXF requires jdk 8 afaik otherwise I have this issue : UnsupportedClassVersionError: org/apache/cxf/jaxrs/spring/NamespaceHandler : Unsupported major.minor version 52.0).&lt;/p&gt;

&lt;p&gt;Looking at &lt;a href=&quot;https://access.redhat.com/articles/112673&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://access.redhat.com/articles/112673&lt;/a&gt;, JBoss EAP 6.4 is built from JBoss AS 7.5.0 Final&lt;br/&gt;
But I don&apos;t find JBoss AS 7.5.0 Final anywhere.&lt;/p&gt;

&lt;p&gt;I&apos;m building JBoss AS 7.1.3 and then if it doesn&apos;t work 7.2.0.&lt;br/&gt;
I hope one of the 2 will run on Jdk 8 otherwise, it will be a blind fix.&lt;/p&gt;</comment>
                            <comment id="16287879" author="gonzalad" created="Tue, 12 Dec 2017 16:58:31 +0000"  >&lt;p&gt;No luck with 7.1.3 (doesn&apos;t start with jdk 8).&lt;br/&gt;
7.2.0 doesn&apos;t build.&lt;br/&gt;
I don&apos;t find 7.5.0 source code.&lt;/p&gt;

&lt;p&gt;So I&apos;ll use wildfly 8.0.0.Final for the tests.&lt;/p&gt;</comment>
                            <comment id="16288347" author="sergey_beryozkin" created="Tue, 12 Dec 2017 22:03:31 +0000"  >&lt;p&gt;Hi Adrian, &lt;br/&gt;
Many thanks. I&apos;d say the solution which will affect the the existing code which already depends on this provider in the most minimal way (when the code gets moved to 3.2.2 or later at some stage) will be the best one &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;br/&gt;
Then we can deploy the fixed module and ask Olivier to help with the test.&lt;/p&gt;

&lt;p&gt;Thanks, Sergey&lt;/p&gt;
</comment>
                            <comment id="16288382" author="githubbot" created="Tue, 12 Dec 2017 22:26:27 +0000"  >&lt;p&gt;gonzalad opened a new pull request #357: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7586&quot; title=&quot;cxf-rt-rs-security-oauth2 preventing application on JBoss from starting if more than 1 PU defined&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7586&quot;&gt;&lt;del&gt;CXF-7586&lt;/del&gt;&lt;/a&gt;: Remove @PersistenceContext&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/357&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Remove PersistenceContext anotation&lt;br/&gt;
   from JPACMTCodeDataProvider as it&lt;br/&gt;
   impeds application startup on JBoss EAP 6.x&lt;br/&gt;
   when the application declares multiple&lt;br/&gt;
   persistence units in its persistence.xml.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16288484" author="githubbot" created="Tue, 12 Dec 2017 23:49:55 +0000"  >&lt;p&gt;gonzalad closed pull request #357: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7586&quot; title=&quot;cxf-rt-rs-security-oauth2 preventing application on JBoss from starting if more than 1 PU defined&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7586&quot;&gt;&lt;del&gt;CXF-7586&lt;/del&gt;&lt;/a&gt;: Remove @PersistenceContext&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/357&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProvider.java b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProvider.java&lt;br/&gt;
index 1c951ac0909..4da4cd17d7b 100644&lt;br/&gt;
&amp;#8212; a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProvider.java&lt;br/&gt;
+++ b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProvider.java&lt;br/&gt;
@@ -24,19 +24,66 @@&lt;br/&gt;
 import javax.persistence.EntityManager;&lt;br/&gt;
 import javax.persistence.EntityTransaction;&lt;br/&gt;
 import javax.persistence.LockModeType;&lt;br/&gt;
-import javax.persistence.PersistenceContext;&lt;/p&gt;

&lt;p&gt; import org.apache.cxf.rs.security.oauth2.common.ServerAccessToken;&lt;br/&gt;
 import org.apache.cxf.rs.security.oauth2.tokens.refresh.RefreshToken;&lt;/p&gt;

&lt;p&gt;+/**&lt;br/&gt;
+ * Same as &lt;/p&gt;
{@link JPACodeDataProvider}
&lt;p&gt; (stores Clients and tokens in a rdbms using&lt;br/&gt;
+ * JPA APIs).&lt;br/&gt;
+ *&lt;br/&gt;
+ * The transaction demarcation is handled by the container (be it Spring&lt;br/&gt;
+ * or Java EE).&lt;br/&gt;
+ *&lt;br/&gt;
+ * Sample usage with Spring XML:&lt;br/&gt;
+ &amp;lt;pre&amp;gt;&lt;br/&gt;
+ &lt;/p&gt;
{@code
+     &amp;lt;bean id=&quot;oauthProvider&quot; class=&quot;org.apache.cxf.rs.security.oauth2.grants.code.JPACMTCodeDataProvider&quot;
+        init-method=&quot;init&quot; destroy-method=&quot;close&quot;&amp;gt;
+
+         &amp;lt;property name=&quot;entityManager&quot; ref=&quot;entityManager&quot;/&amp;gt;
+         &amp;lt;!-- List of accepted scopes --&amp;gt;
+         &amp;lt;property name=&quot;supportedScopes&quot; ref=&quot;supportedScopes&quot;/&amp;gt;
+         &amp;lt;!-- List of required scopes --&amp;gt;
+         &amp;lt;!-- commented because bug in Resource Owner Flow
+         &amp;lt;property name=&quot;requiredScopes&quot; ref=&quot;coreScopes&quot;/&amp;gt;
+         --&amp;gt;
+         &amp;lt;!--
+         List of scopes that the consent/authorization form should make
+         selected by default. For example, asking a user to do an extra click
+         to approve an &quot;oidc&quot; scope is a redundant operation because this scope
+         is required anyway.
+         --&amp;gt;
+         &amp;lt;property name=&quot;defaultScopes&quot; ref=&quot;coreScopes&quot;/&amp;gt;
+         &amp;lt;property name=&quot;invisibleToClientScopes&quot; ref=&quot;invisibleToClientScopes&quot;/&amp;gt;
+     &amp;lt;/bean&amp;gt;
+
+     &amp;lt;bean name=&quot;entityManager&quot; class=&quot;org.springframework.orm.jpa.support.SharedEntityManagerBean&quot;&amp;gt;
+         &amp;lt;property name=&quot;entityManagerFactory&quot; ref=&quot;entityManagerFactory&quot;/&amp;gt;
+     &amp;lt;/bean&amp;gt;
+     ...
+ }
&lt;p&gt;+ &amp;lt;/pre&amp;gt;&lt;br/&gt;
+&lt;br/&gt;
+ * You can also extend this class and inject your own entityManager:&lt;br/&gt;
+ {@code&lt;br/&gt;
+    public class MyJPACodeDataProvider extends JPACMTCodeDataProvider {&lt;br/&gt;
+&lt;br/&gt;
+        @PersistenceContext&lt;br/&gt;
+        @Override&lt;br/&gt;
+        public void setEntityManager(EntityManager entityManager) &lt;/p&gt;
{
+            super.setEntityManager(entityManager);
+        }
&lt;p&gt;+ }&lt;br/&gt;
+ }&lt;br/&gt;
+ */&lt;br/&gt;
 public class JPACMTCodeDataProvider extends JPACodeDataProvider {&lt;/p&gt;

&lt;p&gt;     private static final int DEFAULT_PESSIMISTIC_LOCK_TIMEOUT = 10000;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
     private int pessimisticLockTimeout = DEFAULT_PESSIMISTIC_LOCK_TIMEOUT;&lt;br/&gt;
     private boolean useJpaLockForExistingRefreshToken = true;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;@PersistenceContext&lt;br/&gt;
+&lt;br/&gt;
     private EntityManager entityManager;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     /**&lt;br/&gt;
@@ -72,7 +119,7 @@ protected void commitIfNeeded(EntityManager em) {&lt;br/&gt;
     @Override&lt;br/&gt;
     protected void closeIfNeeded(EntityManager em) {&lt;br/&gt;
     }&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
     @Override&lt;br/&gt;
     protected RefreshToken updateExistingRefreshToken(RefreshToken rt, ServerAccessToken at) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {         if (useJpaLockForExistingRefreshToken) {
@@ -82,7 +129,7 @@ protected RefreshToken updateExistingRefreshToken(RefreshToken rt, ServerAccessT
         }         return super.updateExistingRefreshToken(rt, at);     }&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
     protected void lockRefreshTokenForUpdate(final RefreshToken refreshToken) {&lt;br/&gt;
         try {&lt;br/&gt;
             execute(new EntityManagerOperation&amp;lt;Void&amp;gt;() &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {@@ -103,7 +150,7 @@ public Void execute(EntityManager em) {
             // entity is not managed yet. ignore
         }     }&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
     public void setPessimisticLockTimeout(int pessimisticLockTimeout) &lt;/p&gt;
{
         this.pessimisticLockTimeout = pessimisticLockTimeout;
     }
&lt;p&gt;diff --git a/rt/rs/security/oauth-parent/oauth2/src/test/resources/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProvider.xml b/rt/rs/security/oauth-parent/oauth2/src/test/resources/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProvider.xml&lt;br/&gt;
index 61a25c79b3f..6272c50e18a 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/rt/rs/security/oauth-parent/oauth2/src/test/resources/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProvider.xml&lt;br/&gt;
+++ b/rt/rs/security/oauth-parent/oauth2/src/test/resources/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProvider.xml&lt;br/&gt;
@@ -38,9 +38,9 @@ under the License.&lt;br/&gt;
     &amp;lt;bean id=&quot;oauthProvider&quot;&lt;br/&gt;
           class=&quot;org.apache.cxf.rs.security.oauth2.grants.code.JPACMTCodeDataProvider&quot;&lt;br/&gt;
           init-method=&quot;init&quot; destroy-method=&quot;close&quot;&amp;gt;&lt;br/&gt;
+        &amp;lt;property name=&quot;entityManager&quot; ref=&quot;entityManager&quot;/&amp;gt;&lt;br/&gt;
     &amp;lt;/bean&amp;gt;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;-&lt;br/&gt;
     &amp;lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.orm.jpa.JpaTransactionManager&quot;&amp;gt;&lt;br/&gt;
         &amp;lt;property name=&quot;entityManagerFactory&quot; ref=&quot;entityManagerFactory&quot;/&amp;gt;&lt;br/&gt;
     &amp;lt;/bean&amp;gt;&lt;br/&gt;
@@ -58,6 +58,10 @@ under the License.&lt;br/&gt;
         &amp;lt;/tx:attributes&amp;gt;&lt;br/&gt;
     &amp;lt;/tx:advice&amp;gt;&lt;/p&gt;

&lt;p&gt;+    &amp;lt;bean name=&quot;entityManager&quot; class=&quot;org.springframework.orm.jpa.support.SharedEntityManagerBean&quot;&amp;gt;&lt;br/&gt;
+        &amp;lt;property name=&quot;entityManagerFactory&quot; ref=&quot;entityManagerFactory&quot;/&amp;gt;&lt;br/&gt;
+    &amp;lt;/bean&amp;gt;&lt;br/&gt;
+&lt;br/&gt;
     &amp;lt;beans profile=&quot;hibernate&quot;&amp;gt;&lt;br/&gt;
         &amp;lt;bean id=&quot;entityManagerFactory&quot;&lt;br/&gt;
               class=&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot;&amp;gt;&lt;br/&gt;
diff --git a/rt/rs/security/sso/oidc/src/test/resources/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectCMTTest.xml b/rt/rs/security/sso/oidc/src/test/resources/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectCMTTest.xml&lt;br/&gt;
index 61a25c79b3f..456b9358aa8 100644&lt;br/&gt;
&amp;#8212; a/rt/rs/security/sso/oidc/src/test/resources/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectCMTTest.xml&lt;br/&gt;
+++ b/rt/rs/security/sso/oidc/src/test/resources/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectCMTTest.xml&lt;br/&gt;
@@ -38,6 +38,7 @@ under the License.&lt;br/&gt;
     &amp;lt;bean id=&quot;oauthProvider&quot;&lt;br/&gt;
           class=&quot;org.apache.cxf.rs.security.oauth2.grants.code.JPACMTCodeDataProvider&quot;&lt;br/&gt;
           init-method=&quot;init&quot; destroy-method=&quot;close&quot;&amp;gt;&lt;br/&gt;
+        &amp;lt;property name=&quot;entityManager&quot; ref=&quot;entityManager&quot;/&amp;gt;&lt;br/&gt;
     &amp;lt;/bean&amp;gt;&lt;/p&gt;


&lt;p&gt;@@ -58,6 +59,10 @@ under the License.&lt;br/&gt;
         &amp;lt;/tx:attributes&amp;gt;&lt;br/&gt;
     &amp;lt;/tx:advice&amp;gt;&lt;/p&gt;

&lt;p&gt;+    &amp;lt;bean name=&quot;entityManager&quot; class=&quot;org.springframework.orm.jpa.support.SharedEntityManagerBean&quot;&amp;gt;&lt;br/&gt;
+        &amp;lt;property name=&quot;entityManagerFactory&quot; ref=&quot;entityManagerFactory&quot;/&amp;gt;&lt;br/&gt;
+    &amp;lt;/bean&amp;gt;&lt;br/&gt;
+    &lt;br/&gt;
     &amp;lt;beans profile=&quot;hibernate&quot;&amp;gt;&lt;br/&gt;
         &amp;lt;bean id=&quot;entityManagerFactory&quot;&lt;br/&gt;
               class=&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot;&amp;gt;&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16288492" author="gonzalad" created="Tue, 12 Dec 2017 23:53:28 +0000"  >&lt;p&gt;I can reproduce the issue with wildfly 8.0.0.Final &lt;/p&gt;</comment>
                            <comment id="16288498" author="gonzalad" created="Wed, 13 Dec 2017 00:00:09 +0000"  >&lt;p&gt;@ollipaq a fix has been pushed to CXF (I just removed the @PersistenceContext annotation in the offending class).&lt;br/&gt;
Could you test latest CXF 3.2.2-SNAPSHOT and tell us if it fixes the issue for you, please ?&lt;/p&gt;

&lt;p&gt;Once done, you can either :&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;upgrade to CXF 3.2.2-SNAPSHOT.&lt;/li&gt;
	&lt;li&gt;temporarily shade the cxf oauth2 jar (not cool sorry...)&lt;br/&gt;
   I tried other ways to exclude the JPACMTCodeDataProvider, but not way : jboss-scanning.xml doesn&apos;t work afaik in EAP 6, and I cannot exclude the class using jboss-deployment-structure.xml). Perhaps another way would be to create a cxf module, but it&apos;s overkill imo.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;ll attach your sample project with a shade submodule in case you really need it. &lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Adrian&lt;/p&gt;
</comment>
                            <comment id="16288860" author="ollipaq" created="Wed, 13 Dec 2017 08:09:25 +0000"  >&lt;p&gt;Hi guys, &lt;/p&gt;

&lt;p&gt;thanks for the quick response and fix, I will test it asap.&lt;/p&gt;</comment>
                            <comment id="16289331" author="ollipaq" created="Wed, 13 Dec 2017 14:35:09 +0000"  >&lt;p&gt;The fix in 3.2.2-SNAPSHOT works fine on JBoss EAP 6.4.&lt;br/&gt;
We will work for this module with the snapshot version for the moment.&lt;/p&gt;


&lt;p&gt;Thanks for the quick support!&lt;/p&gt;

&lt;p&gt;Greets, Olivier&lt;/p&gt;</comment>
                            <comment id="16289410" author="gonzalad" created="Wed, 13 Dec 2017 15:39:28 +0000"  >&lt;p&gt;Great ! &lt;br/&gt;
Thanks for the feedback Olivier, and for the really good testcase (I wouldn&apos;t have make it without &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; )&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12901787" name="cxf-jpa-example-shade.zip" size="66529" author="gonzalad" created="Wed, 13 Dec 2017 00:02:54 +0000"/>
                            <attachment id="12901642" name="cxf-jpa-example.zip" size="10582" author="ollipaq" created="Tue, 12 Dec 2017 09:37:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 48 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nson:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>