<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:39:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-8936] Fix h2 protocol negotiation in Jetty Transport</title>
                <link>https://issues.apache.org/jira/browse/CXF-8936</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;h1&gt;&lt;a name=&quot;Summary%C2%A0&quot;&gt;&lt;/a&gt;Summary&#160;&lt;/h1&gt;

&lt;p&gt;I have been trying to update one of our apps using the Jetty backend to use http2. While doing this I&apos;ve noticed that the protocol negotiation is in the wrong order which results in http/1.1 always being preferred where the client includes this in the ALPN handshake. This means that both browsers and cURL will never successfully negotiate h2/http2.&lt;/p&gt;

&lt;p&gt;&amp;#8212;&lt;/p&gt;

&lt;h1&gt;&lt;a name=&quot;Theproblem&quot;&gt;&lt;/a&gt;The problem&lt;/h1&gt;

&lt;p&gt;The issue can be shown using curl.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;curl -ikv &lt;a href=&quot;https://localhost:9000&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://localhost:9000&lt;/a&gt;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve attached the full output of this command when running curl against the CXF sample &lt;tt&gt;jax_rs_basic_http2_jetty&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The important lines are:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
* ALPN: offers h2,http/1.1
* ALPN: server accepted http/1.1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Compare this with the attached curl output from the CXF sample &lt;tt&gt;jax_rs_basic_http2_netty&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The important lines here are:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
* ALPN: offers h2,http/1.1
* ALPN: server accepted h2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&amp;#8212;&lt;/p&gt;

&lt;h1&gt;&lt;a name=&quot;Thesolution&quot;&gt;&lt;/a&gt;The solution&lt;/h1&gt;

&lt;p&gt;The ALPN takes place within &lt;tt&gt;ALPNServerConnection&lt;/tt&gt;, which is part of the &lt;tt&gt;jetty-alpn-server&lt;/tt&gt; module.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// RFC 7301 states that the server picks the protocol
&lt;/span&gt;&#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// that it prefers that is also supported by the client.
&lt;/span&gt;&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; serverProtocol : serverProtocols)
&#160; &#160; &#160; &#160; {
&#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (clientProtocols.contains(serverProtocol))
&#160; &#160; &#160; &#160; &#160; &#160; {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ConnectionFactory factory = getConnector().getConnectionFactory(serverProtocol);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (factory &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; CipherDiscriminator &amp;amp;&amp;amp; !((CipherDiscriminator)factory).isAcceptable(serverProtocol, tlsProtocol, tlsCipher))
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isDebugEnabled())
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Protocol {} not acceptable to {} &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; {}/{} on {}&quot;&lt;/span&gt;, serverProtocol, factory, tlsProtocol, tlsCipher, getEndPoint());
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }

&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; negotiated = serverProtocol;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
&#160; &#160; &#160; &#160; &#160; &#160; }
&#160; &#160; &#160; &#160; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As the code states, the server is responsible for picking the protocol and Jetty picks the first match in the server&apos;s list. From the log output of the same app the first in the list is http/1.1&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO: Started ServerConnector@11eadcba\{ssl, (http/1.1, ssl, alpn, h2)}{0.0.0.0:9000}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Therefore the solution is to ensure that when h2 is enabled inside &lt;tt&gt;JettyHTTPServerEngine&lt;/tt&gt; -&amp;gt; &lt;tt&gt;createConnectorJetty&lt;/tt&gt;, the HTTP2ServerConnectionFactory should always be added at the start of the list.&lt;/p&gt;

&lt;p&gt;With this change, curl then successfully negotiates with h2.&lt;/p&gt;</description>
                <environment>&lt;p&gt;CXF latest and CXF 4.0.3 on Java 11 and 17 both show this issue.&lt;/p&gt;</environment>
        <key id="13552070">CXF-8936</key>
            <summary>Fix h2 protocol negotiation in Jetty Transport</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="huw0">Huw Ayling-Miller</reporter>
                        <labels>
                            <label>Jetty</label>
                    </labels>
                <created>Tue, 26 Sep 2023 17:06:03 +0000</created>
                <updated>Wed, 4 Oct 2023 00:56:45 +0000</updated>
                            <resolved>Wed, 4 Oct 2023 00:56:45 +0000</resolved>
                                    <version>4.0.3</version>
                                    <fixVersion>3.6.3</fixVersion>
                    <fixVersion>4.0.4</fixVersion>
                                    <component>Transports</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17769286" author="JIRAUSER302381" created="Tue, 26 Sep 2023 17:08:16 +0000"  >&lt;p&gt;PR - &lt;a href=&quot;https://github.com/apache/cxf/pull/1454&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/1454&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13063189" name="output-jetty-original.txt" size="1360" author="huw0" created="Tue, 26 Sep 2023 17:05:32 +0000"/>
                            <attachment id="13063188" name="output-netty.txt" size="1611" author="huw0" created="Tue, 26 Sep 2023 17:05:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 7 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1klj4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>