<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:37:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-2164] CXFBusImpl never removed from ThreadLocal, generates permgen out of memory error after some redeployments</title>
                <link>https://issues.apache.org/jira/browse/CXF-2164</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;I&apos;ve found this message on a mailing list recently, and it doesn&apos;t seem to have been resolved as we have the same problem with version 2.1.4 of CXF on one of our webapp :&lt;/p&gt;

&lt;p&gt;Hello CXF users,&lt;/p&gt;

&lt;p&gt;I&apos;ve been  working on figuring out why our JBoss servers keep going down with permgen out&lt;br/&gt;
of memory exceptions when we redeploy our war files. To do this I had been using a profiler&lt;br/&gt;
to inspect the WebAppClassloader to find out what was keeping it from being garbage collected.&lt;br/&gt;
One such culprit was the class org.apache.cxf.BusFactory&lt;/p&gt;

&lt;p&gt;The BusFactory has a ThreadLocal in which it stores a copy of CXFBusImpl. However, this isn&apos;t&lt;br/&gt;
getting cleaned up properly when the war is undeployed. I noticed that CXFBusImpl has a shutdown&lt;br/&gt;
method that calls BusFactory.setDefaultBus(null) which in turn sets the value stored in the&lt;br/&gt;
ThreadLocal to null. However, this doesn&apos;t seem to be getting called.&lt;/p&gt;

&lt;p&gt;The way we are using CXF from spring is with the following WEB-INF/services.xml file in our&lt;br/&gt;
war:&lt;br/&gt;
  &amp;lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&lt;br/&gt;
    xmlns:amq=&quot;http://activemq.org/config/1.0&quot; xmlns:jaxws=&quot;http://cxf.apache.org/jaxws&quot;&lt;br/&gt;
    xmlns:http-conf=&quot;http://cxf.apache.org/transports/http/configuration&quot;&lt;br/&gt;
    xsi:schemaLocation=&quot;&lt;br/&gt;
      &lt;a href=&quot;http://www.springframework.org/schema/beans&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.springframework.org/schema/beans&lt;/a&gt; &lt;a href=&quot;http://www.springframework.org/schema/beans/spring-beans-2.5.xsd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.springframework.org/schema/beans/spring-beans-2.5.xsd&lt;/a&gt;&lt;br/&gt;
      &lt;a href=&quot;http://cxf.apache.org/transports/http/configuration&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cxf.apache.org/transports/http/configuration&lt;/a&gt; &lt;a href=&quot;http://cxf.apache.org/schemas/configuration/http-conf.xsd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cxf.apache.org/schemas/configuration/http-conf.xsd&lt;/a&gt;&lt;br/&gt;
      &lt;a href=&quot;http://cxf.apache.org/jaxws&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cxf.apache.org/jaxws&lt;/a&gt; &lt;a href=&quot;http://cxf.apache.org/schemas/jaxws.xsd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cxf.apache.org/schemas/jaxws.xsd&lt;/a&gt;&lt;br/&gt;
      &lt;a href=&quot;http://activemq.org/config/1.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.org/config/1.0&lt;/a&gt; &lt;a href=&quot;http://activemq.apache.org/schema/core/activemq-core-5.0.0.xsd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org/schema/core/activemq-core-5.0.0.xsd&lt;/a&gt;&quot;&lt;br/&gt;
    default-autowire=&quot;byType&quot;&amp;gt;&lt;/p&gt;

&lt;p&gt;    &amp;lt;import resource=&quot;classpath:META-INF/cxf/cxf.xml&quot; /&amp;gt;&lt;br/&gt;
    &amp;lt;import resource=&quot;classpath:META-INF/cxf/cxf-extension-soap.xml&quot; /&amp;gt;&lt;br/&gt;
    &amp;lt;import resource=&quot;classpath:META-INF/cxf/cxf-servlet.xml&quot; /&amp;gt;&lt;/p&gt;

&lt;p&gt;    &amp;lt;jaxws:endpoint id=&quot;helloService&quot; implementor=&quot;#helloSvc&quot; address=&quot;/HelloService&quot; /&amp;gt;&lt;br/&gt;
  &amp;lt;/beans&amp;gt;&lt;/p&gt;

&lt;p&gt;I&apos;m not really sure why this Bus.shutdown() isn&apos;t getting called or even who is responsible&lt;br/&gt;
for calling it. I tried doing something along the lines of:&lt;br/&gt;
  WebApplicationContext webContext = WebApplicationContextUtils.getRequiredWebApplicationContext(context);&lt;br/&gt;
  if (webContext.containsBean(&quot;cxf&quot;)) &lt;/p&gt;
{
    CXFBusImpl cxfBus = (CXFBusImpl) webContext.getBean(&quot;cxf&quot;);
    cxfBus.shutdown(true);
  }

&lt;p&gt;But that didn&apos;t work. What I eventually ended up doing was to have the following hack in the&lt;br/&gt;
shutdown sequence of our webapp:&lt;br/&gt;
  Field field = org.apache.cxf.BussFactory.class.getDeclaredField(&quot;localBus&quot;);&lt;br/&gt;
  field.setAccessible(true);&lt;br/&gt;
  ThreadLocal&amp;lt;?&amp;gt; localBus = (ThreadLocal&amp;lt;?&amp;gt;) field.get(null);&lt;br/&gt;
  localBus.remove();&lt;/p&gt;

&lt;p&gt;This did work but obviously it is a bit of an ugly hack. Is there something that needs to&lt;br/&gt;
be included in our service.xml file to tell spring how to cleanup CXF? Is this maybe a bug&lt;br/&gt;
in CXF that the CXFBusImpl.shutdown(Boolean) just isn&apos;t getting called at all or maybe that&lt;br/&gt;
in BusFactory.setThreadDefaultBus(Bus) that there should be some check such as:&lt;br/&gt;
  if (bus == null) &lt;/p&gt;
{
    localBus.remove();
  }
&lt;p&gt; else &lt;/p&gt;
{
    localBus.set(bus);
  }

&lt;p&gt;Or maybe some combination of all of these. I&apos;m reasonably new to CXF, Spring, and all this&lt;br/&gt;
stuff so I apologize ahead of time if there is some obvious solution that I just didn&apos;t come&lt;br/&gt;
across but I&apos;ve been trying to scour the CXF and Spring documentation for some idea of the&lt;br/&gt;
correct way to do this and why BusFactory is keeping its ThreadLocal but I can&apos;t figure it&lt;br/&gt;
out.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;Ben Dean&lt;br/&gt;
Software Engineer&lt;br/&gt;
Ontario Systems, LLC&lt;/p&gt;</description>
                <environment></environment>
        <key id="12422340">CXF-2164</key>
            <summary>CXFBusImpl never removed from ThreadLocal, generates permgen out of memory error after some redeployments</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bharathganesh">Bharath Ganesh</assignee>
                                    <reporter username="mably">Francois Masurel</reporter>
                        <labels>
                    </labels>
                <created>Wed, 8 Apr 2009 08:56:43 +0000</created>
                <updated>Thu, 9 Sep 2010 12:20:58 +0000</updated>
                            <resolved>Fri, 22 May 2009 14:00:32 +0000</resolved>
                                    <version>2.1.4</version>
                                    <fixVersion>2.2.2</fixVersion>
                                    <component>Bus</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="12698559" author="dkulp" created="Mon, 13 Apr 2009 21:33:57 +0000"  >
&lt;p&gt;The CXF servlet definitely has a destroy method that calls shutdown:&lt;/p&gt;

&lt;p&gt;   public void destroy() &lt;/p&gt;
{
        String s = bus.getId();
        BUS_MAP.remove(s);
        bus.shutdown(true);
    }

&lt;p&gt;Thus, it LOOKS like the JBoss server isn&apos;t calling destroy on the the redeploy if destroy isn&apos;t being called.    If you can show that is the case, I would definitely   log a bug with them.&lt;/p&gt;
</comment>
                            <comment id="12698569" author="mably" created="Mon, 13 Apr 2009 22:07:04 +0000"  >&lt;p&gt;In fact the thread local variables should be set and removed for each request in a try/finally block (like db connections).  It doesn&apos;t seem to be the case.&lt;/p&gt;

&lt;p&gt;I&apos;ve identified a few other classes setting ThreadLocal variables and not removing them properly.&lt;/p&gt;

&lt;p&gt;I&apos;ve temporarily resolved this problem by using WeakReferences.  Dont know if it has any significant impact on performance, but at least all objects are garbage collected after a redeploy.&lt;/p&gt;</comment>
                            <comment id="12698809" author="mably" created="Tue, 14 Apr 2009 15:35:50 +0000"  >&lt;p&gt;An interesting article (and comments) about ThreadLocal usage and thread pools :&lt;br/&gt;
&lt;a href=&quot;http://www.devwebsphere.com/devwebsphere/2005/06/dont_use_thread.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.devwebsphere.com/devwebsphere/2005/06/dont_use_thread.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12699725" author="bharathganesh" created="Thu, 16 Apr 2009 15:09:56 +0000"  >&lt;p&gt;@Ben Dean&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;But that didn&apos;t work. What I eventually ended up doing was to have the following hack in the&lt;br/&gt;
&amp;gt;&amp;gt;shutdown sequence of our webapp:&lt;br/&gt;
  &amp;gt;&amp;gt;Field field = org.apache.cxf.BussFactory.class.getDeclaredField(&quot;localBus&quot;);&lt;br/&gt;
  &amp;gt;&amp;gt;field.setAccessible(true);&lt;br/&gt;
  &amp;gt;&amp;gt;ThreadLocal&amp;lt;?&amp;gt; localBus = (ThreadLocal&amp;lt;?&amp;gt;) field.get(null);&lt;br/&gt;
  &amp;gt;&amp;gt;localBus.remove();&lt;/p&gt;

&lt;p&gt;If you have done the above in the shutdown sequence of your web app, I assume this code would be executed in the undeployment thread (main thread or some RMI thread in case of remote un-deployment) thread of JBoss. The localbus threadlocal would not be initialized for this thread. As far as I understand, there wont be any effect of doing the localBus.remove() in that thread. So there is something else that is fixing your issue.&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;localBus.remove();&lt;br/&gt;
Yes, The advantage of using this (added in Java SE 5) would be that the complete entry would be removed from the ThreadLocalMap, not just the value. But this will not result in a very significant improvement in memory, as the value is anyways GC&apos;ed even when you do cxfBus.shutdown().&lt;/p&gt;

&lt;p&gt;@Francois&lt;br/&gt;
&amp;gt;&amp;gt;In fact the thread local variables should be set and removed for each request in a try/finally block (like db connections). It doesn&apos;t seem to be the case.&lt;br/&gt;
Yes, I am looking at those places and seeing what can be done, to make sure we don&apos;t keep anything in the web-worker thread beyond the scope of the request .&lt;/p&gt;</comment>
                            <comment id="12699862" author="dkulp" created="Thu, 16 Apr 2009 21:04:56 +0000"  >

&lt;p&gt;&amp;gt;In fact the thread local variables should be set and removed for each request in a try/finally block (like db connections). It doesn&apos;t seem to be the case. &lt;br/&gt;
&amp;gt;I&apos;ve identified a few other classes setting ThreadLocal variables and not removing them properly. &lt;/p&gt;

&lt;p&gt;If you find issues like that, PLEASE log a bug here or, preferrably , provide a patch so we can get them fixed.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="12699899" author="mably" created="Thu, 16 Apr 2009 22:05:54 +0000"  >&lt;p&gt;Thanx again for taking my issue in consideration.&lt;/p&gt;

&lt;p&gt;I sadly dont know much about CXF internals to really understand why these threadlocal variables aren&apos;t removed, just made a few investigations using JProfiler heap walker tool.&lt;/p&gt;

&lt;p&gt;I&apos;m on holidays at the moment, will try to send more information as soon as I&apos;m back to work.&lt;/p&gt;
</comment>
                            <comment id="12700143" author="mably" created="Fri, 17 Apr 2009 11:58:00 +0000"  >&lt;p&gt;My patch against 2.1.4 version which circumvent thread local variables from not being garbage collected on application redeploy.  Hoping it can help tracing down the problem.&lt;/p&gt;</comment>
                            <comment id="12701185" author="dkulp" created="Tue, 21 Apr 2009 16:02:18 +0000"  >
&lt;p&gt;Unfortunately, nothing in the patch will really work per spec.&lt;/p&gt;

&lt;p&gt;The changes to the WebServiceContextImpl should not be needed.   I checked an every single place we call setMessageContext in the code, we have a finally block that calls  clear.    Thus, that thread local should always be properly cleared.   (except on of the test cases, but that&apos;s not relevant)&lt;/p&gt;


&lt;p&gt;The changes to BindingProviderImpl and ClientImpl woudl not work.    If I do:&lt;/p&gt;

&lt;p&gt;((BindingProvider)port).getRequestContext().put(......);&lt;br/&gt;
foo = port.echoFoo(foo);&lt;br/&gt;
((BindingProvider)port).getRequestContext().get(...)&lt;/p&gt;

&lt;p&gt;If a garbage collection triggeres between any of the lines above, the contexts would get cleared out and the expected behavior would not occur.&lt;/p&gt;</comment>
                            <comment id="12701414" author="mably" created="Wed, 22 Apr 2009 07:25:01 +0000"  >&lt;p&gt;Hi Daniel,&lt;/p&gt;

&lt;p&gt;I&apos;ve put back the original (non modified) jars of CXF 2.1.4 and did a few redeploys on our Spring-CXF web app.  Threadlocal issues are back.&lt;/p&gt;

&lt;p&gt;Attachments contains what I get from JProfiler (latest version 5.2.1).&lt;/p&gt;

&lt;p&gt;Configuration : Tomcat 6.0.18, Sun JDK 1.5.0_17-b04, Windows XP, Spring 2.0.8&lt;/p&gt;</comment>
                            <comment id="12702284" author="mably" created="Fri, 24 Apr 2009 08:19:49 +0000"  >&lt;p&gt;Willing to help, I&apos;ve tried to dig a bit deeper in the code.&lt;/p&gt;

&lt;p&gt;There is no try/finally around WebServiceContextImpl.setMessageContext and WebServiceContextImpl.clear in org.apache.cxf.jaxws.JAXWSMethodInvoker invoke method.  But as long no exception is throw in between it should&apos;nt be a problem.&lt;/p&gt;

&lt;p&gt;In org.apache.cxf.jaxws.BindingProviderImpl, requestContext and responseContext threadlocal variables don&apos;t seem to be cleared anywhere, there is a strange protected clearContext method which doesn&apos;t seem to be called from anywhere.&lt;/p&gt;

&lt;p&gt;Same for org.apache.cxf.endpoint.ClientImpl.  No call to set(null) method in the code for these threadlocal variables.&lt;/p&gt;

&lt;p&gt;This might be the cause of our problems.&lt;/p&gt;

&lt;p&gt;Some kind of clear() method needs to be implemented for these two classes.&lt;/p&gt;

&lt;p&gt;Is there any architectural constraints for these methods not being implemented and used ?&lt;/p&gt;</comment>
                            <comment id="12702424" author="dkulp" created="Fri, 24 Apr 2009 15:54:50 +0000"  >
&lt;p&gt;From a IM chat I had with Bharath:   (posted here so all can benefit)&lt;/p&gt;

&lt;p&gt;(11:00:12) rbharathganesh: What Francois Masurel is saying about the ThreadLocal leak seems to be correct&lt;br/&gt;
(11:00:39) rbharathganesh: If you look at ClientImpl we never unset the req and resp contexts&lt;br/&gt;
(11:00:39) jdkulp: Yea, I&apos;m just not sure how to go about fixing it.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
(11:00:49) rbharathganesh: I have something in mind&lt;br/&gt;
(11:00:59) rbharathganesh: Just wanted to confirm with you before doing it&lt;br/&gt;
(11:01:27) jdkulp: The part in the WebServiceContext server side should already be fixed.&lt;br/&gt;
(11:01:35) rbharathganesh: If you look at his latest comment on the bug: &lt;br/&gt;
(11:01:35) jdkulp: I think he&apos;s looking at 2.1.4 code.&lt;br/&gt;
(11:01:36) rbharathganesh: //There is no try/finally around WebServiceContextImpl.setMessageContext and WebServiceContextImpl.clear in org.apache.cxf.jaxws.JAXWSMethodInvoker invoke method. But as long no exception is throw in between it should&apos;nt be a problem. &lt;br/&gt;
(11:01:41) rbharathganesh: This is incorrect&lt;br/&gt;
(11:01:48) rbharathganesh: We have already fixed this&lt;br/&gt;
(11:01:49) rbharathganesh: Oh yes&lt;br/&gt;
(11:01:56) jdkulp: Yea.   It WAS broken in 2.1.4.&lt;br/&gt;
(11:01:58) rbharathganesh: Sorry did not rread what you typed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
(11:02:39) rbharathganesh: But yes the second part seems to be right&lt;br/&gt;
(11:03:07) jdkulp: Yea.   If you have a good idea to fix it, I&apos;m all ears.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
(11:03:31) jdkulp: Maybe a weak ref in the thread local and a strong ref in the ClientImpl?&lt;br/&gt;
(11:04:22) rbharathganesh: hmmm.. But how about explicitly  clearing it in JaxWsClientProxy?&lt;br/&gt;
(11:04:45) jdkulp: The issue is &quot;when to clear it&quot;.&lt;br/&gt;
(11:05:41) rbharathganesh: In JaxWsClientProxy#invoke(), Before retuning the result to the user? &lt;br/&gt;
(11:06:40) jdkulp: You cannot clear the response context then.&lt;br/&gt;
(11:06:53) jdkulp: Or they obviously couldn&apos;t get the response stuff.&lt;br/&gt;
(11:07:23) jdkulp: Plus, if you make 3 invokes, the original stuff in the context needs to still be used.&lt;br/&gt;
(11:09:15) rbharathganesh: Dan I guess I am missing something&lt;br/&gt;
(11:09:21) rbharathganesh: // if you make 3 invokes, the original stuff in the context needs to still be used.&lt;br/&gt;
(11:09:23) jdkulp: or I am...  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
(11:10:04) rbharathganesh: Is there any state to be maintained beyond the scope of the invoke method?&lt;br/&gt;
(11:10:22) jdkulp: The state of the request context is for ALL invokes on that thread.&lt;br/&gt;
(11:10:24) jdkulp: So yes.&lt;br/&gt;
(11:10:39) jdkulp: If I set the ENDPOINT_URL in the request context, then call invoke 10 times, all 10 should go to that URL.&lt;br/&gt;
(11:10:54) rbharathganesh: Oh Yes!&lt;br/&gt;
(11:16:41) jdkulp: One option could be to use a WeakHashMap&amp;lt;Thread, Map&amp;lt;...&amp;gt;&amp;gt; in client impl instead of thread locals.&lt;br/&gt;
(11:17:03) jdkulp: Thus, when clientImpl is garbage collected, so would that map and everything it points to.&lt;br/&gt;
(11:17:30) rbharathganesh: Yeah....&lt;br/&gt;
(11:17:33) jdkulp: If a thread goes away, it&apos;s map would be gc&apos;d&lt;br/&gt;
(11:18:47) rbharathganesh: In his case, the clientImpl goes away right?&lt;br/&gt;
(11:18:54) jdkulp: I assume so.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
(11:19:09) jdkulp: I think when the war/app is undeployed, it should go away.&lt;br/&gt;
(11:19:11) rbharathganesh: The thread going away would mostly never happen right?&lt;br/&gt;
(11:19:33) jdkulp: Maybe, maybe not.    It could be a workqueue that grows/shrinks on demand.&lt;br/&gt;
(11:19:38) rbharathganesh: The web server would anyway pool these threads&lt;br/&gt;
(11:19:40) rbharathganesh: yeah right&lt;br/&gt;
(11:19:40) jdkulp: In which case it COULD go away.&lt;br/&gt;
(11:19:46) rbharathganesh: Yeah&lt;/p&gt;</comment>
                            <comment id="12702480" author="mably" created="Fri, 24 Apr 2009 18:35:36 +0000"  >&lt;p&gt;Sounds good to me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Just keep in mind that the CXF jars can be shared across several webapps (ex : Tomcat common/lib), so classes might not be gc&apos;d on redeploys, only instances, so beware of static fields (it&apos;s not the case for ClientImpl and BindingProviderImpl).&lt;/p&gt;</comment>
                            <comment id="12712092" author="bharathganesh" created="Fri, 22 May 2009 14:00:32 +0000"  >&lt;p&gt;We now maintain the request and response context in a WeakHashMap. This will would enable them eligible for garbage collection when the ClientImpl itself gets GC&apos;d (during application undeployment). &lt;/p&gt;</comment>
                            <comment id="12714733" author="mably" created="Sat, 30 May 2009 15:44:28 +0000"  >&lt;p&gt;We did some profiling tests with the recently released 2.2.2  version of CXF and it seems like we dont have memory leaks anymore as we had with version 2.1.4 after a few webapp redeployments.  Thanx for all !&lt;/p&gt;</comment>
                            <comment id="12714737" author="bharathganesh" created="Sat, 30 May 2009 16:08:23 +0000"  >&lt;p&gt;Francois Masurel has verified that the fix has solved the issue. &lt;/p&gt;</comment>
                            <comment id="12907265" author="mauromol" created="Wed, 8 Sep 2010 15:42:47 +0000"  >&lt;p&gt;I don&apos;t know if it&apos;s better to reopen this bug or to file a new one.&lt;br/&gt;
I still have problems with ThreadLocals not being released.&lt;/p&gt;

&lt;p&gt;The problem is that cxf.xml declares the following bean:&lt;/p&gt;

&lt;p&gt;&amp;lt;bean id=&quot;cxf&quot; class=&quot;org.apache.cxf.bus.CXFBusImpl&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;Here, the destroy-method is not declared. This means that when Sping shuts down the context, it does not call any shutdown method on the CXFBusImpl.&lt;/p&gt;

&lt;p&gt;This has nothing to do with the init and destroy methods of the CXFServlet, which might occur in different threads. Moreover, I see the problem even if I don&apos;t start the CXFServlet at all (no load-on-startup).&lt;/p&gt;

&lt;p&gt;The net result is the following:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Tomcat starts&lt;/li&gt;
	&lt;li&gt;Tomcat starts my web application&lt;/li&gt;
	&lt;li&gt;this declares a Spring web application context that gets parsed&lt;/li&gt;
	&lt;li&gt;at some point cxf.xml is parsed, so the bean named cxf is created and an org.apache.cxf.bus.CXFBusImpl instance is created using the constructor org.apache.cxf.bus.CXFBusImpl.CXFBusImpl(Map&amp;lt;Class, Object&amp;gt;), which causes the org.apache.cxf.BusFactory.localBus ThreadLocal to be assigned a value of this type, through a call to org.apache.cxf.BusFactory.possiblySetDefaultBus(Bus); I see that this happens in a thread called &quot;main&quot;&lt;/li&gt;
	&lt;li&gt;if I stop the web application, Spring closes down the context; however, as I said before, this does not cause any shutdown method of the cxf bean to be called&lt;/li&gt;
	&lt;li&gt;so there&apos;s no null-setting or removing operation of the org.apache.cxf.BusFactory.localBus ThreadLocal for the thread &quot;main&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think the easiest fix is to modify the cxf bean definition in this way:&lt;br/&gt;
&amp;lt;bean id=&quot;cxf&quot; class=&quot;org.apache.cxf.bus.CXFBusImpl&quot; destroy-method=&quot;shutdown&quot;/&amp;gt;&lt;br/&gt;
However, org.apache.cxf.bus.CXFBusImpl.shutdown(boolean) should be refactored so that it does not take the boolean parameter (it&apos;s not used actually), otherwise an overloading of this method without parameters should be provided.&lt;/p&gt;

&lt;p&gt;However, this will work with the assumption that the Spring context load and shutdown operations are both executed in the same thread. I don&apos;t know if this is guaranteed by the servlet specifications or not (I&apos;m using the org.springframework.web.context.ContextLoaderListener servlet listener to handle the lifecycle of the webapp application context). A better fix could be to avoid to hold state information for the CXFBusImpl in this way (i.e.: why does a constructor set a ThreadLocal and leave it there???).&lt;/p&gt;

&lt;p&gt;Please note I&apos;m working with CXF 2.2.10.&lt;/p&gt;</comment>
                            <comment id="12907283" author="mauromol" created="Wed, 8 Sep 2010 16:21:30 +0000"  >&lt;p&gt;I must correct myself. As the original reporter said, the call to shutdown does not resolve the problem, because I just saw that it does not unset the ThreadLocal, but simply sets to null an internal property (defaultBus).&lt;/p&gt;

&lt;p&gt;The bad news is that I just realized that the shutdown sequence can actually be made on a different thread: that is, the context may be created in thread &quot;main&quot;, but destroyed in thread htttp-8080-1 (the one that serves my request to stop the web application in the Tomcat Manager application).&lt;/p&gt;

&lt;p&gt;So, I don&apos;t see any straight way to fix this problem without thinking about the reason of that ThreadLocal. Maybe the method org.apache.cxf.BusFactory.setDefaultBus(Bus) should at least let the user specify whether the TheadLocal localBus property should also be set together with the defaultBus property. After that, maybe the constructor of CXFBusImpl should set only the default bus property, not the localBus one. Or at least this should happen just for the CXFBusImpl instance created by cxf.xml Spring application context....&lt;/p&gt;

&lt;p&gt;Mauro.&lt;/p&gt;</comment>
                            <comment id="12907346" author="dkulp" created="Wed, 8 Sep 2010 18:12:58 +0000"  >
&lt;p&gt;Definitely log a new bug for this.&lt;/p&gt;

&lt;p&gt;I&apos;m thinking we MAY need to do the same thing we did for the request/response objects in the ClientImpl of using  something like:&lt;/p&gt;

&lt;p&gt;protected Map&amp;lt;Thread, Bus&amp;gt; threadBusses &lt;br/&gt;
        = Collections.synchronizedMap(new WeakHashMap&amp;lt;Thread, Bus&amp;gt;());&lt;/p&gt;

&lt;p&gt;The destroy method could walk the map and remove any keys that are associated with that Bus.   &lt;/p&gt;

&lt;p&gt;Anyway, please log a new bug.   A patch would be great as well. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
</comment>
                            <comment id="12907610" author="mauromol" created="Thu, 9 Sep 2010 12:20:58 +0000"  >&lt;p&gt;Thank you Daniel, I opened bug &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-2985&quot; title=&quot;Memory leak when initializing CXF throughSpring&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-2985&quot;&gt;&lt;del&gt;CXF-2985&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12406104" name="Heap_Walker_Incoming_References.zip" size="9087" author="mably" created="Wed, 22 Apr 2009 07:25:01 +0000"/>
                            <attachment id="12406103" name="cxf_threadlocal.jpg" size="118045" author="mably" created="Wed, 22 Apr 2009 07:25:01 +0000"/>
                            <attachment id="12405756" name="threadlocal.patch" size="31140" author="mably" created="Fri, 17 Apr 2009 11:58:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>113612</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 11 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14erb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>233854</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>