<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:40:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-2619] Deadlock when echoing MTOM attachments back to client</title>
                <link>https://issues.apache.org/jira/browse/CXF-2619</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;I&apos;ve written a simple &quot;echo&quot; web service, which receives an attachment and echoes it back. In CXF 2.2.2 and earlier, this works OK. Starting with CXF 2.2.3, however, there is a somewhat unpredictable deadlock situation which occurs with MTOM attachments, which causes the web server to deadlock, so that it never responds to the request.&lt;/p&gt;

&lt;p&gt;This situation often occurs when the attachment is around 85 kilobytes or greater in size. However, this boundary is not 100% consistent. Sometimes I can successfully echo attachments up to 88 kilobytes in size, and sometimes smaller attachments trigger the bug.&lt;/p&gt;

&lt;p&gt;The behavior only occurs if the same input stream is reused. Copying the input into a new input stream circumvents the error. I&apos;ve verified this behavior began with CXF 2.2.3, and is still present in the latest 2.2.6-SNAPSHOT.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows XP&lt;/p&gt;</environment>
        <key id="12445662">CXF-2619</key>
            <summary>Deadlock when echoing MTOM attachments back to client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dkulp">Daniel Kulp</assignee>
                                    <reporter username="piepera">aaron pieper</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Jan 2010 19:24:06 +0000</created>
                <updated>Mon, 1 Feb 2010 19:02:26 +0000</updated>
                            <resolved>Tue, 19 Jan 2010 18:40:08 +0000</resolved>
                                    <version>2.2.3</version>
                    <version>2.2.4</version>
                    <version>2.2.5</version>
                    <version>2.2.6</version>
                                    <fixVersion>2.1.9</fixVersion>
                    <fixVersion>2.2.6</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12800854" author="piepera" created="Fri, 15 Jan 2010 19:27:32 +0000"  >&lt;p&gt;A maven module demonstrating the issue. This uses CXF v2.2.3, and relies on several aspects of CXF. It generates Java stubs using CXF, and uses the CXF jetty transport for its test case.&lt;/p&gt;

&lt;p&gt;I see the following results after executing an mvn clean install:&lt;/p&gt;

&lt;p&gt;Running frt.impl.LargeFileTest&lt;br/&gt;
Tests run: 8, Failures: 0, Errors: 2, Skipped: 0, Time elapsed: 32.062 sec &amp;lt;&amp;lt;&amp;lt; FAILURE!&lt;/p&gt;

&lt;p&gt;Results :&lt;/p&gt;

&lt;p&gt;Tests in error:&lt;br/&gt;
  testCanHandle100KilobyteMtomUpload(frt.impl.LargeFileTest)&lt;br/&gt;
  testCanHandle500KilobyteMtomUpload(frt.impl.LargeFileTest)&lt;/p&gt;

&lt;p&gt;Tests run: 8, Failures: 0, Errors: 2, Skipped: 0&lt;/p&gt;</comment>
                            <comment id="12800870" author="dkulp" created="Fri, 15 Jan 2010 19:39:37 +0000"  >

&lt;p&gt;This is really &quot;working as designed&quot;.   Prior to 2.2.3, attachments were all buffered (onto disk for &amp;gt;64K, memory otherwise) when read in. &lt;br/&gt;
No real &quot;steaming&quot; was done on the incoming side.    Thus, by the time the method on your server impl was invoked, the client was done sending things and had started attempting to read from the input stream.&lt;/p&gt;

&lt;p&gt;With 2.2.3, we introduced pure streaming of incoming attachments which is what is ideal for MOST use cases as it gets into the real logic earlier and performs much better as nothing is buffered anywhere.  However, that runs into a problem in your usecase.    Basically, in your case, the client is still trying to write the attachment to it&apos;s OutputStream.   It hasn&apos;t yet started trying to read from the InputStream.  However, your server has started writing.   The outgoing buffers fill and it deadlocks waiting for the client to read.&lt;/p&gt;

&lt;p&gt;We COULD add a configuration parameter to turn off the incoming streaming, although you would achieve the same result by buffering it yourself as you mentioned.&lt;/p&gt;

&lt;p&gt;Another option is to just configure in the SAAJInInterceptor or schema-validation.   I believe both of them require the attachments to be pulled in and buffered as well. &lt;/p&gt;

</comment>
                            <comment id="12800872" author="dkulp" created="Fri, 15 Jan 2010 19:41:11 +0000"  >&lt;p&gt;&lt;br/&gt;
Another option MIGHT be to detect the first write to the output stream on the server side and have that trigger a buffering of everything on the incoming side.   Something for me to ponder...............&lt;/p&gt;</comment>
                            <comment id="12800881" author="piepera" created="Fri, 15 Jan 2010 19:50:08 +0000"  >&lt;p&gt;Hmm okay that sounds like a good change, I can see how that would improve performance for most use cases. This is kind of a peculiar edge case, this kind of a servlet isn&apos;t very practical in production - we merely use it for our unit tests to make sure we handle incoming/outgoing attachments properly.&lt;/p&gt;

&lt;p&gt;Both of your suggested solutions seem OK (a configuration step, or detecting the first write) - although it seems like no matter what, you&apos;d want to detect the potential for deadlock, and either prebuffer the attachment or just throw some kind of a human-readable error with some text describing the issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12430428" name="frt.zip" size="9675" author="piepera" created="Fri, 15 Jan 2010 19:27:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10063"><![CDATA[Advanced]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>114018</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 45 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0sy07:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>166986</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>