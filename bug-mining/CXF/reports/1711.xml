<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 11:59:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-4891] Cannot set content-type header</title>
                <link>https://issues.apache.org/jira/browse/CXF-4891</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;From within an interceptor I am trying to alter the content-type simply to add a few parameters to the response header. I have attempted multiple ways to do so, across several Phases.&lt;/p&gt;

&lt;p&gt;Firstly, there are examples on the web of setting the header using Message.put(Message.CONTENT_TYPE, &quot;whatever&quot;). This simply does not work. I then wrote the header using aMessage.put(Message.PROTOCOL_HEADERS, arrayOfWhatever). This appears to work, but it&apos;s a lie. In the CXF response logging I see what appears to be what I want:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ID: 18
Response-Code: 200
Content-Type: text/plain;charset=UTF-8;version=1.0.0-SNAPSHOT
Headers: {Expires=[-1], Cache-Control=[no-cache], Pragma=[no-cache], Content-Type=[text/plain], Date=[Tue, 12 Mar 2013 20:37:43 GMT]}
Payload: 1.0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, this must be getting overwritten between this logging statement and my client because the browser only displays text/plain. Thinking this was just a browser error I used Firfox and curl, both resulted in the same value of text/plain being returned.&lt;/p&gt;

&lt;p&gt;I have only been able to get the actual values changed by grabbing the HTTPServletResponse using HttpServletResponse response = (HttpServletResponse) m.get(AbstractHTTPDestination.HTTP_RESPONSE); and setting the content-type via response.setHeader(HttpHeaders.CONTENT_TYPE, contentType);. However, this doesn&apos;t work right. First of all, it won&apos;t work if you attempt to write the content type after MARSHAL because the stream has already been written to. And if you attempt to write the value before MARSHAL, then when you attempt to pull the content-type from the Message, you&apos;ll get a default content-type (I believe text/xml) value other than what the body is. That is, if the content was marshalled to JSON, you will not get application/json as expected.&lt;/p&gt;

&lt;p&gt;I have been over this for two days. I have attempted to use JAXRS handlers with similar results. I simply do not see a way to affect the headers as I need to.&lt;/p&gt;

&lt;p&gt;I originally ran against 2.6.2, but was hoping that 2.7.3 corrected this. Unfortunately both version exhibit this behavior.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12636655">CXF-4891</key>
            <summary>Cannot set content-type header</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sergey_beryozkin">Sergey Beryozkin</assignee>
                                    <reporter username="redijedi">Todd Orr</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Mar 2013 20:58:52 +0000</created>
                <updated>Tue, 9 Apr 2013 15:15:51 +0000</updated>
                            <resolved>Wed, 20 Mar 2013 11:29:45 +0000</resolved>
                                    <version>2.6.2</version>
                    <version>2.7.3</version>
                                    <fixVersion>2.7.4</fixVersion>
                    <fixVersion>3.0.0-milestone1</fixVersion>
                                    <component>JAX-RS</component>
                    <component>Transports</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13600470" author="sergey_beryozkin" created="Tue, 12 Mar 2013 21:04:28 +0000"  >&lt;p&gt;For now, setting both PROTOCOL_HEADERS &amp;amp; CONTENT_TYPE before MARSHAL really has to work, give that a try please.&lt;br/&gt;
I&apos;ll add a test as well and will get back to you &lt;/p&gt;</comment>
                            <comment id="13600487" author="redijedi" created="Tue, 12 Mar 2013 21:22:00 +0000"  >&lt;p&gt;Thanks for the speedy response. I have tried this, and just reverified. The issue is that since this phase is prior to marshalling, CXF doesn&apos;t know what type of marshalling has taken place. That is, it never updated the content-type to application/json (in the case that I am requesting a JSON resource). So when I read the content-type from the message to then append the charset, etc. I only see the default. Then when I set the content-type back into the message and protocol_headers, it is text/xml.&lt;/p&gt;</comment>
                            <comment id="13600504" author="sergey_beryozkin" created="Tue, 12 Mar 2013 21:34:33 +0000"  >&lt;p&gt;Do you expect the runtime already setting the right media type, before you attempt to modify it ?&lt;br/&gt;
In CXF 2.7.x, JAX-RS 2.0 ContainerResponseFilter or WriterInterceptor should be able to help, they run before the marshalling but after JAXRSOutInterceptor sets up the headers, can you try either of these 2 options, though I will also add a test asap &lt;/p&gt;</comment>
                            <comment id="13600517" author="sergey_beryozkin" created="Tue, 12 Mar 2013 21:47:49 +0000"  >&lt;p&gt;OK, that path is broken too; will be fixed; I&apos;m presuming you can not use Response or even Produces(&quot;application/json;charset=somevalue&quot;)&lt;/p&gt;</comment>
                            <comment id="13600604" author="redijedi" created="Tue, 12 Mar 2013 23:18:57 +0000"  >&lt;p&gt;I can&apos;t use Produces because some of the values are dynamic. I would like to find a way to not use Responses because we have a large number of responses and I would not like to have switches in each method for each supported mime type.&lt;/p&gt;

&lt;p&gt;I suppose for the time being I can use a servlet filter, but that is definitely a workaround. Thanks for looking into this!&lt;/p&gt;</comment>
                            <comment id="13603396" author="sergey_beryozkin" created="Fri, 15 Mar 2013 14:02:27 +0000"  >&lt;p&gt;FYI, this is mostly resolved, however I had to change JAXRSOutInterceptor along the way quite a lot as this issue highlighted it was not able to meet some of ContainerResponseContext&apos;s method requirements, so it is a bit time consuming indeed&lt;/p&gt;</comment>
                            <comment id="13603556" author="sergey_beryozkin" created="Fri, 15 Mar 2013 17:30:17 +0000"  >&lt;p&gt;Hi, most of the updates went into 2.8.x so far, and I&apos;m not really sure I want them pushed down to 2.7.x as they are quite sensitive given that the way response content type is calculated has completely changed.&lt;/p&gt;

&lt;p&gt;However, there is actually a JAX-RS compliant way to get the response content type (already correctly determined by the runtime) updated, before the serialization takes place, this is possible to do from a custom message body writer.&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;http://svn.apache.org/r1457026&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1457026&lt;/a&gt; for one example. This works on 2.7.x too.&lt;br/&gt;
Can you try this option please ?&lt;/p&gt;

</comment>
                            <comment id="13606735" author="redijedi" created="Tue, 19 Mar 2013 20:19:49 +0000"  >&lt;p&gt;The MessageBodyWriter approach works for my simple case of adding charset, but I also have a need to look at the marshalled object to discover and analyze a number of annotations. I&apos;d end up having to perform the marshalling myself, which would be redundant.&lt;/p&gt;</comment>
                            <comment id="13607522" author="sergey_beryozkin" created="Wed, 20 Mar 2013 11:28:32 +0000"  >&lt;p&gt;Sure, I went ahead and merged the actual changes to 2.7.x - I thought I&apos;d rather keep them on the trunk only but given that ContainerResponseFilter and WriterInterceptor chains are not run correctly on 2.7.x the changes have to make it into 2.7.x.&lt;/p&gt;

&lt;p&gt;In CXF 2.7.4 you will be able to use JAX-RS 2.0 ContainerResponseFilter to check the entity and update the media type as needed - please give it a try with CXF 2.7.4-SNAPSHOT in a few days and reopen the JIRA if it does not work as expected.&lt;/p&gt;

&lt;p&gt;Also, note that one can write a delegating MBW which will do exactly the same but indeed it will require more effort, for example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyWriter &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; MessageBodyProvider {
   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; ACTIVE_JAXRS_PROVIDER_KEY = &lt;span class=&quot;code-quote&quot;&gt;&quot;active.jaxrs.provider&quot;&lt;/span&gt;;

   @Context
   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Providers providers;

   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void writeTo(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; obj, &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt; type, Type genericType, Annotation[] anns, MediaType mt,
                        MultivaluedMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; headers, OutputStream os) 
        &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, WebApplicationException {

        &lt;span class=&quot;code-comment&quot;&gt;// to avoid the recursive calls
&lt;/span&gt;        Message currentMessage = PhaseInterceptorChain.getCurrentMessage(); 
        currentMessage.put(ACTIVE_JAXRS_PROVIDER_KEY, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
        
        MessageBodyWriter&amp;lt;T&amp;gt; r = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            r = mc.getProviders().getMessageBodyWriter(type, genericType, anns, mt);
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            currentMessage.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;active.jaxrs.provider&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;); 
        }
        &lt;span class=&quot;code-comment&quot;&gt;// check the object, update mt as needed
&lt;/span&gt;        r.writeTo(obj, type, genericType, anns, mt, headers, os);  
   }

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This will work on 2.7.3&lt;/p&gt;</comment>
                            <comment id="13608886" author="redijedi" created="Thu, 21 Mar 2013 12:56:52 +0000"  >&lt;p&gt;I&apos;ve updated my version to 2.7.4-SNAPSHOT and converted some code to use the ContainerResponseFilter. This approach has been met with initial excitement at the ease of use, but then disappointment at the end result. As best as I can tell, String contentType = responseContext.getHeaderString(HttpHeaders.CONTENT_TYPE); returns null when called during a response. I then attempt to reference responseContext.getMediaType(), but this is also null. &lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="13609419" author="sergey_beryozkin" created="Thu, 21 Mar 2013 20:21:46 +0000"  >&lt;p&gt;Well, I have the end to end test where the content type is modified first by ContainerResponseFilter and then WriterInterceptor and it all works as expected.&lt;br/&gt;
I wonder if the snapshot you&apos;ve picked up does not contain the right changes yet ?&lt;/p&gt;

&lt;p&gt;Can you retry please ? I do expect it to work...&lt;/p&gt;

&lt;p&gt;If that does not work - can you try to create a simple test case (maven based if possible or simply create a basic war) ?&lt;/p&gt;


</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>317147</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 35 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1iq3b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>317488</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>