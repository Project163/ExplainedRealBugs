<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:31:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-7716] IBM Performance Team has found several performance increases</title>
                <link>https://issues.apache.org/jira/browse/CXF-7716</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Our performance team has identified several areas of improvement to reduce garbage collection and CPU usage.&lt;/p&gt;

&lt;p&gt;First, we reduced the amount of StringBuilders created in HTTPUtils.java&#160;and ResourceUtils.java.&lt;/p&gt;

&lt;p&gt;Second, we created JAXRSUtils.doMimeTypesIntersect() - a method similar to JAXRSUtils.intersectMimeTypes - that doesn&apos;t create a HashSet but instead returns a boolean when we just need to know if they intersect.&lt;/p&gt;

&lt;p&gt;Third, we found that getting the annotations for parameters to create constructor arguments in PerRequestResourceProvider.java is expensive, so we cache them in the constructor instead of getting them via reflection every request.&lt;/p&gt;

&lt;p&gt;These changes combined result in a ~1.5-2% performance increase.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13153393">CXF-7716</key>
            <summary>IBM Performance Team has found several performance increases</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="atanders">Adam Anderson</reporter>
                        <labels>
                    </labels>
                <created>Wed, 18 Apr 2018 16:13:03 +0000</created>
                <updated>Mon, 25 Mar 2019 12:28:33 +0000</updated>
                            <resolved>Fri, 11 May 2018 02:03:30 +0000</resolved>
                                    <version>3.1.15</version>
                    <version>3.2.4</version>
                                    <fixVersion>3.1.16</fixVersion>
                    <fixVersion>3.2.5</fixVersion>
                                    <component>JAX-RS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="3600">1h</timeoriginalestimate>
                            <timeestimate seconds="3600">1h</timeestimate>
                                        <comments>
                            <comment id="16442966" author="githubbot" created="Wed, 18 Apr 2018 18:09:47 +0000"  >&lt;p&gt;WhiteCat22 opened a new pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   The IBM performance team has identified several areas of improvement to reduce garbage collection and CPU usage.&lt;/p&gt;

&lt;p&gt;   First, we reduced the amount of StringBuilders created in HTTPUtils.java and ResourceUtils.java.&lt;/p&gt;

&lt;p&gt;   Second, we created JAXRSUtils.doMimeTypesIntersect() - a method similar to JAXRSUtils.intersectMimeTypes - that doesn&apos;t create a HashSet but instead returns a boolean when we just need to know if they intersect.&lt;/p&gt;

&lt;p&gt;   Third, we found that getting the annotations for parameters to create constructor arguments in PerRequestResourceProvider.java is expensive, so we cache them in the constructor instead of getting them via reflection every request.&lt;/p&gt;

&lt;p&gt;   These changes combined result in a ~1.5-2% performance increase.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16443447" author="githubbot" created="Thu, 19 Apr 2018 01:41:28 +0000"  >&lt;p&gt;reta commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r182614831&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r182614831&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/ResourceUtils.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -816,12 +816,23 @@ private static UserOperation getOperationFromElement(Element e) {&lt;br/&gt;
                                                       Message m,&lt;br/&gt;
                                                       boolean perRequest,&lt;br/&gt;
                                                       Map&amp;lt;Class&amp;lt;?&amp;gt;, Object&amp;gt; contextValues) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (m == null) 
{
-            m = new MessageImpl();
-        }
&lt;p&gt;         Class&amp;lt;?&amp;gt;[] params = c.getParameterTypes();&lt;br/&gt;
         Annotation[][] anns = c.getParameterAnnotations();&lt;br/&gt;
         Type[] genericTypes = c.getGenericParameterTypes();&lt;br/&gt;
+        return createConstructorArguments(c, m, perRequest, contextValues, params, anns, genericTypes);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    public static Object[] createConstructorArguments(Constructor&amp;lt;?&amp;gt; c,&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Are those new arguments (`params`, `anns`, `genericTypes`) used by the method?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16443455" author="githubbot" created="Thu, 19 Apr 2018 01:49:24 +0000"  >&lt;p&gt;reta commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r182615636&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r182615636&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/model/URITemplate.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -130,10 +130,31 @@ public String getPatternValue() {&lt;/p&gt;

&lt;p&gt;     private static String escapeCharacters(String expression) {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;StringBuilder sb = new StringBuilder();&lt;/li&gt;
	&lt;li&gt;for (int i = 0; i &amp;lt; expression.length(); i++) {&lt;/li&gt;
	&lt;li&gt;char ch = expression.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;/li&gt;
	&lt;li&gt;sb.append(isReservedCharacter(ch) ? &quot;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&quot; + ch : ch);&lt;br/&gt;
+        int length = expression.length();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   My apologies but this implementation is not very convincing to me, I think we could just pre-allocate `2 * expression.length()` using `StringBuilder ` constructor (worst case when all characters are reserved) and keep the previous one?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16444084" author="githubbot" created="Thu, 19 Apr 2018 14:02:34 +0000"  >&lt;p&gt;WhiteCat22 commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r182756615&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r182756615&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/ResourceUtils.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -816,12 +816,23 @@ private static UserOperation getOperationFromElement(Element e) {&lt;br/&gt;
                                                       Message m,&lt;br/&gt;
                                                       boolean perRequest,&lt;br/&gt;
                                                       Map&amp;lt;Class&amp;lt;?&amp;gt;, Object&amp;gt; contextValues) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (m == null) 
{
-            m = new MessageImpl();
-        }
&lt;p&gt;         Class&amp;lt;?&amp;gt;[] params = c.getParameterTypes();&lt;br/&gt;
         Annotation[][] anns = c.getParameterAnnotations();&lt;br/&gt;
         Type[] genericTypes = c.getGenericParameterTypes();&lt;br/&gt;
+        return createConstructorArguments(c, m, perRequest, contextValues, params, anns, genericTypes);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    public static Object[] createConstructorArguments(Constructor&amp;lt;?&amp;gt; c,&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Yes, the idea is that we get them once in the PerRequestResourceProvider constructor, vs getting them via reflection every request.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16444089" author="githubbot" created="Thu, 19 Apr 2018 14:07:21 +0000"  >&lt;p&gt;WhiteCat22 commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r182758236&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r182758236&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/model/URITemplate.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -130,10 +130,31 @@ public String getPatternValue() {&lt;/p&gt;

&lt;p&gt;     private static String escapeCharacters(String expression) {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;StringBuilder sb = new StringBuilder();&lt;/li&gt;
	&lt;li&gt;for (int i = 0; i &amp;lt; expression.length(); i++) {&lt;/li&gt;
	&lt;li&gt;char ch = expression.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;/li&gt;
	&lt;li&gt;sb.append(isReservedCharacter(ch) ? &quot;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&quot; + ch : ch);&lt;br/&gt;
+        int length = expression.length();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   The goal is to reduce the number of StringBuilders created in order to reduce GCs and CPU usage. In this case we don&apos;t create a StringBuilder until we are sure that we actually need one, vs creating one that we might not even use.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16445008" author="githubbot" created="Thu, 19 Apr 2018 23:48:22 +0000"  >&lt;p&gt;reta commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r182915164&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r182915164&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/ResourceUtils.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -816,12 +816,23 @@ private static UserOperation getOperationFromElement(Element e) {&lt;br/&gt;
                                                       Message m,&lt;br/&gt;
                                                       boolean perRequest,&lt;br/&gt;
                                                       Map&amp;lt;Class&amp;lt;?&amp;gt;, Object&amp;gt; contextValues) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (m == null) 
{
-            m = new MessageImpl();
-        }
&lt;p&gt;         Class&amp;lt;?&amp;gt;[] params = c.getParameterTypes();&lt;br/&gt;
         Annotation[][] anns = c.getParameterAnnotations();&lt;br/&gt;
         Type[] genericTypes = c.getGenericParameterTypes();&lt;br/&gt;
+        return createConstructorArguments(c, m, perRequest, contextValues, params, anns, genericTypes);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    public static Object[] createConstructorArguments(Constructor&amp;lt;?&amp;gt; c,&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Make sense, thank you.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16445019" author="githubbot" created="Thu, 19 Apr 2018 23:51:58 +0000"  >&lt;p&gt;reta commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r182915735&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r182915735&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/model/URITemplate.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -130,10 +130,31 @@ public String getPatternValue() {&lt;/p&gt;

&lt;p&gt;     private static String escapeCharacters(String expression) {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;StringBuilder sb = new StringBuilder();&lt;/li&gt;
	&lt;li&gt;for (int i = 0; i &amp;lt; expression.length(); i++) {&lt;/li&gt;
	&lt;li&gt;char ch = expression.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;/li&gt;
	&lt;li&gt;sb.append(isReservedCharacter(ch) ? &quot;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&quot; + ch : ch);&lt;br/&gt;
+        int length = expression.length();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Thanks, from this perspective we could consider it as micro-optimization, trading the code readability, I think it is acceptable in this case, the implementation could be understood easily.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16445022" author="githubbot" created="Thu, 19 Apr 2018 23:56:46 +0000"  >&lt;p&gt;reta commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r182916384&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r182916384&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/model/URITemplate.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -130,10 +130,31 @@ public String getPatternValue() {&lt;/p&gt;

&lt;p&gt;     private static String escapeCharacters(String expression) {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;StringBuilder sb = new StringBuilder();&lt;/li&gt;
	&lt;li&gt;for (int i = 0; i &amp;lt; expression.length(); i++) {&lt;/li&gt;
	&lt;li&gt;char ch = expression.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;/li&gt;
	&lt;li&gt;sb.append(isReservedCharacter(ch) ? &quot;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&quot; + ch : ch);&lt;br/&gt;
+        int length = expression.length();&lt;br/&gt;
+        int i = 0;&lt;br/&gt;
+        char ch = &apos; &apos;;&lt;br/&gt;
+        for (; i &amp;lt; length; ++i) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            ch = expression.charAt(i);+            if (isReservedCharacter(ch)) {
+                break;
+            }+        }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+        &lt;br/&gt;
+        if (i == length) &lt;/p&gt;
{
+            return expression;
+        }
&lt;p&gt;+        &lt;br/&gt;
+        StringBuilder sb = new StringBuilder(length + 8);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Why `length + 8`? &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16445411" author="githubbot" created="Fri, 20 Apr 2018 07:13:33 +0000"  >&lt;p&gt;asoldano commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r182964151&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r182964151&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/model/URITemplate.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -130,10 +130,31 @@ public String getPatternValue() {&lt;/p&gt;

&lt;p&gt;     private static String escapeCharacters(String expression) {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;StringBuilder sb = new StringBuilder();&lt;/li&gt;
	&lt;li&gt;for (int i = 0; i &amp;lt; expression.length(); i++) {&lt;/li&gt;
	&lt;li&gt;char ch = expression.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;/li&gt;
	&lt;li&gt;sb.append(isReservedCharacter(ch) ? &quot;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&quot; + ch : ch);&lt;br/&gt;
+        int length = expression.length();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   This being micro-optimization or not should really be supported by benchmark result data. If this is on a hot path, creating less StringBuilder can really make some differences.&lt;br/&gt;
   This said, please note that the fix actually solves 2 issue:&lt;br/&gt;
   1) it avoids creating the StringBuilder when not needed&lt;br/&gt;
   2) it prevents useless StringBuilder instances being created whenever a reserved character is found, as sb.append(isReservedCharacter(ch) ? &quot;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&quot; + ch : ch) internally creates another StringBuilder to perform the &quot;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&quot; + ch concatenation.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16445801" author="githubbot" created="Fri, 20 Apr 2018 14:29:38 +0000"  >&lt;p&gt;WhiteCat22 commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r183068721&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r183068721&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/model/URITemplate.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -130,10 +130,31 @@ public String getPatternValue() {&lt;/p&gt;

&lt;p&gt;     private static String escapeCharacters(String expression) {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;StringBuilder sb = new StringBuilder();&lt;/li&gt;
	&lt;li&gt;for (int i = 0; i &amp;lt; expression.length(); i++) {&lt;/li&gt;
	&lt;li&gt;char ch = expression.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;/li&gt;
	&lt;li&gt;sb.append(isReservedCharacter(ch) ? &quot;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&quot; + ch : ch);&lt;br/&gt;
+        int length = expression.length();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   We don&apos;t have hard numbers at the moment, but all of these changes combined are estimated to improve performance by 1.5%-2% per request.&lt;/p&gt;

&lt;p&gt;   Our JDK team analyzed our performance in order to reduce CPU usage and garbage collection and found that we are creating a large number of StringBuilders. StringBuilders are expensive to use so only using them when we need them will improve performance. Similarly, they found that we were using reflection to get the params every request in ResourceUtils.createConstructorArguments() which is also expensive, hence the change to get the params one time in the constructor.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16445886" author="githubbot" created="Fri, 20 Apr 2018 15:22:14 +0000"  >&lt;p&gt;WhiteCat22 commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r183085465&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r183085465&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/model/URITemplate.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -130,10 +130,31 @@ public String getPatternValue() {&lt;/p&gt;

&lt;p&gt;     private static String escapeCharacters(String expression) {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;StringBuilder sb = new StringBuilder();&lt;/li&gt;
	&lt;li&gt;for (int i = 0; i &amp;lt; expression.length(); i++) {&lt;/li&gt;
	&lt;li&gt;char ch = expression.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;/li&gt;
	&lt;li&gt;sb.append(isReservedCharacter(ch) ? &quot;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&quot; + ch : ch);&lt;br/&gt;
+        int length = expression.length();&lt;br/&gt;
+        int i = 0;&lt;br/&gt;
+        char ch = &apos; &apos;;&lt;br/&gt;
+        for (; i &amp;lt; length; ++i) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            ch = expression.charAt(i);+            if (isReservedCharacter(ch)) {
+                break;
+            }+        }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+        &lt;br/&gt;
+        if (i == length) &lt;/p&gt;
{
+            return expression;
+        }
&lt;p&gt;+        &lt;br/&gt;
+        StringBuilder sb = new StringBuilder(length + 8);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   We do + 8 to allows for up to 8 escaped characters before we start creating more StringBuilders to add on the the String. 8 is an arbitrary limit, but it seems to be sufficient in most cases. We could do something like 256, but that would be overkill since it&apos;s rare that someone would actually have 256 escaped characters.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16445895" author="githubbot" created="Fri, 20 Apr 2018 15:25:55 +0000"  >&lt;p&gt;WhiteCat22 commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r183068721&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r183068721&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/model/URITemplate.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -130,10 +130,31 @@ public String getPatternValue() {&lt;/p&gt;

&lt;p&gt;     private static String escapeCharacters(String expression) {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;StringBuilder sb = new StringBuilder();&lt;/li&gt;
	&lt;li&gt;for (int i = 0; i &amp;lt; expression.length(); i++) {&lt;/li&gt;
	&lt;li&gt;char ch = expression.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;/li&gt;
	&lt;li&gt;sb.append(isReservedCharacter(ch) ? &quot;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&quot; + ch : ch);&lt;br/&gt;
+        int length = expression.length();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   We don&apos;t have hard numbers at the moment, but all of these changes combined are estimated to improve performance by 1.5%-2% per request depending on load.&lt;/p&gt;

&lt;p&gt;   Our JDK team analyzed our performance in order to reduce CPU usage and garbage collection and found that we are creating a large number of StringBuilders. StringBuilders are expensive to use so only using them when we need them will improve performance. Similarly, they found that we were using reflection to get the params every request in ResourceUtils.createConstructorArguments() which is also expensive, hence the change to get the params one time in the constructor.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16445947" author="githubbot" created="Fri, 20 Apr 2018 16:04:46 +0000"  >&lt;p&gt;coheigea commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r183098421&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r183098421&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/model/URITemplate.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -130,10 +130,31 @@ public String getPatternValue() {&lt;/p&gt;

&lt;p&gt;     private static String escapeCharacters(String expression) {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;StringBuilder sb = new StringBuilder();&lt;/li&gt;
	&lt;li&gt;for (int i = 0; i &amp;lt; expression.length(); i++) {&lt;/li&gt;
	&lt;li&gt;char ch = expression.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;/li&gt;
	&lt;li&gt;sb.append(isReservedCharacter(ch) ? &quot;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&quot; + ch : ch);&lt;br/&gt;
+        int length = expression.length();&lt;br/&gt;
+        int i = 0;&lt;br/&gt;
+        char ch = &apos; &apos;;&lt;br/&gt;
+        for (; i &amp;lt; length; ++i) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            ch = expression.charAt(i);+            if (isReservedCharacter(ch)) {
+                break;
+            }+        }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+        &lt;br/&gt;
+        if (i == length) &lt;/p&gt;
{
+            return expression;
+        }
&lt;p&gt;+        &lt;br/&gt;
+        StringBuilder sb = new StringBuilder(length + 8);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   There should be a comment in the code in that case explaining why &quot;8&quot; is chosen&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16445966" author="githubbot" created="Fri, 20 Apr 2018 16:13:35 +0000"  >&lt;p&gt;WhiteCat22 commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r183100561&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r183100561&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/model/URITemplate.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -130,10 +130,34 @@ public String getPatternValue() {&lt;/p&gt;

&lt;p&gt;     private static String escapeCharacters(String expression) {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;StringBuilder sb = new StringBuilder();&lt;/li&gt;
	&lt;li&gt;for (int i = 0; i &amp;lt; expression.length(); i++) {&lt;/li&gt;
	&lt;li&gt;char ch = expression.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;/li&gt;
	&lt;li&gt;sb.append(isReservedCharacter(ch) ? &quot;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&quot; + ch : ch);&lt;br/&gt;
+        int length = expression.length();&lt;br/&gt;
+        int i = 0;&lt;br/&gt;
+        char ch = &apos; &apos;;&lt;br/&gt;
+        for (; i &amp;lt; length; ++i) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            ch = expression.charAt(i);+            if (isReservedCharacter(ch)) {
+                break;
+            }+        }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+        if (i == length) &lt;/p&gt;
{
+            return expression;
+        }
&lt;p&gt;+&lt;br/&gt;
+        // Allows for up to 8 escaped characters before we start creating more&lt;br/&gt;
+        // StringBuilders. 8 is an arbitrary limit, but it seems to be&lt;br/&gt;
+        // sufficient in most cases.&lt;br/&gt;
+        StringBuilder sb = new StringBuilder(length + 8);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Apparently amending the file removes comments, but I added a comment explaining why we add +8 to the length.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16447445" author="githubbot" created="Mon, 23 Apr 2018 00:57:43 +0000"  >&lt;p&gt;reta commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r183259135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r183259135&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1508,11 +1509,40 @@ public static boolean matchMimeTypes(MediaType requestContentType,&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;br/&gt;
-&lt;br/&gt;
         return new ArrayList&amp;lt;&amp;gt;(supportedMimeTypeList);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    public static boolean doMimeTypesIntersect(List&amp;lt;MediaType&amp;gt; requiredMediaTypes, List&amp;lt;MediaType&amp;gt; userMediaTypes) {&lt;br/&gt;
+        for (MediaType requiredType : requiredMediaTypes) {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Regarding this part, I understand the purpose, but now there 2 identical places, `intersectMimeTypes` and `doMimeTypesIntersect`, with the same code (solving one problem but introducing another). What I am thinking about is to introduce some kind of accumulator to either map the result of the operation to the `List` or `true/false`, do you think it would be possible @WhiteCat22 ?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16448857" author="githubbot" created="Mon, 23 Apr 2018 20:55:42 +0000"  >&lt;p&gt;WhiteCat22 commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r183534925&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r183534925&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1508,11 +1509,40 @@ public static boolean matchMimeTypes(MediaType requestContentType,&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;br/&gt;
-&lt;br/&gt;
         return new ArrayList&amp;lt;&amp;gt;(supportedMimeTypeList);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    public static boolean doMimeTypesIntersect(List&amp;lt;MediaType&amp;gt; requiredMediaTypes, List&amp;lt;MediaType&amp;gt; userMediaTypes) {&lt;br/&gt;
+        for (MediaType requiredType : requiredMediaTypes) {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   The performance increase comes from not making a HashSet just to do the comparison. I agree that duplicating code is not ideal, but I&apos;m not sure how to accomplish both cases with a single method.&lt;/p&gt;

&lt;p&gt;   I am open to suggestions.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16449123" author="githubbot" created="Tue, 24 Apr 2018 00:52:59 +0000"  >&lt;p&gt;reta commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r183578479&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r183578479&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1508,11 +1509,40 @@ public static boolean matchMimeTypes(MediaType requestContentType,&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;br/&gt;
-&lt;br/&gt;
         return new ArrayList&amp;lt;&amp;gt;(supportedMimeTypeList);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    public static boolean doMimeTypesIntersect(List&amp;lt;MediaType&amp;gt; requiredMediaTypes, List&amp;lt;MediaType&amp;gt; userMediaTypes) {&lt;br/&gt;
+        for (MediaType requiredType : requiredMediaTypes) {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Turned out to be quite tricky ... but I have one suggestion for you. Here is the implementation for `doMimeTypesIntersect` and `intersectMimeTypes`:&lt;/p&gt;

&lt;p&gt;   ```&lt;br/&gt;
     public static List&amp;lt;MediaType&amp;gt; intersectMimeTypes(List&amp;lt;MediaType&amp;gt; requiredMediaTypes,&lt;br/&gt;
                                                        List&amp;lt;MediaType&amp;gt; userMediaTypes,&lt;br/&gt;
                                                        boolean addRequiredParamsIfPossible,&lt;br/&gt;
                                                        boolean addDistanceParameter) &lt;/p&gt;
{
           final AccumulatingConsumer consumer = new AccumulatingConsumer(addRequiredParamsIfPossible, addDistanceParameter);
           intersectMimeTypes(requiredMediaTypes, userMediaTypes, consumer);
           return new ArrayList&amp;lt;&amp;gt;(consumer.supportedMimeTypeList);
       }

&lt;p&gt;       public static boolean doMimeTypesIntersect(List&amp;lt;MediaType&amp;gt; requiredMediaTypes, List&amp;lt;MediaType&amp;gt; userMediaTypes) &lt;/p&gt;
{
           final NonAccumulatingConsumer consumer = new NonAccumulatingConsumer();
           intersectMimeTypes(requiredMediaTypes, userMediaTypes, consumer);
           return consumer.doIntersect;
       }
&lt;p&gt;   ```&lt;br/&gt;
   Here is the initial `intersectMimeTypes` function, refactored to use consumers, the part which is was accumulating (or returning `true`) is now part of the consumers:&lt;/p&gt;

&lt;p&gt;   ```&lt;br/&gt;
   private static void intersectMimeTypes(List&amp;lt;MediaType&amp;gt; requiredMediaTypes, List&amp;lt;MediaType&amp;gt; userMediaTypes,&lt;br/&gt;
               BiConsumer&amp;lt;MediaType, MediaType&amp;gt; consumer) {&lt;/p&gt;

&lt;p&gt;           for (MediaType requiredType : requiredMediaTypes) {&lt;br/&gt;
               for (MediaType userType : userMediaTypes) {&lt;br/&gt;
                   boolean isCompatible = isMediaTypeCompatible(requiredType, userType);&lt;br/&gt;
                   if (isCompatible) {&lt;br/&gt;
                       boolean parametersMatched = true;&lt;br/&gt;
                       for (Map.Entry&amp;lt;String, String&amp;gt; entry : userType.getParameters().entrySet()) {&lt;br/&gt;
                           String value = requiredType.getParameters().get(entry.getKey());&lt;br/&gt;
                           if (value != null &amp;amp;&amp;amp; entry.getValue() != null&lt;br/&gt;
                               &amp;amp;&amp;amp; !(stripDoubleQuotesIfNeeded(value).equals(&lt;br/&gt;
                                       stripDoubleQuotesIfNeeded(entry.getValue())))) {&lt;/p&gt;

&lt;p&gt;                               if (HTTP_CHARSET_PARAM.equals(entry.getKey())&lt;br/&gt;
                                   &amp;amp;&amp;amp; value.equalsIgnoreCase(entry.getValue())) &lt;/p&gt;
{
                                   continue;
                               }
&lt;p&gt;                               parametersMatched = false;&lt;br/&gt;
                               break;&lt;br/&gt;
                           }&lt;br/&gt;
                       }&lt;br/&gt;
                       if (!parametersMatched) &lt;/p&gt;
{
                           continue;
                       }

&lt;p&gt;                       consumer.accept(requiredType, userType);&lt;br/&gt;
                   }&lt;br/&gt;
               }&lt;br/&gt;
           }&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;   ```&lt;/p&gt;

&lt;p&gt;   And finally, two consumers:&lt;br/&gt;
   ```&lt;br/&gt;
       private static class NonAccumulatingConsumer implements BiConsumer&amp;lt;MediaType, MediaType&amp;gt; {&lt;br/&gt;
           private boolean doIntersect;&lt;/p&gt;

&lt;p&gt;           @Override&lt;br/&gt;
           public void accept(MediaType t, MediaType u) &lt;/p&gt;
{
               doIntersect = true;
           }
&lt;p&gt;       }&lt;br/&gt;
   ```&lt;/p&gt;

&lt;p&gt;   And &lt;br/&gt;
   ```&lt;br/&gt;
       private static class AccumulatingConsumer implements BiConsumer&amp;lt;MediaType, MediaType&amp;gt; {&lt;br/&gt;
           private final Set&amp;lt;MediaType&amp;gt; supportedMimeTypeList = new LinkedHashSet&amp;lt;MediaType&amp;gt;();&lt;br/&gt;
           private final boolean addRequiredParamsIfPossible;&lt;br/&gt;
           private final boolean addDistanceParameter;&lt;/p&gt;

&lt;p&gt;           private AccumulatingConsumer(boolean addRequiredParamsIfPossible, boolean addDistanceParameter) &lt;/p&gt;
{
               this.addRequiredParamsIfPossible = addRequiredParamsIfPossible;
               this.addDistanceParameter = addDistanceParameter;
           }

&lt;p&gt;           @Override&lt;br/&gt;
           public void accept(MediaType requiredType, MediaType userType) {&lt;br/&gt;
               boolean requiredTypeWildcard = requiredType.getType().equals(MediaType.MEDIA_TYPE_WILDCARD);&lt;br/&gt;
               boolean requiredSubTypeWildcard = requiredType.getSubtype().contains(MediaType.MEDIA_TYPE_WILDCARD);&lt;/p&gt;

&lt;p&gt;               String type = requiredTypeWildcard ? userType.getType() : requiredType.getType();&lt;br/&gt;
               String subtype = requiredSubTypeWildcard ? userType.getSubtype() : requiredType.getSubtype();&lt;/p&gt;

&lt;p&gt;               Map&amp;lt;String, String&amp;gt; parameters = userType.getParameters();&lt;br/&gt;
               if (addRequiredParamsIfPossible) {&lt;br/&gt;
                   parameters = new LinkedHashMap&amp;lt;String, String&amp;gt;(parameters);&lt;br/&gt;
                   for (Map.Entry&amp;lt;String, String&amp;gt; entry : requiredType.getParameters().entrySet()) {&lt;br/&gt;
                       if (!parameters.containsKey(entry.getKey())) &lt;/p&gt;
{
                           parameters.put(entry.getKey(), entry.getValue());
                       }
&lt;p&gt;                   }&lt;br/&gt;
               }&lt;br/&gt;
               if (addDistanceParameter) {&lt;br/&gt;
                   int distance = 0;&lt;br/&gt;
                   if (requiredTypeWildcard) &lt;/p&gt;
{
                       distance++;
                   }&lt;br/&gt;
                   if (requiredSubTypeWildcard) {
                       distance++;
                   }
&lt;p&gt;                   parameters.put(MEDIA_TYPE_DISTANCE_PARAM, Integer.toString(distance));&lt;br/&gt;
               }&lt;br/&gt;
               supportedMimeTypeList.add(new MediaType(type, subtype, parameters));&lt;br/&gt;
           }&lt;br/&gt;
       }&lt;br/&gt;
   ```&lt;/p&gt;

&lt;p&gt;   Ideally, would be good to move to a dedicated utility class, but roughly this is an idea. What do you think. @WhiteCat22, does it make sense?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16451340" author="githubbot" created="Tue, 24 Apr 2018 22:28:07 +0000"  >&lt;p&gt;WhiteCat22 commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r183899002&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r183899002&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1508,11 +1509,40 @@ public static boolean matchMimeTypes(MediaType requestContentType,&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;br/&gt;
-&lt;br/&gt;
         return new ArrayList&amp;lt;&amp;gt;(supportedMimeTypeList);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    public static boolean doMimeTypesIntersect(List&amp;lt;MediaType&amp;gt; requiredMediaTypes, List&amp;lt;MediaType&amp;gt; userMediaTypes) {&lt;br/&gt;
+        for (MediaType requiredType : requiredMediaTypes) {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   This makes sense, but is there another interface that we can use instead of BiConsumer? BiConsumer requires Java 1.8 and this is something that we would like to see backported to 3.1.X which has 1.7 dependencies. Another thing is that we need to have a mechanism to return after the first match during NonAccumulatingConsumer .accept() instead of going through the entire double for loops. There are several ways to do this, pass in a flag to allow us to bail out after first match, return a boolean from accept, or create a new isFinished() method to let us know that we are done processing.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16451513" author="githubbot" created="Wed, 25 Apr 2018 02:00:39 +0000"  >&lt;p&gt;reta commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r183927574&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r183927574&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1508,11 +1509,40 @@ public static boolean matchMimeTypes(MediaType requestContentType,&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;br/&gt;
-&lt;br/&gt;
         return new ArrayList&amp;lt;&amp;gt;(supportedMimeTypeList);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    public static boolean doMimeTypesIntersect(List&amp;lt;MediaType&amp;gt; requiredMediaTypes, List&amp;lt;MediaType&amp;gt; userMediaTypes) {&lt;br/&gt;
+        for (MediaType requiredType : requiredMediaTypes) {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Yeah, sure, sounds good, something like that would fit:&lt;br/&gt;
   ```&lt;br/&gt;
   public interface MimeTypesIntersector &lt;/p&gt;
{
       boolean void intersect(MediaType requiredType, MediaType userType);
   }
&lt;p&gt;   ```&lt;/p&gt;

&lt;p&gt;   And than&lt;/p&gt;

&lt;p&gt;   ```&lt;br/&gt;
   private static void intersectMimeTypes(List&amp;lt;MediaType&amp;gt; requiredMediaTypes, List&amp;lt;MediaType&amp;gt; userMediaTypes,&lt;br/&gt;
   MimeTypesIntersector intersector) {&lt;br/&gt;
       ... &lt;br/&gt;
      if (!intersector.intersect( requiredType, userType) &lt;/p&gt;
{
          return;
      }
&lt;p&gt;   }&lt;br/&gt;
   ```&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16466502" author="githubbot" created="Mon, 7 May 2018 21:39:11 +0000"  >&lt;p&gt;WhiteCat22 commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r186559564&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r186559564&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1508,11 +1509,40 @@ public static boolean matchMimeTypes(MediaType requestContentType,&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;br/&gt;
-&lt;br/&gt;
         return new ArrayList&amp;lt;&amp;gt;(supportedMimeTypeList);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    public static boolean doMimeTypesIntersect(List&amp;lt;MediaType&amp;gt; requiredMediaTypes, List&amp;lt;MediaType&amp;gt; userMediaTypes) {&lt;br/&gt;
+        for (MediaType requiredType : requiredMediaTypes) {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Alright, I&apos;ve had a chance to code this up. Should these classes each go in their own class in the `org.apache.cxf.jaxrs.utils` package, or a single util class?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16466518" author="githubbot" created="Mon, 7 May 2018 21:52:31 +0000"  >&lt;p&gt;reta commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r186562512&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r186562512&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1508,11 +1509,40 @@ public static boolean matchMimeTypes(MediaType requestContentType,&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;br/&gt;
-&lt;br/&gt;
         return new ArrayList&amp;lt;&amp;gt;(supportedMimeTypeList);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    public static boolean doMimeTypesIntersect(List&amp;lt;MediaType&amp;gt; requiredMediaTypes, List&amp;lt;MediaType&amp;gt; userMediaTypes) {&lt;br/&gt;
+        for (MediaType requiredType : requiredMediaTypes) {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   I would vote for own class, what do you think?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16466536" author="githubbot" created="Mon, 7 May 2018 22:12:59 +0000"  >&lt;p&gt;WhiteCat22 commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r186566722&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r186566722&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1508,11 +1509,40 @@ public static boolean matchMimeTypes(MediaType requestContentType,&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;br/&gt;
-&lt;br/&gt;
         return new ArrayList&amp;lt;&amp;gt;(supportedMimeTypeList);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    public static boolean doMimeTypesIntersect(List&amp;lt;MediaType&amp;gt; requiredMediaTypes, List&amp;lt;MediaType&amp;gt; userMediaTypes) {&lt;br/&gt;
+        for (MediaType requiredType : requiredMediaTypes) {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   I agree, I have them coded up into separate `MimeTypesIntersector`, `AccumulatingIntersector` and `NonAccumulatingIntersector` classes&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16466549" author="githubbot" created="Mon, 7 May 2018 22:26:46 +0000"  >&lt;p&gt;reta commented on a change in pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#discussion_r186569414&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#discussion_r186569414&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -1508,11 +1509,40 @@ public static boolean matchMimeTypes(MediaType requestContentType,&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;br/&gt;
-&lt;br/&gt;
         return new ArrayList&amp;lt;&amp;gt;(supportedMimeTypeList);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    public static boolean doMimeTypesIntersect(List&amp;lt;MediaType&amp;gt; requiredMediaTypes, List&amp;lt;MediaType&amp;gt; userMediaTypes) {&lt;br/&gt;
+        for (MediaType requiredType : requiredMediaTypes) {&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   :+1: &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16467904" author="githubbot" created="Tue, 8 May 2018 20:04:05 +0000"  >&lt;p&gt;WhiteCat22 commented on issue #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#issuecomment-387525374&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#issuecomment-387525374&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @reta I&apos;ve pushed the JAXRSUtils changes that we talked about.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16468184" author="githubbot" created="Wed, 9 May 2018 00:54:13 +0000"  >&lt;p&gt;reta commented on issue #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#issuecomment-387586865&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#issuecomment-387586865&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @WhiteCat22 Looks good to me, thanks a lot. @asoldano any objections towards merging it? It is good set of micro-optimizations overall (in my opinion). &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16468991" author="githubbot" created="Wed, 9 May 2018 15:58:08 +0000"  >&lt;p&gt;WhiteCat22 commented on issue #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#issuecomment-387788090&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#issuecomment-387788090&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Can we also deliver this to 3.1.X? I&apos;m not sure if that would require additional work to merge or not.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16470337" author="githubbot" created="Thu, 10 May 2018 12:42:24 +0000"  >&lt;p&gt;dkulp commented on issue #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#issuecomment-388042074&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#issuecomment-388042074&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   lgtm&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16471193" author="githubbot" created="Thu, 10 May 2018 21:59:12 +0000"  >&lt;p&gt;reta commented on issue #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#issuecomment-388198964&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#issuecomment-388198964&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks guys! @WhiteCat22  I will take care of back-porting to 3.1.x&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16471194" author="githubbot" created="Thu, 10 May 2018 21:59:21 +0000"  >&lt;p&gt;reta closed pull request #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/lifecycle/PerRequestResourceProvider.java b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/lifecycle/PerRequestResourceProvider.java&lt;br/&gt;
index 1bc98bd9def..61881fbbf8d 100644&lt;br/&gt;
&amp;#8212; a/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/lifecycle/PerRequestResourceProvider.java&lt;br/&gt;
+++ b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/lifecycle/PerRequestResourceProvider.java&lt;br/&gt;
@@ -19,9 +19,11 @@&lt;/p&gt;

&lt;p&gt; package org.apache.cxf.jaxrs.lifecycle;&lt;/p&gt;

&lt;p&gt;+import java.lang.annotation.Annotation;&lt;br/&gt;
 import java.lang.reflect.Constructor;&lt;br/&gt;
 import java.lang.reflect.InvocationTargetException;&lt;br/&gt;
 import java.lang.reflect.Method;&lt;br/&gt;
+import java.lang.reflect.Type;&lt;br/&gt;
 import java.util.Collections;&lt;br/&gt;
 import java.util.Map;&lt;/p&gt;

&lt;p&gt;@@ -45,6 +47,9 @@&lt;br/&gt;
     private Constructor&amp;lt;?&amp;gt; c;&lt;br/&gt;
     private Method postConstructMethod;&lt;br/&gt;
     private Method preDestroyMethod;&lt;br/&gt;
+    private final Class&amp;lt;?&amp;gt;[] params;&lt;br/&gt;
+    private final Annotation[][] anns;&lt;br/&gt;
+    private final Type[] genericTypes;&lt;/p&gt;

&lt;p&gt;     public PerRequestResourceProvider(Class&amp;lt;?&amp;gt; clazz) {&lt;br/&gt;
         c = ResourceUtils.findResourceConstructor(clazz, true);&lt;br/&gt;
@@ -52,6 +57,9 @@ public PerRequestResourceProvider(Class&amp;lt;?&amp;gt; clazz) &lt;/p&gt;
{
             throw new RuntimeException(&quot;Resource class &quot; + clazz
                                        + &quot; has no valid constructor&quot;);
         }
&lt;p&gt;+        params = c.getParameterTypes();&lt;br/&gt;
+        anns = c.getParameterAnnotations();&lt;br/&gt;
+        genericTypes = c.getGenericParameterTypes();&lt;br/&gt;
         postConstructMethod = ResourceUtils.findPostConstructMethod(clazz);&lt;br/&gt;
         preDestroyMethod = ResourceUtils.findPreDestroyMethod(clazz);&lt;br/&gt;
     }&lt;br/&gt;
@@ -75,7 +83,7 @@ protected Object createInstance(Message m) {&lt;br/&gt;
             (ProviderInfo&amp;lt;?&amp;gt;)m.getExchange().getEndpoint().get(Application.class.getName());&lt;br/&gt;
         Map&amp;lt;Class&amp;lt;?&amp;gt;, Object&amp;gt; mapValues = CastUtils.cast(application == null ? null&lt;br/&gt;
             : Collections.singletonMap(Application.class, application.getProvider()));&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Object[] values = ResourceUtils.createConstructorArguments(c, m, true, mapValues);&lt;br/&gt;
+        Object[] values = ResourceUtils.createConstructorArguments(c, m, true, mapValues, params, anns, genericTypes);&lt;br/&gt;
         try {&lt;br/&gt;
             Object instance = values.length &amp;gt; 0 ? c.newInstance(values) : c.newInstance(new Object[]{});&lt;br/&gt;
             InjectionUtils.invokeLifeCycleMethod(instance, postConstructMethod);&lt;br/&gt;
diff --git a/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/model/URITemplate.java b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/model/URITemplate.java&lt;br/&gt;
index 29777a8981b..b5059f3ddca 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/model/URITemplate.java&lt;br/&gt;
+++ b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/model/URITemplate.java&lt;br/&gt;
@@ -130,10 +130,34 @@ public String getPatternValue() {&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private static String escapeCharacters(String expression) {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;StringBuilder sb = new StringBuilder();&lt;/li&gt;
	&lt;li&gt;for (int i = 0; i &amp;lt; expression.length(); i++) {&lt;/li&gt;
	&lt;li&gt;char ch = expression.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;/li&gt;
	&lt;li&gt;sb.append(isReservedCharacter(ch) ? &quot;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&quot; + ch : ch);&lt;br/&gt;
+        int length = expression.length();&lt;br/&gt;
+        int i = 0;&lt;br/&gt;
+        char ch = &apos; &apos;;&lt;br/&gt;
+        for (; i &amp;lt; length; ++i) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            ch = expression.charAt(i);+            if (isReservedCharacter(ch)) {
+                break;
+            }+        }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+        if (i == length) &lt;/p&gt;
{
+            return expression;
+        }
&lt;p&gt;+&lt;br/&gt;
+        // Allows for up to 8 escaped characters before we start creating more&lt;br/&gt;
+        // StringBuilders. 8 is an arbitrary limit, but it seems to be&lt;br/&gt;
+        // sufficient in most cases.&lt;br/&gt;
+        StringBuilder sb = new StringBuilder(length + 8);&lt;br/&gt;
+        sb.append(expression, 0, i);&lt;br/&gt;
+        sb.append(&apos;&lt;br class=&quot;atl-forced-newline&quot; /&gt;&apos;);&lt;br/&gt;
+        sb.append(ch);&lt;br/&gt;
+        ++i;&lt;br/&gt;
+        for (; i &amp;lt; length; ++i) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+            ch = expression.charAt(i);+            if (isReservedCharacter(ch)) {
+                sb.append(&apos;\\&apos;);
+            }+            sb.append(ch);         }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;         return sb.toString();&lt;br/&gt;
     }&lt;br/&gt;
diff --git a/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/provider/ProviderFactory.java b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/provider/ProviderFactory.java&lt;br/&gt;
index e62d3396e1c..03b6a5e64b8 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/provider/ProviderFactory.java&lt;br/&gt;
+++ b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/provider/ProviderFactory.java&lt;br/&gt;
@@ -222,7 +222,7 @@ protected static Object createProvider(String className, Bus bus) {&lt;br/&gt;
                         if (argCls != null &amp;amp;&amp;amp; argCls.isAssignableFrom(contextCls)) {&lt;br/&gt;
                             List&amp;lt;MediaType&amp;gt; mTypes = JAXRSUtils.getProduceTypes(&lt;br/&gt;
                                  cr.getProvider().getClass().getAnnotation(Produces.class));&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;if (JAXRSUtils.intersectMimeTypes(mTypes, type).size() &amp;gt; 0) {&lt;br/&gt;
+                            if (JAXRSUtils.doMimeTypesIntersect(mTypes, type)) 
{
                                 injectContextValues(cr, m);
                                 candidates.add((ContextResolver&amp;lt;T&amp;gt;)cr.getProvider());
                             }
&lt;p&gt;@@ -728,10 +728,7 @@ private void sortContextResolvers() &lt;/p&gt;
{
         MessageBodyReader&amp;lt;?&amp;gt; ep = pi.getProvider();
         List&amp;lt;MediaType&amp;gt; supportedMediaTypes = JAXRSUtils.getProviderConsumeTypes(ep);
 
-        List&amp;lt;MediaType&amp;gt; availableMimeTypes =
-            JAXRSUtils.intersectMimeTypes(Collections.singletonList(mediaType), supportedMediaTypes, false);
-
-        return availableMimeTypes.size() != 0;
+        return JAXRSUtils.doMimeTypesIntersect(Collections.singletonList(mediaType), supportedMediaTypes);
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private boolean isReadable(ProviderInfo&amp;lt;MessageBodyReader&amp;lt;?&amp;gt;&amp;gt; pi,&lt;br/&gt;
@@ -752,11 +749,7 @@ private boolean isReadable(ProviderInfo&amp;lt;MessageBodyReader&amp;lt;?&amp;gt;&amp;gt; pi,&lt;br/&gt;
         MessageBodyWriter&amp;lt;?&amp;gt; ep = pi.getProvider();&lt;br/&gt;
         List&amp;lt;MediaType&amp;gt; supportedMediaTypes = JAXRSUtils.getProviderProduceTypes(ep);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;List&amp;lt;MediaType&amp;gt; availableMimeTypes =&lt;/li&gt;
	&lt;li&gt;JAXRSUtils.intersectMimeTypes(Collections.singletonList(mediaType),&lt;/li&gt;
	&lt;li&gt;supportedMediaTypes, false);&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;return availableMimeTypes.size() != 0;&lt;br/&gt;
+        return JAXRSUtils.doMimeTypesIntersect(Collections.singletonList(mediaType), supportedMediaTypes);&lt;br/&gt;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private boolean isWriteable(ProviderInfo&amp;lt;MessageBodyWriter&amp;lt;?&amp;gt;&amp;gt; pi,&lt;br/&gt;
diff --git a/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/AccumulatingIntersector.java b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/AccumulatingIntersector.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..3d2537f46c6&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/AccumulatingIntersector.java&lt;br/&gt;
@@ -0,0 +1,74 @@&lt;br/&gt;
+/**&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
+ * or more contributor license agreements. See the NOTICE file&lt;br/&gt;
+ * distributed with this work for additional information&lt;br/&gt;
+ * regarding copyright ownership. The ASF licenses this file&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
+ * with the License. You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ * &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing,&lt;br/&gt;
+ * software distributed under the License is distributed on an&lt;br/&gt;
+ * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY&lt;br/&gt;
+ * KIND, either express or implied. See the License for the&lt;br/&gt;
+ * specific language governing permissions and limitations&lt;br/&gt;
+ * under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.cxf.jaxrs.utils;&lt;br/&gt;
+&lt;br/&gt;
+import java.util.LinkedHashMap;&lt;br/&gt;
+import java.util.LinkedHashSet;&lt;br/&gt;
+import java.util.Map;&lt;br/&gt;
+import java.util.Set;&lt;br/&gt;
+&lt;br/&gt;
+import javax.ws.rs.core.MediaType;&lt;br/&gt;
+&lt;br/&gt;
+public class AccumulatingIntersector implements MimeTypesIntersector {&lt;br/&gt;
+    private static final String MEDIA_TYPE_DISTANCE_PARAM = &quot;d&quot;;&lt;br/&gt;
+    private final Set&amp;lt;MediaType&amp;gt; supportedMimeTypeList = new LinkedHashSet&amp;lt;MediaType&amp;gt;();&lt;br/&gt;
+    private final boolean addRequiredParamsIfPossible;&lt;br/&gt;
+    private final boolean addDistanceParameter;&lt;br/&gt;
+&lt;br/&gt;
+    AccumulatingIntersector(boolean addRequiredParamsIfPossible, boolean addDistanceParameter) &lt;/p&gt;
{
+        this.addRequiredParamsIfPossible = addRequiredParamsIfPossible;
+        this.addDistanceParameter = addDistanceParameter;
+    }
&lt;p&gt;+&lt;br/&gt;
+    @Override&lt;br/&gt;
+    public boolean intersect(MediaType requiredType, MediaType userType) {&lt;br/&gt;
+        boolean requiredTypeWildcard = requiredType.getType().equals(MediaType.MEDIA_TYPE_WILDCARD);&lt;br/&gt;
+        boolean requiredSubTypeWildcard = requiredType.getSubtype().contains(MediaType.MEDIA_TYPE_WILDCARD);&lt;br/&gt;
+&lt;br/&gt;
+        String type = requiredTypeWildcard ? userType.getType() : requiredType.getType();&lt;br/&gt;
+        String subtype = requiredSubTypeWildcard ? userType.getSubtype() : requiredType.getSubtype();&lt;br/&gt;
+&lt;br/&gt;
+        Map&amp;lt;String, String&amp;gt; parameters = userType.getParameters();&lt;br/&gt;
+        if (addRequiredParamsIfPossible) {&lt;br/&gt;
+            parameters = new LinkedHashMap&amp;lt;String, String&amp;gt;(parameters);&lt;br/&gt;
+            for (Map.Entry&amp;lt;String, String&amp;gt; entry : requiredType.getParameters().entrySet()) {&lt;br/&gt;
+                if (!parameters.containsKey(entry.getKey())) &lt;/p&gt;
{
+                    parameters.put(entry.getKey(), entry.getValue());
+                }
&lt;p&gt;+            }&lt;br/&gt;
+        }&lt;br/&gt;
+        if (addDistanceParameter) {&lt;br/&gt;
+            int distance = 0;&lt;br/&gt;
+            if (requiredTypeWildcard) &lt;/p&gt;
{
+                distance++;
+            }&lt;br/&gt;
+            if (requiredSubTypeWildcard) {+                distance++;+            }
&lt;p&gt;+            parameters.put(MEDIA_TYPE_DISTANCE_PARAM, Integer.toString(distance));&lt;br/&gt;
+        }&lt;br/&gt;
+        getSupportedMimeTypeList().add(new MediaType(type, subtype, parameters));&lt;br/&gt;
+        return true;&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    public Set&amp;lt;MediaType&amp;gt; getSupportedMimeTypeList() &lt;/p&gt;
{
+        return supportedMimeTypeList;
+    }
&lt;p&gt;+}&lt;br/&gt;
diff --git a/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/HttpUtils.java b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/HttpUtils.java&lt;br/&gt;
index 41286c358fb..53a21434fe3 100644&lt;br/&gt;
&amp;#8212; a/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/HttpUtils.java&lt;br/&gt;
+++ b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/HttpUtils.java&lt;br/&gt;
@@ -117,24 +117,29 @@ public static String pathDecode(String value) {&lt;/p&gt;

&lt;p&gt;     private static String componentEncode(String reservedChars, String value) {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;StringBuilder buffer = new StringBuilder();&lt;/li&gt;
	&lt;li&gt;StringBuilder bufferToEncode = new StringBuilder();&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;for (int i = 0; i &amp;lt; value.length(); i++) {&lt;br/&gt;
+        StringBuilder buffer = null;&lt;br/&gt;
+        int length = value.length();&lt;br/&gt;
+        int startingIndex = 0;&lt;br/&gt;
+        for (int i = 0; i &amp;lt; length; i++) {&lt;br/&gt;
             char currentChar = value.charAt&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;;&lt;br/&gt;
             if (reservedChars.indexOf(currentChar) != -1) {&lt;/li&gt;
	&lt;li&gt;if (bufferToEncode.length() &amp;gt; 0) {&lt;/li&gt;
	&lt;li&gt;buffer.append(urlEncode(bufferToEncode.toString()));&lt;/li&gt;
	&lt;li&gt;bufferToEncode.setLength(0);&lt;br/&gt;
+                if (buffer == null) 
{
+                    buffer = new StringBuilder(length + 8);
+                }
&lt;p&gt;+                // If it is going to be an empty string nothing to encode.&lt;br/&gt;
+                if (i != startingIndex) &lt;/p&gt;
{
+                    buffer.append(urlEncode(value.substring(startingIndex, i)));
                 }
&lt;p&gt;                 buffer.append(currentChar);&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;} else 
{
-                bufferToEncode.append(currentChar);
+                startingIndex = i + 1;
             }
&lt;p&gt;         }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (bufferToEncode.length() &amp;gt; 0) {&lt;/li&gt;
	&lt;li&gt;buffer.append(urlEncode(bufferToEncode.toString()));&lt;br/&gt;
+        if (buffer == null) 
{
+            return urlEncode(value);
+        }
&lt;p&gt;+        if (startingIndex &amp;lt; length) &lt;/p&gt;
{
+            buffer.append(urlEncode(value.substring(startingIndex, length)));
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         return buffer.toString();&lt;br/&gt;
@@ -186,15 +191,21 @@ public static String encodePartiallyEncoded(String encoded, boolean query) &lt;/p&gt;
{
             return encoded;
         }
&lt;p&gt;         Matcher m = ENCODE_PATTERN.matcher(encoded);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;StringBuilder sb = new StringBuilder();&lt;br/&gt;
+&lt;br/&gt;
+        if (!m.find()) 
{
+            return query ? HttpUtils.queryEncode(encoded) : HttpUtils.pathEncode(encoded);
+        }
&lt;p&gt;+&lt;br/&gt;
+        int length = encoded.length();&lt;br/&gt;
+        StringBuilder sb = new StringBuilder(length + 8);&lt;br/&gt;
         int i = 0;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;while (m.find()) {&lt;br/&gt;
+        do 
{
             String before = encoded.substring(i, m.start());
             sb.append(query ? HttpUtils.queryEncode(before) : HttpUtils.pathEncode(before));
             sb.append(m.group());
             i = m.end();
-        }&lt;/li&gt;
	&lt;li&gt;String tail = encoded.substring(i, encoded.length());&lt;br/&gt;
+        } while (m.find());&lt;br/&gt;
+        String tail = encoded.substring(i, length);&lt;br/&gt;
         sb.append(query ? HttpUtils.queryEncode(tail) : HttpUtils.pathEncode(tail));&lt;br/&gt;
         return sb.toString();&lt;br/&gt;
     }&lt;br/&gt;
diff --git a/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java&lt;br/&gt;
index 3094a3eb767..252f4cd06b3 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java&lt;br/&gt;
+++ b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java&lt;br/&gt;
@@ -35,7 +35,6 @@&lt;br/&gt;
 import java.util.Comparator;&lt;br/&gt;
 import java.util.HashSet;&lt;br/&gt;
 import java.util.LinkedHashMap;&lt;br/&gt;
-import java.util.LinkedHashSet;&lt;br/&gt;
 import java.util.LinkedList;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
@@ -1400,21 +1399,21 @@ public static void writeMessageBody(List&amp;lt;WriterInterceptor&amp;gt; writers,&lt;br/&gt;
     public static boolean matchConsumeTypes(MediaType requestContentType,&lt;br/&gt;
                                             OperationResourceInfo ori) 
{
 
-        return !intersectMimeTypes(ori.getConsumeTypes(), requestContentType).isEmpty();
+        return doMimeTypesIntersect(ori.getConsumeTypes(), requestContentType);
     }&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     public static boolean matchProduceTypes(MediaType acceptContentType,&lt;br/&gt;
                                               OperationResourceInfo ori) &lt;/p&gt;
{
 
-        return !intersectMimeTypes(ori.getProduceTypes(), acceptContentType).isEmpty();
+        return doMimeTypesIntersect(ori.getProduceTypes(), acceptContentType);
     }

&lt;p&gt;     public static boolean matchMimeTypes(MediaType requestContentType,&lt;br/&gt;
                                          MediaType acceptContentType,&lt;br/&gt;
                                          OperationResourceInfo ori) &lt;/p&gt;
{
 
-        return intersectMimeTypes(ori.getConsumeTypes(), requestContentType).size() != 0
-            &amp;amp;&amp;amp; intersectMimeTypes(ori.getProduceTypes(), acceptContentType).size() != 0;
+        return doMimeTypesIntersect(ori.getConsumeTypes(), requestContentType)
+                &amp;amp;&amp;amp; doMimeTypesIntersect(ori.getProduceTypes(), acceptContentType);
     }

&lt;p&gt;     public static List&amp;lt;MediaType&amp;gt; parseMediaTypes(String types) &lt;/p&gt;
{
@@ -1439,6 +1438,16 @@ public static boolean matchMimeTypes(MediaType requestContentType,
         return acceptValues;
     }

&lt;p&gt;+    public static boolean doMimeTypesIntersect(List&amp;lt;MediaType&amp;gt; mimeTypesA, MediaType mimeTypeB) &lt;/p&gt;
{
+        return doMimeTypesIntersect(mimeTypesA, Collections.singletonList(mimeTypeB));
+    }
&lt;p&gt;+&lt;br/&gt;
+    public static boolean doMimeTypesIntersect(List&amp;lt;MediaType&amp;gt; requiredMediaTypes, List&amp;lt;MediaType&amp;gt; userMediaTypes) &lt;/p&gt;
{
+        final NonAccumulatingIntersector intersector = new NonAccumulatingIntersector();
+        intersectMimeTypes(requiredMediaTypes, userMediaTypes, intersector);
+        return intersector.doIntersect();
+    }
&lt;p&gt;+&lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;intersect two mime types&lt;br/&gt;
      *&lt;br/&gt;
@@ -1451,11 +1460,19 @@ public static boolean matchMimeTypes(MediaType requestContentType,&lt;br/&gt;
                                                      boolean addRequiredParamsIfPossible) 
{
         return intersectMimeTypes(requiredMediaTypes, userMediaTypes, addRequiredParamsIfPossible, false);
     }
&lt;p&gt;+&lt;br/&gt;
     public static List&amp;lt;MediaType&amp;gt; intersectMimeTypes(List&amp;lt;MediaType&amp;gt; requiredMediaTypes,&lt;br/&gt;
                                                      List&amp;lt;MediaType&amp;gt; userMediaTypes,&lt;br/&gt;
                                                      boolean addRequiredParamsIfPossible,&lt;br/&gt;
                                                      boolean addDistanceParameter) &lt;/p&gt;
{
-        Set&amp;lt;MediaType&amp;gt; supportedMimeTypeList = new LinkedHashSet&amp;lt;MediaType&amp;gt;();
+        final AccumulatingIntersector intersector = new AccumulatingIntersector(addRequiredParamsIfPossible,
+                addDistanceParameter);
+        intersectMimeTypes(requiredMediaTypes, userMediaTypes, intersector);
+        return new ArrayList&amp;lt;&amp;gt;(intersector.getSupportedMimeTypeList());
+    }
&lt;p&gt;+&lt;br/&gt;
+    private static void intersectMimeTypes(List&amp;lt;MediaType&amp;gt; requiredMediaTypes, List&amp;lt;MediaType&amp;gt; userMediaTypes,&lt;br/&gt;
+            MimeTypesIntersector intersector) {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         for (MediaType requiredType : requiredMediaTypes) {&lt;br/&gt;
             for (MediaType userType : userMediaTypes) {&lt;br/&gt;
@@ -1464,12 +1481,10 @@ public static boolean matchMimeTypes(MediaType requestContentType,&lt;br/&gt;
                     boolean parametersMatched = true;&lt;br/&gt;
                     for (Map.Entry&amp;lt;String, String&amp;gt; entry : userType.getParameters().entrySet()) {&lt;br/&gt;
                         String value = requiredType.getParameters().get(entry.getKey());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (value != null &amp;amp;&amp;amp; entry.getValue() != null&lt;/li&gt;
	&lt;li&gt;&amp;amp;&amp;amp; !(stripDoubleQuotesIfNeeded(value).equals(&lt;/li&gt;
	&lt;li&gt;stripDoubleQuotesIfNeeded(entry.getValue())))) {&lt;/li&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;if (HTTP_CHARSET_PARAM.equals(entry.getKey())&lt;/li&gt;
	&lt;li&gt;&amp;amp;&amp;amp; value.equalsIgnoreCase(entry.getValue())) {&lt;br/&gt;
+                        if (value != null &amp;amp;&amp;amp; entry.getValue() != null &amp;amp;&amp;amp; !(stripDoubleQuotesIfNeeded(value)&lt;br/&gt;
+                                .equals(stripDoubleQuotesIfNeeded(entry.getValue())))) {&lt;br/&gt;
+&lt;br/&gt;
+                            if (HTTP_CHARSET_PARAM.equals(entry.getKey()) &amp;amp;&amp;amp; value.equalsIgnoreCase(entry.getValue())) 
{
                                 continue;
                             }
&lt;p&gt;                             parametersMatched = false;&lt;br/&gt;
@@ -1479,40 +1494,15 @@ public static boolean matchMimeTypes(MediaType requestContentType,&lt;br/&gt;
                     if (!parametersMatched) &lt;/p&gt;
{
                         continue;
                     }&lt;/li&gt;
	&lt;li&gt;boolean requiredTypeWildcard = requiredType.getType().equals(MediaType.MEDIA_TYPE_WILDCARD);&lt;/li&gt;
	&lt;li&gt;boolean requiredSubTypeWildcard = requiredType.getSubtype().contains(MediaType.MEDIA_TYPE_WILDCARD);&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;String type = requiredTypeWildcard ? userType.getType() : requiredType.getType();&lt;/li&gt;
	&lt;li&gt;String subtype = requiredSubTypeWildcard ? userType.getSubtype() : requiredType.getSubtype();&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;Map&amp;lt;String, String&amp;gt; parameters = userType.getParameters();&lt;/li&gt;
	&lt;li&gt;if (addRequiredParamsIfPossible) {&lt;/li&gt;
	&lt;li&gt;parameters = new LinkedHashMap&amp;lt;String, String&amp;gt;(parameters);&lt;/li&gt;
	&lt;li&gt;for (Map.Entry&amp;lt;String, String&amp;gt; entry : requiredType.getParameters().entrySet()) {&lt;/li&gt;
	&lt;li&gt;if (!parameters.containsKey(entry.getKey())) 
{
-                                parameters.put(entry.getKey(), entry.getValue());
-                            }&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;if (addDistanceParameter) {&lt;/li&gt;
	&lt;li&gt;int distance = 0;&lt;/li&gt;
	&lt;li&gt;if (requiredTypeWildcard) 
{
-                            distance++;
-                        }&lt;br/&gt;
-                        if (requiredSubTypeWildcard) {-                            distance++;-                        }&lt;/li&gt;
	&lt;li&gt;parameters.put(MEDIA_TYPE_DISTANCE_PARAM, Integer.toString(distance));&lt;br/&gt;
+&lt;br/&gt;
+                    if (!intersector.intersect(requiredType, userType)) 
{
+                        return;
                     }&lt;/li&gt;
	&lt;li&gt;supportedMimeTypeList.add(new MediaType(type, subtype, parameters));&lt;br/&gt;
                 }&lt;br/&gt;
             }&lt;br/&gt;
         }&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;return new ArrayList&amp;lt;&amp;gt;(supportedMimeTypeList);&lt;br/&gt;
-&lt;br/&gt;
     }&lt;/li&gt;
	&lt;li&gt;&lt;p&gt;+&lt;br/&gt;
     private static String stripDoubleQuotesIfNeeded(String value) {&lt;br/&gt;
         if (value != null &amp;amp;&amp;amp; value.startsWith(&quot;\&quot;&quot;) &lt;br/&gt;
             &amp;amp;&amp;amp; value.endsWith(&quot;\&quot;&quot;) &amp;amp;&amp;amp; value.length() &amp;gt; 1) {&lt;br/&gt;
diff --git a/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/MimeTypesIntersector.java b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/MimeTypesIntersector.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..3dd3e47be76&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;/dev/null&lt;br/&gt;
+++ b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/MimeTypesIntersector.java&lt;br/&gt;
@@ -0,0 +1,26 @@&lt;br/&gt;
+/**&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
+ * or more contributor license agreements. See the NOTICE file&lt;br/&gt;
+ * distributed with this work for additional information&lt;br/&gt;
+ * regarding copyright ownership. The ASF licenses this file&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
+ * with the License. You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ * &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing,&lt;br/&gt;
+ * software distributed under the License is distributed on an&lt;br/&gt;
+ * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY&lt;br/&gt;
+ * KIND, either express or implied. See the License for the&lt;br/&gt;
+ * specific language governing permissions and limitations&lt;br/&gt;
+ * under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.cxf.jaxrs.utils;&lt;br/&gt;
+&lt;br/&gt;
+import javax.ws.rs.core.MediaType;&lt;br/&gt;
+&lt;br/&gt;
+public interface MimeTypesIntersector 
{
+    boolean intersect(MediaType requiredType, MediaType userType);
+}
&lt;p&gt;diff --git a/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/NonAccumulatingIntersector.java b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/NonAccumulatingIntersector.java&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..7f6661e6c39&lt;/p&gt;&lt;/li&gt;
			&lt;li&gt;/dev/null&lt;br/&gt;
+++ b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/NonAccumulatingIntersector.java&lt;br/&gt;
@@ -0,0 +1,36 @@&lt;br/&gt;
+/**&lt;br/&gt;
+ * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
+ * or more contributor license agreements. See the NOTICE file&lt;br/&gt;
+ * distributed with this work for additional information&lt;br/&gt;
+ * regarding copyright ownership. The ASF licenses this file&lt;br/&gt;
+ * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
+ * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
+ * with the License. You may obtain a copy of the License at&lt;br/&gt;
+ *&lt;br/&gt;
+ * &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+ *&lt;br/&gt;
+ * Unless required by applicable law or agreed to in writing,&lt;br/&gt;
+ * software distributed under the License is distributed on an&lt;br/&gt;
+ * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY&lt;br/&gt;
+ * KIND, either express or implied. See the License for the&lt;br/&gt;
+ * specific language governing permissions and limitations&lt;br/&gt;
+ * under the License.&lt;br/&gt;
+ */&lt;br/&gt;
+&lt;br/&gt;
+package org.apache.cxf.jaxrs.utils;&lt;br/&gt;
+&lt;br/&gt;
+import javax.ws.rs.core.MediaType;&lt;br/&gt;
+&lt;br/&gt;
+public class NonAccumulatingIntersector implements MimeTypesIntersector 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+    private boolean doIntersect;++    @Override+    public boolean intersect(MediaType requiredType, MediaType userType) {
+        doIntersect = true;
+        return false;
+    }++    public boolean doIntersect() {
+        return doIntersect;
+    }+}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;diff --git a/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/ResourceUtils.java b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/ResourceUtils.java&lt;br/&gt;
index 39d97696a54..1b32e855f25 100644&lt;/p&gt;&lt;/li&gt;
			&lt;li&gt;a/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/ResourceUtils.java&lt;br/&gt;
+++ b/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/ResourceUtils.java&lt;br/&gt;
@@ -816,12 +816,23 @@ private static UserOperation getOperationFromElement(Element e) {&lt;br/&gt;
                                                       Message m,&lt;br/&gt;
                                                       boolean perRequest,&lt;br/&gt;
                                                       Map&amp;lt;Class&amp;lt;?&amp;gt;, Object&amp;gt; contextValues) {&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;if (m == null) 
{
-            m = new MessageImpl();
-        }
&lt;p&gt;         Class&amp;lt;?&amp;gt;[] params = c.getParameterTypes();&lt;br/&gt;
         Annotation[][] anns = c.getParameterAnnotations();&lt;br/&gt;
         Type[] genericTypes = c.getGenericParameterTypes();&lt;br/&gt;
+        return createConstructorArguments(c, m, perRequest, contextValues, params, anns, genericTypes);&lt;br/&gt;
+    }&lt;br/&gt;
+&lt;br/&gt;
+    public static Object[] createConstructorArguments(Constructor&amp;lt;?&amp;gt; c,&lt;br/&gt;
+                                                      Message m,&lt;br/&gt;
+                                                      boolean perRequest,&lt;br/&gt;
+                                                      Map&amp;lt;Class&amp;lt;?&amp;gt;,&lt;br/&gt;
+                                                      Object&amp;gt; contextValues,&lt;br/&gt;
+                                                      Class&amp;lt;?&amp;gt;[] params,&lt;br/&gt;
+                                                      Annotation[][] anns,&lt;br/&gt;
+                                                      Type[] genericTypes) {&lt;br/&gt;
+        if (m == null) &lt;/p&gt;
{
+            m = new MessageImpl();
+        }
&lt;p&gt;         @SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
         MultivaluedMap&amp;lt;String, String&amp;gt; templateValues =&lt;br/&gt;
             (MultivaluedMap&amp;lt;String, String&amp;gt;)m.get(URITemplate.TEMPLATE_PARAMETERS);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16471241" author="githubbot" created="Thu, 10 May 2018 22:33:41 +0000"  >&lt;p&gt;WhiteCat22 commented on issue #407: &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7716&quot; title=&quot;IBM Performance Team has found several performance increases&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7716&quot;&gt;&lt;del&gt;CXF-7716&lt;/del&gt;&lt;/a&gt; Reduce StringBuilders and other performance changes.&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/cxf/pull/407#issuecomment-388206050&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/407#issuecomment-388206050&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @reta Thanks!&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10062"><![CDATA[Moderate]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 27 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3sppj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>