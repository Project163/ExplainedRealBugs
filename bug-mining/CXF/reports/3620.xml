<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:38:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-8566] cxf-ws-rt-security &amp; ehcache: OSGi classloading</title>
                <link>https://issues.apache.org/jira/browse/CXF-8566</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;during some tests in Karaf container, we faced this exception&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.IllegalArgumentException: CacheTemplate &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cxf.ws.security.tokenstore.TokenStore&apos;&lt;/span&gt; declares value type of org.apache.cxf.ws.security.tokenstore.SecurityToken. Provided: &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cxf.ws.security.tokenstore.SecurityToken
	at org.ehcache.xml.ConfigurationParser.checkTemplateTypeConsistency(ConfigurationParser.java:279) ~[bundleFile:3.8.1 a19322e8d4b3f7157e878112c2afc0b6e3090fdd]
	at org.ehcache.xml.ConfigurationParser.access$000(ConfigurationParser.java:108) ~[bundleFile:3.8.1 a19322e8d4b3f7157e878112c2afc0b6e3090fdd]
	at org.ehcache.xml.ConfigurationParser$1.builderFor(ConfigurationParser.java:255) ~[bundleFile:3.8.1 a19322e8d4b3f7157e878112c2afc0b6e3090fdd]
	at org.ehcache.xml.XmlConfiguration.newCacheConfigurationBuilderFromTemplate(XmlConfiguration.java:277) ~[bundleFile:3.8.1 a19322e8d4b3f7157e878112c2afc0b6e3090fdd]
	at org.apache.cxf.ws.security.tokenstore.EHCacheTokenStore.&amp;lt;init&amp;gt;(EHCacheTokenStore.java:66) ~[bundleFile:3.4.3]
	at org.apache.cxf.ws.security.tokenstore.EHCacheTokenStoreFactory.newTokenStore(EHCacheTokenStoreFactory.java:45) ~[bundleFile:3.4.3]
	at org.apache.cxf.ws.security.tokenstore.TokenStoreUtils.getTokenStore(TokenStoreUtils.java:58) ~[bundleFile:3.4.3]
	at org.apache.cxf.ws.security.trust.DefaultSTSTokenCacher.storeToken(DefaultSTSTokenCacher.java:103) ~[bundleFile:3.4.3]
	at org.apache.cxf.ws.security.trust.STSTokenRetriever.getToken(STSTokenRetriever.java:117) ~[bundleFile:3.4.3]
	... 18 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It seems it&apos;s due to different class loaders for classes &lt;tt&gt;XmlConfiguration&lt;/tt&gt; and &lt;tt&gt;SecurityToken.&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I tried to force the &lt;tt&gt;cacheClassLoaders&lt;/tt&gt; from &lt;tt&gt;ehcache&lt;/tt&gt;&#160;in &lt;tt&gt;EHCacheTokenStore&lt;/tt&gt; (&lt;a href=&quot;https://github.com/apache/cxf/blob/9387c3f65862bbe9356457ad4c111eda852fcc90/rt/ws/security/src/main/java/org/apache/cxf/ws/security/tokenstore/EHCacheTokenStore.java#L56-L76&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/blob/9387c3f65862bbe9356457ad4c111eda852fcc90/rt/ws/security/src/main/java/org/apache/cxf/ws/security/tokenstore/EHCacheTokenStore.java#L56-L76&lt;/a&gt;)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-comment&quot;&gt;// Exclude the endpoint info bit added in TokenStoreUtils when getting the template name
&lt;/span&gt;            &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; template = key;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (template.contains(&lt;span class=&quot;code-quote&quot;&gt;&quot;-&quot;&lt;/span&gt;)) {
                template = key.substring(0, key.lastIndexOf(&lt;span class=&quot;code-quote&quot;&gt;&apos;-&apos;&lt;/span&gt;));
            }

            Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;&amp;gt; cacheClassLoaders = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();
            cacheClassLoaders.put(template, SecurityToken.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getClassLoader());
            XmlConfiguration xmlConfig = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; XmlConfiguration(configFileURL, ClassLoading.getDefaultClassLoader(),
                    cacheClassLoaders);

            CacheConfigurationBuilder&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, SecurityToken&amp;gt; configurationBuilder =
                    xmlConfig.newCacheConfigurationBuilderFromTemplate(template,
                            &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class, SecurityToken.class);

            cacheManager = CacheManagerBuilder.newCacheManagerBuilder().withCache(key, configurationBuilder).build();

            cacheManager.init();
            cache = cacheManager.getCache(key, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class, SecurityToken.class);

        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TokenStoreException(e);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;It seems to resolve the issue, but I&apos;m not sure about the proper implementation, and the unit tests to set &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;</description>
                <environment></environment>
        <key id="13391170">CXF-8566</key>
            <summary>cxf-ws-rt-security &amp; ehcache: OSGi classloading</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ffang">Freeman Yue Fang</assignee>
                                    <reporter username="jgreffe">Julien Greffe</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 Jul 2021 17:15:27 +0000</created>
                <updated>Wed, 22 Dec 2021 20:41:42 +0000</updated>
                            <resolved>Thu, 26 Aug 2021 18:13:26 +0000</resolved>
                                    <version>3.4.3</version>
                                    <fixVersion>3.5.0</fixVersion>
                    <fixVersion>3.4.5</fixVersion>
                                    <component>OSGi</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17385023" author="ffang" created="Wed, 21 Jul 2021 17:48:39 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jgreffe&quot; class=&quot;user-hover&quot; rel=&quot;jgreffe&quot;&gt;jgreffe&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for bringing this up.&lt;/p&gt;

&lt;p&gt;This kind of message generally means that class org.apache.cxf.ws.security.tokenstore.SecurityToken are loaded by different classloaders, which means normally you have two bundles in Karaf container which both contain the org.apache.cxf.ws.security.tokenstore.SecurityToken class.&lt;/p&gt;

&lt;p&gt;Could I get a reproducer?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;br/&gt;
Freeman&lt;/p&gt;</comment>
                            <comment id="17404466" author="jgreffe" created="Wed, 25 Aug 2021 13:51:31 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ffang&quot; class=&quot;user-hover&quot; rel=&quot;ffang&quot;&gt;ffang&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;actually there&apos;s only one bundle containing this class: &lt;tt&gt;cxf-rt-ws-security-3.4.3.jar&lt;/tt&gt;, part of feature &lt;tt&gt;cxf-ws-security&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17404485" author="ffang" created="Wed, 25 Aug 2021 14:09:13 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jgreffe&quot; class=&quot;user-hover&quot; rel=&quot;jgreffe&quot;&gt;jgreffe&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for the feedback!&lt;/p&gt;

&lt;p&gt;I took a close look at the&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
XmlConfiguration(URL url, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; classLoader, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;&amp;gt; cacheClassLoaders)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Your solution looks good to me.&lt;/p&gt;

&lt;p&gt;Could you please send a PR?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;br/&gt;
Freeman&lt;/p&gt;</comment>
                            <comment id="17405315" author="jgreffe" created="Thu, 26 Aug 2021 15:37:01 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ffang&quot; class=&quot;user-hover&quot; rel=&quot;ffang&quot;&gt;ffang&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;created these two PRs:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cxf/pull/837&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/837&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cxf/pull/838&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/838&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks,&lt;/p&gt;</comment>
                            <comment id="17405399" author="ffang" created="Thu, 26 Aug 2021 18:13:49 +0000"  >&lt;p&gt;Patch applied on behalf of &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jgreffe&quot; class=&quot;user-hover&quot; rel=&quot;jgreffe&quot;&gt;jgreffe&lt;/a&gt; with thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 11 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0t7io:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>