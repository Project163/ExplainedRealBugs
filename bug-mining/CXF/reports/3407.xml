<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:33:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-8022] Thread hangs using Reactor Flux when Exeption is Thrown</title>
                <link>https://issues.apache.org/jira/browse/CXF-8022</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;We have run into a serious issue that was not expected or caught until late&#160;&lt;br/&gt;
 it appears with CXF and Reactor in Undertow (using Spring Boot)...&#160;&lt;/p&gt;

&lt;p&gt;The Flux throws an exception inside and hangs infinitely, requiring the&#160;&lt;br/&gt;
 process to be forcibly killed (kill -9). &#160;&#160;&lt;/p&gt;

&lt;p&gt;We are using Spring Boot (latest), CXF (latest) with Reactor extension,&#160;&lt;br/&gt;
 Undertow and Reactor. &#160;Has anyone run into this and are there or could there&#160;&lt;br/&gt;
 be any potential work around to handle this?&lt;/p&gt;

&lt;p&gt;We wanted to stick with using CXF for both our standard REST resources and Reactor resources because CXF has always worked well for us plus we are using the OpenAPI swagger integration.&#160; Not being able to resolve this or have an established workaround may cause us to have to completely revert to Spring controllers.&lt;/p&gt;

&lt;p&gt;There seems to be a problem with the onComplete handling of Fluxes when it&#160;&lt;br/&gt;
 throws a RuntimeException. &#160;Basically, if you try to the endpoint, it will&#160;&lt;br/&gt;
 hang. &#160;I&apos;ve tracked it down to the writeTo function in&#160;&lt;br/&gt;
 StreamingAsyncSubscriber where the queue is empty but &quot;completed&quot; is still&#160;&lt;br/&gt;
 false so it goes into an infinite loop. &#160;You can repeat it by running the&#160;&lt;br/&gt;
 code below.&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160;@Path(&lt;span class=&quot;code-quote&quot;&gt;&quot;/errors&quot;&lt;/span&gt;)&#160;
&#160; &#160;@Produces(APPLICATION_JSON)&#160;
&#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Flux&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; errors()&#160;
&#160; &#160;{&#160;
&#160; &#160; &#160; &#160;Flux&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; response = &#160;Flux&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;.range(1, 5)&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;.flatMap(item-&amp;gt;&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;{&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (item &amp;lt;=4)&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;{&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Mono.just(&lt;span class=&quot;code-quote&quot;&gt;&quot;item: &quot;&lt;/span&gt; + item);&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;}&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;{&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;---Hitting exception&quot;&lt;/span&gt;);&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Mono.error(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&quot;runtime&#160;
error&quot;));&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;}&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;});&#160;

&#160; &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; response;&#160;
&#160; &#160;}&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I also posted this on the forums hoping someone can assist -&#160;&lt;a href=&quot;http://cxf.547215.n5.nabble.com/Thread-hangs-when-using-reactor-cxf-and-undertow-td5796369.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cxf.547215.n5.nabble.com/Thread-hangs-when-using-reactor-cxf-and-undertow-td5796369.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The log output, up until manually killing the process looks like:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.a.c.j.interceptor.JAXRSInInterceptor : Found operation: errors&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.apache.cxf.phase.PhaseInterceptorChain : Invoking handleMessage on interceptor org.apache.cxf.interceptor.OneWayProcessorIntercep tor@6e760b48&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.apache.cxf.phase.PhaseInterceptorChain : Invoking handleMessage on interceptor org.apache.cxf.interceptor.ServiceInvokerIntercept or@6d7702a0&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.a.cxf.service.invoker.AbstractInvoker : Invoking method public reactor.core.publisher.Flux io.logicdrop.drools.endpoints.DroolsR ulesetResource.errors() on object io.logicdrop.drools.endpoints.DroolsRulesetResource@23718909 with params [].&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; reactor.util.Loggers$LoggerFactory : Using Slf4j logging framework&lt;br/&gt;
---Hitting exception&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.apache.cxf.phase.PhaseInterceptorChain : Invoking handleMessage on interceptor org.apache.cxf.interceptor.OutgoingChainIntercepto r@308be65a&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.a.c.i.OutgoingChainInterceptor : Interceptors contributed by bus: []&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.a.c.i.OutgoingChainInterceptor : Interceptors contributed by service: []&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.a.c.i.OutgoingChainInterceptor : Interceptors contributed by endpoint: &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.cxf.interceptor.MessageSenderIntercept or@3f0061c3&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.a.c.i.OutgoingChainInterceptor : Interceptors contributed by binding: &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.cxf.jaxrs.interceptor.JAXRSOutIntercept or@5419dbea&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.apache.cxf.phase.PhaseInterceptorChain : Adding interceptor org.apache.cxf.interceptor.MessageSenderInterceptor@3f0061c3 to phase prepare-send&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.apache.cxf.phase.PhaseInterceptorChain : Adding interceptor org.apache.cxf.jaxrs.interceptor.JAXRSOutInterceptor@5419dbea to phas e marshal&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.apache.cxf.phase.PhaseInterceptorChain : Chain org.apache.cxf.phase.PhaseInterceptorChain@63b5b52 was created. Current flow:&lt;br/&gt;
 prepare-send &lt;span class=&quot;error&quot;&gt;&amp;#91;MessageSenderInterceptor&amp;#93;&lt;/span&gt;&lt;br/&gt;
 marshal &lt;span class=&quot;error&quot;&gt;&amp;#91;JAXRSOutInterceptor&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.apache.cxf.phase.PhaseInterceptorChain : Invoking handleMessage on interceptor org.apache.cxf.interceptor.MessageSenderIntercepto r@3f0061c3&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.apache.cxf.phase.PhaseInterceptorChain : Adding interceptor org.apache.cxf.interceptor.MessageSenderInterceptor$MessageSenderEndi ngInterceptor@30cf09f to phase prepare-send-ending&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.apache.cxf.phase.PhaseInterceptorChain : Chain org.apache.cxf.phase.PhaseInterceptorChain@63b5b52 was modified. Current flow:&lt;br/&gt;
 prepare-send &lt;span class=&quot;error&quot;&gt;&amp;#91;MessageSenderInterceptor&amp;#93;&lt;/span&gt;&lt;br/&gt;
 marshal &lt;span class=&quot;error&quot;&gt;&amp;#91;JAXRSOutInterceptor&amp;#93;&lt;/span&gt;&lt;br/&gt;
 prepare-send-ending &lt;span class=&quot;error&quot;&gt;&amp;#91;MessageSenderEndingInterceptor&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.apache.cxf.phase.PhaseInterceptorChain : Invoking handleMessage on interceptor org.apache.cxf.jaxrs.interceptor.JAXRSOutIntercept or@5419dbea&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.a.c.j.interceptor.JAXRSOutInterceptor : Response content type is: application/json&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.apache.cxf.ws.addressing.ContextUtils : retrieving MAPs from context property javax.xml.ws.addressing.context.inbound&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;DEBUG&amp;#93;&lt;/span&gt; o.apache.cxf.ws.addressing.ContextUtils : WS-Addressing - failed to retrieve Message Addressing Properties from context&lt;/p&gt;

&lt;p&gt;Same scenario with a Mono appears to show the stream &quot;completing&quot;...&lt;/p&gt;</description>
                <environment>&lt;ul&gt;
	&lt;li&gt;JDK 11&lt;/li&gt;
	&lt;li&gt;CXF 3.3.1&lt;/li&gt;
	&lt;li&gt;Spring Boot (latest)&lt;/li&gt;
	&lt;li&gt;Undertow (latest)&lt;/li&gt;
	&lt;li&gt;Reactor (latest)&lt;/li&gt;
&lt;/ul&gt;
</environment>
        <key id="13228202">CXF-8022</key>
            <summary>Thread hangs using Reactor Flux when Exeption is Thrown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="reta">Andriy Redko</assignee>
                                    <reporter username="kjq">KimJohn Quinn</reporter>
                        <labels>
                            <label>cxf</label>
                            <label>reactor</label>
                            <label>spring-boot</label>
                    </labels>
                <created>Mon, 15 Apr 2019 21:59:09 +0000</created>
                <updated>Mon, 13 May 2019 18:08:38 +0000</updated>
                            <resolved>Sun, 21 Apr 2019 16:10:29 +0000</resolved>
                                    <version>3.2.8</version>
                    <version>3.3.1</version>
                                    <fixVersion>3.2.9</fixVersion>
                    <fixVersion>3.3.2</fixVersion>
                                    <component>JAX-RS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16818462" author="kjq" created="Mon, 15 Apr 2019 23:23:27 +0000"  >&lt;p&gt;As an additional part to this, if i take the exact same stream and convert it from CXF to Spring using a @RestController the exception is correctly handled and I do not have to kill the process.&lt;/p&gt;</comment>
                            <comment id="16818957" author="kjq" created="Tue, 16 Apr 2019 12:29:20 +0000"  >&lt;p&gt;Taking a hint from Gitter, and kind of what we suspected, I can override the onError() method in the StreamingAsyncSubscriber and set completed to true and it gets closer though I am absolutely sure I am not doing it correctly.&lt;/p&gt;

&lt;p&gt;Doing so, my process does not hang but of course I dont get the exception and everything just churns through.&lt;/p&gt;</comment>
                            <comment id="16819136" author="reta" created="Tue, 16 Apr 2019 15:10:36 +0000"  >&lt;p&gt;Thanks for the investigation, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kjq&quot; class=&quot;user-hover&quot; rel=&quot;kjq&quot;&gt;kjq&lt;/a&gt;, I was able to reproduce the issue. It seems like the presence of Undertow is not really required, I was able to hit the problem even with Tomcat container.&lt;/p&gt;</comment>
                            <comment id="16819140" author="kjq" created="Tue, 16 Apr 2019 15:14:29 +0000"  >&lt;p&gt;Thanks for taking this on.&#160; That&apos;s great you can reproduce.&#160; I just want to list out everything we use just in case &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160; If we can provide any more details I would be happy to do so.&#160; We would try to debug it further but timing is not in our favor right now and unless there is a workaround or a patch we need to start looking at backing our CXF and switching to Spring REST...&lt;/p&gt;

&lt;p&gt;Is there a workaround that you can think of by any chance?&#160; Is it a complicated issue to fix?&#160;&#160;&lt;/p&gt;</comment>
                            <comment id="16819168" author="reta" created="Tue, 16 Apr 2019 15:47:24 +0000"  >&lt;p&gt;My apologies, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kjq&quot; class=&quot;user-hover&quot; rel=&quot;kjq&quot;&gt;kjq&lt;/a&gt; don&apos;t have the details yet (beside the general conclusions you came up as well), will share the findings as soon as possible, thank you.&lt;/p&gt;</comment>
                            <comment id="16819241" author="reta" created="Tue, 16 Apr 2019 16:38:10 +0000"  >&lt;p&gt;Ok, the fix is looking rather simple (I believe), I have opened the PR (&lt;a href=&quot;https://github.com/apache/cxf/pull/542)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/542&lt;/a&gt;) so the team can provide the feedback. It needs some tests and validation but I believe the direction is right. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kjq&quot; class=&quot;user-hover&quot; rel=&quot;kjq&quot;&gt;kjq&lt;/a&gt; could you give it a try please? Thanks!&lt;/p&gt;</comment>
                            <comment id="16819452" author="kjq" created="Tue, 16 Apr 2019 20:06:13 +0000"  >&lt;p&gt;Ill give it a shot but I believe, and I could just be confused at this point, I tried the exact same thing and though it passed through and completed the streams if an exception was thrown it just kept on going...&lt;/p&gt;</comment>
                            <comment id="16819615" author="reta" created="Wed, 17 Apr 2019 00:08:45 +0000"  >&lt;p&gt;Hm ... interesting, I added the test case and:&lt;/p&gt;

&lt;p&gt;&#160;- without the fix, the thread hangs and StepVerifier fails with timeout exception&lt;/p&gt;

&lt;p&gt;&#160;- after the fix, test passes normally&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kjq&quot; class=&quot;user-hover&quot; rel=&quot;kjq&quot;&gt;kjq&lt;/a&gt; may the binaries weren&apos;t picked up in your case, leading to confusion?&lt;/p&gt;</comment>
                            <comment id="16819619" author="kjq" created="Wed, 17 Apr 2019 00:15:04 +0000"  >&lt;p&gt;Let me check in the next hour or so.&#160; It has been a hectic day...&lt;/p&gt;</comment>
                            <comment id="16819643" author="kjq" created="Wed, 17 Apr 2019 01:16:45 +0000"  >&lt;p&gt;This definitely gets past the thread hanging which is a good thing but now I am looking at the exception handling, which worked prior to the patch, and the fact the response is always coming back as a 200.&lt;/p&gt;

&lt;p&gt;I have a test stream that looks like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;
    .findArtifact(artifact, project, client)
    .&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(Ruleset.class)
    .flatMapMany(a -&amp;gt; {
        &lt;span class=&quot;code-comment&quot;&gt;//For each file generate rules
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; fromIterable(files)
            .map(File::&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;)
            .filter(GeneratorResource::checkExtension)
            .publishOn(elastic())
            .flatMap(f -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.decisionTableService
                .getSources(f)
                &lt;span class=&quot;code-comment&quot;&gt;//For each sheet
&lt;/span&gt;                .flatMap(sheet -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.decisionTableService
                    &lt;span class=&quot;code-comment&quot;&gt;//Generate details
&lt;/span&gt;                    .generateTable(sheet, f)
                    .flatMapMany(table -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.decisionTableService
                        &lt;span class=&quot;code-comment&quot;&gt;//Generate rows
&lt;/span&gt;                        .generateRules(table, f)
                        &lt;span class=&quot;code-comment&quot;&gt;//Buffer rows
&lt;/span&gt;                        .buffer(buffer)
                        &lt;span class=&quot;code-comment&quot;&gt;//Find and remove matches then merge &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; save
&lt;/span&gt;                        .flatMap(rules -&amp;gt; replace(rules, a)))));
    })
    .onErrorMap(RulesetResourceException::&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The&#160;&lt;b&gt;findArtifact&lt;/b&gt; used to throw a NotFoundException which resulted in the ExceptionMapper kicking in and returning the proper HTTP error (404).&lt;/p&gt;

&lt;p&gt;The code from &lt;b&gt;findArtifact&lt;/b&gt; looks like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
    .findProject(project, client)
    .flatMap(p -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.artifactService
        .findByName(artifact, p)
        .switchIfEmpty(error(NotFoundException::&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;)))
    .onErrorMap(ArtifactResourceException::&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And the CXF ExceptionMapper handles the exception.&#160; So, if I have a bad &quot;artifact&quot;, &quot;project&quot; any one of those would throw the exception and should terminate the stream.&#160; With the patch,&#160;the exception is not being returned and the resource results always in a 200 but I can see in the log where the ExceptionMapper did in fact pick up the error (which leads me to believe it might be something on how I am handling the exception).&lt;/p&gt;

&lt;p&gt;But, at least right now, it looks like any exceptions leading up to the &quot;getSources&quot; where I am forcibly throwing a RuntimeException, get passed up.&lt;/p&gt;

&lt;p&gt;This could be me handling errors improperly so I am investigating it with the patch applied - I was under the assumption that the onErrorMap is treated as the equivalent of rethrowing so I can get to the ExceptionMapper but I just wanted to get my thoughts down and over to you.&lt;/p&gt;

&lt;p&gt;I am looking at my exception handling now so don&apos;t take this as me saying the patch does not work &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&#160; In fact, im inclined to believe it is something i am doing wrong...&lt;/p&gt;

&lt;p&gt;And by the way, thank you for you help too - it is greatly appreciated.&lt;/p&gt;</comment>
                            <comment id="16819651" author="kjq" created="Wed, 17 Apr 2019 01:32:32 +0000"  >&lt;p&gt;Better example using our working test:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//Run through the flux
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Flux
        .range(1, 5)
        .flatMap(item -&amp;gt;
                 {
                     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (item &amp;lt;= 4)
                     {
                         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Mono.just(&lt;span class=&quot;code-quote&quot;&gt;&quot;item: &quot;&lt;/span&gt; + item);
                     }
                     &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
                     {
                         &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;---Hitting exception&quot;&lt;/span&gt;);
                         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; error(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NotFoundException());
                     }
                 })
        .onErrorMap(ArtifactResourceException::&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I would of expected the error to get caught by the ExceptionMapper.&#160; Instead it gives me a partial JSON response (invalid) and returns a 200.&lt;/p&gt;

&lt;p&gt;Referring to my above example with &quot;findArtifact&quot; that stream will in fact return the 404 if the result is empty and that is getting to the ExceptionMapper.&lt;/p&gt;

&lt;p&gt;&#160;If i trace/debug from the IDE i do see the exception getting to the onErrorMap.&lt;/p&gt;

&lt;p&gt;The above is similar to what other methods do where the ExceptionMapper caught it.&#160; The above, even though it gets to the errorMap, does not get caught.&lt;/p&gt;</comment>
                            <comment id="16819654" author="reta" created="Wed, 17 Apr 2019 01:49:08 +0000"  >&lt;p&gt;Yes, confirming the same observations. When thread hanging was gone, I run into the surprising error handling part (partial successful response), not what I would have expected. I will be looking further to figure out why the error is not properly propagated, thanks for your great help &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kjq&quot; class=&quot;user-hover&quot; rel=&quot;kjq&quot;&gt;kjq&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16819660" author="kjq" created="Wed, 17 Apr 2019 02:05:19 +0000"  >&lt;p&gt;Maybe I am asking the wrong question and your patch does indeed work as the thread does not hang.&#160; What I am looking at with the Flux is to get the exception to the CXF ExceptionMapper.&#160; I do not want to drop the bad element and continue but instead want to return an error.&lt;/p&gt;

&lt;p&gt;Doing this in place of the above works as expected:&lt;/p&gt;

&lt;p&gt;return Mono.error(new NotFoundException());&lt;/p&gt;

&lt;p&gt;BTW, thanks again!&lt;/p&gt;</comment>
                            <comment id="16819682" author="kjq" created="Wed, 17 Apr 2019 02:53:55 +0000"  >&lt;p&gt;May be a shot in the dark as I am getting lost tracing through but it looks like the&#160;AsyncResponseImpl is not getting handled correctly in the case of Flux at least.&#160; Where it looks to expect/handle an exception the result processing skips over that.&lt;/p&gt;

&lt;p&gt;Tracing it, it goes to the onComplete().&#160; I would think it goes to onError() though onComplete has the updateCompletionCallback(throwable) but throwable is null.&lt;/p&gt;

&lt;p&gt;Or maybe not, comparing it to the Mono that throws the exception it is thrown and logged long before and the same things above are null.&lt;/p&gt;

&lt;p&gt;One thing I am pretty sure of is that this is isolated to Flux type operations - any now with the patch do not handle exceptions.&#160; The Mono operations I tested seem to still work.&lt;/p&gt;</comment>
                            <comment id="16819967" author="reta" created="Wed, 17 Apr 2019 10:52:48 +0000"  >&lt;p&gt;Right, since Flux is using streaming, I believe Mono takes the different path, I will try spend time today to understand why.&lt;/p&gt;</comment>
                            <comment id="16819973" author="kjq" created="Wed, 17 Apr 2019 10:58:54 +0000"  >&lt;p&gt;Thank you!&#160; It is close and at least the thread is not hanging.&#160; I tried to debug it last night but I am not as familiar with the code.&lt;/p&gt;</comment>
                            <comment id="16820505" author="kjq" created="Wed, 17 Apr 2019 21:07:12 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reta&quot; class=&quot;user-hover&quot; rel=&quot;reta&quot;&gt;reta&lt;/a&gt;.&#160; Checking if to see if you have any insight since this is a critical issue for us.&lt;/p&gt;

&lt;p&gt;We tried to debug it further and found that we could override the &apos;resume()&apos; method in the AsyncResponse and at least get the exception thrown properly (it seemed) from the tests we use.&#160; But, in a deeper Flux (more closely to what I posted way up) the exception is still not being bubbled up,&#160; Hopefully this might provide some insight for you...&lt;/p&gt;

&lt;p&gt;&lt;b&gt;AsyncResponse Changes:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; resume(Throwable response)
{
    &lt;span class=&quot;code-comment&quot;&gt;//Set the object to the throwable
&lt;/span&gt;    cont.setObject(response);

    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; doResume(response);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This one, also in the AsyncResponse, worried us based on the change above...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;//Probably should be investigated more later...
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isSuspended())
{
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So, it is close...one thing to note, if we do not explicitly handle the error we do get a 500 and no other response.&#160; Using one of my custom exceptions goes to the ExceptionMapper.&lt;/p&gt;

&lt;p&gt;Adding to our investigation, the above works with simple/single stream entry/exit points but when we introduce another stream, that would return a Mono in this case and internally throws a runtime exception caught by a onErrorMap) the propagation is skipped and we get back a 200 not even a 500.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.findProject(&lt;span class=&quot;code-quote&quot;&gt;&quot;nope&quot;&lt;/span&gt;, client)
    .flatMapMany(c -&amp;gt;
                 {...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16820676" author="reta" created="Thu, 18 Apr 2019 03:01:41 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kjq&quot; class=&quot;user-hover&quot; rel=&quot;kjq&quot;&gt;kjq&lt;/a&gt;, sorry was a long day. So here is the issue, the AsyncResponse implementation in CXF is resumable only once. This is why we don&apos;t observe the onError() call effect. It leaves us with a few choice:&lt;/p&gt;

&lt;p&gt;&#160;- if the onNext() has been called, the throwable will be propagated using StreamingResponseImpl (this is not ideal since only RuntimeException and IOException could be thrown)&lt;/p&gt;

&lt;p&gt;&#160;- otherwise using normal resume(t) operation&lt;/p&gt;

&lt;p&gt;Changing the AsyncResponse&#160; semantics to be resumable multiple times is risky (and I believe is going against JAX-RS specification). There is also an option to use the AsyncContext directly but it might be difficult to do. I have updated the PR to use the StreamingResponseImpl for error propagation, I can confirm that for scenarios I have checked so far a) exception mappers are called b) response status is propagated.&lt;/p&gt;

&lt;p&gt;Could you give it a try please? Thanks a lot!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16820973" author="kjq" created="Thu, 18 Apr 2019 11:16:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reta&quot; class=&quot;user-hover&quot; rel=&quot;reta&quot;&gt;reta&lt;/a&gt; - i am beside myself with joy right now.&#160; So far, this seems to work and though it might not be the ideal (referring to your points above) it is more than good enough right now!&lt;/p&gt;

&lt;p&gt;A quick pass and just spot testing all of the expected exceptions are being handled as I would expect.&#160; I will continue testing through the day, but I believe this is resolved for now, just to make sure nothing new or weird crops up as a side-effect.&lt;/p&gt;

&lt;p&gt;I cannot thank you enough for your help.&#160; As has been my experience working with CXF and the CXF team over the last decade you all have been one of my favorites to work with and I rarely have issues but when I do you all respond and I have yet to encounter anything fatal.&#160; This may of been the most fatal thing I have had to reach out for ever with CXF!&lt;/p&gt;

&lt;p&gt;If I had to back out CXF I would of lost so much time converting to pure Spring.&#160; It was doable but would of introduced its own set of issues and really did not fit the architecture we are going for.&lt;/p&gt;

&lt;p&gt;Once again, thank you so much - it is appreciated more than you can realize!&#160; If we go to ApacheCon and you are there I will buy you a beer (or dinner or whatever)!&lt;/p&gt;</comment>
                            <comment id="16821102" author="reta" created="Thu, 18 Apr 2019 13:29:42 +0000"  >&lt;p&gt;Thanks a lot for checking out &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kjq&quot; class=&quot;user-hover&quot; rel=&quot;kjq&quot;&gt;kjq&lt;/a&gt;, really glad to hear the problem is solved. I will also do more tests and enrich the test suite before merging the PR.&#160; Thanks a lot for your kind words, we are certainly committed to do our best to help out, particularly with such a serious blocker. The&#160;support you guys provided to nail the issue and understand the scope, was outstanding, thank you very much for that. Hope to see you one day at ApacheCon!&#160;&lt;/p&gt;</comment>
                            <comment id="16821506" author="kjq" created="Thu, 18 Apr 2019 21:37:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reta&quot; class=&quot;user-hover&quot; rel=&quot;reta&quot;&gt;reta&lt;/a&gt; - everything is looking good.&#160; I think I can say we are happy/satisfied with this solution and nothing has cropped up yet.&#160; I&apos;ll give it till Friday but we can close this ticket.&lt;/p&gt;

&lt;p&gt;One minor adjustment we just made, but have not tested yet, is move the &quot;throws&quot; in the &quot;writeTo&quot; to before the writer starts going.&#160; We saw one place where we got an empty stream then the exception - we believe this will prevent the partial/empty response.&lt;/p&gt;

&lt;p&gt;Change to StreamingAsyncSubscriber&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (throwable != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
{
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (throwable &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; RuntimeException)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; (RuntimeException)throwable;
    }
    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (throwable &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; IOException)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; (IOException)throwable;
    }
    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
    {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(throwable);
    }
}

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (openTag != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
{
    writer.getEntityStream().write(StringUtils.toBytesUTF8(openTag));
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Once again, I can&apos;t thank you enough for all your help!&lt;/p&gt;</comment>
                            <comment id="16821593" author="reta" created="Fri, 19 Apr 2019 00:59:28 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kjq&quot; class=&quot;user-hover&quot; rel=&quot;kjq&quot;&gt;kjq&lt;/a&gt;, awesome. Regarding the empty response (empty stream), you are very right, yet another issue to fix (essentially, the idea is if nothing has been written yet, do not write the open and close tags, postpone it to the moment when the data become available or completion, unless the exception is raised).&#160; It also revealed the issue on the client side: when response is empty the exception is thrown inside getFlux() method instead of propagating the using the onError() callback. All fixes went into the PR, along with test cases.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13228453">CXF-8023</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 30 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z01ta8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>