<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:38:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-8590] First invocation of method causes NPE failure in neethi.PolicyBuilder</title>
                <link>https://issues.apache.org/jira/browse/CXF-8590</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;I have a multithreaded application where each thread does the following:&lt;br/&gt;
new SomeService&lt;br/&gt;
 .getPort()&lt;br/&gt;
 .invokeSomeEndpointMethod()&lt;/p&gt;

&lt;p&gt;The first invocation of the endpoint method cases the following error:&lt;/p&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.reflect.InvocationTargetException
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.apache.neethi.builders.converters.ConverterRegistry.findQName(ConverterRegistry.java:121)
	at org.apache.neethi.PolicyBuilder.processOperationElement(PolicyBuilder.java:204)
	at org.apache.neethi.PolicyBuilder.getPolicyOperator(PolicyBuilder.java:174)
	at org.apache.neethi.PolicyBuilder.getPolicy(PolicyBuilder.java:124)
	at org.apache.cxf.ws.policy.attachment.wsdl11.Wsdl11AttachmentPolicyProvider.getElementPolicy(Wsdl11AttachmentPolicyProvider.java:192)
	at org.apache.cxf.ws.policy.attachment.wsdl11.Wsdl11AttachmentPolicyProvider.getElementPolicy(Wsdl11AttachmentPolicyProvider.java:168)
	at org.apache.cxf.ws.policy.attachment.wsdl11.Wsdl11AttachmentPolicyProvider.getElementPolicy(Wsdl11AttachmentPolicyProvider.java:161)
	at org.apache.cxf.ws.policy.attachment.wsdl11.Wsdl11AttachmentPolicyProvider.getEffectivePolicy(Wsdl11AttachmentPolicyProvider.java:75)
	at org.apache.cxf.ws.policy.PolicyEngineImpl.getAggregatedServicePolicy(PolicyEngineImpl.java:461)
	at org.apache.cxf.ws.policy.EndpointPolicyImpl.initializePolicy(EndpointPolicyImpl.java:151)
	at org.apache.cxf.ws.policy.EndpointPolicyImpl.initialize(EndpointPolicyImpl.java:140)
	at org.apache.cxf.ws.policy.PolicyEngineImpl.createEndpointPolicyInfo(PolicyEngineImpl.java:614)
	at org.apache.cxf.ws.policy.PolicyEngineImpl.getEndpointPolicy(PolicyEngineImpl.java:326)
	at org.apache.cxf.ws.policy.PolicyEngineImpl.getClientEndpointPolicy(PolicyEngineImpl.java:313)
	at org.apache.cxf.ws.policy.PolicyDataEngineImpl.getClientEndpointPolicy(PolicyDataEngineImpl.java:61)
	at org.apache.cxf.transport.http.HTTPConduit.updateClientPolicy(HTTPConduit.java:326)
	at org.apache.cxf.transport.http.HTTPConduit.updateClientPolicy(HTTPConduit.java:346)
	at org.apache.cxf.transport.http.HTTPConduit.getClient(HTTPConduit.java:892)
	at org.apache.cxf.transport.http.HTTPConduit.configureConduitFromEndpointInfo(HTTPConduit.java:368)
	at org.apache.cxf.transport.http.HTTPConduit.finalizeConfig(HTTPConduit.java:448)
	at org.apache.cxf.transport.http.HTTPTransportFactory.getConduit(HTTPTransportFactory.java:249)
	at org.apache.cxf.binding.soap.SoapTransportFactory.getConduit(SoapTransportFactory.java:226)
	at org.apache.cxf.binding.soap.SoapTransportFactory.getConduit(SoapTransportFactory.java:233)
	at org.apache.cxf.endpoint.AbstractConduitSelector.createConduit(AbstractConduitSelector.java:144)
	at org.apache.cxf.endpoint.AbstractConduitSelector.getSelectedConduit(AbstractConduitSelector.java:108)
	at org.apache.cxf.endpoint.UpfrontConduitSelector.prepare(UpfrontConduitSelector.java:63)
	at org.apache.cxf.endpoint.ClientImpl.prepareConduitSelector(ClientImpl.java:887)
	at org.apache.cxf.endpoint.ClientImpl.doInvoke(ClientImpl.java:525)
	at org.apache.cxf.endpoint.ClientImpl.invoke(ClientImpl.java:441)
	at org.apache.cxf.endpoint.ClientImpl.invoke(ClientImpl.java:356)
	at org.apache.cxf.endpoint.ClientImpl.invoke(ClientImpl.java:314)
	at org.apache.cxf.frontend.ClientProxy.invokeSync(ClientProxy.java:96)
	at org.apache.cxf.jaxws.JaxWsClientProxy.invoke(JaxWsClientProxy.java:140)
...
	at org.quartz.simpl.SimpleThreadPool$WorkerThread.run(SimpleThreadPool.java:573)
Caused by: java.lang.NullPointerException
	at com.sun.org.apache.xerces.internal.dom.DeferredElementNSImpl.synchronizeData(DeferredElementNSImpl.java:108)
	at com.sun.org.apache.xerces.internal.dom.ElementNSImpl.getLocalName(ElementNSImpl.java:338)
	at org.apache.neethi.builders.converters.AbstractDOMConverter.getQName(AbstractDOMConverter.java:43)
	... 45 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;From there on, everything works fine. The service in question uses policies, and apparently policies are lazily initialized. &lt;br/&gt;
The actual failure is triggered by a race condition causing ElementNSImpl from xerces to be being shared across threads as a consequence.&lt;/p&gt;

&lt;p&gt;This happens in org.apache.cxf.ws.policy.attachment.wsdl11.Wsdl11AttachmentPolicyProvider.getElementPolicy, when the PolicyRegistry is consulted:&lt;/p&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                        Policy policy = registry.lookup(id);
                        if (policy == null) {
                            try {
                                policy = builder.getPolicy(e.getElement());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;All threads will start building the missing policy, as there is nothing in the registry and no synchronization on a cache miss. Some thread wins the race and gets a usable result from e.getElement() and stores the result in the registry, the others hit the NPE-error.&lt;/p&gt;

&lt;p&gt;I do not really understand all the internal workings, but I can cure this problem by changing the code snippet to:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                        synchronized (e.getElement()) {
                           Policy policy = registry.lookup(id);
                           if (policy == null) {
                               try {
                                   policy = builder.getPolicy(e.getElement());
                                   
                           ...
                        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That solves the race to initialize the entry in the registry, but not the real problem.&lt;/p&gt;

&lt;p&gt;This leaves me with 3 questions:&lt;br/&gt;
Is there a way to eagerly populate the PolicyRegistry as an user of CXF?&lt;br/&gt;
Shouldn&apos;t Wsdl11AttachmentPolicyProvider be thread safe, if policies are to be lazily initialized?&lt;br/&gt;
How do we prevent the WSDLManager in the Service from sharing non-tread safe items (ElementNSImpl) across threads? &lt;br/&gt;
Apparently org.apache.cxf.jaxws.ServiceImpl.initialize always selects the same bus, which cases the WSDLManager to be shared between threads. Normally that would be a good thing, since we can share the WSDL-cache.&lt;/p&gt;

&lt;p&gt;I tried to build a test-case, so far I have no luck in building the required configuration. Also, which submodule is to blame here? A lot of components are involved.&lt;br/&gt;
Please ask for more details if required.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
 Kim Johan Andersson&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13398676">CXF-8590</key>
            <summary>First invocation of method causes NPE failure in neethi.PolicyBuilder</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ffang">Freeman Yue Fang</assignee>
                                    <reporter username="kim.johan.andersson">Kim Johan Andersson</reporter>
                        <labels>
                    </labels>
                <created>Wed, 1 Sep 2021 13:20:49 +0000</created>
                <updated>Wed, 22 Dec 2021 20:41:43 +0000</updated>
                            <resolved>Thu, 2 Sep 2021 18:29:13 +0000</resolved>
                                    <version>3.4.4</version>
                                    <fixVersion>3.5.0</fixVersion>
                    <fixVersion>3.4.5</fixVersion>
                                    <component>Core</component>
                    <component>WS-* Components</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17408202" author="ffang" created="Wed, 1 Sep 2021 14:32:21 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kim.johan.andersson&quot; class=&quot;user-hover&quot; rel=&quot;kim.johan.andersson&quot;&gt;kim.johan.andersson&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for raising this question!&lt;/p&gt;

&lt;p&gt;Just FYI, per the document here&lt;br/&gt;
&lt;a href=&quot;http://cxf.apache.org/faq.html#FAQ-AreJAX-WSclientproxiesthreadsafe?&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cxf.apache.org/faq.html#FAQ-AreJAX-WSclientproxiesthreadsafe?&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;JAX-WS client proxies are not thread safe, you should use synchronize access or use a pool of instances for the multiple client proxies you used in your code(which means you can&apos;t use a bunch of client proxies at the same time, instead you should synchronize access the client proxies).&lt;/p&gt;

&lt;p&gt;CXF Client proxies are not thread safe for several cases, not only the conduit configuration(which is your case since the policy got involved here), but also a few other cases as mentioned in CXF &lt;a href=&quot;http://cxf.apache.org/faq.html#FAQ-AreJAX-WSclientproxiesthreadsafe?&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FAQ&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;Freeman&lt;/p&gt;


</comment>
                            <comment id="17408272" author="kim.johan.andersson" created="Wed, 1 Sep 2021 16:38:42 +0000"  >&lt;p&gt;Thanks for you response. So there is no real way a user can ascertain what is actually thread safe or not?&lt;/p&gt;

&lt;p&gt;Perhaps the problem here is that I do not understand what is considered part of the client proxy.&lt;/p&gt;

&lt;p&gt;The document you link to discusses sharing of the Port returned by the Service ( something that extends&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;javax.xml.ws.Service)&lt;/font&gt;. In the case I have described, we hit the problem even when making a new Service and a new Port instance in seperate threads.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;Going by the JavaDoc, &lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;javax.xml.ws.Service is the factory for Proxies. So we are not using proxies cross-thread.&lt;br/&gt;
&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;Maybe I got it wrong, but I don&apos;t really see how we can really call anything (safely) in CXF from more than one JVM thread if I got the above wrong.&lt;/font&gt;&lt;/p&gt;</comment>
                            <comment id="17408304" author="ffang" created="Wed, 1 Sep 2021 17:56:38 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kim.johan.andersson&quot; class=&quot;user-hover&quot; rel=&quot;kim.johan.andersson&quot;&gt;kim.johan.andersson&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I get your point now, and your proposed fix(synchronized (e.getElement())) looks good to me.&lt;/p&gt;

&lt;p&gt;A PR is very welcome!&lt;/p&gt;

&lt;p&gt;Thanks!&lt;br/&gt;
Freeman&lt;/p&gt;</comment>
                            <comment id="17408340" author="kim.johan.andersson" created="Wed, 1 Sep 2021 19:21:15 +0000"  >&lt;p&gt;I will try to get a PR worked out. But I have the distinct sense that&#160; synchronizing on e.getElement() is treating the symptom, and not the cause.&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;Wsdl11AttachmentPolicyProvider.&lt;/font&gt;&lt;font color=&quot;#00627a&quot;&gt;getElementPolicy doesn&apos;t really know that it has been dealt a bad hand, in the sense that somebody else stuffed a non-thread safe&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;UnknownExtensibilityElement into the DescriptionInfo. The problem is bound to appear everywhere &lt;/font&gt;&lt;font color=&quot;#000000&quot;&gt;UnknownExtensibilityElement.getElement is called.&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#00627a&quot;&gt;&#160;&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;&#160;&lt;/font&gt;&lt;/p&gt;</comment>
                            <comment id="17408365" author="ffang" created="Wed, 1 Sep 2021 20:31:36 +0000"  >&lt;p&gt;I think the root cause is that the Xerces Dom implementation isn&apos;t thread safe, please see &lt;br/&gt;
&lt;a href=&quot;https://xerces.apache.org/xerces2-j/faq-dom.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://xerces.apache.org/xerces2-j/faq-dom.html&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Is Xerces DOM implementation thread-safe?	
		
	
No. DOM does not require implementations to be thread safe. If you need to access the DOM from multiple threads, you are required to add the appropriate locks to your application code.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So add the appropriate locks to application code should be the way to go. &lt;br/&gt;
Of course ideally we can add the synchronized locks in Apache neethi code, which is closer to the root of stackrtrace. But I&apos;m also thinking to fix it in CXF codebase, at least before the fix available in Apache neethi.&lt;/p&gt;

&lt;p&gt;Freeman&lt;/p&gt;</comment>
                            <comment id="17408787" author="kim.johan.andersson" created="Thu, 2 Sep 2021 12:39:35 +0000"  >&lt;p&gt;Yes, the underlying issue is the lack of thread safety in the DOM-implementation. I have gone through the call sites of&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;UnknownExtensibilityElement.getElement, and added synchronization on the ownerDocument. I noticed that other places in the code follows that pattern.&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;I have made a pull request for the change.&lt;/font&gt;&lt;/p&gt;</comment>
                            <comment id="17409025" author="ffang" created="Thu, 2 Sep 2021 18:13:56 +0000"  >&lt;p&gt;patch applied on behalf of &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kim.johan.andersson&quot; class=&quot;user-hover&quot; rel=&quot;kim.johan.andersson&quot;&gt;kim.johan.andersson&lt;/a&gt; with thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 10 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0uhts:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>