<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:00:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-4986] jax-rs2 request filter is unable to modify request header by adding a new header </title>
                <link>https://issues.apache.org/jira/browse/CXF-4986</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;I have a filter implementation as follows&lt;/p&gt;

&lt;p&gt;@Provider&lt;br/&gt;
public class AuthSessionFilter implements ContainerRequestFilter {&lt;br/&gt;
    public AuthSessionFilter() {&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;    @Override&lt;br/&gt;
    public void filter(ContainerRequestContext requestContext) throws IOException {      &lt;br/&gt;
        //another @Prematching filter is setting this session id so it is definitely not null&lt;br/&gt;
        Object sessionId = requestContext.getProperty(&quot;sessionId&quot;);&lt;br/&gt;
        if (sessionId == null || GeneralUtils.isNullOrBlank(sessionId + &quot;&quot;)) &lt;/p&gt;
{
            requestContext.abortWith(Response.status(Response.Status.UNAUTHORIZED)
                    .entity(&quot;missing sessionId&quot;).build());
        }

&lt;p&gt;       //this line gets invoked without problems, however, the added header is not available from the resource class&lt;br/&gt;
        requestContext.getHeaders().putSingle(&quot;sessionId&quot;, sessionId+&quot;&quot;);&lt;br/&gt;
    }&lt;br/&gt;
}&lt;/p&gt;


&lt;p&gt;The line requestContext.getHeaders().putSingle(&quot;sessionId&quot;, sessionId+&quot;&quot;); is not making the added sessionId header available when trying to obtain it from my resource. getHeaders() is supposed to return a mutable map in accordance with the spec, but its implementation &apos;ContainerRequestContextImpl&apos; is returning a readonly map instead. it returning:&lt;/p&gt;

&lt;p&gt;  return new MetadataMap&amp;lt;String, String&amp;gt;(&lt;br/&gt;
            (Map&amp;lt;String, List&amp;lt;String&amp;gt;&amp;gt;)m.get(Message.PROTOCOL_HEADERS), false, true, true);&lt;/p&gt;

&lt;p&gt;where it is passing &apos;true&apos; for the readonly parameter.&lt;/p&gt;


&lt;p&gt;in my resource, I am trying to obtain the header using&lt;/p&gt;

&lt;p&gt;public Response doSomething(UriInfo uriInfo, HttpServletRequest request) {&lt;br/&gt;
        //this is always null even though it shouldn&apos;t be null&lt;/p&gt;

&lt;p&gt;        String sessionId = request.getHeader(&quot;sessionId&quot;);&lt;br/&gt;
}&lt;/p&gt;

</description>
                <environment>&lt;p&gt;cxf on tomcat&lt;/p&gt;</environment>
        <key id="12644571">CXF-4986</key>
            <summary>jax-rs2 request filter is unable to modify request header by adding a new header </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sergey_beryozkin">Sergey Beryozkin</assignee>
                                    <reporter username="abdelgadiri">abdelgadiri</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Apr 2013 10:16:39 +0000</created>
                <updated>Fri, 16 Aug 2013 14:12:30 +0000</updated>
                            <resolved>Fri, 16 Aug 2013 14:12:30 +0000</resolved>
                                    <version>2.7.2</version>
                                    <fixVersion>2.7.5</fixVersion>
                    <fixVersion>3.0.0-milestone1</fixVersion>
                                    <component>JAX-RS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13641646" author="abdelgadiri" created="Thu, 25 Apr 2013 10:48:34 +0000"  >&lt;p&gt;I have now tried an alternative approach. I have my @Prematching filter call&lt;/p&gt;

&lt;p&gt;sessionId = ... //non null session id&lt;br/&gt;
requestContext.setProperty(&quot;sessionId&quot;, sessionId);&lt;/p&gt;

&lt;p&gt;according to the specification/java-doc of setProperty() method&lt;br/&gt;
&quot;In a Servlet container, the properties are synchronized with the ServletRequest and expose all the attributes available in the ServletRequest. Any modifications of the properties are also reflected in the set of properties of the associated ServletRequest.&quot;&lt;/p&gt;

&lt;p&gt;so in my resource, I am trying:&lt;/p&gt;


&lt;p&gt;public Response dosomething(UriInfo uriInfo, HttpServletRequest request) {&lt;br/&gt;
//this fails - sessionId is always null&lt;br/&gt;
Object sessionId = request.getAttribute(&quot;sessionId&quot;)&lt;/p&gt;

&lt;p&gt;//this also fails - sessionId is always null&lt;br/&gt;
sessionId = request.getParameter(&quot;sessionId&quot;);&lt;/p&gt;

&lt;p&gt;return Response.ok().build();&lt;br/&gt;
}&lt;/p&gt;


&lt;p&gt;so, it looks like cxf is not allowing filters to modify the request&lt;/p&gt;</comment>
                            <comment id="13641666" author="sergey_beryozkin" created="Thu, 25 Apr 2013 11:01:16 +0000"  >&lt;p&gt;Ouch, I really thought I managed to convince the spec lead to get rid of this reference to ServletRequest and I thought they did some work but it stayed, really bad idea IMHO, the filters will see the HTTP request attributes set before the JAX-RS runtime even executes. Sigh. Have to fix that, thanks for spotting that. FYI, we have the tests where the filters pass the properties around, though they are not persisted into HTTP request...&lt;/p&gt;

</comment>
                            <comment id="13641667" author="sergey_beryozkin" created="Thu, 25 Apr 2013 11:03:28 +0000"  >&lt;p&gt;Also, can you start working with CXF 2.7.4 please ? Quite a few fixes went into this specific area, though I can see this JIRa is still valid&lt;/p&gt;</comment>
                            <comment id="13641672" author="abdelgadiri" created="Thu, 25 Apr 2013 11:10:02 +0000"  >&lt;p&gt;Thanks for the info. &lt;/p&gt;

&lt;p&gt;Yes, I am able to pass properties between filters without any problems, it is just when I try to pass a property onto the request where it is failing.&lt;/p&gt;

&lt;p&gt;So, how can I make my filter add a property/header/parameter that is then retrievable from the resource ?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="13641675" author="sergey_beryozkin" created="Thu, 25 Apr 2013 11:13:33 +0000"  >&lt;p&gt;Right, this is your requirement, inject HttpServletRequest into the filter, and then access it from the resource. Please switch to 2.7.4 though first&lt;/p&gt;</comment>
                            <comment id="13641676" author="abdelgadiri" created="Thu, 25 Apr 2013 11:16:09 +0000"  >&lt;p&gt;Thank you very much. I will give it a try after upgrading to 2.7.4&lt;/p&gt;</comment>
                            <comment id="13641699" author="abdelgadiri" created="Thu, 25 Apr 2013 11:54:03 +0000"  >&lt;p&gt;First thank you for your speedy responses.&lt;/p&gt;

&lt;p&gt;I have upgraded to 2.7.4 then injected a HttpServletRequest into my filter via&lt;/p&gt;

&lt;p&gt;@Context HttpServletRequest request;&lt;/p&gt;

&lt;p&gt;This appears to have injected an instance of ThreadLocalHttpServletRequest. However, calling setAttribute() on this request instance is throwing a NullPointerException.&lt;/p&gt;

&lt;p&gt;the setAttribute() method is implemented as&lt;/p&gt;

&lt;p&gt;public void setAttribute(String name, Object o) &lt;/p&gt;
{
        get().setAttribute(name, o);

}

&lt;p&gt;and it appears get() is returning null hence the thrown exception&lt;/p&gt;


&lt;p&gt;Is this related to your previous comment regarding initialization of the jax-rs runtime when the filter is executed?&lt;/p&gt;




</comment>
                            <comment id="13641708" author="sergey_beryozkin" created="Thu, 25 Apr 2013 12:06:25 +0000"  >&lt;p&gt;I&apos;ve updated my test locally so far and it works fine for me. Can you double check you have CXF 2.7.4 in the libs ?&lt;/p&gt;</comment>
                            <comment id="13641737" author="abdelgadiri" created="Thu, 25 Apr 2013 12:53:08 +0000"  >&lt;p&gt;Yes - it now works. I just needed to clean up my build.&lt;br/&gt;
Thank you for your help&lt;/p&gt;</comment>
                            <comment id="13642784" author="sergey_beryozkin" created="Fri, 26 Apr 2013 12:26:28 +0000"  >&lt;p&gt;Header and property related issues have been fixed&lt;/p&gt;</comment>
                            <comment id="13742235" author="abdelgadiri" created="Fri, 16 Aug 2013 14:08:21 +0000"  >&lt;p&gt;war to reproduce the issue&lt;/p&gt;</comment>
                            <comment id="13742236" author="abdelgadiri" created="Fri, 16 Aug 2013 14:08:54 +0000"  >&lt;p&gt;source maven project to reproduce the issue&lt;/p&gt;</comment>
                            <comment id="13742238" author="abdelgadiri" created="Fri, 16 Aug 2013 14:11:10 +0000"  >&lt;p&gt;attached is the code to reproduce the issue. I would deploy the war file to my tomcat then run the test cases in the attached source project. One of the test cases (smallpayload) is always succeeding while the other testcase (largepayload) is always failing&lt;/p&gt;</comment>
                            <comment id="13742239" author="abdelgadiri" created="Fri, 16 Aug 2013 14:12:30 +0000"  >&lt;p&gt;sorry I had reopened the wrong issue. it should be issue &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-5201&quot; title=&quot;jaxrs2: unable to intercept response to add new response headers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-5201&quot;&gt;&lt;del&gt;CXF-5201&lt;/del&gt;&lt;/a&gt;. closing this one&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12598467" name="bug4986-1.0.war" size="8677042" author="abdelgadiri" created="Fri, 16 Aug 2013 14:08:21 +0000"/>
                            <attachment id="12598468" name="bug4986.zip" size="17766" author="abdelgadiri" created="Fri, 16 Aug 2013 14:08:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>324936</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 14 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1k25z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>325281</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>