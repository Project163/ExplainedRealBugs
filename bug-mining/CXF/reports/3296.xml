<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:31:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-7591] memory leak in ClientImpl</title>
                <link>https://issues.apache.org/jira/browse/CXF-7591</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;My app is a web-app and my wildfly has ~ 300 thread. If I understand correctly the code, ClientImpl.responseContext is cleaned only on destroy. We use a lot of service ad some of them have a large output (~10Mb). So, I need a lot of memory for storing ClientImpl.responseContext.&lt;/p&gt;

&lt;p&gt;I try the following patch ant it seems to solve the problem, but it has an &lt;br/&gt;
horrible cast.&lt;/p&gt;


&lt;p&gt;{{&lt;br/&gt;
diff --git a/core/src/main/java/org/apache/cxf/endpoint/ClientImpl.java b/core/src/main/java/org/apache/cxf/endpoint/ClientImpl.java&lt;br/&gt;
index 428f79454b..b15fb4dff2 100644&lt;br/&gt;
&amp;#8212; a/core/src/main/java/org/apache/cxf/endpoint/ClientImpl.java&lt;br/&gt;
+++ b/core/src/main/java/org/apache/cxf/endpoint/ClientImpl.java&lt;br/&gt;
@@ -29,7 +29,7 @@ import java.util.Collections;&lt;br/&gt;
 import java.util.HashMap;&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.Map;&lt;br/&gt;
-import java.util.WeakHashMap;&lt;br/&gt;
+import java.util.HashMap;&lt;br/&gt;
 import java.util.concurrent.ConcurrentHashMap;&lt;br/&gt;
 import java.util.concurrent.Executor;&lt;br/&gt;
 import java.util.logging.Level;&lt;br/&gt;
@@ -96,10 +96,10 @@ public class ClientImpl&lt;/p&gt;

&lt;p&gt;     protected Map&amp;lt;String, Object&amp;gt; currentRequestContext = new ConcurrentHashMap&amp;lt;String, Object&amp;gt;(8, 0.75f, 4);&lt;br/&gt;
     protected Map&amp;lt;Thread, EchoContext&amp;gt; requestContext &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;= Collections.synchronizedMap(new WeakHashMap&amp;lt;Thread, EchoContext&amp;gt;());&lt;br/&gt;
+        = Collections.synchronizedMap(new HashMap&amp;lt;Thread, EchoContext&amp;gt;());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     protected Map&amp;lt;Thread, Map&amp;lt;String, Object&amp;gt;&amp;gt; responseContext &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;= Collections.synchronizedMap(new WeakHashMap&amp;lt;Thread, Map&amp;lt;String, Object&amp;gt;&amp;gt;());&lt;br/&gt;
+        = Collections.synchronizedMap(new HashMap&amp;lt;Thread, Map&amp;lt;String, Object&amp;gt;&amp;gt;());&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     protected Executor executor;&lt;/p&gt;

&lt;p&gt;@@ -1052,5 +1052,8 @@ public class ClientImpl&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;-&lt;br/&gt;
+    public void releaseLocalThread() &lt;/p&gt;
{
+        requestContext.remove(Thread.currentThread());
+        responseContext.remove(Thread.currentThread());
+    }
&lt;p&gt; }&lt;br/&gt;
diff --git a/rt/frontend/jaxws/src/main/java/org/apache/cxf/jaxws/JaxWsClientProxy.java b/rt/frontend/jaxws/src/main/java/org/apache/cxf/jaxws/JaxWsClientProxy.java&lt;br/&gt;
index d963693afd..37b5e2ed02 100644&lt;br/&gt;
&amp;#8212; a/rt/frontend/jaxws/src/main/java/org/apache/cxf/jaxws/JaxWsClientProxy.java&lt;br/&gt;
+++ b/rt/frontend/jaxws/src/main/java/org/apache/cxf/jaxws/JaxWsClientProxy.java&lt;br/&gt;
@@ -131,6 +131,7 @@ public class JaxWsClientProxy extends org.apache.cxf.frontend.ClientProxy implem&lt;br/&gt;
         client.getRequestContext().put(Method.class.getName(), method);&lt;br/&gt;
         boolean isAsync = isAsync(method);&lt;/p&gt;

&lt;p&gt;+       try {&lt;br/&gt;
             Object result = null;&lt;br/&gt;
             try {&lt;br/&gt;
                 if (isAsync) &lt;/p&gt;
{
@@ -184,6 +185,9 @@ public class JaxWsClientProxy extends org.apache.cxf.frontend.ClientProxy implem
                 }
&lt;p&gt;             }&lt;br/&gt;
             return adjustObject(result);&lt;br/&gt;
+        } finally &lt;/p&gt;
{
+            if(client instanceof org.apache.cxf.endpoint.ClientImpl) ((org.apache.cxf.endpoint.ClientImpl)client).releaseLocalThread();
+        }
&lt;p&gt;     }&lt;br/&gt;
     boolean isAsync(Method m) {&lt;br/&gt;
         return m.getName().endsWith(&quot;Async&quot;)&lt;/p&gt;

&lt;p&gt;}}&lt;/p&gt;

&lt;p&gt;Luca&lt;/p&gt;</description>
                <environment>&lt;p&gt;wildfly-10.1.0&lt;/p&gt;</environment>
        <key id="13125184">CXF-7591</key>
            <summary>memory leak in ClientImpl</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="lbonco_74">Luca Boncompagni</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Dec 2017 11:21:07 +0000</created>
                <updated>Mon, 25 Mar 2019 12:28:52 +0000</updated>
                            <resolved>Wed, 25 Apr 2018 10:27:44 +0000</resolved>
                                    <version>3.1.6</version>
                                    <fixVersion>3.2.2</fixVersion>
                    <fixVersion>3.1.15</fixVersion>
                                    <component>Core</component>
                    <component>JAX-WS Runtime</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16292787" author="dkulp" created="Fri, 15 Dec 2017 16:46:12 +0000"  >&lt;p&gt;Could you try your use case with the attached patch?    &lt;/p&gt;

&lt;p&gt;Basically, this isn&apos;t really a &quot;memory leak&quot; as it&apos;s working as designed.   However, making it easier to clear out the contexts is probably a good thing to do.   What the patch does is override the &quot;clear()&quot; method on the maps used for the context to attempt to clear out and remove the maps from the various locations.   Thus, you should just be able to call clear on the contexts when you are done with them.&lt;/p&gt;</comment>
                            <comment id="16293011" author="lbonco_74" created="Fri, 15 Dec 2017 18:43:02 +0000"  >&lt;p&gt;How can I test your patch? Invoking &quot;clear()&quot; in JaxWsClientProxy or in our code?&lt;/p&gt;

&lt;p&gt;If I understand your design, WeakReference delegates the GC to clear the map. I think that using it should cause some problem during high memory pressure, if someone is allocating big objects, before throwing OOM, JVM will empty your map and this should corrupt the stack.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Luca&lt;/p&gt;</comment>
                            <comment id="16452023" author="deki" created="Wed, 25 Apr 2018 10:27:44 +0000"  >&lt;p&gt;I&apos;m resolving this as Daniel&apos;s patch went into the latest releases. Please retest and reopen this issue if the problem still exists.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13152866">CXF-7710</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12902403" name="CXF_7591-patch.txt" size="3299" author="dkulp" created="Fri, 15 Dec 2017 16:43:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 30 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ny07:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>