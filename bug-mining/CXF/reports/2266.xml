<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:10:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-5763] ClassCast Exception in AsyncHTTPConduit$AsyncWrappedOutputStream.close() method when using async and HttpAsyncClient </title>
                <link>https://issues.apache.org/jira/browse/CXF-5763</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Sometimes there is an error on connection close when using async client &lt;/p&gt;

&lt;p&gt;javax.ws.rs.ProcessingException: java.lang.ClassCastException: org.apache.cxf.transport.http.asyncclient.AsyncHTTPConduit$AsyncWrappedOutputStream$1 cannot be cast to org.apache.cxf.io.CachedOutputStream&lt;br/&gt;
	at org.apache.cxf.jaxrs.client.WebClient.handleAsyncResponse(WebClient.java:1010) &lt;span class=&quot;error&quot;&gt;&amp;#91;cxf-rt-rs-client-3.0.0.jar:3.0.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cxf.jaxrs.client.WebClient.access$100(WebClient.java:81) &lt;span class=&quot;error&quot;&gt;&amp;#91;cxf-rt-rs-client-3.0.0.jar:3.0.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cxf.jaxrs.client.WebClient$ClientAsyncResponseInterceptor.handleMessage(WebClient.java:1298) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cxf-rt-rs-client-3.0.0.jar:3.0.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:307) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cxf-core-3.0.0.jar:3.0.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cxf.jaxrs.client.ClientMessageObserver.onMessage(ClientMessageObserver.java:56) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cxf-rt-rs-client-3.0.0.jar:3.0.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream$1.run(HTTPConduit.java:1154) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cxf-rt-transports-http-3.0.0.jar:3.0.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cxf.workqueue.AutomaticWorkQueueImpl$3.run(AutomaticWorkQueueImpl.java:428) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cxf-core-3.0.0.jar:3.0.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.7.0_25&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.7.0_25&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cxf.workqueue.AutomaticWorkQueueImpl$AWQThreadFactory$1.run(AutomaticWorkQueueImpl.java:353) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cxf-core-3.0.0.jar:3.0.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:724) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.7.0_25&amp;#93;&lt;/span&gt;&lt;br/&gt;
Caused by: java.lang.ClassCastException: org.apache.cxf.transport.http.asyncclient.AsyncHTTPConduit$AsyncWrappedOutputStream$1 cannot be cast to org.apache.cxf.io.CachedOutputStream&lt;br/&gt;
	at org.apache.cxf.transport.http.asyncclient.AsyncHTTPConduit$AsyncWrappedOutputStream.close(AsyncHTTPConduit.java:397) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cxf-rt-transports-http-hc-3.0.0.jar:3.0.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cxf.transport.AbstractConduit.close(AbstractConduit.java:56) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cxf-core-3.0.0.jar:3.0.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cxf.transport.http.HTTPConduit.close(HTTPConduit.java:638) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cxf-rt-transports-http-3.0.0.jar:3.0.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cxf.endpoint.AbstractConduitSelector.complete(AbstractConduitSelector.java:209) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cxf-core-3.0.0.jar:3.0.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cxf.jaxrs.client.AbstractClient.preProcessResult(AbstractClient.java:534) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cxf-rt-rs-client-3.0.0.jar:3.0.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cxf.jaxrs.client.WebClient.handleAsyncResponse(WebClient.java:1005) &lt;span class=&quot;error&quot;&gt;&amp;#91;cxf-rt-rs-client-3.0.0.jar:3.0.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
	... 10 common frames omitted&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux&lt;br/&gt;
Java 7&lt;/p&gt;</environment>
        <key id="12716323">CXF-5763</key>
            <summary>ClassCast Exception in AsyncHTTPConduit$AsyncWrappedOutputStream.close() method when using async and HttpAsyncClient </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dkulp">Daniel Kulp</assignee>
                                    <reporter username="anthonyC">Anthony Communier</reporter>
                        <labels>
                    </labels>
                <created>Fri, 23 May 2014 12:38:31 +0000</created>
                <updated>Mon, 16 Feb 2015 16:09:20 +0000</updated>
                            <resolved>Mon, 16 Jun 2014 18:41:38 +0000</resolved>
                                    <version>3.0</version>
                                    <fixVersion>3.0.1</fixVersion>
                                    <component>Transports</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14007107" author="anthonyc" created="Fri, 23 May 2014 12:44:24 +0000"  >&lt;p&gt;You will find attached a log with debug &lt;/p&gt;</comment>
                            <comment id="14007151" author="anthonyc" created="Fri, 23 May 2014 13:20:52 +0000"  >&lt;p&gt;The allow chunk parameter of httpClientPolicy was set to false&lt;/p&gt;

&lt;p&gt;There are different kind of classes that are set into this.wrappedStream :&lt;br/&gt;
1/ CachedOutputStream (l 411)&lt;br/&gt;
2/ Annonymous  OutputStream (l 417)&lt;br/&gt;
3/ CacheAndWriteOutputStream (l432) (extending CachedOutputStream)&lt;/p&gt;

&lt;p&gt;In close method only CachedOutputStream is considered :&lt;br/&gt;
l 396:      if ((!this.chunking) &amp;amp;&amp;amp; (this.wrappedStream != null))&lt;br/&gt;
      {&lt;br/&gt;
        CachedOutputStream out = (CachedOutputStream)this.wrappedStream;&lt;/p&gt;

&lt;p&gt;It seems that the code is in the case 2/ =&amp;gt; Annonymous OutputStream&lt;/p&gt;

&lt;p&gt;There are not so much comments in code in order to understand what need to be done.&lt;br/&gt;
Waht could be done in order to fix the issue :&lt;br/&gt;
1/ Only test if it&apos;s this.wrappedStream is an instance of CachedOutputStream before doing job done in close method&lt;br/&gt;
2/ Be sure that  this.wrappedStream is always of type :CachedOutputStream &lt;/p&gt;

&lt;p&gt;Note that if close occurs during setupWrappedStream this.wrappedStream  could be of 2 types because there is no protection&lt;/p&gt;</comment>
                            <comment id="14020236" author="dkulp" created="Fri, 6 Jun 2014 19:01:38 +0000"  >&lt;p&gt;Is there any way to create a testcase for this?   I&apos;m most interested in the code around the WebClient calls and the size of the messages.&lt;/p&gt;

&lt;p&gt;I&apos;m not able to reproduce this at all.   The only ways I can see this exception occurring is if close() is called multiple times on the output stream.  That would keep the &quot;chunked&quot; set to false but replace the wrappedStream with the anonymous version.  &lt;/p&gt;

&lt;p&gt;However, that could potentially cause all kinds of other problems which is why I&apos;d really like a test case so I can breakpoint in the close to see where that is happening.&lt;/p&gt;</comment>
                            <comment id="14020791" author="anthonyc" created="Sat, 7 Jun 2014 12:19:52 +0000"  >&lt;p&gt;Since I have changed the UseAsyncPolicy to NEVER I do see this error anymore. It seems that it occurs only when Apache HttpAsyncClient.(4.0.1) is used.&lt;/p&gt;

&lt;p&gt;It occurs when response is sent back to the client.&lt;/p&gt;

&lt;p&gt;In the log, the request has the id 75 (pattern in log =&amp;gt; ID: 75)&lt;/p&gt;

&lt;p&gt;The request is sent at 14:03:40.928. The response is sent back at 14:03:40.934 :&lt;/p&gt;


&lt;p&gt;14:03:40.934 &lt;span class=&quot;error&quot;&gt;&amp;#91;default-workqueue-3&amp;#93;&lt;/span&gt; INFO  o.a.c.i.LoggingInInterceptor - Inbound Message&lt;br/&gt;
----------------------------&lt;br/&gt;
ID: 75&lt;br/&gt;
Address: &lt;a href=&quot;http://localhost:41446/amp-interface/unsubscribe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:41446/amp-interface/unsubscribe&lt;/a&gt;&lt;br/&gt;
Http-Method: POST&lt;br/&gt;
Content-Type: text/plain&lt;br/&gt;
Headers: &lt;/p&gt;
{Accept=[application/xml], Content-Type=[text/plain], Connection=[Keep-Alive]}
&lt;p&gt;--------------------------------------&lt;br/&gt;
14:03:40.934 &lt;span class=&quot;error&quot;&gt;&amp;#91;default-workqueue-3&amp;#93;&lt;/span&gt; DEBUG o.a.cxf.phase.PhaseInterceptorChain - Invoking handleMessage on interceptor org.apache.cxf.jaxrs.client.spec.ClientResponseFilterInterceptor@ef09ea4&lt;br/&gt;
14:03:40.934 &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; DEBUG o.a.h.i.n.c.ManagedNHttpClientConnectionImpl - http-outgoing-19 127.0.0.1:58580&amp;lt;-&amp;gt;127.0.0.1:41446&lt;span class=&quot;error&quot;&gt;&amp;#91;ACTIVE&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;rw:rw&amp;#93;&lt;/span&gt;: Shutdown&lt;br/&gt;
14:03:40.934 &lt;span class=&quot;error&quot;&gt;&amp;#91;default-workqueue-3&amp;#93;&lt;/span&gt; DEBUG o.a.cxf.phase.PhaseInterceptorChain - Invoking handleMessage on interceptor org.apache.cxf.jaxrs.client.WebClient$ClientAsyncResponseInterceptor@1fa68516&lt;br/&gt;
14:03:40.935 &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; DEBUG o.a.h.i.n.c.InternalHttpAsyncClient - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 53&amp;#93;&lt;/span&gt; connection aborted&lt;br/&gt;
14:03:40.935 &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; DEBUG o.a.h.i.n.c.PoolingNHttpClientConnectionManager - Releasing connection: &lt;span class=&quot;error&quot;&gt;&amp;#91;id: http-outgoing-19&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;route: {}-&amp;gt;http://localhost:41446&amp;#93;&lt;/span&gt;[total kept alive: 1; route allocated: 1 of 1000; total allocated: 2 of 5000]&lt;br/&gt;
14:03:40.935 &lt;span class=&quot;error&quot;&gt;&amp;#91;default-workqueue-3&amp;#93;&lt;/span&gt; INFO  c.c.c.techstats.TechStatRepository - Counter ready to be closed : AMP_UNSUBSCRIBE_REQUEST&lt;br/&gt;
14:03:40.935 &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; DEBUG o.a.h.i.n.c.PoolingNHttpClientConnectionManager - Connection released: &lt;span class=&quot;error&quot;&gt;&amp;#91;id: http-outgoing-19&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;route: {}-&amp;gt;http://localhost:41446&amp;#93;&lt;/span&gt;[total kept alive: 1; route allocated: 0 of 1000; total allocated: 1 of 5000]&lt;br/&gt;
14:03:40.935 &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; DEBUG o.a.h.n.p.HttpAsyncRequestExecutor - http-outgoing-19 &lt;span class=&quot;error&quot;&gt;&amp;#91;CLOSED&amp;#93;&lt;/span&gt;: Disconnected&lt;/p&gt;

&lt;p&gt;It seems that 2 threads are processing the request at the same time : &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; and &lt;span class=&quot;error&quot;&gt;&amp;#91;default-workqueue-3&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;On HttpAsync side the http flow is identified by pattern : exchange: 53&lt;/p&gt;

&lt;p&gt;1760: 14:03:40.928 &lt;span class=&quot;error&quot;&gt;&amp;#91;AMP-1&amp;#93;&lt;/span&gt; DEBUG o.a.h.impl.nio.client.MainClientExec - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 53&amp;#93;&lt;/span&gt; start execution&lt;br/&gt;
1763: 14:03:40.929 &lt;span class=&quot;error&quot;&gt;&amp;#91;AMP-1&amp;#93;&lt;/span&gt; DEBUG o.a.h.i.n.c.InternalHttpAsyncClient - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 53&amp;#93;&lt;/span&gt; Request connection for {}-&amp;gt;&lt;a href=&quot;http://localhost:41446&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:41446&lt;/a&gt;&lt;br/&gt;
1766: 14:03:40.929 &lt;span class=&quot;error&quot;&gt;&amp;#91;AMP-1&amp;#93;&lt;/span&gt; DEBUG o.a.h.i.n.c.InternalHttpAsyncClient - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 53&amp;#93;&lt;/span&gt; Connection allocated: http-outgoing-19 &lt;span class=&quot;error&quot;&gt;&amp;#91;ACTIVE&amp;#93;&lt;/span&gt;&lt;br/&gt;
1770: 14:03:40.931 &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; DEBUG o.a.h.impl.nio.client.MainClientExec - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 53&amp;#93;&lt;/span&gt; Attempt 1 to execute request&lt;br/&gt;
1783: 14:03:40.931 &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; DEBUG o.a.h.impl.nio.client.MainClientExec - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 53&amp;#93;&lt;/span&gt; produce content&lt;br/&gt;
1827: 14:03:40.935 &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; DEBUG o.a.h.i.n.c.InternalHttpAsyncClient - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 53&amp;#93;&lt;/span&gt; connection aborted&lt;/p&gt;

&lt;p&gt;There is another flow that worked :   pattern =&amp;gt; exchange: 52 and pattern ID: 74&lt;/p&gt;

&lt;p&gt;1597: 14:03:40.900 &lt;span class=&quot;error&quot;&gt;&amp;#91;AMP-1&amp;#93;&lt;/span&gt; DEBUG o.a.h.impl.nio.client.MainClientExec - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 52&amp;#93;&lt;/span&gt; start execution&lt;br/&gt;
1600: 14:03:40.900 &lt;span class=&quot;error&quot;&gt;&amp;#91;AMP-1&amp;#93;&lt;/span&gt; DEBUG o.a.h.i.n.c.InternalHttpAsyncClient - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 52&amp;#93;&lt;/span&gt; Request connection for {}-&amp;gt;&lt;a href=&quot;http://localhost:41446&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:41446&lt;/a&gt;&lt;br/&gt;
1603: 14:03:40.903 &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; DEBUG o.a.h.i.n.c.InternalHttpAsyncClient - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 52&amp;#93;&lt;/span&gt; Connection allocated: http-outgoing-19 &lt;span class=&quot;error&quot;&gt;&amp;#91;ACTIVE&amp;#93;&lt;/span&gt;&lt;br/&gt;
1611: 14:03:40.904 &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; DEBUG o.a.h.impl.nio.client.MainClientExec - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 52&amp;#93;&lt;/span&gt; Attempt 1 to execute request&lt;br/&gt;
1624: 14:03:40.905 &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; DEBUG o.a.h.impl.nio.client.MainClientExec - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 52&amp;#93;&lt;/span&gt; produce content&lt;br/&gt;
1625: 14:03:40.905 &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; DEBUG o.a.h.impl.nio.client.MainClientExec - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 52&amp;#93;&lt;/span&gt; Request completed&lt;br/&gt;
1657: 14:03:40.912 &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; DEBUG o.a.h.impl.nio.client.MainClientExec - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 52&amp;#93;&lt;/span&gt; Response received HTTP/1.1 200 OK&lt;br/&gt;
1659: 14:03:40.912 &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; DEBUG o.a.h.impl.nio.client.MainClientExec - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 52&amp;#93;&lt;/span&gt; Consume content&lt;br/&gt;
1660: 14:03:40.913 &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; DEBUG o.a.h.impl.nio.client.MainClientExec - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 52&amp;#93;&lt;/span&gt; Connection can be kept alive indefinitely&lt;br/&gt;
1662: 14:03:40.913 &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; DEBUG o.a.h.impl.nio.client.MainClientExec - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 52&amp;#93;&lt;/span&gt; Response processed&lt;br/&gt;
1663: 14:03:40.913 &lt;span class=&quot;error&quot;&gt;&amp;#91;I/O dispatcher 2&amp;#93;&lt;/span&gt; DEBUG o.a.h.i.n.c.InternalHttpAsyncClient - &lt;span class=&quot;error&quot;&gt;&amp;#91;exchange: 52&amp;#93;&lt;/span&gt; releasing connection&lt;/p&gt;

&lt;p&gt;The difference is that the the connection was aborted.&lt;/p&gt;

</comment>
                            <comment id="14020792" author="anthonyc" created="Sat, 7 Jun 2014 12:21:27 +0000"  >&lt;p&gt;This log is produced when HttpAsyncClient is not used&lt;/p&gt;</comment>
                            <comment id="14020793" author="anthonyc" created="Sat, 7 Jun 2014 12:34:37 +0000"  >&lt;p&gt;The request has the same id in the 2 files (ID: 75)&lt;/p&gt;

&lt;p&gt;The test start with the line : c.c.o.m.p.c.t.b.a.s.TestUnsubscribeSM - Test unsubscribeAMP_ErreurNonDefinitive_TechnicalError&lt;/p&gt;

&lt;p&gt;In the first log file (policy : ASYNC_ONLY) it starts on line 1708&lt;br/&gt;
In the second log (policy : NEVER) it starts on line 1578&lt;/p&gt;

&lt;p&gt;The length of the content is 286 (it&apos;s in the second log at 1646)&lt;/p&gt;

</comment>
                            <comment id="14020795" author="anthonyc" created="Sat, 7 Jun 2014 12:52:53 +0000"  >&lt;p&gt;We do not use AsyncHttpClient any more because we observe that connection sometimes  has failure that are not excepted. Tests are runned with maven and soapui plugin (with contains jetty 6)&lt;/p&gt;

&lt;p&gt;The connection abort is not seen in first log is not excepted&lt;/p&gt;


&lt;p&gt;The code used to send the request :&lt;/p&gt;

&lt;p&gt;WebClient wc = (WebClient) asyncService.getWebClient();    wc.path(&quot;unsubscribe&quot;).accept(MediaType.APPLICATION_XML_TYPE).type(MediaType.APPLICATION_FORM_URLENCODED);&lt;/p&gt;

&lt;p&gt;        List&amp;lt;NameValuePair&amp;gt; qparams = new ArrayList&amp;lt;NameValuePair&amp;gt;();&lt;br/&gt;
        qparams.add(new BasicNameValuePair(NOM_PARAM_ptfID, ptfID));&lt;br/&gt;
        qparams.add(new BasicNameValuePair(NOM_PARAM_GID, gid));&lt;br/&gt;
        qparams.add(new BasicNameValuePair(NOM_PARAM_REQUESTID, requestId));&lt;/p&gt;

&lt;p&gt;        asyncService.executePost(Entity.text(URLEncodedUtils.format(qparams, Charset.defaultCharset())), callback);&lt;/p&gt;


&lt;p&gt;When the callback reach the end of the processing : The method reset() is called on the AbstractClient (WebClient).&lt;br/&gt;
This method can be track with log : DEBUG c.c.c.w.c.s.WSClientAsyncSubsystem - return service :&lt;br/&gt;
It&apos;s done just after this log.&lt;/p&gt;

&lt;p&gt;But in case of ClassCastException the reset method is called after (line 1833 for the class cast and line 1856 for the reset).&lt;/p&gt;

&lt;p&gt;The reset method is called because WebClient are put in a pool.&lt;/p&gt;

&lt;p&gt;The issue could be more linked to fact that the connection is aborted. I don&apos;t know why the connection is aborted because it&apos;s never occurs when the AsyncPolicy is set to NEVER.&lt;/p&gt;</comment>
                            <comment id="14032755" author="dkulp" created="Mon, 16 Jun 2014 18:41:38 +0000"  >
&lt;p&gt;Possibly fixed.  I couldn&apos;t reproduce based on the information here (a test case is really needed), but I did add a check to make sure the stream is only closed once which should prevent this.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12646506" name="TestUnsubscribeSM-output.txt" size="288732" author="anthonyC" created="Fri, 23 May 2014 12:44:24 +0000"/>
                            <attachment id="12648809" name="com.capgemini.opentv.mediation.provisioning.customer.test.batchs.actions.statemachines.TestUnsubscribeSM-output.txt" size="249921" author="anthonyC" created="Sat, 7 Jun 2014 12:21:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>394531</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 23 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1vxhr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>394672</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>