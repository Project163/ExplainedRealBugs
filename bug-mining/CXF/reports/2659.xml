<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:17:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-6579] Inflated tokens can be corrupted if compression ratio is greater than 2:1</title>
                <link>https://issues.apache.org/jira/browse/CXF-6579</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;DeflateEncoderDecoder/CompressionUtils inflate method assumes that the compression ratio will be 2:1.  That assumption is not true for SAML tokens with many similar attribute statements.  The inflated token will be corrupted with a portion of the token replaced with null characters.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cxf/blob/cxf-2.7.17/rt/rs/security/xml/src/main/java/org/apache/cxf/rs/security/saml/DeflateEncoderDecoder.java#L34&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/blob/cxf-2.7.17/rt/rs/security/xml/src/main/java/org/apache/cxf/rs/security/saml/DeflateEncoderDecoder.java#L34&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cxf/blob/cxf-3.0.6/core/src/main/java/org/apache/cxf/common/util/CompressionUtils.java#L41&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/blob/cxf-3.0.6/core/src/main/java/org/apache/cxf/common/util/CompressionUtils.java#L41&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cxf/blob/cxf-3.1.2/core/src/main/java/org/apache/cxf/common/util/CompressionUtils.java#L41&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/blob/cxf-3.1.2/core/src/main/java/org/apache/cxf/common/util/CompressionUtils.java#L41&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testInflateDeflateWithTokenDuplication() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; token = &lt;span class=&quot;code-quote&quot;&gt;&quot;valid_grant valid_grant valid_grant valid_grant valid_grant valid_grant&quot;&lt;/span&gt;;

        DeflateEncoderDecoder deflateEncoderDecoder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DeflateEncoderDecoder();
        &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] deflatedToken = deflateEncoderDecoder.deflateToken(token.getBytes());

        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; cxfInflatedToken = IOUtils
                .toString(deflateEncoderDecoder.inflateToken(deflatedToken));

        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; streamInflatedToken = IOUtils.toString(
                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InflaterInputStream(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayInputStream(deflatedToken),
                        &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Inflater(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)));

        assertThat(streamInflatedToken, is(token));
        assertThat(cxfInflatedToken, is(token));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The stream inflated token is correct but the CXF inflated token is invalid.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.AssertionError: 
Expected: is &lt;span class=&quot;code-quote&quot;&gt;&quot;valid_grant valid_grant valid_grant valid_grant valid_grant valid_grant&quot;&lt;/span&gt;
     got: &lt;span class=&quot;code-quote&quot;&gt;&quot;t valid_grant valid_grant valid_grant&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12861939">CXF-6579</key>
            <summary>Inflated tokens can be corrupted if compression ratio is greater than 2:1</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sergey_beryozkin">Sergey Beryozkin</assignee>
                                    <reporter username="pklinef">Phillip Klinefelter</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Sep 2015 20:16:02 +0000</created>
                <updated>Fri, 14 Oct 2016 14:12:06 +0000</updated>
                            <resolved>Wed, 9 Sep 2015 13:38:26 +0000</resolved>
                                    <version>3.0.6</version>
                    <version>2.7.17</version>
                    <version>3.1.2</version>
                                    <fixVersion>3.1.3</fixVersion>
                    <fixVersion>2.7.18</fixVersion>
                    <fixVersion>3.0.7</fixVersion>
                                    <component>Core</component>
                    <component>JAX-RS Security</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14732491" author="sergey_beryozkin" created="Sun, 6 Sep 2015 18:21:57 +0000"  >&lt;p&gt;Thanks for the test, I&apos;ve introduced a &apos;deflate.level&apos; contextual property. At the moment the default is the Deflater.DEFLATE which can be set to 0, etc, if needed.&lt;/p&gt;

&lt;p&gt;Should a level be set to 0 by default if no contextual property is available. I guess it might be sensitive if somehow we have a client or server having different deflate level expectations, so it is better be configurable, just not sure how sensitive it can be if we set it to 0 by default after the code used a different level...Probably should keep it as is but in in this case setting a &apos;deflate.level&apos; to something else would fix it, Phillip, does it work for you ?&lt;/p&gt;</comment>
                            <comment id="14733450" author="sergey_beryozkin" created="Mon, 7 Sep 2015 09:21:27 +0000"  >&lt;p&gt;FYI, you&apos;d set this property in jaxrs:server/jaxrs:properties. Or in an early CXF in interceptor if there can be a situation where different clients use different ratio levels.&lt;/p&gt;

&lt;p&gt;At this stage I think we should get this issue resolved given that it is known that a token is deflated with the default deflate level in a number of practical and interop cases (the latter verified by Colm against many IDPs).&lt;/p&gt;

&lt;p&gt;Defaulting to &apos;0&apos; without users bothering with setting a property can definitely be done too once we have a bit more assurance it won&apos;t affect the existing clients targeting CXF SAML SP code.    &lt;/p&gt;</comment>
                            <comment id="14734802" author="stustison" created="Tue, 8 Sep 2015 13:40:39 +0000"  >&lt;p&gt;It seems to me that this is still an issue if a token comes from another client with a better than 2:1 compression ratio. The deflating of the token isn&apos;t the problem here. A better fix would be replacing all of this code: &lt;a href=&quot;https://github.com/apache/cxf/blob/cxf-3.1.2/core/src/main/java/org/apache/cxf/common/util/CompressionUtils.java#L41-L67&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/blob/cxf-3.1.2/core/src/main/java/org/apache/cxf/common/util/CompressionUtils.java#L41-L67&lt;/a&gt; with: return new InflaterInputStream(new ByteArrayInputStream(deflatedToken), new Inflater(true)); Then there is no need to set the compression level for deflate.&lt;/p&gt;</comment>
                            <comment id="14735047" author="sergey_beryozkin" created="Tue, 8 Sep 2015 16:01:37 +0000"  >&lt;p&gt;If I replace the code as suggested I have these two DeflateEncoderDecoderTest tests failing:&lt;/p&gt;

&lt;p&gt;testInvalidContent&lt;br/&gt;
testInvalidContentAfterBase64&lt;/p&gt;

&lt;p&gt;Note I added those tests in response to:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-5390&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CXF-5390&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This all revolves around the existing code that gets the token inflated and therefore one option is just to drop these 2 tests if we replace the code as you suggested.&lt;/p&gt;

&lt;p&gt;However, clearly &quot;invalid_grant&quot;.getBytes() is not a valid deflated sequence and as such why exactly the code you suggested does not throw DataFormatException ? &lt;/p&gt;

&lt;p&gt;If the existing inflation code does not work for higher compression rates then why can&apos;t we fix it as opposed to completely remove it.&lt;/p&gt;

&lt;p&gt;I&apos;m sure that directly working with Inflater is also viable in a sense that it should support various compression rates, therefore IMHO we need to tune the existing code to ensure we have all the rates supported but also have an early failure in case of invalid sequences.&lt;/p&gt;

&lt;p&gt;Can you please review the existing code and see how it can be fixed ? &lt;/p&gt;
</comment>
                            <comment id="14736716" author="sergey_beryozkin" created="Wed, 9 Sep 2015 11:54:30 +0000"  >&lt;p&gt;The fix only works if the client is able to control the deflection level which is probably not easy to do in some cases. CXF Inflater code appears to be a bit broken in that it does not support multiple &apos;fill&apos; situations which would be the case when the ratio is higher than 2:1&lt;/p&gt;</comment>
                            <comment id="14737523" author="pklinef" created="Wed, 9 Sep 2015 20:25:20 +0000"  >&lt;p&gt;The following inflateToken using a ByteArrayOutputStream passes testInvalidContent and testInvalidContentAfterBase64 as written.  It also supports any compression ratio that a client might send.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; InputStream inflateToken(&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] deflatedToken)
            &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; DataFormatException {
        Inflater inflater = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Inflater(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        inflater.setInput(deflatedToken);

        &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] buffer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[deflatedToken.length];
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; inflateLen;
        ByteArrayOutputStream inflatedToken = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayOutputStream();
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!inflater.finished()) {
            inflateLen = inflater.inflate(buffer, 0, deflatedToken.length);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inflateLen == 0 &amp;amp;&amp;amp; !inflater.finished()) {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inflater.needsInput()) {
                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DataFormatException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Inflater can not inflate all the token bytes&quot;&lt;/span&gt;);
                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                    &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
                }
            }

            inflatedToken.write(buffer, 0, inflateLen);
        }

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayInputStream(inflatedToken.toByteArray());
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The stream approach will also throw an exception but only when reading from the stream.  testInvalidContent and testInvalidContentAfterBase64 currently assume an exception will be thrown before reading the stream.  The stream version will not go into an infinite loop as described in &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-5390&quot; title=&quot;AbstractSamlBase64InHandler goes into infinite loop when processing bad header value.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-5390&quot;&gt;&lt;del&gt;CXF-5390&lt;/del&gt;&lt;/a&gt; but instead throw an exception when trying to read the inflated token.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; InputStream inflateToken(&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] deflatedToken)
        &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; DataFormatException {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InflaterInputStream(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayInputStream(deflatedToken),
            &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Inflater(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;));
    }

    @Test(expected = ZipException.class) &lt;span class=&quot;code-comment&quot;&gt;// Caused by: java.util.zip.ZipException: invalid stored block lengths
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testInvalidContent() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        DeflateEncoderDecoder inflater = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DeflateEncoderDecoder();
        IOUtils.toString(inflater.inflateToken(&lt;span class=&quot;code-quote&quot;&gt;&quot;invalid_grant&quot;&lt;/span&gt;.getBytes()));
    }

    @Test(expected = EOFException.class) &lt;span class=&quot;code-comment&quot;&gt;// Caused by: java.io.EOFException: Unexpected end of ZLIB input stream
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testInvalidContentAfterBase64() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        DeflateEncoderDecoder inflater = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DeflateEncoderDecoder();
        &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] base64decoded = Base64Utility.decode(&lt;span class=&quot;code-quote&quot;&gt;&quot;invalid_grant&quot;&lt;/span&gt;);
        IOUtils.toString(inflater.inflateToken(base64decoded));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14738507" author="sergey_beryozkin" created="Thu, 10 Sep 2015 09:45:16 +0000"  >&lt;p&gt;I did it fix it yesterday by tweaking the existing code, but your version of the code is more compact and cleaner - hence I&apos;ve finalized it with applying your proposed code, many thanks &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 10 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jt47:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>