<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:20:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-6930] Race-Condition with JMS-transport, LoggingInInterceptor spoils the payload while logging it</title>
                <link>https://issues.apache.org/jira/browse/CXF-6930</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Hi,&lt;br/&gt;
I think we stumbled over a problem with cxf and the JMS-transport, &lt;br/&gt;
if the &lt;tt&gt;LoggingFeature&lt;/tt&gt; is used to log incoming response messages.&lt;/p&gt;

&lt;p&gt;The problem is that sometimes, &lt;tt&gt;ClientProxyImpl.invoke(...)&lt;/tt&gt; returns &lt;tt&gt;null&lt;/tt&gt;, &lt;br/&gt;
but from the logged message payload, it&apos;s clear that there is a not-null response payload coming from the sever.&lt;/p&gt;

&lt;p&gt;I believe, I just figured out that it is in fact the logging of that very payload which causes &lt;tt&gt;ClientProxyImpl.invoke(...)&lt;/tt&gt; to return &lt;tt&gt;null&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;How?&lt;br/&gt;
There is a race between the actual &quot;client thread&quot; which waited for the server&apos;s response &lt;br/&gt;
(i.e. &lt;tt&gt;exchange.wait()&lt;/tt&gt; in &lt;tt&gt;JMSConduit.sendAndReceiveMessage(...)&lt;/tt&gt; ) &lt;br/&gt;
until notified by the ActiveMQ Session Task thread &lt;br/&gt;
(i.e. &lt;tt&gt;exchange.notifyAll()&lt;/tt&gt; in &lt;tt&gt;JMSConduit.processReplyMessage(...)&lt;/tt&gt; )&lt;br/&gt;
one one side and the ActiveMQ Session Task thread itself on the other side.&lt;/p&gt;

&lt;p&gt;Once the client thread is notified, it goes on with &lt;tt&gt;preProcessResult(...)&lt;/tt&gt; and &lt;tt&gt;handleResponse(...)&lt;/tt&gt; and somewhere in there the message&apos;s &lt;tt&gt;ByteArrayStream&lt;/tt&gt; is read and the return object is created.&lt;/p&gt;

&lt;p&gt;However, at the same time, back in the ActiveMQ thread, the interceptor chain is run. &lt;/p&gt;

&lt;p&gt;In my case it contains the &lt;tt&gt;LoggingInInterceptor&lt;/tt&gt; which accesses the message&apos;s &lt;b&gt;same&lt;/b&gt; &lt;tt&gt;ByteArrayInputStream&lt;/tt&gt;, in the method &lt;tt&gt;LoggingInInterceptor.logInputStream(...)&lt;/tt&gt; ).&lt;/p&gt;

&lt;p&gt;Now, in &lt;tt&gt;logInputStream(...)&lt;/tt&gt;, we have&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;IOUtils.copyAtLeast(bis, bos, limit == -1 ? &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE : limit);
bos.flush();
bis = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SequenceInputStream(bos.getInputStream(), bis);

&lt;span class=&quot;code-comment&quot;&gt;// restore the delegating input stream or the input stream
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (is &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; DelegatingInputStream) {
    ((DelegatingInputStream)is).setInputStream(bis);
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
    message.setContent(InputStream.class, bis);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;My problem happens if the client thread tries to read the message while &quot;&lt;tt&gt;bis&lt;/tt&gt;&quot; was read, but not yet restored. During that time, &quot;&lt;tt&gt;bis&lt;/tt&gt;&quot; is closed for the in the client thread and it will skip over it (or throw an Exception, based on its config).&lt;/p&gt;

&lt;p&gt;My current best and maybe naive guess on how to solve this is to change the method &lt;tt&gt;JMSConduit.processReplyMessage(...)&lt;/tt&gt; &lt;br/&gt;
and execute the if-block around &lt;tt&gt;exchange.notifyAll();&lt;/tt&gt; only after the if-block around &lt;tt&gt;incomingObserver.onMessage(exchange.getInMessage());&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;WDYT?&lt;/p&gt;

&lt;p&gt;Best reagards&lt;br/&gt;
Tobias&lt;/p&gt;</description>
                <environment></environment>
        <key id="12975278">CXF-6930</key>
            <summary>Race-Condition with JMS-transport, LoggingInInterceptor spoils the payload while logging it</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dkulp">Daniel Kulp</assignee>
                                    <reporter username="t.schoeneberg">Tobias Sch&#246;neberg</reporter>
                        <labels>
                    </labels>
                <created>Thu, 2 Jun 2016 19:52:07 +0000</created>
                <updated>Wed, 22 Mar 2017 17:25:03 +0000</updated>
                            <resolved>Fri, 25 Nov 2016 14:16:46 +0000</resolved>
                                    <version>3.1.6</version>
                                    <fixVersion>3.1.8</fixVersion>
                                    <component>JMS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15384027" author="t.schoeneberg" created="Tue, 19 Jul 2016 12:09:37 +0000"  >&lt;p&gt;today i banged my head again, because i had negelected to switch off inbound data logging...&lt;br/&gt;
any news on this issue?&lt;/p&gt;</comment>
                            <comment id="15695960" author="sergey_beryozkin" created="Fri, 25 Nov 2016 14:16:05 +0000"  >&lt;p&gt;I believe Dan had fixed it, can you try 3.1.8 please ?&lt;/p&gt;</comment>
                            <comment id="15702774" author="t.schoeneberg" created="Mon, 28 Nov 2016 18:49:39 +0000"  >&lt;p&gt;Thx for the info, I&apos;m going to try it out this week and report&lt;/p&gt;</comment>
                            <comment id="15731211" author="t.schoeneberg" created="Thu, 8 Dec 2016 05:53:12 +0000"  >&lt;p&gt;sorry, didn&apos;t get to it yet. it&apos;s high in my backlog&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 49 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ywr3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>