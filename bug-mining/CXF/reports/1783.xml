<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:00:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-4992] proxy sub-resources creating wrong request URIs with non-HTTP transports</title>
                <link>https://issues.apache.org/jira/browse/CXF-4992</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;I was experimenting with direct dispatch local transport and ran into an issue with proxy-based clients.&lt;/p&gt;

&lt;p&gt;Here&apos;s my working WebClient-based client code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;WebClient client = WebClient.create(&lt;span class=&quot;code-quote&quot;&gt;&quot;local:&lt;span class=&quot;code-comment&quot;&gt;//api&quot;&lt;/span&gt;);
&lt;/span&gt;WebClient.getConfig(client).getRequestContext().put(LocalConduit.DIRECT_DISPATCH, &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.TRUE);
client.path(&lt;span class=&quot;code-quote&quot;&gt;&quot;v1/clusters/not-a-valid-cluster&quot;&lt;/span&gt;);
client.get();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here&apos;s my broken proxy-based client code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;JAXRSClientFactoryBean bean = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JAXRSClientFactoryBean();
bean.setAddress(&lt;span class=&quot;code-quote&quot;&gt;&quot;local:&lt;span class=&quot;code-comment&quot;&gt;//api&quot;&lt;/span&gt;);
&lt;/span&gt;bean.setResourceClass(ApiRootResourceImpl.class);
ApiRootResource root = bean.create(ApiRootResourceImpl.class);
ClientConfiguration config = WebClient.getConfig(root);
config.getRequestContext().put(LocalConduit.DIRECT_DISPATCH, &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.TRUE);
config.getConduit();
root.getRootV1().getClustersResource().readCluster(&lt;span class=&quot;code-quote&quot;&gt;&quot;not-a-valid-cluster&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What breaks? I get an IllegalStateException with the message &quot;Local destination does not have a MessageObserver on address /clusters&quot;. Note that the proxy-based client code works correctly when the address is &quot;http://localhost:&amp;lt;port&amp;gt;/api&quot;, so I don&apos;t suspect anything broken in either the code or in my resource layout.&lt;/p&gt;

&lt;p&gt;I&apos;ve spent a fair amount of time debugging this and I think I&apos;ve figured out what&apos;s going on. Every method call into the proxy (getRootV1(), getClustersResource(), and readCluster()) creates a new proxy for the corresponding subresource. That involves creating a new LocalClientState (see ClientProxyImpl.invoke() for details). Here is its constructor:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; LocalClientState(URI baseURI) {
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.baseURI = baseURI;
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; scheme = baseURI.getScheme();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!StringUtils.isEmpty(scheme) &amp;amp;&amp;amp; scheme.startsWith(HTTP_SCHEME)) {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.currentBuilder = UriBuilder.fromUri(baseURI);
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.currentBuilder = UriBuilder.fromUri(&lt;span class=&quot;code-quote&quot;&gt;&quot;/&quot;&lt;/span&gt;);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Because the baseURI in question begins with &quot;local://&quot;, we end up in the &apos;else&apos; statement, which resets our URI&apos;s path to &apos;/&apos;. In my case, the URIs for each subcall end up looking like &quot;/&quot;, &quot;/v1&quot;, and &quot;/clusters&quot; instead of &quot;local://api&quot;, &quot;local://api/v1&quot;, and &quot;local://api/v1/clusters&quot;.&lt;/p&gt;

&lt;p&gt;Later, during conduit selector preparation (called from inside ClientProxyImpl.doChainedInvocation, via createMessage()), we try to find a &quot;compatible&quot; conduit. We only have one conduit: a LocalConduit constructed during the call to config.getConduit() in the client code. The conduit is &quot;compatible&quot; if its endpoint&apos;s address matches the address in the message. And the address in the message is based on those partial URIs I described earlier. So what happens? The LocalConduit&apos;s endpoint&apos;s address is &quot;local://api&quot;, but the address in the message is &quot;/clusters&quot;. They don&apos;t match, and findCompatibleConduit() fails. We then construct a new LocalConduit on-the-fly (see AbstractConduitSelector.getSelectedConduit()), but the LocalDestination that&apos;s created for it (by LocalTransportFactory) never gets an observer installed in it. The original LocalConduit (the one that didn&apos;t match) has a destination with an observer; it was set up in ServerImpl.start().&lt;/p&gt;

&lt;p&gt;Now, I was able to make forward progress by, using my debugger, modifying LocalClientState.currentBuilder in every proxy call to be an absolute path like &quot;local://api/...&quot;. At that point, the exception went away and the message was routed to the server. But then JAXRSInInterceptor.processMessage() failed to find the method to dispatch, so I suspect I broke something in the process.&lt;/p&gt;

&lt;p&gt;I asked about this on the cxf-users mailing list (&lt;a href=&quot;http://cxf.547215.n5.nabble.com/JAX-RS-recursive-dispatch-td5726752.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cxf.547215.n5.nabble.com/JAX-RS-recursive-dispatch-td5726752.html&lt;/a&gt;). The consensus was that this is a real bug, and likely affects other non-HTTP transports like JMS.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12645281">CXF-4992</key>
            <summary>proxy sub-resources creating wrong request URIs with non-HTTP transports</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sergey_beryozkin">Sergey Beryozkin</assignee>
                                    <reporter username="adar">Adar Dembo</reporter>
                        <labels>
                    </labels>
                <created>Mon, 29 Apr 2013 18:59:28 +0000</created>
                <updated>Wed, 14 Aug 2013 15:50:08 +0000</updated>
                            <resolved>Tue, 30 Apr 2013 12:19:55 +0000</resolved>
                                    <version>2.7.4</version>
                                    <fixVersion>2.6.8</fixVersion>
                    <fixVersion>2.7.5</fixVersion>
                    <fixVersion>2.5.11</fixVersion>
                    <fixVersion>3.0.0-milestone1</fixVersion>
                                    <component>JAX-RS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                        <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>325643</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 30 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1k6iv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>325988</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>