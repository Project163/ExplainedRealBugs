<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:40:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-9115] Race Condition in HttpClientHttpConduit Causes Writing Thread to Hang Forever</title>
                <link>https://issues.apache.org/jira/browse/CXF-9115</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;It is possible for &lt;tt&gt;HttpClientHTTPConduit.HttpClientBodyPublisher#subscribe&lt;/tt&gt; to be called &lt;em&gt;after&lt;/em&gt; the underlying subscription has already been cancelled, for example, if a connect timeout happens &lt;em&gt;before&lt;/em&gt; &lt;tt&gt;HttpClientHTTPConduit.HttpClientBodyPublisher#subscribe&lt;/tt&gt; is called.&lt;br/&gt;
In this case, the writing thread will be stuck in &lt;tt&gt;HttpClientHTTPConduit.HttpClientPipedOutputStream#write&lt;/tt&gt;, waiting forever for space in the write buffer.&lt;/p&gt;

&lt;p&gt;This happens every once in a while in our production system, causing it to hang. The threads are stuck here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;demo.hw.client.ComplexClient.main()@4789&quot;&lt;/span&gt; tid=0x3e nid=NA waiting
  java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING
	  at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait0(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:-1)
	  at java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.java:366)
	  at java.io.PipedInputStream.awaitSpace(PipedInputStream.java:279)
	  at java.io.PipedInputStream.receive(PipedInputStream.java:237)
	  at java.io.PipedOutputStream.write(PipedOutputStream.java:154)
	  at org.apache.cxf.transport.http.HttpClientHTTPConduit$HttpClientPipedOutputStream.write(HttpClientHTTPConduit.java:554)
	  at org.apache.cxf.io.AbstractWrappedOutputStream.write(AbstractWrappedOutputStream.java:51)
	  at org.apache.cxf.io.AbstractThresholdOutputStream.write(AbstractThresholdOutputStream.java:69)
	  at com.ctc.wstx.io.UTF8Writer.flush(UTF8Writer.java:100)
	  at com.ctc.wstx.sw.BufferingXmlWriter.flush(BufferingXmlWriter.java:242)
	  at com.ctc.wstx.sw.BaseStreamWriter.flush(BaseStreamWriter.java:260)
	  at org.apache.cxf.interceptor.AbstractOutDatabindingInterceptor.writeParts(AbstractOutDatabindingInterceptor.java:107)
	  at org.apache.cxf.wsdl.interceptors.BareOutInterceptor.handleMessage(BareOutInterceptor.java:68)
	  at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:307)
	  - locked &amp;lt;0x2369&amp;gt; (a org.apache.cxf.phase.PhaseInterceptorChain)
	  at org.apache.cxf.endpoint.ClientImpl.doInvoke(ClientImpl.java:530)
	  at org.apache.cxf.endpoint.ClientImpl.invoke(ClientImpl.java:441)
	  at org.apache.cxf.endpoint.ClientImpl.invoke(ClientImpl.java:356)
	  at org.apache.cxf.endpoint.ClientImpl.invoke(ClientImpl.java:314)
	  at org.apache.cxf.endpoint.ClientImpl.invoke(ClientImpl.java:334)
	  at demo.hw.client.ComplexClient.main(ComplexClient.java:106)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The &lt;tt&gt;PipedInputStream&lt;/tt&gt; looks like this (so it is connected, but doesn&apos;t yet have a thread registered as the &lt;tt&gt;readSide&lt;/tt&gt;, and never will have one. It therefore doesn&apos;t consider the read end to be gone/dead and keeps looping forever in &lt;tt&gt;awaitSpace()&lt;/tt&gt;):&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13075251/13075251_screenshot-1.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;I can reproduce this issue every time by&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Placing a breakpoint in this line: &lt;a href=&quot;https://github.com/apache/cxf/blob/7fb95ad266e4a5ced561a0dc56c038db43967ca4/rt/transports/http/src/main/java/org/apache/cxf/transport/http/HttpClientHTTPConduit.java#L637&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/blob/7fb95ad266e4a5ced561a0dc56c038db43967ca4/rt/transports/http/src/main/java/org/apache/cxf/transport/http/HttpClientHTTPConduit.java#L637&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;sending a request with a body that is larger than the chunking threshold (4096 bytes by default), and larger than the chunk length,&lt;/li&gt;
	&lt;li&gt;waiting for the breakpoint to be hit,&lt;/li&gt;
	&lt;li&gt;then waiting for the connect timeout to be exceeded (30s by default),&lt;/li&gt;
	&lt;li&gt;then resuming the program.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I recommend running with &lt;tt&gt;-Djdk.httpclient.HttpClient.log=errors,requests,headers,frames:control:data:window,ssl,trace,channel&lt;/tt&gt;. That way we can see debug logs printed by the &lt;tt&gt;HttpClient&lt;/tt&gt; that tell us when timeouts happen and subscriptions are being cancelled.&lt;/p&gt;

&lt;p&gt;As a reproducer project, you can use the &lt;a href=&quot;https://github.com/apache/cxf/tree/cxf-4.1.0/distribution/src/main/release/samples/wsdl_first_dynamic_client&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;wsdl_first_dynamic_client sample&lt;/a&gt;, with the following modification in the client to trigger chunking, and to have the timeouts happen a little sooner:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Index: distribution/src/main/release/samples/wsdl_first_dynamic_client/src/main/java/demo/hw/client/ComplexClient.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&amp;lt;+&amp;gt;UTF-8
===================================================================
diff --git a/distribution/src/main/release/samples/wsdl_first_dynamic_client/src/main/java/demo/hw/client/ComplexClient.java b/distribution/src/main/release/samples/wsdl_first_dynamic_client/src/main/java/demo/hw/client/ComplexClient.java
--- a/distribution/src/main/release/samples/wsdl_first_dynamic_client/src/main/java/demo/hw/client/ComplexClient.java	(revision 7fb95ad266e4a5ced561a0dc56c038db43967ca4)
+++ b/distribution/src/main/release/samples/wsdl_first_dynamic_client/src/main/java/demo/hw/client/ComplexClient.java	(date 1741191623466)
@@ -35,6 +35,7 @@
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cxf.service.model.BindingOperationInfo;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cxf.service.model.MessagePartInfo;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cxf.service.model.ServiceInfo;
+&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cxf.transport.http.HTTPConduit;
 
 /**
  *
@@ -70,6 +71,12 @@
         JaxWsDynamicClientFactory factory = JaxWsDynamicClientFactory.newInstance();
         Client client = factory.createClient(wsdlURL.toExternalForm(), SERVICE_NAME);
         ClientImpl clientImpl = (ClientImpl) client;
+        ((HTTPConduit) clientImpl.getConduit()).getClient().setChunkingThreshold(8);
+        ((HTTPConduit) clientImpl.getConduit()).getClient().setChunkLength(8);
+        ((HTTPConduit) clientImpl.getConduit()).getClient().setConnectionTimeout(5000);
+        ((HTTPConduit) clientImpl.getConduit()).getClient().setReceiveTimeout(5000);
+
+
         Endpoint endpoint = clientImpl.getEndpoint();
         ServiceInfo serviceInfo = endpoint.getService().getServiceInfos().get(0);
         QName bindingName = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; QName(&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//Company.com/Application&quot;&lt;/span&gt;,&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Start the server with &lt;tt&gt;mvn -Pserver&lt;/tt&gt;, set the breakpoint as described above and start &lt;tt&gt;mvn -Pclient&lt;/tt&gt; in the debugger. Once the breakpoint is hit, wait ~5 seconds and resume. The process will now hang forever.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13610760">CXF-9115</key>
            <summary>Race Condition in HttpClientHttpConduit Causes Writing Thread to Hang Forever</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="reta">Andriy Redko</assignee>
                                    <reporter username="kzander">Kai Zander</reporter>
                        <labels>
                    </labels>
                <created>Wed, 5 Mar 2025 16:26:51 +0000</created>
                <updated>Sun, 30 Mar 2025 14:57:10 +0000</updated>
                            <resolved>Sun, 30 Mar 2025 14:57:10 +0000</resolved>
                                    <version>4.1.0</version>
                    <version>4.0.6</version>
                    <version>3.6.6</version>
                                    <fixVersion>4.1.2</fixVersion>
                    <fixVersion>4.0.8</fixVersion>
                    <fixVersion>3.6.7</fixVersion>
                                    <component>Transports</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                        <attachments>
                            <attachment id="13075251" name="screenshot-1.png" size="41981" author="kzander" created="Wed, 5 Mar 2025 16:28:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            35 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ulbc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>