<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:15:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-6373] CompletionCallback can not get the Throwable if error occurs in other interceptor (no serviceinvokerInterceptor)</title>
                <link>https://issues.apache.org/jira/browse/CXF-6373</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;//Resource class&lt;br/&gt;
@Path(&quot;resource&quot;)&lt;br/&gt;
public class Resource {&lt;/p&gt;

&lt;p&gt;   private static final AsyncResponseBlockingQueue[] step = &lt;/p&gt;
{
           new AsyncResponseBlockingQueue(1),
           new AsyncResponseBlockingQueue(1),
           new AsyncResponseBlockingQueue(1)}
&lt;p&gt;;&lt;/p&gt;

&lt;p&gt;   @GET&lt;br/&gt;
   @Path(&quot;suspend&quot;)&lt;br/&gt;
   public void suspend(@Suspended AsyncResponse asyncResponse) &lt;/p&gt;
{
      step[0].add(asyncResponse);
	  }

&lt;p&gt;   @GET&lt;br/&gt;
   @Path(&quot;register&quot;)&lt;br/&gt;
   public String registerObject(@QueryParam(&quot;step&quot;) String step) &lt;/p&gt;
{
      AsyncResponse async = takeAsyncResponse(step);
      boolean b = async.register(new MyCompletionCallback()).isEmpty();
      addResponse(async, step);
      return b ? TRUE : FALSE;
   }

&lt;p&gt;   @GET&lt;br/&gt;
   @Path(&quot;exception&quot;)&lt;br/&gt;
   public String throwExceptionOnAsyncResponse(&lt;br/&gt;
           @QueryParam(&quot;step&quot;) String step) &lt;/p&gt;
{
      System.out.println(&quot;********throwExceptionOnAsyncResponse&quot;);
      AsyncResponse async = takeAsyncResponse(step);
      System.out.println(&quot;*****async is not null: &quot; + async);
      boolean b = async.resume(new ExceptionThrowingStringBean(
              &quot;throw exception&quot;));
      System.out.println(&quot;execuet finished for resume!!!&quot;);
      addResponse(async, step);
      return b ? TRUE : FALSE;
   }
&lt;p&gt;   }&lt;/p&gt;

&lt;p&gt;///////  StringBean&lt;br/&gt;
   public class StringBean {&lt;br/&gt;
   private String header;&lt;/p&gt;

&lt;p&gt;   public String get() &lt;/p&gt;
{
      return header;
   }

&lt;p&gt;   public void set(String header) &lt;/p&gt;
{
      this.header = header;
   }

&lt;p&gt;   @Override&lt;br/&gt;
   public String toString() &lt;/p&gt;
{
      return &quot;StringBean. To get a value, use rather #get() method.&quot;;
   }

&lt;p&gt;   public StringBean(String header) &lt;/p&gt;
{
      super();
      this.header = header;
   }
&lt;p&gt;}&lt;br/&gt;
/////// Throw Exception here&lt;br/&gt;
 public class ExceptionThrowingStringBean extends StringBean {&lt;br/&gt;
   public ExceptionThrowingStringBean(String header) &lt;/p&gt;
{
      super(header);
   }

&lt;p&gt;   @Override&lt;br/&gt;
   public String get() &lt;/p&gt;
{
      throw new RuntimeException(new IOException(super.get()));
   }

&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;////// Register a provider to deal with StringBean, &lt;br/&gt;
// This cause we have an exception thrown in JaxrsOutInterceptor&lt;/p&gt;

&lt;p&gt;@Provider&lt;br/&gt;
public class StringBeanEntityProvider implements MessageBodyReader&amp;lt;StringBean&amp;gt;,&lt;br/&gt;
        MessageBodyWriter&amp;lt;StringBean&amp;gt; {&lt;/p&gt;

&lt;p&gt;   @Override&lt;br/&gt;
   public boolean isWriteable(Class&amp;lt;?&amp;gt; type, Type genericType,&lt;br/&gt;
                              Annotation[] annotations, MediaType mediaType) &lt;/p&gt;
{
      return StringBean.class.isAssignableFrom(type);
   }

&lt;p&gt;   @Override&lt;br/&gt;
   public long getSize(StringBean t, Class&amp;lt;?&amp;gt; type, Type genericType,&lt;br/&gt;
                       Annotation[] annotations, MediaType mediaType) &lt;/p&gt;
{
      return t.get().length();
   }

&lt;p&gt;   @Override&lt;br/&gt;
   public void writeTo(StringBean t, Class&amp;lt;?&amp;gt; type, Type genericType,&lt;br/&gt;
                       Annotation[] annotations, MediaType mediaType,&lt;br/&gt;
                       MultivaluedMap&amp;lt;String, Object&amp;gt; httpHeaders,&lt;br/&gt;
                       OutputStream entityStream) throws IOException,&lt;br/&gt;
           WebApplicationException &lt;/p&gt;
{
      entityStream.write(t.get().getBytes());
   }

&lt;p&gt;   @Override&lt;br/&gt;
   public boolean isReadable(Class&amp;lt;?&amp;gt; type, Type genericType,&lt;br/&gt;
                             Annotation[] annotations, MediaType mediaType) &lt;/p&gt;
{
      return isWriteable(type, genericType, annotations, mediaType);
   }

&lt;p&gt;   @Override&lt;br/&gt;
   public StringBean readFrom(Class&amp;lt;StringBean&amp;gt; type, Type genericType,&lt;br/&gt;
                              Annotation[] annotations, MediaType mediaType,&lt;br/&gt;
                              MultivaluedMap&amp;lt;String, String&amp;gt; httpHeaders, InputStream entityStream)&lt;br/&gt;
           throws IOException, WebApplicationException &lt;/p&gt;
{
      String stream = JaxrsUtil.readFromStream(entityStream);
      StringBean bean = new StringBean(stream);
      return bean;
   }

&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;//////  Need to get the exception throwed from ExceptionThrowingStringBean.get() method in this callback&lt;/p&gt;


&lt;p&gt;public class MyCompletionCallback implements CompletionCallback {&lt;/p&gt;

&lt;p&gt;   private static String throwableName;&lt;br/&gt;
   public static final String NULL = &quot;NULL&quot;;&lt;br/&gt;
   public static final String NONAME = &quot;No name has been set yet&quot;;&lt;/p&gt;

&lt;p&gt;   @Override&lt;br/&gt;
   public void onComplete(Throwable throwable) &lt;/p&gt;
{
	   
      throwableName = throwable == null ? NULL : throwable.getClass()
              .getName();
   }

&lt;p&gt;   public static final String getLastThrowableName() &lt;/p&gt;
{
      return throwableName;
   }

&lt;p&gt;   public static final void resetLastThrowableName() &lt;/p&gt;
{
      throwableName = NONAME;
   }

&lt;p&gt;}&lt;/p&gt;</description>
                <environment></environment>
        <key id="12824048">CXF-6373</key>
            <summary>CompletionCallback can not get the Throwable if error occurs in other interceptor (no serviceinvokerInterceptor)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sergey_beryozkin">Sergey Beryozkin</assignee>
                                    <reporter username="irisding">Iris Ding</reporter>
                        <labels>
                    </labels>
                <created>Sun, 26 Apr 2015 02:10:03 +0000</created>
                <updated>Fri, 14 Oct 2016 14:24:04 +0000</updated>
                            <resolved>Mon, 27 Apr 2015 09:35:37 +0000</resolved>
                                    <version>3.0.3</version>
                    <version>3.0.4</version>
                    <version>2.7.15</version>
                                    <fixVersion>3.1</fixVersion>
                    <fixVersion>3.0.5</fixVersion>
                                    <component>JAX-RS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14512834" author="irisding" created="Sun, 26 Apr 2015 02:26:52 +0000"  >&lt;p&gt;The client: &lt;br/&gt;
             //step 1&lt;br/&gt;
             Response response1 = client.target(&quot;http://localhost:9080/cdi11_rs20/rest/resource/clear&quot;).request().get();&lt;br/&gt;
	      response1.close();&lt;br/&gt;
	      //step 2&lt;br/&gt;
	      Response response = client.target(&quot;http://localhost:9080/cdi11_rs20/rest/resource/reset&quot;).request().get();&lt;br/&gt;
	      response.close();&lt;br/&gt;
             //step 3&lt;br/&gt;
             Future&amp;lt;Response&amp;gt; suspend = client.target(&quot;http://localhost:9080/cdi11_rs20/rest/resource/suspend&quot;).request().async().get();&lt;br/&gt;
             //step 4&lt;br/&gt;
	      Future&amp;lt;Response&amp;gt; register = client.target(&quot;http://localhost:9080/cdi11_rs20/rest/resource/register?stage=0&quot;).request().async().get();&lt;br/&gt;
              // step 5&lt;br/&gt;
	      Future&amp;lt;Response&amp;gt; exception = client.target(&quot;http://localhost:9080/cdi11_rs20/rest/resource/exception?stage=1&quot;).request().async().get();&lt;br/&gt;
	      Response response2 = exception.get();&lt;/p&gt;

&lt;p&gt;	      Response suspendResponse = suspend.get();&lt;br/&gt;
	      suspendResponse.close();&lt;br/&gt;
              //step 6&lt;br/&gt;
	      Future&amp;lt;Response&amp;gt; error = client.target(&quot;http://localhost:9080/cdi11_rs20/rest/resource/error&quot;).request().async().get();&lt;br/&gt;
	      System.out.println(&quot;eeee&quot; + error.get().readEntity(String.class));  // need to get RunTimeException&lt;/p&gt;



&lt;p&gt;Two missied method in Resouce:&lt;/p&gt;

&lt;p&gt; @GET&lt;br/&gt;
   @Path(&quot;error&quot;)&lt;br/&gt;
   public String getErrorValue() &lt;/p&gt;
{
      String name = MyCompletionCallback.getLastThrowableName();
      return name;
   }


&lt;p&gt;@GET&lt;br/&gt;
   @Path(&quot;clear&quot;)&lt;br/&gt;
   public void clear() &lt;/p&gt;
{
      for (int i = 0; i != stage.length; i++)
         stage[i].clear();
   }

&lt;p&gt; @GET&lt;br/&gt;
   @Path(&quot;reset&quot;)&lt;br/&gt;
   public void resetErrorValue() &lt;/p&gt;
{
      MyCompletionCallback.resetLastThrowableName();
   }

&lt;p&gt;protected static AsyncResponse takeAsyncResponse(int stageId) {&lt;br/&gt;
      final ResponseBuilder error = createErrorResponseBuilder();&lt;br/&gt;
      AsyncResponse asyncResponse = null;&lt;br/&gt;
      try &lt;/p&gt;
{
         asyncResponse = stage[stageId].take();
      }
&lt;p&gt; catch (InterruptedException e) &lt;/p&gt;
{
         throw new WebApplicationException(error.entity(
                 &quot;ArrayBlockingQueue#take&quot;).build());
      }
&lt;p&gt;      return asyncResponse;&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;   protected static final void addResponse(AsyncResponse response, String stageId) &lt;/p&gt;
{
      int id = Integer.parseInt(stageId) + 1;
      if (id != stage.length)
         stage[id].add(response);
   }</comment>
                            <comment id="14512837" author="irisding" created="Sun, 26 Apr 2015 02:34:58 +0000"  >&lt;p&gt;The test Failed.&lt;/p&gt;

&lt;p&gt;After analysis, I found out we only call asyncResponseImpl.setUnmappedThrowable if &lt;br/&gt;
the exception is thrown from ServiceInvokerInterceptor and no mapper found for this exception: &lt;/p&gt;

&lt;p&gt;ServiceInvokerInterceptor.handleMessage() -&amp;gt; JAXRSInvoker.invoke -&amp;gt; JAXRSInvoker.handleAsyncResponse -&amp;gt; JAXRSInvoker.handleAsyncFault&lt;/p&gt;

&lt;p&gt;However in above case, the exception is thrown after ServiceInvokerInterceptor but in JAXRSOutInterceptor.serializeMessage().  Then the completioncallback can not get the correct &apos;Throwable&quot;&lt;/p&gt;


&lt;p&gt;The proposed fix is:&lt;br/&gt;
in JAXRSDefaultFaultOutInterceptor.handleMessage() method add below lines:&lt;/p&gt;

&lt;p&gt; final Fault f = (Fault) message.getContent(Exception.class);&lt;/p&gt;

&lt;p&gt;        Response r = JAXRSUtils.convertFaultToResponse(f.getCause(), message);&lt;br/&gt;
       // proposed change end&lt;br/&gt;
        if (r == null) //which means it is an unmapped exception&lt;br/&gt;
        {&lt;br/&gt;
            try {&lt;br/&gt;
                AsyncResponseImpl asyncResponse = (AsyncResponseImpl) message.getExchange().getInMessage().get(AsyncResponse.class);&lt;br/&gt;
                if (asyncResponse != null)&lt;/p&gt;
                {
                    asyncResponse.setUnmappedThrowable(f.getCause());
                }
&lt;p&gt;            } catch (Exception e)&lt;/p&gt;
            {//donothing

            }
&lt;p&gt;        }&lt;br/&gt;
       //proposed change end&lt;br/&gt;
        if (r != null) {...........}}&lt;/p&gt;


&lt;p&gt;After this, the test passed!!&lt;/p&gt;
</comment>
                            <comment id="14513801" author="sergey_beryozkin" created="Mon, 27 Apr 2015 09:35:37 +0000"  >&lt;p&gt;I&apos;ve done the fix at the HTTP transport level, thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 30 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2drmv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>