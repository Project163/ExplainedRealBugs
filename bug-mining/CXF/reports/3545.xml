<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:36:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-8356] JAXRS Multipart-Handling broken for InputStream/Datasource parameters</title>
                <link>https://issues.apache.org/jira/browse/CXF-8356</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Multipart attachements mapped to InputStream/Datasource parameters are currently broken, due to their respective DelegatingInputStream being closed too early.&lt;br/&gt;
As of cxf-3.3.4 this was still working.&lt;/p&gt;


&lt;p&gt;As far as I can see, the early closing happens here:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Daemon &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; [&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-workqueue-1] (Suspended (breakpoint at line 46 in DelegatingInputStream))	
	owns: PhaseInterceptorChain  (id=49)	
	DelegatingInputStream.close() line: 46	
	JAXRSUtils.copyAndGetEntityStream(Message) line: 1897	
	JAXRSUtils.processRequestBodyParameter(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;?&amp;gt;, Type, Annotation[], Message, OperationResourceInfo) line: 884	
	JAXRSUtils.processParameters(OperationResourceInfo, MultivaluedMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;, Message) line: 832	
	JAXRSInInterceptor.processRequest(Message, Exchange) line: 214	
	JAXRSInInterceptor.handleMessage(Message) line: 78	
	PhaseInterceptorChain.doIntercept(Message) line: 308	
	ChainInitiationObserver.onMessage(Message) line: 121	
	LocalConduit$LocalConduitOutputStream$1.run() line: 88	
	AutomaticWorkQueueImpl$3.run() line: 412	
	AutomaticWorkQueueImpl$1(ThreadPoolExecutor).runWorker(ThreadPoolExecutor$Worker) line: 1128	
	ThreadPoolExecutor$Worker.run() line: 628	
	AutomaticWorkQueueImpl$AWQThreadFactory$1.run() line: 345	
	&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run() line: 834	

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I believe this change (&lt;a href=&quot;https://github.com/apache/cxf/commit/dc71ce1635330136e472e0b6fb5ce4a71ae0d474&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/commit/dc71ce1635330136e472e0b6fb5ce4a71ae0d474&lt;/a&gt;) led to this issue, due to `contentType` and `mt` (Mediatype) variable disagreeing, leading to unwanted? copy and closing of the stream.&lt;br/&gt;
A few lines below the `contentType` is used again to derive the MediaType, which leads me to believe the first`mt` variable is incorrect.&lt;/p&gt;

&lt;p&gt;A local patch for this line made it working again for me, although I am uncertain this is the correct fix:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
MediaType mt = toMediaType(contentType);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For reference, one of the annotated methods producing this issue for us:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @POST
    @Path(&lt;span class=&quot;code-quote&quot;&gt;&quot;/pdf&quot;&lt;/span&gt;)
    @Consumes(MediaType.MULTIPART_FORM_DATA)
    @Operation(summary = &lt;span class=&quot;code-quote&quot;&gt;&quot;Rendert das &#252;bergebene TemplateModel mit Hilfe des &#252;bergebenen Templates&quot;&lt;/span&gt;)
    Response getPDF(
            @Parameter(
                    description = &lt;span class=&quot;code-quote&quot;&gt;&quot;Das Template, das zum Rendern der Daten benutzt wird&quot;&lt;/span&gt;,
                    content = @Content(schema = @Schema(implementation = TemplatePart.class))) @Multipart(
                            value = &lt;span class=&quot;code-quote&quot;&gt;&quot;template&quot;&lt;/span&gt;, type = &lt;span class=&quot;code-quote&quot;&gt;&quot;application/octet-stream&quot;&lt;/span&gt;) InputStream template,
            @Parameter(description = &lt;span class=&quot;code-quote&quot;&gt;&quot;Charset des Templates&quot;&lt;/span&gt;) @QueryParam(&lt;span class=&quot;code-quote&quot;&gt;&quot;charset&quot;&lt;/span&gt;) &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; charset,
            @RequestBody(
                    description = &lt;span class=&quot;code-quote&quot;&gt;&quot;Die Daten, die mit Hilfe des &#252;bergebenen Templates gerendert werden&quot;&lt;/span&gt;) @Multipart(
                            value = &lt;span class=&quot;code-quote&quot;&gt;&quot;data&quot;&lt;/span&gt;, type = &lt;span class=&quot;code-quote&quot;&gt;&quot;application/json&quot;&lt;/span&gt;) TemplateModel data);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this case this issue led to `template` being a `DelegatingInputStream` wrapping another (closed) `DelegatingInputStream` on the server side.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13335354">CXF-8356</key>
            <summary>JAXRS Multipart-Handling broken for InputStream/Datasource parameters</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="reta">Andriy Redko</assignee>
                                    <reporter username="lkoe">Lars K&#246;dderitzsch</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Oct 2020 06:48:47 +0000</created>
                <updated>Mon, 4 Jan 2021 09:46:15 +0000</updated>
                            <resolved>Wed, 4 Nov 2020 15:00:41 +0000</resolved>
                                    <version>3.3.7</version>
                    <version>3.4.0</version>
                                    <fixVersion>3.4.2</fixVersion>
                    <fixVersion>3.3.9</fixVersion>
                                    <component>JAX-RS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17213713" author="coheigea" created="Wed, 14 Oct 2020 07:57:46 +0000"  >&lt;p&gt;FYI &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amccright&quot; class=&quot;user-hover&quot; rel=&quot;amccright&quot;&gt;amccright&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17214361" author="reta" created="Thu, 15 Oct 2020 01:45:23 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lkoe&quot; class=&quot;user-hover&quot; rel=&quot;lkoe&quot;&gt;lkoe&lt;/a&gt; , may I ask you please why the `Content-Type` header is not passed in your case, it could help to workaround the issue till it is addressed, thank you.&lt;/p&gt;</comment>
                            <comment id="17214512" author="lkoe" created="Thu, 15 Oct 2020 08:31:55 +0000"  >&lt;p&gt;The client is a JAXRS-Proxy based on the annotated service interface, so I am not doing anything special there with regards to HTTP Headers.&lt;/p&gt;

&lt;p&gt;I investigated a bit more and it seems the problem - Content-Type header missing - only presents itself when using LocalTransport (for testing). &lt;br/&gt;
 In this case only the `Content-Type` message property (&quot;(String)message.get(Message.CONTENT_TYPE);&quot;) seems to be present.&lt;/p&gt;

&lt;p&gt;When testing a real deployment over HTTP the header is set and the service works just fine.&lt;/p&gt;

&lt;p&gt;So effectively it appears that (&lt;a href=&quot;https://github.com/apache/cxf/blob/dc71ce1635330136e472e0b6fb5ce4a71ae0d474/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java#L873):&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/blob/dc71ce1635330136e472e0b6fb5ce4a71ae0d474/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java#L873):&lt;/a&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if using LocalTransport `mc.getHttpHeaders().getMediaType()` returns null, but `message.get(Message.CONTENT_TYPE)` still yields the proper content type (`multipart/form-data; boundary=&quot;uuid:faf5b92a-65ae-4783-a1e7-a2575060c8ae&quot;`)&lt;/li&gt;
	&lt;li&gt;mt being null leads to the stream being copied and closed, resulting in a closed stream in the actual service&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17214621" author="reta" created="Thu, 15 Oct 2020 11:16:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lkoe&quot; class=&quot;user-hover&quot; rel=&quot;lkoe&quot;&gt;lkoe&lt;/a&gt; thanks for exhaustive investigation, really helpful.&lt;/p&gt;</comment>
                            <comment id="17215081" author="reta" created="Thu, 15 Oct 2020 23:46:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lkoe&quot; class=&quot;user-hover&quot; rel=&quot;lkoe&quot;&gt;lkoe&lt;/a&gt; I have difficulties preparing the test case to reproduce this issue, may I ask you a favor to attach one (or sample project) to this ticket? Thank you.&lt;/p&gt;</comment>
                            <comment id="17219626" author="lkoe" created="Fri, 23 Oct 2020 10:30:36 +0000"  >&lt;p&gt;Sorry for taking my sweet time, but I think I came up with a comprehensive test &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13014038/13014038_CXF-8356.zip&quot; title=&quot;CXF-8356.zip attached to CXF-8356&quot;&gt;CXF-8356.zip&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;The problem only seems to manifest when using more than one multipart.&lt;br/&gt;
 Also the issue plays out differently, depending on the size of the first multipart &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;if the first part is small, the stream passed into the server side service impl is empty&lt;/li&gt;
	&lt;li&gt;if the first part is a larger dataset, then accessing the stream results in the &quot;stream closed&quot; exception&lt;/li&gt;
	&lt;li&gt;the second multipart seems to be actually ok, in both cases&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17219630" author="lkoe" created="Fri, 23 Oct 2020 10:43:28 +0000"  >&lt;p&gt;Changing &lt;a href=&quot;https://github.com/apache/cxf/blob/a421613ce5b5bb21bfa22c94a3b3fd42b77c9079/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java#L880)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/blob/a421613ce5b5bb21bfa22c94a3b3fd42b77c9079/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java#L880&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;to `MediaType mt = toMediaType(contentType);` fixes those failing test cases for me. Of course I don&apos;t know about all the other tests &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;If the fix is correct however, you might want to to also have a look here for a potential similar problem (which I didn&apos;t hit): &lt;a href=&quot;https://github.com/apache/cxf/blob/a421613ce5b5bb21bfa22c94a3b3fd42b77c9079/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java#L1021&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/blob/a421613ce5b5bb21bfa22c94a3b3fd42b77c9079/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/utils/JAXRSUtils.java#L1021&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17220216" author="reta" created="Sun, 25 Oct 2020 00:36:19 +0000"  >&lt;p&gt;Thanks a lot for the test cases, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lkoe&quot; class=&quot;user-hover&quot; rel=&quot;lkoe&quot;&gt;lkoe&lt;/a&gt; , I can see the problem now.&lt;/p&gt;</comment>
                            <comment id="17220666" author="kjq" created="Mon, 26 Oct 2020 13:01:03 +0000"  >&lt;p&gt;Hey Andy.&lt;/p&gt;

&lt;p&gt;Thanks for taking care of that!&#160; I will get a chance to test it, hopefully before the next release, but I have no doubts about your fix.&#160; Apologies for taking so long to look at it, the last few week have just slipped away.&lt;/p&gt;

&lt;p&gt;As always, thanks for your help!&lt;/p&gt;

&lt;p&gt;KJQ&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13014038" name="CXF-8356.zip" size="57404" author="lkoe" created="Fri, 23 Oct 2020 10:24:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 3 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0jos0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>