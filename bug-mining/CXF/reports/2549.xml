<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:15:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-6389] set initialSuspend=true incorrectly when resume the asyncresponse</title>
                <link>https://issues.apache.org/jira/browse/CXF-6389</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;My Resource class: &lt;br/&gt;
@Path(&quot;resource&quot;)&lt;br/&gt;
public class Resource&lt;br/&gt;
{&lt;/p&gt;

&lt;p&gt;   public static final String RESUMED = &quot;Response resumed&quot;;&lt;br/&gt;
   public static final String FALSE = &quot;A method returned false&quot;;&lt;br/&gt;
   public static final String TRUE = &quot;A method return true&quot;;&lt;/p&gt;

&lt;p&gt;   //&lt;br/&gt;
   private static final AsyncResponseBlockingQueue[] stage = &lt;/p&gt;
{
           new AsyncResponseBlockingQueue(1),
           new AsyncResponseBlockingQueue(1),
           new AsyncResponseBlockingQueue(1)}
&lt;p&gt;;&lt;/p&gt;

&lt;p&gt;   @GET&lt;br/&gt;
   @Path(&quot;suspend&quot;)&lt;br/&gt;
   public void suspend(@Suspended AsyncResponse asyncResponse)&lt;/p&gt;
   {
      stage[0].add(asyncResponse);
   }

&lt;p&gt;   @GET&lt;br/&gt;
   @Path(&quot;cancelvoid&quot;)&lt;br/&gt;
   public String cancel(@QueryParam(&quot;stage&quot;) String stage)&lt;/p&gt;
   {
      AsyncResponse response = takeAsyncResponse(stage);
      boolean ret = response.cancel();
      System.out.println(&quot;*** response.cancel() 1 &quot; + ret);
      ret &amp;amp;= response.cancel();
      System.out.println(&quot;*** response.cancel() 2 &quot; + ret);
      addResponse(response, stage);
      return ret ? TRUE : FALSE;
   }

&lt;p&gt;    @POST&lt;br/&gt;
   @Path(&quot;resume&quot;)&lt;br/&gt;
   public String resume(@QueryParam(&quot;stage&quot;) String stage, String response)&lt;/p&gt;
   {
      AsyncResponse async = takeAsyncResponse(stage);
      boolean b = resume(async, response);
      addResponse(async, stage);
      return b ? TRUE : FALSE;
   }

&lt;p&gt;     protected static AsyncResponse takeAsyncResponse(String stageId)&lt;/p&gt;
   {
      return takeAsyncResponse(Integer.parseInt(stageId));
   }

&lt;p&gt;   protected static AsyncResponse takeAsyncResponse(int stageId)&lt;br/&gt;
   {&lt;br/&gt;
      final ResponseBuilder error = createErrorResponseBuilder();&lt;br/&gt;
      AsyncResponse asyncResponse = null;&lt;br/&gt;
      try&lt;/p&gt;
      {
         asyncResponse = stage[stageId].take();
      }
&lt;p&gt;      catch (InterruptedException e)&lt;/p&gt;
      {
         throw new WebApplicationException(error.entity(
                 &quot;ArrayBlockingQueue#take&quot;).build());
      }
&lt;p&gt;      return asyncResponse;&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;   protected static final void addResponse(AsyncResponse response, String stageId)&lt;/p&gt;
   {
      int id = Integer.parseInt(stageId) + 1;
      if (id != stage.length)
         stage[id].add(response);
   }

&lt;p&gt;   protected static boolean resume(AsyncResponse takenResponse, Object response)&lt;/p&gt;
   {
      return takenResponse.resume(response);
   }

&lt;p&gt;   protected static ResponseBuilder createErrorResponseBuilder()&lt;/p&gt;
   {
      return Response.status(Status.EXPECTATION_FAILED);
   }
&lt;p&gt;   }&lt;/p&gt;</description>
                <environment></environment>
        <key id="12827154">CXF-6389</key>
            <summary>set initialSuspend=true incorrectly when resume the asyncresponse</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sergey_beryozkin">Sergey Beryozkin</assignee>
                                    <reporter username="irisding">Iris Ding</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 May 2015 06:15:45 +0000</created>
                <updated>Fri, 14 Oct 2016 14:25:16 +0000</updated>
                            <resolved>Thu, 7 May 2015 11:54:15 +0000</resolved>
                                    <version>3.0</version>
                    <version>3.0.3</version>
                    <version>2.7.15</version>
                                    <fixVersion>3.1.1</fixVersion>
                    <fixVersion>3.0.6</fixVersion>
                                    <component>JAX-RS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14528015" author="irisding" created="Tue, 5 May 2015 06:32:31 +0000"  >&lt;p&gt;My client:&lt;/p&gt;

&lt;p&gt; public void cancelVoidOnResumedTest()throws Exception &lt;/p&gt;
{
		      String expectedResponse = &quot;Expected response&quot;;
		      Future&amp;lt;Response&amp;gt; suspend = invokeRequest(&quot;suspend&quot;);
		      Future&amp;lt;Response&amp;gt; resume = invokeRequest(&quot;resume?stage=0&quot;,
		              expectedResponse);
		      assertString(resume, Resource.TRUE);
		      assertString(suspend, expectedResponse);
		      Future&amp;lt;Response&amp;gt; cancel = invokeRequest(&quot;cancelvoid?stage=1&quot;);
		      assertString(cancel, Resource.FALSE);
		   }

&lt;p&gt;       private static void assertString(Future&amp;lt;Response&amp;gt; future, String check)&lt;br/&gt;
		          throws Exception &lt;/p&gt;
{
		      Response response = getResponse(future);
		      assertStatus(response, Status.OK);
		      String content = response.readEntity(String.class);
		      assertEquals(check, content, &quot;Unexpected response content&quot;, content);
		      logMsg(&quot;Found expected string&quot;, check);
		   }

&lt;p&gt;	    private &amp;lt;T&amp;gt; Future&amp;lt;Response&amp;gt; invokeRequest(String resource, T entity) &lt;/p&gt;
{
		      AsyncInvoker async = createAsyncInvoker(resource);
		      Future&amp;lt;Response&amp;gt; future = async.post(Entity.entity(entity,
		              MediaType.TEXT_PLAIN_TYPE));
		      return future;
		   }

&lt;p&gt;	   private Future&amp;lt;Response&amp;gt; invokeRequest(String resource) &lt;/p&gt;
{
		      AsyncInvoker async = createAsyncInvoker(resource);
		      Future&amp;lt;Response&amp;gt; future = async.get();
		      return future;
		   }

&lt;p&gt;	   private AsyncInvoker createAsyncInvoker(String resource) &lt;/p&gt;
{
		      WebTarget target = createWebTarget(resource);
		      AsyncInvoker async = target.request().async();
		      return async;
		   }

&lt;p&gt;// The test is as below:&lt;/p&gt;

&lt;p&gt;//step1- call below resource method: &lt;br/&gt;
 @Path(&quot;suspend&quot;)&lt;br/&gt;
   public void suspend(@Suspended AsyncResponse asyncResponse)&lt;/p&gt;
   {
      stage[0].add(asyncResponse);
   }
&lt;p&gt;//step2: resume the asyncresponse:&lt;br/&gt;
@POST&lt;br/&gt;
   @Path(&quot;resume&quot;)&lt;br/&gt;
   public String resume(@QueryParam(&quot;stage&quot;) String stage, String response)&lt;/p&gt;
   {
      AsyncResponse async = takeAsyncResponse(stage);
      boolean b = resume(async, response);
      addResponse(async, stage);
      return b ? TRUE : FALSE;
   }
&lt;p&gt;//step3: cancel the asyncresponse, in this case, since the asyncresponse has already been resumed, the cancel should return &apos;false&quot;:&lt;/p&gt;

&lt;p&gt;@GET&lt;br/&gt;
   @Path(&quot;cancelvoid&quot;)&lt;br/&gt;
   public String cancel(@QueryParam(&quot;stage&quot;) String stage)&lt;/p&gt;
   {
      AsyncResponse response = takeAsyncResponse(stage);
      boolean ret = response.cancel();
      System.out.println(&quot;*** response.cancel() 1 &quot; + ret);
      ret &amp;amp;= response.cancel();
      System.out.println(&quot;*** response.cancel() 2 &quot; + ret);
      addResponse(response, stage);
      return ret ? TRUE : FALSE;
   }

&lt;p&gt;But currently, CXF returns true. The issue here is in :&lt;br/&gt;
org.apache.cxf.jaxrs.JAXRSInvoker.invoke(Exchange exchange, Object request) &lt;del&gt;&amp;gt; asyncImpl.prepareContinuation()&lt;/del&gt;&amp;gt;asyncImpl.initContinuation(). &lt;br/&gt;
in asyncImpl.initContinuation() it will set initialSuspend = true;&lt;/p&gt;

&lt;p&gt;The proposed change is modify org.apache.cxf.jaxrs.impl.AsyncResponseImpl.prepareContinuation(), just remove the &quot;initialSuspend = true&quot; in initContinuation().&lt;br/&gt;
 public void prepareContinuation() &lt;/p&gt;
{
       //  initContinuation();
      ContinuationProvider provider =
                        (ContinuationProvider) inMessage.get(ContinuationProvider.class.getName());
        cont = provider.getContinuation();
    }</comment>
                            <comment id="14530549" author="irisding" created="Wed, 6 May 2015 13:33:31 +0000"  >&lt;p&gt;I found there is a problem in original proposed change, we can use below one instead:&lt;/p&gt;

&lt;p&gt;@Override&lt;br/&gt;
    public synchronized boolean isSuspended() &lt;/p&gt;
{
        //proposed change start
    	if (cancelled||resumedByApplication)
    		return false;
       //proposed change end
        return initialSuspend || cont.isPending();
    }</comment>
                            <comment id="14530798" author="sergey_beryozkin" created="Wed, 6 May 2015 16:13:54 +0000"  >&lt;p&gt;Thanks for looking into this issue, will have a look asap&lt;/p&gt;</comment>
                            <comment id="14531413" author="sergey_beryozkin" created="Wed, 6 May 2015 21:06:47 +0000"  >&lt;p&gt;I&apos;m a bit confused about the source of the problem.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isSuspended() {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; initialSuspend || cont.isPending();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;after the test code resumes AsyncResponse isSuspended() should return &apos;false&apos;.&lt;br/&gt;
when cancel() is called, it returns false if isSuspended() returns false.&lt;/p&gt;

&lt;p&gt;So the question is why does isSuspended() return true after resume() was called. initialSuspend is false at that stage, so do you see cont.isPending() returning true ?&lt;/p&gt;

&lt;p&gt;Cheers, Sergey&lt;/p&gt;</comment>
                            <comment id="14531889" author="weiz" created="Thu, 7 May 2015 02:23:08 +0000"  >&lt;p&gt;Sergey,&lt;/p&gt;

&lt;p&gt;If resume() and isSuspened() are called in a single request, the code works well, since initialSuspend is false. But in this test code, resume() and isSuspened() are called in two requests. In the second request (isSuspended()), asyncImpl.prepareContinuation()&amp;gt;asyncImpl.initContinuation() was called, and initialSuspened is set to true again, so the isSuspened() method will return true regardless of the return value of cont.isPending().&lt;/p&gt;</comment>
                            <comment id="14532503" author="sergey_beryozkin" created="Thu, 7 May 2015 11:54:00 +0000"  >&lt;p&gt;Wei - thanks for this analysis, Iris - thanks for another patch&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 28 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ea93:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>