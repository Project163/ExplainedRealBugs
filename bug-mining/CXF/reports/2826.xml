<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:20:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-6943] Dead lock on Async Response when timeout is set</title>
                <link>https://issues.apache.org/jira/browse/CXF-6943</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;When using AsyncResponse with timeout and an external thread for the treatment, it seems that a dead lock appears between the main http thread and the treatment thread when the treatment thread finished before the main thread :&lt;/p&gt;

&lt;p&gt;Here is the code which reproduces this issue :&lt;/p&gt;

&lt;p&gt;    public Response asyncResponseTestKo(HttpServletRequest request, final AsyncResponse ar) {&lt;/p&gt;

&lt;p&gt;        Response r = null;&lt;br/&gt;
        LOGGER.info(&quot;Get request asyncResponseTestKo&quot;);&lt;br/&gt;
        ar.setTimeout(10, TimeUnit.SECONDS);&lt;br/&gt;
        poolExecutor.execute(new Runnable() {&lt;/p&gt;

&lt;p&gt;            @Override&lt;br/&gt;
            public void run() &lt;/p&gt;
{
                ar.resume(Response.ok().build());
            }
&lt;p&gt;        });&lt;br/&gt;
        try &lt;/p&gt;
{
            Thread.sleep(2000);
        }
&lt;p&gt; catch (InterruptedException e) &lt;/p&gt;
{
            // TODO Auto-generated catch block
            e.printStackTrace();
        }

&lt;p&gt;        return r;&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;The main thread error is :&lt;/p&gt;

&lt;p&gt;2016-06-15 14:47:44&lt;/p&gt;

&lt;p&gt;&quot;http-nio-9080-exec-1&quot; - Thread t@25&lt;br/&gt;
   java.lang.Thread.State: BLOCKED&lt;br/&gt;
	at org.apache.cxf.jaxrs.impl.AsyncResponseImpl.suspendContinuationIfNeeded(AsyncResponseImpl.java:263)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;792a9e17&amp;gt; (a org.apache.cxf.jaxrs.impl.AsyncResponseImpl) owned by &quot;pool-1-thread-1&quot; t@26&lt;br/&gt;
	at org.apache.cxf.jaxrs.JAXRSInvoker.invoke(JAXRSInvoker.java:191)&lt;br/&gt;
	at org.apache.cxf.jaxrs.JAXRSInvoker.invoke(JAXRSInvoker.java:99)&lt;br/&gt;
	at org.apache.cxf.interceptor.ServiceInvokerInterceptor$1.run(ServiceInvokerInterceptor.java:59)&lt;br/&gt;
	at org.apache.cxf.interceptor.ServiceInvokerInterceptor.handleMessage(ServiceInvokerInterceptor.java:96)&lt;br/&gt;
	at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:308)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;5f36a728&amp;gt; (a org.apache.cxf.phase.PhaseInterceptorChain)&lt;br/&gt;
	at org.apache.cxf.transport.ChainInitiationObserver.onMessage(ChainInitiationObserver.java:121)&lt;br/&gt;
	at org.apache.cxf.transport.http.AbstractHTTPDestination.invoke(AbstractHTTPDestination.java:254)&lt;br/&gt;
	at org.apache.cxf.transport.servlet.ServletController.invokeDestination(ServletController.java:234)&lt;br/&gt;
	at org.apache.cxf.transport.servlet.ServletController.invoke(ServletController.java:208)&lt;br/&gt;
	at org.apache.cxf.transport.servlet.ServletController.invoke(ServletController.java:160)&lt;br/&gt;
	at org.apache.cxf.transport.servlet.CXFNonSpringServlet.invoke(CXFNonSpringServlet.java:180)&lt;br/&gt;
	at org.apache.cxf.transport.servlet.AbstractHTTPServlet.handleRequest(AbstractHTTPServlet.java:298)&lt;br/&gt;
	at org.apache.cxf.transport.servlet.AbstractHTTPServlet.doGet(AbstractHTTPServlet.java:222)&lt;br/&gt;
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:622)&lt;br/&gt;
	at org.apache.cxf.transport.servlet.AbstractHTTPServlet.service(AbstractHTTPServlet.java:273)&lt;br/&gt;
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:292)&lt;br/&gt;
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)&lt;br/&gt;
	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:52)&lt;br/&gt;
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:240)&lt;br/&gt;
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:207)&lt;br/&gt;
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:212)&lt;br/&gt;
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:106)&lt;br/&gt;
	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:502)&lt;br/&gt;
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:141)&lt;br/&gt;
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:79)&lt;br/&gt;
	at org.apache.catalina.valves.AbstractAccessLogValve.invoke(AbstractAccessLogValve.java:616)&lt;br/&gt;
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:88)&lt;br/&gt;
	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:528)&lt;br/&gt;
	at org.apache.coyote.http11.AbstractHttp11Processor.process(AbstractHttp11Processor.java:1099)&lt;br/&gt;
	at org.apache.coyote.AbstractProtocol$AbstractConnectionHandler.process(AbstractProtocol.java:672)&lt;br/&gt;
	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1520)&lt;br/&gt;
	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.run(NioEndpoint.java:1476)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;32b056bb&amp;gt; (a org.apache.tomcat.util.net.NioChannel)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)&lt;br/&gt;
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   Locked ownable synchronizers:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked &amp;lt;623f9d31&amp;gt; (a java.util.concurrent.ThreadPoolExecutor$Worker)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The treatment thread error is :&lt;/p&gt;

&lt;p&gt;2016-06-15 14:48:15&lt;/p&gt;

&lt;p&gt;&quot;pool-1-thread-1&quot; - Thread t@26&lt;br/&gt;
   java.lang.Thread.State: WAITING&lt;br/&gt;
	at java.lang.Object.wait(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting on &amp;lt;19991ed0&amp;gt; (a org.apache.coyote.AsyncStateMachine)&lt;br/&gt;
	at java.lang.Object.wait(Object.java:502)&lt;br/&gt;
	at org.apache.coyote.AsyncStateMachine.pauseNonContainerThread(AsyncStateMachine.java:430)&lt;br/&gt;
	at org.apache.coyote.AsyncStateMachine.asyncDispatch(AsyncStateMachine.java:300)&lt;br/&gt;
	at org.apache.coyote.http11.AbstractHttp11Processor.action(AbstractHttp11Processor.java:863)&lt;br/&gt;
	at org.apache.coyote.Request.action(Request.java:378)&lt;br/&gt;
	at org.apache.catalina.core.AsyncContextImpl.dispatch(AsyncContextImpl.java:238)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;60e59a3c&amp;gt; (a java.lang.Object)&lt;br/&gt;
	at org.apache.catalina.core.AsyncContextImpl.dispatch(AsyncContextImpl.java:194)&lt;br/&gt;
	at org.apache.catalina.core.AsyncContextImpl.dispatch(AsyncContextImpl.java:188)&lt;br/&gt;
	at org.apache.cxf.transport.http.Servlet3ContinuationProvider$Servlet3Continuation.redispatch(Servlet3ContinuationProvider.java:125)&lt;br/&gt;
	at org.apache.cxf.transport.http.Servlet3ContinuationProvider$Servlet3Continuation.resume(Servlet3ContinuationProvider.java:131)&lt;br/&gt;
	at org.apache.cxf.jaxrs.impl.AsyncResponseImpl.doResumeFinal(AsyncResponseImpl.java:96)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;792a9e17&amp;gt; (a org.apache.cxf.jaxrs.impl.AsyncResponseImpl)&lt;br/&gt;
	at org.apache.cxf.jaxrs.impl.AsyncResponseImpl.doResume(AsyncResponseImpl.java:89)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;792a9e17&amp;gt; (a org.apache.cxf.jaxrs.impl.AsyncResponseImpl)&lt;br/&gt;
	at org.apache.cxf.jaxrs.impl.AsyncResponseImpl.resume(AsyncResponseImpl.java:78)&lt;br/&gt;
	at test.AsyncResponseTestImpl$2.run(AsyncResponseTestImpl.java:72)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   Locked ownable synchronizers:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked &amp;lt;4f68ae20&amp;gt; (a java.util.concurrent.ThreadPoolExecutor$Worker)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Best regards&lt;/p&gt;</description>
                <environment>&lt;p&gt;The bug was detected on :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Java 1.7.0_11&lt;/li&gt;
	&lt;li&gt;Tomcat 8.0.23&lt;/li&gt;
	&lt;li&gt;CXF 3.0.4&lt;/li&gt;
	&lt;li&gt;Red Hat 6.5&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The bug is also available on :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Java 1.8.0_77&lt;/li&gt;
	&lt;li&gt;Tomcat 8.0.35&lt;/li&gt;
	&lt;li&gt;CXF 3.1.6&lt;/li&gt;
	&lt;li&gt;Red Hat 6.5&lt;/li&gt;
&lt;/ul&gt;
</environment>
        <key id="12979353">CXF-6943</key>
            <summary>Dead lock on Async Response when timeout is set</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sergey_beryozkin">Sergey Beryozkin</assignee>
                                    <reporter username="amoire">MOIRE Antony</reporter>
                        <labels>
                            <label>test</label>
                    </labels>
                <created>Wed, 15 Jun 2016 12:48:54 +0000</created>
                <updated>Fri, 14 Oct 2016 14:10:29 +0000</updated>
                            <resolved>Tue, 21 Jun 2016 11:26:26 +0000</resolved>
                                    <version>3.0.4</version>
                    <version>3.1.6</version>
                                    <fixVersion>3.0.10</fixVersion>
                    <fixVersion>3.1.7</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                                    <component>JAX-RS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15331666" author="amoire" created="Wed, 15 Jun 2016 12:51:00 +0000"  >&lt;p&gt;This attached file contains a project which reproduces the issue&lt;/p&gt;</comment>
                            <comment id="15331670" author="amoire" created="Wed, 15 Jun 2016 12:55:39 +0000"  >&lt;p&gt;Attached files xxx_Thread_error.txt contain the stack (deadlock)&lt;/p&gt;</comment>
                            <comment id="15339693" author="sergey_beryozkin" created="Mon, 20 Jun 2016 15:20:41 +0000"  >&lt;p&gt;It appears this issue is invalid. One has to return a value via the async response object and not directly, I&apos;ll update the code to ignore such methods as in your example above.&lt;br/&gt;
I&apos;ve updated the following test locally:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cxf/blob/master/systests/jaxrs/src/test/java/org/apache/cxf/systest/jaxrs/BookContinuationStore.java#L119&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/blob/master/systests/jaxrs/src/test/java/org/apache/cxf/systest/jaxrs/BookContinuationStore.java#L119&lt;/a&gt;&lt;br/&gt;
I added an async response timeout line just before submitting a Runnable at:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cxf/blob/master/systests/jaxrs/src/test/java/org/apache/cxf/systest/jaxrs/BookContinuationStore.java#L192&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/blob/master/systests/jaxrs/src/test/java/org/apache/cxf/systest/jaxrs/BookContinuationStore.java#L192&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;All works, but it is not really needed, by default the timeout is unlimited.&lt;/p&gt;

&lt;p&gt;Can you please try and rewrite your test accordingly ?&lt;/p&gt;</comment>
                            <comment id="15341596" author="sergey_beryozkin" created="Tue, 21 Jun 2016 11:26:26 +0000"  >&lt;p&gt;Even though this issue is invalid I&apos;m closing it as Fixed because I&apos;ve updated the code to ignore AsyncResponse methods with a non-void return type&lt;/p&gt;</comment>
                            <comment id="15403645" author="oziris_sp" created="Tue, 2 Aug 2016 08:54:16 +0000"  >&lt;p&gt;This is a big breaking change (ignoring methods with non-void return type) ... I had to rework all my code, after upgrading to 3.1.7.&lt;br/&gt;
Even if I understand the need and the mistake it could be done ...&lt;/p&gt;

&lt;p&gt;In my case, I was using return type (always with null returned), in order to generate a valid WADL. How generating a valid WADL response tag for async response in this case, if the return type is always void ?&lt;/p&gt;

&lt;p&gt;Could it be less impacting to raised an exception if the return value is set to null or Void in case of AsyncResponse ?&lt;/p&gt;

&lt;p&gt;I just noticed, that the @Suspended JAX-RS 2.0 annotation of AsyncResponse has to be on the implementation now, it was working on inherited interface before 3.1.7 ... An other side effect of the modification ?&lt;/p&gt;</comment>
                            <comment id="15403755" author="sergey_beryozkin" created="Tue, 2 Aug 2016 10:44:19 +0000"  >&lt;p&gt;It was not a breaking change. It was a fix preventing the users writing an invalid JAX-RS 2.0 code - we can&apos;t have CXF supporting the invalid code.&lt;/p&gt;

&lt;p&gt;The fact WADL does not correctly represent such methods is a minor issue which can be addressed (I&apos;ll open a minor enhancement request and let you know). Most likely one would need to depend on some extra annotations already recognized by the WADL generator but some fix may be needed there to check if it is AsyncResponse. &lt;/p&gt;

&lt;p&gt;I&apos;ll check on AsyncResponse and the impl-only restriction in 3.1.7  &lt;/p&gt;</comment>
                            <comment id="15439823" author="sergey_beryozkin" created="Fri, 26 Aug 2016 20:54:50 +0000"  >&lt;p&gt;FYI:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7027&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CXF-7027&lt;/a&gt;&lt;br/&gt;
this enhances WADLGenerator to recognize @ElementClass annotation when AsyncResponse is used&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7028&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CXF-7028&lt;/a&gt;&lt;br/&gt;
this resolves the regression that @Suspended can not be inherited - all the tests in CXF 3.1.7 use it on implementation classes so it was not caught.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12810834" name="Main_Thread_error.txt" size="3765" author="amoire" created="Wed, 15 Jun 2016 12:55:39 +0000"/>
                            <attachment id="12810835" name="Working_Thread_error.txt" size="1922" author="amoire" created="Wed, 15 Jun 2016 12:55:39 +0000"/>
                            <attachment id="12810833" name="async-response-test.zip" size="5355" author="amoire" created="Wed, 15 Jun 2016 12:51:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2zhtr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>