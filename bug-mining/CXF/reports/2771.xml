<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:19:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-6823] Duplicate injectedProviders in ProviderFactory impacting throughput by ~30%</title>
                <link>https://issues.apache.org/jira/browse/CXF-6823</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;We are using CXF to process JAX-RS requests and have noticed a large number of threads blocking in a synchronised block.&lt;/p&gt;

&lt;p&gt;ClientProviderFactory and ServerProviderFactory extend ProviderFactory which contains a member variable org.apache.cxf.jaxrs.provider.ProviderFactory#injectedProviders (a LinkedList).&lt;/p&gt;

&lt;p&gt;Due to injectProviders being a list, it supports (and contains) duplicates.&lt;/p&gt;

&lt;p&gt;In our application, we currently have the following elements in injectProviders:&lt;br/&gt;
org.apache.cxf.jaxrs.client.ClientProviderFactory: 26 elements&lt;br/&gt;
org.apache.cxf.jaxrs.provider.ServerProviderFactory: 8504 elements&lt;/p&gt;

&lt;p&gt;But there are only 4 unique ProviderInfo objects in these lists, namely:&lt;br/&gt;
org.apache.cxf.jaxrs.provider.FormEncodingProvider&lt;br/&gt;
org.apache.cxf.jaxrs.provider.MultipartProvider&lt;br/&gt;
org.apache.cxf.jaxrs.provider.SourceProvider&lt;br/&gt;
org.apache.cxf.jaxrs.provider.JAXBElementProvider&lt;/p&gt;


&lt;p&gt;The issue is that injectProviders is iterated on each response to clear thread local proxies (org.apache.cxf.jaxrs.provider.ProviderFactory#clearThreadLocalProxies).&lt;/p&gt;

&lt;p&gt;Clearing of the thread local proxies relies on a synchronized block to retrieve the thread local proxies from the bus (org.apache.cxf.jaxrs.model.AbstractResourceInfo#getProxyMap).&lt;/p&gt;

&lt;p&gt;This means that at scale, the code blocks waiting for entry into this code. I have seen a huge number of threads waiting for entry into this block.&lt;/p&gt;

&lt;p&gt;As a test, I have changed injectedProviders to a Set to remove the duplicates and have seen an increase in throughput (RPS) of about ~30% in our application.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12947975">CXF-6823</key>
            <summary>Duplicate injectedProviders in ProviderFactory impacting throughput by ~30%</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sergey_beryozkin">Sergey Beryozkin</assignee>
                                    <reporter username="codenative">Brendon</reporter>
                        <labels>
                            <label>performance</label>
                    </labels>
                <created>Tue, 8 Mar 2016 11:11:20 +0000</created>
                <updated>Fri, 14 Oct 2016 14:13:27 +0000</updated>
                            <resolved>Tue, 8 Mar 2016 17:47:04 +0000</resolved>
                                    <version>3.1.5</version>
                                    <fixVersion>3.1.6</fixVersion>
                    <fixVersion>3.0.9</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                                    <component>JAX-RS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15184803" author="sergey_beryozkin" created="Tue, 8 Mar 2016 11:27:48 +0000"  >&lt;p&gt;Thanks for this analysis.&lt;/p&gt;

&lt;p&gt;I&apos;m a bit puzzled as to why injectedProviders contains 8K+ number of  elements in a single ServiceProviderFactory ?&lt;/p&gt;</comment>
                            <comment id="15184812" author="codenative" created="Tue, 8 Mar 2016 11:41:54 +0000"  >&lt;p&gt;Edited to add more detail.&lt;/p&gt;

&lt;p&gt;From what I can determine, the 4 ProviderInfo objects above are added to the injectedProviders list whenever we create a new JAXRSClient (by calling org.apache.cxf.jaxrs.client.JAXRSClientFactory#create(java.lang.String, java.lang.Class&amp;lt;T&amp;gt;, java.util.List&amp;lt;?&amp;gt;, java.util.List&amp;lt;org.apache.cxf.feature.Feature&amp;gt;, java.lang.String)).&lt;/p&gt;

&lt;p&gt;We have a LOT of jaxrs references so it&apos;s probably amplified by the number of clients we&apos;re creating.&lt;/p&gt;

&lt;p&gt;The main flow from what I can see is:&lt;br/&gt;
1. JAXRSClientFactory#create(...) calls (through a bunch of other calls) ProviderFactory#setCommonProviders&lt;br/&gt;
2. setCommonProviders passes (messageReaders, messageWriters, contextResolvers, paramConverters, readerInterceptors, and writerInterceptors) to ProviderFactory#injectContextProxies &lt;br/&gt;
3. injectContextProxies adds each provider to injectedProviders (supporting duplicates).&lt;/p&gt;

&lt;p&gt;The params in step 2 are not changed, hence they get duplicated.&lt;/p&gt;</comment>
                            <comment id="15185342" author="sergey_beryozkin" created="Tue, 8 Mar 2016 17:46:23 +0000"  >&lt;p&gt;Sure I fixed it, thanks. I guess it would be better to avoid creating lots of proxies, but I agree if one does it then it should not cause a leak with the injectedProviders list growing&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ubtr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>