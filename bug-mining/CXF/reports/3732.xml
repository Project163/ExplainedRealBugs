<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:39:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-8951] Concurrent WebClient usage causes massive thread overhead</title>
                <link>https://issues.apache.org/jira/browse/CXF-8951</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Concurrent usage of Webclients causes massively more threads to be created in cxf-3.6.x/4.x than before.&lt;br/&gt;
Supposedly this results from introducing a new conduit implementation based on the &quot;new&quot; java http client compared to HttpUrlConnection before.&lt;/p&gt;

&lt;p&gt;It seems that a new http client is created per requesting thread - and each http client in turn creates an own pool of selector/worker threads.&lt;/p&gt;

&lt;p&gt;To demonstate I&apos;ve attached a test project with several methods to test different scenarios.&lt;/p&gt;

&lt;p&gt;Each tests launches a simple JAX-RS Server, configures/uses WebClients in different configuration and submits 1000 requests via up to 100 parrallel requestor threads.&lt;/p&gt;

&lt;p&gt;The number of live threads in the JVM instance if printed after each request. Baseline is the number of threads used by the server instance + the 100 requesting threads.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;singleClientInstanceWithNewConduit -&amp;gt; reuses a threadsafe client instance, thread count rises to 700+ live threads&lt;/p&gt;

&lt;p&gt;singleClientInstanceWithOldConduit -&amp;gt; reuses a threadsafe client instance, stays at about 200 threads&lt;/p&gt;

&lt;p&gt;clientPerRequestWithOldConduit &#160; &#160; -&amp;gt; creates a client instance per request (no closing!), keeps below 200 threads&lt;/p&gt;

&lt;p&gt;clientPerRequestWithNewConduit &#160; &#160; -&amp;gt; creates a client instance per request (no closing!), creates a runaway thread leak &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/warning.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;clientPerRequestWithNewConduit is additionally interesting because current documentation is not clear about whether client instances&lt;br/&gt;
are required to be resource managed or not.&lt;br/&gt;
It appears that closing clients was not required up until cxf-3.6.0 and documentation actively encourages creating new &quot;lightweight&quot; client instances on the fly (see Thread safety in &lt;a href=&quot;https://cxf.apache.org/docs/jax-rs-client-api.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cxf.apache.org/docs/jax-rs-client-api.html&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;However, cxf-3.6+ implementation (and comments in &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-8885&quot; title=&quot;HttpClient SelectorManager threads run indefinitely causing OOM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-8885&quot;&gt;&lt;del&gt;CXF-8885&lt;/del&gt;&lt;/a&gt;) seem to suggest that clients are in fact &lt;b&gt;not lightweight&lt;/b&gt; (anymore?) but need to be closed, when no longer used.&lt;br/&gt;
But then in turn WebClient/Client does not even implement Closeable/Autoclosable. So, it&apos;s all quite muddy - and there doesn&apos;t seem to be a real consensus on the idiomatic usage of Webclients.&lt;br/&gt;
It would be very nice if you could bring some clarity on this as well.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13555681">CXF-8951</key>
            <summary>Concurrent WebClient usage causes massive thread overhead</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="reta">Andriy Redko</assignee>
                                    <reporter username="lkoe">Lars K&#246;dderitzsch</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 Oct 2023 14:12:49 +0000</created>
                <updated>Tue, 29 Apr 2025 03:01:19 +0000</updated>
                            <resolved>Sat, 20 Apr 2024 01:56:33 +0000</resolved>
                                    <version>3.6.2</version>
                    <version>4.0.3</version>
                    <version>3.6.3</version>
                    <version>4.0.4</version>
                                    <fixVersion>4.1.0</fixVersion>
                    <fixVersion>4.0.5</fixVersion>
                    <fixVersion>3.6.4</fixVersion>
                                    <component>Core</component>
                    <component>JAX-RS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17780379" author="reta" created="Fri, 27 Oct 2023 13:52:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dkulp&quot; class=&quot;user-hover&quot; rel=&quot;dkulp&quot;&gt;dkulp&lt;/a&gt; could you please take a look? thank you&lt;/p&gt;</comment>
                            <comment id="17780390" author="dkulp" created="Fri, 27 Oct 2023 14:00:21 +0000"  >&lt;p&gt;Please re-try with 4.0.4-SNAPSHOT.   I believe the thread leak is now fixed.&lt;/p&gt;</comment>
                            <comment id="17782448" author="lkoe" created="Fri, 3 Nov 2023 07:37:18 +0000"  >&lt;p&gt;Sorry for the delay.&lt;/p&gt;

&lt;p&gt;I retestet with 4.0.4-SNAPSHOT - the main issue is &lt;b&gt;not&lt;/b&gt; fixed with this version.&lt;/p&gt;

&lt;p&gt;Only the runaway thread leak exposed in &quot;clientPerRequestWithNewConduit&quot; is not present anymore.&lt;/p&gt;

&lt;p&gt;However, thread usage in both &quot;singleClientInstanceWithNewConduit&quot;/&quot;clientPerRequestWithNewConduit&quot; is still huge in comparison to the similar tests with the old conduit.&lt;/p&gt;

&lt;p&gt;If you would have a look at the attached reproducer project and its test output this will immediately become apparent.&lt;/p&gt;



&lt;p&gt;The issue at hand seems very much to be how the new conduits usage of the java http client is implemented. It can&apos;t be quite right if every client/requestor thread is using its own java http client instance - as the java http client itself manages selector/worker threads.&#160;&lt;br/&gt;
As of now this leads to each java http client having its own short lived thread pool which is extremely wasteful.&lt;/p&gt;

&lt;p&gt;Instead it appears that having all clients sharing a single, properly configured java http client would be more fitting, concept wise. The number of worker threads should be configurable by cxf users in this case and should (of course) have a sensible default - similar a servlet container having a sensible default on worker threads for incoming requests.&lt;/p&gt;</comment>
                            <comment id="17782449" author="lkoe" created="Fri, 3 Nov 2023 07:41:57 +0000"  >&lt;p&gt;I&apos;ved upped this to &quot;blocker&quot; (sorry) as we consider cxf-3.6/4.0 currently not fit for production use, given the new conduit impementation is the default.&lt;br/&gt;
Internally we have reverted to the old conduit via usage of the &quot;force.urlconnection.http.conduit&quot; property&lt;/p&gt;</comment>
                            <comment id="17790490" author="lkoe" created="Tue, 28 Nov 2023 10:49:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dkulp&quot; class=&quot;user-hover&quot; rel=&quot;dkulp&quot;&gt;dkulp&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reta&quot; class=&quot;user-hover&quot; rel=&quot;reta&quot;&gt;reta&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Is there any update on this? Can we provide something else to help this along?&lt;/p&gt;</comment>
                            <comment id="17790559" author="reta" created="Tue, 28 Nov 2023 13:14:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lkoe&quot; class=&quot;user-hover&quot; rel=&quot;lkoe&quot;&gt;lkoe&lt;/a&gt; I am unsure if &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dkulp&quot; class=&quot;user-hover&quot; rel=&quot;dkulp&quot;&gt;dkulp&lt;/a&gt; looked at it yet, but there is another option to mitigate the problem: new Bus / system property &quot;org.apache.cxf.transport.http.forceURLConnection&quot; that allows to fallback to the old HttpConduit altogether, see please &lt;a href=&quot;https://github.com/apache/cxf/commit/3d70de80fb60b74040c0214fc6a28774362556e4.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/commit/3d70de80fb60b74040c0214fc6a28774362556e4&lt;/a&gt;, not a solution obviously but workaround for the time being, thank you&lt;/p&gt;</comment>
                            <comment id="17790577" author="lkoe" created="Tue, 28 Nov 2023 13:44:59 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reta&quot; class=&quot;user-hover&quot; rel=&quot;reta&quot;&gt;reta&lt;/a&gt; we&apos;ll have a look at this.&lt;/p&gt;

&lt;p&gt;However, due to some reflection hacks to allow for PATCH methods with HttpURLConnection in cxf, this requires additional JVM args to be set in Java 17+ (&quot;--add-opens&quot;, &quot;java.base/java.net=ALL-UNNAMED&quot;).&lt;br/&gt;
We are discussing internally atm if we are going to production with workaround stacked upon workaround, or if we fall back to cxf-3.5 - at least until Spring Boot 3.0 forces us to use the jakarta-enabled cxf-4.x&lt;/p&gt;

&lt;p&gt;Edit: well, to be fair - cxf-3.5 will require the &quot;add-opens&quot; on Java 17 too&lt;/p&gt;</comment>
                            <comment id="17790734" author="reta" created="Tue, 28 Nov 2023 19:46:48 +0000"  >&lt;p&gt;&amp;gt; However, due to some reflection hacks to allow for PATCH methods with HttpURLConnection in cxf, this requires additional JVM args to be set in Java 17+ (&quot;--add-opens&quot;, &quot;java.base/java.net=ALL-UNNAMED&quot;).&lt;/p&gt;

&lt;p&gt;Correct, this is sadly a trade-off (for the time being), thank you&lt;/p&gt;</comment>
                            <comment id="17802828" author="lkoe" created="Thu, 4 Jan 2024 09:38:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dkulp&quot; class=&quot;user-hover&quot; rel=&quot;dkulp&quot;&gt;dkulp&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reta&quot; class=&quot;user-hover&quot; rel=&quot;reta&quot;&gt;reta&lt;/a&gt; Sorry about this, I wouldn&apos;t have nagged, but my team pressured me to. So here it goes:&lt;/p&gt;

&lt;p&gt;Any update on this? Does the ticket need to be assigned to move forward?&lt;/p&gt;</comment>
                            <comment id="17803719" author="reta" created="Fri, 5 Jan 2024 22:56:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lkoe&quot; class=&quot;user-hover&quot; rel=&quot;lkoe&quot;&gt;lkoe&lt;/a&gt; apologies, we need to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dkulp&quot; class=&quot;user-hover&quot; rel=&quot;dkulp&quot;&gt;dkulp&lt;/a&gt; &apos;s input as implementor of the feature (JDK&apos;s HttpClient)&lt;/p&gt;</comment>
                            <comment id="17831574" author="reta" created="Wed, 27 Mar 2024 23:16:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lkoe&quot; class=&quot;user-hover&quot; rel=&quot;lkoe&quot;&gt;lkoe&lt;/a&gt; sincere apologies for this issue taking a long time to be looked at, I am on it since &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dkulp&quot; class=&quot;user-hover&quot; rel=&quot;dkulp&quot;&gt;dkulp&lt;/a&gt; is not available for the time being. The issue is reproducible on 4.0.4&lt;/p&gt;</comment>
                            <comment id="17839173" author="reta" created="Sat, 20 Apr 2024 01:56:25 +0000"  >&lt;p&gt;Documentation updated: &lt;a href=&quot;https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=49941&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=49941&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13063906" name="cxf-connector-threads.zip" size="119771" author="lkoe" created="Thu, 26 Oct 2023 13:46:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 29 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1l7s0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>