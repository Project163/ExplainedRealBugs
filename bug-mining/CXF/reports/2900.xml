<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 12:21:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-7109] ClientCallback may be invoked twice when Async HTTP Transport is used</title>
                <link>https://issues.apache.org/jira/browse/CXF-7109</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;With Async HTTP Transport (&lt;tt&gt;cxf-rt-transports-http-hc&lt;/tt&gt;) enabled, the &lt;tt&gt;ClientCallback&lt;/tt&gt; object passed for the invocation of the client may be called twice when a failure occurs during the invocation:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Client client = ...
client.invoke(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ClientCallback { ... }, opName, params);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;At this moment, this issue is reproduced only on RHEL 6.8, but code analysis shows that it&apos;s a general multithreading issue with Async HTTP Transport and in theory it can happen on any platform.&lt;/p&gt;

&lt;p&gt;Here is what I&apos;ve found with the code analysis:&lt;/p&gt;

&lt;p&gt;If for some reason the target endpoint is not reachable, this issue can happen when the callback for Apache HC &lt;tt&gt;HttpAsyncClient&lt;/tt&gt; [1] is invoked and thus shuts down &lt;tt&gt;SharedOutputBuffer&lt;/tt&gt; earlier than &lt;tt&gt;HTTPConduit&lt;/tt&gt; tries to write it before closing the conduit itself [2].&lt;br/&gt;
[1] &lt;a href=&quot;https://github.com/apache/cxf/blob/cxf-3.1.8/rt/transports/http-hc/src/main/java/org/apache/cxf/transport/http/asyncclient/AsyncHTTPConduit.java#L464&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/blob/cxf-3.1.8/rt/transports/http-hc/src/main/java/org/apache/cxf/transport/http/asyncclient/AsyncHTTPConduit.java#L464&lt;/a&gt;&lt;br/&gt;
[2] &lt;a href=&quot;https://github.com/apache/cxf/blob/cxf-3.1.8/rt/transports/http-hc/src/main/java/org/apache/cxf/transport/http/asyncclient/SharedOutputBuffer.java#L231&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/blob/cxf-3.1.8/rt/transports/http-hc/src/main/java/org/apache/cxf/transport/http/asyncclient/SharedOutputBuffer.java#L231&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;When the above issue happens, the interceptor chain&apos;s fault observer is eventually invoked twice, once from the response workqueue thread [3] that is spawn by the Apache HC &lt;tt&gt;HttpAsyncClient&lt;/tt&gt; callback and the second time from the requesting thread at the interceptor chain [4]; Thus the client callback is also invoked twice [5]!&lt;br/&gt;
[3] &lt;a href=&quot;https://github.com/apache/cxf/blob/cxf-3.1.8/rt/transports/http/src/main/java/org/apache/cxf/transport/http/HTTPConduit.java#L1177&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/blob/cxf-3.1.8/rt/transports/http/src/main/java/org/apache/cxf/transport/http/HTTPConduit.java#L1177&lt;/a&gt;&lt;br/&gt;
[4] &lt;a href=&quot;https://github.com/apache/cxf/blob/cxf-3.1.8/core/src/main/java/org/apache/cxf/phase/PhaseInterceptorChain.java#L366&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/blob/cxf-3.1.8/core/src/main/java/org/apache/cxf/phase/PhaseInterceptorChain.java#L366&lt;/a&gt;&lt;br/&gt;
[5] &lt;a href=&quot;https://github.com/apache/cxf/blob/cxf-3.1.8/core/src/main/java/org/apache/cxf/interceptor/ClientOutFaultObserver.java#L59&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/blob/cxf-3.1.8/core/src/main/java/org/apache/cxf/interceptor/ClientOutFaultObserver.java#L59&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Why it happens so reliably only on RHEL 6.8 is still unclear (probably due to some thread scheduling logic specific to the kernel for RHEL 6.8), but since it&apos;s essentially an ordering issue for two distinct threads, in theory it can happen on any platforms. In general, CXF should really enforce that every client callback be invoked once and only once.&lt;/p&gt;</description>
                <environment>&lt;p&gt;RHEL 6.8&lt;/p&gt;</environment>
        <key id="13015023">CXF-7109</key>
            <summary>ClientCallback may be invoked twice when Async HTTP Transport is used</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ffang">Freeman Yue Fang</assignee>
                                    <reporter username="tadayosi">Tadayoshi Sato</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 Oct 2016 09:34:27 +0000</created>
                <updated>Wed, 22 Mar 2017 17:24:58 +0000</updated>
                            <resolved>Wed, 26 Oct 2016 06:10:45 +0000</resolved>
                                    <version>3.1.8</version>
                                    <fixVersion>3.1.9</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                                    <component>Core</component>
                    <component>Transports</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15604787" author="tadayosi" created="Tue, 25 Oct 2016 09:36:26 +0000"  >&lt;p&gt;I&apos;m working on a pull req.&lt;/p&gt;

&lt;p&gt;I think the best way to fix this issue is to remove the callback instance from the exchange once the callback&apos;s &lt;tt&gt;handle*****&lt;/tt&gt; method is invoked so any other thread cannot invoke it again within the same exchange.&lt;/p&gt;</comment>
                            <comment id="15606965" author="githubbot" created="Wed, 26 Oct 2016 00:54:22 +0000"  >&lt;p&gt;GitHub user tadayosi opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cxf/pull/187&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/187&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7109&quot; title=&quot;ClientCallback may be invoked twice when Async HTTP Transport is used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7109&quot;&gt;&lt;del&gt;CXF-7109&lt;/del&gt;&lt;/a&gt; ClientCallback may be invoked twice when Async HTTP Transport is used&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7109&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CXF-7109&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I think the best way to make a client callback invoked once and only once is to remove from the exchange immediately after its `handle***()` method is invoked once. It should prevent a client callback from being called more than once not only for the &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7109&quot; title=&quot;ClientCallback may be invoked twice when Async HTTP Transport is used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7109&quot;&gt;&lt;del&gt;CXF-7109&lt;/del&gt;&lt;/a&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7109&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CXF-7109&lt;/a&gt;) case but also for any other potential cases where the callback may be invoked more than once accidentally.&lt;/p&gt;

&lt;p&gt;    I added `remove(Class&amp;lt;T&amp;gt;)` to `Exchange` (`StringMap`) for convenience and symmetry. It is necessary to remove the callback right before calling its `handle**&lt;b&gt;()`, as otherwise some other thread may grab it concurrently before the current thread invokes `handle&lt;/b&gt;**()`.&lt;/p&gt;

&lt;p&gt;    I also added a test case `AsyncHTTPConduitTest#testCallAsyncCallbackInvokedOnlyOnce()`, but please note this test fails only on RHEL 6.8 even without this fix. In order to check if this fix is really effective, you need to run the test on RHEL 6.8 to compare the results.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tadayosi/cxf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tadayosi/cxf&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7109&quot; title=&quot;ClientCallback may be invoked twice when Async HTTP Transport is used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7109&quot;&gt;&lt;del&gt;CXF-7109&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cxf/pull/187.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/187.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #187&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4eb81d3044c0f663d580cdbd3b611d5e3b1b4ac5&lt;br/&gt;
Author: Tadayoshi Sato &amp;lt;sato.tadayoshi@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-10-25T09:45:42Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-7109&quot; title=&quot;ClientCallback may be invoked twice when Async HTTP Transport is used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-7109&quot;&gt;&lt;del&gt;CXF-7109&lt;/del&gt;&lt;/a&gt; ClientCallback may be invoked twice when Async HTTP Transport is used&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15607283" author="githubbot" created="Wed, 26 Oct 2016 03:34:12 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cxf/pull/187&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/187&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15607569" author="ffang" created="Wed, 26 Oct 2016 06:13:41 +0000"  >&lt;p&gt;patch applied on behalf of  Tadayoshi Sato with thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i35cnz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>