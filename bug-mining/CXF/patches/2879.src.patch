diff --git a/rt/rs/security/oauth-parent/oauth2/pom.xml b/rt/rs/security/oauth-parent/oauth2/pom.xml
index 57d109d465..d4fa865c99 100644
--- a/rt/rs/security/oauth-parent/oauth2/pom.xml
+++ b/rt/rs/security/oauth-parent/oauth2/pom.xml
@@ -17,203 +17,274 @@
   specific language governing permissions and limitations
   under the License.
 -->
-<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
-    <modelVersion>4.0.0</modelVersion>
-    <artifactId>cxf-rt-rs-security-oauth2</artifactId>
-    <packaging>bundle</packaging>
-    <name>Apache CXF Runtime OAuth 2.0</name>
-    <description>Apache CXF Runtime OAuth 2.0</description>
-    <url>http://cxf.apache.org</url>
-    <parent>
-        <artifactId>cxf-rt-rs-security-oauth-parent</artifactId>
-        <groupId>org.apache.cxf</groupId>
-        <version>3.2.0-SNAPSHOT</version>
-        <relativePath>../pom.xml</relativePath>
-    </parent>
-    <properties>
-        <cxf.osgi.import>
-            net.sf.ehcache*;resolution:=optional;version="[2.5, 3.0.0)",
-            javax.servlet*;version="${cxf.osgi.javax.servlet.version}"
-        </cxf.osgi.import>
-        <hibernate.em.version>4.1.0.Final</hibernate.em.version>
-        <hsqldb.version>2.3.4</hsqldb.version>
-    </properties>
-    <dependencies>
-        <dependency>
-            <groupId>org.apache.cxf</groupId>
-            <artifactId>cxf-rt-frontend-jaxrs</artifactId>
-            <version>${project.version}</version>
-        </dependency>
-        <dependency>
-            <groupId>org.apache.cxf</groupId>
-            <artifactId>cxf-rt-rs-security-jose-jaxrs</artifactId>
-            <version>${project.version}</version>
-        </dependency> 
-        <dependency>
-            <groupId>org.apache.cxf</groupId>
-            <artifactId>cxf-rt-rs-client</artifactId>
-            <version>${project.version}</version>
-        </dependency>
-        <dependency>
-            <groupId>${cxf.servlet-api.group}</groupId>
-            <artifactId>${cxf.servlet-api.artifact}</artifactId>
-            <scope>provided</scope>
-            <optional>true</optional>
-        </dependency>
-        <dependency>
-          <groupId>net.sf.ehcache</groupId>
-          <artifactId>ehcache</artifactId>
-          <version>${cxf.ehcache.version}</version>
-          <scope>provided</scope>
-          <optional>true</optional>
-        </dependency>
-        <dependency>
-          <groupId>javax.cache</groupId>
-          <artifactId>cache-api</artifactId>
-          <version>${cxf.jcache.version}</version>
-          <scope>provided</scope>
-          <optional>true</optional>
-        </dependency>
-        <dependency>
-            <groupId>org.apache.geronimo.specs</groupId>
-            <artifactId>geronimo-jpa_2.0_spec</artifactId>
-            <version>${cxf.geronimo.jpa.version}</version>
-            <scope>provided</scope>
-            <optional>true</optional>
-        </dependency>
-        <dependency>
-            <groupId>org.codehaus.jettison</groupId>
-            <artifactId>jettison</artifactId>
-            <scope>test</scope>
-        </dependency>
-        <dependency>
-            <groupId>org.apache.cxf</groupId>
-            <artifactId>cxf-rt-rs-extension-providers</artifactId>
-            <version>${project.version}</version>
-            <scope>test</scope>
-        </dependency> 
-        <dependency>
-            <groupId>junit</groupId>
-            <artifactId>junit</artifactId>
-            <scope>test</scope>
-        </dependency>
-        <dependency>
-            <groupId>org.easymock</groupId>
-            <artifactId>easymock</artifactId>
-            <scope>test</scope>
-        </dependency>
-        <dependency>
-            <groupId>org.hsqldb</groupId>
-            <artifactId>hsqldb</artifactId>
-            <version>${hsqldb.version}</version>
-            <scope>test</scope>
-        </dependency>
-        <dependency>
-          <groupId>org.ehcache</groupId>
-          <artifactId>ehcache</artifactId>
-          <version>${cxf.ehcache3.version}</version>
-          <scope>test</scope>
-        </dependency>
-        <!--
-        <dependency>
-             <groupId>org.apache.openjpa</groupId>
-             <artifactId>openjpa</artifactId>
-             <version>${cxf.openjpa.version}</version>
-             <scope>provided</scope>
-        </dependency>
-        -->
-        <dependency>
-            <groupId>org.hibernate</groupId>
-            <artifactId>hibernate-entitymanager</artifactId>
-            <version>${hibernate.em.version}</version>
-            <scope>test</scope>
-        </dependency>
-      <dependency>
-        <groupId>org.slf4j</groupId>
-        <artifactId>slf4j-nop</artifactId>
-        <version>${cxf.slf4j.version}</version>
-        <scope>test</scope>
-      </dependency>
-        
-     </dependencies>
-     <build>
-       <plugins>
-         <plugin>
-	       <groupId>org.bsc.maven</groupId>
-	       <artifactId>maven-processor-plugin</artifactId>
-	       <version>3.1.0</version>
-	       <executions>
-	        <execution>
-		     <id>process</id>
-		     <goals>
-		       <goal>process</goal>
-		     </goals>
-		     <phase>generate-sources</phase>
-		     <configuration>
-               <compilerArguments>-Aopenjpa.source=7 -Aopenjpa.metamodel=true</compilerArguments>
-		       <processors>
-		         <processor>org.apache.openjpa.persistence.meta.AnnotationProcessor6</processor>
-	           </processors>
-               <outputDirectory>target/generated-sources/metamodel</outputDirectory>
-		     </configuration>
-            </execution>
-		   </executions>
-		   <dependencies>
-		     <dependency>
-		       <groupId>org.apache.openjpa</groupId>
-		       <artifactId>openjpa</artifactId>
-		       <version>${cxf.openjpa.version}</version>
-		     </dependency>
-		   </dependencies>
-		 </plugin>
-		 <plugin>
-		  <groupId>org.codehaus.mojo</groupId>
-		  <artifactId>build-helper-maven-plugin</artifactId>
-		  <version>1.10</version>
-		  <executions>
-		    <execution>
-		      <id>add-source</id>
-		      <phase>generate-sources</phase>
-		      <goals>
-			<goal>add-source</goal>
-		      </goals>
-		      <configuration>
-			<sources>
-			  <source>target/generated-sources/metamodel</source>
-			</sources>
-		      </configuration>
-		    </execution>
-		  </executions>
-		 </plugin>
-            <!--
-            <plugin>
-                <groupId>org.apache.openjpa</groupId>
-                <artifactId>openjpa-maven-plugin</artifactId>
-                <version>${cxf.openjpa.version}</version>
-                <configuration>
-                    <includes>
-                       org/apache/cxf/rs/security/oauth2/common/Client.class,
-                       org/apache/cxf/rs/security/oauth2/common/UserSubject.class,
-                       org/apache/cxf/rs/security/oauth2/grants/code/AuthorizationCodeGrant,
-                       org/apache/cxf/rs/security/oauth2/grants/code/ServerAuthorizationCodeGrant.class,
-                       org/apache/cxf/rs/security/oauth2/tokens/bearer/BearerAccessToken.class,
-                       org/apache/cxf/rs/security/oauth2/common/ServerAccessToken.class,
-                       org/apache/cxf/rs/security/oauth2/common/AccessToken.class,
-                       org/apache/cxf/rs/security/oauth2/tokens/refresh/RefreshToken.class,
-                       org/apache/cxf/rs/security/oauth2/common/OAuthPermission.class
-                    </includes>
-                </configuration>
-                <executions>
-                    <execution>
-                        <id>enhancer</id>
-                        <phase>process-test-classes</phase>
-                        <goals>
-                            <goal>test-enhance</goal>
-                        </goals>
-                    </execution>
-                </executions>
-            </plugin>
-            -->
-        </plugins>
-      </build>
-   </project>
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+  <modelVersion>4.0.0</modelVersion>
+  <artifactId>cxf-rt-rs-security-oauth2</artifactId>
+  <packaging>bundle</packaging>
+  <name>Apache CXF Runtime OAuth 2.0</name>
+  <description>Apache CXF Runtime OAuth 2.0</description>
+  <url>http://cxf.apache.org</url>
+  <parent>
+    <artifactId>cxf-rt-rs-security-oauth-parent</artifactId>
+    <groupId>org.apache.cxf</groupId>
+    <version>3.2.0-SNAPSHOT</version>
+    <relativePath>../pom.xml</relativePath>
+  </parent>
+  <properties>
+    <cxf.osgi.import>
+      net.sf.ehcache*;resolution:=optional;version="[2.5, 3.0.0)",
+      javax.servlet*;version="${cxf.osgi.javax.servlet.version}"
+    </cxf.osgi.import>
+    <hibernate.em.version>4.1.0.Final</hibernate.em.version>
+    <hsqldb.version>2.3.4</hsqldb.version>
+  </properties>
+  <dependencies>
+    <dependency>
+      <groupId>org.apache.cxf</groupId>
+      <artifactId>cxf-rt-frontend-jaxrs</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.apache.cxf</groupId>
+      <artifactId>cxf-rt-rs-security-jose-jaxrs</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.apache.cxf</groupId>
+      <artifactId>cxf-rt-rs-client</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>${cxf.servlet-api.group}</groupId>
+      <artifactId>${cxf.servlet-api.artifact}</artifactId>
+      <scope>provided</scope>
+      <optional>true</optional>
+    </dependency>
+    <dependency>
+      <groupId>net.sf.ehcache</groupId>
+      <artifactId>ehcache</artifactId>
+      <version>${cxf.ehcache.version}</version>
+      <scope>provided</scope>
+      <optional>true</optional>
+    </dependency>
+    <dependency>
+      <groupId>javax.cache</groupId>
+      <artifactId>cache-api</artifactId>
+      <version>${cxf.jcache.version}</version>
+      <scope>provided</scope>
+      <optional>true</optional>
+    </dependency>
+    <dependency>
+      <groupId>org.apache.geronimo.specs</groupId>
+      <artifactId>geronimo-jpa_2.0_spec</artifactId>
+      <version>${cxf.geronimo.jpa.version}</version>
+      <scope>provided</scope>
+      <optional>true</optional>
+    </dependency>
+    <dependency>
+      <groupId>org.codehaus.jettison</groupId>
+      <artifactId>jettison</artifactId>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.apache.cxf</groupId>
+      <artifactId>cxf-rt-rs-extension-providers</artifactId>
+      <version>${project.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>junit</groupId>
+      <artifactId>junit</artifactId>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.easymock</groupId>
+      <artifactId>easymock</artifactId>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.hsqldb</groupId>
+      <artifactId>hsqldb</artifactId>
+      <version>${hsqldb.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.ehcache</groupId>
+      <artifactId>ehcache</artifactId>
+      <version>${cxf.ehcache3.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.apache.openjpa</groupId>
+      <artifactId>openjpa</artifactId>
+      <version>${cxf.openjpa.version}</version>
+      <scope>test</scope>
+      <optional>true</optional>
+    </dependency>
+    <dependency>
+      <groupId>org.hibernate</groupId>
+      <artifactId>hibernate-entitymanager</artifactId>
+      <version>${hibernate.em.version}</version>
+      <scope>test</scope>
+      <optional>true</optional>
+    </dependency>
+    <dependency>
+      <groupId>org.hibernate</groupId>
+      <artifactId>hibernate-ehcache</artifactId>
+      <version>${hibernate.em.version}</version>
+      <scope>test</scope>
+      <optional>true</optional>
+    </dependency>
+    <dependency>
+      <groupId>org.slf4j</groupId>
+      <artifactId>slf4j-nop</artifactId>
+      <version>${cxf.slf4j.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.springframework</groupId>
+      <artifactId>spring-aop</artifactId>
+      <version>${cxf.spring.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.springframework</groupId>
+      <artifactId>spring-context</artifactId>
+      <version>${cxf.spring.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.springframework</groupId>
+      <artifactId>spring-orm</artifactId>
+      <version>${cxf.spring.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.springframework</groupId>
+      <artifactId>spring-test</artifactId>
+      <version>${cxf.spring.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.springframework</groupId>
+      <artifactId>spring-tx</artifactId>
+      <version>${cxf.spring.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.slf4j</groupId>
+      <artifactId>jcl-over-slf4j</artifactId>
+      <version>${cxf.slf4j.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.aspectj</groupId>
+      <artifactId>aspectjweaver</artifactId>
+      <version>1.8.7</version>
+      <scope>test</scope>
+    </dependency>
+
+  </dependencies>
+  <build>
+    <plugins>
+      <plugin>
+        <groupId>org.bsc.maven</groupId>
+        <artifactId>maven-processor-plugin</artifactId>
+        <version>3.1.0</version>
+        <executions>
+          <execution>
+            <id>process</id>
+            <goals>
+              <goal>process</goal>
+            </goals>
+            <phase>generate-sources</phase>
+            <configuration>
+              <compilerArguments>-Aopenjpa.source=7 -Aopenjpa.metamodel=true</compilerArguments>
+              <processors>
+                <processor>org.apache.openjpa.persistence.meta.AnnotationProcessor6</processor>
+              </processors>
+              <outputDirectory>target/generated-sources/metamodel</outputDirectory>
+            </configuration>
+          </execution>
+        </executions>
+        <dependencies>
+          <dependency>
+            <groupId>org.apache.openjpa</groupId>
+            <artifactId>openjpa</artifactId>
+            <version>${cxf.openjpa.version}</version>
+          </dependency>
+        </dependencies>
+      </plugin>
+      <plugin>
+        <groupId>org.codehaus.mojo</groupId>
+        <artifactId>build-helper-maven-plugin</artifactId>
+        <version>1.10</version>
+        <executions>
+          <execution>
+            <id>add-source</id>
+            <phase>generate-sources</phase>
+            <goals>
+              <goal>add-source</goal>
+            </goals>
+            <configuration>
+              <sources>
+                <source>target/generated-sources/metamodel</source>
+              </sources>
+            </configuration>
+          </execution>
+        </executions>
+      </plugin>
+      <plugin>
+        <groupId>org.apache.maven.plugins</groupId>
+        <artifactId>maven-source-plugin</artifactId>
+        <version>3.0.1</version>
+        <executions>
+          <execution>
+            <id>attach-sources</id>
+            <phase>verify</phase>
+            <goals>
+              <goal>jar-no-fork</goal>
+            </goals>
+          </execution>
+        </executions>
+      </plugin>
+      <!-- this configures the surefire plugin to run your tests with the javaagent enabled -->
+      <!-- (openJPA loadtime weaving) -->
+      <plugin>
+        <groupId>org.apache.maven.plugins</groupId>
+        <artifactId>maven-surefire-plugin</artifactId>
+        <configuration>
+          <argLine>-javaagent:${project.basedir}/target/openjpa-${cxf.openjpa.version}.jar</argLine>
+          <workingDirectory>${project.basedir}/target</workingDirectory>
+        </configuration>
+      </plugin>
+      <!-- this tells maven to copy the openjpa agent jar into your target/ directory -->
+      <!-- where surefire can see it -->
+      <plugin>
+        <groupId>org.apache.maven.plugins</groupId>
+        <artifactId>maven-dependency-plugin</artifactId>
+        <executions>
+          <execution>
+            <id>copy</id>
+            <phase>process-resources</phase>
+            <goals>
+              <goal>copy</goal>
+            </goals>
+            <configuration>
+              <artifactItems>
+                <artifactItem>
+                  <groupId>org.apache.openjpa</groupId>
+                  <artifactId>openjpa</artifactId>
+                  <version>${cxf.openjpa.version}</version>
+                  <outputDirectory>${project.build.directory}</outputDirectory>
+                </artifactItem>
+              </artifactItems>
+            </configuration>
+          </execution>
+        </executions>
+      </plugin>
+    </plugins>
+  </build>
+</project>
+
diff --git a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/AccessToken.java b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/AccessToken.java
index ade93b480e..39699d4fc0 100644
--- a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/AccessToken.java
+++ b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/AccessToken.java
@@ -23,6 +23,7 @@ import java.util.LinkedHashMap;
 import java.util.Map;
 
 import javax.persistence.ElementCollection;
+import javax.persistence.FetchType;
 import javax.persistence.Id;
 import javax.persistence.MapKeyColumn;
 import javax.persistence.MappedSuperclass;
@@ -117,7 +118,7 @@ public abstract class AccessToken implements Serializable {
      * Gets token parameters 
      * @return
      */
-    @ElementCollection
+    @ElementCollection(fetch = FetchType.EAGER)
     @MapKeyColumn(name = "propName")
     public Map<String, String> getParameters() {
         return parameters;
diff --git a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/Client.java b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/Client.java
index c465d40b9c..5988fcd6fe 100644
--- a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/Client.java
+++ b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/Client.java
@@ -26,10 +26,12 @@ import java.util.Map;
 
 import javax.persistence.ElementCollection;
 import javax.persistence.Entity;
+import javax.persistence.FetchType;
 import javax.persistence.Id;
 import javax.persistence.ManyToOne;
 import javax.persistence.MapKeyColumn;
 import javax.persistence.OneToOne;
+import javax.persistence.OrderColumn;
 
 
 /**
@@ -37,59 +39,59 @@ import javax.persistence.OneToOne;
  */
 @Entity
 public class Client implements Serializable {
-    
+
     private static final long serialVersionUID = -5550840247125850922L;
-    
+
     private String clientId;
     private String clientSecret;
     private String clientIpAddress;
-    
+
     private String applicationName;
     private String applicationDescription;
     private String applicationWebUri;
     private String applicationLogoUri;
     private List<String> applicationCertificates = new LinkedList<String>();
     private List<String> redirectUris = new LinkedList<String>();
-    
+
     private boolean isConfidential;
     private List<String> allowedGrantTypes = new LinkedList<String>();
     private List<String> registeredScopes = new LinkedList<String>();
     private List<String> registeredAudiences = new LinkedList<String>();
-    
+
     private Map<String, String> properties = new HashMap<String, String>();
     private UserSubject subject;
     private UserSubject resourceOwnerSubject;
-    private long registeredAt;    
+    private long registeredAt;
     private String homeRealm;
-    
+
     public Client() {
-        
+
     }
-    
+
     public Client(String clientId, String clientSecret, boolean isConfidential) {
         this.clientId = clientId;
         this.clientSecret = clientSecret;
         this.isConfidential = isConfidential;
     }
 
-    public Client(String clientId, 
+    public Client(String clientId,
                   String clientSecret,
                   boolean isConfidential,
                   String applicationName) {
         this(clientId, clientSecret, isConfidential);
         this.applicationName = applicationName;
     }
-    
-    public Client(String clientId, 
+
+    public Client(String clientId,
                   String clientSecret,
                   boolean isConfidential,
                   String applicationName,
                   String applicationWebUri) {
         this(clientId, clientSecret, isConfidential, applicationName);
         this.applicationWebUri = applicationWebUri;
-        
+
     }
-    
+
     /**
      * Get the client registration id
      * @return the consumer key
@@ -102,7 +104,7 @@ public class Client implements Serializable {
     public void setClientId(String id) {
         clientId = id;
     }
-    
+
     /**
      * Get the client secret
      * @return the consumer key
@@ -114,7 +116,7 @@ public class Client implements Serializable {
     public void setClientSecret(String id) {
         clientSecret = id;
     }
-        
+
     /**
      * Get the name of the third-party application
      * this client represents
@@ -149,6 +151,14 @@ public class Client implements Serializable {
         this.applicationWebUri = applicationWebUri;
     }
 
+    /**
+     * Get the description of the third-party application.
+     * @return the application description
+     */
+    public String getApplicationDescription() {
+        return applicationDescription;
+    }
+
     /**
      * Set the description of the third-party application.
      * @param applicationDescription the description
@@ -158,13 +168,13 @@ public class Client implements Serializable {
     }
 
     /**
-     * Get the description of the third-party application.
-     * @return the application description
+     * Get the URI pointing to a logo image of the client application
+     * @return the logo URI
      */
-    public String getApplicationDescription() {
-        return applicationDescription;
+    public String getApplicationLogoUri() {
+        return applicationLogoUri;
     }
-    
+
     /**
      * Set the URI pointing to a logo image of the client application
      * @param logoPath the logo URI
@@ -174,18 +184,18 @@ public class Client implements Serializable {
     }
 
     /**
-     * Get the URI pointing to a logo image of the client application
-     * @return the logo URI
+     * Get the confidentiality status of this client application.
+     * @return the confidentiality status
      */
-    public String getApplicationLogoUri() {
-        return applicationLogoUri;
+    public boolean isConfidential() {
+        return isConfidential;
     }
 
     /**
      * Set the confidentiality status of this client application.
      * This can be used to restrict which OAuth2 flows this client
      * can participate in.
-     * 
+     *
      * @param isConf true if the client is confidential
      */
     public void setConfidential(boolean isConf) {
@@ -193,11 +203,14 @@ public class Client implements Serializable {
     }
 
     /**
-     * Get the confidentiality status of this client application.
-     * @return the confidentiality status
+     * Get a list of URIs the AuthorizationService
+     * may return the authorization code to
+     * @return the redirect uris
      */
-    public boolean isConfidential() {
-        return isConfidential;
+    @ElementCollection(fetch = FetchType.EAGER)
+    @OrderColumn
+    public List<String> getRedirectUris() {
+        return redirectUris;
     }
 
     /**
@@ -210,13 +223,14 @@ public class Client implements Serializable {
     }
 
     /**
-     * Get a list of URIs the AuthorizationService
-     * may return the authorization code to
-     * @return the redirect uris
+     * Get the list of access token grant types this client
+     * can use to obtain the access tokens.
+     * @return the list of grant types
      */
-    @ElementCollection
-    public List<String> getRedirectUris() {
-        return redirectUris;
+    @ElementCollection(fetch = FetchType.EAGER)
+    @OrderColumn
+    public List<String> getAllowedGrantTypes() {
+        return allowedGrantTypes;
     }
 
     /**
@@ -229,21 +243,21 @@ public class Client implements Serializable {
     }
 
     /**
-     * Get the list of access token grant types this client
-     * can use to obtain the access tokens.
-     * @return the list of grant types
+     * Get the {@link UserSubject} representing this Client
+     * authentication
+     * @return the user subject
      */
-    @ElementCollection
-    public List<String> getAllowedGrantTypes() {
-        return allowedGrantTypes;
+    @OneToOne
+    public UserSubject getSubject() {
+        return subject;
     }
 
     /**
-     * Set the {@link UserSubject} representing this Client 
+     * Set the {@link UserSubject} representing this Client
      * authentication. This property may be set during the registration
      * in cases where a 3rd party client needs to authenticate first before
      * registering as OAuth2 client. This property may also wrap a clientId
-     * in cases where a client credentials flow is used   
+     * in cases where a client credentials flow is used
      *
      * @param subject the user subject
      */
@@ -252,43 +266,31 @@ public class Client implements Serializable {
     }
 
     /**
-     * Get the {@link UserSubject} representing this Client 
-     * authentication
-     * @return the user subject
+     * Get the {@link UserSubject} representing the resource owner
+     * who has registered this client
+     * @return the resource owner user subject
      */
-    @OneToOne
-    public UserSubject getSubject() {
-        return subject;
+    @ManyToOne
+    public UserSubject getResourceOwnerSubject() {
+        return resourceOwnerSubject;
     }
 
     /**
-     * Set the {@link UserSubject} representing the resource owner 
+     * Set the {@link UserSubject} representing the resource owner
      * who has registered this client. This property may be set in cases where
      * each account (resource) owner registers account specific Clients
      *
-     * @param subject the resource owner user subject
+     * @param resourceOwnerSubject the resource owner user subject
      */
-
     public void setResourceOwnerSubject(UserSubject resourceOwnerSubject) {
         this.resourceOwnerSubject = resourceOwnerSubject;
     }
 
-
-    /**
-     * Get the {@link UserSubject} representing the resource owner 
-     * who has registered this client
-     * @return the resource owner user subject
-     */
-    @ManyToOne
-    public UserSubject getResourceOwnerSubject() {
-        return resourceOwnerSubject;
-    }
-    
     /**
      * Get the list of additional client properties
      * @return the list of properties
      */
-    @ElementCollection
+    @ElementCollection(fetch = FetchType.EAGER)
     @MapKeyColumn(name = "name")
     public Map<String, String> getProperties() {
         return properties;
@@ -306,7 +308,8 @@ public class Client implements Serializable {
      * Get the list of registered scopes
      * @return scopes
      */
-    @ElementCollection
+    @ElementCollection(fetch = FetchType.EAGER)
+    @OrderColumn
     public List<String> getRegisteredScopes() {
         return registeredScopes;
     }
@@ -316,7 +319,7 @@ public class Client implements Serializable {
      * Registering the scopes will allow the clients not to include the scopes
      * and delegate to the runtime to enforce that the current request scopes are
      * a subset of the pre-registered scopes.
-     * 
+     *
      * Client Registration service is expected to reject unknown scopes. 
      * @param registeredScopes the scopes
      */
@@ -324,7 +327,8 @@ public class Client implements Serializable {
         this.registeredScopes = registeredScopes;
     }
 
-    @ElementCollection
+    @ElementCollection(fetch = FetchType.EAGER)
+    @OrderColumn
     public List<String> getRegisteredAudiences() {
         return registeredAudiences;
     }
@@ -337,7 +341,8 @@ public class Client implements Serializable {
         this.registeredAudiences = registeredAudiences;
     }
 
-    @ElementCollection
+    @ElementCollection(fetch = FetchType.EAGER)
+    @OrderColumn
     public List<String> getApplicationCertificates() {
         return applicationCertificates;
     }
diff --git a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/OAuthPermission.java b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/OAuthPermission.java
index 62a2e4c66b..5317c638f9 100644
--- a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/OAuthPermission.java
+++ b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/OAuthPermission.java
@@ -22,12 +22,16 @@ import java.io.Serializable;
 import java.util.LinkedList;
 import java.util.List;
 
+import javax.persistence.Cacheable;
 import javax.persistence.ElementCollection;
 import javax.persistence.Entity;
+import javax.persistence.FetchType;
 import javax.persistence.Id;
+import javax.persistence.OrderColumn;
 import javax.persistence.Transient;
 import javax.xml.bind.annotation.XmlRootElement;
 
+
 /**
  * Provides the complete information about a given opaque permission.
  * For example, a scope parameter such as "read_calendar" will be
@@ -37,6 +41,7 @@ import javax.xml.bind.annotation.XmlRootElement;
  */
 @XmlRootElement
 @Entity
+@Cacheable
 public class OAuthPermission implements Serializable {
     private static final long serialVersionUID = -6486616235830491290L;
     private List<String> httpVerbs = new LinkedList<String>();
@@ -45,20 +50,29 @@ public class OAuthPermission implements Serializable {
     private String description;
     private boolean isDefaultPermission;
     private boolean invisibleToClient;
-    
     public OAuthPermission() {
-        
+
     }
-    
+
     public OAuthPermission(String permission) {
         this.permission = permission;
     }
-    
+
     public OAuthPermission(String permission, String description) {
         this.description = description;
         this.permission = permission;
     }
-    
+
+    /**
+     * Gets the optional list of HTTP verbs
+     * @return the list of HTTP verbs
+     */
+    @ElementCollection(fetch = FetchType.EAGER)
+    @OrderColumn
+    public List<String> getHttpVerbs() {
+        return httpVerbs;
+    }
+
     /**
      * Sets the optional list of HTTP verbs, example,
      * "GET" and "POST", etc
@@ -69,12 +83,13 @@ public class OAuthPermission implements Serializable {
     }
 
     /**
-     * Gets the optional list of HTTP verbs
-     * @return the list of HTTP verbs
+     * Gets the optional list of relative request URIs
+     * @return the list of URIs
      */
-    @ElementCollection
-    public List<String> getHttpVerbs() {
-        return httpVerbs;
+    @ElementCollection(fetch = FetchType.EAGER)
+    @OrderColumn
+    public List<String> getUris() {
+        return uris;
     }
 
     /**
@@ -85,14 +100,6 @@ public class OAuthPermission implements Serializable {
         this.uris = uri;
     }
 
-    /**
-     * Gets the optional list of relative request URIs
-     * @return the list of URIs
-     */
-    @ElementCollection
-    public List<String> getUris() {
-        return uris;
-    }
     
     /**
      * Gets the permission description
@@ -164,7 +171,6 @@ public class OAuthPermission implements Serializable {
     public void setInvisibleToClient(boolean invisibleToClient) {
         this.invisibleToClient = invisibleToClient;
     }
-    
     @Override
     public boolean equals(Object object) {
         if (!(object instanceof OAuthPermission)) {
@@ -197,7 +203,6 @@ public class OAuthPermission implements Serializable {
         
         return true;
     }
-    
     @Override
     public int hashCode() {
         int hashCode = 17;
diff --git a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/ServerAccessToken.java b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/ServerAccessToken.java
index e3b8b0573b..f758aedca4 100644
--- a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/ServerAccessToken.java
+++ b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/ServerAccessToken.java
@@ -24,10 +24,12 @@ import java.util.List;
 import java.util.Map;
 
 import javax.persistence.ElementCollection;
+import javax.persistence.FetchType;
 import javax.persistence.ManyToMany;
 import javax.persistence.ManyToOne;
 import javax.persistence.MapKeyColumn;
 import javax.persistence.MappedSuperclass;
+import javax.persistence.OrderColumn;
 
 import org.apache.cxf.rs.security.oauth2.provider.OAuthServiceException;
 import org.apache.cxf.rs.security.oauth2.utils.OAuthConstants;
@@ -40,7 +42,7 @@ import org.apache.cxf.rs.security.oauth2.utils.OAuthUtils;
 @MappedSuperclass
 public abstract class ServerAccessToken extends AccessToken {
     private static final long serialVersionUID = 638776204861456064L;
-    
+
     private String grantType;
     private Client client;
     private List<OAuthPermission> scopes = new LinkedList<OAuthPermission>();
@@ -51,34 +53,34 @@ public abstract class ServerAccessToken extends AccessToken {
     private String responseType;
     private String grantCode;
     private Map<String, String> extraProperties = new LinkedHashMap<String, String>();
-    
+
     protected ServerAccessToken() {
-        
+
     }
-    
-    protected ServerAccessToken(Client client, 
-                                        String tokenType,
-                                        String tokenKey,
-                                        long expiresIn) {
+
+    protected ServerAccessToken(Client client,
+                                String tokenType,
+                                String tokenKey,
+                                long expiresIn) {
         this(client, tokenType, tokenKey, expiresIn, OAuthUtils.getIssuedAt());
     }
-    
-    protected ServerAccessToken(Client client, 
+
+    protected ServerAccessToken(Client client,
                                 String tokenType,
                                 String tokenKey,
-                                long expiresIn, 
+                                long expiresIn,
                                 long issuedAt) {
         super(tokenType, tokenKey, expiresIn, issuedAt);
         this.client = client;
     }
-    
-    protected ServerAccessToken(ServerAccessToken token, String key) {    
-        super(token.getTokenType(), 
-             key, 
-             token.getExpiresIn(), 
-             token.getIssuedAt(),
-             token.getRefreshToken(),
-             token.getParameters());
+
+    protected ServerAccessToken(ServerAccessToken token, String key) {
+        super(token.getTokenType(),
+                key,
+                token.getExpiresIn(),
+                token.getIssuedAt(),
+                token.getRefreshToken(),
+                token.getParameters());
         this.client = token.getClient();
         this.grantType = token.getGrantType();
         this.scopes = token.getScopes();
@@ -90,6 +92,13 @@ public abstract class ServerAccessToken extends AccessToken {
         this.grantCode = token.getGrantCode();
     }
 
+    protected static ServerAccessToken validateTokenType(ServerAccessToken token, String expectedType) {
+        if (!token.getTokenType().equals(expectedType)) {
+            throw new OAuthServiceException(OAuthConstants.SERVER_ERROR);
+        }
+        return token;
+    }
+
     /**
      * Returns the Client associated with this token
      * @return the client
@@ -102,12 +111,12 @@ public abstract class ServerAccessToken extends AccessToken {
     public void setClient(Client c) {
         this.client = c;
     }
-    
+
     /**
      * Returns a list of opaque permissions/scopes
      * @return the scopes
      */
-    @ManyToMany
+    @ManyToMany(fetch = FetchType.EAGER)
     public List<OAuthPermission> getScopes() {
         return scopes;
     }
@@ -119,16 +128,6 @@ public abstract class ServerAccessToken extends AccessToken {
     public void setScopes(List<OAuthPermission> scopes) {
         this.scopes = scopes;
     }
-    
-    /**
-     * Sets a subject capturing the login name 
-     * the end user used to login to the resource server
-     * when authorizing a given client request
-     * @param subject
-     */
-    public void setSubject(UserSubject subject) {
-        this.subject = subject;
-    }
 
     /**
      * Returns a subject capturing the login name 
@@ -142,11 +141,13 @@ public abstract class ServerAccessToken extends AccessToken {
     }
 
     /**
-     * Sets the grant type which was used to obtain the access token
-     * @param grantType the grant type
+     * Sets a subject capturing the login name
+     * the end user used to login to the resource server
+     * when authorizing a given client request
+     * @param subject
      */
-    public void setGrantType(String grantType) {
-        this.grantType = grantType;
+    public void setSubject(UserSubject subject) {
+        this.subject = subject;
     }
 
     /**
@@ -156,13 +157,13 @@ public abstract class ServerAccessToken extends AccessToken {
     public String getGrantType() {
         return grantType;
     }
-    
+
     /**
-     * Set the response type
-     * @param responseType the response type
+     * Sets the grant type which was used to obtain the access token
+     * @param grantType the grant type
      */
-    public void setResponseType(String responseType) {
-        this.responseType = responseType;
+    public void setGrantType(String grantType) {
+        this.grantType = grantType;
     }
 
     /**
@@ -172,8 +173,17 @@ public abstract class ServerAccessToken extends AccessToken {
     public String getResponseType() {
         return responseType;
     }
-    
-    @ElementCollection
+
+    /**
+     * Set the response type
+     * @param responseType the response type
+     */
+    public void setResponseType(String responseType) {
+        this.responseType = responseType;
+    }
+
+    @ElementCollection(fetch = FetchType.EAGER)
+    @OrderColumn
     public List<String> getAudiences() {
         return audiences;
     }
@@ -181,14 +191,7 @@ public abstract class ServerAccessToken extends AccessToken {
     public void setAudiences(List<String> audiences) {
         this.audiences = audiences;
     }
-    
-    protected static ServerAccessToken validateTokenType(ServerAccessToken token, String expectedType) {
-        if (!token.getTokenType().equals(expectedType)) {
-            throw new OAuthServiceException(OAuthConstants.SERVER_ERROR);
-        }
-        return token;
-    }
-    
+
     public String getClientCodeVerifier() {
         return clientCodeVerifier;
     }
@@ -205,7 +208,7 @@ public abstract class ServerAccessToken extends AccessToken {
         this.nonce = nonce;
     }
 
-    @ElementCollection
+    @ElementCollection(fetch = FetchType.EAGER)
     @MapKeyColumn(name = "extraPropName")
     public Map<String, String> getExtraProperties() {
         return extraProperties;
@@ -214,13 +217,6 @@ public abstract class ServerAccessToken extends AccessToken {
     public void setExtraProperties(Map<String, String> extraProperties) {
         this.extraProperties = extraProperties;
     }
-    /**
-     * Set the grant code which was used to request the token
-     * @param grantCode the grant code
-     */
-    public void setGrantCode(String grantCode) {
-        this.grantCode = grantCode;
-    }
 
     /**
      * Get the grant code
@@ -229,4 +225,12 @@ public abstract class ServerAccessToken extends AccessToken {
     public String getGrantCode() {
         return grantCode;
     }
+
+    /**
+     * Set the grant code which was used to request the token
+     * @param grantCode the grant code
+     */
+    public void setGrantCode(String grantCode) {
+        this.grantCode = grantCode;
+    }
 }
diff --git a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/UserSubject.java b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/UserSubject.java
index 8bd9571c95..8d27148944 100644
--- a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/UserSubject.java
+++ b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/common/UserSubject.java
@@ -26,8 +26,10 @@ import java.util.Map;
 
 import javax.persistence.ElementCollection;
 import javax.persistence.Entity;
+import javax.persistence.FetchType;
 import javax.persistence.Id;
 import javax.persistence.MapKeyColumn;
+import javax.persistence.OrderColumn;
 import javax.xml.bind.annotation.XmlRootElement;
 
 /**
@@ -37,56 +39,59 @@ import javax.xml.bind.annotation.XmlRootElement;
 @XmlRootElement
 @Entity
 public class UserSubject implements Serializable {
-    
+
     private static final long serialVersionUID = -1469694589163385689L;
-    
+
     private String login;
     private String id;
     private List<String> roles = new LinkedList<String>();
     private Map<String, String> properties = new HashMap<String, String>();
     private AuthenticationMethod am;
+
     public UserSubject() {
-        
+
     }
-    
+
     public UserSubject(String login) {
         this.login = login;
     }
-    
+
     public UserSubject(String login, List<String> roles) {
         this.login = login;
         this.roles = roles;
     }
-    
-    public UserSubject(String login, String id) { 
+
+    public UserSubject(String login, String id) {
         this.login = login;
         this.id = id;
     }
-    
+
     public UserSubject(String login, String id, List<String> roles) {
         this.login = login;
         this.id = id;
         this.roles = roles;
     }
-    
+
     public UserSubject(UserSubject sub) {
         this(sub.getLogin(), sub.getId(), sub.getRoles());
         this.properties = sub.getProperties();
         this.am = sub.getAuthenticationMethod();
-        
+
     }
-    
+
     /**
      * Return the user login name
+     *
      * @return the login name
      */
     @Id
     public String getLogin() {
         return login;
     }
-    
+
     /**
      * Set the user login name
+     *
      * @param login the login name
      */
     public void setLogin(String login) {
@@ -94,18 +99,21 @@ public class UserSubject implements Serializable {
     }
 
     /**
-     * Return the optional list of user roles which may have 
-     * been captured during the authentication process 
+     * Return the optional list of user roles which may have
+     * been captured during the authentication process
+     *
      * @return the list of roles
      */
-    @ElementCollection
+    @ElementCollection(fetch = FetchType.EAGER)
+    @OrderColumn
     public List<String> getRoles() {
         return roles;
     }
-    
+
     /**
-     * Set the optional list of user roles which may have 
-     * been captured during the authentication process 
+     * Set the optional list of user roles which may have
+     * been captured during the authentication process
+     *
      * @param roles the list of roles
      */
     public void setRoles(List<String> roles) {
@@ -114,9 +122,10 @@ public class UserSubject implements Serializable {
 
     /**
      * Get the list of additional user subject properties
+     *
      * @return the list of properties
      */
-    @ElementCollection
+    @ElementCollection(fetch = FetchType.EAGER)
     @MapKeyColumn(name = "name")
     public Map<String, String> getProperties() {
         return properties;
@@ -124,22 +133,25 @@ public class UserSubject implements Serializable {
 
     /**
      * Set the list of additional user subject properties
+     *
      * @param properties the properties
      */
     public void setProperties(Map<String, String> properties) {
         this.properties = properties;
     }
-    
+
     /**
      * Get the user's unique id
+     *
      * @return the user's id
-    */
+     */
     public String getId() {
         return this.id;
     }
-    
+
     /**
      * Set the users unique id
+     *
      * @param id the user's id
      */
     public void setId(String id) {
@@ -153,5 +165,5 @@ public class UserSubject implements Serializable {
     public void setAuthenticationMethod(AuthenticationMethod method) {
         this.am = method;
     }
-    
+
 }
diff --git a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProvider.java b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProvider.java
new file mode 100644
index 0000000000..5eaa39abeb
--- /dev/null
+++ b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProvider.java
@@ -0,0 +1,63 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements. See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership. The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License. You may obtain a copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied. See the License for the
+ * specific language governing permissions and limitations
+ * under the License.
+ */
+package org.apache.cxf.rs.security.oauth2.grants.code;
+
+import javax.persistence.EntityManager;
+import javax.persistence.EntityTransaction;
+import javax.persistence.PersistenceContext;
+
+public class JPACMTCodeDataProvider extends JPACodeDataProvider {
+
+    @PersistenceContext
+    private EntityManager entityManager;
+
+    /**
+     * Returns the entityManaged used for the current operation.
+     */
+    @Override
+    protected EntityManager getEntityManager() {
+        return this.entityManager;
+    }
+
+    public void setEntityManager(EntityManager entityManager) {
+        this.entityManager = entityManager;
+    }
+
+    /**
+     * Doesn't do anything, beginning tx is handled by container.
+     */
+    @Override
+    protected EntityTransaction beginIfNeeded(EntityManager em) {
+        return null;
+    }
+
+    /**
+     * Doesn't do anything, commit is handled by container.
+     */
+    @Override
+    protected void commitIfNeeded(EntityManager em) {
+    }
+
+    /**
+     * Doesn't do anything, em lifecycle is handled by container.
+     */
+    @Override
+    protected void closeIfNeeded(EntityManager em) {
+    }
+}
diff --git a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACodeDataProvider.java b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACodeDataProvider.java
index 9893b2e74d..84bfb8e9e8 100644
--- a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACodeDataProvider.java
+++ b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACodeDataProvider.java
@@ -20,6 +20,8 @@ package org.apache.cxf.rs.security.oauth2.grants.code;
 
 import java.util.List;
 
+import javax.persistence.EntityManager;
+import javax.persistence.EntityNotFoundException;
 import javax.persistence.TypedQuery;
 
 import org.apache.cxf.rs.security.oauth2.common.Client;
@@ -28,83 +30,140 @@ import org.apache.cxf.rs.security.oauth2.provider.JPAOAuthDataProvider;
 import org.apache.cxf.rs.security.oauth2.provider.OAuthServiceException;
 
 public class JPACodeDataProvider extends JPAOAuthDataProvider implements AuthorizationCodeDataProvider {
-    private static final String CODE_TABLE_NAME = ServerAuthorizationCodeGrant.class.getSimpleName();
     private long codeLifetime = 10 * 60;
+
     @Override
     public ServerAuthorizationCodeGrant createCodeGrant(AuthorizationCodeRegistration reg)
-        throws OAuthServiceException {
+            throws OAuthServiceException {
         ServerAuthorizationCodeGrant grant = doCreateCodeGrant(reg);
         saveCodeGrant(grant);
         return grant;
     }
-    
+
     protected ServerAuthorizationCodeGrant doCreateCodeGrant(AuthorizationCodeRegistration reg)
-        throws OAuthServiceException {
+            throws OAuthServiceException {
         return AbstractCodeDataProvider.initCodeGrant(reg, codeLifetime);
     }
 
-    protected void saveCodeGrant(ServerAuthorizationCodeGrant grant) { 
-        getEntityManager().getTransaction().begin();
-        if (grant.getSubject() != null) {
-            UserSubject sub = getEntityManager().find(UserSubject.class, grant.getSubject().getLogin());
-            if (sub == null) {
-                getEntityManager().persist(grant.getSubject());
-            } else {
-                sub = getEntityManager().merge(grant.getSubject());
-                grant.setSubject(sub);
+    protected void saveCodeGrant(final ServerAuthorizationCodeGrant grant) {
+        executeInTransaction(new EntityManagerOperation<Void>() {
+            @Override
+            public Void execute(EntityManager em) {
+                if (grant.getSubject() != null) {
+                    UserSubject sub = em.find(UserSubject.class, grant.getSubject().getLogin());
+                    if (sub == null) {
+                        em.persist(grant.getSubject());
+                    } else {
+                        sub = em.merge(grant.getSubject());
+                        grant.setSubject(sub);
+                    }
+                }
+                // ensure we have a managed association
+                // (needed for OpenJPA : InvalidStateException: Encountered unmanaged object)
+                if (grant.getClient() != null) {
+                    grant.setClient(em.find(Client.class, grant.getClient().getClientId()));
+                }
+                em.persist(grant);
+                return null;
             }
-        }
-        getEntityManager().persist(grant);
-        getEntityManager().getTransaction().commit();
+        });
     }
-    
+
     @Override
-    protected void doRemoveClient(Client c) {
-        removeClientCodeGrants(c);
-        super.doRemoveClient(c);
+    protected void doRemoveClient(final Client c) {
+        executeInTransaction(new EntityManagerOperation<Void>() {
+            @Override
+            public Void execute(EntityManager em) {
+                removeClientCodeGrants(c, em);
+                Client clientToRemove = em.getReference(Client.class, c.getClientId());
+                em.remove(clientToRemove);
+                return null;
+            }
+        });
     }
-    
-    protected void removeClientCodeGrants(Client c) {
-        for (ServerAuthorizationCodeGrant grant : getCodeGrants(c, null)) {
-            removeCodeGrant(grant.getCode());
+
+    protected void removeClientCodeGrants(final Client c) {
+        executeInTransaction(new EntityManagerOperation<Void>() {
+            @Override
+            public Void execute(EntityManager em) {
+                removeClientCodeGrants(c, em);
+                return null;
+            }
+        });
+    }
+
+    protected void removeClientCodeGrants(final Client c, EntityManager em) {
+        for (ServerAuthorizationCodeGrant grant : getCodeGrants(c, null, em)) {
+            removeCodeGrant(grant.getCode(), em);
         }
     }
-    
+
     @Override
-    public ServerAuthorizationCodeGrant removeCodeGrant(String code) throws OAuthServiceException {
-        ServerAuthorizationCodeGrant grant = getEntityManager().find(ServerAuthorizationCodeGrant.class, code);
-        if (grant != null) {
-            removeEntity(grant);
-        } 
+    public ServerAuthorizationCodeGrant removeCodeGrant(final String code) throws OAuthServiceException {
+        return executeInTransaction(new EntityManagerOperation<ServerAuthorizationCodeGrant>() {
+            @Override
+            public ServerAuthorizationCodeGrant execute(EntityManager em) {
+                return removeCodeGrant(code, em);
+            }
+        });
+    }
+
+    private ServerAuthorizationCodeGrant removeCodeGrant(String code, EntityManager em) throws OAuthServiceException {
+        ServerAuthorizationCodeGrant grant = em.getReference(ServerAuthorizationCodeGrant.class, code);
+        try {
+            em.remove(grant);
+        } catch (EntityNotFoundException e) {
+        }
         return grant;
     }
 
     @Override
-    public List<ServerAuthorizationCodeGrant> getCodeGrants(Client c, UserSubject subject)
-        throws OAuthServiceException {
-        return getCodesQuery(c, subject).getResultList();
+    public List<ServerAuthorizationCodeGrant> getCodeGrants(final Client c, final UserSubject subject)
+            throws OAuthServiceException {
+        return execute(new EntityManagerOperation<List<ServerAuthorizationCodeGrant>>() {
+            @Override
+            public List<ServerAuthorizationCodeGrant> execute(EntityManager em) {
+                return getCodeGrants(c, subject, em);
+            }
+        });
     }
+
+    private List<ServerAuthorizationCodeGrant> getCodeGrants(final Client c, final UserSubject subject,
+                                                             EntityManager em)
+            throws OAuthServiceException {
+        return getCodesQuery(c, subject, em).getResultList();
+    }
+
     public void setCodeLifetime(long codeLifetime) {
         this.codeLifetime = codeLifetime;
     }
-    protected TypedQuery<ServerAuthorizationCodeGrant> getCodesQuery(Client c, UserSubject resourceOwnerSubject) {
+
+    protected TypedQuery<ServerAuthorizationCodeGrant> getCodesQuery(Client c, UserSubject resourceOwnerSubject,
+                                                                     EntityManager em) {
         if (c == null && resourceOwnerSubject == null) {
-            return getEntityManager().createQuery("SELECT c FROM " + CODE_TABLE_NAME + " c", 
-                                             ServerAuthorizationCodeGrant.class);
+            return em.createQuery("SELECT c FROM ServerAuthorizationCodeGrant c",
+                    ServerAuthorizationCodeGrant.class);
         } else if (c == null) {
-            return getEntityManager().createQuery(
-                "SELECT c FROM " + CODE_TABLE_NAME + " c JOIN c.subject s WHERE s.login = '" 
-                + resourceOwnerSubject.getLogin() + "'", ServerAuthorizationCodeGrant.class);
+            return em.createQuery(
+                    "SELECT c FROM ServerAuthorizationCodeGrant"
+                            + " c JOIN c.subject s"
+                            + " WHERE s.login = :login", ServerAuthorizationCodeGrant.class)
+                    .setParameter("login", resourceOwnerSubject.getLogin());
         } else if (resourceOwnerSubject == null) {
-            return getEntityManager().createQuery(
-                "SELECT code FROM " + CODE_TABLE_NAME + " code JOIN code.client c WHERE c.clientId = '" 
-                    + c.getClientId() + "'", ServerAuthorizationCodeGrant.class);
+            return em.createQuery(
+                    "SELECT code FROM ServerAuthorizationCodeGrant code"
+                            + " JOIN code.client c"
+                            + " WHERE c.clientId = :clientId", ServerAuthorizationCodeGrant.class)
+                    .setParameter("clientId", c.getClientId());
         } else {
-            return getEntityManager().createQuery(
-                "SELECT code FROM " + CODE_TABLE_NAME 
-                + " code JOIN code.subject s JOIN code.client c WHERE s.login = '" 
-                + resourceOwnerSubject.getLogin() + "' AND c.clientId = '" + c.getClientId() + "'",
-                ServerAuthorizationCodeGrant.class);
+            return em.createQuery(
+                    "SELECT code FROM ServerAuthorizationCodeGrant code"
+                            + " JOIN code.subject s"
+                            + " JOIN code.client c"
+                            + " WHERE s.login = :login"
+                            + " AND c.clientId = :clientId", ServerAuthorizationCodeGrant.class)
+                    .setParameter("clientId", c.getClientId())
+                    .setParameter("login", resourceOwnerSubject.getLogin());
         }
     }
 }
diff --git a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/grants/code/ServerAuthorizationCodeGrant.java b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/grants/code/ServerAuthorizationCodeGrant.java
index 932d690ef2..3ad5b36da7 100644
--- a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/grants/code/ServerAuthorizationCodeGrant.java
+++ b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/grants/code/ServerAuthorizationCodeGrant.java
@@ -25,8 +25,10 @@ import java.util.Map;
 
 import javax.persistence.ElementCollection;
 import javax.persistence.Entity;
+import javax.persistence.FetchType;
 import javax.persistence.ManyToOne;
 import javax.persistence.MapKeyColumn;
+import javax.persistence.OrderColumn;
 
 import org.apache.cxf.rs.security.oauth2.common.Client;
 import org.apache.cxf.rs.security.oauth2.common.UserSubject;
@@ -39,7 +41,7 @@ import org.apache.cxf.rs.security.oauth2.utils.OAuthUtils;
 @Entity
 public class ServerAuthorizationCodeGrant extends AuthorizationCodeGrant {
     private static final long serialVersionUID = -5004608901535459036L;
-    
+
     private long issuedAt;
     private long expiresIn;
     private Client client;
@@ -52,21 +54,21 @@ public class ServerAuthorizationCodeGrant extends AuthorizationCodeGrant {
     private String nonce;
     private boolean preauthorizedTokenAvailable;
     private Map<String, String> extraProperties = new LinkedHashMap<String, String>();
-    
+
     public ServerAuthorizationCodeGrant() {
-        
+
     }
-    
-    public ServerAuthorizationCodeGrant(Client client, 
+
+    public ServerAuthorizationCodeGrant(Client client,
                                         long lifetime) {
         this(client, OAuthUtils.generateRandomTokenKey(), lifetime,
-             OAuthUtils.getIssuedAt());
+                OAuthUtils.getIssuedAt());
     }
-    
-    public ServerAuthorizationCodeGrant(Client client, 
-                                  String code,
-                                  long expiresIn, 
-                                  long issuedAt) {
+
+    public ServerAuthorizationCodeGrant(Client client,
+                                        String code,
+                                        long expiresIn,
+                                        long issuedAt) {
         super(code);
         this.client = client;
         this.expiresIn = expiresIn;
@@ -80,7 +82,7 @@ public class ServerAuthorizationCodeGrant extends AuthorizationCodeGrant {
     public long getIssuedAt() {
         return issuedAt;
     }
-    
+
     public void setIssuedAt(long issuedAt) {
         this.issuedAt = issuedAt;
     }
@@ -92,7 +94,7 @@ public class ServerAuthorizationCodeGrant extends AuthorizationCodeGrant {
     public long getExpiresIn() {
         return expiresIn;
     }
-    
+
     public void setExpiresIn(long expiresIn) {
         this.expiresIn = expiresIn;
     }
@@ -109,35 +111,27 @@ public class ServerAuthorizationCodeGrant extends AuthorizationCodeGrant {
     public void setClient(Client c) {
         this.client = c;
     }
-    
-    /**
-     * Sets the scopes explicitly approved by the end user.
-     * If this list is empty then the end user had no way to down-scope. 
-     * @param approvedScope the approved scopes
-     */
-    
-    public void setApprovedScopes(List<String> scopes) {
-        this.approvedScopes = scopes;
-    }
 
     /**
      * Gets the scopes explicitly approved by the end user
      * @return the approved scopes
      */
-    @ElementCollection
+    @ElementCollection(fetch = FetchType.EAGER)
+    @OrderColumn
     public List<String> getApprovedScopes() {
         return approvedScopes;
     }
 
-
     /**
-     * Sets the user subject representing the end user
-     * @param subject the subject
+     * Sets the scopes explicitly approved by the end user.
+     * If this list is empty then the end user had no way to down-scope.
+     * @param scopes the approved scopes
      */
-    public void setSubject(UserSubject subject) {
-        this.subject = subject;
+
+    public void setApprovedScopes(List<String> scopes) {
+        this.approvedScopes = scopes;
     }
-    
+
     /**
      * Gets the user subject representing the end user
      * @return the subject
@@ -147,6 +141,14 @@ public class ServerAuthorizationCodeGrant extends AuthorizationCodeGrant {
         return subject;
     }
 
+    /**
+     * Sets the user subject representing the end user
+     * @param subject the subject
+     */
+    public void setSubject(UserSubject subject) {
+        this.subject = subject;
+    }
+
     public String getAudience() {
         return audience;
     }
@@ -163,7 +165,8 @@ public class ServerAuthorizationCodeGrant extends AuthorizationCodeGrant {
         this.clientCodeChallenge = clientCodeChallenge;
     }
 
-    @ElementCollection
+    @ElementCollection(fetch = FetchType.EAGER)
+    @OrderColumn
     public List<String> getRequestedScopes() {
         return requestedScopes;
     }
@@ -188,7 +191,7 @@ public class ServerAuthorizationCodeGrant extends AuthorizationCodeGrant {
         this.preauthorizedTokenAvailable = preauthorizedTokenAvailable;
     }
 
-    @ElementCollection
+    @ElementCollection(fetch = FetchType.EAGER)
     @MapKeyColumn(name = "extraPropName")
     public Map<String, String> getExtraProperties() {
         return extraProperties;
diff --git a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/provider/JPAOAuthDataProvider.java b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/provider/JPAOAuthDataProvider.java
index bdce24b8c6..209088c2f7 100644
--- a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/provider/JPAOAuthDataProvider.java
+++ b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/provider/JPAOAuthDataProvider.java
@@ -18,13 +18,17 @@
  */
 package org.apache.cxf.rs.security.oauth2.provider;
 
+import java.util.ArrayList;
+import java.util.HashMap;
 import java.util.LinkedList;
 import java.util.List;
-
 import javax.persistence.EntityManager;
+import javax.persistence.EntityManagerFactory;
+import javax.persistence.EntityTransaction;
 import javax.persistence.TypedQuery;
 
 import org.apache.cxf.helpers.CastUtils;
+import org.apache.cxf.rs.security.oauth2.common.AccessTokenRegistration;
 import org.apache.cxf.rs.security.oauth2.common.Client;
 import org.apache.cxf.rs.security.oauth2.common.OAuthPermission;
 import org.apache.cxf.rs.security.oauth2.common.ServerAccessToken;
@@ -32,165 +36,385 @@ import org.apache.cxf.rs.security.oauth2.common.UserSubject;
 import org.apache.cxf.rs.security.oauth2.tokens.bearer.BearerAccessToken;
 import org.apache.cxf.rs.security.oauth2.tokens.refresh.RefreshToken;
 
+/**
+ * Provides a Jpa BMT implementation for OAuthDataProvider.
+ *
+ * If your application runs in a container and if you want to use
+ * container managed persistence, you'll have to override
+ * the following methods :
+ * <ul>
+ *     <li> {@link #getEntityManager()}</li>
+ *     <li> {@link #commitIfNeeded(EntityManager)}</li>
+ *     <li> {@link #closeIfNeeded(EntityManager)}</li>
+ * </ul>
+ */
 public class JPAOAuthDataProvider extends AbstractOAuthDataProvider {
-    private static final String CLIENT_TABLE_NAME = Client.class.getSimpleName();
-    private static final String BEARER_TOKEN_TABLE_NAME = BearerAccessToken.class.getSimpleName();
-    private static final String REFRESH_TOKEN_TABLE_NAME = RefreshToken.class.getSimpleName();
-    private EntityManager entityManager;
-    
-    public JPAOAuthDataProvider() {
-    }
-    
+    private static final String CLIENT_QUERY = "SELECT client FROM Client client"
+            + " INNER JOIN client.resourceOwnerSubject ros";
+
+    private EntityManagerFactory entityManagerFactory;
+
+    public void setEntityManagerFactory(EntityManagerFactory emf) {
+        this.entityManagerFactory = emf;
+    }
+
     @Override
-    public Client getClient(String clientId) throws OAuthServiceException {
-        return getEntityManager().find(Client.class, clientId);
-    }
-    
-    public void setClient(Client client) {
-        getEntityManager().getTransaction().begin();
-        if (client.getResourceOwnerSubject() != null) {
-            UserSubject sub = getEntityManager().find(UserSubject.class, client.getResourceOwnerSubject().getLogin());
-            if (sub == null) {
-                getEntityManager().persist(client.getResourceOwnerSubject());
-            } else {
-                client.setResourceOwnerSubject(sub);
+    public Client getClient(final String clientId) throws OAuthServiceException {
+        return execute(new EntityManagerOperation<Client>() {
+            @Override
+            public Client execute(EntityManager em) {
+                return em.find(Client.class, clientId);
             }
+        });
+    }
+
+    protected <T> T execute(EntityManagerOperation<T> operation) {
+        EntityManager em = getEntityManager();
+        T value;
+        try {
+            value = operation.execute(em);
+        } finally {
+            closeIfNeeded(em);
+        }
+        return value;
+    }
+
+    protected <T> T executeInTransaction(EntityManagerOperation<T> operation) {
+        EntityManager em = getEntityManager();
+        EntityTransaction transaction = null;
+        T value;
+        try {
+            transaction = beginIfNeeded(em);
+            value = operation.execute(em);
+            flushIfNeeded(em);
+            commitIfNeeded(em);
+        } catch (RuntimeException e) {
+            if (transaction != null) {
+                transaction.rollback();
+            }
+            throw e;
+        } finally {
+            closeIfNeeded(em);
         }
-        getEntityManager().persist(client);
-        getEntityManager().getTransaction().commit();
+        return value;
+    }
+
+    public void setClient(final Client client) {
+        executeInTransaction(new EntityManagerOperation<Void>() {
+            @Override
+            public Void execute(EntityManager em) {
+                if (client.getResourceOwnerSubject() != null) {
+                    UserSubject sub =
+                            em.find(UserSubject.class, client.getResourceOwnerSubject().getLogin());
+                    if (sub == null) {
+                        em.persist(client.getResourceOwnerSubject());
+                    } else {
+                        client.setResourceOwnerSubject(sub);
+                    }
+                }
+                boolean clientExists = em.createQuery("SELECT count(client) from Client client "
+                                + "where client.clientId = :id",
+                        Long.class)
+                        .setParameter("id", client.getClientId())
+                        .getSingleResult() > 0 ? true : false;
+                if (clientExists) {
+                    em.merge(client);
+                } else {
+                    em.persist(client);
+                }
+                return null;
+            }
+        });
     }
-    
+
     @Override
-    protected void doRemoveClient(Client c) {
-        removeEntity(c);
+    protected void doRemoveClient(final Client c) {
+        executeInTransaction(new EntityManagerOperation<Void>() {
+            @Override
+            public Void execute(EntityManager em) {
+                Client clientToRemove = em.getReference(Client.class, c.getClientId());
+                em.remove(clientToRemove);
+                return null;
+            }
+        });
     }
 
     @Override
-    public List<Client> getClients(UserSubject resourceOwner) {
-        return getClientsQuery(resourceOwner).getResultList();
+    public List<Client> getClients(final UserSubject resourceOwner) {
+        return execute(new EntityManagerOperation<List<Client>>() {
+            @Override
+            public List<Client> execute(EntityManager em) {
+                return getClientsQuery(resourceOwner, em).getResultList();
+            }
+        });
     }
 
     @Override
-    public List<ServerAccessToken> getAccessTokens(Client c, UserSubject sub) {
-        return CastUtils.cast(getTokensQuery(c, sub).getResultList());
+    public List<ServerAccessToken> getAccessTokens(final Client c, final UserSubject sub) {
+        return execute(new EntityManagerOperation<List<ServerAccessToken>>() {
+            @Override
+            public List<ServerAccessToken> execute(EntityManager em) {
+                return CastUtils.cast(getTokensQuery(c, sub, em).getResultList());
+            }
+        });
     }
 
     @Override
-    public List<RefreshToken> getRefreshTokens(Client c, UserSubject sub) {
-        return getRefreshTokensQuery(c, sub).getResultList();
+    public List<RefreshToken> getRefreshTokens(final Client c, final UserSubject sub) {
+        return execute(new EntityManagerOperation<List<RefreshToken>>() {
+            @Override
+            public List<RefreshToken> execute(EntityManager em) {
+                return getRefreshTokensQuery(c, sub, em).getResultList();
+            }
+        });
     }
-    
+
     @Override
-    public ServerAccessToken getAccessToken(String accessToken) throws OAuthServiceException {
-        return getEntityManager().find(BearerAccessToken.class, accessToken);
+    public ServerAccessToken getAccessToken(final String accessToken) throws OAuthServiceException {
+        return execute(new EntityManagerOperation<ServerAccessToken>() {
+            @Override
+            public ServerAccessToken execute(EntityManager em) {
+                return em.find(BearerAccessToken.class, accessToken);
+            }
+        });
     }
+
     @Override
-    protected void doRevokeAccessToken(ServerAccessToken at) {
-        removeEntity(at);
+    protected void doRevokeAccessToken(final ServerAccessToken at) {
+        executeInTransaction(new EntityManagerOperation<Void>() {
+            @Override
+            public Void execute(EntityManager em) {
+                ServerAccessToken tokenToRemove = em.getReference(at.getClass(), at.getTokenKey());
+                em.remove(tokenToRemove);
+                return null;
+            }
+        });
     }
+
     @Override
-    protected RefreshToken getRefreshToken(String refreshTokenKey) { 
-        return getEntityManager().find(RefreshToken.class, refreshTokenKey);
+    protected void linkRefreshTokenToAccessToken(final RefreshToken rt, final ServerAccessToken at) {
+        super.linkRefreshTokenToAccessToken(rt, at);
+        executeInTransaction(new EntityManagerOperation<Void>() {
+            @Override
+            public Void execute(EntityManager em) {
+                em.merge(at);
+                return null;
+            }
+        });
     }
+
     @Override
-    protected void doRevokeRefreshToken(RefreshToken rt) { 
-        removeEntity(rt);
-    }
-    
-    protected void saveAccessToken(ServerAccessToken serverToken) {
-        getEntityManager().getTransaction().begin();
-        List<OAuthPermission> perms = new LinkedList<OAuthPermission>();
-        for (OAuthPermission perm : serverToken.getScopes()) {
-            OAuthPermission permSaved = getEntityManager().find(OAuthPermission.class, perm.getPermission());
-            if (permSaved != null) {
-                perms.add(permSaved);
-            } else {
-                getEntityManager().persist(perm);
-                perms.add(perm);
+    protected RefreshToken getRefreshToken(final String refreshTokenKey) {
+        return execute(new EntityManagerOperation<RefreshToken>() {
+            @Override
+            public RefreshToken execute(EntityManager em) {
+                return em.find(RefreshToken.class, refreshTokenKey);
             }
+        });
+    }
+
+    @Override
+    protected void doRevokeRefreshToken(final RefreshToken rt) {
+        executeInTransaction(new EntityManagerOperation<Void>() {
+            @Override
+            public Void execute(EntityManager em) {
+                RefreshToken tokentoRemove = em.getReference(RefreshToken.class, rt.getTokenKey());
+                em.remove(tokentoRemove);
+                return null;
+            }
+        });
+    }
+
+    @Override
+    protected ServerAccessToken doCreateAccessToken(AccessTokenRegistration atReg) {
+        ServerAccessToken at = super.doCreateAccessToken(atReg);
+        // we override this in order to get rid of elementCollections directly injected
+        // from another entity
+        // this can be the case when using multiple cmt dataProvider operation in a single entityManager
+        // lifespan
+        if (at.getAudiences() != null) {
+            at.setAudiences(new ArrayList<String>(at.getAudiences()));
         }
-        serverToken.setScopes(perms);
-        
-        UserSubject sub = getEntityManager().find(UserSubject.class, serverToken.getSubject().getLogin());
-        if (sub == null) {
-            getEntityManager().persist(serverToken.getSubject());
-        } else {
-            sub = getEntityManager().merge(serverToken.getSubject());
-            serverToken.setSubject(sub);
+        if (at.getExtraProperties() != null) {
+            at.setExtraProperties(new HashMap<String, String>(at.getExtraProperties()));
+        }
+        if (at.getScopes() != null) {
+            at.setScopes(new ArrayList<OAuthPermission>(at.getScopes()));
         }
-        
-        getEntityManager().persist(serverToken);
-        getEntityManager().getTransaction().commit();
+        if (at.getParameters() != null) {
+            at.setParameters(new HashMap<String, String>(at.getParameters()));
+        }
+        return at;
+    }
+
+    protected void saveAccessToken(final ServerAccessToken serverToken) {
+        executeInTransaction(new EntityManagerOperation<Void>() {
+            @Override
+            public Void execute(EntityManager em) {
+                List<OAuthPermission> perms = new LinkedList<OAuthPermission>();
+                for (OAuthPermission perm : serverToken.getScopes()) {
+                    OAuthPermission permSaved = em.find(OAuthPermission.class, perm.getPermission());
+                    if (permSaved != null) {
+                        perms.add(permSaved);
+                    } else {
+                        em.persist(perm);
+                        perms.add(perm);
+                    }
+                }
+                serverToken.setScopes(perms);
+
+                UserSubject sub = em.find(UserSubject.class, serverToken.getSubject().getLogin());
+                if (sub == null) {
+                    em.persist(serverToken.getSubject());
+                } else {
+                    sub = em.merge(serverToken.getSubject());
+                    serverToken.setSubject(sub);
+                }
+                // ensure we have a managed association
+                // (needed for OpenJPA : InvalidStateException: Encountered unmanaged object)
+                if (serverToken.getClient() != null) {
+                    serverToken.setClient(em.find(Client.class, serverToken.getClient().getClientId()));
+                }
+
+                em.persist(serverToken);
+                return null;
+            }
+        });
     }
-    
+
     protected void saveRefreshToken(RefreshToken refreshToken) {
         persistEntity(refreshToken);
     }
-    protected void persistEntity(Object entity) {
-        entityManager.getTransaction().begin();
-        entityManager.persist(entity);
-        entityManager.getTransaction().commit();
+
+    protected void persistEntity(final Object entity) {
+        executeInTransaction(new EntityManagerOperation<Void>() {
+            @Override
+            public Void execute(EntityManager em) {
+                em.persist(entity);
+                return null;
+            }
+        });
     }
-    protected void removeEntity(Object entity) {
-        entityManager.getTransaction().begin();
-        entityManager.remove(entity);
-        entityManager.getTransaction().commit();
+
+    protected void removeEntity(final Object entity) {
+        executeInTransaction(new EntityManagerOperation<Void>() {
+            @Override
+            public Void execute(EntityManager em) {
+                em.remove(entity);
+                return null;
+            }
+        });
     }
-    protected TypedQuery<Client> getClientsQuery(UserSubject resourceOwnerSubject) {
+
+    protected TypedQuery<Client> getClientsQuery(UserSubject resourceOwnerSubject, EntityManager entityManager) {
         if (resourceOwnerSubject == null) {
-            return entityManager.createQuery("SELECT c FROM " + CLIENT_TABLE_NAME + " c", Client.class);
+            return entityManager.createQuery(CLIENT_QUERY, Client.class);
         } else {
-            return entityManager.createQuery(
-                "SELECT c FROM " + CLIENT_TABLE_NAME + " c JOIN c.resourceOwnerSubject r WHERE r.login = '" 
-                + resourceOwnerSubject.getLogin() + "'", Client.class);
+            return entityManager.createQuery(CLIENT_QUERY + " WHERE ros.login = :login", Client.class).
+                    setParameter("login", resourceOwnerSubject.getLogin());
         }
     }
-    protected TypedQuery<BearerAccessToken> getTokensQuery(Client c, UserSubject resourceOwnerSubject) {
+
+    protected TypedQuery<BearerAccessToken> getTokensQuery(Client c, UserSubject resourceOwnerSubject,
+                                                           EntityManager entityManager) {
         if (c == null && resourceOwnerSubject == null) {
-            return entityManager.createQuery("SELECT t FROM " + BEARER_TOKEN_TABLE_NAME + " t", 
-                                             BearerAccessToken.class);
+            return entityManager.createQuery("SELECT t FROM BearerAccessToken t",
+                    BearerAccessToken.class);
         } else if (c == null) {
             return entityManager.createQuery(
-                "SELECT t FROM " + BEARER_TOKEN_TABLE_NAME + " t JOIN t.subject s WHERE s.login = '" 
-                + resourceOwnerSubject.getLogin() + "'", BearerAccessToken.class);
+                    "SELECT t FROM BearerAccessToken t"
+                            + " JOIN t.subject s"
+                            + " WHERE s.login = :login", BearerAccessToken.class)
+                    .setParameter("login", resourceOwnerSubject.getLogin());
         } else if (resourceOwnerSubject == null) {
             return entityManager.createQuery(
-                "SELECT t FROM " + BEARER_TOKEN_TABLE_NAME + " t JOIN t.client c WHERE c.clientId = '" 
-                    + c.getClientId() + "'", BearerAccessToken.class);
+                    "SELECT t FROM BearerAccessToken t"
+                            + " JOIN t.client c"
+                            + " WHERE c.clientId = :clientId", BearerAccessToken.class)
+                    .setParameter("clientId", c.getClientId());
         } else {
             return entityManager.createQuery(
-                "SELECT t FROM " + BEARER_TOKEN_TABLE_NAME + " t JOIN t.subject s JOIN t.client c WHERE s.login = '" 
-                + resourceOwnerSubject.getLogin() + "' AND c.clientId = '" + c.getClientId() + "'",
-                BearerAccessToken.class);
+                    "SELECT t FROM BearerAccessToken t"
+                            + " JOIN t.subject s"
+                            + " JOIN t.client c"
+                            + " WHERE s.login = :login AND c.clientId = :clientId", BearerAccessToken.class)
+                    .setParameter("login", resourceOwnerSubject.getLogin())
+                    .setParameter("clientId", c.getClientId());
         }
     }
-    protected TypedQuery<RefreshToken> getRefreshTokensQuery(Client c, UserSubject resourceOwnerSubject) {
+
+    protected TypedQuery<RefreshToken> getRefreshTokensQuery(Client c, UserSubject resourceOwnerSubject,
+                                                             EntityManager entityManager) {
         if (c == null && resourceOwnerSubject == null) {
-            return entityManager.createQuery("SELECT t FROM " + REFRESH_TOKEN_TABLE_NAME + " t", 
-                                             RefreshToken.class);
+            return entityManager.createQuery("SELECT t FROM RefreshToken t",
+                    RefreshToken.class);
         } else if (c == null) {
             return entityManager.createQuery(
-                "SELECT t FROM " + REFRESH_TOKEN_TABLE_NAME + " t JOIN t.subject s WHERE s.login = '" 
-                + resourceOwnerSubject.getLogin() + "'", RefreshToken.class);
+                    "SELECT t FROM RefreshToken t"
+                            + " JOIN t.subject s"
+                            + " WHERE s.login = :login", RefreshToken.class)
+                    .setParameter("login", resourceOwnerSubject.getLogin());
         } else if (resourceOwnerSubject == null) {
             return entityManager.createQuery(
-                "SELECT t FROM " + REFRESH_TOKEN_TABLE_NAME + " t JOIN t.client c WHERE c.clientId = '" 
-                    + c.getClientId() + "'", RefreshToken.class);
+                    "SELECT t FROM RefreshToken t"
+                            + " JOIN t.client c"
+                            + " WHERE c.clientId = :clientId", RefreshToken.class)
+                    .setParameter("clientId", c.getClientId());
         } else {
             return entityManager.createQuery(
-                "SELECT t FROM " + REFRESH_TOKEN_TABLE_NAME + " t JOIN t.subject s JOIN t.client c WHERE s.login = '" 
-                + resourceOwnerSubject.getLogin() + "' AND c.clientId = '" + c.getClientId() + "'",
-                RefreshToken.class);
+                    "SELECT t FROM RefreshToken t"
+                            + " JOIN t.subject s"
+                            + " JOIN t.client c"
+                            + " WHERE s.login = :login AND c.clientId = :clientId", RefreshToken.class)
+                    .setParameter("login", resourceOwnerSubject.getLogin())
+                    .setParameter("clientId", c.getClientId());
         }
     }
-    public void setEntityManager(EntityManager entityManager) {
-        this.entityManager = entityManager;
+
+    /**
+     * Returns the entityManaged used for the current operation.
+     */
+    protected EntityManager getEntityManager() {
+        return entityManagerFactory.createEntityManager();
     }
-    public EntityManager getEntityManager() {
-        return entityManager;
+
+    /**
+     * Begins the current transaction.
+     *
+     * This method needs to be overridden in a CMT environment.
+     */
+    protected EntityTransaction beginIfNeeded(EntityManager em) {
+        EntityTransaction tx = em.getTransaction();
+        tx.begin();
+        return tx;
     }
-    @Override
-    public void close() {
-        entityManager.close();
+
+    /**
+     * Flush the current transaction.
+     */
+    protected void flushIfNeeded(EntityManager em) {
+        em.flush();
+    }
+
+    /**
+     * Commits the current transaction.
+     *
+     * This method needs to be overridden in a CMT environment.
+     */
+    protected void commitIfNeeded(EntityManager em) {
+        em.getTransaction().commit();
+    }
+
+    /**
+     * Closes the current em.
+     *
+     * This method needs to be overriden in a CMT environment.
+     */
+    protected void closeIfNeeded(EntityManager em) {
+        em.close();
+    }
+
+    public interface EntityManagerOperation<T> {
+        T execute(EntityManager em);
     }
 }
diff --git a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/tokens/refresh/RefreshToken.java b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/tokens/refresh/RefreshToken.java
index da937b8799..4eedea26b4 100644
--- a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/tokens/refresh/RefreshToken.java
+++ b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/tokens/refresh/RefreshToken.java
@@ -23,6 +23,8 @@ import java.util.List;
 
 import javax.persistence.ElementCollection;
 import javax.persistence.Entity;
+import javax.persistence.FetchType;
+import javax.persistence.OrderColumn;
 
 import org.apache.cxf.rs.security.oauth2.common.Client;
 import org.apache.cxf.rs.security.oauth2.common.ServerAccessToken;
@@ -34,28 +36,28 @@ import org.apache.cxf.rs.security.oauth2.utils.OAuthUtils;
  */
 @Entity
 public class RefreshToken extends ServerAccessToken {
-    
+
     private static final long serialVersionUID = 2837120382251693874L;
     private List<String> accessTokens = new LinkedList<String>();
-    
-    public RefreshToken(Client client, 
+
+    public RefreshToken(Client client,
                         long lifetime) {
-        super(client, 
-              OAuthConstants.REFRESH_TOKEN_TYPE, 
-              OAuthUtils.generateRandomTokenKey(), 
-              lifetime, 
-              OAuthUtils.getIssuedAt());
+        super(client,
+                OAuthConstants.REFRESH_TOKEN_TYPE,
+                OAuthUtils.generateRandomTokenKey(),
+                lifetime,
+                OAuthUtils.getIssuedAt());
     }
-    
-    public RefreshToken(Client client, 
-                             String tokenKey,
-                             long lifetime, 
-                             long issuedAt) {
-        super(client, 
-              OAuthConstants.REFRESH_TOKEN_TYPE, 
-              tokenKey, 
-              lifetime, 
-              issuedAt);
+
+    public RefreshToken(Client client,
+                        String tokenKey,
+                        long lifetime,
+                        long issuedAt) {
+        super(client,
+                OAuthConstants.REFRESH_TOKEN_TYPE,
+                tokenKey,
+                lifetime,
+                issuedAt);
     }
 
     public RefreshToken(ServerAccessToken token,
@@ -64,10 +66,13 @@ public class RefreshToken extends ServerAccessToken {
         super(validateTokenType(token, OAuthConstants.REFRESH_TOKEN_TYPE), key);
         this.accessTokens = accessTokens;
     }
+
     public RefreshToken() {
-        
+
     }
-    @ElementCollection
+
+    @ElementCollection(fetch = FetchType.EAGER)
+    @OrderColumn
     public List<String> getAccessTokens() {
         return accessTokens;
     }
@@ -75,11 +80,11 @@ public class RefreshToken extends ServerAccessToken {
     public void setAccessTokens(List<String> accessTokens) {
         this.accessTokens = accessTokens;
     }
-    
+
     public void addAccessToken(String token) {
         getAccessTokens().add(token);
     }
-    
+
     public boolean removeAccessToken(String token) {
         return getAccessTokens().remove(token);
     }
diff --git a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/utils/OAuthUtils.java b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/utils/OAuthUtils.java
index c1a1474716..d08969b1bd 100644
--- a/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/utils/OAuthUtils.java
+++ b/rt/rs/security/oauth-parent/oauth2/src/main/java/org/apache/cxf/rs/security/oauth2/utils/OAuthUtils.java
@@ -21,6 +21,7 @@ package org.apache.cxf.rs.security.oauth2.utils;
 import java.security.Principal;
 import java.util.ArrayList;
 import java.util.Collections;
+import java.util.HashMap;
 import java.util.LinkedList;
 import java.util.List;
 import java.util.Properties;
@@ -287,7 +288,7 @@ public final class OAuthUtils {
             if (!StringUtils.isEmpty(scopeString)) {
                 clientToken.setApprovedScope(scopeString);    
             }
-            clientToken.setParameters(serverToken.getParameters());
+            clientToken.setParameters(new HashMap<String, String>(serverToken.getParameters()));
         }
         return clientToken;
     }
diff --git a/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProviderOpenJPATest.java b/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProviderOpenJPATest.java
new file mode 100644
index 0000000000..d9d3d9be03
--- /dev/null
+++ b/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProviderOpenJPATest.java
@@ -0,0 +1,43 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements. See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership. The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License. You may obtain a copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied. See the License for the
+ * specific language governing permissions and limitations
+ * under the License.
+ */
+package org.apache.cxf.rs.security.oauth2.grants.code;
+
+import org.junit.runner.RunWith;
+import org.springframework.test.annotation.DirtiesContext;
+import org.springframework.test.context.ActiveProfiles;
+import org.springframework.test.context.ContextConfiguration;
+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
+
+/**
+ * Runs the same tests as JPACodeDataProviderTest but within a Spring Managed Transaction.
+ *
+ * Spring spawns a transaction before each call to <code><oauthProvider</code>.
+ *
+ * Note : this test needs <code>@DirtiesContext</code>, otherwise
+ * spring tests cache and reuse emf across test classes
+ * while non spring unit tests are closing emf (hence connection exception: closed).
+ *
+ * @author agonzalez
+ */
+@RunWith(SpringJUnit4ClassRunner.class)
+@ContextConfiguration("JPACMTCodeDataProvider.xml")
+@DirtiesContext
+@ActiveProfiles(value = "openJPA", inheritProfiles = false)
+public class JPACMTCodeDataProviderOpenJPATest extends JPACMTCodeDataProviderTest {
+}
diff --git a/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProviderTest.java b/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProviderTest.java
new file mode 100644
index 0000000000..8894706bb2
--- /dev/null
+++ b/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProviderTest.java
@@ -0,0 +1,65 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements. See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership. The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License. You may obtain a copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied. See the License for the
+ * specific language governing permissions and limitations
+ * under the License.
+ */
+package org.apache.cxf.rs.security.oauth2.grants.code;
+
+import org.junit.After;
+import org.junit.Before;
+import org.junit.runner.RunWith;
+import org.springframework.beans.factory.annotation.Autowired;
+import org.springframework.test.annotation.DirtiesContext;
+import org.springframework.test.context.ActiveProfiles;
+import org.springframework.test.context.ContextConfiguration;
+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
+
+/**
+ * Runs the same tests as JPACodeDataProviderTest but within a Spring Managed Transaction.
+ *
+ * Spring spawns a transaction before each call to <code><oauthProvider</code>.
+ *
+ * Note : this test needs <code>@DirtiesContext</code>, otherwise
+ * spring tests cache and reuse emf across test classes
+ * while non spring unit tests are closing emf (hence connection exception: closed).
+ *
+ * @author agonzalez
+ */
+@RunWith(SpringJUnit4ClassRunner.class)
+@ContextConfiguration("JPACMTCodeDataProvider.xml")
+@DirtiesContext
+@ActiveProfiles("hibernate")
+public class JPACMTCodeDataProviderTest extends JPACodeDataProviderTest {
+
+    @Autowired
+    private JPACMTCodeDataProvider oauthProvider;
+
+    @Override
+    protected JPACodeDataProvider getProvider() {
+        return this.oauthProvider;
+    }
+
+    @Before
+    @Override
+    public void setUp() {
+        initializeProvider(oauthProvider);
+    }
+
+    @After
+    @Override
+    public void tearDown() {
+    }
+}
diff --git a/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTOAuthDataProviderOpenJPATest.java b/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTOAuthDataProviderOpenJPATest.java
new file mode 100644
index 0000000000..4324ba3532
--- /dev/null
+++ b/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTOAuthDataProviderOpenJPATest.java
@@ -0,0 +1,44 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements. See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership. The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License. You may obtain a copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied. See the License for the
+ * specific language governing permissions and limitations
+ * under the License.
+ */
+package org.apache.cxf.rs.security.oauth2.grants.code;
+
+import org.apache.cxf.rs.security.oauth2.provider.JPAOAuthDataProviderTest;
+import org.junit.runner.RunWith;
+import org.springframework.test.annotation.DirtiesContext;
+import org.springframework.test.context.ActiveProfiles;
+import org.springframework.test.context.ContextConfiguration;
+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
+
+/**
+ * Runs the same tests as JPAOAuthDataProviderTest but within a Spring Managed Transaction.
+ *
+ * Spring spawns a transaction before each call to <code><oauthProvider</code>.
+ *
+ * Note : this test needs <code>@DirtiesContext</code>, otherwise
+ * spring tests cache and reuse emf across test classes
+ * while non spring unit tests are closing emf (hence connection exception: closed).
+ *
+ * @author agonzalez
+ */
+@RunWith(SpringJUnit4ClassRunner.class)
+@ContextConfiguration("JPACMTCodeDataProvider.xml")
+@DirtiesContext
+@ActiveProfiles(value = "openJPA", inheritProfiles = false)
+public class JPACMTOAuthDataProviderOpenJPATest extends JPAOAuthDataProviderTest {
+}
diff --git a/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTOAuthDataProviderTest.java b/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTOAuthDataProviderTest.java
new file mode 100644
index 0000000000..a7245e2695
--- /dev/null
+++ b/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTOAuthDataProviderTest.java
@@ -0,0 +1,67 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements. See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership. The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License. You may obtain a copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied. See the License for the
+ * specific language governing permissions and limitations
+ * under the License.
+ */
+package org.apache.cxf.rs.security.oauth2.grants.code;
+
+import org.apache.cxf.rs.security.oauth2.provider.JPAOAuthDataProvider;
+import org.apache.cxf.rs.security.oauth2.provider.JPAOAuthDataProviderTest;
+import org.junit.After;
+import org.junit.Before;
+import org.junit.runner.RunWith;
+import org.springframework.beans.factory.annotation.Autowired;
+import org.springframework.test.annotation.DirtiesContext;
+import org.springframework.test.context.ActiveProfiles;
+import org.springframework.test.context.ContextConfiguration;
+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
+
+/**
+ * Runs the same tests as JPAOAuthDataProviderTest but within a Spring Managed Transaction.
+ *
+ * Spring spawns a transaction before each call to <code><oauthProvider</code>.
+ *
+ * Note : this test needs <code>@DirtiesContext</code>, otherwise
+ * spring tests cache and reuse emf across test classes
+ * while non spring unit tests are closing emf (hence connection exception: closed).
+ *
+ * @author agonzalez
+ */
+@RunWith(SpringJUnit4ClassRunner.class)
+@ContextConfiguration("JPACMTCodeDataProvider.xml")
+@DirtiesContext
+@ActiveProfiles("hibernate")
+public class JPACMTOAuthDataProviderTest extends JPAOAuthDataProviderTest {
+
+    @Autowired
+    private JPACMTCodeDataProvider oauthProvider;
+
+    @Override
+    protected JPAOAuthDataProvider getProvider() {
+        return this.oauthProvider;
+    }
+
+    @Before
+    @Override
+    public void setUp() {
+        initializeProvider(oauthProvider);
+    }
+
+    @After
+    @Override
+    public void tearDown() {
+    }
+}
diff --git a/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACodeDataProviderOpenJPATest.java b/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACodeDataProviderOpenJPATest.java
new file mode 100644
index 0000000000..d227ff8e96
--- /dev/null
+++ b/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACodeDataProviderOpenJPATest.java
@@ -0,0 +1,26 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements. See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership. The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License. You may obtain a copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied. See the License for the
+ * specific language governing permissions and limitations
+ * under the License.
+ */
+package org.apache.cxf.rs.security.oauth2.grants.code;
+
+public class JPACodeDataProviderOpenJPATest extends JPACodeDataProviderTest {
+    @Override
+    protected String getPersistenceUnitName() {
+        return "testUnitOpenJPA";
+    }
+}
diff --git a/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACodeDataProviderTest.java b/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACodeDataProviderTest.java
index cbbea512b0..27ee049ae3 100644
--- a/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACodeDataProviderTest.java
+++ b/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/grants/code/JPACodeDataProviderTest.java
@@ -22,14 +22,11 @@ import java.sql.Connection;
 import java.sql.DriverManager;
 import java.util.Collections;
 import java.util.List;
-
-import javax.persistence.EntityManager;
 import javax.persistence.EntityManagerFactory;
 import javax.persistence.Persistence;
 
 import org.apache.cxf.rs.security.oauth2.common.Client;
 import org.apache.cxf.rs.security.oauth2.common.UserSubject;
-
 import org.junit.After;
 import org.junit.Assert;
 import org.junit.Before;
@@ -39,6 +36,7 @@ public class JPACodeDataProviderTest extends Assert {
     private EntityManagerFactory emFactory;
     private Connection connection;
     private JPACodeDataProvider provider;
+
     @Before
     public void setUp() throws Exception {
         try {
@@ -49,17 +47,28 @@ public class JPACodeDataProviderTest extends Assert {
             fail("Exception during HSQL database init.");
         }
         try {
-            emFactory = Persistence.createEntityManagerFactory("testUnitHibernate");
-            EntityManager em = emFactory.createEntityManager();
+            emFactory = Persistence.createEntityManagerFactory(getPersistenceUnitName());
             provider = new JPACodeDataProvider();
-            provider.setEntityManager(em);
-            provider.setSupportedScopes(Collections.singletonMap("a", "A Scope"));
+            getProvider().setEntityManagerFactory(emFactory);
+            initializeProvider(provider);
         } catch (Exception ex) {
             ex.printStackTrace();
             fail("Exception during JPA EntityManager creation.");
         }
     }
 
+    protected String getPersistenceUnitName() {
+        return "testUnitHibernate";
+    }
+
+    protected void initializeProvider(JPACodeDataProvider dataProvider) {
+        dataProvider.setSupportedScopes(Collections.singletonMap("a", "A Scope"));
+    }
+
+    protected JPACodeDataProvider getProvider() {
+        return provider;
+    }
+
     @Test
     public void testAddGetDeleteCodeGrants() {
         Client c = addClient("111", "bob");
@@ -69,25 +78,34 @@ public class JPACodeDataProviderTest extends Assert {
         atr.setApprovedScope(Collections.singletonList("a"));
         atr.setSubject(c.getResourceOwnerSubject());
         
-        ServerAuthorizationCodeGrant grant = provider.createCodeGrant(atr);
+        ServerAuthorizationCodeGrant grant = getProvider().createCodeGrant(atr);
         
-        List<ServerAuthorizationCodeGrant> grants = provider.getCodeGrants(c, c.getResourceOwnerSubject());
+        List<ServerAuthorizationCodeGrant> grants = getProvider().getCodeGrants(c, c.getResourceOwnerSubject());
         assertNotNull(grants);
         assertEquals(1, grants.size());
         assertEquals(grant.getCode(), grants.get(0).getCode());
         
-        grants = provider.getCodeGrants(c, null);
+        grants = getProvider().getCodeGrants(c, null);
         assertNotNull(grants);
         assertEquals(1, grants.size());
         assertEquals(grant.getCode(), grants.get(0).getCode());
         
-        ServerAuthorizationCodeGrant grant2 = provider.removeCodeGrant(grant.getCode());
+        ServerAuthorizationCodeGrant grant2 = getProvider().removeCodeGrant(grant.getCode());
         assertEquals(grant.getCode(), grant2.getCode());
         
-        grants = provider.getCodeGrants(c, null);
+        grants = getProvider().getCodeGrants(c, null);
         assertNotNull(grants);
         assertEquals(0, grants.size());
     }
+
+    @Test
+    public void testResetClient() {
+        Client c = addClient("111", "bob");
+        c.setClientSecret("newSecret");
+        getProvider().setClient(c);
+        Client savedClient = getProvider().getClient(c.getClientId());
+        assertEquals(c.getClientSecret(), savedClient.getClientSecret());
+    }
     
     @Test
     public void testAddGetDeleteCodeGrants2() {
@@ -98,13 +116,13 @@ public class JPACodeDataProviderTest extends Assert {
         atr.setApprovedScope(Collections.singletonList("a"));
         atr.setSubject(c.getResourceOwnerSubject());
         
-        provider.createCodeGrant(atr);
+        getProvider().createCodeGrant(atr);
         
-        List<ServerAuthorizationCodeGrant> grants = provider.getCodeGrants(c, c.getResourceOwnerSubject());
+        List<ServerAuthorizationCodeGrant> grants = getProvider().getCodeGrants(c, c.getResourceOwnerSubject());
         assertNotNull(grants);
         assertEquals(1, grants.size());
-        provider.removeClient(c.getClientId());
-        grants = provider.getCodeGrants(c, c.getResourceOwnerSubject());
+        getProvider().removeClient(c.getClientId());
+        grants = getProvider().getCodeGrants(c, c.getResourceOwnerSubject());
         assertNotNull(grants);
         assertEquals(0, grants.size());
     }
@@ -114,14 +132,15 @@ public class JPACodeDataProviderTest extends Assert {
         c.setRedirectUris(Collections.singletonList("http://client/redirect"));
         c.setClientId(clientId);
         c.setResourceOwnerSubject(new UserSubject(userLogin));
-        provider.setClient(c);
+        getProvider().setClient(c);
         return c;
     }
+
     @After
     public void tearDown() throws Exception {
         try {
             if (provider != null) {
-                provider.close();
+                getProvider().close();
             }
             if (emFactory != null) {
                 emFactory.close();
diff --git a/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/provider/JPAOAuthDataProviderOpenJPATest.java b/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/provider/JPAOAuthDataProviderOpenJPATest.java
new file mode 100644
index 0000000000..e6a2d25a84
--- /dev/null
+++ b/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/provider/JPAOAuthDataProviderOpenJPATest.java
@@ -0,0 +1,26 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements. See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership. The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License. You may obtain a copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied. See the License for the
+ * specific language governing permissions and limitations
+ * under the License.
+ */
+package org.apache.cxf.rs.security.oauth2.provider;
+
+public class JPAOAuthDataProviderOpenJPATest extends JPAOAuthDataProviderTest {
+    @Override
+    protected String getPersistenceUnitName() {
+        return "testUnitOpenJPA";
+    }
+}
diff --git a/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/provider/JPAOAuthDataProviderTest.java b/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/provider/JPAOAuthDataProviderTest.java
index ed2e0a693d..4eb8533fbd 100644
--- a/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/provider/JPAOAuthDataProviderTest.java
+++ b/rt/rs/security/oauth-parent/oauth2/src/test/java/org/apache/cxf/rs/security/oauth2/provider/JPAOAuthDataProviderTest.java
@@ -18,13 +18,9 @@
  */
 package org.apache.cxf.rs.security.oauth2.provider;
 
-import java.sql.Connection;
-import java.sql.DriverManager;
 import java.util.Arrays;
 import java.util.Collections;
 import java.util.List;
-
-import javax.persistence.EntityManager;
 import javax.persistence.EntityManagerFactory;
 import javax.persistence.Persistence;
 
@@ -35,159 +31,162 @@ import org.apache.cxf.rs.security.oauth2.common.ServerAccessToken;
 import org.apache.cxf.rs.security.oauth2.common.UserSubject;
 import org.apache.cxf.rs.security.oauth2.tokens.refresh.RefreshToken;
 import org.apache.cxf.rs.security.oauth2.utils.OAuthConstants;
-
 import org.junit.After;
 import org.junit.Assert;
 import org.junit.Before;
 import org.junit.Test;
 
 public class JPAOAuthDataProviderTest extends Assert {
-    private EntityManagerFactory emFactory;
-    private Connection connection;
+    protected EntityManagerFactory emFactory;
     private JPAOAuthDataProvider provider;
+
     @Before
     public void setUp() throws Exception {
         try {
-            Class.forName("org.hsqldb.jdbcDriver");
-            connection = DriverManager.getConnection("jdbc:hsqldb:mem:oauth-jpa", "sa", "");
-        } catch (Exception ex) {
-            ex.printStackTrace();
-            fail("Exception during HSQL database init.");
-        }
-        try {
-            emFactory = Persistence.createEntityManagerFactory("testUnitHibernate");
-            EntityManager em = emFactory.createEntityManager();
+            emFactory = Persistence.createEntityManagerFactory(getPersistenceUnitName());
             provider = new JPAOAuthDataProvider();
-            provider.setEntityManager(em);
-            provider.setSupportedScopes(Collections.singletonMap("a", "A Scope"));
-            provider.setSupportedScopes(Collections.singletonMap("refreshToken", "RefreshToken"));
+            provider.setEntityManagerFactory(emFactory);
+            initializeProvider(provider);
         } catch (Exception ex) {
             ex.printStackTrace();
             fail("Exception during JPA EntityManager creation.");
         }
     }
 
+    protected String getPersistenceUnitName() {
+        return "testUnitHibernate";
+    }
+
+    protected void initializeProvider(JPAOAuthDataProvider dataProvider) {
+        dataProvider.setSupportedScopes(Collections.singletonMap("a", "A Scope"));
+        dataProvider.setSupportedScopes(Collections.singletonMap("refreshToken", "RefreshToken"));
+    }
+
+    protected JPAOAuthDataProvider getProvider() {
+        return provider;
+    }
+
     @Test
     public void testAddGetDeleteClient() {
         Client c = addClient("12345", "alice");
-        Client c2 = provider.getClient(c.getClientId());
+        Client c2 = getProvider().getClient(c.getClientId());
         compareClients(c, c2);
-        
+
         c2.setClientSecret("567");
-        provider.setClient(c2);
-        Client c22 = provider.getClient(c.getClientId());
+        getProvider().setClient(c2);
+        Client c22 = getProvider().getClient(c.getClientId());
         compareClients(c2, c22);
-        
-        provider.removeClient(c.getClientId());
-        Client c3 = provider.getClient(c.getClientId());
+
+        getProvider().removeClient(c.getClientId());
+        Client c3 = getProvider().getClient(c.getClientId());
         assertNull(c3);
     }
-    
+
     @Test
     public void testAddGetDeleteClients() {
         Client c = addClient("12345", "alice");
         Client c2 = addClient("56789", "alice");
         Client c3 = addClient("09876", "bob");
-        
-        List<Client> aliceClients = provider.getClients(new UserSubject("alice"));
+
+        List<Client> aliceClients = getProvider().getClients(new UserSubject("alice"));
         assertNotNull(aliceClients);
         assertEquals(2, aliceClients.size());
-        compareClients(c, aliceClients.get(0).getClientId().equals("12345") 
+        compareClients(c, aliceClients.get(0).getClientId().equals("12345")
                        ? aliceClients.get(0) : aliceClients.get(1));
-        compareClients(c2, aliceClients.get(0).getClientId().equals("56789") 
+        compareClients(c2, aliceClients.get(0).getClientId().equals("56789")
                        ? aliceClients.get(0) : aliceClients.get(1));
-        
-        List<Client> bobClients = provider.getClients(new UserSubject("bob"));
+
+        List<Client> bobClients = getProvider().getClients(new UserSubject("bob"));
         assertNotNull(bobClients);
         assertEquals(1, bobClients.size());
         Client bobClient = bobClients.get(0);
         compareClients(c3, bobClient);
-        
-        List<Client> allClients = provider.getClients(null);
+
+        List<Client> allClients = getProvider().getClients(null);
         assertNotNull(allClients);
         assertEquals(3, allClients.size());
-        provider.removeClient(c.getClientId());
-        provider.removeClient(c2.getClientId());
-        provider.removeClient(c3.getClientId());
-        allClients = provider.getClients(null);
+        getProvider().removeClient(c.getClientId());
+        getProvider().removeClient(c2.getClientId());
+        getProvider().removeClient(c3.getClientId());
+        allClients = getProvider().getClients(null);
         assertNotNull(allClients);
         assertEquals(0, allClients.size());
     }
-    
+
     @Test
     public void testAddGetDeleteAccessToken() {
         Client c = addClient("101", "bob");
-        
+
         AccessTokenRegistration atr = new AccessTokenRegistration();
         atr.setClient(c);
         atr.setApprovedScope(Collections.singletonList("a"));
         atr.setSubject(c.getResourceOwnerSubject());
-        
-        ServerAccessToken at = provider.createAccessToken(atr);
-        ServerAccessToken at2 = provider.getAccessToken(at.getTokenKey());
+
+        ServerAccessToken at = getProvider().createAccessToken(atr);
+        ServerAccessToken at2 = getProvider().getAccessToken(at.getTokenKey());
         assertEquals(at.getTokenKey(), at2.getTokenKey());
         List<OAuthPermission> scopes = at2.getScopes();
         assertNotNull(scopes);
         assertEquals(1, scopes.size());
         OAuthPermission perm = scopes.get(0);
         assertEquals("a", perm.getPermission());
-        
-        List<ServerAccessToken> tokens = provider.getAccessTokens(c, c.getResourceOwnerSubject());
+
+        List<ServerAccessToken> tokens = getProvider().getAccessTokens(c, c.getResourceOwnerSubject());
         assertNotNull(tokens);
         assertEquals(1, tokens.size());
         assertEquals(at.getTokenKey(), tokens.get(0).getTokenKey());
-        
-        tokens = provider.getAccessTokens(c, null);
+
+        tokens = getProvider().getAccessTokens(c, null);
         assertNotNull(tokens);
         assertEquals(1, tokens.size());
         assertEquals(at.getTokenKey(), tokens.get(0).getTokenKey());
-        
-        tokens = provider.getAccessTokens(null, c.getResourceOwnerSubject());
+
+        tokens = getProvider().getAccessTokens(null, c.getResourceOwnerSubject());
         assertNotNull(tokens);
         assertEquals(1, tokens.size());
         assertEquals(at.getTokenKey(), tokens.get(0).getTokenKey());
-        
-        tokens = provider.getAccessTokens(null, null);
+
+        tokens = getProvider().getAccessTokens(null, null);
         assertNotNull(tokens);
         assertEquals(1, tokens.size());
         assertEquals(at.getTokenKey(), tokens.get(0).getTokenKey());
-        
-        provider.revokeToken(c, at.getTokenKey(), OAuthConstants.ACCESS_TOKEN);
-        assertNull(provider.getAccessToken(at.getTokenKey()));
+
+        getProvider().revokeToken(c, at.getTokenKey(), OAuthConstants.ACCESS_TOKEN);
+        assertNull(getProvider().getAccessToken(at.getTokenKey()));
     }
-    
+
     @Test
     public void testAddGetDeleteAccessToken2() {
         Client c = addClient("102", "bob");
-        
+
         AccessTokenRegistration atr = new AccessTokenRegistration();
         atr.setClient(c);
         atr.setApprovedScope(Collections.singletonList("a"));
         atr.setSubject(c.getResourceOwnerSubject());
-        
-        provider.createAccessToken(atr);
-        List<ServerAccessToken> tokens = provider.getAccessTokens(c, null);
+
+        getProvider().createAccessToken(atr);
+        List<ServerAccessToken> tokens = getProvider().getAccessTokens(c, null);
         assertNotNull(tokens);
         assertEquals(1, tokens.size());
-        
-        provider.removeClient(c.getClientId());
-        
-        tokens = provider.getAccessTokens(c, null);
+
+        getProvider().removeClient(c.getClientId());
+
+        tokens = getProvider().getAccessTokens(c, null);
         assertNotNull(tokens);
         assertEquals(0, tokens.size());
     }
-    
+
     @Test
     public void testAddGetDeleteRefreshToken() {
         Client c = addClient("101", "bob");
-        
+
         AccessTokenRegistration atr = new AccessTokenRegistration();
         atr.setClient(c);
         atr.setApprovedScope(Arrays.asList("a", "refreshToken"));
         atr.setSubject(c.getResourceOwnerSubject());
-        
-        ServerAccessToken at = provider.createAccessToken(atr);
-        ServerAccessToken at2 = provider.getAccessToken(at.getTokenKey());
+
+        ServerAccessToken at = getProvider().createAccessToken(atr);
+        ServerAccessToken at2 = getProvider().getAccessToken(at.getTokenKey());
         assertEquals(at.getTokenKey(), at2.getTokenKey());
         List<OAuthPermission> scopes = at2.getScopes();
         assertNotNull(scopes);
@@ -196,28 +195,28 @@ public class JPAOAuthDataProviderTest extends Assert {
         assertEquals("a", perm.getPermission());
         OAuthPermission perm2 = scopes.get(1);
         assertEquals("refreshToken", perm2.getPermission());
-        
-        RefreshToken rt = provider.getRefreshToken(at2.getRefreshToken());
+
+        RefreshToken rt = getProvider().getRefreshToken(at2.getRefreshToken());
         assertNotNull(rt);
         assertEquals(at2.getTokenKey(), rt.getAccessTokens().get(0));
-        
-        List<RefreshToken> tokens = provider.getRefreshTokens(c, c.getResourceOwnerSubject());
+
+        List<RefreshToken> tokens = getProvider().getRefreshTokens(c, c.getResourceOwnerSubject());
         assertNotNull(tokens);
         assertEquals(1, tokens.size());
         assertEquals(rt.getTokenKey(), tokens.get(0).getTokenKey());
-        
-        provider.revokeToken(c, rt.getTokenKey(), OAuthConstants.REFRESH_TOKEN);
-        
-        assertNull(provider.getRefreshToken(rt.getTokenKey()));
+
+        getProvider().revokeToken(c, rt.getTokenKey(), OAuthConstants.REFRESH_TOKEN);
+
+        assertNull(getProvider().getRefreshToken(rt.getTokenKey()));
     }
-    
+
     private Client addClient(String clientId, String userLogin) {
         Client c = new Client();
         c.setRedirectUris(Collections.singletonList("http://client/redirect"));
         c.setClientId(clientId);
         c.setClientSecret("123");
         c.setResourceOwnerSubject(new UserSubject(userLogin));
-        provider.setClient(c);
+        getProvider().setClient(c);
         return c;
     }
     private void compareClients(Client c, Client c2) {
@@ -228,12 +227,12 @@ public class JPAOAuthDataProviderTest extends Assert {
         assertEquals("http://client/redirect", c.getRedirectUris().get(0));
         assertEquals(c.getResourceOwnerSubject().getLogin(), c2.getResourceOwnerSubject().getLogin());
     }
-    
+
     @After
     public void tearDown() throws Exception {
         try {
             if (provider != null) {
-                provider.close();
+                getProvider().close();
             }
             if (emFactory != null) {
                 emFactory.close();
@@ -242,7 +241,7 @@ public class JPAOAuthDataProviderTest extends Assert {
             ex.printStackTrace();    
         } finally {    
             try {
-                connection.createStatement().execute("SHUTDOWN");
+                //connection.createStatement().execute("SHUTDOWN");
             } catch (Throwable ex) {
                 ex.printStackTrace();
             }
diff --git a/rt/rs/security/oauth-parent/oauth2/src/test/resources/META-INF/orm.xml b/rt/rs/security/oauth-parent/oauth2/src/test/resources/META-INF/orm.xml
deleted file mode 100644
index 0b25439a18..0000000000
--- a/rt/rs/security/oauth-parent/oauth2/src/test/resources/META-INF/orm.xml
+++ /dev/null
@@ -1,99 +0,0 @@
-<?xml version="1.0" encoding="UTF-8"?>
-<!--
-  Licensed to the Apache Software Foundation (ASF) under one
-  or more contributor license agreements. See the NOTICE file
-  distributed with this work for additional information
-  regarding copyright ownership. The ASF licenses this file
-  to you under the Apache License, Version 2.0 (the
-  "License"); you may not use this file except in compliance
-  with the License. You may obtain a copy of the License at
- 
-  http://www.apache.org/licenses/LICENSE-2.0
- 
-  Unless required by applicable law or agreed to in writing,
-  software distributed under the License is distributed on an
-  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
-  KIND, either express or implied. See the License for the
-  specific language governing permissions and limitations
-  under the License.
--->
-<entity-mappings xmlns="http://java.sun.com/xml/ns/persistence/orm"
-    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xsi:schemaLocation="http://java.sun.com/xml/ns/persistence/orm http://java.sun.com/xml/ns/persistence/orm_2_0.xsd"
-    version="2.0">
-
-    <mapped-superclass class="org.apache.cxf.rs.security.oauth2.common.AccessToken">
-      <attributes>
-        <id name="tokenKey"/>
-        <element-collection name="parameters">
-            <map-key-column name="propName"/>
-        </element-collection>
-      </attributes>
-    </mapped-superclass>
-    <mapped-superclass class="org.apache.cxf.rs.security.oauth2.common.ServerAccessToken">
-      <attributes>
-        <many-to-one name="subject" fetch="LAZY"/>
-        <many-to-one name="client" fetch="LAZY"/>
-        <many-to-many name="scopes"/>
-        <element-collection name="audiences" target-class="java.lang.String"/>
-        <element-collection name="extraProperties">
-            <map-key-column name="extraPropName"/>
-        </element-collection>
-      </attributes>
-    </mapped-superclass>
-    <mapped-superclass class="org.apache.cxf.rs.security.oauth2.grants.code.AuthorizationCodeGrant">
-      <attributes>
-        <id name="code"/>
-      </attributes>
-    </mapped-superclass>
-    <entity class="org.apache.cxf.rs.security.oauth2.tokens.bearer.BearerAccessToken">
-      <attributes/>
-    </entity>
-    <entity class="org.apache.cxf.rs.security.oauth2.tokens.refresh.RefreshToken">
-      <attributes>
-        <element-collection name="accessTokens" target-class="java.lang.String"/>
-      </attributes>
-    </entity>
-    <entity class="org.apache.cxf.rs.security.oauth2.common.OAuthPermission">
-      <attributes>
-        <id name="permission"/>
-        <element-collection name="httpVerbs" target-class="java.lang.String"/>
-        <element-collection name="uris" target-class="java.lang.String"/>
-      </attributes>
-    </entity>
-    <entity class="org.apache.cxf.rs.security.oauth2.common.Client">
-      <attributes>
-        <id name="clientId"/>
-        <many-to-one name="resourceOwnerSubject" fetch="LAZY"/>
-        <one-to-one name="subject" fetch="LAZY"/>
-        <element-collection name="applicationCertificates" target-class="java.lang.String"/>
-        <element-collection name="redirectUris" target-class="java.lang.String"/>
-        <element-collection name="allowedGrantTypes" target-class="java.lang.String"/>
-        <element-collection name="registeredScopes" target-class="java.lang.String"/>
-        <element-collection name="registeredAudiences" target-class="java.lang.String"/>
-        <element-collection name="properties">
-            <map-key-column name="name"/>
-        </element-collection>
-      </attributes>
-    </entity>
-    <entity class="org.apache.cxf.rs.security.oauth2.common.UserSubject">
-      <attributes>
-        <id name="login"/>
-        <element-collection name="roles" target-class="java.lang.String"/>
-        <element-collection name="properties">
-            <map-key-column name="name"/>
-        </element-collection>
-      </attributes>
-    </entity>
-    <entity class="org.apache.cxf.rs.security.oauth2.grants.code.ServerAuthorizationCodeGrant">
-      <attributes>
-        <many-to-one name="subject" fetch="LAZY"/>
-        <many-to-one name="client" fetch="LAZY"/>
-        <element-collection name="requestedScopes" target-class="java.lang.String"/>
-        <element-collection name="approvedScopes" target-class="java.lang.String"/>
-        <element-collection name="extraProperties">
-            <map-key-column name="extraPropName"/>
-        </element-collection>
-      </attributes>
-    </entity>
- </entity-mappings>
diff --git a/rt/rs/security/oauth-parent/oauth2/src/test/resources/META-INF/persistence.xml b/rt/rs/security/oauth-parent/oauth2/src/test/resources/META-INF/persistence.xml
index 25c7f769d6..8d7ad1c371 100644
--- a/rt/rs/security/oauth-parent/oauth2/src/test/resources/META-INF/persistence.xml
+++ b/rt/rs/security/oauth-parent/oauth2/src/test/resources/META-INF/persistence.xml
@@ -2,51 +2,60 @@
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"
              version="2.0">
-             
-   <persistence-unit name="testUnitHibernate" transaction-type="RESOURCE_LOCAL">
-     <provider>org.hibernate.ejb.HibernatePersistence</provider>
-     <class>org.apache.cxf.rs.security.oauth2.common.Client</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.UserSubject</class>
-     <class>org.apache.cxf.rs.security.oauth2.grants.code.ServerAuthorizationCodeGrant</class>
-     <class>org.apache.cxf.rs.security.oauth2.grants.code.AuthorizationCodeGrant</class>
-     <class>org.apache.cxf.rs.security.oauth2.tokens.bearer.BearerAccessToken</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.ServerAccessToken</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.AccessToken</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.OAuthPermission</class>
-     <class>org.apache.cxf.rs.security.oauth2.tokens.refresh.RefreshToken</class>
-     <exclude-unlisted-classes>true</exclude-unlisted-classes>
-     <properties>
-        <property name="hibernate.connection.url" value="jdbc:hsqldb:mem:oauth-jpa"/>
-        <property name="hibernate.connection.driver_class" value="org.hsqldb.jdbcDriver"/>
-        <property name="hibernate.dialect" value="org.hibernate.dialect.HSQLDialect"/>
-        <property name="hibernate.hbm2ddl.auto" value="create-drop"/>
-        <property name="hibernate.connection.username" value="sa"/>
-        <property name="hibernate.connection.password" value=""/>
-        <property name="javax.persistence.validation.mode" value="none"/>
-     </properties>
-   </persistence-unit>
-   
-   <!--
-   <persistence-unit name="testUnitOpenJPA" transaction-type="RESOURCE_LOCAL">
-     <provider>org.apache.openjpa.persistence.PersistenceProviderImpl</provider>
-     <class>org.apache.cxf.rs.security.oauth2.common.Client</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.UserSubject</class>
-     <class>org.apache.cxf.rs.security.oauth2.grants.code.ServerAuthorizationCodeGrant</class>
-     <class>org.apache.cxf.rs.security.oauth2.grants.code.AuthorizationCodeGrant</class>
-     <class>org.apache.cxf.rs.security.oauth2.tokens.bearer.BearerAccessToken</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.ServerAccessToken</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.AccessToken</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.OAuthPermission</class>
-     <class>org.apache.cxf.rs.security.oauth2.tokens.refresh.RefreshToken</class>
-     <exclude-unlisted-classes>true</exclude-unlisted-classes>
-     <properties>
-        <property name="openjpa.ConnectionURL" value="jdbc:hsqldb:mem:oauth-jpa"/>
-        <property name="openjpa.ConnectionDriverName" value="org.hsqldb.jdbcDriver"/>
-        <property name="openjpa.jdbc.DBDictionary" value="hsql" />
-        <property name="openjpa.ConnectionUserName" value="sa"/>
-        <property name="openjpa.ConnectionPassword" value=""/>
-        <property name="openjpa.jdbc.SynchronizeMappings" value="buildSchema"/>
-     </properties>
+
+    <persistence-unit name="testUnitHibernate" transaction-type="RESOURCE_LOCAL">
+        <provider>org.hibernate.ejb.HibernatePersistence</provider>
+        <class>org.apache.cxf.rs.security.oauth2.common.Client</class>
+        <class>org.apache.cxf.rs.security.oauth2.common.UserSubject</class>
+        <class>org.apache.cxf.rs.security.oauth2.grants.code.ServerAuthorizationCodeGrant</class>
+        <class>org.apache.cxf.rs.security.oauth2.grants.code.AuthorizationCodeGrant</class>
+        <class>org.apache.cxf.rs.security.oauth2.tokens.bearer.BearerAccessToken</class>
+        <class>org.apache.cxf.rs.security.oauth2.common.ServerAccessToken</class>
+        <class>org.apache.cxf.rs.security.oauth2.common.AccessToken</class>
+        <class>org.apache.cxf.rs.security.oauth2.common.OAuthPermission</class>
+        <class>org.apache.cxf.rs.security.oauth2.tokens.refresh.RefreshToken</class>
+        <exclude-unlisted-classes>true</exclude-unlisted-classes>
+        <shared-cache-mode>ENABLE_SELECTIVE</shared-cache-mode>
+        <properties>
+            <property name="hibernate.connection.url" value="jdbc:hsqldb:mem:oauth-jpa"/>
+            <property name="hibernate.connection.driver_class" value="org.hsqldb.jdbcDriver"/>
+            <property name="hibernate.dialect" value="org.hibernate.dialect.HSQLDialect"/>
+            <property name="hibernate.hbm2ddl.auto" value="create-drop"/>
+            <property name="hibernate.connection.username" value="sa"/>
+            <property name="hibernate.connection.password" value=""/>
+            <property name="javax.persistence.validation.mode" value="none"/>
+            <property name="hibernate.cache.region.factory_class"
+                      value="org.hibernate.cache.ehcache.SingletonEhCacheRegionFactory"/>
+            <property name="hibernate.max_fetch_depth" value="3"/>
+        </properties>
     </persistence-unit>
-    -->
+
+    <persistence-unit name="testUnitOpenJPA" transaction-type="RESOURCE_LOCAL">
+        <provider>org.apache.openjpa.persistence.PersistenceProviderImpl</provider>
+        <class>org.apache.cxf.rs.security.oauth2.common.Client</class>
+        <class>org.apache.cxf.rs.security.oauth2.common.UserSubject</class>
+        <class>org.apache.cxf.rs.security.oauth2.grants.code.ServerAuthorizationCodeGrant</class>
+        <class>org.apache.cxf.rs.security.oauth2.grants.code.AuthorizationCodeGrant</class>
+        <class>org.apache.cxf.rs.security.oauth2.tokens.bearer.BearerAccessToken</class>
+        <class>org.apache.cxf.rs.security.oauth2.common.ServerAccessToken</class>
+        <class>org.apache.cxf.rs.security.oauth2.common.AccessToken</class>
+        <class>org.apache.cxf.rs.security.oauth2.common.OAuthPermission</class>
+        <class>org.apache.cxf.rs.security.oauth2.tokens.refresh.RefreshToken</class>
+        <exclude-unlisted-classes>true</exclude-unlisted-classes>
+        <shared-cache-mode>ENABLE_SELECTIVE</shared-cache-mode>
+        <properties>
+            <property name="openjpa.ConnectionURL" value="jdbc:hsqldb:mem:oauth-jpa"/>
+            <property name="openjpa.ConnectionDriverName" value="org.hsqldb.jdbcDriver"/>
+            <property name="openjpa.jdbc.DBDictionary" value="hsql"/>
+            <property name="openjpa.ConnectionUserName" value="sa"/>
+            <property name="openjpa.ConnectionPassword" value=""/>
+            <property name="openjpa.jdbc.SynchronizeMappings" value="buildSchema"/>
+            <property name="openjpa.jdbc.EagerFetchMode" value="parallel"/>
+            <property name="openjpa.MaxFetchDepth" value="20"/>
+            <!--
+            <property name="openjpa.Log" value="DefaultLevel=WARN, Runtime=TRACE, Tool=INFO"/>
+            -->
+        </properties>
+    </persistence-unit>
+
 </persistence>
\ No newline at end of file
diff --git a/rt/rs/security/oauth-parent/oauth2/src/test/resources/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProvider.xml b/rt/rs/security/oauth-parent/oauth2/src/test/resources/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProvider.xml
new file mode 100644
index 0000000000..c80434a741
--- /dev/null
+++ b/rt/rs/security/oauth-parent/oauth2/src/test/resources/org/apache/cxf/rs/security/oauth2/grants/code/JPACMTCodeDataProvider.xml
@@ -0,0 +1,113 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+Licensed to the Apache Software Foundation (ASF) under one
+or more contributor license agreements.  See the NOTICE file
+distributed with this work for additional information
+regarding copyright ownership.  The ASF licenses this file
+to you under the Apache License, Version 2.0 (the
+"License"); you may not use this file except in compliance
+with the License.  You may obtain a copy of the License at
+
+  http://www.apache.org/licenses/LICENSE-2.0
+
+Unless required by applicable law or agreed to in writing,
+software distributed under the License is distributed on an
+"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+KIND, either express or implied.  See the License for the
+specific language governing permissions and limitations
+under the License.
+-->
+<beans xmlns="http://www.springframework.org/schema/beans"
+       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+       xmlns:aop="http://www.springframework.org/schema/aop"
+       xmlns:context="http://www.springframework.org/schema/context"
+       xmlns:tx="http://www.springframework.org/schema/tx"
+       xmlns:util="http://www.springframework.org/schema/util"
+       xsi:schemaLocation="http://www.springframework.org/schema/aop
+                           http://www.springframework.org/schema/aop/spring-aop.xsd
+                           http://www.springframework.org/schema/beans
+                           http://www.springframework.org/schema/beans/spring-beans.xsd
+                           http://www.springframework.org/schema/context
+                           http://www.springframework.org/schema/context/spring-context.xsd
+                           http://www.springframework.org/schema/tx
+                           http://www.springframework.org/schema/tx/spring-tx.xsd
+                           http://www.springframework.org/schema/util
+                           http://www.springframework.org/schema/util/spring-util.xsd">
+
+
+    <bean id="oauthProvider"
+          class="org.apache.cxf.rs.security.oauth2.grants.code.JPACMTCodeDataProvider"
+          init-method="init" destroy-method="close">
+    </bean>
+
+
+    <bean id="transactionManager" class="org.springframework.orm.jpa.JpaTransactionManager">
+        <property name="entityManagerFactory" ref="entityManagerFactory"/>
+    </bean>
+
+    <tx:annotation-driven transaction-manager="transactionManager"/>
+
+    <aop:config proxy-target-class="true">
+        <aop:pointcut id="oauthProviderOperation"
+                      expression="bean(oauthProvider)"/>
+        <aop:advisor advice-ref="txAdvice" pointcut-ref="oauthProviderOperation"/>
+    </aop:config>
+    <tx:advice id="txAdvice" transaction-manager="transactionManager">
+        <tx:attributes>
+            <tx:method name="*"/>
+        </tx:attributes>
+    </tx:advice>
+
+    <beans profile="hibernate">
+        <bean id="entityManagerFactory"
+              class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">
+            <!--
+            <property name="dataSource" ref="dataSource"/>
+            -->
+            <!--<property name="jpaVendorAdapter">-->
+                <!--<bean class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter">-->
+                    <!--<property name="showSql" value="true"/>-->
+                    <!--<property name="generateDdl" value="true"/>-->
+                <!--</bean>-->
+            <!--</property>-->
+            <property name="persistenceUnitName" value="testUnitHibernate"/>
+            <property name="jpaPropertyMap">
+                <map>
+                    <entry key="hibernate.jdbc.fetch_size" value="400"/>
+                    <entry key="hibernate.jdbc.batch_size" value="100"/>
+                    <!--<entry key="hibernate.cache.use_second_level_cache" value="true"/>-->
+                    <!--<entry key="hibernate.cache.region.factory_class" value="org.hibernate.cache.ehcache.EhCacheRegionFactory"/>-->
+                </map>
+            </property>
+        </bean>
+    </beans>
+
+    <beans profile="openJPA">
+        <bean id="entityManagerFactory"
+              class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">
+            <!--
+            <property name="dataSource" ref="dataSource"/>
+            -->
+            <!--<property name="jpaVendorAdapter">-->
+                <!--<bean class="org.springframework.orm.jpa.vendor.OpenJpaVendorAdapter">-->
+                    <!--<property name="showSql" value="true"/>-->
+                    <!--<property name="generateDdl" value="true"/>-->
+                <!--</bean>-->
+            <!--</property>-->
+            <property name="persistenceUnitName" value="testUnitOpenJPA"/>
+            <!--
+            <property name="loadTimeWeaver">
+                <bean class="org.springframework.instrument.classloading.SimpleLoadTimeWeaver"/>
+            </property>
+            -->
+            <!--<property name="jpaPropertyMap">-->
+                <!--<map>-->
+                    <!--<entry key="openjpa.Log" value="slf4j"/>-->
+                    <!--<entry key="openjpa.Log" value="SQL=TRACE"/>-->
+                    <!--<entry key="openjpa.ConnectionFactoryProperties"-->
+                           <!--value="PrintParameters=true, PrettyPrint=true, PrettyPrintLineLength=80"/>-->
+                    <!--<entry key="openjpa.Log" value="DefaultLevel=WARN, Runtime=INFO, Tool=INFO, SQL=TRACE"/>-->
+                <!--</map>-->
+        </bean>
+    </beans>
+</beans>
\ No newline at end of file
diff --git a/rt/rs/security/sso/oidc/pom.xml b/rt/rs/security/sso/oidc/pom.xml
index 839b08a328..bba910d98c 100644
--- a/rt/rs/security/sso/oidc/pom.xml
+++ b/rt/rs/security/sso/oidc/pom.xml
@@ -17,152 +17,218 @@
   specific language governing permissions and limitations
   under the License.
 -->
-<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
-    <modelVersion>4.0.0</modelVersion>
-    <artifactId>cxf-rt-rs-security-sso-oidc</artifactId>
-    <packaging>bundle</packaging>
-    <name>Apache CXF Runtime OpenId Connect</name>
-    <description>Apache CXF Runtime OpenId Connect</description>
-    <url>http://cxf.apache.org</url>
-    <parent>
-        <groupId>org.apache.cxf</groupId>
-        <artifactId>cxf-parent</artifactId>
-        <version>3.2.0-SNAPSHOT</version>
-        <relativePath>../../../../../parent/pom.xml</relativePath>
-    </parent>
-    <properties>
-        <hibernate.em.version>4.1.0.Final</hibernate.em.version>
-        <hsqldb.version>1.8.0.10</hsqldb.version>
-    </properties>
-    <dependencies>
-        <dependency>
-            <groupId>org.apache.cxf</groupId>
-            <artifactId>cxf-rt-rs-security-oauth2</artifactId>
-            <version>${project.version}</version>
-        </dependency>
-        <dependency>
-            <groupId>org.apache.cxf</groupId>
-            <artifactId>cxf-rt-rs-security-jose-jaxrs</artifactId>
-            <version>${project.version}</version>
-        </dependency>
-        <dependency>
-            <groupId>org.apache.geronimo.specs</groupId>
-            <artifactId>geronimo-jpa_2.0_spec</artifactId>
-            <version>${cxf.geronimo.jpa.version}</version>
-            <scope>provided</scope>
-            <optional>true</optional>
-        </dependency>
-        <!--test dependencies-->
-        <dependency>
-            <groupId>junit</groupId>
-            <artifactId>junit</artifactId>
-            <scope>test</scope>
-        </dependency>
-        <dependency>
-            <groupId>org.easymock</groupId>
-            <artifactId>easymock</artifactId>
-            <scope>test</scope>
-        </dependency>
-        <dependency>
-            <groupId>hsqldb</groupId>
-            <artifactId>hsqldb</artifactId>
-            <version>${hsqldb.version}</version>
-            <scope>test</scope>
-        </dependency>
-        <!--
-        <dependency>
-             <groupId>org.apache.openjpa</groupId>
-             <artifactId>openjpa</artifactId>
-             <version>${cxf.openjpa.version}</version>
-             <scope>provided</scope>
-        </dependency>
-        -->
-        <dependency>
-            <groupId>org.hibernate</groupId>
-            <artifactId>hibernate-entitymanager</artifactId>
-            <version>${hibernate.em.version}</version>
-            <scope>test</scope>
-        </dependency>
-    </dependencies>
-    <build>
-       <plugins>
-         <plugin>
-	       <groupId>org.bsc.maven</groupId>
-	       <artifactId>maven-processor-plugin</artifactId>
-	       <version>3.1.0</version>
-	       <executions>
-	        <execution>
-		     <id>process</id>
-		     <goals>
-		       <goal>process</goal>
-		     </goals>
-		     <phase>generate-sources</phase>
-		     <configuration>
-               <compilerArguments>-Aopenjpa.source=7 -Aopenjpa.metamodel=true</compilerArguments>
-		       <processors>
-		         <processor>org.apache.openjpa.persistence.meta.AnnotationProcessor6</processor>
-	           </processors>
-               <outputDirectory>target/generated-sources/metamodel</outputDirectory>
-		     </configuration>
-            </execution>
-	    </executions>
-		   <dependencies>
-		     <dependency>
-		       <groupId>org.apache.openjpa</groupId>
-		       <artifactId>openjpa</artifactId>
-		       <version>${cxf.openjpa.version}</version>
-		     </dependency>
-		   </dependencies>
-		 </plugin>
-		 <plugin>
-		  <groupId>org.codehaus.mojo</groupId>
-		  <artifactId>build-helper-maven-plugin</artifactId>
-		  <version>1.10</version>
-		  <executions>
-		    <execution>
-		      <id>add-source</id>
-		      <phase>generate-sources</phase>
-		      <goals>
-			<goal>add-source</goal>
-		      </goals>
-		      <configuration>
-			<sources>
-			  <source>target/generated-sources/metamodel</source>
-			</sources>
-		      </configuration>
-		    </execution>
-		  </executions>
-		 </plugin>
-            <!--  
-            <plugin>
-                <groupId>org.apache.openjpa</groupId>
-                <artifactId>openjpa-maven-plugin</artifactId>
-                <version>${cxf.openjpa.version}</version>
-                <configuration>
-                    <includes>
-                       org/apache/cxf/rs/security/oidc/idp/OidcUserSubject.class,
-                       org/apache/cxf/rs/security/oauth2/common/Client.class,
-                       org/apache/cxf/rs/security/oauth2/common/UserSubject.class,
-                       org/apache/cxf/rs/security/oauth2/grants/code/AuthorizationCodeGrant,
-                       org/apache/cxf/rs/security/oauth2/grants/code/ServerAuthorizationCodeGrant.class,
-                       org/apache/cxf/rs/security/oauth2/tokens/bearer/BearerAccessToken.class,
-                       org/apache/cxf/rs/security/oauth2/common/ServerAccessToken.class,
-                       org/apache/cxf/rs/security/oauth2/common/AccessToken.class,
-                       org/apache/cxf/rs/security/oauth2/tokens/refresh/RefreshToken.class,
-                       org/apache/cxf/rs/security/oauth2/common/OAuthPermission.class
-                    </includes>
-                </configuration>
-                <executions>
-                    <execution>
-                        <id>enhancer</id>
-                        <phase>process-test-classes</phase>
-                        <goals>
-                            <goal>test-enhance</goal>
-                        </goals>
-                    </execution>
-                </executions>
-            </plugin>
-            -->
-        </plugins>
-      </build>
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+  <modelVersion>4.0.0</modelVersion>
+  <artifactId>cxf-rt-rs-security-sso-oidc</artifactId>
+  <packaging>bundle</packaging>
+  <name>Apache CXF Runtime OpenId Connect</name>
+  <description>Apache CXF Runtime OpenId Connect</description>
+  <url>http://cxf.apache.org</url>
+  <parent>
+    <groupId>org.apache.cxf</groupId>
+    <artifactId>cxf-parent</artifactId>
+    <version>3.2.0-SNAPSHOT</version>
+    <relativePath>../../../../../parent/pom.xml</relativePath>
+  </parent>
+  <properties>
+    <hibernate.em.version>4.1.0.Final</hibernate.em.version>
+    <hsqldb.version>1.8.0.10</hsqldb.version>
+  </properties>
+  <dependencies>
+    <dependency>
+      <groupId>org.apache.cxf</groupId>
+      <artifactId>cxf-rt-rs-security-oauth2</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.apache.cxf</groupId>
+      <artifactId>cxf-rt-rs-security-jose-jaxrs</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>org.apache.geronimo.specs</groupId>
+      <artifactId>geronimo-jpa_2.0_spec</artifactId>
+      <version>${cxf.geronimo.jpa.version}</version>
+      <scope>provided</scope>
+      <optional>true</optional>
+    </dependency>
+    <!--test dependencies-->
+    <dependency>
+      <groupId>junit</groupId>
+      <artifactId>junit</artifactId>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.easymock</groupId>
+      <artifactId>easymock</artifactId>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>hsqldb</groupId>
+      <artifactId>hsqldb</artifactId>
+      <version>${hsqldb.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.apache.openjpa</groupId>
+      <artifactId>openjpa</artifactId>
+      <version>${cxf.openjpa.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.hibernate</groupId>
+      <artifactId>hibernate-entitymanager</artifactId>
+      <version>${hibernate.em.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.hibernate</groupId>
+      <artifactId>hibernate-ehcache</artifactId>
+      <version>${hibernate.em.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.springframework</groupId>
+      <artifactId>spring-aop</artifactId>
+      <version>${cxf.spring.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.springframework</groupId>
+      <artifactId>spring-context</artifactId>
+      <version>${cxf.spring.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.springframework</groupId>
+      <artifactId>spring-orm</artifactId>
+      <version>${cxf.spring.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.springframework</groupId>
+      <artifactId>spring-test</artifactId>
+      <version>${cxf.spring.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.springframework</groupId>
+      <artifactId>spring-tx</artifactId>
+      <version>${cxf.spring.version}</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.aspectj</groupId>
+      <artifactId>aspectjweaver</artifactId>
+      <version>1.8.7</version>
+      <scope>test</scope>
+    </dependency>
+    <dependency>
+      <groupId>org.slf4j</groupId>
+      <artifactId>jcl-over-slf4j</artifactId>
+      <version>${cxf.slf4j.version}</version>
+      <scope>test</scope>
+    </dependency>
+  </dependencies>
+  <build>
+    <plugins>
+      <plugin>
+        <groupId>org.bsc.maven</groupId>
+        <artifactId>maven-processor-plugin</artifactId>
+        <version>3.1.0</version>
+        <executions>
+          <execution>
+            <id>process</id>
+            <goals>
+              <goal>process</goal>
+            </goals>
+            <phase>generate-sources</phase>
+            <configuration>
+              <compilerArguments>-Aopenjpa.source=7 -Aopenjpa.metamodel=true</compilerArguments>
+              <processors>
+                <processor>org.apache.openjpa.persistence.meta.AnnotationProcessor6</processor>
+              </processors>
+              <outputDirectory>target/generated-sources/metamodel</outputDirectory>
+            </configuration>
+          </execution>
+        </executions>
+        <dependencies>
+          <dependency>
+            <groupId>org.apache.openjpa</groupId>
+            <artifactId>openjpa</artifactId>
+            <version>${cxf.openjpa.version}</version>
+          </dependency>
+        </dependencies>
+      </plugin>
+      <plugin>
+        <groupId>org.codehaus.mojo</groupId>
+        <artifactId>build-helper-maven-plugin</artifactId>
+        <version>1.10</version>
+        <executions>
+          <execution>
+            <id>add-source</id>
+            <phase>generate-sources</phase>
+            <goals>
+              <goal>add-source</goal>
+            </goals>
+            <configuration>
+              <sources>
+                <source>target/generated-sources/metamodel</source>
+              </sources>
+            </configuration>
+          </execution>
+        </executions>
+      </plugin>
+      <plugin>
+        <groupId>org.apache.maven.plugins</groupId>
+        <artifactId>maven-source-plugin</artifactId>
+        <version>3.0.1</version>
+        <executions>
+          <execution>
+            <id>attach-sources</id>
+            <phase>verify</phase>
+            <goals>
+              <goal>jar-no-fork</goal>
+            </goals>
+          </execution>
+        </executions>
+      </plugin>
+      <!-- this configures the surefire plugin to run your tests with the javaagent enabled -->
+      <!-- (openJPA loadtime weaving) -->
+      <plugin>
+        <groupId>org.apache.maven.plugins</groupId>
+        <artifactId>maven-surefire-plugin</artifactId>
+        <configuration>
+          <argLine>-javaagent:${project.basedir}/target/openjpa-${cxf.openjpa.version}.jar</argLine>
+          <workingDirectory>${project.basedir}/target</workingDirectory>
+        </configuration>
+      </plugin>
+      <!-- this tells maven to copy the openjpa agent jar into your target/ directory -->
+      <!-- where surefire can see it -->
+      <plugin>
+        <groupId>org.apache.maven.plugins</groupId>
+        <artifactId>maven-dependency-plugin</artifactId>
+        <executions>
+          <execution>
+            <id>copy</id>
+            <phase>process-resources</phase>
+            <goals>
+              <goal>copy</goal>
+            </goals>
+            <configuration>
+              <artifactItems>
+                <artifactItem>
+                  <groupId>org.apache.openjpa</groupId>
+                  <artifactId>openjpa</artifactId>
+                  <version>${cxf.openjpa.version}</version>
+                  <outputDirectory>${project.build.directory}</outputDirectory>
+                </artifactItem>
+              </artifactItems>
+            </configuration>
+          </execution>
+        </executions>
+      </plugin>
+    </plugins>
+  </build>
 </project>
diff --git a/rt/rs/security/sso/oidc/src/main/java/org/apache/cxf/rs/security/oidc/idp/OidcUserSubject.java b/rt/rs/security/sso/oidc/src/main/java/org/apache/cxf/rs/security/oidc/idp/OidcUserSubject.java
index cea53199be..c0c4b97716 100644
--- a/rt/rs/security/sso/oidc/src/main/java/org/apache/cxf/rs/security/oidc/idp/OidcUserSubject.java
+++ b/rt/rs/security/sso/oidc/src/main/java/org/apache/cxf/rs/security/oidc/idp/OidcUserSubject.java
@@ -18,7 +18,10 @@
  */
 package org.apache.cxf.rs.security.oidc.idp;
 
+import javax.persistence.Basic;
 import javax.persistence.Entity;
+import javax.persistence.FetchType;
+import javax.persistence.Lob;
 
 import org.apache.cxf.rs.security.oauth2.common.UserSubject;
 import org.apache.cxf.rs.security.oidc.common.IdToken;
@@ -26,34 +29,41 @@ import org.apache.cxf.rs.security.oidc.common.UserInfo;
 
 @Entity
 public class OidcUserSubject extends UserSubject {
-    
+
     private static final long serialVersionUID = 8806727177012442229L;
+
     private IdToken idToken;
+
     private UserInfo userInfo;
-    
+
     public OidcUserSubject() {
-        
+
     }
-    
+
     public OidcUserSubject(String login) {
         super(login);
     }
-    
-    public OidcUserSubject(String login, String id) { 
+
+    public OidcUserSubject(String login, String id) {
         super(login, id);
     }
-    
+
     public OidcUserSubject(UserSubject sub) {
         super(sub);
     }
-    
+
+    @Lob
+    @Basic(fetch = FetchType.EAGER)
     public IdToken getIdToken() {
         return idToken;
     }
+
     public void setIdToken(IdToken idToken) {
         this.idToken = idToken;
     }
 
+    @Lob
+    @Basic(fetch = FetchType.EAGER)
     public UserInfo getUserInfo() {
         return userInfo;
     }
diff --git a/rt/rs/security/sso/oidc/src/test/java/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectCMTOpenJPATest.java b/rt/rs/security/sso/oidc/src/test/java/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectCMTOpenJPATest.java
new file mode 100644
index 0000000000..50d0ddd4c2
--- /dev/null
+++ b/rt/rs/security/sso/oidc/src/test/java/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectCMTOpenJPATest.java
@@ -0,0 +1,55 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements. See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership. The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License. You may obtain a copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied. See the License for the
+ * specific language governing permissions and limitations
+ * under the License.
+ */
+package org.apache.cxf.rs.security.oidc.idp;
+
+import org.apache.cxf.rs.security.oauth2.provider.JPAOAuthDataProvider;
+import org.junit.After;
+import org.junit.Before;
+import org.junit.runner.RunWith;
+import org.springframework.beans.factory.annotation.Autowired;
+import org.springframework.test.annotation.DirtiesContext;
+import org.springframework.test.context.ActiveProfiles;
+import org.springframework.test.context.ContextConfiguration;
+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
+
+@RunWith(SpringJUnit4ClassRunner.class)
+@ContextConfiguration("JPAOidcUserSubjectCMTTest.xml")
+@DirtiesContext
+@ActiveProfiles("openJPA")
+public class JPAOidcUserSubjectCMTOpenJPATest extends JPAOidcUserSubjectTest {
+
+    @Autowired
+    private JPAOAuthDataProvider oauthProvider;
+
+    @Override
+    protected JPAOAuthDataProvider getProvider() {
+        return this.oauthProvider;
+    }
+
+    @Before
+    @Override
+    public void setUp() {
+        initializeProvider(oauthProvider);
+    }
+
+    @After
+    @Override
+    public void tearDown() {
+    }
+}
\ No newline at end of file
diff --git a/rt/rs/security/sso/oidc/src/test/java/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectCMTTest.java b/rt/rs/security/sso/oidc/src/test/java/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectCMTTest.java
new file mode 100644
index 0000000000..00495e1a99
--- /dev/null
+++ b/rt/rs/security/sso/oidc/src/test/java/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectCMTTest.java
@@ -0,0 +1,55 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements. See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership. The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License. You may obtain a copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied. See the License for the
+ * specific language governing permissions and limitations
+ * under the License.
+ */
+package org.apache.cxf.rs.security.oidc.idp;
+
+import org.apache.cxf.rs.security.oauth2.provider.JPAOAuthDataProvider;
+import org.junit.After;
+import org.junit.Before;
+import org.junit.runner.RunWith;
+import org.springframework.beans.factory.annotation.Autowired;
+import org.springframework.test.annotation.DirtiesContext;
+import org.springframework.test.context.ActiveProfiles;
+import org.springframework.test.context.ContextConfiguration;
+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
+
+@RunWith(SpringJUnit4ClassRunner.class)
+@ContextConfiguration("JPAOidcUserSubjectCMTTest.xml")
+@DirtiesContext
+@ActiveProfiles("hibernate")
+public class JPAOidcUserSubjectCMTTest extends JPAOidcUserSubjectTest {
+
+    @Autowired
+    private JPAOAuthDataProvider oauthProvider;
+
+    @Override
+    protected JPAOAuthDataProvider getProvider() {
+        return this.oauthProvider;
+    }
+
+    @Before
+    @Override
+    public void setUp() {
+        initializeProvider(oauthProvider);
+    }
+
+    @After
+    @Override
+    public void tearDown() {
+    }
+}
\ No newline at end of file
diff --git a/rt/rs/security/sso/oidc/src/test/java/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectOpenJPATest.java b/rt/rs/security/sso/oidc/src/test/java/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectOpenJPATest.java
new file mode 100644
index 0000000000..4c7031cd33
--- /dev/null
+++ b/rt/rs/security/sso/oidc/src/test/java/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectOpenJPATest.java
@@ -0,0 +1,27 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements. See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership. The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License. You may obtain a copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied. See the License for the
+ * specific language governing permissions and limitations
+ * under the License.
+ */
+package org.apache.cxf.rs.security.oidc.idp;
+
+public class JPAOidcUserSubjectOpenJPATest extends JPAOidcUserSubjectTest {
+
+    @Override
+    protected String getPersistenceUnitName() {
+        return "testUnitOpenJPA";
+    }
+}
diff --git a/rt/rs/security/sso/oidc/src/test/java/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectTest.java b/rt/rs/security/sso/oidc/src/test/java/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectTest.java
index 4b18902985..b6280d46dd 100644
--- a/rt/rs/security/sso/oidc/src/test/java/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectTest.java
+++ b/rt/rs/security/sso/oidc/src/test/java/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectTest.java
@@ -18,11 +18,7 @@
  */
 package org.apache.cxf.rs.security.oidc.idp;
 
-import java.sql.Connection;
-import java.sql.DriverManager;
 import java.util.Collections;
-
-import javax.persistence.EntityManager;
 import javax.persistence.EntityManagerFactory;
 import javax.persistence.Persistence;
 
@@ -31,7 +27,6 @@ import org.apache.cxf.rs.security.oauth2.common.Client;
 import org.apache.cxf.rs.security.oauth2.common.ServerAccessToken;
 import org.apache.cxf.rs.security.oauth2.provider.JPAOAuthDataProvider;
 import org.apache.cxf.rs.security.oidc.common.IdToken;
-
 import org.junit.After;
 import org.junit.Assert;
 import org.junit.Before;
@@ -39,30 +34,33 @@ import org.junit.Test;
 
 public class JPAOidcUserSubjectTest extends Assert {
     private EntityManagerFactory emFactory;
-    private Connection connection;
     private JPAOAuthDataProvider provider;
+
     @Before
     public void setUp() throws Exception {
         try {
-            Class.forName("org.hsqldb.jdbcDriver");
-            connection = DriverManager.getConnection("jdbc:hsqldb:mem:oauth-jpa", "sa", "");
-        } catch (Exception ex) {
-            ex.printStackTrace();
-            fail("Exception during HSQL database init.");
-        }
-        try {
-            emFactory = Persistence.createEntityManagerFactory("testUnitHibernate");
-            EntityManager em = emFactory.createEntityManager();
+            emFactory = Persistence.createEntityManagerFactory(getPersistenceUnitName());
             provider = new JPAOAuthDataProvider();
-            provider.setEntityManager(em);
-            provider.setSupportedScopes(Collections.singletonMap("a", "A Scope"));
-            provider.setSupportedScopes(Collections.singletonMap("refreshToken", "RefreshToken"));
+            provider.setEntityManagerFactory(emFactory);
+            initializeProvider(provider);
         } catch (Exception ex) {
             ex.printStackTrace();
             fail("Exception during JPA EntityManager creation.");
         }
     }
 
+    protected JPAOAuthDataProvider getProvider() {
+        return provider;
+    }
+
+    protected void initializeProvider(JPAOAuthDataProvider oauthDataProvider) {
+        oauthDataProvider.setSupportedScopes(Collections.singletonMap("a", "A Scope"));
+        oauthDataProvider.setSupportedScopes(Collections.singletonMap("refreshToken", "RefreshToken"));
+    }
+
+    protected String getPersistenceUnitName() {
+        return "testUnitHibernate";
+    }
     
     @Test
     public void testAccessTokenWithOidcUserSubject() {
@@ -79,8 +77,8 @@ public class JPAOidcUserSubjectTest extends Assert {
         oidcSubject.setIdToken(idToken);
         atr.setSubject(oidcSubject);
         
-        ServerAccessToken at = provider.createAccessToken(atr);
-        ServerAccessToken at2 = provider.getAccessToken(at.getTokenKey());
+        ServerAccessToken at = getProvider().createAccessToken(atr);
+        ServerAccessToken at2 = getProvider().getAccessToken(at.getTokenKey());
         assertEquals(at.getTokenKey(), at2.getTokenKey());
                 
         OidcUserSubject oidcSubject2 = (OidcUserSubject)at2.getSubject();
@@ -93,8 +91,8 @@ public class JPAOidcUserSubjectTest extends Assert {
         oidcSubject3.setIdToken(idToken2);
         atr.setSubject(oidcSubject3);
         
-        ServerAccessToken at3 = provider.createAccessToken(atr);
-        ServerAccessToken at4 = provider.getAccessToken(at3.getTokenKey());
+        ServerAccessToken at3 = getProvider().createAccessToken(atr);
+        ServerAccessToken at4 = getProvider().getAccessToken(at3.getTokenKey());
         OidcUserSubject oidcSubject4 = (OidcUserSubject)at4.getSubject();
         assertEquals(c.getClientId(), oidcSubject4.getIdToken().getAudience());
     }
@@ -105,28 +103,26 @@ public class JPAOidcUserSubjectTest extends Assert {
         c.setRedirectUris(Collections.singletonList("http://client/redirect"));
         c.setClientId(clientId);
         c.setResourceOwnerSubject(new OidcUserSubject(userLogin));
-        provider.setClient(c);
+        getProvider().setClient(c);
         return c;
     }
     
     @After
     public void tearDown() throws Exception {
         try {
-            if (provider != null) {
-                provider.close();
-            }
-            if (emFactory != null) {
-                emFactory.close();
+            if (getProvider() != null) {
+                getProvider().close();
             }
         } catch (Throwable ex) {
             ex.printStackTrace();    
         } finally {    
             try {
-                connection.createStatement().execute("SHUTDOWN");
+                if (getProvider() != null) {
+                    getProvider().close();
+                }
             } catch (Throwable ex) {
                 ex.printStackTrace();
             }
         }
     }
-    
 }
diff --git a/rt/rs/security/sso/oidc/src/test/resources/META-INF/persistence.xml b/rt/rs/security/sso/oidc/src/test/resources/META-INF/persistence.xml
index 09666336b0..89a3aa3eb3 100644
--- a/rt/rs/security/sso/oidc/src/test/resources/META-INF/persistence.xml
+++ b/rt/rs/security/sso/oidc/src/test/resources/META-INF/persistence.xml
@@ -2,51 +2,54 @@
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"
              version="2.0">
-   <persistence-unit name="testUnitHibernate" transaction-type="RESOURCE_LOCAL">
-     <provider>org.hibernate.ejb.HibernatePersistence</provider>
-     <class>org.apache.cxf.rs.security.oidc.idp.OidcUserSubject</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.Client</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.UserSubject</class>
-     <class>org.apache.cxf.rs.security.oauth2.grants.code.ServerAuthorizationCodeGrant</class>
-     <class>org.apache.cxf.rs.security.oauth2.grants.code.AuthorizationCodeGrant</class>
-     <class>org.apache.cxf.rs.security.oauth2.tokens.bearer.BearerAccessToken</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.ServerAccessToken</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.AccessToken</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.OAuthPermission</class>
-     <class>org.apache.cxf.rs.security.oauth2.tokens.refresh.RefreshToken</class>
-     <exclude-unlisted-classes>true</exclude-unlisted-classes>
-     <properties>
-        <property name="hibernate.connection.url" value="jdbc:hsqldb:mem:oauth-jpa"/>
-        <property name="hibernate.connection.driver_class" value="org.hsqldb.jdbcDriver"/>
-        <property name="hibernate.dialect" value="org.hibernate.dialect.HSQLDialect"/>
-        <property name="hibernate.hbm2ddl.auto" value="create-drop"/>
-        <property name="hibernate.connection.username" value="sa"/>
-        <property name="hibernate.connection.password" value=""/>
-        <property name="javax.persistence.validation.mode" value="none"/>
-     </properties>
-   </persistence-unit>
-   <!--
-   <persistence-unit name="testUnitOpenJPA" transaction-type="RESOURCE_LOCAL">
-     <provider>org.apache.openjpa.persistence.PersistenceProviderImpl</provider>
-     <class>org.apache.cxf.rs.security.oidc.idp.OidcUserSubject</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.Client</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.UserSubject</class>
-     <class>org.apache.cxf.rs.security.oauth2.grants.code.ServerAuthorizationCodeGrant</class>
-     <class>org.apache.cxf.rs.security.oauth2.grants.code.AuthorizationCodeGrant</class>
-     <class>org.apache.cxf.rs.security.oauth2.tokens.bearer.BearerAccessToken</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.ServerAccessToken</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.AccessToken</class>
-     <class>org.apache.cxf.rs.security.oauth2.common.OAuthPermission</class>
-     <class>org.apache.cxf.rs.security.oauth2.tokens.refresh.RefreshToken</class>
-     <exclude-unlisted-classes>true</exclude-unlisted-classes>
-     <properties>
-        <property name="openjpa.ConnectionURL" value="jdbc:hsqldb:mem:oauth-jpa"/>
-        <property name="openjpa.ConnectionDriverName" value="org.hsqldb.jdbcDriver"/>
-        <property name="openjpa.jdbc.DBDictionary" value="hsql" />
-        <property name="openjpa.ConnectionUserName" value="sa"/>
-        <property name="openjpa.ConnectionPassword" value=""/>
-        <property name="openjpa.jdbc.SynchronizeMappings" value="buildSchema"/>
-     </properties>
+    <persistence-unit name="testUnitHibernate" transaction-type="RESOURCE_LOCAL">
+        <provider>org.hibernate.ejb.HibernatePersistence</provider>
+        <class>org.apache.cxf.rs.security.oidc.idp.OidcUserSubject</class>
+        <class>org.apache.cxf.rs.security.oauth2.common.Client</class>
+        <class>org.apache.cxf.rs.security.oauth2.common.UserSubject</class>
+        <class>org.apache.cxf.rs.security.oauth2.grants.code.ServerAuthorizationCodeGrant</class>
+        <class>org.apache.cxf.rs.security.oauth2.grants.code.AuthorizationCodeGrant</class>
+        <class>org.apache.cxf.rs.security.oauth2.tokens.bearer.BearerAccessToken</class>
+        <class>org.apache.cxf.rs.security.oauth2.common.ServerAccessToken</class>
+        <class>org.apache.cxf.rs.security.oauth2.common.AccessToken</class>
+        <class>org.apache.cxf.rs.security.oauth2.common.OAuthPermission</class>
+        <class>org.apache.cxf.rs.security.oauth2.tokens.refresh.RefreshToken</class>
+        <shared-cache-mode>ENABLE_SELECTIVE</shared-cache-mode>
+        <properties>
+            <property name="hibernate.connection.url" value="jdbc:hsqldb:mem:oauth-jpa"/>
+            <property name="hibernate.connection.driver_class" value="org.hsqldb.jdbcDriver"/>
+            <property name="hibernate.dialect" value="org.hibernate.dialect.HSQLDialect"/>
+            <property name="hibernate.hbm2ddl.auto" value="create-drop"/>
+            <property name="hibernate.connection.username" value="sa"/>
+            <property name="hibernate.connection.password" value=""/>
+            <property name="javax.persistence.validation.mode" value="none"/>
+            <property name="hibernate.cache.region.factory_class"
+                      value="org.hibernate.cache.ehcache.SingletonEhCacheRegionFactory"/>
+            <property name="hibernate.max_fetch_depth" value="3"/>
+        </properties>
     </persistence-unit>
-    -->
+
+    <persistence-unit name="testUnitOpenJPA" transaction-type="RESOURCE_LOCAL">
+      <provider>org.apache.openjpa.persistence.PersistenceProviderImpl</provider>
+      <class>org.apache.cxf.rs.security.oidc.idp.OidcUserSubject</class>
+      <class>org.apache.cxf.rs.security.oauth2.common.Client</class>
+      <class>org.apache.cxf.rs.security.oauth2.common.UserSubject</class>
+      <class>org.apache.cxf.rs.security.oauth2.grants.code.ServerAuthorizationCodeGrant</class>
+      <class>org.apache.cxf.rs.security.oauth2.grants.code.AuthorizationCodeGrant</class>
+      <class>org.apache.cxf.rs.security.oauth2.tokens.bearer.BearerAccessToken</class>
+      <class>org.apache.cxf.rs.security.oauth2.common.ServerAccessToken</class>
+      <class>org.apache.cxf.rs.security.oauth2.common.AccessToken</class>
+      <class>org.apache.cxf.rs.security.oauth2.common.OAuthPermission</class>
+      <class>org.apache.cxf.rs.security.oauth2.tokens.refresh.RefreshToken</class>
+      <exclude-unlisted-classes>true</exclude-unlisted-classes>
+      <properties>
+         <property name="openjpa.ConnectionURL" value="jdbc:hsqldb:mem:oauth-jpa"/>
+         <property name="openjpa.ConnectionDriverName" value="org.hsqldb.jdbcDriver"/>
+         <property name="openjpa.jdbc.DBDictionary" value="hsql" />
+         <property name="openjpa.ConnectionUserName" value="sa"/>
+         <property name="openjpa.ConnectionPassword" value=""/>
+         <property name="openjpa.jdbc.SynchronizeMappings" value="buildSchema"/>
+      </properties>
+     </persistence-unit>
+
 </persistence>
\ No newline at end of file
diff --git a/rt/rs/security/sso/oidc/src/test/resources/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectCMTTest.xml b/rt/rs/security/sso/oidc/src/test/resources/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectCMTTest.xml
new file mode 100644
index 0000000000..c80434a741
--- /dev/null
+++ b/rt/rs/security/sso/oidc/src/test/resources/org/apache/cxf/rs/security/oidc/idp/JPAOidcUserSubjectCMTTest.xml
@@ -0,0 +1,113 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+Licensed to the Apache Software Foundation (ASF) under one
+or more contributor license agreements.  See the NOTICE file
+distributed with this work for additional information
+regarding copyright ownership.  The ASF licenses this file
+to you under the Apache License, Version 2.0 (the
+"License"); you may not use this file except in compliance
+with the License.  You may obtain a copy of the License at
+
+  http://www.apache.org/licenses/LICENSE-2.0
+
+Unless required by applicable law or agreed to in writing,
+software distributed under the License is distributed on an
+"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+KIND, either express or implied.  See the License for the
+specific language governing permissions and limitations
+under the License.
+-->
+<beans xmlns="http://www.springframework.org/schema/beans"
+       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+       xmlns:aop="http://www.springframework.org/schema/aop"
+       xmlns:context="http://www.springframework.org/schema/context"
+       xmlns:tx="http://www.springframework.org/schema/tx"
+       xmlns:util="http://www.springframework.org/schema/util"
+       xsi:schemaLocation="http://www.springframework.org/schema/aop
+                           http://www.springframework.org/schema/aop/spring-aop.xsd
+                           http://www.springframework.org/schema/beans
+                           http://www.springframework.org/schema/beans/spring-beans.xsd
+                           http://www.springframework.org/schema/context
+                           http://www.springframework.org/schema/context/spring-context.xsd
+                           http://www.springframework.org/schema/tx
+                           http://www.springframework.org/schema/tx/spring-tx.xsd
+                           http://www.springframework.org/schema/util
+                           http://www.springframework.org/schema/util/spring-util.xsd">
+
+
+    <bean id="oauthProvider"
+          class="org.apache.cxf.rs.security.oauth2.grants.code.JPACMTCodeDataProvider"
+          init-method="init" destroy-method="close">
+    </bean>
+
+
+    <bean id="transactionManager" class="org.springframework.orm.jpa.JpaTransactionManager">
+        <property name="entityManagerFactory" ref="entityManagerFactory"/>
+    </bean>
+
+    <tx:annotation-driven transaction-manager="transactionManager"/>
+
+    <aop:config proxy-target-class="true">
+        <aop:pointcut id="oauthProviderOperation"
+                      expression="bean(oauthProvider)"/>
+        <aop:advisor advice-ref="txAdvice" pointcut-ref="oauthProviderOperation"/>
+    </aop:config>
+    <tx:advice id="txAdvice" transaction-manager="transactionManager">
+        <tx:attributes>
+            <tx:method name="*"/>
+        </tx:attributes>
+    </tx:advice>
+
+    <beans profile="hibernate">
+        <bean id="entityManagerFactory"
+              class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">
+            <!--
+            <property name="dataSource" ref="dataSource"/>
+            -->
+            <!--<property name="jpaVendorAdapter">-->
+                <!--<bean class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter">-->
+                    <!--<property name="showSql" value="true"/>-->
+                    <!--<property name="generateDdl" value="true"/>-->
+                <!--</bean>-->
+            <!--</property>-->
+            <property name="persistenceUnitName" value="testUnitHibernate"/>
+            <property name="jpaPropertyMap">
+                <map>
+                    <entry key="hibernate.jdbc.fetch_size" value="400"/>
+                    <entry key="hibernate.jdbc.batch_size" value="100"/>
+                    <!--<entry key="hibernate.cache.use_second_level_cache" value="true"/>-->
+                    <!--<entry key="hibernate.cache.region.factory_class" value="org.hibernate.cache.ehcache.EhCacheRegionFactory"/>-->
+                </map>
+            </property>
+        </bean>
+    </beans>
+
+    <beans profile="openJPA">
+        <bean id="entityManagerFactory"
+              class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">
+            <!--
+            <property name="dataSource" ref="dataSource"/>
+            -->
+            <!--<property name="jpaVendorAdapter">-->
+                <!--<bean class="org.springframework.orm.jpa.vendor.OpenJpaVendorAdapter">-->
+                    <!--<property name="showSql" value="true"/>-->
+                    <!--<property name="generateDdl" value="true"/>-->
+                <!--</bean>-->
+            <!--</property>-->
+            <property name="persistenceUnitName" value="testUnitOpenJPA"/>
+            <!--
+            <property name="loadTimeWeaver">
+                <bean class="org.springframework.instrument.classloading.SimpleLoadTimeWeaver"/>
+            </property>
+            -->
+            <!--<property name="jpaPropertyMap">-->
+                <!--<map>-->
+                    <!--<entry key="openjpa.Log" value="slf4j"/>-->
+                    <!--<entry key="openjpa.Log" value="SQL=TRACE"/>-->
+                    <!--<entry key="openjpa.ConnectionFactoryProperties"-->
+                           <!--value="PrintParameters=true, PrettyPrint=true, PrettyPrintLineLength=80"/>-->
+                    <!--<entry key="openjpa.Log" value="DefaultLevel=WARN, Runtime=INFO, Tool=INFO, SQL=TRACE"/>-->
+                <!--</map>-->
+        </bean>
+    </beans>
+</beans>
\ No newline at end of file
