diff --git a/common/common/src/main/java/org/apache/cxf/staxutils/transform/OutTransformWriter.java b/common/common/src/main/java/org/apache/cxf/staxutils/transform/OutTransformWriter.java
index fa90450864..8ff128a486 100644
--- a/common/common/src/main/java/org/apache/cxf/staxutils/transform/OutTransformWriter.java
+++ b/common/common/src/main/java/org/apache/cxf/staxutils/transform/OutTransformWriter.java
@@ -18,6 +18,7 @@
  */
 package org.apache.cxf.staxutils.transform;
 
+import java.util.Deque;
 import java.util.HashMap;
 import java.util.HashSet;
 import java.util.LinkedList;
@@ -38,7 +39,7 @@ public class OutTransformWriter extends DelegatingXMLStreamWriter {
     private QNamesMap elementsMap;
     private Map<QName, QName> appendMap = new HashMap<QName, QName>(5);
     private Map<String, String> nsMap = new HashMap<String, String>(5);
-    private Set<String> writtenUris = new HashSet<String>(2);
+    private Deque<Set<String>> writtenUris = new LinkedList<Set<String>>();
     
     private Set<QName> dropElements;
     private List<Integer> droppingIndexes = new LinkedList<Integer>();
@@ -77,7 +78,7 @@ public class OutTransformWriter extends DelegatingXMLStreamWriter {
         
         uri = value != null ? value : uri;
         
-        if (writtenUris.contains(uri)) {
+        if (writtenUris.getFirst().contains(uri)) {
             return;
         }
         
@@ -89,13 +90,19 @@ public class OutTransformWriter extends DelegatingXMLStreamWriter {
             }
             super.writeNamespace(prefix, uri);
         }
-        writtenUris.add(uri);
-        
+        writtenUris.getFirst().add(uri);
     }
     
     @Override
     public void writeStartElement(String prefix, String local, String uri) throws XMLStreamException {
         currentDepth++;
+        Set<String> s;
+        if (writtenUris.isEmpty()) {
+            s = new HashSet<String>();
+        } else {
+            s = new HashSet<String>(writtenUris.getFirst());
+        }
+        writtenUris.addFirst(s);
         QName currentQName = new QName(uri, local);
         
         QName appendQName = appendMap.get(currentQName);
@@ -119,6 +126,9 @@ public class OutTransformWriter extends DelegatingXMLStreamWriter {
     
     @Override
     public void writeEndElement() throws XMLStreamException {
+        if (!writtenUris.isEmpty()) {
+            writtenUris.removeFirst();
+        }
         --currentDepth;
         if (indexRemoved(droppingIndexes)) {
             return;
