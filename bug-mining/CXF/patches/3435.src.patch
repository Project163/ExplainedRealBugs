diff --git a/rt/ws/security/src/main/java/org/apache/cxf/ws/security/trust/AbstractSTSClient.java b/rt/ws/security/src/main/java/org/apache/cxf/ws/security/trust/AbstractSTSClient.java
index 69c69347c4..eaf44b9d74 100755
--- a/rt/ws/security/src/main/java/org/apache/cxf/ws/security/trust/AbstractSTSClient.java
+++ b/rt/ws/security/src/main/java/org/apache/cxf/ws/security/trust/AbstractSTSClient.java
@@ -27,6 +27,7 @@ import java.security.cert.X509Certificate;
 import java.time.Instant;
 import java.time.ZoneOffset;
 import java.util.ArrayList;
+import java.util.Collection;
 import java.util.HashMap;
 import java.util.Iterator;
 import java.util.List;
@@ -75,6 +76,7 @@ import org.apache.cxf.interceptor.Fault;
 import org.apache.cxf.interceptor.Interceptor;
 import org.apache.cxf.interceptor.InterceptorProvider;
 import org.apache.cxf.jaxws.JaxWsProxyFactoryBean;
+import org.apache.cxf.message.Attachment;
 import org.apache.cxf.message.Message;
 import org.apache.cxf.phase.PhaseInterceptorChain;
 import org.apache.cxf.rt.security.claims.ClaimCollection;
@@ -873,7 +875,10 @@ public abstract class AbstractSTSClient implements Configurable, InterceptorProv
 
         Object[] obj = client.invoke(boi, new DOMSource(writer.getDocument().getDocumentElement()));
 
-        return new STSResponse((DOMSource)obj[0], requestorEntropy, cert, crypto);
+        @SuppressWarnings("unchecked")
+        Collection<Attachment> attachments =
+        (Collection<Attachment>)client.getResponseContext().get(Message.ATTACHMENTS);
+        return new STSResponse((DOMSource)obj[0], requestorEntropy, cert, crypto, attachments);
     }
 
     /**
@@ -1093,7 +1098,10 @@ public abstract class AbstractSTSClient implements Configurable, InterceptorProv
 
         Object[] obj = client.invoke(boi, new DOMSource(writer.getDocument().getDocumentElement()));
 
-        return new STSResponse((DOMSource)obj[0], null);
+        @SuppressWarnings("unchecked")
+        Collection<Attachment> attachments =
+            (Collection<Attachment>)client.getResponseContext().get(Message.ATTACHMENTS);
+        return new STSResponse((DOMSource)obj[0], null, null, null, attachments);
     }
 
     protected PrimitiveAssertion getAddressingAssertion() {
@@ -1166,7 +1174,10 @@ public abstract class AbstractSTSClient implements Configurable, InterceptorProv
 
             Object[] o = client.invoke(boi, new DOMSource(writer.getDocument().getDocumentElement()));
 
-            return new STSResponse((DOMSource)o[0], null);
+            @SuppressWarnings("unchecked")
+            Collection<Attachment> attachments =
+                (Collection<Attachment>)client.getResponseContext().get(Message.ATTACHMENTS);
+            return new STSResponse((DOMSource)o[0], null, null, null, attachments);
         }
         if (enableLifetime) {
             addLifetime(writer);
@@ -1213,7 +1224,10 @@ public abstract class AbstractSTSClient implements Configurable, InterceptorProv
 
         Object[] o = client.invoke(boi, new DOMSource(writer.getDocument().getDocumentElement()));
 
-        return new STSResponse((DOMSource)o[0], requestorEntropy, cert, crypto);
+        @SuppressWarnings("unchecked")
+        Collection<Attachment> attachments =
+            (Collection<Attachment>)client.getResponseContext().get(Message.ATTACHMENTS);
+        return new STSResponse((DOMSource)o[0], requestorEntropy, cert, crypto, attachments);
     }
 
     private void writeRenewalSemantics(XMLStreamWriter writer) throws XMLStreamException {
@@ -1791,18 +1805,26 @@ public abstract class AbstractSTSClient implements Configurable, InterceptorProv
         private final byte[] entropy;
         private final X509Certificate cert;
         private final Crypto crypto;
+        private final Collection<Attachment> attachments;
 
         public STSResponse(DOMSource response, byte[] entropy) {
             this(response, entropy, null, null);
         }
 
         public STSResponse(DOMSource response, byte[] entropy, X509Certificate cert, Crypto crypto) {
+            this(response, entropy, cert, crypto, null);
+        }
+
+        public STSResponse(DOMSource response, byte[] entropy, X509Certificate cert,
+                           Crypto crypto, Collection<Attachment> attachments) {
             this.response = response;
             this.entropy = entropy;
             this.cert = cert;
             this.crypto = crypto;
+            this.attachments = attachments;
         }
 
+
         public DOMSource getResponse() {
             return response;
         }
@@ -1818,6 +1840,10 @@ public abstract class AbstractSTSClient implements Configurable, InterceptorProv
         public Crypto getCrypto() {
             return crypto;
         }
+
+        public Collection<Attachment> getAttachments() {
+            return attachments;
+        }
     }
 
     public String getWspNamespace() {
diff --git a/rt/ws/security/src/main/java/org/apache/cxf/ws/security/trust/STSClient.java b/rt/ws/security/src/main/java/org/apache/cxf/ws/security/trust/STSClient.java
index 59e343b9cf..a160b4cd67 100644
--- a/rt/ws/security/src/main/java/org/apache/cxf/ws/security/trust/STSClient.java
+++ b/rt/ws/security/src/main/java/org/apache/cxf/ws/security/trust/STSClient.java
@@ -19,6 +19,7 @@
 
 package org.apache.cxf.ws.security.trust;
 
+import java.util.Collection;
 import java.util.LinkedList;
 import java.util.List;
 import java.util.logging.Level;
@@ -27,10 +28,19 @@ import java.util.logging.Logger;
 import org.w3c.dom.Element;
 
 import org.apache.cxf.Bus;
+import org.apache.cxf.attachment.AttachmentUtil;
 import org.apache.cxf.common.logging.LogUtils;
 import org.apache.cxf.helpers.DOMUtils;
 import org.apache.cxf.interceptor.Fault;
+import org.apache.cxf.message.Attachment;
+import org.apache.cxf.message.Message;
+import org.apache.cxf.phase.PhaseInterceptorChain;
 import org.apache.cxf.ws.security.tokenstore.SecurityToken;
+import org.apache.cxf.ws.security.wss4j.AttachmentCallbackHandler;
+import org.apache.wss4j.common.ext.WSSecurityException;
+import org.apache.wss4j.common.util.XMLUtils;
+import org.apache.wss4j.dom.WSConstants;
+import org.apache.wss4j.dom.util.WSSecurityUtil;
 
 /**
  * A extension of AbstractSTSClient to communicate with an STS and return a SecurityToken
@@ -62,6 +72,7 @@ public class STSClient extends AbstractSTSClient {
 
         SecurityToken token =
             createSecurityToken(getDocumentElement(response.getResponse()), response.getEntropy());
+        inlineAttachments(token, response.getAttachments());
 
         if (response.getCert() != null) {
             token.setX509Certificate(response.getCert(), response.getCrypto());
@@ -81,6 +92,8 @@ public class STSClient extends AbstractSTSClient {
         STSResponse response = renew(tok);
 
         SecurityToken token = createSecurityToken(getDocumentElement(response.getResponse()), null);
+        inlineAttachments(token, response.getAttachments());
+
         if (token.getTokenType() == null) {
             String tokenTypeFromTemplate = getTokenTypeFromTemplate();
             if (tokenTypeFromTemplate != null) {
@@ -100,6 +113,19 @@ public class STSClient extends AbstractSTSClient {
         return validateSecurityToken(tok, validateTokenType);
     }
 
+    private void inlineAttachments(SecurityToken token, Collection<Attachment> attachments) throws WSSecurityException {
+        Message msg = PhaseInterceptorChain.getCurrentMessage();
+        if (AttachmentUtil.isMtomEnabled(msg) && attachments != null) {
+            Element requestedSecurityTokenElement = token.getToken();
+            if (requestedSecurityTokenElement != null) {
+                // Look for xop:Include Nodes + inline the contents
+                List<Element> includeElements =
+                    XMLUtils.findElements(requestedSecurityTokenElement.getFirstChild(), "Include", WSConstants.XOP_NS);
+                WSSecurityUtil.inlineAttachments(includeElements, new AttachmentCallbackHandler(attachments), true);
+            }
+        }
+    }
+
     protected List<SecurityToken> validateSecurityToken(SecurityToken tok, String tokentype)
         throws Exception {
         STSResponse response = validate(tok, tokentype);
diff --git a/rt/ws/security/src/main/java/org/apache/cxf/ws/security/wss4j/AttachmentCallbackHandler.java b/rt/ws/security/src/main/java/org/apache/cxf/ws/security/wss4j/AttachmentCallbackHandler.java
index 299e1ff4c5..fae53c4866 100644
--- a/rt/ws/security/src/main/java/org/apache/cxf/ws/security/wss4j/AttachmentCallbackHandler.java
+++ b/rt/ws/security/src/main/java/org/apache/cxf/ws/security/wss4j/AttachmentCallbackHandler.java
@@ -43,10 +43,17 @@ import org.apache.wss4j.common.ext.AttachmentResultCallback;
  */
 public class AttachmentCallbackHandler implements CallbackHandler {
 
-    private final Message message;
+    private final Collection<org.apache.cxf.message.Attachment> attachments;
 
     public AttachmentCallbackHandler(Message message) {
-        this.message = message;
+        if (message.getAttachments() == null) {
+            message.setAttachments(new ArrayList<Attachment>());
+        }
+        attachments = message.getAttachments();
+    }
+
+    public AttachmentCallbackHandler(Collection<org.apache.cxf.message.Attachment> attachments) {
+        this.attachments = attachments;
     }
 
     @Override
@@ -67,12 +74,6 @@ public class AttachmentCallbackHandler implements CallbackHandler {
             } else if (callback instanceof AttachmentResultCallback) {
                 AttachmentResultCallback attachmentResultCallback = (AttachmentResultCallback) callback;
 
-                if (message.getAttachments() == null) {
-                    message.setAttachments(new ArrayList<Attachment>());
-                }
-
-                final Collection<org.apache.cxf.message.Attachment> attachments = message.getAttachments();
-
                 org.apache.cxf.attachment.AttachmentImpl securedAttachment =
                     new org.apache.cxf.attachment.AttachmentImpl(
                         attachmentResultCallback.getAttachmentId(),
@@ -93,7 +94,6 @@ public class AttachmentCallbackHandler implements CallbackHandler {
                 AttachmentRemovalCallback attachmentRemovalCallback = (AttachmentRemovalCallback) callback;
                 String attachmentId = attachmentRemovalCallback.getAttachmentId();
                 if (attachmentId != null) {
-                    final Collection<org.apache.cxf.message.Attachment> attachments = message.getAttachments();
                     // Calling LazyAttachmentCollection.size() here to force it to load the attachments
                     if (attachments != null && attachments.size() > 0) {  // NOPMD
                         for (Iterator<org.apache.cxf.message.Attachment> iterator = attachments.iterator();
@@ -118,7 +118,6 @@ public class AttachmentCallbackHandler implements CallbackHandler {
         String attachmentId,
         boolean removeAttachments
     ) throws IOException {
-        final Collection<org.apache.cxf.message.Attachment> attachments = message.getAttachments();
         // Calling LazyAttachmentCollection.size() here to force it to load the attachments
         if (attachments != null && attachments.size() > 0) { // NOPMD
             for (Iterator<org.apache.cxf.message.Attachment> iterator = attachments.iterator();
