diff --git a/services/sts/sts-core/src/main/java/org/apache/cxf/sts/operation/AbstractOperation.java b/services/sts/sts-core/src/main/java/org/apache/cxf/sts/operation/AbstractOperation.java
index e743c66fef..7a1e420c34 100644
--- a/services/sts/sts-core/src/main/java/org/apache/cxf/sts/operation/AbstractOperation.java
+++ b/services/sts/sts-core/src/main/java/org/apache/cxf/sts/operation/AbstractOperation.java
@@ -189,14 +189,6 @@ public abstract class AbstractOperation {
         SecurityTokenReferenceType securityTokenReferenceType = 
             QNameConstants.WSSE_FACTORY.createSecurityTokenReferenceType();
         
-        // Create the identifier according to whether it is an attached reference or not
-        String identifier = tokenReference.getIdentifier();
-        if (attached && identifier.charAt(0) != '#') {
-            identifier = "#" + identifier;
-        } else if (!attached && identifier.charAt(0) == '#') {
-            identifier = identifier.substring(1);
-        }
-        
         // TokenType
         String tokenType = tokenReference.getWsse11TokenType();
         if (tokenType != null) {
@@ -204,6 +196,11 @@ public abstract class AbstractOperation {
         }
         
         if (tokenReference.isUseKeyIdentifier()) {
+            String identifier = tokenReference.getIdentifier();
+            if (identifier.charAt(0) == '#') {
+                identifier = identifier.substring(1);
+            }
+            
             KeyIdentifierType keyIdentifierType = 
                 QNameConstants.WSSE_FACTORY.createKeyIdentifierType();
             keyIdentifierType.setValue(identifier);
@@ -215,6 +212,13 @@ public abstract class AbstractOperation {
                 QNameConstants.WSSE_FACTORY.createKeyIdentifier(keyIdentifierType);
             securityTokenReferenceType.getAny().add(keyIdentifier);
         } else if (tokenReference.isUseDirectReference()) {
+            String identifier = tokenReference.getIdentifier();
+            if (attached && identifier.charAt(0) != '#') {
+                identifier = "#" + identifier;
+            } else if (!attached && identifier.charAt(0) == '#') {
+                identifier = identifier.substring(1);
+            }
+            
             ReferenceType referenceType = QNameConstants.WSSE_FACTORY.createReferenceType();
             referenceType.setURI(identifier);
             
diff --git a/services/sts/systests/basic/src/test/resources/org/apache/cxf/systest/sts/asymmetric/cxf-service.xml b/services/sts/systests/basic/src/test/resources/org/apache/cxf/systest/sts/asymmetric/cxf-service.xml
index 45386016df..7c3506b168 100644
--- a/services/sts/systests/basic/src/test/resources/org/apache/cxf/systest/sts/asymmetric/cxf-service.xml
+++ b/services/sts/systests/basic/src/test/resources/org/apache/cxf/systest/sts/asymmetric/cxf-service.xml
@@ -52,6 +52,7 @@
          <entry key="ws-security.callback-handler" 
                 value="org.apache.cxf.systest.sts.common.CommonCallbackHandler"/>
          <entry key="ws-security.signature.properties" value="serviceKeystore.properties"/>
+         <entry key="ws-security.is-bsp-compliant" value="false"/>
       </jaxws:properties> 
    </jaxws:endpoint>
    
