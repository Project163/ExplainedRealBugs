{"url":"https://api.github.com/repos/Kludex/uvicorn/issues/244","repository_url":"https://api.github.com/repos/Kludex/uvicorn","labels_url":"https://api.github.com/repos/Kludex/uvicorn/issues/244/labels{/name}","comments_url":"https://api.github.com/repos/Kludex/uvicorn/issues/244/comments","events_url":"https://api.github.com/repos/Kludex/uvicorn/issues/244/events","html_url":"https://github.com/Kludex/uvicorn/issues/244","id":380869978,"node_id":"MDU6SXNzdWUzODA4Njk5Nzg=","number":244,"title":"TypeError when connection is closed in connect()","user":{"login":"ostcar","id":977937,"node_id":"MDQ6VXNlcjk3NzkzNw==","avatar_url":"https://avatars.githubusercontent.com/u/977937?v=4","gravatar_id":"","url":"https://api.github.com/users/ostcar","html_url":"https://github.com/ostcar","followers_url":"https://api.github.com/users/ostcar/followers","following_url":"https://api.github.com/users/ostcar/following{/other_user}","gists_url":"https://api.github.com/users/ostcar/gists{/gist_id}","starred_url":"https://api.github.com/users/ostcar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ostcar/subscriptions","organizations_url":"https://api.github.com/users/ostcar/orgs","repos_url":"https://api.github.com/users/ostcar/repos","events_url":"https://api.github.com/users/ostcar/events{/privacy}","received_events_url":"https://api.github.com/users/ostcar/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":616811004,"node_id":"MDU6TGFiZWw2MTY4MTEwMDQ=","url":"https://api.github.com/repos/Kludex/uvicorn/labels/bug","name":"bug","color":"ee0701","default":true,"description":null},{"id":1674450491,"node_id":"MDU6TGFiZWwxNjc0NDUwNDkx","url":"https://api.github.com/repos/Kludex/uvicorn/labels/websockets","name":"websockets","color":"a4f2f4","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":18,"created_at":"2018-11-14T20:19:02Z","updated_at":"2020-12-09T17:06:15Z","closed_at":"2020-12-09T17:06:15Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I have the same problem then #185 but I think, I can reproduce it.\r\n\r\nWhen you close a connection in the connect() method of a WebsocketConsumer, it works fine with daphne but uvicorn raises a TypeError \r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"/home/ossi/src/channels-examples/.venv/lib/python3.7/site-packages/uvicorn/protocols/websockets/websockets_impl.py\", line 140, in run_asgi\r\n    result = await asgi(self.asgi_receive, self.asgi_send)\r\n  File \"/home/ossi/src/channels-examples/.venv/lib/python3.7/site-packages/channels/sessions.py\", line 179, in __call__\r\n    return await self.inner(receive, self.send)\r\n  File \"/home/ossi/src/channels-examples/.venv/lib/python3.7/site-packages/channels/middleware.py\", line 41, in coroutine_call\r\n    await inner_instance(receive, send)\r\n  File \"/home/ossi/src/channels-examples/.venv/lib/python3.7/site-packages/channels/consumer.py\", line 59, in __call__\r\n    [receive, self.channel_receive], self.dispatch\r\n  File \"/home/ossi/src/channels-examples/.venv/lib/python3.7/site-packages/channels/utils.py\", line 59, in await_many_dispatch\r\n    await task\r\n  File \"/home/ossi/src/channels-examples/.venv/lib/python3.7/site-packages/channels/utils.py\", line 51, in await_many_dispatch\r\n    result = task.result()\r\n  File \"/home/ossi/src/channels-examples/.venv/lib/python3.7/site-packages/uvicorn/protocols/websockets/websockets_impl.py\", line 222, in asgi_receive\r\n    data = await self.recv()\r\n  File \"/home/ossi/src/channels-examples/.venv/lib/python3.7/site-packages/websockets/protocol.py\", line 419, in recv\r\n    return_when=asyncio.FIRST_COMPLETED,\r\n  File \"/usr/lib/python3.7/asyncio/tasks.py\", line 361, in wait\r\n    fs = {ensure_future(f, loop=loop) for f in set(fs)}\r\n  File \"/usr/lib/python3.7/asyncio/tasks.py\", line 361, in <setcomp>\r\n    fs = {ensure_future(f, loop=loop) for f in set(fs)}\r\n  File \"/usr/lib/python3.7/asyncio/tasks.py\", line 592, in ensure_future\r\n    raise TypeError('An asyncio.Future, a coroutine or an awaitable is '\r\nTypeError: An asyncio.Future, a coroutine or an awaitable is required\r\n```\r\n\r\nI created this branch on the django-channels-example repository: https://github.com/ostcar/channels-examples/tree/uvicorn-test\r\n\r\nAll I changed was, that the websocket connection is always closed: https://github.com/andrewgodwin/channels-examples/compare/master...ostcar:uvicorn-test\r\n\r\nI think the problem is, that you call `websockets.WebSocketServerProtocol.recv()` before the websocket connection is open so `websockets.WebSocketServerProtocol.connection_open()` was not called. In this case the attribute `transfer_data_task` is still None. So when `websockets.WebSocketServerProtocol.recv()` calls \r\n\r\n```python\r\nyield from asyncio.wait(\r\n                    [pop_message_waiter, self.transfer_data_task],\r\n                    loop=self.loop,\r\n                    return_when=asyncio.FIRST_COMPLETED,\r\n                )\r\n```\r\nit tries to await `None` what causes the exception.\r\n\r\nI don't know, if this is a but in the websockets package or if you should check `self.closed` before calling `self.recv()`\r\n","closed_by":{"login":"florimondmanca","id":15911462,"node_id":"MDQ6VXNlcjE1OTExNDYy","avatar_url":"https://avatars.githubusercontent.com/u/15911462?v=4","gravatar_id":"","url":"https://api.github.com/users/florimondmanca","html_url":"https://github.com/florimondmanca","followers_url":"https://api.github.com/users/florimondmanca/followers","following_url":"https://api.github.com/users/florimondmanca/following{/other_user}","gists_url":"https://api.github.com/users/florimondmanca/gists{/gist_id}","starred_url":"https://api.github.com/users/florimondmanca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/florimondmanca/subscriptions","organizations_url":"https://api.github.com/users/florimondmanca/orgs","repos_url":"https://api.github.com/users/florimondmanca/repos","events_url":"https://api.github.com/users/florimondmanca/events{/privacy}","received_events_url":"https://api.github.com/users/florimondmanca/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/Kludex/uvicorn/issues/244/reactions","total_count":7,"+1":7,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/Kludex/uvicorn/issues/244/timeline","performed_via_github_app":null,"state_reason":"completed"}