{"url":"https://api.github.com/repos/Kludex/uvicorn/issues/1326","repository_url":"https://api.github.com/repos/Kludex/uvicorn","labels_url":"https://api.github.com/repos/Kludex/uvicorn/issues/1326/labels{/name}","comments_url":"https://api.github.com/repos/Kludex/uvicorn/issues/1326/comments","events_url":"https://api.github.com/repos/Kludex/uvicorn/issues/1326/events","html_url":"https://github.com/Kludex/uvicorn/issues/1326","id":1104831727,"node_id":"I_kwDOBYpCG85B2mTv","number":1326,"title":"Interactions between --reload-dir, --reload-include, and --reload-exclude are not very intuitive or well explained (and may even be wrong)","user":{"login":"posita","id":222581,"node_id":"MDQ6VXNlcjIyMjU4MQ==","avatar_url":"https://avatars.githubusercontent.com/u/222581?v=4","gravatar_id":"","url":"https://api.github.com/users/posita","html_url":"https://github.com/posita","followers_url":"https://api.github.com/users/posita/followers","following_url":"https://api.github.com/users/posita/following{/other_user}","gists_url":"https://api.github.com/users/posita/gists{/gist_id}","starred_url":"https://api.github.com/users/posita/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/posita/subscriptions","organizations_url":"https://api.github.com/users/posita/orgs","repos_url":"https://api.github.com/users/posita/repos","events_url":"https://api.github.com/users/posita/events{/privacy}","received_events_url":"https://api.github.com/users/posita/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2022-01-15T19:50:54Z","updated_at":"2024-05-14T01:53:26Z","closed_at":"2022-02-14T17:20:10Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Checklist\r\n\r\n- [X] The bug is reproducible against the latest release or `master`.\r\n- [X] There are no similar issues or pull requests to fix it yet.\r\n\r\n### Describe the bug\r\n\r\nI am trying to get `uvicorn` to automatically reload in a dev environment based on source file changes and config file changes. I have two Python src directories (`/path/to/first_dir` and `/path/to/second_dir`) and a config directory (`/path/to/env_dir`) which contains `*.env` files that my application loads.\r\n\r\nIt is _**really**_ hard to understand what `uvicorn` intends to do, much less what it actually does with regard to tuned reload behavior. Consider:\r\n\r\n``` sh\r\n% uvicorn \\\r\n     --reload \\\r\n     --reload-exclude '*_flymake.py' \\\r\n     --reload-exclude 'flycheck_*.py' \\\r\n     --reload-dir /path/to/first_dir \\\r\n     --reload-dir /path/to/second_dir \\\r\n     mm.txns.main:app\r\n```\r\n\r\n~~The above will _**only**_ ignore files matching `*_flymake.py` and `flycheck_*.py` in `/path/to/first_dir`, _**not**_ `/path/to/second_dir`. So it looks like one needs to repeat the exclude patterns prior to each `--reload-dir`:~~ _UPDATE: This wasn't correct. It turns out_ nothing _was being excluded in this configuration because watchgod was not installed. This confusion is part of the bug._\r\n\r\n``` sh\r\n% uvicorn \\\r\n     --reload \\\r\n     --reload-exclude '*_flymake.py' \\\r\n     --reload-exclude 'flycheck_*.py' \\\r\n     --reload-dir /path/to/first_dir \\\r\n     --reload-exclude '*_flymake.py' \\\r\n     --reload-exclude 'flycheck_*.py' \\\r\n     --reload-dir /path/to/second_dir \\\r\n     mm.txns.main:app\r\n```\r\n\r\n~~There is no mention of the need for repeated uses of `--reload-exclude` _**in advance of**_ any `--reload-dir` options that I can find.~~\r\n\r\nFurther, (in what I am perceiving as a contradiction of the docs), this won't work:\r\n\r\n``` sh\r\n% uvicorn \\\r\n     --reload \\\r\n     --reload-exclude '*_flymake.py' \\\r\n     --reload-exclude 'flycheck_*.py' \\\r\n     --reload-dir /path/to/first_dir \\\r\n     --reload-exclude '*_flymake.py' \\\r\n     --reload-exclude 'flycheck_*.py' \\\r\n     --reload-dir /path/to/second_dir \\\r\n     --reload-include '*.env' \\\r\n     --reload-dir /path/to/env_dir \\\r\n     mm.txns.main:app\r\n```\r\n\r\nAdding, deleting, or modifying `/path/to/env_dir/foo.env` will _**not**_ trigger a reload.\r\n\r\nThe [documentation for ``--reload-exclude``](https://www.uvicorn.org/settings/#development) makes it clear (or at least strongly suggests) I should be able to expand the patterns matched for reload detection (**_emphasis_** mine):\r\n\r\n> `--reload-exclude <glob-pattern>` - Specify a glob pattern to match files or directories which will excluded from watching. May be used multiple times. By default the following patterns are excluded: `.*, .py[cod], .sw.*, ~*`. **_These defaults can be overwritten by including them in `--reload-include`._**\r\n\r\nThat's not what I'm seeing by including `*.env` files. Then there's this, which seems to contradict the inclusion docs (**_emphasis_** mine):\r\n\r\n> By default Uvicorn uses simple changes detection strategy that compares **_python files_** modification times few times a second. If … or you need watching of **_non python files_** you can install [watchgod](https://pypi.org/project/watchgod/) or install uvicorn with `uvicorn[standard]`, which will include watchgod.\r\n\r\nDoes that mean there's some \"upper bound\" of patterns uvicorn is capable of considering? Is it `*.py`? That can't be correct, because the counterexample explicitly states that `*.py[cod]` is excluded by default, but could be included via `--reload-include`. It's not clear where the limitations are, even after spending dozens of minutes reading, re-reading, re-re-reading, experimenting, etc.\r\n\r\nIf the answer is, \"Use watchgod,\" I can't find any documentation of how to do that or what additional configuration steps I would need to meet my use case.\r\n\r\n### Environment\r\n\r\n[root@localhost vagrant]# uname -a\r\nLinux localhost.localdomain 5.4.17-2136.300.7.el8uek.x86_64 #2 SMP Fri Oct 8 16:23:01 PDT 2021 x86_64 x86_64 x86_64 GNU/Linux\r\n[root@localhost vagrant]# /opt/local/app/bin/uvicorn --version\r\nRunning uvicorn 0.16.0 with CPython 3.9.6 on Linux\r\n\r\n### Additional context\r\n\r\nI'm not the only person to be confused by this. [This StackOverflow question](https://stackoverflow.com/questions/64118680/reload-flag-with-uvicorn-can-we-exclude-certain-code#comment123408591_64118929) poses something very similar, but remains unanswered:\r\n\r\n> Could you advise on how to exclude [\\*.json] using this method while preserving the reload functionality? I tried: [uvicorn main:app --reload-exclude '\\*.json'] however it generated this warning: WARNING: Current configuration will not reload as not all conditions are met, please refer to documentation.\r\n\r\nWhen I [misfiled this against gunicorn](https://github.com/benoitc/gunicorn/issues/2722) in a fit of blindess, I noted that [this comment](https://github.com/benoitc/gunicorn/issues/2339#issuecomment-651270632) from @Andrew-Chen-Wang suggests there is some magic around merely making watchgod available to uvicorn, but fails to go into additional detail, so I have no way of verifying it (at least not without digging into a lot of code), much less figuring out how I can take advantage:\r\n\r\n> … [I]f you have watchgod installed, uvicorn should automatically pick that up to make the reloading process better. …\r\n\r\nHe responded with:\r\n\r\n> … In terms of resolving the issue, I believe you're not supposed to reuse reload-include several times. Instead, wrap all your values in double quotes and make them csv\r\n\r\nIf that's true, it's also not clear from the docs. It also doesn't help me, since I'm only using `--reload-include` once. (The above use of `--reload-exclude` multiple times does appear to get the behavior I want with respect to excluding various files/directories.)\r\n\r\n_UPDATE: I'm pretty sure the single, comma-separated argument advice is wrong. [This strongly suggests](https://github.com/encode/uvicorn/blob/27f76476a14dac68a62dc2998717997607a36197/uvicorn/main.py#L85-L99) one should be able to provide `--reload-include` and `--reload-exclude` multiple times via the command line._","closed_by":{"login":"euri10","id":1104190,"node_id":"MDQ6VXNlcjExMDQxOTA=","avatar_url":"https://avatars.githubusercontent.com/u/1104190?v=4","gravatar_id":"","url":"https://api.github.com/users/euri10","html_url":"https://github.com/euri10","followers_url":"https://api.github.com/users/euri10/followers","following_url":"https://api.github.com/users/euri10/following{/other_user}","gists_url":"https://api.github.com/users/euri10/gists{/gist_id}","starred_url":"https://api.github.com/users/euri10/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/euri10/subscriptions","organizations_url":"https://api.github.com/users/euri10/orgs","repos_url":"https://api.github.com/users/euri10/repos","events_url":"https://api.github.com/users/euri10/events{/privacy}","received_events_url":"https://api.github.com/users/euri10/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/Kludex/uvicorn/issues/1326/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/Kludex/uvicorn/issues/1326/timeline","performed_via_github_app":null,"state_reason":"completed"}