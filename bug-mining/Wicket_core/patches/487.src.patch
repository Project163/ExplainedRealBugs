diff --git a/wicket-core/src/main/java/org/apache/wicket/Component.java b/wicket-core/src/main/java/org/apache/wicket/Component.java
index 38ea4b9890..ebadba28e5 100644
--- a/wicket-core/src/main/java/org/apache/wicket/Component.java
+++ b/wicket-core/src/main/java/org/apache/wicket/Component.java
@@ -64,6 +64,8 @@ import org.apache.wicket.request.handler.ListenerInterfaceRequestHandler;
 import org.apache.wicket.request.handler.PageAndComponentProvider;
 import org.apache.wicket.request.mapper.parameter.PageParameters;
 import org.apache.wicket.request.resource.ResourceReference;
+import org.apache.wicket.resource.header.StringHeaderItem;
+import org.apache.wicket.response.StringResponse;
 import org.apache.wicket.settings.IDebugSettings;
 import org.apache.wicket.util.IHierarchical;
 import org.apache.wicket.util.convert.IConverter;
@@ -2671,10 +2673,20 @@ public abstract class Component
 			// Allow component to contribute
 			if (response.wasRendered(this) == false)
 			{
-				// Make sure the markup source strategy contributes to the header first
-				// to be backward compatible. WICKET-3761
-				getMarkupSourcingStrategy().renderHead(this, container);
-
+				StringResponse markupHeaderResponse = new StringResponse();
+				Response oldResponse = getResponse();
+				RequestCycle.get().setResponse(markupHeaderResponse);
+				try
+				{
+					// Make sure the markup source strategy contributes to the header first
+					// to be backward compatible. WICKET-3761
+					getMarkupSourcingStrategy().renderHead(this, container);
+					response.render(StringHeaderItem.forString(markupHeaderResponse.getBuffer()));
+				} 
+				finally
+				{
+					RequestCycle.get().setResponse(oldResponse);
+				}
 				// Then let the component itself to contribute to the header
 				renderHead(this, response);
 
diff --git a/wicket-core/src/main/java/org/apache/wicket/MarkupContainer.java b/wicket-core/src/main/java/org/apache/wicket/MarkupContainer.java
index be32e58f40..621ea050bc 100644
--- a/wicket-core/src/main/java/org/apache/wicket/MarkupContainer.java
+++ b/wicket-core/src/main/java/org/apache/wicket/MarkupContainer.java
@@ -1400,7 +1400,7 @@ public abstract class MarkupContainer extends Component implements Iterable<Comp
 	}
 
 	/**
-	 * THIS METHOD IS NOT PART OF THE WICKET PUBLIC API. DO NOT USE IT.
+	 * THIS METHOD IS NOT PART OF THE WICKET PUBLIC API. DO NOT USE OR OVERWRITE IT.
 	 * 
 	 * Renders the next element of markup in the given markup stream.
 	 * 
@@ -1408,7 +1408,7 @@ public abstract class MarkupContainer extends Component implements Iterable<Comp
 	 *            The markup stream
 	 * @return true, if element was rendered as RawMarkup
 	 */
-	protected final boolean renderNext(final MarkupStream markupStream)
+	protected boolean renderNext(final MarkupStream markupStream)
 	{
 		// Get the current markup element
 		final MarkupElement element = markupStream.get();
diff --git a/wicket-core/src/main/java/org/apache/wicket/markup/html/WebPage.java b/wicket-core/src/main/java/org/apache/wicket/markup/html/WebPage.java
index 8dff61d2de..3cb71368a0 100644
--- a/wicket-core/src/main/java/org/apache/wicket/markup/html/WebPage.java
+++ b/wicket-core/src/main/java/org/apache/wicket/markup/html/WebPage.java
@@ -269,7 +269,7 @@ public class WebPage extends Page
 				getRequestCycle().setResponse(response);
 
 				// Render all header sections of all components on the page
-				AbstractHeaderRenderStrategy.get().renderHeader(header, getPage());
+				AbstractHeaderRenderStrategy.get().renderHeader(header, null, getPage());
 				response.close();
 
 				if (response.getBuffer().length() > 0)
diff --git a/wicket-core/src/main/java/org/apache/wicket/markup/html/internal/HtmlHeaderContainer.java b/wicket-core/src/main/java/org/apache/wicket/markup/html/internal/HtmlHeaderContainer.java
index ffab069bbc..fd0447e114 100644
--- a/wicket-core/src/main/java/org/apache/wicket/markup/html/internal/HtmlHeaderContainer.java
+++ b/wicket-core/src/main/java/org/apache/wicket/markup/html/internal/HtmlHeaderContainer.java
@@ -32,6 +32,8 @@ import org.apache.wicket.markup.html.IHeaderResponse;
 import org.apache.wicket.markup.html.TransparentWebMarkupContainer;
 import org.apache.wicket.markup.renderStrategy.AbstractHeaderRenderStrategy;
 import org.apache.wicket.request.Response;
+import org.apache.wicket.request.cycle.RequestCycle;
+import org.apache.wicket.resource.header.StringHeaderItem;
 import org.apache.wicket.response.StringResponse;
 
 
@@ -83,6 +85,40 @@ public class HtmlHeaderContainer extends TransparentWebMarkupContainer
 	 */
 	private transient IHeaderResponse headerResponse = null;
 
+	/**
+	 * Combines the {@link MarkupStream} with the open tag, together representing the header section
+	 * in the markup.
+	 * 
+	 * @author papegaaij
+	 */
+	public static class HeaderStreamState
+	{
+		private MarkupStream markupStream;
+		private ComponentTag openTag;
+
+		private HeaderStreamState(MarkupStream markupStream, ComponentTag openTag)
+		{
+			this.markupStream = markupStream;
+			this.openTag = openTag;
+		}
+
+		/**
+		 * @return the {@link MarkupStream}
+		 */
+		public MarkupStream getMarkupStream()
+		{
+			return markupStream;
+		}
+
+		/**
+		 * @return the {@link ComponentTag} that represents the open tag
+		 */
+		public ComponentTag getOpenTag()
+		{
+			return openTag;
+		}
+	}
+
 	/**
 	 * Construct
 	 * 
@@ -103,7 +139,7 @@ public class HtmlHeaderContainer extends TransparentWebMarkupContainer
 
 	/**
 	 * First render the body of the component. And if it is the header component of a Page (compared
-	 * to a Panel or Border), than get the header sections from all component in the hierarchy and
+	 * to a Panel or Border), then get the header sections from all component in the hierarchy and
 	 * render them as well.
 	 */
 	@Override
@@ -131,32 +167,24 @@ public class HtmlHeaderContainer extends TransparentWebMarkupContainer
 			}
 
 			// Render the header sections of all components on the page
-			AbstractHeaderRenderStrategy.get().renderHeader(this, getPage());
+			AbstractHeaderRenderStrategy.get().renderHeader(this,
+				new HeaderStreamState(markupStream, openTag), getPage());
 
 			// Close the header response before rendering the header container itself
 			// See https://issues.apache.org/jira/browse/WICKET-3728
 			headerResponse.close();
 
-			// Create a separate (string) response for the header container itself
-			final StringResponse bodyResponse = new StringResponse();
-			getRequestCycle().setResponse(bodyResponse);
-
-			// render the header section directly associated with the markup
-			super.onComponentTagBody(markupStream, openTag);
-
 			// Cleanup extraneous CR and LF from the response
 			CharSequence output = getCleanResponse(response);
-			CharSequence bodyOutput = getCleanResponse(bodyResponse);
 
 			// Automatically add <head> if necessary
-			if ((output.length() > 0) || (bodyOutput.length() > 0))
+			if (output.length() > 0)
 			{
 				if (renderOpenAndCloseTags())
 				{
 					webResponse.write("<head>");
 				}
 
-				webResponse.write(bodyOutput);
 				webResponse.write(output);
 
 				if (renderOpenAndCloseTags())
@@ -172,6 +200,40 @@ public class HtmlHeaderContainer extends TransparentWebMarkupContainer
 		}
 	}
 
+	/**
+	 * Renders the content of the &lt;head&gt; section of the page, including &lt;wicket:head&gt;
+	 * sections in subclasses of the page. For every child-component, the content is rendered to a
+	 * string and passed to {@link IHeaderResponse}.
+	 * 
+	 * @param headerStreamState
+	 */
+	public void renderHeaderTagBody(HeaderStreamState headerStreamState)
+	{
+		if (headerStreamState == null)
+			return;
+
+		final Response oldResponse = getRequestCycle().getResponse();
+		try
+		{
+			// Create a separate (string) response for the header container itself
+			final StringResponse bodyResponse = new StringResponse();
+			getRequestCycle().setResponse(bodyResponse);
+
+			// render the header section directly associated with the markup
+			super.onComponentTagBody(headerStreamState.getMarkupStream(),
+				headerStreamState.getOpenTag());
+			CharSequence bodyOutput = getCleanResponse(bodyResponse);
+			if (bodyOutput.length() > 0)
+			{
+				getHeaderResponse().render(StringHeaderItem.forString(bodyOutput));
+			}
+		}
+		finally
+		{
+			getRequestCycle().setResponse(oldResponse);
+		}
+	}
+
 	/**
 	 * 
 	 * @param response
@@ -290,6 +352,32 @@ public class HtmlHeaderContainer extends TransparentWebMarkupContainer
 		return headerResponse;
 	}
 
+	/**
+	 * THIS METHOD IS NOT PART OF THE WICKET PUBLIC API. DO NOT USE IT.
+	 * 
+	 * Temporarily replaces the response with a StringResponse to capture the header output for this
+	 * part of the stream and pass it to {@link IHeaderResponse}.
+	 * 
+	 * @see org.apache.wicket.MarkupContainer#renderNext(org.apache.wicket.markup.MarkupStream)
+	 */
+	@Override
+	protected final boolean renderNext(MarkupStream markupStream)
+	{
+		StringResponse markupHeaderResponse = new StringResponse();
+		Response oldResponse = getResponse();
+		RequestCycle.get().setResponse(markupHeaderResponse);
+		try
+		{
+			boolean ret = super.renderNext(markupStream);
+			getHeaderResponse().render(StringHeaderItem.forString(markupHeaderResponse.getBuffer()));
+			return ret;
+		}
+		finally
+		{
+			RequestCycle.get().setResponse(oldResponse);
+		}
+	}
+
 	@Override
 	public IMarkupFragment getMarkup()
 	{
diff --git a/wicket-core/src/main/java/org/apache/wicket/markup/html/panel/DefaultMarkupSourcingStrategy.java b/wicket-core/src/main/java/org/apache/wicket/markup/html/panel/DefaultMarkupSourcingStrategy.java
index 24a09e9c45..e69ee1e089 100644
--- a/wicket-core/src/main/java/org/apache/wicket/markup/html/panel/DefaultMarkupSourcingStrategy.java
+++ b/wicket-core/src/main/java/org/apache/wicket/markup/html/panel/DefaultMarkupSourcingStrategy.java
@@ -21,7 +21,6 @@ import org.apache.wicket.MarkupContainer;
 import org.apache.wicket.markup.ComponentTag;
 import org.apache.wicket.markup.IMarkupFragment;
 import org.apache.wicket.markup.MarkupStream;
-import org.apache.wicket.markup.html.internal.HtmlHeaderContainer;
 import org.apache.wicket.markup.html.list.AbstractItem;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
@@ -142,12 +141,4 @@ public final class DefaultMarkupSourcingStrategy extends AbstractMarkupSourcingS
 
 		return markup;
 	}
-
-	/**
-	 * Empty: nothing will be added to the header by default
-	 */
-	@Override
-	public void renderHead(final Component component, HtmlHeaderContainer container)
-	{
-	}
 }
diff --git a/wicket-core/src/main/java/org/apache/wicket/markup/renderStrategy/AbstractHeaderRenderStrategy.java b/wicket-core/src/main/java/org/apache/wicket/markup/renderStrategy/AbstractHeaderRenderStrategy.java
index 250f735e3a..e07a27512b 100644
--- a/wicket-core/src/main/java/org/apache/wicket/markup/renderStrategy/AbstractHeaderRenderStrategy.java
+++ b/wicket-core/src/main/java/org/apache/wicket/markup/renderStrategy/AbstractHeaderRenderStrategy.java
@@ -1,152 +1,155 @@
-/*
- * Licensed to the Apache Software Foundation (ASF) under one or more
- * contributor license agreements.  See the NOTICE file distributed with
- * this work for additional information regarding copyright ownership.
- * The ASF licenses this file to You under the Apache License, Version 2.0
- * (the "License"); you may not use this file except in compliance with
- * the License.  You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-package org.apache.wicket.markup.renderStrategy;
-
-import org.apache.wicket.Application;
-import org.apache.wicket.Component;
-import org.apache.wicket.markup.html.IHeaderContributor;
-import org.apache.wicket.markup.html.internal.HtmlHeaderContainer;
-import org.apache.wicket.util.lang.Args;
-
-/**
- * An abstract implementation of a header render strategy which is only missing the code to traverse
- * the child hierarchy, since the sequence of that traversal is what will make the difference
- * between the different header render strategies.
- * 
- * Besides the child hierarchy the render sequence by default (may be changed via subclassing) is as
- * follows:
- * <ul>
- * <li>1. application level headers</li>
- * <li>2. the root component's headers</li>
- * <li>3. the children hierarchy (to be implemented per subclass)</li>
- * </ul>
- * 
- * @author Juergen Donnerstag
- */
-public abstract class AbstractHeaderRenderStrategy implements IHeaderRenderStrategy
-{
-	/**
-	 * @return Gets the strategy registered with the application
-	 */
-	public static IHeaderRenderStrategy get()
-	{
-		// NOT OFFICIALLY SUPPORTED BY WICKET
-		// By purpose it is "difficult" to change to another render strategy.
-		// We don't want it to be modifiable by users, but we needed a way to easily test other
-		// strategies.
-		String className = System.getProperty("Wicket_HeaderRenderStrategy");
-		if (className != null)
-		{
-			Class<?> clazz = null;
-			try
-			{
-				clazz = Application.get()
-					.getApplicationSettings()
-					.getClassResolver()
-					.resolveClass(className);
-
-				if (clazz != null)
-				{
-					return (IHeaderRenderStrategy)clazz.newInstance();
-				}
-			}
-			catch (ClassNotFoundException ex)
-			{
-				// ignore
-			}
-			catch (InstantiationException ex)
-			{
-				// ignore
-			}
-			catch (IllegalAccessException ex)
-			{
-				// ignore
-			}
-		}
-
-		// Our default header render strategy
-		// Pre 1.5
-		// return new ParentFirstHeaderRenderStrategy();
-
-		// Since 1.5
-		return new ChildFirstHeaderRenderStrategy();
-	}
-
-	/**
-	 * Construct.
-	 */
-	public AbstractHeaderRenderStrategy()
-	{
-	}
-
-	@Override
-	public void renderHeader(final HtmlHeaderContainer headerContainer,
-		final Component rootComponent)
-	{
-		Args.notNull(headerContainer, "headerContainer");
-		Args.notNull(rootComponent, "rootComponent");
-
-		// First the application level headers
-		renderApplicationLevelHeaders(headerContainer);
-
-		// Than the root component's headers
-		renderRootComponent(headerContainer, rootComponent);
-
-		// Than its child hierarchy
-		renderChildHeaders(headerContainer, rootComponent);
-	}
-
-	/**
-	 * Render the root component (e.g. Page).
-	 * 
-	 * @param headerContainer
-	 * @param rootComponent
-	 */
-	protected void renderRootComponent(final HtmlHeaderContainer headerContainer,
-		final Component rootComponent)
-	{
-		rootComponent.renderHead(headerContainer);
-	}
-
-	/**
-	 * Render the child hierarchy headers.
-	 * 
-	 * @param headerContainer
-	 * @param rootComponent
-	 */
-	abstract protected void renderChildHeaders(final HtmlHeaderContainer headerContainer,
-		final Component rootComponent);
-
-	/**
-	 * Render the application level headers
-	 * 
-	 * @param headerContainer
-	 */
-	protected final void renderApplicationLevelHeaders(final HtmlHeaderContainer headerContainer)
-	{
-		Args.notNull(headerContainer, "headerContainer");
-
-		if (Application.exists())
-		{
-			for (IHeaderContributor listener : Application.get()
-				.getHeaderContributorListenerCollection())
-			{
-				listener.renderHead(headerContainer.getHeaderResponse());
-			}
-		}
-	}
-}
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.wicket.markup.renderStrategy;
+
+import org.apache.wicket.Application;
+import org.apache.wicket.Component;
+import org.apache.wicket.markup.html.IHeaderContributor;
+import org.apache.wicket.markup.html.internal.HtmlHeaderContainer;
+import org.apache.wicket.markup.html.internal.HtmlHeaderContainer.HeaderStreamState;
+import org.apache.wicket.util.lang.Args;
+
+/**
+ * An abstract implementation of a header render strategy which is only missing the code to traverse
+ * the child hierarchy, since the sequence of that traversal is what will make the difference
+ * between the different header render strategies.
+ * 
+ * Besides the child hierarchy the render sequence by default (may be changed via subclassing) is as
+ * follows:
+ * <ul>
+ * <li>1. application level headers</li>
+ * <li>2. the root component's headers</li>
+ * <li>3. the children hierarchy (to be implemented per subclass)</li>
+ * </ul>
+ * 
+ * @author Juergen Donnerstag
+ */
+public abstract class AbstractHeaderRenderStrategy implements IHeaderRenderStrategy
+{
+	/**
+	 * @return Gets the strategy registered with the application
+	 */
+	public static IHeaderRenderStrategy get()
+	{
+		// NOT OFFICIALLY SUPPORTED BY WICKET
+		// By purpose it is "difficult" to change to another render strategy.
+		// We don't want it to be modifiable by users, but we needed a way to easily test other
+		// strategies.
+		String className = System.getProperty("Wicket_HeaderRenderStrategy");
+		if (className != null)
+		{
+			Class<?> clazz = null;
+			try
+			{
+				clazz = Application.get()
+					.getApplicationSettings()
+					.getClassResolver()
+					.resolveClass(className);
+
+				if (clazz != null)
+				{
+					return (IHeaderRenderStrategy)clazz.newInstance();
+				}
+			}
+			catch (ClassNotFoundException ex)
+			{
+				// ignore
+			}
+			catch (InstantiationException ex)
+			{
+				// ignore
+			}
+			catch (IllegalAccessException ex)
+			{
+				// ignore
+			}
+		}
+
+		// Our default header render strategy
+		// Pre 1.5
+		// return new ParentFirstHeaderRenderStrategy();
+
+		// Since 1.5
+		return new ChildFirstHeaderRenderStrategy();
+	}
+
+	/**
+	 * Construct.
+	 */
+	public AbstractHeaderRenderStrategy()
+	{
+	}
+
+	@Override
+	public void renderHeader(final HtmlHeaderContainer headerContainer,
+		HeaderStreamState headerStreamState, final Component rootComponent)
+	{
+		Args.notNull(headerContainer, "headerContainer");
+		Args.notNull(rootComponent, "rootComponent");
+
+		// First the application level headers
+		renderApplicationLevelHeaders(headerContainer);
+
+		// Then the root component's headers
+		renderRootComponent(headerContainer, headerStreamState, rootComponent);
+
+		// Then its child hierarchy
+		renderChildHeaders(headerContainer, rootComponent);
+	}
+
+	/**
+	 * Render the root component (e.g. Page).
+	 * 
+	 * @param headerContainer
+	 * @param headerStreamState
+	 * @param rootComponent
+	 */
+	protected void renderRootComponent(final HtmlHeaderContainer headerContainer,
+		final HeaderStreamState headerStreamState, final Component rootComponent)
+	{
+		headerContainer.renderHeaderTagBody(headerStreamState);
+		rootComponent.renderHead(headerContainer);
+	}
+
+	/**
+	 * Render the child hierarchy headers.
+	 * 
+	 * @param headerContainer
+	 * @param rootComponent
+	 */
+	abstract protected void renderChildHeaders(final HtmlHeaderContainer headerContainer,
+		final Component rootComponent);
+
+	/**
+	 * Render the application level headers
+	 * 
+	 * @param headerContainer
+	 */
+	protected final void renderApplicationLevelHeaders(final HtmlHeaderContainer headerContainer)
+	{
+		Args.notNull(headerContainer, "headerContainer");
+
+		if (Application.exists())
+		{
+			for (IHeaderContributor listener : Application.get()
+				.getHeaderContributorListenerCollection())
+			{
+				listener.renderHead(headerContainer.getHeaderResponse());
+			}
+		}
+	}
+}
diff --git a/wicket-core/src/main/java/org/apache/wicket/markup/renderStrategy/ChildFirstHeaderRenderStrategy.java b/wicket-core/src/main/java/org/apache/wicket/markup/renderStrategy/ChildFirstHeaderRenderStrategy.java
index 96885a7a1d..cf4d8da568 100644
--- a/wicket-core/src/main/java/org/apache/wicket/markup/renderStrategy/ChildFirstHeaderRenderStrategy.java
+++ b/wicket-core/src/main/java/org/apache/wicket/markup/renderStrategy/ChildFirstHeaderRenderStrategy.java
@@ -19,14 +19,15 @@ package org.apache.wicket.markup.renderStrategy;
 import org.apache.wicket.Component;
 import org.apache.wicket.MarkupContainer;
 import org.apache.wicket.markup.html.internal.HtmlHeaderContainer;
+import org.apache.wicket.markup.html.internal.HtmlHeaderContainer.HeaderStreamState;
 import org.apache.wicket.util.lang.Args;
 import org.apache.wicket.util.visit.IVisit;
 
 /**
  * This a header render strategy implements a child->parent->root sequence, which is inverse to how
  * it was until Wicket 1.5. It now allows parent containers to replace child contributions, since
- * their contribution is added to the markup after the child ones (see
- * <a href="https://issues.apache.org/jira/browse/WICKET-2693">WICKET-2693</a>).
+ * their contribution is added to the markup after the child ones (see <a
+ * href="https://issues.apache.org/jira/browse/WICKET-2693">WICKET-2693</a>).
  * 
  * Please note that irrespective of the render strategy, if the same header content (e.g. CSS file)
  * gets added twice to the header, only the first will be rendered and the 2nd will be skipped.
@@ -44,7 +45,7 @@ public class ChildFirstHeaderRenderStrategy extends AbstractHeaderRenderStrategy
 
 	@Override
 	public void renderHeader(final HtmlHeaderContainer headerContainer,
-		final Component rootComponent)
+		HeaderStreamState headerStreamState, final Component rootComponent)
 	{
 		Args.notNull(headerContainer, "headerContainer");
 		Args.notNull(rootComponent, "rootComponent");
@@ -52,11 +53,11 @@ public class ChildFirstHeaderRenderStrategy extends AbstractHeaderRenderStrategy
 		// First the application level headers
 		renderApplicationLevelHeaders(headerContainer);
 
-		// Than its child hierarchy
+		// Then its child hierarchy
 		renderChildHeaders(headerContainer, rootComponent);
 
-		// Than the root component's headers
-		renderRootComponent(headerContainer, rootComponent);
+		// Then the root component's headers
+		renderRootComponent(headerContainer, headerStreamState, rootComponent);
 	}
 
 	/**
diff --git a/wicket-core/src/main/java/org/apache/wicket/markup/renderStrategy/IHeaderRenderStrategy.java b/wicket-core/src/main/java/org/apache/wicket/markup/renderStrategy/IHeaderRenderStrategy.java
index 1db3385c8b..b15f149188 100644
--- a/wicket-core/src/main/java/org/apache/wicket/markup/renderStrategy/IHeaderRenderStrategy.java
+++ b/wicket-core/src/main/java/org/apache/wicket/markup/renderStrategy/IHeaderRenderStrategy.java
@@ -1,41 +1,45 @@
-/*
- * Licensed to the Apache Software Foundation (ASF) under one or more
- * contributor license agreements.  See the NOTICE file distributed with
- * this work for additional information regarding copyright ownership.
- * The ASF licenses this file to You under the Apache License, Version 2.0
- * (the "License"); you may not use this file except in compliance with
- * the License.  You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-package org.apache.wicket.markup.renderStrategy;
-
-import org.apache.wicket.Component;
-import org.apache.wicket.markup.html.internal.HtmlHeaderContainer;
-
-/**
- * Allows for different header render strategies. The difference per strategy will be order in which
- * components are asked to add to the markup header section. Before 1.5 it was
- * page->container->child. Since 1.5 it has been changed to child->container->parent (see
- * <a href="http://issues.apache.org/jira/browse/WICKET-2693 ">WICKET-2693</a>)
- *
- * @author Juergen Donnerstag
- */
-public interface IHeaderRenderStrategy
-{
-	/**
-	 * Implements the render strategy
-	 * 
-	 * @param headerContainer
-	 *            The HeaderContainer associated to the response
-	 * @param component
-	 *            The root component (e.g. Page) to start the render process
-	 */
-	void renderHeader(HtmlHeaderContainer headerContainer, Component component);
-}
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.wicket.markup.renderStrategy;
+
+import org.apache.wicket.Component;
+import org.apache.wicket.markup.html.internal.HtmlHeaderContainer;
+import org.apache.wicket.markup.html.internal.HtmlHeaderContainer.HeaderStreamState;
+
+/**
+ * Allows for different header render strategies. The difference per strategy will be order in which
+ * components are asked to add to the markup header section. Before 1.5 it was
+ * page->container->child. Since 1.5 it has been changed to child->container->parent (see <a
+ * href="http://issues.apache.org/jira/browse/WICKET-2693 ">WICKET-2693</a>)
+ * 
+ * @author Juergen Donnerstag
+ */
+public interface IHeaderRenderStrategy
+{
+	/**
+	 * Implements the render strategy
+	 * 
+	 * @param headerContainer
+	 *            The HeaderContainer associated to the response
+	 * @param headerStreamState
+	 *            the header section of the page, when null, this section will not be rendered
+	 * @param component
+	 *            The root component (e.g. Page) to start the render process
+	 */
+	void renderHeader(HtmlHeaderContainer headerContainer, HeaderStreamState headerStreamState,
+		Component component);
+}
diff --git a/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionPage2_ajax_expected.html b/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionPage2_ajax_expected.html
index 5b483e41db..97c39a718e 100644
--- a/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionPage2_ajax_expected.html
+++ b/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionPage2_ajax_expected.html
@@ -1,19 +1,21 @@
-<?xml version="1.0" encoding="UTF-8"?><ajax-response><header-contribution><![CDATA[<head xmlns:wicket="http://wicket.apache.org">
-<link href="../test"/>
-<script type="text/javascript" src="../javascripturl"></script>
-</head>]]></header-contribution><component id="test12" ><![CDATA[<span wicket:id="test1" id="test12"><wicket:panel>
+<?xml version="1.0" encoding="UTF-8"?><ajax-response><component id="test12" ><![CDATA[<span wicket:id="test1" id="test12"><wicket:panel>
 test
 </wicket:panel></span>]]></component><component id="test23" ><![CDATA[<span wicket:id="test2" id="test23"><wicket:panel>
 test
 </wicket:panel></span>]]></component><component id="test34" ><![CDATA[<span wicket:id="test3" id="test34"><wicket:panel>
 test
-</wicket:panel></span>]]></component><header-contribution><![CDATA[<head xmlns:wicket="http://wicket.apache.org">
-<link href="../test2"/>
-<script type="text/javascript" src="../javascripturlB"></script>
-</head>]]></header-contribution><component id="btest15" ><![CDATA[<span wicket:id="btest1" id="btest15"><wicket:panel>
+</wicket:panel></span>]]></component><component id="btest15" ><![CDATA[<span wicket:id="btest1" id="btest15"><wicket:panel>
 test
 </wicket:panel></span>]]></component><component id="btest26" ><![CDATA[<span wicket:id="btest2" id="btest26"><wicket:panel>
 test
 </wicket:panel></span>]]></component><component id="btest37" ><![CDATA[<span wicket:id="btest3" id="btest37"><wicket:panel>
 test
-</wicket:panel></span>]]></component><priority-evaluate><![CDATA[prepend();]]></priority-evaluate><evaluate><![CDATA[domReady();]]></evaluate><evaluate><![CDATA[domReadyB();]]></evaluate><evaluate><![CDATA[append();]]></evaluate><evaluate><![CDATA[onLoad();]]></evaluate><evaluate><![CDATA[onLoadB();]]></evaluate></ajax-response>
\ No newline at end of file
+</wicket:panel></span>]]></component><header-contribution><![CDATA[<head xmlns:wicket="http://wicket.apache.org">
+<link href="../test"/>
+<script type="text/javascript" src="../javascripturl"></script>
+<script type="text/javascript" src="resource/org.apache.wicket.resource.JQueryResourceReference/jquery/jquery.js"></script>
+<script type="text/javascript" src="resource/org.apache.wicket.ajax.AbstractDefaultAjaxBehavior/res/js/wicket-event-jquery.js"></script>
+
+<link href="../test2"/>
+<script type="text/javascript" src="../javascripturlB"></script>
+</head>]]></header-contribution><priority-evaluate><![CDATA[prepend();]]></priority-evaluate><evaluate><![CDATA[domReady();]]></evaluate><evaluate><![CDATA[domReadyB();]]></evaluate><evaluate><![CDATA[append();]]></evaluate><evaluate><![CDATA[onLoad();]]></evaluate><evaluate><![CDATA[onLoadB();]]></evaluate></ajax-response>
\ No newline at end of file
diff --git a/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionPage2_expected.html b/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionPage2_expected.html
index f8edc61870..ffddb3c68a 100644
--- a/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionPage2_expected.html
+++ b/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionPage2_expected.html
@@ -4,6 +4,9 @@
 <script type="text/javascript" src="../../javascripturl"></script>
 <script type="text/javascript" src="../resource/org.apache.wicket.resource.JQueryResourceReference/jquery/jquery.js"></script>
 <script type="text/javascript" src="../resource/org.apache.wicket.ajax.AbstractDefaultAjaxBehavior/res/js/wicket-event-jquery.js"></script>
+
+<link href="../../test2"/>
+<script type="text/javascript" src="../../javascripturlB"></script>
 <script type="text/javascript" src="../resource/org.apache.wicket.ajax.AbstractDefaultAjaxBehavior/res/js/wicket-ajax-jquery.js"></script>
 <script type="text/javascript" src="../resource/org.apache.wicket.ajax.AbstractDefaultAjaxBehavior/res/js/wicket-ajax-jquery-debug.js"></script>
 <script type="text/javascript" id="wicket-ajax-debug-enable">
@@ -21,6 +24,7 @@ Wicket.Ajax.baseUrl="wicket/bookmarkable/org.apache.wicket.ajax.AjaxHeaderContri
 Wicket.Event.add(window, "domready", function(event) { 
 domReady();;
 domReadyB();;
+Wicket.Ajax.ajax({"u":"../page?0-1.IBehaviorListener.0-link","e":"click","c":"link1"});;
 ;});
 /*]]>*/
 </script>
@@ -32,14 +36,6 @@ onLoadB();;
 ;});
 /*]]>*/
 </script>
-
-<link href="../../test2"/>
-<script type="text/javascript" src="../../javascripturlB"></script>
-<script type="text/javascript" id="event-click-link1">
-/*<![CDATA[*/
-Wicket.Ajax.ajax({"u":"../page?0-1.IBehaviorListener.0-link","e":"click","c":"link1"});
-/*]]>*/
-</script>
 </head><body>
 <span wicket:id="test1" id="test12"><wicket:panel>
 test
diff --git a/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionPage_ajax_expected.html b/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionPage_ajax_expected.html
index b63a87743f..315bc5828d 100644
--- a/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionPage_ajax_expected.html
+++ b/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionPage_ajax_expected.html
@@ -1,10 +1,12 @@
-<?xml version="1.0" encoding="UTF-8"?><ajax-response><header-contribution><![CDATA[<head xmlns:wicket="http://wicket.apache.org">
-<link href="../test"/>
-<script type="text/javascript" src="../javascripturl"></script>
-</head>]]></header-contribution><component id="test12" ><![CDATA[<span wicket:id="test1" id="test12"><wicket:panel>
+<?xml version="1.0" encoding="UTF-8"?><ajax-response><component id="test12" ><![CDATA[<span wicket:id="test1" id="test12"><wicket:panel>
 test
 </wicket:panel></span>]]></component><component id="test23" ><![CDATA[<span wicket:id="test2" id="test23"><wicket:panel>
 test
 </wicket:panel></span>]]></component><component id="test34" ><![CDATA[<span wicket:id="test3" id="test34"><wicket:panel>
 test
-</wicket:panel></span>]]></component><priority-evaluate><![CDATA[prepend();]]></priority-evaluate><evaluate><![CDATA[domReady();]]></evaluate><evaluate><![CDATA[append();]]></evaluate><evaluate><![CDATA[onLoad();]]></evaluate></ajax-response>
\ No newline at end of file
+</wicket:panel></span>]]></component><header-contribution><![CDATA[<head xmlns:wicket="http://wicket.apache.org">
+<link href="../test"/>
+<script type="text/javascript" src="../javascripturl"></script>
+<script type="text/javascript" src="resource/org.apache.wicket.resource.JQueryResourceReference/jquery/jquery.js"></script>
+<script type="text/javascript" src="resource/org.apache.wicket.ajax.AbstractDefaultAjaxBehavior/res/js/wicket-event-jquery.js"></script>
+</head>]]></header-contribution><priority-evaluate><![CDATA[prepend();]]></priority-evaluate><evaluate><![CDATA[domReady();]]></evaluate><evaluate><![CDATA[append();]]></evaluate><evaluate><![CDATA[onLoad();]]></evaluate></ajax-response>
\ No newline at end of file
diff --git a/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionPage_expected.html b/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionPage_expected.html
index 65a26571cb..cbcf57627f 100644
--- a/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionPage_expected.html
+++ b/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionPage_expected.html
@@ -20,6 +20,7 @@ Wicket.Ajax.baseUrl="wicket/bookmarkable/org.apache.wicket.ajax.AjaxHeaderContri
 /*<![CDATA[*/
 Wicket.Event.add(window, "domready", function(event) { 
 domReady();;
+Wicket.Ajax.ajax({"u":"../page?0-1.IBehaviorListener.0-link","e":"click","c":"link1"});;
 ;});
 /*]]>*/
 </script>
@@ -31,15 +32,15 @@ onLoad();;
 /*]]>*/
 </script>
 </head><body>
-<span wicket:id="test1" id="test11"><wicket:panel>
+<span wicket:id="test1" id="test12"><wicket:panel>
 test
 </wicket:panel></span>
-<span wicket:id="test2" id="test22"><wicket:panel>
+<span wicket:id="test2" id="test23"><wicket:panel>
 test
 </wicket:panel></span>
-<span wicket:id="test3" id="test33"><wicket:panel>
+<span wicket:id="test3" id="test34"><wicket:panel>
 test
 </wicket:panel></span>
-<a href="../page?0-1.ILinkListener-link" wicket:id="link" id="link4" onclick="var wcall=Wicket.Ajax.get(&#039;../page?0-1.IBehaviorListener.0-link&#039;, Wicket.bind(function() { }, this), Wicket.bind(function() { }, this), Wicket.bind(function() {return Wicket.$(&#039;link4&#039;) != null;}, this));return !wcall;">Test</a>
+<a href="../page?0-1.ILinkListener-link" wicket:id="link" id="link1">Test</a>
 </body>
 </html>
\ No newline at end of file
diff --git a/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionTest.java b/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionTest.java
index c8a6a34d63..3232436ba0 100644
--- a/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionTest.java
+++ b/wicket-core/src/test/java/org/apache/wicket/ajax/AjaxHeaderContributionTest.java
@@ -17,13 +17,11 @@
 package org.apache.wicket.ajax;
 
 import org.apache.wicket.WicketTestCase;
-import org.junit.Ignore;
 import org.junit.Test;
 
 /**
  * @author jcompagner
  */
-@Ignore("wicket:head needs to be rendered by IHeaderResponse to fix these, see WICKET-4000")
 public class AjaxHeaderContributionTest extends WicketTestCase
 {
 	/**
diff --git a/wicket-core/src/test/java/org/apache/wicket/ajax/markup/html/componentMap/SimpleTestPage.html b/wicket-core/src/test/java/org/apache/wicket/ajax/markup/html/componentMap/SimpleTestPage.html
index e9aab1ced9..12655d1f7c 100644
--- a/wicket-core/src/test/java/org/apache/wicket/ajax/markup/html/componentMap/SimpleTestPage.html
+++ b/wicket-core/src/test/java/org/apache/wicket/ajax/markup/html/componentMap/SimpleTestPage.html
@@ -5,4 +5,4 @@
 <body>
   <span wicket:id="testPanel"></span>
 </body>
-</html>
+</html>
\ No newline at end of file
diff --git a/wicket-core/src/test/java/org/apache/wicket/ajax/markup/html/componentMap/SimpleTestPageExpectedResult-1.html b/wicket-core/src/test/java/org/apache/wicket/ajax/markup/html/componentMap/SimpleTestPageExpectedResult-1.html
index 4b482486d0..1602c6544e 100644
--- a/wicket-core/src/test/java/org/apache/wicket/ajax/markup/html/componentMap/SimpleTestPageExpectedResult-1.html
+++ b/wicket-core/src/test/java/org/apache/wicket/ajax/markup/html/componentMap/SimpleTestPageExpectedResult-1.html
@@ -12,4 +12,4 @@ Wicket.Ajax.DebugWindow.enabled=true;
 Wicket.Ajax.baseUrl="wicket/page?0-1.IBehaviorListener.0-testPanel-baseSpan-linja1";
 /*]^]^>*/
 </script>
-</head>]]></header-contribution><evaluate><![CDATA[setTimeout('Wicket.Ajax.ajax({"u":"page?0-1.IBehaviorListener.0-testPanel-baseSpan-linja1","e":"domready"});', 2000)]]></evaluate></ajax-response>
\ No newline at end of file
+</head>]]></header-contribution><evaluate><![CDATA[Wicket.timeoutHandle_linja11 = setTimeout('Wicket.Ajax.ajax({"u":"page?0-1.IBehaviorListener.0-testPanel-baseSpan-linja1","e":"domready"});', 2000)]]></evaluate></ajax-response>
\ No newline at end of file
diff --git a/wicket-core/src/test/java/org/apache/wicket/ajax/markup/html/componentMap/SimpleTestPageExpectedResult.html b/wicket-core/src/test/java/org/apache/wicket/ajax/markup/html/componentMap/SimpleTestPageExpectedResult.html
index 21e1b1f055..bcb02b7a08 100644
--- a/wicket-core/src/test/java/org/apache/wicket/ajax/markup/html/componentMap/SimpleTestPageExpectedResult.html
+++ b/wicket-core/src/test/java/org/apache/wicket/ajax/markup/html/componentMap/SimpleTestPageExpectedResult.html
@@ -1,7 +1,5 @@
 <html>
-<head>
-  <title>ajax-test</title>
-<script type="text/javascript" src="../resource/org.apache.wicket.resource.JQueryResourceReference/jquery/jquery.js"></script>
+<head><script type="text/javascript" src="../resource/org.apache.wicket.resource.JQueryResourceReference/jquery/jquery.js"></script>
 <script type="text/javascript" src="../resource/org.apache.wicket.ajax.AbstractDefaultAjaxBehavior/res/js/wicket-event-jquery.js"></script>
 <script type="text/javascript" src="../resource/org.apache.wicket.ajax.AbstractDefaultAjaxBehavior/res/js/wicket-ajax-jquery.js"></script>
 <script type="text/javascript" src="../resource/org.apache.wicket.ajax.AbstractDefaultAjaxBehavior/res/js/wicket-ajax-jquery-debug.js"></script>
@@ -15,10 +13,12 @@ Wicket.Ajax.DebugWindow.enabled=true;
 Wicket.Ajax.baseUrl="wicket/bookmarkable/org.apache.wicket.ajax.markup.html.componentMap.SimpleTestPage?0";
 /*]]>*/
 </script>
+
+  <title>ajax-test</title>
 <script type="text/javascript" >
 /*<![CDATA[*/
 Wicket.Event.add(window, "load", function(event) { 
-setTimeout('Wicket.Ajax.ajax({"u":"../page?0-1.IBehaviorListener.0-testPanel-baseSpan-linja1","e":"domready"});', 2000);
+Wicket.timeoutHandle_linja11 = setTimeout('Wicket.Ajax.ajax({"u":"../page?0-1.IBehaviorListener.0-testPanel-baseSpan-linja1","e":"domready"});', 2000);
 ;});
 /*]]>*/
 </script>
@@ -32,4 +32,4 @@ setTimeout('Wicket.Ajax.ajax({"u":"../page?0-1.IBehaviorListener.0-testPanel-bas
     </span>
   </wicket:panel></span>
 </body>
-</html>
+</html>
\ No newline at end of file
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/basic/SimplePageExpectedResult_12.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/basic/SimplePageExpectedResult_12.html
index 04e8d7f6d4..3d8cbf3979 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/html/basic/SimplePageExpectedResult_12.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/basic/SimplePageExpectedResult_12.html
@@ -9,9 +9,7 @@
 /*<![CDATA[*/
 @import url(modern_ohne_ie.css) all;
 /*]]>*/
-</style>
-
-  <wicket:link>
+</style><wicket:link>
   <!--[if IE]>
     <a href="org.apache.wicket.markup.html.basic.SimplePage_3">Link</a>
   <![endif]-->
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/MyPage2_ExpectedResult.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/MyPage2_ExpectedResult.html
index b359dcfe73..32d64dc332 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/MyPage2_ExpectedResult.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/MyPage2_ExpectedResult.html
@@ -1,9 +1,9 @@
 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
 <html>
-  <head>
+  <head><link rel="stylesheet" type="text/css" href="../resource/org.apache.wicket.markup.html.header.MyPage2/MyPage2.css" />
+
     <title>My Page</title>
-  <link rel="stylesheet" type="text/css" href="../resource/org.apache.wicket.markup.html.header.MyPage2/MyPage2.css" />
-</head>
+  </head>
   <body>
   </body>
 </html>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/MyPageExpectedResult.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/MyPageExpectedResult.html
index 4d9184eabd..17fef794d2 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/MyPageExpectedResult.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/MyPageExpectedResult.html
@@ -2,8 +2,6 @@
 
 <html>
   <head>
-    <title>My Page</title>
-  
     <script id="org-apache-wicket-markup-html-header-PanelA-0">
 /*<![CDATA[*/
 
@@ -15,6 +13,8 @@
     AA
   
     BB
+  
+    <title>My Page</title>
   </head>
   <body>
     <span wicket:id="panelA"><wicket:panel>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/inheritance/ExpectedResult2.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/inheritance/ExpectedResult2.html
index dd40e2ae18..f80f1a67f6 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/inheritance/ExpectedResult2.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/inheritance/ExpectedResult2.html
@@ -1,7 +1,5 @@
 <html>
 <head>
-  <title>AbstractPage.html</title>
-
   <script type="text/javascript" id="org-apache-wicket-markup-html-header-inheritance-MyPanel2-0">
 /*<![CDATA[*/
 
@@ -11,6 +9,8 @@
 
 /*]]>*/
 </script>
+
+  <title>AbstractPage.html</title>
 </head>
 <body>
   <h1>Child markup</h1>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/inheritance/ExpectedResult3.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/inheritance/ExpectedResult3.html
index 28aa06d659..ad111810df 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/inheritance/ExpectedResult3.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/inheritance/ExpectedResult3.html
@@ -1,8 +1,8 @@
 <html>
 <head>
-  <title>AbstractPage_myStyle.html</title>
-
   MyPanel2_myStyle
+
+  <title>AbstractPage_myStyle.html</title>
 </head>
 <body>
   <h1>Child markup</h1>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/AbstractPage.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/AbstractPage.html
new file mode 100644
index 0000000000..b61f8dbb03
--- /dev/null
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/AbstractPage.html
@@ -0,0 +1,8 @@
+<html>
+<head>
+	<title>HeadOfAbstractPage</title>
+</head>
+<body>
+	<wicket:child />
+</body>
+</html>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/AbstractPage.java b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/AbstractPage.java
new file mode 100644
index 0000000000..5aba6cdec2
--- /dev/null
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/AbstractPage.java
@@ -0,0 +1,35 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.wicket.markup.html.header.response;
+
+import org.apache.wicket.markup.html.IHeaderResponse;
+import org.apache.wicket.markup.html.WebPage;
+import org.apache.wicket.resource.header.StringHeaderItem;
+
+/**
+ * Page with a head and header contribution
+ */
+public class AbstractPage extends WebPage
+{
+	private static final long serialVersionUID = 1L;
+
+	@Override
+	public void renderHead(IHeaderResponse response)
+	{
+		response.render(StringHeaderItem.forString("<title>HeaderContributionInAbstractPage</title>\n"));
+	}
+}
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/ConcretePage.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/ConcretePage.html
new file mode 100644
index 0000000000..01e8acabc2
--- /dev/null
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/ConcretePage.html
@@ -0,0 +1,7 @@
+<wicket:head>
+	<title>WicketHeadOfConcretePage</title>
+	<wicket:container wicket:id="headerPanel"></wicket:container>
+</wicket:head>
+<wicket:extend>
+  <span wicket:id="panel"></span>
+</wicket:extend>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/ConcretePage.java b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/ConcretePage.java
new file mode 100644
index 0000000000..a7358756ce
--- /dev/null
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/ConcretePage.java
@@ -0,0 +1,45 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.wicket.markup.html.header.response;
+
+import org.apache.wicket.markup.html.IHeaderResponse;
+import org.apache.wicket.resource.header.StringHeaderItem;
+
+/**
+ * Page with a wicket:head (markup inheritance), a header contribution and 2 panels, one in the
+ * header and one in the body
+ */
+public class ConcretePage extends AbstractPage
+{
+	private static final long serialVersionUID = 1L;
+
+	/**
+	 * Construct.
+	 */
+	public ConcretePage()
+	{
+		add(new HeaderPanel("headerPanel"));
+		add(new PanelWithHeader("panel"));
+	}
+
+	@Override
+	public void renderHead(IHeaderResponse response)
+	{
+		super.renderHead(response);
+		response.render(StringHeaderItem.forString("<title>HeaderContributionInConcretePage</title>\n"));
+	}
+}
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/ExpectedResult.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/ExpectedResult.html
new file mode 100644
index 0000000000..2d7ca39b0c
--- /dev/null
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/ExpectedResult.html
@@ -0,0 +1,24 @@
+<html>
+<head>
+	<title>WicketHeadOfHeaderPanel</title>
+<title>HeaderContributionInHeaderPanel</title>
+
+	<title>WicketHeadOfPanelWithHeader</title>
+<title>HeaderContributionInPanelWithHeader</title>
+<title>HeaderContributionInAbstractPage</title>
+<title>HeaderContributionInConcretePage</title>
+
+	<title>HeadOfAbstractPage</title>
+
+	<title>WicketHeadOfConcretePage</title>
+	<wicket:container wicket:id="headerPanel"><wicket:panel>
+	<title>BodyOfHeaderPanel</title>
+</wicket:panel></wicket:container>
+</head>
+<body>
+	<wicket:child><wicket:extend>
+  <span wicket:id="panel"><wicket:panel>
+</wicket:panel></span>
+</wicket:extend></wicket:child>
+</body>
+</html>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/HeaderPanel.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/HeaderPanel.html
new file mode 100644
index 0000000000..3050722567
--- /dev/null
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/HeaderPanel.html
@@ -0,0 +1,8 @@
+<wicket:head>
+	<title>WicketHeadOfHeaderPanel</title>
+</wicket:head>
+<body>
+<wicket:panel>
+	<title>BodyOfHeaderPanel</title>
+</wicket:panel>
+</body>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/HeaderPanel.java b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/HeaderPanel.java
new file mode 100644
index 0000000000..4579e919cb
--- /dev/null
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/HeaderPanel.java
@@ -0,0 +1,45 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.wicket.markup.html.header.response;
+
+import org.apache.wicket.markup.html.IHeaderResponse;
+import org.apache.wicket.markup.html.panel.Panel;
+import org.apache.wicket.resource.header.StringHeaderItem;
+
+/**
+ * Panel to be rendered in the header of the page, with a wicket:head and a contribution
+ */
+public class HeaderPanel extends Panel
+{
+	private static final long serialVersionUID = 1L;
+
+	/**
+	 * Construct.
+	 * 
+	 * @param id
+	 */
+	public HeaderPanel(String id)
+	{
+		super(id);
+	}
+
+	@Override
+	public void renderHead(IHeaderResponse response)
+	{
+		response.render(StringHeaderItem.forString("<title>HeaderContributionInHeaderPanel</title>\n"));
+	}
+}
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/HeaderResponseTest.java b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/HeaderResponseTest.java
new file mode 100644
index 0000000000..842ad2bbd2
--- /dev/null
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/HeaderResponseTest.java
@@ -0,0 +1,41 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.wicket.markup.html.header.response;
+
+import org.apache.wicket.WicketTestCase;
+import org.junit.Test;
+
+/**
+ * This test verifies the ordering of header items.
+ * 
+ * @author papegaaij
+ */
+public class HeaderResponseTest extends WicketTestCase
+{
+	/**
+	 * Renders items in child-first order. The expected order is: children in depth first order,
+	 * first rendering the wicket:head, then the header contributions, finally the head of the base
+	 * page is rendered, followed by the wicket:head of the concrete page
+	 * 
+	 * @throws Exception
+	 */
+	@Test
+	public void testAllMarkup() throws Exception
+	{
+		executeTest(ConcretePage.class, "ExpectedResult.html");
+	}
+}
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/PanelWithHeader.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/PanelWithHeader.html
new file mode 100644
index 0000000000..d1e45fcc2f
--- /dev/null
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/PanelWithHeader.html
@@ -0,0 +1,7 @@
+<wicket:head>
+	<title>WicketHeadOfPanelWithHeader</title>
+</wicket:head>
+<body>
+<wicket:panel>
+</wicket:panel>
+</body>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/PanelWithHeader.java b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/PanelWithHeader.java
new file mode 100644
index 0000000000..6f4e4f50b6
--- /dev/null
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/response/PanelWithHeader.java
@@ -0,0 +1,45 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.wicket.markup.html.header.response;
+
+import org.apache.wicket.markup.html.IHeaderResponse;
+import org.apache.wicket.markup.html.panel.Panel;
+import org.apache.wicket.resource.header.StringHeaderItem;
+
+/**
+ * Panel to be rendered in the body of the page, with a wicket:head and a contribution
+ */
+public class PanelWithHeader extends Panel
+{
+	private static final long serialVersionUID = 1L;
+
+	/**
+	 * Construct.
+	 * 
+	 * @param id
+	 */
+	public PanelWithHeader(String id)
+	{
+		super(id);
+	}
+
+	@Override
+	public void renderHead(IHeaderResponse response)
+	{
+		response.render(StringHeaderItem.forString("<title>HeaderContributionInPanelWithHeader</title>\n"));
+	}
+}
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/testing/TestPage_ExpectedResult.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/testing/TestPage_ExpectedResult.html
index a9f4be1d6f..3f3447efaa 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/testing/TestPage_ExpectedResult.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/testing/TestPage_ExpectedResult.html
@@ -1,8 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
 <html xmlns="http://www.w3.org/1999/xhtml">
 <head>
-  <title>test page</title>
-
     <script languange="javascript" id="org-apache-wicket-markup-html-header-testing-TestExtendedPanel-0">
 /*<![CDATA[*/
 
@@ -10,7 +8,9 @@
     
 /*]]>*/
 </script>
-  </head>
+  
+  <title>test page</title>
+</head>
 <body>
   body text here<br>
   <span wicket:id="panel"><wicket:panel>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/testing3/TestPage_ExpectedResult-1.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/testing3/TestPage_ExpectedResult-1.html
index 41aee726e5..ede8c694bd 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/html/header/testing3/TestPage_ExpectedResult-1.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/header/testing3/TestPage_ExpectedResult-1.html
@@ -2,7 +2,6 @@
 <html xmlns="http://www.w3.org/1999/xhtml">
 <head>
   <title>test page</title>
-
 </head>
 <body>
   <span wicket:id="panel"><wicket:panel>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/DoubleHeaderPartPageExpectedResult.html b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/DoubleHeaderPartPageExpectedResult.html
index 3b61a1acb8..ff42ef8962 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/DoubleHeaderPartPageExpectedResult.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/DoubleHeaderPartPageExpectedResult.html
@@ -1,9 +1,9 @@
 <html xmlns:wicket>
-    <head>
-        <title wicket:id="title">Header Part Test</title>
-	<link rel="stylesheet" type="text/css" href="../resource/org.apache.wicket.markup.parser.filter.PanelWithHeaderPart/test.css" />
+    <head><link rel="stylesheet" type="text/css" href="../resource/org.apache.wicket.markup.parser.filter.PanelWithHeaderPart/test.css" />
 <script type="text/javascript" src="../resource/org.apache.wicket.markup.parser.filter.PanelWithHeaderPart/test.js"></script>
-</head>
+
+        <title wicket:id="title">Header Part Test</title>
+	</head>
     <body>
    	 <span wicket:id="panelwithheadercomponents1"><wicket:panel>
    	<span wicket:id="body"></span>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_10.html b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_10.html
index 973dbd5833..2c04b8aa25 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_10.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_10.html
@@ -13,9 +13,9 @@
     limitations under the License.
 -->
 <html xmlns:wicket>
-<head>
+<head>panel header
   <!-- insert header even though no <wicket:head> is given -->
-panel header</head>
+</head>
 <body>
   <span wicket:id="panel"><wicket:panel>
   panel
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_14.html b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_14.html
index b579ac1468..41e5bff807 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_14.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_14.html
@@ -1,9 +1,9 @@
 <html xmlns:wicket>
 <head>
-  <link rel="stylesheet" type="text/css" href="../../feedback.css"/>
-
   <meta http-equiv="content-type" content="text/html;charset=UTF-8"></meta>
   <link rel="stylesheet" href="../../style.css" type="text/css"></link>
+
+  <link rel="stylesheet" type="text/css" href="../../feedback.css"/>
 </head>
 <body>
   <h3> Do a view source on this page and you should see a double &lt;head&gt;</h3>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_4.html b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_4.html
index 5f59b9e4d9..ae28a4e0b6 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_4.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_4.html
@@ -13,7 +13,7 @@
     limitations under the License.
 -->
 <html xmlns:wicket>
-<head>header - wicket header - panel header</head>
+<head>panel header - header - wicket header</head>
 <body>
   <span wicket:id="panel"><wicket:panel>
   panel
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_5.html b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_5.html
index 9e1375d66d..152523c557 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_5.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_5.html
@@ -13,7 +13,7 @@
     limitations under the License.
 -->
 <html xmlns:wicket>
-<head>header - wicket header -  border header </head>
+<head> border header  - header - wicket header</head>
 <body>
   <span wicket:id="border"><wicket:border>
   vorher <wicket:body> my body </wicket:body> nachher
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_6.html b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_6.html
index 26f2b7f256..a8a9d083b9 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_6.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_6.html
@@ -13,7 +13,7 @@
     limitations under the License.
 -->
 <html xmlns:wicket>
-<head>header - wicket header - panel header border header </head>
+<head>panel header border header - header - wicket header</head>
 <body>
   <span wicket:id="panel1"><wicket:panel>
   panel
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_7.html b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_7.html
index 1db6f189fc..c034a1b57c 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_7.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_7.html
@@ -13,7 +13,7 @@
     limitations under the License.
 -->
 <html xmlns:wicket>
-<head>header - wicket header - my Label header</head>
+<head>my Label header - header - wicket header</head>
 <body>
   <span wicket:id="label">mein Label</span>
 </body>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_8.html b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_8.html
index 5592d3dea4..e0830c3266 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_8.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_8.html
@@ -13,10 +13,10 @@
     limitations under the License.
 -->
 <html xmlns:wicket>
-<head>header - wicket header - 
+<head>panel header - header - wicket header
   <!-- validate that components in <head> get resolved -->
-  <link href="myStyle.css" type="css" wicket:id="cssHref" media="print,type"/>
-panel header</head>
+  <link wicket:id="cssHref" media="print,type" type="css" href="myStyle.css"/>
+</head>
 <body>
   <span wicket:id="panel"><wicket:panel>
   panel
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_9.html b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_9.html
index 712b6f34fd..152cbee29c 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_9.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_9.html
@@ -13,13 +13,13 @@
     limitations under the License.
 -->
 <html xmlns:wicket>
-<head> - wicket header - 
+<head>
   panel header 
   <link wicket:id="cssHref" media="print,type" type="css" href="myStyle.css"/>
   <wicket:link autolink="true">
     <link rel="StyleSheet" type="text/css" href="../resource/org.apache.wicket.markup.parser.filter.HeaderSectionPanel_2/style.css"/>
   </wicket:link>
-</head>
+ - wicket header - </head>
 <body>
   <span wicket:id="panel"><wicket:panel>
   panel
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_9a.html b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_9a.html
index d67c8772c5..21001a594d 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_9a.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPageExpectedResult_9a.html
@@ -13,13 +13,13 @@
     limitations under the License.
 -->
 <html xmlns:wicket>
-<head> - wicket header - 
+<head>
   panel header 
   
   <wicket:link autolink="true">
     <link rel="StyleSheet" type="text/css" href="../resource/org.apache.wicket.markup.parser.filter.HeaderSectionPanel_2/style.css"/>
   </wicket:link>
-</head>
+ - wicket header - </head>
 <body>
   <span wicket:id="panel"><wicket:panel>
   panel
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_4.html b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_4.html
index 36630c0856..b2c61ed2e3 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_4.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_4.html
@@ -13,7 +13,7 @@
     limitations under the License.
 -->
 <html xmlns:wicket>
-<head>header<wicket:head> - wicket header - </wicket:head></head>
+<head> - header<wicket:head> - wicket header</wicket:head></head>
 <body>
   <span wicket:id="panel"/>
 </body>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_5.html b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_5.html
index d78f1c9303..5837608275 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_5.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_5.html
@@ -13,7 +13,7 @@
     limitations under the License.
 -->
 <html xmlns:wicket>
-<head>header<wicket:head> - wicket header - </wicket:head></head>
+<head> - header<wicket:head> - wicket header</wicket:head></head>
 <body>
   <span wicket:id="border"> my body </span>
 </body>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_6.html b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_6.html
index 2eef548497..e2abca18a7 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_6.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_6.html
@@ -13,7 +13,7 @@
     limitations under the License.
 -->
 <html xmlns:wicket>
-<head>header<wicket:head> - wicket header - </wicket:head></head>
+<head>- header<wicket:head> - wicket header</wicket:head></head>
 <body>
   <span wicket:id="panel1"/>
   <span wicket:id="panel2"/>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_7.html b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_7.html
index 1843c0f1e0..9bc7f4e3aa 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_7.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_7.html
@@ -13,7 +13,7 @@
     limitations under the License.
 -->
 <html xmlns:wicket>
-<head>header<wicket:head> - wicket header - </wicket:head></head>
+<head> - header<wicket:head> - wicket header</wicket:head></head>
 <body>
   <span wicket:id="label">my label</span>
 </body>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_8.html b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_8.html
index dd0c20d293..f3d0c9dd38 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_8.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/parser/filter/HeaderSectionPage_8.html
@@ -13,7 +13,7 @@
     limitations under the License.
 -->
 <html xmlns:wicket>
-<head>header<wicket:head> - wicket header - </wicket:head>
+<head> - header<wicket:head> - wicket header</wicket:head>
   <!-- validate that components in <head> get resolved -->
   <link wicket:id="cssHref" media="print,type" type="css" href="murx.css"/>
 </head>
diff --git a/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceAggregatorTest1Page_results.html b/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceAggregatorTest1Page_results.html
index aae2ccf846..9d3b45ed10 100644
--- a/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceAggregatorTest1Page_results.html
+++ b/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceAggregatorTest1Page_results.html
@@ -1,10 +1,10 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
 <html xmlns="http://www.w3.org/1999/xhtml">
-<head>
+<head><script type="text/javascript" src="../resource/org.apache.wicket.resource.JQueryResourceReference/jquery/jquery.js"></script>
+<script type="text/javascript" src="../resource/org.apache.wicket.ajax.AbstractDefaultAjaxBehavior/res/js/wicket-event-jquery.js"></script>
+
 	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
 	<title>Insert title here</title>
-<script type="text/javascript" src="../resource/org.apache.wicket.resource.JQueryResourceReference/jquery/jquery.js"></script>
-<script type="text/javascript" src="../resource/org.apache.wicket.ajax.AbstractDefaultAjaxBehavior/res/js/wicket-event-jquery.js"></script>
 <script type="text/javascript" >
 /*<![CDATA[*/
 Wicket.Event.add(window, "domready", function(event) { 
diff --git a/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceAggregatorTest2Page_results.html b/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceAggregatorTest2Page_results.html
index 6fb985f450..c3942f948a 100644
--- a/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceAggregatorTest2Page_results.html
+++ b/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceAggregatorTest2Page_results.html
@@ -1,11 +1,11 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
 <html xmlns="http://www.w3.org/1999/xhtml">
-<head>
-	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
-	<title>Insert title here</title>
-<script type="text/javascript" src="../resource/org.apache.wicket.resource.JQueryResourceReference/jquery/jquery.js"></script>
+<head><script type="text/javascript" src="../resource/org.apache.wicket.resource.JQueryResourceReference/jquery/jquery.js"></script>
 <script type="text/javascript" src="../resource/org.apache.wicket.ajax.AbstractDefaultAjaxBehavior/res/js/wicket-event-jquery.js"></script>
 <script type="text/javascript" src="../resource/org.apache.wicket.resource.aggregator.ResourceAggregatorTest2Page/ResourceAggregatorTest2Page.js"></script>
+
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
+	<title>Insert title here</title>
 <script type="text/javascript" >
 /*<![CDATA[*/
 Wicket.Event.add(window, "domready", function(event) { 
