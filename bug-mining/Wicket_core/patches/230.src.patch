diff --git a/wicket-core/src/main/java/org/apache/wicket/request/mapper/CryptoMapper.java b/wicket-core/src/main/java/org/apache/wicket/request/mapper/CryptoMapper.java
index 5441429279..c762870065 100755
--- a/wicket-core/src/main/java/org/apache/wicket/request/mapper/CryptoMapper.java
+++ b/wicket-core/src/main/java/org/apache/wicket/request/mapper/CryptoMapper.java
@@ -30,9 +30,20 @@ import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
 /**
- * Request mapper that encrypts urls generated by another mapper.
+ * Request mapper that encrypts urls generated by another mapper. The original URL (both segments
+ * and parameters) is encrypted and is represented as URL segment. To be able to handle relative
+ * URLs for images in .css file the same amount of URL segments that the original URL had are
+ * appended to the encrypted URL. Each segment has a precise 5 character value, calculated using a
+ * checksum. This helps in calculating the relative distance from the original URL. When a URL is
+ * returned by the browser, we iterate through these checksummed placeholder URL segments. If the
+ * segment matches the expected checksum, then the segment it deemed to be the corresponding segment
+ * in the encrypted URL. If the segment does not match the expected checksum, then the segment is
+ * deemed a plain text sibling of the corresponding segment in the encrypted URL, and all subsequent
+ * segments are considered plain text children of the current segment.
+ * 
  * 
  * @author igor.vaynberg
+ * @author Jesse Long
  */
 public class CryptoMapper implements IRequestMapper
 {
@@ -50,7 +61,7 @@ public class CryptoMapper implements IRequestMapper
 	 * @param application
 	 *            the current application
 	 */
-	public CryptoMapper(IRequestMapper wrappedMapper, Application application)
+	public CryptoMapper(final IRequestMapper wrappedMapper, final Application application)
 	{
 		this(wrappedMapper, application, new ApplicationCryptProvider(application));
 	}
@@ -65,22 +76,22 @@ public class CryptoMapper implements IRequestMapper
 	 * @param cryptProvider
 	 *            the custom crypt provider
 	 */
-	public CryptoMapper(IRequestMapper wrappedMapper, Application application,
-		IProvider<ICrypt> cryptProvider)
+	public CryptoMapper(final IRequestMapper wrappedMapper, final Application application,
+		final IProvider<ICrypt> cryptProvider)
 	{
 		this.wrappedMapper = wrappedMapper;
 		this.cryptProvider = cryptProvider;
 		this.application = application;
 	}
 
-	public int getCompatibilityScore(Request request)
+	public int getCompatibilityScore(final Request request)
 	{
 		return 0;
 	}
 
-	public Url mapHandler(IRequestHandler requestHandler)
+	public Url mapHandler(final IRequestHandler requestHandler)
 	{
-		Url url = wrappedMapper.mapHandler(requestHandler);
+		final Url url = wrappedMapper.mapHandler(requestHandler);
 
 		if (url == null)
 		{
@@ -90,7 +101,7 @@ public class CryptoMapper implements IRequestMapper
 		return encryptUrl(url);
 	}
 
-	public IRequestHandler mapRequest(Request request)
+	public IRequestHandler mapRequest(final Request request)
 	{
 		Url url = decryptUrl(request, request.getUrl());
 
@@ -107,8 +118,7 @@ public class CryptoMapper implements IRequestMapper
 		return cryptProvider.get();
 	}
 
-
-	private Url encryptUrl(Url url)
+	private Url encryptUrl(final Url url)
 	{
 		if (url.getSegments().isEmpty() && url.getQueryParameters().isEmpty())
 		{
@@ -116,9 +126,8 @@ public class CryptoMapper implements IRequestMapper
 		}
 		String encryptedUrlString = getCrypt().encryptUrlSafe(url.toString());
 
-		Url encrypted = new Url(url.getCharset());
-		encrypted.getSegments().add(encryptedUrlString);
-		encrypted.getQueryParameters().addAll(url.getQueryParameters());
+		Url encryptedUrl = new Url(url.getCharset());
+		encryptedUrl.getSegments().add(encryptedUrlString);
 
 		int numberOfSegments = url.getSegments().size();
 		if (numberOfSegments == 0 && !url.getQueryParameters().isEmpty())
@@ -139,14 +148,13 @@ public class CryptoMapper implements IRequestMapper
 			hash = hashString(segment);
 
 			segment += String.format("%02x", Math.abs(hash % 256));
-			encrypted.getSegments().add(segment);
+			encryptedUrl.getSegments().add(segment);
 			hash = hashString(segment);
 		}
-
-		return encrypted;
+		return encryptedUrl;
 	}
 
-	private Url decryptUrl(Request request, Url encryptedUrl)
+	private Url decryptUrl(final Request request, final Url encryptedUrl)
 	{
 		if (encryptedUrl.getSegments().isEmpty() && encryptedUrl.getQueryParameters().isEmpty())
 		{
@@ -192,7 +200,7 @@ public class CryptoMapper implements IRequestMapper
 				segment += String.format("%02x", Math.abs(hash % 256));
 				hash = hashString(segment);
 
-				if (segment.equals(encryptedUrl.getSegments().get(segNo)))
+				if (segment.equals(segments.get(segNo)))
 				{
 					url.getSegments().add(originalUrl.getSegments().get(segNo - 1));
 				}
@@ -204,7 +212,7 @@ public class CryptoMapper implements IRequestMapper
 
 			if (segNo < numberOfSegments)
 			{
-				url.getQueryParameters().addAll(encryptedUrl.getQueryParameters());
+				url.getQueryParameters().addAll(originalUrl.getQueryParameters());
 
 				for (; segNo < numberOfSegments; segNo++)
 				{
@@ -242,7 +250,7 @@ public class CryptoMapper implements IRequestMapper
 	{
 		private final Application application;
 
-		public ApplicationCryptProvider(Application application)
+		public ApplicationCryptProvider(final Application application)
 		{
 			this.application = application;
 		}
diff --git a/wicket-core/src/test/java/org/apache/wicket/request/mapper/CryptoMapperTest.java b/wicket-core/src/test/java/org/apache/wicket/request/mapper/CryptoMapperTest.java
index 5ff822af1d..eac8a10f2a 100644
--- a/wicket-core/src/test/java/org/apache/wicket/request/mapper/CryptoMapperTest.java
+++ b/wicket-core/src/test/java/org/apache/wicket/request/mapper/CryptoMapperTest.java
@@ -99,7 +99,7 @@ public class CryptoMapperTest extends AbstractMapperTest
 	 */
 	public void testPageParameters()
 	{
-		String expectedEncrypted = "ywKWg-Qpk7YQBiYCmj9MaAJSIV1gtssNinjiALijtet62VMQc2-sMK_RchttkidUpYM_cplXKeZSfGxBkvWzH_E_zWv4Ii7MNSm5nXKno7o/ywK6c/MK_c0/nji3c/Qpk1b/XKnba/c2-cd?namedKey1=namedValue1&namedKey2=namedValue2";
+		String expectedEncrypted = "ywKWg-Qpk7YQBiYCmj9MaAJSIV1gtssNinjiALijtet62VMQc2-sMK_RchttkidUpYM_cplXKeZSfGxBkvWzH_E_zWv4Ii7MNSm5nXKno7o/ywK6c/MK_c0/nji3c/Qpk1b/XKnba/c2-cd";
 
 		PageParameters expectedParameters = new PageParameters();
 		expectedParameters.add("namedKey1", "namedValue1");
