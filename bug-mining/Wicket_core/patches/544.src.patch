diff --git a/wicket-core/src/main/java/org/apache/wicket/application/AbstractClassResolver.java b/wicket-core/src/main/java/org/apache/wicket/application/AbstractClassResolver.java
index 108029ee83..dbd4fe2001 100644
--- a/wicket-core/src/main/java/org/apache/wicket/application/AbstractClassResolver.java
+++ b/wicket-core/src/main/java/org/apache/wicket/application/AbstractClassResolver.java
@@ -18,17 +18,16 @@ package org.apache.wicket.application;
 
 import java.lang.ref.WeakReference;
 import java.net.URL;
-import java.util.ArrayList;
 import java.util.Enumeration;
-import java.util.HashSet;
 import java.util.Iterator;
-import java.util.List;
 import java.util.Set;
+import java.util.TreeSet;
 import java.util.concurrent.ConcurrentHashMap;
 import java.util.concurrent.ConcurrentMap;
 
 import org.apache.wicket.Application;
 import org.apache.wicket.WicketRuntimeException;
+import org.apache.wicket.util.collections.UrlExternalFormComparator;
 
 /**
  * An abstract implementation of a {@link IClassResolver} which uses a {@link ClassLoader} for
@@ -128,35 +127,28 @@ public abstract class AbstractClassResolver implements IClassResolver
 	@Override
 	public Iterator<URL> getResources(final String name)
 	{
-		List<URL> resultList = new ArrayList<URL>();
+		Set<URL> resultSet = new TreeSet<URL>(new UrlExternalFormComparator());
 
-		// URL's externalForm should be used instead of URLs as Set keys. See WICKET-3867/4203.
-		Set<String> loadedResources = new HashSet<String>();
 		try
 		{
 			// Try the classloader for the wicket jar/bundle
 			Enumeration<URL> resources = Application.class.getClassLoader().getResources(name);
-			loadResources(resources, loadedResources);
+			loadResources(resources, resultSet);
 
 			// Try the classloader for the user's application jar/bundle
 			resources = Application.get().getClass().getClassLoader().getResources(name);
-			loadResources(resources, loadedResources);
+			loadResources(resources, resultSet);
 
 			// Try the context class loader
 			resources = getClassLoader().getResources(name);
-			loadResources(resources, loadedResources);
-
-			for (String urlExternalForm : loadedResources)
-			{
-				resultList.add(new URL(urlExternalForm));
-			}
+			loadResources(resources, resultSet);
 		}
 		catch (Exception e)
 		{
 			throw new WicketRuntimeException(e);
 		}
 
-		return resultList.iterator();
+		return resultSet.iterator();
 	}
 
 	/**
@@ -164,15 +156,14 @@ public abstract class AbstractClassResolver implements IClassResolver
 	 * @param resources
 	 * @param loadedResources
 	 */
-	private void loadResources(Enumeration<URL> resources, Set<String> loadedResources)
+	private void loadResources(Enumeration<URL> resources, Set<URL> loadedResources)
 	{
 		if (resources != null)
 		{
 			while (resources.hasMoreElements())
 			{
 				final URL url = resources.nextElement();
-				String externalForm = url.toExternalForm();
-				loadedResources.add(externalForm);
+				loadedResources.add(url);
 			}
 		}
 	}
diff --git a/wicket-core/src/main/java/org/apache/wicket/application/CompoundClassResolver.java b/wicket-core/src/main/java/org/apache/wicket/application/CompoundClassResolver.java
index 05aff82d6f..8a39a9c16d 100644
--- a/wicket-core/src/main/java/org/apache/wicket/application/CompoundClassResolver.java
+++ b/wicket-core/src/main/java/org/apache/wicket/application/CompoundClassResolver.java
@@ -17,13 +17,13 @@
 package org.apache.wicket.application;
 
 import java.net.URL;
-import java.util.ArrayList;
 import java.util.Iterator;
 import java.util.List;
 import java.util.Set;
 import java.util.TreeSet;
 import java.util.concurrent.CopyOnWriteArrayList;
 
+import org.apache.wicket.util.collections.UrlExternalFormComparator;
 import org.apache.wicket.util.lang.Args;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
@@ -93,23 +93,15 @@ public class CompoundClassResolver implements IClassResolver
 	{
 		Args.notNull(name, "name");
 
-		Set<String> externalForms = new TreeSet<String>();
-		List<URL> urls = new ArrayList<URL>();
+		Set<URL> urls = new TreeSet<URL>(new UrlExternalFormComparator());
+
 		for (IClassResolver resolver : resolvers)
 		{
 			Iterator<URL> it = resolver.getResources(name);
 			while (it.hasNext())
 			{
 				URL url = it.next();
-
-				// use URL's external form to make the check for equality/containment
-				// because URL makes domain name resolution and is slow
-				String externalForm = url.toExternalForm();
-				if (externalForms.contains(externalForm) == false)
-				{
-					externalForms.add(externalForm);
-					urls.add(url);
-				}
+				urls.add(url);
 			}
 		}
 
diff --git a/wicket-core/src/main/java/org/apache/wicket/application/ReloadingClassLoader.java b/wicket-core/src/main/java/org/apache/wicket/application/ReloadingClassLoader.java
index 6c170fff7e..e31c915efd 100644
--- a/wicket-core/src/main/java/org/apache/wicket/application/ReloadingClassLoader.java
+++ b/wicket-core/src/main/java/org/apache/wicket/application/ReloadingClassLoader.java
@@ -21,11 +21,12 @@ import java.net.URL;
 import java.net.URLClassLoader;
 import java.util.ArrayList;
 import java.util.Enumeration;
-import java.util.HashSet;
 import java.util.Iterator;
 import java.util.List;
 import java.util.Set;
+import java.util.TreeSet;
 
+import org.apache.wicket.util.collections.UrlExternalFormComparator;
 import org.apache.wicket.util.file.File;
 import org.apache.wicket.util.listener.IChangeListener;
 import org.apache.wicket.util.time.Duration;
@@ -45,7 +46,7 @@ public class ReloadingClassLoader extends URLClassLoader
 {
 	private static final Logger log = LoggerFactory.getLogger(ReloadingClassLoader.class);
 
-	private static final Set<URL> urls = new HashSet<URL>();
+	private static final Set<URL> urls = new TreeSet<URL>(new UrlExternalFormComparator());
 
 	private static final List<String> patterns = new ArrayList<String>();
 
diff --git a/wicket-core/src/main/java/org/apache/wicket/util/resource/locator/caching/UrlResourceStreamReference.java b/wicket-core/src/main/java/org/apache/wicket/util/resource/locator/caching/UrlResourceStreamReference.java
index d1f36ab104..a627cca6f8 100644
--- a/wicket-core/src/main/java/org/apache/wicket/util/resource/locator/caching/UrlResourceStreamReference.java
+++ b/wicket-core/src/main/java/org/apache/wicket/util/resource/locator/caching/UrlResourceStreamReference.java
@@ -23,7 +23,13 @@ import org.apache.wicket.WicketRuntimeException;
 import org.apache.wicket.util.resource.UrlResourceStream;
 
 /**
- * A reference which may be used to recreate {@link UrlResourceStream}
+ * A reference which may be used to recreate {@link UrlResourceStream}.
+ * <p>
+ * If the UrlResourceStream deals with URLs with custom {@link java.net.URLStreamHandler}
+ * then you will need to export <em>java.protocol.handler.pkgs</em> system property
+ * so that the JVM can automatically use them to re-create the URL from its cached
+ * external form.
+ * </p>
  */
 class UrlResourceStreamReference extends AbstractResourceStreamReference
 {
@@ -46,8 +52,11 @@ class UrlResourceStreamReference extends AbstractResourceStreamReference
 		}
 		catch (MalformedURLException e)
 		{
-			// should not ever happen. The cached url is created by previously existing URL
-			// instance
+			// It can happen when the previously existing URL had a non-standard protocol, and
+			// had a custom URLStreamHandler associated with it, which knew how to deal with
+			// said protocol. When the URL is recreated from the external form, the
+			// URLStreamHandler is no longer associated, and, if the URL has a non-standard
+			// protocol for which Java has no handler, a MalformedURLException will be thrown.
 			throw new WicketRuntimeException(e);
 		}
 	}
