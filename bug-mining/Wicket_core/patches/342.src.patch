diff --git a/wicket-core/src/main/java/org/apache/wicket/protocol/http/mock/MockHttpServletRequest.java b/wicket-core/src/main/java/org/apache/wicket/protocol/http/mock/MockHttpServletRequest.java
index 2eed71c8b5..63ae4ed808 100755
--- a/wicket-core/src/main/java/org/apache/wicket/protocol/http/mock/MockHttpServletRequest.java
+++ b/wicket-core/src/main/java/org/apache/wicket/protocol/http/mock/MockHttpServletRequest.java
@@ -347,6 +347,16 @@ public class MockHttpServletRequest implements HttpServletRequest
 		return characterEncoding;
 	}
 
+	/**
+	 * Get the current character set.
+	 * 
+	 * @return The character set
+	 */
+	public Charset getCharset()
+	{
+		return Charset.forName(characterEncoding);
+	}
+	
 	/**
 	 * true will force Request generate multiPart ContentType and ContentLength
 	 * 
@@ -777,14 +787,12 @@ public class MockHttpServletRequest implements HttpServletRequest
 				{
 					if (name != null)
 					{
-						buf.append(UrlEncoder.QUERY_INSTANCE.encode(name,
-							Charset.forName(getCharacterEncoding())));
+						buf.append(UrlEncoder.QUERY_INSTANCE.encode(name, getCharset()));
 					}
 					buf.append('=');
 					if (values[i] != null)
 					{
-						buf.append(UrlEncoder.QUERY_INSTANCE.encode(values[i],
-							Charset.forName(getCharacterEncoding())));
+						buf.append(UrlEncoder.QUERY_INSTANCE.encode(values[i], getCharset()));
 					}
 					if (i + 1 < values.length)
 					{
@@ -949,12 +957,19 @@ public class MockHttpServletRequest implements HttpServletRequest
 
 	/**
 	 * Sets the scheme of this request
+	 * <p/>
+	 * set the <code>secure</code> flag accordingly 
+	 * (<code>true</code> for 'https', <code>false</code> otherwise) 
 	 * 
 	 * @param scheme
+	 *          protocol scheme (e.g. https, http, ftp)
+	 * 
+	 * @see #isSecure() 
 	 */
 	public void setScheme(String scheme)
 	{
 		this.scheme = scheme;
+		this.secure = "https".equalsIgnoreCase(scheme);
 	}
 
 	/**
@@ -1290,7 +1305,7 @@ public class MockHttpServletRequest implements HttpServletRequest
 	 */
 	public void setPath(final String path)
 	{
-		this.path = UrlDecoder.PATH_INSTANCE.decode(path, Charset.forName(getCharacterEncoding()));
+		this.path = UrlDecoder.PATH_INSTANCE.decode(path, getCharset());
 	}
 
 	/**
@@ -1300,46 +1315,7 @@ public class MockHttpServletRequest implements HttpServletRequest
 	 */
 	public void setURL(String url)
 	{
-		if (url.startsWith("http://"))
-		{
-			int index = url.indexOf("/", 7);
-			url = url.substring(index);
-		}
-		if (!url.startsWith("/"))
-		{
-			url = getContextPath() + getServletPath() + "/" + url;
-		}
-		this.url = url;
-		if (url.startsWith(getContextPath()))
-		{
-			url = url.substring(getContextPath().length());
-		}
-		if (url.startsWith(getServletPath()))
-		{
-			url = url.substring(getServletPath().length());
-		}
-
-		int index = url.indexOf("?");
-		if (index == -1)
-		{
-			setPath(url);
-		}
-		else
-		{
-			setPath(url.substring(0, index));
-
-			String queryString = url.substring(index + 1);
-/*
- * We can't clear the parameters here because users may have set custom parameters in request. An
- * better place to clear they is when tester setups the next request cycle
- */
-// parameters.clear();
-			for (QueryParameter parameter : Url.parse("?" + queryString,
-				Charset.forName(getCharacterEncoding())).getQueryParameters())
-			{
-				addParameter(parameter.getName(), parameter.getValue());
-			}
-		}
+		setUrl(Url.parse(url));
 	}
 
 // /**
@@ -1660,7 +1636,48 @@ public class MockHttpServletRequest implements HttpServletRequest
 	 */
 	public void setUrl(Url url)
 	{
-		setURL(url.toString());
+		if (url.getProtocol() != null)
+		{
+			setScheme(url.getProtocol());
+		}
+		if (url.getHost() != null)
+		{
+			serverName = url.getHost();
+		}
+		if (url.getPort() != null)
+		{
+			serverPort = url.getPort();
+		}
+		String path = url.getPath(getCharset());
+
+		if (path.startsWith("/") == false)
+		{
+			path = getContextPath() + getServletPath() + '/' + path;
+		}
+		this.url = path;
+		
+		if (path.startsWith(getContextPath()))
+		{
+			path = path.substring(getContextPath().length());
+		}
+		if (path.startsWith(getServletPath()))
+		{
+			path = path.substring(getServletPath().length());
+		}
+
+		setPath(path);
+
+		//
+		// We can't clear the parameters here because users may have set custom 
+		// parameters in request. An better place to clear they is when tester 
+		// setups the next request cycle
+		//
+		// parameters.clear();
+		
+		for (QueryParameter parameter : url.getQueryParameters())
+		{
+			addParameter(parameter.getName(), parameter.getValue());
+		}
 	}
 
 	/**
@@ -1668,9 +1685,12 @@ public class MockHttpServletRequest implements HttpServletRequest
 	 */
 	public Url getUrl()
 	{
-		String url = getRequestURI();
-		url += "?" + getQueryString();
-		return Url.parse(url, Charset.forName(getCharacterEncoding()));
+		String urlString = getRequestURI() + '?' + getQueryString();
+		Url url = Url.parse(urlString, getCharset());
+		url.setProtocol(scheme);
+		url.setHost(serverName);
+		url.setPort(serverPort);
+		return url;
 	}
 
 	/**
diff --git a/wicket-core/src/test/java/org/apache/wicket/protocol/http/mock/MockHttpServletRequestTest.java b/wicket-core/src/test/java/org/apache/wicket/protocol/http/mock/MockHttpServletRequestTest.java
new file mode 100755
index 0000000000..092410f64b
--- /dev/null
+++ b/wicket-core/src/test/java/org/apache/wicket/protocol/http/mock/MockHttpServletRequestTest.java
@@ -0,0 +1,103 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.wicket.protocol.http.mock;
+
+import org.apache.wicket.WicketTestCase;
+import org.apache.wicket.request.Url;
+import org.apache.wicket.util.tester.WicketTester;
+import org.junit.Test;
+
+/**
+ * test features of {@link MockHttpServletRequest}
+ */
+public class MockHttpServletRequestTest extends WicketTestCase
+{
+	@Test
+	public void setAbsoluteUrlWithHost()
+	{
+		WicketTester tester = new WicketTester();
+		MockHttpServletRequest request = tester.getRequest();
+		assertEquals("http", request.getScheme());
+		assertEquals("localhost", request.getServerName());
+		assertEquals(80, request.getServerPort());
+
+		request.setURL("https://myhost.mydomain.org:1234/foo/bar/baz.html?a=123&b=456");
+		assertEquals("https", request.getScheme());
+		assertEquals("myhost.mydomain.org", request.getServerName());
+		assertEquals(1234, request.getServerPort());
+
+		Url url = request.getUrl();
+		assertEquals("https", url.getProtocol());
+		assertEquals("myhost.mydomain.org", url.getHost());
+		assertEquals(new Integer(1234), url.getPort());
+		assertEquals("/foo/bar/baz.html", url.getPath());
+		assertEquals("?a=123&b=456", url.getQueryString());
+
+		String pathInfo = request.getPathInfo();
+		assertEquals("/foo/bar/baz.html", pathInfo);
+	}
+
+	@Test
+	public void setAbsoluteUrlWithoutHost()
+	{
+		WicketTester tester = new WicketTester();
+		MockHttpServletRequest request = tester.getRequest();
+		assertEquals("http", request.getScheme());
+		assertEquals("localhost", request.getServerName());
+		assertEquals(80, request.getServerPort());
+
+		request.setURL("/foo/bar/baz.html?a=123&b=456");
+		assertEquals("http", request.getScheme());
+		assertEquals("localhost", request.getServerName());
+		assertEquals(80, request.getServerPort());
+
+		Url url = request.getUrl();
+		assertEquals("http", url.getProtocol());
+		assertEquals("localhost", url.getHost());
+		assertEquals(new Integer(80), url.getPort());
+		assertEquals("/foo/bar/baz.html", url.getPath());
+		assertEquals("?a=123&b=456", url.getQueryString());
+
+		String pathInfo = request.getPathInfo();
+		assertEquals("/foo/bar/baz.html", pathInfo);
+	}
+
+	@Test
+	public void setRelativeUrl()
+	{
+		WicketTester tester = new WicketTester();
+		MockHttpServletRequest request = tester.getRequest();
+		assertEquals("http", request.getScheme());
+		assertEquals("localhost", request.getServerName());
+		assertEquals(80, request.getServerPort());
+
+		request.setURL("foo/bar/baz.html?a=123&b=456");
+		assertEquals("http", request.getScheme());
+		assertEquals("localhost", request.getServerName());
+		assertEquals(80, request.getServerPort());
+
+		Url url = request.getUrl();
+		assertEquals("http", url.getProtocol());
+		assertEquals("localhost", url.getHost());
+		assertEquals(new Integer(80), url.getPort());
+		assertEquals(request.getContextPath() + request.getServletPath() + "/foo/bar/baz.html", url.getPath());
+		assertEquals("?a=123&b=456", url.getQueryString());
+
+		String pathInfo = request.getPathInfo();
+		assertEquals("/foo/bar/baz.html", pathInfo);
+	}
+}
