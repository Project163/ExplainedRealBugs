diff --git a/wicket-core/src/main/java/org/apache/wicket/markup/head/ResourceAggregator.java b/wicket-core/src/main/java/org/apache/wicket/markup/head/ResourceAggregator.java
index bce6a11305..02221e7997 100644
--- a/wicket-core/src/main/java/org/apache/wicket/markup/head/ResourceAggregator.java
+++ b/wicket-core/src/main/java/org/apache/wicket/markup/head/ResourceAggregator.java
@@ -126,7 +126,7 @@ public class ResourceAggregator extends DecoratingHeaderResponse
 		public RecordedHeaderItem(HeaderItem item)
 		{
 			this.item = item;
-			this.locations = new ArrayList<RecordedHeaderItemLocation>();
+			locations = new ArrayList<RecordedHeaderItemLocation>();
 		}
 
 		/**
@@ -186,9 +186,9 @@ public class ResourceAggregator extends DecoratingHeaderResponse
 	{
 		super(real);
 
-		this.itemsToBeRendered = new LinkedHashMap<HeaderItem, RecordedHeaderItem>();
-		this.domReadyItemsToBeRendered = new ArrayList<OnDomReadyHeaderItem>();
-		this.loadItemsToBeRendered = new ArrayList<OnLoadHeaderItem>();
+		itemsToBeRendered = new LinkedHashMap<HeaderItem, RecordedHeaderItem>();
+		domReadyItemsToBeRendered = new ArrayList<OnDomReadyHeaderItem>();
+		loadItemsToBeRendered = new ArrayList<OnLoadHeaderItem>();
 	}
 
 	@Override
@@ -375,6 +375,10 @@ public class ResourceAggregator extends DecoratingHeaderResponse
 	 */
 	private HeaderItem getItemToBeRendered(HeaderItem item)
 	{
+		while (item instanceof IWrappedHeaderItem)
+		{
+			item = ((IWrappedHeaderItem)item).getWrapped();
+		}
 		if (getRealResponse().wasRendered(item))
 		{
 			return NoHeaderItem.get();
diff --git a/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceAggregatorTest.java b/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceAggregatorTest.java
index fa65359cff..184b0ac3cc 100644
--- a/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceAggregatorTest.java
+++ b/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceAggregatorTest.java
@@ -25,6 +25,7 @@ import java.util.List;
 import org.apache.wicket.Application;
 import org.apache.wicket.WicketTestCase;
 import org.apache.wicket.markup.head.HeaderItem;
+import org.apache.wicket.markup.head.PriorityHeaderItem;
 import org.apache.wicket.markup.head.ResourceAggregator;
 import org.apache.wicket.request.resource.ResourceReference;
 import org.apache.wicket.resource.CircularDependencyException;
@@ -193,6 +194,25 @@ public class ResourceAggregatorTest extends WicketTestCase
 		assertItems(bundleAB, bundleCD);
 	}
 
+	/**
+	 * bundle {a, b->a} and {c->a, d->c->a}, render [priority(b), d], should render [ab, cd]
+	 */
+	@Test
+	public void testTwoBundlesWithDependenciesAndPriority()
+	{
+		HeaderItem bundleAB = Application.get()
+			.getResourceBundles()
+			.addJavaScriptBundle(Application.class, "ab.js", new ResourceReferenceA(),
+				new ResourceReferenceB());
+		HeaderItem bundleCD = Application.get()
+			.getResourceBundles()
+			.addJavaScriptBundle(Application.class, "cd.js", new ResourceReferenceC(),
+				new ResourceReferenceD());
+		aggregator.render(new PriorityHeaderItem(forReference(new ResourceReferenceB())));
+		aggregator.render(forReference(new ResourceReferenceD()));
+		assertItems(bundleAB, bundleCD);
+	}
+
 	/**
 	 * bundle {a, b->a} and {a, c->a}, should give exception
 	 */
