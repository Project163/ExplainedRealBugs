diff --git a/wicket-core/src/main/java/org/apache/wicket/markup/MarkupCache.java b/wicket-core/src/main/java/org/apache/wicket/markup/MarkupCache.java
index 1b45eec610..0b559e624f 100644
--- a/wicket-core/src/main/java/org/apache/wicket/markup/MarkupCache.java
+++ b/wicket-core/src/main/java/org/apache/wicket/markup/MarkupCache.java
@@ -194,23 +194,29 @@ public class MarkupCache implements IMarkupCache
 			{
 				Markup markup = iter.next();
 
-				// Check if the markup associated with key has a base markup. And if yes, test
-				// if that is cached. If the base markup has been removed, than remove the derived
-				// markup as well.
-
-				MarkupResourceStream resourceStream = markup.getMarkupResourceStream()
-					.getBaseMarkupResourceStream();
-
-				// Is the base markup available in the cache?
-				if ((resourceStream != null) && !isMarkupCached(resourceStream))
+				if ((markup != null) && (markup != Markup.NO_MARKUP))
 				{
-					iter.remove();
-					count++;
+					// Check if the markup associated with key has a base markup. And if yes, test
+					// if that is cached. If the base markup has been removed, than remove the
+					// derived markup as well.
+
+					MarkupResourceStream resourceStream = markup.getMarkupResourceStream();
+					if (resourceStream != null)
+					{
+						resourceStream = resourceStream.getBaseMarkupResourceStream();
+					}
 
-					if (log.isDebugEnabled())
+					// Is the base markup available in the cache?
+					if ((resourceStream != null) && !isMarkupCached(resourceStream))
 					{
-						log.debug("Removed derived markup from cache: " +
-							markup.getMarkupResourceStream());
+						iter.remove();
+						count++;
+
+						if (log.isDebugEnabled())
+						{
+							log.debug("Removed derived markup from cache: " +
+								markup.getMarkupResourceStream());
+						}
 					}
 				}
 			}
