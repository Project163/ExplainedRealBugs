diff --git a/wicket-core/src/main/java/org/apache/wicket/Component.java b/wicket-core/src/main/java/org/apache/wicket/Component.java
index 33c515d576..13b32cb054 100644
--- a/wicket-core/src/main/java/org/apache/wicket/Component.java
+++ b/wicket-core/src/main/java/org/apache/wicket/Component.java
@@ -941,6 +941,11 @@ public abstract class Component
 		try
 		{
 			setFlag(FLAG_AFTER_RENDERING, true);
+
+			// always detach children because components can be attached
+			// independently of their parents
+			onAfterRenderChildren();
+
 			onAfterRender();
 			getApplication().getComponentOnAfterRenderListeners().onAfterRender(this);
 			if (getFlag(FLAG_AFTER_RENDERING))
@@ -950,9 +955,6 @@ public abstract class Component
 					getClass().getName() +
 					" has not called super.onAfterRender() in the override of onAfterRender() method");
 			}
-			// always detach children because components can be attached
-			// independently of their parents
-			onAfterRenderChildren();
 		}
 		finally
 		{
@@ -2852,10 +2854,7 @@ public abstract class Component
 	 */
 	public Component setMarkupId(String markupId)
 	{
-		if (markupId != null && Strings.isEmpty(markupId))
-		{
-			throw new IllegalArgumentException("Markup id cannot be an empty string");
-		}
+		Args.notEmpty(markupId, "markupId");
 
 		// TODO check if an automatic id has already been generated or getmarkupid() called
 		// previously and throw an illegalstateexception because something else might be depending
@@ -4112,6 +4111,10 @@ public abstract class Component
 			setFlag(FLAG_PREPARED_FOR_RENDER, false);
 			setFlag(FLAG_RENDERING, true);
 		}
+		else
+		{
+			setFlag(FLAG_RENDERING, false);
+		}
 	}
 
 	/**
diff --git a/wicket-core/src/main/java/org/apache/wicket/MarkupContainer.java b/wicket-core/src/main/java/org/apache/wicket/MarkupContainer.java
index 37986ff17a..056d48365d 100644
--- a/wicket-core/src/main/java/org/apache/wicket/MarkupContainer.java
+++ b/wicket-core/src/main/java/org/apache/wicket/MarkupContainer.java
@@ -1835,13 +1835,11 @@ public abstract class MarkupContainer extends Component implements Iterable<Comp
 	@Override
 	protected void onAfterRenderChildren()
 	{
-		// Loop through child components
 		for (Component child : this)
 		{
-			// Call end request on the child
-			child.afterRender();
+			// set RENDERING_FLAG to false for auto-component's children (like Enclosure)
+			child.markRendering(false);
 		}
-
 		super.onAfterRenderChildren();
 	}
 
diff --git a/wicket-core/src/test/java/org/apache/wicket/MarkupContainerTest.java b/wicket-core/src/test/java/org/apache/wicket/MarkupContainerTest.java
index cab3fad962..d5cb3609ca 100644
--- a/wicket-core/src/test/java/org/apache/wicket/MarkupContainerTest.java
+++ b/wicket-core/src/test/java/org/apache/wicket/MarkupContainerTest.java
@@ -16,8 +16,12 @@
  */
 package org.apache.wicket;
 
+import org.apache.wicket.markup.IMarkupResourceStreamProvider;
 import org.apache.wicket.markup.html.WebComponent;
 import org.apache.wicket.markup.html.WebMarkupContainer;
+import org.apache.wicket.markup.html.WebPage;
+import org.apache.wicket.util.resource.IResourceStream;
+import org.apache.wicket.util.resource.StringResourceStream;
 import org.junit.Test;
 
 
@@ -112,4 +116,53 @@ public class MarkupContainerTest extends WicketTestCase
 		WebMarkupContainer me = new WebMarkupContainer("a");
 		me.add(me);
 	}
+
+	/**
+	 * https://issues.apache.org/jira/browse/WICKET-4012
+	 */
+	@Test
+	public void afterRenderJustOnce()
+	{
+		AfterRenderJustOncePage page = new AfterRenderJustOncePage();
+		tester.startPage(page);
+
+		assertEquals(1, page.afterRenderCalls);
+	}
+
+	private static class AfterRenderJustOncePage extends WebPage
+		implements
+			IMarkupResourceStreamProvider
+	{
+		private int afterRenderCalls = 0;
+
+		private AfterRenderJustOncePage()
+		{
+
+			WebMarkupContainer a1 = new WebMarkupContainer("a1");
+			add(a1);
+
+			WebMarkupContainer a2 = new WebMarkupContainer("a2");
+			a1.add(a2);
+
+			WebMarkupContainer a3 = new WebMarkupContainer("a3")
+			{
+
+				@Override
+				protected void onAfterRender()
+				{
+					super.onAfterRender();
+					afterRenderCalls++;
+				}
+
+			};
+			a2.add(a3);
+		}
+
+		public IResourceStream getMarkupResourceStream(MarkupContainer container,
+			Class<?> containerClass)
+		{
+			return new StringResourceStream(
+				"<html><body><div wicket:id='a1'><div wicket:id='a2'><div wicket:id='a3'></div></div></div></body></html>");
+		}
+	}
 }
