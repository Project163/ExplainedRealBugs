diff --git a/wicket-core/src/main/java/org/apache/wicket/protocol/http/WebSession.java b/wicket-core/src/main/java/org/apache/wicket/protocol/http/WebSession.java
index 60d41e25ea..23d38f6011 100644
--- a/wicket-core/src/main/java/org/apache/wicket/protocol/http/WebSession.java
+++ b/wicket-core/src/main/java/org/apache/wicket/protocol/http/WebSession.java
@@ -206,7 +206,7 @@ public class WebSession extends Session
 					IRequestHandler activeRequestHandler = requestCycle.getActiveRequestHandler();
 					String url = requestCycle.urlFor(activeRequestHandler).toString();
 					String relativeUrl = requestCycle.getUrlRenderer()
-						.renderContextPathRelativeUrl(url, request);
+						.renderContextPathRelativeUrl(url);
 					Page browserInfoPage = newBrowserInfoPage(relativeUrl);
 					throw new RestartResponseException(browserInfoPage);
 				}
diff --git a/wicket-core/src/main/java/org/apache/wicket/protocol/http/servlet/ServletWebRequest.java b/wicket-core/src/main/java/org/apache/wicket/protocol/http/servlet/ServletWebRequest.java
index 5563aec449..84844e7cc9 100644
--- a/wicket-core/src/main/java/org/apache/wicket/protocol/http/servlet/ServletWebRequest.java
+++ b/wicket-core/src/main/java/org/apache/wicket/protocol/http/servlet/ServletWebRequest.java
@@ -123,7 +123,7 @@ public class ServletWebRequest extends WebRequest
 	{
 		if (!isAjax())
 		{
-			return Url.parse(getUrl(httpServletRequest, filterPrefix).toString(), getCharset());
+			return getUrl(httpServletRequest, filterPrefix);
 		}
 		else
 		{
@@ -138,9 +138,16 @@ public class ServletWebRequest extends WebRequest
 
 			Checks.notNull(base, "Current ajax request is missing the base url header or parameter");
 
-			return Url.parse(base, getCharset());
+			return setParameters(Url.parse(base, getCharset()));
 		}
+	}
 
+	private Url setParameters(Url url)
+	{
+		url.setPort(httpServletRequest.getServerPort());
+		url.setHost(httpServletRequest.getServerName());
+		url.setProtocol(httpServletRequest.getScheme());
+		return url;
 	}
 
 	private Url getUrl(HttpServletRequest request, String filterPrefix)
@@ -162,10 +169,9 @@ public class ServletWebRequest extends WebRequest
 			url.append(query);
 		}
 
-		return Url.parse(url.toString(), getCharset());
+		return setParameters(Url.parse(url.toString(), getCharset()));
 	}
 
-
 	/**
 	 * Returns the prefix of Wicket filter (without the leading /)
 	 * 
diff --git a/wicket-core/src/main/java/org/apache/wicket/protocol/https/HttpsMapper.java b/wicket-core/src/main/java/org/apache/wicket/protocol/https/HttpsMapper.java
index ec04753057..85f688aff7 100644
--- a/wicket-core/src/main/java/org/apache/wicket/protocol/https/HttpsMapper.java
+++ b/wicket-core/src/main/java/org/apache/wicket/protocol/https/HttpsMapper.java
@@ -119,6 +119,18 @@ public class HttpsMapper implements IRequestMapper
 	 */
 	public Url mapHandler(IRequestHandler requestHandler)
 	{
-		return delegate.mapHandler(checker.checkSecureOutgoing(requestHandler, httpsConfig));
+		Url url = delegate.mapHandler(requestHandler);
+		switch (checker.getProtocol(requestHandler))
+		{
+			case HTTP :
+				url.setProtocol("http");
+				url.setPort(httpsConfig.getHttpPort());
+				break;
+			case HTTPS :
+				url.setProtocol("https");
+				url.setPort(httpsConfig.getHttpsPort());
+				break;
+		}
+		return url;
 	}
 }
diff --git a/wicket-core/src/main/java/org/apache/wicket/protocol/https/HttpsRequestChecker.java b/wicket-core/src/main/java/org/apache/wicket/protocol/https/HttpsRequestChecker.java
index 6cc2ff9522..b54bcf4bfb 100644
--- a/wicket-core/src/main/java/org/apache/wicket/protocol/https/HttpsRequestChecker.java
+++ b/wicket-core/src/main/java/org/apache/wicket/protocol/https/HttpsRequestChecker.java
@@ -16,10 +16,8 @@
  */
 package org.apache.wicket.protocol.https;
 
-import org.apache.wicket.protocol.https.SwitchProtocolRequestHandler.Protocol;
 import org.apache.wicket.request.IRequestHandler;
-import org.apache.wicket.request.handler.BookmarkablePageRequestHandler;
-import org.apache.wicket.request.handler.IPageRequestHandler;
+import org.apache.wicket.request.handler.IPageClassRequestHandler;
 
 /**
  * A helper class which will replace the current {@link IRequestHandler request handler} with
@@ -72,44 +70,29 @@ class HttpsRequestChecker
 	}
 
 	/**
+	 * Figures out the protocol that should be used for a given request handler
+	 * 
 	 * @param requestHandler
-	 *            the original request handler
-	 * @param httpsConfig
-	 *            the https configuration
-	 * @return either {@link SwitchProtocolRequestHandler} if the page that is going to be rendered
-	 *         is annotated with @{@link RequireHttps} and the protocol of the current request is
-	 *         http, or will return the original handler if these conditions are not fulfilled
+	 * @return protocol
 	 */
-	IRequestHandler checkSecureOutgoing(IRequestHandler requestHandler, HttpsConfig httpsConfig)
+	public Protocol getProtocol(IRequestHandler requestHandler)
 	{
-
-		if (requestHandler != null && requestHandler instanceof SwitchProtocolRequestHandler)
-		{
-			return requestHandler;
-		}
-
 		Class<?> pageClass = getPageClass(requestHandler);
 		if (pageClass != null)
 		{
-			final IRequestHandler redirect;
-
 			if (hasSecureAnnotation(pageClass))
 			{
-				redirect = SwitchProtocolRequestHandler.requireProtocol(Protocol.HTTPS,
-					requestHandler, httpsConfig);
+				return Protocol.HTTPS;
 			}
 			else
 			{
-				redirect = SwitchProtocolRequestHandler.requireProtocol(Protocol.HTTP,
-					requestHandler, httpsConfig);
-			}
-			if (redirect != null)
-			{
-				return redirect;
+				return Protocol.HTTP;
 			}
-
 		}
-		return requestHandler;
+		else
+		{
+			return Protocol.PRESERVE_CURRENT;
+		}
 	}
 
 	/**
@@ -147,13 +130,9 @@ class HttpsRequestChecker
 	 */
 	private Class<?> getPageClass(IRequestHandler handler)
 	{
-		if (handler instanceof IPageRequestHandler)
-		{
-			return ((IPageRequestHandler)handler).getPageClass();
-		}
-		else if (handler instanceof BookmarkablePageRequestHandler)
+		if (handler instanceof IPageClassRequestHandler)
 		{
-			return ((BookmarkablePageRequestHandler)handler).getPageClass();
+			return ((IPageClassRequestHandler)handler).getPageClass();
 		}
 		else
 		{
diff --git a/wicket-core/src/main/java/org/apache/wicket/protocol/https/Protocol.java b/wicket-core/src/main/java/org/apache/wicket/protocol/https/Protocol.java
new file mode 100644
index 0000000000..da6351e10d
--- /dev/null
+++ b/wicket-core/src/main/java/org/apache/wicket/protocol/https/Protocol.java
@@ -0,0 +1,29 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.wicket.protocol.https;
+
+/**
+ * Protocols
+ */
+enum Protocol {
+	/*** HTTP */
+	HTTP,
+	/** HTTPS */
+	HTTPS,
+	/** CURRENT */
+	PRESERVE_CURRENT
+}
\ No newline at end of file
diff --git a/wicket-core/src/main/java/org/apache/wicket/protocol/https/SwitchProtocolRequestHandler.java b/wicket-core/src/main/java/org/apache/wicket/protocol/https/SwitchProtocolRequestHandler.java
index 5a3aa4dbbd..56f2d07408 100644
--- a/wicket-core/src/main/java/org/apache/wicket/protocol/https/SwitchProtocolRequestHandler.java
+++ b/wicket-core/src/main/java/org/apache/wicket/protocol/https/SwitchProtocolRequestHandler.java
@@ -32,18 +32,6 @@ import org.apache.wicket.util.lang.Args;
 class SwitchProtocolRequestHandler implements IRequestHandlerDelegate
 {
 
-	/**
-	 * Protocols
-	 */
-	public enum Protocol {
-		/*** HTTP */
-		HTTP,
-		/** HTTPS */
-		HTTPS,
-		/** CURRENT */
-		PRESERVE_CURRENT
-	}
-
 	/** the protocol this request handler is going to switch to */
 	private final Protocol protocol;
 
diff --git a/wicket-core/src/main/java/org/apache/wicket/request/cycle/RequestCycle.java b/wicket-core/src/main/java/org/apache/wicket/request/cycle/RequestCycle.java
index 0e5a18c7fa..81923b6f16 100644
--- a/wicket-core/src/main/java/org/apache/wicket/request/cycle/RequestCycle.java
+++ b/wicket-core/src/main/java/org/apache/wicket/request/cycle/RequestCycle.java
@@ -140,7 +140,7 @@ public class RequestCycle extends RequestHandlerStack implements IRequestCycle,
 	protected UrlRenderer newUrlRenderer()
 	{
 		// All URLs will be rendered relative to current request (can be overridden afterwards)
-		return new UrlRenderer(getRequest().getClientUrl());
+		return new UrlRenderer(getRequest().getClientUrl(), getRequest().getPrefixToContextPath());
 	}
 
 	/**
diff --git a/wicket-core/src/main/java/org/apache/wicket/util/string/UrlUtils.java b/wicket-core/src/main/java/org/apache/wicket/util/string/UrlUtils.java
index 6f1e8d7f12..8f79589ef1 100644
--- a/wicket-core/src/main/java/org/apache/wicket/util/string/UrlUtils.java
+++ b/wicket-core/src/main/java/org/apache/wicket/util/string/UrlUtils.java
@@ -64,8 +64,7 @@ public class UrlUtils
 	{
 		if (isRelative(url))
 		{
-			return requestCycle.getUrlRenderer().renderContextPathRelativeUrl(url,
-				requestCycle.getRequest());
+			return requestCycle.getUrlRenderer().renderContextPathRelativeUrl(url);
 		}
 		else
 		{
diff --git a/wicket-core/src/test/java/org/apache/wicket/protocol/https/SwitchProtocolRequestHandlerTest.java b/wicket-core/src/test/java/org/apache/wicket/protocol/https/SwitchProtocolRequestHandlerTest.java
index a725d6c7d3..e7be4301bd 100644
--- a/wicket-core/src/test/java/org/apache/wicket/protocol/https/SwitchProtocolRequestHandlerTest.java
+++ b/wicket-core/src/test/java/org/apache/wicket/protocol/https/SwitchProtocolRequestHandlerTest.java
@@ -23,7 +23,6 @@ import javax.servlet.http.HttpServletRequest;
 
 import org.apache.wicket.MockPage;
 import org.apache.wicket.protocol.http.servlet.ServletWebRequest;
-import org.apache.wicket.protocol.https.SwitchProtocolRequestHandler.Protocol;
 import org.apache.wicket.request.IRequestCycle;
 import org.apache.wicket.request.IRequestHandler;
 import org.apache.wicket.request.Url;
diff --git a/wicket-core/src/test/java/org/apache/wicket/request/cycle/UrlRendererTest.java b/wicket-core/src/test/java/org/apache/wicket/request/cycle/UrlRendererTest.java
index 7db39bbc10..faaaaf2a47 100644
--- a/wicket-core/src/test/java/org/apache/wicket/request/cycle/UrlRendererTest.java
+++ b/wicket-core/src/test/java/org/apache/wicket/request/cycle/UrlRendererTest.java
@@ -35,7 +35,7 @@ public class UrlRendererTest extends TestCase
 	 */
 	public void test1()
 	{
-		UrlRenderer r1 = new UrlRenderer(Url.parse("foo/bar/baz?a=b"));
+		UrlRenderer r1 = new UrlRenderer(Url.parse("foo/bar/baz?a=b"), "");
 		assertEquals("./xyz?x=y", r1.renderUrl(Url.parse("foo/bar/xyz?x=y")));
 		assertEquals("./baz/xyz?x=y", r1.renderUrl(Url.parse("foo/bar/baz/xyz?x=y")));
 		assertEquals("../aaa/xyz?x=y", r1.renderUrl(Url.parse("foo/aaa/xyz?x=y")));
@@ -47,7 +47,7 @@ public class UrlRendererTest extends TestCase
 	 */
 	public void test2()
 	{
-		UrlRenderer r1 = new UrlRenderer(Url.parse("foo/bar/baz?a=b"));
+		UrlRenderer r1 = new UrlRenderer(Url.parse("foo/bar/baz?a=b"), "");
 		assertEquals("../../foo?x=y", r1.renderUrl(Url.parse("foo?x=y")));
 		assertEquals("../../aaa?x=y", r1.renderUrl(Url.parse("aaa?x=y")));
 	}
@@ -57,7 +57,7 @@ public class UrlRendererTest extends TestCase
 	 */
 	public void test3()
 	{
-		UrlRenderer r1 = new UrlRenderer(Url.parse("?a=b"));
+		UrlRenderer r1 = new UrlRenderer(Url.parse("?a=b"), "");
 		assertEquals("a/b/c?x=y", r1.renderUrl(Url.parse("a/b/c?x=y")));
 	}
 
@@ -66,7 +66,7 @@ public class UrlRendererTest extends TestCase
 	 */
 	public void test5()
 	{
-		UrlRenderer r1 = new UrlRenderer(Url.parse("url"));
+		UrlRenderer r1 = new UrlRenderer(Url.parse("url"), "");
 		assertEquals("./url?1", r1.renderUrl(Url.parse("url?1")));
 	}
 
@@ -75,7 +75,7 @@ public class UrlRendererTest extends TestCase
 	 */
 	public void test6()
 	{
-		UrlRenderer r1 = new UrlRenderer(Url.parse("url/"));
+		UrlRenderer r1 = new UrlRenderer(Url.parse("url/"), "");
 		assertEquals("./x?1", r1.renderUrl(Url.parse("url/x?1")));
 	}
 
@@ -85,7 +85,7 @@ public class UrlRendererTest extends TestCase
 	public void test7()
 	{
 		UrlRenderer r1 = new UrlRenderer(
-			Url.parse("MyTestPage/indexed1/indexed2/indexed3?10-27.ILinkListener-l2&p1=v1"));
+			Url.parse("MyTestPage/indexed1/indexed2/indexed3?10-27.ILinkListener-l2&p1=v1"), "");
 		assertEquals("../../../MyTestPage?10", r1.renderUrl(Url.parse("MyTestPage?10")));
 	}
 
@@ -94,7 +94,7 @@ public class UrlRendererTest extends TestCase
 	 */
 	public void test8()
 	{
-		UrlRenderer r1 = new UrlRenderer(Url.parse("en/first-test-page?16-1.ILinkListener-l1"));
+		UrlRenderer r1 = new UrlRenderer(Url.parse("en/first-test-page?16-1.ILinkListener-l1"), "");
 		assertEquals("./first-test-page/indexed1/indexed2/indexed3?p1=v1",
 			r1.renderUrl(Url.parse("en/first-test-page/indexed1/indexed2/indexed3?p1=v1")));
 	}
@@ -104,7 +104,7 @@ public class UrlRendererTest extends TestCase
 	 */
 	public void test9()
 	{
-		UrlRenderer r1 = new UrlRenderer(Url.parse("a/b/q/d/e"));
+		UrlRenderer r1 = new UrlRenderer(Url.parse("a/b/q/d/e"), "");
 		assertEquals("../../../q/c/d/e", r1.renderUrl(Url.parse("a/q/c/d/e")));
 	}
 
@@ -113,7 +113,6 @@ public class UrlRendererTest extends TestCase
 	 */
 	public void test10()
 	{
-		UrlRenderer r1 = new UrlRenderer(Url.parse("a/b/q/d/e"));
 
 		HttpServletRequest httpRequest = Mockito.mock(HttpServletRequest.class);
 		Mockito.when(httpRequest.getCharacterEncoding()).thenReturn("UTF-8");
@@ -121,15 +120,16 @@ public class UrlRendererTest extends TestCase
 		Mockito.when(httpRequest.getRequestURI()).thenReturn("/contextPath/filterPath/anything");
 
 		ServletWebRequest request = new ServletWebRequest(httpRequest, "filterPath/");
+		UrlRenderer r1 = new UrlRenderer(Url.parse("a/b/q/d/e"), request.getPrefixToContextPath());
 
-		assertEquals("../../../../../", r1.renderContextPathRelativeUrl("", request));
-		assertEquals("../../../../../", r1.renderContextPathRelativeUrl("/", request));
-		assertEquals("../../../../../f", r1.renderContextPathRelativeUrl("/f", request));
-		assertEquals("../../../../../../f", r1.renderContextPathRelativeUrl("../f", request));
+		assertEquals("../../../../../", r1.renderContextPathRelativeUrl(""));
+		assertEquals("../../../../../", r1.renderContextPathRelativeUrl("/"));
+		assertEquals("../../../../../f", r1.renderContextPathRelativeUrl("/f"));
+		assertEquals("../../../../../../f", r1.renderContextPathRelativeUrl("../f"));
 
 		try
 		{
-			r1.renderContextPathRelativeUrl(null, request);
+			r1.renderContextPathRelativeUrl(null);
 			fail("Null 'url' is not allowed!");
 		}
 		catch (IllegalArgumentException iax)
@@ -143,7 +143,7 @@ public class UrlRendererTest extends TestCase
 	 */
 	public void test11()
 	{
-		UrlRenderer r1 = new UrlRenderer(Url.parse("a"));
+		UrlRenderer r1 = new UrlRenderer(Url.parse("a"), "");
 		assertEquals(".", r1.renderUrl(Url.parse("")));
 	}
 }
