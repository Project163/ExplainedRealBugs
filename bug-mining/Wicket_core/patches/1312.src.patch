diff --git a/wicket-core/src/main/java/org/apache/wicket/markup/parser/AbstractMarkupFilter.java b/wicket-core/src/main/java/org/apache/wicket/markup/parser/AbstractMarkupFilter.java
index a29f774f15..f37b94db91 100644
--- a/wicket-core/src/main/java/org/apache/wicket/markup/parser/AbstractMarkupFilter.java
+++ b/wicket-core/src/main/java/org/apache/wicket/markup/parser/AbstractMarkupFilter.java
@@ -23,6 +23,7 @@ import java.util.concurrent.atomic.AtomicInteger;
 
 import org.apache.wicket.MetaDataKey;
 import org.apache.wicket.markup.ComponentTag;
+import org.apache.wicket.markup.ContainerInfo;
 import org.apache.wicket.markup.HtmlSpecialTag;
 import org.apache.wicket.markup.Markup;
 import org.apache.wicket.markup.MarkupElement;
@@ -48,8 +49,9 @@ public abstract class AbstractMarkupFilter implements IMarkupFilter
 
 	/**
 	 *  A key for a request-relative map of counters.
-	 *  As map keys we use the {@link org.apache.wicket.markup.MarkupResourceStream} cacheKey, 
-	 *  meaning that each {@link org.apache.wicket.markup.MarkupResourceStream} has its own counter. 
+	 *  As map keys we use the class name of the {@link org.apache.wicket.markup.MarkupResourceStream}'s owner 
+	 *  container (see {@link org.apache.wicket.markup.MarkupResourceStream#getContainerInfo()}), 
+	 *  meaning that each container has its own counter. 
 	 *  The counters are used by {@link #getRequestUniqueId()} to get unique ids for markup tags.
 	 * **/
 	private final static MetaDataKey<Map<String, AtomicInteger>> REQUEST_COUNTER_KEY = new MetaDataKey<Map<String, AtomicInteger>>()
@@ -204,7 +206,8 @@ public abstract class AbstractMarkupFilter implements IMarkupFilter
 
 	/**
 	 * Returns an id using the request-relative counter associated with the 
-	 * underlying {@link org.apache.wicket.markup.MarkupResourceStream}. 
+	 * underlying {@link org.apache.wicket.markup.MarkupResourceStream}'s owner container 
+	 * (see {@link org.apache.wicket.markup.MarkupResourceStream#getContainerInfo()}). 
 	 * This can be useful for autocomponent tags that need to get a tag id.
 	 * 
 	 * @return
@@ -214,7 +217,8 @@ public abstract class AbstractMarkupFilter implements IMarkupFilter
 	{
 		RequestCycle requestCycle = RequestCycle.get();
 		Map<String, AtomicInteger> markupUniqueCounters = requestCycle.getMetaData(REQUEST_COUNTER_KEY);
-		String cacheKey = getMarkupResourceStream().getCacheKey();
+		ContainerInfo containerInfo = getMarkupResourceStream().getContainerInfo();
+		String cacheKey = containerInfo != null ? containerInfo.getContainerClass().getCanonicalName() : null;
 		
 		if (markupUniqueCounters == null)
 		{
diff --git a/wicket-core/src/main/java/org/apache/wicket/markup/parser/filter/InlineEnclosureHandler.java b/wicket-core/src/main/java/org/apache/wicket/markup/parser/filter/InlineEnclosureHandler.java
index 0014b92d1a..07a53dc3ed 100644
--- a/wicket-core/src/main/java/org/apache/wicket/markup/parser/filter/InlineEnclosureHandler.java
+++ b/wicket-core/src/main/java/org/apache/wicket/markup/parser/filter/InlineEnclosureHandler.java
@@ -66,12 +66,6 @@ public final class InlineEnclosureHandler extends AbstractMarkupFilter
 	/** enclosures inside enclosures */
 	private Deque<ComponentTag> enclosures;
 
-	/**
-	 * InlineEnclosures are not removed after render as other auto-components,
-	 * thus they have to have a stable id.
-	 */
-	private int counter;
-
 	/**
 	 * Construct.
 	 */
@@ -115,7 +109,8 @@ public final class InlineEnclosureHandler extends AbstractMarkupFilter
 				{
 					if (Strings.isEmpty(htmlId))
 					{
-						String id = getWicketNamespace() + "_" + INLINE_ENCLOSURE_ID_PREFIX + (counter++);
+						String id = getWicketNamespace() + "_" + INLINE_ENCLOSURE_ID_PREFIX + 
+							getRequestUniqueId();
 						tag.setId(id);
 					}
 					else
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosureDifferentNamespaceExpectedResult.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosureDifferentNamespaceExpectedResult.html
index 0453d7d0a6..245f47d273 100755
--- a/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosureDifferentNamespaceExpectedResult.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosureDifferentNamespaceExpectedResult.html
@@ -2,8 +2,8 @@
 <body>
 
 <!-- nested inline enclosures with separate child depths. -->
-<div id="w__InlineEnclosure_01"><span>Test Label 1</span>
-	<div id="w__InlineEnclosure_12">
+<div id="w__InlineEnclosure__11193264691"><span>Test Label 1</span>
+	<div id="w__InlineEnclosure__11193264682">
 		<table>
 			<tr>
 				<td><span>Test Label 2</span></td>
@@ -13,15 +13,15 @@
 </div>
 
 <!-- nested inline enclosures with same child depth. -->
-<div id="w__InlineEnclosure_23">
-	<div id="w__InlineEnclosure_34">
+<div id="w__InlineEnclosure__11193264673">
+	<div id="w__InlineEnclosure__11193264664">
 		<span>Test Label 3</span>
 		<span>Test Label 4</span>
 	</div>
 </div>
 
 <!-- enclosure tag nested inside inline enclosure with separate child depths. -->
-<div id="w__InlineEnclosure_45"> <span>Test Label 5</span>
+<div id="w__InlineEnclosure__11193264655"> <span>Test Label 5</span>
 	
 		<table>
 			<tr>
@@ -34,7 +34,7 @@
 </div>
 
 <!-- enclosure tag nested inside inline enclosure with same child depth. -->
-<div id="w__InlineEnclosure_56">
+<div id="w__InlineEnclosure__11193264616">
 	
 		<table>
 			<tr>
@@ -49,7 +49,7 @@
 
 <!--  inline enclosure nested inside enclosure tag with separate child depths. -->
 
-	<div id="w__InlineEnclosure_67"> <span>Test Label 9</span>
+	<div id="w__InlineEnclosure__11193264557"> <span>Test Label 9</span>
 		<table>
 			<tr>
 				<td><span>Test Label 10</span></td>
@@ -59,7 +59,7 @@
 
 
 <!--  inline enclosure nested inside enclosure tag with same child depth. -->
-<div id="w__InlineEnclosure_78">
+<div id="w__InlineEnclosure__11193264538">
 	
 		<table>
 			<tr>
@@ -74,7 +74,7 @@
 
 <!--  inline enclosure nested inside enclosure tag with same child depth inside a wicket container. -->
 
-	<div id="w__InlineEnclosure_89">
+	<div id="w__InlineEnclosure__11193264479">
 		<div>
 			<table>
 				<tr>
@@ -90,8 +90,8 @@
 
 
 <!-- nested inline enclosures without explicitly determining children -->
-<div id="w__InlineEnclosure_9a">
-	<div id="w__InlineEnclosure_10b">
+<div id="w__InlineEnclosure__1119326445a">
+	<div id="w__InlineEnclosure__1119326444b">
 		<table>
 			<tr>
 				<td>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosurePageExpectedResult_1.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosurePageExpectedResult_1.html
index dc8d66d3d4..98e8bf25c0 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosurePageExpectedResult_1.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosurePageExpectedResult_1.html
@@ -1,9 +1,9 @@
 <html>
 <body>
 
-<span id="wicket__InlineEnclosure_01"> <span>Test Label 1</span> </span>
+<span id="wicket__InlineEnclosure__15719789331"> <span>Test Label 1</span> </span>
 
-<div id="wicket__InlineEnclosure_12">
+<div id="wicket__InlineEnclosure__15719789322">
 	<table>
 		<tr>
 			<td><span>Test Label 2</span></td>
@@ -11,9 +11,9 @@
 	</table>
 </div>
 
-<span id="wicket__InlineEnclosure_23" style="display:none"></span>
+<span id="wicket__InlineEnclosure__15719789313" style="display:none"></span>
 
-<div id="wicket__InlineEnclosure_34">
+<div id="wicket__InlineEnclosure__15719789304">
 	<table>
 		<tr>
 			<td><span>Test Label 4</span></td>
@@ -36,9 +36,9 @@
 	</table>
 </div>
 
-<div id="wicket__InlineEnclosure_45"><span> <span>Test Label 8</span> </span></div>
+<div id="wicket__InlineEnclosure__15719789295"><span> <span>Test Label 8</span> </span></div>
 
-<div id="wicket__InlineEnclosure_56"><span>Test Label 9</span></div>
+<div id="wicket__InlineEnclosure__15719789286"><span>Test Label 9</span></div>
 
 <div id="customInlineEnclosureId7"><span>Test Label 10</span>
 </div>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosurePageExpectedResult_2.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosurePageExpectedResult_2.html
index 7f16e8782e..bc6e4c6578 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosurePageExpectedResult_2.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosurePageExpectedResult_2.html
@@ -2,8 +2,8 @@
 <body>
 
 <!-- nested inline enclosures with separate child depths. -->
-<div id="wicket__InlineEnclosure_01"><span>Test Label 1</span>
-	<div id="wicket__InlineEnclosure_12">
+<div id="wicket__InlineEnclosure__15719789021"><span>Test Label 1</span>
+	<div id="wicket__InlineEnclosure__15719789012">
 		<table>
 			<tr>
 				<td><span>Test Label 2</span></td>
@@ -13,15 +13,15 @@
 </div>
 
 <!-- nested inline enclosures with same child depth. -->
-<div id="wicket__InlineEnclosure_23"> 
-	<div id="wicket__InlineEnclosure_34"> 
+<div id="wicket__InlineEnclosure__15719789003"> 
+	<div id="wicket__InlineEnclosure__15719788994"> 
 		<span>Test Label 3</span>
 		<span>Test Label 4</span> 
 	</div> 
 </div>
 
 <!-- enclosure tag nested inside inline enclosure with separate child depths. -->
-<div id="wicket__InlineEnclosure_45"> <span>Test Label 5</span>
+<div id="wicket__InlineEnclosure__15719788985"> <span>Test Label 5</span>
 	
 		<table>
 			<tr>
@@ -34,7 +34,7 @@
 </div>
 
 <!-- enclosure tag nested inside inline enclosure with same child depth. -->
-<div id="wicket__InlineEnclosure_56"> 
+<div id="wicket__InlineEnclosure__15719788946"> 
 	
 		<table>
 			<tr>
@@ -49,7 +49,7 @@
 
 <!--  inline enclosure nested inside enclosure tag with separate child depths. -->
 
-	<div id="wicket__InlineEnclosure_67"> <span>Test Label 9</span>
+	<div id="wicket__InlineEnclosure__15719788887"> <span>Test Label 9</span>
 		<table>
 			<tr>
 				<td><span>Test Label 10</span></td>
@@ -59,7 +59,7 @@
 
 
 <!--  inline enclosure nested inside enclosure tag with same child depth. -->
-<div id="wicket__InlineEnclosure_78"> 
+<div id="wicket__InlineEnclosure__15719788868"> 
 	
 		<table>
 			<tr>
@@ -74,7 +74,7 @@
 
 <!--  inline enclosure nested inside enclosure tag with same child depth inside a wicket container. -->
 
-	<div id="wicket__InlineEnclosure_89"> 
+	<div id="wicket__InlineEnclosure__15719788809"> 
 		<div>
 			<table>
 				<tr>
@@ -90,8 +90,8 @@
 
 
 <!-- nested inline enclosures without explicitly determining children -->
-<div id="wicket__InlineEnclosure_9a"> 
-	<div id="wicket__InlineEnclosure_10b">
+<div id="wicket__InlineEnclosure__1571978878a"> 
+	<div id="wicket__InlineEnclosure__1571978877b">
 		<table>
 			<tr>
 				<td>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosurePanelPageExpectedResult.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosurePanelPageExpectedResult.html
index 312fefabd9..9b8cf1a31a 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosurePanelPageExpectedResult.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosurePanelPageExpectedResult.html
@@ -1,13 +1,13 @@
 <html>
 <body>
-	<div id="wicket__InlineEnclosure_01">
+	<div id="wicket__InlineEnclosure_12175729931">
 		<div>
 			<div>
 	This is a simple test panel. This contains a label and an inline enclosure
 	with a label inside it.
 	<span>Inside InlineEnclosure and Panel: hello world</span>
 	
-	<div id="wicket__InlineEnclosure_02">
+	<div id="wicket__InlineEnclosure__153409002">
 		<span>Inside InlineEnclosure, Panel and another InlineEnclosure: hello again.</span>
 	</div>
 	
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosureWithWicketMessagePage_invisible_expected.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosureWithWicketMessagePage_invisible_expected.html
index 267e77b1d6..b6e11b5bf5 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosureWithWicketMessagePage_invisible_expected.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosureWithWicketMessagePage_invisible_expected.html
@@ -21,6 +21,6 @@
 	<title>Wicket 4520</title>
 </head>
 <body>
-	<div id="wicket__message__attr__11346339991" style="display:none"></div>
+	<div id="wicket__message__attr___4340036351" style="display:none"></div>
 </body>
 </html>
\ No newline at end of file
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosureWithWicketMessagePage_visible_expected.html b/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosureWithWicketMessagePage_visible_expected.html
index 2ebffb1e11..e7f6a18f7e 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosureWithWicketMessagePage_visible_expected.html
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/InlineEnclosureWithWicketMessagePage_visible_expected.html
@@ -21,7 +21,7 @@
 	<title>Wicket 4520</title>
 </head>
 <body>
-	<div id="wicket__message__attr__11346339991" title="Some title">
+	<div id="wicket__message__attr___4340036351" title="Some title">
 		<div>Inner div
 			<span>A Label</span>
 		</div>
diff --git a/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/TogglePageTest.java b/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/TogglePageTest.java
index 3cf0b06e49..0b96e0017e 100644
--- a/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/TogglePageTest.java
+++ b/wicket-core/src/test/java/org/apache/wicket/markup/html/internal/TogglePageTest.java
@@ -23,6 +23,8 @@ import org.apache.wicket.markup.html.basic.Label;
 import org.apache.wicket.mock.MockApplication;
 import org.apache.wicket.protocol.http.WebApplication;
 import org.apache.wicket.util.tester.WicketTestCase;
+import org.apache.wicket.util.visit.IVisit;
+import org.apache.wicket.util.visit.IVisitor;
 import org.junit.Test;
 
 
@@ -129,7 +131,16 @@ public class TogglePageTest extends WicketTestCase
 			InlineEnclosureWithAdditionalAjaxTargetPage ajaxPage = (InlineEnclosureWithAdditionalAjaxTargetPage)tester.getLastRenderedPage();
 			// WICKET-5302 - only the InlineEnclosure is in the Ajax response
 			// Label1 is inside the InlineEncosure
-			tester.assertComponentOnAjaxResponse("wicket_InlineEnclosure-0");
+			InlineEnclosure children = ajaxPage.visitChildren(InlineEnclosure.class, new IVisitor<InlineEnclosure, InlineEnclosure>()
+			{
+				@Override
+				public void component(InlineEnclosure component, IVisit<InlineEnclosure> visit)
+				{
+					visit.stop(component);					
+				}
+			});
+			
+			tester.assertComponentOnAjaxResponse(children.getId());
 			tester.assertComponentOnAjaxResponse(ajaxPage.getLabel2());
 			assertVisible(ajaxPage.getLabel1());
 			assertVisible(ajaxPage.getLabel2());
diff --git a/wicket-core/src/test/java/org/apache/wicket/queueing/ComponentQueueingTest.java b/wicket-core/src/test/java/org/apache/wicket/queueing/ComponentQueueingTest.java
index 1e0cac07d1..b43e17744f 100644
--- a/wicket-core/src/test/java/org/apache/wicket/queueing/ComponentQueueingTest.java
+++ b/wicket-core/src/test/java/org/apache/wicket/queueing/ComponentQueueingTest.java
@@ -572,14 +572,14 @@ public class ComponentQueueingTest extends WicketTestCase
 		// A is visible, enclosure renders
 
 		assertEquals(
-				"<div wicket:enclosure=\"a\" id=\"wicket__InlineEnclosure_01\"><div wicket:id=\"a\"></div><div wicket:id=\"b\"></div></div>",
+				"<div wicket:enclosure=\"a\" id=\"wicket__InlineEnclosure_20793898271\"><div wicket:id=\"a\"></div><div wicket:id=\"b\"></div></div>",
 				tester.getLastResponseAsString());
 
 		// A is not visible, inline enclosure render only itself (the placeholder tag)
 
 		a.setVisible(false);
 		tester.startPage(p);
-		assertEquals("<div id=\"wicket__InlineEnclosure_01\" style=\"display:none\"></div>", tester.getLastResponseAsString());
+		assertEquals("<div id=\"wicket__InlineEnclosure_20793898271\" style=\"display:none\"></div>", tester.getLastResponseAsString());
 	}
 	
 	/**
