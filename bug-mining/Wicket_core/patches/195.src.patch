diff --git a/wicket-core/src/main/java/org/apache/wicket/markup/ContainerInfo.java b/wicket-core/src/main/java/org/apache/wicket/markup/ContainerInfo.java
index ed634e653d..43326364c8 100644
--- a/wicket-core/src/main/java/org/apache/wicket/markup/ContainerInfo.java
+++ b/wicket-core/src/main/java/org/apache/wicket/markup/ContainerInfo.java
@@ -72,7 +72,7 @@ public class ContainerInfo
 	 * 
 	 * @return The container class
 	 */
-	public Class<?> getContainerClass()
+	public Class getContainerClass()
 	{
 		return containerClassRef.get();
 	}
diff --git a/wicket-core/src/main/java/org/apache/wicket/util/tester/BaseWicketTester.java b/wicket-core/src/main/java/org/apache/wicket/util/tester/BaseWicketTester.java
index aba202138a..546946e0a5 100644
--- a/wicket-core/src/main/java/org/apache/wicket/util/tester/BaseWicketTester.java
+++ b/wicket-core/src/main/java/org/apache/wicket/util/tester/BaseWicketTester.java
@@ -34,6 +34,7 @@ import java.util.List;
 import java.util.Map;
 import java.util.Set;
 import java.util.UUID;
+import java.util.regex.Matcher;
 import java.util.regex.Pattern;
 
 import javax.servlet.FilterConfig;
@@ -67,8 +68,10 @@ import org.apache.wicket.behavior.Behavior;
 import org.apache.wicket.feedback.FeedbackMessage;
 import org.apache.wicket.feedback.FeedbackMessages;
 import org.apache.wicket.feedback.IFeedbackMessageFilter;
+import org.apache.wicket.markup.ContainerInfo;
 import org.apache.wicket.markup.IMarkupFragment;
-import org.apache.wicket.markup.Markup;
+import org.apache.wicket.markup.MarkupParser;
+import org.apache.wicket.markup.MarkupResourceStream;
 import org.apache.wicket.markup.html.WebPage;
 import org.apache.wicket.markup.html.basic.Label;
 import org.apache.wicket.markup.html.form.Form;
@@ -125,9 +128,11 @@ import org.apache.wicket.util.lang.Args;
 import org.apache.wicket.util.lang.Classes;
 import org.apache.wicket.util.lang.Generics;
 import org.apache.wicket.util.resource.ResourceStreamNotFoundException;
+import org.apache.wicket.util.resource.StringResourceStream;
 import org.apache.wicket.util.string.Strings;
 import org.apache.wicket.util.visit.IVisit;
 import org.apache.wicket.util.visit.IVisitor;
+import org.mockito.Mockito;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
@@ -150,6 +155,10 @@ public class BaseWicketTester
 	/** log. */
 	private static final Logger log = LoggerFactory.getLogger(BaseWicketTester.class);
 
+	/** matches the last closing tag before </body> */
+	private static final Pattern pattern = Pattern.compile(".*(<\\/.*[^<\\/])<\\/body>.*",
+		Pattern.MULTILINE | Pattern.DOTALL);
+
 	private final ServletContext servletContext;
 	private MockHttpSession httpSession;
 
@@ -688,9 +697,14 @@ public class BaseWicketTester
 	}
 
 	/**
+	 * The last response as a string when a page is tested via {@code startPage()} methods.
+	 * <p>
+	 * In case the processed component was not a {@link Page} then the automatically created page
+	 * markup gets removed. If you need the whole returned markup in this case use
+	 * {@link #getLastResponse()}{@link MockHttpServletResponse#getDocument() .getDocument()}
+	 * </p>
 	 * 
-	 * @return last response as String. In case the component processed was not a Page, than the
-	 *         automatically created page markup gets removed.
+	 * @return last response as String.
 	 */
 	public String getLastResponseAsString()
 	{
@@ -702,10 +716,18 @@ public class BaseWicketTester
 			return response;
 		}
 
-		// Remove first and last tag of surrounding page
-		int pos1 = response.indexOf('>');
-		int pos2 = response.lastIndexOf('<');
-		return response.substring(pos1 + 1, pos2);
+		// remove the markup for the auto-generated page. leave just component's markup body
+		String componentId = startComponent.getId();
+		String before = "wicket:id=\"" + componentId + "\">";
+		Matcher matcher = pattern.matcher(response);
+		if (matcher.matches())
+		{
+			int start = response.indexOf(before) + before.length();
+			int end = matcher.start(1);
+			response = response.substring(start, end);
+		}
+
+		return response;
 	}
 
 	/**
@@ -1117,6 +1139,14 @@ public class BaseWicketTester
 	{
 		Args.notNull(component, "component");
 
+		// Create a page object and assign the markup
+		Page page = createPage();
+		if (page == null)
+		{
+			fail("The automatically created page should not be null.");
+		}
+
+
 		// Automatically create the page markup if not provided
 		if (pageMarkup == null)
 		{
@@ -1125,16 +1155,23 @@ public class BaseWicketTester
 			{
 				fail("The markup for the automatically created page should not be null.");
 			}
-			pageMarkup = Markup.of(markup);
-		}
-
-		// Create a page object and assign the markup
-		Page page = createPage();
-		if (page == null)
-		{
-			fail("The automatically created page should not be null.");
+			markup = "<html><head></head><body>" + markup + "</body></html>";
+
+			// set a ContainerInfo to be able to use HtmlHeaderContainer so header contribution
+			// still work. WICKET-3700
+			ContainerInfo containerInfo = Mockito.mock(ContainerInfo.class);
+			Mockito.when(containerInfo.getContainerClass()).thenReturn(page.getClass());
+			MarkupResourceStream markupResourceStream = new MarkupResourceStream(
+				new StringResourceStream(markup), containerInfo, page.getClass());
+			try
+			{
+				pageMarkup = new MarkupParser(markupResourceStream).parse();
+			}
+			catch (Exception e)
+			{
+				fail("Error while parsing the markup for the autogenerated page: " + e.getMessage());
+			}
 		}
-
 		page.setMarkup(pageMarkup);
 
 		// Add the child component
