diff --git a/wicket-core/src/main/java/org/apache/wicket/protocol/http/servlet/ServletWebResponse.java b/wicket-core/src/main/java/org/apache/wicket/protocol/http/servlet/ServletWebResponse.java
index 2296e34588..a9c2ff83f0 100644
--- a/wicket-core/src/main/java/org/apache/wicket/protocol/http/servlet/ServletWebResponse.java
+++ b/wicket-core/src/main/java/org/apache/wicket/protocol/http/servlet/ServletWebResponse.java
@@ -22,6 +22,9 @@ import javax.servlet.http.Cookie;
 import javax.servlet.http.HttpServletResponse;
 
 import org.apache.wicket.WicketRuntimeException;
+import org.apache.wicket.request.Url;
+import org.apache.wicket.request.UrlRenderer;
+import org.apache.wicket.request.cycle.RequestCycle;
 import org.apache.wicket.request.http.WebResponse;
 import org.apache.wicket.util.lang.Args;
 import org.apache.wicket.util.time.Time;
@@ -168,27 +171,30 @@ public class ServletWebResponse extends WebResponse
 	public String encodeURL(CharSequence url)
 	{
 		Args.notNull(url, "url");
-		if (url.length() > 0 && url.charAt(0) == '?')
-		{
-			// there is a bug in apache tomcat 5.5 where tomcat doesn't put sessionid to url
-			// when the URL starts with '?'. So we prepend the URL with ./ and remove it
-			// afterwards (unless some container prepends session id before './' or mangles
-			// the URL otherwise
 
-			String encoded = httpServletResponse.encodeURL("./" + url.toString());
-			if (encoded.startsWith("./"))
-			{
-				return encoded.substring(2);
-			}
-			else
-			{
-				return encoded;
-			}
+		/*
+		  WICKET-4645 - always pass absolute url to the web container for encoding
+		  because when REDIRECT_TO_BUFFER is in use Wicket may render PageB when
+		  PageA is actually the requested one and the web container cannot resolve
+		  the base url properly
+		 */
+		UrlRenderer urlRenderer = RequestCycle.get().getUrlRenderer();
+		Url relativeUrl = Url.parse(url);
+		String fullUrl = urlRenderer.renderFullUrl(relativeUrl);
+		String encodedFullUrl = httpServletResponse.encodeURL(fullUrl);
+		final String encodedRelativeUrl;
+		if (fullUrl.equals(encodedFullUrl))
+		{
+			// no encoding happened so just reuse the relative url
+			encodedRelativeUrl = url.toString();
 		}
 		else
 		{
-			return httpServletResponse.encodeURL(url.toString());
+			// get the relative url with the jsessionid encoded in it
+			Url _encoded = Url.parse(encodedFullUrl);
+			encodedRelativeUrl = urlRenderer.renderRelativeUrl(_encoded);
 		}
+		return encodedRelativeUrl;
 	}
 
 	@Override
diff --git a/wicket-core/src/test/java/org/apache/wicket/request/cycle/RequestCycleUrlForTest.java b/wicket-core/src/test/java/org/apache/wicket/request/cycle/RequestCycleUrlForTest.java
index 115673c49f..9ad8a99a21 100644
--- a/wicket-core/src/test/java/org/apache/wicket/request/cycle/RequestCycleUrlForTest.java
+++ b/wicket-core/src/test/java/org/apache/wicket/request/cycle/RequestCycleUrlForTest.java
@@ -81,6 +81,7 @@ public class RequestCycleUrlForTest extends Assert
 		RequestCycleContext context = new RequestCycleContext(request, response, mapper, exceptionMapper);
 
 		requestCycle = new RequestCycle(context);
+		requestCycle.getUrlRenderer().setBaseUrl(Url.parse("http://dummy-host"));
 	}
 
 	/**
@@ -92,7 +93,7 @@ public class RequestCycleUrlForTest extends Assert
 	public void urlForClass() throws Exception
 	{
 		CharSequence url = requestCycle.urlFor(MockHomePage.class, new PageParameters());
-		assertEquals("/bookmarkablePage"+JSESSIONID, url);
+		assertEquals("./bookmarkablePage"+JSESSIONID, url);
 	}
 
 	/**
@@ -114,7 +115,7 @@ public class RequestCycleUrlForTest extends Assert
 		}; 
 		ResourceReferenceRequestHandler handler = new ResourceReferenceRequestHandler(reference);
 		CharSequence url = requestCycle.urlFor(handler);
-		assertEquals(RES_REF_URL, url);
+		assertEquals('.'+RES_REF_URL, url);
 	}
 
 	/**
@@ -136,7 +137,7 @@ public class RequestCycleUrlForTest extends Assert
 		};
 		ResourceReferenceRequestHandler handler = new ResourceReferenceRequestHandler(reference);
 		CharSequence url = requestCycle.urlFor(handler);
-		assertEquals(RES_REF_URL+JSESSIONID, url);
+		assertEquals('.'+RES_REF_URL+JSESSIONID, url);
 	}
 
 	/**
@@ -150,7 +151,7 @@ public class RequestCycleUrlForTest extends Assert
 		IStaticCacheableResource resource = mock(IStaticCacheableResource.class);
 		ResourceRequestHandler handler = new ResourceRequestHandler(resource, new PageParameters());
 		CharSequence url = requestCycle.urlFor(handler);
-		assertEquals(RESOURCE_URL, url);
+		assertEquals('.'+RESOURCE_URL, url);
 	}
 
 	/**
@@ -164,7 +165,7 @@ public class RequestCycleUrlForTest extends Assert
 		ByteArrayResource resource = new ByteArrayResource(null, new byte[] {1, 2}, "test.bin");
 		ResourceRequestHandler handler = new ResourceRequestHandler(resource, new PageParameters());
 		CharSequence url = requestCycle.urlFor(handler);
-		assertEquals(RESOURCE_URL + JSESSIONID, url);
+		assertEquals('.'+RESOURCE_URL + JSESSIONID, url);
 	}
 
 	/**
diff --git a/wicket-core/src/test/java/org/apache/wicket/request/cycle/UrlRendererTest.java b/wicket-core/src/test/java/org/apache/wicket/request/cycle/UrlRendererTest.java
index 3365ed4545..d70d9163d2 100644
--- a/wicket-core/src/test/java/org/apache/wicket/request/cycle/UrlRendererTest.java
+++ b/wicket-core/src/test/java/org/apache/wicket/request/cycle/UrlRendererTest.java
@@ -262,4 +262,28 @@ public class UrlRendererTest extends Assert
 		fullUrl = renderer.renderUrl(newUrl);
 		assertEquals("http://www.example.com:8888/four", fullUrl);
 	}
+
+	@Test
+	public void renderFullUrlAsRelativeToAnotherBaseUrl()
+	{
+		Url baseUrl = Url.parse("http://host:8080/contextPath/filterPath/a/b/c/d");
+		Url encodedFullUrl = Url.parse("http://host:8080/contextPath/filterPath/a/b;jsessionid=123456");
+
+		UrlRenderer renderer = new UrlRenderer(new MockWebRequest(baseUrl));
+		String encodedRelativeUrl = renderer.renderRelativeUrl(encodedFullUrl);
+
+		assertEquals("../../b;jsessionid=123456", encodedRelativeUrl);
+	}
+
+	@Test
+	public void renderFullUrlAsRelativeToAnotherBaseUrl_2()
+	{
+		Url baseUrl = Url.parse("/contextPath/filterPath/a/b/c/d");
+		Url encodedFullUrl = Url.parse("http://host:8080/contextPath/filterPath/a/b;jsessionid=123456");
+
+		UrlRenderer renderer = new UrlRenderer(new MockWebRequest(baseUrl));
+		String encodedRelativeUrl = renderer.renderRelativeUrl(encodedFullUrl);
+
+		assertEquals("../../b;jsessionid=123456", encodedRelativeUrl);
+	}
 }
