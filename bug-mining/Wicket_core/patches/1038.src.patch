diff --git a/wicket-core/src/main/java/org/apache/wicket/protocol/http/servlet/ServletWebResponse.java b/wicket-core/src/main/java/org/apache/wicket/protocol/http/servlet/ServletWebResponse.java
index e7e32d17a2..cdb418d427 100644
--- a/wicket-core/src/main/java/org/apache/wicket/protocol/http/servlet/ServletWebResponse.java
+++ b/wicket-core/src/main/java/org/apache/wicket/protocol/http/servlet/ServletWebResponse.java
@@ -173,7 +173,7 @@ public class ServletWebResponse extends WebResponse
 	{
 		Args.notNull(url, "url");
 
-		UrlRenderer urlRenderer = RequestCycle.get().getUrlRenderer();
+		UrlRenderer urlRenderer = getUrlRenderer();
 
 		Url originalUrl = Url.parse(url);
 
@@ -208,12 +208,22 @@ public class ServletWebResponse extends WebResponse
 		return encodedUrl;
 	}
 
+	private UrlRenderer getUrlRenderer()
+	{
+		RequestCycle requestCycle = RequestCycle.get();
+		if (requestCycle == null)
+		{
+			return new UrlRenderer(webRequest);
+		}
+		return requestCycle.getUrlRenderer();
+	}
+
 	@Override
 	public String encodeRedirectURL(CharSequence url)
 	{
 		Args.notNull(url, "url");
 
-		UrlRenderer urlRenderer = RequestCycle.get().getUrlRenderer();
+		UrlRenderer urlRenderer = getUrlRenderer();
 
 		Url originalUrl = Url.parse(url);
 
