diff --git a/wicket-core/src/main/java/org/apache/wicket/markup/head/ResourceAggregator.java b/wicket-core/src/main/java/org/apache/wicket/markup/head/ResourceAggregator.java
index 0ca16578ec..143d466517 100644
--- a/wicket-core/src/main/java/org/apache/wicket/markup/head/ResourceAggregator.java
+++ b/wicket-core/src/main/java/org/apache/wicket/markup/head/ResourceAggregator.java
@@ -232,6 +232,7 @@ public class ResourceAggregator extends DecoratingHeaderResponse
 	{
 		for (HeaderItem curDependency : item.getDependencies())
 		{
+			curDependency = getItemToBeRendered(curDependency);
 			if (depsDone.add(curDependency))
 			{
 				recordHeaderItem(curDependency, depsDone);
@@ -247,6 +248,7 @@ public class ResourceAggregator extends DecoratingHeaderResponse
 	@Override
 	public void render(HeaderItem item)
 	{
+		item = getItemToBeRendered(item);
 		if (item instanceof OnDomReadyHeaderItem)
 		{
 			renderDependencies(item, new LinkedHashSet<HeaderItem>());
@@ -297,7 +299,10 @@ public class ResourceAggregator extends DecoratingHeaderResponse
 		}
 		for (RecordedHeaderItem curRenderItem : sortedItemsToBeRendered)
 		{
-			getRealResponse().render(getItemToBeRendered(curRenderItem.getItem()));
+			if (markItemRendered(curRenderItem.getItem()))
+			{
+				getRealResponse().render(curRenderItem.getItem());
+			}
 		}
 	}
 
@@ -309,17 +314,12 @@ public class ResourceAggregator extends DecoratingHeaderResponse
 		StringBuilder combinedScript = new StringBuilder();
 		for (OnDomReadyHeaderItem curItem : domReadyItemsToBeRendered)
 		{
-			HeaderItem itemToBeRendered = getItemToBeRendered(curItem);
-			if (itemToBeRendered == curItem)
+			if (markItemRendered(curItem))
 			{
 				combinedScript.append('\n');
 				combinedScript.append(curItem.getJavaScript());
 				combinedScript.append(';');
 			}
-			else
-			{
-				getRealResponse().render(itemToBeRendered);
-			}
 		}
 		if (combinedScript.length() > 0)
 		{
@@ -330,17 +330,12 @@ public class ResourceAggregator extends DecoratingHeaderResponse
 		combinedScript.setLength(0);
 		for (OnLoadHeaderItem curItem : loadItemsToBeRendered)
 		{
-			HeaderItem itemToBeRendered = getItemToBeRendered(curItem);
-			if (itemToBeRendered == curItem)
+			if (markItemRendered(curItem))
 			{
 				combinedScript.append('\n');
 				combinedScript.append(curItem.getJavaScript());
 				combinedScript.append(';');
 			}
-			else
-			{
-				getRealResponse().render(itemToBeRendered);
-			}
 		}
 		if (combinedScript.length() > 0)
 		{
@@ -356,15 +351,34 @@ public class ResourceAggregator extends DecoratingHeaderResponse
 	{
 		for (OnDomReadyHeaderItem curItem : domReadyItemsToBeRendered)
 		{
-			getRealResponse().render(getItemToBeRendered(curItem));
+			if (markItemRendered(curItem))
+			{
+				getRealResponse().render(curItem);
+			}
 		}
 
 		for (OnLoadHeaderItem curItem : loadItemsToBeRendered)
 		{
-			getRealResponse().render(getItemToBeRendered(curItem));
+			if (markItemRendered(curItem))
+			{
+				getRealResponse().render(curItem);
+			}
 		}
 	}
 
+	private boolean markItemRendered(HeaderItem item)
+	{
+		if (wasRendered(item))
+			return false;
+
+		getRealResponse().markRendered(item);
+		for (HeaderItem curProvided : item.getProvidedResources())
+		{
+			getRealResponse().markRendered(curProvided);
+		}
+		return true;
+	}
+
 	/**
 	 * Resolves the actual item that needs to be rendered for the given item. This can be a
 	 * {@link NoHeaderItem} when the item was already rendered. It can also be a bundle or the item
@@ -375,27 +389,17 @@ public class ResourceAggregator extends DecoratingHeaderResponse
 	 */
 	private HeaderItem getItemToBeRendered(HeaderItem item)
 	{
-		while (item instanceof IWrappedHeaderItem)
+		HeaderItem innerItem = item;
+		while (innerItem instanceof IWrappedHeaderItem)
 		{
-			item = ((IWrappedHeaderItem)item).getWrapped();
+			innerItem = ((IWrappedHeaderItem)innerItem).getWrapped();
 		}
-		if (getRealResponse().wasRendered(item))
+		if (getRealResponse().wasRendered(innerItem))
 		{
 			return NoHeaderItem.get();
 		}
 
-		getRealResponse().markRendered(item);
-		HeaderItem bundle = Application.get().getResourceBundles().findBundle(item);
-		if (bundle == null)
-		{
-			return item;
-		}
-
-		for (HeaderItem curProvided : bundle.getProvidedResources())
-		{
-			getRealResponse().markRendered(curProvided);
-		}
-
-		return bundle;
+		HeaderItem bundle = Application.get().getResourceBundles().findBundle(innerItem);
+		return bundle == null ? item : bundle;
 	}
 }
diff --git a/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceAggregatorTest.java b/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceAggregatorTest.java
index 184b0ac3cc..3c077220f8 100644
--- a/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceAggregatorTest.java
+++ b/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceAggregatorTest.java
@@ -237,4 +237,19 @@ public class ResourceAggregatorTest extends WicketTestCase
 	{
 		aggregator.render(forReference(new ResourceReferenceCirc1()));
 	}
+
+	/**
+	 * bundle {bun1 -> x, bun2 -> y}, render [bun1], should render [x, y, bun12]
+	 */
+	@Test
+	public void testTwoResourcesWithBundleAsDependency()
+	{
+		HeaderItem bundle12 = Application.get()
+			.getResourceBundles()
+			.addJavaScriptBundle(Application.class, "bun12.js", new ResourceReferenceBun1(),
+				new ResourceReferenceBun2());
+		aggregator.render(forReference(new ResourceReferenceBun1()));
+		assertItems(forReference(new ResourceReferenceX()), forReference(new ResourceReferenceY()),
+			bundle12);
+	}
 }
diff --git a/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceReferenceBun1.java b/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceReferenceBun1.java
new file mode 100644
index 0000000000..4822779798
--- /dev/null
+++ b/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceReferenceBun1.java
@@ -0,0 +1,46 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.wicket.resource.aggregator;
+
+import static org.apache.wicket.markup.head.JavaScriptHeaderItem.forReference;
+
+import java.util.Collections;
+
+import org.apache.wicket.markup.head.HeaderItem;
+import org.apache.wicket.request.resource.JavaScriptResourceReference;
+
+/**
+ * js resource with dep on x
+ */
+public class ResourceReferenceBun1 extends JavaScriptResourceReference
+{
+	private static final long serialVersionUID = 1L;
+
+	/**
+	 * Construct.
+	 */
+	public ResourceReferenceBun1()
+	{
+		super(ResourceAggregatorTest.class, "bun1.js");
+	}
+
+	@Override
+	public Iterable<? extends HeaderItem> getDependencies()
+	{
+		return Collections.singletonList(forReference(new ResourceReferenceX()));
+	}
+}
\ No newline at end of file
diff --git a/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceReferenceBun2.java b/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceReferenceBun2.java
new file mode 100644
index 0000000000..ae9a8eab06
--- /dev/null
+++ b/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceReferenceBun2.java
@@ -0,0 +1,46 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.wicket.resource.aggregator;
+
+import static org.apache.wicket.markup.head.JavaScriptHeaderItem.forReference;
+
+import java.util.Collections;
+
+import org.apache.wicket.markup.head.HeaderItem;
+import org.apache.wicket.request.resource.JavaScriptResourceReference;
+
+/**
+ * js resource with dep on y
+ */
+public class ResourceReferenceBun2 extends JavaScriptResourceReference
+{
+	private static final long serialVersionUID = 1L;
+
+	/**
+	 * Construct.
+	 */
+	public ResourceReferenceBun2()
+	{
+		super(ResourceAggregatorTest.class, "bun2.js");
+	}
+
+	@Override
+	public Iterable<? extends HeaderItem> getDependencies()
+	{
+		return Collections.singletonList(forReference(new ResourceReferenceY()));
+	}
+}
\ No newline at end of file
diff --git a/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceReferenceX.java b/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceReferenceX.java
new file mode 100644
index 0000000000..ce873caf01
--- /dev/null
+++ b/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceReferenceX.java
@@ -0,0 +1,35 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.wicket.resource.aggregator;
+
+import org.apache.wicket.request.resource.JavaScriptResourceReference;
+
+/**
+ * js resource with no deps
+ */
+public class ResourceReferenceX extends JavaScriptResourceReference
+{
+	private static final long serialVersionUID = 1L;
+
+	/**
+	 * Construct.
+	 */
+	public ResourceReferenceX()
+	{
+		super(ResourceAggregatorTest.class, "x.js");
+	}
+}
\ No newline at end of file
diff --git a/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceReferenceY.java b/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceReferenceY.java
new file mode 100644
index 0000000000..438e8eada4
--- /dev/null
+++ b/wicket-core/src/test/java/org/apache/wicket/resource/aggregator/ResourceReferenceY.java
@@ -0,0 +1,35 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.wicket.resource.aggregator;
+
+import org.apache.wicket.request.resource.JavaScriptResourceReference;
+
+/**
+ * js resource with no deps
+ */
+public class ResourceReferenceY extends JavaScriptResourceReference
+{
+	private static final long serialVersionUID = 1L;
+
+	/**
+	 * Construct.
+	 */
+	public ResourceReferenceY()
+	{
+		super(ResourceAggregatorTest.class, "y.js");
+	}
+}
\ No newline at end of file
