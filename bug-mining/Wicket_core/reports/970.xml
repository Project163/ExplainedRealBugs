<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:22:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-5460] onBeforeRender called too early on stateless page</title>
                <link>https://issues.apache.org/jira/browse/WICKET-5460</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;I&apos;m having a problem with a ListView that displays an outdated list.&lt;br/&gt;
In my test, the ListView uses a Model that returns a static variable just to make sure the model is independent from any page instance. As far as I can tell, this problem has nothing to do with the model, but with the way Wicket prepares for a request listener invocation.&lt;/p&gt;

&lt;p&gt;The exact setup is this:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the page contains a ListView and (outside of the list) a Link that&lt;br/&gt;
adds an item to the list in its onClick(). The list itself is stored&lt;br/&gt;
in a static variable.&lt;/li&gt;
	&lt;li&gt;the page is stateless&lt;/li&gt;
	&lt;li&gt;the page&apos;s components are created in onInitialize()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Result:&lt;br/&gt;
The list doesn&apos;t show the most recently added item. Reloading the&lt;br/&gt;
original page shows the correct list. Note that by &quot;reloading&quot; I mean&lt;br/&gt;
entering the page&apos;s original URL since the browser&apos;s address bar now contains the request listener URL due to the page being stateless.&lt;/p&gt;

&lt;p&gt;This is how I think is happens:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Initially rendering the page works fine. The page is then discarded&lt;br/&gt;
since it&apos;s stateless.&lt;/li&gt;
	&lt;li&gt;Clicking on the link creates a new page instance to invoke the&lt;br/&gt;
link&apos;s request listener.&lt;/li&gt;
	&lt;li&gt;IPageAndComponentProvider.getComponent() cannot find the link yet&lt;br/&gt;
since it is not created until onInitialize() has been called.&lt;/li&gt;
	&lt;li&gt;as a consequence, it calls page.internalInitialize() and&lt;br/&gt;
internalPrepareForRender(false)&lt;/li&gt;
	&lt;li&gt;this creates the link, but it also creates the ListView and prepares&lt;br/&gt;
it for rendering. This in turn polls the ListView&apos;s model and creates&lt;br/&gt;
list items. It also marks the ListView as &quot;prepared for render&quot;, which&lt;br/&gt;
is the crucial point.&lt;/li&gt;
	&lt;li&gt;The link&apos;s request listener runs and adds an item to the list.&lt;/li&gt;
	&lt;li&gt;After the request listener handler, the page render handler runs&lt;/li&gt;
	&lt;li&gt;That handler renders the page, including the ListView&lt;/li&gt;
	&lt;li&gt;... but it doesn&apos;t call onBeforeRender() on the ListView anymore,&lt;br/&gt;
because it&apos;s already marked as &quot;prepared for render&quot;! So it doesn&apos;t&lt;br/&gt;
pick up the new, up-to-date list from its model.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m not sure if I&apos;m &quot;doing it wrong&quot;, but then it doesn&apos;t seem quite&lt;br/&gt;
right that onBeforeRender() gets called before invoking the listener,&lt;br/&gt;
but not actually before rendering. There&apos;s probably some kind of logic&lt;br/&gt;
behind the decision to run onBeforeRender() only when this hasn&apos;t yet&lt;br/&gt;
happened, right? Is there a general way to &quot;unprepare&quot; the component&lt;br/&gt;
in onClick()?&lt;/p&gt;

&lt;p&gt;&amp;#8212;&lt;br/&gt;
Re: #internalPrepareForRender(false) should not mark the page as rendered (thus the false parameter).&lt;/p&gt;

&lt;p&gt;The problem is, I think, not that the component is being marked as&lt;br/&gt;
&lt;b&gt;rendered&lt;/b&gt;, but as &lt;b&gt;prepared for render&lt;/b&gt;. From class Component:&lt;/p&gt;

&lt;p&gt;protected void onBeforeRender()&lt;br/&gt;
{&lt;br/&gt;
  setFlag(FLAG_PREPARED_FOR_RENDER, true);&lt;br/&gt;
  onBeforeRenderChildren();&lt;br/&gt;
  setRequestFlag(RFLAG_BEFORE_RENDER_SUPER_CALL_VERIFIED, true);&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;Note the first line. This causes subsequent invocations of&lt;br/&gt;
internalBeforeRender() to skip the relevant part.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12687305">WICKET-5460</key>
            <summary>onBeforeRender called too early on stateless page</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="svenmeier">Sven Meier</assignee>
                                    <reporter username="martin geisse">Martin Geisse</reporter>
                        <labels>
                    </labels>
                <created>Sat, 4 Jan 2014 10:10:47 +0000</created>
                <updated>Mon, 6 Jan 2014 20:17:15 +0000</updated>
                            <resolved>Mon, 6 Jan 2014 20:17:15 +0000</resolved>
                                    <version>6.12.0</version>
                    <version>7.0.0-M1</version>
                                    <fixVersion>6.14.0</fixVersion>
                    <fixVersion>7.0.0-M1</fixVersion>
                                    <component>wicket</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13862253" author="martin geisse" created="Sat, 4 Jan 2014 10:12:29 +0000"  >&lt;p&gt;attached quickstart that shows the problem&lt;/p&gt;</comment>
                            <comment id="13862955" author="svenmeier" created="Mon, 6 Jan 2014 12:40:31 +0000"  >&lt;p&gt;This can be easily fixed by always resetting the flag:&lt;/p&gt;

&lt;p&gt;diff --git a/wicket-core/src/main/java/org/apache/wicket/Component.java b/wicket-core/src/main/java/org/apache/wicket/Component.java&lt;br/&gt;
index fa0fe96..4f08edf 100644&lt;br/&gt;
&amp;#8212; a/wicket-core/src/main/java/org/apache/wicket/Component.java&lt;br/&gt;
+++ b/wicket-core/src/main/java/org/apache/wicket/Component.java&lt;br/&gt;
@@ -4175,9 +4175,10 @@&lt;br/&gt;
 	 */&lt;br/&gt;
 	void internalMarkRendering(boolean setRenderingFlag)&lt;br/&gt;
 	{&lt;br/&gt;
+		setFlag(FLAG_PREPARED_FOR_RENDER, false);&lt;br/&gt;
+&lt;br/&gt;
 		if (setRenderingFlag)&lt;/p&gt;
 		{
-			setFlag(FLAG_PREPARED_FOR_RENDER, false);
 			setFlag(FLAG_RENDERING, true);
 		}
&lt;p&gt; 		else&lt;/p&gt;

&lt;p&gt;Tests seems to be unaffected by this change, but I still want to look for caveats.&lt;/p&gt;</comment>
                            <comment id="13863027" author="svenmeier" created="Mon, 6 Jan 2014 14:51:16 +0000"  >&lt;p&gt;I pushed a fix in the master branch.&lt;/p&gt;</comment>
                            <comment id="13863360" author="svenmeier" created="Mon, 6 Jan 2014 20:17:15 +0000"  >&lt;p&gt;FLAG_PREPARED_FOR_RENDER is now reset&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12621460" name="beforerender-bug.zip" size="25932" author="martin geisse" created="Sat, 4 Jan 2014 10:12:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>366303</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 45 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1r53b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>366614</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>