<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:16:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-3312] Tomcat complains about thread local memory leaking when using wickets XForwardedRequestWrapperFactory</title>
                <link>https://issues.apache.org/jira/browse/WICKET-3312</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;o.a.w.protocol.http.servlet.XForwardedRequestWrapperFactory can be used to wrap incoming servlet request into o.a.w.protocol.http.servlet.XForwardedRequestWrapper objects. These objects store a SimpleDateFormat array in a private static thread local memory but theye are never cleared. Tomcats memory leak prevention listener detects when the webapp is stopped. Tomcat 7.0.5 logs several times the followings:&lt;/p&gt;

&lt;p&gt;2011.01.07. 12:50:59 org.apache.catalina.loader.WebappClassLoader clearThreadLocalMap&lt;br/&gt;
SEVERE: The web application &lt;span class=&quot;error&quot;&gt;&amp;#91;/wtl&amp;#93;&lt;/span&gt; created a ThreadLocal with key of type &lt;span class=&quot;error&quot;&gt;&amp;#91;null&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.wicket.protocol.http.servlet.XForwardedRequestWrapper$1@6328edf2&amp;#93;&lt;/span&gt;) and a value of type [java.text.SimpleDateFormat[]] (value [&lt;span class=&quot;error&quot;&gt;&amp;#91;Ljava.text.SimpleDateFormat;@141dddba&amp;#93;&lt;/span&gt;) but failed to remove it when the web application was stopped. This is very likely to create a memory leak.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12494937">WICKET-3312</key>
            <summary>Tomcat complains about thread local memory leaking when using wickets XForwardedRequestWrapperFactory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ivaynberg">Igor Vaynberg</assignee>
                                    <reporter username="akiraly">Attila Kir&#225;ly</reporter>
                        <labels>
                    </labels>
                <created>Fri, 7 Jan 2011 12:27:26 +0000</created>
                <updated>Sun, 16 Jan 2011 18:54:32 +0000</updated>
                            <resolved>Mon, 10 Jan 2011 01:26:25 +0000</resolved>
                                    <version>1.5-M3</version>
                                    <fixVersion>1.5-RC1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12978759" author="akiraly" created="Fri, 7 Jan 2011 12:29:45 +0000"  >&lt;p&gt;Attaching a patch against current trunk. Tests pass, tomcat does not complain anymore.&lt;/p&gt;

&lt;p&gt;Patch simply drops static threadlocal variable and uses instance variable to hold the SimpleDateFormat array.&lt;/p&gt;</comment>
                            <comment id="12979186" author="ivaynberg" created="Sat, 8 Jan 2011 19:37:12 +0000"  >&lt;p&gt;can you provide some log output of this and a simple quickstart that reproduces it?&lt;/p&gt;

&lt;p&gt;doesnt make sense that memory &quot;leaks&quot;, it is a threadlocal so there will be as many entries as there are threads in the server&apos;s threadpool - but not more.&lt;/p&gt;

&lt;p&gt;your patch is bad because simpledateformat is not threadsafe, so your patch will cause concurrency errors. if we remove the threadlocal we have to sync on the formats, but that is not as efficient as using a threadlocal.&lt;/p&gt;

&lt;p&gt;i will close this until you provide the logs and/or a quickstart.&lt;/p&gt;</comment>
                            <comment id="12979391" author="akiraly" created="Sun, 9 Jan 2011 19:08:11 +0000"  >&lt;p&gt;Please reopen this issue.&lt;/p&gt;

&lt;p&gt;I. Quickstart&lt;br/&gt;
I am attaching a quickstart maven project. To reproduce do the followings:&lt;br/&gt;
1. Unzip quickstart.zip, run &quot;mvn package&quot; from wt directory to generate wt.war in target directory.&lt;br/&gt;
2. Start up a vanilla Tomcat installation (6.0.29 and 7.0.5 are both fine).&lt;br/&gt;
3. Copy wt.war into the webapps directory of tomcat. After a few seconds Tomcat will notice the new war and deploy it (unzip into wt directory). This can be seen on console / in log.&lt;br/&gt;
4. Visit &lt;a href=&quot;http://localhost:8080/wt/index.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/wt/index.html&lt;/a&gt; . You should see &quot;Hello World&quot;&lt;br/&gt;
5. Delete wt.war from tomcats webapps directory. After a few seconds Tomcat will notice this change and undeploy the war (delete wt directory). When this is done Tomcat will log the following:&lt;/p&gt;

&lt;p&gt;SEVERE: The web application &lt;span class=&quot;error&quot;&gt;&amp;#91;/wt&amp;#93;&lt;/span&gt; created a ThreadLocal with key of type &lt;span class=&quot;error&quot;&gt;&amp;#91;null&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.wicket.protocol.http.servlet.XForwardedRequestWrapper$1@7dc21ece&amp;#93;&lt;/span&gt;) and a value of type [java.text.SimpleDateFormat[]] (value [&lt;span class=&quot;error&quot;&gt;&amp;#91;Ljava.text.SimpleDateFormat;@5374a6e2&amp;#93;&lt;/span&gt;) but failed to remove it when the web application was stopped. This is very likely to create a memory leak.&lt;/p&gt;


&lt;p&gt;II. The reason for this leak is the following (imho).&lt;br/&gt;
Tomcat (and probably other servlet containers too) work like these:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;They have a common thread pool. The threads in this pool are used to serve request for all web applications. The lifecycle of the threads is different than the webapps.&lt;/li&gt;
	&lt;li&gt;Each webapp has its own Web Application Classloader instance. This WAC is used to load the classes bundled with the webapp.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;XForwardedRequestWrapper defines and uses a ThreadLocal subclass (let us call it S). S is bundled inside the wicket jars with the webapp so it is loaded by the WAC. The instances of S are hold in the thread locals of threads. When the application is undeployed/redeployed Tomcat drops the references to WAC in the hope the GC will reclaim the memory of all loaded classes by this loader. However the threads live and in the thread local an instance of S is referenced. This instance holds a reference to the S class. The S class holds reference to the WAC object. The WAC object holds references to every classes it loaded. This is the reason for the leak. And because we are talking about classes this is a leak in the permgen space not in the heap. Tomcat detects and clears it but not all servlet containers do this. For more info see Tomcat wiki &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;Logback had a similar issue last year they fixed it too. See &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &amp;amp; &lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; for it.&lt;/p&gt;


&lt;p&gt;III. About the thread safety of my patch&lt;br/&gt;
Yes SimpleDateFormat is not thread safe, I know that. My patch moves the SimpleDateFormat array from a static variable to an instance variable of a servlet request wrapper object. My assumption was when I made the test that servlet requests and servlet request wrappers do not have to be thread safe because they can only be used by one thread at a time.&lt;br/&gt;
Servlet spec 3.0 states the same:&lt;br/&gt;
&quot;2.3.3.4&lt;br/&gt;
Thread Safety&lt;br/&gt;
Other than the startAsync and complete methods, implementations of the &lt;br/&gt;
request and response objects are not guaranteed to be thread safe. This means that &lt;br/&gt;
they should either only be used within the scope of the request handling thread or &lt;br/&gt;
the application must ensure that access to the request and response objects are &lt;br/&gt;
thread safe.&lt;br/&gt;
If a thread created by the application uses the container-managed objects, such as &lt;br/&gt;
the request or response object, those objects must be accessed only within the &lt;br/&gt;
object&apos;s life cycle as defined in sections 3.10 and 5.6. Be aware that other than the &lt;br/&gt;
startAsync, and complete methods, the request and response objects are not &lt;br/&gt;
thread safe. If those objects were accessed in the multiple threads, the access should &lt;br/&gt;
be synchronized or be done through a wrapper to add the thread safety, for instance, &lt;br/&gt;
synchronizing the call of the methods to access the request attribute, or using a local &lt;br/&gt;
output stream for the response object within a thread.&quot;&lt;br/&gt;
Also some other libraries think the same about request wrappers.&lt;br/&gt;
Jiras CapturingRequestWrapper &lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt;:&lt;br/&gt;
&quot;THREAD SAFETY - One of these must be constructed on each HTTP request/response and hence only one thread may write to it at the one time. This suits the whole servlet engine idea,&quot;&lt;br/&gt;
Spring security 2.0 SavedRequestAwareWrapper uses a SimpleDateFormat array &lt;span class=&quot;error&quot;&gt;&amp;#91;5&amp;#93;&lt;/span&gt; (this class is not present in the 3.0.x branch):&lt;br/&gt;
&quot;protected SimpleDateFormat[] formats&lt;br/&gt;
The set of SimpleDateFormat formats to use in getDateHeader(). Notice that because SimpleDateFormat is not thread-safe, we can&apos;t declare formats[] as a static variable.&quot;&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; Tomcat wiki about memory leaks: &lt;a href=&quot;http://wiki.apache.org/tomcat/MemoryLeakProtection#customThreadLocal&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://wiki.apache.org/tomcat/MemoryLeakProtection#customThreadLocal&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; Logback issue about UnsynchronizedAppenderBase: &lt;a href=&quot;http://jira.qos.ch/browse/LBCLASSIC-183&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://jira.qos.ch/browse/LBCLASSIC-183&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; Logback git diff for UnsynchronizedAppenderBase (ThreadLocal subclass holds Boolean): &lt;a href=&quot;https://github.com/ceki/logback/commit/93995946b59b3ed1622d92c06b39c21942d98c58&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ceki/logback/commit/93995946b59b3ed1622d92c06b39c21942d98c58&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt; Jiras CapturingRequestWrapper: &lt;a href=&quot;http://docs.atlassian.com/software/jira/docs/api/latest/com/atlassian/jira/util/http/request/CapturingRequestWrapper.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.atlassian.com/software/jira/docs/api/latest/com/atlassian/jira/util/http/request/CapturingRequestWrapper.html&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;5&amp;#93;&lt;/span&gt; SavedRequestAwareWrapper class in Spring security 2.0: &lt;a href=&quot;http://static.springsource.org/spring-security/site/docs/2.0.x/apidocs/org/springframework/security/wrapper/SavedRequestAwareWrapper.html#formats&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://static.springsource.org/spring-security/site/docs/2.0.x/apidocs/org/springframework/security/wrapper/SavedRequestAwareWrapper.html#formats&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12979448" author="ivaynberg" created="Mon, 10 Jan 2011 01:26:25 +0000"  >&lt;p&gt;applied. i didnt realize the wrapper existed for a single request only. i dont think constructing those 3 formats will be too expensive.&lt;/p&gt;

&lt;p&gt;i also didnt realize the leak was on undeploy, that makes sense. thats the piece you shouldve mentioned in your initial issue description &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;cheers.&lt;/p&gt;</comment>
                            <comment id="12982301" author="bornmw" created="Sun, 16 Jan 2011 14:26:06 +0000"  >&lt;p&gt;Guys, I&apos;m seeing exactly the same issue on 6.0.26:&lt;/p&gt;

&lt;p&gt;SEVERE: A web application created a ThreadLocal with key of type &lt;span class=&quot;error&quot;&gt;&amp;#91;null&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;com.opensymphony.xwork2.inject.ContainerImpl$10@65ddc55f&amp;#93;&lt;/span&gt;) and a value of type [java.lang.Object[]] (value [&lt;span class=&quot;error&quot;&gt;&amp;#91;Ljava.lang.Object;@5d79a22d&amp;#93;&lt;/span&gt;) but failed to remove it when the web application was stopped. To prevent a memory leak, the ThreadLocal has been forcibly removed.&lt;/p&gt;

&lt;p&gt;I&apos;m keeping the EntityManager in ThreadLocal, and that message above floods catalina.out each time I shutdown Tomcat.&lt;/p&gt;

&lt;p&gt;Does my issue seem to be the same as the one originally reported by Attila?&lt;/p&gt;

&lt;p&gt;Do I understand it right that this issue is fixed in Tomcat 7 and not 6?&lt;/p&gt;

&lt;p&gt;If yes then should I create a separate issue for 6?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="12982362" author="akiraly" created="Sun, 16 Jan 2011 18:54:32 +0000"  >&lt;p&gt;@Oleg Mikheev&lt;/p&gt;

&lt;p&gt;It is not a tomcat issue. Tomcat only reports that you have a memory leak related error in your application. For more info you can read the links provided in a previous post or ask on the tomcat user list. This discussion is very off topic here, because this is the wicket frameworks issue tracker and your problem is not related to wicket.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12467717" name="WICKET-3312.patch" size="1480" author="akiraly" created="Fri, 7 Jan 2011 12:29:45 +0000"/>
                            <attachment id="12467845" name="quickstart.zip" size="3628" author="akiraly" created="Sun, 9 Jan 2011 19:08:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>204118</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 44 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0kbbj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>116651</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>