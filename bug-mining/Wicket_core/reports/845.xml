<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:21:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-5147] WicketTester MockHttpRequest.getCookies very slow / OutOfMemory</title>
                <link>https://issues.apache.org/jira/browse/WICKET-5147</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>
&lt;p&gt;We have an extensive set of WicketTester tests. Recently, the wicket RELEASE in the maven repository changed to 6.7.0. After the new version, our tests got very slow.&lt;/p&gt;

&lt;p&gt;When profiling, I discovered that the MockHttpRequest.getCookies() was taking up a lot of time. Also, tests failed because of OutOfMemory exceptions. My guess is that somehow a lot of objects are created at such speeds that the GC cannot clean them&lt;/p&gt;

&lt;p&gt;I will investigate further, but switching back to 6.6.0 solved the issue. &lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Edit&amp;#93;&lt;/span&gt;&lt;br/&gt;
The tests are run with TestNG and using &apos;mvn test&apos;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12642888">WICKET-5147</key>
            <summary>WicketTester MockHttpRequest.getCookies very slow / OutOfMemory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgrigorov">Martin Tzvetanov Grigorov</assignee>
                                    <reporter username="robau">Rob Audenaerde</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Apr 2013 10:15:11 +0000</created>
                <updated>Fri, 26 Apr 2013 09:03:18 +0000</updated>
                            <resolved>Fri, 26 Apr 2013 09:03:18 +0000</resolved>
                                    <version>6.7.0</version>
                                    <fixVersion>6.8.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                                                            <comments>
                            <comment id="13633953" author="robau" created="Wed, 17 Apr 2013 11:07:58 +0000"  >&lt;p&gt;During debugging a test, I see the number of Cookies is doubled a lot of times. This would explain the huge increase in memory. &lt;/p&gt;</comment>
                            <comment id="13633955" author="robau" created="Wed, 17 Apr 2013 11:08:40 +0000"  >&lt;p&gt;The Cookies all contain the same data.&lt;/p&gt;</comment>
                            <comment id="13633958" author="mgrigorov" created="Wed, 17 Apr 2013 11:16:20 +0000"  >&lt;p&gt;Please attach a test case that shows the problematic behavior.&lt;/p&gt;</comment>
                            <comment id="13633961" author="robau" created="Wed, 17 Apr 2013 11:19:32 +0000"  >&lt;p&gt;I will try to make one. It is a bit of work, as I need an AuthenticaedWebsession and (a lot of) ajax-calls&lt;/p&gt;</comment>
                            <comment id="13633978" author="robau" created="Wed, 17 Apr 2013 12:22:49 +0000"  >&lt;p&gt;The test &apos;changeLabelTwoTimes&apos; test will fail. The number of cookies in the request will be 16 after the first call (too much already) and is 64 after the second call. &lt;br/&gt;
I would expect them to be 1.&lt;/p&gt;
</comment>
                            <comment id="13634373" author="michael.mosmann" created="Wed, 17 Apr 2013 20:15:49 +0000"  >&lt;p&gt;think,i found it..&lt;/p&gt;</comment>
                            <comment id="13634871" author="michael.mosmann" created="Thu, 18 Apr 2013 06:03:23 +0000"  >&lt;p&gt;First Bugfix in &lt;a href=&quot;https://github.com/apache/wicket/pull/35&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/pull/35&lt;/a&gt; ... but there should be a lot more tests.. so do NOT pull this, i will make an other refactoring with more test, hopefully without this reformating stuff..&lt;/p&gt;</comment>
                            <comment id="13638529" author="michael.mosmann" created="Mon, 22 Apr 2013 22:43:08 +0000"  >&lt;p&gt;I did a second try:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/wicket/pull/36&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/pull/36&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This way i fixed some bugs, wrote some tests, fixed the docu, fixed this reformating problem, and so on.&lt;/p&gt;</comment>
                            <comment id="13640205" author="mgrigorov" created="Wed, 24 Apr 2013 07:54:08 +0000"  >&lt;p&gt;Rob,&lt;/p&gt;

&lt;p&gt;Please check &lt;a href=&quot;http://markmail.org/thread/an4g2mx5bpemc7nw&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://markmail.org/thread/an4g2mx5bpemc7nw&lt;/a&gt;&lt;br/&gt;
Do you destroy WicketTester after your tests ?&lt;/p&gt;</comment>
                            <comment id="13640248" author="robau" created="Wed, 24 Apr 2013 08:47:15 +0000"  >&lt;p&gt;I do not destroy the WicketTester. But I also do not reuse the WicketTester between tests. My UI tests use this piece of code:&lt;/p&gt;

&lt;p&gt;        @BeforeMethod&lt;br/&gt;
	public final void setupTest() throws Exception&lt;/p&gt;
	{
		LOG.info( &quot;Running test in class:&quot; + this.getClass() );

		this.wicketTester = new WicketTester( this.wicketApplication );
		this.login();
	}

&lt;p&gt;Besides that, I see the number of cookies increase expontentially in my testcase in the attached zip.&lt;/p&gt;</comment>
                            <comment id="13640267" author="mgrigorov" created="Wed, 24 Apr 2013 09:10:21 +0000"  >&lt;p&gt;We will fix the issue for Wicket 6.8.0. I&apos;m just trying to tell you that you hit OOM because your tests leak resources.&lt;br/&gt;
Cookie class is quite small. You have to produce a lot of instances to fill the memory. I doubt that you create so many cookies in a single test to run out of memory. It is just that resources from a previous usage of WicketTester are not recycled during the whole run of the test suite.&lt;/p&gt;

&lt;p&gt;I see you reuse the application instance for the different instances of WicketTester. This is already a candidate for memory leaks.&lt;br/&gt;
I guess you do this to avoid costly initializations, like initializing Spring for example.&lt;/p&gt;</comment>
                            <comment id="13640291" author="robau" created="Wed, 24 Apr 2013 09:35:02 +0000"  >&lt;p&gt;Hi Martin, &lt;/p&gt;

&lt;p&gt;Thanks for the resolution. And you are right that I&apos;m injecting the WicketAppliction using Spring &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;BTW. The problem is not that the Cookie itself is big, but rather that going through some ajax calls within one test causes the number of cookies to double and double and double; so basically having one cookie will cause OOM after a slightly bigger test, (for example 20 ajaxcalls will cause at least 2^20 (~ 1 million) cookies.). &lt;/p&gt;

&lt;p&gt;Some context: In our application users can set filters in a few mouseclicks, but to make sure they have to do as little as possible, I want to remove all the options that are not applicable after each choice. Typically, the user will select 2 to 4 filters and some operators, so &apos;normal&apos; behaviour would be around 4 to 8 ajax calls. I want to fuzztest this component. The number of filters and operations that I use in the fuzztest go up to 10, causing the OOM&lt;/p&gt;
</comment>
                            <comment id="13642374" author="michael.mosmann" created="Thu, 25 Apr 2013 23:36:11 +0000"  >&lt;p&gt;Ok. &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I have fixed it.&lt;/li&gt;
	&lt;li&gt;I have extended the test to check if cookies are visible in tester.getRequest().&lt;/li&gt;
	&lt;li&gt;I did check the quickstart.&lt;/li&gt;
	&lt;li&gt;I have updated comments&lt;br/&gt;
Everything is fine.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13642378" author="michael.mosmann" created="Thu, 25 Apr 2013 23:43:13 +0000"  >&lt;p&gt;Someone should have a look at &lt;a href=&quot;https://github.com/apache/wicket/pull/36&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/pull/36&lt;/a&gt; for code review...&lt;/p&gt;</comment>
                            <comment id="13642696" author="mgrigorov" created="Fri, 26 Apr 2013 09:03:18 +0000"  >&lt;p&gt;Thank you for the help, Michael!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12628123">WICKET-4989</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12579119" name="testcookies.zip" size="28224" author="robau" created="Wed, 17 Apr 2013 12:21:42 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12644375">WICKET-5155</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>323301</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 30 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1js33:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>323646</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>