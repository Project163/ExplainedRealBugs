<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:26:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-6845] stackoverflow while serializing a page containing a reference to session</title>
                <link>https://issues.apache.org/jira/browse/WICKET-6845</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;Something has changed in the way pages are serialized in wicket 9.x thus that if a page has a reference to session serialization enters in a loop causing an stack overflow. See attached  project. While there is no reasons to keep a reference to session, and I have fixed that in our legacy code causing this problem,  it would be nice to avoid server crashing because of this (and log a huge warning for users to note).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13336251">WICKET-6845</key>
            <summary>stackoverflow while serializing a page containing a reference to session</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgrigorov">Martin Tzvetanov Grigorov</assignee>
                                    <reporter username="reiern70">Ernesto Reinaldo Barreiro</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Oct 2020 09:37:28 +0000</created>
                <updated>Fri, 23 Oct 2020 07:51:39 +0000</updated>
                            <resolved>Thu, 22 Oct 2020 18:25:42 +0000</resolved>
                                    <version>9.0.0</version>
                    <version>9.1.0</version>
                                    <fixVersion>9.2.0</fixVersion>
                                    <component>wicket</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17217551" author="mgrigorov" created="Tue, 20 Oct 2020 12:09:44 +0000"  >&lt;p&gt;We have &lt;a href=&quot;https://github.com/apache/wicket/blob/master/wicket-core/src/main/java/org/apache/wicket/core/util/objects/checker/SessionChecker.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/blob/master/wicket-core/src/main/java/org/apache/wicket/core/util/objects/checker/SessionChecker.java&lt;/a&gt; for &quot;logging a huge warning&quot;.&lt;/p&gt;

&lt;p&gt;Maybe it should be enabled by default in DEV mode ?!&lt;/p&gt;</comment>
                            <comment id="17217608" author="reiern70" created="Tue, 20 Oct 2020 13:24:27 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17217635" author="reiern70" created="Tue, 20 Oct 2020 14:36:04 +0000"  >&lt;p&gt;It would be interesting to know what have changed... that on 8.x example is working and on 9.x is not. I haven&apos;t had time to debug yet.&lt;/p&gt;</comment>
                            <comment id="17217893" author="svenmeier" created="Tue, 20 Oct 2020 19:52:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgrigorov&quot; class=&quot;user-hover&quot; rel=&quot;mgrigorov&quot;&gt;mgrigorov&lt;/a&gt; To save you a little time, I already found the reason:&lt;/p&gt;

&lt;p&gt;When the page is serialized, the session is serialized too, including all pages contained in InSessionPageStore&apos;s data. This loops into serializing the page again &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;In Wicket 8.x non-serialized pages in the PagesCache (InSessionPageStore&apos;s 8.x equivalent) are just dropped on serialization.&lt;/p&gt;</comment>
                            <comment id="17217898" author="mgrigorov" created="Tue, 20 Oct 2020 19:59:05 +0000"  >&lt;p&gt;I have a fix for it.&lt;/p&gt;

&lt;p&gt;Even two fixes.&lt;/p&gt;

&lt;p&gt;Now running the tests and I will push.&lt;/p&gt;</comment>
                            <comment id="17217907" author="jira-bot" created="Tue, 20 Oct 2020 20:10:15 +0000"  >&lt;p&gt;Commit 8664176abcc6393c54b29d058c655d440500bc8d in wicket&apos;s branch refs/heads/master from Martin Tzvetanov Grigorov&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=wicket.git;h=8664176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=wicket.git;h=8664176&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6845&quot; title=&quot;stackoverflow while serializing a page containing a reference to session&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6845&quot;&gt;&lt;del&gt;WICKET-6845&lt;/del&gt;&lt;/a&gt; stackoverflow while serializing a page containing a reference to session&lt;/p&gt;

&lt;p&gt;Make sure an HTTP session is created before committing the response.&lt;br/&gt;
This is needed because org.apache.wicket.pageStore.RequestPageStore#detach() is called after committing the response and it is too late to create an HTTP session at that time.&lt;/p&gt;</comment>
                            <comment id="17217908" author="jira-bot" created="Tue, 20 Oct 2020 20:10:17 +0000"  >&lt;p&gt;Commit d929d852e75567e32a2864674b821900c4929eed in wicket&apos;s branch refs/heads/master from Martin Tzvetanov Grigorov&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=wicket.git;h=d929d85&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=wicket.git;h=d929d85&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6845&quot; title=&quot;stackoverflow while serializing a page containing a reference to session&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6845&quot;&gt;&lt;del&gt;WICKET-6845&lt;/del&gt;&lt;/a&gt; stackoverflow while serializing a page containing a reference to session&lt;/p&gt;

&lt;p&gt;Remove the page from InSessionPageStore#pages before trying to serialize it to prevent stackoverflow when the page keeps a reference to the Wicket Session.&lt;/p&gt;</comment>
                            <comment id="17217909" author="mgrigorov" created="Tue, 20 Oct 2020 20:18:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=svenmeier&quot; class=&quot;user-hover&quot; rel=&quot;svenmeier&quot;&gt;svenmeier&lt;/a&gt; What do you think about the changes ?&lt;/p&gt;</comment>
                            <comment id="17217911" author="mgrigorov" created="Tue, 20 Oct 2020 20:23:26 +0000"  >&lt;p&gt;Adding&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (usesDevelopmentConfig())
{
   JavaSerializer serializer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JavaSerializer(getName())
   {
      @Override
      &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; ObjectOutputStream newObjectOutputStream(OutputStream out) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
      {
         IObjectChecker checker = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SessionChecker();
         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CheckingObjectOutputStream(out, checker);
      }
   };
   getFrameworkSettings().setSerializer(serializer);
} 

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to MyApplication#init() produces this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[qtp385242642-17] ERROR org.apache.wicket.serialize.java.JavaSerializer - Error serializing object &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;com.test.HomePage [object=[Page class = com.test.HomePage, id = 0, render count = 1]]
org.apache.wicket.core.util.objects.checker.CheckingObjectOutputStream$ObjectCheckException: Trying to serialize the Wicket Session!
A problem occurred &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; checking object with type: org.apache.wicket.protocol.http.WebSession
Field hierarchy is:
   [class=com.test.HomePage, path=0]
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; com.test.TestBean com.test.HomePage.testBean [class=com.test.TestBean]
      &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; org.apache.wicket.Session com.test.TestBean.session [class=org.apache.wicket.protocol.http.WebSession] &amp;lt;----- field that is causing the problem
	at org.apache.wicket.core.util.objects.checker.CheckingObjectOutputStream.internalCheck(CheckingObjectOutputStream.java:371)
	at org.apache.wicket.core.util.objects.checker.CheckingObjectOutputStream.check(CheckingObjectOutputStream.java:354)
        ... &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;but I am not sure whether we want to enable this checker for everyone.&lt;/p&gt;

&lt;p&gt;At the moment Wicket first serializes the page without checking and if it fails with NotSerializableException then it uses org.apache.wicket.core.util.objects.checker.ObjectSerializationChecker to print which field is not Serializable. I.e. the extra cost for the checking is executed only if there is a problem.&lt;/p&gt;

&lt;p&gt;But in the current case one has to enable SessionChecker by default in DEV mode to find the problem. Otherwise StackOverflowError won&apos;t allow the second run of the serialization with the checkers.&lt;/p&gt;</comment>
                            <comment id="17218188" author="reiern70" created="Wed, 21 Oct 2020 08:38:25 +0000"  >&lt;p&gt;Hi Martin,&lt;/p&gt;

&lt;p&gt;Many thanks for the fix. My idea about the warning was:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Serializer  is only used in serializing thread. Then make it a thread local.&lt;/li&gt;
	&lt;li&gt;If code arrives to where a new serializer has to be created or used that probably means we are entering a loop. Then halt serialization and SCREAM a warning.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17218195" author="mgrigorov" created="Wed, 21 Oct 2020 08:56:22 +0000"  >&lt;p&gt;Hi Ernesto,&lt;/p&gt;

&lt;p&gt;I am not sure what you mean. Where exactly do you think this check should be added ?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Here is how Java Serialization works:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Wicket&apos;s JavaSerializer calls ObjectOutputStream#write(page).&lt;/li&gt;
	&lt;li&gt;from here on Java Serialization related classes start writing all non-transient and non-static fields of the Page and the fields of inner components, etc.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Java Serialization usually is smart and does not write second time the same object instance but just uses a pointer to the already serialized data. But in the current case it was not able to detect this because we make a new call to JavaSerializer#serialize(Page) that uses a new ObjectOutputStream and all the caches and pointers are not known here.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17218988" author="svenmeier" created="Thu, 22 Oct 2020 12:57:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgrigorov&quot; class=&quot;user-hover&quot; rel=&quot;mgrigorov&quot;&gt;mgrigorov&lt;/a&gt; I think your commit with regarding the AsynchronousPageStore and HTTP session belongs to &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6702&quot; title=&quot;AsynchronousPageStore with NotDetachedModelChecker - &amp;quot;Not detached model found&amp;quot; exception on several fast sequential Ajax calls&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6702&quot;&gt;&lt;del&gt;WICKET-6702&lt;/del&gt;&lt;/a&gt; and the comment from&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reiern70&quot; class=&quot;user-hover&quot; rel=&quot;reiern70&quot;&gt;reiern70&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think this is a good solution and we should create a separate issue for 9.2.0 for that.&lt;/p&gt;</comment>
                            <comment id="17219032" author="jira-bot" created="Thu, 22 Oct 2020 14:14:30 +0000"  >&lt;p&gt;Commit f9f960e3e07fa1499a82f9686d9c87ed9dae597f in wicket&apos;s branch refs/heads/master from Sven Meier&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=wicket.git;h=f9f960e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=wicket.git;h=f9f960e&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6845&quot; title=&quot;stackoverflow while serializing a page containing a reference to session&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6845&quot;&gt;&lt;del&gt;WICKET-6845&lt;/del&gt;&lt;/a&gt; by default session cache should not serialize&lt;/p&gt;

&lt;p&gt;If the session gets serialized, pages can be acquired from persistent store again.&lt;/p&gt;

&lt;p&gt;Added comments for prevention of serialization loop (if InSessionPageStore does indeed&lt;br/&gt;
serialize).&lt;br/&gt;
Corrected JavaDoc of DefaultPageManagerProvider.&lt;/p&gt;</comment>
                            <comment id="17219042" author="svenmeier" created="Thu, 22 Oct 2020 14:18:26 +0000"  >&lt;p&gt;+1 The prevention of the serialization-loop is a good trick.&lt;/p&gt;

&lt;p&gt;I&apos;ve changed another thing though: The session cache of DefaultPageManagerProvider does not need to serialize pages on session serialization anyway. They can be acquired from any other persistent store instead. This is something I&apos;ve got wrong when restructuring page stores for Wicket 9.x - this is why this stack-overflow is not happening on 8.x&lt;/p&gt;</comment>
                            <comment id="17219124" author="mgrigorov" created="Thu, 22 Oct 2020 15:55:23 +0000"  >&lt;p&gt;Is there anything more to do for this ticket ?&lt;/p&gt;

&lt;p&gt;May I close it ?&lt;/p&gt;</comment>
                            <comment id="17219132" author="svenmeier" created="Thu, 22 Oct 2020 16:05:55 +0000"  >&lt;p&gt;+1 should all be fine now&lt;/p&gt;</comment>
                            <comment id="17219530" author="reiern70" created="Fri, 23 Oct 2020 07:51:39 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgrigorov&quot; class=&quot;user-hover&quot; rel=&quot;mgrigorov&quot;&gt;mgrigorov&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;This second call JavaSerializer#serialize(Page)  is what I wanted to prevent via a thread local (as serialization happens in a single thread). Before calling JavaSerializer#serialize(Page) check thread and make sure it is the first time it has been/will be called. That way even if thing broke somewhere else loop will be prevented. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13336769">WICKET-6847</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13013850" name="session-serialization.tar.gz" size="34735" author="reiern70" created="Tue, 20 Oct 2020 09:32:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 3 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0juaw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>