<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:25:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-6629] OOM (and disk) in AsynchronousPageStore</title>
                <link>https://issues.apache.org/jira/browse/WICKET-6629</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;Symptoms:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Out of memory on DiskDataStore.sessionEntryMap, map contains tens of thousands of DiskDataStore$SessionEntry&apos;s&lt;/li&gt;
	&lt;li&gt;The vm only contains a few hundred PageStoreManager$SessionEntry&apos;s. This is expected, but not consistent with the number of DiskDataStore$SessionEntry&apos;s&lt;/li&gt;
	&lt;li&gt;Slowly growing disk usage, the Wicket filestore contains millions of directories, up to the point where even ls becomes unusable.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Snippet from our productions logs (Wicket 8.2.0):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2019-01-09 17:09:40,662 DEBUG [org.apache.wicket.session.HttpSessionStore] (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; task-2513) Session unbound: 5nSIPXlkpRkGu5Oo3_wuwf801Y6TM3K1_k-95uIi
2019-01-09 17:09:40,662 DEBUG [org.apache.wicket.pageStore.DiskDataStore] (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; task-2513) Removing data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; pages in session with id &lt;span class=&quot;code-quote&quot;&gt;&apos;5nSIPXlkpRkGu5Oo3_wuwf801Y6TM3K1_k-95uIi&apos;&lt;/span&gt;
2019-01-09 17:09:40,663 DEBUG [org.apache.wicket.pageStore.AsynchronousDataStore] (Wicket-AsyncDataStore-PageSavingThread) PageSavingRunnable:: Saving asynchronously: Entry [sessionId=5nSIPXlkpRkGu5Oo3_wuwf801Y6TM3K1_k-95uIi, pageId=2]...
2019-01-09 17:09:40,663 DEBUG [org.apache.wicket.pageStore.DiskDataStore] (Wicket-AsyncDataStore-PageSavingThread) Storing data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; page with id &lt;span class=&quot;code-quote&quot;&gt;&apos;2&apos;&lt;/span&gt; in session with id &lt;span class=&quot;code-quote&quot;&gt;&apos;5nSIPXlkpRkGu5Oo3_wuwf801Y6TM3K1_k-95uIi&apos;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Problem (as far as I can tell) &lt;br/&gt;
The PageSavingRunnable of the AsynchronousPageStore saves entries to the DiskDataStore after the corresponding session has been invalidated and its DiskDataStore has been cleaned. Because the session is destroyed according to the container and Wicket session handling there is nothing triggering a cleanup for this session anymore.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Attached is a testcase (master branch) to showcase what is happening. Because it is a timing issue I &apos;faked&apos; the testcase and temporarily stopped the PageSavingRunnable to create a scenario where the PageSavingRunnable would save an entry for an already invalidated session.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13208809">WICKET-6629</key>
            <summary>OOM (and disk) in AsynchronousPageStore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgrigorov">Martin Tzvetanov Grigorov</assignee>
                                    <reporter username="sboschman">Sverre Boschman</reporter>
                        <labels>
                            <label>serialization</label>
                    </labels>
                <created>Thu, 10 Jan 2019 15:24:58 +0000</created>
                <updated>Sun, 20 Jan 2019 17:29:18 +0000</updated>
                            <resolved>Fri, 11 Jan 2019 12:05:48 +0000</resolved>
                                    <version>8.2.0</version>
                    <version>9.0.0-M1</version>
                                    <fixVersion>8.3.0</fixVersion>
                    <fixVersion>9.0.0-M1</fixVersion>
                                    <component>wicket</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16740309" author="mgrigorov" created="Fri, 11 Jan 2019 11:41:01 +0000"  >&lt;p&gt;The attached test case fails for me with:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.AssertionError: expected &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, but was:&amp;lt;[B@5c90e579&amp;gt;

	at org.junit.Assert.fail(Assert.java:88)
	at org.junit.Assert.failNotNull(Assert.java:755)
	at org.junit.Assert.assertNull(Assert.java:737)
	at org.junit.Assert.assertNull(Assert.java:747)
	at org.apache.wicket.pageStore.AsyncPageStoreManagerTest.invalidateSessionBeforeSave(AsyncPageStoreManagerTest.java:112)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Update&lt;/b&gt;: I see that actually failing is the expected behavior. All is clear! &lt;/p&gt;
</comment>
                            <comment id="16740322" author="jira-bot" created="Fri, 11 Jan 2019 11:58:04 +0000"  >&lt;p&gt;Commit 5cf4f6c8936aaf01bb5a3cae1c392bf2545cf9a0 in wicket&apos;s branch refs/heads/master from Martin Tzvetanov Grigorov&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=wicket.git;h=5cf4f6c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=wicket.git;h=5cf4f6c&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6629&quot; title=&quot;OOM (and disk) in AsynchronousPageStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6629&quot;&gt;&lt;del&gt;WICKET-6629&lt;/del&gt;&lt;/a&gt; OOM (and disk) in AsynchronousPageStore&lt;/p&gt;

&lt;p&gt;Clear the AsynchronousPageStore&apos;s entries for expired sessions&lt;/p&gt;</comment>
                            <comment id="16740325" author="jira-bot" created="Fri, 11 Jan 2019 12:00:21 +0000"  >&lt;p&gt;Commit e5b1290a1e7f4954cf76f7e4e47c4b1569d7edea in wicket&apos;s branch refs/heads/wicket-8.x from Martin Tzvetanov Grigorov&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=wicket.git;h=e5b1290&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=wicket.git;h=e5b1290&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6629&quot; title=&quot;OOM (and disk) in AsynchronousPageStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6629&quot;&gt;&lt;del&gt;WICKET-6629&lt;/del&gt;&lt;/a&gt; OOM (and disk) in AsynchronousPageStore&lt;/p&gt;

&lt;p&gt;Clear the AsynchronousPageStore&apos;s entries for expired sessions&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 5cf4f6c8936aaf01bb5a3cae1c392bf2545cf9a0)&lt;/p&gt;</comment>
                            <comment id="16740326" author="jira-bot" created="Fri, 11 Jan 2019 12:00:22 +0000"  >&lt;p&gt;Commit e9d5f4741923c31cabeb52214a59a57baa276678 in wicket&apos;s branch refs/heads/wicket-8.x from Martin Tzvetanov Grigorov&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=wicket.git;h=e9d5f47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=wicket.git;h=e9d5f47&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6629&quot; title=&quot;OOM (and disk) in AsynchronousPageStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6629&quot;&gt;&lt;del&gt;WICKET-6629&lt;/del&gt;&lt;/a&gt; OOM (and disk) in AsynchronousPageStore&lt;/p&gt;

&lt;p&gt;JUnit 4&lt;/p&gt;</comment>
                            <comment id="16740332" author="mgrigorov" created="Fri, 11 Jan 2019 12:05:49 +0000"  >&lt;p&gt;org.apache.wicket.pageStore.AsynchronousPageStore has been introduced in 8.0.0 so earlier versions do not have this problem.&lt;/p&gt;</comment>
                            <comment id="16740334" author="jira-bot" created="Fri, 11 Jan 2019 12:08:18 +0000"  >&lt;p&gt;Commit 0108d09438d1b2f6bd8c04445955490ac1d4d5f1 in wicket&apos;s branch refs/heads/wicket-8.x from Martin Tzvetanov Grigorov&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=wicket.git;h=0108d09&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=wicket.git;h=0108d09&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6629&quot; title=&quot;OOM (and disk) in AsynchronousPageStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6629&quot;&gt;&lt;del&gt;WICKET-6629&lt;/del&gt;&lt;/a&gt; OOM (and disk) in AsynchronousPageStore&lt;/p&gt;

&lt;p&gt;Move to the correct package. I&apos;ve pasted it in the wrond one by mistake&lt;/p&gt;</comment>
                            <comment id="16740335" author="jira-bot" created="Fri, 11 Jan 2019 12:08:37 +0000"  >&lt;p&gt;Commit a17af33c524a21026b464e185746fee07904b2b1 in wicket&apos;s branch refs/heads/master from Martin Tzvetanov Grigorov&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=wicket.git;h=a17af33&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=wicket.git;h=a17af33&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6629&quot; title=&quot;OOM (and disk) in AsynchronousPageStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6629&quot;&gt;&lt;del&gt;WICKET-6629&lt;/del&gt;&lt;/a&gt; OOM (and disk) in AsynchronousPageStore&lt;/p&gt;

&lt;p&gt;Move to the correct package. I&apos;ve pasted it in the wrond one by mistake&lt;/p&gt;

&lt;p&gt;(cherry picked from commit 0108d09438d1b2f6bd8c04445955490ac1d4d5f1)&lt;/p&gt;</comment>
                            <comment id="16740544" author="svenmeier" created="Fri, 11 Jan 2019 16:40:26 +0000"  >&lt;p&gt;What about AsynchronousDataStore? It works identically to AsynchronousPageStore.&lt;/p&gt;

&lt;p&gt;What happens in the following case?&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;PageSavingRunnable polls an entry&lt;/li&gt;
	&lt;li&gt;that entry&apos;s session is invalidated (nothing to remove from entries), unbind is delegated to the disk storage&lt;/li&gt;
	&lt;li&gt;PageSavingRunnable now delegates the entry&apos;s page to the disk storage&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16741820" author="mgrigorov" created="Mon, 14 Jan 2019 07:13:33 +0000"  >&lt;p&gt;I think AsynchronousDataStore does not have this problem but I will check again these days.&lt;/p&gt;</comment>
                            <comment id="16745894" author="mgrigorov" created="Fri, 18 Jan 2019 08:33:01 +0000"  >&lt;p&gt;AsynchronousDataStore has this code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Override
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void removeData(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; sessionId)
	{
		&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Iterator&amp;lt;Entry&amp;gt; itor = entries.iterator(); itor.hasNext();)
		{
			Entry entry = itor.next();
			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (entry != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; check is not needed in JDK6
&lt;/span&gt;			{
				&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; entrySessionId = entry.sessionId;

				&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sessionId.equals(entrySessionId))
				{
					entryMap.remove(getKey(entry));
					itor.remove();
				}
			}
		}

		dataStore.removeData(sessionId);
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/wicket/blob/wicket-8.x/wicket-core/src/main/java/org/apache/wicket/pageStore/AsynchronousDataStore.java#L158-L166&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/blob/wicket-8.x/wicket-core/src/main/java/org/apache/wicket/pageStore/AsynchronousDataStore.java#L158-L166&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;which is the more verbose version of `entries.removeIf()` that I used in AsynchronousPageStore.&lt;/p&gt;</comment>
                            <comment id="16747503" author="svenmeier" created="Sun, 20 Jan 2019 17:29:18 +0000"  >&lt;p&gt;Yes, you&apos;re right&#160; - I was looking for #unbind() in AsynchronousDataStore o_O&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12954439" name="AsyncPageStoreManagerTest.java" size="5126" author="sboschman" created="Thu, 10 Jan 2019 15:11:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12311020" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>External issue URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[https://issues.apache.org/jira/browse/WICKET-6177]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 42 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|u00pns:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>