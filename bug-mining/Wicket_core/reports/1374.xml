<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:25:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-6177] Introduce AsynchronousPageStore</title>
                <link>https://issues.apache.org/jira/browse/WICKET-6177</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;We have a performance issue with our Wicket app, page serialization causes inconvenience to user because PageStoreManager.storeTouchedPages() blocks the request until pageSerializer.serialize(page) has been handled.&lt;/p&gt;

&lt;p&gt;Could this be solved by serializing the page in a separate thread and let the request complete?&lt;/p&gt;

&lt;p&gt;The problem we have is that user is making quick small ajax modifications to the page but serialization + network latency makes the delay very inconvenient. If serialization could be done in separate thread, user would feel only the network delay which is bearable.&lt;/p&gt;</description>
                <environment>any</environment>
        <key id="12975791">WICKET-6177</key>
            <summary>Introduce AsynchronousPageStore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgrigorov">Martin Tzvetanov Grigorov</assignee>
                                    <reporter username="mmakundi">Martin Terra</reporter>
                        <labels>
                            <label>serialization</label>
                    </labels>
                <created>Sun, 5 Jun 2016 07:42:10 +0000</created>
                <updated>Sun, 15 Nov 2020 19:20:18 +0000</updated>
                            <resolved>Wed, 12 Apr 2017 21:32:16 +0000</resolved>
                                    <version>7.4.0</version>
                                    <fixVersion>8.0.0-M6</fixVersion>
                                    <component>wicket</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="604800">168h</timeoriginalestimate>
                            <timeestimate seconds="604800">168h</timeestimate>
                                        <comments>
                            <comment id="15315786" author="mmakundi" created="Sun, 5 Jun 2016 07:44:55 +0000"  >&lt;p&gt;Attached quickstart to reproduce issue.&lt;/p&gt;</comment>
                            <comment id="15329010" author="mgrigorov" created="Tue, 14 Jun 2016 07:25:00 +0000"  >&lt;p&gt;Attaching a simple demo app with custom IPageStore that serializes the page asynchronously.&lt;/p&gt;

&lt;p&gt;I am not sure such impl should be provided by Wicket distro by default because it won&apos;t work well when the application makes a new request before the page is serialized and saved. In that case it will serve an old version or even worse will fail with PageExpiredException.&lt;/p&gt;</comment>
                            <comment id="15331399" author="mmakundi" created="Wed, 15 Jun 2016 08:47:34 +0000"  >&lt;p&gt;Thanks. How could this be modified such that in case a new request occurs, the pagemap would be blocked until serialization has finished? Similar way as pagemap is locked normally for concurrent requests.&lt;/p&gt;</comment>
                            <comment id="15331431" author="mgrigorov" created="Wed, 15 Jun 2016 09:18:46 +0000"  >&lt;p&gt;You will need a custom IPageManager too.&lt;br/&gt;
It should keep a list of &quot;pages in progress&quot; and should block access to them.&lt;/p&gt;</comment>
                            <comment id="15331474" author="mmakundi" created="Wed, 15 Jun 2016 10:05:24 +0000"  >&lt;p&gt;Could you help and make them a bundle/pair? Customer IPageStore that also configures necessary custom IPageManager (or vice versa)? Then could run them in a test set &amp;amp; performance tests.&lt;/p&gt;</comment>
                            <comment id="15358900" author="koutsoub" created="Fri, 1 Jul 2016 12:46:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgrigorov&quot; class=&quot;user-hover&quot; rel=&quot;mgrigorov&quot;&gt;mgrigorov&lt;/a&gt; I setup a naive implementation of your comment above, for the sake of simplicity I reused the PageAccessSynchronizer in order to verify the base logic of the implementation &lt;br/&gt;
The code based on your sample is available below&lt;br/&gt;
&lt;a href=&quot;https://github.com/koutsoub/wicket-samples/blob/master/WICKET-6177/src/main/java/com/mycompany/AsyncPageStore.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/koutsoub/wicket-samples/blob/master/WICKET-6177/src/main/java/com/mycompany/AsyncPageStore.java&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/koutsoub/wicket-samples/blob/master/WICKET-6177/src/main/java/com/mycompany/AsyncPageStorePageManagerProvider.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/koutsoub/wicket-samples/blob/master/WICKET-6177/src/main/java/com/mycompany/AsyncPageStorePageManagerProvider.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Will the above do the trick?&lt;br/&gt;
Lock the page when serialization is requested, unlock the page when serialization completes.&lt;br/&gt;
Can we reuse the PageAccessSynchronizer for this logic (if so we could extend the WicketSession in order to use the provider there) or implement a PageSerializerSynchonizer in the same principles?&lt;/p&gt;
</comment>
                            <comment id="15373508" author="mgrigorov" created="Tue, 12 Jul 2016 19:20:29 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I think your code should work.&lt;/p&gt;

&lt;p&gt;It won&apos;t be possible to use the Session&apos;s PageAccessSynchronizer even if it was possible to get a reference to it because it doesn&apos;t keep track of the number of locks per pageId.&lt;br/&gt;
So Wicket will lock the page in the begin of the request cycle, then your logic will call lockPage() again and then fork the serialization in a new thread. The previous thread will continue by committing the request, i.e. will call unlockAllPages(). At the end of the serialization your logic will call again unlockAllPages() but this will do nothing. If in the meantime another request asks for this page by id then it will use an older version of it, if there is such, i.e. there was an Ajax request for it before.&lt;/p&gt;

&lt;p&gt;So I see two solutions:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;use a second PageAccessSynchronizer as you did it&lt;/li&gt;
	&lt;li&gt;add logic to PageAccessSynchronizer to count the locks and unlocks&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;d prefer the first solution because the second adds complexity that is not really needed by 99% of the apps.&lt;/p&gt;</comment>
                            <comment id="15630982" author="manuelbarzi" created="Thu, 3 Nov 2016 00:05:02 +0000"  >&lt;p&gt;hi guys,&lt;/p&gt;

&lt;p&gt;i&apos;ve been reviewing this issue a bit and i find out that there is already a good async impl for data storage, in which the default construction (by default-page-manager-provider) wraps the (sync)-disk-data-store with async-data-store. this last already works with concurrency on data storing, managing entries tracked by session-id and page-id.&lt;/p&gt;

&lt;p&gt;my projection is: ok, why not applying a similar strategy on page-store. keeping the current (sync)-defaul-page-store being wrapped by an async-page-store managing concurrency in a similar way to what async-data-store already does.&lt;/p&gt;

&lt;p&gt;just my first thoughts i wanted to share with you, and open to discussion if you feel like to share too.&lt;/p&gt;</comment>
                            <comment id="15706068" author="manuelbarzi" created="Tue, 29 Nov 2016 18:11:43 +0000"  >&lt;p&gt;hi again there,&lt;br/&gt;
here i created a PoC with the idea, applying the async behavior on an async-page-store (based on asynchronous-data-store) &lt;a href=&quot;https://github.com/manuelbarzi/wicket-async-page-store&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/manuelbarzi/wicket-async-page-store&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15711189" author="mgrigorov" created="Thu, 1 Dec 2016 07:33:43 +0000"  >&lt;p&gt;Hi Manuel,&lt;/p&gt;

&lt;p&gt;Your implementation looks good to me!&lt;br/&gt;
Maybe the wait times should be made configurable because 30ms might be a bit short for the original problem in &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mmakundi&quot; class=&quot;user-hover&quot; rel=&quot;mmakundi&quot;&gt;mmakundi&lt;/a&gt;&apos;s application. If is possible to serialize his page in 30ms then most probably there won&apos;t be a need for async page store.&lt;/p&gt;</comment>
                            <comment id="15829593" author="manuelbarzi" created="Thu, 19 Jan 2017 09:39:16 +0000"  >&lt;p&gt;hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgrigorov&quot; class=&quot;user-hover&quot; rel=&quot;mgrigorov&quot;&gt;mgrigorov&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;those waiting times are not for serialisation itself, but for the blocking queue that temporary catches the page entries as they are requested to be stored: 30ms timeout when adding an entry into de queue, and 1000ms timeout when retrieving an entry from the queue. the former is used when requesting an async store of a page, just to add it to the queue (BlockingQueue.offer(...)), and the latter is used when retrieving that page entry from the queue (BlockingQueue.poll(...)) to proceed to serialisation by means of the wrapped and original sync store.&lt;/p&gt;

&lt;p&gt;there is only one worker thread in charge of polling those entries from the queue and use the original sync page store to serialise the queued pages. this is where the wrapper async page store decouples the process of serialisation, calling the original sync page store in that thread.&lt;/p&gt;

&lt;p&gt;so there are two sides here: the producing of those page entries in that queue, and the consuming of them in the worker thread. both operations over the blocking queue require a timeout to exactly avoid the async page store to be blocked if the queue cannot respond better than those times.&lt;/p&gt;

&lt;p&gt;in case and entry cannot be queued, then the async page store would just delegate the task to the original sync page store. that is, the async page store would just work in a sync manner if the timeout is reached. it&apos;s like saying &quot;let&apos;s try to save this page asynchronously, but if the queue is overloaded, then cannot wait for it, let&apos;s proceed with the traditional synchronous page store&quot;. that&apos;s it.&lt;/p&gt;

&lt;p&gt;and in case an entry cannot be un-queued, then the worker thread would just retry a poll a immediately after, until it finally reaches to retrieve an entry for synchronously storing it, that is, using the original sync store inside it to finally serialise the page.&lt;/p&gt;

&lt;p&gt;finally, in case a user requests a page that has already been queued but hasn&apos;t been serialised yet, then the store retrieves it from queue and returns it immediately (located in a concurrent map). this provides a non-wait response, and a quick answer with page version requested.&lt;/p&gt;

&lt;p&gt;i hope these explanation could provide a more clear picture of the projection, otherwise let me know, please ,)&lt;/p&gt;</comment>
                            <comment id="15835064" author="mmakundi" created="Mon, 23 Jan 2017 19:12:13 +0000"  >&lt;p&gt;Thanks, Manuel. Would you please add following things:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;logging so that simple performance statistics can be logged&lt;/li&gt;
	&lt;li&gt;ensure there are junit tests demonstrating low, normal and high load with fast, average and slow serializing pages&lt;/li&gt;
	&lt;li&gt;proposal how this could be committed in a way that it would be activated by default for a default wicket configuration&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15847488" author="mgrigorov" created="Tue, 31 Jan 2017 20:51:01 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=manuelbarzi&quot; class=&quot;user-hover&quot; rel=&quot;manuelbarzi&quot;&gt;manuelbarzi&lt;/a&gt;!&lt;br/&gt;
Please create a pull request with your suggestion so we can discuss it. If the team likes it then it might be included in Wicket Core!&lt;/p&gt;</comment>
                            <comment id="15862618" author="githubbot" created="Sun, 12 Feb 2017 02:12:40 +0000"  >&lt;p&gt;GitHub user manuelbarzi opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/wicket/pull/212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/pull/212&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6177&quot; title=&quot;Introduce AsynchronousPageStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6177&quot;&gt;&lt;del&gt;WICKET-6177&lt;/del&gt;&lt;/a&gt; Blocking page serialization&lt;/p&gt;

&lt;p&gt;    from &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6177&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/WICKET-6177&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    *&lt;b&gt;AsyncPageStore&lt;/b&gt;* adds the capability to provide an asynchronous page storing by wrapping the original sync page store (e.g. DefaultPageStore) and handling store requests in a queue and storing pages in worker thread which makes use of the original store. The number of pages to be managed asynchronously is defined by a capacity, provided by estimation which should be done on each specific application where applied.&lt;/p&gt;

&lt;p&gt;    The aim of AsyncPageStore is to unblock page requests when serialization process takes &apos;too long&apos;, giving the user the sensation of &apos;slow web&apos;. This could happen in applications that for any reason delay on backing up pages by means of the current default wicket store.&lt;/p&gt;

&lt;p&gt;    It adds the chance to manage a preset number of pages asynchronously, defined by the &apos;capacity&apos;, and in case that limit is exceeded by requests, it just works as the original sync page store, by simply delegating work on it until the queue is released and space is done to handle pages in asynchronous way again.&lt;/p&gt;

&lt;p&gt;    It acts in a way like saying &quot;let&apos;s handle storing of pages asynchronously for an estimated number of them in &apos;normal conditions&apos;, and in case there is an excess of pages to store (peak of requests), that is, exceeding async store &apos;capacity&apos;, then let&apos;s just work as normally.&lt;/p&gt;

&lt;p&gt;    *&lt;b&gt;AsyncPageStoreTest&lt;/b&gt;* provides initial on/off cases with the scenarios in which async page store works in &apos;normal conditions&apos; (not exceeding capacity), and the opposite (arriving at a point of exceeding that capacity).&lt;/p&gt;

&lt;p&gt;    original code is already &apos;gutted&apos; in a *&lt;b&gt;quickstart&lt;/b&gt;* for inspection and testing in &lt;a href=&quot;https://github.com/manuelbarzi/wicket-async-page-store&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/manuelbarzi/wicket-async-page-store&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    for further details on this projection, just following the first link above.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/manuelbarzi/wicket&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/manuelbarzi/wicket&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/wicket/pull/212.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/pull/212.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #212&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 2ffd587dea4c5e1edec0853f35a9b5761e391917&lt;br/&gt;
Author: manuelbarzi &amp;lt;manuelbarzi@manuelbarzis-macbook-pro.local&amp;gt;&lt;br/&gt;
Date:   2017-02-12T01:23:40Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6177&quot; title=&quot;Introduce AsynchronousPageStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6177&quot;&gt;&lt;del&gt;WICKET-6177&lt;/del&gt;&lt;/a&gt; Blocking page serialization&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15862819" author="githubbot" created="Sun, 12 Feb 2017 15:18:28 +0000"  >&lt;p&gt;Github user bitstorm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/wicket/pull/212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/pull/212&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @manuelbarzi &lt;br/&gt;
    thank you for you PR. I see you added Guava as dependency but I don&apos;t see any point where you use it. Am I missing something?&lt;/p&gt;</comment>
                            <comment id="15862988" author="githubbot" created="Sun, 12 Feb 2017 21:40:03 +0000"  >&lt;p&gt;Github user manuelbarzi commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/wicket/pull/212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/pull/212&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    ciao @bitstorm &lt;/p&gt;

&lt;p&gt;    yes, indeed, guava and commons-lang3, both for test purposes - test scope / pom - in AsyncPageStoreTest, making use of com.google.common.base.Stopwatch and org.apache.commons.lang3.RandomUtils, respectively.&lt;/p&gt;</comment>
                            <comment id="15863029" author="githubbot" created="Sun, 12 Feb 2017 23:11:39 +0000"  >&lt;p&gt;Github user bitstorm commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/wicket/pull/212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/pull/212&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    ciao @manuelbarzi ,&lt;/p&gt;

&lt;p&gt;    my fault, I&apos;m not very familiar with Guava and its package naming. &lt;/p&gt;</comment>
                            <comment id="15873999" author="githubbot" created="Mon, 20 Feb 2017 03:46:07 +0000"  >&lt;p&gt;Github user mmakundi commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/wicket/pull/212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/pull/212&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks @manuelbarzi and Some findings:&lt;/p&gt;

&lt;p&gt;    1. I would remove the (non-Javadoc) and instead format those with start-prefix /** like true javadoc and remove extra empty lines in the javadoc&lt;/p&gt;

&lt;p&gt;    2. All in all check for formatting and extra lines etc.&lt;/p&gt;

&lt;p&gt;    3. In case entries.offer fails, entryMap.remove is called before pageStore.storePage. If we assume pageStore.storePage is slow, maybe it would be good idea to postpone remove so that a new requiest during pageStore.storePage can use the in-memory reference? Similar to what is happening in PageSavingRunnable.run? Also this will make a great re-usable method:&lt;br/&gt;
    storePageAndRemoveFromMap(...) {&lt;br/&gt;
             log.debug(&quot;Saving asynchronously: {}...&quot;, entry);&lt;br/&gt;
            pageStore.storePage(sessionId, page);&lt;br/&gt;
            entryMap.remove(getKey(entry));&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;    4. Same as in (3.) to catch (InterruptedException e) &lt;/p&gt;
{ log.error(e.getMessage(), e);; storePageAndRemoveFromMap(...); }

&lt;p&gt;    5. Please junit-test if any conflict occur if unbind(sessionId) is called while there are entries in the queue for that session.&lt;/p&gt;

&lt;p&gt;    6. Please add tests also for borderline racing cases such as same instance is returned for new request arriving before storing is complete.&lt;/p&gt;

&lt;p&gt;    7. I would rename AsyncPageStore -&amp;gt; AsynchronousPageStore for clarity and symmetry (symmetric naming with AsynchronousDataStore),&lt;/p&gt;

&lt;p&gt;    8. Please propose a patch also into DefaultPageManagerProvider such that  new AsyncPageStore(super.newPageStore(dataStore), 100); would be the default pagestore for wicket when dataStore.canBeAsynchronous()==true. Similar way that AsynchronousDataStore is default.&lt;/p&gt;</comment>
                            <comment id="15927861" author="githubbot" created="Thu, 16 Mar 2017 11:23:42 +0000"  >&lt;p&gt;Github user 1nside0ut commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/wicket/pull/212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/pull/212&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    hi @mmakundi &lt;/p&gt;

&lt;p&gt;    &quot;3. In case entries.offer fails, entryMap.remove is called before pageStore.storePage. If we assume pageStore.storePage is slow, maybe it would be good idea to postpone remove so that a new requiest during pageStore.storePage can use the in-memory reference? Similar to what is happening in PageSavingRunnable.run? Also this will make a great re-usable method:&lt;br/&gt;
    storePageAndRemoveFromMap(...) {&lt;br/&gt;
    log.debug(&quot;Saving asynchronously: {}...&quot;, entry);&lt;br/&gt;
    pageStore.storePage(sessionId, page);&lt;br/&gt;
    entryMap.remove(getKey(entry));&lt;br/&gt;
    }&quot;&lt;/p&gt;

&lt;p&gt;    entryMap is not supposed to be used as &quot;backup mem&quot;, there&apos;s already one queue for that (entries). it&apos;s not by mistake that map-removal is located before synchronous store call for the same thread (not the worker). the reason is simple: if before try-to-queue a page fails, or it simply takes to long (offer), then that would mean app mem / process is in trouble, &quot;no space / speed for that&quot;, so there&apos;s not point on keeping that ref attached to map (occupying) while synchronous storing (&quot;slow&quot; storing, as you say) if it has already been stated a fail on trying to manage it in queue (mem). using map as &quot;a backup for when queuing fails&quot; would just false the mechanism, imposing a mem kept at a non-optimal point for that. &lt;br/&gt;
    on the other hand, regarding the worker thread that &quot;asynchronously&quot; stores the page, the case is the opposite. every single page that has achieved to enter the queue before (that is, offer succeeded), has already got the privilege to being kept in mem while not being entirely stored, so being removed from map after that.&lt;br/&gt;
    queue protects itself from accepting or not new entries depending on env conditions, but outside it logic should act in coherence to it.&lt;/p&gt;</comment>
                            <comment id="15938543" author="mgrigorov" created="Thu, 23 Mar 2017 15:13:40 +0000"  >&lt;p&gt;Reopen to consider the PR.&lt;br/&gt;
I thought I&apos;ve done this already ...&lt;/p&gt;</comment>
                            <comment id="15958497" author="thomas.heigl" created="Thu, 6 Apr 2017 07:55:31 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I&apos;m very interested in this issue and gave the implementation a test-run yesterday. &lt;/p&gt;

&lt;p&gt;My application is currently configured to use &lt;tt&gt;HttpSessionDataStore&lt;/tt&gt;. &lt;tt&gt;AsynchronousPageStore&lt;/tt&gt; fails when used with this data store. Maybe there should be an additional check that the &lt;tt&gt;IDataStore&lt;/tt&gt; supports asynchronous storing before wrapping the page store with the asynchronous implementation?&lt;/p&gt;

&lt;p&gt;-t&lt;/p&gt;</comment>
                            <comment id="15958503" author="mgrigorov" created="Thu, 6 Apr 2017 07:59:39 +0000"  >&lt;p&gt;How exactly it fails ?&lt;br/&gt;
What error(s) do you experience ?&lt;/p&gt;</comment>
                            <comment id="15958670" author="thomas.heigl" created="Thu, 6 Apr 2017 09:49:18 +0000"  >&lt;p&gt;It fails with:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;16816 [read] ERR o.a.w.p.memory.HttpSessionDataStore      - Cannot store the data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; page with id &lt;span class=&quot;code-quote&quot;&gt;&apos;2&apos;&lt;/span&gt; in session with id &lt;span class=&quot;code-quote&quot;&gt;&apos;528610207C4F0751CA70F4B34DB75DBE&apos;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The code in &lt;tt&gt;HttpSessionDataStore&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	@Override
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void storeData(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; sessionId, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; pageId, &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] pageAsBytes)
	{
		PageTable pageTable = getPageTable(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pageTable != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
		{
			pageTable.storePage(pageId, pageAsBytes);
			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (LOG.isDebugEnabled())
			{
				LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Stored &lt;span class=&quot;code-quote&quot;&gt;&apos;{}&apos;&lt;/span&gt; bytes &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; page &lt;span class=&quot;code-quote&quot;&gt;&apos;{}&apos;&lt;/span&gt; in session &lt;span class=&quot;code-quote&quot;&gt;&apos;{}&apos;&lt;/span&gt;&quot;&lt;/span&gt;,
						pageAsBytes.length, pageId, sessionId);
			}
			evictionStrategy.evict(pageTable);
		}
		&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
		{
			LOG.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot store the data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; page with id &lt;span class=&quot;code-quote&quot;&gt;&apos;{}&apos;&lt;/span&gt; in session with id &lt;span class=&quot;code-quote&quot;&gt;&apos;{}&apos;&lt;/span&gt;&quot;&lt;/span&gt;,
				pageId, sessionId);
		}
	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It tries to get the page table from a session attribute and the session is not available after asynchronous serialization.&lt;/p&gt;</comment>
                            <comment id="15958738" author="mgrigorov" created="Thu, 6 Apr 2017 10:58:21 +0000"  >&lt;p&gt;That&apos;s the purpose of IDataStore#canBeAsynchronous().&lt;br/&gt;
It seems it is not used in your setup.&lt;br/&gt;
Wicket&apos;s default page manager  uses it at &lt;a href=&quot;https://github.com/apache/wicket/blob/137fa9e40237e12c2a9566f7701356796d43aaa9/wicket-core/src/main/java/org/apache/wicket/DefaultPageManagerProvider.java#L60&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/blob/137fa9e40237e12c2a9566f7701356796d43aaa9/wicket-core/src/main/java/org/apache/wicket/DefaultPageManagerProvider.java#L60&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15958742" author="mgrigorov" created="Thu, 6 Apr 2017 10:59:53 +0000"  >&lt;p&gt;I understand now.&lt;br/&gt;
The IPageStore is asynchronous in your case, i.e. one level up.&lt;br/&gt;
I guess the same check should be used before creating the IPageStore.&lt;/p&gt;</comment>
                            <comment id="15958775" author="thomas.heigl" created="Thu, 6 Apr 2017 11:37:54 +0000"  >&lt;p&gt;That&apos;s what I was thinking, yes.&lt;/p&gt;</comment>
                            <comment id="15958792" author="manuelbarzi" created="Thu, 6 Apr 2017 11:59:06 +0000"  >&lt;p&gt;hi, Thomas, Martin,&lt;/p&gt;

&lt;p&gt;in the pr was introduced a change in default-page-manage-provider to check whether page-store can be asynchronous,&lt;br/&gt;
&lt;a href=&quot;https://github.com/manuelbarzi/wicket/blob/master/wicket-core/src/main/java/org/apache/wicket/DefaultPageManagerProvider.java#L61#L73&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/manuelbarzi/wicket/blob/master/wicket-core/src/main/java/org/apache/wicket/DefaultPageManagerProvider.java#L61#L73&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;but that check excludes data-store check (lines above). may that logic be updated to subordinate the page-store async check into the data-store one above. that is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	@Override
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; IPageManager apply(IPageManagerContext pageManagerContext)
	{
		IDataStore dataStore = newDataStore();

		StoreSettings storeSettings = getStoreSettings();

		IPageStore pageStore;

		&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (dataStore.canBeAsynchronous())
		{
			&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; capacity = storeSettings.getAsynchronousQueueCapacity();
			dataStore = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AsynchronousDataStore(dataStore, capacity);

			pageStore = newPageStore(dataStore);

			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pageStore.canBeAsynchronous())
			{
				pageStore = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AsynchronousPageStore(pageStore, capacity);
			}
		}
		&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
			pageStore = newPageStore(dataStore);

		&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PageStoreManager(application.getName(), pageStore, pageManagerContext);

	}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15959331" author="thomas.heigl" created="Thu, 6 Apr 2017 17:12:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=manuelbarzi&quot; class=&quot;user-hover&quot; rel=&quot;manuelbarzi&quot;&gt;manuelbarzi&lt;/a&gt;: Looks good to me and would work as a drop-in replacement also for users who are currently using &lt;tt&gt;HttpSessionDataStore&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15959413" author="manuelbarzi" created="Thu, 6 Apr 2017 17:44:25 +0000"  >&lt;p&gt;pushed ,)&lt;/p&gt;</comment>
                            <comment id="15966662" author="jira-bot" created="Wed, 12 Apr 2017 21:28:29 +0000"  >&lt;p&gt;Commit 2ffd587dea4c5e1edec0853f35a9b5761e391917 in wicket&apos;s branch refs/heads/master from manuelbarzi&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=wicket.git;h=2ffd587&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=wicket.git;h=2ffd587&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6177&quot; title=&quot;Introduce AsynchronousPageStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6177&quot;&gt;&lt;del&gt;WICKET-6177&lt;/del&gt;&lt;/a&gt; Blocking page serialization&lt;/p&gt;</comment>
                            <comment id="15966663" author="jira-bot" created="Wed, 12 Apr 2017 21:28:31 +0000"  >&lt;p&gt;Commit 25fb5a29dbe523d6ebd7dccdea639eaf5bc28618 in wicket&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgrigorov&quot; class=&quot;user-hover&quot; rel=&quot;mgrigorov&quot;&gt;mgrigorov&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=wicket.git;h=25fb5a2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=wicket.git;h=25fb5a2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6177&quot; title=&quot;Introduce AsynchronousPageStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6177&quot;&gt;&lt;del&gt;WICKET-6177&lt;/del&gt;&lt;/a&gt; Introduce AsynchronousPageStore&lt;/p&gt;

&lt;p&gt;Minor cleanups&lt;/p&gt;</comment>
                            <comment id="15966665" author="githubbot" created="Wed, 12 Apr 2017 21:28:44 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/wicket/pull/212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/pull/212&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15966676" author="mgrigorov" created="Wed, 12 Apr 2017 21:32:16 +0000"  >&lt;p&gt;Thank you for the contribution and the patience, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=manuelbarzi&quot; class=&quot;user-hover&quot; rel=&quot;manuelbarzi&quot;&gt;manuelbarzi&lt;/a&gt; !&lt;/p&gt;</comment>
                            <comment id="15967659" author="manuelbarzi" created="Thu, 13 Apr 2017 14:38:36 +0000"  >&lt;p&gt;np, Martin ,) &#128077;&lt;/p&gt;</comment>
                            <comment id="16119934" author="wschlich" created="Wed, 9 Aug 2017 13:59:52 +0000"  >&lt;p&gt;Will this be backported to 7.x/6.x?&lt;/p&gt;</comment>
                            <comment id="16124882" author="mgrigorov" created="Sun, 13 Aug 2017 11:15:41 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wschlich&quot; class=&quot;user-hover&quot; rel=&quot;wschlich&quot;&gt;wschlich&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Please create a new ticket for 7.x.&lt;br/&gt;
We are going to release 8.0.0 soon so 6.x branch will be moved in maintenance mode, i.e. it will receive only security related fixes.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13195156">WICKET-6607</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12810268" name="6177.tgz" size="25638" author="mgrigorov" created="Tue, 14 Jun 2016 07:25:00 +0000"/>
                            <attachment id="12808203" name="Wicket_Quickstart_7.zip" size="74595" author="mmakundi" created="Sun, 5 Jun 2016 07:44:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12311020" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>External issue URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[https://issues.apache.org/jira/browse/WICKET-5805]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 13 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yzwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>