<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:25:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-6522] ThreadLocal leak in PageStoreManager</title>
                <link>https://issues.apache.org/jira/browse/WICKET-6522</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;One of our heavy-used Wicket production applications has developed &apos;interesting&apos; behaviour since upgrading to 7.9.0: after a while the system becomes slower and seems to need more CPU time to handle the same amount of requests. Threaddumps exposed that a lot of CPU time was consumed by&#160;java.lang.ThreadLocal$ThreadLocalMap.getEntryAfterMiss, pointing to a ThreadLocal leak.&lt;/p&gt;

&lt;p&gt;After making a heapdump (20g) of one of our servers we found lots of ThreadLocalMap$Entry objects referenced by org.apache.wicket.page.PageStoreManager$SessionEntry$1 containing the value Boolean.FALSE.&lt;/p&gt;

&lt;p&gt;Seems that boolean is new behaviour introduced by the fix for&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6465&quot; title=&quot;PageStore not cleared at session end&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6465&quot;&gt;&lt;del&gt;WICKET-6465&lt;/del&gt;&lt;/a&gt; and is causing complications on servers like Wildfly we use which don&apos;t recycle threads.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>Wildfly 10 on CentOS 7 Linux.</environment>
        <key id="13132637">WICKET-6522</key>
            <summary>ThreadLocal leak in PageStoreManager</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="papegaaij">Emond Papegaaij</assignee>
                                    <reporter username="klaasjan">Klaasjan Brand</reporter>
                        <labels>
                    </labels>
                <created>Mon, 22 Jan 2018 10:50:47 +0000</created>
                <updated>Tue, 6 Feb 2018 12:55:11 +0000</updated>
                            <resolved>Tue, 30 Jan 2018 13:27:44 +0000</resolved>
                                    <version>7.9.0</version>
                                    <fixVersion>7.10.0</fixVersion>
                    <fixVersion>8.0.0-M9</fixVersion>
                                    <component>wicket</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16334172" author="papegaaij" created="Mon, 22 Jan 2018 11:44:47 +0000"  >&lt;p&gt;The problems are caused by repeated instantiation of a ThreadLocal instance (one for each (deserialized) session) and the lack of cleanup.&lt;/p&gt;

&lt;p&gt;I propose the following changes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;make&#160;storingTouchedPages a static field in PageStoreManager (there is no need for a ThreadLocal per session as a thread can only access one session at a time)&lt;/li&gt;
	&lt;li&gt;change&#160;storingTouchedPages.set(false) to storingTouchedPages.remove() to cleanup properly&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16334178" author="svenmeier" created="Mon, 22 Jan 2018 11:53:47 +0000"  >&lt;p&gt;+1 that&apos;s a good solution&lt;/p&gt;</comment>
                            <comment id="16334216" author="bitstorm" created="Mon, 22 Jan 2018 12:46:32 +0000"  >&lt;p&gt;-1 don&apos;t wanna be annoying, but as I said I&apos;d rather remove the threadLocal boolean and change HttpSessionStore.SessionBindingListener#valueUnbound adding session.clear:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (wicketSession != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
{
	wicketSession.onInvalidate();
        wicketSession.clear(); &lt;span class=&quot;code-comment&quot;&gt;//added line
&lt;/span&gt;}
			
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;this in turn calls PageStoreManager#clear which is what we want&lt;/p&gt;</comment>
                            <comment id="16335516" author="githubbot" created="Tue, 23 Jan 2018 08:48:30 +0000"  >&lt;p&gt;GitHub user bitstorm opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/wicket/pull/259&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/pull/259&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6522&quot; title=&quot;ThreadLocal leak in PageStoreManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6522&quot;&gt;&lt;del&gt;WICKET-6522&lt;/del&gt;&lt;/a&gt; session cleaning code moved to HttpSessionStore&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/bitstorm/wicket&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/bitstorm/wicket&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6522&quot; title=&quot;ThreadLocal leak in PageStoreManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6522&quot;&gt;&lt;del&gt;WICKET-6522&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/wicket/pull/259.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/pull/259.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #259&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 0315c37d447a1040609cb5fa0b137def66a254c3&lt;br/&gt;
Author: Andrea Del Bene &amp;lt;adelbene@...&amp;gt;&lt;br/&gt;
Date:   2018-01-23T08:45:27Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6522&quot; title=&quot;ThreadLocal leak in PageStoreManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6522&quot;&gt;&lt;del&gt;WICKET-6522&lt;/del&gt;&lt;/a&gt; session cleaning code moved to HttpSessionStore&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16335519" author="bitstorm" created="Tue, 23 Jan 2018 08:51:33 +0000"  >&lt;p&gt;I did a PR to better explain my idea.&lt;/p&gt;</comment>
                            <comment id="16335615" author="svenmeier" created="Tue, 23 Jan 2018 10:33:52 +0000"  >&lt;p&gt;So reusing the existing SessionBindingListener in HttpSessionStore instead? I agree, that would be even simpler.&lt;/p&gt;</comment>
                            <comment id="16335618" author="papegaaij" created="Tue, 23 Jan 2018 10:38:07 +0000"  >&lt;p&gt;It seems a clean solution, but we need to make sure we do not introduce a regression again with this fix.&lt;/p&gt;</comment>
                            <comment id="16336032" author="bitstorm" created="Tue, 23 Jan 2018 16:36:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=papegaaij&quot; class=&quot;user-hover&quot; rel=&quot;papegaaij&quot;&gt;papegaaij&lt;/a&gt; you are right. I&apos;ve seen that other issues like &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-5164&quot; title=&quot;PageStoreManager.SessionEntry keeps outdated sessionId when container changes sessionId&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-5164&quot;&gt;&lt;del&gt;WICKET-5164&lt;/del&gt;&lt;/a&gt; might be affected by this kind of solution. At the moment I don&apos;t have any better ideas so your solution is ok also for me.&lt;/p&gt;</comment>
                            <comment id="16337132" author="githubbot" created="Wed, 24 Jan 2018 08:35:55 +0000"  >&lt;p&gt;Github user bitstorm closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/wicket/pull/259&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/pull/259&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16344866" author="bitstorm" created="Tue, 30 Jan 2018 10:51:42 +0000"  >&lt;p&gt;any news about this? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=papegaaij&quot; class=&quot;user-hover&quot; rel=&quot;papegaaij&quot;&gt;papegaaij&lt;/a&gt; could take care of this issue? Thank you.&lt;/p&gt;</comment>
                            <comment id="16344963" author="papegaaij" created="Tue, 30 Jan 2018 12:11:06 +0000"  >&lt;p&gt;I&apos;ll take a look at it.&lt;/p&gt;</comment>
                            <comment id="16344991" author="jira-bot" created="Tue, 30 Jan 2018 12:51:42 +0000"  >&lt;p&gt;Commit a6b48110f130cb3074b78f8add29b59d4a0ecc7f in wicket&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emond&quot; class=&quot;user-hover&quot; rel=&quot;emond&quot;&gt;emond&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=wicket.git;h=a6b4811&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=wicket.git;h=a6b4811&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6522&quot; title=&quot;ThreadLocal leak in PageStoreManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6522&quot;&gt;&lt;del&gt;WICKET-6522&lt;/del&gt;&lt;/a&gt;: move ThreadLocal to a static field to prevent leaks&lt;/p&gt;</comment>
                            <comment id="16344998" author="jira-bot" created="Tue, 30 Jan 2018 12:56:49 +0000"  >&lt;p&gt;Commit 242d4e9e1c32b2cb5c03a657ecafdd50dc9f6c30 in wicket&apos;s branch refs/heads/wicket-7.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emond&quot; class=&quot;user-hover&quot; rel=&quot;emond&quot;&gt;emond&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=wicket.git;h=242d4e9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=wicket.git;h=242d4e9&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6522&quot; title=&quot;ThreadLocal leak in PageStoreManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6522&quot;&gt;&lt;del&gt;WICKET-6522&lt;/del&gt;&lt;/a&gt;: move ThreadLocal to a static field to prevent leaks&lt;/p&gt;</comment>
                            <comment id="16345215" author="bitstorm" created="Tue, 30 Jan 2018 15:22:57 +0000"  >&lt;p&gt;thank you!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 41 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3p6ef:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>