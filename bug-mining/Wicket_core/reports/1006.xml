<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:22:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-5243] JS: High stack size in Function Executor causes &quot;too much recursion&quot;</title>
                <link>https://issues.apache.org/jira/browse/WICKET-5243</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;The Function Executor in wicket-ajax-jquery.js uses recursion and deferred calls to the notify() function to ensure synchronous execution of all tasks contained in an AjaxResponse.&lt;br/&gt;
Each task calls notif() when it is finished. This causes a recursive call to processNext() thus raising the stack for each execution. If there are a lot of task to handle, the stack size will increase beyond the possible stack size in the client causing a &quot;too much recursion&quot; exception and increasingly low performance.&lt;/p&gt;

&lt;p&gt;The deferred execution of notify is only necessary if the task executor has to wait for long running tasks to finish at some uncertain point in the future. Examples: downloading of external resources (js, css, images). These task can call back the executor as soon as they are really finished (e.g. load event triggerd).&lt;/p&gt;

&lt;p&gt;The problem is that the majority of tasks don&apos;t need to wait but return instantly instead. Examples: exchanging components, executing custom javascripts that do not use the &quot;|-syntax&quot; to include the notify callback.&lt;/p&gt;

&lt;p&gt;Current fix: The depth of the stack is counted and if a depth of &amp;gt;= 1000 is reached, a timeout will interrupt the synchronous task queue execution. A new executor will continue with an empty stack.&lt;br/&gt;
Problems with that approach: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;why 1000?&lt;/li&gt;
	&lt;li&gt;several ajax requests might interrupt each other because the synchronous execution is broken.&lt;/li&gt;
	&lt;li&gt;if an executed custom javascript creates a big stack itself (e.g. by using jquery a lot) the stack will add to the stack used by the Function Executor so that it may still be too big.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Proposal to fix this: see also the attached patch.&lt;br/&gt;
Another callback notifyContinue() is supported that can be called whenever the task will return instantly. This callback avoids the recursive call to processNext and continues in a simple loop over all the tasks.&lt;/p&gt;
</description>
                <environment>Tested on Firefox</environment>
        <key id="12653881">WICKET-5243</key>
            <summary>JS: High stack size in Function Executor causes &quot;too much recursion&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgrigorov">Martin Tzvetanov Grigorov</assignee>
                                    <reporter username="tobiashaupt">Tobias Haupt</reporter>
                        <labels>
                            <label>javascript</label>
                            <label>perfomance</label>
                    </labels>
                <created>Thu, 20 Jun 2013 07:50:57 +0000</created>
                <updated>Wed, 5 Mar 2014 20:02:33 +0000</updated>
                            <resolved>Wed, 5 Mar 2014 08:49:15 +0000</resolved>
                                    <version>6.8.0</version>
                                    <fixVersion>7.0.0-M1</fixVersion>
                    <fixVersion>6.15.0</fixVersion>
                                    <component>wicket</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13688996" author="mgrigorov" created="Thu, 20 Jun 2013 08:06:21 +0000"  >&lt;p&gt;&amp;gt; why 1000 ?&lt;br/&gt;
See &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-4675?focusedCommentId=13426609&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13426609&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/WICKET-4675?focusedCommentId=13426609&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13426609&lt;/a&gt;&lt;br/&gt;
It is a random number that most of the browsers can handle. But it depends on how much data is in each stack frame ...&lt;/p&gt;

&lt;p&gt;There is problem with your assumption that you should not wait when components are changed and JS is executed.&lt;br/&gt;
The contract is:&lt;br/&gt;
1) load all header contributions. This is needed because a script in prependJavaScript may need some library to do its job&lt;br/&gt;
2) execute prependJavaScript scripts&lt;br/&gt;
3) replace the components&lt;br/&gt;
4) execute all OnDomReady, OnLoad and OnEvent header contributions&lt;br/&gt;
5) execute all appendJavaScript scripts&lt;/p&gt;

&lt;p&gt;prependJS and appendJS scripts are combined in one step each (See &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-4675&quot; title=&quot;Process Ajax responses in one go&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-4675&quot;&gt;&lt;del&gt;WICKET-4675&lt;/del&gt;&lt;/a&gt;), so this shouldn&apos;t be the problem in your case.&lt;br/&gt;
I guess you don&apos;t have hundreds of header contributions so probably you have many components to be replaced ?!&lt;/p&gt;

&lt;p&gt;Can you copy the Ajax response when you face this problem and attach it to the ticket so we can investigate what is the reason ?&lt;/p&gt;</comment>
                            <comment id="13689001" author="tobiashaupt" created="Thu, 20 Jun 2013 08:17:37 +0000"  >&lt;p&gt;&amp;gt; why 1000?&lt;br/&gt;
Actually I first noticed that bug on a very old system (500MB Ram, WinXP, ...). In my opinion any number is just an assumption of a certain system.&lt;/p&gt;

&lt;p&gt;I do not make the assumption that you should not wait. I totally agree that every task has to be finished completly until the next task is executed. Parallel execution has to be avoided to hold the contract that you specified above. Thats clear and the patch I use does not break that principle, does it?&lt;/p&gt;

&lt;p&gt;But (in most of the cases!) you dont need recursion to wait for the current task to finish. You can also wait in a simple loop. Still some task need the recursion.&lt;/p&gt;</comment>
                            <comment id="13689014" author="tobiashaupt" created="Thu, 20 Jun 2013 08:36:32 +0000"  >&lt;p&gt;Added a response that triggered that error before applying the patch.&lt;/p&gt;</comment>
                            <comment id="13689019" author="tobiashaupt" created="Thu, 20 Jun 2013 08:40:50 +0000"  >&lt;p&gt;In my example I do use a lot of header contributions to attach events to my own event queue. I trigger that queue at the very end of the whole response. I can see that this is not optimal because I may use prependJS in future to avoid the header contributions totally. The application was ported from 1.4 to 1.5 now to 6.x and this is some aspect that I can do better with the changed api possibilities. I may even gain some speed in the execution. &lt;/p&gt;

&lt;p&gt;Anyway wicket should not simply crash or freeze the browser with this number of header contributions, components etc.&lt;/p&gt;</comment>
                            <comment id="13689044" author="mgrigorov" created="Thu, 20 Jun 2013 09:21:56 +0000"  >&lt;p&gt;In Wicket 1.5 and before the check to reset the depth and use setTimeout was:&lt;/p&gt;

&lt;p&gt;  if (this.depth &amp;gt; 50 || Wicket.Browser.isKHTML() || Wicket.Browser.isSafari()) &lt;/p&gt;

&lt;p&gt;i.e. it used 50 for old WebKits. I&apos;m not sure how it worked for Firefox in your case - there was no upper bound.&lt;/p&gt;

&lt;p&gt;I&apos;ll feel better if we decrease the check from 1000 to 50 for all browsers than to change the logic for the scheduling and notifications.&lt;br/&gt;
Can you check with what number your use case don&apos;t break with &quot;too much recursion&quot; ?&lt;/p&gt;</comment>
                            <comment id="13689046" author="mgrigorov" created="Thu, 20 Jun 2013 09:26:20 +0000"  >&lt;p&gt;Actually&lt;/p&gt;

&lt;p&gt;   if (this.depth &amp;gt; 50 || Wicket.Browser.isKHTML() || Wicket.Browser.isSafari()) &lt;/p&gt;

&lt;p&gt;says what I just proposed - 50 for all. Just old WebKits use setTimeout &lt;b&gt;always&lt;/b&gt;! I read it wrong the first time.&lt;/p&gt;</comment>
                            <comment id="13689072" author="tobiashaupt" created="Thu, 20 Jun 2013 09:52:26 +0000"  >&lt;p&gt;Using the timeout in general makes the result of the execution unpredictable because it switches from a synchronous to an asynchronous (or even parallel) way of execution.&lt;/p&gt;

&lt;p&gt;I will check the 50 asap.&lt;/p&gt;</comment>
                            <comment id="13689080" author="mgrigorov" created="Thu, 20 Jun 2013 09:59:39 +0000"  >&lt;p&gt;You are correct.&lt;br/&gt;
We will have to think some more on this.&lt;/p&gt;</comment>
                            <comment id="13689097" author="tobiashaupt" created="Thu, 20 Jun 2013 10:10:15 +0000"  >&lt;p&gt;Instead of decreasing the depth threshold, I used prependJavascript instead of header contributions in my application. This fixed my problem even with a number of 1000 and is also much more elegant.&lt;/p&gt;

&lt;p&gt;Still the patch fixed my initial problem and should be considered. It avoids the usage (firing) of the threshold in a lot more cases. It will probably increase the support of old browsers without the need of lowering the threshold conditionally.&lt;/p&gt;

&lt;p&gt;Thanks for the quick response Martin.&lt;/p&gt;</comment>
                            <comment id="13689103" author="mgrigorov" created="Thu, 20 Jun 2013 10:14:59 +0000"  >&lt;p&gt;I prefer to not change this logic until really needed.&lt;br/&gt;
I&apos;ll leave the ticket open for some time so someone else can work on it.&lt;/p&gt;</comment>
                            <comment id="13689324" author="mgrigorov" created="Thu, 20 Jun 2013 15:18:13 +0000"  >&lt;p&gt;JS test &quot;Wicket.Ajax: Process response with 2k+ evaluations&quot; also suffers with this symptom on IE9 and older. All other browsers are OK, including IE10.&lt;br/&gt;
Decreasing the threshold to 500 fixes it.&lt;/p&gt;

&lt;p&gt;Reworking the FunctionExecuter to use Promises (jQuery.Deferred) will probably solve this issue. But this will take some time.&lt;/p&gt;</comment>
                            <comment id="13913194" author="gsmet" created="Wed, 26 Feb 2014 17:25:18 +0000"  >&lt;p&gt;FWIW, starting with Firefox 23, we started to have Too much recursion error when we replace too many components with Wicket (with &quot;too many&quot; quite low unfortunately).&lt;/p&gt;

&lt;p&gt;It looks like a Firefox regression and we filled a bug here:&lt;br/&gt;
&lt;a href=&quot;https://bugzilla.mozilla.org/show_bug.cgi?id=960523&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugzilla.mozilla.org/show_bug.cgi?id=960523&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;People at Mozilla are currently looking into it.&lt;/p&gt;

&lt;p&gt;Some other people started to have problems too here:&lt;br/&gt;
&lt;a href=&quot;https://bugzilla.mozilla.org/show_bug.cgi?id=966173&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugzilla.mozilla.org/show_bug.cgi?id=966173&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thought it might be useful information.&lt;/p&gt;

&lt;p&gt;&amp;#8211; &lt;br/&gt;
Guillaume&lt;/p&gt;</comment>
                            <comment id="13914324" author="ihorpts" created="Thu, 27 Feb 2014 09:46:46 +0000"  >&lt;p&gt;@&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=damieng&quot; class=&quot;user-hover&quot; rel=&quot;damieng&quot;&gt;damieng&lt;/a&gt; thank you for the info - we&apos;ve got the same issue now with Wicket 6.5.0 + Firefox 24 when a page is trying to replace too many components&lt;/p&gt;</comment>
                            <comment id="13919371" author="mgrigorov" created="Tue, 4 Mar 2014 13:19:45 +0000"  >&lt;p&gt;I have an idea how to simplify Wicket&apos;s code.&lt;br/&gt;
First let me reproduce the problem with FunctionExecuter involved.&lt;/p&gt;</comment>
                            <comment id="13919405" author="mgrigorov" created="Tue, 4 Mar 2014 13:52:49 +0000"  >&lt;p&gt;Here are a patch and a patched wicket-ajax-jquery.js.&lt;br/&gt;
The idea is that notify() is used only when there is something asynchronous. In all other cases the functions return state. When the state is DONE (i.e. the execution has finished without problems) FunctionsExecuter will execute the next scheduled function without allocating a new stack frame.&lt;/p&gt;

&lt;p&gt;Now only loading a new &amp;lt;script&amp;gt;, a new &amp;lt;link&amp;gt; and JavaScript execution (appendJavaScript/prependJavaScript) with manual control will require new stack frame.&lt;/p&gt;

&lt;p&gt;Please test this suggested fix with your applications and give feedback.&lt;/p&gt;</comment>
                            <comment id="13919409" author="ihorpts" created="Tue, 4 Mar 2014 14:03:09 +0000"  >&lt;p&gt;Thank you Martin.&lt;/p&gt;

&lt;p&gt;As far as we can test it - I&apos;ll give immediate feedback here.&lt;/p&gt;</comment>
                            <comment id="13919531" author="gsmet" created="Tue, 4 Mar 2014 15:43:01 +0000"  >&lt;p&gt;Hi Martin,&lt;/p&gt;

&lt;p&gt;I can confirm that your patch fixes our &quot;too much recursion&quot; issues with Firefox.&lt;/p&gt;

&lt;p&gt;We will continue to follow up on the Firefox issue to see if we can get the limit back to what it was before there, but it&apos;s really nice to have it fixed in Wicket.&lt;/p&gt;

&lt;p&gt;&amp;#8211; &lt;br/&gt;
Guillaume&lt;/p&gt;</comment>
                            <comment id="13919538" author="mgrigorov" created="Tue, 4 Mar 2014 15:45:56 +0000"  >&lt;p&gt;Thanks for testing, Guillaume!&lt;br/&gt;
I will clean and document the new functionality and push it. It will be part of 6.15.&lt;/p&gt;</comment>
                            <comment id="13919546" author="gsmet" created="Tue, 4 Mar 2014 15:56:45 +0000"  >&lt;p&gt;Thanks Martin!&lt;/p&gt;

&lt;p&gt;We look forward to 6.15!&lt;/p&gt;</comment>
                            <comment id="13920657" author="mgrigorov" created="Wed, 5 Mar 2014 08:49:15 +0000"  >&lt;p&gt;The suggested patch has been applied to wicket-6.x and master branches.&lt;br/&gt;
From now on recursion will not be used when there is no need to wait for notify() calls.&lt;br/&gt;
notify() is needed only for JS/CSS resources&apos; download and JS execution with manual control.&lt;/p&gt;

&lt;p&gt;This reduces a lot the need of allocating stack frames (i.e. using recursion) but still doesn&apos;t remove this completely.&lt;/p&gt;</comment>
                            <comment id="13920663" author="mgrigorov" created="Wed, 5 Mar 2014 08:57:06 +0000"  >&lt;p&gt;The fix has been tested locally on:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;IE 8 (XP), 9 and 11 (Windows 7)&lt;/li&gt;
	&lt;li&gt;Chrome 32 (Linux), 27 (Windows)&lt;/li&gt;
	&lt;li&gt;Firefox 27 (Linux), 25 (Windows)&lt;/li&gt;
	&lt;li&gt;Opera 16 (Windows)&lt;/li&gt;
	&lt;li&gt;Safari 5.1.7 (Windows)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13921329" author="ihorpts" created="Wed, 5 Mar 2014 20:02:33 +0000"  >&lt;p&gt;Hi Martin&lt;/p&gt;

&lt;p&gt;Your patch has fixed our problem as well (it was merged for Wicket 6.5.0).&lt;/p&gt;

&lt;p&gt;Thank you!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12617398">WICKET-4881</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12632195">WICKET-5039</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12600313">WICKET-4675</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12588779" name="WICKET-5243-avoid-recursion.patch" size="4947" author="tobiashaupt" created="Thu, 20 Jun 2013 07:52:03 +0000"/>
                            <attachment id="12632504" name="WICKET-5243-notify-only-when-async.patch" size="5486" author="mgrigorov" created="Tue, 4 Mar 2014 13:52:49 +0000"/>
                            <attachment id="12588789" name="response.xml" size="497623" author="tobiashaupt" created="Thu, 20 Jun 2013 08:36:32 +0000"/>
                            <attachment id="12632505" name="wicket-ajax-jquery.js" size="83086" author="mgrigorov" created="Tue, 4 Mar 2014 13:52:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>334158</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 37 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ln67:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>334484</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>