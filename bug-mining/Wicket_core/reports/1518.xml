<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:26:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-6771] Performance issues accessing component metadata while iterating</title>
                <link>https://issues.apache.org/jira/browse/WICKET-6771</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;We have recently rolled out continuous profiling using JFR to our production environment. With some very surprising results. The biggest one being that one of the hottest methods in our application is &lt;tt&gt;Component.getMetaData():&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13001281/13001281_image-2020-04-27-09-57-20-368.png&quot; height=&quot;745&quot; width=&quot;1143&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Component metadata is used to store removal operations for the duration of the request and is accessed every time a component&apos;s children are iterated and when detaching components.&lt;/p&gt;

&lt;p&gt;The profiler screenshot above shows one of the possible code paths.&lt;/p&gt;

&lt;p&gt;I couldn&apos;t believe this at first so I decided to write a JMH benchmark. It turns out that between 20% and 35% of time in the detach method is spent on getting (empty) removal metadata.&lt;/p&gt;

&lt;p&gt;The benchmark compares checking metadata with a request-level boolean flag that is set when a component has removals:&lt;/p&gt;
&lt;blockquote&gt;&lt;ol&gt;
	&lt;li&gt;Run complete. Total time: 00:02:44&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Benchmark Score Error Units&lt;br/&gt;
ComponentBenchmarks.detachComponentWithFlags &lt;b&gt;12295,363&lt;/b&gt; &#177; 71,343 ops/s&lt;br/&gt;
ComponentBenchmarks.detachComponentWithMetaData &lt;b&gt;8855,321&lt;/b&gt; &#177; 34,743 ops/s&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I will shortly create a PR with the benchmark so you can replicate these issues.&lt;/p&gt;

&lt;p&gt;I have not found time yet to profile the metadata code to get to the root cause of this. Help would be greatly appreciated. If we cannot improve the performance of accessing metadata, I&apos;d suggest introducing request-level flags that are checked before accessing metadata for the most active code paths like I have done in the benchmark.&lt;/p&gt;

&lt;p&gt;I will create separate tickets for some other issues found by profiling on production that are quite easy to fix. This issue is the most important finding though.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13301186">WICKET-6771</key>
            <summary>Performance issues accessing component metadata while iterating</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="svenmeier">Sven Meier</assignee>
                                    <reporter username="thomas.heigl">Thomas Heigl</reporter>
                        <labels>
                    </labels>
                <created>Mon, 27 Apr 2020 07:58:00 +0000</created>
                <updated>Wed, 29 Apr 2020 12:20:47 +0000</updated>
                            <resolved>Wed, 29 Apr 2020 12:20:47 +0000</resolved>
                                    <version>8.7.0</version>
                    <version>9.0.0-M5</version>
                                    <fixVersion>9.0.0</fixVersion>
                    <fixVersion>8.9.0</fixVersion>
                                    <component>wicket-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17093156" author="thomas.heigl" created="Mon, 27 Apr 2020 08:07:56 +0000"  >&lt;p&gt;Here is the PR with my benchmark: &lt;a href=&quot;https://github.com/apache/wicket/pull/420&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/pull/420&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please run the benchmark 2-3 times to verify my results.&lt;/p&gt;</comment>
                            <comment id="17095245" author="thomas.heigl" created="Wed, 29 Apr 2020 08:47:55 +0000"  >&lt;p&gt;I experimentally pulled out MetaDataEntry[] into a separate field on Component instead of the storing it in the shared &lt;tt&gt;datas&lt;/tt&gt; object. Performance increased significantly in both cases and more than doubled from the baseline:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Benchmark  Score Error  Units&lt;br/&gt;
ComponentBenchmarks.detachComponentWithFlags &lt;b&gt;20764,040&lt;/b&gt; &#177; 147,383  ops/s&lt;br/&gt;
ComponentBenchmarks.detachComponentWithMetaData &lt;b&gt;19158,646&lt;/b&gt; &#177; 126,370  ops/s&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This requires a tiny bit of extra memory when a component only has a single &lt;tt&gt;MetaDataEntry&lt;/tt&gt; but it greatly improves throughput and simplifies the code.&lt;/p&gt;

&lt;p&gt;The arcane logic for storing everything in a single untyped &lt;tt&gt;datas&lt;/tt&gt; object might have been useful years ago when the code was written, but it seems to severely affect the performance of accessing and manipulating the data.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=svenmeier&quot; class=&quot;user-hover&quot; rel=&quot;svenmeier&quot;&gt;svenmeier&lt;/a&gt;: What do you think? Would it be an acceptable trade off to double throughput by adding the memory overhead of an array for components with metadata?&lt;/p&gt;

&lt;p&gt;I&apos;ll push this change as a single commit so you can compare the change in throughput.&lt;/p&gt;</comment>
                            <comment id="17095298" author="thomas.heigl" created="Wed, 29 Apr 2020 09:57:35 +0000"  >&lt;p&gt;The component&apos;s model could be pulled out of the &lt;tt&gt;data&lt;/tt&gt; object as well, further simplifying the code without any adverse effects on memory. It could even improve memory usage when a component has a model and only a single behavior, because the behavior would be stored as a single object and not in an array together with the model.&lt;/p&gt;

&lt;p&gt;I experimentally made the change on my machine. It doesn&apos;t have any effect on throughput but the code simplification might be worth it. When metadata and model are pulled out, the &lt;tt&gt;data&lt;/tt&gt; object would only store behaviors.&lt;/p&gt;</comment>
                            <comment id="17095307" author="svenmeier" created="Wed, 29 Apr 2020 10:08:42 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomas.heigl&quot; class=&quot;user-hover&quot; rel=&quot;thomas.heigl&quot;&gt;thomas.heigl&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;I pushed a simpler solution that prevents unnecessary access to metadata when iterating the children.&lt;/p&gt;

&lt;p&gt;Could you give it a try?&lt;/p&gt;

&lt;p&gt;Sven&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17095311" author="svenmeier" created="Wed, 29 Apr 2020 10:18:26 +0000"  >&lt;p&gt;&amp;gt; logic for storing everything in a single untyped &lt;tt&gt;datas&lt;/tt&gt; object might have been useful ...&lt;br/&gt;
&amp;gt; but it seems to severely affect the performance of accessing and manipulating the data.&lt;/p&gt;

&lt;p&gt;You&apos;re right in that separating metaData and model from the behaviors would simplify things a lot.&lt;/p&gt;

&lt;p&gt;We&apos;ll have to value the trade-off between memory and performance.&lt;/p&gt;</comment>
                            <comment id="17095332" author="thomas.heigl" created="Wed, 29 Apr 2020 10:46:38 +0000"  >&lt;p&gt;Hi Sven!&lt;/p&gt;

&lt;p&gt;I just ran the benchmark a couple of times with your changes:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Benchmark Score Error Units&lt;br/&gt;
ComponentBenchmarks.detachComponentWithMetaData &lt;b&gt;11304,774&lt;/b&gt; &#177; 742,698  ops/s&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It is faster than the original code but it is slower than my flag demo because metadata is still accessed for every detaching component in &lt;tt&gt;MarkupContainer.onDetach&lt;/tt&gt; by &lt;tt&gt;removals_clear&lt;/tt&gt; and by &lt;tt&gt;Component.detachFeedback&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;And it is much slower than the version with metadata extracted into a separate field.&lt;/p&gt;

&lt;p&gt;So I&apos;d say your change is good and will likely improve the situation significantly, but there still is much room for improvement.&lt;/p&gt;

&lt;p&gt;Should I modify my PR to only include the changes to extract metadata and model into separate fields, so we can discuss the implications? Or is this a change you would not consider making?&lt;/p&gt;</comment>
                            <comment id="17095348" author="svenmeier" created="Wed, 29 Apr 2020 11:08:40 +0000"  >&lt;p&gt;Hi Thomas,&lt;/p&gt;

&lt;p&gt;let&apos;s keep this issue for optimizing iteration of children, i.e. metadata is no longer accessed for each iterated child. I will apply the optimization to 8.x too.&lt;/p&gt;

&lt;p&gt;Please open a new&#160; issue for separating metadata, model and behaviors in separate fields. We&apos;ll have to discuss this, maybe it is something to consider for 9.x.&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Sven&lt;/p&gt;</comment>
                            <comment id="17095351" author="bitstorm" created="Wed, 29 Apr 2020 11:12:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;The component&apos;s model could be pulled out of the &lt;tt&gt;data&lt;/tt&gt; object as well, further simplifying the code without any adverse effects on memory. It could even improve memory usage when a component has a model and only a single behavior, because the behavior would be stored as a single object and not in an array together with the model.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I like this kind of approach! BTW it&apos;s the same thing done for RequestCycle metadata&lt;/p&gt;</comment>
                            <comment id="17095365" author="thomas.heigl" created="Wed, 29 Apr 2020 11:26:47 +0000"  >&lt;p&gt;Thanks Sven!&lt;/p&gt;

&lt;p&gt;I created &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6774&quot; title=&quot;Separate model, behaviors and metadata into separate fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6774&quot;&gt;WICKET-6774&lt;/a&gt; and will add a PR and a detailed description of memory tradeoffs shortly.&lt;/p&gt;</comment>
                            <comment id="17095399" author="jira-bot" created="Wed, 29 Apr 2020 12:20:29 +0000"  >&lt;p&gt;Commit dd13bb87db49a56a9080a9723f557fb3d5b1a881 in wicket&apos;s branch refs/heads/wicket-8.x from Sven Meier&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=wicket.git;h=dd13bb8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=wicket.git;h=dd13bb8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6771&quot; title=&quot;Performance issues accessing component metadata while iterating&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6771&quot;&gt;&lt;del&gt;WICKET-6771&lt;/del&gt;&lt;/a&gt; avoid access to removals&lt;/p&gt;

&lt;p&gt;unless needed&lt;/p&gt;</comment>
                            <comment id="17095400" author="svenmeier" created="Wed, 29 Apr 2020 12:20:47 +0000"  >&lt;p&gt;MetaData is no longer accessed for iterating children, when no modification has happened&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13301779">WICKET-6774</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13001281" name="image-2020-04-27-09-57-20-368.png" size="352080" author="thomas.heigl" created="Mon, 27 Apr 2020 07:57:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 28 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0e3rs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>