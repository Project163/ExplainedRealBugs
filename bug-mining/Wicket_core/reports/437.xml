<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:19:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-4164] StoredResponsesMap not threadsafe</title>
                <link>https://issues.apache.org/jira/browse/WICKET-4164</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;The StoredResponsesMap is based on the not so threadsafe LinkedHashMap. This map is filled from multiple threads by the WebPageRenderer, which can lead to the internal table property of hashmap going out of sync with the header property of linkedhashmap. As the hashmap entries are not gc&apos;able this leads to out of memory exceptions.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12528467">WICKET-4164</key>
            <summary>StoredResponsesMap not threadsafe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgrigorov">Martin Tzvetanov Grigorov</assignee>
                                    <reporter username="boschman">Sverre Boschman</reporter>
                        <labels>
                    </labels>
                <created>Mon, 24 Oct 2011 11:23:35 +0000</created>
                <updated>Tue, 25 Oct 2011 18:04:41 +0000</updated>
                            <resolved>Tue, 25 Oct 2011 18:04:41 +0000</resolved>
                                    <version>1.5.1</version>
                                    <fixVersion>1.5.3</fixVersion>
                                    <component>wicket</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13133985" author="mgrigorov" created="Mon, 24 Oct 2011 11:29:50 +0000"  >&lt;p&gt;Can you make it failing by using org.apache.wicket.protocol.http.StoredResponsesMapTest.heavyLoad() or completely new test method ?&lt;/p&gt;</comment>
                            <comment id="13134016" author="boschman" created="Mon, 24 Oct 2011 12:22:51 +0000"  >&lt;p&gt;yes, just add&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;code&amp;#93;&lt;/span&gt;&lt;br/&gt;
endLatch.await();&lt;br/&gt;
System.out.println(map.size());&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;/code&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;output: 500253 or 500602 or 500439 or ... &lt;/p&gt;

&lt;p&gt;but max entries is 1000, so map.size() should never be more than 1000.&lt;/p&gt;</comment>
                            <comment id="13134831" author="mgrigorov" created="Tue, 25 Oct 2011 08:14:42 +0000"  >&lt;p&gt;Here is a patch that adds as minimum synchronization as I can imagine for this kind of map.&lt;/p&gt;

&lt;p&gt;A better solution would be a mix of ConcurrentMap and LinkedHashMap&apos;s java.util.LinkedHashMap.removeEldestEntry(Entry&amp;lt;K, V&amp;gt;)&lt;/p&gt;

&lt;p&gt;With this patch the performance of this map decreased 15 times&lt;/p&gt;</comment>
                            <comment id="13134849" author="boschman" created="Tue, 25 Oct 2011 09:00:39 +0000"  >&lt;p&gt;How did you test the performance of the map? My very naive approach of running the unittest a few times in eclipse and looking at the reported execution time of the heavyLoad test shows you actually made the performance better, not worse. The synchronized parts will block and decrease performance, but the maximum capacity of the underlying hashmap never grows beyond 1000. Which means a lot less very expensive rehashes.&lt;/p&gt;</comment>
                            <comment id="13134857" author="mgrigorov" created="Tue, 25 Oct 2011 09:13:36 +0000"  >&lt;p&gt;The old version of the test works with 10k iterations, the new one with 1k.&lt;br/&gt;
The old one ran for ~ 45secs, the new for ~27secs on my computer. &lt;/p&gt;

&lt;p&gt;old : 0.0045s per iteration&lt;br/&gt;
new: 0.027s per iteration&lt;br/&gt;
0.027 / 0.0045 = 6 times slower&lt;/p&gt;

&lt;p&gt;Not 15 but still slower &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13134901" author="boschman" created="Tue, 25 Oct 2011 09:44:46 +0000"  >&lt;p&gt;You also changed the test itself by using the CopyOnWriteArrayList, which seems to have a very big impact on the performance (changed it to 10k iterations and it is already running for minutes using the old StoredResponsesMap code...). My previous observation was based on the &apos;new&apos; unittest with 100 threads and 1000 iterations against the old StoredResponsesMap and the new StoredResponsesMap. The old StoredResponsesMap took 15.1 - 15.2 seconds, while the new StoredResponsesMap took 14.8 - 15.0 seconds. Not a dramatic difference, but at least it doesn&apos;t seem 6 times slower to me.&lt;br/&gt;
Funny thing, using the CopyOnWriteArrayList in the test also makes the chances the initally reported threading issues occurs in the test and blowing up the map smaller.&lt;/p&gt;</comment>
                            <comment id="13134909" author="mgrigorov" created="Tue, 25 Oct 2011 09:55:44 +0000"  >&lt;p&gt;Yes, I forgot to test the old SRM with the CopyOnWriteArrayList in the test ...&lt;br/&gt;
Give it a try in your real app and let us know whether it is stable.&lt;br/&gt;
I also use it locally but I cannot load test it more at the moment.&lt;/p&gt;</comment>
                            <comment id="13134915" author="boschman" created="Tue, 25 Oct 2011 10:15:09 +0000"  >&lt;p&gt;Changed the CopyOnWriteArrayList to Collections.synchronizedList(new ArrayList&amp;lt;String&amp;gt;()) in the heavyLoad test.&lt;/p&gt;

&lt;p&gt;Three run average based on 100 threads and 10k iterations:&lt;br/&gt;
old StoredResponsesMap: 34.299s&lt;br/&gt;
new StoredResponsesMap: 17.007s&lt;/p&gt;

&lt;p&gt;So it seems we were previously benchmarking the CopyOnWriteArrayList instead of the StoredResponsesMap. So, you made the map twice as fast &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Unfortunately getting the code into our real app is a bit of a hassle... &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12500628" name="WICKET-4164.patch" size="3035" author="mgrigorov" created="Tue, 25 Oct 2011 08:14:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>214327</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 4 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0k94n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>116296</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>