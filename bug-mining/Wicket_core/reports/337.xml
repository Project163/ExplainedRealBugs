<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:18:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-3931] Component markup caching inconsistencies</title>
                <link>https://issues.apache.org/jira/browse/WICKET-3931</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-3891&quot; title=&quot;in development mode Wicket stops picking up markup changes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-3891&quot;&gt;&lt;del&gt;WICKET-3891&lt;/del&gt;&lt;/a&gt; we found that Component#markup field is not being reset between requests. The problem is that this field is transient and it is null-ified only when the page is read from the second level page cache (see &lt;a href=&quot;https://cwiki.apache.org/confluence/x/qIaoAQ&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/x/qIaoAQ&lt;/a&gt;). If the page instance is read from first level cache (http session) then its non-serialized version is used and the markup field value is still non-null.&lt;/p&gt;

&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-3891&quot; title=&quot;in development mode Wicket stops picking up markup changes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-3891&quot;&gt;&lt;del&gt;WICKET-3891&lt;/del&gt;&lt;/a&gt; this looked like a minor issue with the markup caching in development mode but actually this problem is valid even in production mode.&lt;br/&gt;
See the attached application. When the panel&apos;s variation is changed every MarkupContainer inside still uses its old markup. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12515245">WICKET-3931</key>
            <summary>Component markup caching inconsistencies</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgrigorov">Martin Tzvetanov Grigorov</assignee>
                                    <reporter username="mgrigorov">Martin Tzvetanov Grigorov</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Jul 2011 11:18:26 +0000</created>
                <updated>Thu, 28 Jul 2011 13:14:35 +0000</updated>
                            <resolved>Thu, 28 Jul 2011 13:14:35 +0000</resolved>
                                    <version>1.5-RC5.1</version>
                                    <fixVersion>1.5-RC6</fixVersion>
                                    <component>wicket</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13070433" author="mgrigorov" created="Mon, 25 Jul 2011 11:19:32 +0000"  >&lt;p&gt;A quickstart showing the problem.&lt;/p&gt;</comment>
                            <comment id="13070434" author="mgrigorov" created="Mon, 25 Jul 2011 11:24:33 +0000"  >&lt;p&gt;Index: wicket-core/src/main/java/org/apache/wicket/Component.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; wicket-core/src/main/java/org/apache/wicket/Component.java	(revision 1150368)&lt;br/&gt;
+++ wicket-core/src/main/java/org/apache/wicket/Component.java	(working copy)&lt;br/&gt;
@@ -3807,6 +3807,8 @@&lt;br/&gt;
 	 */&lt;br/&gt;
 	protected void onDetach()&lt;/p&gt;
 	{
+		markup = null;
+
 		setFlag(FLAG_DETACHING, false);
 	}

&lt;p&gt;This fixes the problem. This way the markup is read from the MarkupCache at every request and it properly refreshes changes in DEV mode and changes in the component variation in DEPLOYMENT mode.&lt;br/&gt;
The &apos;markup&apos; variable is still &apos;transient&apos; just in case.&lt;/p&gt;</comment>
                            <comment id="13070435" author="mgrigorov" created="Mon, 25 Jul 2011 11:25:00 +0000"  >&lt;p&gt;Juergen, what do you think about this ?&lt;/p&gt;</comment>
                            <comment id="13070564" author="jdonnerstag" created="Mon, 25 Jul 2011 15:48:44 +0000"  >&lt;p&gt;I guess it is the easiest and cleanest solution:&lt;br/&gt;
pro: applies to all components (you can not miss one, even though it might not be needed)&lt;br/&gt;
pro: reduced memory footprint.&lt;br/&gt;
con: requires to load markup upon the next request. Though loading from MarkupCache is cheap. I don&apos;t expect any performance penalities.&lt;/p&gt;

&lt;p&gt;I wonder if we need to make sure that not by accident the markup gets re-loaded after detach. E.g. if a user first calls super.detach()  but than uses getMarkup() for whatever reason in his onDetach(). Maybe it&apos;s better to cleanup the markup after onDetach() has been executed via iterating over the hierarchy again and calling setMarkup(null).&lt;/p&gt;

&lt;p&gt;It&apos;d be good to add test case as well. &lt;/p&gt;</comment>
                            <comment id="13071055" author="mgrigorov" created="Tue, 26 Jul 2011 11:54:54 +0000"  >&lt;p&gt;The tests for InlineEnclosure fail with this change.&lt;br/&gt;
I&apos;ll investigate.&lt;/p&gt;</comment>
                            <comment id="13071653" author="mgrigorov" created="Wed, 27 Jul 2011 11:06:24 +0000"  >&lt;p&gt;This is the best I was able to do so far.&lt;br/&gt;
Now InlineEnclosure has a logic to find its markup for Ajax requests.&lt;/p&gt;

&lt;p&gt;The only problem is that now org.apache.wicket.markup.html.internal.AjaxEnclosureTest.testNestedInlineEnclosuresShouldToggleNormally() fails because all InlineEnclosures in a page have the same component id (InlineEnclosure-) and finding the markup is impossible.&lt;/p&gt;</comment>
                            <comment id="13071971" author="jdonnerstag" created="Wed, 27 Jul 2011 20:16:18 +0000"  >&lt;p&gt;First I was thinking that other components are affected as well, but only auto-components get their markup set via setMarkup(), which is why they don&apos;t need to know how to find their markup. But than I found this: &lt;/p&gt;

&lt;p&gt;MarkupContainer:&lt;br/&gt;
	void detachChildren()&lt;br/&gt;
	{&lt;br/&gt;
...&lt;br/&gt;
			// We need to keep InlineEnclosures for Ajax request handling.&lt;br/&gt;
			// TODO this is really ugly. Feature request for 1.5: change auto-component that&lt;br/&gt;
			// they don&apos;t need to be removed anymore.&lt;br/&gt;
			if (component.isAuto() &amp;amp;&amp;amp; !(component instanceof InlineEnclosure))&lt;/p&gt;
			{
				children_remove(i);
			}

&lt;p&gt;which makes me belief that the problem is limited to InlineEnclosure only. I think we have two options. Either the way it&apos;s implemented in your patch (InlineEnclosure implements getMarkup()) or InlineEnclosure gets a variable markup which is not reset. Any variation change has no effect on InlineEnclosure ajax upates anyway, since the markup will not be reloaded under any circumstances. &lt;/p&gt;

&lt;p&gt;Pseudo code: InlineEnclosure&lt;br/&gt;
  // avoid all the extra info which come with IMF implementations&lt;br/&gt;
  private String markup&lt;/p&gt;

&lt;p&gt;  IMF getMarkup()&lt;br/&gt;
  {&lt;br/&gt;
     IMF markup = super.getMarkup();&lt;/p&gt;

&lt;p&gt;     // resolver has set markup upon auto-component creation. Local markup not yet set =&amp;gt; remember&lt;br/&gt;
     if (markup != null &amp;amp;&amp;amp; this.markup == null)&lt;/p&gt;
     {
          this.markup = markup.toString()
     }
&lt;p&gt;     // markup == null because of detach, but we have our local copy =&amp;gt; use copy to set markup&lt;br/&gt;
     else if (markup == null &amp;amp;&amp;amp; this.markup != null)&lt;/p&gt;
     {
        markup = Markup.of(this.markup)
        setMarkup(markup)
     }

&lt;p&gt;     return markup&lt;br/&gt;
}&lt;/p&gt;</comment>
                            <comment id="13072323" author="mgrigorov" created="Thu, 28 Jul 2011 12:50:14 +0000"  >&lt;p&gt;Here is the final patch. All tests and the variation quickstart work.&lt;br/&gt;
I&apos;ll modify the quickstart to a unit test. &lt;/p&gt;</comment>
                            <comment id="13072332" author="mgrigorov" created="Thu, 28 Jul 2011 13:14:35 +0000"  >&lt;p&gt;Submitted the fix with r1151831.&lt;br/&gt;
Re-worked a bit the previous version because MarkupFragment is not serializable.&lt;br/&gt;
Please review and comment if there is something wrong.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12513851">WICKET-3891</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12488091" name="WICKET-3931.patch" size="3866" author="mgrigorov" created="Thu, 28 Jul 2011 12:50:14 +0000"/>
                            <attachment id="12487961" name="WICKET-3931.patch" size="3202" author="mgrigorov" created="Wed, 27 Jul 2011 11:06:24 +0000"/>
                            <attachment id="12487692" name="variation.tgz" size="21015" author="mgrigorov" created="Mon, 25 Jul 2011 11:19:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>66727</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 17 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0k9on:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>116386</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>