<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:20:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-4358] BufferedWebResponse fails to add/clear cookie in redirect</title>
                <link>https://issues.apache.org/jira/browse/WICKET-4358</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;bufferedWebResponse.addCookie( cookie );&lt;/p&gt;

&lt;p&gt;That fails under certain conditions: (1) when called on the last of three 302 redirects during OpenID login; and (2) on single redirect immediately after container startup, though it later recovers.  Failure confirmed in Firebug; no cookies sent in any of the response headers.  My workaround is to bypass the buffered response.  This works:&lt;/p&gt;

&lt;p&gt;((HttpServletResponse)bufferedWebResponse.getContainerResponse()).addCookie( cookie );&lt;/p&gt;</description>
                <environment>Firefox 9</environment>
        <key id="12539719">WICKET-4358</key>
            <summary>BufferedWebResponse fails to add/clear cookie in redirect</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgrigorov">Martin Tzvetanov Grigorov</assignee>
                                    <reporter username="mcallan">Michael Allan</reporter>
                        <labels>
                            <label>cookie</label>
                            <label>redirect</label>
                    </labels>
                <created>Wed, 25 Jan 2012 07:00:15 +0000</created>
                <updated>Sat, 30 Jun 2012 12:01:01 +0000</updated>
                            <resolved>Thu, 28 Jun 2012 09:40:51 +0000</resolved>
                                    <version>1.5.4</version>
                                    <fixVersion>1.5.8</fixVersion>
                    <fixVersion>6.0.0-beta3</fixVersion>
                                    <component>wicket</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13192908" author="mgrigorov" created="Wed, 25 Jan 2012 07:16:35 +0000"  >&lt;p&gt;How do you make the redirect ?&lt;br/&gt;
Can you provide a quickstart application please.&lt;/p&gt;</comment>
                            <comment id="13193549" author="mcallan" created="Thu, 26 Jan 2012 04:08:19 +0000"  >&lt;p&gt;The following is not the only failure path I encountered.  There&apos;s a simpler one involving a single redirect after a container restart.  But I haven&apos;t investigated it much because it&apos;s not a real problem for my app.  This is the path I was looking at most closely:&lt;/p&gt;

&lt;p&gt;Redirect (1) is by RequestCycle#scheduleRequestHandlerAfterCurrent.  See page WP_Login, line 768:&lt;br/&gt;
&lt;a href=&quot;http://zelea.com/var/db/repo/votorola-wic-1.5/file/1618244d61ee/votorola/a/web/wic/authen/WP_Login.java#l768&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://zelea.com/var/db/repo/votorola-wic-1.5/file/1618244d61ee/votorola/a/web/wic/authen/WP_Login.java#l768&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Redirect (2) is by the OpenID provider.  In my test case, the provider is &lt;a href=&quot;https://pip.verisignlabs.com/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://pip.verisignlabs.com/&lt;/a&gt;.  Their server redirects the client to page WP_OpenIDReturn, which then retrieves the previous instance of WP_Login from the session and calls into it from line 170: &lt;a href=&quot;http://zelea.com/var/db/repo/votorola-wic-1.5/file/1618244d61ee/votorola/a/web/wic/authen/WP_OpenIDReturn.java#l170&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://zelea.com/var/db/repo/votorola-wic-1.5/file/1618244d61ee/votorola/a/web/wic/authen/WP_OpenIDReturn.java#l170&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Redirect (3) is by RequestCycle#setResponsePage(Class,PageParameters).  See page WP_Login, line 124: &lt;a href=&quot;http://zelea.com/var/db/repo/votorola-wic-1.5/file/1618244d61ee/votorola/a/web/wic/authen/WP_Login.java#l124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://zelea.com/var/db/repo/votorola-wic-1.5/file/1618244d61ee/votorola/a/web/wic/authen/WP_Login.java#l124&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The cookies are set immediately after, beginning at line 156: &lt;a href=&quot;http://zelea.com/var/db/repo/votorola-wic-1.5/file/1618244d61ee/votorola/a/web/wic/authen/WP_Login.java#l156&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://zelea.com/var/db/repo/votorola-wic-1.5/file/1618244d61ee/votorola/a/web/wic/authen/WP_Login.java#l156&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The cookie setting code is here.  Without the workaround described here, it fails:&lt;br/&gt;
&lt;a href=&quot;http://zelea.com/var/db/repo/votorola-wic-1.5/file/1618244d61ee/votorola/g/web/wic/WebResponseX.java#l23&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://zelea.com/var/db/repo/votorola-wic-1.5/file/1618244d61ee/votorola/g/web/wic/WebResponseX.java#l23&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I hope this is enough to trace the fault.  If you still need a quickstart, I&apos;ll try to find time to install Maven and create one.&lt;/p&gt;</comment>
                            <comment id="13194710" author="mgrigorov" created="Fri, 27 Jan 2012 13:44:32 +0000"  >&lt;p&gt;I don&apos;t have time to debug your code by just reading it ... :-/&lt;br/&gt;
I suspect that you use some version of ResetResponseException (like RestartResponseException) that resets the WebResponse and clears the cookies.&lt;br/&gt;
Add a breakpoint at org.apache.wicket.protocol.http.BufferedWebResponse#reset() and see what happens.&lt;/p&gt;</comment>
                            <comment id="13196891" author="mcallan" created="Tue, 31 Jan 2012 13:04:10 +0000"  >&lt;p&gt;I don&apos;t think so, but that breakpoint IS triggered twice.  Firebug says the first break holds up the response to the initial request (form POST), but I guess that one is uninteresting.  The second break holds up the response to the third request (a GET) which is the one in which the cookies are supposed to be set.  The cookies are not set.  The break occurs after the response page is fully constructed.  The constructor runs to completion and throws no exceptions.  Here&apos;s the stack trace at the breakpoint:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; org.apache.wicket.protocol.http.BufferedWebResponse.reset (BufferedWebResponse.java:412)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; org.apache.wicket.protocol.http.HeaderBufferingWebResponse.flush(HeaderBufferingWebResponse.java:90)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; org.apache.wicket.protocol.http.WicketFilter.processRequest (WicketFilter.java:172)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt; org.apache.wicket.protocol.http.WicketFilter.doFilter (WicketFilter.java:218)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;5&amp;#93;&lt;/span&gt; org.apache.catalina.core.ApplicationFilterChain.internalDoFilter (null)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;6&amp;#93;&lt;/span&gt; org.apache.catalina.core.ApplicationFilterChain.doFilter (null)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;7&amp;#93;&lt;/span&gt; org.apache.catalina.core.StandardWrapperValve.invoke (null)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;8&amp;#93;&lt;/span&gt; org.apache.catalina.core.StandardContextValve.invoke (null)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;9&amp;#93;&lt;/span&gt; org.apache.catalina.valves.RequestFilterValve.process (null)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;10&amp;#93;&lt;/span&gt; org.apache.catalina.valves.RemoteAddrValve.invoke (null)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;11&amp;#93;&lt;/span&gt; org.apache.catalina.core.StandardHostValve.invoke (null)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;12&amp;#93;&lt;/span&gt; org.apache.catalina.valves.ErrorReportValve.invoke (null)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;13&amp;#93;&lt;/span&gt; org.apache.catalina.core.StandardEngineValve.invoke (null)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;14&amp;#93;&lt;/span&gt; org.apache.catalina.connector.CoyoteAdapter.service (null)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;15&amp;#93;&lt;/span&gt; org.apache.coyote.http11.Http11Processor.process (null)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;16&amp;#93;&lt;/span&gt; org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process (null)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;17&amp;#93;&lt;/span&gt; org.apache.tomcat.util.net.JIoEndpoint$Worker.run (null)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;18&amp;#93;&lt;/span&gt; java.lang.Thread.run (Thread.java:722)&lt;/p&gt;

&lt;p&gt;But the breakpoint is NOT triggered and the cookies ARE set if I remove the call to RequestCycle.setResponsePage() by commenting out line 124: &lt;a href=&quot;http://zelea.com/var/db/repo/votorola-wic-1.5/file/1618244d61ee/votorola/a/web/wic/authen/WP_Login.java#l124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://zelea.com/var/db/repo/votorola-wic-1.5/file/1618244d61ee/votorola/a/web/wic/authen/WP_Login.java#l124&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Hope this helps.  If it&apos;s not enough, then I&apos;ll try to find time to create a quickstart.&lt;/p&gt;</comment>
                            <comment id="13196901" author="mgrigorov" created="Tue, 31 Jan 2012 13:23:58 +0000"  >&lt;p&gt;The response is flushed for every response... I.e. this stack is normal.&lt;br/&gt;
There must be another one that resets the response and starts writing new headers and content in it.&lt;/p&gt;

&lt;p&gt;Please attach a quickstart.&lt;/p&gt;</comment>
                            <comment id="13198308" author="mcallan" created="Wed, 1 Feb 2012 23:25:06 +0000"  >&lt;p&gt;Quickstart attached.  Tested with JDK 1.6 and 1.7, Firefox 9.  Instructions:&lt;/p&gt;

&lt;p&gt;(1) Build and run the quickstart.&lt;/p&gt;

&lt;p&gt;(2) Load the home page: &lt;a href=&quot;http://localhost:8080/wicket-bug-4358/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/wicket-bug-4358/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(3) Click on the login link at top left.&lt;/p&gt;

&lt;p&gt;(4) Login with your OpenID.  After 3 redirects you land back on the home page.  Verify that the&lt;br/&gt;
following localhost cookies ARE set on the third redirect: vo_loginPersistKey,&lt;br/&gt;
vo_loginPersistUserEmail.&lt;/p&gt;

&lt;p&gt;(5) Open votorola.g.web.wic.WebResponseX in your editor.&lt;/p&gt;

&lt;p&gt;(6) Edit addCookie().  Comment out the workaround (B) and uncomment the call to BufferedWebResponse (A).&lt;/p&gt;

&lt;p&gt;(7) Clear the two cookies from your browser.&lt;/p&gt;

&lt;p&gt;(8) Rebuild and retest (1-4).  This time the cookies are NOT set.&lt;/p&gt;</comment>
                            <comment id="13204580" author="mgrigorov" created="Thu, 9 Feb 2012 15:13:05 +0000"  >&lt;p&gt;Sorry, your quickstart is too complicated and takes me too much time to analyze what you are doing.&lt;br/&gt;
If you can reproduce it with less code (Wicket quickstart + what is needed to reproduce) then I&apos;ll take a look again. Otherwise I&apos;ll leave it to someone else to debug this application. &lt;/p&gt;</comment>
                            <comment id="13204751" author="mcallan" created="Thu, 9 Feb 2012 19:18:25 +0000"  >&lt;p&gt;Unfortunately OpenID login is complicated by lots of redirects and that kind of complexity appears to be essential to the bug.  The response to the third and final 302 redirect (which you can see in Firebug) is supposed to have two cookies.  They are added on lines 129 and 133 of votorola.a.web.wic.authen.WP_Login.  The redirect itself is invoked on line 102.&lt;/p&gt;

&lt;p&gt;Are you able to confirm that it works with the workaround and fails without it?  If so, then it should be easy for whoever you assign to trace the fault in BufferedWebResponse.  HttpServletResponse handles the cookies OK, but BufferedWebResponse is dropping them.&lt;/p&gt;

&lt;p&gt;A possible clue: when the cookies are passed to BufferedWebResponse there is a mysterious EXTRA call to BufferedWebResponse.reset().  See my reply of Jan 31.  This call does NOT occur when the workaround is in place, i.e. when the cookies are passed directly to HttpServletResponse.  Maybe it&apos;s normal for the buffer to be flushed if cookies are added and not otherwise, but I think the problem is that it&apos;s being flushed before the cookies are successfully handed to HttpServletResponse.  Else where did the cookies go?&lt;/p&gt;</comment>
                            <comment id="13292191" author="berniegp" created="Sat, 9 Jun 2012 04:42:09 +0000"  >&lt;p&gt;I stumbled upon what I think is the same bug and built a very simple quickstart reproducing the issue with Wicket 1.5.7.&lt;/p&gt;

&lt;p&gt;Steps to reproduce:&lt;br/&gt;
1-Browse to localhost:8080&lt;br/&gt;
2-The label should read &quot;Cookie is NOT set&quot;; if not, click on &quot;clear cookie&quot;&lt;br/&gt;
3-Click on &quot;Set cookie via link handler&quot;&lt;br/&gt;
4-Click on &quot;Set cookie&quot;&lt;br/&gt;
5-The label should now read &quot;Cookie is set&quot;&lt;br/&gt;
6-Click on &quot;clear cookie&quot;&lt;br/&gt;
7-Clich on &quot;Set cookie via bookmarkable link (no prompt)&quot;&lt;br/&gt;
8-The label should read &quot;Cookie is NOT set&quot;&lt;/p&gt;

&lt;p&gt;Both &quot;cookie-setting&quot; pages use the same code:&lt;br/&gt;
		HomePage.setCookie(HomePage.COOKIE_KEY, &quot;setResponsePage&quot;);&lt;br/&gt;
		setResponsePage(HomePage.class);&lt;/p&gt;

&lt;p&gt;However, only the first page works. The case that works is when setResponsePage is called from within a ListenerInterfaceRequestHandler. The case that doesn&apos;t is when setResponsePage is called from within a RenderPageRequestHandler.&lt;/p&gt;

&lt;p&gt;The problem seems to be around BufferedWebResponse#renderPage(Url targetUrl, RequestCycle requestCycle) line 107. &lt;/p&gt;</comment>
                            <comment id="13292192" author="berniegp" created="Sat, 9 Jun 2012 04:42:40 +0000"  >&lt;p&gt;Quickstart&lt;/p&gt;</comment>
                            <comment id="13402949" author="mgrigorov" created="Thu, 28 Jun 2012 09:14:18 +0000"  >&lt;p&gt;Here is a possible patch.&lt;/p&gt;</comment>
                            <comment id="13402957" author="mgrigorov" created="Thu, 28 Jun 2012 09:40:51 +0000"  >&lt;p&gt;Fix for the Bertrand&apos;s quickstart is applied.&lt;br/&gt;
Michael Allan&apos;s code is too hard to follow and debug. &lt;br/&gt;
@Michael: please verify that the fix solves your problem.&lt;/p&gt;</comment>
                            <comment id="13404025" author="berniegp" created="Fri, 29 Jun 2012 17:04:30 +0000"  >&lt;p&gt;I confirm that it works with the patch&lt;/p&gt;</comment>
                            <comment id="13404474" author="mcallan" created="Sat, 30 Jun 2012 12:01:01 +0000"  >&lt;p&gt;Believe it or not, I can no longer duplicate the fault unless I apply the patch.  I can no longer duplicate it in my original quickstart (same jars, same Tomcat), nor in my current code.  But if I apply the patch, then it reappears in my current code (but not in the quickstart).  This is so strange, that I actually opened up the jars to double check.  With my current Wicket (1.5.4) or with a newly rebuilt 1.5.4 from your repo (class files identical) it&apos;s OK.  With a patched 1.5.4 (class file different), it reverts to the original behaviour.  The original workaround continues to work in this case.&lt;/p&gt;

&lt;p&gt;Please don&apos;t spend more time on this.  If I&apos;m the only one affected, then the workaround will suffice for me.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12533792" name="WICKET-4358.patch" size="2262" author="mgrigorov" created="Thu, 28 Jun 2012 09:14:17 +0000"/>
                            <attachment id="12531502" name="wicket-4358.zip" size="28395" author="berniegp" created="Sat, 9 Jun 2012 04:42:40 +0000"/>
                            <attachment id="12512866" name="wicket-bug-4358.tar.bz2" size="38887" author="mcallan" created="Wed, 1 Feb 2012 23:25:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>225222</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0k8tb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>116245</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>