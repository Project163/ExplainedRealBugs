<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:22:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-5424] Page.isPageStateless() returning true in regular run but false in WicketTester</title>
                <link>https://issues.apache.org/jira/browse/WICKET-5424</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;Motivation:&lt;br/&gt;
Healthcheck/heartbeat pages must always be stateless to prevent significant amounts of session creation and storage.&lt;br/&gt;
Also each anonymously accessed page in a public site should be stateless due to the same reason (otherwise the site could easily be DoSsed down).&lt;br/&gt;
It would be nice to verify these requirements by tests.&lt;/p&gt;

&lt;p&gt;If I create an ought-to-be-stateless page with an AjaxLink which is hidden by a behavior:&lt;/p&gt;

&lt;p&gt;public class MyPage extends WebPage {&lt;br/&gt;
    public MyPage() {&lt;br/&gt;
        add(new AjaxLink&amp;lt;Void&amp;gt;(&quot;link&quot;) {&lt;br/&gt;
            @Override&lt;br/&gt;
            public void onClick(AjaxRequestTarget target) &lt;/p&gt;
{
                //
            }
&lt;p&gt;        }.add(new Behavior() {&lt;br/&gt;
            @Override&lt;br/&gt;
            public void onConfigure(Component c) &lt;/p&gt;
{
                c.setVisible(false);
            }
&lt;p&gt;        }));&lt;br/&gt;
        add(new Label(&quot;isPageStateless&quot;, new AbstractReadOnlyModel&amp;lt;Boolean&amp;gt;() {&lt;br/&gt;
            @Override&lt;br/&gt;
            public Boolean getObject() &lt;/p&gt;
{
                return MyPage.this.isPageStateless();
            }
&lt;p&gt;        }));&lt;br/&gt;
    }&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;then checking through a web server the page correctly prints &quot;true&quot;, and no HttpSessions are created.&lt;/p&gt;

&lt;p&gt;However, when I try to verify statelessness through WicketTester, the following test passes:&lt;/p&gt;

&lt;p&gt;@Test&lt;br/&gt;
public void testName() throws Exception {&lt;br/&gt;
    WicketTester tester = new WicketTester(new WebApplication() {&lt;br/&gt;
        @Override&lt;br/&gt;
        public Class&amp;lt;? extends Page&amp;gt; getHomePage() &lt;/p&gt;
{
            return MyPage.class;
        }
&lt;p&gt;    });&lt;br/&gt;
    tester.startPage(MyPage.class);&lt;br/&gt;
    tester.assertLabel(&quot;isPageStateless&quot;, &quot;false&quot;);&lt;br/&gt;
    assertFalse(tester.getLastRenderedPage().isPageStateless());&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;It seems that somehow due to WicketTester, isPageStateless() is being invoked before any behaviors are run (and thus the AjaxLink is still visible), and since stateless-flag for the page is cached, it remains false.&lt;/p&gt;

&lt;p&gt;If it&apos;s by design that isPageStateless should always return the same result during each request, then I guess that the statelessness resolution process must not depend on anything happening after the page constructor? I assume it&apos;s not by design.&lt;/p&gt;

&lt;p&gt;Suggestions:&lt;/p&gt;

&lt;p&gt;A) Obvious fix would be to remove stateless-flag caching, since apparently it is causing problems, as also suggested by a hackish comment in Page.init(). In general, caching should always be used sparingly.&lt;/p&gt;

&lt;p&gt;B) Or maybe whoever is invoking isPageStateless() at an early stage should actually be using Page.peekPageStateless()? But this doesn&apos;t really seem like a real fix, more like a temporary hack.&lt;/p&gt;

&lt;p&gt;C) All caching could also be disabled during test runs, but this would not be a good thing since tests should reproduce the actual behavior as closely as possible.&lt;/p&gt;

&lt;p&gt;D) In case this is a known issue without a proper fix, how then could I verify page statelessness through WicketTester? Currently I&apos;m clearing the stateless-cache by reflection, which feels kind of bad...&lt;/p&gt;</description>
                <environment></environment>
        <key id="12680977">WICKET-5424</key>
            <summary>Page.isPageStateless() returning true in regular run but false in WicketTester</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="svenmeier">Sven Meier</assignee>
                                    <reporter username="jyrimatti">Jyri-Matti L&#228;hteenm&#228;ki</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Nov 2013 07:22:02 +0000</created>
                <updated>Tue, 26 Nov 2013 20:23:09 +0000</updated>
                            <resolved>Tue, 26 Nov 2013 18:08:48 +0000</resolved>
                                    <version>6.8.0</version>
                    <version>6.12.0</version>
                                    <fixVersion>6.13.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13831230" author="mgrigorov" created="Mon, 25 Nov 2013 07:39:15 +0000"  >&lt;p&gt;Could you please attach a failing test case ?&lt;br/&gt;
Thank you! &lt;/p&gt;</comment>
                            <comment id="13831373" author="jyrimatti" created="Mon, 25 Nov 2013 11:25:16 +0000"  >&lt;p&gt;Added test case.&lt;br/&gt;
Seems that this has something to do with RenderStrategy.ONE_PASS_RENDER&lt;/p&gt;</comment>
                            <comment id="13831518" author="mgrigorov" created="Mon, 25 Nov 2013 15:00:41 +0000"  >&lt;p&gt;The test case is not failing.&lt;br/&gt;
Let me see deeper.&lt;/p&gt;</comment>
                            <comment id="13831533" author="jyrimatti" created="Mon, 25 Nov 2013 15:16:27 +0000"  >&lt;p&gt;I organized the test so that the two tests pass meaning that the page is considered stateful. Should have made two failing tests, sorry, I&apos;ll learn &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Anyway, the test now asserts that isPageStateless returns &lt;em&gt;false&lt;/em&gt;, but if you start jetty and load the frontpage it displays &lt;em&gt;true&lt;/em&gt;. So the behaviors in the test and actual run differ.&lt;/p&gt;</comment>
                            <comment id="13831551" author="mgrigorov" created="Mon, 25 Nov 2013 15:34:32 +0000"  >&lt;p&gt;The quickstart has no Start.java so I cannot run it normally (i.e. w/o WicketTester). I already deleted maven jetty plugin - it was using 6.1.22... I didn&apos;t want to download something that old. Sorry &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Next time use &lt;a href=&quot;http://wicket.apache.org/start/quickstart.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://wicket.apache.org/start/quickstart.html&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;But I think it should behave the same way - #isPageStateless() is called early in org.apache.wicket.request.handler.render.WebPageRenderer#respond().&lt;br/&gt;
Behavior#onConfigure() is called once the page rendering process starts. So it is late to hide the stateful component and make the page stateless again.&lt;/p&gt;

&lt;p&gt;The problem is deeper.&lt;br/&gt;
org.apache.wicket.Page#stateless is transient but the page is deserialized only if it is loaded from the disk. Before loading from disk Wicket checks for the level 1 cache - the http session keeps the last used page. So if the page is loaded from http session the &apos;stateless&apos; cache is still there and even if you remove/replace the solely stateful component with a stateless one the page will still be assumed as stateful due to the cached.&lt;br/&gt;
This can be improved by null-ifying the cache in #detach().&lt;/p&gt;

&lt;p&gt;I am not sure that removing the cache will be a good thing. This may make the page processing considerably slower.&lt;br/&gt;
Maybe we can introduce protected non-final #getStatelessCache() that returns org.apache.wicket.Page#stateless. If page like yours needs to disable the cache then you can override this method and return null always.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=svenmeier&quot; class=&quot;user-hover&quot; rel=&quot;svenmeier&quot;&gt;svenmeier&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ivaynberg&quot; class=&quot;user-hover&quot; rel=&quot;ivaynberg&quot;&gt;ivaynberg&lt;/a&gt; WDYT about this problem ?&lt;/p&gt;</comment>
                            <comment id="13831889" author="svenmeier" created="Mon, 25 Nov 2013 20:43:46 +0000"  >&lt;p&gt;I&apos;ll take a look at it tomorrow.&lt;/p&gt;</comment>
                            <comment id="13831949" author="svenmeier" created="Mon, 25 Nov 2013 21:49:26 +0000"  >&lt;p&gt;Actually there are two different problems:&lt;/p&gt;

&lt;p&gt;1) BaseWicketTester uses a special PageRenderer that records the last rendered page. The current implementation pulls the page out of the pageProvider &lt;b&gt;before&lt;/b&gt; actual rendering.&lt;br/&gt;
This results in the observed difference between test and non-test (only with ONE_PASS_RENDER though).&lt;/p&gt;

&lt;p&gt;IMHO we should fix this with the attached patch and close this ticket.&lt;/p&gt;

&lt;p&gt;2) Then reconsider the separate issue of changing statelessness in #onConfigure().&lt;/p&gt;</comment>
                            <comment id="13832478" author="mgrigorov" created="Tue, 26 Nov 2013 10:30:02 +0000"  >&lt;p&gt;Good catch!&lt;br/&gt;
The patch looks good to me.&lt;/p&gt;</comment>
                            <comment id="13832522" author="svenmeier" created="Tue, 26 Nov 2013 11:53:06 +0000"  >&lt;p&gt;BaseWicketTester now takes care not to interfere with the wrapped PageRenderer. With the configured render strategy ONE_PASS_RENDER the page is reported as stateless in the testcase and when rendered in the browser.&lt;/p&gt;</comment>
                            <comment id="13832611" author="mgrigorov" created="Tue, 26 Nov 2013 14:15:44 +0000"  >&lt;p&gt;The issue is still existing in master branch - &lt;a href=&quot;http://ci.apache.org/builders/wicket-master/builds/1522/steps/compile/logs/stdio&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ci.apache.org/builders/wicket-master/builds/1522/steps/compile/logs/stdio&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ve used the attached quickstart as a test case.&lt;/p&gt;</comment>
                            <comment id="13832816" author="svenmeier" created="Tue, 26 Nov 2013 18:08:48 +0000"  >&lt;p&gt;The difference between test and in-browser run is present in 6.x only, this issue is now fixed with 6.13.0.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-5426&quot; title=&quot;Page not recognized as stateless although stateful component is hidden in #onConfigure()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-5426&quot;&gt;&lt;del&gt;WICKET-5426&lt;/del&gt;&lt;/a&gt; will track improvements on statelessness handling when stateful components are hidden in the render phase.&lt;/p&gt;</comment>
                            <comment id="13832821" author="svenmeier" created="Tue, 26 Nov 2013 18:10:17 +0000"  >&lt;p&gt;Thanks Martin, I&apos;ll use WicketTesterLazyIsPageStatelessBase and subclasses in &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-5426&quot; title=&quot;Page not recognized as stateless although stateful component is hidden in #onConfigure()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-5426&quot;&gt;&lt;del&gt;WICKET-5426&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13833006" author="jyrimatti" created="Tue, 26 Nov 2013 20:23:09 +0000"  >&lt;p&gt;Thanks a lot, you are quick =)&lt;/p&gt;

&lt;p&gt;...but I&apos;m a bit worried of two things:&lt;/p&gt;

&lt;p&gt;1) Caching should be used with great caution, unless it&apos;s clear that the result will never change. If this approach is used widely in Wicket, it might be causing bugs which are really hard to catch. At least it&apos;s making Wicket more fragile. Are you sure removing the cache would cause a noticeable hit? It looks like the method is just invoking isVisible/EnabledInHierarchy for the whole component tree a couple of times. Since the implementation is &quot;going down&quot; with a visitor and on each component coming back up with the &quot;hierarchy&quot;, it&apos;s doing the same stuff multiple times, so maybe the whole check could be performed in one method so that the visibility of each component is checked only once? Would it still be too slow?&lt;/p&gt;

&lt;p&gt;2) I probably don&apos;t understand much about statelessness in Wicket, but doesn&apos;t it feel odd that statelessness can change during a request? How about turning the process &quot;upside down&quot;: instead of checking for statelessness, make each component determine its statelessness just before rendering. Thus this flag wouldn&apos;t even be available before the render phase and it could not change once it&apos;s determined (there&apos;s no point in changing it during rendering or afterwards, right?).&lt;/p&gt;

&lt;p&gt;I&apos;m kind of waving my hands in the air here, so feel free to ignore my suggestions =)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12681249">WICKET-5426</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12615678" name="WICKET-5424-tester.patch" size="1613" author="svenmeier" created="Mon, 25 Nov 2013 21:49:26 +0000"/>
                            <attachment id="12615578" name="wicket-bug-test.zip" size="4657" author="jyrimatti" created="Mon, 25 Nov 2013 11:25:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>360242</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 51 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1q3n3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>360541</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>