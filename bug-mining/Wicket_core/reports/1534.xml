<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:26:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-6848] Session invalidation fails because response is already committed</title>
                <link>https://issues.apache.org/jira/browse/WICKET-6848</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;Since Wicket 9.1.0, we are seeing the stacktrace below. It is very likely related to the changes made with &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6831&quot; title=&quot;Flush the response before detach&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6831&quot;&gt;&lt;del&gt;WICKET-6831&lt;/del&gt;&lt;/a&gt;. We are currently checking if this has been fixed by the latest changes on master, but I believe this is a different issue.&lt;/p&gt;

&lt;p&gt;From the stacktrace I deduce that the session is invalidated as part of detach, but as detach is now called after flush, it is no longer possible to invalidate the HttpSession at this point (you cannot clear the JSESSIONID cookie).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
17:22:11,823 ERROR [io.undertow.request] (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; task-9) UT005023: Exception handling request to /idp/: java.lang.IllegalStateException: WFLYCLWEBUT0009: Invalidation attempted &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; session JtkqV0MvzZq-RzFBSs-K6n2CcJN72IDooNHsTBm8 after the response was committed (e.g. after HttpServletResponse.sendRedirect or sendError)
	at org.wildfly.clustering.web.undertow@20.0.1.Final&lt;span class=&quot;code-comment&quot;&gt;//org.wildfly.clustering.web.undertow.session.DistributableSession.validateBatch(DistributableSession.java:292)
&lt;/span&gt;	at org.wildfly.clustering.web.undertow@20.0.1.Final&lt;span class=&quot;code-comment&quot;&gt;//org.wildfly.clustering.web.undertow.session.DistributableSession.invalidate(DistributableSession.java:225)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.spec.HttpSessionImpl.invalidate(HttpSessionImpl.java:198)
&lt;/span&gt;	at deployment.parnassys-portal-authenticator.war&lt;span class=&quot;code-comment&quot;&gt;//org.apache.wicket.session.HttpSessionStore.invalidate(HttpSessionStore.java:165)
&lt;/span&gt;	at deployment.parnassys-portal-authenticator.war&lt;span class=&quot;code-comment&quot;&gt;//org.apache.wicket.Session.destroy(Session.java:508)
&lt;/span&gt;	at deployment.parnassys-portal-authenticator.war&lt;span class=&quot;code-comment&quot;&gt;//org.apache.wicket.Session.invalidateNow(Session.java:529)
&lt;/span&gt;	at deployment.parnassys-portal-authenticator.war&lt;span class=&quot;code-comment&quot;&gt;//org.apache.wicket.Session.detach(Session.java:684)
&lt;/span&gt;	at deployment.parnassys-portal-authenticator.war&lt;span class=&quot;code-comment&quot;&gt;//org.apache.wicket.request.cycle.RequestCycle.onDetach(RequestCycle.java:674)
&lt;/span&gt;	at deployment.parnassys-portal-authenticator.war&lt;span class=&quot;code-comment&quot;&gt;//org.apache.wicket.request.cycle.RequestCycle.detach(RequestCycle.java:614)
&lt;/span&gt;	at deployment.parnassys-portal-authenticator.war&lt;span class=&quot;code-comment&quot;&gt;//org.apache.wicket.protocol.http.WicketFilter.processRequestCycle(WicketFilter.java:284)
&lt;/span&gt;	at deployment.parnassys-portal-authenticator.war&lt;span class=&quot;code-comment&quot;&gt;//org.apache.wicket.protocol.http.WicketFilter.processRequest(WicketFilter.java:207)
&lt;/span&gt;	at deployment.parnassys-portal-authenticator.war&lt;span class=&quot;code-comment&quot;&gt;//org.apache.wicket.protocol.http.WicketFilter.doFilter(WicketFilter.java:306)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:61)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:131)
&lt;/span&gt;	at deployment.parnassys-portal-authenticator.war&lt;span class=&quot;code-comment&quot;&gt;//nl.topicus.cobra.filter.ClickjackFilter.doFilter(ClickjackFilter.java:29)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:61)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:131)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.FilterHandler.handleRequest(FilterHandler.java:84)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.security.ServletSecurityRoleHandler.handleRequest(ServletSecurityRoleHandler.java:62)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.ServletChain$1.handleRequest(ServletChain.java:68)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.ServletDispatchingHandler.handleRequest(ServletDispatchingHandler.java:36)
&lt;/span&gt;	at org.wildfly.extension.undertow@20.0.1.Final&lt;span class=&quot;code-comment&quot;&gt;//org.wildfly.extension.undertow.security.SecurityContextAssociationHandler.handleRequest(SecurityContextAssociationHandler.java:78)
&lt;/span&gt;	at io.undertow.core@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:43)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.RedirectDirHandler.handleRequest(RedirectDirHandler.java:68)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.security.SSLInformationAssociationHandler.handleRequest(SSLInformationAssociationHandler.java:132)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.security.ServletAuthenticationCallHandler.handleRequest(ServletAuthenticationCallHandler.java:57)
&lt;/span&gt;	at io.undertow.core@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:43)
&lt;/span&gt;	at io.undertow.core@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.security.handlers.AbstractConfidentialityHandler.handleRequest(AbstractConfidentialityHandler.java:46)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.security.ServletConfidentialityConstraintHandler.handleRequest(ServletConfidentialityConstraintHandler.java:64)
&lt;/span&gt;	at io.undertow.core@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.security.handlers.AuthenticationMechanismsHandler.handleRequest(AuthenticationMechanismsHandler.java:60)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.security.CachedAuthenticatedSessionHandler.handleRequest(CachedAuthenticatedSessionHandler.java:77)
&lt;/span&gt;	at io.undertow.core@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.security.handlers.NotificationReceiverHandler.handleRequest(NotificationReceiverHandler.java:50)
&lt;/span&gt;	at io.undertow.core@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.security.handlers.AbstractSecurityContextAssociationHandler.handleRequest(AbstractSecurityContextAssociationHandler.java:43)
&lt;/span&gt;	at io.undertow.core@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:43)
&lt;/span&gt;	at org.wildfly.extension.undertow@20.0.1.Final&lt;span class=&quot;code-comment&quot;&gt;//org.wildfly.extension.undertow.security.jacc.JACCContextIdHandler.handleRequest(JACCContextIdHandler.java:61)
&lt;/span&gt;	at io.undertow.core@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:43)
&lt;/span&gt;	at org.wildfly.extension.undertow@20.0.1.Final&lt;span class=&quot;code-comment&quot;&gt;//org.wildfly.extension.undertow.deployment.GlobalRequestControllerHandler.handleRequest(GlobalRequestControllerHandler.java:68)
&lt;/span&gt;	at io.undertow.core@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:43)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.ServletInitialHandler.jrHandle(ServletInitialHandler.java:40001)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//org.zeroturnaround.javarebel.integration.servlet.undertow.cbp.ServletInitialHandlerCBP.handleRequest(ServletInitialHandlerCBP.java:138)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.ServletInitialHandler.handleFirstRequest(ServletInitialHandler.java:269)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.ServletInitialHandler.access$100(ServletInitialHandler.java:78)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.ServletInitialHandler$2.call(ServletInitialHandler.java:133)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.ServletInitialHandler$2.call(ServletInitialHandler.java:130)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.core.ServletRequestContextThreadSetupAction$1.call(ServletRequestContextThreadSetupAction.java:48)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.core.ContextClassLoaderSetupAction$1.call(ContextClassLoaderSetupAction.java:43)
&lt;/span&gt;	at org.wildfly.extension.undertow@20.0.1.Final&lt;span class=&quot;code-comment&quot;&gt;//org.wildfly.extension.undertow.security.SecurityContextThreadSetupAction.lambda$create$0(SecurityContextThreadSetupAction.java:105)
&lt;/span&gt;	at org.wildfly.extension.undertow@20.0.1.Final&lt;span class=&quot;code-comment&quot;&gt;//org.wildfly.extension.undertow.deployment.UndertowDeploymentInfoService$UndertowThreadSetupAction.lambda$create$0(UndertowDeploymentInfoService.java:1530)
&lt;/span&gt;	at org.wildfly.extension.undertow@20.0.1.Final&lt;span class=&quot;code-comment&quot;&gt;//org.wildfly.extension.undertow.deployment.UndertowDeploymentInfoService$UndertowThreadSetupAction.lambda$create$0(UndertowDeploymentInfoService.java:1530)
&lt;/span&gt;	at org.wildfly.extension.undertow@20.0.1.Final&lt;span class=&quot;code-comment&quot;&gt;//org.wildfly.extension.undertow.deployment.UndertowDeploymentInfoService$UndertowThreadSetupAction.lambda$create$0(UndertowDeploymentInfoService.java:1530)
&lt;/span&gt;	at org.wildfly.extension.undertow@20.0.1.Final&lt;span class=&quot;code-comment&quot;&gt;//org.wildfly.extension.undertow.deployment.UndertowDeploymentInfoService$UndertowThreadSetupAction.lambda$create$0(UndertowDeploymentInfoService.java:1530)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.ServletInitialHandler.dispatchRequest(ServletInitialHandler.java:249)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.ServletInitialHandler.access$000(ServletInitialHandler.java:78)
&lt;/span&gt;	at io.undertow.servlet@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.servlet.handlers.ServletInitialHandler$1.handleRequest(ServletInitialHandler.java:99)
&lt;/span&gt;	at io.undertow.core@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.server.Connectors.executeRootHandler(Connectors.java:370)
&lt;/span&gt;	at io.undertow.core@2.1.3.Final&lt;span class=&quot;code-comment&quot;&gt;//io.undertow.server.HttpServerExchange$1.run(HttpServerExchange.java:830)
&lt;/span&gt;	at org.jboss.threads@2.3.3.Final&lt;span class=&quot;code-comment&quot;&gt;//org.jboss.threads.ContextClassLoaderSavingRunnable.run(ContextClassLoaderSavingRunnable.java:35)
&lt;/span&gt;	at org.jboss.threads@2.3.3.Final&lt;span class=&quot;code-comment&quot;&gt;//org.jboss.threads.EnhancedQueueExecutor.safeRun(EnhancedQueueExecutor.java:1982)
&lt;/span&gt;	at org.jboss.threads@2.3.3.Final&lt;span class=&quot;code-comment&quot;&gt;//org.jboss.threads.EnhancedQueueExecutor$ThreadBody.doRunTask(EnhancedQueueExecutor.java:1486)
&lt;/span&gt;	at org.jboss.threads@2.3.3.Final&lt;span class=&quot;code-comment&quot;&gt;//org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1377)
&lt;/span&gt;	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:834)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13338028">WICKET-6848</key>
            <summary>Session invalidation fails because response is already committed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="papegaaij">Emond Papegaaij</assignee>
                                    <reporter username="papegaaij">Emond Papegaaij</reporter>
                        <labels>
                    </labels>
                <created>Fri, 30 Oct 2020 08:36:08 +0000</created>
                <updated>Sat, 28 Nov 2020 04:33:48 +0000</updated>
                            <resolved>Mon, 2 Nov 2020 12:33:54 +0000</resolved>
                                    <version>9.1.0</version>
                    <version>8.10.0</version>
                                    <fixVersion>9.2.0</fixVersion>
                    <fixVersion>8.11.0</fixVersion>
                                    <component>wicket-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="17223506" author="papegaaij" created="Fri, 30 Oct 2020 09:07:20 +0000"  >&lt;p&gt;I&apos;ve managed to produce a quickstart for this problem, but the stacktrace only occurs on WildFly, not on Jetty. Also, the session needs to be distributable to trigger the error. I don&apos;t understand why a distributable session has different characteristics on this. I would expect this to fail for every session type. This bug is not fixed on master yet.&lt;/p&gt;

&lt;p&gt;For the quickstart: build the application, deploy it on wildfly, navigate to &lt;a href=&quot;http://localhost:8080/wicket6848-1.0-SNAPSHOT&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/wicket6848-1.0-SNAPSHOT&lt;/a&gt; and click on the link that says &apos;Click here!&apos;&lt;/p&gt;</comment>
                            <comment id="17223529" author="papegaaij" created="Fri, 30 Oct 2020 09:25:22 +0000"  >&lt;p&gt;I&apos;ve done some more debugging and the current behavior definitely is broken. When I remove the &apos;distributable&apos; element from the web.xml and run it against Wicket 9.0.0, I see a set-cookie header in the response of the logout request to clear the JSESSIONID cookie. With 9.1.0 and master, this set-cookie header is missing. So even though the stacktrace is not triggered, behavior has changed.&lt;/p&gt;

&lt;p&gt;What is puzzling though, is that on Jetty I do not get the set-cookie header, not even on 9.0.0. Why is Jetty not clearing the cookie on logout? Is this a bug?&lt;/p&gt;</comment>
                            <comment id="17223533" author="solomax" created="Fri, 30 Oct 2020 09:29:05 +0000"  >&lt;p&gt;I saw such stacktrace on Tomcat once&lt;br/&gt;
It happen during login (session was replaced)&lt;br/&gt;
It is not reproducible for me since then&lt;/p&gt;</comment>
                            <comment id="17223545" author="papegaaij" created="Fri, 30 Oct 2020 09:57:07 +0000"  >&lt;p&gt;The attached patch fixes the issue by not flushing before detach when the session is marked for invalidation. It fixes the issue, but I do not like this special case. However, I do not see a way to fix the issue any other way.&lt;/p&gt;</comment>
                            <comment id="17223601" author="reiern70" created="Fri, 30 Oct 2020 12:02:14 +0000"  >&lt;p&gt;Hi Emond,&lt;/p&gt;

&lt;p&gt;+			if (reqProcessed &amp;amp;&amp;amp; !Session.isSessionInvalidated(requestCycle))&lt;br/&gt;
 			{&lt;/p&gt;

&lt;p&gt;Cannot this be Session.get().isInvalidated()? Or was session  already detached from request thread?&lt;/p&gt;</comment>
                            <comment id="17223618" author="papegaaij" created="Fri, 30 Oct 2020 12:30:04 +0000"  >&lt;p&gt;No, that does not work. At that point the &lt;tt&gt;RequestCycle&lt;/tt&gt; is not set on the &lt;tt&gt;ThreadContext&lt;/tt&gt;, which will result in a &lt;tt&gt;NullPointerException&lt;/tt&gt; in &lt;tt&gt;isInvalidated()&lt;/tt&gt;. Also, &lt;tt&gt;Session.get()&lt;/tt&gt; will create a session if it does not yet exist, and I&apos;d rather avoid that at this point. I didn&apos;t check if &lt;tt&gt;Session.get()&lt;/tt&gt; even returned the correct session. It could be that it simply created a new one because the session was also not set on the context. Luckily, we don&apos;t need the session for the check, because the boolean is stored as metadata in the &lt;tt&gt;RequestCycle&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17223669" author="reiern70" created="Fri, 30 Oct 2020 14:13:03 +0000"  >&lt;p&gt;java.lang.IllegalStateException: Cannot create a session after the response has been committed&lt;br/&gt;
	at org.apache.catalina.connector.Request.doGetSession(Request.java:3038)&lt;br/&gt;
	at org.apache.catalina.connector.Request.getSession(Request.java:2456)&lt;br/&gt;
	at org.apache.catalina.connector.RequestFacade.getSession(RequestFacade.java:896)&lt;br/&gt;
	at javax.servlet.http.HttpServletRequestWrapper.getSession(HttpServletRequestWrapper.java:231)&lt;br/&gt;
	at org.apache.shiro.web.servlet.ShiroHttpServletRequest.getSession(ShiroHttpServletRequest.java:148)&lt;br/&gt;
	at org.apache.wicket.session.HttpSessionStore.getHttpSession(HttpSessionStore.java:85)&lt;br/&gt;
	at org.apache.wicket.session.HttpSessionStore.getSessionId(HttpSessionStore.java:146)&lt;br/&gt;
	at org.apache.wicket.Session.bind(Session.java:276)&lt;br/&gt;
	at org.apache.wicket.pageStore.DefaultPageContext.getSessionId(DefaultPageContext.java:44)&lt;br/&gt;
	at org.apache.wicket.pageStore.AsynchronousPageStore$PendingAdd.&amp;lt;init&amp;gt;(AsynchronousPageStore.java:150)&lt;br/&gt;
	at org.apache.wicket.pageStore.AsynchronousPageStore.addPage(AsynchronousPageStore.java:368)&lt;br/&gt;
	at org.apache.wicket.pageStore.SerializingPageStore.addPage(SerializingPageStore.java:82)&lt;br/&gt;
	at org.apache.wicket.pageStore.CachingPageStore.addPage(CachingPageStore.java:73)&lt;br/&gt;
	at org.apache.wicket.pageStore.RequestPageStore.detach(RequestPageStore.java:102)&lt;br/&gt;
	at org.apache.wicket.page.PageManager.detach(PageManager.java:85)&lt;br/&gt;
	at org.apache.wicket.Application$2.onDetach(Application.java:1572)&lt;br/&gt;
	at org.apache.wicket.request.cycle.RequestCycleListenerCollection$3.notify(RequestCycleListenerCollection.java:105)&lt;br/&gt;
	at org.apache.wicket.request.cycle.RequestCycleListenerCollection$3.notify(RequestCycleListenerCollection.java:101)&lt;br/&gt;
	at org.apache.wicket.util.listener.ListenerCollection$1.notify(ListenerCollection.java:120)&lt;br/&gt;
	at org.apache.wicket.util.listener.ListenerCollection.reversedNotify(ListenerCollection.java:144)&lt;br/&gt;
	at org.apache.wicket.util.listener.ListenerCollection.reversedNotifyIgnoringExceptions(ListenerCollection.java:113)&lt;br/&gt;
	at org.apache.wicket.request.cycle.RequestCycleListenerCollection.onDetach(RequestCycleListenerCollection.java:100)&lt;br/&gt;
	at org.apache.wicket.request.cycle.RequestCycle.onDetach(RequestCycle.java:669)&lt;br/&gt;
	at org.apache.wicket.request.cycle.RequestCycle.detach(RequestCycle.java:614)&lt;br/&gt;
	at org.apache.wicket.protocol.http.WicketFilter.processRequestCycle(WicketFilter.java:284)&lt;br/&gt;
	at org.apache.wicket.protocol.http.WicketFilter.processRequest(WicketFilter.java:207)&lt;br/&gt;
	at org.apache.wicket.protocol.http.WicketFilter.doFilter(WicketFilter.java:306)&lt;br/&gt;
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)&lt;/p&gt;

&lt;p&gt;I still get this on current master&lt;/p&gt;</comment>
                            <comment id="17223680" author="papegaaij" created="Fri, 30 Oct 2020 14:34:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reiern70&quot; class=&quot;user-hover&quot; rel=&quot;reiern70&quot;&gt;reiern70&lt;/a&gt; That&apos;s a different bug: &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6847&quot; title=&quot;async page storing fails with flush before detach without session&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6847&quot;&gt;&lt;del&gt;WICKET-6847&lt;/del&gt;&lt;/a&gt;. This bug is about session invalidation, the other about creation.&lt;/p&gt;</comment>
                            <comment id="17224043" author="svenmeier" created="Sat, 31 Oct 2020 10:19:18 +0000"  >&lt;p&gt;It seems that Jetty is just ignoring that fact the cookie can no longer be cleared. I&apos;m wondering whether this has any negative consequences - as long as the session is invalidated on the server, clearing the cookie isn&apos;t actually needed, is it?&lt;/p&gt;

&lt;p&gt;Just an idea: Couldn&apos;t we call SessionStore#invalidate() immediately in Session#invalidate()? See attached patch.&lt;br/&gt;
Actually I never understood why we have invalidate() and invalidateNow() and their difference.&lt;/p&gt;</comment>
                            <comment id="17224529" author="papegaaij" created="Mon, 2 Nov 2020 09:19:42 +0000"  >&lt;p&gt;It is important for the cookie to be cleared. For example, when you are in a load balancing setup, the cookie is often used to stick the session to a server. When the cookies aren&apos;t cleared on logout, sessions will not be distributed cleanly.&lt;/p&gt;

&lt;p&gt;I also don&apos;t know why we have invalidate() and invalidateNow(), but I&apos;m reluctant to change that in a minor version. Keep in mind we also have to patch this on 8, as we very likely have the same problem in 8.&lt;/p&gt;</comment>
                            <comment id="17224623" author="bitstorm" created="Mon, 2 Nov 2020 12:15:18 +0000"  >&lt;p&gt;I agree with Emond. We might (should?) deprecate invalidateNow&#160; but changing it&#160;now for 9.x and 8.x it&apos;s not a good idea, and I think it&apos;s not even possible as we must keep APIs behavior consistent across minor releases. &lt;br/&gt;
As workaround I would simply implement something that keeps the old order (detach then flush) only if Session#isSessionInvalidated is true.&#160;&lt;/p&gt;</comment>
                            <comment id="17224628" author="jira-bot" created="Mon, 2 Nov 2020 12:25:36 +0000"  >&lt;p&gt;Commit 625f9afd88efc98e5c01c89431067385a993d94d in wicket&apos;s branch refs/heads/master from Emond Papegaaij&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=wicket.git;h=625f9af&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=wicket.git;h=625f9af&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6848&quot; title=&quot;Session invalidation fails because response is already committed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6848&quot;&gt;&lt;del&gt;WICKET-6848&lt;/del&gt;&lt;/a&gt;: Do not flush before detach when session needs invalidation&lt;/p&gt;</comment>
                            <comment id="17224630" author="papegaaij" created="Mon, 2 Nov 2020 12:27:56 +0000"  >&lt;p&gt;I&apos;ve committed my patch as it does fix this particular issue, but that still leaves us with &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6847&quot; title=&quot;async page storing fails with flush before detach without session&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6847&quot;&gt;&lt;del&gt;WICKET-6847&lt;/del&gt;&lt;/a&gt;, which is very much related but about session creation rather than invalidation.&lt;/p&gt;</comment>
                            <comment id="17224633" author="jira-bot" created="Mon, 2 Nov 2020 12:32:47 +0000"  >&lt;p&gt;Commit 8150ad19cbb3b436f8e8aed32c766269811e6c62 in wicket&apos;s branch refs/heads/wicket-8.x from Emond Papegaaij&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=wicket.git;h=8150ad1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=wicket.git;h=8150ad1&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6848&quot; title=&quot;Session invalidation fails because response is already committed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6848&quot;&gt;&lt;del&gt;WICKET-6848&lt;/del&gt;&lt;/a&gt;: Do not flush before detach when session needs invalidation&lt;/p&gt;</comment>
                            <comment id="17227764" author="jira-bot" created="Sat, 7 Nov 2020 08:59:22 +0000"  >&lt;p&gt;Commit e07c2521383e094e86b81d13d9252f3c8d783216 in wicket&apos;s branch refs/heads/&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6847&quot; title=&quot;async page storing fails with flush before detach without session&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6847&quot;&gt;&lt;del&gt;WICKET-6847&lt;/del&gt;&lt;/a&gt;-onEndRequest-before-flush from Sven Meier&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=wicket.git;h=e07c252&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=wicket.git;h=e07c252&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6848&quot; title=&quot;Session invalidation fails because response is already committed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6848&quot;&gt;&lt;del&gt;WICKET-6848&lt;/del&gt;&lt;/a&gt; sessionInvalidation before flush&lt;/p&gt;</comment>
                            <comment id="17227766" author="svenmeier" created="Sat, 7 Nov 2020 09:04:46 +0000"  >&lt;p&gt;With commit &lt;a href=&quot;https://github.com/apache/wicket/commit/e07c2521383e094e86b81d13d9252f3c8d783216&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/wicket/commit/e07c2521383e094e86b81d13d9252f3c8d783216&lt;/a&gt; invalidation happens before flush.&lt;br/&gt;
This works as the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6848&quot; title=&quot;Session invalidation fails because response is already committed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6848&quot;&gt;&lt;del&gt;WICKET-6848&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17227768" author="reiern70" created="Sat, 7 Nov 2020 09:09:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=svenmeier&quot; class=&quot;user-hover&quot; rel=&quot;svenmeier&quot;&gt;svenmeier&lt;/a&gt;Thanks for the heads up. I will grab that commit too rebuild and retest. &lt;/p&gt;

&lt;p&gt;regarding adding tests covering this. Our producing this issue are selenium tests. Not sure if pure wicket test could reproduce this issue.&lt;/p&gt;</comment>
                            <comment id="17227774" author="reiern70" created="Sat, 7 Nov 2020 10:23:15 +0000"  >&lt;p&gt;A quarter of our 600 selenium tests passed without server side stack traces (including latest commit). I will report back in a few hours. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=svenmeier&quot; class=&quot;user-hover&quot; rel=&quot;svenmeier&quot;&gt;svenmeier&lt;/a&gt; Thanks again.&lt;/p&gt;</comment>
                            <comment id="17227938" author="reiern70" created="Sun, 8 Nov 2020 08:12:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=svenmeier&quot; class=&quot;user-hover&quot; rel=&quot;svenmeier&quot;&gt;svenmeier&lt;/a&gt;this fixes our problem. Thanks&lt;/p&gt;</comment>
                            <comment id="17227975" author="bitstorm" created="Sun, 8 Nov 2020 11:52:01 +0000"  >&lt;p&gt;Great! Once it&apos;s merged on master I can proceed with the release. Thanks folks!&lt;/p&gt;</comment>
                            <comment id="17229387" author="svenmeier" created="Tue, 10 Nov 2020 17:31:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=papegaaij&quot; class=&quot;user-hover&quot; rel=&quot;papegaaij&quot;&gt;papegaaij&lt;/a&gt; could you take a look too please? I&apos;m unsure of the implications of this change: the session is now invalidated &lt;b&gt;before&lt;/b&gt; other all other stuff is detached. I hope this works for clearing of any cookies, but I don&apos;t have an example to test this.&lt;/p&gt;</comment>
                            <comment id="17229895" author="papegaaij" created="Wed, 11 Nov 2020 10:41:29 +0000"  >&lt;p&gt;Sorry for being a bit late to reply. I&apos;ve got a very busy schedule at the moment. I&apos;ve tested your changes on my quickstart and I no longer get the error, but it seems logout is broken now. The session is invalidated, but a new one is started right away and the user is still logged in. I&apos;m looking into it to see if I can find the cause of this.&lt;/p&gt;</comment>
                            <comment id="17229901" author="papegaaij" created="Wed, 11 Nov 2020 10:56:48 +0000"  >&lt;p&gt;Ok, I&apos;ve found the cause. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=svenmeier&quot; class=&quot;user-hover&quot; rel=&quot;svenmeier&quot;&gt;svenmeier&lt;/a&gt; on your branch, the session is invalidated before &lt;tt&gt;RequestPageStore.end&lt;/tt&gt; is called. With the page still in the touched pages, this causes a new session to be created in the same request. Swapping the calls to &lt;tt&gt;onEndRequest&lt;/tt&gt; in &lt;tt&gt;RequestCycle.processRequest&lt;/tt&gt; fixes it.&lt;/p&gt;</comment>
                            <comment id="17230136" author="svenmeier" created="Wed, 11 Nov 2020 18:00:31 +0000"  >&lt;p&gt;Had to add another commit, that clears pending pages in the request - otherwise these get stored after flush when no session is available.&lt;/p&gt;</comment>
                            <comment id="17232175" author="jira-bot" created="Sat, 14 Nov 2020 23:36:29 +0000"  >&lt;p&gt;Commit a1c94760fdaf5769211c47edfd1a4ac6077e998f in wicket&apos;s branch refs/heads/wicket-8.x from Sven Meier&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=wicket.git;h=a1c9476&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=wicket.git;h=a1c9476&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6847&quot; title=&quot;async page storing fails with flush before detach without session&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6847&quot;&gt;&lt;del&gt;WICKET-6847&lt;/del&gt;&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6848&quot; title=&quot;Session invalidation fails because response is already committed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6848&quot;&gt;&lt;del&gt;WICKET-6848&lt;/del&gt;&lt;/a&gt; flush before detach fixes&lt;/p&gt;</comment>
                            <comment id="17232177" author="jira-bot" created="Sat, 14 Nov 2020 23:37:50 +0000"  >&lt;p&gt;Commit 0c81a8830480d8aa57f3d45f7c6d1ea74b5b4bad in wicket&apos;s branch refs/heads/master from Sven Meier&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=wicket.git;h=0c81a88&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=wicket.git;h=0c81a88&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6848&quot; title=&quot;Session invalidation fails because response is already committed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6848&quot;&gt;&lt;del&gt;WICKET-6848&lt;/del&gt;&lt;/a&gt; sessionInvalidation before flush&lt;/p&gt;</comment>
                            <comment id="17232182" author="svenmeier" created="Sat, 14 Nov 2020 23:40:57 +0000"  >&lt;p&gt;Changes are pushed to master and 8.x now, please take another look and run your tests.&lt;/p&gt;</comment>
                            <comment id="17239880" author="phantom" created="Sat, 28 Nov 2020 04:33:48 +0000"  >&lt;p&gt;Seems that this fix created another problem. Please check issue&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6856&quot; title=&quot;WicketTester fails do startComponentInPage() after session invalidation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6856&quot;&gt;&lt;del&gt;WICKET-6856&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13336769">WICKET-6847</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13327872">WICKET-6831</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13014483" name="WICKET-6848-invalidate-session-manager-immediately.patch" size="855" author="svenmeier" created="Sat, 31 Oct 2020 10:19:30 +0000"/>
                            <attachment id="13014408" name="WICKET-6848.diff" size="2535" author="papegaaij" created="Fri, 30 Oct 2020 09:55:18 +0000"/>
                            <attachment id="13014406" name="wicket6848.zip" size="27982" author="papegaaij" created="Fri, 30 Oct 2020 09:07:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 50 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0k59c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>