<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:19:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-4293] UrlResourceStream closes incorrect InputStream causing stacktraces on undeploy on GlassFish</title>
                <link>https://issues.apache.org/jira/browse/WICKET-4293</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;The UrlResourceStream, used by PackageResources, uses URLConnection#getInputStream() to get file contents. This method is called in UrlResourceStream#getInputStream(), but also when closing the resource in UrlResourceStream#close(). At least on GlassFish v2 and v3, the second call to URLConnection#getInputStream() returns a new stream, so the one created to retrieve the file contents is never closed properly.&lt;br/&gt;
This results in a warning of the container when the classes are garbage-collected, for example on undeploy.&lt;/p&gt;

&lt;p&gt;The problem is not triggered in all situations. It can be reproduced by using Wicket in a multi-module project consisting of an EAR, WAR and JAR. The JAR must contain a resource (CSS, image, ...) and a Behavior. Inside the Behavior, a static ResourceReference must be created for the resource file.&lt;br/&gt;
When using this Behavior from inside the WAR project by loading a page the resource is loaded properly. On undeploy however, the described problem will show up.&lt;/p&gt;

&lt;p&gt;The problem does not exists in Wicket 1.4.x, because a reference to the InputStream is stored. A quickstart and patch for 1.5 is available, will try to attach it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</description>
                <environment>GlassFish v2.1.1 and GlassFish v.3.1&lt;br/&gt;
&lt;br/&gt;
java version &amp;quot;1.6.0_29&amp;quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.6.0_29-b11-402-11M3527)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 20.4-b02-402, mixed mode)&lt;br/&gt;
&lt;br/&gt;
Mac OS X 10.7.2</environment>
        <key id="12535164">WICKET-4293</key>
            <summary>UrlResourceStream closes incorrect InputStream causing stacktraces on undeploy on GlassFish</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgrigorov">Martin Tzvetanov Grigorov</assignee>
                                    <reporter username="pdegeus">Pepijn de Geus</reporter>
                        <labels>
                            <label>core</label>
                            <label>ear</label>
                            <label>glassfish</label>
                            <label>resource</label>
                    </labels>
                <created>Wed, 14 Dec 2011 14:27:40 +0000</created>
                <updated>Fri, 16 Dec 2011 15:47:30 +0000</updated>
                            <resolved>Fri, 16 Dec 2011 14:17:25 +0000</resolved>
                                    <version>1.5.3</version>
                                    <fixVersion>1.5.4</fixVersion>
                    <fixVersion>6.0.0-beta1</fixVersion>
                                    <component>wicket</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13169393" author="pdegeus" created="Wed, 14 Dec 2011 14:29:20 +0000"  >&lt;p&gt;Quickstart to reproduce the bug. Must be ran on GlassFish to be able to see the problem.&lt;/p&gt;

&lt;p&gt;The patch on Wicket 1.5-SNAPSHOT fixes the problem.&lt;/p&gt;</comment>
                            <comment id="13170163" author="mgrigorov" created="Thu, 15 Dec 2011 12:45:46 +0000"  >&lt;p&gt;We have test for this situation but it doesn&apos;t open a new input stream for each call: org.apache.wicket.util.resource.UrlResourceStreamTest.loadJustOnce()&lt;/p&gt;

&lt;p&gt;I just committed an improvement that should do what you need.&lt;br/&gt;
Try it and give us feedback,&lt;br/&gt;
Also try to break/improve the test if you can.&lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                            <comment id="13170250" author="pdegeus" created="Thu, 15 Dec 2011 14:45:42 +0000"  >&lt;p&gt;Thanks for your reply, Martin.&lt;/p&gt;

&lt;p&gt;Your commit fixes the problem, but has one disadvantage: the call to Connections.close(data.connection) still opens a new InputStream and immediately closes it.&lt;br/&gt;
The problem is thereby even broader: every call to Connections.close(URLConnection) has this problem. Please refer to these implementations of URLConnection (in OpenJDK and GlassFish) to see a new stream created for every call:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://grepcode.com/file/repository.springsource.com/org.apache.geronimo/com.springsource.org.apache.geronimo.kernel/2.0.1/org/apache/geronimo/kernel/classloader/JarFileUrlConnection.java?av=h#JarFileUrlConnection&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://grepcode.com/file/repository.springsource.com/org.apache.geronimo/com.springsource.org.apache.geronimo.kernel/2.0.1/org/apache/geronimo/kernel/classloader/JarFileUrlConnection.java?av=h#JarFileUrlConnection&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://grepcode.com/file/repo1.maven.org/maven2/org.glassfish.common/common-util/10.0-b28/com/sun/enterprise/loader/EJBClassLoader.java?av=h#EJBClassLoader.InternalJarURLConnection&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://grepcode.com/file/repo1.maven.org/maven2/org.glassfish.common/common-util/10.0-b28/com/sun/enterprise/loader/EJBClassLoader.java?av=h#EJBClassLoader.InternalJarURLConnection&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In my opinion all usages of the close(URLConnection) with connections other than HttpURLConnection are faulty and should be checked/changed.&lt;br/&gt;
I&apos;ll attach a new patch (wicket-core-4293-2.patch) fixing the problem based on your new commit and extending the test you mentioned.&lt;/p&gt;</comment>
                            <comment id="13170256" author="mgrigorov" created="Thu, 15 Dec 2011 14:56:20 +0000"  >&lt;p&gt;The real problem is Connections#close() that calls getInputStream().&lt;br/&gt;
I don&apos;t see a reason to do that.&lt;/p&gt;</comment>
                            <comment id="13170258" author="pdegeus" created="Thu, 15 Dec 2011 15:00:30 +0000"  >&lt;p&gt;Exactly, but the streams that are used must of course be closed afterwards, which is what my patch accomplishes.&lt;/p&gt;</comment>
                            <comment id="13170274" author="mgrigorov" created="Thu, 15 Dec 2011 15:19:02 +0000"  >&lt;p&gt;Your test improvement is not correct. Or at least doesn&apos;t follow the rule that calling getInputStream() should increase the streamCounter.&lt;br/&gt;
I&apos;ll commit the improved version soon.&lt;/p&gt;</comment>
                            <comment id="13170321" author="pdegeus" created="Thu, 15 Dec 2011 16:15:10 +0000"  >&lt;p&gt;Thanks, I&apos;m curiously waiting for your change &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
I noted another potential problem in my patch; the last line of internalGetInputStream should read:&lt;/p&gt;

&lt;p&gt;return (data != null) ? data.inputStream : null;&lt;/p&gt;</comment>
                            <comment id="13170869" author="mgrigorov" created="Fri, 16 Dec 2011 09:49:12 +0000"  >&lt;p&gt;Hi Pepijn,&lt;/p&gt;

&lt;p&gt;Can you please take a look at r1215075 ?&lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                            <comment id="13170903" author="pdegeus" created="Fri, 16 Dec 2011 11:18:17 +0000"  >&lt;p&gt;Hi Martin, that looks great. I see you have a different opinion on whether getInputStream should return a single stream instance or always a new one &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
One remaining thing: you&apos;re still using Connections.closeQuietly(data.connection), which opens a new stream and immediately closes it. This is unnecessary and I&apos;d suggest to fix that too by removing the call.&lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                            <comment id="13170939" author="mgrigorov" created="Fri, 16 Dec 2011 12:36:23 +0000"  >&lt;p&gt;You didn&apos;t pay attention then &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Connections#close() no more does this.&lt;br/&gt;
Thanks for your help!&lt;/p&gt;</comment>
                            <comment id="13170954" author="pdegeus" created="Fri, 16 Dec 2011 13:03:14 +0000"  >&lt;p&gt;Ah sorry, didn&apos;t have the wicket-util project open. Shame on me.&lt;br/&gt;
It works great now, thank you too &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12518332">WICKET-3957</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12507356" name="Wicket153-bug.zip" size="22898" author="pdegeus" created="Wed, 14 Dec 2011 14:29:20 +0000"/>
                            <attachment id="12507357" name="patch.txt" size="1985" author="pdegeus" created="Wed, 14 Dec 2011 14:29:20 +0000"/>
                            <attachment id="12507535" name="wicket-core-4293-2.patch" size="6233" author="pdegeus" created="Thu, 15 Dec 2011 14:46:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>220848</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 49 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i00w87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3153</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>