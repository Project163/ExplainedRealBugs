<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:25:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-6356] Clustering failover not working on Tomcat</title>
                <link>https://issues.apache.org/jira/browse/WICKET-6356</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;Clustering failover with Tomcat 8 is not working for us in Production or locally on my Mac. The reason is the following from the debugging that I did and from the best of my understanding:&lt;/p&gt;

&lt;p&gt;Whenever a statefull page is used/touched the SessionEntry is updated. This SessionEntry is stored in the tomcats session under the attribute name  &quot;wicket:persistentPageManagerData-APPLICATION_NAME&quot;. &lt;br/&gt;
However at the end of the wicket request, Session.internalDetach() is called and setAttribute() is called passing the wicket session under the name &quot;wicket:wicket.hub:session&quot;. This triggers the replication in Tomcat (only when setAttribute is called and ONLY that attribute is replicated). Because the SessionEntry is stored under a different attribute name its never replicated.&lt;/p&gt;

&lt;p&gt;The only time the SessionEntry is replicated is when a node first starts up and joins the cluster , at this point all sessions are replicated across (including all attritbutes) by the daltamanager and SessionEntry#readObject() is used which contains all the pages. On Tomcat after this initial syncing of all sessions SessionEntry#readObject() is never used.&lt;/p&gt;

&lt;p&gt;So the only time session failover works is when you kill the other instance (in a 2 node cluster) just after the other instance starts up - at this point the correct SessionEntry is on the new instance. If however you visit some more pages the new pages are never replicated across as the SessionEntry is never replicated.&lt;/p&gt;

&lt;p&gt;Further to this IF the SessionEntry was to be replicated it would not be any good as the cache are transient &lt;br/&gt;
private transient List&amp;lt;IManageablePage&amp;gt; sessionCache;&lt;br/&gt;
private transient List&amp;lt;Object&amp;gt; afterReadObject&lt;/p&gt;

&lt;p&gt;This means any new pages created on the old instance (after the new instance has started up) are not available in the http session or the second level page store on the new instance. &lt;br/&gt;
Therefore when the old instance in shut down the user is load balanced to the new instance. At this point the link in the page Wicket is looking for does not exist in the SessionEntry cache or the PageStore so it creates the page and looks for the component/link.This causes a ComponentNotFoundException for us because the links are either in a DataView which is never rendered so does not exist, or the other links are actually added to the page in an Ajax request and again because the page is not rendered are not there, Wicket then throws the exception and it appears to the user the session is lost.&lt;/p&gt;



&lt;p&gt;So in summary there seems there is no way for the current mechanism on Tomcat to work. It would seem the SessionEntry.sessionCache needs to be not transient and setAttribute needs to be called for the SessionEntry at the end of request on the internalDetach so that Tomcats deltamanager replicates that attribute in the session.&lt;/p&gt;

&lt;p&gt;Attached my quickstart , tomcat, and apache conf.&lt;/p&gt;
</description>
                <environment>Tomcat 8.0.32, Apache 2.4, OSx and Solaris 9,</environment>
        <key id="13063647">WICKET-6356</key>
            <summary>Clustering failover not working on Tomcat</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgrigorov">Martin Tzvetanov Grigorov</assignee>
                                    <reporter username="waynegc">wayne pope</reporter>
                        <labels>
                            <label>cluster</label>
                            <label>clustering</label>
                            <label>tomcat</label>
                    </labels>
                <created>Wed, 12 Apr 2017 22:24:00 +0000</created>
                <updated>Wed, 5 Jul 2017 08:24:21 +0000</updated>
                            <resolved>Mon, 1 May 2017 19:37:42 +0000</resolved>
                                    <version>6.17.0</version>
                    <version>7.5.0</version>
                                    <fixVersion>6.27.0</fixVersion>
                    <fixVersion>7.7.0</fixVersion>
                    <fixVersion>8.0.0-M6</fixVersion>
                                    <component>wicket</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15981004" author="waynegc" created="Mon, 24 Apr 2017 11:15:18 +0000"  >&lt;p&gt;I&apos;ve done a fix which seems to work for me. Please find attached updated PageStoreManager.java based on 7.5.0 code version&lt;/p&gt;</comment>
                            <comment id="15981011" author="mgrigorov" created="Mon, 24 Apr 2017 11:21:08 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=waynegc&quot; class=&quot;user-hover&quot; rel=&quot;waynegc&quot;&gt;waynegc&lt;/a&gt;!&lt;br/&gt;
I&apos;ll take a look in the coming days!&lt;/p&gt;</comment>
                            <comment id="15991199" author="mgrigorov" created="Mon, 1 May 2017 18:02:48 +0000"  >&lt;p&gt;I have two questions regarding the attached patch:&lt;/p&gt;

&lt;p&gt;1) Why #removePage() methods are removed ?&lt;/p&gt;

&lt;p&gt;2) why &quot;afterReadObject&quot; is no more transient ?&lt;/p&gt;</comment>
                            <comment id="15991360" author="jira-bot" created="Mon, 1 May 2017 19:29:53 +0000"  >&lt;p&gt;Commit 9338bdffedd1263a48c55a1f3e2c78f11c9d9d6b in wicket&apos;s branch refs/heads/wicket-7.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgrigorov&quot; class=&quot;user-hover&quot; rel=&quot;mgrigorov&quot;&gt;mgrigorov&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=wicket.git;h=9338bdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=wicket.git;h=9338bdf&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6356&quot; title=&quot;Clustering failover not working on Tomcat&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6356&quot;&gt;&lt;del&gt;WICKET-6356&lt;/del&gt;&lt;/a&gt; Clustering failover not working on Tomcat&lt;/p&gt;

&lt;p&gt;Touch the session attribute every time a new stateful pages are stored so that session replication is triggered&lt;/p&gt;</comment>
                            <comment id="15991361" author="jira-bot" created="Mon, 1 May 2017 19:30:09 +0000"  >&lt;p&gt;Commit 77bafbc7de94a4f5a5ce7ed054c6bc5bb693f266 in wicket&apos;s branch refs/heads/wicket-6.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgrigorov&quot; class=&quot;user-hover&quot; rel=&quot;mgrigorov&quot;&gt;mgrigorov&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=wicket.git;h=77bafbc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=wicket.git;h=77bafbc&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6356&quot; title=&quot;Clustering failover not working on Tomcat&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6356&quot;&gt;&lt;del&gt;WICKET-6356&lt;/del&gt;&lt;/a&gt; Clustering failover not working on Tomcat&lt;/p&gt;

&lt;p&gt;Touch the session attribute every time a new stateful pages are stored so that session replication is triggered&lt;/p&gt;</comment>
                            <comment id="15991362" author="jira-bot" created="Mon, 1 May 2017 19:30:22 +0000"  >&lt;p&gt;Commit 290398a3e4f950f6c6cd93ad0c557c12c867ce0e in wicket&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgrigorov&quot; class=&quot;user-hover&quot; rel=&quot;mgrigorov&quot;&gt;mgrigorov&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=wicket.git;h=290398a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=wicket.git;h=290398a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6356&quot; title=&quot;Clustering failover not working on Tomcat&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6356&quot;&gt;&lt;del&gt;WICKET-6356&lt;/del&gt;&lt;/a&gt; Clustering failover not working on Tomcat&lt;/p&gt;

&lt;p&gt;Touch the session attribute every time a new stateful pages are stored so that session replication is triggered&lt;/p&gt;</comment>
                            <comment id="15991374" author="mgrigorov" created="Mon, 1 May 2017 19:37:42 +0000"  >&lt;p&gt;I was able to reproduce the problem.&lt;br/&gt;
I&apos;ve just added the following Apache2 conf to /etc/apache2/sites-enabled/tomcat-cluster.conf:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ProxyPass &lt;span class=&quot;code-quote&quot;&gt;&quot;/&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;balancer:&lt;span class=&quot;code-comment&quot;&gt;//cluster/&quot;&lt;/span&gt; stickysession=JSESSIONID nofailover=Off
&lt;/span&gt;ProxyPassReverse &lt;span class=&quot;code-quote&quot;&gt;&quot;/&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;balancer:&lt;span class=&quot;code-comment&quot;&gt;//cluster/&quot;&lt;/span&gt;
&lt;/span&gt;
# define the balancer, with http and/or ajp connections
&amp;lt;Proxy balancer:&lt;span class=&quot;code-comment&quot;&gt;//cluster/&amp;gt;
&lt;/span&gt;       Order allow,deny
       Allow from all
       BalancerMember ajp:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:8009 route=gc1
&lt;/span&gt;       BalancerMember ajp:&lt;span class=&quot;code-comment&quot;&gt;//127.0.0.1:8010 route=gc2
&lt;/span&gt;  &amp;lt;/Proxy&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The needed modules are: proxy_ajp.load, proxy_balancer.conf, proxy_balancer.load, proxy.conf, proxy_http.load, proxy.load, &lt;br/&gt;
lbmethod_byrequests.load &lt;/p&gt;

&lt;p&gt;The version of Tomcat is 8.0.43. For 8.5.x MessageDispatch15Interceptor should be replaced with MessageDispatchInterceptor in server.xonf.&lt;br/&gt;
Also I&apos;ve changed the receiver address to 127.0.0.1. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=waynegc&quot; class=&quot;user-hover&quot; rel=&quot;waynegc&quot;&gt;waynegc&lt;/a&gt; Please test my change with 7.7.0-SNAPSHOT and let me know if something is still broken!&lt;br/&gt;
Thank you very much for the discussion and analysis!&lt;/p&gt;</comment>
                            <comment id="16072555" author="waynegc" created="Mon, 3 Jul 2017 14:50:32 +0000"  >&lt;p&gt;Hello Martin,&lt;/p&gt;

&lt;p&gt;sincere apologies for the amount of time its taken me to circle back to this, but we had some major releases that needed my attention. I&apos;m very glad to say that your fixes have solved the replication issue at least in testing. I will get this moved to production, but the outcome looks great. Many many thanks for working on this. &lt;/p&gt;</comment>
                            <comment id="16072915" author="mgrigorov" created="Mon, 3 Jul 2017 20:59:40 +0000"  >&lt;p&gt;Great news!&lt;br/&gt;
Just make sure you also use the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6387&quot; title=&quot;PageStore loses all stored pages&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6387&quot;&gt;&lt;del&gt;WICKET-6387&lt;/del&gt;&lt;/a&gt; !&lt;/p&gt;</comment>
                            <comment id="16073429" author="waynegc" created="Tue, 4 Jul 2017 10:13:15 +0000"  >&lt;p&gt;Thanks Martin much appreciated for pointing that out. I think its best I wait then until the release of 7.8.0. Any idea/guess when that will go live?&lt;/p&gt;</comment>
                            <comment id="16074406" author="bitstorm" created="Wed, 5 Jul 2017 08:24:21 +0000"  >&lt;p&gt;Hi all,&lt;/p&gt;

&lt;p&gt;if there are no urgent issues to close I can start the release vote for 7.8.0 in the very next days.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13076191">WICKET-6387</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12863150" name="IssueFiles.zip" size="34998" author="waynegc" created="Wed, 12 Apr 2017 22:24:00 +0000"/>
                            <attachment id="12864743" name="PageStoreManager.java" size="10513" author="waynegc" created="Mon, 24 Apr 2017 11:15:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 19 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3dkbj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>