<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:20:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-4718] ResourceStreamResource#getResourceStream() is called multiple times</title>
                <link>https://issues.apache.org/jira/browse/WICKET-4718</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;When a ResourceStreamResource is implemented to return a IResourceStream dynamically, by returning a new instance of an extended AbstractResourceStream, that ResourceStream is instantiated multiple times when a ResourceLink is clicked.&lt;/p&gt;

&lt;p&gt;In my case, that ResourceStream returns an AttachmentInputStream from the Ektorp library (for CouchDB interaction). This behavior results in multiple queries (currently up to four) when I click once on a ResourceLink to that resource.&lt;/p&gt;

&lt;p&gt;Code Examples&lt;br/&gt;
Extended ResourceStreamResource: &lt;a href=&quot;http://pastebin.com/9BB7LEiV&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://pastebin.com/9BB7LEiV&lt;/a&gt;&lt;br/&gt;
Extended IResouceStream: &lt;a href=&quot;http://pastebin.com/Z7GvzGja&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://pastebin.com/Z7GvzGja&lt;/a&gt;&lt;/p&gt;</description>
                <environment>Mac OS X 10.7.4 Lion, Java 6, IntelliJ Idea 11.1, Tomcat 7 &amp;amp; Jetty 7.5.0</environment>
        <key id="12603891">WICKET-4718</key>
            <summary>ResourceStreamResource#getResourceStream() is called multiple times</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgrigorov">Martin Tzvetanov Grigorov</assignee>
                                    <reporter username="blacklight">Carsten Dr&#228;ger</reporter>
                        <labels>
                    </labels>
                <created>Fri, 17 Aug 2012 17:32:24 +0000</created>
                <updated>Mon, 20 Aug 2012 21:29:21 +0000</updated>
                            <resolved>Mon, 20 Aug 2012 15:32:17 +0000</resolved>
                                    <version>6.0.0-beta3</version>
                                    <fixVersion>1.5.8</fixVersion>
                    <fixVersion>6.0.0</fixVersion>
                                    <component>wicket</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13437745" author="mgrigorov" created="Mon, 20 Aug 2012 08:59:21 +0000"  >&lt;p&gt;The default impl of org.apache.wicket.request.resource.ResourceStreamResource#getResourceStream() is:&lt;/p&gt;

&lt;p&gt;/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Lazy or dynamic initialization of the wrapped IResourceStream(Writer)&lt;/li&gt;
	&lt;li&gt;@return the underlying IResourceStream&lt;br/&gt;
	 */&lt;br/&gt;
	protected IResourceStream getResourceStream()
	{
		return stream;
	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Since you override it then it will do whatever you do in your implementation.&lt;/p&gt;

&lt;p&gt;I see two solutions for your case:&lt;/p&gt;

&lt;p&gt;1) Use org.apache.wicket.request.resource.ResourceStreamResource#ResourceStreamResource(IResourceStream) constructor and thus the &apos;stream&apos; will be created just once and reused many times later.&lt;/p&gt;

&lt;p&gt;2) Cache the created value of the &apos;stream&apos; in your #getResourceStream() impl and reuse it. This will make the instantiation of &apos;stream&apos; lazy.&lt;/p&gt;</comment>
                            <comment id="13437758" author="blacklight" created="Mon, 20 Aug 2012 09:16:52 +0000"  >&lt;p&gt;Thank you for your comment! Unfortunately, I already tried both, and there&apos;s two problems with it.&lt;/p&gt;

&lt;p&gt;1) Can&apos;t do that, because that would make my resources static. I&apos;m having many different ResourceLinks on one page, if I would load all those resources at once at page-load I would have a horrible performance. I also need to create the ResourceLink at page-load because I need the URL for it (it&apos;s not supposed to be a shared resource, my site is secured) to pass it to other functions, e.g. a JW Player for a mp3-file coming from the database.&lt;/p&gt;

&lt;p&gt;2) I tried to cache the stream with a class variable in #getResourceStream(), but I also couldn&apos;t do that because the org.ektorp.AttachmentInputStream is not serializable. I get an error if I do that, the page can&apos;t be serialized and I don&apos;t have access to the resource even though it apparently has been queried once.&lt;/p&gt;

&lt;p&gt;So 1) is not an option for now. Do you maybe see a solution for point 2? That would really help me out of my dilemma. I&apos;m still wondering why the #getResourceStream() is called multiple times if it is only requested once via a ResourceLink. That&apos;s why I thought it&apos;s a bug.&lt;/p&gt;</comment>
                            <comment id="13437762" author="mgrigorov" created="Mon, 20 Aug 2012 09:27:23 +0000"  >&lt;p&gt;Put a breakpoint in #getResourceStream() and see the stacktrace(s). Paste them here or in a pastebin too.&lt;/p&gt;

&lt;p&gt;As a workaround you can null-ify your cached &apos;stream&apos; by overriding org.apache.wicket.request.resource.IResource#respond():&lt;/p&gt;

&lt;p&gt;@Override public void respond(Attributes attrs) {&lt;br/&gt;
   super.respond(attrs);&lt;/p&gt;

&lt;p&gt;  cachedStream = null;&lt;br/&gt;
}&lt;/p&gt;</comment>
                            <comment id="13437769" author="blacklight" created="Mon, 20 Aug 2012 10:04:33 +0000"  >&lt;p&gt;Ok, here&apos;s the stack trace when I try to cache the IResourceStream returned by getResourceStream() in my extended ResourceStreamResource. I get that multiple times as well: &lt;a href=&quot;http://pastebin.com/5tgWDZYc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://pastebin.com/5tgWDZYc&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Also, I tried to debug it. Without caching, if I click on a ResourceLink e.g. to display an image from the database in a JQuery FancyBox, the stream get instantiated in the CouchDbAttachmentResource#getResourceStream(). It then appears to get instantiated again in the ResourceStreamResource#internalGetResourceStream()! I can&apos;t see why this should be happening. &lt;br/&gt;
Also, by the time the resource should be displayed, the stream is already closed for some reason, so this is happening all over again, which is probably why I get 2x2=4 queries for one click on a ResourceLink.&lt;/p&gt;

&lt;p&gt;If I try your workaround, it&apos;s sometimes working, sometimes not depending on the way I use the resource. I still get multiple queries, but for the image explained above, it&apos;s only happening two times.&lt;br/&gt;
However, when I let the browser e.g. play a .wav file directly from the database, it&apos;s not working anymore and I get the following exceptions: &lt;a href=&quot;http://pastebin.com/JZF1kF9i&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://pastebin.com/JZF1kF9i&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So not really an option either :/&lt;/p&gt;</comment>
                            <comment id="13437771" author="mgrigorov" created="Mon, 20 Aug 2012 10:08:28 +0000"  >&lt;p&gt;Please create a quickstart.&lt;br/&gt;
#internalGetResourceStream() just calls #getResourceStream() and asserts that the returned value is not null.&lt;/p&gt;</comment>
                            <comment id="13437773" author="blacklight" created="Mon, 20 Aug 2012 10:13:45 +0000"  >&lt;p&gt;Ok I will try to do that somehow, I hope I can replicate it because the CouchDB is local and I can&apos;t reproduce the environment the same way in a quick start. I will see if I find a workaround and comment again.&lt;/p&gt;</comment>
                            <comment id="13437794" author="blacklight" created="Mon, 20 Aug 2012 11:28:44 +0000"  >&lt;p&gt;Alright, I was able to replicate the behavior without the actual database! I&apos;m using images from the web and am reading that data into an InputStream instead. But the structure is the same. The AttachmentInputStream class is the same, it comes from the Ektorp library and is returned if I fetch an attachment.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://d.pr/f/aFnV&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://d.pr/f/aFnV&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The first link is with caching, the second without. No error when I click on the second link which is what I have right now, but as you can see in the console there are multiple queries just like to my CouchDB.&lt;/p&gt;</comment>
                            <comment id="13437934" author="mgrigorov" created="Mon, 20 Aug 2012 15:32:17 +0000"  >&lt;p&gt;The problem was that ResourceStreamResource#close() also called #getInternalResourceStream().&lt;br/&gt;
With this fix now your link2 works fine.&lt;br/&gt;
link1 works also fine if you make your cached stream transient.&lt;/p&gt;</comment>
                            <comment id="13437945" author="blacklight" created="Mon, 20 Aug 2012 15:40:26 +0000"  >&lt;p&gt;Great, thank you for looking into it so quickly! Hope the release is near. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I tried making the cached stream transient today after your suggestions, but that caused some other problems with some of my resources, even though it might be working in the quick-start. If the fix makes my current implementation work, I&apos;m happy.&lt;/p&gt;</comment>
                            <comment id="13437954" author="mgrigorov" created="Mon, 20 Aug 2012 15:47:04 +0000"  >&lt;p&gt;6.0.0 is close but you can try with 6.0-SNAPSHOT in the meantime. This way we can fix other issues before 6.0.0.&lt;br/&gt;
Just add the Apache snapshots repository to your project&apos;s pom.xml. See pom.xml in the quickstart for 6.0-SNAPSHOT.&lt;/p&gt;</comment>
                            <comment id="13437970" author="blacklight" created="Mon, 20 Aug 2012 16:08:58 +0000"  >&lt;p&gt;Hm, I tried it with the 6.0-SNAPSHOT. I&apos;m afraid it&apos;s still not working as intended. In the quick-start it worked for the first time (maybe by coincidence), but if you click a second time (and every time after that) it&apos;s the same behavior: multiple queries.&lt;/p&gt;</comment>
                            <comment id="13438196" author="mgrigorov" created="Mon, 20 Aug 2012 20:56:04 +0000"  >&lt;p&gt;For me every click on link2 leads to these three log statements:&lt;/p&gt;

&lt;p&gt;INFO  - TestResourceStreamResource - Called multiple times, therefore querying my database four times instead of once&lt;br/&gt;
INFO  - CustomResourceStream       - Opening InputStream for &lt;a href=&quot;http://couchdb.apache.org/image/couch.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://couchdb.apache.org/image/couch.png&lt;/a&gt;&lt;br/&gt;
INFO  - CustomResourceStream       - Closing InputStream for &lt;a href=&quot;http://couchdb.apache.org/image/couch.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://couchdb.apache.org/image/couch.png&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think this is the correct behavior.&lt;/p&gt;

&lt;p&gt;Did you download 6.0-SNAPSHOT from Apache Snapshots repo or you built Wicket locally ?&lt;br/&gt;
Apache Jenkins setup is not very stable and sometimes it takes more time to build proper SNAPSHOT. &lt;/p&gt;</comment>
                            <comment id="13438233" author="blacklight" created="Mon, 20 Aug 2012 21:29:21 +0000"  >&lt;p&gt;You are correct! I downloaded it from the Apache repository, and that was probably too quick. I just tried it again, and now I get the correct behavior every time like you do. &lt;/p&gt;

&lt;p&gt;Indeed it seems fixed! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>257703</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 13 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0k87j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>116147</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>