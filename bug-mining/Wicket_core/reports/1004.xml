<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:22:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-5518] FormComponent.updateCollectionModel  does not handle unmodifiableList</title>
                <link>https://issues.apache.org/jira/browse/WICKET-5518</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;FormComponent.updateCollectionModel should handle situation, when getter returns unmodifiable list.&lt;/p&gt;

&lt;p&gt;Proposed solution:&lt;/p&gt;

&lt;p&gt;			formComponent.modelChanging();&lt;br/&gt;
			booelan isChanged;&lt;br/&gt;
			try {&lt;br/&gt;
				collection.clear();&lt;br/&gt;
				if (convertedInput != null)&lt;/p&gt;
				{
					collection.addAll(convertedInput);
				}
&lt;p&gt;				isChanged = true;&lt;br/&gt;
			catch (Exception e)&lt;/p&gt;
			{
				// ignore this exception as Unmodifiable list does not allow change 				
				logger.info(&quot;An error occurred while trying to modify list attached to &quot; + formComponent, e);
			}

&lt;p&gt;			try&lt;/p&gt;
			{
				if(isChanged)				
					formComponent.getModel().setObject(collection);
				else 
					// TODO: create here collection as non-abstract successor of setObject declared argument
					formComponent.getModel().setObject(new ArrayList(convertedInput));
				isChanged = true;
			}
&lt;p&gt;			catch (Exception e)&lt;/p&gt;
			{
				// ignore this exception because it could be that there
				// is not setter for this collection.
				logger.info(&quot;An error occurred while trying to set the new value for the property attached to &quot; + formComponent, e);
			}
&lt;p&gt;			// at least one update method should pass successfully			&lt;br/&gt;
			if(isChanged)&lt;br/&gt;
				formComponent.modelChanged();&lt;br/&gt;
			else&lt;br/&gt;
				throw new RuntimeException(&quot;An error occurred while trying to modify value for the property attached to &quot; + formComponent);	   &lt;/p&gt;</description>
                <environment></environment>
        <key id="12697106">WICKET-5518</key>
            <summary>FormComponent.updateCollectionModel  does not handle unmodifiableList</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="svenmeier">Sven Meier</assignee>
                                    <reporter username="petr.lancaric@lmc.eu">Petr Lancaric</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 Feb 2014 11:57:03 +0000</created>
                <updated>Thu, 27 Feb 2014 10:57:09 +0000</updated>
                            <resolved>Thu, 27 Feb 2014 10:57:09 +0000</resolved>
                                    <version>6.12.0</version>
                                    <fixVersion>7.0.0-M1</fixVersion>
                    <fixVersion>6.15.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13911513" author="mgrigorov" created="Tue, 25 Feb 2014 12:26:28 +0000"  >&lt;p&gt;What is the use case ?&lt;br/&gt;
Why you want to use unmodifiable model (list) ?&lt;/p&gt;</comment>
                            <comment id="13911533" author="svenmeier" created="Tue, 25 Feb 2014 12:52:19 +0000"  >&lt;p&gt;A getter might return an unmodifiable collection, expecting the setter to be called with a new collection. Makes sense to me.&lt;/p&gt;</comment>
                            <comment id="13911534" author="petr.lancaric@lmc.eu" created="Tue, 25 Feb 2014 12:53:04 +0000"  >&lt;p&gt;There is a discussion on pros and cons of immutable objects, so I considered as good practice to use immutable object:&lt;br/&gt;
&lt;a href=&quot;http://programmers.stackexchange.com/questions/151733/if-immutable-objects-are-good-why-do-people-keep-creating-mutable-objects&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://programmers.stackexchange.com/questions/151733/if-immutable-objects-are-good-why-do-people-keep-creating-mutable-objects&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;My initial motivation was that I want to track changes on my value object, therefore getter returns copy of list and changes could be detected in setter. I am able to achieve this goal using mutable copy as shown bellow.&lt;/p&gt;

&lt;p&gt;I understand task is not so easy as we have to find suitable collection type and create instance via reflection, which is accepted by setObject call as an argument.&lt;/p&gt;

&lt;p&gt;My code of vaue object used in property model:&lt;/p&gt;

&lt;p&gt;    public List&amp;lt;Integer&amp;gt; getBusinessFieldList() &lt;/p&gt;
{
        // fails:
        return Collections.unmodifiableList(this.businessFieldList);
       // works: 
       //return Lists.newArrayList(this.businessFieldList);
    }

&lt;p&gt;    public void setBusinessFieldList(List&amp;lt;Integer&amp;gt; value) &lt;/p&gt;
{
        trackChange(&quot;businessField&quot;, this.businessFieldList, value);
        this.businessFieldList = value;
    }</comment>
                            <comment id="13911543" author="mgrigorov" created="Tue, 25 Feb 2014 13:02:15 +0000"  >&lt;p&gt;Immutable collections makes sense to be used when:&lt;br/&gt;
1) the collection is designed to be immutable&lt;br/&gt;
2) in multithreaded context&lt;/p&gt;

&lt;p&gt;1) is very important because immutable collections have additional logic to reuse the same memory when an item is added/removed to/from it. &lt;br/&gt;
I.e. the old collection will share most of its items with the new collection. With your code your are adding more pressure to the Garbage Collector, nothing more, because Java collections are not designed to be used as immutable. Wicket protects you from multithreaded issues if the collection is not with session scope.&lt;/p&gt;

&lt;p&gt;But in the case when you use real immutable collections (like Guava&apos;s ones) then the suggested change makes more sense.&lt;br/&gt;
The logger level should be DEBUG IMO.&lt;/p&gt;</comment>
                            <comment id="13911555" author="petr.lancaric@lmc.eu" created="Tue, 25 Feb 2014 13:19:04 +0000"  >&lt;p&gt;With guava the result is the same:&lt;/p&gt;

&lt;p&gt;Caused by: java.lang.UnsupportedOperationException&lt;br/&gt;
	at com.google.common.collect.ImmutableCollection.clear(ImmutableCollection.java:142)&lt;br/&gt;
	at org.apache.wicket.markup.html.form.FormComponent.updateCollectionModel(FormComponent.java:1593)&lt;br/&gt;
	at org.apache.wicket.markup.html.form.ListMultipleChoice.updateModel(ListMultipleChoice.java:371)&lt;/p&gt;


&lt;p&gt;Colelction.clear and Collection.addAll are declared as optional methods and it is correct if they throw UnsupportedOperationException. Such situation should be handled.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://docs.oracle.com/javase/7/docs/api/java/util/Collection.html#clear%28%29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/7/docs/api/java/util/Collection.html#clear%28%29&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13912162" author="svenmeier" created="Tue, 25 Feb 2014 22:25:34 +0000"  >&lt;p&gt;I&apos;ve pushed an improvement in Wicket master. I&apos;m not sure it&apos;s safe to apply the change to 6.x too, since it changes the invocation order of #modelChanged() and this might break user&apos;s code.&lt;/p&gt;</comment>
                            <comment id="13912700" author="svenmeier" created="Wed, 26 Feb 2014 09:39:02 +0000"  >&lt;p&gt;On second though I think it&apos;s safe to apply the change on 6.x too.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=petr.lancaric%40lmc.eu&quot; class=&quot;user-hover&quot; rel=&quot;petr.lancaric@lmc.eu&quot;&gt;petr.lancaric@lmc.eu&lt;/a&gt; Does the proposed solution work for you?&lt;/p&gt;</comment>
                            <comment id="13912725" author="petr.lancaric@lmc.eu" created="Wed, 26 Feb 2014 10:03:02 +0000"  >&lt;p&gt;Thank you, there is a bug:&lt;br/&gt;
	if (modified &amp;amp;&amp;amp; logger.isDebugEnabled())&lt;/p&gt;

&lt;p&gt;should be &lt;/p&gt;

&lt;p&gt;	if (modified)&lt;br/&gt;
                if(logger.isDebugEnabled())&lt;br/&gt;
....&lt;br/&gt;
otherwise switch off debuging will cause exception.&lt;/p&gt;

&lt;p&gt;Another think is, that my &quot;TODO&quot; was not processed, code will work only if setter accept List (or ArrayList or parents), but there are other collection will fail (Set e.g.). It is not an easy task to find right instance, but I recommend to put there at least comment, that code is unfinished. For my situation (ListMultipleChoice) it would work fine.&lt;/p&gt;









</comment>
                            <comment id="13912732" author="mgrigorov" created="Wed, 26 Feb 2014 10:11:09 +0000"  >&lt;p&gt;The problem has been fixed already.&lt;/p&gt;

&lt;p&gt;Another suggestion:&lt;br/&gt;
if (logger.isDebugEnabled()) 	&lt;/p&gt;
{ logger.error(...) }

&lt;p&gt;I.e. if debug is enabled then log it as an error.&lt;/p&gt;</comment>
                            <comment id="13912743" author="svenmeier" created="Wed, 26 Feb 2014 10:25:07 +0000"  >&lt;p&gt;It&apos;s not an error when the list is unmodifiable &lt;b&gt;or&lt;/b&gt; the setter fails - one of both suffices. Thus I don&apos;t think logger.error() would be correct.&lt;/p&gt;</comment>
                            <comment id="13912745" author="petr.lancaric@lmc.eu" created="Wed, 26 Feb 2014 10:26:32 +0000"  >&lt;p&gt;IMO it is not an error, as unmodifiable collection or missing setter (like in jaxb) is normal situation. It would just spam log.&lt;/p&gt;</comment>
                            <comment id="13912750" author="mgrigorov" created="Wed, 26 Feb 2014 10:35:11 +0000"  >&lt;p&gt;If DEBUG is enabled then it will be logged no matter whether .debug() or .error() is used.&lt;br/&gt;
While it is OK in this case I think it may be a bug in someone else&apos;s application. With the new silent behavior the original collection will be silently replaced with a new ArrayList and pretend that everything was OK.&lt;/p&gt;

&lt;p&gt;I still miss the idea in this improvement.&lt;br/&gt;
1) Initially the application uses unmodifiable collection as a model object.&lt;br/&gt;
2) Then either &quot;collection.clear();&quot; or &quot;collection.addAll(convertedInput);&quot; will fail and Wicket will change the type of the underlying model object to an ArrayList (or HashSet, or HashMap, or ...).&lt;br/&gt;
3) And from now on the component will use the modifiable collection and will be able to clear/addAll in the next request.&lt;br/&gt;
So after the first failure the unmodifiable collection is lost.&lt;br/&gt;
Am I right or I miss a step here ?&lt;/p&gt;</comment>
                            <comment id="13912755" author="svenmeier" created="Wed, 26 Feb 2014 10:47:33 +0000"  >&lt;p&gt;&amp;gt;I still miss the idea in this improvement.&lt;/p&gt;

&lt;p&gt;Take a look at this example:&lt;/p&gt;

&lt;p&gt;public class Foo {&lt;br/&gt;
  private List&amp;lt;Bar&amp;gt; bars = new ArrayList();&lt;/p&gt;

&lt;p&gt;  public void setBars(List&amp;lt;Bar&amp;gt; bars) &lt;/p&gt;
{
    this.bars.clear();
    this.bars.addAll(bars);

    // missing step: do something with bars
  }

&lt;p&gt;  public List&amp;lt;Bar&amp;gt; getBars() &lt;/p&gt;
{
    // prevent modification from outside
    return Collections.unmodifiableList(this.bars);
  }
&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;Yes, #getBars() could return a copy of the list, but I&apos;ve come across this pattern regularly.&lt;br/&gt;
With the proposed change it will be supported too.&lt;/p&gt;</comment>
                            <comment id="13912760" author="mgrigorov" created="Wed, 26 Feb 2014 10:54:39 +0000"  >&lt;p&gt;OK.&lt;/p&gt;</comment>
                            <comment id="13912770" author="petr.lancaric@lmc.eu" created="Wed, 26 Feb 2014 11:07:03 +0000"  >&lt;p&gt;Take a look at another  example:&lt;/p&gt;

&lt;p&gt;public class Foo &lt;/p&gt;
{
private Set&amp;lt;Bar&amp;gt; bars = new HashSet();

public void setBars(Set&amp;lt;Bar&amp;gt; bars)
{ this.bars.clear(); this.bars.addAll(bars); // missing step: do something with bars }

&lt;p&gt;public Set&amp;lt;Bar&amp;gt; getBars()&lt;/p&gt;
{ // prevent modification from outside 
return Collections.unmodifiableSet(this.bars); }
&lt;p&gt;}&lt;/p&gt;

&lt;p&gt;Result is something like ClassCastException, as Set is a Collection, but incompatible with an ArrayList.&lt;/p&gt;
</comment>
                            <comment id="13912772" author="mgrigorov" created="Wed, 26 Feb 2014 11:11:12 +0000"  >&lt;p&gt;We can add simple helper method that uses the type of the original collection to create the new one.&lt;/p&gt;</comment>
                            <comment id="13912783" author="petr.lancaric@lmc.eu" created="Wed, 26 Feb 2014 11:25:02 +0000"  >&lt;p&gt;Yes, it is a good solution working if type has public ctor taking collection  Ctor(Collection arg). It is not case of e.g. Collections.UnmodifiableCollection. I am not sure, package access could be probably overcome by reflection in this case, but generally speaking proposed solution is not working allways.&lt;/p&gt;

&lt;p&gt;SingletonImmutableList - not working, should be constructed as ImmutableList.copyof&lt;/p&gt;

&lt;p&gt;Consider the following situation: returned type is SingletonImmutableList, but we want to add another list element. So different type has to be constructed. Really not an easy task...&lt;/p&gt;</comment>
                            <comment id="13914377" author="svenmeier" created="Thu, 27 Feb 2014 10:57:09 +0000"  >&lt;p&gt;Unmodifiable lists are supported now.&lt;/p&gt;

&lt;p&gt;Further improvements for other collection types can be tracked in a separate ticket.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>375580</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 38 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1spyn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>375876</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>