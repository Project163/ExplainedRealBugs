<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:26:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[WICKET-6793] OOM in AsynchronousPageStore</title>
                <link>https://issues.apache.org/jira/browse/WICKET-6793</link>
                <project id="12310561" key="WICKET">Wicket</project>
                    <description>&lt;p&gt;After migrating to version 8.X, we face an out-of-memory issue. To clear the locked memory, the server must be restarted several times a week. &lt;br/&gt;
 After analyzing the heap dumps, we found that the vast majority of the heap is AsynchronousPageStore.entryMap. We started looking for some solutions and found a &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6629&quot; title=&quot;OOM (and disk) in AsynchronousPageStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6629&quot;&gt;&lt;del&gt;WICKET-6629&lt;/del&gt;&lt;/a&gt; error. I think this fix is &#8203;&#8203;not enough and should include removing AsynchronousPageStore.Entry also from AsynchronousPageStore.entryMap not only from AsynchronousPageStore.entries.&lt;/p&gt;

&lt;p&gt;Let me explain what I think. If StoreSettings.isAsynchronous is set to true (default option), Wicket uses AsynchronousPageStore to store the pages.&lt;/p&gt;

&lt;p&gt;AsynchronousPageStore.storePage method inserts the entry to entryMap on line 278 (version 8.7.0). If the entries are not full, entry is inserts to entries queue on line 282. &lt;br/&gt;
 Then wait until the PageSavingRunnable poll entry from queue, store it and remove it from entryMap on line 209. Now everything is fine.&lt;/p&gt;

&lt;p&gt;But what if the entry&apos;s session is unbind (expires, logout etc.), and entry was already inserted into entries and entryMap? Therefore, there is an AsynchronousPageStore.unbind method that removes all entries for the session from entries queue. But entry that has not yet been saved (in PageSavingRunnable, because it was waiting in queue) still exists and will not be removed from entryMap.&lt;/p&gt;

&lt;p&gt;When the entry is inserted into the AsynchronousPageStore.entryMap and AsynchronousPageStore.entries queue, there is only one place where the entry can be deleted from the AsynchronousPageStore.entryMap, and that is on line 209 in PageSavingRunnable.run method. But when we deleted an entry from the AsynchronousPageStore.entries, the entry in the AsynchronousPageStore.entryMap remains there, because if statment on line 205 in PageSavingRunnable.run.&lt;br/&gt;
 So now if you have thousands of users and the sites are huge, it&apos;s only a matter of time before it starts to cause a problem.&lt;/p&gt;

&lt;p&gt;I think solution is remove all entries from unbinded session from AsynchronousPageStore.entryMap.&lt;/p&gt;

&lt;p&gt;I hope that I&apos;m right.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13308313">WICKET-6793</key>
            <summary>OOM in AsynchronousPageStore</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="svenmeier">Sven Meier</assignee>
                                    <reporter username="kubinda">Vladimir Kubinda</reporter>
                        <labels>
                    </labels>
                <created>Fri, 29 May 2020 12:28:08 +0000</created>
                <updated>Thu, 4 Jun 2020 11:07:04 +0000</updated>
                            <resolved>Mon, 1 Jun 2020 13:29:52 +0000</resolved>
                                    <version>8.7.0</version>
                                    <fixVersion>9.0.0</fixVersion>
                    <fixVersion>8.9.0</fixVersion>
                                    <component>wicket-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17121011" author="jira-bot" created="Mon, 1 Jun 2020 13:22:14 +0000"  >&lt;p&gt;Commit 96c99181ac74607910795eefbb27c88a706e8f0d in wicket&apos;s branch refs/heads/master from Sven Meier&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=wicket.git;h=96c9918&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=wicket.git;h=96c9918&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6793&quot; title=&quot;OOM in AsynchronousPageStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6793&quot;&gt;&lt;del&gt;WICKET-6793&lt;/del&gt;&lt;/a&gt; remove pending from map too&lt;/p&gt;</comment>
                            <comment id="17121012" author="jira-bot" created="Mon, 1 Jun 2020 13:22:33 +0000"  >&lt;p&gt;Commit cd39538e8f4a429edcfcf4083942ff71c3b613e6 in wicket&apos;s branch refs/heads/wicket-8.x from Sven Meier&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=wicket.git;h=cd39538&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=wicket.git;h=cd39538&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6793&quot; title=&quot;OOM in AsynchronousPageStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6793&quot;&gt;&lt;del&gt;WICKET-6793&lt;/del&gt;&lt;/a&gt; moved method&lt;/p&gt;

&lt;p&gt;no functional change&lt;/p&gt;</comment>
                            <comment id="17121013" author="jira-bot" created="Mon, 1 Jun 2020 13:22:34 +0000"  >&lt;p&gt;Commit f92473660d2dd3175018fa6b484c7cd98ec023dc in wicket&apos;s branch refs/heads/wicket-8.x from Sven Meier&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=wicket.git;h=f924736&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=wicket.git;h=f924736&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6793&quot; title=&quot;OOM in AsynchronousPageStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6793&quot;&gt;&lt;del&gt;WICKET-6793&lt;/del&gt;&lt;/a&gt; remove entry from map too&lt;/p&gt;</comment>
                            <comment id="17121018" author="svenmeier" created="Mon, 1 Jun 2020 13:29:52 +0000"  >&lt;p&gt;Thanks Vladimir, your analysis was spot on!&lt;/p&gt;</comment>
                            <comment id="17125701" author="mgrigorov" created="Thu, 4 Jun 2020 08:49:38 +0000"  >&lt;p&gt;I&apos;m not sure whether it is caused by these changes but while testing Apache Tomcat and crawling Wicket Examples&apos; Library application (&lt;a href=&quot;http://localhost:8080/wicket-examples/library&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://localhost:8080/wicket-examples/library&lt;/a&gt;) I&apos;ve noticed this exception:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR - JavaSerializer             - Error serializing object &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.wicket.examples.library.EditBook [object=[Page class = org.apache.wicket.examples.library.EditBook, id = 6, render count = 1]]
org.apache.wicket.WicketRuntimeException: java.util.ConcurrentModificationException
	at org.apache.wicket.serialize.java.JavaSerializer$SerializationCheckerObjectOutputStream.writeObjectOverride(JavaSerializer.java:405)
	at java.base/java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:349)
	at org.apache.wicket.serialize.java.JavaSerializer.serialize(JavaSerializer.java:83)
	at org.apache.wicket.pageStore.SerializingPageStore.addPage(SerializingPageStore.java:80)
	at org.apache.wicket.pageStore.AsynchronousPageStore$PageAddingRunnable.run(AsynchronousPageStore.java:278)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:832)
Caused by: java.util.ConcurrentModificationException
	at java.base/java.util.ArrayList.writeObject(ArrayList.java:869)
	at java.base/jdk.internal.reflect.GeneratedMethodAccessor64.invoke(Unknown Source)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:564)
	at java.base/java.io.ObjectStreamClass.invokeWriteObject(ObjectStreamClass.java:1186)
	at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1523)
	at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1444)
	at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1187)
	at java.base/java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1579)
	at java.base/java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1536)
	at java.base/java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1444)
	at java.base/java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1187)
	at java.base/java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:353)
	at org.apache.wicket.serialize.java.JavaSerializer$SerializationCheckerObjectOutputStream.writeObjectOverride(JavaSerializer.java:371)
	... 5 more
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;Wicket-AsyncPageStore-PageSavingThread&quot;&lt;/span&gt; java.lang.IllegalArgumentException: Argument &lt;span class=&quot;code-quote&quot;&gt;&apos;data&apos;&lt;/span&gt; may not be &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;.
	at org.apache.wicket.util.lang.Args.notNull(Args.java:41)
	at org.apache.wicket.pageStore.SerializedPage.&amp;lt;init&amp;gt;(SerializedPage.java:64)
	at org.apache.wicket.pageStore.SerializingPageStore.addPage(SerializingPageStore.java:80)
	at org.apache.wicket.pageStore.AsynchronousPageStore$PageAddingRunnable.run(AsynchronousPageStore.java:278)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:832)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Wicket master branch.&lt;/p&gt;</comment>
                            <comment id="17125704" author="mgrigorov" created="Thu, 4 Jun 2020 08:51:34 +0000"  >&lt;p&gt;Actually it looks like two separate problems.&lt;/p&gt;</comment>
                            <comment id="17125830" author="svenmeier" created="Thu, 4 Jun 2020 11:07:04 +0000"  >&lt;p&gt;That looks more like &lt;a href=&quot;https://issues.apache.org/jira/browse/WICKET-6702&quot; title=&quot;AsynchronousPageStore with NotDetachedModelChecker - &amp;quot;Not detached model found&amp;quot; exception on several fast sequential Ajax calls&quot; class=&quot;issue-link&quot; data-issue-key=&quot;WICKET-6702&quot;&gt;&lt;del&gt;WICKET-6702&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 23 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fbdc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>