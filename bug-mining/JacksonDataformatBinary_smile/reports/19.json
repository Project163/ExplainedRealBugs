{"url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/issues/384","repository_url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary","labels_url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/issues/384/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/issues/384/comments","events_url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/issues/384/events","html_url":"https://github.com/FasterXML/jackson-dataformats-binary/issues/384","id":1747879827,"node_id":"I_kwDOA3Qg685oLoeT","number":384,"title":"`Smile` decoding issue with `NonBlockingByteArrayParser`, concurrency","user":{"login":"simondaudin","id":20225932,"node_id":"MDQ6VXNlcjIwMjI1OTMy","avatar_url":"https://avatars.githubusercontent.com/u/20225932?v=4","gravatar_id":"","url":"https://api.github.com/users/simondaudin","html_url":"https://github.com/simondaudin","followers_url":"https://api.github.com/users/simondaudin/followers","following_url":"https://api.github.com/users/simondaudin/following{/other_user}","gists_url":"https://api.github.com/users/simondaudin/gists{/gist_id}","starred_url":"https://api.github.com/users/simondaudin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/simondaudin/subscriptions","organizations_url":"https://api.github.com/users/simondaudin/orgs","repos_url":"https://api.github.com/users/simondaudin/repos","events_url":"https://api.github.com/users/simondaudin/events{/privacy}","received_events_url":"https://api.github.com/users/simondaudin/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":433796791,"node_id":"MDU6TGFiZWw0MzM3OTY3OTE=","url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/labels/smile","name":"smile","color":"0e8a16","default":false,"description":null},{"id":3872378314,"node_id":"LA_kwDOA3Qg687mz83K","url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/labels/has-failing-test","name":"has-failing-test","color":"4e8a16","default":false,"description":"Indicates that there exists a test case (under `failing/`) to reproduce the issue"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/milestones/52","html_url":"https://github.com/FasterXML/jackson-dataformats-binary/milestone/52","labels_url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/milestones/52/labels","id":9556680,"node_id":"MI_kwDOA3Qg684AkdLI","number":52,"title":"2.15.3","description":null,"creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":2,"state":"open","created_at":"2023-06-19T20:25:17Z","updated_at":"2023-06-19T20:25:57Z","due_on":null,"closed_at":null},"comments":4,"created_at":"2023-06-08T13:17:02Z","updated_at":"2023-06-19T20:25:57Z","closed_at":"2023-06-19T20:25:56Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi there\r\n\r\nI noticed an error when using SMILE NonBlockingByteArrayParser in an asynchronous environment (in an HTTP environment).\r\nI managed to reproduce the error in a local test and to propose a \"simple\" test that produce the error.\r\n\r\nJackson version: 2.15.2 (and before)\r\n\r\nHere is the failing test\r\n\r\n```\r\n    @Test\r\n    public void test_KO() throws IOException, ExecutionException, InterruptedException {\r\n        Map<String, Map<String, String>> tags = new HashMap<>();\r\n        for (int i = 0; i < 10; i++) {\r\n            Map<String, String> value = new HashMap<>();\r\n            for (int j = 0; j < 10; j++) {\r\n                value.put(\"key_\" + j, \"val\" + j);\r\n            }\r\n            tags.put(\"elt_\" + i, value);\r\n        }\r\n\r\n        JsonFactory jsonFactory = new SmileFactory();\r\n        ObjectMapper objectMapper = new ObjectMapper();\r\n        ObjectWriter objectWriter = objectMapper.writer().with(jsonFactory);\r\n        jsonFactory.setCodec(objectMapper);\r\n        byte[] json = objectWriter.writeValueAsBytes(tags);\r\n        TypeReference<Map<String, Map<String, String>>> typeReference = new TypeReference<Map<String, Map<String, String>>>() {\r\n        };\r\n\r\n        ExecutorService executorService = Executors.newFixedThreadPool(10);\r\n        List<CompletableFuture<?>> futures = new ArrayList<>();\r\n\r\n        int count = 100000;\r\n        for (int i = 0; i < count; i++) {\r\n            JsonParser parser = jsonFactory.createNonBlockingByteArrayParser();\r\n            ByteArrayFeeder inputFeeder = (ByteArrayFeeder) parser.getNonBlockingInputFeeder();\r\n            futures.add(CompletableFuture.supplyAsync(() -> {\r\n                try {\r\n                    inputFeeder.feedInput(json, 0, json.length);\r\n                    TokenBuffer tokenBuffer = new TokenBuffer(parser);\r\n                    while (true) {\r\n                        JsonToken token = parser.nextToken();\r\n                        if (token == JsonToken.NOT_AVAILABLE || token == null) {\r\n                            break;\r\n                        }\r\n\r\n                        tokenBuffer.copyCurrentEvent(parser);\r\n                    }\r\n                    return tokenBuffer.asParser(jsonFactory.getCodec()).readValueAs(typeReference);\r\n                } catch (IOException e) {\r\n                    throw new RuntimeException(e);\r\n                } finally {\r\n                    try {\r\n                        inputFeeder.endOfInput();\r\n                        parser.close();\r\n                    } catch (IOException e) {\r\n                        throw new RuntimeException(e);\r\n                    }\r\n                }\r\n            }, executorService));\r\n        }\r\n\r\n        CompletableFuture.allOf(futures.toArray(new CompletableFuture[futures.size()])).get();\r\n    }\r\n```\r\n\r\nHere is the error it produces\r\n```\r\njava.util.concurrent.ExecutionException: java.lang.RuntimeException: com.fasterxml.jackson.databind.JsonMappingException: (was java.lang.NullPointerException) (through reference chain: java.util.LinkedHashMap[\"elt_2\"])\r\n\r\n\tat java.base/java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:395)\r\n\tat java.base/java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1999)\r\n\tat com.liveaction.reactiff.codec.jackson.JacksonCodecTest.test_KO(JacksonCodecTest.java:74)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:59)\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:56)\r\n\tat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\r\n\tat org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306)\r\n\tat org.junit.runners.BlockJUnit4ClassRunner$1.evaluate(BlockJUnit4ClassRunner.java:100)\r\n\tat org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:366)\r\n\tat org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:103)\r\n\tat org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:63)\r\n\tat org.junit.runners.ParentRunner$4.run(ParentRunner.java:331)\r\n\tat org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:79)\r\n\tat org.junit.runners.ParentRunner.runChildren(ParentRunner.java:329)\r\n\tat org.junit.runners.ParentRunner.access$100(ParentRunner.java:66)\r\n\tat org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:293)\r\n\tat org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306)\r\n\tat org.junit.runners.ParentRunner.run(ParentRunner.java:413)\r\n\tat org.junit.runner.JUnitCore.run(JUnitCore.java:137)\r\n\tat com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:69)\r\n\tat com.intellij.rt.junit.IdeaTestRunner$Repeater$1.execute(IdeaTestRunner.java:38)\r\n\tat com.intellij.rt.execution.junit.TestsRepeater.repeat(TestsRepeater.java:11)\r\n\tat com.intellij.rt.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:35)\r\n\tat com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:232)\r\n\tat com.intellij.rt.junit.JUnitStarter.main(JUnitStarter.java:55)\r\nCaused by: java.lang.RuntimeException: com.fasterxml.jackson.databind.JsonMappingException: (was java.lang.NullPointerException) (through reference chain: java.util.LinkedHashMap[\"elt_2\"])\r\n\tat com.liveaction.reactiff.codec.jackson.JacksonCodecTest.lambda$test_KO$0(JacksonCodecTest.java:62)\r\n\tat java.base/java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1700)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n\tat java.base/java.lang.Thread.run(Thread.java:829)\r\nCaused by: com.fasterxml.jackson.databind.JsonMappingException: (was java.lang.NullPointerException) (through reference chain: java.util.LinkedHashMap[\"elt_2\"])\r\n\tat com.fasterxml.jackson.databind.JsonMappingException.wrapWithPath(JsonMappingException.java:402)\r\n\tat com.fasterxml.jackson.databind.JsonMappingException.wrapWithPath(JsonMappingException.java:361)\r\n\tat com.fasterxml.jackson.databind.deser.std.ContainerDeserializerBase.wrapAndThrow(ContainerDeserializerBase.java:190)\r\n\tat com.fasterxml.jackson.databind.deser.std.MapDeserializer._readAndBindStringKeyMap(MapDeserializer.java:638)\r\n\tat com.fasterxml.jackson.databind.deser.std.MapDeserializer.deserialize(MapDeserializer.java:449)\r\n\tat com.fasterxml.jackson.databind.deser.std.MapDeserializer.deserialize(MapDeserializer.java:32)\r\n\tat com.fasterxml.jackson.databind.deser.DefaultDeserializationContext.readRootValue(DefaultDeserializationContext.java:323)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper._readValue(ObjectMapper.java:4801)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:2999)\r\n\tat com.fasterxml.jackson.core.JsonParser.readValueAs(JsonParser.java:2396)\r\n\tat com.liveaction.reactiff.codec.jackson.JacksonCodecTest.lambda$test_KO$0(JacksonCodecTest.java:60)\r\n\t... 4 more\r\nCaused by: java.lang.NullPointerException\r\n\tat com.fasterxml.jackson.databind.util.TokenBuffer$Parser.nextFieldName(TokenBuffer.java:1677)\r\n\tat com.fasterxml.jackson.databind.deser.std.MapDeserializer._readAndBindStringKeyMap(MapDeserializer.java:608)\r\n\tat com.fasterxml.jackson.databind.deser.std.MapDeserializer.deserialize(MapDeserializer.java:449)\r\n\tat com.fasterxml.jackson.databind.deser.std.MapDeserializer.deserialize(MapDeserializer.java:32)\r\n\tat com.fasterxml.jackson.databind.deser.std.MapDeserializer._readAndBindStringKeyMap(MapDeserializer.java:623)\r\n\t... 11 more\r\n```\r\n    \r\nI noticed 3 things:\r\n* Replace `SmileFactore` by `JsonFactory` -> no error\r\n* Put the following 2 lines inside the `supplyAsync` (so same thread) -> no error\r\n```\r\nJsonParser parser = jsonFactory.createNonBlockingByteArrayParser();\r\nByteArrayFeeder inputFeeder = (ByteArrayFeeder) parser.getNonBlockingInputFeeder();\r\n ```\r\n * with a single thread `ExecutorService executorService = Executors.newFixedThreadPool(1);` -> no error\r\n \r\nI didn't take the time to track deep in jackson, but it seemed that there was some trouble with the `seenNames` being empty when it should not have been.\r\nI don't know if maybe it should not be used this way or if it is a legit error.\r\n\r\nThanks","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/issues/384/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/jackson-dataformats-binary/issues/384/timeline","performed_via_github_app":null,"state_reason":"completed"}