<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:13:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[JXPATH-152] Concurrent access on hashmap of JXPathIntrospector</title>
                <link>https://issues.apache.org/jira/browse/JXPATH-152</link>
                <project id="12310480" key="JXPATH">Commons JXPath</project>
                    <description>&lt;p&gt;JXPathIntrospector.registerDynamicClass method can be called in static part of classes. &lt;br/&gt;
If two classes A &amp;amp; B try to registerDynamicClass in the same time a concurrent access exception can append on hashmap of JXPathIntrospector.&lt;/p&gt;

&lt;p&gt;Replace hashmap by concurrent hashmap or synchronized access to these hashmaps.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Java5, Windows/AIX&lt;/p&gt;</environment>
        <key id="12518572">JXPATH-152</key>
            <summary>Concurrent access on hashmap of JXPathIntrospector</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mbenson">Matthew Jason Benson</assignee>
                                    <reporter username="pleutre">pleutre</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Aug 2011 09:27:11 +0000</created>
                <updated>Sat, 4 Jul 2015 18:13:55 +0000</updated>
                            <resolved>Fri, 24 Feb 2012 20:56:07 +0000</resolved>
                                    <version>1.3</version>
                                    <fixVersion>1.4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="86400">24h</timeoriginalestimate>
                            <timeestimate seconds="86400">24h</timeestimate>
                                        <comments>
                            <comment id="13214456" author="taromaru" created="Thu, 23 Feb 2012 08:34:44 +0000"  >&lt;p&gt;I think that this issue is a critical bug.&lt;/p&gt;

&lt;p&gt;For example,&lt;br/&gt;
if the following code(an ordinary code) is executed in a multithread environment,&lt;br/&gt;
all threads hang-up(infinity loop) occurs in the worst case.&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;JXPathContext context = JXPathContext.newContext(target);&lt;br/&gt;
Iterator ite = context.iteratePointers(requestXpath);&lt;br/&gt;
while (ite.hasNext()) {&lt;br/&gt;
    Pointer p = (Pointer) ite.next();&lt;br/&gt;
    ...&lt;br/&gt;
}&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;Thread-1 use JXPathContext instance-1.&lt;br/&gt;
Thread-2 use JXPathContext instance-2.&lt;/p&gt;

&lt;p&gt;However,&lt;br/&gt;
Thread-1 and Thread-2 may execute&lt;br/&gt;
JXPathIntrospector#getBeanInfo (static method)&lt;br/&gt;
concurrently.&lt;/p&gt;

&lt;p&gt;JXPathIntrospector#getBeanInfo execute&lt;br/&gt;
&quot;byClass.put(beanClass, beanInfo);&quot;.&lt;br/&gt;
(&quot;byClass&quot; is HashMap in static field)&lt;/p&gt;

&lt;p&gt;That is,&lt;br/&gt;
Thread-1 and Thread-2 may execute&lt;br/&gt;
HashMap#put concurrently.&lt;/p&gt;

&lt;p&gt;Thread-1 and Thread-2 use same HashMap instance (in static field).&lt;/p&gt;

&lt;p&gt;In the worst case,&lt;br/&gt;
Thread-1 and Thread-2 expand HashMap capacity concurrently.&lt;br/&gt;
Then, the structure of HashMap is broken.&lt;/p&gt;

&lt;p&gt;If a thread use broken HashMap&apos;s method(get, put, etc...),&lt;br/&gt;
the thread execute infinity loop in HashMap.&lt;/p&gt;

&lt;p&gt;If HashMap(byClass) is broken,&lt;br/&gt;
Thread-1 use JXPathContext ... infinity loop&lt;br/&gt;
Thread-2 use JXPathContext ... infinity loop&lt;br/&gt;
Thread-3 use JXPathContext ... infinity loop&lt;br/&gt;
...&lt;br/&gt;
As a result, all threads hang-up(infinity loop).&lt;/p&gt;</comment>
                            <comment id="13215899" author="mbenson" created="Fri, 24 Feb 2012 20:56:07 +0000"  >&lt;p&gt;It would seem that synchronizing each &lt;tt&gt;HashMap#put()&lt;/tt&gt; call against the target map would defend against the worst-case scenarios you suggest.  Thanks for the report!&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Committed revision 1293412.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="13220937" author="taromaru" created="Fri, 2 Mar 2012 14:07:58 +0000"  >&lt;p&gt;Collections.synchronizedMap is thread safe method.&lt;/p&gt;

&lt;p&gt;However, since these HashMap are referred to frequently,&lt;br/&gt;
it becomes a bottleneck by the method of synchronizedMap&apos;s lock&lt;br/&gt;
in a multi-core CPU (or multi CPU) environment.&lt;/p&gt;


&lt;p&gt;I recommend correcting by one of the following methods.&lt;br/&gt;
These methods can perform Map#get concurrently.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Since byInterface resembles byClass, byInterface omits.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Before correction: (Before #1293412 modification.)&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;private static HashMap byClass = new HashMap();&lt;br/&gt;
...&lt;br/&gt;
byClass.put(...);&lt;br/&gt;
...&lt;br/&gt;
beanInfo = (JXPathBeanInfo) byClass.get(...);&lt;/p&gt;
&lt;hr /&gt;


&lt;p&gt;correction method 1: (Easy)&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;private static Map byClass = ConcurrentHashMap();&lt;br/&gt;
...&lt;br/&gt;
byClass.put(...);&lt;br/&gt;
...&lt;br/&gt;
beanInfo = (JXPathBeanInfo) byClass.get(...);&lt;/p&gt;
&lt;hr /&gt;
&lt;ul&gt;
	&lt;li&gt;ConcurrentHashMap : java.util.concurrent.ConcurrentHashMap (JDK5 or later)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The feature of the method 1:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Unlike JXPath-1.3, required JDK5 or later.&lt;/li&gt;
	&lt;li&gt;Unlike JXPath-1.3, if key or value is null, NullPointerException occur.&lt;br/&gt;
(If you maintain the compatibility when key or value is null value, please see method 2.)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;correction method 2: (Specification is full compatible)&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;private static HashMap byClass = new HashMap();&lt;br/&gt;
private static final ReentrantReadWriteLock byClassReadWriteLock = new ReentrantReadWriteLock();&lt;br/&gt;
private static final Lock byClassReadLock = byClassReadWriteLock.readLock();&lt;br/&gt;
private static final Lock byClassWriteLock = byClassReadWriteLock.writeLock();&lt;br/&gt;
...&lt;br/&gt;
byClassWriteLock.lock();&lt;br/&gt;
try {&lt;br/&gt;
    byClass.put(...);&lt;br/&gt;
} finally {&lt;br/&gt;
    byClassWriteLock.unlock();&lt;br/&gt;
}&lt;br/&gt;
...&lt;br/&gt;
byClassReadLock.lock();&lt;br/&gt;
try {&lt;br/&gt;
    beanInfo = (JXPathBeanInfo) byClass.get(...);&lt;br/&gt;
} finally {&lt;br/&gt;
    byClassReadLock.unlock();&lt;br/&gt;
}&lt;/p&gt;
&lt;hr /&gt;
&lt;ul&gt;
	&lt;li&gt;ReentrantReadWriteLock : java.util.concurrent.locks.ReentrantReadWriteLock (JDK5 or later)&lt;/li&gt;
	&lt;li&gt;Lock : java.util.concurrent.locks.Lock (JDK5 or later)&lt;br/&gt;
please see&lt;br/&gt;
&lt;a href=&quot;http://docs.oracle.com/javase/1.5.0/docs/api/java/util/concurrent/locks/ReentrantReadWriteLock.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/1.5.0/docs/api/java/util/concurrent/locks/ReentrantReadWriteLock.html&lt;/a&gt;&lt;br/&gt;
&quot;RWDictionary&quot; example.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The feature of the method 2:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Unlike JXPath-1.3, required JDK5 or later.&lt;/li&gt;
	&lt;li&gt;Like JXPath-1.3, null can be used for key or value.&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;correction method 3: (JDK1.3 compatible. but contrary to usage.)&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;private static HashMap byClass = new HashMap();&lt;br/&gt;
...&lt;br/&gt;
synchronized (byClass) {&lt;br/&gt;
    byClass.put(...);&lt;br/&gt;
}&lt;br/&gt;
...&lt;br/&gt;
beanInfo = (JXPathBeanInfo) byClass.get(...);&lt;br/&gt;
if (beanInfo == null) { // not mapping, null mapping, or when byClass is being expanded.&lt;br/&gt;
    synchronized (byClass) &lt;/p&gt;
{
        beanInfo = (JXPathBeanInfo) byClass.get(...);
    }
&lt;p&gt;}&lt;/p&gt;
&lt;hr /&gt;
&lt;ul&gt;
	&lt;li&gt;Although it is contrary to usage,&lt;br/&gt;
   this method can be used if it is java.util.HashMap,&lt;br/&gt;
   using method are &quot;put&quot; &quot;get&quot; only.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(At least in the case of Sun(Oracle) JDK.)&lt;/p&gt;

&lt;p&gt;The feature of the method 3:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Like JXPath-1.3, JDK1.3 compatible.&lt;/li&gt;
	&lt;li&gt;Like JXPath-1.3, null can be used for key or value.&lt;/li&gt;
	&lt;li&gt;It is contrary to the following description of HashMap&apos;s API document.&lt;br/&gt;
&quot;If multiple threads access this map concurrently,&lt;br/&gt;
and at least one of the threads modifies the map structurally,&lt;br/&gt;
it must be synchronized externally.&quot;&lt;br/&gt;
(&lt;a href=&quot;http://docs.oracle.com/javase/1.5.0/docs/api/java/util/HashMap.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/1.5.0/docs/api/java/util/HashMap.html&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13257293" author="taromaru" created="Thu, 19 Apr 2012 06:23:14 +0000"  >&lt;p&gt;&amp;gt; correction method 3: (JDK1.3 compatible. but contrary to usage.)&lt;br/&gt;
Sorry, it has problem.&lt;br/&gt;
ArrayIndexOutOfBoundsException may occur.&lt;/p&gt;

&lt;p&gt;The problem did not occur in the case of Sun(Oracle) JDK5.&lt;br/&gt;
result of get method:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;return null&lt;/li&gt;
	&lt;li&gt;return value object&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;But, the problem occured in the case of Sun(Oracle) JDK6.&lt;br/&gt;
result of get method:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;return null&lt;/li&gt;
	&lt;li&gt;return value object&lt;/li&gt;
	&lt;li&gt;throw ArrayIndexOutOfBoundsException&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14607553" author="ndipiazza" created="Tue, 30 Jun 2015 06:02:13 +0000"  >&lt;p&gt;Does this issue affect 1.2 release of commons-jxpath library as well? &lt;/p&gt;

&lt;p&gt;I am calling org.apache.commons.jxpath.CompiledExpression.getValue(JXPathContext) and I too am seeing hundreds of threads stuck trying to get JXPathIntrospector.getBeanInfo.&lt;/p&gt;

&lt;p&gt;I notice only 1.3 is available from the website. When is 1.4 available to the public? &lt;/p&gt;

&lt;p&gt;293 threads with trace:&lt;br/&gt;
States: &lt;/p&gt;
{RUNNABLE=293}
&lt;p&gt;Stack:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;java.util.HashMap.getEntry(HashMap.java:465)&lt;/li&gt;
	&lt;li&gt;java.util.HashMap.get(HashMap.java:417)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.JXPathIntrospector.getBeanInfo(JXPathIntrospector.java:101)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.model.dynamic.DynamicPointerFactory.createNodePointer(DynamicPointerFactory.java:67)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.model.NodePointer.newChildNodePointer(NodePointer.java:90)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.model.beans.PropertyPointer.getImmediateValuePointer(PropertyPointer.java:127)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.model.NodePointer.getValuePointer(NodePointer.java:238)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.model.beans.PropertyIterator.getNodePointer(PropertyIterator.java:108)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.axes.ChildContext.getCurrentNodePointer(ChildContext.java:56)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.axes.InitialContext.&amp;lt;init&amp;gt;(InitialContext.java:39)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.compiler.LocationPath.compute(LocationPath.java:67)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.compiler.CoreOperationCompare.equal(CoreOperationCompare.java:49)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.compiler.CoreOperationEqual.computeValue(CoreOperationEqual.java:33)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.axes.PredicateContext.nextNode(PredicateContext.java:81)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.EvalContext.nextSet(EvalContext.java:322)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.axes.ChildContext.getSingleNodePointer(ChildContext.java:72)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.compiler.Path.searchForPath(Path.java:183)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.compiler.Path.getSingleNodePointerForSteps(Path.java:159)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.compiler.LocationPath.computeValue(LocationPath.java:82)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.JXPathContextReferenceImpl.getValue(JXPathContextReferenceImpl.java:314)&lt;/li&gt;
	&lt;li&gt;org.apache.commons.jxpath.ri.JXPathCompiledExpression.getValue(JXPathCompiledExpression.java:57)&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="14613991" author="vivodamichele@hotmail.com" created="Sat, 4 Jul 2015 18:13:55 +0000"  >&lt;p&gt;1.4 snapshot is here &lt;a href=&quot;https://github.com/apache/commons-jxpath&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-jxpath&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>65481</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 20 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0xqmn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>194951</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>