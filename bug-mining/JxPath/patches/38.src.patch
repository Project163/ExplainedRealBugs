diff --git a/pom.xml b/pom.xml
index 93ac38a7..e619d6d8 100644
--- a/pom.xml
+++ b/pom.xml
@@ -161,6 +161,22 @@ under the License.
       <optional>true</optional>
       <scope>runtime</scope>
     </dependency>
+    <dependency>
+      <groupId>com.mockrunner</groupId>
+      <artifactId>mockrunner-jdk1.3-j2ee1.3</artifactId>
+      <version>0.4</version>
+      <scope>test</scope>
+      <exclusions>
+        <exclusion>
+          <groupId>cglib-nodep</groupId>
+          <artifactId>cglib-nodep</artifactId>
+        </exclusion>
+        <exclusion>
+          <groupId>jboss</groupId>
+          <artifactId>jboss-jee</artifactId>
+        </exclusion>
+      </exclusions>
+    </dependency>
   </dependencies>
   <reporting>
     <plugins>
diff --git a/src/java/org/apache/commons/jxpath/servlet/ServletRequestHandler.java b/src/java/org/apache/commons/jxpath/servlet/ServletRequestHandler.java
index 5a686407..6b328486 100644
--- a/src/java/org/apache/commons/jxpath/servlet/ServletRequestHandler.java
+++ b/src/java/org/apache/commons/jxpath/servlet/ServletRequestHandler.java
@@ -16,7 +16,6 @@
  */
 package org.apache.commons.jxpath.servlet;
 
-import java.util.Arrays;
 import java.util.Enumeration;
 import java.util.HashSet;
 import javax.servlet.ServletRequest;
@@ -69,6 +68,6 @@ public class ServletRequestHandler extends HttpSessionHandler {
     }
 
     public void setProperty(Object request, String property, Object value) {
-        ((ServletRequest) request).setAttribute(property, value);
+        ((ServletRequestAndContext) request).getServletRequest().setAttribute(property, value);
     }
 }
diff --git a/src/test-webapp/JXPathServletContextsTestServlet.java b/src/test-webapp/JXPathServletContextsTestServlet.java
deleted file mode 100644
index cfedaaa4..00000000
--- a/src/test-webapp/JXPathServletContextsTestServlet.java
+++ /dev/null
@@ -1,140 +0,0 @@
-/*
- * Licensed to the Apache Software Foundation (ASF) under one or more
- * contributor license agreements.  See the NOTICE file distributed with
- * this work for additional information regarding copyright ownership.
- * The ASF licenses this file to You under the Apache License, Version 2.0
- * (the "License"); you may not use this file except in compliance with
- * the License.  You may obtain a copy of the License at
- *
- *     http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-import java.io.IOException;
-import java.io.PrintWriter;
-
-import javax.servlet.ServletContext;
-import javax.servlet.ServletException;
-import javax.servlet.http.HttpServlet;
-import javax.servlet.http.HttpServletRequest;
-import javax.servlet.http.HttpServletResponse;
-import javax.servlet.http.HttpSession;
-
-import org.apache.commons.jxpath.JXPathContext;
-import org.apache.commons.jxpath.servlet.JXPathServletContexts;
-
-/**
- * Invoke like this: http://localhost:8080/jxpath?parm=OK
- * 
- * @version $Revision$ $Date$
- */
-public class JXPathServletContextsTestServlet extends HttpServlet {
-
-    public void doGet(HttpServletRequest request, HttpServletResponse response)
-    throws IOException, ServletException
-    {
-        ServletContext servletContext = getServletContext();
-        servletContext.setAttribute("app", "OK");
-        JXPathContext appContext = JXPathServletContexts
-                .getApplicationContext(servletContext);
-        
-        request.setAttribute("attr", "OK");
-        JXPathContext reqContext = JXPathServletContexts.getRequestContext(
-                request,
-                servletContext);
-                
-        HttpSession session = request.getSession();
-        Integer count = (Integer) session.getAttribute("count");
-        if (count == null) {
-            count = new Integer(0);
-        }
-        else {
-            count = new Integer(count.intValue() + 1);
-        }
-        session.setAttribute("count", count);
-        
-        JXPathContext sessionContext = JXPathServletContexts.getSessionContext(
-                session,
-                servletContext);
-        
-        response.setContentType("text/html");
-        PrintWriter out = response.getWriter();
-        out.println("<html>");
-        out.println("<head>");
-        out.println("<title>JXPathServletContext</title>");
-        out.println("</head>");
-        out.println("<body>");
-        out.println("<h1>JXPathServletContexts Servlet Context Test</h1>");
-        assertEqual(
-                out,
-                "Application Context",
-                appContext.getValue("app"),
-                "OK");
-        assertEqual(
-                out,
-                "Request Context Attribute",
-                reqContext.getValue("attr"),
-                "OK");
-        assertEqual(
-                out,
-                "Request Context Attribute",
-                reqContext.getValue("attr"),
-                "OK");
-        
-        if (request.getParameter("parm") == null) {
-            out.println("<p><b>Invoke this test servlet like this: "
-                    + "http://localhost:8080/jxpath-war/jxpath?parm=OK<b>");
-        }
-        else {
-            assertEqual(
-                    out,
-                    "Request Context Parameter",
-                    reqContext.getValue("parm"),
-                    "OK");
-        }
-        assertEqual(
-                out,
-                "Session Context Parameter (reload for actual test)",
-                sessionContext.getValue("count"),
-                count);
-        assertEqual(
-                out,
-                "Application Context via Request Context",
-                reqContext.getValue("app"),
-                "OK");
-        assertEqual(
-                out,
-                "Session Context via Request Context",
-                reqContext.getValue("count"),
-                count);
-        assertEqual(
-                out,
-                "Application Context via Session Context",
-                sessionContext.getValue("app"),
-                "OK");
-        
-        out.println("</body>");
-        out.println("</html>");
-    }
-
-    private void assertEqual(
-            PrintWriter out,
-            String title,
-            Object actual,
-            Object expected) 
-    {
-        if ((actual == null && expected == null)
-                || (actual != null && actual.equals(expected))) {
-            out.println("<p>" + title + ": Ok");
-        }
-        else {
-            out.println("<p><font color=red>" + title + ": Failure</font>");
-        }
-    }
-}
-
diff --git a/src/test-webapp/JXPathTest.jsp b/src/test-webapp/JXPathTest.jsp
deleted file mode 100644
index fa00118d..00000000
--- a/src/test-webapp/JXPathTest.jsp
+++ /dev/null
@@ -1,64 +0,0 @@
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-  contributor license agreements.  See the NOTICE file distributed with
-  this work for additional information regarding copyright ownership.
-  The ASF licenses this file to You under the Apache License, Version 2.0
-  (the "License"); you may not use this file except in compliance with
-  the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<%@ page language="java" %>
-<%@ page import="org.apache.commons.jxpath.JXPathContext" %>
-<%@ page import="org.apache.commons.jxpath.servlet.JXPathServletContexts" %>
-
-<%!
-    private String assertEqual(
-            String title,
-            Object actual,
-            Object expected) 
-    {
-        if ((actual == null && expected == null)
-                || (actual != null && actual.equals(expected))) {
-            return "<p>" + title + ": Ok";
-        }
-        else {
-            return "<p><font color=red>" + title + ": Failure</font>";
-        }
-    }
-%>
-
-<html>
-<head>
- <title>JXPathServletContext</title>
-</head>
-<body>
-  <%
-    pageContext.setAttribute("page", "page");
-    pageContext.getServletContext().setAttribute("app", "app");
-    request.setAttribute("request", "request");
-    session.setAttribute("session", "session");
-
-    JXPathContext context = JXPathServletContexts.getPageContext(pageContext); 
-    context.setLenient(true);
-  %>
-  <h1>JXPathServletContexts JSP PageContext Context Test</h1>
-
-  <%= assertEqual("Page Scope", context.getValue("page"), "page") %>
-  <%= assertEqual("Request Scope", context.getValue("request"), "request") %>
-  <%= assertEqual("Session Scope", context.getValue("session"), "session") %>
-  <%= assertEqual("Application Scope", context.getValue("app"), "app") %>
-  <%= assertEqual("Explicit Page Scope", context.getValue("$page/page"), "page") %>
-  <%= assertEqual("Explicit Request Scope", context.getValue("$request/request"), "request") %>
-  <%= assertEqual("Explicit Session Scope", context.getValue("$session/session"), "session") %>
-  <%= assertEqual("Explicit Application Scope", context.getValue("$application/app"), "app") %>
-
-  <jsp:include page="jxpath?parm=OK"/>
- </body>
-</html>
\ No newline at end of file
diff --git a/src/test-webapp/WEB-INF/web.xml b/src/test-webapp/WEB-INF/web.xml
deleted file mode 100644
index 37e9e71a..00000000
--- a/src/test-webapp/WEB-INF/web.xml
+++ /dev/null
@@ -1,37 +0,0 @@
-<?xml version="1.0" encoding="ISO-8859-1"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-  contributor license agreements.  See the NOTICE file distributed with
-  this work for additional information regarding copyright ownership.
-  The ASF licenses this file to You under the Apache License, Version 2.0
-  (the "License"); you may not use this file except in compliance with
-  the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-
-<!DOCTYPE web-app
-    PUBLIC "-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"
-    "http://java.sun.com/dtd/web-app_2_3.dtd">
-
-<web-app>
-
-    <display-name>JXPathServletContextsTest</display-name>
-
-    <servlet>
-        <servlet-name>jxpath</servlet-name>
-        <servlet-class>JXPathServletContextsTestServlet</servlet-class>
-    </servlet>
-
-    <servlet-mapping>
-        <servlet-name>jxpath</servlet-name>
-        <url-pattern>/jxpath</url-pattern>
-    </servlet-mapping>
-
-</web-app>
diff --git a/src/test/org/apache/commons/jxpath/servlet/JXPathServletContextTest.java b/src/test/org/apache/commons/jxpath/servlet/JXPathServletContextTest.java
new file mode 100644
index 00000000..38d0e894
--- /dev/null
+++ b/src/test/org/apache/commons/jxpath/servlet/JXPathServletContextTest.java
@@ -0,0 +1,188 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.commons.jxpath.servlet;
+
+import java.util.Iterator;
+import javax.servlet.ServletContext;
+
+import org.apache.commons.jxpath.JXPathContext;
+import org.apache.commons.jxpath.Pointer;
+import org.apache.commons.jxpath.Variables;
+
+import com.mockrunner.mock.web.MockHttpServletRequest;
+import com.mockrunner.mock.web.MockHttpSession;
+import com.mockrunner.mock.web.MockPageContext;
+import com.mockrunner.mock.web.MockServletConfig;
+import com.mockrunner.mock.web.MockServletContext;
+import junit.framework.TestCase;
+
+/**
+ * @author Emmanuel Bourg
+ * @version $Revision$, $Date$
+ */
+public class JXPathServletContextTest extends TestCase {
+
+    private ServletContext getServletContext() {
+        MockServletContext context = new MockServletContext();
+        context.setAttribute("app", "OK");
+
+        return context;
+    }
+    
+    public void testServletContext() {
+        ServletContext context = getServletContext();
+        JXPathContext appContext = JXPathServletContexts.getApplicationContext(context);
+
+        assertSame("Cached context not property returned", appContext, JXPathServletContexts.getApplicationContext(context));
+
+        assertEquals("Application Context", "OK", appContext.getValue("app"));
+
+        checkPointerIterator(appContext);
+
+        // test setting a value in the context
+        appContext.setValue("/foo", "bar");
+        assertEquals("Context property", "bar", appContext.getValue("/foo"));
+
+        // test the variables
+        Variables variables = appContext.getVariables();
+        assertNotNull("$application variable", variables.getVariable("application"));
+        assertNull("$foo variable", variables.getVariable("$foo"));
+    }
+
+    public void testServletRequest() {
+        ServletContext context = getServletContext();
+
+        MockHttpSession session = new MockHttpSession();
+        session.setupServletContext(context);
+        session.setUpIsNew(true);
+        Integer count = new Integer(10);
+        session.setAttribute("count", count);
+
+        MockHttpServletRequest request = new MockHttpServletRequest();
+        request.setSession(session);
+        request.setAttribute("attr", "OK");
+        request.setupAddParameter("parm", "OK");
+        request.setupAddParameter("multiparam", new String[] { "value1", "value2" });
+        request.setupAddParameter("emptyparam", new String[0]);
+
+        assertSame("Request session", session, request.getSession());
+
+        JXPathContext reqContext = JXPathServletContexts.getRequestContext(request, context);
+
+        assertSame("Cached context not property returned", reqContext, JXPathServletContexts.getRequestContext(request, context));
+
+        JXPathContext sessionContext = JXPathServletContexts.getSessionContext(session, context);
+
+        assertSame("Cached context not property returned", sessionContext, JXPathServletContexts.getSessionContext(session, context));
+
+        assertEquals("Request Context Attribute", "OK", reqContext.getValue("attr"));
+
+        assertEquals("Request Context Parameter", "OK", reqContext.getValue("parm"));
+        assertTrue("Request Context Parameter (Array)", reqContext.getValue("multiparam").getClass().isArray());
+        assertEquals("Request Context Parameter (Empty)", null, reqContext.getValue("emptyparam"));
+
+        assertEquals("Session Context Parameter", count, sessionContext.getValue("count"));
+        assertEquals("Application Context via Request Context", "OK", reqContext.getValue("app"));
+        assertEquals("Session Context via Request Context", count, reqContext.getValue("count"));
+        assertEquals("Application Context via Session Context", "OK", sessionContext.getValue("app"));
+
+        checkPointerIterator(reqContext);
+        checkPointerIterator(sessionContext);
+
+        // test setting a value in the context
+        reqContext.setValue("/foo1", "bar1");
+        assertEquals("Context property", "bar1", reqContext.getValue("/foo1"));
+
+        sessionContext.setValue("/foo2", "bar2");
+        assertEquals("Context property", "bar2", sessionContext.getValue("/foo2"));
+    }
+
+    public void testServletRequestWithoutSession() {
+        ServletContext context = getServletContext();
+
+        MockHttpServletRequest request = new MockHttpServletRequest();
+
+        JXPathContext reqContext = JXPathServletContexts.getRequestContext(request, context);
+
+        assertEquals("Application Context via Request Context", "OK", reqContext.getValue("app"));
+    }
+
+    private void checkPointerIterator(JXPathContext context) {
+        Iterator it = context.iteratePointers("/*");
+        assertTrue("Empty context", it.hasNext());
+        while (it.hasNext())
+        {
+            Pointer pointer = (Pointer) it.next();
+            assertNotNull("null pointer", pointer);
+            assertNotNull("null path", pointer.asPath());
+        }
+    }
+
+    public void testPageContext() {
+        MockServletContext servletContext = new MockServletContext();
+        servletContext.setAttribute("app", "app");
+
+        MockServletConfig servletConfig = new MockServletConfig();
+        servletConfig.setServletContext(servletContext);
+
+        MockHttpSession session = new MockHttpSession();
+        session.setupServletContext(servletContext);
+        session.setAttribute("session", "session");
+
+        MockHttpServletRequest request = new MockHttpServletRequest();
+        request.setAttribute("request", "request");
+        request.setSession(session);
+
+        MockPageContext pageContext = new MockPageContext();
+        pageContext.setServletConfig(servletConfig);
+        pageContext.setServletRequest(request);
+        pageContext.setAttribute("page", "page");
+
+        assertSame("Request session", session, request.getSession());
+
+
+        JXPathContext context = JXPathServletContexts.getPageContext(pageContext);
+        context.setLenient(true);
+        
+        checkPointerIterator(context);
+
+        assertEquals("Page Scope", "page", context.getValue("page"));
+        assertEquals("Request Scope", "request", context.getValue("request"));
+        assertEquals("Session Scope", "session", context.getValue("session"));
+        assertEquals("Application Scope", "app", context.getValue("app"));
+
+        assertEquals("Explicit Page Scope", "page", context.getValue("$page/page"));
+        assertEquals("Explicit Request Scope", "request", context.getValue("$request/request"));
+        assertEquals("Explicit Session Scope", "session", context.getValue("$session/session"));
+        assertEquals("Explicit Application Scope", "app", context.getValue("$application/app"));
+
+        // iterate through the elements of page context only (two elements expected, 'page' and the context)
+        Iterator it = context.iteratePointers("$page/*");
+        assertTrue("element not found", it.hasNext());
+        it.next();
+        it.next();
+        assertFalse("too many elements", it.hasNext());
+
+        // test setting a value in the context
+        context.setValue("/foo1", "bar1");
+        assertEquals("Context property", "bar1", context.getValue("/foo1"));
+
+        context.setValue("$page/foo2", "bar2");
+        assertEquals("Context property", "bar2", context.getValue("$page/foo2"));
+    }
+}
