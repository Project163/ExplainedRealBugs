diff --git a/src/java/org/apache/commons/jxpath/ri/model/dom/DOMAttributeIterator.java b/src/java/org/apache/commons/jxpath/ri/model/dom/DOMAttributeIterator.java
index f4c2ac6b..f9785f64 100644
--- a/src/java/org/apache/commons/jxpath/ri/model/dom/DOMAttributeIterator.java
+++ b/src/java/org/apache/commons/jxpath/ri/model/dom/DOMAttributeIterator.java
@@ -19,6 +19,7 @@ package org.apache.commons.jxpath.ri.model.dom;
 import java.util.ArrayList;
 import java.util.List;
 
+import org.apache.commons.jxpath.ri.NamespaceResolver;
 import org.apache.commons.jxpath.ri.QName;
 import org.apache.commons.jxpath.ri.model.NodeIterator;
 import org.apache.commons.jxpath.ri.model.NodePointer;
@@ -108,7 +109,9 @@ public class DOMAttributeIterator implements NodeIterator {
         String testNS = null;
 
         if (testPrefix != null) {
-            testNS = parent.getNamespaceURI(testPrefix);
+            NamespaceResolver nsr = parent.getNamespaceResolver();
+            testNS = nsr == null ? null : nsr.getNamespaceURI(testPrefix);
+            testNS = testNS == null ? parent.getNamespaceURI(testPrefix) : testNS;
         }
 
         if (testNS != null) {
diff --git a/src/java/org/apache/commons/jxpath/ri/model/jdom/JDOMAttributeIterator.java b/src/java/org/apache/commons/jxpath/ri/model/jdom/JDOMAttributeIterator.java
index bd4df5de..84c0afd3 100644
--- a/src/java/org/apache/commons/jxpath/ri/model/jdom/JDOMAttributeIterator.java
+++ b/src/java/org/apache/commons/jxpath/ri/model/jdom/JDOMAttributeIterator.java
@@ -20,6 +20,7 @@ import java.util.ArrayList;
 import java.util.Collections;
 import java.util.List;
 
+import org.apache.commons.jxpath.ri.NamespaceResolver;
 import org.apache.commons.jxpath.ri.QName;
 import org.apache.commons.jxpath.ri.model.NodeIterator;
 import org.apache.commons.jxpath.ri.model.NodePointer;
@@ -43,17 +44,26 @@ public class JDOMAttributeIterator implements NodeIterator {
         if (parent.getNode() instanceof Element) {
             Element element = (Element) parent.getNode();
             String prefix = name.getPrefix();
-            Namespace ns;
+            Namespace ns = null;
             if (prefix != null) {
                 if (prefix.equals("xml")) {
                     ns = Namespace.XML_NAMESPACE;
                 }
                 else {
-                    ns = element.getNamespace(prefix);
+                    NamespaceResolver nsr = parent.getNamespaceResolver();
+                    if (nsr != null) {
+                        String uri = nsr.getNamespaceURI(prefix);
+                        if (uri != null) {
+                            ns = Namespace.getNamespace(prefix, uri);
+                        }
+                    }
                     if (ns == null) {
-                        // TBD: no attributes
-                        attributes = Collections.EMPTY_LIST;
-                        return;
+                        ns = element.getNamespace(prefix);
+                        if (ns == null) {
+                            // TBD: no attributes
+                            attributes = Collections.EMPTY_LIST;
+                            return;
+                        }
                     }
                 }
             }
diff --git a/src/test/org/apache/commons/jxpath/ri/model/XMLModelTestCase.java b/src/test/org/apache/commons/jxpath/ri/model/XMLModelTestCase.java
index e5d89574..6691ed58 100644
--- a/src/test/org/apache/commons/jxpath/ri/model/XMLModelTestCase.java
+++ b/src/test/org/apache/commons/jxpath/ri/model/XMLModelTestCase.java
@@ -797,6 +797,15 @@ public abstract class XMLModelTestCase extends JXPathTestCase {
                 "count(vendor/product/rate:*)", 
                 new Double(2));
 
+        assertXPathValue(context,
+                "vendor[1]/product[1]/rate:amount[1]/@rate:discount", "10%");
+        assertXPathValue(context,
+                "vendor[1]/product[1]/rate:amount[1]/@price:discount", "10%");
+        assertXPathValue(context,
+                "vendor[1]/product[1]/price:amount[1]/@rate:discount", "10%");
+        assertXPathValue(context,
+                "vendor[1]/product[1]/price:amount[1]/@price:discount", "10%");
+
         // Preference for externally registered namespace prefix
         assertXPathValueAndPointer(context,
                 "//product:name",
