diff --git a/pom.xml b/pom.xml
index 0e59cb3..a293791 100644
--- a/pom.xml
+++ b/pom.xml
@@ -79,6 +79,10 @@
 			<groupId>org.apache.maven</groupId>
 			<artifactId>maven-plugin-api</artifactId>
 		</dependency>
+        <dependency>
+            <groupId>org.apache.maven.shared</groupId>
+            <artifactId>maven-runtime</artifactId>
+        </dependency>
 		<dependency>
 			<groupId>org.apache.maven.plugin-tools</groupId>
 			<artifactId>maven-plugin-annotations</artifactId>
@@ -91,10 +95,6 @@
 			<version>1.3</version>
 			<scope>test</scope>
 		</dependency>
-    <dependency>
-      <groupId>org.apache.maven.shared</groupId>
-      <artifactId>maven-runtime</artifactId>
-    </dependency>
 	</dependencies>
 
 	<dependencyManagement>
@@ -154,11 +154,11 @@
 				<artifactId>plexus-utils</artifactId>
 				<version>2.0.7</version>
 			</dependency>
-      <dependency>
-        <groupId>org.apache.maven.shared</groupId>
-        <artifactId>maven-runtime</artifactId>
-        <version>1.0-alpha-3</version>
-      </dependency>
+			<dependency>
+				<groupId>org.apache.maven.shared</groupId>
+				<artifactId>maven-runtime</artifactId>
+				<version>1.0-alpha-3</version>
+			</dependency>
 		</dependencies>
 	</dependencyManagement>
 
diff --git a/src/main/java/org/eluder/coveralls/maven/plugin/AbstractCoverallsMojo.java b/src/main/java/org/eluder/coveralls/maven/plugin/AbstractCoverallsMojo.java
index ec0c619..e0a8bb8 100644
--- a/src/main/java/org/eluder/coveralls/maven/plugin/AbstractCoverallsMojo.java
+++ b/src/main/java/org/eluder/coveralls/maven/plugin/AbstractCoverallsMojo.java
@@ -26,13 +26,24 @@ package org.eluder.coveralls.maven.plugin;
  * %[license]
  */
 
+import java.io.File;
+import java.io.IOException;
+import java.util.ArrayList;
+import java.util.Arrays;
+import java.util.Date;
+import java.util.List;
+
 import org.apache.maven.plugin.AbstractMojo;
 import org.apache.maven.plugin.MojoExecutionException;
 import org.apache.maven.plugin.MojoFailureException;
 import org.apache.maven.plugins.annotations.Component;
 import org.apache.maven.plugins.annotations.Parameter;
 import org.apache.maven.project.MavenProject;
-import org.eluder.coveralls.maven.plugin.domain.*;
+import org.eluder.coveralls.maven.plugin.domain.CoverallsResponse;
+import org.eluder.coveralls.maven.plugin.domain.Git;
+import org.eluder.coveralls.maven.plugin.domain.GitRepository;
+import org.eluder.coveralls.maven.plugin.domain.Job;
+import org.eluder.coveralls.maven.plugin.domain.SourceLoader;
 import org.eluder.coveralls.maven.plugin.httpclient.CoverallsClient;
 import org.eluder.coveralls.maven.plugin.json.JsonWriter;
 import org.eluder.coveralls.maven.plugin.logging.CoverageTracingLogger;
@@ -42,13 +53,6 @@ import org.eluder.coveralls.maven.plugin.logging.Logger.Position;
 import org.eluder.coveralls.maven.plugin.service.ServiceSetup;
 import org.eluder.coveralls.maven.plugin.service.Travis;
 
-import java.io.File;
-import java.io.IOException;
-import java.util.ArrayList;
-import java.util.Arrays;
-import java.util.Date;
-import java.util.List;
-
 public abstract class AbstractCoverallsMojo extends AbstractMojo {
 
     /**
@@ -64,10 +68,10 @@ public abstract class AbstractCoverallsMojo extends AbstractMojo {
     protected String coverallsUrl;
 
     /**
-     * Directory path for base project.
+     * Source directories.
      */
-    @Parameter(property = "projectDirectory", defaultValue = "${basedir}")
-    protected File projectDirectory;
+    @Parameter(property = "sourceDirectories")
+    protected List<File> sourceDirectories;
     
     /**
      * Source file encoding.
@@ -99,31 +103,21 @@ public abstract class AbstractCoverallsMojo extends AbstractMojo {
     @Parameter(property = "branch")
     protected String branch;
 
-    /**
-     * For dynamic project source directory resolution.
-     */
-    @Component
-    protected MavenProject project;
-
-    /**
-     *  Holds discovered source directories that get pushed into the SourceLoader.
-     */
-    private List<File> sourceDirs = new ArrayList<File>();
-    
     /**
      * Build timestamp. Must be in 'yyyy-MM-dd HH:mm:ssa' format.
      */
     @Parameter(property = "timestamp", defaultValue = "${timestamp}")
     protected Date timestamp;
     
+    /**
+     * Maven project for runtime value resolution.
+     */
+    @Component
+    protected MavenProject project;
+    
     @Override
     public final void execute() throws MojoExecutionException, MojoFailureException {
         try {
-            getLog().debug("Collecting source directories:");
-          addProjectSourceDirectories(this.project);
-            for(MavenProject project : this.project.getCollectedProjects()) {
-              addProjectSourceDirectories(project);
-            }
             createEnvironment().setup();
             CoverageParser parser = createCoverageParser(createSourceLoader());
             Job job = createJob();
@@ -136,7 +130,6 @@ public abstract class AbstractCoverallsMojo extends AbstractMojo {
             report(reporters, Position.BEFORE);
             writeCoveralls(writer, sourceCallback, parser);
             report(reporters, Position.AFTER);
-            getLog().info(parser.getNumClasses()+" classes covered.");
             submitData(client, writer.getCoverallsFile());
         } catch (MojoFailureException ex) {
             throw ex;
@@ -149,18 +142,7 @@ public abstract class AbstractCoverallsMojo extends AbstractMojo {
         }
     }
 
-  private void addProjectSourceDirectories(MavenProject project) {
-    List<String> sources = project.getCompileSourceRoots();
-    for(String sourceDir : sources) {
-        File sourceDirFile = new File(sourceDir);
-        if(sourceDirFile.exists() && sourceDirFile.isDirectory()) {
-            getLog().debug("Adding source directory: "+sourceDir);
-            sourceDirs.add(sourceDirFile.getAbsoluteFile());
-        }
-    }
-  }
-
-  /**
+    /**
      * Creates a coverage parser. Must return new instance on every call.
      * 
      * @param sourceLoader the source loader to be used with parser
@@ -172,11 +154,11 @@ public abstract class AbstractCoverallsMojo extends AbstractMojo {
      * @return source loader to create source files
      */
     protected SourceLoader createSourceLoader() {
-        return new SourceLoader(sourceDirs, sourceEncoding);
+        return new SourceLoader(sourceDirectories, sourceEncoding);
     }
 
     /**
-     * @return environment to setup service specific mojo properties
+     * @return environment to setup mojo and service specific mojo properties
      */
     protected Environment createEnvironment() {
         return new Environment(this, Arrays.asList((ServiceSetup) new Travis()));
@@ -187,7 +169,7 @@ public abstract class AbstractCoverallsMojo extends AbstractMojo {
      * @throws IOException if an I/O error occurs
      */
     protected Job createJob() throws IOException {
-        Git git = new GitRepository(projectDirectory, branch).load();
+        Git git = new GitRepository(project.getBasedir(), branch).load();
         return new Job()
             .withRepoToken(repoToken)
             .withServiceName(serviceName)
diff --git a/src/main/java/org/eluder/coveralls/maven/plugin/AbstractXmlEventParser.java b/src/main/java/org/eluder/coveralls/maven/plugin/AbstractXmlEventParser.java
index e0be240..bc6fe12 100644
--- a/src/main/java/org/eluder/coveralls/maven/plugin/AbstractXmlEventParser.java
+++ b/src/main/java/org/eluder/coveralls/maven/plugin/AbstractXmlEventParser.java
@@ -26,22 +26,26 @@ package org.eluder.coveralls.maven.plugin;
  * %[license]
  */
 
+import java.io.File;
+import java.io.IOException;
+import java.io.Reader;
+
+import javax.xml.stream.FactoryConfigurationError;
+import javax.xml.stream.XMLInputFactory;
+import javax.xml.stream.XMLStreamConstants;
+import javax.xml.stream.XMLStreamException;
+import javax.xml.stream.XMLStreamReader;
+
 import org.codehaus.plexus.util.IOUtil;
 import org.codehaus.plexus.util.ReaderFactory;
 import org.codehaus.plexus.util.xml.XmlStreamReader;
 import org.eluder.coveralls.maven.plugin.domain.Source;
 import org.eluder.coveralls.maven.plugin.domain.SourceLoader;
 
-import javax.xml.stream.*;
-import java.io.File;
-import java.io.IOException;
-import java.io.Reader;
-
 public abstract class AbstractXmlEventParser implements CoverageParser {
 
     private final File coverageFile;
     private final SourceLoader sourceLoader;
-    protected int numClasses = 0;
     
     public AbstractXmlEventParser(final File coverageFile, final SourceLoader sourceLoader) {
         this.coverageFile = coverageFile;
@@ -103,8 +107,4 @@ public abstract class AbstractXmlEventParser implements CoverageParser {
     protected final boolean isEndElement(final XMLStreamReader xml, final String name) {
         return (XMLStreamConstants.END_ELEMENT == xml.getEventType() && xml.getLocalName().equals(name));
     }
-
-    public int getNumClasses() {
-      return numClasses;
-    }
 }
diff --git a/src/main/java/org/eluder/coveralls/maven/plugin/CoverageParser.java b/src/main/java/org/eluder/coveralls/maven/plugin/CoverageParser.java
index 0fbcf1f..2cdf5ae 100644
--- a/src/main/java/org/eluder/coveralls/maven/plugin/CoverageParser.java
+++ b/src/main/java/org/eluder/coveralls/maven/plugin/CoverageParser.java
@@ -51,6 +51,4 @@ public interface CoverageParser {
      * @return the coverage report file under processing
      */
     public File getCoverageFile();
-
-    public int getNumClasses();
 }
diff --git a/src/main/java/org/eluder/coveralls/maven/plugin/Environment.java b/src/main/java/org/eluder/coveralls/maven/plugin/Environment.java
index efcab7b..08689ec 100644
--- a/src/main/java/org/eluder/coveralls/maven/plugin/Environment.java
+++ b/src/main/java/org/eluder/coveralls/maven/plugin/Environment.java
@@ -26,6 +26,11 @@ package org.eluder.coveralls.maven.plugin;
  * %[license]
  */
 
+import java.io.File;
+import java.util.ArrayList;
+import java.util.List;
+
+import org.apache.maven.project.MavenProject;
 import org.codehaus.plexus.util.StringUtils;
 import org.eluder.coveralls.maven.plugin.service.ServiceSetup;
 
@@ -46,6 +51,36 @@ public final class Environment {
     }
     
     public void setup() {
+        setupSourceDirectories();
+        setupService();
+    }
+    
+    private void setupSourceDirectories() {
+        if (mojo.sourceDirectories == null || mojo.sourceDirectories.isEmpty()) {
+            List<File> directories = new ArrayList<File>();
+            collectSourceDirectories(mojo.project, directories);
+            mojo.sourceDirectories = directories;
+        }
+        if (mojo.sourceDirectories == null || mojo.sourceDirectories.isEmpty()) {
+            throw new IllegalArgumentException("No source directories set up");
+        }
+        mojo.getLog().debug("Using " + mojo.sourceDirectories.size() + " source directories to scan source files:");
+        mojo.getLog().debug(mojo.sourceDirectories.toString());
+    }
+    
+    private void collectSourceDirectories(final MavenProject project, final List<File> directories) {
+        for (String sourceRoot : project.getCompileSourceRoots()) {
+            File directory = new File(sourceRoot);
+            if (directory.exists() && directory.isDirectory()) {
+                directories.add(directory);
+            }
+        }
+        for (MavenProject collectedProject : project.getCollectedProjects()) {
+            collectSourceDirectories(collectedProject, directories);
+        }
+    }
+    
+    private void setupService() {
         for (ServiceSetup service : services) {
             if (service.isSelected(mojo.serviceName)) {
                 setupEnvironment(service);
diff --git a/src/main/java/org/eluder/coveralls/maven/plugin/cobertura/CoberturaMojo.java b/src/main/java/org/eluder/coveralls/maven/plugin/cobertura/CoberturaMojo.java
index 0063af3..e5e2e01 100644
--- a/src/main/java/org/eluder/coveralls/maven/plugin/cobertura/CoberturaMojo.java
+++ b/src/main/java/org/eluder/coveralls/maven/plugin/cobertura/CoberturaMojo.java
@@ -26,15 +26,15 @@ package org.eluder.coveralls.maven.plugin.cobertura;
  * %[license]
  */
 
+import java.io.File;
+
 import org.apache.maven.plugins.annotations.Mojo;
 import org.apache.maven.plugins.annotations.Parameter;
 import org.eluder.coveralls.maven.plugin.AbstractCoverallsMojo;
 import org.eluder.coveralls.maven.plugin.CoverageParser;
 import org.eluder.coveralls.maven.plugin.domain.SourceLoader;
 
-import java.io.File;
-
-@Mojo(name = "cobertura", threadSafe = false, aggregator=true)
+@Mojo(name = "cobertura", threadSafe = false, aggregator = true)
 public class CoberturaMojo extends AbstractCoverallsMojo {
 
     /**
diff --git a/src/main/java/org/eluder/coveralls/maven/plugin/cobertura/CoberturaParser.java b/src/main/java/org/eluder/coveralls/maven/plugin/cobertura/CoberturaParser.java
index 9e7acc7..015daf4 100644
--- a/src/main/java/org/eluder/coveralls/maven/plugin/cobertura/CoberturaParser.java
+++ b/src/main/java/org/eluder/coveralls/maven/plugin/cobertura/CoberturaParser.java
@@ -26,22 +26,22 @@ package org.eluder.coveralls.maven.plugin.cobertura;
  * %[license]
  */
 
+import java.io.File;
+import java.io.IOException;
+
+import javax.xml.stream.XMLStreamException;
+import javax.xml.stream.XMLStreamReader;
+
 import org.eluder.coveralls.maven.plugin.AbstractXmlEventParser;
 import org.eluder.coveralls.maven.plugin.ProcessingException;
 import org.eluder.coveralls.maven.plugin.SourceCallback;
 import org.eluder.coveralls.maven.plugin.domain.Source;
 import org.eluder.coveralls.maven.plugin.domain.SourceLoader;
 
-import javax.xml.stream.XMLStreamException;
-import javax.xml.stream.XMLStreamReader;
-import java.io.File;
-import java.io.IOException;
-
 public class CoberturaParser extends AbstractXmlEventParser {
 
     private Source source;
     private boolean inMethods;
-
     
     public CoberturaParser(final File coverageFile, final SourceLoader sourceLoader) {
         super(coverageFile, sourceLoader);
@@ -51,12 +51,10 @@ public class CoberturaParser extends AbstractXmlEventParser {
     protected void onEvent(final XMLStreamReader xml, final SourceCallback callback) throws XMLStreamException, ProcessingException, IOException {
         if (isStartElement(xml, "class")) {
             source = loadSource(xml.getAttributeValue(null, "filename"));
-            if(source != null) {
-              String className = xml.getAttributeValue(null, "name");
-              int classifierPosition = className.indexOf('$');
-              if (classifierPosition > 0) {
-                  source.setClassifier(className.substring(classifierPosition));
-              }
+            String className = xml.getAttributeValue(null, "name");
+            int classifierPosition = className.indexOf('$');
+            if (classifierPosition > 0) {
+                source.setClassifier(className.substring(classifierPosition));
             }
         } else
         
@@ -76,7 +74,6 @@ public class CoberturaParser extends AbstractXmlEventParser {
         } else
         
         if (isEndElement(xml, "class") && source != null) {
-            numClasses++;
             callback.onSource(source);
             source = null;
         }
diff --git a/src/main/java/org/eluder/coveralls/maven/plugin/domain/SourceLoader.java b/src/main/java/org/eluder/coveralls/maven/plugin/domain/SourceLoader.java
index c8ebff8..e3a5bce 100644
--- a/src/main/java/org/eluder/coveralls/maven/plugin/domain/SourceLoader.java
+++ b/src/main/java/org/eluder/coveralls/maven/plugin/domain/SourceLoader.java
@@ -26,54 +26,59 @@ package org.eluder.coveralls.maven.plugin.domain;
  * %[license]
  */
 
-import org.codehaus.plexus.util.IOUtil;
-
-import java.io.*;
+import java.io.BufferedInputStream;
+import java.io.File;
+import java.io.FileInputStream;
+import java.io.IOException;
+import java.io.InputStreamReader;
+import java.io.Reader;
 import java.nio.charset.Charset;
 import java.util.List;
 
+import org.codehaus.plexus.util.IOUtil;
+
 public class SourceLoader {
 
-    private List<File> sourceDirectories;
+    private final List<File> sourceDirectories;
     private final Charset sourceEncoding;
     
     public SourceLoader(final List<File> sourceDirectories, final String sourceEncoding) {
-        this.sourceDirectories = sourceDirectories;
-        for(File sourceDirectory : sourceDirectories) {
-          if(!sourceDirectory.exists()) {
-            throw new IllegalArgumentException("Source directory " + sourceDirectory.getAbsolutePath() + " does not exist");
-          }
-          if(!sourceDirectory.isDirectory()) {
-            throw new IllegalArgumentException(sourceDirectory.getAbsolutePath() + " is not directory");
-          }
+        if (sourceDirectories == null || sourceDirectories.isEmpty()) {
+            throw new IllegalArgumentException("At least one source directory must be defined");
         }
+        for (File sourceDirectory : sourceDirectories) {
+            if (!sourceDirectory.exists()) {
+                throw new IllegalArgumentException("Source directory " + sourceDirectory.getAbsolutePath() + " does not exist");
+            }
+            if (!sourceDirectory.isDirectory()) {
+                throw new IllegalArgumentException(sourceDirectory.getAbsolutePath() + " is not directory");
+            }
+        }
+        this.sourceDirectories = sourceDirectories;
         this.sourceEncoding = Charset.forName(sourceEncoding);
     }
     
     public Source load(final String sourceFile) throws IOException {
-        File file = null;
-        for(File sourceDirectory : sourceDirectories) {
-          file = new File(sourceDirectory, sourceFile);
-          if(!file.exists()) {
-            file = null;
-          } else {
-            break;
-          }
+        File file = locate(sourceFile);
+        Reader reader = new InputStreamReader(new BufferedInputStream(new FileInputStream(file)), sourceEncoding);
+        try {
+            String source = IOUtil.toString(reader);
+            return new Source(sourceFile, source);
+        } finally {
+            IOUtil.close(reader);
         }
-        if(file != null) {
-            if (!file.isFile()) {
-                throw new IllegalArgumentException(file.getAbsolutePath() + " is not file");
-            }
-            Reader reader = new InputStreamReader(new BufferedInputStream(new FileInputStream(file)), sourceEncoding);
-            try {
-                String source = IOUtil.toString(reader);
-                return new Source(sourceFile, source);
-            } finally {
-                IOUtil.close(reader);
+    }
+    
+    private File locate(final String sourceFile) {
+        for (File sourceDirectory : sourceDirectories) {
+            File file = new File(sourceDirectory, sourceFile);
+            if (file.exists()) {
+                if (!file.isFile()) {
+                    throw new IllegalArgumentException(file.getAbsolutePath() + " is not file");
+                }
+                return file;
             }
-        } else {
-            return null;
         }
+        throw new IllegalArgumentException("Could not find source file " + sourceFile + " from any source directory");
     }
-    
 }
diff --git a/src/main/java/org/eluder/coveralls/maven/plugin/jacoco/JaCoCoParser.java b/src/main/java/org/eluder/coveralls/maven/plugin/jacoco/JaCoCoParser.java
index 08eac96..825df84 100644
--- a/src/main/java/org/eluder/coveralls/maven/plugin/jacoco/JaCoCoParser.java
+++ b/src/main/java/org/eluder/coveralls/maven/plugin/jacoco/JaCoCoParser.java
@@ -26,17 +26,18 @@ package org.eluder.coveralls.maven.plugin.jacoco;
  * %[license]
  */
 
+import java.io.File;
+import java.io.IOException;
+
+import javax.xml.stream.XMLStreamException;
+import javax.xml.stream.XMLStreamReader;
+
 import org.eluder.coveralls.maven.plugin.AbstractXmlEventParser;
 import org.eluder.coveralls.maven.plugin.ProcessingException;
 import org.eluder.coveralls.maven.plugin.SourceCallback;
 import org.eluder.coveralls.maven.plugin.domain.Source;
 import org.eluder.coveralls.maven.plugin.domain.SourceLoader;
 
-import javax.xml.stream.XMLStreamException;
-import javax.xml.stream.XMLStreamReader;
-import java.io.File;
-import java.io.IOException;
-
 public class JaCoCoParser extends AbstractXmlEventParser {
 
     private String packageName;
@@ -66,7 +67,6 @@ public class JaCoCoParser extends AbstractXmlEventParser {
         } else
         
         if (isEndElement(xml, "sourcefile") && this.source != null) {
-            numClasses++;
             callback.onSource(this.source);
             this.source = null;
         } else
diff --git a/src/test/java/org/eluder/coveralls/maven/plugin/AbstractCoverallsMojoTest.java b/src/test/java/org/eluder/coveralls/maven/plugin/AbstractCoverallsMojoTest.java
index cc1dbbb..6da93f3 100644
--- a/src/test/java/org/eluder/coveralls/maven/plugin/AbstractCoverallsMojoTest.java
+++ b/src/test/java/org/eluder/coveralls/maven/plugin/AbstractCoverallsMojoTest.java
@@ -33,11 +33,14 @@ import static org.junit.Assert.assertThat;
 import static org.junit.Assert.fail;
 import static org.mockito.Matchers.any;
 import static org.mockito.Matchers.anyString;
+import static org.mockito.Mockito.verify;
 import static org.mockito.Mockito.when;
 
 import java.io.File;
 import java.io.IOException;
+import java.util.ArrayList;
 import java.util.Collections;
+import java.util.List;
 
 import org.apache.maven.plugin.MojoExecutionException;
 import org.apache.maven.plugin.MojoFailureException;
@@ -61,23 +64,8 @@ import org.mockito.invocation.InvocationOnMock;
 import org.mockito.runners.MockitoJUnitRunner;
 import org.mockito.stubbing.Answer;
 
-import java.io.File;
-import java.io.IOException;
-import java.util.ArrayList;
-import java.util.Collections;
-import java.util.List;
-
-import static org.hamcrest.Matchers.containsString;
-import static org.junit.Assert.*;
-import static org.mockito.Matchers.any;
-import static org.mockito.Matchers.anyString;
-import static org.mockito.Mockito.verify;
-import static org.mockito.Mockito.when;
-
 @RunWith(MockitoJUnitRunner.class)
 public abstract class AbstractCoverallsMojoTest {
-
-    private static final int MAX_NUMBER_OF_LINES = 30;
     
     @Rule
     public TemporaryFolder folder = new TemporaryFolder();
@@ -111,14 +99,13 @@ public abstract class AbstractCoverallsMojoTest {
         when(sourceLoaderMock.load(anyString())).then(new Answer<Source>() {
             @Override
             public Source answer(final InvocationOnMock invocation) throws Throwable {
-                StringBuilder content = new StringBuilder();
-                for (int i = 0; i < MAX_NUMBER_OF_LINES; i++) {
-                    content.append("\n");
-                }
-                return new Source(invocation.getArguments()[0].toString(), content.toString());
+                String sourceFile = invocation.getArguments()[0].toString();
+                String content = TestIoUtil.readFileContent(TestIoUtil.getFile("/" + new File(sourceFile).getName()));
+                return new Source(invocation.getArguments()[0].toString(), content);
             }
         });
         when(logMock.isDebugEnabled()).thenReturn(true);
+        when(logMock.isInfoEnabled()).thenReturn(true);
         
         mojo = new AbstractCoverallsMojo() {
             @Override
@@ -170,6 +157,9 @@ public abstract class AbstractCoverallsMojoTest {
         for (String[] coverageFile : CoverageFixture.COVERAGE_FILES) {
             assertThat(json, containsString(coverageFile[0]));
         }
+        
+        verify(logMock).info("Gathered code coverage metrics for 2 source files with 44 lines of code:");
+        verify(logMock).info("*** It might take hours for Coveralls to update the actual coverage numbers for a job");
     }
     
     @Test(expected = MojoFailureException.class)
diff --git a/src/test/java/org/eluder/coveralls/maven/plugin/EnvironmentTest.java b/src/test/java/org/eluder/coveralls/maven/plugin/EnvironmentTest.java
index fcd5af6..30b8002 100644
--- a/src/test/java/org/eluder/coveralls/maven/plugin/EnvironmentTest.java
+++ b/src/test/java/org/eluder/coveralls/maven/plugin/EnvironmentTest.java
@@ -26,17 +26,25 @@ package org.eluder.coveralls.maven.plugin;
  * %[license]
  */
 
+import static org.junit.Assert.assertArrayEquals;
 import static org.junit.Assert.assertEquals;
 import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.verify;
 import static org.mockito.Mockito.when;
 
+import java.io.File;
+import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.Collections;
 
+import org.apache.maven.plugin.logging.Log;
+import org.apache.maven.project.MavenProject;
 import org.eluder.coveralls.maven.plugin.domain.SourceLoader;
 import org.eluder.coveralls.maven.plugin.service.ServiceSetup;
 import org.junit.Before;
+import org.junit.Rule;
 import org.junit.Test;
+import org.junit.rules.TemporaryFolder;
 import org.junit.runner.RunWith;
 import org.mockito.Mock;
 import org.mockito.runners.MockitoJUnitRunner;
@@ -44,21 +52,61 @@ import org.mockito.runners.MockitoJUnitRunner;
 @RunWith(MockitoJUnitRunner.class)
 public class EnvironmentTest {
 
+    @Rule
+    public TemporaryFolder folder = new TemporaryFolder();
+    
     private AbstractCoverallsMojo mojo;
     
+    @Mock
+    private CoverageParser coverageParserMock;
+    
+    @Mock
+    private Log logMock;
+    
     @Mock
     private ServiceSetup serviceMock;
     
+    @Mock
+    private MavenProject mavenProjectMock;
+    
+    @Mock
+    private MavenProject mavenProjectMock2;
+    private File folder2;
+
+    @Mock
+    private MavenProject mavenProjectMock3;
+
+    @Mock
+    private MavenProject mavenProjectMock4;
+    private File folder4;
+
+    @Mock
+    private MavenProject mavenProjectMock5;
+    private File folder5;
+    
     @Before
-    public void init() {
+    public void init() throws Exception {
+        folder2 = folder.newFolder();
+        folder4 = folder.newFolder();
+        folder5 = folder.newFolder();
         mojo = new AbstractCoverallsMojo() {
             @Override
             protected CoverageParser createCoverageParser(final SourceLoader sourceLoader) {
-                return mock(CoverageParser.class);
+                return coverageParserMock;
+            }
+            @Override
+            public Log getLog() {
+                return logMock;
             }
         };
         mojo.serviceName = "service";
+        mojo.project = mavenProjectMock;
         when(serviceMock.isSelected("service")).thenReturn(true);
+        when(mavenProjectMock.getCollectedProjects()).thenReturn(Arrays.asList(mavenProjectMock2, mavenProjectMock3));
+        when(mavenProjectMock3.getCollectedProjects()).thenReturn(Arrays.asList(mavenProjectMock4, mavenProjectMock5));
+        when(mavenProjectMock2.getCompileSourceRoots()).thenReturn(Arrays.asList(folder2.getAbsolutePath()));
+        when(mavenProjectMock4.getCompileSourceRoots()).thenReturn(Arrays.asList(folder4.getAbsolutePath()));
+        when(mavenProjectMock5.getCompileSourceRoots()).thenReturn(Arrays.asList(folder5.getAbsolutePath()));
     }
     
     @Test(expected = IllegalArgumentException.class)
@@ -71,6 +119,29 @@ public class EnvironmentTest {
         new Environment(mojo, null);
     }
     
+    @Test(expected = IllegalArgumentException.class)
+    public void testSetupWithoutSourceDirectories() {
+        when(mavenProjectMock.getCollectedProjects()).thenReturn(new ArrayList<MavenProject>());
+        create(Collections.<ServiceSetup>emptyList()).setup();
+    }
+    
+    @Test
+    public void testSetupWithoutMojoSourceDirectories() {
+        create(Collections.<ServiceSetup>emptyList()).setup();
+        assertArrayEquals(new File[] { folder2.getAbsoluteFile(), folder4.getAbsoluteFile(), folder5.getAbsoluteFile() },
+                          mojo.sourceDirectories.toArray(new File[0]));
+        verify(logMock).debug("Using 3 source directories to scan source files:");
+    }
+    
+    @Test
+    public void testSetupWithMojoSourceDirectories() {
+        mojo.sourceDirectories = Arrays.asList(folder.getRoot());
+        create(Collections.<ServiceSetup>emptyList()).setup();
+        assertArrayEquals(new File[] { folder.getRoot() },
+                          mojo.sourceDirectories.toArray(new File[0]));
+        verify(logMock).debug("Using 1 source directories to scan source files:");
+    }
+    
     @Test
     public void testSetupWithoutServices() {
         create(Collections.<ServiceSetup>emptyList()).setup();
diff --git a/src/test/java/org/eluder/coveralls/maven/plugin/domain/SourceLoaderTest.java b/src/test/java/org/eluder/coveralls/maven/plugin/domain/SourceLoaderTest.java
index d352005..9f70906 100644
--- a/src/test/java/org/eluder/coveralls/maven/plugin/domain/SourceLoaderTest.java
+++ b/src/test/java/org/eluder/coveralls/maven/plugin/domain/SourceLoaderTest.java
@@ -26,6 +26,13 @@ package org.eluder.coveralls.maven.plugin.domain;
  * %[license]
  */
 
+import static org.junit.Assert.assertEquals;
+import static org.mockito.Mockito.when;
+
+import java.io.File;
+import java.util.ArrayList;
+import java.util.Arrays;
+
 import org.eluder.coveralls.maven.plugin.util.TestIoUtil;
 import org.junit.Rule;
 import org.junit.Test;
@@ -34,13 +41,6 @@ import org.junit.runner.RunWith;
 import org.mockito.Mock;
 import org.mockito.runners.MockitoJUnitRunner;
 
-import java.io.File;
-import java.util.Arrays;
-
-import static org.junit.Assert.assertEquals;
-import static org.junit.Assert.assertNull;
-import static org.mockito.Mockito.when;
-
 @RunWith(MockitoJUnitRunner.class)
 public class SourceLoaderTest {
 
@@ -53,6 +53,11 @@ public class SourceLoaderTest {
     @Rule
     public TemporaryFolder folder = new TemporaryFolder();
     
+    @Test(expected = IllegalArgumentException.class)
+    public void testMissingSourceDirectories() throws Exception {
+        new SourceLoader(new ArrayList<File>(), "UTF-8");
+    }
+    
     @Test(expected = IllegalArgumentException.class)
     public void testMissingSourceDirectory() throws Exception {
         when(dirMock.exists()).thenReturn(false);
@@ -67,9 +72,9 @@ public class SourceLoaderTest {
         new SourceLoader(Arrays.asList(dirMock), "UTF-8");
     }
 
-    @Test
+    @Test(expected = IllegalArgumentException.class)
     public void testMissingSourceFile() throws Exception {
-        assertNull(new SourceLoader(Arrays.asList(folder.getRoot()), "UTF-8").load("Foo.java"));
+        new SourceLoader(Arrays.asList(folder.getRoot()), "UTF-8").load("Foo.java");
     }
     
     @Test(expected = IllegalArgumentException.class)
