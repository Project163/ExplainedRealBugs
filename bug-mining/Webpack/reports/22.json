{"url":"https://api.github.com/repos/webpack/webpack/issues/8949","repository_url":"https://api.github.com/repos/webpack/webpack","labels_url":"https://api.github.com/repos/webpack/webpack/issues/8949/labels{/name}","comments_url":"https://api.github.com/repos/webpack/webpack/issues/8949/comments","events_url":"https://api.github.com/repos/webpack/webpack/issues/8949/events","html_url":"https://github.com/webpack/webpack/issues/8949","id":424540628,"node_id":"MDU6SXNzdWU0MjQ1NDA2Mjg=","number":8949,"title":"FunctionModuleTemplatePlugin performance problem with replace","user":{"login":"maksimr","id":616193,"node_id":"MDQ6VXNlcjYxNjE5Mw==","avatar_url":"https://avatars.githubusercontent.com/u/616193?v=4","gravatar_id":"","url":"https://api.github.com/users/maksimr","html_url":"https://github.com/maksimr","followers_url":"https://api.github.com/users/maksimr/followers","following_url":"https://api.github.com/users/maksimr/following{/other_user}","gists_url":"https://api.github.com/users/maksimr/gists{/gist_id}","starred_url":"https://api.github.com/users/maksimr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maksimr/subscriptions","organizations_url":"https://api.github.com/users/maksimr/orgs","repos_url":"https://api.github.com/users/maksimr/repos","events_url":"https://api.github.com/users/maksimr/events{/privacy}","received_events_url":"https://api.github.com/users/maksimr/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":841723323,"node_id":"MDU6TGFiZWw4NDE3MjMzMjM=","url":"https://api.github.com/repos/webpack/webpack/labels/Send%20a%20PR","name":"Send a PR","color":"0054d3","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2019-03-23T20:18:30Z","updated_at":"2019-03-25T06:09:49Z","closed_at":"2019-03-25T06:09:49Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We have a problem with performance when enabling source-maps (cheap-module-eval-source-map) in our project. After some investigation I found an issue with `replace` function inside `FunctionModuleTemplatePlugin`. `replace` took too much time even when the string (req) is small.\r\n\r\n```bash\r\nwebpack@3.12.0\r\nwebpack-dev-server@2.11.3\r\nnode@v10.15.0\r\nnpm@6.4.1\r\ndarwin 18.2.0 MacOs Mojave (10.14.3) 2.3GHz i5/ 8GB\r\n``` \r\n\r\nhttps://github.com/webpack/webpack/blob/master/lib/FunctionModuleTemplatePlugin.js#L44-L46\r\n\r\n```js\r\n\tsource.add(\"/*!****\" + req.replace(/./g, \"*\") + \"****!*\\\\\\n\");\r\n\tsource.add(\"  !*** \" + req.replace(/\\*\\//g, \"*_/\") + \" ***!\\n\");\r\n\tsource.add(\"  \\\\****\" + req.replace(/./g, \"*\") + \"****/\\n\");\r\n```\r\n\r\nFirst simple solution just remove duplications `req.replace(/./g, \"*\")`.\r\nSecond I replaced `replace` with Array\r\n\r\n```js\r\n        const x = Array(req.length).fill(\"*\").join('');\r\n        const y = Array(req.length).fill(null).map((_, i) => (i > 0 && req[i - 1] === '*' && req[i] === '/') ? '_/' : req[i]).join('');\r\n        source.add(\"/*!****\" + x + \"****!*\\\\\\n\");\r\n        source.add(\"  !*** \" + y + \" ***!\\n\");\r\n        source.add(\"  \\\\****\" + x + \"****/\\n\");\r\n\r\n```\r\n\r\nAfter this fixes rebuild time decreased `3-4` times.\r\nPerformance of `FunctionModuleTemplatePlugin` increased in ~15 times (by profile)\r\n\r\n\r\nI have created a small test file which reproduces this problem\r\nhttps://gist.github.com/maksimr/cff8cb1ebda05d530071c9c78cd0d82e\r\n\r\n![image1553370705714](https://user-images.githubusercontent.com/616193/54871116-82800b80-4dc0-11e9-8714-e1ce09df60c6.png)\r\n![image1553370308610 (1)](https://user-images.githubusercontent.com/616193/54871125-ad6a5f80-4dc0-11e9-851c-044706d05dd7.png)\r\n\r\n\r\n[CPU profile for replace](https://gist.githubusercontent.com/maksimr/cff8cb1ebda05d530071c9c78cd0d82e/raw/c38c39206655d61716181d72df8c5777b7dec729/CPU-20190323T223837.cpuprofile)\r\n\r\n[CPU profile for Array](https://gist.githubusercontent.com/maksimr/cff8cb1ebda05d530071c9c78cd0d82e/raw/c38c39206655d61716181d72df8c5777b7dec729/CPU-patched.cpuprofile)\r\n\r\nAll CPU profiles I have added to gist\r\nhttps://gist.github.com/maksimr/cff8cb1ebda05d530071c9c78cd0d82e\r\n\r\nThanks","closed_by":{"login":"maksimr","id":616193,"node_id":"MDQ6VXNlcjYxNjE5Mw==","avatar_url":"https://avatars.githubusercontent.com/u/616193?v=4","gravatar_id":"","url":"https://api.github.com/users/maksimr","html_url":"https://github.com/maksimr","followers_url":"https://api.github.com/users/maksimr/followers","following_url":"https://api.github.com/users/maksimr/following{/other_user}","gists_url":"https://api.github.com/users/maksimr/gists{/gist_id}","starred_url":"https://api.github.com/users/maksimr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maksimr/subscriptions","organizations_url":"https://api.github.com/users/maksimr/orgs","repos_url":"https://api.github.com/users/maksimr/repos","events_url":"https://api.github.com/users/maksimr/events{/privacy}","received_events_url":"https://api.github.com/users/maksimr/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/webpack/webpack/issues/8949/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/webpack/webpack/issues/8949/timeline","performed_via_github_app":null,"state_reason":"completed"}