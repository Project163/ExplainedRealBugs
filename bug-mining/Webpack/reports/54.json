{"url":"https://api.github.com/repos/webpack/webpack/issues/10409","repository_url":"https://api.github.com/repos/webpack/webpack","labels_url":"https://api.github.com/repos/webpack/webpack/issues/10409/labels{/name}","comments_url":"https://api.github.com/repos/webpack/webpack/issues/10409/comments","events_url":"https://api.github.com/repos/webpack/webpack/issues/10409/events","html_url":"https://github.com/webpack/webpack/issues/10409","id":566897362,"node_id":"MDU6SXNzdWU1NjY4OTczNjI=","number":10409,"title":"concatenateModules breaks circular dependency","user":{"login":"SystemParadox","id":1228777,"node_id":"MDQ6VXNlcjEyMjg3Nzc=","avatar_url":"https://avatars.githubusercontent.com/u/1228777?v=4","gravatar_id":"","url":"https://api.github.com/users/SystemParadox","html_url":"https://github.com/SystemParadox","followers_url":"https://api.github.com/users/SystemParadox/followers","following_url":"https://api.github.com/users/SystemParadox/following{/other_user}","gists_url":"https://api.github.com/users/SystemParadox/gists{/gist_id}","starred_url":"https://api.github.com/users/SystemParadox/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SystemParadox/subscriptions","organizations_url":"https://api.github.com/users/SystemParadox/orgs","repos_url":"https://api.github.com/users/SystemParadox/repos","events_url":"https://api.github.com/users/SystemParadox/events{/privacy}","received_events_url":"https://api.github.com/users/SystemParadox/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1089820,"node_id":"MDU6TGFiZWwxMDg5ODIw","url":"https://api.github.com/repos/webpack/webpack/labels/bug","name":"bug","color":"fbca04","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2020-02-18T13:35:54Z","updated_at":"2020-05-11T18:36:01Z","closed_at":"2020-02-24T07:58:05Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"# Bug report\r\n\r\n**What is the current behavior?**\r\n\r\nMy app works fine normally, but setting `optimization: { concatenateModules: true }` causes it to break the resolution order of the circular dependency.\r\n\r\n**If the current behavior is a bug, please provide the steps to reproduce.**\r\n\r\nConsider the following example:\r\n\r\n```\r\n// lib/a.js\r\nimport cts from './cts';\r\nexport default cts.connectData(function () {});\r\n\r\n// lib/b.js\r\nimport cts from './cts';\r\nexport function b() {\r\n    setImmediate();\r\n}\r\n\r\n// lib/c.js\r\nimport cts from './cts';\r\nimport a from './a';\r\nexport function c() {}\r\n\r\n// lib/cts.js\r\nimport * as cts from './cts';\r\nexport { cts as default };\r\nexport function connectData() {}\r\nexport { b } from './b';\r\nexport { c } from './c';\r\n\r\n// lib/main.js\r\nimport cts from './cts';\r\nimport a from './a';\r\n```\r\n\r\nWith `concatenateModules: true`, running the bundle (created from `lib/main.js`) results in `TypeError: Cannot read property 'connectData' of undefined`. Something has gone wrong with the concatenation, causing the cts default export to not be defined early enough.\r\n\r\nI have reduced the example above to the bare minimum. Changing almost anything will cause it to work even with `concatenateModules`. It seems to be related to the concatenation bailout which is caused by the reference to the setImmediate global.\r\n\r\n**What is the expected behavior?**\r\n\r\n`concatenateModules` should not cause working apps to break. Perhaps this is a particularly pathological example, but it's a bit concerning when it works in development and setting `mode: 'production'` causes it to break.\r\n\r\nIt took me a very long time to reduce this to a sensible example - hopefully this is useful!\r\n\r\nOn a side note, is there any better way to ensure that the default export gets set to the module namespace before processing any of the other imports/exports? It feels very fragile, and despite being such a common use case the spec appears to be lacking here.\r\n\r\n**Other relevant information:**\r\nwebpack version: 4.41.6\r\nNode.js version: 10.15.2\r\nOperating System: Linux\r\nAdditional tools: None","closed_by":{"login":"sokra","id":1365881,"node_id":"MDQ6VXNlcjEzNjU4ODE=","avatar_url":"https://avatars.githubusercontent.com/u/1365881?v=4","gravatar_id":"","url":"https://api.github.com/users/sokra","html_url":"https://github.com/sokra","followers_url":"https://api.github.com/users/sokra/followers","following_url":"https://api.github.com/users/sokra/following{/other_user}","gists_url":"https://api.github.com/users/sokra/gists{/gist_id}","starred_url":"https://api.github.com/users/sokra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sokra/subscriptions","organizations_url":"https://api.github.com/users/sokra/orgs","repos_url":"https://api.github.com/users/sokra/repos","events_url":"https://api.github.com/users/sokra/events{/privacy}","received_events_url":"https://api.github.com/users/sokra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/webpack/webpack/issues/10409/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/webpack/webpack/issues/10409/timeline","performed_via_github_app":null,"state_reason":"completed"}