{"url":"https://api.github.com/repos/webpack/webpack/issues/12487","repository_url":"https://api.github.com/repos/webpack/webpack","labels_url":"https://api.github.com/repos/webpack/webpack/issues/12487/labels{/name}","comments_url":"https://api.github.com/repos/webpack/webpack/issues/12487/comments","events_url":"https://api.github.com/repos/webpack/webpack/issues/12487/events","html_url":"https://github.com/webpack/webpack/issues/12487","id":792479545,"node_id":"MDU6SXNzdWU3OTI0Nzk1NDU=","number":12487,"title":"SplitChunksPlugin crash when optimization.splitChunks.maxSize is set","user":{"login":"smitty3268","id":8310507,"node_id":"MDQ6VXNlcjgzMTA1MDc=","avatar_url":"https://avatars.githubusercontent.com/u/8310507?v=4","gravatar_id":"","url":"https://api.github.com/users/smitty3268","html_url":"https://github.com/smitty3268","followers_url":"https://api.github.com/users/smitty3268/followers","following_url":"https://api.github.com/users/smitty3268/following{/other_user}","gists_url":"https://api.github.com/users/smitty3268/gists{/gist_id}","starred_url":"https://api.github.com/users/smitty3268/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smitty3268/subscriptions","organizations_url":"https://api.github.com/users/smitty3268/orgs","repos_url":"https://api.github.com/users/smitty3268/repos","events_url":"https://api.github.com/users/smitty3268/events{/privacy}","received_events_url":"https://api.github.com/users/smitty3268/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":816832417,"node_id":"MDU6TGFiZWw4MTY4MzI0MTc=","url":"https://api.github.com/repos/webpack/webpack/labels/webpack-5","name":"webpack-5","color":"c5def5","default":false,"description":""},{"id":2424789964,"node_id":"MDU6TGFiZWwyNDI0Nzg5OTY0","url":"https://api.github.com/repos/webpack/webpack/labels/critical-bug","name":"critical-bug","color":"d93f0b","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2021-01-23T08:20:30Z","updated_at":"2021-03-11T10:55:25Z","closed_at":"2021-03-11T10:55:25Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Bug Report**\r\n\r\n**What is the current behavior?**\r\nWebpack crashes when splitting my project in 5.17.0 when a maxSize is set. \r\n\r\nThis behavior varies depending on the packages being splits, as well as the maxSize and minSize that are set. I'm able to consistently avoid problems by setting minSize to 0. The larger I set it, the more likely it is for a problem to occur.\r\n\r\nI get the following stack trace when it fails:\r\n\r\n```\r\nSplitChunksPlugin(node:22720) UnhandledPromiseRejectionWarning: TypeError: Cannot read property 'size' of undefined\r\n    at module.exports (C:\\_code\\Intranet\\trunk\\Web\\node_modules\\webpack\\lib\\util\\deterministicGrouping.js:339:44)\r\n    at C:\\_code\\Intranet\\trunk\\Web\\node_modules\\webpack\\lib\\optimize\\SplitChunksPlugin.js:1589:23\r\n    at Hook.eval [as call] (eval at create (C:\\_code\\Intranet\\trunk\\Web\\node_modules\\webpack\\node_modules\\tapable\\lib\\HookCodeFactory.js:19:10), <anonymous>:39:16)\r\n    at Hook.CALL_DELEGATE [as _call] (C:\\_code\\Intranet\\trunk\\Web\\node_modules\\webpack\\node_modules\\tapable\\lib\\Hook.js:14:14)\r\n    at Compilation.seal (C:\\_code\\Intranet\\trunk\\Web\\node_modules\\webpack\\lib\\Compilation.js:2101:36)\r\n    at C:\\_code\\Intranet\\trunk\\Web\\node_modules\\webpack\\lib\\Compiler.js:1056:20\r\n    at C:\\_code\\Intranet\\trunk\\Web\\node_modules\\webpack\\lib\\Compilation.js:1925:4\r\n    at _next2 (eval at create (C:\\_code\\Intranet\\trunk\\Web\\node_modules\\webpack\\node_modules\\tapable\\lib\\HookCodeFactory.js:33:10), <anonymous>:35:1)\r\n    at eval (eval at create (C:\\_code\\Intranet\\trunk\\Web\\node_modules\\webpack\\node_modules\\tapable\\lib\\HookCodeFactory.js:33:10), <anonymous>:71:1)\r\n    at C:\\_code\\Intranet\\trunk\\Web\\node_modules\\webpack\\lib\\FlagDependencyExportsPlugin.js:332:11\r\n(node:22720) UnhandledPromiseRejectionWarning: Unhandled promise rejection. This error originated either by throwing inside of an async function without a catch block, or by rejecting a promise which was not handled with .catch(). (rejection id: 1)\r\n(node:22720) [DEP0018] DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.\r\n```\r\n\r\nLooking at the code where it crashes, I see this:\r\n\r\n```\r\nlet left = 1;\r\nlet leftSize = Object.create(null);\r\naddSizeTo(leftSize, group.nodes[0].size);\r\nwhile (isTooSmall(leftSize, minSize)) {\r\n    addSizeTo(leftSize, group.nodes[left].size); //this is the crash, left has exceeded the length of the nodes list.\r\n    left++;\r\n}\r\n```\r\n\r\n\r\nI don't see how exactly this is supposed to work, as there doesn't appear to be anything stopping left from incrementing up past the length of the available nodes. This code is what made me realize setting minSize lower would workaround the issue, though, as setting it small enough simply ensures the while loop is never entered.\r\n\r\n**If the current behavior is a bug, please provide the steps to reproduce.**\r\nOn my codebase, setting maxSize smaller and minSize larger seems to be more likely to cause the bug.\r\n\r\n```\r\noptimization: {\r\n    chunks: 'all', \r\n    maxAsyncRequests: Infinity,\r\n    maxInitialRequests: Infinity,\r\n    maxSize: 100000,\r\n    //minSize: 1,\r\n    cacheGroups: {\r\n        sharedcomponents: {\r\n            test: /[\\\\/]_shared[\\\\/]src/,\r\n            name: 'sharedcomponents',\r\n            reuseExistingChunk: true\r\n        },\r\n\tvendors: {\r\n            test: /[\\\\/]node_modules[\\\\/]/,\r\n            name: 'vendors',\r\n\t    reuseExistingChunk: true\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\n**What is the expected behavior?**\r\nWebpack should generate chunks with an appropriate maxSize if possible, and anything smaller is acceptable as well. Having a chunk smaller than the minSize shouldn't crash.\r\n\r\n**Please mention other relevant information such as the browser version, Node.js version, webpack version, and Operating System.**\r\nWebpack 5.17.0. Also had the same issue on 5.14.0. Haven't tested any older versions.\r\nNode 12.13.0\r\n","closed_by":{"login":"sokra","id":1365881,"node_id":"MDQ6VXNlcjEzNjU4ODE=","avatar_url":"https://avatars.githubusercontent.com/u/1365881?v=4","gravatar_id":"","url":"https://api.github.com/users/sokra","html_url":"https://github.com/sokra","followers_url":"https://api.github.com/users/sokra/followers","following_url":"https://api.github.com/users/sokra/following{/other_user}","gists_url":"https://api.github.com/users/sokra/gists{/gist_id}","starred_url":"https://api.github.com/users/sokra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sokra/subscriptions","organizations_url":"https://api.github.com/users/sokra/orgs","repos_url":"https://api.github.com/users/sokra/repos","events_url":"https://api.github.com/users/sokra/events{/privacy}","received_events_url":"https://api.github.com/users/sokra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/webpack/webpack/issues/12487/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/webpack/webpack/issues/12487/timeline","performed_via_github_app":null,"state_reason":"completed"}