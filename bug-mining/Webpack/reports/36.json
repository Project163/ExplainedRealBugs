{"url":"https://api.github.com/repos/webpack/webpack/issues/9634","repository_url":"https://api.github.com/repos/webpack/webpack","labels_url":"https://api.github.com/repos/webpack/webpack/issues/9634/labels{/name}","comments_url":"https://api.github.com/repos/webpack/webpack/issues/9634/comments","events_url":"https://api.github.com/repos/webpack/webpack/issues/9634/events","html_url":"https://github.com/webpack/webpack/issues/9634","id":485593100,"node_id":"MDU6SXNzdWU0ODU1OTMxMDA=","number":9634,"title":"Chunk graph / \"available modules optimisation\" refactor in 4.38.0 breaks our bundles","user":{"login":"marcins","id":340441,"node_id":"MDQ6VXNlcjM0MDQ0MQ==","avatar_url":"https://avatars.githubusercontent.com/u/340441?v=4","gravatar_id":"","url":"https://api.github.com/users/marcins","html_url":"https://github.com/marcins","followers_url":"https://api.github.com/users/marcins/followers","following_url":"https://api.github.com/users/marcins/following{/other_user}","gists_url":"https://api.github.com/users/marcins/gists{/gist_id}","starred_url":"https://api.github.com/users/marcins/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcins/subscriptions","organizations_url":"https://api.github.com/users/marcins/orgs","repos_url":"https://api.github.com/users/marcins/repos","events_url":"https://api.github.com/users/marcins/events{/privacy}","received_events_url":"https://api.github.com/users/marcins/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2019-08-27T05:35:12Z","updated_at":"2019-08-27T12:11:20Z","closed_at":"2019-08-27T11:02:55Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!-- Please don't delete this template because we'll close your issue -->\r\n<!-- Before creating an issue please make sure you are using the latest version of webpack. -->\r\n\r\n# Bug report\r\n\r\n<!-- Please ask questions on StackOverflow or the webpack Gitter. -->\r\n<!-- https://stackoverflow.com/questions/ask?tags=webpack -->\r\n<!-- https://gitter.im/webpack/webpack -->\r\n<!-- Issues which contain questions or support requests will be closed. -->\r\n\r\n**What is the current behavior?**\r\n\r\nWe have a large, 25,000+ module, build with multiple entry points and judicious usage of code splitting. In the latest version of Webpack we have a scenario where one of our async bundles when loaded through a chain starting from a particular entry point cannot find one of the modules it requires, because it is only included in a different entry point.  Running a `git bisect` identified the commit where this behaviour changed as 126fb9912187fc8a09d00f831267e1eae85c4984\r\n\r\nUnfortunately at this stage I am unable to produce a minimal reproduction, and our codebase is not public. The commit in question moved code as well as refactored, so it's hard to tell from the diff exactly what changed in the chunk graph algorithm, however based on what we're seeing I am suspecting the \"available modules optimization\" is at fault, where a module is not being bundled where it should be because it's considered \"available\" when it isn't.\r\n\r\nHere is the scenario, slightly simplified:\r\n\r\n* given two entry points, `entry-a` and `entry-b`\r\n* `entry-a` eventually depends on `module-a` via a mix of sync & async imports (code splits)\r\n* `entry-a` also depends on `module-b` via a mix of sync & async imports (code splits), through a path including `shared-module-a`.\r\n* `module-b` depends on `module-a`\r\n* `entry-b` depends on `shared-module-a` through a mix of sync & sync imports (and so eventually depends on `module-a` via `module-b`\r\n\r\n(Dashes are code splits, solid are direct imports - there's a lot more of these in the real codebase, which might be relevant)\r\n\r\n![image](https://user-images.githubusercontent.com/340441/63743549-f24e7100-c8df-11e9-9d26-17ba11bf37fd.png)\r\n\r\nAfter commit 126fb9912187fc8a09d00f831267e1eae85c4984, `module-a` is bundled into `entry-a`, so when we load `entry-b` and `module-b` tries to load `module-a` a runtime error is thrown because `module-a` cannot be found.\r\n\r\nBefore commit 126fb9912187fc8a09d00f831267e1eae85c4984, `module-a` will be bundled into `module-b` (and `entry-a`), so when we load `entry-b` it can be found when `module-b` tries to load it.  \r\n\r\n**If the current behavior is a bug, please provide the steps to reproduce.**\r\n\r\nAs above, I cannot currently provide a minimal reproduction, but I am working on it and will update the issue when I have narrowed it down further.\r\n\r\nIt does not appear that any optimisation settings affect this - I can repro in dev mode, prod mode, with webpack-dev-server, and anything in between - it's, to my current understanding, a fundamental bug in the graph building code.\r\n\r\nI have tried to produce a simplified scenario as described above, but it's something more specific about our particular combination of sync/async imports that is obviously causing this issue to occur, hopefully if I can identify which part of 126fb9912187fc8a09d00f831267e1eae85c4984 causes the issue I can work how to reproduce the issue (and/or provide a fix).\r\n\r\n<!-- A great way to do this is to provide your configuration via a GitHub repository -->\r\n<!-- The most helpful is a minimal reproduction with instructions on how to reproduce -->\r\n<!-- Repositories with too many files or large `webpack.config.js` files are not suitable -->\r\n<!-- Please only add small code snippets directly into this issue -->\r\n<!-- https://gist.github.com is a good place for longer code snippets -->\r\n<!-- If your issue is caused by a plugin or loader, please create an issue on the loader/plugin repository instead -->\r\n\r\n**What is the expected behavior?**\r\n\r\nI expect that when `module-b` is loaded via `entry-b`, it can still access `module-a` because it has been bundled somewhere in the modules available to `entry-b`.\r\n\r\n\r\n<!-- \"It should work\" is not a helpful explanation -->\r\n<!-- Explain exactly how it should behave -->\r\n\r\n**Other relevant information:**\r\nwebpack version: 4.39.2\r\nNode.js version: 10.9.0\r\nOperating System: macOS 10.14.6\r\nAdditional tools:\r\n","closed_by":{"login":"sokra","id":1365881,"node_id":"MDQ6VXNlcjEzNjU4ODE=","avatar_url":"https://avatars.githubusercontent.com/u/1365881?v=4","gravatar_id":"","url":"https://api.github.com/users/sokra","html_url":"https://github.com/sokra","followers_url":"https://api.github.com/users/sokra/followers","following_url":"https://api.github.com/users/sokra/following{/other_user}","gists_url":"https://api.github.com/users/sokra/gists{/gist_id}","starred_url":"https://api.github.com/users/sokra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sokra/subscriptions","organizations_url":"https://api.github.com/users/sokra/orgs","repos_url":"https://api.github.com/users/sokra/repos","events_url":"https://api.github.com/users/sokra/events{/privacy}","received_events_url":"https://api.github.com/users/sokra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/webpack/webpack/issues/9634/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/webpack/webpack/issues/9634/timeline","performed_via_github_app":null,"state_reason":"completed"}