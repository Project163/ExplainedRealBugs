{"url":"https://api.github.com/repos/grafana/k6/issues/885","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/885/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/885/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/885/events","html_url":"https://github.com/grafana/k6/issues/885","id":394263079,"node_id":"MDU6SXNzdWUzOTQyNjMwNzk=","number":885,"title":"WebSocket session counter is not exactly same as VU","user":{"login":"gcg","id":811685,"node_id":"MDQ6VXNlcjgxMTY4NQ==","avatar_url":"https://avatars.githubusercontent.com/u/811685?v=4","gravatar_id":"","url":"https://api.github.com/users/gcg","html_url":"https://github.com/gcg","followers_url":"https://api.github.com/users/gcg/followers","following_url":"https://api.github.com/users/gcg/following{/other_user}","gists_url":"https://api.github.com/users/gcg/gists{/gist_id}","starred_url":"https://api.github.com/users/gcg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gcg/subscriptions","organizations_url":"https://api.github.com/users/gcg/orgs","repos_url":"https://api.github.com/users/gcg/repos","events_url":"https://api.github.com/users/gcg/events{/privacy}","received_events_url":"https://api.github.com/users/gcg/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191758,"node_id":"MDU6TGFiZWwzNDUxOTE3NTg=","url":"https://api.github.com/repos/grafana/k6/labels/bug","name":"bug","color":"b60205","default":true,"description":""},{"id":874564661,"node_id":"MDU6TGFiZWw4NzQ1NjQ2NjE=","url":"https://api.github.com/repos/grafana/k6/labels/refactor","name":"refactor","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-12-27T00:20:29Z","updated_at":"2020-03-23T12:15:09Z","closed_at":"2020-03-23T12:15:09Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hey there, first I really appricate k6 and thank you for this :) \r\n\r\nI am trying to write some tests with websockets but for some reason k6 never opens the connection count that I want with -u. \r\n\r\nIf I give -u 10000 it usually opens 8k socket connections. If I give the -u 5000, it's somewhere around 4k. I am not sure if I am missing something here. \r\n\r\n![430d368c-11d6-4308-a714-295aef73fd23](https://user-images.githubusercontent.com/811685/50460210-03567500-0942-11e9-9942-7bcf13634393.png)\r\n\r\n\r\nHere is the code version for the same .js file on the screen shot\r\n\r\n```javascript\r\nimport ws from \"k6/ws\";\r\nimport { check, fail } from \"k6\";\r\nimport { Counter } from \"k6/metrics\";\r\n\r\nlet sessionCounter = new Counter('session_counter');\r\nlet msgCounter = new Counter('msg_counter');\r\nlet errCounter = new Counter('err_counter');\r\nlet closeCounter = new Counter('close_counter');\r\nlet pingCounter = new Counter('ping_counter');\r\n\r\nexport function setup() {\r\n  let trivia_id = __ENV.trivia_id;\r\n\r\n  return {\r\n    trivia_id\r\n  }\r\n}\r\n\r\nexport default function (data) {\r\n  let url = `ws://gcg.me:3000/trivia-status/${data.trivia_id}`;\r\n  let con = ws.connect(url, null, function( socket ) {\r\n    socket.on('open', function () {\r\n      sessionCounter.add(1);\r\n      socket.setInterval(function timeout() {\r\n        socket.ping();\r\n        pingCounter.add(1);\r\n      }, 1000);\r\n    });\r\n\r\n    socket.on('close', function () {\r\n      console.log(`Connection closed on ${__VU} on ${__ITER}`);\r\n      closeCounter.add(1);\r\n    });\r\n    socket.on('error', function(e) {\r\n      if (e.error() != \"websocket: close sent\") {\r\n        console.log('An unexpected error occured: ', e.error());\r\n      }\r\n      errCounter.add(1);\r\n    });\r\n\r\n    socket.on('message', function () {\r\n      msgCounter.add(1);\r\n    });\r\n  });\r\n\r\n  check(con, {\r\n    \"status is 101\": (r) => r && r.status === 101\r\n  });\r\n}\r\n```\r\n\r\nAs you can see I am also logging error and socket close events and since they are not showing up on the results I am assuming there was no error and no server side close issues. I also add active socket connection count to my backend and tracked that number real time and it's the same with the sessionCounter. So how come I can't open all the connections I want? \r\n\r\nAnd from the documantation I was hoping to see default ws metrics to be on the result screen but for some reason I am not seeing, that is the reason I am counting every event manually. \r\n\r\nAnd as an extra question, I also want to handle the socket connection errors to re-open that connection after an error to keep the session going. But I didn't see on the documantation page. I want to make my tests as real as possible and if a client loses its socket connection, it usually re-opens the connection. \r\n\r\nThank you. ","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/885/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/885/timeline","performed_via_github_app":null,"state_reason":"completed"}