{"url":"https://api.github.com/repos/grafana/k6/issues/882","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/882/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/882/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/882/events","html_url":"https://github.com/grafana/k6/issues/882","id":392218655,"node_id":"MDU6SXNzdWUzOTIyMTg2NTU=","number":882,"title":"Global JS event loops in every VU","user":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191760,"node_id":"MDU6TGFiZWwzNDUxOTE3NjA=","url":"https://api.github.com/repos/grafana/k6/labels/enhancement","name":"enhancement","color":"5319E7","default":true,"description":""},{"id":869282130,"node_id":"MDU6TGFiZWw4NjkyODIxMzA=","url":"https://api.github.com/repos/grafana/k6/labels/feature","name":"feature","color":"5319E7","default":false,"description":""},{"id":874927263,"node_id":"MDU6TGFiZWw4NzQ5MjcyNjM=","url":"https://api.github.com/repos/grafana/k6/labels/high%20prio","name":"high prio","color":"D93F0B","default":false,"description":""},{"id":949381702,"node_id":"MDU6TGFiZWw5NDkzODE3MDI=","url":"https://api.github.com/repos/grafana/k6/labels/js-compat","name":"js-compat","color":"ea8394","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/grafana/k6/milestones/21","html_url":"https://github.com/grafana/k6/milestone/21","labels_url":"https://api.github.com/repos/grafana/k6/milestones/21/labels","id":7544121,"node_id":"MI_kwDOAz4Wr84Acx05","number":21,"title":"v0.37.0","description":"","creator":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":53,"state":"closed","created_at":"2022-01-05T13:29:43Z","updated_at":"2022-03-15T11:49:17Z","due_on":"2022-03-14T07:00:00Z","closed_at":"2022-03-15T11:49:17Z"},"comments":7,"created_at":"2018-12-18T15:52:14Z","updated_at":"2022-03-02T16:40:28Z","closed_at":"2022-03-02T16:40:28Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"To actually support a lot of cool features and to achieve better compatibility with a ton of JavaScript APIs and libraries out there, we need to be able to support asynchronous execution inside of VUs via a global event loop. We have a [localized one](https://github.com/loadimpact/k6/blob/b154f449b8c4a67929f36cba07f58a218acd99e9/js/modules/k6/ws/ws.go#L237-L323) in the current websocket implementation, but even that's not enough in a lot of cases.\r\n\r\nThings which will benefit from or need an event loop:\r\n- Better websockets (https://github.com/loadimpact/k6/issues/865)\r\n- raw TCP/UDP sockets\r\n- gRPC (https://github.com/loadimpact/k6/issues/441) streaming + multiple concurrent unary requests from a single VU (i.e. a `http.batch()` equivalent)\r\n- HTTP SSE (Server-Sent Events) (https://github.com/loadimpact/k6/issues/746)\r\n- HTTP long polling (https://github.com/loadimpact/k6/issues/1122)\r\n- HTTP/2 server push (https://github.com/loadimpact/k6/issues/881)\r\n- and any asynchronous protocols, including a lot of messaging ones\r\n- `setTimeout()`, `setInterval()`, etc. (https://github.com/loadimpact/k6/issues/332)\r\n- `async`/`await` (https://github.com/loadimpact/k6/issues/779)\r\n- polyfills/mocks (hopefully in JS only, no Go code changes needed) for different browser APIs like [`XMLHttpRequest`](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest) or [`Fetch`](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API), so we have a broader support for browser JS libraries and browserified node libraries\r\n- allow us to eventually mock some parts of the node API, if we want to\r\n- likely other nice things, considering that the most of the JS ecosystem is kind of based on it...\r\n\r\nOf course, the current looping VU model of k6 will necessitate certain restrictions in the way event loops are normally implemented. For one, each VU in k6 has its own separate JS runtime, so each VU will also need to have its own event loop.\r\n\r\nAlso, events probably shouldn't cross over between iterations of the same VU, since that would be very confusing and likely quite error-prone, especially with the arrival-rate based executor. Memory leaks would also be a concern... And even if cross-iteration events are easy to implement and we decide to allow them, I think they shouldn't be enabled by default. So some type of configurable post-iteration timeout option should probably be introduced that will be used to control how long k6 will wait for queued events to fire and finish up before it discards them and continues to the next iteration.\r\n\r\nAs a simple event loop implementation we may look to for inspiration and ideas, the author of [goja](https://github.com/dop251/goja) (the JS runtime k6 uses) also has this repo: https://github.com/dop251/goja_nodejs\r\n\r\n","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/882/reactions","total_count":19,"+1":19,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/882/timeline","performed_via_github_app":null,"state_reason":"completed"}