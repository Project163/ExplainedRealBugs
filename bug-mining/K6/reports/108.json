{"url":"https://api.github.com/repos/grafana/k6/issues/951","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/951/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/951/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/951/events","html_url":"https://github.com/grafana/k6/issues/951","id":420454432,"node_id":"MDU6SXNzdWU0MjA0NTQ0MzI=","number":951,"title":"Make console.log() available in the init context","user":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191760,"node_id":"MDU6TGFiZWwzNDUxOTE3NjA=","url":"https://api.github.com/repos/grafana/k6/labels/enhancement","name":"enhancement","color":"5319E7","default":true,"description":""},{"id":865562676,"node_id":"MDU6TGFiZWw4NjU1NjI2NzY=","url":"https://api.github.com/repos/grafana/k6/labels/ux","name":"ux","color":"5319e7","default":false,"description":""},{"id":1079102926,"node_id":"MDU6TGFiZWwxMDc5MTAyOTI2","url":"https://api.github.com/repos/grafana/k6/labels/evaluation%20needed","name":"evaluation needed","color":"006B75","default":false,"description":"proposal needs to be validated or tested before fully implementing it in k6"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/grafana/k6/milestones/7","html_url":"https://github.com/grafana/k6/milestone/7","labels_url":"https://api.github.com/repos/grafana/k6/milestones/7/labels","id":4536026,"node_id":"MDk6TWlsZXN0b25lNDUzNjAyNg==","number":7,"title":"v0.26.0","description":"","creator":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":109,"state":"closed","created_at":"2019-07-31T08:43:47Z","updated_at":"2022-10-03T09:45:50Z","due_on":null,"closed_at":"2020-04-22T12:31:51Z"},"comments":9,"created_at":"2019-03-13T11:40:41Z","updated_at":"2019-08-29T12:11:42Z","closed_at":"2019-08-29T11:08:33Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"As seen in [this issue](https://github.com/loadimpact/k6/issues/950), `console.log()` could be quite useful in the init context for debugging purposes.\r\n\r\nThe main user-facing problem with this it the fact that code in the init context is executed multiple times. Off the top of my head, it's executed once in the beginning of a k6 run to get the exported script `options`, once for `setup()`, once for the initialization in each VU, and once in `teardown()`. So if we enable this by default, it's going to be quite noisy...\r\n\r\nThere are 2 somewhat major things from an implementation perspective that are potentially problematic. First, the logger for each runtime (i.e. VU) is currently in the [`lib.State` struct](https://github.com/loadimpact/k6/blob/cf8bccc76f1d3f7095a767b5bf71488200db340c/lib/state.go#L47), which isn't available in the init context. In fact, its [presence](https://github.com/loadimpact/k6/blob/cf8bccc76f1d3f7095a767b5bf71488200db340c/js/modules/k6/metrics/metrics.go#L52-L54) of [absence](https://github.com/loadimpact/k6/blob/cf8bccc76f1d3f7095a767b5bf71488200db340c/js/modules/k6/k6.go#L71-L74) are often how we verify whether a particular piece of k6 Go code is executed in the VU or init context respectively...\r\n\r\nThe second issue stems from the fact that we likely can't enable this logging by default due to its noisiness. This likely means that we have to hide it behind a flag. Unfortunately, it can't be a JS option only, since those are retrieved after the init context is executed once. But it seems like something minor that doesn't deserve its own CLI/environment variable flag...\r\n\r\nSo, here's an initial proposal that needs to be further evaluated for feasibility:\r\n- By default, trying `console.log()` in the init context will return an error. But it won't be the current `ReferenceError: console is not defined`, rather it will be something like `Using console.log() in the init context only works when verbose mode is enabled. You can do that with the --verbose/-v CLI flags or the K6_VERBOSE environment variable.`\r\n- If users turn on verbose mode, `console` [methods](https://github.com/loadimpact/k6/blob/master/samples/logging.js) in the init context will start to work. Each message will likely be emitted multiple times, once per init context execution, unless there's an error somewhere in the code that aborts the script execution. \r\n- Ideally, users should be able to differentiate between the messages from different init context executions. This could be accomplished by adding a `source` field in each log message. And it's also somewhat tied to [this issue](https://github.com/loadimpact/k6/issues/889) about having VU numbers in the init context.\r\n\r\nBut yeah, more evaluation definitely needed, since this seemingly simple feature has a lot of complications if we want to get it right...","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/951/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/951/timeline","performed_via_github_app":null,"state_reason":"completed"}