{"url":"https://api.github.com/repos/grafana/k6/issues/63","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/63/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/63/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/63/events","html_url":"https://github.com/grafana/k6/issues/63","id":198461850,"node_id":"MDU6SXNzdWUxOTg0NjE4NTA=","number":63,"title":"Thresholds with tags","user":{"login":"liclac","id":428026,"node_id":"MDQ6VXNlcjQyODAyNg==","avatar_url":"https://avatars.githubusercontent.com/u/428026?v=4","gravatar_id":"","url":"https://api.github.com/users/liclac","html_url":"https://github.com/liclac","followers_url":"https://api.github.com/users/liclac/followers","following_url":"https://api.github.com/users/liclac/following{/other_user}","gists_url":"https://api.github.com/users/liclac/gists{/gist_id}","starred_url":"https://api.github.com/users/liclac/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/liclac/subscriptions","organizations_url":"https://api.github.com/users/liclac/orgs","repos_url":"https://api.github.com/users/liclac/repos","events_url":"https://api.github.com/users/liclac/events{/privacy}","received_events_url":"https://api.github.com/users/liclac/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191760,"node_id":"MDU6TGFiZWwzNDUxOTE3NjA=","url":"https://api.github.com/repos/grafana/k6/labels/enhancement","name":"enhancement","color":"5319E7","default":true,"description":""}],"state":"closed","locked":false,"assignee":{"login":"liclac","id":428026,"node_id":"MDQ6VXNlcjQyODAyNg==","avatar_url":"https://avatars.githubusercontent.com/u/428026?v=4","gravatar_id":"","url":"https://api.github.com/users/liclac","html_url":"https://github.com/liclac","followers_url":"https://api.github.com/users/liclac/followers","following_url":"https://api.github.com/users/liclac/following{/other_user}","gists_url":"https://api.github.com/users/liclac/gists{/gist_id}","starred_url":"https://api.github.com/users/liclac/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/liclac/subscriptions","organizations_url":"https://api.github.com/users/liclac/orgs","repos_url":"https://api.github.com/users/liclac/repos","events_url":"https://api.github.com/users/liclac/events{/privacy}","received_events_url":"https://api.github.com/users/liclac/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"liclac","id":428026,"node_id":"MDQ6VXNlcjQyODAyNg==","avatar_url":"https://avatars.githubusercontent.com/u/428026?v=4","gravatar_id":"","url":"https://api.github.com/users/liclac","html_url":"https://github.com/liclac","followers_url":"https://api.github.com/users/liclac/followers","following_url":"https://api.github.com/users/liclac/following{/other_user}","gists_url":"https://api.github.com/users/liclac/gists{/gist_id}","starred_url":"https://api.github.com/users/liclac/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/liclac/subscriptions","organizations_url":"https://api.github.com/users/liclac/orgs","repos_url":"https://api.github.com/users/liclac/repos","events_url":"https://api.github.com/users/liclac/events{/privacy}","received_events_url":"https://api.github.com/users/liclac/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":2,"created_at":"2017-01-03T12:09:22Z","updated_at":"2017-01-18T19:16:46Z","closed_at":"2017-01-18T19:16:46Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Right now, we don't process tags locally inside k6 - it'd mean duplicating data for every possible combination of tags, which would result in an unreasonable amount of RAM usage for longer tests, especially tests containing a lot of URLs.\r\n\r\nUnfortunately, this means thresholds become limited to querying full metrics, which isn't a useful level of granularity for many use cases.\r\n\r\nThe current workaround is to declare custom metrics, copy samples off requests into these, and set thresholds on these metrics instead:\r\n\r\n```es6\r\nlet res = http.get(\"...\");\r\nmyMetric.add(res.timings.duration);\r\ncheck(res, {\r\n    \"status is 200\": (res) => res.status === 200,\r\n})\r\n```\r\n\r\nWhile this produces correct results, I don't like this approach, because:\r\n\r\n1. It's verbose. Gone is the elegant simplicity of:\r\n\r\n    ```es6\r\n    check(http.get(\"...\"), {\r\n        \"status is 200\": (res) => res.status === 200,\r\n    });\r\n    ```\r\n\r\n1. It clutters the output with useless metrics. Bad for UX. We could make a way to mark metrics as \"hidden\" here (perhaps by prefixing the name with an `_` or something of the sort), but more importantly...\r\n\r\n1. It encourages users to resort to the seemingly simpler solution of:\r\n\r\n    ```es6\r\n    check(http.get(\"...\"), {\r\n        \"status is 200\": (res) => res.status === 200,\r\n        \"time is <100ms\": (res) => res.timings.duration < 1000,\r\n    })\r\n    ```\r\n\r\n    Coupled with a raised `-a`/`--acceptance`, this may produce seemingly correct results with a single k6 instance. However:\r\n\r\n    * `-a`/`--acceptance` is a blunt instrument. It silences all failures up to a certain point, and is meant to cover for sporadic errors or dropped packets. Outliers in performance are by nature more common, and tuning acceptance up to cover for this will bury legitimate issues with the application being tested.\r\n    * The problem is magnified in distributed tests; a single instance will not have access to the full dataset, and it's entirely possible for a single instance to get a series of slow requests, tainting the entire run with a check failure. The remedy is to up `-a`/`--acceptance`, thus perpetuating the above. Thresholds don't have this problem, as they are by nature distributed, and can work against a database.\r\n\r\n    Don't encourage users to shoot themselves in the foot.\r\n\r\n---\r\n\r\nWhat I want to do is to instantiate *submetrics* or *derived metrics*, using an InfluxDB-like syntax to filter out only certain tags. Let's assume we're using a parameter to `http.<method>()` to add the \"kind\" tag to requests that should be special-cased - for instance, a login endpoint.\r\n\r\n```es6\r\nexport let options = {\r\n    thresholds: {\r\n        \"http_req_duration{kind:}\": \"avg <= 100\",\r\n        \"http_req_duration{kind:login}\": \"avg <= 1000\",\r\n    }\r\n}\r\n```\r\n\r\nWith these two thresholds set, the engine will figure out to create two hidden metrics called `http_req_duration{kind:}` (where `sample.Tags[\"kind\"] == \"\"`) and `http_req_duration{kind:login}` (where `sample.Tags[\"kind\"] == \"login\"`). No explicit custom metrics required.","closed_by":{"login":"liclac","id":428026,"node_id":"MDQ6VXNlcjQyODAyNg==","avatar_url":"https://avatars.githubusercontent.com/u/428026?v=4","gravatar_id":"","url":"https://api.github.com/users/liclac","html_url":"https://github.com/liclac","followers_url":"https://api.github.com/users/liclac/followers","following_url":"https://api.github.com/users/liclac/following{/other_user}","gists_url":"https://api.github.com/users/liclac/gists{/gist_id}","starred_url":"https://api.github.com/users/liclac/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/liclac/subscriptions","organizations_url":"https://api.github.com/users/liclac/orgs","repos_url":"https://api.github.com/users/liclac/repos","events_url":"https://api.github.com/users/liclac/events{/privacy}","received_events_url":"https://api.github.com/users/liclac/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/63/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/63/timeline","performed_via_github_app":null,"state_reason":"completed"}