{"url":"https://api.github.com/repos/grafana/k6/issues/1928","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/1928/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/1928/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/1928/events","html_url":"https://github.com/grafana/k6/issues/1928","id":842503686,"node_id":"MDU6SXNzdWU4NDI1MDM2ODY=","number":1928,"title":"Fatal error when parse protobuf with docker k6","user":{"login":"hojongs","id":15096588,"node_id":"MDQ6VXNlcjE1MDk2NTg4","avatar_url":"https://avatars.githubusercontent.com/u/15096588?v=4","gravatar_id":"","url":"https://api.github.com/users/hojongs","html_url":"https://github.com/hojongs","followers_url":"https://api.github.com/users/hojongs/followers","following_url":"https://api.github.com/users/hojongs/following{/other_user}","gists_url":"https://api.github.com/users/hojongs/gists{/gist_id}","starred_url":"https://api.github.com/users/hojongs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hojongs/subscriptions","organizations_url":"https://api.github.com/users/hojongs/orgs","repos_url":"https://api.github.com/users/hojongs/repos","events_url":"https://api.github.com/users/hojongs/events{/privacy}","received_events_url":"https://api.github.com/users/hojongs/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191758,"node_id":"MDU6TGFiZWwzNDUxOTE3NTg=","url":"https://api.github.com/repos/grafana/k6/labels/bug","name":"bug","color":"b60205","default":true,"description":""},{"id":345191761,"node_id":"MDU6TGFiZWwzNDUxOTE3NjE=","url":"https://api.github.com/repos/grafana/k6/labels/help%20wanted","name":"help wanted","color":"159818","default":true,"description":null},{"id":874927263,"node_id":"MDU6TGFiZWw4NzQ5MjcyNjM=","url":"https://api.github.com/repos/grafana/k6/labels/high%20prio","name":"high prio","color":"D93F0B","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/grafana/k6/milestones/14","html_url":"https://github.com/grafana/k6/milestone/14","labels_url":"https://api.github.com/repos/grafana/k6/milestones/14/labels","id":6442565,"node_id":"MDk6TWlsZXN0b25lNjQ0MjU2NQ==","number":14,"title":"v0.32.0","description":"","creator":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":68,"state":"closed","created_at":"2021-02-17T08:36:20Z","updated_at":"2021-06-29T07:10:47Z","due_on":"2021-05-12T07:00:00Z","closed_at":"2021-05-13T12:24:31Z"},"comments":1,"created_at":"2021-03-27T13:23:53Z","updated_at":"2021-03-31T09:33:07Z","closed_at":"2021-03-31T09:33:07Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--- Provide a general summary of the issue in the Title above -->\r\n\r\n## Environment\r\n<!--- Provide as much information about your environment as possible: output from `k6 version`,\r\n      OCI runtime and image information if using containers, cloud execution environment, etc. -->\r\n- k6 version: 0.31.1\r\n- OS and version: Windows 10\r\n- Docker version and image, if applicable: latest(0.31.1)\r\n\r\n## Expected Behavior\r\n<!--- Tell us what should happen -->\r\nWhen I run same script&proto file with windows binary\r\n```plaintext\r\n          /\\      |‾‾| /‾‾/   /‾‾/\r\n     /\\  /  \\     |  |/  /   /  /\r\n    /  \\/    \\    |     (   /   ‾‾\\\r\n   /          \\   |  |\\  \\ |  (‾)  |\r\n  / __________ \\  |__| \\__\\ \\_____/ .io\r\n\r\n\r\n  execution: local\r\n     script: ./grpc-test.js\r\n     output: -\r\n\r\n  scenarios: (100.00%) 1 scenario, 1 max VUs, 10m30s max duration (incl. graceful stop):\r\n           * default: 1 iterations for each of 1 VUs (maxDuration: 10m0s, gracefulStop: 30s)\r\n\r\nWARN[0000] error getting terminal size                   error=\"The handle is invalid.\"\r\nWARN[0000] Error from API server                         error=\"listen tcp 127.0.0.1:6565: bind: An attempt was made to access a socket in a way forbidden by its access permissions.\"\r\n\r\nrunning (00m01.0s), 0/1 VUs, 1 complete and 0 interrupted iterations\r\ndefault ✓ [========================] 1 VUs  00m01.0s/10m0s  1/1 iters, 1 per VU\r\n\r\n     ✓ status is OK\r\n\r\n     checks...............: 100.00% ✓ 1   ✗ 0\r\n     data_received........: 214 B   210 B/s\r\n     data_sent............: 211 B   207 B/s\r\n     grpc_req_duration....: avg=2ms   min=2ms   med=2ms   max=2ms   p(90)=2ms   p(95)=2ms\r\n     iteration_duration...: avg=1.01s min=1.01s med=1.01s max=1.01s p(90)=1.01s p(95)=1.01s\r\n     iterations...........: 1       0.982341/s\r\n     vus..................: 1       min=1 max=1\r\n     vus_max..............: 1       min=1 max=1\r\n```\r\n\r\n## Actual Behavior\r\n<!--- Tell us what happens instead of the expected behavior -->\r\n```\r\n          /\\      |‾‾| /‾‾/   /‾‾/\r\n     /\\  /  \\     |  |/  /   /  /\r\n    /  \\/    \\    |     (   /   ‾‾\\\r\n   /          \\   |  |\\  \\ |  (‾)  |\r\n  / __________ \\  |__| \\__\\ \\_____/ .io\r\n\r\npanic: runtime error: invalid memory address or nil pointer dereference [recovered]\r\n        panic: runtime error: invalid memory address or nil pointer dereference [recovered]\r\n        panic: runtime error: invalid memory address or nil pointer dereference\r\n[signal SIGSEGV: segmentation violation code=0x1 addr=0x28 pc=0xc501be]\r\n\r\ngoroutine 1 [running]:\r\ngithub.com/dop251/goja.(*Runtime).RunProgram.func1(0xc0010459d0)\r\n        github.com/dop251/goja@v0.0.0-20210216182323-60bc6ebb9fc1/runtime.go:1200 +0x85\r\npanic(0x11048c0, 0x1def4f0)\r\n        runtime/panic.go:969 +0x1b9\r\ngithub.com/dop251/goja.(*vm).try.func1(0xc000200ee0, 0x0, 0xc001045890, 0x0, 0x0, 0x0, 0xc001045918)\r\n        github.com/dop251/goja@v0.0.0-20210216182323-60bc6ebb9fc1/vm.go:406 +0x5d3\r\npanic(0x11048c0, 0x1def4f0)\r\n        runtime/panic.go:969 +0x1b9\r\ngithub.com/jhump/protoreflect/desc/protoparse.(*basicCompositeNode).start(...)\r\n        github.com/jhump/protoreflect@v1.7.0/desc/protoparse/ast.go:162\r\ngithub.com/jhump/protoreflect/desc/protoparse.(*parseResult).createFileDescriptor(0xc001990ab0, 0xc002c697a0, 0xd, 0xc0034f3380)\r\n        github.com/jhump/protoreflect@v1.7.0/desc/protoparse/descriptor_protos.go:35 +0xd9e\r\ngithub.com/jhump/protoreflect/desc/protoparse.createParseResult(0xc002c697a0, 0xd, 0xc0034f3380, 0xc001990990, 0x111e940)\r\n        github.com/jhump/protoreflect@v1.7.0/desc/protoparse/parser.go:690 +0xbb\r\ngithub.com/jhump/protoreflect/desc/protoparse.parseProto(0xc002c697a0, 0xd, 0x14b0ca0, 0xc0006344a8, 0xc001990990, 0xc001e06501, 0xc001e06550)\r\n        github.com/jhump/protoreflect@v1.7.0/desc/protoparse/parser.go:669 +0x174\r\ngithub.com/jhump/protoreflect/desc/protoparse.parseProtoFile.func2(0x14bbe20, 0xc0006344a8, 0xc002c697a0, 0xd, 0xc001990990, 0x1, 0xc001044ca8)\r\n        github.com/jhump/protoreflect@v1.7.0/desc/protoparse/parser.go:440 +0xba\r\ngithub.com/jhump/protoreflect/desc/protoparse.parseProtoFile(0xc001044e58, 0xc002c697a0, 0xd, 0x0, 0xc001990990, 0x400101, 0xc001044e38, 0x139f0d0)\r\n        github.com/jhump/protoreflect@v1.7.0/desc/protoparse/parser.go:441 +0x97f\r\ngithub.com/jhump/protoreflect/desc/protoparse.parseProtoFiles(0xc001044e58, 0xc001e06390, 0x1, 0x1, 0xc001990990, 0x1230101, 0xc001044e38, 0x0)\r\n        github.com/jhump/protoreflect@v1.7.0/desc/protoparse/parser.go:414 +0xb9\r\ngithub.com/jhump/protoreflect/desc/protoparse.Parser.ParseFiles(0xc001e06550, 0x1, 0x1, 0x0, 0x0, 0xc001e06560, 0x0, 0x0, 0x0, 0xc001e06390, ...)\r\n        github.com/jhump/protoreflect@v1.7.0/desc/protoparse/parser.go:207 +0x1bc\r\ngithub.com/loadimpact/k6/js/modules/k6/grpc.(*Client).Load(0xc001dcfa80, 0xc001da1a90, 0x1e40b18, 0x0, 0x0, 0xc001e06390, 0x1, 0x1, 0x0, 0x0, ...)\r\n        github.com/loadimpact/k6/js/modules/k6/grpc/client.go:142 +0x246\r\nreflect.Value.call(0x11ba3e0, 0xc001dcfa80, 0x1613, 0x1291780, 0x9, 0xc00033c230, 0x3, 0x3, 0xb, 0x10a7e60, ...)\r\n        reflect/value.go:476 +0x8c7\r\nreflect.Value.CallSlice(0x11ba3e0, 0xc001dcfa80, 0x1613, 0xc00033c230, 0x3, 0x3, 0x198, 0x18c68d0, 0x2d)\r\n        reflect/value.go:350 +0xb9\r\ngithub.com/loadimpact/k6/js/common.Bind.func1(0x14d8620, 0xc001990600, 0xc000201a60, 0x2, 0xc, 0xc001e06380, 0x0)\r\n        github.com/loadimpact/k6/js/common/bridge.go:241 +0x70c\r\ngithub.com/dop251/goja.(*vm)._nativeCall(0xc000200ee0, 0xc0028d1200, 0x2)\r\n        github.com/dop251/goja@v0.0.0-20210216182323-60bc6ebb9fc1/vm.go:1817 +0x2c2\r\ngithub.com/dop251/goja.call.exec(0x2, 0xc000200ee0)\r\n        github.com/dop251/goja@v0.0.0-20210216182323-60bc6ebb9fc1/vm.go:1789 +0xaeb\r\ngithub.com/dop251/goja.(*vm).run(0xc000200ee0)\r\n        github.com/dop251/goja@v0.0.0-20210216182323-60bc6ebb9fc1/vm.go:307 +0x99\r\ngithub.com/dop251/goja.(*vm).try(0xc000200ee0, 0xc001045920, 0x0)\r\n        github.com/dop251/goja@v0.0.0-20210216182323-60bc6ebb9fc1/vm.go:412 +0x163\r\ngithub.com/dop251/goja.(*vm).runTry(0xc000200ee0, 0x0)\r\n        github.com/dop251/goja@v0.0.0-20210216182323-60bc6ebb9fc1/vm.go:417 +0x4e\r\ngithub.com/dop251/goja.(*Runtime).RunProgram(0xc000766900, 0xc0034f22a0, 0x0, 0x0, 0x0, 0x0)\r\n        github.com/dop251/goja@v0.0.0-20210216182323-60bc6ebb9fc1/runtime.go:1211 +0x1f8\r\ngithub.com/loadimpact/k6/js.(*Bundle).instantiate(0xc00355b8c0, 0x14dcb20, 0xc00011c2a0, 0xc000766900, 0xc00033c000, 0x0, 0x0, 0x0)\r\n        github.com/loadimpact/k6/js/bundle.go:313 +0x811\r\ngithub.com/loadimpact/k6/js.NewBundle(0x14dcb20, 0xc00011c2a0, 0xc00011a960, 0xc00012ca20, 0x1, 0x1290d17, 0x8, 0x0, 0xc00012cba0, 0x0, ...)\r\n        github.com/loadimpact/k6/js/bundle.go:98 +0x498\r\ngithub.com/loadimpact/k6/js.New(0xc00011c2a0, 0xc00011a960, 0xc00012ca20, 0x1, 0x1290d17, 0x8, 0x0, 0xc00012cba0, 0x0, 0x0, ...)\r\n        github.com/loadimpact/k6/js/runner.go:76 +0xa7\r\ngithub.com/loadimpact/k6/cmd.newRunner(0xc00011c2a0, 0xc00011a960, 0x128b110, 0x2, 0xc00012ca20, 0x1, 0x1290d17, 0x8, 0x0, 0xc00012cba0, ...)\r\n        github.com/loadimpact/k6/cmd/run.go:412 +0x174\r\ngithub.com/loadimpact/k6/cmd.newRunner(0xc00011c2a0, 0xc00011a960, 0x0, 0x0, 0xc00012ca20, 0x1, 0x1290d17, 0x8, 0x0, 0xc00012cba0, ...)\r\n        github.com/loadimpact/k6/cmd/run.go:410 +0x4f8\r\ngithub.com/loadimpact/k6/cmd.getRunCmd.func1(0xc000123b80, 0xc000136140, 0x1, 0x1, 0x0, 0x0)\r\n        github.com/loadimpact/k6/cmd/run.go:125 +0x6cd\r\ngithub.com/spf13/cobra.(*Command).execute(0xc000123b80, 0xc000136120, 0x1, 0x1, 0xc000123b80, 0xc000136120)\r\n        github.com/spf13/cobra@v0.0.4-0.20180629152535-a114f312e075/command.go:762 +0x47c\r\ngithub.com/spf13/cobra.(*Command).ExecuteC(0xc000122000, 0xc00088ff00, 0xc, 0xc)\r\n        github.com/spf13/cobra@v0.0.4-0.20180629152535-a114f312e075/command.go:852 +0x2fe\r\ngithub.com/spf13/cobra.(*Command).Execute(...)\r\n        github.com/spf13/cobra@v0.0.4-0.20180629152535-a114f312e075/command.go:800\r\ngithub.com/loadimpact/k6/cmd.Execute()\r\n        github.com/loadimpact/k6/cmd/root.go:198 +0x571\r\nmain.main()\r\n        github.com/loadimpact/k6/main.go:28 +0x25\r\n```\r\n\r\nI think core cause is below. **protoparse**\r\nBut I'm not sure why it fails in only docker environment, unlike windows env.\r\n\r\n```\r\ngithub.com/jhump/protoreflect/desc/protoparse.(*basicCompositeNode).start(...)\r\n        github.com/jhump/protoreflect@v1.7.0/desc/protoparse/ast.go:162\r\ngithub.com/jhump/protoreflect/desc/protoparse.(*parseResult).createFileDescriptor(0xc001990ab0, 0xc002c697a0, 0xd, 0xc0034f3380)\r\n        github.com/jhump/protoreflect@v1.7.0/desc/protoparse/descriptor_protos.go:35 +0xd9e\r\ngithub.com/jhump/protoreflect/desc/protoparse.createParseResult(0xc002c697a0, 0xd, 0xc0034f3380, 0xc001990990, 0x111e940)\r\n        github.com/jhump/protoreflect@v1.7.0/desc/protoparse/parser.go:690 +0xbb\r\ngithub.com/jhump/protoreflect/desc/protoparse.parseProto(0xc002c697a0, 0xd, 0x14b0ca0, 0xc0006344a8, 0xc001990990, 0xc001e06501, 0xc001e06550)\r\n        github.com/jhump/protoreflect@v1.7.0/desc/protoparse/parser.go:669 +0x174\r\ngithub.com/jhump/protoreflect/desc/protoparse.parseProtoFile.func2(0x14bbe20, 0xc0006344a8, 0xc002c697a0, 0xd, 0xc001990990, 0x1, 0xc001044ca8)\r\n        github.com/jhump/protoreflect@v1.7.0/desc/protoparse/parser.go:440 +0xba\r\ngithub.com/jhump/protoreflect/desc/protoparse.parseProtoFile(0xc001044e58, 0xc002c697a0, 0xd, 0x0, 0xc001990990, 0x400101, 0xc001044e38, 0x139f0d0)\r\n        github.com/jhump/protoreflect@v1.7.0/desc/protoparse/parser.go:441 +0x97f\r\ngithub.com/jhump/protoreflect/desc/protoparse.parseProtoFiles(0xc001044e58, 0xc001e06390, 0x1, 0x1, 0xc001990990, 0x1230101, 0xc001044e38, 0x0)\r\n        github.com/jhump/protoreflect@v1.7.0/desc/protoparse/parser.go:414 +0xb9\r\ngithub.com/jhump/protoreflect/desc/protoparse.Parser.ParseFiles(0xc001e06550, 0x1, 0x1, 0x0, 0x0, 0xc001e06560, 0x0, 0x0, 0x0, 0xc001e06390, ...)\r\n        github.com/jhump/protoreflect@v1.7.0/desc/protoparse/parser.go:207 +0x1bc\r\ngithub.com/loadimpact/k6/js/modules/k6/grpc.(*Client).Load(0xc001dcfa80, 0xc001da1a90, 0x1e40b18, 0x0, 0x0, 0xc001e06390, 0x1, 0x1, 0x0, 0x0, ...)\r\n        github.com/loadimpact/k6/js/modules/k6/grpc/client.go:142 +0x246\r\nreflect.Value.call(0x11ba3e0, 0xc001dcfa80, 0x1613, 0x1291780, 0x9, 0xc00033c230, 0x3, 0x3, 0xb, 0x10a7e60, ...)\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n<!--- Provide the exact commands, environment variables and relevant script(s) to reproduce this bug. -->\r\n\r\nYou need to be sure you already installed docker.\r\n\r\n1. Save greeter.proto file\r\n```proto\r\n// Copyright 2015 The gRPC Authors\r\n//\r\n// Licensed under the Apache License, Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//     http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\nsyntax = \"proto3\";\r\n\r\noption java_multiple_files = true;\r\noption java_package = \"io.grpc.examples.helloworld\";\r\noption java_outer_classname = \"HelloWorldProto\";\r\n\r\npackage helloworld;\r\n\r\n// The greeting service definition.\r\nservice Greeter {\r\n  // Sends a greeting\r\n  rpc SayHello (HelloRequest) returns (HelloReply) {}\r\n}\r\n\r\n// The request message containing the user's name.\r\nmessage HelloRequest {\r\n  string name = 1;\r\n}\r\n\r\n// The response message containing the greetings\r\nmessage HelloReply {\r\n  string message = 1;\r\n}\r\n```\r\n\r\n2. Save grpc-test.js file in the same directory\r\n```js\r\nimport grpc from 'k6/net/grpc';\r\nimport {check, sleep} from 'k6';\r\n\r\nconst client = new grpc.Client();\r\nclient.load([], 'greeter.proto');\r\n\r\nexport default () => {\r\n    client.connect('localhost:6565', {\r\n        plaintext: true\r\n    });\r\n    const data = {\r\n        name: 'hojong'\r\n    };\r\n    const response = client.invoke('helloworld.Greeter/SayHello', data);\r\n    check(response, {\r\n        'status is OK': (r) => r && r.status === grpc.StatusOK,\r\n    });\r\n    console.log(JSON.stringify(response.message));\r\n    client.close();\r\n    sleep(1);\r\n};\r\n```\r\n\r\n3. Run local gRPC Server with port 6565. You can use my server example. (It requires java)\r\n```sh\r\ngit clone https://github.com/hojongs/spring-boot-example.git\r\ncd spring-boot-example/grpc/\r\n./gradlew bootRun # I used git bash\r\n```\r\n\r\n4. Run docker k6 with the proto, js. (at the same directory)\r\n```sh\r\ndocker run -i -v greeter.proto:/greeter.proto loadimpact/k6 run - < ./grpc-test.js\r\n```\r\n\r\nMy OS uses EUC-KR file encoding default (unlike UTF-8). So I tried proto file with both encoding UTF-8 and EUC-KR. but the both cases are failed with same error message. So I think it's not file encoding problem.\r\n","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/1928/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/1928/timeline","performed_via_github_app":null,"state_reason":"completed"}