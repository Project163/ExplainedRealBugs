{"url":"https://api.github.com/repos/grafana/k6/issues/284","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/284/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/284/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/284/events","html_url":"https://github.com/grafana/k6/issues/284","id":243256119,"node_id":"MDU6SXNzdWUyNDMyNTYxMTk=","number":284,"title":"HTTP requests in the init context","user":{"login":"rafaelcapucho","id":163367,"node_id":"MDQ6VXNlcjE2MzM2Nw==","avatar_url":"https://avatars.githubusercontent.com/u/163367?v=4","gravatar_id":"","url":"https://api.github.com/users/rafaelcapucho","html_url":"https://github.com/rafaelcapucho","followers_url":"https://api.github.com/users/rafaelcapucho/followers","following_url":"https://api.github.com/users/rafaelcapucho/following{/other_user}","gists_url":"https://api.github.com/users/rafaelcapucho/gists{/gist_id}","starred_url":"https://api.github.com/users/rafaelcapucho/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rafaelcapucho/subscriptions","organizations_url":"https://api.github.com/users/rafaelcapucho/orgs","repos_url":"https://api.github.com/users/rafaelcapucho/repos","events_url":"https://api.github.com/users/rafaelcapucho/events{/privacy}","received_events_url":"https://api.github.com/users/rafaelcapucho/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191761,"node_id":"MDU6TGFiZWwzNDUxOTE3NjE=","url":"https://api.github.com/repos/grafana/k6/labels/help%20wanted","name":"help wanted","color":"159818","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2017-07-16T18:12:29Z","updated_at":"2020-07-13T10:46:16Z","closed_at":"2018-10-16T15:09:54Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi, I noted that I'm unable to call functions outside of the `export default function`, as the following example:\r\n\r\n\r\n```\r\nimport http from \"k6/http\";\r\nimport { check, fail } from \"k6\";\r\n\r\nconst host = __ENV.HOST || \"django:8000\";\r\nconst headers = {\r\n  \"Content-Type\": \"application/json\",\r\n  \"Authorization\": 'Bearer *******',\r\n};\r\n\r\nfunction get_organizations_id(){\r\n    var ids = new Array();\r\n    let response_get = http.get(`http://${host}/api/1.0/organizations/`, {headers: headers});\r\n    response_get.json().results.forEach((x, i) => {\r\n      ids.push(x.id);\r\n    });\r\n    return ids;\r\n}\r\n\r\nlet organization_ids = get_organizations_id();   // <---- It produces errors\r\n\r\nexport default function() {\r\n    console.log(get_organizations_id()); // <----- It works as expected\r\n};\r\n```\r\n\r\nI left two comments pointing the function calls.\r\nThe error that it produces when I call it outside of `default function` is like:\r\n\r\n```\r\npanic: runtime error: invalid memory address or nil pointer dereference [recovered]\r\n\tpanic: Panic at 19: runtime error: invalid memory address or nil pointer dereference [recovered]\r\n\tpanic: Panic at 19: runtime error: invalid memory address or nil pointer dereference\r\n[signal SIGSEGV: segmentation violation code=0x1 addr=0x88 pc=0x8cb2e0]\r\n\r\ngoroutine 1 [running]:\r\npanic(0xa04e80, 0xc4206769e0)\r\n\t/usr/local/go/src/runtime/panic.go:500 +0x1a1\r\ngithub.com/dop251/goja.(*Runtime).RunProgram.func1(0xc420460308)\r\n\t/go/src/github.com/dop251/goja/runtime.go:795 +0xa4\r\npanic(0xa04e80, 0xc4206769e0)\r\n\t/usr/local/go/src/runtime/panic.go:458 +0x243\r\ngithub.com/dop251/goja.(*vm).try.func1(0xc4201761a0, 0x0, 0xc4204601e0, 0x0, 0x0, 0x0, 0xc420460238)\r\n\t/go/src/github.com/dop251/goja/vm.go:364 +0x400\r\npanic(0xa14860, 0xc420012080)\r\n\t/usr/local/go/src/runtime/panic.go:458 +0x243\r\ngithub.com/loadimpact/k6/js/modules/k6/http.(*HTTP).request(0xf441c8, 0xdb98c0, 0xc422fa00c0, 0xc420785500, 0x0, 0xabca46, 0x3, 0xdbdec0, 0xc4206768f0, 0xc4215577c0, ...)\r\n\t/go/src/github.com/loadimpact/k6/js/modules/k6/http/http.go:130 +0x210\r\ngithub.com/loadimpact/k6/js/modules/k6/http.(*HTTP).Request(0xf441c8, 0xdb98c0, 0xc422fa00c0, 0xabca46, 0x3, 0xdbdec0, 0xc4206768f0, 0xc4215577c0, 0x2, 0x2, ...)\r\n\t/go/src/github.com/loadimpact/k6/js/modules/k6/http/http.go:256 +0x11d\r\ngithub.com/loadimpact/k6/js/modules/k6/http.(*HTTP).Get(0xf441c8, 0xdb98c0, 0xc422fa00c0, 0xdbdec0, 0xc4206768f0, 0xc420676980, 0x1, 0x1, 0x0, 0x0, ...)\r\n\t/go/src/github.com/loadimpact/k6/js/modules/k6/http/http.go:264 +0x17e\r\nreflect.Value.call(0xa74ac0, 0xf441c8, 0xa13, 0xac24af, 0x9, 0xc420262dc0, 0x3, 0x3, 0xb1458d, 0xa428a0, ...)\r\n\t/usr/local/go/src/reflect/value.go:434 +0x5c8\r\nreflect.Value.CallSlice(0xa74ac0, 0xf441c8, 0xa13, 0xc420262dc0, 0x3, 0x3, 0x2, 0x2, 0x28)\r\n\t/usr/local/go/src/reflect/value.go:315 +0xa4\r\ngithub.com/loadimpact/k6/js/common.Bind.func1(0xc420849a10, 0x2, 0x2, 0xc420849a10, 0x0, 0x2)\r\n\t/go/src/github.com/loadimpact/k6/js/common/bridge.go:170 +0x230\r\nreflect.callReflect(0xc421556560, 0xc42045f9e8)\r\n\t/usr/local/go/src/reflect/value.go:506 +0x39e\r\nreflect.makeFuncStub(0xdbdec0, 0xc4206768f0, 0xc420676980, 0x1, 0x1, 0x0, 0xc4208499f0, 0xc421557680, 0xc42045fd78, 0x61d1a8, ...)\r\n\t/usr/local/go/src/reflect/asm_amd64.s:17 +0x40\r\nreflect.Value.call(0xc421a549c0, 0xc421556560, 0x13, 0xabcf17, 0x4, 0xc420849980, 0x2, 0x2, 0x0, 0x0, ...)\r\n\t/usr/local/go/src/reflect/value.go:434 +0x5c8\r\nreflect.Value.Call(0xc421a549c0, 0xc421556560, 0x13, 0xc420849980, 0x2, 0x2, 0xc421557620, 0x16, 0x0)\r\n\t/usr/local/go/src/reflect/value.go:302 +0xa4\r\ngithub.com/dop251/goja.(*Runtime).wrapReflectFunc.func1(0xdbdce0, 0xc421556780, 0xc42139ad60, 0x2, 0xa, 0x0, 0x0)\r\n\t/go/src/github.com/dop251/goja/runtime.go:1062 +0x859\r\ngithub.com/dop251/goja.(*vm)._nativeCall(0xc4201761a0, 0xc42023d290, 0x2)\r\n\t/go/src/github.com/dop251/goja/vm.go:1827 +0x2d0\r\ngithub.com/dop251/goja.call.exec(0xc400000002, 0xc4201761a0)\r\n\t/go/src/github.com/dop251/goja/vm.go:1808 +0x749\r\ngithub.com/dop251/goja.(*call).exec(0xc420681ce0, 0xc4201761a0)\r\n\t<autogenerated>:816 +0x5a\r\ngithub.com/dop251/goja.(*vm).run(0xc4201761a0)\r\n\t/go/src/github.com/dop251/goja/vm.go:288 +0x92\r\ngithub.com/dop251/goja.(*vm).(github.com/dop251/goja.run)-fm()\r\n\t/go/src/github.com/dop251/goja/vm.go:375 +0x2a\r\ngithub.com/dop251/goja.(*vm).try(0xc4201761a0, 0xc420460240, 0x0)\r\n\t/go/src/github.com/dop251/goja/vm.go:370 +0x143\r\ngithub.com/dop251/goja.(*vm).runTry(0xc4201761a0, 0xb16f18)\r\n\t/go/src/github.com/dop251/goja/vm.go:375 +0x4f\r\ngithub.com/dop251/goja.(*Runtime).RunProgram(0xc420785500, 0xc421b03c20, 0x0, 0x0, 0x0, 0x0)\r\n\t/go/src/github.com/dop251/goja/runtime.go:806 +0x212\r\ngithub.com/loadimpact/k6/js.(*Bundle).instantiate(0xc420d7a780, 0xc420785500, 0xc4217c8b80, 0x0, 0xc420847e90)\r\n\t/go/src/github.com/loadimpact/k6/js/bundle.go:226 +0x529\r\ngithub.com/loadimpact/k6/js.NewBundle(0xc420e2e1e0, 0xdbd600, 0xf441c8, 0x7f9a59546e10, 0x0, 0xc421f9af00)\r\n\t/go/src/github.com/loadimpact/k6/js/bundle.go:99 +0x498\r\ngithub.com/loadimpact/k6/js.New(0xc420e2e1e0, 0xdbd600, 0xf441c8, 0x2, 0xa6de01, 0x1)\r\n\t/go/src/github.com/loadimpact/k6/js/runner.go:51 +0x43\r\nmain.makeRunner(0xabc89b, 0x2, 0xc420e2e1e0, 0xdbd600, 0xf441c8, 0xc42002a008, 0xdbd600, 0xf441c8, 0xc420e2e1e0)\r\n\t/go/src/github.com/loadimpact/k6/run.go:247 +0x2b4\r\nmain.actionRun(0xc4223e1b80, 0x10100, 0xc4223e1b80)\r\n\t/go/src/github.com/loadimpact/k6/run.go:404 +0x40d\r\ngopkg.in/urfave/cli%2ev1.HandleAction(0x9f5d40, 0xb174d0, 0xc4223e1b80, 0xc421facd00, 0x0)\r\n\t/go/src/gopkg.in/urfave/cli.v1/app.go:485 +0xd4\r\ngopkg.in/urfave/cli%2ev1.Command.Run(0xabccf2, 0x3, 0x0, 0x0, 0x0, 0x0, 0x0, 0xace85f, 0x1a, 0x0, ...)\r\n\t/go/src/gopkg.in/urfave/cli.v1/command.go:193 +0xb96\r\ngopkg.in/urfave/cli%2ev1.(*App).Run(0xc4200664e0, 0xc42000c1b0, 0x9, 0x9, 0x0, 0x0)\r\n\t/go/src/gopkg.in/urfave/cli.v1/app.go:250 +0x812\r\nmain.main()\r\n\t/go/src/github.com/loadimpact/k6/main.go:82 +0x5ec\r\n```\r\n\r\nI'd like to execute it from outside because it must execute only once, the tests itself will use it later on.\r\nThanks!","closed_by":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/284/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/284/timeline","performed_via_github_app":null,"state_reason":"completed"}