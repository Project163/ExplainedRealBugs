{"url":"https://api.github.com/repos/grafana/k6/issues/1492","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/1492/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/1492/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/1492/events","html_url":"https://github.com/grafana/k6/issues/1492","id":635199968,"node_id":"MDU6SXNzdWU2MzUxOTk5Njg=","number":1492,"title":"Simplify the vuHandle implementation","user":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":874564661,"node_id":"MDU6TGFiZWw4NzQ1NjQ2NjE=","url":"https://api.github.com/repos/grafana/k6/labels/refactor","name":"refactor","color":"fbca04","default":false,"description":""},{"id":874929364,"node_id":"MDU6TGFiZWw4NzQ5MjkzNjQ=","url":"https://api.github.com/repos/grafana/k6/labels/lower%20prio","name":"lower prio","color":"fef2c0","default":false,"description":""},{"id":1079102926,"node_id":"MDU6TGFiZWwxMDc5MTAyOTI2","url":"https://api.github.com/repos/grafana/k6/labels/evaluation%20needed","name":"evaluation needed","color":"006B75","default":false,"description":"proposal needs to be validated or tested before fully implementing it in k6"},{"id":1773972841,"node_id":"MDU6TGFiZWwxNzczOTcyODQx","url":"https://api.github.com/repos/grafana/k6/labels/executors","name":"executors","color":"f9d0c4","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-06-09T07:57:52Z","updated_at":"2020-06-18T07:21:54Z","closed_at":"2020-06-18T07:21:53Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"As I mentioned in https://github.com/loadimpact/k6/pull/1479#pullrequestreview-426625213, I don't like how complex the `vuHandle` implementation has gotten. True, its job is very tricky, so I am a bit skeptical about my gut feeling we can simplify it... It has to deal with a few gnarly synchronization issues:\r\n1. The `gracefulStop` / `gracefulRampDown` handling, which can require a VU that is in the process of gracefully shutting down to resume again, without ever returning the VU to the pool, if we suddenly ramp up. And we don't know how long the last iteration it's executing is going to be, so it can end at basically any time in that process, or not at all... :sob: \r\n2. The VU deactivation, which, because of the way we stop their goja JS runtime (by necessity), happens a bit after the VU context is cancelled...\r\n3. The unpredictable nature of the `externally-controlled` executor...\r\n\r\nI initially thought that this will finally be a job for [`sync.Cond`](https://golang.org/pkg/sync/#Cond), but because of the `context` we require for JS execution and deactivation, it really doesn't seem to be of much use, though I might be missing something :disappointed: That said, it might not be totally out of place in some bigger refactoring, for example if we use the `changed` atomic more broadly. That is, if instead of just signalling that something has changed, we use a few different values to signal the current state `Stopped` / `Running` / `GracefullyStopping` that the executor is supposed to be in... But that has issues of its own, namely something has to cancel the VU context...\r\n\r\nSomething else to consider... For `variable-looping-vus` executor, we can know the precise time each VU is supposed to run, including the `gracefulStop` value. It will become easier to calculate once we zip `rawStepEvents` and `gracefulLimitEvents` in a single plan, to address https://github.com/loadimpact/k6/issues/1473. So, instead of having a resident goroutine for each VU we want to run (i.e. a stopped `vuHandle`), we can launch new goroutines every time we ramp up, and give 2 unique contexts to each of them, somewhat similar to what we do with the executor contexts, ` maxDurationCtx, regDurationCtx, cancel := getDurationContexts()`... That would still leave the problem of what to do with the `externally-controlled` executor though... \r\n\r\nAnd it also won't solve the issues with rapid ramp-down, ramp-up events. In these, we may have a situation where a VU is in the process of gracefully stopping, but it's still executing its last iteration. And if, before the `gracefulRampDown` time expires, we ramp up to that VU again, the VU never has to stop. So, in this case, what we do on the iteration length - for short iteration, we would have returned the VU to the buffer, but for iterations longer than the gap, it should be as if there was never any interruption in the VU running at all. This is the trickiest issue that I can't think of any other way besides a \"`vuHandle`\" to solve... :disappointed: \r\n\r\nSo yeah, leaving this here for some future time, if we have any bright ideas... Or, we can close this a few months from now and just use my ramblings above as a documentation/justification of the current approach :sweat_smile: ","closed_by":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/1492/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/1492/timeline","performed_via_github_app":null,"state_reason":"completed"}