{"url":"https://api.github.com/repos/grafana/k6/issues/1601","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/1601/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/1601/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/1601/events","html_url":"https://github.com/grafana/k6/issues/1601","id":683576261,"node_id":"MDU6SXNzdWU2ODM1NzYyNjE=","number":1601,"title":"Add recover() check on each iteration to guard against goja panics","user":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191760,"node_id":"MDU6TGFiZWwzNDUxOTE3NjA=","url":"https://api.github.com/repos/grafana/k6/labels/enhancement","name":"enhancement","color":"5319E7","default":true,"description":""},{"id":774850989,"node_id":"MDU6TGFiZWw3NzQ4NTA5ODk=","url":"https://api.github.com/repos/grafana/k6/labels/good%20first%20issue","name":"good first issue","color":"bfd4f2","default":true,"description":null},{"id":874927263,"node_id":"MDU6TGFiZWw4NzQ5MjcyNjM=","url":"https://api.github.com/repos/grafana/k6/labels/high%20prio","name":"high prio","color":"D93F0B","default":false,"description":""},{"id":1079362808,"node_id":"MDU6TGFiZWwxMDc5MzYyODA4","url":"https://api.github.com/repos/grafana/k6/labels/hacktoberfest","name":"hacktoberfest","color":"562c3f","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/grafana/k6/milestones/11","html_url":"https://github.com/grafana/k6/milestone/11","labels_url":"https://api.github.com/repos/grafana/k6/milestones/11/labels","id":5853332,"node_id":"MDk6TWlsZXN0b25lNTg1MzMzMg==","number":11,"title":"v0.29.0","description":"","creator":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":47,"state":"closed","created_at":"2020-09-08T07:26:34Z","updated_at":"2021-01-19T11:53:02Z","due_on":"2020-11-09T08:00:00Z","closed_at":"2020-11-11T14:39:15Z"},"comments":0,"created_at":"2020-08-21T13:50:23Z","updated_at":"2020-11-02T13:23:54Z","closed_at":"2020-11-02T13:23:54Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We've seen this panic when a k6 instance was stopped (essentially equivalent to `curl -X PATCH --data '{\"data\":{\"type\":\"status\",\"id\":\"default\",\"attributes\":{\"stopped\":true}}}' 'http://localhost:6565/v1/status'`):\r\n```\r\nexit status 2\r\n\r\npanic: runtime error: invalid memory address or nil pointer dereference [recovered]\r\n\tpanic: runtime error: invalid memory address or nil pointer dereference [recovered]\r\n\tpanic: runtime error: invalid memory address or nil pointer dereference\r\n[signal SIGSEGV: segmentation violation code=0x1 addr=0x8 pc=0x8ecaa0]\r\n\r\ngoroutine 106 [running]:\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.AssertFunction.func1.1(0xc028769b08)\r\n\t/home/alpine/go/src/github.com/loadimpact/k6/vendor/github.com/dop251/goja/runtime.go:1489 +0x98\r\npanic(0xd7b6a0, 0x19917f0)\r\n\t/usr/local/go/src/runtime/panic.go:969 +0x166\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*vm).try.func1(0xc006eabee0, 0x0, 0xc0287699e0, 0x0, 0x0, 0x0, 0xc028769a58)\r\n\t/home/alpine/go/src/github.com/loadimpact/k6/vendor/github.com/dop251/goja/vm.go:377 +0x3da\r\npanic(0xd7b6a0, 0x19917f0)\r\n\t/usr/local/go/src/runtime/panic.go:969 +0x166\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*vm).run(0xc006eabee0)\r\n\t/home/alpine/go/src/github.com/loadimpact/k6/vendor/github.com/dop251/goja/vm.go:289 +0x60\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*funcObject).Call(0xc00b8d5e00, 0x10ec460, 0x19d6600, 0xc0253f23b0, 0x1, 0x1, 0x203009, 0xc028769990)\r\n\t/home/alpine/go/src/github.com/loadimpact/k6/vendor/github.com/dop251/goja/func.go:154 +0x2cc\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.AssertFunction.func1.2()\r\n\t/home/alpine/go/src/github.com/loadimpact/k6/vendor/github.com/dop251/goja/runtime.go:1494 +0x96\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*vm).try(0xc006eabee0, 0xc028769a70, 0x0)\r\n\t/home/alpine/go/src/github.com/loadimpact/k6/vendor/github.com/dop251/goja/vm.go:383 +0x132\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.AssertFunction.func1(0x10ec460, 0x19d6600, 0xc0253f23b0, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0)\r\n\t/home/alpine/go/src/github.com/loadimpact/k6/vendor/github.com/dop251/goja/runtime.go:1493 +0xfc\r\ngithub.com/loadimpact/k6/js.(*VU).runFn(0xc0044a4990, 0x10df620, 0xc023dbee40, 0x1, 0xc001e0e3c0, 0xc0253f23b0, 0x1, 0x1, 0x10ec460, 0x19d6600, ...)\r\n\t/home/alpine/go/src/github.com/loadimpact/k6/js/runner.go:554 +0x14e\r\ngithub.com/loadimpact/k6/js.(*ActiveVU).RunOnce(0xc0258d14e0, 0x0, 0x0)\r\n\t/home/alpine/go/src/github.com/loadimpact/k6/js/runner.go:517 +0x220\r\ngithub.com/loadimpact/k6/lib/executor.getIterationRunner.func1(0x10df560, 0xc01cb51ac0, 0x10cc400, 0xc0258d14e0, 0x1)\r\n\t/home/alpine/go/src/github.com/loadimpact/k6/lib/executor/helpers.go:86 +0x5e\r\ngithub.com/loadimpact/k6/lib/executor.(*vuHandle).runLoopsIfPossible(0xc027609100, 0xc005d65ee0)\r\n\t/home/alpine/go/src/github.com/loadimpact/k6/lib/executor/vu_handle.go:220 +0x53a\r\ncreated by github.com/loadimpact/k6/lib/executor.RampingVUs.Run\r\n\t/home/alpine/go/src/github.com/loadimpact/k6/lib/executor/ramping_vus.go:632 +0xc36\r\n```\r\n\r\nIt's nigh impossible to reproduce, and while panics should _never_ happen in k6, the bigger problem here is that everything dies because a single VU had some weird issue. So, after https://github.com/loadimpact/k6/issues/877#issuecomment-673328354 or something like it is done, we should add `recover()` around each executed JS iteration. If it panicked, we should emit a `interrupted_iterations{cause:error} =1` metric, or maybe even `interrupted_iterations{cause:panic}`... We should also log the panic via our logger, with a [`PanicLevel`](https://godoc.org/github.com/sirupsen/logrus#PanicLevel), but we shouldn't actually panic and abort the whole k6 process! ","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/1601/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/1601/timeline","performed_via_github_app":null,"state_reason":"completed"}