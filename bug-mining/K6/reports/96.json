{"url":"https://api.github.com/repos/grafana/k6/issues/659","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/659/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/659/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/659/events","html_url":"https://github.com/grafana/k6/issues/659","id":327584411,"node_id":"MDU6SXNzdWUzMjc1ODQ0MTE=","number":659,"title":"ES6 modules instantiation works incorrectly","user":{"login":"chip700","id":39755850,"node_id":"MDQ6VXNlcjM5NzU1ODUw","avatar_url":"https://avatars.githubusercontent.com/u/39755850?v=4","gravatar_id":"","url":"https://api.github.com/users/chip700","html_url":"https://github.com/chip700","followers_url":"https://api.github.com/users/chip700/followers","following_url":"https://api.github.com/users/chip700/following{/other_user}","gists_url":"https://api.github.com/users/chip700/gists{/gist_id}","starred_url":"https://api.github.com/users/chip700/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chip700/subscriptions","organizations_url":"https://api.github.com/users/chip700/orgs","repos_url":"https://api.github.com/users/chip700/repos","events_url":"https://api.github.com/users/chip700/events{/privacy}","received_events_url":"https://api.github.com/users/chip700/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191758,"node_id":"MDU6TGFiZWwzNDUxOTE3NTg=","url":"https://api.github.com/repos/grafana/k6/labels/bug","name":"bug","color":"b60205","default":true,"description":""},{"id":874927263,"node_id":"MDU6TGFiZWw4NzQ5MjcyNjM=","url":"https://api.github.com/repos/grafana/k6/labels/high%20prio","name":"high prio","color":"D93F0B","default":false,"description":""},{"id":949381702,"node_id":"MDU6TGFiZWw5NDkzODE3MDI=","url":"https://api.github.com/repos/grafana/k6/labels/js-compat","name":"js-compat","color":"ea8394","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2018-05-30T05:59:46Z","updated_at":"2020-07-13T10:47:05Z","closed_at":"2019-03-28T08:56:40Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"K6 handles E6 modules in such a way that multiple 'import' clause creates multiple instances of imported module.\r\nTo illustrate the issue I created a minimal test scenario (attached).\r\nThese is a 'i1_common' module exporting a 'context' object.\r\nThese are also additional 'i1_module' module and 'i1_main' - main test script module.\r\n'context' object from 'i1_common' module is exported both in 'i1_module' and in 'i1_main' module.\r\nThis must be handled so that inside 'i1_main' module and inside 'i1_module' we work with the same instance of imported 'context' object, But as we see in the output this is not what happens.\r\nWhen executing by k6 engine 'common' module is instantiated twice and 'i1_main' module and 'i1_module' get each its own separate instance of imported 'context' object.\r\nAs a reference implementation I created i1_index.html (attached) to run the same set of modules in browser. The below is the output from browser execution:\r\nmain 1:initial\r\nmodule1_func 1:initial\r\nmodule1_func 2:set_by_module1\r\nmain 2:set_by_module1   <<<< HERE IS THE DIFFERENCE\r\nmain 3:set_by_main\r\nHere is the output from K6 execution:\r\nmain 1:initial\r\nmodule1_func 1:initial\r\nmodule1_func 2:set_by_module1\r\nmain 2:initial      <<<< HERE IS THE DIFFERENCE\r\nmain 3:set_by_main\r\n\r\nThis is tested with K6 executible version k6-v0.21.0-win64\r\n\r\n[es6_modules_issue.zip](https://github.com/loadimpact/k6/files/2052574/es6_modules_issue.zip)\r\n","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/659/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/659/timeline","performed_via_github_app":null,"state_reason":"completed"}