{"url":"https://api.github.com/repos/grafana/k6/issues/2598","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/2598/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/2598/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/2598/events","html_url":"https://github.com/grafana/k6/issues/2598","id":1304503136,"node_id":"I_kwDOAz4Wr85NwSNg","number":2598,"title":"Create modulesTestState helper","user":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191761,"node_id":"MDU6TGFiZWwzNDUxOTE3NjE=","url":"https://api.github.com/repos/grafana/k6/labels/help%20wanted","name":"help wanted","color":"159818","default":true,"description":null},{"id":1079102926,"node_id":"MDU6TGFiZWwxMDc5MTAyOTI2","url":"https://api.github.com/repos/grafana/k6/labels/evaluation%20needed","name":"evaluation needed","color":"006B75","default":false,"description":"proposal needs to be validated or tested before fully implementing it in k6"},{"id":2743341216,"node_id":"MDU6TGFiZWwyNzQzMzQxMjE2","url":"https://api.github.com/repos/grafana/k6/labels/documentation-needed","name":"documentation-needed","color":"1AE598","default":false,"description":"A PR which will need a separate PR for documentation"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/grafana/k6/milestones/27","html_url":"https://github.com/grafana/k6/milestone/27","labels_url":"https://api.github.com/repos/grafana/k6/milestones/27/labels","id":8061330,"node_id":"MI_kwDOAz4Wr84AewGS","number":27,"title":"v0.40.0","description":"","creator":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":58,"state":"closed","created_at":"2022-06-08T07:51:26Z","updated_at":"2022-09-13T16:16:34Z","due_on":"2022-09-08T07:00:00Z","closed_at":"2022-09-08T09:18:04Z"},"comments":1,"created_at":"2022-07-14T09:19:10Z","updated_at":"2022-07-28T13:03:30Z","closed_at":"2022-07-28T12:57:39Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Across k6 and many extensions it is common to need to recreate how k6 will execute an extension. \r\n\r\nThis in general includes creating\r\n1. goja.Runtime\r\n2. lib.State\r\n3. common.InitEnv\r\n4. modules.VU\r\n5. an instance of a specific js module we need\r\n6. since recently an event loop\r\ncombine all of them and run a script. \r\n\r\nThis isn't exactly hard but there are bunch of stuff that arguably can just be extracted in a helper struct and used across k6 and extensions. \r\n\r\nNo particular design is proposed, but I will link to some such places: \r\n* [xk6-websockets](https://github.com/grafana/xk6-websockets/blob/216d8554d09e3f624a100c3e7433a59b3aa9cae0/websockets/websockets_test.go#L53-L108)\r\n* [k6/http](https://github.com/grafana/k6/blob/7cdc0b18226a37f8cb90cacb57f81232d2298158/js/modules/k6/http/request_test.go#L131-L170) where it isn't evne a struct but returns 5 results :facepalm: \r\n* [k6/ws](https://github.com/grafana/k6/blob/7cdc0b18226a37f8cb90cacb57f81232d2298158/js/modules/k6/ws/ws_test.go#L96-L147)\r\n* [k6/grpc](https://github.com/grafana/k6/blob/master/js/modules/k6/grpc/client_test.go#L63-L70)\r\n\r\nThere are many more, I am also pretty certain there was one that went from init context evaluation to vu context ... but can't find it. (related to this [comment](https://github.com/grafana/xk6-redis/pull/5#discussion_r920915870))","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/2598/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/2598/timeline","performed_via_github_app":null,"state_reason":"completed"}