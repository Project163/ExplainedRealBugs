{"url":"https://api.github.com/repos/grafana/k6/issues/2912","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/2912/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/2912/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/2912/events","html_url":"https://github.com/grafana/k6/issues/2912","id":1581377775,"node_id":"I_kwDOAz4Wr85eQejv","number":2912,"title":"`check` randomly returning true unexpectedly","user":{"login":"pcsegal","id":7880893,"node_id":"MDQ6VXNlcjc4ODA4OTM=","avatar_url":"https://avatars.githubusercontent.com/u/7880893?v=4","gravatar_id":"","url":"https://api.github.com/users/pcsegal","html_url":"https://github.com/pcsegal","followers_url":"https://api.github.com/users/pcsegal/followers","following_url":"https://api.github.com/users/pcsegal/following{/other_user}","gists_url":"https://api.github.com/users/pcsegal/gists{/gist_id}","starred_url":"https://api.github.com/users/pcsegal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pcsegal/subscriptions","organizations_url":"https://api.github.com/users/pcsegal/orgs","repos_url":"https://api.github.com/users/pcsegal/repos","events_url":"https://api.github.com/users/pcsegal/events{/privacy}","received_events_url":"https://api.github.com/users/pcsegal/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191758,"node_id":"MDU6TGFiZWwzNDUxOTE3NTg=","url":"https://api.github.com/repos/grafana/k6/labels/bug","name":"bug","color":"b60205","default":true,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/grafana/k6/milestones/32","html_url":"https://github.com/grafana/k6/milestone/32","labels_url":"https://api.github.com/repos/grafana/k6/milestones/32/labels","id":8980326,"node_id":"MI_kwDOAz4Wr84AiQdm","number":32,"title":"v0.44.0","description":"","creator":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":56,"state":"closed","created_at":"2023-01-30T08:18:12Z","updated_at":"2023-04-26T12:52:39Z","due_on":"2023-04-24T07:00:00Z","closed_at":"2023-04-26T12:52:39Z"},"comments":3,"created_at":"2023-02-12T19:16:44Z","updated_at":"2023-03-06T10:20:37Z","closed_at":"2023-03-06T10:20:36Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Brief summary\r\n\r\nDuring local tests with a large number of preallocated VUs, I have encountered situations\r\nwhere `check` should have returned `false`, but it returned `true`.\r\n\r\nThis is difficult to reproduce, since it happens randomly. It seems to be caused by a race condition.\r\n\r\n### k6 version\r\n\r\n0.42.0.\r\n\r\n### OS\r\n\r\nWSL2 (Ubuntu 20.04) in Windows 10.\r\n\r\n### Docker version and image (if applicable)\r\n\r\nDocker version: 23.0.0; image: `loadimpact/k6:0.42.0`.\r\n\r\n### Steps to reproduce the problem\r\n\r\nUnfortunately, this problem is difficult to reproduce. It seems to be caused by a race condition,\r\nand I haven't been able to find a scenario under which it is guaranteed to happen.\r\n\r\nYou may need to run the below steps multiple times before you see the issue come up.\r\n\r\nI was able to see this problem happen several times when running the following minimal example in Docker, using the following command:\r\n\r\n```bash\r\ncat script.js | docker run --cpus=2 --memory=4G -i loadimpact/k6:0.42.0 run -\r\n```\r\n\r\nThe `script.js` file has the following content:\r\n\r\n```js\r\nimport { check, sleep } from 'k6';\r\n\r\nexport const options = {\r\n    scenarios: {\r\n        test: {\r\n            executor: \"constant-arrival-rate\",\r\n            preAllocatedVUs: 20000,\r\n            rate: 10000,\r\n            timeUnit: \"1s\",\r\n            duration: \"60s\",\r\n            exec: \"default\",\r\n        },\r\n    }\r\n};\r\n\r\nfunction randomNumber() {\r\n    return (Math.random() * 5) + 2\r\n}\r\n\r\nexport default function() {\r\n    sleep(randomNumber())\r\n    const checkOutput1 = check(null, {\r\n        \"my check 1\": (res) => false,\r\n    })\r\n    if (checkOutput1) {\r\n        console.log(\"checkOutput1:\", checkOutput1)\r\n    }\r\n    sleep(randomNumber())\r\n    const checkOutput2 = check(null, {\r\n        \"my check 2\": (res) => false,\r\n    })\r\n    if (checkOutput2) {\r\n        console.log(\"checkOutput1:\", checkOutput1, \"checkOutput2:\", checkOutput2)\r\n    }\r\n}\r\n```\r\n\r\n### Expected behaviour\r\n\r\nThe `console.log` lines should never be printed, since both checks always return `false`.\r\n\r\n### Actual behaviour\r\n\r\nSometimes, randomly, one (or both) of the `console.log` lines is printed.","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/2912/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/2912/timeline","performed_via_github_app":null,"state_reason":"completed"}