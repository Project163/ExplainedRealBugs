{"url":"https://api.github.com/repos/grafana/k6/issues/4596","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/4596/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/4596/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/4596/events","html_url":"https://github.com/grafana/k6/issues/4596","id":2887251807,"node_id":"I_kwDOAz4Wr86sF_df","number":4596,"title":"Panic in browser test due to a race","user":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2025-02-28T14:08:34Z","updated_at":"2025-03-06T19:21:36Z","closed_at":"2025-03-06T19:21:36Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"```\nWARNING: DATA RACE\nRead at 0x00c0005eda08 by goroutine 2341:\n  github.com/grafana/sobek.(*Runtime).getArrayBufferPrototype()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/builtin_typedarrays.go:1956 +0x44\n  github.com/grafana/sobek.(*Runtime).NewArrayBuffer()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/typedarrays.go:123 +0x39\n  go.k6.io/k6/internal/js/modules/k6/browser/browser.mapResponse.func2.1()\n      /home/runner/work/k6/k6/internal/js/modules/k6/browser/browser/response_mapping.go:31 +0x95\n  go.k6.io/k6/internal/js/modules/k6/browser/k6ext.promise.func1()\n      /home/runner/work/k6/k6/internal/js/modules/k6/browser/k6ext/promise.go:24 +0x41\n\nPrevious write at 0x00c0005eda08 by goroutine 2381:\n  github.com/grafana/sobek.(*Runtime).getArrayBufferPrototype()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/builtin_typedarrays.go:1959 +0xea\n  github.com/grafana/sobek.(*Runtime).NewArrayBuffer()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/typedarrays.go:123 +0x39\n  go.k6.io/k6/internal/js/modules/k6/browser/browser.mapResponse.func2.1()\n      /home/runner/work/k6/k6/internal/js/modules/k6/browser/browser/response_mapping.go:31 +0x95\n  go.k6.io/k6/internal/js/modules/k6/browser/k6ext.promise.func1()\n      /home/runner/work/k6/k6/internal/js/modules/k6/browser/k6ext/promise.go:24 +0x41\n\nGoroutine 2341 (running) created at:\n  go.k6.io/k6/internal/js/modules/k6/browser/k6ext.promise()\n      /home/runner/work/k6/k6/internal/js/modules/k6/browser/k6ext/promise.go:23 +0x13c\n  go.k6.io/k6/internal/js/modules/k6/browser/k6ext.Promise()\n      /home/runner/work/k6/k6/internal/js/modules/k6/browser/k6ext/promise.go:18 +0x1cc\n  go.k6.io/k6/internal/js/modules/k6/browser/browser.mapResponse.func2()\n      /home/runner/work/k6/k6/internal/js/modules/k6/browser/browser/response_mapping.go:26 +0x38\n  runtime.call16()\n      /opt/hostedtoolcache/go/1.22.12/x64/src/runtime/asm_amd64.s:770 +0x42\n  reflect.Value.Call()\n      /opt/hostedtoolcache/go/1.22.12/x64/src/reflect/value.go:380 +0xb5\n  github.com/grafana/sobek.(*Runtime).newWrappedFunc.(*Runtime).wrapReflectFunc.func1()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/runtime.go:2029 +0x44e\n  github.com/grafana/sobek.(*nativeFuncObject).vmCall()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/func.go:563 +0x333\n  github.com/grafana/sobek.(*wrappedFuncObject).vmCall()\n      <autogenerated>:1 +0x45\n  github.com/grafana/sobek.call.exec()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/vm.go:3719 +0xfa\n  github.com/grafana/sobek.(*call).exec()\n      <autogenerated>:1 +0x4a\n  github.com/grafana/sobek.(*vm).run()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/vm.go:635 +0xc1\n  github.com/grafana/sobek.(*vm).runTryInner()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/vm.go:886 +0x9c\n  github.com/grafana/sobek.(*generator).step()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/func.go:762 +0x64\n  github.com/grafana/sobek.(*generator).next()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/func.go:800 +0x351\n  github.com/grafana/sobek.(*asyncRunner).onFulfilled()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/func.go:686 +0x1cc\n  github.com/grafana/sobek.(*asyncRunner).onFulfilled-fm()\n      <autogenerated>:1 +0xa4\n  github.com/grafana/sobek.(*Runtime).callJobCallback()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/runtime.go:2946 +0x10c\n  github.com/grafana/sobek.(*Promise).fulfill.(*Runtime).triggerPromiseReactions.(*Runtime).newPromiseReactionJob.func1.1()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/builtin_promise.go:214 +0x109\n  github.com/grafana/sobek.(*vm).try()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/vm.go:863 +0x421\n  github.com/grafana/sobek.(*Promise).fulfill.(*Runtime).triggerPromiseReactions.(*Runtime).newPromiseReactionJob.func1()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/builtin_promise.go:213 +0x1db\n  github.com/grafana/sobek.(*Runtime).leave()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/runtime.go:2819 +0x1c3\n  github.com/grafana/sobek.(*Runtime).runWrapped()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/runtime.go:2519 +0x148\n  github.com/grafana/sobek.AssertFunction.func1()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/runtime.go:2469 +0x13d\n  github.com/grafana/sobek.(*Runtime).wrapPromiseReaction.func1()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/builtin_promise.go:602 +0xcb\n  go.k6.io/k6/js/promises.New.func1.1()\n      /home/runner/work/k6/k6/js/promises/promises.go:37 +0x46\n  go.k6.io/k6/internal/js/eventloop.(*EventLoop).Start()\n      /home/runner/work/k6/k6/internal/js/eventloop/eventloop.go:177 +0x27a\n  go.k6.io/k6/js/modulestest.(*Runtime).RunOnEventLoop()\n      /home/runner/work/k6/k6/js/modulestest/runtime.go:111 +0x25e\n  go.k6.io/k6/internal/js/modules/k6/browser/k6ext/k6test.(*VU).RunOnEventLoop()\n      /home/runner/work/k6/k6/internal/js/modules/k6/browser/k6ext/k6test/vu.go:132 +0xc4\n  go.k6.io/k6/internal/js/modules/k6/browser/k6ext/k6test.(*VU).RunAsync()\n      /home/runner/work/k6/k6/internal/js/modules/k6/browser/k6ext/k6test/vu.go:142 +0x10b\n  go.k6.io/k6/internal/js/modules/k6/browser/tests.TestPageOnResponse()\n      /home/runner/work/k6/k6/internal/js/modules/k6/browser/tests/page_test.go:2529 +0x3ab\n  testing.tRunner()\n      /opt/hostedtoolcache/go/1.22.12/x64/src/testing/testing.go:1689 +0x21e\n  testing.(*T).Run.gowrap1()\n      /opt/hostedtoolcache/go/1.22.12/x64/src/testing/testing.go:1742 +0x44\n\nGoroutine 2381 (finished) created at:\n  go.k6.io/k6/internal/js/modules/k6/browser/k6ext.promise()\n      /home/runner/work/k6/k6/internal/js/modules/k6/browser/k6ext/promise.go:23 +0x13c\n  go.k6.io/k6/internal/js/modules/k6/browser/k6ext.Promise()\n      /home/runner/work/k6/k6/internal/js/modules/k6/browser/k6ext/promise.go:18 +0x1cc\n  go.k6.io/k6/internal/js/modules/k6/browser/browser.mapResponse.func2()\n      /home/runner/work/k6/k6/internal/js/modules/k6/browser/browser/response_mapping.go:26 +0x38\n  runtime.call16()\n      /opt/hostedtoolcache/go/1.22.12/x64/src/runtime/asm_amd64.s:770 +0x42\n  reflect.Value.Call()\n      /opt/hostedtoolcache/go/1.22.12/x64/src/reflect/value.go:380 +0xb5\n  github.com/grafana/sobek.(*Runtime).newWrappedFunc.(*Runtime).wrapReflectFunc.func1()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/runtime.go:2029 +0x44e\n  github.com/grafana/sobek.(*nativeFuncObject).vmCall()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/func.go:563 +0x333\n  github.com/grafana/sobek.(*wrappedFuncObject).vmCall()\n      <autogenerated>:1 +0x45\n  github.com/grafana/sobek.call.exec()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/vm.go:3719 +0xfa\n  github.com/grafana/sobek.(*call).exec()\n      <autogenerated>:1 +0x4a\n  github.com/grafana/sobek.(*vm).run()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/vm.go:635 +0xc1\n  github.com/grafana/sobek.(*vm).runTryInner()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/vm.go:886 +0x9c\n  github.com/grafana/sobek.(*generator).step()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/func.go:762 +0x64\n  github.com/grafana/sobek.(*generator).next()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/func.go:800 +0x351\n  github.com/grafana/sobek.(*asyncRunner).onFulfilled()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/func.go:686 +0x1cc\n  github.com/grafana/sobek.(*asyncRunner).onFulfilled-fm()\n      <autogenerated>:1 +0xa4\n  github.com/grafana/sobek.(*Runtime).callJobCallback()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/runtime.go:2946 +0x10c\n  github.com/grafana/sobek.(*Promise).fulfill.(*Runtime).triggerPromiseReactions.(*Runtime).newPromiseReactionJob.func1.1()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/builtin_promise.go:214 +0x109\n  github.com/grafana/sobek.(*vm).try()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/vm.go:863 +0x421\n  github.com/grafana/sobek.(*Promise).fulfill.(*Runtime).triggerPromiseReactions.(*Runtime).newPromiseReactionJob.func1()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/builtin_promise.go:213 +0x1db\n  github.com/grafana/sobek.(*Runtime).leave()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/runtime.go:2819 +0x1c3\n  github.com/grafana/sobek.(*Runtime).runWrapped()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/runtime.go:2519 +0x148\n  github.com/grafana/sobek.AssertFunction.func1()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/runtime.go:2469 +0x13d\n  github.com/grafana/sobek.(*Runtime).wrapPromiseReaction.func1()\n      /home/runner/work/k6/k6/vendor/github.com/grafana/sobek/builtin_promise.go:602 +0xcb\n  go.k6.io/k6/js/promises.New.func1.1()\n      /home/runner/work/k6/k6/js/promises/promises.go:37 +0x46\n  go.k6.io/k6/internal/js/eventloop.(*EventLoop).Start()\n      /home/runner/work/k6/k6/internal/js/eventloop/eventloop.go:177 +0x27a\n  go.k6.io/k6/js/modulestest.(*Runtime).RunOnEventLoop()\n      /home/runner/work/k6/k6/js/modulestest/runtime.go:111 +0x25e\n  go.k6.io/k6/internal/js/modules/k6/browser/k6ext/k6test.(*VU).RunOnEventLoop()\n      /home/runner/work/k6/k6/internal/js/modules/k6/browser/k6ext/k6test/vu.go:132 +0xc4\n  go.k6.io/k6/internal/js/modules/k6/browser/k6ext/k6test.(*VU).RunAsync()\n      /home/runner/work/k6/k6/internal/js/modules/k6/browser/k6ext/k6test/vu.go:142 +0x10b\n  go.k6.io/k6/internal/js/modules/k6/browser/tests.TestPageOnResponse()\n      /home/runner/work/k6/k6/internal/js/modules/k6/browser/tests/page_test.go:2529 +0x3ab\n  testing.tRunner()\n      /opt/hostedtoolcache/go/1.22.12/x64/src/testing/testing.go:1689 +0x21e\n  testing.(*T).Run.gowrap1()\n      /opt/hostedtoolcache/go/1.22.12/x64/src/testing/testing.go:1742 +0x44\n==================\ntime=\"2025-02-28T13:40:23Z\" level=warning msg=\"Please call browser.close only once, and do not use the browser after calling close.\" category=\"Browser:Close\" elapsed=\"0 ms\" source=browser\n--- FAIL: TestPageOnResponse (1.62s)\n    testing.go:1398: race detected during execution of test\ntime=\"2025-02-28T13:40:26Z\" level=warning msg=\"Please call browser.close only once, and do not use the browser after calling close.\" category=\"Browser:Close\" elapsed=\"0 ms\" source=browser\n--- FAIL: TestNavigationSpanCreation (7.47s)\n    testing.go:1398: race detected during execution of test\n--- FAIL: TestSetInputFiles (0.00s)\n    testing.go:1398: race detected during execution of test\n--- FAIL: TestEvalRemoteObjectParse (0.00s)\n    testing.go:1398: race detected during execution of test\n--- FAIL: TestConsoleLogParse (0.00s)\n    testing.go:1398: race detected during execution of test\n```","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/4596/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/4596/timeline","performed_via_github_app":null,"state_reason":"completed"}