{"url":"https://api.github.com/repos/grafana/k6/issues/2842","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/2842/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/2842/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/2842/events","html_url":"https://github.com/grafana/k6/issues/2842","id":1526917391,"node_id":"I_kwDOAz4Wr85bAukP","number":2842,"title":"Async/Await update affected k6-browser JS scripts","user":{"login":"inancgumus","id":621232,"node_id":"MDQ6VXNlcjYyMTIzMg==","avatar_url":"https://avatars.githubusercontent.com/u/621232?v=4","gravatar_id":"","url":"https://api.github.com/users/inancgumus","html_url":"https://github.com/inancgumus","followers_url":"https://api.github.com/users/inancgumus/followers","following_url":"https://api.github.com/users/inancgumus/following{/other_user}","gists_url":"https://api.github.com/users/inancgumus/gists{/gist_id}","starred_url":"https://api.github.com/users/inancgumus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/inancgumus/subscriptions","organizations_url":"https://api.github.com/users/inancgumus/orgs","repos_url":"https://api.github.com/users/inancgumus/repos","events_url":"https://api.github.com/users/inancgumus/events{/privacy}","received_events_url":"https://api.github.com/users/inancgumus/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191758,"node_id":"MDU6TGFiZWwzNDUxOTE3NTg=","url":"https://api.github.com/repos/grafana/k6/labels/bug","name":"bug","color":"b60205","default":true,"description":""}],"state":"closed","locked":false,"assignee":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2023-01-10T07:46:52Z","updated_at":"2023-01-10T15:06:14Z","closed_at":"2023-01-10T15:06:14Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Brief summary\r\n\r\nAs an experiment, we tried updating k6-browser to the latest async/await update in 8418147.\r\n\r\nHowever, we can no longer run our [example JS tests](https://github.com/grafana/xk6-browser/tree/main/examples). Note that our examples were working with k6 v0.42.\r\n\r\nYou can see the CI output [here](https://github.com/grafana/xk6-browser/actions/runs/3875450875/jobs/6619503274).\r\n\r\nAlso see for more context: https://github.com/grafana/xk6-browser/pull/695#issuecomment-1376838090.\r\n\r\n### k6 version\r\n\r\n8418147\r\n\r\n### OS\r\n\r\nmacOS 13.1 and Github CI\r\n\r\n### Docker version and image (if applicable)\r\n\r\n_No response_\r\n\r\n### Steps to reproduce the problem\r\n\r\n1. Clone the xk6-browser repository and switch to the folder\r\n3. Run: `xk6 build master --with github.com/grafana/xk6-browser=.`\r\n4. Run: `./k6 run examples/launch_naked.js`\r\n\r\n### Expected behaviour\r\n\r\nTo see the expected behavior, try running a browser script (i.e., `examples/launch_naked.js`) using k6 v0.42. We were not getting a \"Not a function\" error (which you can see in the actual behavior heading below) while running our example scripts with k6 v0.42.\r\n\r\n### Actual behaviour\r\n\r\nThe following error happens when we use the k6 commit 8418147 in https://github.com/grafana/xk6-browser/pull/695:\r\n\r\n```bash\r\nERRO[0000] test aborted: TypeError: Not a function: [object Object] at file:///Users/inanc/grafana/k6browser/feature/async-await-k6/examples/launch_naked.js:13:20(21)\r\n```\r\n\r\nHere's the full output:\r\n\r\n```bash\r\n$ xk6 build master --with github.com/grafana/xk6-browser=.\r\n...\r\n$ ./k6 run examples/launch_naked.js\r\nrunning (00m00.2s), 0/1 VUs, 0 complete and 1 interrupted iterations\r\ndefault âœ— [======================================] 1 VUs  00m00.2s/10m0s  1/1 iters, 1 per VU\r\nERRO[0000] communicating with browser: websocket: close 1006 (abnormal closure): unexpected EOF  category=cdp elapsed=\"0 ms\" goroutine=98\r\nERRO[0000] process with PID 73411 unexpectedly ended: signal: killed  category=browser elapsed=\"0 ms\" goroutine=80\r\n\r\n     data_received........: 0 B 0 B/s\r\n     data_sent............: 0 B 0 B/s\r\n     iteration_duration...: avg=242.34ms min=242.34ms med=242.34ms max=242.34ms p(90)=242.34ms p(95)=242.34ms\r\n     iterations...........: 1   4.122317/s\r\n\r\nERRO[0000] test aborted: TypeError: Not a function: [object Object] at file:///Users/inanc/grafana/k6browser/feature/async-await-k6/examples/launch_naked.js:13:20(21)\r\n```\r\n\r\n---\r\n\r\n### Update\r\n\r\nIt seems [the xk6-browser mappings](https://github.com/grafana/xk6-browser/blob/main/browser/module.go#L25) no longer work with the latest k6 update (8418147). It was working with k6 v0.42.0. I can run the scripts when I remove the mappings. However, this still indicates a problem somewhere that we need to figure out. What might have changed on the Goja or k6-core side? ðŸ¤”\r\n\r\n### Related\r\n\r\n* https://github.com/grafana/xk6-browser/issues/698\r\n* https://github.com/grafana/xk6-browser/pull/695#issuecomment-1376838090\r\n* https://github.com/grafana/k6/issues/2842\r\n* https://github.com/dop251/goja/issues/469\r\n* https://github.com/grafana/xk6-browser/pull/695","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/2842/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/2842/timeline","performed_via_github_app":null,"state_reason":"completed"}