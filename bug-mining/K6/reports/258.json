{"url":"https://api.github.com/repos/grafana/k6/issues/3534","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/3534/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/3534/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/3534/events","html_url":"https://github.com/grafana/k6/issues/3534","id":2076970250,"node_id":"I_kwDOAz4Wr857zA0K","number":3534,"title":"Fix `require` to be specification compliant in respect to what it resolves relative to","user":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191758,"node_id":"MDU6TGFiZWwzNDUxOTE3NTg=","url":"https://api.github.com/repos/grafana/k6/labels/bug","name":"bug","color":"b60205","default":true,"description":""},{"id":949381702,"node_id":"MDU6TGFiZWw5NDkzODE3MDI=","url":"https://api.github.com/repos/grafana/k6/labels/js-compat","name":"js-compat","color":"ea8394","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/grafana/k6/milestones/42","html_url":"https://github.com/grafana/k6/milestone/42","labels_url":"https://api.github.com/repos/grafana/k6/milestones/42/labels","id":9981299,"node_id":"MI_kwDOAz4Wr84AmE1z","number":42,"title":"v0.53.0","description":"","creator":{"login":"andrewslotin","id":203793,"node_id":"MDQ6VXNlcjIwMzc5Mw==","avatar_url":"https://avatars.githubusercontent.com/u/203793?v=4","gravatar_id":"","url":"https://api.github.com/users/andrewslotin","html_url":"https://github.com/andrewslotin","followers_url":"https://api.github.com/users/andrewslotin/followers","following_url":"https://api.github.com/users/andrewslotin/following{/other_user}","gists_url":"https://api.github.com/users/andrewslotin/gists{/gist_id}","starred_url":"https://api.github.com/users/andrewslotin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrewslotin/subscriptions","organizations_url":"https://api.github.com/users/andrewslotin/orgs","repos_url":"https://api.github.com/users/andrewslotin/repos","events_url":"https://api.github.com/users/andrewslotin/events{/privacy}","received_events_url":"https://api.github.com/users/andrewslotin/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":46,"state":"closed","created_at":"2023-09-29T09:48:25Z","updated_at":"2024-08-13T10:17:26Z","due_on":"2024-08-13T07:00:00Z","closed_at":"2024-08-13T10:17:26Z"},"comments":5,"created_at":"2024-01-11T15:31:13Z","updated_at":"2024-07-26T15:17:47Z","closed_at":"2024-07-17T07:56:30Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Brief summary\r\n\r\nk6's `require` has always resolved specifiers relative to the current \"root of execution\" module/script instead of to relative to the script/module the file is in.\r\n\r\nAn example below will help illustrate what \"root of execution\" is.\r\n\r\nThis behavior has been around forever and is against the [specification](https://wiki.commonjs.org/wiki/Website:Index/specs/modules/1.0) for commonJS and is not how dynamic `import` works or to be honest anything else I have come around.\r\n\r\nThe same issue is true for `open`, but:\r\n1. this is issues is `require` specific to limit it scope\r\n2. `open` is not based on any specification\r\n\r\nFor the rest of the issue I might add \"Also relevant to `open`\" as reminder for this, but `open` is not what we discuss here.\r\n\r\nThis is extracted from #2674 within a more actionable issue \r\n\r\n### k6 version\r\n\r\nall\r\n\r\n### OS\r\n\r\nall\r\n\r\n### Docker version and image (if applicable)\r\n\r\n_No response_\r\n\r\n### Steps to reproduce the problem\r\n\r\nHave 3 files:\r\nmain.js\r\n```javascript\r\nconst s = require(\"./A/a.js\")\r\nif (s() != 5) {\r\n\tthrow \"Bad\"\r\n}\r\nmodule.exports.default = () =>{} // just to not error\r\n```\r\n\r\n/A/a.js:\r\n```javascript\r\nmodule.exports =  function () {\r\n  return require(\"./b.js\");\r\n}\r\n```\r\n/A/b.js\r\n```javascript\r\nmodule.exports = 5\r\n```\r\n\r\nThis should not throw an exception - but it does. As at the time `s()` is executed the \"root of the execution\" is `main.js` not `/A/a.js` and consequently k6  resolves `./b.js` based on that and then loading it from disk doesn't find it leading to\r\n\r\n```\r\nERRO[0000] GoError: The moduleSpecifier \"./b.js\" couldn't be found on local disk. Make sure that you've specified the right path to the file. If you're running k6 using the Docker image make sure you have mounted the local directory (-v /local/path/:/inside/docker/path) containing your script and modules so that they're accessible by k6 from inside of the container, see https://k6.io/docs/using-k6/modules#using-local-modules-with-docker.\r\n        at go.k6.io/k6/js.(*requireImpl).require-fm (native)\r\n        at file:///home/mstoykov/work/k6io/k6/path-based-tests-playground/issue-example/A/a.js:3:16(3)\r\n        at file:///home/mstoykov/work/k6io/k6/path-based-tests-playground/issue-example/main.js:3:6(7)  hint=\"script exception\"\r\n```\r\n\r\n### Expected behaviour\r\n\r\nScript runs as expected and there is no exception.\r\n\r\n### Actual behaviour\r\n\r\n```\r\nERRO[0000] GoError: The moduleSpecifier \"./b.js\" couldn't be found on local disk. Make sure that you've specified the right path to the file. If you're running k6 using the Docker image make sure you have mounted the local directory (-v /local/path/:/inside/docker/path) containing your script and modules so that they're accessible by k6 from inside of the container, see https://k6.io/docs/using-k6/modules#using-local-modules-with-docker.\r\n        at go.k6.io/k6/js.(*requireImpl).require-fm (native)\r\n        at file:///home/mstoykov/work/k6io/k6/path-based-tests-playground/issue-example/A/a.js:3:16(3)\r\n        at file:///home/mstoykov/work/k6io/k6/path-based-tests-playground/issue-example/main.js:3:6(7)  hint=\"script exception\"\r\n```","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/3534/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/3534/timeline","performed_via_github_app":null,"state_reason":"completed"}