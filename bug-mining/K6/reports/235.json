{"url":"https://api.github.com/repos/grafana/k6/issues/2849","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/2849/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/2849/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/2849/events","html_url":"https://github.com/grafana/k6/issues/2849","id":1531104819,"node_id":"I_kwDOAz4Wr85bQs4z","number":2849,"title":"Inconsistent behavior of exec.test.abort within a group","user":{"login":"pomeh","id":285534,"node_id":"MDQ6VXNlcjI4NTUzNA==","avatar_url":"https://avatars.githubusercontent.com/u/285534?v=4","gravatar_id":"","url":"https://api.github.com/users/pomeh","html_url":"https://github.com/pomeh","followers_url":"https://api.github.com/users/pomeh/followers","following_url":"https://api.github.com/users/pomeh/following{/other_user}","gists_url":"https://api.github.com/users/pomeh/gists{/gist_id}","starred_url":"https://api.github.com/users/pomeh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pomeh/subscriptions","organizations_url":"https://api.github.com/users/pomeh/orgs","repos_url":"https://api.github.com/users/pomeh/repos","events_url":"https://api.github.com/users/pomeh/events{/privacy}","received_events_url":"https://api.github.com/users/pomeh/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191758,"node_id":"MDU6TGFiZWwzNDUxOTE3NTg=","url":"https://api.github.com/repos/grafana/k6/labels/bug","name":"bug","color":"b60205","default":true,"description":""},{"id":874927263,"node_id":"MDU6TGFiZWw4NzQ5MjcyNjM=","url":"https://api.github.com/repos/grafana/k6/labels/high%20prio","name":"high prio","color":"D93F0B","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/grafana/k6/milestones/31","html_url":"https://github.com/grafana/k6/milestone/31","labels_url":"https://api.github.com/repos/grafana/k6/milestones/31/labels","id":8713028,"node_id":"MI_kwDOAz4Wr84AhPNE","number":31,"title":"v0.43.0","description":"","creator":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":57,"state":"closed","created_at":"2022-12-02T08:51:35Z","updated_at":"2023-02-20T12:56:35Z","due_on":"2023-02-20T08:00:00Z","closed_at":"2023-02-20T12:56:35Z"},"comments":5,"created_at":"2023-01-12T17:25:26Z","updated_at":"2023-01-13T13:20:53Z","closed_at":"2023-01-13T13:20:52Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Brief summary\n\nIf I use `exec.test.abort` inside a `group` call, the k6 script exits immediately, that's OK.\r\n\r\nBut I got the exit code 0, while [the documentation says it should be 108](https://k6.io/docs/javascript-api/k6-execution/#test):\r\n\r\n> abort([String])\r\n> function\r\n> It aborts the test run with the exit code 108, and an optional string parameter can provide an error message. Aborting the test will not prevent the teardown() execution.\r\n\r\nWhen I move the `exec.test.abort` call outside of the group, the exit code is `108` (what I expect).\n\n### k6 version\n\n0.42.0\n\n### OS\n\nUbuntu 20.04\n\n### Docker version and image (if applicable)\n\ndocker.io/grafana/k6:0.42.0\n\n### Steps to reproduce the problem\n\nHaving 2 files:\r\n\r\n## abort-main.js \r\n\r\n```javascript\r\nimport exec from 'k6/execution';\r\n\r\nexport default function () {\r\n    exec.test.abort(\"failed message from main\");\r\n    console.log(\"will not be visible\");\r\n}\r\n```\r\n\r\n## abort-group.js\r\n\r\n```javascript\r\nimport exec from 'k6/execution';\r\nimport { group } from \"k6\";\r\n\r\nexport default function () {\r\n    group(\"some group\", () => {\r\n        exec.test.abort(\"failed message from group\");\r\n        console.log(\"will not be visible\");\r\n    });\r\n\r\n    console.log(\"will not be visible either\");\r\n}\r\n```\r\n\r\nAnd then, run k6 with both file, using `docker.io/grafana/k6:0.42.0` Docker image, and finally get the exit code (`$?`), like this:\r\n\r\n`docker run --rm -v $(pwd)/:/usr/local/me docker.io/grafana/k6:0.42.0 run /usr/local/me/my-file.js ; echo \"exit code is:\" $?`\n\n### Expected behaviour\n\nI expect following results:\r\n\r\n1. both test failed\r\n2. the exit code is 108\r\n3. the log messages `will not be visible` and `will not be visible either` are not present\r\n4. the error messages `failed message from main` and `failed message from group` are visible\r\n\n\n### Actual behaviour\n\n## abort-main.js\r\n\r\n```\r\n$ docker run --rm -v $(pwd)/:/usr/local/me docker.io/grafana/k6:0.42.0 run /usr/local/me/abort-main.js ; echo \"exit code is:\" $?\r\n\r\n          /\\      |‾‾| /‾‾/   /‾‾/  \r\n     /\\  /  \\     |  |/  /   /  /   \r\n    /  \\/    \\    |     (   /   ‾‾\\  \r\n   /          \\   |  |\\  \\ |  (‾)  | \r\n  / __________ \\  |__| \\__\\ \\_____/ .io\r\n\r\n  execution: local\r\n     script: /usr/local/me/abort-main.js\r\n     output: -\r\n\r\n  scenarios: (100.00%) 1 scenario, 1 max VUs, 10m30s max duration (incl. graceful stop):\r\n           * default: 1 iterations for each of 1 VUs (maxDuration: 10m0s, gracefulStop: 30s)\r\n\r\n\r\nrunning (00m00.0s), 0/1 VUs, 0 complete and 1 interrupted iterations\r\ndefault ✗ [ 100% ] 1 VUs  00m00.0s/10m0s  1/1 iters, 1 per VU\r\n\r\n     data_received........: 0 B 0 B/s\r\n     data_sent............: 0 B 0 B/s\r\n     iteration_duration...: avg=36.8µs min=36.8µs med=36.8µs max=36.8µs p(90)=36.8µs p(95)=36.8µs\r\n     iterations...........: 1   10183.506792/s\r\n\r\nexit code is: 108\r\n```\r\n\r\n### results\r\n\r\n1. ✅ test failed (it's OK because we get `default ✗` message)\r\n2. ✅ the exit code is 108\r\n3. ✅ the log messages `will not be visible` and `will not be visible either` are not present\r\n4. ❌ the error message `failed message from main` is visible (text is missing in the output)\r\n\r\n## abort-group.js\r\n\r\n```\r\n$ docker run --rm -v $(pwd)/:/usr/local/me docker.io/grafana/k6:0.42.0 run /usr/local/me/abort-group.js ; echo \"exit code is:\" $?\r\n\r\n          /\\      |‾‾| /‾‾/   /‾‾/  \r\n     /\\  /  \\     |  |/  /   /  /    \r\n    /  \\/    \\    |     (   /   ‾‾\\  \r\n   /          \\   |  |\\  \\ |  (‾)  | \r\n  / __________ \\  |__| \\__\\ \\_____/ .io\r\n\r\n  execution: local\r\n     script: /usr/local/me/abort-group.js\r\n     output: -\r\n\r\n  scenarios: (100.00%) 1 scenario, 1 max VUs, 10m30s max duration (incl. graceful stop):\r\n           * default: 1 iterations for each of 1 VUs (maxDuration: 10m0s, gracefulStop: 30s)\r\n\r\ntime=\"2023-01-12T16:50:42Z\" level=error msg=\"GoError: test aborted: failed message from group at file:///usr/local/me/abort-group.js:6:24(7)\\n\\tat go.k6.io/k6/js/modules/k6.(*K6).Group-fm (native)\\n\\tat file:///usr/local/me/abort-group.js:5:4(5)\\n\\tat native\\n\" executor=per-vu-iterations scenario=default source=stacktrace\r\n\r\nrunning (00m00.0s), 0/1 VUs, 1 complete and 0 interrupted iterations\r\ndefault ✓ [ 100% ] 1 VUs  00m00.0s/10m0s  1/1 iters, 1 per VU\r\n\r\n     █ some group\r\n\r\n     data_received........: 0 B 0 B/s\r\n     data_sent............: 0 B 0 B/s\r\n     group_duration.......: avg=18.37µs min=18.37µs med=18.37µs max=18.37µs p(90)=18.37µs p(95)=18.37µs\r\n     iteration_duration...: avg=72.52µs min=72.52µs med=72.52µs max=72.52µs p(90)=72.52µs p(95)=72.52µs\r\n     iterations...........: 1   5404.032489/s\r\n\r\nexit code is: 0\r\n```\r\n\r\n### results\r\n\r\n1. ❌ test failed (it's KO because we get `default ✓` message)\r\n2. ❌ the exit code is 0\r\n3. ✅ the log messages `will not be visible` and `will not be visible either` are not present\r\n4. ✅ the error message `failed message from group` is visible\r\n","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/2849/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/2849/timeline","performed_via_github_app":null,"state_reason":"completed"}