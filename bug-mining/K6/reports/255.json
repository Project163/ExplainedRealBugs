{"url":"https://api.github.com/repos/grafana/k6/issues/1906","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/1906/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/1906/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/1906/events","html_url":"https://github.com/grafana/k6/issues/1906","id":831841519,"node_id":"MDU6SXNzdWU4MzE4NDE1MTk=","number":1906,"title":"Fix/Drop the js stacktrace when k6 panics during js execution ","user":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191758,"node_id":"MDU6TGFiZWwzNDUxOTE3NTg=","url":"https://api.github.com/repos/grafana/k6/labels/bug","name":"bug","color":"b60205","default":true,"description":""},{"id":1079102926,"node_id":"MDU6TGFiZWwxMDc5MTAyOTI2","url":"https://api.github.com/repos/grafana/k6/labels/evaluation%20needed","name":"evaluation needed","color":"006B75","default":false,"description":"proposal needs to be validated or tested before fully implementing it in k6"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-03-15T14:00:57Z","updated_at":"2024-05-22T12:46:02Z","closed_at":"2024-05-22T12:46:02Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"After #1697 we had a way to get the location of panic in js code in the form of a js stacktrace from goja ... or so we thought. \r\n\r\nAs explained in https://github.com/dop251/goja/issues/179#issuecomment-783572020 this apparently hasn't really worked, to begin with, and I don't remember it actually being used in practice ... the whole panic wrapping is mostly a precaution on a super rare bug we have not been able to identify or fix. Even https://github.com/dop251/goja/issues/214 wasn't actually caught with that even though the catching of the panics would've prevented it from killing k6.\r\n\r\nFor all we know that one issue could've been fixed in the meantime either by us or goja update  :man_shrugging: \r\n\r\nThe only way to fix it (as explained in the comment linked above) is for the golang code that panics to catch that and repanic with the goja stack at that time before it actually got unwinded. Doing this for each call ... will be very error-prone IMO and adding it to the bridge's Bind will not cover all cases. \r\n\r\nEither way that adds at least 1 more defer per each call, which also will have some performance implications, although I doubt they will be ... big enough. \r\n\r\nI am currently of the opinion that we should just drop the stack and if we start having problems where that would be useful again, to readd them then.\r\n\r\nAlternatively maybe some discussion on whether goja can *not* unwind its stack for this case would be good ... although probably that will be quite a big change.","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/1906/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/1906/timeline","performed_via_github_app":null,"state_reason":"completed"}