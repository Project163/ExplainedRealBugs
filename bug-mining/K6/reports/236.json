{"url":"https://api.github.com/repos/grafana/k6/issues/2825","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/2825/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/2825/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/2825/events","html_url":"https://github.com/grafana/k6/issues/2825","id":1504331303,"node_id":"I_kwDOAz4Wr85ZqkYn","number":2825,"title":"Add `http.asyncRequest`","user":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":869282130,"node_id":"MDU6TGFiZWw4NjkyODIxMzA=","url":"https://api.github.com/repos/grafana/k6/labels/feature","name":"feature","color":"5319E7","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/grafana/k6/milestones/31","html_url":"https://github.com/grafana/k6/milestone/31","labels_url":"https://api.github.com/repos/grafana/k6/milestones/31/labels","id":8713028,"node_id":"MI_kwDOAz4Wr84AhPNE","number":31,"title":"v0.43.0","description":"","creator":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":57,"state":"closed","created_at":"2022-12-02T08:51:35Z","updated_at":"2023-02-20T12:56:35Z","due_on":"2023-02-20T08:00:00Z","closed_at":"2023-02-20T12:56:35Z"},"comments":0,"created_at":"2022-12-20T10:28:39Z","updated_at":"2023-02-01T09:36:29Z","closed_at":"2023-02-01T09:36:28Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Feature Description\n\nWith the addition of event loop months ago, k6 did get the ability to have asynchronous operations, like all the other js tools ;). \r\n\r\nWhile we have added some *experimental* APIs and will likely add more that use this there is a small problem.\r\n\r\nUsing asynchronous APIs in combination with synchronous ones that take long time will *block* the event loop. Which will prevent the asynchronous calls from completing.\r\n\r\n```javascript\r\nexport default () => {\r\n  const ws = new WebSocket(url);\r\n  ws.addEventListener(\"message\", (e) => {\r\n    console.log(e);\r\n  });\r\n  http.get(url2);\r\n  http.get(url3);\r\n  // more http requests\r\n  http.get(url10);\r\n}\r\n```\r\nThis will effectively not log a single message until all the http requests are finished. This might take a few minutes. If the websocket was supposed to return something back there is a very good chance the server would've timeouted this connection. \r\n\r\nIn order for this to not be the case we need asynchronous http call. \r\n\r\nWhile getting the [new-http](https://github.com/grafana/k6/issues?q=is%3Aopen+is%3Aissue+label%3Anew-http) API will be best this is unlikely to happen soon so a stop gap solution seems like a good middle ground.\r\n\n\n### Suggested Solution (optional)\n\nImplement `asyncRequest` with the same signature as `request` but instead of returning the response directly, it will return a Promise that will be resolved with the response or rejected with an error in the same cases as `http.request` would do it.\r\n\r\nNo other changes are at this point proposed including:\r\n1. changes to any of the arguments - as that will likely be more confusing\r\n2. no `http.asyncGet`, `http.asyncPost` and friends. While they might be slightly easier to write, there are already confusion about which have bodies and which not and arguably are saving very small amount of writing. \r\n3. no `http.asyncBatch` - given that `http.batch` is mostly used to do multiple requests at the same time it seems less useful to have this in the case that you can just make a bunch of `asyncRequest`s and `Promise.all` on them for example.\r\n\r\n\r\nThe above might change, although the hope is that this will reduce the maintenance burden, while still giving enough functionality to users until the new http API lands. \n\n### Already existing or connected issues / PRs (optional)\n\n_No response_","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/2825/reactions","total_count":2,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":1,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/2825/timeline","performed_via_github_app":null,"state_reason":"completed"}