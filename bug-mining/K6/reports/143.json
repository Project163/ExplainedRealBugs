{"url":"https://api.github.com/repos/grafana/k6/issues/1552","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/1552/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/1552/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/1552/events","html_url":"https://github.com/grafana/k6/issues/1552","id":655891127,"node_id":"MDU6SXNzdWU2NTU4OTExMjc=","number":1552,"title":"JSON.parse with reviver option cause panic","user":{"login":"n-batrakov","id":25243297,"node_id":"MDQ6VXNlcjI1MjQzMjk3","avatar_url":"https://avatars.githubusercontent.com/u/25243297?v=4","gravatar_id":"","url":"https://api.github.com/users/n-batrakov","html_url":"https://github.com/n-batrakov","followers_url":"https://api.github.com/users/n-batrakov/followers","following_url":"https://api.github.com/users/n-batrakov/following{/other_user}","gists_url":"https://api.github.com/users/n-batrakov/gists{/gist_id}","starred_url":"https://api.github.com/users/n-batrakov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/n-batrakov/subscriptions","organizations_url":"https://api.github.com/users/n-batrakov/orgs","repos_url":"https://api.github.com/users/n-batrakov/repos","events_url":"https://api.github.com/users/n-batrakov/events{/privacy}","received_events_url":"https://api.github.com/users/n-batrakov/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191758,"node_id":"MDU6TGFiZWwzNDUxOTE3NTg=","url":"https://api.github.com/repos/grafana/k6/labels/bug","name":"bug","color":"b60205","default":true,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/grafana/k6/milestones/8","html_url":"https://github.com/grafana/k6/milestone/8","labels_url":"https://api.github.com/repos/grafana/k6/milestones/8/labels","id":4738802,"node_id":"MDk6TWlsZXN0b25lNDczODgwMg==","number":8,"title":"v0.27.0","description":"","creator":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":76,"state":"closed","created_at":"2019-10-10T07:45:28Z","updated_at":"2021-01-19T11:52:02Z","due_on":null,"closed_at":"2020-07-15T13:58:19Z"},"comments":1,"created_at":"2020-07-13T14:20:50Z","updated_at":"2020-07-14T11:44:16Z","closed_at":"2020-07-14T11:44:16Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"`reviver` option in `JSON.parse` causes k6 to panic, no matter what revive function is doing.\r\n\r\n## Environment\r\n\r\n- k6 version: `k6 v0.26.2 (2020-03-18T11:45:39+0000/v0.26.2-0-g459da79e, go1.13.8, linux/amd64)`\r\n- OS and version: Ubuntu 20.04 LTS\r\n\r\n## Expected Behavior\r\n\r\nCalling `JSON.parse` with `reviver` option transforms the output with provided function, e.g.\r\n\r\n```js\r\nlet obj = JSON.parse('{ \"a\": \"foo\" }', (k, v) => k === 'a' ? 'bar' : v)\r\n// Outputs: { a: 'bar' }\r\n```\r\n\r\n## Actual Behavior\r\n\r\nThe code above causes panic:\r\n\r\n```\r\npanic: interface conversion: goja.Value is goja.valueUndefined, not *goja.Object [recovered]\r\n        panic: interface conversion: goja.Value is goja.valueUndefined, not *goja.Object [recovered]\r\n        panic: interface conversion: goja.Value is goja.valueUndefined, not *goja.Object\r\n\r\ngoroutine 56 [running]:\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.AssertFunction.func1.1(0xc0005f7cd8)\r\n        github.com/loadimpact/k6/vendor/github.com/dop251/goja/runtime.go:1456 +0x98\r\npanic(0xd6d500, 0xc001546cc0)\r\n        runtime/panic.go:679 +0x1b2\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*vm).try.func1(0xc001d4f2b0, 0x0, 0xc0005f7ba8, 0x0, 0x0, 0x0, 0xc0005f7c00)\r\n        github.com/loadimpact/k6/vendor/github.com/dop251/goja/vm.go:373 +0x3b0\r\npanic(0xd6d500, 0xc001546cc0)\r\n        runtime/panic.go:679 +0x1b2\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*Runtime).builtinJSON_reviveWalk(0xc000fe7500, 0xc000f722d0, 0xc0017a0040, 0x10c5b60, 0x1951fb0, 0xc000f72380, 0x0)\r\n        github.com/loadimpact/k6/vendor/github.com/dop251/goja/builtin_json.go:156 +0x5dc\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*Runtime).builtinJSON_reviveWalk(0xc000fe7500, 0xc000f722d0, 0xc0017a0080, 0x10c5b60, 0x1951fb0, 0x0, 0x203000)\r\n        github.com/loadimpact/k6/vendor/github.com/dop251/goja/builtin_json.go:170 +0x1ab\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*Runtime).builtinJSON_parse(0xc000fe7500, 0x10c5980, 0xc0027231c0, 0xc0006d6680, 0x2, 0x8, 0x83e1535f, 0x4508b9c83fc13fbd)\r\n        github.com/loadimpact/k6/vendor/github.com/dop251/goja/builtin_json.go:35 +0x454\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*vm)._nativeCall(0xc001d4f2b0, 0xc0024a2210, 0x2)\r\n        github.com/loadimpact/k6/vendor/github.com/dop251/goja/vm.go:1835 +0x291\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.call.exec(0xc000000002, 0xc001d4f2b0)\r\n        github.com/loadimpact/k6/vendor/github.com/dop251/goja/vm.go:1819 +0x4a2\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*vm).run(0xc001d4f2b0)\r\n        github.com/loadimpact/k6/vendor/github.com/dop251/goja/vm.go:289 +0x99\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*funcObject).Call(0xc000641380, 0x10c5fc0, 0x19736e0, 0xc000f72200, 0x1, 0x1, 0x9f9000009f4, 0x9fc000009fc)\r\n        github.com/loadimpact/k6/vendor/github.com/dop251/goja/func.go:130 +0x2cc\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.AssertFunction.func1.2()\r\n        github.com/loadimpact/k6/vendor/github.com/dop251/goja/runtime.go:1461 +0x96\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*vm).try(0xc001d4f2b0, 0xc00025cc50, 0x0)\r\n        github.com/loadimpact/k6/vendor/github.com/dop251/goja/vm.go:379 +0x147\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.AssertFunction.func1(0x10c5fc0, 0x19736e0, 0xc000f72200, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0)\r\n        github.com/loadimpact/k6/vendor/github.com/dop251/goja/runtime.go:1460 +0x13a\r\ngithub.com/loadimpact/k6/js.(*VU).runFn(0xc002603ea0, 0x10b8d40, 0xc001835500, 0xc002047b60, 0x10b8d01, 0xc001ba4900, 0xc000f72200, 0x1, 0x1, 0xc00003c300, ...)\r\n        github.com/loadimpact/k6/js/runner.go:477 +0x35e\r\ngithub.com/loadimpact/k6/js.(*VU).RunOnce(0xc002603ea0, 0x10b8d40, 0xc001835500, 0x0, 0x0)\r\n        github.com/loadimpact/k6/js/runner.go:427 +0x277\r\ngithub.com/loadimpact/k6/core/local.(*vuHandle).run(0xc001144540, 0xc000130000, 0xc00003c240, 0xc0000aa540)\r\n        github.com/loadimpact/k6/core/local/local.go:70 +0x152\r\ngithub.com/loadimpact/k6/core/local.(*Executor).scale.func1(0xc001144540, 0xc0022e67e0, 0xc00003c240, 0xc0000aa540)\r\n        github.com/loadimpact/k6/core/local/local.go:349 +0x4d\r\ncreated by github.com/loadimpact/k6/core/local.(*Executor).scale\r\n        github.com/loadimpact/k6/core/local/local.go:348 +0x328\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nRun sample script with `k6 run`\r\n\r\n```js\r\nexport default function main() {\r\n  JSON.parse('{ \"a\": \"foo\" }', (k, v) => k === 'a' ? 'bar' : v)\r\n}\r\n```","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/1552/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/1552/timeline","performed_via_github_app":null,"state_reason":"completed"}