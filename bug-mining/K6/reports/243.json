{"url":"https://api.github.com/repos/grafana/k6/issues/3008","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/3008/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/3008/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/3008/events","html_url":"https://github.com/grafana/k6/issues/3008","id":1656996171,"node_id":"I_kwDOAz4Wr85iw8FL","number":3008,"title":"Scheduler test getting stuck","user":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":865565592,"node_id":"MDU6TGFiZWw4NjU1NjU1OTI=","url":"https://api.github.com/repos/grafana/k6/labels/tests","name":"tests","color":"2ee83d","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-04-06T09:17:44Z","updated_at":"2023-04-06T11:13:59Z","closed_at":"2023-04-06T11:13:59Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"https://github.com/grafana/k6/actions/runs/4619942626/jobs/8169371360\r\n\r\nWith the following logs \r\n[stuck-github-action.log](https://github.com/grafana/k6/files/11168408/stuck-github-action.log)\r\n\r\nFrom which after using [panicparse](https://github.com/maruel/panicparse) \r\nI got only relevant:\r\n```\r\n1: semacquire [12 minutes] [Created by testing.(*T).Run @ testing.go:1629]\r\n    sync           sema.go:62                     runtime_Semacquire(*uint32(#51))\r\n    sync           waitgroup.go:116               (*WaitGroup).Wait(*WaitGroup(0x0))\r\n    execution      scheduler.go:388               (*Scheduler).Init.func1()\r\n    execution_test scheduler_ext_test.go:510      TestSchedulerRunCustomTags.func1(#192)\r\n    testing        testing.go:1576                tRunner(*testContext(#192), #106)\r\n1: chan send [12 minutes] [Created by execution.(*Scheduler).emitVUsAndVUsMax @ scheduler.go:229]\r\n    metrics        sample.go:135                  PushIfNotDone(...)\r\n    execution      scheduler.go:225               (*Scheduler).emitVUsAndVUsMax.func1()\r\n    execution      scheduler.go:239               (*Scheduler).emitVUsAndVUsMax.func2()\r\n```\r\nSo it seems that emitting samples get stuck.\r\n\r\nThis is due to the loop reading it having a different channel to stop it. The other channel is closed before the emittion is stopped. So if it just so happens that the ticker for the samples ticks between those two, the scheduler will try to emit a metric but nothing will be reading it. ","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/3008/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/3008/timeline","performed_via_github_app":null,"state_reason":"completed"}