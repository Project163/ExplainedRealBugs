{"url":"https://api.github.com/repos/grafana/k6/issues/819","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/819/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/819/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/819/events","html_url":"https://github.com/grafana/k6/issues/819","id":371854621,"node_id":"MDU6SXNzdWUzNzE4NTQ2MjE=","number":819,"title":"k6 doesn't properly anonymize archives","user":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191758,"node_id":"MDU6TGFiZWwzNDUxOTE3NTg=","url":"https://api.github.com/repos/grafana/k6/labels/bug","name":"bug","color":"b60205","default":true,"description":""},{"id":874927263,"node_id":"MDU6TGFiZWw4NzQ5MjcyNjM=","url":"https://api.github.com/repos/grafana/k6/labels/high%20prio","name":"high prio","color":"D93F0B","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2018-10-19T08:24:32Z","updated_at":"2020-07-13T10:47:07Z","closed_at":"2018-10-29T09:15:00Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When creating archives (i.e. when running the `k6 cloud` and `k6 arrchive` commands), k6 tries to anonymize the usernames in any paths that are `open()`-ed or imported: https://github.com/loadimpact/k6/blob/5788beef154b31f95ea8c6da5e86521b6fa07f6a/lib/archive.go#L38-L50\r\n\r\nThe problem comes from the fact that any file paths in the archives will be anonymized, but the paths in the actual `open(\"/home/username/file.json\")` and `import test from \"/home/my_other_username/superlib.js` won't... \r\n\r\nExample script:\r\n```js\r\nimport mylib from \"/home/user/mylib.js\";\r\n\r\nvar someData = open(\"/home/user/data.json\");\r\n\r\nvar username = \"user\" // Can't anonymize that without some strong AI or a magical JS parser :/ ...\r\nvar someMoreData = open(\"/home/\" + username + \"/data.json\");\r\n\r\nvar theJoyOfJS = eval(\"open(['/home', 'user', 'data.json'].join('/'))\");\r\n\r\nexport default function () {\r\n    console.log(JSON.stringify(mylib));\r\n    console.log(someData);\r\n    console.log(someMoreData);\r\n    console.log(theJoyOfJS);\r\n}\r\n```\r\n\r\nAs you might have deduced from the above example, I don't think this is fixable and we should just give up on the whole username anonymization idea...\r\n\r\nThe produced `archive.tar` file from running `k6 archive` on the above script results in a file that has a `data` file (i.e. the script entrypoint) exactly the same as the script above (no anonymization at all) and a tar file that looks like this (via `tar --list --file archive.tar`):\r\n```  \r\nmetadata.json\r\ndata\r\nscripts\r\nscripts/_\r\nscripts/_/home\r\nscripts/_/home/nobody\r\nscripts/_/home/nobody/mylib.js\r\nfiles\r\nfiles/_\r\nfiles/_/home\r\nfiles/_/home/nobody\r\nfiles/_/home/nobody/data.json\r\n```\r\n\r\nThis doesn't work, and what's more, `k6 run archive.tar` fails a panic, which is another bug in and of itself:\r\n```\r\npanic: runtime error: invalid memory address or nil pointer dereference [recovered]\r\n\tpanic: Panic at 29: runtime error: invalid memory address or nil pointer dereference [recovered]\r\n\tpanic: Panic at 29: runtime error: invalid memory address or nil pointer dereference\r\n[signal SIGSEGV: segmentation violation code=0x1 addr=0x48 pc=0x6d97f5]\r\n\r\ngoroutine 1 [running]:\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*Runtime).RunProgram.func1(0xc4231a2af8)\r\n\t/go/src/github.com/loadimpact/k6/vendor/github.com/dop251/goja/runtime.go:880 +0x99\r\npanic(0xbeb880, 0xc42307db20)\r\n\t/usr/lib/go/src/runtime/panic.go:502 +0x229\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*vm).try.func1(0xc4202d8d00, 0x0, 0xc4231a29f0, 0x0, 0x0, 0x0, 0xc4231a2a48)\r\n\t/go/src/github.com/loadimpact/k6/vendor/github.com/dop251/goja/vm.go:364 +0x45c\r\npanic(0xc03940, 0x14cd250)\r\n\t/usr/lib/go/src/runtime/panic.go:502 +0x229\r\ngithub.com/loadimpact/k6/vendor/github.com/spf13/afero.ReadFile(0x0, 0x0, 0xc420228714, 0x13, 0x0, 0x0, 0x0, 0x0, 0x0)\r\n\t/go/src/github.com/loadimpact/k6/vendor/github.com/spf13/afero/ioutil.go:65 +0x45\r\ngithub.com/loadimpact/k6/loader.Load(0x0, 0x0, 0xc4200364e0, 0x25, 0xc420228714, 0x13, 0x0, 0xc4231a21b8, 0x411cc9)\r\n\t/go/src/github.com/loadimpact/k6/loader/loader.go:100 +0x3ff\r\ngithub.com/loadimpact/k6/js.(*InitContext).requireFile(0xc420c22780, 0xc420228714, 0x13, 0x0, 0x0, 0x0, 0x0)\r\n\t/go/src/github.com/loadimpact/k6/js/initcontext.go:135 +0x648\r\ngithub.com/loadimpact/k6/js.(*InitContext).Require(0xc420c22780, 0xc420228714, 0x13, 0x0, 0x0)\r\n\t/go/src/github.com/loadimpact/k6/js/initcontext.go:97 +0xe7\r\nreflect.callMethod(0xc42112e3c0, 0xc4231a2340)\r\n\t/usr/lib/go/src/reflect/value.go:663 +0x181\r\nreflect.methodValueCall(0xc420228714, 0x13, 0x0, 0x0, 0xc4231a2620, 0x4b24e9, 0xc42112e330, 0xc42112e3c0, 0xc4208d1ac0, 0x1000000020, ...)\r\n\t/usr/lib/go/src/reflect/asm_amd64.s:29 +0x33\r\nreflect.Value.call(0xbd5da0, 0xc42112e3c0, 0x13, 0xd13721, 0x4, 0xc4208d1aa0, 0x1, 0x1, 0x0, 0x0, ...)\r\n\t/usr/lib/go/src/reflect/value.go:447 +0x969\r\nreflect.Value.Call(0xbd5da0, 0xc42112e3c0, 0x13, 0xc4208d1aa0, 0x1, 0x1, 0xc42307da80, 0x98, 0x0)\r\n\t/usr/lib/go/src/reflect/value.go:308 +0xa4\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*Runtime).wrapReflectFunc.func1(0xe95b00, 0x1501960, 0xc4222c2220, 0x1, 0x1e, 0x7, 0x0)\r\n\t/go/src/github.com/loadimpact/k6/vendor/github.com/dop251/goja/runtime.go:1153 +0x8c4\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*vm)._nativeCall(0xc4202d8d00, 0xc4208cd550, 0x1)\r\n\t/go/src/github.com/loadimpact/k6/vendor/github.com/dop251/goja/vm.go:1826 +0x2ae\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.call.exec(0x1, 0xc4202d8d00)\r\n\t/go/src/github.com/loadimpact/k6/vendor/github.com/dop251/goja/vm.go:1810 +0x51d\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*vm).run(0xc4202d8d00)\r\n\t/go/src/github.com/loadimpact/k6/vendor/github.com/dop251/goja/vm.go:288 +0x51\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*vm).(github.com/loadimpact/k6/vendor/github.com/dop251/goja.run)-fm()\r\n\t/go/src/github.com/loadimpact/k6/vendor/github.com/dop251/goja/vm.go:375 +0x2a\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*vm).try(0xc4202d8d00, 0xc4231a2a50, 0x0)\r\n\t/go/src/github.com/loadimpact/k6/vendor/github.com/dop251/goja/vm.go:370 +0x10c\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*vm).runTry(0xc4202d8d00, 0xe1eee0)\r\n\t/go/src/github.com/loadimpact/k6/vendor/github.com/dop251/goja/vm.go:375 +0x46\r\ngithub.com/loadimpact/k6/vendor/github.com/dop251/goja.(*Runtime).RunProgram(0xc42136e480, 0xc4215cf020, 0x0, 0x0, 0x0, 0x0)\r\n\t/go/src/github.com/loadimpact/k6/vendor/github.com/dop251/goja/runtime.go:891 +0x1c2\r\ngithub.com/loadimpact/k6/js.(*Bundle).instantiate(0xc42175f600, 0xc42136e480, 0xc420c22780, 0xc422b1e6ab, 0x1)\r\n\t/go/src/github.com/loadimpact/k6/js/bundle.go:262 +0x472\r\ngithub.com/loadimpact/k6/js.(*Bundle).Instantiate(0xc42175f600, 0xbbb600, 0x0, 0x0)\r\n\t/go/src/github.com/loadimpact/k6/js/bundle.go:210 +0x15b\r\ngithub.com/loadimpact/k6/js.(*Runner).newVU(0xc420ce1040, 0xc421ee8300, 0xc734e0, 0x462301, 0xc421faad40)\r\n\t/go/src/github.com/loadimpact/k6/js/runner.go:115 +0x46\r\ngithub.com/loadimpact/k6/js.(*Runner).NewVU(0xc420ce1040, 0xc421ee8300, 0xc420b2db50, 0x1, 0xc420ac89b0, 0xc420c22230)\r\n\t/go/src/github.com/loadimpact/k6/js/runner.go:106 +0x35\r\ngithub.com/loadimpact/k6/core/local.(*Executor).SetVUsMax(0xc420b2db00, 0x1, 0x0, 0x0)\r\n\t/go/src/github.com/loadimpact/k6/core/local/local.go:528 +0x34e\r\ngithub.com/loadimpact/k6/core.NewEngine(0xe97420, 0xc420b2db00, 0x0, 0x1, 0x0, 0x1, 0x0, 0x0, 0x0, 0x1, ...)\r\n\t/go/src/github.com/loadimpact/k6/core/engine.go:86 +0x174\r\ngithub.com/loadimpact/k6/cmd.glob..func11(0x14d8520, 0xc42056c4d0, 0x1, 0x1, 0x0, 0x0)\r\n\t/go/src/github.com/loadimpact/k6/cmd/run.go:182 +0xa7b\r\ngithub.com/loadimpact/k6/vendor/github.com/spf13/cobra.(*Command).execute(0x14d8520, 0xc42056c4a0, 0x1, 0x1, 0x14d8520, 0xc42056c4a0)\r\n\t/go/src/github.com/loadimpact/k6/vendor/github.com/spf13/cobra/command.go:762 +0x468\r\ngithub.com/loadimpact/k6/vendor/github.com/spf13/cobra.(*Command).ExecuteC(0x14d82c0, 0x52, 0xc420576180, 0xc4205ce000)\r\n\t/go/src/github.com/loadimpact/k6/vendor/github.com/spf13/cobra/command.go:852 +0x30a\r\ngithub.com/loadimpact/k6/vendor/github.com/spf13/cobra.(*Command).Execute(0x14d82c0, 0xc420287f78, 0x405d8c)\r\n\t/go/src/github.com/loadimpact/k6/vendor/github.com/spf13/cobra/command.go:800 +0x2b\r\ngithub.com/loadimpact/k6/cmd.Execute()\r\n\t/go/src/github.com/loadimpact/k6/cmd/root.go:87 +0x31\r\nmain.main()\r\n\t/go/src/github.com/loadimpact/k6/main.go:28 +0x20\r\n```\r\n\r\nSo... I think we should:\r\n- disable that usename anonymization since apparently it has never worked and I don't see how we can make it work properly (t.e. by modifying the script as well as the file paths)\r\n- actually use the `NormalizeAndAnonymizePath` (after removing `homeDirRE`) when we open/import files (when we `run` archives), since it's very likely that the other two regular expressions may also cause issues with the changed file paths...\r\n- fix the panic - k6 shlouldn't panic, even if an archive file is wrong somehow\r\n- test all of those things...","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/819/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/819/timeline","performed_via_github_app":null,"state_reason":"completed"}