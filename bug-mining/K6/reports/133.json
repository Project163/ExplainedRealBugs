{"url":"https://api.github.com/repos/grafana/k6/issues/1308","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/1308/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/1308/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/1308/events","html_url":"https://github.com/grafana/k6/issues/1308","id":548047145,"node_id":"MDU6SXNzdWU1NDgwNDcxNDU=","number":1308,"title":"Better distribution of work with execution segments?","user":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191758,"node_id":"MDU6TGFiZWwzNDUxOTE3NTg=","url":"https://api.github.com/repos/grafana/k6/labels/bug","name":"bug","color":"b60205","default":true,"description":""},{"id":345191760,"node_id":"MDU6TGFiZWwzNDUxOTE3NjA=","url":"https://api.github.com/repos/grafana/k6/labels/enhancement","name":"enhancement","color":"5319E7","default":true,"description":""},{"id":1079102926,"node_id":"MDU6TGFiZWwxMDc5MTAyOTI2","url":"https://api.github.com/repos/grafana/k6/labels/evaluation%20needed","name":"evaluation needed","color":"006B75","default":false,"description":"proposal needs to be validated or tested before fully implementing it in k6"},{"id":1773972841,"node_id":"MDU6TGFiZWwxNzczOTcyODQx","url":"https://api.github.com/repos/grafana/k6/labels/executors","name":"executors","color":"f9d0c4","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/grafana/k6/milestones/8","html_url":"https://github.com/grafana/k6/milestone/8","labels_url":"https://api.github.com/repos/grafana/k6/milestones/8/labels","id":4738802,"node_id":"MDk6TWlsZXN0b25lNDczODgwMg==","number":8,"title":"v0.27.0","description":"","creator":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":76,"state":"closed","created_at":"2019-10-10T07:45:28Z","updated_at":"2021-01-19T11:52:02Z","due_on":null,"closed_at":"2020-07-15T13:58:19Z"},"comments":10,"created_at":"2020-01-10T12:14:07Z","updated_at":"2020-04-30T12:50:12Z","closed_at":"2020-04-30T12:50:12Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The discussions surrounding https://github.com/loadimpact/k6/issues/1295 and https://github.com/loadimpact/k6/pull/1307 made me realize that we might have an issue with work partitioning.... Some of the executors have 2 different attributes that have to be distributed when we partition them with execution segments (https://github.com/loadimpact/k6/issues/997) - the number of VUs they have at any given moment, and the work they have to do. The `per-vu-iterations`, `constant-looping-vus`, and `variable-looping-vus` don't have this problem, since for them, the only important thing we need to segment/partition is the number of VUs - the work each VU has to do isn't affected, it's constant. \r\n\r\nBut for `shared-iterations`, `constant-arrival-rate`, and `variable-arrival-rate`, things are a bit different. Say that we have the following configuration:\r\n```js\r\nexport let options = {\r\n    executionSegment: \"1/3:2/3\",\r\n    execution: {\r\n        shared_iters: {\r\n            type: \"shared-iterations\",\r\n            vus: 2,\r\n            iterations: 3,\r\n            maxDuration: \"10s\",\r\n        },\r\n    },\r\n};\r\n```\r\n\r\nThis is the execution segment that has no VUs, but a single iteration... Similarly, with the `arrival-rate` executors it will probably be even easier to end up having a segment with work but no VUs... So, I think we may need to have a 2-tier partitioning for these executors:\r\n1. Partition the workers (i.e. VUs) first\r\n2. Based on the number of allotted workers for that segment, partition the actual work (iterations or iterations/s respectively).\r\n\r\nSo, in the above example, this is how the iterations and VUs are currently partitioned if we split the work into thirds, and also how I think they should:\r\n\r\n| InstID | Segment | VUs | Iterations now | Iterations after fix |\r\n|--------|---------|---|--------------------|-----|\r\n| 1      | (0 - ⅓] | 1 | 1 | 1  |\r\n| 2      | (⅓ - ⅔] | 0 | **1** | 0 |\r\n| 3      | (⅔ - 1] | 1 | 1 | 2 |\r\n\r\nFor the arrival-rate executors things like this would probably happen even more often, since iters/s are practically infinitely divisible. Say that we have 2 iter/s with 2 VUs, and we again want to split that execution into thirds:\r\n```js\r\nexport let options = {\r\n    executionSegment: \"1/3:2/3\",\r\n    execution: {\r\n        constant_arr_rate: {\r\n            type: \"constant-arrival-rate\",\r\n            rate: 2,\r\n            duration: \"10s\",\r\n            preAllocatedVUs: 2,\r\n            maxVUs: 2,\r\n        },\r\n    },\r\n};\r\n```\r\n\r\nWe'd have something like this:\r\n\r\n| InstID | Segment | VUs | Iters/s now | Iters/s after fix |\r\n|--------|---------|---|--------------------|-----|\r\n| 1      | (0 - ⅓] | 1 | ⅔ | 1  |\r\n| 2      | (⅓ - ⅔] | 0 | **⅔** | 0 |\r\n| 3      | (⅔ - 1] | 1 | ⅔ | 1 |\r\n\r\nThese changes should be fairly easy and efficient to achieve with the execution segments, though of course, serious testing would be required to validate it...","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/1308/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/1308/timeline","performed_via_github_app":null,"state_reason":"completed"}