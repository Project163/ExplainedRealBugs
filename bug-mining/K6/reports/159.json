{"url":"https://api.github.com/repos/grafana/k6/issues/1353","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/1353/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/1353/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/1353/events","html_url":"https://github.com/grafana/k6/issues/1353","id":578778360,"node_id":"MDU6SXNzdWU1Nzg3NzgzNjA=","number":1353,"title":"Plugin support","user":{"login":"andremedeiros","id":9689,"node_id":"MDQ6VXNlcjk2ODk=","avatar_url":"https://avatars.githubusercontent.com/u/9689?v=4","gravatar_id":"","url":"https://api.github.com/users/andremedeiros","html_url":"https://github.com/andremedeiros","followers_url":"https://api.github.com/users/andremedeiros/followers","following_url":"https://api.github.com/users/andremedeiros/following{/other_user}","gists_url":"https://api.github.com/users/andremedeiros/gists{/gist_id}","starred_url":"https://api.github.com/users/andremedeiros/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andremedeiros/subscriptions","organizations_url":"https://api.github.com/users/andremedeiros/orgs","repos_url":"https://api.github.com/users/andremedeiros/repos","events_url":"https://api.github.com/users/andremedeiros/events{/privacy}","received_events_url":"https://api.github.com/users/andremedeiros/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":869282130,"node_id":"MDU6TGFiZWw4NjkyODIxMzA=","url":"https://api.github.com/repos/grafana/k6/labels/feature","name":"feature","color":"5319E7","default":false,"description":""},{"id":1079102926,"node_id":"MDU6TGFiZWwxMDc5MTAyOTI2","url":"https://api.github.com/repos/grafana/k6/labels/evaluation%20needed","name":"evaluation needed","color":"006B75","default":false,"description":"proposal needs to be validated or tested before fully implementing it in k6"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/grafana/k6/milestones/11","html_url":"https://github.com/grafana/k6/milestone/11","labels_url":"https://api.github.com/repos/grafana/k6/milestones/11/labels","id":5853332,"node_id":"MDk6TWlsZXN0b25lNTg1MzMzMg==","number":11,"title":"v0.29.0","description":"","creator":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":47,"state":"closed","created_at":"2020-09-08T07:26:34Z","updated_at":"2021-01-19T11:53:02Z","due_on":"2020-11-09T08:00:00Z","closed_at":"2020-11-11T14:39:15Z"},"comments":23,"created_at":"2020-03-10T18:27:00Z","updated_at":"2020-11-04T15:57:57Z","closed_at":"2020-11-04T15:57:57Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"As a user, I would like to be able to implement custom functionality and protocols and expose it in the JavaScript VM so that I can write the heavy lifting work in Golang but write tests in JS.\r\n\r\n## Feature Description\r\nAs a protocol developer, I'd like to be able to develop a client that talks to my protocol via the JavaScript VM that k6 runs. To do this, I would prefer to be able to write a plugin that doesn't have to live in the main codebase and isn't the responsibility of the k6 team.\r\n\r\nEffectively, a plugin should expose:\r\n\r\n- A preflight function (to start any background services it might need)\r\n- A postflight function (to shutdown any background services it might have started)\r\n- A `map[string]interface{}` that gets added to the module mapping so that the plugin's functions can be imported from JavaScript.\r\n\r\n## Suggested Solution (optional)\r\nMy MVP proposal would be to use Golang's [`plugin`](https://golang.org/pkg/plugin/) package. Despite not supporting Windows in its current state, Windows users could use Docker to run plugins. Moreso, it would not introduce any new dependencies to k6.\r\n\r\nPlugins would be loaded by passing a `-plugin` argument when launching k6, which should receive a `.so` file path, and would be initialized (preflight) once, on test start, and cleaned up (postflight) once, on test finish.\r\n\r\nA plugin struct could look something like:\r\n\r\n```golang\r\ntype Plugin struct {\r\n\tName       string\r\n\tPreflight  func() error\r\n\tPostflight func() error\r\n    Modules    map[string]interface{}\r\n}\r\n```\r\n\r\nFor each plugin file, k9 would run something to the lines of:\r\n\r\n```golang\r\n// Omitting error checking for brevity\r\nfor _, path := range plugins {\r\n\tp, _ := plugin.Open(path)\r\n\tm, _ := p.Lookup(\"Plugin\")\r\n\tmeta := m.(Plugin)\r\n\r\n\t// Add plugin modules to JavaScript module registry\r\n\t// Add preflight and postflight functions to a callback list\r\n}\r\n```\r\n\r\nTagging @na--, @imiric, and @MStoykov as indicated in Slack.","closed_by":{"login":"imiric","id":1009277,"node_id":"MDQ6VXNlcjEwMDkyNzc=","avatar_url":"https://avatars.githubusercontent.com/u/1009277?v=4","gravatar_id":"","url":"https://api.github.com/users/imiric","html_url":"https://github.com/imiric","followers_url":"https://api.github.com/users/imiric/followers","following_url":"https://api.github.com/users/imiric/following{/other_user}","gists_url":"https://api.github.com/users/imiric/gists{/gist_id}","starred_url":"https://api.github.com/users/imiric/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imiric/subscriptions","organizations_url":"https://api.github.com/users/imiric/orgs","repos_url":"https://api.github.com/users/imiric/repos","events_url":"https://api.github.com/users/imiric/events{/privacy}","received_events_url":"https://api.github.com/users/imiric/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/1353/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/1353/timeline","performed_via_github_app":null,"state_reason":"completed"}