{"url":"https://api.github.com/repos/grafana/k6/issues/2131","repository_url":"https://api.github.com/repos/grafana/k6","labels_url":"https://api.github.com/repos/grafana/k6/issues/2131/labels{/name}","comments_url":"https://api.github.com/repos/grafana/k6/issues/2131/comments","events_url":"https://api.github.com/repos/grafana/k6/issues/2131/events","html_url":"https://github.com/grafana/k6/issues/2131","id":992968516,"node_id":"MDU6SXNzdWU5OTI5Njg1MTY=","number":2131,"title":"Inner function breaks outer rest parameters","user":{"login":"efdknittlfrank","id":36225864,"node_id":"MDQ6VXNlcjM2MjI1ODY0","avatar_url":"https://avatars.githubusercontent.com/u/36225864?v=4","gravatar_id":"","url":"https://api.github.com/users/efdknittlfrank","html_url":"https://github.com/efdknittlfrank","followers_url":"https://api.github.com/users/efdknittlfrank/followers","following_url":"https://api.github.com/users/efdknittlfrank/following{/other_user}","gists_url":"https://api.github.com/users/efdknittlfrank/gists{/gist_id}","starred_url":"https://api.github.com/users/efdknittlfrank/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/efdknittlfrank/subscriptions","organizations_url":"https://api.github.com/users/efdknittlfrank/orgs","repos_url":"https://api.github.com/users/efdknittlfrank/repos","events_url":"https://api.github.com/users/efdknittlfrank/events{/privacy}","received_events_url":"https://api.github.com/users/efdknittlfrank/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":345191758,"node_id":"MDU6TGFiZWwzNDUxOTE3NTg=","url":"https://api.github.com/repos/grafana/k6/labels/bug","name":"bug","color":"b60205","default":true,"description":""},{"id":874927263,"node_id":"MDU6TGFiZWw4NzQ5MjcyNjM=","url":"https://api.github.com/repos/grafana/k6/labels/high%20prio","name":"high prio","color":"D93F0B","default":false,"description":""},{"id":949381702,"node_id":"MDU6TGFiZWw5NDkzODE3MDI=","url":"https://api.github.com/repos/grafana/k6/labels/js-compat","name":"js-compat","color":"ea8394","default":false,"description":""},{"id":1079102926,"node_id":"MDU6TGFiZWwxMDc5MTAyOTI2","url":"https://api.github.com/repos/grafana/k6/labels/evaluation%20needed","name":"evaluation needed","color":"006B75","default":false,"description":"proposal needs to be validated or tested before fully implementing it in k6"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/grafana/k6/milestones/19","html_url":"https://github.com/grafana/k6/milestone/19","labels_url":"https://api.github.com/repos/grafana/k6/milestones/19/labels","id":7146874,"node_id":"MI_kwDOAz4Wr84AbQ16","number":19,"title":"v0.34.1","description":"","creator":{"login":"na--","id":3336773,"node_id":"MDQ6VXNlcjMzMzY3NzM=","avatar_url":"https://avatars.githubusercontent.com/u/3336773?v=4","gravatar_id":"","url":"https://api.github.com/users/na--","html_url":"https://github.com/na--","followers_url":"https://api.github.com/users/na--/followers","following_url":"https://api.github.com/users/na--/following{/other_user}","gists_url":"https://api.github.com/users/na--/gists{/gist_id}","starred_url":"https://api.github.com/users/na--/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/na--/subscriptions","organizations_url":"https://api.github.com/users/na--/orgs","repos_url":"https://api.github.com/users/na--/repos","events_url":"https://api.github.com/users/na--/events{/privacy}","received_events_url":"https://api.github.com/users/na--/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":5,"state":"closed","created_at":"2021-09-13T11:02:52Z","updated_at":"2021-10-04T07:45:26Z","due_on":"2021-09-16T07:00:00Z","closed_at":"2021-10-04T07:45:26Z"},"comments":5,"created_at":"2021-09-10T07:32:18Z","updated_at":"2021-09-13T11:31:19Z","closed_at":"2021-09-13T11:31:19Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--- Provide a general summary of the issue in the Title above -->\r\n\r\nGreat work on k6 0.34.0 üçæ! (I was already impatiently waiting for all the new goodies :))\r\n\r\nI upgraded my environment and noticed that several of my tests are now failing. Analyzing the failed tests, I noticed a very peculiar and strange interaction of rest parameters with inner function declarations. The repro can be reduced to just a few lines, which I have attached at the bottom of this issue.\r\n\r\nI assume this is more likely to be a bug in goja than in k6 and most probably was introduced by #2109. Since k6 is the only way I can test and run JS in goja at the moment, I'm posting the bug here (also, because this has worked before in k6 up until and including version 0.33.0. It stopped working with 0.34.0).\r\n\r\nOn a related note, I expected startup of tests to be faster with the new version (due to less work being done by babel), but in fact I was observing a small increase in startup times. At least this is what k6 is telling me when being run with the `-v` flag. On the other hand, the time is printed next to \"Babel: transformed\", so perhaps the transformation is slower now?\r\n\r\n## Environment\r\n<!--- Provide as much information about your environment as possible: output from `k6 version`,\r\n      OCI runtime and image information if using containers, cloud execution environment, etc. -->\r\n- k6 version: 0.34.0\r\n- OS and version: Windows 10\r\n- Docker version and image, if applicable: loadimpact/k6:0.34.0\r\n\r\n\r\n## Expected Behavior\r\n<!--- Tell us what should happen -->\r\n\r\nRest parameters work, regardless of function body\r\n\r\n## Actual Behavior\r\n<!--- Tell us what happens instead of the expected behavior -->\r\n\r\nRest parameters stop working (empty array) as soon as the function contains an inner function (named, anonymous, or arrow) which references the rest param array.\r\n\r\n## Steps to Reproduce the Problem\r\n<!--- Provide the exact commands, environment variables and relevant script(s) to reproduce this bug. -->\r\n\r\n```js\r\nfunction working(...rest) {\r\n  console.log(rest.length);\r\n}\r\n\r\nfunction broken(...rest) {\r\n  console.log(rest.length);\r\n  () => rest;\r\n}\r\n\r\nfunction workaround(...rest) {\r\n  console.log(rest.length);\r\n  const alias = rest;\r\n  () => alias;\r\n}\r\n\r\nexport default function() {\r\n  working(4,2); // 2\r\n  broken(4,2); // 0\r\n  workaround(4,2); // 2\r\n}\r\n```\r\n","closed_by":{"login":"mstoykov","id":312246,"node_id":"MDQ6VXNlcjMxMjI0Ng==","avatar_url":"https://avatars.githubusercontent.com/u/312246?v=4","gravatar_id":"","url":"https://api.github.com/users/mstoykov","html_url":"https://github.com/mstoykov","followers_url":"https://api.github.com/users/mstoykov/followers","following_url":"https://api.github.com/users/mstoykov/following{/other_user}","gists_url":"https://api.github.com/users/mstoykov/gists{/gist_id}","starred_url":"https://api.github.com/users/mstoykov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mstoykov/subscriptions","organizations_url":"https://api.github.com/users/mstoykov/orgs","repos_url":"https://api.github.com/users/mstoykov/repos","events_url":"https://api.github.com/users/mstoykov/events{/privacy}","received_events_url":"https://api.github.com/users/mstoykov/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grafana/k6/issues/2131/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grafana/k6/issues/2131/timeline","performed_via_github_app":null,"state_reason":"completed"}