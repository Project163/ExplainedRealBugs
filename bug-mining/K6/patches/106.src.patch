diff --git a/js/modules/k6/ws/ws.go b/js/modules/k6/ws/ws.go
index 86fbee643..875060043 100644
--- a/js/modules/k6/ws/ws.go
+++ b/js/modules/k6/ws/ws.go
@@ -192,11 +192,6 @@ func (*WS) Connect(ctx context.Context, url string, args ...goja.Value) (*WSHTTP
 		}
 	}
 
-	// Run the user-provided set up function
-	if _, err := setupFn(goja.Undefined(), rt.ToValue(&socket)); err != nil {
-		return nil, err
-	}
-
 	if connErr != nil {
 		// Pass the error to the user script before exiting immediately
 		socket.handleEvent("error", rt.ToValue(connErr))
@@ -204,6 +199,11 @@ func (*WS) Connect(ctx context.Context, url string, args ...goja.Value) (*WSHTTP
 		return nil, connErr
 	}
 
+	// Run the user-provided set up function
+	if _, err := setupFn(goja.Undefined(), rt.ToValue(&socket)); err != nil {
+		return nil, err
+	}
+
 	wsResponse, wsRespErr := wrapHTTPResponse(httpResponse)
 	if wsRespErr != nil {
 		return nil, wsRespErr
diff --git a/js/modules/k6/ws/ws_test.go b/js/modules/k6/ws/ws_test.go
index 98a07faef..eae1320a5 100644
--- a/js/modules/k6/ws/ws_test.go
+++ b/js/modules/k6/ws/ws_test.go
@@ -324,6 +324,25 @@ func TestErrors(t *testing.T) {
 		assert.Error(t, err)
 	})
 
+	t.Run("invalid_url_message_panic", func(t *testing.T) {
+		// Attempting to send a message to a non-existent socket shouldn't panic
+		_, err := common.RunString(rt, `
+		let res = ws.connect("INVALID", function(socket){
+			socket.send("new message");
+		});
+		`)
+		assert.Error(t, err)
+	})
+
+	t.Run("error_in_setup", func(t *testing.T) {
+		_, err := common.RunString(rt, `
+		let res = ws.connect("ws://demos.kaazing.com/echo", function(socket){
+			throw new Error("error in setup");
+		});
+		`)
+		assert.Error(t, err)
+	})
+
 	t.Run("send_after_close", func(t *testing.T) {
 		_, err := common.RunString(rt, `
 		let hasError = false;
