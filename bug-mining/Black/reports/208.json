{"url":"https://api.github.com/repos/psf/black/issues/2873","repository_url":"https://api.github.com/repos/psf/black","labels_url":"https://api.github.com/repos/psf/black/issues/2873/labels{/name}","comments_url":"https://api.github.com/repos/psf/black/issues/2873/comments","events_url":"https://api.github.com/repos/psf/black/issues/2873/events","html_url":"https://github.com/psf/black/issues/2873","id":1126166537,"node_id":"I_kwDOB3dpmM5DH_AJ","number":2873,"title":"Black 22.1.0 strips some comments","user":{"login":"henryiii","id":4616906,"node_id":"MDQ6VXNlcjQ2MTY5MDY=","avatar_url":"https://avatars.githubusercontent.com/u/4616906?v=4","gravatar_id":"","url":"https://api.github.com/users/henryiii","html_url":"https://github.com/henryiii","followers_url":"https://api.github.com/users/henryiii/followers","following_url":"https://api.github.com/users/henryiii/following{/other_user}","gists_url":"https://api.github.com/users/henryiii/gists{/gist_id}","starred_url":"https://api.github.com/users/henryiii/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henryiii/subscriptions","organizations_url":"https://api.github.com/users/henryiii/orgs","repos_url":"https://api.github.com/users/henryiii/repos","events_url":"https://api.github.com/users/henryiii/events{/privacy}","received_events_url":"https://api.github.com/users/henryiii/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":867432792,"node_id":"MDU6TGFiZWw4Njc0MzI3OTI=","url":"https://api.github.com/repos/psf/black/labels/T:%20bug","name":"T: bug","color":"d73a4a","default":false,"description":"Something isn't working"},{"id":867438288,"node_id":"MDU6TGFiZWw4Njc0MzgyODg=","url":"https://api.github.com/repos/psf/black/labels/C:%20invalid%20code","name":"C: invalid code","color":"ff0000","default":false,"description":"Black destroyed a valid Python file"},{"id":869137302,"node_id":"MDU6TGFiZWw4NjkxMzczMDI=","url":"https://api.github.com/repos/psf/black/labels/F:%20comments","name":"F: comments","color":"BFD4F2","default":false,"description":"The syntactic kind. Not in the language grammar, always on our minds. Best bugs."}],"state":"closed","locked":false,"assignee":{"login":"ichard26","id":63936253,"node_id":"MDQ6VXNlcjYzOTM2MjUz","avatar_url":"https://avatars.githubusercontent.com/u/63936253?v=4","gravatar_id":"","url":"https://api.github.com/users/ichard26","html_url":"https://github.com/ichard26","followers_url":"https://api.github.com/users/ichard26/followers","following_url":"https://api.github.com/users/ichard26/following{/other_user}","gists_url":"https://api.github.com/users/ichard26/gists{/gist_id}","starred_url":"https://api.github.com/users/ichard26/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ichard26/subscriptions","organizations_url":"https://api.github.com/users/ichard26/orgs","repos_url":"https://api.github.com/users/ichard26/repos","events_url":"https://api.github.com/users/ichard26/events{/privacy}","received_events_url":"https://api.github.com/users/ichard26/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"ichard26","id":63936253,"node_id":"MDQ6VXNlcjYzOTM2MjUz","avatar_url":"https://avatars.githubusercontent.com/u/63936253?v=4","gravatar_id":"","url":"https://api.github.com/users/ichard26","html_url":"https://github.com/ichard26","followers_url":"https://api.github.com/users/ichard26/followers","following_url":"https://api.github.com/users/ichard26/following{/other_user}","gists_url":"https://api.github.com/users/ichard26/gists{/gist_id}","starred_url":"https://api.github.com/users/ichard26/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ichard26/subscriptions","organizations_url":"https://api.github.com/users/ichard26/orgs","repos_url":"https://api.github.com/users/ichard26/repos","events_url":"https://api.github.com/users/ichard26/events{/privacy}","received_events_url":"https://api.github.com/users/ichard26/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2022-02-07T15:47:04Z","updated_at":"2022-07-14T00:02:52Z","closed_at":"2022-07-14T00:02:52Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\nPlease make sure that the bug is not already fixed either in newer versions or the\r\ncurrent development version. To confirm this, you have three options:\r\n\r\n1. Update Black's version if a newer release exists: `pip install -U black`\r\n2. Use the online formatter at <https://black.vercel.app/?version=main>, which will use\r\n   the latest main branch.\r\n3. Or run _Black_ on your machine:\r\n   - create a new virtualenv (make sure it's the same Python version);\r\n   - clone this repository;\r\n   - run `pip install -e .[d]`;\r\n   - run `pip install -r test_requirements.txt`\r\n   - make sure it's sane by running `python -m pytest`; and\r\n   - run `black` like you did last time.\r\n-->\r\n\r\n**Describe the bug**\r\n\r\nBlack will now occasionally strip comments (including `type: ignore` comments).\r\n\r\n**To Reproduce**\r\n\r\n<!--\r\nMinimal steps to reproduce the behavior with source code and Black's configuration.\r\n-->\r\n\r\nFor example, take this code:\r\n\r\n```python\r\nif hasattr(view, \"sum_of_weights\"):\r\n    return np.divide(  # type: ignore[no-any-return]\r\n        view.variance,  # type: ignore[union-attr]\r\n        view.sum_of_weights,  # type: ignore[union-attr]\r\n        out=np.full(view.sum_of_weights.shape, np.nan),  # type: ignore[union-attr]\r\n        where=view.sum_of_weights > 1,  # type: ignore[union-attr]\r\n        where=view.sum_of_weights**2 > view.sum_of_weights_squared,  # type: ignore[union-attr]\r\n    )\r\n```\r\n\r\nAnd run it with these arguments:\r\n\r\n```sh\r\n$ black file.py\r\n```\r\n\r\nThe resulting Python code is:\r\n\r\n```python\r\nif hasattr(view, \"sum_of_weights\"):\r\n    return np.divide(  # type: ignore[no-any-return]\r\n        view.variance,  # type: ignore[union-attr]\r\n        view.sum_of_weights,  # type: ignore[union-attr]\r\n        out=np.full(view.sum_of_weights.shape, np.nan),  # type: ignore[union-attr]\r\n        where=view.sum_of_weights > 1,  # type: ignore[union-attr]\r\n        where=view.sum_of_weights**2 > view.sum_of_weights_squared,\r\n    )\r\n```\r\n\r\n**Expected behavior**\r\n\r\nNot to strip a type ignore comment!!!\r\n\r\n(Personally, I think all trailing comments should be ignored from all line length calculations, etc, since they are often turning off linting or type checking for the line they are on. But it clearly shouldn't just vanish!)\r\n\r\n**Environment**\r\n\r\n<!-- Please complete the following information: -->\r\n\r\n- Black's version: main and 22.1.0\r\n- OS and Python version: Any (macOS, pre-commit.ci's linux, and whatever the web app runs on)\r\n\r\n**Additional context**\r\n\r\nPretty self contained. :)  I had noticed a similar error on upgrading to 22.1.0, but it went away due to other changes, and I never worked it back down, but I'm hoping it was the same one.\r\n","closed_by":{"login":"JelleZijlstra","id":906600,"node_id":"MDQ6VXNlcjkwNjYwMA==","avatar_url":"https://avatars.githubusercontent.com/u/906600?v=4","gravatar_id":"","url":"https://api.github.com/users/JelleZijlstra","html_url":"https://github.com/JelleZijlstra","followers_url":"https://api.github.com/users/JelleZijlstra/followers","following_url":"https://api.github.com/users/JelleZijlstra/following{/other_user}","gists_url":"https://api.github.com/users/JelleZijlstra/gists{/gist_id}","starred_url":"https://api.github.com/users/JelleZijlstra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JelleZijlstra/subscriptions","organizations_url":"https://api.github.com/users/JelleZijlstra/orgs","repos_url":"https://api.github.com/users/JelleZijlstra/repos","events_url":"https://api.github.com/users/JelleZijlstra/events{/privacy}","received_events_url":"https://api.github.com/users/JelleZijlstra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/psf/black/issues/2873/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/psf/black/issues/2873/timeline","performed_via_github_app":null,"state_reason":"completed"}