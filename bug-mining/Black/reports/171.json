{"url":"https://api.github.com/repos/psf/black/issues/1469","repository_url":"https://api.github.com/repos/psf/black","labels_url":"https://api.github.com/repos/psf/black/issues/1469/labels{/name}","comments_url":"https://api.github.com/repos/psf/black/issues/1469/comments","events_url":"https://api.github.com/repos/psf/black/issues/1469/events","html_url":"https://github.com/psf/black/issues/1469","id":628069101,"node_id":"MDU6SXNzdWU2MjgwNjkxMDE=","number":1469,"title":"Black changes f-string into string even though there is a substitution in it.","user":{"login":"Jackenmen","id":6032823,"node_id":"MDQ6VXNlcjYwMzI4MjM=","avatar_url":"https://avatars.githubusercontent.com/u/6032823?v=4","gravatar_id":"","url":"https://api.github.com/users/Jackenmen","html_url":"https://github.com/Jackenmen","followers_url":"https://api.github.com/users/Jackenmen/followers","following_url":"https://api.github.com/users/Jackenmen/following{/other_user}","gists_url":"https://api.github.com/users/Jackenmen/gists{/gist_id}","starred_url":"https://api.github.com/users/Jackenmen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jackenmen/subscriptions","organizations_url":"https://api.github.com/users/Jackenmen/orgs","repos_url":"https://api.github.com/users/Jackenmen/repos","events_url":"https://api.github.com/users/Jackenmen/events{/privacy}","received_events_url":"https://api.github.com/users/Jackenmen/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":867432792,"node_id":"MDU6TGFiZWw4Njc0MzI3OTI=","url":"https://api.github.com/repos/psf/black/labels/T:%20bug","name":"T: bug","color":"d73a4a","default":false,"description":"Something isn't working"},{"id":867438288,"node_id":"MDU6TGFiZWw4Njc0MzgyODg=","url":"https://api.github.com/repos/psf/black/labels/C:%20invalid%20code","name":"C: invalid code","color":"ff0000","default":false,"description":"Black destroyed a valid Python file"},{"id":2972766151,"node_id":"MDU6TGFiZWwyOTcyNzY2MTUx","url":"https://api.github.com/repos/psf/black/labels/F:%20strings","name":"F: strings","color":"BFD4F2","default":false,"description":"Related to our handling of strings"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2020-05-31T23:37:53Z","updated_at":"2021-05-30T22:34:33Z","closed_at":"2021-05-30T22:34:33Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**:\r\nBlack changes f-string into string even though there is a substitution in it.\r\n\r\n**To Reproduce**:\r\n1. Put this into a file:\r\n```py\r\ntemp_msg = (\r\n    f\"{f'{humanize_number(pos)}.': <{pound_len+2}} \"\r\n    f\"{balance: <{bal_len + 5}} \"\r\n    f\"<<{author.display_name}>>\\n\"\r\n)\r\n```\r\n2. Run _Black_ on it with no arguments:\r\n3. See error\r\n```\r\nerror: cannot format test.py: INTERNAL ERROR: Black produced code that is not equivalent to the source.  Please report a bug on https://github.com/psf/black/issues. This diff might be helpful: C:\\Users\\Jakub\\AppData\\Local\\Temp\\blk_08urbts5.log\r\n```\r\nContents of the log file:\r\n```diff\r\n--- src\r\n+++ dst\r\n@@ -85,60 +85,11 @@\r\n                     )  # /Constant\r\n                 )  # /JoinedStr\r\n             )  # /FormattedValue\r\n             Constant(\r\n               value=\r\n-                '',  # str\r\n-            )  # /Constant\r\n-            FormattedValue(\r\n-              conversion=\r\n-                -1,  # int\r\n-              format_spec=\r\n-                JoinedStr(\r\n-                  values=\r\n-                    Constant(\r\n-                      value=\r\n-                        '<',  # str\r\n-                    )  # /Constant\r\n-                    FormattedValue(\r\n-                      conversion=\r\n-                        -1,  # int\r\n-                      format_spec=\r\n-                        None,  # NoneType\r\n-                      value=\r\n-                        BinOp(\r\n-                          left=\r\n-                            Name(\r\n-                              ctx=\r\n-                                Load(\r\n-                                )  # /Load\r\n-                              id=\r\n-                                'bal_len',  # str\r\n-                            )  # /Name\r\n-                          op=\r\n-                            Add(\r\n-                            )  # /Add\r\n-                          right=\r\n-                            Constant(\r\n-                              value=\r\n-                                5,  # int\r\n-                            )  # /Constant\r\n-                        )  # /BinOp\r\n-                    )  # /FormattedValue\r\n-                )  # /JoinedStr\r\n-              value=\r\n-                Name(\r\n-                  ctx=\r\n-                    Load(\r\n-                    )  # /Load\r\n-                  id=\r\n-                    'balance',  # str\r\n-                )  # /Name\r\n-            )  # /FormattedValue\r\n-            Constant(\r\n-              value=\r\n-                '<<',  # str\r\n+                '{balance: <{bal_len + 5} <<',  # str\r\n             )  # /Constant\r\n             FormattedValue(\r\n               conversion=\r\n                 -1,  # int\r\n               format_spec=\r\n```\r\n\r\n**Expected behavior**:\r\nI would expect _Black_ to not touch that f-string.\r\n\r\n**Environment:**\r\n- Version: master (commit cd3a93a14689f046468ece2a5b1f78863c3c4cd2, with `--experimental-string-processing` flag)\r\n- OS and Python version: Windows/Python 3.8.3\r\n\r\n**Does this bug also happen on master?**\r\nIt *only* happens on master, it doesn't happen on current release as there's no string reformatting in it yet. Online formatter doesn't error, but it does produce this output which is obviously not equivalent to the original:\r\n```py\r\ntemp_msg = (\r\n    f\"{f'{humanize_number(pos)}.': <{pound_len+2}} \"\r\n    \"{balance: <{bal_len + 5} \"\r\n    f\"<<{author.display_name}>>\\n\"\r\n)\r\n```\r\n\r\n**Additional context**:\r\nNone\r\n\r\nI'm sorry for the amount of issues but I tried to run Black's master on Cog-Creators/Red-DiscordBot's code base which resulted in quite a few of errors and also some undesired (by me) changes which I wanted to at least report even if they're not gonna be changed.\r\n","closed_by":{"login":"JelleZijlstra","id":906600,"node_id":"MDQ6VXNlcjkwNjYwMA==","avatar_url":"https://avatars.githubusercontent.com/u/906600?v=4","gravatar_id":"","url":"https://api.github.com/users/JelleZijlstra","html_url":"https://github.com/JelleZijlstra","followers_url":"https://api.github.com/users/JelleZijlstra/followers","following_url":"https://api.github.com/users/JelleZijlstra/following{/other_user}","gists_url":"https://api.github.com/users/JelleZijlstra/gists{/gist_id}","starred_url":"https://api.github.com/users/JelleZijlstra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JelleZijlstra/subscriptions","organizations_url":"https://api.github.com/users/JelleZijlstra/orgs","repos_url":"https://api.github.com/users/JelleZijlstra/repos","events_url":"https://api.github.com/users/JelleZijlstra/events{/privacy}","received_events_url":"https://api.github.com/users/JelleZijlstra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/psf/black/issues/1469/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/psf/black/issues/1469/timeline","performed_via_github_app":null,"state_reason":"completed"}