{"url":"https://api.github.com/repos/psf/black/issues/4077","repository_url":"https://api.github.com/repos/psf/black","labels_url":"https://api.github.com/repos/psf/black/issues/4077/labels{/name}","comments_url":"https://api.github.com/repos/psf/black/issues/4077/comments","events_url":"https://api.github.com/repos/psf/black/issues/4077/events","html_url":"https://github.com/psf/black/issues/4077","id":2015299296,"node_id":"I_kwDOB3dpmM54Hwbg","number":4077,"title":"pathlib exception when symlinks are involved","user":{"login":"tg2648","id":45052145,"node_id":"MDQ6VXNlcjQ1MDUyMTQ1","avatar_url":"https://avatars.githubusercontent.com/u/45052145?v=4","gravatar_id":"","url":"https://api.github.com/users/tg2648","html_url":"https://github.com/tg2648","followers_url":"https://api.github.com/users/tg2648/followers","following_url":"https://api.github.com/users/tg2648/following{/other_user}","gists_url":"https://api.github.com/users/tg2648/gists{/gist_id}","starred_url":"https://api.github.com/users/tg2648/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tg2648/subscriptions","organizations_url":"https://api.github.com/users/tg2648/orgs","repos_url":"https://api.github.com/users/tg2648/repos","events_url":"https://api.github.com/users/tg2648/events{/privacy}","received_events_url":"https://api.github.com/users/tg2648/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":867432792,"node_id":"MDU6TGFiZWw4Njc0MzI3OTI=","url":"https://api.github.com/repos/psf/black/labels/T:%20bug","name":"T: bug","color":"d73a4a","default":false,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-11-28T20:56:34Z","updated_at":"2024-01-22T17:46:58Z","closed_at":"2024-01-22T17:46:58Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\n\r\nHello! First of all, thank you for this invaluable tool.\r\n\r\nI first ran into this issue on Windows when using black to format code located on a mapped network drive. \r\n\r\nThis line in [get_sources()](https://github.com/psf/black/blob/a0e270d0f246387202e676b25abbf7a02ddcbc71/src/black/__init__.py#L656C17-L656C17) doesn't ignore symlinks pointing outside of `root`, which has symlinks resolved by [find_project_root()](https://github.com/psf/black/blob/a0e270d0f246387202e676b25abbf7a02ddcbc71/src/black/files.py#L46):\r\nhttps://github.com/psf/black/blob/a0e270d0f246387202e676b25abbf7a02ddcbc71/src/black/__init__.py#L687\r\n\r\n**To Reproduce on Linux**\r\n\r\n```shell\r\nmkdir test_black\r\nln -s test_black test_black_sym\r\ncd test_black\r\ngit init\r\necho \"print('hello')\" > app.py\r\nblack ~/test_black_sym/app.py\r\n```\r\n\r\n`git init` is needed so that [find_project_root()](https://github.com/psf/black/blob/main/src/black/files.py#L46) doesn't return the root of the file system. \r\n\r\nThe resulting error is:\r\n\r\n```shell\r\nTraceback (most recent call last):\r\n  <some omitted>\r\n  File \"/home/tg2648/black/src/black/__init__.py\", line 600, in main\r\n    sources = get_sources(\r\n              ^^^^^^^^^^^^\r\n  File \"/home/tg2648/black/src/black/__init__.py\", line 687, in get_sources\r\n    root_relative_path = path.absolute().relative_to(root).as_posix()\r\n                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/home/tg2648/.pyenv/versions/3.11.0/lib/python3.11/pathlib.py\", line 730, in relative_to\r\n    raise ValueError(\"{!r} is not in the subpath of {!r}\"\r\nValueError: '/home/tg2648/test_black_sym/app.py' is not in the subpath of '/home/tg2648/test_black' OR one path is relative and the other is absolute.\r\n```\r\n\r\n**Environment**\r\n\r\n<!-- Please complete the following information: -->\r\n\r\n- Black's version: 23.11.0\r\n- OS and Python version: Windows and Linux / Python 3.11.0\r\n\r\n**Ideas**\r\n\r\n[normalize_path_maybe_ignore()](https://github.com/psf/black/blob/main/src/black/files.py#L250), which is used later in `get_sources()`, also calculates the root relative path but catches the `ValueError` exception:\r\n\r\nhttps://github.com/psf/black/blob/46be1f8e54ac9a7d67723c0fa28c7bec13a0a2bf/src/black/files.py#L262-L269\r\n\r\nMaybe one solution is to extract these lines into a function like `get_root_relative_path` and then use it in `get_sources()` and `normalize_path_maybe_ignore()`. I can submit a PR if this sounds reasonable.\r\n","closed_by":{"login":"JelleZijlstra","id":906600,"node_id":"MDQ6VXNlcjkwNjYwMA==","avatar_url":"https://avatars.githubusercontent.com/u/906600?v=4","gravatar_id":"","url":"https://api.github.com/users/JelleZijlstra","html_url":"https://github.com/JelleZijlstra","followers_url":"https://api.github.com/users/JelleZijlstra/followers","following_url":"https://api.github.com/users/JelleZijlstra/following{/other_user}","gists_url":"https://api.github.com/users/JelleZijlstra/gists{/gist_id}","starred_url":"https://api.github.com/users/JelleZijlstra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JelleZijlstra/subscriptions","organizations_url":"https://api.github.com/users/JelleZijlstra/orgs","repos_url":"https://api.github.com/users/JelleZijlstra/repos","events_url":"https://api.github.com/users/JelleZijlstra/events{/privacy}","received_events_url":"https://api.github.com/users/JelleZijlstra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/psf/black/issues/4077/reactions","total_count":5,"+1":5,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/psf/black/issues/4077/timeline","performed_via_github_app":null,"state_reason":"completed"}