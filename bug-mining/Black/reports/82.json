{"url":"https://api.github.com/repos/psf/black/issues/338","repository_url":"https://api.github.com/repos/psf/black","labels_url":"https://api.github.com/repos/psf/black/issues/338/labels{/name}","comments_url":"https://api.github.com/repos/psf/black/issues/338/comments","events_url":"https://api.github.com/repos/psf/black/issues/338/events","html_url":"https://github.com/psf/black/issues/338","id":331257050,"node_id":"MDU6SXNzdWUzMzEyNTcwNTA=","number":338,"title":"Crash if there is a symlink to a resource outside of the root directory","user":{"login":"Neraste","id":1684705,"node_id":"MDQ6VXNlcjE2ODQ3MDU=","avatar_url":"https://avatars.githubusercontent.com/u/1684705?v=4","gravatar_id":"","url":"https://api.github.com/users/Neraste","html_url":"https://github.com/Neraste","followers_url":"https://api.github.com/users/Neraste/followers","following_url":"https://api.github.com/users/Neraste/following{/other_user}","gists_url":"https://api.github.com/users/Neraste/gists{/gist_id}","starred_url":"https://api.github.com/users/Neraste/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Neraste/subscriptions","organizations_url":"https://api.github.com/users/Neraste/orgs","repos_url":"https://api.github.com/users/Neraste/repos","events_url":"https://api.github.com/users/Neraste/events{/privacy}","received_events_url":"https://api.github.com/users/Neraste/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":867432792,"node_id":"MDU6TGFiZWw4Njc0MzI3OTI=","url":"https://api.github.com/repos/psf/black/labels/T:%20bug","name":"T: bug","color":"d73a4a","default":false,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-06-11T16:17:53Z","updated_at":"2018-06-13T07:07:05Z","closed_at":"2018-06-13T07:07:05Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello there, thank you for this great tool!\r\n\r\nBlack crashes when it finds a symbolic link pointing to a file or a directory outside of the root directory.\r\n\r\n**Steps to reproduce**\r\n\r\n- Create the following structure:\r\n```\r\nbase\r\n  |-- repo\r\n  |     |-- dummy.py\r\n  |     `-- resource -> ../resource\r\n  `-- resource\r\n```\r\n- Initiate `base/repo` as a Git repository (so as to set the root directory);\r\n- Call `black .` within `base/repo`;\r\n- Expected behavior: *Black* ends as expected;\r\n- Current behavior: throws an exception:\r\n```\r\nTraceback (most recent call last):\r\n  File \"/home/neraste/.virtualenvs/test_black/bin/black\", line 11, in <module>\r\n    sys.exit(main())\r\n  File \"/home/neraste/.virtualenvs/test_black/lib/python3.6/site-packages/click/core.py\", line 722, in __call__\r\n    return self.main(*args, **kwargs)\r\n  File \"/home/neraste/.virtualenvs/test_black/lib/python3.6/site-packages/click/core.py\", line 697, in main\r\n    rv = self.invoke(ctx)\r\n  File \"/home/neraste/.virtualenvs/test_black/lib/python3.6/site-packages/click/core.py\", line 895, in invoke\r\n    return ctx.invoke(self.callback, **ctx.params)\r\n  File \"/home/neraste/.virtualenvs/test_black/lib/python3.6/site-packages/click/core.py\", line 535, in invoke\r\n    return callback(*args, **kwargs)\r\n  File \"/home/neraste/.virtualenvs/test_black/lib/python3.6/site-packages/click/decorators.py\", line 17, in new_func\r\n    return f(get_current_context(), *args, **kwargs)\r\n  File \"/home/neraste/.virtualenvs/test_black/lib/python3.6/site-packages/black.py\", line 347, in main\r\n    gen_python_files_in_dir(p, root, include_regex, exclude_regex, report)\r\n  File \"/home/neraste/.virtualenvs/test_black/lib/python3.6/site-packages/black.py\", line 2942, in gen_python_files_in_dir\r\n    normalized_path = \"/\" + child.resolve().relative_to(root).as_posix()\r\n  File \"/usr/lib64/python3.6/pathlib.py\", line 872, in relative_to\r\n    .format(str(self), str(formatted)))\r\nValueError: '/data/test_black/base/resource' does not start with '/data/test_black/base/repo'\r\n```\r\n\r\nAs pointed out in the backtrace, this is due to the line 2942, where the resolved path of the files is made relative to the root directory. This is indeed impossible if the file is outside of the root directory. One can wonder if it makes sense to have an external link within a repository, but, well I am in this case.\r\n\r\nAdding the conflicting file/folder to the exclude list does not work.\r\n\r\n**Possible workaround**\r\n\r\nA possible workaround could be to simply ignore this case and do not handle this simlinked resource:\r\n```python\r\n        try:\r\n            normalized_path = \"/\" + child.resolve().relative_to(root).as_posix()\r\n\r\n        except ValueError:\r\n            if child.is_symlink():\r\n                continue                                                        \r\n\r\n            raise\r\n```\r\n\r\n\r\n**Additional information**\r\n\r\nOperating system: GNU/Linux OpenSUSE Tumbleweed\r\nPython version: 3.6\r\n*Black* version: 18.6b2\r\nDoes also happen on master: yes\r\n","closed_by":{"login":"ambv","id":55281,"node_id":"MDQ6VXNlcjU1Mjgx","avatar_url":"https://avatars.githubusercontent.com/u/55281?v=4","gravatar_id":"","url":"https://api.github.com/users/ambv","html_url":"https://github.com/ambv","followers_url":"https://api.github.com/users/ambv/followers","following_url":"https://api.github.com/users/ambv/following{/other_user}","gists_url":"https://api.github.com/users/ambv/gists{/gist_id}","starred_url":"https://api.github.com/users/ambv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ambv/subscriptions","organizations_url":"https://api.github.com/users/ambv/orgs","repos_url":"https://api.github.com/users/ambv/repos","events_url":"https://api.github.com/users/ambv/events{/privacy}","received_events_url":"https://api.github.com/users/ambv/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/psf/black/issues/338/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/psf/black/issues/338/timeline","performed_via_github_app":null,"state_reason":"completed"}