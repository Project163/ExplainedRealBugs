{"url":"https://api.github.com/repos/psf/black/issues/2513","repository_url":"https://api.github.com/repos/psf/black","labels_url":"https://api.github.com/repos/psf/black/issues/2513/labels{/name}","comments_url":"https://api.github.com/repos/psf/black/issues/2513/comments","events_url":"https://api.github.com/repos/psf/black/issues/2513/events","html_url":"https://github.com/psf/black/issues/2513","id":1008441895,"node_id":"I_kwDOB3dpmM48G5on","number":2513,"title":"Black Freezes in Containers on Nodes with a Large `os.cpu_count()`","user":{"login":"FHTMitchell","id":24977101,"node_id":"MDQ6VXNlcjI0OTc3MTAx","avatar_url":"https://avatars.githubusercontent.com/u/24977101?v=4","gravatar_id":"","url":"https://api.github.com/users/FHTMitchell","html_url":"https://github.com/FHTMitchell","followers_url":"https://api.github.com/users/FHTMitchell/followers","following_url":"https://api.github.com/users/FHTMitchell/following{/other_user}","gists_url":"https://api.github.com/users/FHTMitchell/gists{/gist_id}","starred_url":"https://api.github.com/users/FHTMitchell/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/FHTMitchell/subscriptions","organizations_url":"https://api.github.com/users/FHTMitchell/orgs","repos_url":"https://api.github.com/users/FHTMitchell/repos","events_url":"https://api.github.com/users/FHTMitchell/events{/privacy}","received_events_url":"https://api.github.com/users/FHTMitchell/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":867432792,"node_id":"MDU6TGFiZWw4Njc0MzI3OTI=","url":"https://api.github.com/repos/psf/black/labels/T:%20bug","name":"T: bug","color":"d73a4a","default":false,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2021-09-27T18:06:27Z","updated_at":"2021-09-29T16:50:45Z","closed_at":"2021-09-29T16:50:45Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\n\r\nBlack attempts to run with too many executed threads when running in a container (e.g. in kubernetes). \r\n\r\nIt is well understood that containers **do not** mask the number of physical cores available, despite the fact that the container itself might be limited by the amount of CPU it can use at one time. This means that using the result of `os.cpu_count()` to spin up that many threads can cause a huge number of threads to be created. The memory overhead of this can cause the program to freeze or crash. See how this has impacted other projects:\r\n\r\n* https://bugs.python.org/issue36054\r\n* https://github.com/benoitc/gunicorn/issues/2028\r\n* https://medium.com/@chipiga86/python-kubernetes-cpu-pinning-eeaeee977c2e\r\n* https://stackoverflow.com/questions/47989418/multiprocessing-python-program-inside-docker\r\n\r\nWe use black in our CI (via precommit) stack which runs on Kubernetes and are currently unable to run any builds using black (and so have had to turn it off for now).\r\n\r\n**To Reproduce**\r\n\r\n1. Simply log into your nearest 1000 core machine\r\n2. Start a container on the machine with reasonable resource limits (e.g. 2 CPU & 1GB RAM)\r\n3. Run `black file1.py file2.py` (must be more than 1 file)\r\n4. Watch as black grinds to a halt trying to start 1000 threads\r\n\r\n**Expected behavior**\r\n\r\nBlack does not grind to a halt...\r\n\r\n**Environment:**\r\n\r\n- Version: 21.9b0 \r\n- OS and Python version: Linux/[3.7|3.8|3.9]\r\n\r\n**Does this bug also happen on main?**\r\n\r\nYes, you can see the offending code on HEAD [here](https://github.com/psf/black/blob/main/src/black/__init__.py#L652).\r\n\r\n**Resolution**\r\n\r\nI would suggest the easiest solution would be to add a `--workers` argument to `black` to optionally set the number of threads. I have a PR ready to go. ","closed_by":{"login":"JelleZijlstra","id":906600,"node_id":"MDQ6VXNlcjkwNjYwMA==","avatar_url":"https://avatars.githubusercontent.com/u/906600?v=4","gravatar_id":"","url":"https://api.github.com/users/JelleZijlstra","html_url":"https://github.com/JelleZijlstra","followers_url":"https://api.github.com/users/JelleZijlstra/followers","following_url":"https://api.github.com/users/JelleZijlstra/following{/other_user}","gists_url":"https://api.github.com/users/JelleZijlstra/gists{/gist_id}","starred_url":"https://api.github.com/users/JelleZijlstra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JelleZijlstra/subscriptions","organizations_url":"https://api.github.com/users/JelleZijlstra/orgs","repos_url":"https://api.github.com/users/JelleZijlstra/repos","events_url":"https://api.github.com/users/JelleZijlstra/events{/privacy}","received_events_url":"https://api.github.com/users/JelleZijlstra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/psf/black/issues/2513/reactions","total_count":4,"+1":4,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/psf/black/issues/2513/timeline","performed_via_github_app":null,"state_reason":"completed"}