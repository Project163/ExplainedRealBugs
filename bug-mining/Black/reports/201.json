{"url":"https://api.github.com/repos/psf/black/issues/2569","repository_url":"https://api.github.com/repos/psf/black","labels_url":"https://api.github.com/repos/psf/black/issues/2569/labels{/name}","comments_url":"https://api.github.com/repos/psf/black/issues/2569/comments","events_url":"https://api.github.com/repos/psf/black/issues/2569/events","html_url":"https://github.com/psf/black/issues/2569","id":1037984547,"node_id":"I_kwDOB3dpmM493mMj","number":2569,"title":"error on windows directory junctions","user":{"login":"pmolodo","id":71800,"node_id":"MDQ6VXNlcjcxODAw","avatar_url":"https://avatars.githubusercontent.com/u/71800?v=4","gravatar_id":"","url":"https://api.github.com/users/pmolodo","html_url":"https://github.com/pmolodo","followers_url":"https://api.github.com/users/pmolodo/followers","following_url":"https://api.github.com/users/pmolodo/following{/other_user}","gists_url":"https://api.github.com/users/pmolodo/gists{/gist_id}","starred_url":"https://api.github.com/users/pmolodo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pmolodo/subscriptions","organizations_url":"https://api.github.com/users/pmolodo/orgs","repos_url":"https://api.github.com/users/pmolodo/repos","events_url":"https://api.github.com/users/pmolodo/events{/privacy}","received_events_url":"https://api.github.com/users/pmolodo/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":867432792,"node_id":"MDU6TGFiZWw4Njc0MzI3OTI=","url":"https://api.github.com/repos/psf/black/labels/T:%20bug","name":"T: bug","color":"d73a4a","default":false,"description":"Something isn't working"},{"id":2272618118,"node_id":"MDU6TGFiZWwyMjcyNjE4MTE4","url":"https://api.github.com/repos/psf/black/labels/C:%20crash","name":"C: crash","color":"ff0000","default":false,"description":"Black is crashing"},{"id":2972729524,"node_id":"MDU6TGFiZWwyOTcyNzI5NTI0","url":"https://api.github.com/repos/psf/black/labels/C:%20file%20collection","name":"C: file collection","color":"16BC84","default":false,"description":"Related to file collection (e.g. gitignore & cache) or file discovery and all of its configuration."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-10-28T01:07:26Z","updated_at":"2022-03-08T15:28:14Z","closed_at":"2022-03-08T15:28:14Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\n\r\nIf a windows directory junction is found while crawling a source root, and it points outside of the source root, then black will error.  This happens even if the directory should be ignored!\r\n\r\n**To Reproduce**\r\n\r\n1. Start a windows cmd prompt\r\n1. `mkdir source_root`\r\n1. `cd source_root`\r\n1. `mkdir .git`\r\n1. `mklink /J dir_junction ..`\r\n1. `python -m black --exclude dir_junction .`\r\n\r\nThen you get this error:\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"C:\\python\\lib\\runpy.py\", line 193, in _run_module_as_main\r\n    \"__main__\", mod_spec)\r\n  File \"C:\\python\\lib\\runpy.py\", line 85, in _run_code\r\n    exec(code, run_globals)\r\n  File \"C:\\pythonlibs\\black\\__main__.py\", line 3, in <module>\r\n    patched_main()\r\n  File \"C:\\pythonlibs\\black\\__init__.py\", line 1283, in patched_main\r\n    main()\r\n  File \"C:\\pythonlibs\\click\\core.py\", line 1128, in __call__\r\n    return self.main(*args, **kwargs)\r\n  File \"C:\\pythonlibs\\click\\core.py\", line 1053, in main\r\n    rv = self.invoke(ctx)\r\n  File \"C:\\pythonlibs\\click\\core.py\", line 1395, in invoke\r\n    return ctx.invoke(self.callback, **ctx.params)\r\n  File \"C:\\pythonlibs\\click\\core.py\", line 754, in invoke\r\n    return __callback(*args, **kwargs)\r\n  File \"C:\\pythonlibs\\click\\decorators.py\", line 26, in new_func\r\n    return f(get_current_context(), *args, **kwargs)\r\n  File \"C:\\pythonlibs\\black\\__init__.py\", line 443, in main\r\n    stdin_filename=stdin_filename,\r\n  File \"C:\\pythonlibs\\black\\__init__.py\", line 549, in get_sources\r\n    quiet=quiet,\r\n  File \"C:\\pythonlibs\\black\\files.py\", line 188, in gen_python_files\r\n    normalized_path = normalize_path_maybe_ignore(child, root, report)\r\n  File \"C:\\pythonlibs\\black\\files.py\", line 142, in normalize_path_maybe_ignore\r\n    normalized_path = abspath.resolve().relative_to(root).as_posix()\r\n  File \"C:\\python\\lib\\pathlib.py\", line 900, in relative_to\r\n    .format(str(self), str(formatted)))\r\nValueError: 'C:\\\\Users\\\\TheUser' does not start with 'C:\\\\Users\\\\TheUser\\\\source_root'\r\n```\r\n\r\n**Expected behavior**\r\n\r\nA directory we've explicitly told to ignore should be ignored!\r\n\r\n**Environment (please complete the following information):**\r\n\r\n- Version: 21.9b0\r\n- OS and Python version: Windows / Python 3.7\r\n\r\n**Does this bug also happen on main?**\r\n\r\nBased on inspection of source, yes (see below)\r\n\r\n**Additional context**\r\n\r\nThe error happens because in [this line](https://github.com/psf/black/blob/main/src/black/files.py#L142), it calls `.resolve().relative_to(root)`:\r\n\r\n```\r\n        normalized_path = abspath.resolve().relative_to(root).as_posix()\r\n```\r\n\r\nIt seems windows directory junctions WILL have their linked path calculated by `resolve()` - however, this then triggers a ValueError, since it's not relative to `root` - this should be caught [here](https://github.com/psf/black/blob/467efe15562e3bad88b1eb3bc11f76b5b9a68816/src/black/files.py#L148):\r\n\r\n```\r\n        if path.is_symlink():\r\n```\r\n\r\n...except it seems that `is_symlink()` returns False for directory junctions! I wonder if a better check wouldn't be to just say that if, after the resolve, it's not relative to the root (regardless of whether we detect a symlink), then it's ignored? ie, something like:\r\n\r\n```\r\n    try:\r\n        abspath = path if path.is_absolute() else Path.cwd() / path\r\n        resolved_path = abspath.resolve()\r\n        try:\r\n            relative_path = resolved_path.relative_to(root)\r\n        except ValueError:\r\n            report.path_ignored(path, f\"is a symbolic link that points outside {root}\")\r\n            return None\r\n        normalized_path = relative_path.as_posix()\r\n    except OSError as e:\r\n        report.path_ignored(path, f\"cannot be read because {e}\")\r\n        return None\r\n```\r\n\r\n","closed_by":{"login":"JelleZijlstra","id":906600,"node_id":"MDQ6VXNlcjkwNjYwMA==","avatar_url":"https://avatars.githubusercontent.com/u/906600?v=4","gravatar_id":"","url":"https://api.github.com/users/JelleZijlstra","html_url":"https://github.com/JelleZijlstra","followers_url":"https://api.github.com/users/JelleZijlstra/followers","following_url":"https://api.github.com/users/JelleZijlstra/following{/other_user}","gists_url":"https://api.github.com/users/JelleZijlstra/gists{/gist_id}","starred_url":"https://api.github.com/users/JelleZijlstra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JelleZijlstra/subscriptions","organizations_url":"https://api.github.com/users/JelleZijlstra/orgs","repos_url":"https://api.github.com/users/JelleZijlstra/repos","events_url":"https://api.github.com/users/JelleZijlstra/events{/privacy}","received_events_url":"https://api.github.com/users/JelleZijlstra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/psf/black/issues/2569/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/psf/black/issues/2569/timeline","performed_via_github_app":null,"state_reason":"completed"}