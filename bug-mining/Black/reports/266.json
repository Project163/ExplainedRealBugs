{"url":"https://api.github.com/repos/psf/black/issues/4504","repository_url":"https://api.github.com/repos/psf/black","labels_url":"https://api.github.com/repos/psf/black/issues/4504/labels{/name}","comments_url":"https://api.github.com/repos/psf/black/issues/4504/comments","events_url":"https://api.github.com/repos/psf/black/issues/4504/events","html_url":"https://github.com/psf/black/issues/4504","id":2616069417,"node_id":"I_kwDOB3dpmM6b7g0p","number":4504,"title":"`tests/test_blackd.py` runs out of fds on systems with high nproc (is blackd leaking fds?)","user":{"login":"mgorny","id":110765,"node_id":"MDQ6VXNlcjExMDc2NQ==","avatar_url":"https://avatars.githubusercontent.com/u/110765?v=4","gravatar_id":"","url":"https://api.github.com/users/mgorny","html_url":"https://github.com/mgorny","followers_url":"https://api.github.com/users/mgorny/followers","following_url":"https://api.github.com/users/mgorny/following{/other_user}","gists_url":"https://api.github.com/users/mgorny/gists{/gist_id}","starred_url":"https://api.github.com/users/mgorny/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mgorny/subscriptions","organizations_url":"https://api.github.com/users/mgorny/orgs","repos_url":"https://api.github.com/users/mgorny/repos","events_url":"https://api.github.com/users/mgorny/events{/privacy}","received_events_url":"https://api.github.com/users/mgorny/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":867432792,"node_id":"MDU6TGFiZWw4Njc0MzI3OTI=","url":"https://api.github.com/repos/psf/black/labels/T:%20bug","name":"T: bug","color":"d73a4a","default":false,"description":"Something isn't working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2024-10-26T18:59:20Z","updated_at":"2025-01-25T18:50:12Z","closed_at":"2025-01-25T17:28:07Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\n\r\nWhen running the test suite on a machine with high nproc (i.e. large number of CPUs/cores — we have 80 on arm64 and 256 on sparc), the test suite suddenly runs out of fds in middle of testing `tests/test_blackd.py`. The remaining blackd tests fail, then pytest hangs when it's supposed to exit.\r\n\r\n**To Reproduce**\r\n\r\n1. Errr, get a system with high `nproc`… (perhaps some mocking will work?)\r\n2. `tox -e py312-ci` (xdist in non-CI jobs works around the problem)\r\n\r\n**Expected behavior**\r\n\r\nTest suite passing.\r\n\r\n**Environment**\r\n\r\n- Black's version: 53a219056d1ab092ee2d4e5181c55c2e58c4756c\r\n- OS and Python version: Gentoo Linux arm64, 3.12.7\r\n\r\n**Additional context**\r\n\r\nTo not shadow the issue, here's a minimal log:\r\n\r\n```pytb\r\n$ python -m pytest tests/test_blackd.py --maxfail=2\r\n========================================================= test session starts =========================================================\r\nplatform linux -- Python 3.12.7, pytest-8.3.3, pluggy-1.5.0\r\nrootdir: /home/mgorny/black\r\nconfigfile: pyproject.toml\r\nplugins: xdist-3.6.1, cov-5.0.0\r\ncollected 20 items                                                                                                                    \r\n\r\ntests/test_blackd.py ........FF\r\n\r\n============================================================== FAILURES ===============================================================\r\n_________________________________________ BlackDTestCase.test_blackd_request_needs_formatting _________________________________________\r\n\r\nself = <tests.test_blackd.BlackDTestCase testMethod=test_blackd_request_needs_formatting>\r\n\r\n    async def test_blackd_request_needs_formatting(self) -> None:\r\n        response = await self.client.post(\"/\", data=b\"print('hello world')\")\r\n>       self.assertEqual(response.status, 200)\r\nE       AssertionError: 500 != 200\r\n\r\ntests/test_blackd.py:38: AssertionError\r\n---------------------------------------------------------- Captured log call ----------------------------------------------------------\r\nERROR    root:__init__.py:163 Exception during handling a request\r\nTraceback (most recent call last):\r\n  File \"/home/mgorny/black/src/blackd/__init__.py\", line 124, in handle\r\n    formatted_str = await loop.run_in_executor(\r\n                          ^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/lib/python3.12/asyncio/base_events.py\", line 863, in run_in_executor\r\n    executor.submit(func, *args), loop=self)\r\n    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/lib/python3.12/concurrent/futures/process.py\", line 831, in submit\r\n    self._start_executor_manager_thread()\r\n  File \"/usr/lib/python3.12/concurrent/futures/process.py\", line 770, in _start_executor_manager_thread\r\n    self._launch_processes()\r\n  File \"/usr/lib/python3.12/concurrent/futures/process.py\", line 797, in _launch_processes\r\n    self._spawn_process()\r\n  File \"/usr/lib/python3.12/concurrent/futures/process.py\", line 807, in _spawn_process\r\n    p.start()\r\n  File \"/usr/lib/python3.12/multiprocessing/process.py\", line 121, in start\r\n    self._popen = self._Popen(self)\r\n                  ^^^^^^^^^^^^^^^^^\r\n  File \"/usr/lib/python3.12/multiprocessing/context.py\", line 282, in _Popen\r\n    return Popen(process_obj)\r\n           ^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/lib/python3.12/multiprocessing/popen_fork.py\", line 19, in __init__\r\n    self._launch(process_obj)\r\n  File \"/usr/lib/python3.12/multiprocessing/popen_fork.py\", line 65, in _launch\r\n    child_r, parent_w = os.pipe()\r\n                        ^^^^^^^^^\r\nOSError: [Errno 24] Too many open files\r\nWARNING  asyncio:base_events.py:1981 Executing <Task pending name='Task-120' coro=<RequestHandler.start() running at /home/mgorny/black/.tox/py312/lib/python3.12/site-packages/aiohttp/web_protocol.py:534> wait_for=<Future pending cb=[Task.task_wakeup()] created at /usr/lib/python3.12/asyncio/base_events.py:449> created at /home/mgorny/black/.tox/py312/lib/python3.12/site-packages/aiohttp/web_protocol.py:319> took 0.168 seconds\r\n____________________________________________ BlackDTestCase.test_blackd_request_no_change _____________________________________________\r\n\r\nself = <tests.test_blackd.BlackDTestCase testMethod=test_blackd_request_no_change>\r\n\r\n    async def get_application(self) -> web.Application:\r\n>       return blackd.make_app()\r\n\r\ntests/test_blackd.py:34: \r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\r\nsrc/blackd/__init__.py:92: in make_app\r\n    executor = ProcessPoolExecutor()\r\n/usr/lib/python3.12/concurrent/futures/process.py:754: in __init__\r\n    self._call_queue = _SafeQueue(\r\n/usr/lib/python3.12/concurrent/futures/process.py:175: in __init__\r\n    super().__init__(max_size, ctx=ctx)\r\n/usr/lib/python3.12/multiprocessing/queues.py:43: in __init__\r\n    self._rlock = ctx.Lock()\r\n/usr/lib/python3.12/multiprocessing/context.py:68: in Lock\r\n    return Lock(ctx=self.get_context())\r\n/usr/lib/python3.12/multiprocessing/synchronize.py:169: in __init__\r\n    SemLock.__init__(self, SEMAPHORE, 1, 1, ctx=ctx)\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\r\n\r\nself = <Lock(owner=unknown)>, kind = 1, value = 1, maxvalue = 1\r\n\r\n    def __init__(self, kind, value, maxvalue, *, ctx):\r\n        if ctx is None:\r\n            ctx = context._default_context.get_context()\r\n        self._is_fork_ctx = ctx.get_start_method() == 'fork'\r\n        unlink_now = sys.platform == 'win32' or self._is_fork_ctx\r\n        for i in range(100):\r\n            try:\r\n>               sl = self._semlock = _multiprocessing.SemLock(\r\n                    kind, value, maxvalue, self._make_name(),\r\n                    unlink_now)\r\nE                   OSError: [Errno 24] Too many open files\r\n\r\n/usr/lib/python3.12/multiprocessing/synchronize.py:57: OSError\r\n======================================================= short test summary info =======================================================\r\nFAILED tests/test_blackd.py::BlackDTestCase::test_blackd_request_needs_formatting - AssertionError: 500 != 200\r\nFAILED tests/test_blackd.py::BlackDTestCase::test_blackd_request_no_change - OSError: [Errno 24] Too many open files\r\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 2 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\r\n===================================================== 2 failed, 8 passed in 1.82s =====================================================\r\n^CException ignored in atexit callback: <function _exit_function at 0xffff9a292c00>\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3.12/multiprocessing/util.py\", line 360, in _exit_function\r\n    p.join()\r\n  File \"/usr/lib/python3.12/multiprocessing/process.py\", line 149, in join\r\n    res = self._popen.wait(timeout)\r\n          ^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/lib/python3.12/multiprocessing/popen_fork.py\", line 43, in wait\r\n    return self.poll(os.WNOHANG if timeout == 0.0 else 0)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/usr/lib/python3.12/multiprocessing/popen_fork.py\", line 27, in poll\r\n    pid, sts = os.waitpid(self.pid, flag)\r\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nKeyboardInterrupt: \r\n```\r\n\r\n(note I had to ^C it, as it was hanging)\r\n\r\nMy initial guess was that `ProcessPoolExecutor` is not cleaned up when `main()` finishes, but hacking a `.shutdown()` in doesn't seem to help. Adding `max_workers=` does (with values up to 29 here).\r\n\r\nThe setup here is using the default `ulimit -n 1024`.","closed_by":{"login":"JelleZijlstra","id":906600,"node_id":"MDQ6VXNlcjkwNjYwMA==","avatar_url":"https://avatars.githubusercontent.com/u/906600?v=4","gravatar_id":"","url":"https://api.github.com/users/JelleZijlstra","html_url":"https://github.com/JelleZijlstra","followers_url":"https://api.github.com/users/JelleZijlstra/followers","following_url":"https://api.github.com/users/JelleZijlstra/following{/other_user}","gists_url":"https://api.github.com/users/JelleZijlstra/gists{/gist_id}","starred_url":"https://api.github.com/users/JelleZijlstra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JelleZijlstra/subscriptions","organizations_url":"https://api.github.com/users/JelleZijlstra/orgs","repos_url":"https://api.github.com/users/JelleZijlstra/repos","events_url":"https://api.github.com/users/JelleZijlstra/events{/privacy}","received_events_url":"https://api.github.com/users/JelleZijlstra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/psf/black/issues/4504/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/psf/black/issues/4504/timeline","performed_via_github_app":null,"state_reason":"completed"}