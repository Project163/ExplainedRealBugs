diff --git a/mqtt-common/src/main/java/org/apache/rocketmq/mqtt/common/util/NamespaceUtil.java b/mqtt-common/src/main/java/org/apache/rocketmq/mqtt/common/util/NamespaceUtil.java
index 38821d4..2ec81ee 100644
--- a/mqtt-common/src/main/java/org/apache/rocketmq/mqtt/common/util/NamespaceUtil.java
+++ b/mqtt-common/src/main/java/org/apache/rocketmq/mqtt/common/util/NamespaceUtil.java
@@ -24,20 +24,16 @@ public class NamespaceUtil {
     private static final int RESOURCE_LENGTH = 2;
     public static final String MQ_DEFAULT_NAMESPACE_NAME = "DEFAULT_INSTANCE";
 
-    public NamespaceUtil() {
-    }
-
     public static String encodeToNamespaceResource(String namespace, String resource) {
-        return resource != null && namespace != null ? StringUtils.join(new String[]{namespace, "%", resource}) : resource;
+        return resource != null && namespace != null ? StringUtils.join(namespace, NAMESPACE_SPLITER, resource) : resource;
     }
 
     public static String decodeOriginResource(String resource) {
-        if (resource != null && resource.contains("%")) {
-            int firstIndex = resource.indexOf("%");
+        if (resource != null && resource.contains(NAMESPACE_SPLITER)) {
+            int firstIndex = resource.indexOf(NAMESPACE_SPLITER);
             return resource.substring(firstIndex + 1);
-        } else {
-            return resource;
         }
+        return resource;
     }
 
     public static String decodeMqttNamespaceIdFromKey(String key) {
@@ -45,24 +41,18 @@ public class NamespaceUtil {
     }
 
     public static String decodeMqttNamespaceIdFromClientId(String clientId) {
-        if (clientId != null && clientId.contains("%")) {
-            String mqttNamespaceId = clientId.split("%")[0];
-            return mqttNamespaceId;
-        } else {
-            return null;
-        }
+        return splitNamespaceStr(clientId);
     }
 
     public static String decodeStoreNamespaceIdFromTopic(String topic) {
-        if (topic != null && topic.contains("%")) {
-            String storeNamespaceId = topic.split("%")[0];
-            return storeNamespaceId;
-        } else {
-            return null;
-        }
+        return splitNamespaceStr(topic);
     }
 
     public static String decodeNamespaceId(String resource) {
-        return resource != null && resource.contains("%") ? resource.split("%")[0] : null;
+        return splitNamespaceStr(resource);
+    }
+
+    private static String splitNamespaceStr(String namespaceStr) {
+        return namespaceStr != null && namespaceStr.contains(NAMESPACE_SPLITER) ? namespaceStr.split(NAMESPACE_SPLITER)[0] : null;
     }
 }
diff --git a/mqtt-common/src/main/java/org/apache/rocketmq/mqtt/common/util/StatUtil.java b/mqtt-common/src/main/java/org/apache/rocketmq/mqtt/common/util/StatUtil.java
index 6c35083..e79f5e8 100644
--- a/mqtt-common/src/main/java/org/apache/rocketmq/mqtt/common/util/StatUtil.java
+++ b/mqtt-common/src/main/java/org/apache/rocketmq/mqtt/common/util/StatUtil.java
@@ -227,40 +227,7 @@ public class StatUtil {
     }
 
     public static void addInvoke(String key, long rt, boolean success) {
-        if (invokeCache.size() > MAX_KEY_NUM || secondInvokeCache.size() > MAX_KEY_NUM) {
-            return;
-        }
-        Invoke invoke = getAndSetInvoke(key);
-        if (invoke == null) {
-            return;
-        }
-
-        invoke.totalPv.getAndIncrement();
-        if (!success) {
-            invoke.failPv.getAndIncrement();
-        }
-        long now = nowSecond();
-        AtomicLong oldSecond = invoke.second;
-        if (oldSecond.get() == now) {
-            invoke.secondPv.getAndIncrement();
-        } else {
-            if (oldSecond.compareAndSet(oldSecond.get(), now)) {
-                if (invoke.secondPv.get() > invoke.topSecondPv.get()) {
-                    invoke.topSecondPv.set(invoke.secondPv.get());
-                }
-                invoke.secondPv.set(1);
-            } else {
-                invoke.secondPv.getAndIncrement();
-            }
-        }
-
-        invoke.sumRt.addAndGet(rt);
-        if (invoke.maxRt.get() < rt) {
-            invoke.maxRt.set(rt);
-        }
-        if (invoke.minRt.get() > rt) {
-            invoke.minRt.set(rt);
-        }
+        addInvoke(key, 1, rt, success);
     }
 
     public static SecondInvoke getAndSetSecondInvoke(String key) {
@@ -431,7 +398,6 @@ public class StatUtil {
     public static int maxRtInWindow(String key, int windowSeconds) {
         List<SecondInvoke> list = secondInvokeList(key, windowSeconds);
         long maxRt = 0;
-        long totalPv = 0;
         for (int i = 0; i < windowSeconds && i < list.size(); i++) {
             if (maxRt < list.get(i).maxRt.get()) {
                 maxRt = list.get(i).maxRt.get();
@@ -443,7 +409,6 @@ public class StatUtil {
     public static int minRtInWindow(String key, int windowSeconds) {
         List<SecondInvoke> list = secondInvokeList(key, windowSeconds);
         long minRt = 0;
-        long totalPv = 0;
         for (int i = 0; i < windowSeconds && i < list.size(); i++) {
             if (minRt < list.get(i).minRt.get()) {
                 minRt = list.get(i).minRt.get();
diff --git a/mqtt-common/src/main/java/org/apache/rocketmq/mqtt/common/util/TopicUtils.java b/mqtt-common/src/main/java/org/apache/rocketmq/mqtt/common/util/TopicUtils.java
index 91cb875..bbdfac8 100644
--- a/mqtt-common/src/main/java/org/apache/rocketmq/mqtt/common/util/TopicUtils.java
+++ b/mqtt-common/src/main/java/org/apache/rocketmq/mqtt/common/util/TopicUtils.java
@@ -31,7 +31,7 @@ public class TopicUtils {
      * @return
      */
     public static String normalizeTopic(String topic) {
-        if (topic == null) {
+        if (topic == null || topic.isEmpty()) {
             return null;
         }
         if (!topic.contains(Constants.MQTT_TOPIC_DELIMITER)) {
@@ -46,20 +46,20 @@ public class TopicUtils {
     /**
      * /t2/t3/t4/
      *
-     * @param secondtopic
+     * @param secondTopic
      * @return
      */
-    public static String normalizeSecondTopic(String secondtopic) {
-        if (secondtopic == null || secondtopic.isEmpty()) {
+    public static String normalizeSecondTopic(String secondTopic) {
+        if (secondTopic == null || secondTopic.isEmpty()) {
             return null;
         }
-        if (!secondtopic.startsWith(Constants.MQTT_TOPIC_DELIMITER)) {
-            secondtopic = Constants.MQTT_TOPIC_DELIMITER + secondtopic;
+        if (!secondTopic.startsWith(Constants.MQTT_TOPIC_DELIMITER)) {
+            secondTopic = Constants.MQTT_TOPIC_DELIMITER + secondTopic;
         }
-        if (!secondtopic.endsWith(Constants.MQTT_TOPIC_DELIMITER)) {
-            return secondtopic + Constants.MQTT_TOPIC_DELIMITER;
+        if (!secondTopic.endsWith(Constants.MQTT_TOPIC_DELIMITER)) {
+            return secondTopic + Constants.MQTT_TOPIC_DELIMITER;
         }
-        return secondtopic;
+        return secondTopic;
     }
 
     public static boolean isP2P(String secondTopic) {
@@ -93,10 +93,10 @@ public class TopicUtils {
     }
 
     public static String getP2Peer(MqttTopic mqttTopic, String namespace) {
-        if (!isP2P(mqttTopic.getSecondTopic())) {
+        if (mqttTopic.getSecondTopic() == null || mqttTopic.getFirstTopic() == null) {
             return null;
         }
-        if (mqttTopic.getSecondTopic() == null || mqttTopic.getFirstTopic() == null) {
+        if (!isP2P(mqttTopic.getSecondTopic())) {
             return null;
         }
         if (mqttTopic.getFirstTopic().contains(Constants.NAMESPACE_SPLITER) && StringUtils.isNotBlank(namespace)) {
diff --git a/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/TestTopicUtils.java b/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/TestTopicUtils.java
deleted file mode 100644
index c30906f..0000000
--- a/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/TestTopicUtils.java
+++ /dev/null
@@ -1,60 +0,0 @@
-/*
- * Licensed to the Apache Software Foundation (ASF) under one or more
- * contributor license agreements.  See the NOTICE file distributed with
- * this work for additional information regarding copyright ownership.
- * The ASF licenses this file to You under the Apache License, Version 2.0
- * (the "License"); you may not use this file except in compliance with
- * the License.  You may obtain a copy of the License at
- *
- *     http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-
-package org.apache.rocketmq.mqtt.common.test;
-
-import org.apache.commons.collections.CollectionUtils;
-import org.apache.rocketmq.mqtt.common.model.Trie;
-import org.apache.rocketmq.mqtt.common.util.TopicUtils;
-import org.junit.Assert;
-import org.junit.Test;
-
-public class TestTopicUtils {
-
-  @Test
-  public void testTopicMatch() {
-    String topic = "t/t1/t2/";
-    String topicFilter = "t/t1/t2/";
-    Assert.assertTrue(TopicUtils.isMatch(topic, topicFilter));
-
-    topicFilter = "t/#/";
-    Assert.assertTrue(TopicUtils.isMatch(topic, topicFilter));
-
-    topicFilter = "t/t1/+/";
-    Assert.assertTrue(TopicUtils.isMatch(topic, topicFilter));
-
-    topicFilter = "t/+/#/";
-    Assert.assertTrue(TopicUtils.isMatch(topic, topicFilter));
-
-    topicFilter = "t/#/t2/";
-    Assert.assertFalse(TopicUtils.isMatch(topic, topicFilter));
-
-    topicFilter = "t/#/+/";
-    Assert.assertFalse(TopicUtils.isMatch(topic, topicFilter));
-
-    topicFilter = "t/t1/t2/t3/";
-    Assert.assertFalse(TopicUtils.isMatch(topic, topicFilter));
-
-    topicFilter = "t/t1/#/t3/";
-    Assert.assertFalse(TopicUtils.isMatch(topic, topicFilter));
-
-    topicFilter = "t/t1#/";
-    Assert.assertFalse(TopicUtils.isMatch(topic, topicFilter));
-
-
-  }
-}
diff --git a/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestHmacSHA1Util.java b/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestHmacSHA1Util.java
new file mode 100644
index 0000000..750446f
--- /dev/null
+++ b/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestHmacSHA1Util.java
@@ -0,0 +1,37 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.rocketmq.mqtt.common.test.util;
+
+import org.apache.rocketmq.mqtt.common.util.HmacSHA1Util;
+import org.junit.Assert;
+import org.junit.Test;
+
+import java.nio.charset.StandardCharsets;
+import java.security.InvalidKeyException;
+import java.security.NoSuchAlgorithmException;
+
+public class TestHmacSHA1Util {
+
+    @Test
+    public void test() throws NoSuchAlgorithmException, InvalidKeyException {
+        String clientId = "testHmacSHA1", secretKey = "SHA1Util";
+
+        byte[] signature = HmacSHA1Util.macSignature(clientId, secretKey).getBytes(StandardCharsets.UTF_8);
+        Assert.assertTrue(HmacSHA1Util.validateSign(clientId, signature, secretKey));
+    }
+}
diff --git a/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestHostInfo.java b/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestHostInfo.java
new file mode 100644
index 0000000..b70e470
--- /dev/null
+++ b/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestHostInfo.java
@@ -0,0 +1,34 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.rocketmq.mqtt.common.test.util;
+
+import org.apache.rocketmq.mqtt.common.util.HostInfo;
+import org.junit.Assert;
+import org.junit.Test;
+
+import java.net.InetAddress;
+import java.net.UnknownHostException;
+
+public class TestHostInfo {
+
+    @Test
+    public void test() throws UnknownHostException {
+        HostInfo HOST_INFO = HostInfo.getInstall();
+        Assert.assertEquals(InetAddress.getLocalHost().getHostAddress(), HOST_INFO.getAddress());
+    }
+}
diff --git a/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/TestMessageUtil.java b/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestMessageUtil.java
similarity index 81%
rename from mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/TestMessageUtil.java
rename to mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestMessageUtil.java
index d6a57ca..3604c97 100644
--- a/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/TestMessageUtil.java
+++ b/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestMessageUtil.java
@@ -15,7 +15,7 @@
  * limitations under the License.
  */
 
-package org.apache.rocketmq.mqtt.common.test;
+package org.apache.rocketmq.mqtt.common.test.util;
 
 import io.netty.buffer.ByteBuf;
 import io.netty.buffer.ByteBufAllocator;
@@ -31,7 +31,10 @@ import org.junit.Assert;
 import org.junit.Before;
 import org.junit.Test;
 
+import java.nio.ByteBuffer;
 import java.nio.charset.StandardCharsets;
+import java.util.ArrayList;
+import java.util.List;
 
 public class TestMessageUtil {
 
@@ -40,7 +43,8 @@ public class TestMessageUtil {
     int qos;
     int mqttId;
     MqttPublishMessage mqttPublishMessage;
-
+    Message message;
+    List<Message> messageList;
 
     @Before
     public void Before() {
@@ -54,6 +58,13 @@ public class TestMessageUtil {
         payload.writeBytes(body);
         mqttPublishMessage = new MqttPublishMessage(new MqttFixedHeader(MqttMessageType.PUBLISH, false, MqttQoS.valueOf(qos), false, 0),
                 new MqttPublishVariableHeader(topicName, mqttId), payload);
+
+        message = new Message();
+        message.setFirstTopic(topicName);
+        message.putUserProperty(Message.extPropertyQoS, String.valueOf(qos));
+        message.setPayload(messageBody.getBytes(StandardCharsets.UTF_8));
+        messageList = new ArrayList<>();
+        messageList.add(message);
     }
 
     @Test
@@ -63,10 +74,14 @@ public class TestMessageUtil {
 
     @Test
     public void TestToMessage() {
-        Message message = new Message();
-        message.setFirstTopic(topicName);
-        message.putUserProperty(Message.extPropertyQoS, String.valueOf(qos));
-        message.setPayload(messageBody.getBytes(StandardCharsets.UTF_8));
         Assert.assertEquals(message, MessageUtil.toMessage(mqttPublishMessage));
     }
+
+    @Test
+    public void TestEncodeAndDecode() throws Exception {
+        byte[] bytes = MessageUtil.encode(messageList);
+        List<Message> decodeMsgList = MessageUtil.decode(ByteBuffer.wrap(bytes));
+        Assert.assertEquals(1, decodeMsgList.size());
+        Assert.assertEquals(message, decodeMsgList.get(0));
+    }
 }
diff --git a/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/TestNamespaceUtil.java b/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestNamespaceUtil.java
similarity index 87%
rename from mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/TestNamespaceUtil.java
rename to mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestNamespaceUtil.java
index 5b38e22..8a01017 100644
--- a/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/TestNamespaceUtil.java
+++ b/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestNamespaceUtil.java
@@ -17,7 +17,7 @@
  *
  */
 
-package org.apache.rocketmq.mqtt.common.test;
+package org.apache.rocketmq.mqtt.common.test.util;
 
 import org.apache.rocketmq.mqtt.common.util.NamespaceUtil;
 import org.junit.Assert;
@@ -40,6 +40,7 @@ public class TestNamespaceUtil {
     @Test
     public void testDecodeOriginResource() {
         Assert.assertEquals(originResource, NamespaceUtil.decodeOriginResource(resource));
+        Assert.assertEquals(originResource, NamespaceUtil.decodeOriginResource(originResource));
     }
 
     @Test
@@ -55,11 +56,13 @@ public class TestNamespaceUtil {
     @Test
     public void testDecodeMqttNamespaceIdFromClientId() {
         Assert.assertEquals(namespace, NamespaceUtil.decodeMqttNamespaceIdFromClientId(resource));
+        Assert.assertNull(NamespaceUtil.decodeMqttNamespaceIdFromClientId(originResource));
     }
 
     @Test
     public void testDecodeStoreNamespaceIdFromTopic() {
         Assert.assertEquals(namespace, NamespaceUtil.decodeStoreNamespaceIdFromTopic(resource));
+        Assert.assertNull(NamespaceUtil.decodeStoreNamespaceIdFromTopic(originResource));
     }
 
     @Test
diff --git a/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestStatUtil.java b/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestStatUtil.java
new file mode 100644
index 0000000..ce3d80a
--- /dev/null
+++ b/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestStatUtil.java
@@ -0,0 +1,64 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.rocketmq.mqtt.common.test.util;
+
+import org.apache.rocketmq.mqtt.common.util.StatUtil;
+import org.junit.Assert;
+import org.junit.Test;
+
+import java.math.BigDecimal;
+
+import static java.math.BigDecimal.ROUND_HALF_UP;
+
+public class TestStatUtil {
+
+    @Test
+    public void test() throws Exception {
+
+        final int keyAPv = 10, keyBPv = 20, testRt = 1000;
+        // test buildKey
+        String keyA = "a", keyB = "b";
+        Assert.assertEquals(keyA + "," + keyB, StatUtil.buildKey(keyA, keyB));
+
+        // test addInvoke
+        StatUtil.addInvoke(keyA, testRt);
+        Assert.assertEquals(1, StatUtil.nowTps(keyA));
+        Assert.assertFalse(StatUtil.isOverFlow(keyA, 200));
+
+        // test addPv
+        StatUtil.addPv(keyA, keyAPv);
+        Assert.assertEquals(keyAPv + 1, StatUtil.nowTps(keyA));
+
+        // test addSecondInvoke, addSecondPV, Pv, Tps
+        StatUtil.addSecondInvoke(keyB, testRt);
+        Assert.assertEquals(1, StatUtil.totalPvInWindow(keyB, 60));
+        StatUtil.addSecondPv(keyB, keyBPv);
+        Assert.assertEquals(keyBPv + 1, StatUtil.totalPvInWindow(keyB, 60));
+        Assert.assertEquals(0, StatUtil.failPvInWindow(keyB, 60));
+        Assert.assertEquals(0, StatUtil.topTpsInWindow(keyA, 60));
+        Assert.assertEquals(keyBPv + 1, StatUtil.topTpsInWindow(keyB, 60));
+
+        // test RtInWindow
+        Assert.assertEquals(testRt, StatUtil.maxRtInWindow(keyB, 60));
+        Assert.assertEquals(0, StatUtil.minRtInWindow(keyB, 60));
+        int avgRt = new BigDecimal(testRt).divide(new BigDecimal(keyBPv + 1),
+                ROUND_HALF_UP).intValue();
+        Assert.assertEquals(avgRt, StatUtil.avgRtInWindow(keyB, 60));
+    }
+
+}
\ No newline at end of file
diff --git a/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestTopicUtils.java b/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestTopicUtils.java
new file mode 100644
index 0000000..4fc4d35
--- /dev/null
+++ b/mqtt-common/src/test/java/org/apache/rocketmq/mqtt/common/test/util/TestTopicUtils.java
@@ -0,0 +1,121 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.rocketmq.mqtt.common.test.util;
+
+import org.apache.rocketmq.mqtt.common.model.Constants;
+import org.apache.rocketmq.mqtt.common.model.MqttTopic;
+import org.apache.rocketmq.mqtt.common.util.TopicUtils;
+import org.junit.Assert;
+import org.junit.Test;
+
+public class TestTopicUtils {
+
+  @Test
+  public void testTopicMatch() {
+    String topic = "t/t1/t2/";
+    String topicFilter = "t/t1/t2/";
+    Assert.assertTrue(TopicUtils.isMatch(topic, topicFilter));
+
+    topicFilter = "t/#/";
+    Assert.assertTrue(TopicUtils.isMatch(topic, topicFilter));
+
+    topicFilter = "t/t1/+/";
+    Assert.assertTrue(TopicUtils.isMatch(topic, topicFilter));
+
+    topicFilter = "t/+/#/";
+    Assert.assertTrue(TopicUtils.isMatch(topic, topicFilter));
+
+    topicFilter = "t/#/t2/";
+    Assert.assertFalse(TopicUtils.isMatch(topic, topicFilter));
+
+    topicFilter = "t/#/+/";
+    Assert.assertFalse(TopicUtils.isMatch(topic, topicFilter));
+
+    topicFilter = "t/t1/t2/t3/";
+    Assert.assertFalse(TopicUtils.isMatch(topic, topicFilter));
+
+    topicFilter = "t/t1/#/t3/";
+    Assert.assertFalse(TopicUtils.isMatch(topic, topicFilter));
+
+    topicFilter = "t/t1#/";
+    Assert.assertFalse(TopicUtils.isMatch(topic, topicFilter));
+  }
+
+  @Test
+  public void test() {
+    String topic = "test";
+    String mqttTopic = "test/mqtt";
+    String clientId = "test-mqtt";
+    String p2pTopic = Constants.P2P + clientId + Constants.MQTT_TOPIC_DELIMITER;
+    String retryTopic = Constants.RETRY + clientId + Constants.MQTT_TOPIC_DELIMITER;
+
+    // test normalizeTopic
+    Assert.assertNull(TopicUtils.normalizeTopic(""));
+    Assert.assertEquals(topic, TopicUtils.normalizeTopic(topic));
+    Assert.assertEquals(mqttTopic + Constants.MQTT_TOPIC_DELIMITER, TopicUtils.normalizeTopic(mqttTopic));
+
+    // test normalizeSecondTopic
+    Assert.assertNull(TopicUtils.normalizeSecondTopic(""));
+    Assert.assertEquals(Constants.MQTT_TOPIC_DELIMITER + topic + Constants.MQTT_TOPIC_DELIMITER,
+            TopicUtils.normalizeSecondTopic(topic));
+    Assert.assertEquals(p2pTopic, TopicUtils.normalizeSecondTopic(p2pTopic));
+
+    // test isP2P
+    Assert.assertTrue(TopicUtils.isP2P(p2pTopic));
+
+    // test getClientIdFromP2pTopic
+    Assert.assertEquals(clientId, TopicUtils.getClientIdFromP2pTopic(p2pTopic));
+
+    // test getClientIdFromRetryTopic
+    Assert.assertEquals(clientId, TopicUtils.getClientIdFromRetryTopic(retryTopic));
+
+    // test getP2pTopic, getRetryTopic
+    Assert.assertEquals(p2pTopic, TopicUtils.getP2pTopic(clientId));
+    Assert.assertEquals(retryTopic, TopicUtils.getRetryTopic(clientId));
+
+    // test isRetryTopic, isP2pTopic
+    Assert.assertTrue(TopicUtils.isRetryTopic(retryTopic));
+    Assert.assertFalse(TopicUtils.isRetryTopic(topic));
+    Assert.assertTrue(TopicUtils.isP2pTopic(p2pTopic));
+    Assert.assertFalse(TopicUtils.isP2pTopic(topic));
+
+    // test getP2Peer
+    String firstTopic = "first%topic", secondTopic = "/p2p/second";
+    String namespace = "namespace";
+    MqttTopic mqttTopicObj = new MqttTopic(firstTopic, secondTopic);
+    Assert.assertNull(TopicUtils.getP2Peer(new MqttTopic("", ""), namespace));
+    Assert.assertNull(TopicUtils.getP2Peer(new MqttTopic(firstTopic, "second"), namespace));
+    Assert.assertEquals("namespace%second", TopicUtils.getP2Peer(mqttTopicObj, namespace));
+
+    firstTopic = "first";
+    mqttTopicObj = new MqttTopic(firstTopic, secondTopic);
+    Assert.assertEquals("second", TopicUtils.getP2Peer(mqttTopicObj, namespace));
+
+    // test encode, decode
+    firstTopic = "first"; secondTopic = "/second/";
+    String topics = Constants.MQTT_TOPIC_DELIMITER + firstTopic + secondTopic;
+    Assert.assertEquals(firstTopic + secondTopic, TopicUtils.encode(firstTopic, secondTopic));
+    Assert.assertEquals(firstTopic, TopicUtils.decode(topics).getFirstTopic());
+    Assert.assertEquals(secondTopic, TopicUtils.decode(topics).getSecondTopic());
+
+    // test wrapLmp, wrapP2pLmq
+    Assert.assertEquals(firstTopic, TopicUtils.wrapLmq(firstTopic, ""));
+    Assert.assertEquals(firstTopic + p2pTopic, TopicUtils.wrapLmq(firstTopic, p2pTopic));
+    Assert.assertEquals(Constants.P2P + clientId + Constants.MQTT_TOPIC_DELIMITER, TopicUtils.wrapP2pLmq(clientId));
+  }
+}
