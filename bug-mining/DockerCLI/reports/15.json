{"url":"https://api.github.com/repos/docker/cli/issues/1736","repository_url":"https://api.github.com/repos/docker/cli","labels_url":"https://api.github.com/repos/docker/cli/issues/1736/labels{/name}","comments_url":"https://api.github.com/repos/docker/cli/issues/1736/comments","events_url":"https://api.github.com/repos/docker/cli/issues/1736/events","html_url":"https://github.com/docker/cli/issues/1736","id":420790257,"node_id":"MDU6SXNzdWU0MjA3OTAyNTc=","number":1736,"title":"goroutines leakage in runDialStdio","user":{"login":"andrey-ko","id":11482331,"node_id":"MDQ6VXNlcjExNDgyMzMx","avatar_url":"https://avatars.githubusercontent.com/u/11482331?v=4","gravatar_id":"","url":"https://api.github.com/users/andrey-ko","html_url":"https://github.com/andrey-ko","followers_url":"https://api.github.com/users/andrey-ko/followers","following_url":"https://api.github.com/users/andrey-ko/following{/other_user}","gists_url":"https://api.github.com/users/andrey-ko/gists{/gist_id}","starred_url":"https://api.github.com/users/andrey-ko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrey-ko/subscriptions","organizations_url":"https://api.github.com/users/andrey-ko/orgs","repos_url":"https://api.github.com/users/andrey-ko/repos","events_url":"https://api.github.com/users/andrey-ko/events{/privacy}","received_events_url":"https://api.github.com/users/andrey-ko/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":585916035,"node_id":"MDU6TGFiZWw1ODU5MTYwMzU=","url":"https://api.github.com/repos/docker/cli/labels/kind/bug","name":"kind/bug","color":"FF8C94","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2019-03-14T01:23:35Z","updated_at":"2019-04-01T22:17:11Z","closed_at":"2019-04-01T22:17:11Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"It looks like function runDialStdio https://github.com/docker/cli/blob/c3fc547cc9a3f9771852f74514a00ec50bad23ef/cli/command/system/dial_stdio.go#L29 have a goroutines leakage in almost all paths except one, when `copier(connHalfCloser, &halfReadCloserWrapper{os.Stdin}, \"stdin to stream\")` completes successfully before another goroutine.\r\nThe problem is that in all other 'bad' paths we exit function without listening another channel, in that case writing to the channel will block goroutine forever.\r\n\r\nHere the snippet to demonstrate this problem: \r\nhttps://play.golang.org/p/lVr92dAgPbh\r\n```\r\npackage main\r\n\r\nimport (\r\n\t\"errors\"\r\n\t\"fmt\"\r\n\t\"os\"\r\n\t\"runtime/pprof\"\r\n\t\"time\"\r\n)\r\n\r\nfunc main() {\r\n\tfor i := 0; i<=300 ; i++ {\r\n\t\trunDialStdio(i)\r\n\t\ttime.Sleep(100 * time.Millisecond)\r\n\t\tif i % 100 == 0 {\r\n\t\t\tp := pprof.Lookup(\"goroutine\")\r\n\t\t\tp.WriteTo(os.Stdout, 1)\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunc runDialStdio(i int) error {\r\n\r\n\tstdin2conn := make(chan error)\r\n\tconn2stdout := make(chan error)\r\n\r\n\tgo func() {\r\n\t\tstdin2conn <- errors.New(\"stdin2conn\")\r\n\t\tfmt.Printf(\"completed [%d], stdin2conn\\n\", i)\r\n\t}()\r\n\tgo func() {\r\n\t\ttime.Sleep(time.Millisecond)\r\n\t\tconn2stdout  <- errors.New(\"conn2stdout\") //nobody listen on conn2stdout so we will be blocked here forever\r\n\t\tfmt.Printf(\"completed [%d], conn2stdout\\n\", i)\r\n\t}()\r\n\r\n\tvar err error\r\n\tselect {\r\n\tcase err = <-stdin2conn:\r\n\t\tif err != nil {\r\n\t\t\treturn err\r\n\t\t}\r\n\t\terr = <-conn2stdout\r\n\tcase err = <-conn2stdout:\r\n\t}\r\n\treturn err\r\n}\r\n```\r\nIf we run this code, in the end of output we can see:\r\n```\r\ngoroutine profile: total 302\r\n301 @ 0x57280 0x24520 0x244e8 0x24260 0x10f7e0 0x8eb01\r\n#    0x10f7df    main.runDialStdio.func2+0xbf    /tmp/sandbox424713474/main.go:33\r\n\r\n1 @ 0x106a40 0x106780 0x1029a0 0x10f2e0 0x56c40 0x8eb01\r\n#    0x106a3f    runtime/pprof.writeRuntimeProfile+0xbf    /usr/local/go/src/runtime/pprof/pprof.go:708\r\n#    0x10677f    runtime/pprof.writeGoroutine+0x9f    /usr/local/go/src/runtime/pprof/pprof.go:670\r\n#    0x10299f    runtime/pprof.(*Profile).WriteTo+0x3bf    /usr/local/go/src/runtime/pprof/pprof.go:329\r\n#    0x10f2df    main.main+0xdf                /tmp/sandbox424713474/main.go:17\r\n#    0x56c3f        runtime.main+0x2df            /usr/local/go/src/runtime/proc.go:200\r\n```\r\nmeaning that there are 301 goroutines blocked at main.go:33\r\n\r\nProbably the easiest way to fix it is to create 'buffered' channels:\r\n```\r\nstdin2conn := make(chan error, 1)\r\nconn2stdout := make(chan error, 1)\r\n```\r\nnot sure if it is the best solution though, so creating this issue for now.\r\n\r\nAlso it doesn't really very serious issue in our case, as we exit process right after we exit runDialStdio, but it feels wrong to keep code with such problems.","closed_by":{"login":"tiborvass","id":827131,"node_id":"MDQ6VXNlcjgyNzEzMQ==","avatar_url":"https://avatars.githubusercontent.com/u/827131?v=4","gravatar_id":"","url":"https://api.github.com/users/tiborvass","html_url":"https://github.com/tiborvass","followers_url":"https://api.github.com/users/tiborvass/followers","following_url":"https://api.github.com/users/tiborvass/following{/other_user}","gists_url":"https://api.github.com/users/tiborvass/gists{/gist_id}","starred_url":"https://api.github.com/users/tiborvass/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tiborvass/subscriptions","organizations_url":"https://api.github.com/users/tiborvass/orgs","repos_url":"https://api.github.com/users/tiborvass/repos","events_url":"https://api.github.com/users/tiborvass/events{/privacy}","received_events_url":"https://api.github.com/users/tiborvass/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/docker/cli/issues/1736/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/docker/cli/issues/1736/timeline","performed_via_github_app":null,"state_reason":"completed"}