{"url":"https://api.github.com/repos/gulpjs/gulp/issues/587","repository_url":"https://api.github.com/repos/gulpjs/gulp","labels_url":"https://api.github.com/repos/gulpjs/gulp/issues/587/labels{/name}","comments_url":"https://api.github.com/repos/gulpjs/gulp/issues/587/comments","events_url":"https://api.github.com/repos/gulpjs/gulp/issues/587/events","html_url":"https://github.com/gulpjs/gulp/issues/587","id":37737672,"node_id":"MDU6SXNzdWUzNzczNzY3Mg==","number":587,"title":"Improve error messages on exit","user":{"login":"pkozlowski-opensource","id":973550,"node_id":"MDQ6VXNlcjk3MzU1MA==","avatar_url":"https://avatars.githubusercontent.com/u/973550?v=4","gravatar_id":"","url":"https://api.github.com/users/pkozlowski-opensource","html_url":"https://github.com/pkozlowski-opensource","followers_url":"https://api.github.com/users/pkozlowski-opensource/followers","following_url":"https://api.github.com/users/pkozlowski-opensource/following{/other_user}","gists_url":"https://api.github.com/users/pkozlowski-opensource/gists{/gist_id}","starred_url":"https://api.github.com/users/pkozlowski-opensource/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pkozlowski-opensource/subscriptions","organizations_url":"https://api.github.com/users/pkozlowski-opensource/orgs","repos_url":"https://api.github.com/users/pkozlowski-opensource/repos","events_url":"https://api.github.com/users/pkozlowski-opensource/events{/privacy}","received_events_url":"https://api.github.com/users/pkozlowski-opensource/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2014-07-13T09:07:16Z","updated_at":"2014-07-25T08:35:36Z","closed_at":"2014-07-14T19:21:42Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I wonder how we could improve error messages when a task signals an error in a callback. Consider this convoluted (but illustrating the point) task:\n\n``` javascript\ngulp.task('foo', function (done) {\n  setTimeout(function () {\n    done(new Error('fail'));\n  }, 1000);\n});\n```\n\nWith the above code snippet the exit code / stack trace is nice and all is well:\n\n> [10:46:52] 'foo' errored after 1 s\n> [10:46:52] Error: fail\n>     at null._onTimeout (/Users/pawelkozlowski/work/gitrepos/pkozlowski-opensource/gulp-karma/gulpfile.js:34:10)\n>     at Timer.listOnTimeout [as ontimeout](timers.js:110:15)\n### The problem\n\nI supply the `done` callback with a string (`done('fail')`) I'm getting a looongish stack trace from the gulp CLI which is rather verbose and hard to read:\n\n> [10:51:47] Error: fail\n>     at formatError (/usr/local/lib/node_modules/gulp/bin/gulp.js:152:12)\n>     at Gulp.<anonymous> (/usr/local/lib/node_modules/gulp/bin/gulp.js:189:15)\n>     at Gulp.EventEmitter.emit (events.js:95:17)\n>     at Gulp.Orchestrator._emitTaskDone (/Users/pawelkozlowski/work/gitrepos/pkozlowski-opensource/gulp-karma/node_modules/gulp/node_modules/orchestrator/index.js:264:8)\n>     at /Users/pawelkozlowski/work/gitrepos/pkozlowski-opensource/gulp-karma/node_modules/gulp/node_modules/orchestrator/index.js:275:23\n>     at finish (/Users/pawelkozlowski/work/gitrepos/pkozlowski-opensource/gulp-karma/node_modules/gulp/node_modules/orchestrator/lib/runTask.js:20:8)\n>     at cb (/Users/pawelkozlowski/work/gitrepos/pkozlowski-opensource/gulp-karma/node_modules/gulp/node_modules/orchestrator/lib/runTask.js:28:3)\n>     at null._onTimeout (/Users/pawelkozlowski/work/gitrepos/pkozlowski-opensource/gulp-karma/gulpfile.js:34:5)\n>     at Timer.listOnTimeout [as ontimeout](timers.js:110:15)\n\nIt has all the necessary info but yeh, people will be probably confused  by seeing orchestrator / gulp as part of the stack-trace. Maybe it would make sense to filter out part of the internal Gulp stack-frames?\n#### Special case for numbers\n\nIf a non-zero number is supplied to the `done` callback (ex. `done(1)`), which is a real life scenario from gulp-karma integration (https://github.com/karma-runner/gulp-karma/blob/master/gulpfile.js#L20) we are getting:\n\n> [10:59:14] 'foo' errored after 1 s\n> [10:59:14] undefined\n\nwhich should be fixed, IMO, as `undefined` looks like something is internally broken.\n### The proposal\n\nBased on the above, here are my suggestions:\n- **let's treat number exit values the same way as string exit values** (or, more generally - all the non-Error exit values should be going through the same path);\n- consider filtering out parts of the stack-trace to remove Gulp / orchestrator frames. It would be really nice for users but yeh, this is rather fragile, so I'm 50/50 here.\n\nWould be happy to put together a PR if the above reasoning makes sense to you guys.\n\nRelated to this commit:  aeaebd93d094674afe875b014f826f2c6d3529c0\n","closed_by":{"login":"yocontra","id":425716,"node_id":"MDQ6VXNlcjQyNTcxNg==","avatar_url":"https://avatars.githubusercontent.com/u/425716?v=4","gravatar_id":"","url":"https://api.github.com/users/yocontra","html_url":"https://github.com/yocontra","followers_url":"https://api.github.com/users/yocontra/followers","following_url":"https://api.github.com/users/yocontra/following{/other_user}","gists_url":"https://api.github.com/users/yocontra/gists{/gist_id}","starred_url":"https://api.github.com/users/yocontra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yocontra/subscriptions","organizations_url":"https://api.github.com/users/yocontra/orgs","repos_url":"https://api.github.com/users/yocontra/repos","events_url":"https://api.github.com/users/yocontra/events{/privacy}","received_events_url":"https://api.github.com/users/yocontra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/gulpjs/gulp/issues/587/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/gulpjs/gulp/issues/587/timeline","performed_via_github_app":null,"state_reason":"completed"}