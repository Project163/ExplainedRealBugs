<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:01:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[TIKA-2446] Tainted Zip file can provoke OOM errors</title>
                <link>https://issues.apache.org/jira/browse/TIKA-2446</link>
                <project id="12310631" key="TIKA">Tika</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;using Tika 1.16 with embedded POI 3.17-beta1 we experienced an OutOfMemory error on a Zip file. The suspicious code is in the constructor of FakeZipEntry in line 125. Here a ByteArrayOutputStream of up to 2 GiB in size is opened which will most probably lead to an OutOfMemory. The entry size in the zip file can be easily faked by an attacker.&lt;/p&gt;

&lt;p&gt;The code path to FakeZipEntry will be used only if the native java.util.zip.ZipFile implementation already failed to open the (possibly corrupted) Zip. Possibly a more fine grained error analysis could be done in ZipPackage.&lt;/p&gt;

&lt;p&gt;I have attached a tweaked zip file that will provoke this error.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; FakeZipEntry(ZipEntry entry, InputStream inp) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
			&lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(entry.getName());
			
			&lt;span class=&quot;code-comment&quot;&gt;// Grab the de-compressed contents &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; later
&lt;/span&gt;            ByteArrayOutputStream baos;

            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; entrySize = entry.getSize();

            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (entrySize !=-1) {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (entrySize&amp;gt;=&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE) {
                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;ZIP entry size is too large&quot;&lt;/span&gt;);
                }

                baos = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayOutputStream((&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) entrySize);
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
    			baos = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayOutputStream();
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Kinds,&lt;/p&gt;

&lt;p&gt;Thorsten&lt;/p&gt;</description>
                <environment></environment>
        <key id="13097245">TIKA-2446</key>
            <summary>Tainted Zip file can provoke OOM errors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="thorsten.schaefer">Thorsten Sch&#228;fer</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Aug 2017 07:35:22 +0000</created>
                <updated>Thu, 7 Jun 2018 05:03:40 +0000</updated>
                            <resolved>Wed, 6 Jun 2018 19:36:27 +0000</resolved>
                                    <version>1.16</version>
                                    <fixVersion>1.19</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                        <due></due>
                            <votes>3</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16502296" author="rschimpf" created="Tue, 5 Jun 2018 18:50:08 +0000"  >&lt;p&gt;I also see this error from time to time with Tika 1.15. This is a regression from the changes made in &lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2311&quot; title=&quot;Preserve &amp;quot;x-tika-ooxml&amp;quot; mime value for truncated ooxml files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2311&quot;&gt;&lt;del&gt;TIKA-2311&lt;/del&gt;&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tallison%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;tallison@apache.org&quot;&gt;tallison@apache.org&lt;/a&gt; since you made the changes for the truncated zips can you provide any help or information? I tried to fix the issue but always broke some existing tests.&lt;/p&gt;

&lt;p&gt;This might also be forwarded to the POI project. Maybe they can provide a fix in their code.&lt;/p&gt;</comment>
                            <comment id="16503280" author="tallison@mitre.org" created="Wed, 6 Jun 2018 13:22:08 +0000"  >&lt;p&gt;We can prevent an OOM in our code by changing how we open the package:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ZipEntrySource zipEntrySource = new ZipFileZipEntrySource(new java.util.zip.ZipFile(stream.getFile()));
OPCPackage pkg = OPCPackage.open(zipEntrySource);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Java&apos;s ZipFile throws an IOException during detection which is swallowed, and then commons-compress throws an EOFException when the parser tries to parse the file.&lt;/p&gt;

&lt;p&gt;I agree that we should try to fix this at the POI level, though.  In 3.17 at least there&apos;s a check that the length of the stream is &amp;lt; Integer.MAX_VALUE, which, as noted above is 2GB. Although I&apos;ve done it before it feels hacky to limit this to, say 1 GB.  I wonder if POI should write out to a new temp file, rather than trying to buffer the defective ZIP into memory?  Maybe not pre-allocate the byte[]...given, as pointed out above, that by this point we know we&apos;re dealing with a corrupted file?&lt;/p&gt;</comment>
                            <comment id="16503412" author="hudson" created="Wed, 6 Jun 2018 14:58:16 +0000"  >&lt;p&gt;UNSTABLE: Integrated in Jenkins build Tika-trunk #1501 (See &lt;a href=&quot;https://builds.apache.org/job/Tika-trunk/1501/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Tika-trunk/1501/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2446&quot; title=&quot;Tainted Zip file can provoke OOM errors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2446&quot;&gt;&lt;del&gt;TIKA-2446&lt;/del&gt;&lt;/a&gt; &amp;#8211; prevent oom during detection of corrupt zip (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/bc24ccb302d1454a226dbfd38337b8f8050d7e4a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/bc24ccb302d1454a226dbfd38337b8f8050d7e4a&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/pkg/ZipContainerDetector.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/test/java/org/apache/tika/parser/microsoft/ooxml/OOXMLParserTest.java&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/test/resources/test-documents/testZIP_corrupted_oom.zip&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16503470" author="hudson" created="Wed, 6 Jun 2018 15:42:04 +0000"  >&lt;p&gt;UNSTABLE: Integrated in Jenkins build tika-2.x-windows #267 (See &lt;a href=&quot;https://builds.apache.org/job/tika-2.x-windows/267/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/tika-2.x-windows/267/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2446&quot; title=&quot;Tainted Zip file can provoke OOM errors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2446&quot;&gt;&lt;del&gt;TIKA-2446&lt;/del&gt;&lt;/a&gt; &amp;#8211; prevent oom during detection of corrupt zip (tallison: rev bc24ccb302d1454a226dbfd38337b8f8050d7e4a)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(add) tika-parsers/src/test/resources/test-documents/testZIP_corrupted_oom.zip&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/pkg/ZipContainerDetector.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/test/java/org/apache/tika/parser/microsoft/ooxml/OOXMLParserTest.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2446&quot; title=&quot;Tainted Zip file can provoke OOM errors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2446&quot;&gt;&lt;del&gt;TIKA-2446&lt;/del&gt;&lt;/a&gt; &amp;#8211; prevent oom during detection of corrupt zip &amp;#8211; catch POI&apos;s (tallison: rev a0325c2480357c99dff0fa99248886d3372269fa)&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/pkg/ZipContainerDetector.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16503540" author="hudson" created="Wed, 6 Jun 2018 16:26:33 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Tika-trunk #1502 (See &lt;a href=&quot;https://builds.apache.org/job/Tika-trunk/1502/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Tika-trunk/1502/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2446&quot; title=&quot;Tainted Zip file can provoke OOM errors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2446&quot;&gt;&lt;del&gt;TIKA-2446&lt;/del&gt;&lt;/a&gt; &amp;#8211; prevent oom during detection of corrupt zip &amp;#8211; catch POI&apos;s (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/a0325c2480357c99dff0fa99248886d3372269fa&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/a0325c2480357c99dff0fa99248886d3372269fa&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/pkg/ZipContainerDetector.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16503793" author="tallison@mitre.org" created="Wed, 6 Jun 2018 19:36:27 +0000"  >&lt;p&gt;I confirmed that this does not happen in POI trunk...so no need to open an issue over there.  Thank you!&lt;/p&gt;</comment>
                            <comment id="16503903" author="hudson" created="Wed, 6 Jun 2018 20:56:30 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build tika-branch-1x #42 (See &lt;a href=&quot;https://builds.apache.org/job/tika-branch-1x/42/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/tika-branch-1x/42/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2446&quot; title=&quot;Tainted Zip file can provoke OOM errors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2446&quot;&gt;&lt;del&gt;TIKA-2446&lt;/del&gt;&lt;/a&gt; &amp;#8211; prevent oom during detection of corrupt zip (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/e3504884337a86240dbd8a5a4db13eb1146231c3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/e3504884337a86240dbd8a5a4db13eb1146231c3&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(add) tika-parsers/src/test/resources/test-documents/testZIP_corrupted_oom.zip&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/pkg/ZipContainerDetector.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/test/java/org/apache/tika/parser/microsoft/ooxml/OOXMLParserTest.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2446&quot; title=&quot;Tainted Zip file can provoke OOM errors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2446&quot;&gt;&lt;del&gt;TIKA-2446&lt;/del&gt;&lt;/a&gt; &amp;#8211; prevent oom during detection of corrupt zip &amp;#8211; catch POI&apos;s (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/88fe62c8e3614c01719d64fc985158a2fd940e24&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/88fe62c8e3614c01719d64fc985158a2fd940e24&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/pkg/ZipContainerDetector.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16504245" author="rschimpf" created="Thu, 7 Jun 2018 05:03:40 +0000"  >&lt;p&gt;Thank you for the fix!&lt;/p&gt;

&lt;p&gt;Looks like POI changed their implementation to use commons-compress recently. Good to know they already fixed the problem.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12883506" name="corrupt_zip.zip" size="181" author="thorsten.schaefer" created="Thu, 24 Aug 2017 07:37:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 23 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3j893:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>