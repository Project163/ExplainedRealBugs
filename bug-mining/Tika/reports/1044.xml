<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:02:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[TIKA-2673] HtmlEncodingDetector doesn&apos;t follow the specification</title>
                <link>https://issues.apache.org/jira/browse/TIKA-2673</link>
                <project id="12310631" key="TIKA">Tika</project>
                    <description>&lt;p&gt;This bug is linked to &lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2671&quot; title=&quot;HtmlEncodingDetector doesnt take provided metadata into account&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2671&quot;&gt;TIKA-2671&lt;/a&gt;, but does not concern metadata, but rather the bytes-based detection itself.&lt;/p&gt;

&lt;p&gt;While reading the specification, I collected a list of sample cases where HtmlEncodingDetector differs from the specification, and thus fails at detecting the right charset.&lt;/p&gt;

&lt;p&gt;I am attaching the test cases to this issue: &lt;/p&gt;</description>
                <environment></environment>
        <key id="13166966">TIKA-2673</key>
            <summary>HtmlEncodingDetector doesn&apos;t follow the specification</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tallison">Tim Allison</assignee>
                                    <reporter username="gbouchar">Gerard Bouchar</reporter>
                        <labels>
                    </labels>
                <created>Tue, 19 Jun 2018 15:35:57 +0000</created>
                <updated>Fri, 30 Aug 2019 12:08:55 +0000</updated>
                            <resolved>Fri, 3 Aug 2018 15:37:44 +0000</resolved>
                                                    <fixVersion>1.19</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16519100" author="gbouchar" created="Thu, 21 Jun 2018 09:01:18 +0000"  >&lt;p&gt;Another important part of the specification that is ignored by HtmlEncodingDetector is &lt;a href=&quot;https://encoding.spec.whatwg.org/#names-and-labels&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;paragraph 4.2 of the encoding spec&lt;/a&gt;, that specifies aliases to use for encodings. HtmlEncodingDetector simply uses &lt;a href=&quot;https://docs.oracle.com/javase/8/docs/api/java/nio/charset/Charset.html#forName-java.lang.String-&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Charset.forName&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The specification maps some labels to DIFFERENT charsets. For instance &quot;ISO-8859-1&quot; is mapped to the WINDOWS-1252 encoding. &lt;/p&gt;</comment>
                            <comment id="16519679" author="tallison@mitre.org" created="Thu, 21 Jun 2018 18:52:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gbouchar&quot; class=&quot;user-hover&quot; rel=&quot;gbouchar&quot;&gt;gbouchar&lt;/a&gt;, thank you for these unit tests!&#160; I&apos;ve added them and made the easy fixes where I could.&#160; As you know, to do a full parse is non-trivial, and I&apos;d like evidence from some corpus that the effort is worth it.&#160;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If you&apos;d like to contribute a StrictHTMLEncodingDetector, we could compare the performance of that with what we have on our 1TB regression corpus.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If you&apos;d like access to our VM either to run your own comparisons or to help us curate it and make it more representative of modern websites with diverse languages and encodings, let me know.&lt;/p&gt;</comment>
                            <comment id="16519704" author="hudson" created="Thu, 21 Jun 2018 19:27:39 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build tika-2.x-windows #276 (See &lt;a href=&quot;https://builds.apache.org/job/tika-2.x-windows/276/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/tika-2.x-windows/276/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; &amp;#8211; unit tests for stricter adherence to spec via Gerard (tallison: rev b688afa01939a1f32775a7e7f0797a8ea466c612)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(add) tika-parsers/src/test/java/org/apache/tika/parser/html/HtmlEncodingDetectorTest.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/HtmlEncodingDetector.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16519708" author="hudson" created="Thu, 21 Jun 2018 19:32:04 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build Tika-trunk #1511 (See &lt;a href=&quot;https://builds.apache.org/job/Tika-trunk/1511/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Tika-trunk/1511/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; &amp;#8211; unit tests for stricter adherence to spec via Gerard (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/b688afa01939a1f32775a7e7f0797a8ea466c612&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/b688afa01939a1f32775a7e7f0797a8ea466c612&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(add) tika-parsers/src/test/java/org/apache/tika/parser/html/HtmlEncodingDetectorTest.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/HtmlEncodingDetector.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16519748" author="hudson" created="Thu, 21 Jun 2018 20:26:37 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build tika-branch-1x #50 (See &lt;a href=&quot;https://builds.apache.org/job/tika-branch-1x/50/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/tika-branch-1x/50/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; &amp;#8211; unit tests for stricter adherence to spec via Gerard (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/df9ed8260c91800baa202a748b0ff3854937ff5f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/df9ed8260c91800baa202a748b0ff3854937ff5f&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/HtmlEncodingDetector.java&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/test/java/org/apache/tika/parser/html/HtmlEncodingDetectorTest.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; &amp;#8211; unit tests for stricter adherence to spec via Gerard (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/c6f7b45ae6ace89ee2398f251c97dd23d220355b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/c6f7b45ae6ace89ee2398f251c97dd23d220355b&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/test/java/org/apache/tika/parser/html/HtmlEncodingDetectorTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16519793" author="hudson" created="Thu, 21 Jun 2018 21:33:20 +0000"  >&lt;p&gt;UNSTABLE: Integrated in Jenkins build tika-2.x-windows #277 (See &lt;a href=&quot;https://builds.apache.org/job/tika-2.x-windows/277/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/tika-2.x-windows/277/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; &amp;#8211; unit tests for stricter adherence to spec via Gerard (tallison: rev 5eec28ae0203820364dbcdef58335fd64aeb90ec)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-parsers/src/test/java/org/apache/tika/parser/html/HtmlEncodingDetectorTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16519802" author="hudson" created="Thu, 21 Jun 2018 21:50:42 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Tika-trunk #1512 (See &lt;a href=&quot;https://builds.apache.org/job/Tika-trunk/1512/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Tika-trunk/1512/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; &amp;#8211; unit tests for stricter adherence to spec via Gerard (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/5eec28ae0203820364dbcdef58335fd64aeb90ec&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/5eec28ae0203820364dbcdef58335fd64aeb90ec&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-parsers/src/test/java/org/apache/tika/parser/html/HtmlEncodingDetectorTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16520117" author="gbouchar" created="Fri, 22 Jun 2018 08:33:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tallison%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;tallison@apache.org&quot;&gt;tallison@apache.org&lt;/a&gt; : Thank you very much for integrating my tests and for your changes to HtmlEncodingDetector! I think at least the utf16 test shouldn&apos;t be ignored. HtmlEncodingDetector does its detection using regular expressions on the byte stream decoded as ASCII. So if the file were actually in UTF-16 (a two bytes per character encoding that is not compatible with ASCII), then it wouldn&apos;t have matched the regular expression in the first place. Decoding it as UTF-16 will almost certainly result in garbled text. &lt;a href=&quot;https://html.spec.whatwg.org/multipage/parsing.html#the-input-byte-stream&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;The specification&lt;/a&gt; was written by people with experience in real-world misuses of character encodings on the web, I think we can confidently trust it concerning various edge-cases such as this one.&lt;/p&gt;</comment>
                            <comment id="16520127" author="gbouchar" created="Fri, 22 Jun 2018 08:42:09 +0000"  >&lt;p&gt;Another part of the specification I think we should respect is &lt;a href=&quot;https://encoding.spec.whatwg.org/#names-and-labels&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;character encoding names and labels&lt;/a&gt;. Several aliases are made from aliases to different charset names, and I think using the labels in this table makes more sense then using the ones defined by java (that were not meant to be used in HTML, or to be compatible with HTML).&lt;/p&gt;</comment>
                            <comment id="16520131" author="gbouchar" created="Fri, 22 Jun 2018 08:54:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://blog.whatwg.org/the-road-to-html-5-character-encoding&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This blog post by the whatwg on character encodings&lt;/a&gt; is an interesting read that explains the gist of the specification and some of the reasons motivating it.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.w3.org/International/tests/repository/html5/the-input-byte-stream/results-basics&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;These tests&lt;/a&gt; show how well browsers respect the specification.&lt;/p&gt;</comment>
                            <comment id="16520137" author="gbouchar" created="Fri, 22 Jun 2018 08:59:09 +0000"  >&lt;p&gt;I think at least the following tests should be included, and pass:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void bom() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        &lt;span class=&quot;code-comment&quot;&gt;// A BOM should have precedence over the meta
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// let assertCharset encode the string in the expected charset
&lt;/span&gt;        assertCharset(&lt;span class=&quot;code-quote&quot;&gt;&quot;\ufeff&amp;lt;meta charset=&lt;span class=&quot;code-quote&quot;&gt;&apos;WINDOWS-1252&apos;&lt;/span&gt;&amp;gt;&quot;&lt;/span&gt;, StandardCharsets.UTF_8);
        assertCharset(&lt;span class=&quot;code-quote&quot;&gt;&quot;\ufeff&amp;lt;meta charset=&lt;span class=&quot;code-quote&quot;&gt;&apos;WINDOWS-1252&apos;&lt;/span&gt;&amp;gt;&quot;&lt;/span&gt;, StandardCharsets.UTF_16LE);
        assertCharset(&lt;span class=&quot;code-quote&quot;&gt;&quot;\ufeff&amp;lt;meta charset=&lt;span class=&quot;code-quote&quot;&gt;&apos;WINDOWS-1252&apos;&lt;/span&gt;&amp;gt;&quot;&lt;/span&gt;, StandardCharsets.UTF_16BE);
    }

    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void utf16() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        &lt;span class=&quot;code-comment&quot;&gt;// According to the specification &lt;span class=&quot;code-quote&quot;&gt;&apos;If charset is a UTF-16 encoding, then set charset to UTF-8.&apos;&lt;/span&gt;
&lt;/span&gt;        assertCharset(&lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;meta charset=&lt;span class=&quot;code-quote&quot;&gt;&apos;UTF-16BE&apos;&lt;/span&gt;&amp;gt;&quot;&lt;/span&gt;, StandardCharsets.UTF_8);
    }

    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void macintoshEncoding() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        &lt;span class=&quot;code-comment&quot;&gt;// The mac roman encoding exists in java, but under the name x-MacRoman
&lt;/span&gt;        assertCharset(&lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;meta charset=&lt;span class=&quot;code-quote&quot;&gt;&apos;macintosh&apos;&lt;/span&gt;&amp;gt;&quot;&lt;/span&gt;, Charset.forName(&lt;span class=&quot;code-quote&quot;&gt;&quot;x-MacRoman&quot;&lt;/span&gt;));
    }

    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void iso88591() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        &lt;span class=&quot;code-comment&quot;&gt;// In the spec, iso-8859-1 is an alias &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; WINDOWS-1252
&lt;/span&gt;        assertWindows1252(&lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;meta charset=&lt;span class=&quot;code-quote&quot;&gt;&apos;iso-8859-1&apos;&lt;/span&gt;&amp;gt;&quot;&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16520281" author="gbouchar" created="Fri, 22 Jun 2018 11:59:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;If you&apos;d like to contribute a StrictHTMLEncodingDetector, we could compare the performance of that with what we have on our 1TB regression corpus.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I agree that testing on real-world data is the key for such a problem. We are going to conduct our own testing internally, but more testing can only be beneficial.&lt;/p&gt;

&lt;p&gt;I am attaching my first attempt at writing a StrictHtmlEncodingDetector for tika. The code is still quite messy, but I tried to write a lot of tests, and have 99% code coverage. It should take into account user-defined metadata, unicode BOM, and meta tags according to the specification. It is meant to be used in a composite encoding detector, with an existing probabilistic detector such as Icu4jEncodingDetector as fallback.&lt;/p&gt;

&lt;p&gt;I would be very curious to see how it performs on your corpus, compared to a real modern browser.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12928759/12928759_StrictHtmlEncodingDetector.tar.gz&quot; title=&quot;StrictHtmlEncodingDetector.tar.gz attached to TIKA-2673&quot;&gt;StrictHtmlEncodingDetector.tar.gz&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16534992" author="tallison@mitre.org" created="Fri, 6 Jul 2018 15:26:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gbouchar&quot; class=&quot;user-hover&quot; rel=&quot;gbouchar&quot;&gt;gbouchar&lt;/a&gt;, thank you for contributing this!&#160; I won&apos;t have time to run the regression tests any time soon.&#160; Would you be ok if I added your StrictHtmlEncodingDetector to Tika now?&#160; Users would then be able to configure Tika to use it via tika-config.xml.&#160; If you&apos;re ok with this, is it ok if I add the Apache Software License 2.0 headers to your main class, test class and .tsv files?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thank you, again!&lt;/p&gt;</comment>
                            <comment id="16535041" author="tallison@mitre.org" created="Fri, 6 Jul 2018 15:57:53 +0000"  >&lt;p&gt;I&apos;ve added this to both &apos;master&apos; and &apos;branch_1x&apos;.&#160; Let me know if you disagree with this or would like to make modifications.&lt;/p&gt;</comment>
                            <comment id="16535130" author="hudson" created="Fri, 6 Jul 2018 17:04:29 +0000"  >&lt;p&gt;UNSTABLE: Integrated in Jenkins build tika-2.x-windows #282 (See &lt;a href=&quot;https://builds.apache.org/job/tika-2.x-windows/282/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/tika-2.x-windows/282/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; &amp;#8211; add StrictHtmlEncodingDetector, contributed by Gerard (tallison: rev 790c1248207371e6cb2a3e7a1ec3a021503ec7a4)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(add) tika-parsers/src/main/java/org/apache/tika/parser/html/StrictHtmlEncodingDetector.java&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/main/resources/org/apache/tika/parser/html/whatwg-encoding-labels.tsv&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/test/java/org/apache/tika/parser/html/StrictHtmlEncodingDetectorTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16535145" author="hudson" created="Fri, 6 Jul 2018 17:21:21 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Tika-trunk #1517 (See &lt;a href=&quot;https://builds.apache.org/job/Tika-trunk/1517/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Tika-trunk/1517/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; &amp;#8211; add StrictHtmlEncodingDetector, contributed by Gerard (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/790c1248207371e6cb2a3e7a1ec3a021503ec7a4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/790c1248207371e6cb2a3e7a1ec3a021503ec7a4&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(add) tika-parsers/src/main/java/org/apache/tika/parser/html/StrictHtmlEncodingDetector.java&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/main/resources/org/apache/tika/parser/html/whatwg-encoding-labels.tsv&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/test/java/org/apache/tika/parser/html/StrictHtmlEncodingDetectorTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16535147" author="hudson" created="Fri, 6 Jul 2018 17:24:01 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build tika-branch-1x #56 (See &lt;a href=&quot;https://builds.apache.org/job/tika-branch-1x/56/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/tika-branch-1x/56/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; &amp;#8211; add StrictHtmlEncodingDetector, contributed by Gerard (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/525889a4f928d1d448c6aaf6b1ddc19081e07404&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/525889a4f928d1d448c6aaf6b1ddc19081e07404&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(add) tika-parsers/src/main/java/org/apache/tika/parser/html/StrictHtmlEncodingDetector.java&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/main/resources/org/apache/tika/parser/html/whatwg-encoding-labels.tsv&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/test/java/org/apache/tika/parser/html/StrictHtmlEncodingDetectorTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16541307" author="gbouchar" created="Thu, 12 Jul 2018 08:22:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tallison%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;tallison@apache.org&quot;&gt;tallison@apache.org&lt;/a&gt; : great, thank you very much ! Of course I agree for it to be merged. I&apos;m sorry for forgetting the license header in the first place.&lt;/p&gt;

&lt;p&gt;I have done more work on this in the last days. I am going to make a pull request to include my last changes.&lt;/p&gt;

&lt;p&gt;We have conducted an internal testing on this, and have seen great results. We selected a random subset of ~100 000 URLs from a nutch segment, fetched it once in nutch, and parsed it using different strategies. We fetched the same URLs using puppeteer (a headless chrome), and compared the charset detected. Here are the results&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; correct similar wrong&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;standard&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 99.4%&#160;&#160;&#160; 0.0%&#160; 0.6%&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;standard_noparse&#160;&#160; 94.7%&#160;&#160;&#160; 4.6%&#160; 0.6%&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;default&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 85.9%&#160;&#160; 11.5%&#160; 2.6%&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;icu&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 79.1%&#160;&#160; 13.9%&#160; 7.0%&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12931459/12931459_image-2018-07-13-11-28-16-657.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;standard_noparse is a composite detector with a version of my detector that just takes into account the BOM and HTTP headers, chained with the existing HtmlEncodingDetector, chained with Icu4JEncodingDetector.&lt;/p&gt;

&lt;p&gt;standard is a composite detector with the last version of my detector, chained with Icu4JEncodingDetector.&lt;/p&gt;

&lt;p&gt;Labeled as &quot;correct&quot; are the pages that were detected the same in chrome and tika. &quot;similar&quot; means that although incorrect, the detected charset is close to the one detected by chrome (ISO-8859-1 instead of WINDOWS-1254, for instance). &quot;wrong&quot; means that the detected charset was not close to the one detected by chrome.&lt;/p&gt;</comment>
                            <comment id="16541906" author="gbouchar" created="Thu, 12 Jul 2018 16:35:13 +0000"  >&lt;p&gt;I made a pull request on github: &lt;a href=&quot;https://github.com/apache/tika/pull/242&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/pull/242&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16542016" author="tallison@mitre.org" created="Thu, 12 Jul 2018 17:56:02 +0000"  >&lt;p&gt;W00t!  Thank you for your evaluation, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gbouchar&quot; class=&quot;user-hover&quot; rel=&quot;gbouchar&quot;&gt;gbouchar&lt;/a&gt;!  Would you be able to re-attach the results or find another way to share them with us?&lt;/p&gt;</comment>
                            <comment id="16542763" author="gbouchar" created="Fri, 13 Jul 2018 09:18:07 +0000"  >&lt;p&gt;I pushed my data to a branch on github: &lt;a href=&quot;https://github.com/GerardBouchar/tika/blob/TIKA-2673-benchmark/benchmark/chrome.ipynb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/GerardBouchar/tika/blob/TIKA-2673-benchmark/benchmark/chrome.ipynb&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This is not very clean, but now you can see which data I used, and what exactly I analyzed.&lt;/p&gt;</comment>
                            <comment id="16545135" author="wastl-nagel" created="Mon, 16 Jul 2018 12:21:51 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gbouchar&quot; class=&quot;user-hover&quot; rel=&quot;gbouchar&quot;&gt;gbouchar&lt;/a&gt;, one question: did you evaluate Tika&apos;s modified version of ICU&apos;s encoding detector or the original version? And did you call setDeclaredEncoding(...)? Background: ICU&apos;s charset detector does not take the &quot;declared&quot; encoding (from HTTP or HTML metadata) into account - the implementation contradicts the documentation (&lt;a href=&quot;http://icu-project.org/apiref/icu4j/com/ibm/icu/text/CharsetDetector.html#setDeclaredEncoding-java.lang.String-&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;setDeclaredEncoding(...)&lt;/a&gt; vs. &lt;a href=&quot;http://source.icu-project.org/repos/icu/trunk/icu4j/main/classes/core/src/com/ibm/icu/text/CharsetDetector.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CharsetDetector.java&lt;/a&gt;). Tika uses a &lt;a href=&quot;https://github.com/apache/tika/blob/master/tika-parsers/src/main/java/org/apache/tika/parser/txt/CharsetDetector.java#L320&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patched version&lt;/a&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-335&quot; title=&quot;TXTParser should use incoming charset&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-335&quot;&gt;&lt;del&gt;TIKA-335&lt;/del&gt;&lt;/a&gt;) of the ICU detector which boosts the declared encoding if also detected as possible encoding. That&apos;s very important for single-byte encodings, e.g, of the ISO-8859-x family. Also note: Nutch uses the ICU version (and also does not set the declared encoding).&lt;/p&gt;</comment>
                            <comment id="16546162" author="gbouchar" created="Tue, 17 Jul 2018 08:05:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wastl-nagel&quot; class=&quot;user-hover&quot; rel=&quot;wastl-nagel&quot;&gt;wastl-nagel&lt;/a&gt; : I used our internal fork of nutch, with the ICU encoding detector from tika 1.17 (org.apache.tika.parser.txt.Icu4jEncodingDetector). I used tika&apos;s metadata to set the declared charset (Metadata.CONTENT_ENCODING), extracting the charset from the HTTP Content-Type header with the following regex : &lt;em&gt;charset=\s*&quot;?(&lt;span class=&quot;error&quot;&gt;&amp;#91;^\s;&amp;quot;&amp;#93;&lt;/span&gt;*) .&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Our regex is case-sensitive, whereas it should not, according to the spec. But I had to test it that way because this is how our internal crawler worked, and I wanted to compare new results to our current baseline.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;By the way, the HTTP header &lt;em&gt;Content-Encoding&lt;/em&gt; used by&#160;Icu4jEncodingDetector as a character set declaration, is in fact a compression algorithm declaration according to &lt;a href=&quot;https://tools.ietf.org/html/rfc7231#section-3.1.2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the specification&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16546190" author="gbouchar" created="Tue, 17 Jul 2018 08:33:33 +0000"  >&lt;p&gt;If anyone wants to replicate the experiment with a different setting, I cannot provide our version of nutch, but here is &lt;a href=&quot;https://gist.github.com/GerardBouchar/3ef6ff9de8f0f1b06656c0d8275c0757&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the node script I used to fetch pages in chrome&lt;/a&gt; and get the detected charset.&lt;/p&gt;</comment>
                            <comment id="16546231" author="wastl-nagel" created="Tue, 17 Jul 2018 09:16:56 +0000"  >&lt;p&gt;Ok, this should set the declared encoding (after a look into o.a.tika.parser.txt.Icu4jEncodingDetector). &lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-431&quot; title=&quot;Tika currently misuses the HTTP Content-Encoding header, and does not seem to use the charset part of the Content-Type header properly.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-431&quot;&gt;&lt;del&gt;TIKA-431&lt;/del&gt;&lt;/a&gt; deprecates the usage of Metadata.CONTENT_ENCODING to hold the charset. After &lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-974&quot; title=&quot;No longer return charset info in Metadata&amp;#39;s CONTENT_ENCODING&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-974&quot;&gt;TIKA-974&lt;/a&gt; is done one has to parse the charset out from Metadata.CONTENT_TYPE. And thanks for evaluation results, I&apos;ll plan to fetch the URLs again to reproduce the test as I need a reliable charset detection as precondition for language detection.&lt;/p&gt;</comment>
                            <comment id="16568362" author="tallison@mitre.org" created="Fri, 3 Aug 2018 15:37:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gbouchar&quot; class=&quot;user-hover&quot; rel=&quot;gbouchar&quot;&gt;gbouchar&lt;/a&gt;, many, many thanks for this fantastic work!&lt;/p&gt;

&lt;p&gt;I made the decision to remove the FullStandardEncodingDetector and the StandardICU4JEncodingDetector because we try to keep encoding detectors composable.  I was actually wondering if we should pull out the BOM detection into a separate detector, but let&apos;s leave it as is for now.&lt;/p&gt;

&lt;p&gt;Please do check that I got the updates right in both master and branch_1x (which we&apos;ll use for Tika 1.19).&lt;/p&gt;

&lt;p&gt;Again, many, many thanks!&lt;/p&gt;</comment>
                            <comment id="16568398" author="tallison@mitre.org" created="Fri, 3 Aug 2018 15:58:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gbouchar&quot; class=&quot;user-hover&quot; rel=&quot;gbouchar&quot;&gt;gbouchar&lt;/a&gt;, I&apos;m sorry if I missed it in the above, but would you be able to share the urls you used for your study, or...better yet... scp/sftp the files to our regression vm?&lt;/p&gt;</comment>
                            <comment id="16568465" author="hudson" created="Fri, 3 Aug 2018 16:47:21 +0000"  >&lt;p&gt;UNSTABLE: Integrated in Jenkins build tika-2.x-windows #292 (See &lt;a href=&quot;https://builds.apache.org/job/tika-2.x-windows/292/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/tika-2.x-windows/292/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; Fix race condition in CharsetAliases (gbouchar: rev 7d96565e25b3d607b91f9384e9df48b235423d0b)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/CharsetAliases.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; Remove wildcard imports (gbouchar: rev 82a1c61d628e604663b3b73326d44fbf57177af3)&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/charsets/XUserDefinedCharset.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/CharsetDetectionResult.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; PreScanner: use read() instead of skip(long) (gbouchar: rev c27f53b8cb4918b957c782e3c856000f105c6d46)&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/PreScanner.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; Make the read limit in StandardHtmlEncodingDetector (gbouchar: rev e7cda261f6aa2eb0102a8ffb53e454a4f3655bdd)&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/StandardIcu4JEncodingDetector.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/StandardHtmlEncodingDetector.java&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/FullStandardEncodingDetector.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; &amp;#8211; small modifications (tallison: rev f8f5e23841d23cfcaa13bfba6dccf7f44f33fdd5)&lt;/li&gt;
	&lt;li&gt;(delete) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/FullStandardEncodingDetector.java&lt;/li&gt;
	&lt;li&gt;(delete) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/StandardIcu4JEncodingDetector.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/StandardHtmlEncodingDetector.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/PreScanner.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; &amp;#8211; fix forbidden-apis failures (tallison: rev f8a8447550afcff941700375774ad3cb92db4d8b)&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/test/java/org/apache/tika/parser/html/StandardHtmlEncodingDetectorTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16568549" author="hudson" created="Fri, 3 Aug 2018 18:06:07 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Tika-trunk #1536 (See &lt;a href=&quot;https://builds.apache.org/job/Tika-trunk/1536/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Tika-trunk/1536/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; Fix race condition in CharsetAliases (gbouchar: &lt;a href=&quot;https://github.com/apache/tika/commit/7d96565e25b3d607b91f9384e9df48b235423d0b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/7d96565e25b3d607b91f9384e9df48b235423d0b&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/CharsetAliases.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; Remove wildcard imports (gbouchar: &lt;a href=&quot;https://github.com/apache/tika/commit/82a1c61d628e604663b3b73326d44fbf57177af3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/82a1c61d628e604663b3b73326d44fbf57177af3&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/CharsetDetectionResult.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/charsets/XUserDefinedCharset.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; PreScanner: use read() instead of skip(long) (gbouchar: &lt;a href=&quot;https://github.com/apache/tika/commit/c27f53b8cb4918b957c782e3c856000f105c6d46&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/c27f53b8cb4918b957c782e3c856000f105c6d46&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/PreScanner.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; Make the read limit in StandardHtmlEncodingDetector (gbouchar: &lt;a href=&quot;https://github.com/apache/tika/commit/e7cda261f6aa2eb0102a8ffb53e454a4f3655bdd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/e7cda261f6aa2eb0102a8ffb53e454a4f3655bdd&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/FullStandardEncodingDetector.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/StandardIcu4JEncodingDetector.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/StandardHtmlEncodingDetector.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; &amp;#8211; small modifications (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/f8f5e23841d23cfcaa13bfba6dccf7f44f33fdd5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/f8f5e23841d23cfcaa13bfba6dccf7f44f33fdd5&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;(delete) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/FullStandardEncodingDetector.java&lt;/li&gt;
	&lt;li&gt;(delete) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/StandardIcu4JEncodingDetector.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/PreScanner.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/StandardHtmlEncodingDetector.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; &amp;#8211; fix forbidden-apis failures (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/f8a8447550afcff941700375774ad3cb92db4d8b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/f8a8447550afcff941700375774ad3cb92db4d8b&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/test/java/org/apache/tika/parser/html/StandardHtmlEncodingDetectorTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16568567" author="hudson" created="Fri, 3 Aug 2018 18:17:55 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build tika-branch-1x #67 (See &lt;a href=&quot;https://builds.apache.org/job/tika-branch-1x/67/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/tika-branch-1x/67/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; &amp;#8211; add StandardHtmlEncodingDetector via Gerard Bouchar (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/6badaead79e3350414536a5e4972871f66e97e90&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/6badaead79e3350414536a5e4972871f66e97e90&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(delete) tika-parsers/src/main/java/org/apache/tika/parser/html/StrictHtmlEncodingDetector.java&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/charsets/XUserDefinedCharset.java&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/StandardHtmlEncodingDetector.java&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/CharsetDetectionResult.java&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/MetaProcessor.java&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/test/java/org/apache/tika/parser/html/StandardHtmlEncodingDetectorTest.java&lt;/li&gt;
	&lt;li&gt;(delete) tika-parsers/src/test/java/org/apache/tika/parser/html/StrictHtmlEncodingDetectorTest.java&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/CharsetAliases.java&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/PreScanner.java&lt;/li&gt;
	&lt;li&gt;(add) tika-parsers/src/main/java/org/apache/tika/parser/html/charsetdetector/charsets/ReplacementCharset.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2673&quot; title=&quot;HtmlEncodingDetector doesn&amp;#39;t follow the specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2673&quot;&gt;&lt;del&gt;TIKA-2673&lt;/del&gt;&lt;/a&gt; &amp;#8211; fix forbidden-apis failure and retro-fit for branch_1x (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/4475b726db9e81d2daaddc2d74908141540301da&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/4475b726db9e81d2daaddc2d74908141540301da&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/test/java/org/apache/tika/parser/html/StandardHtmlEncodingDetectorTest.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-core/src/test/java/org/apache/tika/mime/MimeDetectionTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16569913" author="gbouchar" created="Mon, 6 Aug 2018 09:02:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tallison%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;tallison@apache.org&quot;&gt;tallison@apache.org&lt;/a&gt;, thank you very much for merging my work !&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;would you be able to share the urls you used for your study?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;See &lt;a href=&quot;#comment-16542763&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;my comment above&lt;/a&gt; for the list of URLs I used, together with the testing methodology, and the code used to analyze the results.  The URL lists are really not big, just a few Mb when compressed. You can &lt;a href=&quot;https://github.com/GerardBouchar/tika/tree/TIKA-2673-benchmark/benchmark&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;download the compressed jsonl data files&lt;/a&gt;, and then extract the URLs using jq, for instance:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;lt; segment_big_icu_charsets.jsonl.xz xz -d | jq -r &lt;span class=&quot;code-quote&quot;&gt;&apos;.url&apos;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;



&lt;blockquote&gt;&lt;p&gt;Please do check that I got the updates right in both master and branch_1x (which we&apos;ll use for Tika 1.19).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Everything looks correct to me. &#128077;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;I made the decision to remove the FullStandardEncodingDetector and the StandardICU4JEncodingDetector because we try to keep encoding detectors composable. I was actually wondering if we should pull out the BOM detection into a separate detector, but let&apos;s leave it as is for now.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;OK. I can make a pull request for a separate encoding detector using only the BOM. But anyway, I think it would be nice and helpful to provide a pre-composed charset detector that includes all the required step. I think most people want an encoding detector that &quot;just works&quot; by default. &lt;/p&gt;</comment>
                            <comment id="16570587" author="tallison@mitre.org" created="Mon, 6 Aug 2018 18:19:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gbouchar&quot; class=&quot;user-hover&quot; rel=&quot;gbouchar&quot;&gt;gbouchar&lt;/a&gt;, On the evaluation, it looks like 3 of the files have the same urls: 105,956, but &lt;tt&gt;segment_big_chrome_charsets.jsonl.xz&lt;/tt&gt; has ~200k...  Should I ignore that one?  Second point on the evaluation, I really like how you classified &quot;correct&quot;, &quot;similar&quot; and &quot;wrong&quot;...this continues to be an ongoing pain, but it is necessary.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think most people want an encoding detector that &quot;just works&quot; by default.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Y, I agree.  My thinking is that if we migrate to the newer detector, we&apos;d specify it correctly in the SPI file as we do now with html-&amp;gt;universal-&amp;gt;icu4j.  That would then be &quot;just works&quot; by default.  Until that point, though, users would have to specify the newer detector, and we can show them that they ought to include icu4j after the newer detector... Let me think about this some more.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I can make a pull request for a separate encoding detector using only the BOM. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I don&apos;t feel strongly about this.  Let&apos;s wait to see if there&apos;s a need.  Thank you!&lt;/p&gt;</comment>
                            <comment id="16571207" author="gbouchar" created="Tue, 7 Aug 2018 07:25:28 +0000"  >&lt;p&gt;Yes, the pages for which fetching failed are not included in the non-chrome files. The analysis is based on the pages that were successfully fetched and parsed with all the strategies. When an error was thrown while fetching in chrome, the charset is marked as &quot;unknown&quot;, but the URL is still included.&lt;/p&gt;

&lt;p&gt;If you want to redo the experiment yourself, I would advise to take the 200k URLs, and then filter only the ones for which fetching and parsing succeeded, and the resulting document was actual HTML.&lt;/p&gt;</comment>
                            <comment id="16573355" author="tallison@mitre.org" created="Wed, 8 Aug 2018 15:16:42 +0000"  >&lt;p&gt;I tried to download the urls with Nutch, and then I &apos;dumped&apos; the crawled data to literal files, but I only have ~32k.  Looks like I failed to configure pkix correctly for https...will try again.&lt;/p&gt;</comment>
                            <comment id="16573406" author="wastl-nagel" created="Wed, 8 Aug 2018 15:46:49 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tallison%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;tallison@apache.org&quot;&gt;tallison@apache.org&lt;/a&gt;, I&apos;m also about to fetch these URLs/pages (30% done right now). I&apos;ll prepare Nutch segments and also WARC files.&lt;/p&gt;</comment>
                            <comment id="16573561" author="tallison@mitre.org" created="Wed, 8 Aug 2018 17:38:35 +0000"  >&lt;p&gt;That&apos;d be great, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wastl-nagel&quot; class=&quot;user-hover&quot; rel=&quot;wastl-nagel&quot;&gt;wastl-nagel&lt;/a&gt;!  My second crawl only pulled in 48329 files.  I trust that you know how to configure Nutch better than I do!&lt;/p&gt;

&lt;p&gt;If you&apos;d be willing to scp the raw &lt;tt&gt;dumped&lt;/tt&gt; files or segments to our vm, I&apos;ll grant you access.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13253918">TIKA-2933</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12928371" name="HtmlEncodingDetectorTest.java" size="3999" author="gbouchar" created="Tue, 19 Jun 2018 15:35:46 +0000"/>
                            <attachment id="12928759" name="StrictHtmlEncodingDetector.tar.gz" size="7985" author="gbouchar" created="Fri, 22 Jun 2018 11:58:14 +0000"/>
                            <attachment id="12931459" name="image-2018-07-13-11-28-16-657.png" size="8950" author="gbouchar" created="Fri, 13 Jul 2018 09:28:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 14 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3v0n3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>