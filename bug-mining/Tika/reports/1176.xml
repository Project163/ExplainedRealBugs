<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:03:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[TIKA-3203] MP4Parser temporary files are not deleted from Tomcat temp folder</title>
                <link>https://issues.apache.org/jira/browse/TIKA-3203</link>
                <project id="12310631" key="TIKA">Tika</project>
                    <description>&lt;p&gt;In our application, Tika is used as part of a Tomcat webapp.  Tomcat sets its temp folder ($CATALINA_HOME/temp) as &quot;java.io.tmpdir&quot;.  The MP4Parser creates files in java.io.tmpdir.  &lt;/p&gt;

&lt;p&gt;The files created by the MP4Parser are never deleted from temp/.  Ex: MediaDataBox10544109451805035303org.mp4parser.boxes.iso14496.part12.MediaDataBox@77cb1ee8&lt;/p&gt;

&lt;p&gt;Oddly, there are no errors in logs.  Nothing about files that cannot be deleted or not found.&lt;/p&gt;

&lt;p&gt;Other processes in our application needs to create other files in temp/, so we can&apos;t simply delete everything in that folder.&lt;/p&gt;

&lt;p&gt;I assume from &lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-1040&quot; title=&quot;Could not delete temporary file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-1040&quot;&gt;&lt;del&gt;TIKA-1040&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-1361&quot; title=&quot;Update MP4Parser to 1.0.2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-1361&quot;&gt;&lt;del&gt;TIKA-1361&lt;/del&gt;&lt;/a&gt;, and &lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-3084&quot; title=&quot;Migrate mp4 parsing to sannies&amp;#39; fork&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-3084&quot;&gt;&lt;del&gt;TIKA-3084&lt;/del&gt;&lt;/a&gt; that most file deletion issues in the MP4Parser have been fixed.  This may be a little gremlin in CentOS or in Tomcat ... ?&lt;/p&gt;

&lt;p&gt;I have tried using TemporaryResources (i.e.: replace the &quot;TikaInputStream.get&quot; in the code below by TikaInputStream.get(InputStream, TemporaryResources)) to put the parser&apos;s temporary files in a folder that we can control, but to no avail.  Tika&apos;s MP4Parser &quot;parse&quot; method initializes a new instance of TemporaryResources, so the TemporaryResources that I created is never used.  The default TemporaryResources would use java.io.tmpdir anyways, right?&lt;/p&gt;

&lt;p&gt;So, why aren&apos;t these files deleted ?&lt;/p&gt;

&lt;p&gt;And, while we are on the subject, there should be a way to set a temporary files folder that parsers actually use (and the parser&apos;s dependencies).  How can a user-defined TemporaryResources be useful if the parser ignores it ?&lt;/p&gt;


&lt;p&gt;Relevant code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Parser parser = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AutoDetectParser(); &lt;span class=&quot;code-comment&quot;&gt;// injected by Spring
&lt;/span&gt;
Path input = ...; &lt;span class=&quot;code-comment&quot;&gt;// some mp4 audio file
&lt;/span&gt;Path output = ...;

&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Metadata metadata = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Metadata();

&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;(InputStream stream = TikaInputStream.get(input, metadata);
    OutputStream outputstream = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileOutputStream(output.toFile());
    OutputStreamWriter outputStreamWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OutputStreamWriter(outputstream, &lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;)){

	ParseContext parseContext = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ParseContext();
	
	parser.parse(stream, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BodyContentHandler(outputStreamWriter), metadata, parseContext);
	
	&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; something with the metadata and the output
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that I also tried to set java.io.tmpdir to another folder, programmatically.  That had no effect either.  Since the application needs to use Tomcat&apos;s temp folder for other processing, setting java.io.tmpdir on the command line is not an option.&lt;/p&gt;</description>
                <environment>&lt;p&gt;CentOS 7.8&lt;br/&gt;
Tomcat webapp&lt;br/&gt;
OpenJDK JRE 11.0.5&lt;/p&gt;</environment>
        <key id="13328873">TIKA-3203</key>
            <summary>MP4Parser temporary files are not deleted from Tomcat temp folder</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="igiguere">Isabelle Giguere</reporter>
                        <labels>
                    </labels>
                <created>Tue, 22 Sep 2020 21:33:27 +0000</created>
                <updated>Mon, 7 Dec 2020 23:21:53 +0000</updated>
                            <resolved>Fri, 9 Oct 2020 20:21:32 +0000</resolved>
                                    <version>1.24.1</version>
                                    <fixVersion>1.25</fixVersion>
                                    <component>parser</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17209786" author="tallison@mitre.org" created="Wed, 7 Oct 2020 19:10:48 +0000"  >&lt;p&gt;I&apos;m running through a debugger now, and it isn&apos;t looking like we&apos;re creating a tmp file per box type at the Tika level.&lt;/p&gt;

&lt;p&gt;I understand that it is frustrating that the MP4Parser doesn&apos;t use an existing TikaInputStream if you pass one in with your custom TemporaryResources...that is an easy fix.  I also understand that for your use case relying on &lt;tt&gt;java.io.tmpdir&lt;/tt&gt; is a non-starter.&lt;/p&gt;

&lt;p&gt;Let me look some more at the underlying mp4parser...&lt;/p&gt;</comment>
                            <comment id="17209804" author="tallison@mitre.org" created="Wed, 7 Oct 2020 19:28:54 +0000"  >&lt;p&gt;K.  The problem seems to be in the underlying mp4parser: &lt;a href=&quot;https://github.com/tballison/mp4parser/blob/master/isoparser/src/main/java/org/mp4parser/boxes/iso14496/part12/MediaDataBox.java#L82&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tballison/mp4parser/blob/master/isoparser/src/main/java/org/mp4parser/boxes/iso14496/part12/MediaDataBox.java#L82&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;// make sure to clean up temp file
        dataFile.deleteOnExit();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That looks like a disaster for long running processes.  Mercifully, I see only one &lt;tt&gt;deleteOnExit&lt;/tt&gt; in the mp4parser&apos;s codebase...so I &lt;em&gt;think&lt;/em&gt; this is fixable upstream (or near term in my fork), but it will take some work.&lt;/p&gt;
</comment>
                            <comment id="17211209" author="tallison@mitre.org" created="Fri, 9 Oct 2020 17:14:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/sannies/mp4parser/issues/426&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/sannies/mp4parser/issues/426&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17211350" author="tallison@mitre.org" created="Fri, 9 Oct 2020 20:21:32 +0000"  >&lt;p&gt;I released a fix of my fork of isoparser, and updated the version in Tika.  This should solve the problem.&lt;/p&gt;</comment>
                            <comment id="17211424" author="hudson" created="Fri, 9 Oct 2020 21:32:16 +0000"  >&lt;p&gt;UNSTABLE: Integrated in Jenkins build Tika &#187; tika-branch1x-jdk8 #21 (See &lt;a href=&quot;https://ci-builds.apache.org/job/Tika/job/tika-branch1x-jdk8/21/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Tika/job/tika-branch1x-jdk8/21/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-3203&quot; title=&quot;MP4Parser temporary files are not deleted from Tomcat temp folder&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-3203&quot;&gt;&lt;del&gt;TIKA-3203&lt;/del&gt;&lt;/a&gt; &amp;#8211; fix and release fork of mp4parser...then upgrade in Tika &amp;#8211; attempt to delete the tmp file when finished with the ISOFile instead of waiting for deleteOnExit. (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/cb3e65978409f364506380b3daea5042e4d88656&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/cb3e65978409f364506380b3daea5042e4d88656&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/mp4/MP4Parser.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/pom.xml&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17211425" author="hudson" created="Fri, 9 Oct 2020 21:32:47 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Tika &#187; tika-main-jdk8 #33 (See &lt;a href=&quot;https://ci-builds.apache.org/job/Tika/job/tika-main-jdk8/33/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Tika/job/tika-main-jdk8/33/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-3203&quot; title=&quot;MP4Parser temporary files are not deleted from Tomcat temp folder&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-3203&quot;&gt;&lt;del&gt;TIKA-3203&lt;/del&gt;&lt;/a&gt; &amp;#8211; fix and release fork of mp4parser...then upgrade in Tika &amp;#8211; attempt to delete the tmp file when finished with the ISOFile instead of waiting for deleteOnExit. (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/d2449f9f9302a1479b067f408ee067aad221e45e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/d2449f9f9302a1479b067f408ee067aad221e45e&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-parent/pom.xml&lt;/li&gt;
	&lt;li&gt;(edit) tika-parser-modules/tika-parser-audiovideo-module/src/main/java/org/apache/tika/parser/mp4/MP4Parser.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17211457" author="igiguere" created="Fri, 9 Oct 2020 23:04:27 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tallison&quot; class=&quot;user-hover&quot; rel=&quot;tallison&quot;&gt;tallison&lt;/a&gt; for looking into this.&lt;/p&gt;

&lt;p&gt;I&apos;m looking forward to using you fix.&lt;/p&gt;</comment>
                            <comment id="17245572" author="igiguere" created="Mon, 7 Dec 2020 23:21:53 +0000"  >&lt;p&gt;I upgraded Tika to 1.25 in our application, and deleted the ugly workaround from our code.  I can confirm the fix works.  Thank you.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 48 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0itrc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>