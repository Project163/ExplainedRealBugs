<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:01:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[TIKA-2384] Double close of InputStream in accept text/plain in tika-server</title>
                <link>https://issues.apache.org/jira/browse/TIKA-2384</link>
                <project id="12310631" key="TIKA">Tika</project>
                    <description>&lt;p&gt;As reported by Haris Osmanagic on the user list, TikaResource closes the InputStream twice on requests for text/plain.  &lt;/p&gt;</description>
                <environment></environment>
        <key id="13076843">TIKA-2384</key>
            <summary>Double close of InputStream in accept text/plain in tika-server</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="tallison">Tim Allison</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Jun 2017 13:16:47 +0000</created>
                <updated>Mon, 3 Jul 2017 16:13:55 +0000</updated>
                            <resolved>Mon, 5 Jun 2017 18:28:30 +0000</resolved>
                                    <version>1.15</version>
                                    <fixVersion>1.16</fixVersion>
                                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16034669" author="tallison@mitre.org" created="Fri, 2 Jun 2017 13:19:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;Haris is correct. The static &quot;parse()&quot; closes the InputStream so we shouldn&apos;t wrap the call to parse in an autoclose try(InputStream is = xyz) { TikaResource.parse(...) } Once I remove the autoclosing try, the test passes.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="16034673" author="tallison@mitre.org" created="Fri, 2 Jun 2017 13:22:00 +0000"  >&lt;p&gt;From &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lfcnassif&quot; class=&quot;user-hover&quot; rel=&quot;lfcnassif&quot;&gt;lfcnassif&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I think resources should be closed where they are opened, like parser.parse() API contract, no?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree.  However, we&apos;re wrapping the InputStream in a TikaInputStream within &lt;tt&gt;TikaResourse.parse()&lt;/tt&gt;.&lt;br/&gt;
We want to make absolutely sure to close TikaInputStream in case it has created temp files, etc.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        
    public static void parse(Parser parser, Logger logger, String path, InputStream inputStream,
                             ContentHandler handler, Metadata metadata, ParseContext parseContext) throws TikaServerParseException {
        try (TikaInputStream tikaInputStream = TikaInputStream.get(inputStream)) {
            parser.parse(tikaInputStream, handler, metadata, parseContext);
        } catch (SAXException e) {
            throw new TikaServerParseException(e);
        } catch (EncryptedDocumentException e) {
            logger.warn(&quot;{}: Encrypted document&quot;, path, e);
            throw new TikaServerParseException(e);
        } catch (Exception e) {
            logger.warn(&quot;{}: Text extraction failed&quot;, path, e);
            throw new TikaServerParseException(e);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16034796" author="tallison@mitre.org" created="Fri, 2 Jun 2017 14:39:50 +0000"  >&lt;p&gt;This is actually caused by a subtle bug in the DigestingParser.  If we wrap the InputStream in a TikaInputStream in the DigestingParser (instead of in CommonsDigester), everything works.  &lt;/p&gt;

&lt;p&gt;The problem is that while CommonsDigester resets its TikaInputStream, it cannot reset the wrapped InputStream.&lt;/p&gt;

&lt;p&gt;Once we fix DigestingParser, we won&apos;t have to wrap the underlying stream in a TikaInputStream or close the underlying stream...because, theoretically, cxf will do that...is that right &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sergey_beryozkin&quot; class=&quot;user-hover&quot; rel=&quot;sergey_beryozkin&quot;&gt;sergey_beryozkin&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16034859" author="sergey_beryozkin" created="Fri, 2 Jun 2017 15:23:38 +0000"  >&lt;p&gt;Hi Tim, CXF will only auto-close InputStream if its task is to copy InputStream (or it can avoid doing it if configured as such), which can only happen if InputStream is returned as a service method response (directly or as JAX-RS Response entity) &lt;/p&gt;</comment>
                            <comment id="16034881" author="tallison@mitre.org" created="Fri, 2 Jun 2017 15:30:37 +0000"  >&lt;p&gt;Ah, ok.  Thank you.  Should we go back to closing it in TikaResourse.parse() then?&lt;/p&gt;</comment>
                            <comment id="16034884" author="hudson" created="Fri, 2 Jun 2017 15:31:52 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build Tika-trunk #1284 (See &lt;a href=&quot;https://builds.apache.org/job/Tika-trunk/1284/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Tika-trunk/1284/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2384&quot; title=&quot;Double close of InputStream in accept text/plain in tika-server&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2384&quot;&gt;&lt;del&gt;TIKA-2384&lt;/del&gt;&lt;/a&gt; - TikaResource can close an InputStream twice; this revealed a (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/6d710da272285e04d6632b501e0752d020063182&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/6d710da272285e04d6632b501e0752d020063182&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-server/src/test/java/org/apache/tika/server/TikaResourceTest.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/utils/CommonsDigester.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-server/src/main/java/org/apache/tika/server/resource/TikaResource.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-core/src/main/java/org/apache/tika/parser/DigestingParser.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/test/java/org/apache/tika/parser/DigestingParserTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16034923" author="sergey_beryozkin" created="Fri, 2 Jun 2017 15:57:13 +0000"  >&lt;p&gt;Not sure - may be they can be closed in TikaResource&apos;s StreamingOutput implementation ?&lt;/p&gt;</comment>
                            <comment id="16035075" author="lfcnassif" created="Fri, 2 Jun 2017 17:22:04 +0000"  >&lt;p&gt;To clean temp files we can use&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;TemporaryResources tmp = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TemporaryResources();
Try{
    TikaInputStream.get(inputstream, tmp);
   .... 
}&lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
    tmp.close();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16037376" author="hudson" created="Mon, 5 Jun 2017 18:47:46 +0000"  >&lt;p&gt;FAILURE: Integrated in Jenkins build Tika-trunk #1285 (See &lt;a href=&quot;https://builds.apache.org/job/Tika-trunk/1285/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Tika-trunk/1285/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2384&quot; title=&quot;Double close of InputStream in accept text/plain in tika-server&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2384&quot;&gt;&lt;del&gt;TIKA-2384&lt;/del&gt;&lt;/a&gt; &amp;#8211; went too far in earlier commit.  We should close the (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/f74b089162820b0e80a8217b505164edb1531ef0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/f74b089162820b0e80a8217b505164edb1531ef0&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-server/src/main/java/org/apache/tika/server/resource/TikaResource.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-2384&quot; title=&quot;Double close of InputStream in accept text/plain in tika-server&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-2384&quot;&gt;&lt;del&gt;TIKA-2384&lt;/del&gt;&lt;/a&gt; &amp;#8211; update changes to reflect fix. (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/933ae1c6482312ec87b15d690b4ac3fe71833554&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/933ae1c6482312ec87b15d690b4ac3fe71833554&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;(edit) CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 23 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ft33:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>