<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:05:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[TIKA-4393] Thread-safety issue in TikaToXMP.getConverterMap()</title>
                <link>https://issues.apache.org/jira/browse/TIKA-4393</link>
                <project id="12310631" key="TIKA">Tika</project>
                    <description>&lt;h2&gt;&lt;a name=&quot;Description%3A&quot;&gt;&lt;/a&gt;Description:&lt;/h2&gt;


&lt;p&gt;We execute TikaToXmp conversion in a multithreaded environment where we call multiple conversion at the same time. According to new parser contribution guide, there is nothing about thread-safety. During our test, a thread-safety issue has been found in the getConverterMap() method of the TikaToXMP class in the tika-xmp module.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We are currently using the 2.9.3 version. We checked in the latest version and we think the behavior is the same.&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Problem%3A&quot;&gt;&lt;/a&gt;Problem:&lt;/h2&gt;


&lt;p&gt;The method manipulates the static class variable converterMap, but it is not thread-safe. Since there is no synchronization mechanism, multiple threads can enter getConverterMap() at the same time and create different instances of converterMap, leading to potential race conditions.&lt;br/&gt;
Current code:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Map&amp;lt;MediaType, &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; ITikaToXMPConverter&amp;gt;&amp;gt; converterMap;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Map&amp;lt;MediaType, &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; ITikaToXMPConverter&amp;gt;&amp;gt; getConverterMap() {
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (converterMap == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&#160; &#160; &#160; &#160; converterMap = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();
&#160; &#160; &#160; &#160; initialize();
&#160; &#160; }
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; converterMap;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If multiple threads call getConverterMap() simultaneously when converterMap is still null, they might create multiple instances of converterMap, which can lead to unexpected behavior.&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;&quot;&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Potential solution:&lt;/p&gt;


&lt;p&gt;To ensure thread safety, we offer a simple patch : to synchronize getConverterMap() so that only one thread can initialize converterMap at a time. The fix consists of adding the &lt;b&gt;synchronized&lt;/b&gt; keyword to the method:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; Map&amp;lt;MediaType, &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; ITikaToXMPConverter&amp;gt;&amp;gt; getConverterMap() {
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (converterMap == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&#160; &#160; &#160; &#160; converterMap = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();
&#160; &#160; &#160; &#160; initialize();
&#160; &#160; }
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; converterMap;
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;java 8, fedora 3.9, tika 2.9.3&lt;/p&gt;</environment>
        <key id="13611587">TIKA-4393</key>
            <summary>Thread-safety issue in TikaToXMP.getConverterMap()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ghiles">Ghiles OUAREZKI</reporter>
                        <labels>
                    </labels>
                <created>Wed, 12 Mar 2025 14:00:27 +0000</created>
                <updated>Thu, 8 May 2025 13:59:31 +0000</updated>
                            <resolved>Thu, 13 Mar 2025 18:23:28 +0000</resolved>
                                    <version>2.9.3</version>
                    <version>3.1.0</version>
                                    <fixVersion>4.0.0</fixVersion>
                    <fixVersion>2.9.4</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                                    <component>tika-app</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17935136" author="tallison@mitre.org" created="Thu, 13 Mar 2025 10:37:05 +0000"  >&lt;p&gt;Thank you for opening this issue. I haven&apos;t worked much in this area of the codebase. &lt;del&gt;On a quick review, it looks like even with a synchronized method, the underlying map&apos;s contents would not be threadsafe &amp;#8211; AbstractConverter maintains and modifies instance data. For example, in MSOfficeXMLConverter, the call to &lt;tt&gt;process(...)&lt;/tt&gt; calls &lt;tt&gt;super.setMetadata(metadata)&lt;/tt&gt;.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;&lt;del&gt;It looks like we need to create new converters for each call to convert or use threadlocal, which I really want to avoid.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;Wait, no, I&apos;m wrong. The new classes are constructed per instance in getConverter(). The Map stores the mimeType and the classes for the converters NOT instances for the converter.&lt;/p&gt;

&lt;p&gt;So, y, the &lt;tt&gt;synchronized&lt;/tt&gt; keyword should work.&lt;/p&gt;

&lt;p&gt;We should add multithreaded tests on the same document type to confirm my above suspicions from the code review.&lt;/p&gt;

&lt;p&gt;WDYT?&lt;/p&gt;</comment>
                            <comment id="17935137" author="tallison@mitre.org" created="Thu, 13 Mar 2025 10:43:30 +0000"  >&lt;p&gt;Static initialization should also work, no? Then we wouldn&apos;t even need to synchronize...&lt;/p&gt;</comment>
                            <comment id="17935193" author="JIRAUSER308944" created="Thu, 13 Mar 2025 13:13:42 +0000"  >&lt;p&gt;Either way it works. It is maybe a slightly better way to solve the problem, by adding static initialization instead of adding some threading keywords in the current code.&lt;/p&gt;</comment>
                            <comment id="17935269" author="githubbot" created="Thu, 13 Mar 2025 16:30:37 +0000"  >&lt;p&gt;tballison opened a new pull request, #2163:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/tika/pull/2163&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/pull/2163&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   &amp;lt;!--&lt;br/&gt;
     Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
     or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
     distributed with this work for additional information&lt;br/&gt;
     regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
     to you under the Apache License, Version 2.0 (the&lt;br/&gt;
     &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
     with the License.  You may obtain a copy of the License at&lt;/p&gt;

&lt;p&gt;       &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;     Unless required by applicable law or agreed to in writing,&lt;br/&gt;
     software distributed under the License is distributed on an&lt;br/&gt;
     &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY&lt;br/&gt;
     KIND, either express or implied.  See the License for the&lt;br/&gt;
     specific language governing permissions and limitations&lt;br/&gt;
     under the License.&lt;br/&gt;
   --&amp;gt;&lt;/p&gt;

&lt;p&gt;   Thanks for your contribution to &lt;span class=&quot;error&quot;&gt;&amp;#91;Apache Tika&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://tika.apache.org/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://tika.apache.org/&lt;/a&gt;)! Your help is appreciated!&lt;/p&gt;

&lt;p&gt;   Before opening the pull request, please verify that&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;there is an open issue on the &lt;span class=&quot;error&quot;&gt;&amp;#91;Tika issue tracker&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://issues.apache.org/jira/projects/TIKA&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/projects/TIKA&lt;/a&gt;) which describes the problem or the improvement. We cannot accept pull requests without an issue because the change wouldn&apos;t be listed in the release notes.&lt;/li&gt;
	&lt;li&gt;the issue ID (`TIKA-XXXX`)&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;is referenced in the title of the pull request&lt;/li&gt;
	&lt;li&gt;and placed in front of your commit messages surrounded by square brackets (`&lt;span class=&quot;error&quot;&gt;&amp;#91;TIKA-XXXX&amp;#93;&lt;/span&gt; Issue or pull request title`)&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
	&lt;li&gt;commits are squashed into a single one (or few commits for larger changes)&lt;/li&gt;
	&lt;li&gt;Tika is successfully built and unit tests pass by running `mvn clean test`&lt;/li&gt;
	&lt;li&gt;there should be no conflicts when merging the pull request branch into the &lt;b&gt;recent&lt;/b&gt; `main` branch. If there are conflicts, please try to rebase the pull request branch on top of a freshly pulled `main` branch&lt;/li&gt;
	&lt;li&gt;if you add new module that downstream users will depend upon add it to relevant group in `tika-bom/pom.xml`.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   We will be able to faster integrate your pull request if these conditions are met. If you have any questions how to fix your problem or about using Tika in general, please sign up for the &lt;span class=&quot;error&quot;&gt;&amp;#91;Tika mailing list&amp;#93;&lt;/span&gt;(&lt;a href=&quot;http://tika.apache.org/mail-lists.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://tika.apache.org/mail-lists.html&lt;/a&gt;). Thanks!&lt;/p&gt;


</comment>
                            <comment id="17935310" author="githubbot" created="Thu, 13 Mar 2025 18:20:06 +0000"  >&lt;p&gt;tballison merged PR #2163:&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/tika/pull/2163&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/pull/2163&lt;/a&gt;&lt;/p&gt;

</comment>
                            <comment id="17935331" author="hudson" created="Thu, 13 Mar 2025 19:16:27 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Tika &#187; tika-main-jdk17 #659 (See &lt;a href=&quot;https://ci-builds.apache.org/job/Tika/job/tika-main-jdk17/659/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Tika/job/tika-main-jdk17/659/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-4393&quot; title=&quot;Thread-safety issue in TikaToXMP.getConverterMap()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-4393&quot;&gt;&lt;del&gt;TIKA-4393&lt;/del&gt;&lt;/a&gt; (#2163) (github: &lt;a href=&quot;https://github.com/apache/tika/commit/933fae954da025f62d147b367c1a16494e883925&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/933fae954da025f62d147b367c1a16494e883925&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-xmp/src/main/java/org/apache/tika/xmp/convert/TikaToXMP.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-xmp/src/test/java/org/apache/tika/xmp/TikaToXMPTest.java&lt;/li&gt;
	&lt;li&gt;(edit) CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17935350" author="hudson" created="Thu, 13 Mar 2025 20:21:40 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Tika &#187; tika-branch_2x-jdk11 #621 (See &lt;a href=&quot;https://ci-builds.apache.org/job/Tika/job/tika-branch_2x-jdk11/621/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Tika/job/tika-branch_2x-jdk11/621/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-4393&quot; title=&quot;Thread-safety issue in TikaToXMP.getConverterMap()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-4393&quot;&gt;&lt;del&gt;TIKA-4393&lt;/del&gt;&lt;/a&gt; (#2163) (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/3d04698114a75b56ce2b1ee6546bbb75e0ab813c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/3d04698114a75b56ce2b1ee6546bbb75e0ab813c&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-xmp/src/test/java/org/apache/tika/xmp/TikaToXMPTest.java&lt;/li&gt;
	&lt;li&gt;(edit) CHANGES.txt&lt;/li&gt;
	&lt;li&gt;(edit) tika-xmp/src/main/java/org/apache/tika/xmp/convert/TikaToXMP.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-4393&quot; title=&quot;Thread-safety issue in TikaToXMP.getConverterMap()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-4393&quot;&gt;&lt;del&gt;TIKA-4393&lt;/del&gt;&lt;/a&gt; (#2163) &amp;#8211; checkstyle (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/10653fb3810cf4ce403400d9c313eb6ef1ca7449&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/10653fb3810cf4ce403400d9c313eb6ef1ca7449&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;(edit) tika-xmp/src/test/java/org/apache/tika/xmp/TikaToXMPTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17935351" author="hudson" created="Thu, 13 Mar 2025 20:55:40 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Tika &#187; tika-branch_3x-jdk11 #1993 (See &lt;a href=&quot;https://ci-builds.apache.org/job/Tika/job/tika-branch_3x-jdk11/1993/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Tika/job/tika-branch_3x-jdk11/1993/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-4393&quot; title=&quot;Thread-safety issue in TikaToXMP.getConverterMap()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-4393&quot;&gt;&lt;del&gt;TIKA-4393&lt;/del&gt;&lt;/a&gt; (#2163) (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/dc44d8dd401c176b49274570de9c433c16bd616f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/dc44d8dd401c176b49274570de9c433c16bd616f&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-xmp/src/test/java/org/apache/tika/xmp/TikaToXMPTest.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-xmp/src/main/java/org/apache/tika/xmp/convert/TikaToXMP.java&lt;/li&gt;
	&lt;li&gt;(edit) CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>Java</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            34 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1uqf4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>