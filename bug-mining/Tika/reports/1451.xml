<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:05:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[TIKA-4363] Duplicate text when OCR and extractMarkedContent (PDFParserConfig) enabled</title>
                <link>https://issues.apache.org/jira/browse/TIKA-4363</link>
                <project id="12310631" key="TIKA">Tika</project>
                    <description>&lt;p&gt;Extracting a marked PDF while OCR (Tesseract) and extractMarkedContent is enabled and the ocrStrategy is defaulting to &quot;auto&quot; within the PDFParser is causing duplicate text extraction.&lt;/p&gt;

&lt;p&gt;Attached are example of the configuration and marked PDF file that can reproduce the issue with the following test:&#160;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;@Test&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;public void testPDFDuplicate() throws Exception {&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; String tikaConfigFileName = &quot;/test-documents/tika-conf-override.xml&quot;;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; TikaConfig tikaConfig = new TikaConfig(getClass().getResourceAsStream(tikaConfigFileName));&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; Tika tika = new Tika(tikaConfig);&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; String issueFile = &quot;/test-documents/MarkedPdfDuplicateTextWithTesseract.pdf&quot;;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; URL resource = getClass().getResource(issueFile);&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; assert resource != null;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; try (InputStream issueStream = resource.openStream()) {&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; String issueContent = tika.parseToString(issueStream);&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; System.out.println(issueContent);&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; assertTrue(issueContent.contains(&quot;aabb6ba1-34ab-4af2&quot;));&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; assertEquals(1, StringUtils.countMatches(issueContent, &quot;aabb6ba1-34ab-4af2&quot;), &quot;Does not contain the expected number of occurrences&quot;);&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;}&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;PDFParser.java:214&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This is where it checks for the extractMarkedContent flag and will go into the PDFMarkedContent2XHTML class.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;AbstractPDF2XHTML.java:791 - 806&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;In this code, the totalCharsPerPage was never updated by the PDFMarkedContent2XHTML and therefore matches the conditions to perform OCR on the PDF even though text has been extracted.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;One thing to note, if we turn off extractMarkedContent, then it goes into PDF2XHTML on PDFParser.java:219 and the variable totalCharsPerPage gets updated properly.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13601711">TIKA-4363</key>
            <summary>Duplicate text when OCR and extractMarkedContent (PDFParserConfig) enabled</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="tallison">Tim Allison</assignee>
                                    <reporter username="apismensky">Alexey Pismenskiy</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Dec 2024 16:37:59 +0000</created>
                <updated>Wed, 15 Jan 2025 13:49:36 +0000</updated>
                                            <version>2.9.2</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17905503" author="tallison@mitre.org" created="Fri, 13 Dec 2024 14:24:46 +0000"  >&lt;p&gt;Thank you for opening this and explaining the problem in detail.&lt;/p&gt;

&lt;p&gt;As I look at PDFMarkedContent2XHTML, I&apos;m reminded that that handler builds the text from the structure tree root. &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        //TODO: figure out when we&apos;re crossing page boundaries during the recursion
        // step above and do the page by page processing then...rather than dumping this
        // all here.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The current code does not calculate which content from the structure tree root appears on which page. In short, it currently has no way of knowing how many &lt;tt&gt;totalCharsPerPage&lt;/tt&gt; there are.&lt;/p&gt;

&lt;p&gt;The right solution is to do the &lt;tt&gt;TODO&lt;/tt&gt;. Maybe we could do a minimal effort algorithm of keeping a tally of &quot;totalCharsPerPage&quot; based on the currentPageRef??? &lt;/p&gt;

&lt;p&gt;Short of that, maybe turn off ocr if the codepath goes through PDFMarkedContent2XHTML#processPages()?&lt;/p&gt;
</comment>
                            <comment id="17905506" author="tallison@mitre.org" created="Fri, 13 Dec 2024 14:32:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tilman&quot; class=&quot;user-hover&quot; rel=&quot;tilman&quot;&gt;tilman&lt;/a&gt;, is there an easy way to figure out which page number we&apos;re on at this line?&lt;/p&gt;

&lt;p&gt;The knuckle dragging method would call getPages() before processing the marked content and then do a lookup in that array to see if they object ref is in that list???&lt;/p&gt;


&lt;p&gt;&lt;a href=&quot;https://github.com/apache/tika/blob/main/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-pdf-module/src/main/java/org/apache/tika/parser/pdf/PDFMarkedContent2XHTML.java#L302&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/blob/main/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-pdf-module/src/main/java/org/apache/tika/parser/pdf/PDFMarkedContent2XHTML.java#L302&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17905507" author="tilman" created="Fri, 13 Dec 2024 14:41:05 +0000"  >&lt;p&gt;getCurrentPageNo()&lt;/p&gt;</comment>
                            <comment id="17913073" author="JIRAUSER299016" created="Tue, 14 Jan 2025 21:18:18 +0000"  >&lt;p&gt;The getCurrentPageNo() relies on the pageIndex variable that only gets updated inside the processPages() method. In 2.9.2, pageIndex lives inside the AbstractPDF2XHTML class and is only updated inside the processPages() of that class. The issue is that the PDFMarkedContent2XHTML overrides processPages() and does not update pageIndex. I think doing something with the page refs makes sense.&lt;/p&gt;</comment>
                            <comment id="17913168" author="tilman" created="Wed, 15 Jan 2025 05:33:27 +0000"  >&lt;p&gt;Maybe I misunderstood the question last year... here&apos;s an answer to what you may or may not have meant:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
COSBase object = ((COSObject) pageBase).getObject();
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (object &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; COSDictionary) {
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; index = pdDocument.getPages().indexOf(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PDPage((COSDictionary) object)) + 1;
    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;page: &quot;&lt;/span&gt; + index);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;To speed things up (getPages() can be slow) you could pass the pageTree in &quot;recurse&quot;.&lt;/p&gt;

&lt;p&gt;Also I don&apos;t understand why currentPageRef is used with a new type ObjectRef instead of just using COSObject or COSBase to have a unique key for MCID. (I made a TODO comment about that)&lt;/p&gt;</comment>
                            <comment id="17913307" author="hudson" created="Wed, 15 Jan 2025 13:08:41 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Tika &#187; tika-branch_2x-jdk11 #585 (See &lt;a href=&quot;https://ci-builds.apache.org/job/Tika/job/tika-branch_2x-jdk11/585/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Tika/job/tika-branch_2x-jdk11/585/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-4363&quot; title=&quot;Duplicate text when OCR and extractMarkedContent (PDFParserConfig) enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-4363&quot;&gt;TIKA-4363&lt;/a&gt;: refactor (tilman: &lt;a href=&quot;https://github.com/apache/tika/commit/636f57b40ad610f5dfbc8dce203a0b251ccff56d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/636f57b40ad610f5dfbc8dce203a0b251ccff56d&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-pdf-module/src/main/java/org/apache/tika/parser/pdf/PDFMarkedContent2XHTML.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17913312" author="hudson" created="Wed, 15 Jan 2025 13:30:03 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Tika &#187; tika-main-jdk17 #603 (See &lt;a href=&quot;https://ci-builds.apache.org/job/Tika/job/tika-main-jdk17/603/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Tika/job/tika-main-jdk17/603/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-4363&quot; title=&quot;Duplicate text when OCR and extractMarkedContent (PDFParserConfig) enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-4363&quot;&gt;TIKA-4363&lt;/a&gt;: refactor (tilman: &lt;a href=&quot;https://github.com/apache/tika/commit/657e75b53b82b03d5e296c23687f2e913e0ba4ac&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/657e75b53b82b03d5e296c23687f2e913e0ba4ac&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-pdf-module/src/main/java/org/apache/tika/parser/pdf/PDFMarkedContent2XHTML.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17913320" author="hudson" created="Wed, 15 Jan 2025 13:49:36 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Tika &#187; tika-branch_3x-jdk11 #1944 (See &lt;a href=&quot;https://ci-builds.apache.org/job/Tika/job/tika-branch_3x-jdk11/1944/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Tika/job/tika-branch_3x-jdk11/1944/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-4363&quot; title=&quot;Duplicate text when OCR and extractMarkedContent (PDFParserConfig) enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-4363&quot;&gt;TIKA-4363&lt;/a&gt;: refactor (tilman: &lt;a href=&quot;https://github.com/apache/tika/commit/939eff71140043446d48ad58c16e09e4291c89b0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/939eff71140043446d48ad58c16e09e4291c89b0&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-pdf-module/src/main/java/org/apache/tika/parser/pdf/PDFMarkedContent2XHTML.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="13073396" name="MarkedPdfDuplicateTextWithTesseract.pdf" size="34436" author="apismensky" created="Wed, 11 Dec 2024 16:34:58 +0000"/>
                            <attachment id="13073397" name="tika-conf-override.xml" size="435" author="apismensky" created="Wed, 11 Dec 2024 16:34:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            42 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1t1zk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>