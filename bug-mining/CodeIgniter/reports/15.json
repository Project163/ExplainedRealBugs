{"url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/154","repository_url":"https://api.github.com/repos/bcit-ci/CodeIgniter","labels_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/154/labels{/name}","comments_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/154/comments","events_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/154/events","html_url":"https://github.com/bcit-ci/CodeIgniter/issues/154","id":1442381,"node_id":"MDU6SXNzdWUxNDQyMzgx","number":154,"title":"Rapid requests during session updates trigger unexpected session destruction","user":{"login":"bitbucket-import","id":991171,"node_id":"MDQ6VXNlcjk5MTE3MQ==","avatar_url":"https://avatars.githubusercontent.com/u/991171?v=4","gravatar_id":"","url":"https://api.github.com/users/bitbucket-import","html_url":"https://github.com/bitbucket-import","followers_url":"https://api.github.com/users/bitbucket-import/followers","following_url":"https://api.github.com/users/bitbucket-import/following{/other_user}","gists_url":"https://api.github.com/users/bitbucket-import/gists{/gist_id}","starred_url":"https://api.github.com/users/bitbucket-import/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bitbucket-import/subscriptions","organizations_url":"https://api.github.com/users/bitbucket-import/orgs","repos_url":"https://api.github.com/users/bitbucket-import/repos","events_url":"https://api.github.com/users/bitbucket-import/events{/privacy}","received_events_url":"https://api.github.com/users/bitbucket-import/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":45,"created_at":"2011-08-19T14:49:35Z","updated_at":"2021-08-16T23:35:10Z","closed_at":"2012-02-02T17:45:34Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"=== Issue ===\nWhen using the sessions library and the following conditions exist:\n- $config['sess_use_database'] = true;\n- The period specified in $config['sess_time_to_update'] has expired\n\nIt is possible to inadvertently trigger destruction of the session by performing two requests at the same time.  An example of a scenario that easily triggers this error is a page which initiates two or more AJAX requests at the same time.\n\n=== Expected Behavior ===\nThe CodeIgniter sessions library should not inadvertantly destroy sessions.\n\n=== Cause of Issue ===\nThis is what I believe to be occurring.\n\nTwo requests are made at the same time, causing them to submit the same cookie data.\n\nWhen the server receives the request, the session library looks for the session matching the ID submitted on the cookie. (Session.php:192)\n\nThe first request finds the session record and updates it since sess_time_to_update has expired. (Session.php:377)\n\nThe second request still has the old session id, and fails to find the newly updated database record.  This then triggers a sess_destroy. (Session.php:212)\n\n=== To Replicate ===\n\nIn config.php:\n{{{\n// Reduce the amount of time we have to wait to see the bug to 5 seconds.\n$config['sess_time_to_update']  = 5;\n}}}\n\nCreate controller session_error_demo.php:\n{{{\n<?php\nclass Session_error_demo extends Controller {\n    function initialize () {\n        $this->session->set_userdata('session_alive', 'Hi world!');\n        echo 'Session initialized.';\n    }\n\n```\nfunction test() {\n    if ($this->session->userdata('session_alive')) {\n        echo 'Session is alive.';\n    } else {\n        echo 'Session is dead.';\n    }\n}\n\nfunction reset() {\n    $this->session->sess_destroy();\n    echo 'Session reset.';\n}\n```\n\n}\n?>\n}}}\n\nPerform the following tasks:\n# Call reset() to ensure we start on a clean slate.\n# Call initialize() to seed a session value.\n# Wait 5 seconds so that the session will be forced to update on next request.\n# Call test() twice in rapid succession, so that both requests will be sent before either is fully processed.  I used jQuery & Firebug to submit these requests using $.get().\n# View the responses.  The first will report that the session is alive, but the second and all subsequent requests will report that it is dead.\n\n=== Versions Affected ===\nThis issue exists back in my version on 1.7.2.  I haven't verified that this still exists in 2.0.2, but it appears that the buggy code remains intact.\n","closed_by":{"login":"philsturgeon","id":67381,"node_id":"MDQ6VXNlcjY3Mzgx","avatar_url":"https://avatars.githubusercontent.com/u/67381?v=4","gravatar_id":"","url":"https://api.github.com/users/philsturgeon","html_url":"https://github.com/philsturgeon","followers_url":"https://api.github.com/users/philsturgeon/followers","following_url":"https://api.github.com/users/philsturgeon/following{/other_user}","gists_url":"https://api.github.com/users/philsturgeon/gists{/gist_id}","starred_url":"https://api.github.com/users/philsturgeon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/philsturgeon/subscriptions","organizations_url":"https://api.github.com/users/philsturgeon/orgs","repos_url":"https://api.github.com/users/philsturgeon/repos","events_url":"https://api.github.com/users/philsturgeon/events{/privacy}","received_events_url":"https://api.github.com/users/philsturgeon/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/154/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/154/timeline","performed_via_github_app":null,"state_reason":"completed"}