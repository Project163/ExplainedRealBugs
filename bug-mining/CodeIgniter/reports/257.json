{"url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/2320","repository_url":"https://api.github.com/repos/bcit-ci/CodeIgniter","labels_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/2320/labels{/name}","comments_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/2320/comments","events_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/2320/events","html_url":"https://github.com/bcit-ci/CodeIgniter/issues/2320","id":11884103,"node_id":"MDU6SXNzdWUxMTg4NDEwMw==","number":2320,"title":"Misleading/Confusing SSL/TLS parameter with SMTP connection","user":{"login":"yuanzhou","id":195873,"node_id":"MDQ6VXNlcjE5NTg3Mw==","avatar_url":"https://avatars.githubusercontent.com/u/195873?v=4","gravatar_id":"","url":"https://api.github.com/users/yuanzhou","html_url":"https://github.com/yuanzhou","followers_url":"https://api.github.com/users/yuanzhou/followers","following_url":"https://api.github.com/users/yuanzhou/following{/other_user}","gists_url":"https://api.github.com/users/yuanzhou/gists{/gist_id}","starred_url":"https://api.github.com/users/yuanzhou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yuanzhou/subscriptions","organizations_url":"https://api.github.com/users/yuanzhou/orgs","repos_url":"https://api.github.com/users/yuanzhou/repos","events_url":"https://api.github.com/users/yuanzhou/events{/privacy}","received_events_url":"https://api.github.com/users/yuanzhou/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2013-03-11T16:15:20Z","updated_at":"2016-05-04T06:26:07Z","closed_at":"2013-03-12T17:34:43Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The following config works without problem.\n\n```\n$config = array(\n    protocol' => 'smtp',\n    'smtp_host' => 'ssl://smtp.example.com',\n    'smtp_port' => 465,\n    'smtp_user' => 'username',\n    'smtp_pass' => 'password',\n);\n```\n\nWhen I checked the email class source code, I noticed that we can specify the value of \"smtp_crypto\", if you remove \"ssl://\" prefix from the \"smtp_host\" value and assign it to \"smtp_crypto\" as shown below:\n\n```\n$config = array(\n    protocol' => 'smtp',\n    'smtp_host' => 'smtp.example.com',\n    'smtp_port' => 465,\n    'smtp_user' => 'username',\n    'smtp_pass' => 'password',\n    'smtp_crypto' => 'ssl',\n);\n```\n\nBUT this won't work. Because \"smtp_crypto\" was set as NULL in the property definition and it can't be initialized in initialize($config = array()) when evaluated by isset() \n\n```\n/**\n * SMTP Encryption\n * \n * @var string NULL, 'tls' or 'ssl'\n */\npublic $smtp_crypto = NULL;\n```\n\nSo it should be assigned with an empty string in property definition:\n\n```\n/**\n * SMTP Encryption\n * \n * @var string 'tls' or 'ssl'\n */\npublic $smtp_crypto = '';\n```\n\nAnd in _smtp_connect(), we should change the NULL into empty string: \n\n```\n$ssl = ($this->smtp_crypto === 'ssl') ? 'ssl://' : NULL;\n```\n\nto \n\n```\n$ssl = ($this->smtp_crypto === 'ssl') ? 'ssl://' : '';\n```\n\nBesides, I think the available values of \"smtp_crypto\" can be confusing to some people when it comes to use TLS. As this article (https://www.fastmail.fm/help/technology_ssl_vs_tls_starttls.html) points out, and I'm not quite sure about if we should use \"SSL/TSL\" and \"STARTTLS\" instead of \"SSL\" and \"TSL\". Let's see what's gonna happen after we fix the above NULL to empty string '': \n\n```\n$config = array(\n    protocol' => 'smtp',\n    'smtp_host' => 'smtp.example.com',\n    'smtp_port' => 465,\n    'smtp_user' => 'username',\n    'smtp_pass' => 'password',\n    'smtp_crypto' => 'ssl',\n);\n```\n\nNow, this works as expected because 'ssl://' is added as the prefix to smtp connection. What if we choose 'tls' like below? \n\n```\n$config = array(\n    protocol' => 'smtp',\n    'smtp_host' => 'smtp.example.com',\n    'smtp_port' => 587,\n    'smtp_user' => 'username',\n    'smtp_pass' => 'password',\n    'smtp_crypto' => 'tls',\n);\n```\n\nThis works too. But this time, no 'ssl://' is prefixed to the smtp connection, because $ssl will be empty in this case.\n\n```\n$ssl = ($this->smtp_crypto === 'ssl') ? 'ssl://' : '';\n```\n\nIf you check the source code, you will find the following code block in _smtp_connection()\n\n```\nif ($this->smtp_crypto === 'tls')\n        {\n            $this->_send_command('hello');\n            $this->_send_command('starttls');\n\n            $crypto = stream_socket_enable_crypto($this->_smtp_connect, TRUE, STREAM_CRYPTO_METHOD_TLS_CLIENT);\n\n            if ($crypto !== TRUE)\n            {\n                $this->_set_error_message('lang:email_smtp_error', $this->_get_smtp_data());\n                return FALSE;\n            }\n        }\n```\n\nIf I understand correctly, the existing insecure connection will be upgraded to a secure connection using SSL/TLS, which is called \"STARTTLS\".\n","closed_by":{"login":"narfbg","id":1058011,"node_id":"MDQ6VXNlcjEwNTgwMTE=","avatar_url":"https://avatars.githubusercontent.com/u/1058011?v=4","gravatar_id":"","url":"https://api.github.com/users/narfbg","html_url":"https://github.com/narfbg","followers_url":"https://api.github.com/users/narfbg/followers","following_url":"https://api.github.com/users/narfbg/following{/other_user}","gists_url":"https://api.github.com/users/narfbg/gists{/gist_id}","starred_url":"https://api.github.com/users/narfbg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/narfbg/subscriptions","organizations_url":"https://api.github.com/users/narfbg/orgs","repos_url":"https://api.github.com/users/narfbg/repos","events_url":"https://api.github.com/users/narfbg/events{/privacy}","received_events_url":"https://api.github.com/users/narfbg/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/2320/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/2320/timeline","performed_via_github_app":null,"state_reason":"completed"}