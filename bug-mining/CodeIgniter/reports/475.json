{"url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/4679","repository_url":"https://api.github.com/repos/bcit-ci/CodeIgniter","labels_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/4679/labels{/name}","comments_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/4679/comments","events_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/4679/events","html_url":"https://github.com/bcit-ci/CodeIgniter/issues/4679","id":163061795,"node_id":"MDU6SXNzdWUxNjMwNjE3OTU=","number":4679,"title":"ip_address() hangs when reverse proxy is IPv6","user":{"login":"aarreedd","id":2868028,"node_id":"MDQ6VXNlcjI4NjgwMjg=","avatar_url":"https://avatars.githubusercontent.com/u/2868028?v=4","gravatar_id":"","url":"https://api.github.com/users/aarreedd","html_url":"https://github.com/aarreedd","followers_url":"https://api.github.com/users/aarreedd/followers","following_url":"https://api.github.com/users/aarreedd/following{/other_user}","gists_url":"https://api.github.com/users/aarreedd/gists{/gist_id}","starred_url":"https://api.github.com/users/aarreedd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aarreedd/subscriptions","organizations_url":"https://api.github.com/users/aarreedd/orgs","repos_url":"https://api.github.com/users/aarreedd/repos","events_url":"https://api.github.com/users/aarreedd/events{/privacy}","received_events_url":"https://api.github.com/users/aarreedd/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":140924,"node_id":"MDU6TGFiZWwxNDA5MjQ=","url":"https://api.github.com/repos/bcit-ci/CodeIgniter/labels/Bug","name":"Bug","color":"eb2420","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/bcit-ci/CodeIgniter/milestones/14","html_url":"https://github.com/bcit-ci/CodeIgniter/milestone/14","labels_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/milestones/14/labels","id":2103230,"node_id":"MDk6TWlsZXN0b25lMjEwMzIzMA==","number":14,"title":"3.1.3","description":"","creator":{"login":"narfbg","id":1058011,"node_id":"MDQ6VXNlcjEwNTgwMTE=","avatar_url":"https://avatars.githubusercontent.com/u/1058011?v=4","gravatar_id":"","url":"https://api.github.com/users/narfbg","html_url":"https://github.com/narfbg","followers_url":"https://api.github.com/users/narfbg/followers","following_url":"https://api.github.com/users/narfbg/following{/other_user}","gists_url":"https://api.github.com/users/narfbg/gists{/gist_id}","starred_url":"https://api.github.com/users/narfbg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/narfbg/subscriptions","organizations_url":"https://api.github.com/users/narfbg/orgs","repos_url":"https://api.github.com/users/narfbg/repos","events_url":"https://api.github.com/users/narfbg/events{/privacy}","received_events_url":"https://api.github.com/users/narfbg/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":23,"state":"closed","created_at":"2016-10-31T07:34:48Z","updated_at":"2017-01-10T10:21:23Z","due_on":null,"closed_at":"2017-01-10T10:21:23Z"},"comments":2,"created_at":"2016-06-30T01:20:32Z","updated_at":"2016-11-03T14:26:52Z","closed_at":"2016-07-19T11:04:46Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This is a bug I originally posted here:\n\nhttp://forum.codeigniter.com/thread-65587-post-334025.html#pid334025\n\nI have done some more digging and found this is a bug in Code Igniter's core `ip_address()` function. This bug is in CI 3.0.6.\n\nWhen a reverse proxy uses an IPv6 address that is in the `proxy_ip` list in the config file, the `ip_address()` function gets stuck in a loop. \n\nThe PHP file below is a stripped out version of `/system/core/Input.php` that recreates the problem. I hard coded `$proxy_ips`, the `HTTP_X_FORWARDED_FOR` header, and the `REMOTE_ADDR` header to simulate the bug. \n\nSave the code below as `Input.php` and run it with \n\n```\n$ php Input.php\n```\n\nComment out line 35 to see the function run properly with an IPv4 Address.\n\n```\n<?php\n\n// Proxy IPs list. \n// In production this would be set in config.php\n$proxy_ips = [\n    '103.21.244.0/22',\n    '103.22.200.0/22',\n    '103.31.4.0/22',\n    '104.16.0.0/12',\n    '108.162.192.0/18',\n    '141.101.64.0/18',\n    '162.158.0.0/15',\n    '172.64.0.0/13',\n    '173.245.48.0/20',\n    '188.114.96.0/20',\n    '190.93.240.0/20',\n    '197.234.240.0/22',\n    '198.41.128.0/17',\n    '199.27.128.0/21',\n    '2400:cb00::/32',\n    '2405:8100::/32',\n    '2405:b500::/32',\n    '2606:4700::/32',\n    '2803:f800::/32',\n];\n\n// Set fake forwarded for IP. In production this would be set by\n// cloudflare's reverse proxy. \n$_SERVER['HTTP_X_FORWARDED_FOR'] = '8.8.8.8';\n\n// Set IP Address manually. \n// In production this would come from $_SERVER['REMOTE_ADDR'];\n$ip_address = '103.31.4.1';  // When the reverse proxy is on an IPv4 address\n$ip_address = '2001:5b0:2b25:a4e0:1900:ef83:2fe9:5c88';  // If you uncomment this line we get stuck in a loop.\n\nif ( ! empty($proxy_ips) && ! is_array($proxy_ips))\n{\n    $proxy_ips = explode(',', str_replace(' ', '', $proxy_ips));\n}\n\nif ($proxy_ips)\n{\n    foreach (array('HTTP_X_FORWARDED_FOR', 'HTTP_CLIENT_IP', 'HTTP_X_CLIENT_IP', 'HTTP_X_CLUSTER_CLIENT_IP') as $header)\n    {\n        if (($spoof = server($header)) !== NULL)\n        {\n            // Some proxies typically list the whole chain of IP\n            // addresses through which the client has reached us.\n            // e.g. client_ip, proxy_ip1, proxy_ip2, etc.\n            sscanf($spoof, '%[^,]', $spoof);\n\n            if ( ! valid_ip($spoof))\n            {\n                $spoof = NULL;\n            }\n            else\n            {\n                break;\n            }\n        }\n    }\n\n    if ($spoof)\n    {\n        for ($i = 0, $c = count($proxy_ips); $i < $c; $i++)\n        {\n            var_dump($i);\n\n            // Check if we have an IP address or a subnet\n            if (strpos($proxy_ips[$i], '/') === FALSE)\n            {\n                // An IP address (and not a subnet) is specified.\n                // We can compare right away.\n                if ($proxy_ips[$i] === $ip_address)\n                {\n                    $ip_address = $spoof;\n                    break;\n                }\n\n                continue;\n            }\n\n            // We have a subnet ... now the heavy lifting begins\n            isset($separator) OR $separator = valid_ip($ip_address, 'ipv6') ? ':' : '.';\n\n            // If the proxy entry doesn't match the IP protocol - skip it\n            if (strpos($proxy_ips[$i], $separator) === FALSE)\n            {\n                continue;\n            }\n\n            // Convert the REMOTE_ADDR IP address to binary, if needed\n            if ( ! isset($ip, $sprintf))\n            {\n                if ($separator === ':')\n                {\n                    // Make sure we're have the \"full\" IPv6 format\n                    $ip = explode(':',\n                        str_replace('::',\n                            str_repeat(':', 9 - substr_count($ip_address, ':')),\n                            $ip_address\n                        )\n                    );\n\n                    for ($j = 0; $j < 8; $j++)\n                    {\n                        $ip[$j] = intval($ip[$j], 16);\n                    }\n\n                    $sprintf = '%016b%016b%016b%016b%016b%016b%016b%016b';\n                }\n                else\n                {\n                    $ip = explode('.', $ip_address);\n                    $sprintf = '%08b%08b%08b%08b';\n                }\n\n                $ip = vsprintf($sprintf, $ip);\n            }\n\n            // Split the netmask length off the network address\n            sscanf($proxy_ips[$i], '%[^/]/%d', $netaddr, $masklen);\n\n            // Again, an IPv6 address is most likely in a compressed form\n            if ($separator === ':')\n            {\n                $netaddr = explode(':', str_replace('::', str_repeat(':', 9 - substr_count($netaddr, ':')), $netaddr));\n                for ($i = 0; $i < 8; $i++)\n                {\n                    $netaddr[$i] = intval($netaddr[$i], 16);\n                }\n            }\n            else\n            {\n                $netaddr = explode('.', $netaddr);\n            }\n\n            // Convert to binary and finally compare\n            if (strncmp($ip, vsprintf($sprintf, $netaddr), $masklen) === 0)\n            {\n                $ip_address = $spoof;\n                break;\n            }\n        }\n    }\n}\n\nif ( ! valid_ip($ip_address))\n{\n    return $ip_address = '0.0.0.0';\n}\n\n// die instead of returning\ndie($ip_address);\n\n// --------------------------------------\n// --------------------------------------\n// --------------------------------------\n\nfunction valid_ip($ip, $which = '')\n{\n    switch (strtolower($which))\n    {\n        case 'ipv4':\n            $which = FILTER_FLAG_IPV4;\n            break;\n        case 'ipv6':\n            $which = FILTER_FLAG_IPV6;\n            break;\n        default:\n            $which = NULL;\n            break;\n    }\n\n    return (bool) filter_var($ip, FILTER_VALIDATE_IP, $which);\n}\n\n/**\n * Fetch an item from the SERVER array\n *\n * @param    mixed    $index        Index for item to be fetched from $_SERVER\n * @param    bool    $xss_clean    Whether to apply XSS filtering\n * @return    mixed\n */\nfunction server($index, $xss_clean = NULL)\n{\n    return _fetch_from_array($_SERVER, $index, $xss_clean);\n}\n\n/**\n * Fetch from array\n *\n * Internal method used to retrieve values from global arrays.\n *\n * @param    array    &$array        $_GET, $_POST, $_COOKIE, $_SERVER, etc.\n * @param    mixed    $index        Index for item to be fetched from $array\n * @param    bool    $xss_clean    Whether to apply XSS filtering\n * @return    mixed\n */\nfunction _fetch_from_array(&$array, $index = NULL, $xss_clean = NULL)\n{\n    $xss_clean = true;\n\n    // If $index is NULL, it means that the whole $array is requested\n    isset($index) OR $index = array_keys($array);\n\n    // allow fetching multiple keys at once\n    if (is_array($index))\n    {\n        $output = array();\n        foreach ($index as $key)\n        {\n            $output[$key] = _fetch_from_array($array, $key, $xss_clean);\n        }\n\n        return $output;\n    }\n\n    if (isset($array[$index]))\n    {\n        $value = $array[$index];\n    }\n    elseif (($count = preg_match_all('/(?:^[^\\[]+)|\\[[^]]*\\]/', $index, $matches)) > 1) // Does the index contain array notation\n    {\n        $value = $array;\n        for ($i = 0; $i < $count; $i++)\n        {\n            $key = trim($matches[0][$i], '[]');\n            if ($key === '') // Empty notation will return the value as array\n            {\n                break;\n            }\n\n            if (isset($value[$key]))\n            {\n                $value = $value[$key];\n            }\n            else\n            {\n                return NULL;\n            }\n        }\n    }\n    else\n    {\n        return NULL;\n    }\n\n    return $value;\n}\n```\n","closed_by":{"login":"narfbg","id":1058011,"node_id":"MDQ6VXNlcjEwNTgwMTE=","avatar_url":"https://avatars.githubusercontent.com/u/1058011?v=4","gravatar_id":"","url":"https://api.github.com/users/narfbg","html_url":"https://github.com/narfbg","followers_url":"https://api.github.com/users/narfbg/followers","following_url":"https://api.github.com/users/narfbg/following{/other_user}","gists_url":"https://api.github.com/users/narfbg/gists{/gist_id}","starred_url":"https://api.github.com/users/narfbg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/narfbg/subscriptions","organizations_url":"https://api.github.com/users/narfbg/orgs","repos_url":"https://api.github.com/users/narfbg/repos","events_url":"https://api.github.com/users/narfbg/events{/privacy}","received_events_url":"https://api.github.com/users/narfbg/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/4679/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/4679/timeline","performed_via_github_app":null,"state_reason":"completed"}