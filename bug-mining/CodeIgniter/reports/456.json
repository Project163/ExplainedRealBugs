{"url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/4647","repository_url":"https://api.github.com/repos/bcit-ci/CodeIgniter","labels_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/4647/labels{/name}","comments_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/4647/comments","events_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/4647/events","html_url":"https://github.com/bcit-ci/CodeIgniter/issues/4647","id":156866251,"node_id":"MDU6SXNzdWUxNTY4NjYyNTE=","number":4647,"title":"count_all_results produces incorrect results","user":{"login":"blasto333","id":2765230,"node_id":"MDQ6VXNlcjI3NjUyMzA=","avatar_url":"https://avatars.githubusercontent.com/u/2765230?v=4","gravatar_id":"","url":"https://api.github.com/users/blasto333","html_url":"https://github.com/blasto333","followers_url":"https://api.github.com/users/blasto333/followers","following_url":"https://api.github.com/users/blasto333/following{/other_user}","gists_url":"https://api.github.com/users/blasto333/gists{/gist_id}","starred_url":"https://api.github.com/users/blasto333/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/blasto333/subscriptions","organizations_url":"https://api.github.com/users/blasto333/orgs","repos_url":"https://api.github.com/users/blasto333/repos","events_url":"https://api.github.com/users/blasto333/events{/privacy}","received_events_url":"https://api.github.com/users/blasto333/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":140924,"node_id":"MDU6TGFiZWwxNDA5MjQ=","url":"https://api.github.com/repos/bcit-ci/CodeIgniter/labels/Bug","name":"Bug","color":"eb2420","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/bcit-ci/CodeIgniter/milestones/11","html_url":"https://github.com/bcit-ci/CodeIgniter/milestone/11","labels_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/milestones/11/labels","id":1677677,"node_id":"MDk6TWlsZXN0b25lMTY3NzY3Nw==","number":11,"title":"3.1.0","description":"","creator":{"login":"narfbg","id":1058011,"node_id":"MDQ6VXNlcjEwNTgwMTE=","avatar_url":"https://avatars.githubusercontent.com/u/1058011?v=4","gravatar_id":"","url":"https://api.github.com/users/narfbg","html_url":"https://github.com/narfbg","followers_url":"https://api.github.com/users/narfbg/followers","following_url":"https://api.github.com/users/narfbg/following{/other_user}","gists_url":"https://api.github.com/users/narfbg/gists{/gist_id}","starred_url":"https://api.github.com/users/narfbg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/narfbg/subscriptions","organizations_url":"https://api.github.com/users/narfbg/orgs","repos_url":"https://api.github.com/users/narfbg/repos","events_url":"https://api.github.com/users/narfbg/events{/privacy}","received_events_url":"https://api.github.com/users/narfbg/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":25,"state":"closed","created_at":"2016-04-01T09:05:49Z","updated_at":"2016-11-03T14:26:52Z","due_on":"2016-07-25T07:00:00Z","closed_at":"2016-07-26T17:54:06Z"},"comments":1,"created_at":"2016-05-25T22:39:23Z","updated_at":"2016-05-26T07:23:24Z","closed_at":"2016-05-26T07:23:24Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"count_all_results is returning the wrong value in many cases in CI 3.0.6\n\nQUERY BUILDER:\n\n```\n    $this->db->select('items.item_id, items.name, categories.id as category_id,categories.name as category,location, company_name, item_number,size, product_id, \n    IFNULL('.$this->db->dbprefix('location_items').'.cost_price, '.$this->db->dbprefix('items').'.cost_price) as cost_price, \n    IFNULL('.$this->db->dbprefix('location_items').'.unit_price, '.$this->db->dbprefix('items').'.unit_price) as unit_price,\n    SUM(quantity) as quantity, \n    IFNULL('.$this->db->dbprefix('location_items').'.reorder_level, '.$this->db->dbprefix('items').'.reorder_level) as reorder_level, \n    description', FALSE);\n    $this->db->from('items');\n    $this->db->join('suppliers', 'items.supplier_id = suppliers.person_id', 'left outer');\n    $this->db->join('categories', 'items.category_id = categories.id', 'left outer');\n    $this->db->join('location_items', 'location_items.item_id = items.item_id and location_id IN('.$location_ids_string.')', 'left');\n    $this->db->where('items.deleted', 0);\n    $this->db->group_by('items.item_id');\n\n    if ($this->params['supplier'] != -1)\n    {\n        $this->db->where('suppliers.person_id', $this->params['supplier']);\n    }\n\n    if ($this->params['category_id'] != -1)\n    {\n        $this->db->where_in('categories.id', $category_ids);\n    }\n\n    if ($this->params['inventory'] == 'in_stock')\n    {\n        $this->db->where('quantity > 0');\n    }\n\n    if ($this->params['inventory'] == 'out_of_stock')\n    {\n        $this->db->where('quantity <= 0');\n    }\n\n    $this->db->where('is_service !=', 1);\n    $this->db->order_by('items.name');\n\n    $ret = $this->db->count_all_results();\n\n    echo $this->db->last_query();\n```\n\n3.0.4 (Returns 38) (Correct)\n\nSELECT COUNT(*) AS `numrows` FROM ( SELECT phppos_items.item_id, phppos_items.name, phppos_categories.id as category_id, phppos_categories.name as category, location, company_name, item_number, size, product_id, IFNULL(phppos_location_items.cost_price, phppos_items.cost_price) as cost_price, IFNULL(phppos_location_items.unit_price, phppos_items.unit_price) as unit_price, SUM(quantity) as quantity, IFNULL(phppos_location_items.reorder_level, phppos_items.reorder_level) as reorder_level, description FROM `phppos_items` LEFT OUTER JOIN `phppos_suppliers` ON `phppos_items`.`supplier_id` = `phppos_suppliers`.`person_id` LEFT OUTER JOIN `phppos_categories` ON `phppos_items`.`category_id` = `phppos_categories`.`id` LEFT JOIN `phppos_location_items` ON `phppos_location_items`.`item_id` = `phppos_items`.`item_id` and `location_id` IN(1) WHERE `phppos_items`.`deleted` =0 AND `is_service` != 1 GROUP BY `phppos_items`.`item_id` ORDER BY `phppos_items`.`name` ) CI_count_all_results\n\n3.0.6 (Returns 1) (Incorrect)\n`SELECT COUNT(*) AS`numrows`FROM`phppos_items`LEFT OUTER JOIN`phppos_suppliers`ON`phppos_items`.`supplier_id`=`phppos_suppliers`.`person_id`LEFT OUTER JOIN`phppos_categories`ON`phppos_items`.`category_id`=`phppos_categories`.`id`LEFT JOIN`phppos_location_items`ON`phppos_location_items`.`item_id`=`phppos_items`.`item_id`and`location_id`IN(1) WHERE`phppos_items`.`deleted`=0 AND`is_service`!= 1 GROUP BY`phppos_items`.`item_id``\n","closed_by":{"login":"narfbg","id":1058011,"node_id":"MDQ6VXNlcjEwNTgwMTE=","avatar_url":"https://avatars.githubusercontent.com/u/1058011?v=4","gravatar_id":"","url":"https://api.github.com/users/narfbg","html_url":"https://github.com/narfbg","followers_url":"https://api.github.com/users/narfbg/followers","following_url":"https://api.github.com/users/narfbg/following{/other_user}","gists_url":"https://api.github.com/users/narfbg/gists{/gist_id}","starred_url":"https://api.github.com/users/narfbg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/narfbg/subscriptions","organizations_url":"https://api.github.com/users/narfbg/orgs","repos_url":"https://api.github.com/users/narfbg/repos","events_url":"https://api.github.com/users/narfbg/events{/privacy}","received_events_url":"https://api.github.com/users/narfbg/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/4647/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/4647/timeline","performed_via_github_app":null,"state_reason":"completed"}