{"url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/3123","repository_url":"https://api.github.com/repos/bcit-ci/CodeIgniter","labels_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/3123/labels{/name}","comments_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/3123/comments","events_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/3123/events","html_url":"https://github.com/bcit-ci/CodeIgniter/issues/3123","id":36782506,"node_id":"MDU6SXNzdWUzNjc4MjUwNg==","number":3123,"title":"ReDoS issue in xss_clean","user":{"login":"spipm","id":4620457,"node_id":"MDQ6VXNlcjQ2MjA0NTc=","avatar_url":"https://avatars.githubusercontent.com/u/4620457?v=4","gravatar_id":"","url":"https://api.github.com/users/spipm","html_url":"https://github.com/spipm","followers_url":"https://api.github.com/users/spipm/followers","following_url":"https://api.github.com/users/spipm/following{/other_user}","gists_url":"https://api.github.com/users/spipm/gists{/gist_id}","starred_url":"https://api.github.com/users/spipm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spipm/subscriptions","organizations_url":"https://api.github.com/users/spipm/orgs","repos_url":"https://api.github.com/users/spipm/repos","events_url":"https://api.github.com/users/spipm/events{/privacy}","received_events_url":"https://api.github.com/users/spipm/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2014-06-30T09:36:36Z","updated_at":"2014-08-05T23:48:07Z","closed_at":"2014-08-05T08:46:58Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When global_xss_filtering is set to TRUE in config.php, Codeigniter will pass input trough xss_clean(). Sending a large request composed of lowercase characters causes Denial of Service.\n\nThe function xss_clean() in /system/core/Security.php does a call to preg_replace_callback:\n$str = preg_replace_callback(\"/[a-z]+=([\\'\\\"]).*?\\1/si\", array($this, '_convert_attribute'), $str);\n\nThe problem with this regex is the part “[a-z]+=”. This will cause PHP to go trough all possible combinations of the lowercase characters to check if they are followed by an equal sign. The POC below shows what problems this causes.\n\nThe following PHP code was used to test the regex “/[a-z]+=/\" on a MacBook Pro:\n\n```\n<?php\n\n$filename = \"codeigniter_redos_benchmark.csv\";\n$file = fopen( $filename, \"w\" );\n\n$max = 100000;\n$inc = 5000;\n$input = str_repeat(\"a\", $inc);\n\nfor ($size = $inc; $size < $max; $size+=$inc) {\n\n    // measure time\n    $before = microtime(true);\n        preg_replace(\"/[a-z]+=/\", '', $input);\n    $after = microtime(true);\n\n    // save to file and stdout\n    $time = (int)$after - (int)$before;\n        // file\n        fwrite( $file, \"$size,$time\\n\" );\n        // stdout\n        echo \"@ $size,$time\\n\";\n\n    // add more input\n    $input .= str_repeat(\"a\", $inc);\n}\n\nfclose( $file ); ?>\n```\n\nThe results can be seen in the graph below. It is clear that even though the processing time only grows linear, the processing can take a very long time to complete. Only 100k of characters took a full minute.\n\nExploiting this property is very easy. An attacker just needs to keep sending large requests to the server. Using multiple sockets it’s easy to consume all the server’s recourses. \n\n![redos](https://cloud.githubusercontent.com/assets/4620457/3427697/4e3102c6-0036-11e4-91be-378975ea7f19.png)\n\nI've contacted EllisLab about this issue, and they said the best approach would be to to do a request report here and have the community fix it.\n","closed_by":{"login":"narfbg","id":1058011,"node_id":"MDQ6VXNlcjEwNTgwMTE=","avatar_url":"https://avatars.githubusercontent.com/u/1058011?v=4","gravatar_id":"","url":"https://api.github.com/users/narfbg","html_url":"https://github.com/narfbg","followers_url":"https://api.github.com/users/narfbg/followers","following_url":"https://api.github.com/users/narfbg/following{/other_user}","gists_url":"https://api.github.com/users/narfbg/gists{/gist_id}","starred_url":"https://api.github.com/users/narfbg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/narfbg/subscriptions","organizations_url":"https://api.github.com/users/narfbg/orgs","repos_url":"https://api.github.com/users/narfbg/repos","events_url":"https://api.github.com/users/narfbg/events{/privacy}","received_events_url":"https://api.github.com/users/narfbg/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/3123/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/bcit-ci/CodeIgniter/issues/3123/timeline","performed_via_github_app":null,"state_reason":"completed"}