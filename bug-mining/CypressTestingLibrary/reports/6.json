{"url":"https://api.github.com/repos/testing-library/cypress-testing-library/issues/103","repository_url":"https://api.github.com/repos/testing-library/cypress-testing-library","labels_url":"https://api.github.com/repos/testing-library/cypress-testing-library/issues/103/labels{/name}","comments_url":"https://api.github.com/repos/testing-library/cypress-testing-library/issues/103/comments","events_url":"https://api.github.com/repos/testing-library/cypress-testing-library/issues/103/events","html_url":"https://github.com/testing-library/cypress-testing-library/issues/103","id":557053485,"node_id":"MDU6SXNzdWU1NTcwNTM0ODU=","number":103,"title":"Unhelpful error messages for query* commands","user":{"login":"NicholasBoll","id":338257,"node_id":"MDQ6VXNlcjMzODI1Nw==","avatar_url":"https://avatars.githubusercontent.com/u/338257?v=4","gravatar_id":"","url":"https://api.github.com/users/NicholasBoll","html_url":"https://github.com/NicholasBoll","followers_url":"https://api.github.com/users/NicholasBoll/followers","following_url":"https://api.github.com/users/NicholasBoll/following{/other_user}","gists_url":"https://api.github.com/users/NicholasBoll/gists{/gist_id}","starred_url":"https://api.github.com/users/NicholasBoll/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/NicholasBoll/subscriptions","organizations_url":"https://api.github.com/users/NicholasBoll/orgs","repos_url":"https://api.github.com/users/NicholasBoll/repos","events_url":"https://api.github.com/users/NicholasBoll/events{/privacy}","received_events_url":"https://api.github.com/users/NicholasBoll/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1118585454,"node_id":"MDU6TGFiZWwxMTE4NTg1NDU0","url":"https://api.github.com/repos/testing-library/cypress-testing-library/labels/released","name":"released","color":"ededed","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2020-01-29T18:59:13Z","updated_at":"2020-02-02T03:49:15Z","closed_at":"2020-02-02T03:44:56Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"- `cypress-testing-library` version: 5.1.0\r\n\r\nRelevant code or config\r\n\r\nTest\r\n```javascript\r\ncy.queryByLabelText('Test 1').click()\r\ncy.queryByLabelText('Test 2').click()\r\ncy.queryByLabelText('Test 3').click()\r\ncy.queryByLabelText('Test 4').click()\r\n```\r\n\r\nHTML\r\n```html\r\nPassing - no issues\r\n<label for=\"1\">Test 1</label>\r\n<input id=\"1\" />\r\n\r\nFailing - couldn't find the label element\r\n<label for=\"2\">Test Oops</label>\r\n<input id=\"2\">\r\n\r\nFailing - there is no `for` attribute on the label element\r\n<label>Test 3</label>\r\n<input id=\"3\" />\r\n\r\nFailing - couldn't find the input element\r\n<label for=\"4\">Test 4</label>\r\n<input />\r\n```\r\n\r\nWhat happened:\r\n\r\nThe first passes fine. The `consoleProps` do not have the same description level as built-in Cypress commands\r\n\r\nThe second fails, but not as expected. The issue is the label element could not be found by the text \"Test 2\"\r\n\r\nThe third fails, but not as expected. The issue is the label element doesn't have a `for` attribute and has no way to associate with an input\r\n\r\nThe fourth fails, but not as expected. The issue is the label element has no corresponding input element.\r\n\r\nAll failures result in this error message:\r\n\r\n```\r\nCypressError: cy.click() failed because it requires a DOM element.\r\n\r\nThe subject received was:\r\n\r\n  > {}\r\n\r\nThe previous command that ran was:\r\n\r\n  > cy.then()\r\n```\r\n\r\n<img width=\"550\" alt=\"Error image described by code block\" src=\"https://user-images.githubusercontent.com/338257/73385137-d7ff3180-4289-11ea-8766-af5b315aa3d4.png\">\r\n\r\nNote that the failure is on the `cy.click` command and _not_ the `queryByLabelText` command. This is because https://github.com/testing-library/cypress-testing-library/blob/master/src/index.js#L87 simply wraps any returned value in an jQuery wrapper. It seems to be returning an empty object rather than an empty NodeList which Cypress automatically detects.\r\n\r\nAlso notice the error mentions the previous command was `cy.then`, even though that command wasn't actually used anywhere in user code. This is confusing. This is because of https://github.com/testing-library/cypress-testing-library/blob/master/src/index.js#L84 (use of `cy.window().then()`\r\n\r\nThere is also a comment about Promises not working with Cypress retryability which is not accurate. The problem probably comes from the use of `cy.then`. The original intent of Cypress Custom commands was not to use any `cy` commands at all. Internal Cypress Commands do not use them. Here's the source code for all the traversal-style commands: https://github.com/cypress-io/cypress/blob/develop/packages/driver/src/cy/commands/traversals.coffee. Notice promises are used in there just fine.\r\n\r\nProblem description:\r\nFailures to find elements returned from `@testing-library/dom` are unhelpful and confusing\r\n\r\nSuggested solution:\r\nRefactor the use of Cypress Custom Commands a bit to better handle not finding an element and remove the use of `cy.window()` and `cy.then`. Cypress has a `cy.state` function and it saves the `window` in `cy.state('window')` which is synchronously resolved.\r\n\r\nAlso try some of the query commands with known failures and see if the errors are useful. This goes a long way to guiding developers to finding out why something went wrong.","closed_by":{"login":"kentcdodds","id":1500684,"node_id":"MDQ6VXNlcjE1MDA2ODQ=","avatar_url":"https://avatars.githubusercontent.com/u/1500684?v=4","gravatar_id":"","url":"https://api.github.com/users/kentcdodds","html_url":"https://github.com/kentcdodds","followers_url":"https://api.github.com/users/kentcdodds/followers","following_url":"https://api.github.com/users/kentcdodds/following{/other_user}","gists_url":"https://api.github.com/users/kentcdodds/gists{/gist_id}","starred_url":"https://api.github.com/users/kentcdodds/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kentcdodds/subscriptions","organizations_url":"https://api.github.com/users/kentcdodds/orgs","repos_url":"https://api.github.com/users/kentcdodds/repos","events_url":"https://api.github.com/users/kentcdodds/events{/privacy}","received_events_url":"https://api.github.com/users/kentcdodds/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/testing-library/cypress-testing-library/issues/103/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/testing-library/cypress-testing-library/issues/103/timeline","performed_via_github_app":null,"state_reason":"completed"}