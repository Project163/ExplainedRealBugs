<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sun Nov 09 05:59:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[JEXL-414] SoftCache may suffer from race conditions</title>
                <link>https://issues.apache.org/jira/browse/JEXL-414</link>
                <project id="12310479" key="JEXL">Commons JEXL</project>
                    <description>&lt;p&gt;I found the SoftCache used from within the JEXL class Engine to be very relevant for overall performance (depending on the application) on the one hand, but on the other hand it may suffer from race conditions.&lt;/p&gt;

&lt;p&gt;While solid efford was taken to protect it from race conditions by surrounding access using a ReadWriteLock, parallel read access actually do reach out on a LinkedHashMap having set accessOrder=true. This means that on every potentially parallel, non serialized invocation of LinkedHashMap#get the order of elements is modified to bring the last accessed element down to the tail of the internal linked list structure and modCount is incremented.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In our application rendering web templates, we observe multiple of 10000 access on the SoftCache per page impression and multiple of 10 page impressions per second per JVM instance.&lt;/p&gt;

&lt;p&gt;Not sure whether this is result of race condition claimed above, in heapdumps of that application I observed the LinkedHashMap used within SoftCache having a size of ~9500 elements while the SoftCache#size is set to limit the cache to 5000 elements. Additionaly the LinkedHashMap#modCount shows up with arbitrary giant positive or negative numbers, telling me it has overflown already after some hours of application uptime.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13558416">JEXL-414</key>
            <summary>SoftCache may suffer from race conditions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="henrib">Henri Biestro</assignee>
                                    <reporter username="holgersunke">Holger Sunke</reporter>
                        <labels>
                    </labels>
                <created>Fri, 17 Nov 2023 14:03:52 +0000</created>
                <updated>Wed, 29 Nov 2023 11:11:30 +0000</updated>
                            <resolved>Tue, 28 Nov 2023 20:43:18 +0000</resolved>
                                    <version>3.3</version>
                                    <fixVersion>3.4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17787444" author="henrib" created="Sat, 18 Nov 2023 03:07:34 +0000"  >&lt;p&gt;Very good catch and analysis, thank you. A correction is in the works.&lt;/p&gt;</comment>
                            <comment id="17787449" author="henrib" created="Sat, 18 Nov 2023 04:31:41 +0000"  >&lt;p&gt;I&apos;ve dropped a &lt;a href=&quot;https://github.com/apache/commons-jexl/commit/e4b6b3956ed4f7e1404e4523c6629216b2384476&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;version&lt;/a&gt; that exposes a cache interface and method factories to create either synchronous or concurrent caches.&lt;br/&gt;
The former uses a linkedhashmap but fully synchronized (to correct the initial bug) whilst the latter uses a concurrentlinkedhashmap-lru (from Google). Since this introduces a new dependency, it would be nice to ensure this improves concurrency; I suspect that under low contention, there is no disadvantage to the synchronized version.&lt;br/&gt;
I may revise this to let the concurrent version in the test directory to avoid the new dependency; it might also be better to use Cafeine but that is an even bigger dependency.&lt;br/&gt;
Let me know what you think and find.&lt;/p&gt;</comment>
                            <comment id="17788775" author="JIRAUSER303087" created="Wed, 22 Nov 2023 13:19:41 +0000"  >&lt;p&gt;Thank you for quick action. Looking at the source it looks very solid and should remove any race condition.&lt;/p&gt;

&lt;p&gt;Do you have some kind of reproducible concurrent performance test to compare old implementation and both new variants?&lt;/p&gt;</comment>
                            <comment id="17789193" author="henrib" created="Thu, 23 Nov 2023 15:45:43 +0000"  >&lt;p&gt;I&apos;ve added a rough performance evaluation test class and another JexlCache implementation to compare to. I played with some parameters to get a sense of it but I feel confident the cache handling only has a small impact on overall performance.&lt;br/&gt;
Let me know what you find.&lt;br/&gt;
Commit &lt;a href=&quot;https://github.com/apache/commons-jexl/commit/b36890794bcbef32acc6b11899e5848f10905609&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;b36890&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17790801" author="JIRAUSER303087" created="Tue, 28 Nov 2023 22:56:41 +0000"  >&lt;p&gt;Nice test case, thank you.&lt;/p&gt;

&lt;p&gt;When using the test as is, testSynchronized and testSpread are performing nearly equally while testConcurrent is a bit faster.&lt;/p&gt;

&lt;p&gt;When setting HIT=500 I get quite expressive results:&lt;/p&gt;

&lt;p&gt;INFORMATION: testSynchronized : 5,523&lt;br/&gt;
INFORMATION: testSpread : 1,349&lt;br/&gt;
INFORMATION: testConcurrent : 1,248&lt;/p&gt;

&lt;p&gt;Same remains true when playing with other settings (THREADS, SCRIPTS, CACHED): testConcurrent typically is slightly faster than testSpread which is way faster than testSynchronized.&lt;/p&gt;

&lt;p&gt;testSynchronized produces lowest CPU utilization likely because it is blocking more than the other tests.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;So after all I&apos;d prefer to use the ConcurrentCache on our application or the SpreadCache if introducing a dependency was an issue to me.&lt;/p&gt;

&lt;p&gt;Would it be useful to set the concurrentlinkedhashmap-lru dependency scope to &apos;provided&apos; ? Not sure about this scopes&apos; implications tho.&lt;/p&gt;</comment>
                            <comment id="17790946" author="henrib" created="Wed, 29 Nov 2023 07:40:18 +0000"  >&lt;p&gt;As with any benchmark, I&apos;d take the result with a grain of salt. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; A tight loop of 500 create/execute of a constant script definitely biases the result by emphasizing cache performance wrt actual code parsing/execution.&lt;br/&gt;
Anyhow, the code as is allows you to choose. Since you must create a JexlBuilder and set a few options to use JEXL, you might as well take that opportunity to use the cache implementation you want. Add the eventual dependency to your project, copy the ConcurrentCache code from JEXL test to some of your packages and you&apos;re good to go.&lt;/p&gt;</comment>
                            <comment id="17791019" author="JIRAUSER303087" created="Wed, 29 Nov 2023 11:11:30 +0000"  >&lt;p&gt;Just wanted to add that in our case the SoftCache was configured too small (capacity 5000 where 10000 was needed) and the write-lock actually figured out to be the bottleneck during throughput peaks. I pulled threaddumps when things got wild (giant response times) and found hundreds of threads waiting for a lock on the cache which I didn&apos;t even know is existing up to that moment. Increasing the cache size boosted overall response times visibly in all monitoring graphs. This is likely caused due to less expression parsing but maybe also less (exclusive write-)locking.&lt;/p&gt;

&lt;p&gt;At least in situations where the app is close to congestion due to a peak I&apos;m sure the SyncronizedMap would be a problem in our case. Thus the solution of now being able to choose and experiment on different Map implementations is great &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 49 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1lomw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>