<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sun Nov 09 05:58:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[JEXL-271] Hoisted variable is lost when currying lambda</title>
                <link>https://issues.apache.org/jira/browse/JEXL-271</link>
                <project id="12310479" key="JEXL">Commons JEXL</project>
                    <description>&lt;p&gt;I have noticed that when I curry the lambda that contains hoisted variable, then binding to that variable is lost when I call curried lambda. The following test case illustrates the problem&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testCurry4() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        JexlEngine jexl = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JexlBuilder().strict(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;).create();
        JexlScript base = jexl.createScript(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; base = 2; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; sum = (x, y, z)-&amp;gt;{ base + x + y + z }; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; y = sum.curry(1); y(2,3)&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; result = base.execute(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
        Assert.assertEquals(8, result);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To put it another way, the following script returns &lt;tt&gt;2&lt;/tt&gt; when it should return &lt;tt&gt;0&lt;/tt&gt;;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; base = 2; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; sum = (x, y, z)-&amp;gt;{ base + x + y + z }; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; y = sum.curry(1); sum(1, 2, 3) - y(2,3)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13182114">JEXL-271</key>
            <summary>Hoisted variable is lost when currying lambda</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="henrib">Henri Biestro</assignee>
                                    <reporter username="dmitri_blinov">Dmitri Blinov</reporter>
                        <labels>
                    </labels>
                <created>Thu, 30 Aug 2018 12:41:16 +0000</created>
                <updated>Mon, 7 Jun 2021 13:14:14 +0000</updated>
                            <resolved>Mon, 10 Sep 2018 13:39:42 +0000</resolved>
                                    <version>3.1</version>
                                    <fixVersion>3.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="16599625" author="dmitri_blinov" created="Sat, 1 Sep 2018 12:40:48 +0000"  >&lt;p&gt;The following test case also fails.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testHoistLambda() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        JexlEngine jexl = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JexlBuilder().strict(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;).create();
        JexlScript base = jexl.createScript(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; base = 1; &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; x = (a)-&amp;gt;{ &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; y = (b) -&amp;gt; {base + b}; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; base + y(a)}; x(40)&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; result = base.execute(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
        Assert.assertEquals(42, result);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16601863" author="dmitri_blinov" created="Mon, 3 Sep 2018 08:12:59 +0000"  >&lt;p&gt;I have found a fix for both of these problems, for the first we need to fix a constructor of &lt;tt&gt;Curried&lt;/tt&gt; to honor a &lt;tt&gt;Closure&lt;/tt&gt; as a valid base,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; Curried(Script base, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] args) {
            &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(base.jexl, base.source, base.script);
            Scope.Frame sf = (base &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; Curried) ? ((Curried) base).frame : 
                             (base &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; Closure) ? ((Closure) base).frame :&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sf != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            ...
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;For the second we need to fix &lt;tt&gt;Scope.getSymbol()&lt;/tt&gt; method to fetch symbol from parent with hoist option set to true&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; getSymbol(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; hoist) {
        &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; register = namedVariables != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? namedVariables.get(name) : &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (register == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; hoist &amp;amp;&amp;amp; parent != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt; pr = parent.getSymbol(name, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
            ...
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If there are no objections, can I have the changes to be applied the source tree?&lt;/p&gt;</comment>
                            <comment id="16609204" author="henrib" created="Mon, 10 Sep 2018 13:39:42 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;simplified curry(...) after being reminded it was a form of closure (thanks Dmitri)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;commit	2fdb4278d755b85c9c1d9f767a92bde1b9d098cb&lt;/p&gt;

&lt;p&gt;src/main/java/org/apache/commons/jexl3/internal/Closure.java	&lt;br/&gt;
src/main/java/org/apache/commons/jexl3/internal/Interpreter.java		&lt;br/&gt;
src/main/java/org/apache/commons/jexl3/internal/Script.java		&lt;br/&gt;
src/test/java/org/apache/commons/jexl3/Issues200Test.java&lt;/p&gt;</comment>
                            <comment id="16609354" author="dmitri_blinov" created="Mon, 10 Sep 2018 15:02:36 +0000"  >&lt;p&gt;It would also be very helpful if &lt;tt&gt;Closure.getParameters()&lt;/tt&gt; method would return correct argument names on curried closure. Suppose we have a function {{(x,y,z) -&amp;gt; &lt;/p&gt;
{x+y+z}
&lt;p&gt;}} , for which &lt;tt&gt;getParameters()&lt;/tt&gt; returns &lt;span class=&quot;error&quot;&gt;&amp;#91;x,y,z&amp;#93;&lt;/span&gt;. After currying the first parameter it is reasonable to expect the corresponding closure to return &lt;span class=&quot;error&quot;&gt;&amp;#91;y,z&amp;#93;&lt;/span&gt;&#160;as remaining parameter list.&lt;/p&gt;</comment>
                            <comment id="16609371" author="dmitri_blinov" created="Mon, 10 Sep 2018 15:14:16 +0000"  >&lt;p&gt;Since we modified the Interpreter.java here, can you also look at&#160;&lt;tt&gt;Interpreter.interpret()&lt;/tt&gt; method, there is a possibility of incorrect&#160;&lt;tt&gt;ThreadLocal&lt;/tt&gt; handling. First there is a &lt;tt&gt;cancelCheck(node)&lt;/tt&gt; call in &lt;tt&gt;try&lt;/tt&gt; block before threadlocal initialization, and since &lt;tt&gt;cancelCheck()}}can throw exception we may eventually end up in restoring wrong values in&#160;{{finally&lt;/tt&gt; section later on. Moreover, within&#160;&lt;tt&gt;finally&lt;/tt&gt; section we try to call &lt;tt&gt;closiIfSupported()&lt;/tt&gt; for each functor, and who knows, the corresponding &lt;tt&gt;close()&lt;/tt&gt; method may also throw an exception, like &lt;tt&gt;java.io.IOException&lt;/tt&gt;, so we again can skip to restore the correct threadlocal values. ThreadLocals are very important in container environment&lt;/p&gt;</comment>
                            <comment id="16612375" author="henrib" created="Wed, 12 Sep 2018 15:44:44 +0000"  >&lt;p&gt;On TLS handling, good catch; I&apos;ve moved the code accordingly.&lt;br/&gt;
closeIfSupported(...) swallows everything so no worry there.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 9 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3xl6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>