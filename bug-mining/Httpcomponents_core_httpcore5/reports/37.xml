<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:24:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCORE-590] LaxConnPool may leak connections</title>
                <link>https://issues.apache.org/jira/browse/HTTPCORE-590</link>
                <project id="12310340" key="HTTPCORE">HttpComponents HttpCore</project>
                    <description>&lt;p&gt;LaxConnPool may leak connections when a caller cancels a pending lease request.&lt;/p&gt;

&lt;p&gt;Consider a pool of just 1 connection, currently assigned to Thread 2.&lt;/p&gt;

&lt;p&gt;Thread1:&lt;br/&gt;
future = lease&lt;br/&gt;
&#160; ... no available connection so added to pending and unsatisifed future returned ...&lt;/p&gt;

&lt;p&gt;Thread2:&lt;br/&gt;
release&lt;br/&gt;
&#160; ... put connection back in available list ...&lt;br/&gt;
&#160; servicePendingRequest&lt;br/&gt;
&#160;&#160;&#160; pending.poll() -&amp;gt; Thread1&apos;s outstanding LeaseRequest&lt;br/&gt;
&#160;&#160;&#160; leaseRequest.isDone() = false&lt;br/&gt;
&#160;&#160;&#160; leaseRequest.getDeadline.isExpired() = false&lt;br/&gt;
&#160;&#160;&#160; entry = getAvailableEntry()&lt;br/&gt;
&#160; &#160; addLeased(entry)&lt;/p&gt;

&lt;p&gt;Thread1:&lt;br/&gt;
&#160; future.cancel&lt;br/&gt;
&#160;&#160;&#160; ...&lt;br/&gt;
&#160;&#160;&#160; future.completed = true&lt;br/&gt;
&#160;&#160;&#160; ...&lt;br/&gt;
&#160;&#160;&#160; return true;&lt;br/&gt;
&#160; ... future successfully cancelled. Given up waiting for a connection, and moving on without one ...&lt;/p&gt;

&lt;p&gt;Thread2:&lt;br/&gt;
&#160; leaseRequest.completed(entry)&lt;br/&gt;
&#160;&#160;&#160; future.completed(entry)&lt;br/&gt;
&#160;&#160;&#160;&#160;&#160; if (future.completed) return false;&lt;/p&gt;

&lt;p&gt;At this point, the completed call failed (returned false), meaning the entry hasn&apos;t successfully been received by any caller waiting on the future. But we ignore that failure and proceed as if it has succeeded; leaving the entry in the leased list, where it will permanently now stay because no caller will ever release it.&lt;/p&gt;


&lt;p&gt;The code must test the result of attempting to complete the future, and if it fails, must return the entry to the available pool.&lt;/p&gt;


&lt;p&gt;The error can be recreated with the following test code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hc.core5.io.ModalCloseable;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hc.core5.io.CloseMode;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hc.core5.pool.PoolEntry;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hc.core5.pool.LaxConnPool;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hc.core5.pool.PoolEntry;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hc.core5.util.TimeValue;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.concurrent.Future;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.concurrent.Phaser;


&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;PoolCancelTest {

&#160; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestConn &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; ModalCloseable {
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() {
&#160;&#160;&#160; }
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close(CloseMode mode) {
&#160;&#160;&#160; }
&#160; }

&#160; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; LaxConnPool&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,TestConn&amp;gt; pool;
&#160; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Phaser sync = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Phaser(1);

&#160; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void dbg(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; msg) {
&#160;&#160;&#160; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getName()+&lt;span class=&quot;code-quote&quot;&gt;&quot;: &quot;&lt;/span&gt;+&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis()+&lt;span class=&quot;code-quote&quot;&gt;&quot;: &quot;&lt;/span&gt;+msg);
&#160; }

&#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; poolSize = &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.parseInt(args[0]);
&#160;&#160;&#160; pool = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LaxConnPool&amp;lt;&amp;gt;(poolSize);
&#160;&#160;&#160; &lt;span class=&quot;code-comment&quot;&gt;// Create a pool entry purely to prime &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;loading
&lt;/span&gt;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PoolEntry&amp;lt;&amp;gt;(&quot;&quot;, TimeValue.NEG_ONE_MILLISECONDS);
&#160;&#160; &#160;
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0;i&amp;lt;poolSize*2;i++) {
&#160;&#160;&#160;&#160;&#160; sync.register();
&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;req-%04d&quot;&lt;/span&gt;, i)) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160; @Override
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dbg(&lt;span class=&quot;code-quote&quot;&gt;&quot;Started&quot;&lt;/span&gt;);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Future&amp;lt;PoolEntry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,TestConn&amp;gt;&amp;gt; req = pool.lease(&lt;span class=&quot;code-quote&quot;&gt;&quot;somehost&quot;&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; PoolEntry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,TestConn&amp;gt; entry = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (req.isDone()) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; entry = req.get();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!entry.hasConnection()) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; entry.assignConnection(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TestConn());
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception shouldNotHappen) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dbg(&lt;span class=&quot;code-quote&quot;&gt;&quot;Should not happen!&quot;&lt;/span&gt;);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; shouldNotHappen.printStackTrace();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; sync.arriveAndAwaitAdvance();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (entry != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pool.release(entry, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dbg(&lt;span class=&quot;code-quote&quot;&gt;&quot;Released pool entry &quot;&lt;/span&gt;+&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.identityHashCode(entry));
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (req.cancel(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; req = pool.lease(&lt;span class=&quot;code-quote&quot;&gt;&quot;somehost&quot;&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dbg(&lt;span class=&quot;code-quote&quot;&gt;&quot;Assigned pool entry &quot;&lt;/span&gt;+&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.identityHashCode(req.get()));
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception fail) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dbg(&lt;span class=&quot;code-quote&quot;&gt;&quot;Getting pool entry failed&quot;&lt;/span&gt;);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; fail.printStackTrace();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160; }.start();
&#160;&#160;&#160; }
&#160;&#160;&#160; sync.arriveAndDeregister();
&#160; }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It generally requires a significant number of threads to make the right timing sequence reliably occur, but I find that on my machine, if I run with command line arg of 300, that causes the code to lock up (because a connection is leaked from the pool, so a thread ends up in an infinite wait) on 50+% of runs.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13250414">HTTPCORE-590</key>
            <summary>LaxConnPool may leak connections</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="linton.miller">Linton Miller</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Aug 2019 04:39:04 +0000</created>
                <updated>Fri, 16 Aug 2019 20:36:44 +0000</updated>
                            <resolved>Fri, 16 Aug 2019 20:36:44 +0000</resolved>
                                    <version>5.0-beta8</version>
                                    <fixVersion>5.0-beta9</fixVersion>
                                    <component>HttpCore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16905813" author="linton.miller" created="Tue, 13 Aug 2019 04:46:18 +0000"  >&lt;p&gt;Suggested fix can be seen at&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/coxlinton/httpcomponents-core/pull/3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/coxlinton/httpcomponents-core/pull/3&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16909348" author="linton.miller" created="Fri, 16 Aug 2019 19:38:27 +0000"  >&lt;p&gt;Pull request against the project repo&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-core/pull/139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-core/pull/139&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16909377" author="jira-bot" created="Fri, 16 Aug 2019 20:36:09 +0000"  >&lt;p&gt;Commit 57ec4b7bc774d5c1a2c2c418444a70a31e5c9582 in httpcomponents-core&apos;s branch refs/heads/master from Linton Miller&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=57ec4b7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=57ec4b7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-590&quot; title=&quot;LaxConnPool may leak connections&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-590&quot;&gt;&lt;del&gt;HTTPCORE-590&lt;/del&gt;&lt;/a&gt; Ensure LaxConnPool doesn&apos;t leak connections&lt;br/&gt;
by testing that lease Future completion is successful.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 13 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z05lhk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>