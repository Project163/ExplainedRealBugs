<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:23:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCORE-442] SSLIOSession + ChunkDecoder: MalformedChunkCodingException with last chunk left in inEncryptedBuffer</title>
                <link>https://issues.apache.org/jira/browse/HTTPCORE-442</link>
                <project id="12310340" key="HTTPCORE">HttpComponents HttpCore</project>
                    <description>&lt;p&gt;I&apos;m running into a rather esoteric problem when reading the response to an HTTP request using &lt;tt&gt;httpcore-nio&lt;/tt&gt; (used via CXF). On a high level we get a MalfromedChunkCodingException because the ChunkDecoder doesn&apos;t receive the last chunk ( &lt;tt&gt;&quot;0\r\n\r\n&quot;&lt;/tt&gt; is missing  ) We see the following situation:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The plain text content fed into the SOAP/JAXB deserialization machinery cuts off mid-way through&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;because&lt;/b&gt; the &lt;tt&gt;ChunkDecoder&lt;/tt&gt; threw a &lt;tt&gt;MalformedChunkCodingException&lt;/tt&gt;&apos;&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;because&lt;/b&gt; &lt;tt&gt;this.buffer.readLine&lt;/tt&gt; returned false&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;because&lt;/b&gt; (not 100% sure here) &lt;tt&gt;fillBufferFromChannel&lt;/tt&gt; returned -1 and we are looking for the next chunk size&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;because&lt;/b&gt; the last 106 bytes of the encrypted stream (see below) have never been decrypted&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;because&lt;/b&gt; the loop inside &lt;tt&gt;SSLIOSession#decryptData&lt;/tt&gt; gets exited early if the &lt;tt&gt;SSLIOSession#endOfStream&lt;/tt&gt; flag is set &lt;em&gt;even if the input stream still contains encrypted data&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;state of the SSLIOSession in `&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.channel` when the exception occurs: 
192.168.13.204:48888&amp;lt;-&amp;gt;10.0.29.106:443[ACTIVE][r:r][ACTIVE][r][NOT_HANDSHAKING][EOF][][106][0][0][0]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looking at past issues/commit messages, I understand why we have an early exit here (avoid infinite loops on connections that broke in the middle of a TLS packet). I&apos;m not sure if just exiting is correct here. The documentation for the java &lt;a href=&quot;https://docs.oracle.com/javase/8/docs/api/javax/net/ssl/SSLEngine.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;SSLEngine#unwrap&lt;/tt&gt;&lt;/a&gt; method says that the engine tries to decrypt &quot;one complete TLS network packet&quot;. There is no guarantee that it decrypts all remaining packets in the buffer.&lt;/p&gt;

&lt;p&gt;In our particular case (106 still encrypted bytes), we have to run the &lt;tt&gt;unwrap&lt;/tt&gt; method two more times until we have the complete response from the server (including the final chunk &quot;&lt;tt&gt;0\r\n\r\n&lt;/tt&gt;&quot;). After the first additional call, there are still 53 encrypted bytes left.&lt;/p&gt;

&lt;p&gt;I have attached a patch that solves this issue for us. The patch monitors whether the decryption loop is making progress and keeps looping even if &lt;tt&gt;endOfStream&lt;/tt&gt; is set. It aborts after a number of iterations without clear progress. With this patch, we can run our entire integration test suite without error. Without this patch, about 1 in SOAP 200 calls fails.&lt;/p&gt;

&lt;p&gt;The &quot;progress measurement&quot; logic could perhaps be simplified (only measure plain bytes, not also consumed encrypted bytes), but I&apos;m not sure if that would still be correct.&lt;/p&gt;

&lt;p&gt;I could also imagine that the actual bug is in the ChunkDecoder, that doesn&apos;t give the Channel another chance at filling the buffer, but the SSLIOSession code looks more suspicious to me (signalling EOF with 106 bytes left encrypted).&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;

&lt;p&gt;This issue occurs with all versions from 4.4.4 to the 4.4.x branch.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13036547">HTTPCORE-442</key>
            <summary>SSLIOSession + ChunkDecoder: MalformedChunkCodingException with last chunk left in inEncryptedBuffer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="olegk">Oleg Kalnichevski</assignee>
                                    <reporter username="chklauser">Christian Klauser</reporter>
                        <labels>
                    </labels>
                <created>Fri, 20 Jan 2017 12:56:41 +0000</created>
                <updated>Mon, 23 Jan 2017 20:25:22 +0000</updated>
                            <resolved>Mon, 23 Jan 2017 20:25:22 +0000</resolved>
                                    <version>4.4.4</version>
                    <version>4.4.5</version>
                    <version>4.4.6</version>
                                    <fixVersion>4.4.7</fixVersion>
                    <fixVersion>5.0-alpha3</fixVersion>
                                    <component>HttpCore NIO</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15831947" author="olegk" created="Fri, 20 Jan 2017 15:30:14 +0000"  >&lt;p&gt;Christian&lt;br/&gt;
I took a cursory look at your patch and it seemed perfectly reasonable to me. I just would like to invest some time into making it somewhat prettier / shorter. &lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="15832273" author="olegk" created="Fri, 20 Jan 2017 19:14:01 +0000"  >&lt;p&gt;Christian,&lt;br/&gt;
Could you please run your code with this chance and let me know if it also fixes the problem?&lt;br/&gt;
&lt;a href=&quot;https://github.com/ok2c/httpcore/commit/3df02cefa1e227e66f56fa4a8f750d7c0291bdb5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ok2c/httpcore/commit/3df02cefa1e227e66f56fa4a8f750d7c0291bdb5&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="15833610" author="chklauser" created="Sun, 22 Jan 2017 17:07:01 +0000"  >&lt;p&gt;Sure, I&apos;ll try that change when I get back to the office tomorrow. It&apos;ll probably solve my problem, but wasn&apos;t there an earlier issue, where the &lt;tt&gt;SSLIOSession&lt;/tt&gt; would run into an endless loop when the stream &lt;b&gt;actually&lt;/b&gt; ended in the middle of the message? I&apos;m thinking of issues like &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-322&quot; title=&quot;SSLIOSession infinite loop after alert during handshake&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-322&quot;&gt;&lt;del&gt;HTTPCORE-322&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Anyway, I&apos;ll try that change and report back. &lt;/p&gt;</comment>
                            <comment id="15833636" author="olegk" created="Sun, 22 Jan 2017 18:34:28 +0000"  >&lt;p&gt;Christian&lt;/p&gt;

&lt;p&gt;Here&apos;s my line of thinking. &lt;tt&gt;SSLIOSession#decryptData&lt;/tt&gt; should try to decrypt available data regardless of the end of stream status as long as it is able to do so without additional input. The loop can be exited if either there is no more encrypted data or an unwrap operations terminates with status other than OK. &lt;/p&gt;

&lt;p&gt;What might cause an infinite loop in &lt;tt&gt;SSLIOSession#decryptData&lt;/tt&gt; or an infinite session loop is a condition when there is incomplete encrypted packet but no more input can be expected due to connection being closed prematurely by the opposite endpoint. I added an extra safe-guard to prevent such condition. Please have a look  &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/ok2c/httpcore/commit/d6ba31dcaea32caeb3914bd68438e2ec0899fffe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ok2c/httpcore/commit/d6ba31dcaea32caeb3914bd68438e2ec0899fffe&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="15834379" author="chklauser" created="Mon, 23 Jan 2017 12:25:56 +0000"  >&lt;p&gt;Hi Oleg,&lt;/p&gt;

&lt;p&gt;I re-ran my test suite (in a loop) with your patch today and I had zero cases of &lt;tt&gt;MalformedChunkCodingException&lt;/tt&gt; in 4000 executed test cases . Before, I would get about one exception per 50 test cases (random). So your version of the fix seems to work perfectly fine for me.&lt;/p&gt;

&lt;p&gt;Christian&lt;/p&gt;</comment>
                            <comment id="15835167" author="olegk" created="Mon, 23 Jan 2017 20:25:22 +0000"  >&lt;p&gt;Fixed committed to SVN trunk and 4.4.x branch.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12848533" name="httpcore-nio-SSLIOSession-eof.path" size="2578" author="chklauser" created="Fri, 20 Jan 2017 12:56:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 42 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i38znj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>