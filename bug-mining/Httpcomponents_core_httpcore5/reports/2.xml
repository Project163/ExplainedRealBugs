<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:23:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCORE-420] Connections left open after HTTP synchronous server shutdown</title>
                <link>https://issues.apache.org/jira/browse/HTTPCORE-420</link>
                <project id="12310340" key="HTTPCORE">HttpComponents HttpCore</project>
                    <description>&lt;p&gt;I have observed the following problem on Linux  with Apache HttpComponents 4.4.1 synchronous server: After calling server.shutdown(42, TimeUnit.MICROSECONDS),  if there are Keep-alive connections opened (there is no request processing), these sockets are not closed. Only ServerSocket is closed:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;netstat -aon | grep 58276&lt;/p&gt;

&lt;p&gt;TCP    127.0.0.1:50658        127.0.0.1:58276        ESTABLISHED     18012&lt;/p&gt;

&lt;p&gt;TCP    127.0.0.1:58276        127.0.0.1:50658        ESTABLISHED     18012&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;In attempt to start again HTTP server on the same port a BindingException is thrown:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Caused by: java.net.BindException: Address already in use&lt;br/&gt;
at java.net.PlainSocketImpl.socketBind(Native Method)&lt;br/&gt;
at java.net.PlainSocketImpl.socketBind(PlainSocketImpl.java:521)&lt;br/&gt;
at java.net.PlainSocketImpl.bind(PlainSocketImpl.java:414)&lt;br/&gt;
at java.net.ServerSocket.bind(ServerSocket.java:326)&lt;br/&gt;
at java.net.ServerSocket.&amp;lt;init&amp;gt;(ServerSocket.java:192)&lt;br/&gt;
at javax.net.DefaultServerSocketFactory.createServerSocket(ServerSocketFactory.java:170)&lt;br/&gt;
at org.apache.http.impl.bootstrap.HttpServer.start(HttpServer.java:116)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;On Windows the behavior is the same , however there is no BindingException and the server starts process requests without any problems.&lt;/p&gt;

&lt;p&gt;One can reproduce the problem using example code from &lt;a href=&quot;https://github.com/anton-k11/apache-tests/tree/master&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/anton-k11/apache-tests/tree/master&lt;/a&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Start the server and the client.&lt;/li&gt;
	&lt;li&gt;Client will send several requests to the server.
	&lt;ul&gt;
		&lt;li&gt;Client will open 2 connections to the server.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;After 1 min. the server will be shutdown.
	&lt;ul&gt;
		&lt;li&gt;Check the open connections on port 9090, the 2 connections between client and server are still open.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;After 1 min. a new Server is started on the same port 9090.
	&lt;ul&gt;
		&lt;li&gt;On Linux this brakes with:
&lt;blockquote&gt;
&lt;p&gt; java.net.BindException: Address already in use&lt;br/&gt;
        at java.net.PlainSocketImpl.socketBind(Native Method)&lt;br/&gt;
        at java.net.AbstractPlainSocketImpl.bind(AbstractPlainSocketImpl.java:387)&lt;br/&gt;
        at java.net.ServerSocket.bind(ServerSocket.java:375)&lt;br/&gt;
        at java.net.ServerSocket.&amp;lt;init&amp;gt;(ServerSocket.java:237)&lt;br/&gt;
        at javax.net.DefaultServerSocketFactory.createServerSocket(ServerSocketFactory.java:231)&lt;br/&gt;
        at org.apache.http.impl.bootstrap.HttpServer.start(HttpServer.java:116)&lt;br/&gt;
        at org.apache.http.examples.server.TestHttpServer.main(TestHttpServer.java:49)&lt;/p&gt;&lt;/blockquote&gt;&lt;/li&gt;
		&lt;li&gt;On Windows this work just fine and the server is started successfully.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment>java version &amp;quot;1.8.0_65&amp;quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.8.0_65-b17)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 25.65-b01, mixed mode)&lt;br/&gt;
Linux 3.0.101-0.47.71-default #1 SMP Thu Nov 12 12:22:22 UTC 2015 (b5b212e) x86_64 x86_64 x86_64 GNU/Linux&lt;br/&gt;
</environment>
        <key id="12954308">HTTPCORE-420</key>
            <summary>Connections left open after HTTP synchronous server shutdown</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="olegk">Oleg Kalnichevski</assignee>
                                    <reporter username="anton_k11">Anton Krosnev</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Mar 2016 15:13:35 +0000</created>
                <updated>Thu, 21 Apr 2016 10:44:15 +0000</updated>
                            <resolved>Thu, 21 Apr 2016 10:44:14 +0000</resolved>
                                    <version>4.4.3</version>
                                    <fixVersion>4.4.5</fixVersion>
                    <fixVersion>5.0-alpha2</fixVersion>
                                    <component>HttpCore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="15221421" author="anton_k11" created="Fri, 1 Apr 2016 09:17:58 +0000"  >&lt;p&gt;The problem is actually in org.apache.http.impl.bootstrap.Worker.run(). The Worker thread is supposed to be stopped by Thread.interrupted() when server.shutdown is called, but it blocks on socket.read() after the response is returned, check the stack below. Worker threads remain in this state until the connection is closed or new request is sent via the same socket or the JVM is terminated. &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Thread &lt;span class=&quot;error&quot;&gt;&amp;#91;HTTP-worker-1&amp;#93;&lt;/span&gt; (Suspended)	&lt;br/&gt;
	org.apache.http.impl.DefaultBHttpServerConnection.receiveRequestHeader() line: 132	&lt;br/&gt;
	org.apache.http.protocol.HttpService.handleRequest(org.apache.http.HttpServerConnection, org.apache.http.protocol.HttpContext) line: 307	&lt;br/&gt;
	org.apache.http.impl.bootstrap.Worker.run() line: 66	&lt;br/&gt;
	java.util.concurrent.ThreadPoolExecutor.runWorker(java.util.concurrent.ThreadPoolExecutor$Worker) line: 1142	&lt;br/&gt;
	java.util.concurrent.ThreadPoolExecutor$Worker.run() line: 617	&lt;br/&gt;
	java.lang.Thread.run() line: 745&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="15222835" author="olegk" created="Sat, 2 Apr 2016 10:14:00 +0000"  >&lt;p&gt;The #shutdown method is actually supposed to force-close all worker threads that remain active after a grace period. See line 165 &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; What is completely puzzling to me is that worker ExecutorService returns an empty list of Runnable-s but I can clearly all see worker threads still being alive and blocked in a read operation. This completely defeats my understanding of how ExecutorService is supposed to work.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://hc.apache.org/httpcomponents-core-ga/httpcore/xref/org/apache/http/impl/bootstrap/HttpServer.html#165&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hc.apache.org/httpcomponents-core-ga/httpcore/xref/org/apache/http/impl/bootstrap/HttpServer.html#165&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15223880" author="anton_k11" created="Mon, 4 Apr 2016 09:42:08 +0000"  >&lt;p&gt;The shutdownNow() from ExecutorService is expected to return only the tasks that are awaiting execution. Java doc says:&lt;br/&gt;
&lt;a href=&quot;https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ExecutorService.html#shutdownNow%28%29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Attempts to stop all actively executing tasks, halts the processing of waiting tasks, and returns a list of the tasks that were awaiting execution.&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15223942" author="olegk" created="Mon, 4 Apr 2016 10:55:10 +0000"  >&lt;p&gt;You are correct. My understanding of the contract was wrong.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="15232168" author="olegk" created="Fri, 8 Apr 2016 13:26:46 +0000"  >&lt;p&gt;Anton,&lt;br/&gt;
Could you please try out this patch &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; and let me know if that fixes the issue for you?&lt;/p&gt;

&lt;p&gt;Oleg&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/ok2c/httpcore/commit/0daa5d1c43ff340e364b7ad474ead09ca7d5c15b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ok2c/httpcore/commit/0daa5d1c43ff340e364b7ad474ead09ca7d5c15b&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15232319" author="anton_k11" created="Fri, 8 Apr 2016 15:18:21 +0000"  >&lt;p&gt;Thanks for the quick fix. I have tested it and it works just fine. All connections are closed on server shutdown, so it can be restarted without any problem.&lt;/p&gt;</comment>
                            <comment id="15251693" author="olegk" created="Thu, 21 Apr 2016 10:44:15 +0000"  >&lt;p&gt;Committed to SVN trunk and 4.4.x branch.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12311020" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>External issue URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[http://stackoverflow.com/questions/36198302/proper-way-to-shutdown-apache-httpcomponents-blocking-http-server]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 30 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2vchb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>