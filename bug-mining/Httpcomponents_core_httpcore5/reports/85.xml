<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:24:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCORE-782] Occasional thread stuck in org.apache.hc.core5.reactor.ssl.SSLIOSession.decryptData</title>
                <link>https://issues.apache.org/jira/browse/HTTPCORE-782</link>
                <project id="12310340" key="HTTPCORE">HttpComponents HttpCore</project>
                    <description>&lt;p&gt;We have a service that is occasionally having a thread get stuck in a state where it consumes as much CPU as possible. The thread will create and release a huge number of objects without causing an overall memory leak.&lt;/p&gt;

&lt;p&gt;We gathered a series of stack traces from this happening on one of our production instances that indicates that the thread is stuck inside of the &quot;while (inEncryptedBuf.hasRemaining()) { &quot; in org.apache.hc.core5.reactor.ssl.SSLIOSession.decryptData(SSLIOSession.java)&lt;/p&gt;

&lt;p&gt;This issue has been happening a couple of times a week for several weeks. We believe that it is always happening against a specific endpoint and are attempting to gather more information about what this endpoint is doing.&lt;/p&gt;

&lt;p&gt;This issue started happening a few weeks ago when we were on a slightly older version of this library. We happened to update to the latest version of these libraries and this is continuing to happen. We have had no success in causing this issue to happen in our testing environments where we could gather a heap dump.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13618216">HTTPCORE-782</key>
            <summary>Occasional thread stuck in org.apache.hc.core5.reactor.ssl.SSLIOSession.decryptData</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Jason Mathison">Jason Mathison</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 May 2025 14:00:04 +0000</created>
                <updated>Wed, 18 Jun 2025 14:35:31 +0000</updated>
                            <resolved>Wed, 18 Jun 2025 09:36:23 +0000</resolved>
                                    <version>5.3.4</version>
                                    <fixVersion>5.3.5</fixVersion>
                    <fixVersion>5.4-alpha1</fixVersion>
                                    <component>HttpCore</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17951772" author="olegk" created="Thu, 15 May 2025 14:31:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Jason+Mathison&quot; class=&quot;user-hover&quot; rel=&quot;Jason Mathison&quot;&gt;Jason Mathison&lt;/a&gt; I do not see anything useful in the stack traces, so there is not really much I can do without a reproducer. &lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17952108" author="olegk" created="Fri, 16 May 2025 13:00:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Jason+Mathison&quot; class=&quot;user-hover&quot; rel=&quot;Jason Mathison&quot;&gt;Jason Mathison&lt;/a&gt; I took another look at the stack traces and i see that they do not appear to be matching the lines in the release tag: &lt;/p&gt;

&lt;p&gt;org.apache.hc.core5.reactor.ssl.SSLIOSession.decryptData(SSLIOSession.java:632)&lt;/p&gt;

&lt;p&gt;I am sorry that makes me doubt if your application is actually running with the official 5.3.4 version of HttpCore.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17952199" author="jason mathison" created="Fri, 16 May 2025 15:29:48 +0000"  >&lt;p&gt;I double checked that our service is configured to use the public org.apache.httpcomponents.core5:httpcore5:5.3.4 version of the library.&lt;/p&gt;

&lt;p&gt;When I looked at the stack dump that included SSLIOSession.java:632 it looks like that line is the final } of the while loop that we are assuming is never finishing. That seemed like a reasonable stack location to me. What is your interpretation?&lt;/p&gt;</comment>
                            <comment id="17952377" author="olegk" created="Sat, 17 May 2025 14:56:24 +0000"  >&lt;p&gt;&amp;gt; That seemed like a reasonable stack location to me. What is your interpretation?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Jason+Mathison&quot; class=&quot;user-hover&quot; rel=&quot;Jason Mathison&quot;&gt;Jason Mathison&lt;/a&gt; You are right. It looks plausible.&lt;/p&gt;

&lt;p&gt;Please apply this patch to your local copy of HttpCore &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; or build it from my private branch &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;, deploy, run, collect the logs, and attach them to this issue.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/ok2c/httpcomponents-core/commit/7ffa29ac0de931e638f6d462aff43e91ca5a068e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ok2c/httpcomponents-core/commit/7ffa29ac0de931e638f6d462aff43e91ca5a068e&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/ok2c/httpcomponents-core/tree/HTTPCORE-782&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ok2c/httpcomponents-core/tree/HTTPCORE-782&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17952611" author="jason mathison" created="Mon, 19 May 2025 13:57:05 +0000"  >&lt;p&gt;Turning this on globally would be very expensive for us.&#160; Would it be enough to capture this tracing while an issue is in progress, or is it important that you get the logging from when the issue first starts?&lt;/p&gt;</comment>
                            <comment id="17952642" author="olegk" created="Mon, 19 May 2025 14:48:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Jason+Mathison&quot; class=&quot;user-hover&quot; rel=&quot;Jason Mathison&quot;&gt;Jason Mathison&lt;/a&gt; I cannot make miracles, can I? If we are lucky, just a snippet of the log may be enough. If not, I would either need a reproducer I can execute locally or a log detailed enough for me to be able to figure out the cause of the problem.&lt;/p&gt;

&lt;p&gt;Please let me also know the &lt;em&gt;exact&lt;/em&gt; version of the JRE &lt;em&gt;and&lt;/em&gt; the JSSE provider you are using.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17952699" author="jason mathison" created="Mon, 19 May 2025 18:05:52 +0000"  >&lt;p&gt;We are trying everything we can think of to reproduce this issue, but have been unable to break this at all. I realize that makes it REALLY hard to solve this, I just didn&apos;t want to go through the effort of being able to gather more logs, but have them not be useful to you. Sounds like it could be useful, so I will start work on getting it in place.&lt;/p&gt;

&lt;p&gt;The service instances are running on AWS Graviton (ARM) processors with the AWS Corretto OpenJDK 64-Bit Server VM Corretto-17.0.15.6.1 (build 17.0.15+6-LTS, mixed mode, sharing)&lt;/p&gt;

&lt;p&gt;Working on the JSSE provider, but that could be a bit to nail down.&lt;/p&gt;</comment>
                            <comment id="17952946" author="jason mathison" created="Tue, 20 May 2025 18:37:14 +0000"  >&lt;p&gt;We are using the stock Sun JSSE that comes with the JRE.&lt;/p&gt;</comment>
                            <comment id="17955142" author="olegk" created="Fri, 30 May 2025 08:13:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Jason+Mathison&quot; class=&quot;user-hover&quot; rel=&quot;Jason Mathison&quot;&gt;Jason Mathison&lt;/a&gt; Please re-open if you manage to reproduce the problem in a controlled environment.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17980458" author="jason mathison" created="Tue, 17 Jun 2025 17:05:39 +0000"  >&lt;p&gt;We had another customer reoccurrence that allowed us to gather the debug tracing you asked for. We could not gather the tracing from the start of incident due to the overwhelming amount of logging that would require, but did capture it for a couple of seconds while the issue was happening.&lt;/p&gt;

&lt;p&gt;We got these exact messages 15,034 times each in about 7 seconds.&lt;/p&gt;

&lt;p&gt;&quot;TLS decrypt; encrypted remaining = 4380&quot;&lt;/p&gt;

&lt;p&gt;&quot;TLS decrypt; status = OK; handshake = NEED_TASK; bytesConsumed = 0; bytesProduced = 0; end of stream = false&quot;&lt;/p&gt;

&lt;p&gt;The endpoint is using TLS 1.2.&lt;/p&gt;

&lt;p&gt;We have a deploy going out now that will short circuit based on no data being decrypted, which does seem like it would stop this sort of runaway thread.&#160; Would there be any use /way to try to trace out the delegated tasks that &quot;NEED_TASK&quot; implies are being waited on?&lt;/p&gt;</comment>
                            <comment id="17981829" author="olegk" created="Wed, 18 Jun 2025 08:38:31 +0000"  >&lt;p&gt;&amp;gt; &quot;TLS decrypt; status = OK; handshake = NEED_TASK; bytesConsumed = 0; bytesProduced = 0; end of stream = false&quot;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Jason+Mathison&quot; class=&quot;user-hover&quot; rel=&quot;Jason Mathison&quot;&gt;Jason Mathison&lt;/a&gt; Curious. At the very least it fully explains the event loop in the TLS layer. I will look into it.&lt;/p&gt;

&lt;p&gt;&amp;gt; Would there be any use /way to try to trace out the delegated tasks that &quot;NEED_TASK&quot; implies are being waited on?&lt;/p&gt;

&lt;p&gt;Yes, there would. It would be very helpful to know what kind of potentially blocking task the TLS session requires.&#160;&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17981840" author="jira-bot" created="Wed, 18 Jun 2025 09:28:58 +0000"  >&lt;p&gt;Commit 4b596d71a3ade0107c6096ab1f606f2bc4a4ffa1 in httpcomponents-core&apos;s branch refs/heads/master from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=4b596d71a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=4b596d71a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-782&quot; title=&quot;Occasional thread stuck in org.apache.hc.core5.reactor.ssl.SSLIOSession.decryptData&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-782&quot;&gt;&lt;del&gt;HTTPCORE-782&lt;/del&gt;&lt;/a&gt;: non-blocking TLS session can end up in an endless loop in case of a protocol negotiation&lt;/p&gt;</comment>
                            <comment id="17981842" author="jira-bot" created="Wed, 18 Jun 2025 09:33:45 +0000"  >&lt;p&gt;Commit f6eaeeb449ee982d109e909ff24f602779fe576d in httpcomponents-core&apos;s branch refs/heads/5.3.x from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=f6eaeeb44&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=f6eaeeb44&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-782&quot; title=&quot;Occasional thread stuck in org.apache.hc.core5.reactor.ssl.SSLIOSession.decryptData&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-782&quot;&gt;&lt;del&gt;HTTPCORE-782&lt;/del&gt;&lt;/a&gt;: non-blocking TLS session can end up in an endless loop in case of a protocol negotiation&lt;/p&gt;</comment>
                            <comment id="17981843" author="olegk" created="Wed, 18 Jun 2025 09:36:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Jason+Mathison&quot; class=&quot;user-hover&quot; rel=&quot;Jason Mathison&quot;&gt;Jason Mathison&lt;/a&gt; I think the most likely reason for this behavior is the opposite endpoint requesting protocol re-negotiation. From what understand protocol re-negotiation is considered a bad practice, but I may be wrong.&#160;&lt;/p&gt;

&lt;p&gt;Anyway, the endless loop problem should now be resolved properly. Please upgrade to the latest 5.3.x SNAPSHOT and let me know if the problem still persists.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17982716" author="patrickjamesbarry" created="Wed, 18 Jun 2025 14:06:10 +0000"  >&lt;p&gt;Hi Oleg,&lt;/p&gt;

&lt;p&gt;I work with Jason.&#160; Would it help to log or include in an exception, what task it was held up on?&lt;/p&gt;

&lt;p&gt;something like:&#160;&lt;/p&gt;

&lt;p&gt;sslEngine.getDelegatedTask().getClass().getName()&lt;/p&gt;</comment>
                            <comment id="17982721" author="olegk" created="Wed, 18 Jun 2025 14:35:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=patrickjamesbarry&quot; class=&quot;user-hover&quot; rel=&quot;patrickjamesbarry&quot;&gt;patrickjamesbarry&lt;/a&gt; It may not produce anything useful. What would be helpful is the TLS handshake log but this may be too much to ask in PROD environment. I am quite sure this issue is caused by TLS protocol re-negotiation.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13076523" name="Thread Stack Traces" size="15354" author="Jason Mathison" created="Thu, 15 May 2025 14:00:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            20 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1vvaw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>