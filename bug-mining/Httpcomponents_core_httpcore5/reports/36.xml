<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:24:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCORE-589] LaxConnPool may not allocate available connection</title>
                <link>https://issues.apache.org/jira/browse/HTTPCORE-589</link>
                <project id="12310340" key="HTTPCORE">HttpComponents HttpCore</project>
                    <description>&lt;p&gt;The LaxConnPool can fail to allocate available connections from the pool in rare circumstances.&lt;/p&gt;

&lt;p&gt;The issue happens when 2 threads execute concurrently; one requesting a lease while another releases a pool entry.&lt;/p&gt;

&lt;p&gt;Thread 1&lt;br/&gt;
future = lease&lt;br/&gt;
&#160; getAvailableEntry = null&lt;br/&gt;
&#160; allocatePoolEntry = false&lt;br/&gt;
&#160; &amp;lt;about to add a LeaseRequest to pending queue&amp;gt;&lt;br/&gt;
Thread 2&lt;br/&gt;
release&lt;br/&gt;
&#160; removeLeased&lt;br/&gt;
&#160; available.add&lt;br/&gt;
&#160; servicePendingRequest&lt;br/&gt;
&#160;&#160;&#160; while (pending.poll() != null)&#160; does nothing because pending queue is empty&lt;br/&gt;
&#160; &amp;lt;release call completed, with an entry now in the available list&amp;gt;&lt;br/&gt;
Thread 1&lt;br/&gt;
&#160; pending.add(new LeaseRequest())&lt;br/&gt;
&#160; &amp;lt;lease call completed, with an unsatisfied future&amp;gt;&lt;br/&gt;
future.get()&lt;/p&gt;

&lt;p&gt;And now Thread 1 is blocked until there is another release call, even though there is actually an available connection in the pool.&lt;/p&gt;

&lt;p&gt;The problem arises because there is a window between checking for an available pool entry and registering on the pending request queue. In that window, the statte of the pool can change.&lt;/p&gt;

&lt;p&gt;Recreating this problem is test is extremely difficult, because the window for failure is really very small. I&apos;ve only be able to observe the error in running code by introducing synchronization or delay (as small as 3ms, but still needed) into the pool code just before the lease pending.add, so as to ensure the necessary timing condition between threads exist. My test class:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hc.core5.io.ModalCloseable;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hc.core5.io.CloseMode;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hc.core5.pool.PoolEntry;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hc.core5.pool.LaxConnPool;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hc.core5.pool.PoolEntry;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hc.core5.util.TimeValue;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.concurrent.Future;


&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;PoolPendTest {

&#160; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestConn &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; ModalCloseable {
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() {
&#160;&#160;&#160; }
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close(CloseMode mode) {
&#160;&#160;&#160; }
&#160; }

&#160; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; LaxConnPool&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,TestConn&amp;gt; pool;

&#160; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void dbg(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; msg) {
&#160;&#160;&#160; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getName()+&lt;span class=&quot;code-quote&quot;&gt;&quot;: &quot;&lt;/span&gt;+&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis()+&lt;span class=&quot;code-quote&quot;&gt;&quot;: &quot;&lt;/span&gt;+msg);
&#160; }

&#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; poolSize = 1;
&#160;&#160;&#160; pool = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FixPendPool&amp;lt;&amp;gt;(poolSize);
&#160;&#160;&#160; &lt;span class=&quot;code-comment&quot;&gt;// Create a pool entry purely to prime &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;loading
&lt;/span&gt;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PoolEntry&amp;lt;&amp;gt;(&quot;&quot;, TimeValue.NEG_ONE_MILLISECONDS);
&#160;&#160; &#160;
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0;i&amp;lt;poolSize*2;i++) {
&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;req-%04d&quot;&lt;/span&gt;, i)) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160; @Override
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dbg(&lt;span class=&quot;code-quote&quot;&gt;&quot;Started&quot;&lt;/span&gt;);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Future&amp;lt;PoolEntry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,TestConn&amp;gt;&amp;gt; req = pool.lease(&lt;span class=&quot;code-quote&quot;&gt;&quot;somehost&quot;&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; PoolEntry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,TestConn&amp;gt; entry = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (req.isDone()) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; entry = req.get();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!entry.hasConnection()) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; entry.assignConnection(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TestConn());
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pool.release(entry, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dbg(&lt;span class=&quot;code-quote&quot;&gt;&quot;Released pool entry &quot;&lt;/span&gt;+&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.identityHashCode(entry));
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception shouldNotHappen) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dbg(&lt;span class=&quot;code-quote&quot;&gt;&quot;Should not happen!&quot;&lt;/span&gt;);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; shouldNotHappen.printStackTrace();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dbg(&lt;span class=&quot;code-quote&quot;&gt;&quot;Assigned pool entry &quot;&lt;/span&gt;+&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.identityHashCode(req.get()));
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception fail) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dbg(&lt;span class=&quot;code-quote&quot;&gt;&quot;Getting pool entry failed&quot;&lt;/span&gt;);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; fail.printStackTrace();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160;&#160;&#160; }
&#160;&#160;&#160;&#160;&#160; }.start();
&#160;&#160;&#160; }
&#160; }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When I modify the LaxConnPool code to add a 3ms delay just before adding to the pend queue:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; { &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(3); } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException onward) {}
&#160;&#160;&#160; pending.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LeaseRequest&amp;lt;&amp;gt;(state, requestTimeout, &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;then the test class blocks with an infinite wait where the pool contains a returned connection, but it&apos;s never assigned to the second thread.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13250179">HTTPCORE-589</key>
            <summary>LaxConnPool may not allocate available connection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="linton.miller">Linton Miller</reporter>
                        <labels>
                    </labels>
                <created>Mon, 12 Aug 2019 04:45:39 +0000</created>
                <updated>Fri, 16 Aug 2019 07:55:19 +0000</updated>
                            <resolved>Fri, 16 Aug 2019 07:55:19 +0000</resolved>
                                    <version>5.0-beta8</version>
                                    <fixVersion>5.0-beta9</fixVersion>
                                    <component>HttpCore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="16904846" author="linton.miller" created="Mon, 12 Aug 2019 04:55:16 +0000"  >&lt;p&gt;Suggested fix in&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-core/pull/137&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-core/pull/137&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16905050" author="olegk" created="Mon, 12 Aug 2019 10:20:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=linton.miller&quot; class=&quot;user-hover&quot; rel=&quot;linton.miller&quot;&gt;linton.miller&lt;/a&gt; I am in full agreement as far as your analysis is concerned but I cannot quite wrap my head around your solution. I would like to see if there is a simpler (less intrusive way) of achieving the same.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="16905548" author="linton.miller" created="Mon, 12 Aug 2019 20:06:27 +0000"  >&lt;p&gt;I&apos;m certainly open to alternatives, but I couldn&apos;t see a better choice when I was working it.&lt;/p&gt;

&lt;p&gt;I thought I&apos;d done OK at not being too intrusive or expensive with the fix &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Basically all it amounts to is when allocating a connection, wrapping the modification of the pool state in something that allows us to detect if there was a concurrent release. If so, after we&apos;ve finished modifying the pool, if we end up pended, we should immediately check to see if the release allows us to fulfill our pend.&lt;/p&gt;

&lt;p&gt;I achieve the detection of a concurrent release by using a Long that&apos;s simply incremented with each release. Thus if the long isn&apos;t the same when you finish connection allocation as when you started, you know there was a concurrent release done during your allocation and you should check pending.&lt;/p&gt;

&lt;p&gt;So fundamentally the change is just when allocating a connection (in lease and in servicePendRequest) &lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; releaseState = releaseSeqNum.get();


&#160; ... &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; connection allocation ...
&#160; &amp;lt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; allocation fails&amp;gt;
&#160;&#160;&#160;&#160;&#160; &amp;lt;pending.add&amp;gt;

&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (releaseState != releaseSeqNum.get()) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; servicePendingRequest();
&#160;&#160;&#160;&#160;&#160; }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And when releasing a connection (in release and enumAvailable) :&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; .... release connection and update pool state ...
&#160; releaseSeqNum.incrementAndGet(); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The rest of the mods are just minor code tweaks and simplifications I made while getting this in place. e.g. cleaning up the allocation code so the allocation process reads more straight-forwardly:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;&#160;&#160; PoolEntry&amp;lt;T, C&amp;gt; entry = getAvailableEntry(state);
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (entry == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; pending.isEmpty()) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160; entry = createPoolEntry();
&#160;&#160;&#160; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;is a concise and tidy expression of allocating a pool entry, separate from what is then done with that pool entry. Creating a pool entry is completely handled in one abstracted location rather than splitting the allocation and actual creation.&lt;/p&gt;

&lt;p&gt;And then the actions for assigning that allocated entry are only in a single place, with linear code flow:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (entry != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160; addLeased(entry);
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;.completed(entry);
&#160;&#160;&#160; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;rather than copied and repeated for each of the different ways a pool entry might be obtained.&lt;/p&gt;</comment>
                            <comment id="16906012" author="olegk" created="Tue, 13 Aug 2019 09:39:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=linton.miller&quot; class=&quot;user-hover&quot; rel=&quot;linton.miller&quot;&gt;linton.miller&lt;/a&gt; Please do not get me wrong. I am not saying your fix wrong or too complex, I just need time to understand it better. &lt;/p&gt;

&lt;p&gt;What probably throws me off a bit is that &lt;tt&gt;#servicePendingRequests&lt;/tt&gt; method has been made modal. I generally dislike methods that take boolean parameters because I always find hard to remember what operational mode true and false values represent.&lt;/p&gt;</comment>
                            <comment id="16906701" author="linton.miller" created="Tue, 13 Aug 2019 23:04:52 +0000"  >&lt;p&gt;Fair enough. I could create a two-valued private enum to replace the boolean, which would make the method invocations more documentary because you don&apos;t have to find the method definition to see what the boolean means.&lt;/p&gt;

&lt;p&gt;The flag controls whether the servicePendingRequests tries to process the entire pending queue, or quits after allocating a single pool entry. That&apos;s because it&apos;s called from 2 different contexts:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;release, where only a single entry has been added to the pool, so there&apos;s no point trying to allocate more than one entry to pending connections.&lt;/li&gt;
	&lt;li&gt;enumAvailable, where it may have disposed multiple entries, meaning it should try and service as many pending requests as it can.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Truth is that trying to service the entire queue is a superset of just servicing one entry, and there would never be any harm in always trying to service the entire queue every time (indeed, you could even argue it would be a safety mechanism against other pooling bugs). The only reason to short-circuit and quit after one request is just to save a bit of work in the normal workflow of a release (it avoids popping a request off the pending queue, finding no available entries, then immediately pushing the request back on pending; it also avoids possible reshuffling of the pending queue order in a busy system that might make a thread wait longer than &quot;fair&quot;, even though there are no guarantees of fairness in the pool).&lt;/p&gt;</comment>
                            <comment id="16907314" author="olegk" created="Wed, 14 Aug 2019 14:37:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=linton.miller&quot; class=&quot;user-hover&quot; rel=&quot;linton.miller&quot;&gt;linton.miller&lt;/a&gt;&#160;Let us make &lt;tt&gt;#servicePendingRequests take&lt;/tt&gt;&#160;an enum instead of a boolean and&#160;I will commit the change-set.&lt;/p&gt;</comment>
                            <comment id="16908818" author="jira-bot" created="Fri, 16 Aug 2019 07:31:33 +0000"  >&lt;p&gt;Commit 68a1d783314de5e53291f3f7361125089d6044e6 in httpcomponents-core&apos;s branch refs/heads/master from Linton Miller&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=68a1d78&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=68a1d78&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-589&quot; title=&quot;LaxConnPool may not allocate available connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-589&quot;&gt;&lt;del&gt;HTTPCORE-589&lt;/del&gt;&lt;/a&gt; Fix LaxConnPool to ensure available connections are&lt;br/&gt;
assigned to pending requests whenever possible.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 13 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z05k1c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>