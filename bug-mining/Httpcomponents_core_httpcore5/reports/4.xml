<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:23:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCORE-422] BasicAsyncResponseConsumer#onEntityEnclosed is triggered for HEAD responses</title>
                <link>https://issues.apache.org/jira/browse/HTTPCORE-422</link>
                <project id="12310340" key="HTTPCORE">HttpComponents HttpCore</project>
                    <description>&lt;p&gt;HttpAsyncRequestExecutor#responseReceived(NHttpClientConnection) calls HttpAsyncResponseConsumer#responseReceived(HttpResponse) via HttpAsyncClientExchangeHandler#responseReceived(HttpResponse).&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;https://github.com/apache/httpcore/blob/4.4.x/httpcore-nio/src/main/java/org/apache/http/nio/protocol/HttpAsyncRequestExecutor.java#L302&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcore/blob/4.4.x/httpcore-nio/src/main/java/org/apache/http/nio/protocol/HttpAsyncRequestExecutor.java#L302&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;It does this even if the request is a HEAD request. If your HttpAsyncResponseConsumer is a BasicAsyncResponseConsumer, then this will allocate a buffer of size content-length kB (or 4kB, if content-length does not exist).&lt;/p&gt;

&lt;p&gt;For a simple proxying Java app, profiling revealed this the allocation due to this was a bottleneck.&lt;/p&gt;

&lt;p&gt;It&apos;d be nice if &lt;/p&gt;

&lt;p&gt;Are there use cases for calling HttpAsyncResponseConsumer#responseReceived(HttpResponse) on HEAD requests? If not, perhaps it could not be called.&lt;/p&gt;

&lt;p&gt;FWIW, it looks like httpclient doe not call the corresponding method for HEAD requests: &lt;a href=&quot;https://github.com/apache/httpcore/blob/4.4.x/httpcore/src/main/java/org/apache/http/protocol/HttpRequestExecutor.java#L273-L275&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcore/blob/4.4.x/httpcore/src/main/java/org/apache/http/protocol/HttpRequestExecutor.java#L273-L275&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12974263">HTTPCORE-422</key>
            <summary>BasicAsyncResponseConsumer#onEntityEnclosed is triggered for HEAD responses</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="olegk">Oleg Kalnichevski</assignee>
                                    <reporter username="tomfitzhenry">Tom Fitzhenry</reporter>
                        <labels>
                    </labels>
                <created>Tue, 31 May 2016 15:50:08 +0000</created>
                <updated>Sat, 18 Jun 2016 12:19:04 +0000</updated>
                            <resolved>Sat, 18 Jun 2016 12:19:04 +0000</resolved>
                                    <version>4.4.5</version>
                                    <fixVersion>4.4.6</fixVersion>
                    <fixVersion>5.0-alpha2</fixVersion>
                                    <component>HttpCore NIO</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="15307953" author="tomfitzhenry" created="Tue, 31 May 2016 15:50:26 +0000"  >&lt;p&gt;I can produce a test case if my desciption wasn&apos;t good enough.&lt;/p&gt;</comment>
                            <comment id="15307962" author="tomfitzhenry" created="Tue, 31 May 2016 15:51:31 +0000"  >&lt;p&gt;My workaround is to pass a NoopResponseConsumer, rather than a BasicAsyncResponseConsumer:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;NoopResponseConsumer &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; AbstractAsyncResponseConsumer&amp;lt;HttpResponse&amp;gt; {

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; HttpResponse response;

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void onResponseReceived(HttpResponse response) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; HttpException, IOException {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.response = response;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void onContentReceived(ContentDecoder decoder, IOControl ioctrl) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void onEntityEnclosed(HttpEntity entity, ContentType contentType) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; HttpResponse buildResult(HttpContext context) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; response;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void releaseResources() {

    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15320366" author="olegk" created="Wed, 8 Jun 2016 10:43:25 +0000"  >&lt;p&gt;Tom&lt;br/&gt;
I am not sure I fully understand the issue. The contract of &lt;tt&gt;HttpAsyncResponseConsumer&lt;/tt&gt; interface is described &lt;a href=&quot;http://hc.apache.org/httpcomponents-core-4.4.x/tutorial/html/nio.html#d5e1173&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. The &lt;tt&gt;#responseReceived&lt;/tt&gt; method should be called for all types of messages when the message head is received. The &lt;tt&gt;#consumeContent&lt;/tt&gt; method should be called for messages with an enclosed entity. &lt;/p&gt;

&lt;p&gt;Why would not one want to have &lt;tt&gt;#responseReceived&lt;/tt&gt; method called for a response to HEAD request? This would effectively prevent the caller from getting hold of response status code and response headers.&lt;/p&gt;

&lt;p&gt;Am I missing something?&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;
</comment>
                            <comment id="15325817" author="tomfitzhenry" created="Sat, 11 Jun 2016 11:13:18 +0000"  >&lt;p&gt;Sorry, you&apos;re right: not calling #responseReceived would be a bad idea.&lt;/p&gt;

&lt;p&gt;The problem is that BasicAsyncResponseConsumer#responseReceived allocates a 4kB buffer for the response entity, even if the request is a HEAD request (and hence will have no response entity). This is unnecessary allocation. There are two things that could be done to avoid this:&lt;br/&gt;
(a) BasicAsyncResponseConsumer could allocate in onContentReceived (which presumably is not called for HEAD responses, and hence no response entity allocation would occur for HEAD responses), OR&lt;br/&gt;
(b) Users should not use BasicAsyncResponseConsumer for HEAD requests, and instead should use a response consumer that does not allocate a response entity. (e.g. the NoopResponseConsumer I listed above).&lt;/p&gt;

&lt;p&gt;I&apos;m currently doing (b), which I&apos;m happy to do, but (a) would benefit all users of Apache HttpAsyncClient that use BasicAsyncResponseConsumer with HEAD requests.&lt;/p&gt;</comment>
                            <comment id="15331908" author="olegk" created="Wed, 15 Jun 2016 15:21:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;The problem is that BasicAsyncResponseConsumer#responseReceived allocates a 4kB buffer for the response entity, even if the request is a HEAD request (and hence will have no response entity). &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Tom, are you sure about it? &lt;tt&gt;BasicAsyncResponseConsumer&lt;/tt&gt; should allocate a buffer in response to &lt;tt&gt;#onEntityEnclosed&lt;/tt&gt; event, which should never get triggered for HEAD requests.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/httpcore/blob/4.4.x/httpcore-nio/src/main/java/org/apache/http/nio/protocol/BasicAsyncResponseConsumer.java#L74&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcore/blob/4.4.x/httpcore-nio/src/main/java/org/apache/http/nio/protocol/BasicAsyncResponseConsumer.java#L74&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15332127" author="tomfitzhenry" created="Wed, 15 Jun 2016 17:20:08 +0000"  >&lt;p&gt;&lt;tt&gt;#onEntityEnclosed&lt;/tt&gt; &lt;b&gt;is&lt;/b&gt; triggered for HEAD requests.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.http.HttpEntity;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.http.HttpResponse;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.http.client.methods.HttpHead;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.http.entity.ContentType;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.http.impl.nio.client.CloseableHttpAsyncClient;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.http.impl.nio.client.HttpAsyncClients;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.http.nio.client.methods.HttpAsyncMethods;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.http.nio.protocol.BasicAsyncResponseConsumer;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.http.nio.protocol.HttpAsyncRequestProducer;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.IOException;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.concurrent.ExecutionException;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.concurrent.Future;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Main {

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, ExecutionException, InterruptedException {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (CloseableHttpAsyncClient foo = HttpAsyncClients.createDefault()) {
            foo.start();

            HttpHead request = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HttpHead(&lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//httpbin.org&quot;&lt;/span&gt;);
&lt;/span&gt;
            Future&amp;lt;HttpResponse&amp;gt; response;
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (HttpAsyncRequestProducer httpHead = HttpAsyncMethods.create(request)) {
                response = foo.execute(httpHead, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BasicAsyncResponseConsumer() {
                    @Override
                    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void onEntityEnclosed(HttpEntity entity, ContentType contentType) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
                        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;onEntityEnclosed!&quot;&lt;/span&gt;);
                        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(entity);
                        &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.onEntityEnclosed(entity, contentType);
                    }
                }, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
            }

            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(response.get());
        }
    }

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When the above is executed, it prints:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;onEntityEnclosed!
[Content-Type: text/html; charset=utf-8,Content-Length: 12150,Chunked: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;]
HTTP/1.1 200 OK [Server: nginx, Date: Wed, 15 Jun 2016 17:16:34 GMT, Content-Type: text/html; charset=utf-8, Content-Length: 12150, Connection: keep-alive, Access-Control-Allow-Origin: *, Access-Control-Allow-Credentials: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It sounds like that is a bug, but once resolved will remove the need for a NoopResponseConsumer.&lt;/p&gt;</comment>
                            <comment id="15333411" author="olegk" created="Thu, 16 Jun 2016 09:08:30 +0000"  >&lt;p&gt;Could you please try out this patch and let me know if that resolves the issue for you?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/ok2c/httpcore/commit/f1135662c5b9d4e8d7a9b4ccd3228139163eca57&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ok2c/httpcore/commit/f1135662c5b9d4e8d7a9b4ccd3228139163eca57&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="15333463" author="tomfitzhenry" created="Thu, 16 Jun 2016 09:44:35 +0000"  >&lt;p&gt;Yes, that works. Great! Reassuringly, when I ran the above code, but with a GET instead of a HEAD, &lt;tt&gt;#onEntityEnclosed&lt;/tt&gt; was called as we expect.&lt;/p&gt;</comment>
                            <comment id="15337802" author="olegk" created="Sat, 18 Jun 2016 12:19:04 +0000"  >&lt;p&gt;Committed to SVN trunk and 4.4.x branch.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 22 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yqun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>