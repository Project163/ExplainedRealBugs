<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:24:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCORE-753] race condition with CapacityWindow resulting in CancelKeyException</title>
                <link>https://issues.apache.org/jira/browse/HTTPCORE-753</link>
                <project id="12310340" key="HTTPCORE">HttpComponents HttpCore</project>
                    <description>&lt;p&gt;We have found a race condition AbstractHttp1StreamDuplexer where the IOSessionImpl is closed off (cancelling it&apos;s SelectionKey) first before CapacityWindow (which also has a reference to the IOSession) is closed. This creates a window of opportunity where if a ResponseConsumer (something like AbstractClassicEntityConsumer) holds a reference to the CapacityWindow and tries to call update(), it will result in a CancelledKeyException being thrown. We are running into this issue fairly regularly.&lt;/p&gt;

&lt;p&gt;Here is what I believe the fix is: in AbstractHttp1StreamDuplexer.onInput the following two lines should be swapped:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;dataEnd(contentDecoder.getTrailers());&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;capacityWindow.close();&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Close the capacityWindow first before calling dataEnd which closes off the connection, thus the capacityWindow will always be safe to use.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In case this is helpful, here is the callstack for when the connection is closed and the SelectionKey becomes invalid:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;close:266, IOSessionImpl (org.apache.hc.core5.reactor)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;close:266, InternalDataChannel (org.apache.hc.core5.reactor)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;close:254, InternalDataChannel (org.apache.hc.core5.reactor)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;shutdownSession:157, AbstractHttp1StreamDuplexer (org.apache.hc.core5.http.impl.nio)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;close:116, ClientHttp1StreamDuplexer$1 (org.apache.hc.core5.http.impl.nio)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;dataEnd:277, ClientHttp1StreamHandler (org.apache.hc.core5.http.impl.nio)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;dataEnd:366, ClientHttp1StreamDuplexer (org.apache.hc.core5.http.impl.nio)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;onInput:333, AbstractHttp1StreamDuplexer (org.apache.hc.core5.http.impl.nio)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;inputReady:64, AbstractHttp1IOEventHandler (org.apache.hc.core5.http.impl.nio)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;inputReady:39, ClientHttp1IOEventHandler (org.apache.hc.core5.http.impl.nio)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;onIOEvent:131, InternalDataChannel (org.apache.hc.core5.reactor)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;handleIOEvent:51, InternalChannel (org.apache.hc.core5.reactor)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;processEvents:178, SingleCoreIOReactor (org.apache.hc.core5.reactor)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;doExecute:127, SingleCoreIOReactor (org.apache.hc.core5.reactor)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;execute:85, AbstractSingleCoreIOReactor (org.apache.hc.core5.reactor)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;run:44, IOReactorWorker (org.apache.hc.core5.reactor)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;run:829, Thread (java.lang)&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In the interim, is it safe to catch and discard the CancelledKeyException when calling update on the CapacityChannel?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13540841">HTTPCORE-753</key>
            <summary>race condition with CapacityWindow resulting in CancelKeyException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mns">Malay Shah</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 Jun 2023 05:25:42 +0000</created>
                <updated>Wed, 20 Sep 2023 17:13:59 +0000</updated>
                            <resolved>Thu, 29 Jun 2023 17:02:56 +0000</resolved>
                                    <version>5.1.3</version>
                                    <fixVersion>5.2.3</fixVersion>
                    <fixVersion>5.3-alpha1</fixVersion>
                                    <component>HttpCore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17736383" author="olegk" created="Fri, 23 Jun 2023 07:42:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mns&quot; class=&quot;user-hover&quot; rel=&quot;mns&quot;&gt;mns&lt;/a&gt; I honestly do not understand how swapping those two lines should make any difference.&lt;/p&gt;

&lt;p&gt;Please upgrade to HttpCore 5.2.2, reproduce the issue and provide the complete log of the session and the complete exception stack trace.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17737385" author="mns" created="Mon, 26 Jun 2023 23:26:24 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; I am working to capture the logs you&apos;ve asked for, I haven&apos;t been able to reproduce it locally, we ran into it with some frequency on our CI/CD servers that were under more stress. I&apos;m still working on trying to get you that information, but I do have the call stack from the CancelledKeyException we caught on the server, see below.&lt;/p&gt;

&lt;p&gt;Looking at the code more, I&apos;m not sure either if swapping those two lines of code will solve the issue. It looks like to get into this situation, the IOSessionImpl must not be closed, but the SelectionKey is invalid.&lt;/p&gt;


&lt;p&gt;&lt;tt&gt;09:25:16 org.opentest4j.AssertionFailedError: failed with errorjava.nio.channels.CancelledKeyException at:&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;09:25:16 java.nio.channels.CancelledKeyException&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;09:25:16 at java.base/sun.nio.ch.SelectionKeyImpl.ensureValid(SelectionKeyImpl.java:71)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;09:25:16 at java.base/sun.nio.ch.SelectionKeyImpl.interestOps(SelectionKeyImpl.java:96)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;09:25:16 at org.apache.hc.core5.reactor.IOSessionImpl.setEvent(IOSessionImpl.java:168)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;09:25:16 at org.apache.hc.core5.reactor.InternalDataChannel.setEvent(InternalDataChannel.java:335)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;09:25:16 at org.apache.hc.core5.http.impl.nio.AbstractHttp1StreamDuplexer$CapacityWindow.update(AbstractHttp1StreamDuplexer.java:625)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;09:25:16 at com.company.webapi.CorrectedCapacityTrackingGrowthSharedInputBuffer.incrementCapacity(CorrectedCapacityTrackingGrowthSharedInputBuffer.java:125)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;09:25:16 at com.company.webapi.CorrectedCapacityTrackingGrowthSharedInputBuffer.read(CorrectedCapacityTrackingGrowthSharedInputBuffer.java:197)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;09:25:16 at org.apache.hc.core5.http.nio.support.classic.ContentInputStream.read(ContentInputStream.java:57)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;09:25:16 at com.company.webapi.InputStreamClassicResponseConsumer$CheckForErrorInputStream.lambda$read$1(InputStreamClassicResponseConsumer.java:280)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;09:25:16 at com.company.webapi.InputStreamClassicResponseConsumer$CheckForErrorInputStream.callWhileCheckingForErrors(InputStreamClassicResponseConsumer.java:254)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;09:25:16 at com.company.webapi.InputStreamClassicResponseConsumer$CheckForErrorInputStream.read(InputStreamClassicResponseConsumer.java:280)&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17737406" author="mns" created="Tue, 27 Jun 2023 01:34:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; I think I have found the race condition. It is two threads calling into IOSessionImpl&apos;s SetEvent and Close concurrently. Here is the code for the two methods side-by-side to show the sequence that leads to the problem:&lt;/p&gt;

&lt;p&gt;&amp;lt;&amp;lt;edit: that did not visualize well, attaching instead&amp;gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Basically, the IO Reactor thread cancels the Key, and then the consumer thread, in the process of doing a CapacityChannel.update, calls setEvent.&lt;/p&gt;

&lt;p&gt;One solution may be to lock in the close method.&lt;/p&gt;</comment>
                            <comment id="17737584" author="jira-bot" created="Tue, 27 Jun 2023 11:01:41 +0000"  >&lt;p&gt;Commit a15a5c1a797ff08579648677796563bbfde089bc in httpcomponents-core&apos;s branch refs/heads/&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-753&quot; title=&quot;race condition with CapacityWindow resulting in CancelKeyException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-753&quot;&gt;&lt;del&gt;HTTPCORE-753&lt;/del&gt;&lt;/a&gt; from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=a15a5c1a7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=a15a5c1a7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-753&quot; title=&quot;race condition with CapacityWindow resulting in CancelKeyException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-753&quot;&gt;&lt;del&gt;HTTPCORE-753&lt;/del&gt;&lt;/a&gt;: fixed race condition in the IOSession#close method&lt;/p&gt;</comment>
                            <comment id="17737587" author="olegk" created="Tue, 27 Jun 2023 11:07:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mns&quot; class=&quot;user-hover&quot; rel=&quot;mns&quot;&gt;mns&lt;/a&gt; Could you please test the proposed fix:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/httpcomponents-core/commit/a15a5c1a797ff08579648677796563bbfde089bc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-core/commit/a15a5c1a797ff08579648677796563bbfde089bc&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17738664" author="mns" created="Thu, 29 Jun 2023 16:45:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; That looks right, thank you for putting the fix together.&lt;/p&gt;</comment>
                            <comment id="17738676" author="jira-bot" created="Thu, 29 Jun 2023 17:02:09 +0000"  >&lt;p&gt;Commit a15a5c1a797ff08579648677796563bbfde089bc in httpcomponents-core&apos;s branch refs/heads/master from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=a15a5c1a7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=a15a5c1a7&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-753&quot; title=&quot;race condition with CapacityWindow resulting in CancelKeyException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-753&quot;&gt;&lt;del&gt;HTTPCORE-753&lt;/del&gt;&lt;/a&gt;: fixed race condition in the IOSession#close method&lt;/p&gt;</comment>
                            <comment id="17765637" author="jira-bot" created="Fri, 15 Sep 2023 13:30:12 +0000"  >&lt;p&gt;Commit a56b38360b7353485ae35fc3b8810a8206d7780f in httpcomponents-core&apos;s branch refs/heads/master from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=a56b38360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=a56b38360&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-753&quot; title=&quot;race condition with CapacityWindow resulting in CancelKeyException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-753&quot;&gt;&lt;del&gt;HTTPCORE-753&lt;/del&gt;&lt;/a&gt;: fixed race condition in the IOSession#close method&lt;/p&gt;</comment>
                            <comment id="17767204" author="jira-bot" created="Wed, 20 Sep 2023 17:13:59 +0000"  >&lt;p&gt;Commit a56b38360b7353485ae35fc3b8810a8206d7780f in httpcomponents-core&apos;s branch refs/heads/dependabot/maven/io.reactivex.rxjava3-rxjava-3.1.7 from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=a56b38360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=a56b38360&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-753&quot; title=&quot;race condition with CapacityWindow resulting in CancelKeyException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-753&quot;&gt;&lt;del&gt;HTTPCORE-753&lt;/del&gt;&lt;/a&gt;: fixed race condition in the IOSession#close method&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13060877" name="race_condition.txt" size="2435" author="mns" created="Tue, 27 Jun 2023 01:41:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 7 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1iopk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>