<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:23:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCORE-528] Infinite loop on server disconnect</title>
                <link>https://issues.apache.org/jira/browse/HTTPCORE-528</link>
                <project id="12310340" key="HTTPCORE">HttpComponents HttpCore</project>
                    <description>&lt;p&gt;I am seeing HTTP NIO client get into an infinite loop after the server disconnections the connection. See the log output attached; note some content removed for privacy.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Note that the HttpAsyncClient has returned the response and the application has completely processed it. The client maintains the connection, as expected, since the response included `Keep-Alive: timeout=5`. Five seconds after everything is complete, the &lt;em&gt;server&lt;/em&gt; closes the TCP connection. The client reacts accordingly: the selector wakes up, does a read of -1 bytes, closes the session and sets a 1 second timeout to close the connection in.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The infinite loop occurs because the selector.select() call &lt;em&gt;constantly&lt;/em&gt; returns in AbstractIOReactor.execute()&lt;/p&gt;

&lt;p&gt;readyCount == 1, so events are processed&lt;/p&gt;

&lt;p&gt;processEvent() notes the key is readable and calls:&lt;/p&gt;

&lt;p&gt;&#160; session.resetLastRead()&lt;/p&gt;

&lt;p&gt;&#160; readable(key);&lt;/p&gt;

&lt;p&gt;Because resetLastRead() is constantly updated, the 1 second timeout is never reached and AbstractIOReactor.timeoutCheck() can never call sessionTimedOut() or close the connection.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Note the entire time this is happening, netstat shows the connection is in CLOSE_WAIT state. The infinite loop continues until the OS keepalive timeout is reached and the connection is cleaned by the OS.&lt;/p&gt;

&lt;p&gt;I am not sure if this epoll / selector behavior is expected or not. However, I have replicated this issue in multiple environments. It seems like the async client should handle this by detecting the condition and closing the connection.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Other notes from this infinite loop state:&lt;/p&gt;

&lt;p&gt;SSLIOSession.updateEventMask() never closes the session either since the state remains `CLOSING`&lt;/p&gt;

&lt;p&gt;AbstractIODispatch.inputReady() &lt;em&gt;does not&lt;/em&gt;&#160; read any data from the connection since ssliosession.isAppInputReady() evaluates to false.&lt;/p&gt;

&lt;p&gt;SelectionKeyImpl.interestOps remains 1 (`OP_READ`)&lt;/p&gt;</description>
                <environment>bare metal Ubuntu 16.04 with kernel 4.4; openjdk1.8.0_172_x64 and Oracle jdk1.8.0_162_x64&lt;br/&gt;
CentOs Docker container with 3.10; openjdk1.8.0_172_x64&lt;br/&gt;
macOS 10.13.5; openjdk1.8.0_172_x64&lt;br/&gt;
</environment>
        <key id="13167511">HTTPCORE-528</key>
            <summary>Infinite loop on server disconnect</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="olegk">Oleg Kalnichevski</assignee>
                                    <reporter username="hpresnall">Hunter Presnall</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Jun 2018 23:56:17 +0000</created>
                <updated>Fri, 5 Oct 2018 07:28:04 +0000</updated>
                            <resolved>Tue, 26 Jun 2018 13:56:49 +0000</resolved>
                                    <version>4.4.9</version>
                                    <fixVersion>4.4.10</fixVersion>
                    <fixVersion>5.0-beta3</fixVersion>
                                    <component>HttpCore NIO</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16520280" author="olegk" created="Fri, 22 Jun 2018 11:56:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;Five seconds after everything is complete, the&#160;&lt;em&gt;server&lt;/em&gt;&#160;closes the TCP connection&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The thing is that the server is supposed to close out TLS secured connections though a &lt;tt&gt;TLS close notify&lt;/tt&gt; handshake. I always thoughts that the I/O reactor could deal with abnormal TLS connection termination but I might have overlooked something. I&apos;ll investigate.&lt;/p&gt;

&lt;p&gt;Oleg &lt;/p&gt;</comment>
                            <comment id="16521492" author="olegk" created="Sun, 24 Jun 2018 13:30:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hpresnall&quot; class=&quot;user-hover&quot; rel=&quot;hpresnall&quot;&gt;hpresnall&lt;/a&gt; Could you please try out this &lt;a href=&quot;https://github.com/ok2c/httpcore/commit/62ac34f57f126762b8449036002d0a587fa38ca0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt; and let me know if that solves the problem for you?&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="16522568" author="hpresnall" created="Mon, 25 Jun 2018 17:16:36 +0000"  >&lt;p&gt;That patch looks good. I cannot replicate the issue with the fix.&lt;/p&gt;

&lt;p&gt;One second after the server closes the connection, I see a Timeout message in InternalIODispatch, then a Shutdown on the connection and finally a&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;CLOSED&amp;#93;&lt;/span&gt;&#160;Disconnected message. Seems like it&apos;s working as expected.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;What&apos;s the timeframe for getting this released? I assume a new version of HttpAsyncClient will also be needed.&lt;/p&gt;</comment>
                            <comment id="16523668" author="jira-bot" created="Tue, 26 Jun 2018 12:38:57 +0000"  >&lt;p&gt;Commit c84749a18b255fd23b63700b47bd4bcdae34bb8c in httpcomponents-core&apos;s branch refs/heads/4.4.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-core.git;h=c84749a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-core.git;h=c84749a&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-528&quot; title=&quot;Infinite loop on server disconnect&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-528&quot;&gt;&lt;del&gt;HTTPCORE-528&lt;/del&gt;&lt;/a&gt;: SSL I/O session spins upon abornal connection closure by the opposite endpoint&lt;/p&gt;</comment>
                            <comment id="16523673" author="jira-bot" created="Tue, 26 Jun 2018 12:46:59 +0000"  >&lt;p&gt;Commit 1a10681f41e35f4660e71c9e8058089613af427c in httpcomponents-core&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-core.git;h=1a10681&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-core.git;h=1a10681&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-528&quot; title=&quot;Infinite loop on server disconnect&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-528&quot;&gt;&lt;del&gt;HTTPCORE-528&lt;/del&gt;&lt;/a&gt;: SSL I/O session spins upon abornal connection closure by the opposite endpoint&lt;/p&gt;</comment>
                            <comment id="16523760" author="olegk" created="Tue, 26 Jun 2018 13:57:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;What&apos;s the timeframe for getting this released? I assume a new version of HttpAsyncClient will also be needed&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Within a few weeks.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="16638912" author="desmondyeung" created="Thu, 4 Oct 2018 21:45:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; I&apos;ve adopted the HttpClient 5.0-beta1 into a project and have hit this a production environment. Wondering when there will be a new release of the 5.0 Client.&lt;/p&gt;</comment>
                            <comment id="16639400" author="olegk" created="Fri, 5 Oct 2018 07:28:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=desmondyeung&quot; class=&quot;user-hover&quot; rel=&quot;desmondyeung&quot;&gt;desmondyeung&lt;/a&gt; In a week or two.&lt;/p&gt;

&lt;p&gt;Oleg&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12928691" name="httpdebug.log" size="17538" author="hpresnall" created="Thu, 21 Jun 2018 23:56:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 6 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3v407:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>