<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:24:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCORE-560] LaxConnPool adds wrong PoolEntry to leased when processing pending requests</title>
                <link>https://issues.apache.org/jira/browse/HTTPCORE-560</link>
                <project id="12310340" key="HTTPCORE">HttpComponents HttpCore</project>
                    <description>&lt;p&gt;I&apos;m currently using HttpClient 5.0-beta1/HttpCore 5.0-beta2 and run into the following stacktrace fairly often in a production environment:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IllegalStateException: Pool entry already present in the set of leased entries
	at org.apache.hc.core5.pool.LaxConnPool$PerRoutePool.addLeased(LaxConnPool.java:393)
	at org.apache.hc.core5.pool.LaxConnPool$PerRoutePool.lease(LaxConnPool.java:429)
	at org.apache.hc.core5.pool.LaxConnPool.lease(LaxConnPool.java:143)
	at org.apache.hc.client5.http.impl.nio.PoolingAsyncClientConnectionManager.lease(PoolingAsyncClientConnectionManager.java:216)
	at org.apache.hc.client5.http.impl.async.InternalHttpAsyncExecRuntime.acquireConnection(InternalHttpAsyncExecRuntime.java:89)
	at org.apache.hc.client5.http.impl.async.AsyncConnectExec.execute(AsyncConnectExec.java:152)
	at org.apache.hc.client5.http.impl.async.AsyncExecChainElement.execute(AsyncExecChainElement.java:54)
	at org.apache.hc.client5.http.impl.async.AsyncExecChainElement$1.proceed(AsyncExecChainElement.java:62)
	at org.apache.hc.client5.http.impl.async.AsyncProtocolExec.internalExecute(AsyncProtocolExec.java:170)
	at org.apache.hc.client5.http.impl.async.AsyncProtocolExec.execute(AsyncProtocolExec.java:133)
	at org.apache.hc.client5.http.impl.async.AsyncExecChainElement.execute(AsyncExecChainElement.java:54)
	at org.apache.hc.client5.http.impl.async.InternalAbstractHttpAsyncClient$1.sendRequest(InternalAbstractHttpAsyncClient.java:170)
	at org.apache.hc.core5.http.nio.BasicRequestProducer.sendRequest(BasicRequestProducer.java:65)
	at org.apache.hc.client5.http.impl.async.InternalAbstractHttpAsyncClient.execute(InternalAbstractHttpAsyncClient.java:144)
	at org.apache.hc.client5.http.impl.async.CloseableHttpAsyncClient.execute(CloseableHttpAsyncClient.java:78)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After doing some digging I believe that &lt;tt&gt;addLeased(releasedEntry);&lt;/tt&gt; should be replaced with &lt;tt&gt;addLeased(availableEntry);&lt;/tt&gt; in the following snippet of &lt;tt&gt;PerRoutePool#release&lt;/tt&gt;. In it&apos;s current state, it appears that the polled &lt;tt&gt;leaseRequest&lt;/tt&gt; gets leaked when this happens. Please let me know if my findings are correct.&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; ((leaseRequest = pending.poll()) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (leaseRequest.isDone()) {
        &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
    }
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; state = leaseRequest.getState();
    &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Deadline deadline = leaseRequest.getDeadline();

    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (deadline.isExpired()) {
        leaseRequest.failed(DeadlineTimeoutException.from(deadline));
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; PoolEntry&amp;lt;T, C&amp;gt; availableEntry = getAvailableEntry(state);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (availableEntry != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            addLeased(releasedEntry);
            leaseRequest.completed(availableEntry);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (leased.size() &amp;lt; max) {
            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; PoolEntry&amp;lt;T, C&amp;gt; newEntry = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PoolEntry&amp;lt;&amp;gt;(route, timeToLive);
            addLeased(newEntry);
            leaseRequest.completed(newEntry);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13193641">HTTPCORE-560</key>
            <summary>LaxConnPool adds wrong PoolEntry to leased when processing pending requests</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="desmondyeung">Desmond Yeung</reporter>
                        <labels>
                    </labels>
                <created>Tue, 23 Oct 2018 18:02:03 +0000</created>
                <updated>Wed, 24 Oct 2018 12:07:13 +0000</updated>
                            <resolved>Wed, 24 Oct 2018 07:53:13 +0000</resolved>
                                    <version>5.0-beta5</version>
                                    <fixVersion>5.0-beta6</fixVersion>
                                    <component>HttpCore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16661081" author="desmondyeung" created="Tue, 23 Oct 2018 18:10:53 +0000"  >&lt;p&gt;Here&apos;s another stacktrace with &lt;tt&gt;release&lt;/tt&gt;: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IllegalStateException: Pool entry already present in the set of leased entries
	at org.apache.hc.core5.pool.LaxConnPool$PerRoutePool.addLeased(LaxConnPool.java:393)
	at org.apache.hc.core5.pool.LaxConnPool$PerRoutePool.release(LaxConnPool.java:474)
	at org.apache.hc.core5.pool.LaxConnPool.release(LaxConnPool.java:162)
	at org.apache.hc.client5.http.impl.nio.PoolingAsyncClientConnectionManager.release(PoolingAsyncClientConnectionManager.java:318)
	at org.apache.hc.client5.http.impl.async.InternalHttpAsyncExecRuntime.releaseConnection(InternalHttpAsyncExecRuntime.java:141)
	at org.apache.hc.client5.http.impl.async.InternalAbstractHttpAsyncClient$1$2.completed(InternalAbstractHttpAsyncClient.java:268)
	at org.apache.hc.client5.http.impl.async.AsyncProtocolExec$1.completed(AsyncProtocolExec.java:230)
	at org.apache.hc.client5.http.impl.async.HttpAsyncMainClientExec$1.streamEnd(HttpAsyncMainClientExec.java:215)
	at org.apache.hc.core5.http.impl.nio.ClientHttp1StreamHandler.dataEnd(ClientHttp1StreamHandler.java:272)
	at org.apache.hc.core5.http.impl.nio.ClientHttp1StreamDuplexer.dataEnd(ClientHttp1StreamDuplexer.java:377)
	at org.apache.hc.core5.http.impl.nio.AbstractHttp1StreamDuplexer.onInput(AbstractHttp1StreamDuplexer.java:334)
	at org.apache.hc.core5.http.impl.nio.AbstractHttp1IOEventHandler.inputReady(AbstractHttp1IOEventHandler.java:62)
	at org.apache.hc.core5.http.impl.nio.ClientHttp1IOEventHandler.inputReady(ClientHttp1IOEventHandler.java:38)
	at org.apache.hc.core5.reactor.InternalDataChannel.onIOEvent(InternalDataChannel.java:117)
	at org.apache.hc.core5.reactor.InternalChannel.handleIOEvent(InternalChannel.java:50)
	at org.apache.hc.core5.reactor.SingleCoreIOReactor.processEvents(SingleCoreIOReactor.java:173)
	at org.apache.hc.core5.reactor.SingleCoreIOReactor.doExecute(SingleCoreIOReactor.java:123)
	at org.apache.hc.core5.reactor.AbstractSingleCoreIOReactor.execute(AbstractSingleCoreIOReactor.java:80)
	at org.apache.hc.core5.reactor.IOReactorWorker.run(IOReactorWorker.java:44)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I can submit a patch if the suggested change looks correct.&lt;/p&gt;</comment>
                            <comment id="16661205" author="githubbot" created="Tue, 23 Oct 2018 20:10:17 +0000"  >&lt;p&gt;GitHub user desmondyeung opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpcomponents-core/pull/92&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-core/pull/92&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-560&quot; title=&quot;LaxConnPool adds wrong PoolEntry to leased when processing pending requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-560&quot;&gt;&lt;del&gt;HTTPCORE-560&lt;/del&gt;&lt;/a&gt;: Fix LaxConnPool leasing incorrect PoolEntry when proces&#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;sing pending requests&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/desmondyeung/httpcomponents-core&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/desmondyeung/httpcomponents-core&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-560&quot; title=&quot;LaxConnPool adds wrong PoolEntry to leased when processing pending requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-560&quot;&gt;&lt;del&gt;HTTPCORE-560&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpcomponents-core/pull/92.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-core/pull/92.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #92&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit de10955727f09d7069234ec7553bf316f2329915&lt;br/&gt;
Author: Desmond Yeung &amp;lt;dyeung@...&amp;gt;&lt;br/&gt;
Date:   2018-10-23T19:54:20Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-560&quot; title=&quot;LaxConnPool adds wrong PoolEntry to leased when processing pending requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-560&quot;&gt;&lt;del&gt;HTTPCORE-560&lt;/del&gt;&lt;/a&gt;: Fix LaxConnPool leasing incorrect PoolEntry when processing pending requests&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16661877" author="jira-bot" created="Wed, 24 Oct 2018 07:47:46 +0000"  >&lt;p&gt;Commit c93ea4082a08a130da0afe36e0d5bfae030a21a9 in httpcomponents-core&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=desmondyeung&quot; class=&quot;user-hover&quot; rel=&quot;desmondyeung&quot;&gt;desmondyeung&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-core.git;h=c93ea40&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=httpcomponents-core.git;h=c93ea40&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-560&quot; title=&quot;LaxConnPool adds wrong PoolEntry to leased when processing pending requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-560&quot;&gt;&lt;del&gt;HTTPCORE-560&lt;/del&gt;&lt;/a&gt;: Fix LaxConnPool leasing incorrect PoolEntry when processing pending requests&lt;/p&gt;</comment>
                            <comment id="16661882" author="githubbot" created="Wed, 24 Oct 2018 07:49:37 +0000"  >&lt;p&gt;Github user ok2c commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/httpcomponents-core/pull/92&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-core/pull/92&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Committed as c93ea4082a08a130da0afe36e0d5bfae030a21a9. Please review and close.&lt;/p&gt;</comment>
                            <comment id="16661889" author="olegk" created="Wed, 24 Oct 2018 07:53:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=desmondyeung&quot; class=&quot;user-hover&quot; rel=&quot;desmondyeung&quot;&gt;desmondyeung&lt;/a&gt; Many thanks for reporting this bug and contributing a fix.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="16662196" author="desmondyeung" created="Wed, 24 Oct 2018 12:07:13 +0000"  >&lt;p&gt;happy to help&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 3 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3zjrj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>