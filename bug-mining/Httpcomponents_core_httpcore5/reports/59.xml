<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:24:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCORE-659] Race condition in IOSessionImpl when setting event</title>
                <link>https://issues.apache.org/jira/browse/HTTPCORE-659</link>
                <project id="12310340" key="HTTPCORE">HttpComponents HttpCore</project>
                    <description>&lt;p&gt;There is a race condition in class &lt;tt&gt;org.apache.hc.core5.reactor.IOSessionImpl&lt;/tt&gt; when setting an event through the &lt;tt&gt;setEvent(final int op)&lt;/tt&gt;&#160;method: there is a check on the session to ensure it is not closed but this check is performed outside the lock that is later acquired to protect the call on the &lt;tt&gt;SelectionKey&lt;/tt&gt;. If the session is closed just after the check but before getting the lock, then it will throw a &lt;tt&gt;CancelledKeyException&lt;/tt&gt; when trying to perform the call on the &lt;tt&gt;SelectionKey&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I have implemented an HTTP server that use the reactive library&#160;(&lt;tt&gt;httpcore5-reactive&lt;/tt&gt; component) and execute the requests in a separate thread pool. I was hit by this issue, here is a stack trace (with traces non specific to HttpCore library removed):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   CancelledKeyException at SelectionKeyImpl.java:71 
   SelectionKeyImpl.java:90 
   IOSessionImpl.java:159 
   InternalDataChannel.java:324 
   AbstractHttp1StreamDuplexer.java:  452 
   ServerHttp1StreamDuplexer.java:136 
   ServerHttp1StreamHandler.java:94 
   ReactiveDataProducer.java:108 
   ReactiveDataProducer.java:100 
   ... traces from publisher implementation using Rx java library... 
   ReactiveServerExchangeHandler.java:91          
   ReactiveServerExchangeHandler.java:83 
   ...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I was able to reproduce it almost systematically with unit test from my application (concurrency issues are very sensitive to time). If necessary I can provide a sample &lt;tt&gt;HttpAsyncServer&lt;/tt&gt;&#160;which allows me to reproduce it by introducing a simple &lt;tt&gt;Thread.sleep(50)&lt;/tt&gt;&#160;sequence in &lt;tt&gt;IOSessionImpl&lt;/tt&gt; code.&lt;/p&gt;

&lt;p&gt;There is a simple fix: move the check on close status inside the lock-unlock block&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   lock.lock();
   &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isStatusClosed()) {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
       }
       &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.key.interestOps(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.key.interestOps() | op);
   } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
     lock.unlock();
   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Note that 2 other methods of this class are subject to this problem: &lt;tt&gt;setEventMask(final int newValue)&lt;/tt&gt; and &lt;tt&gt;clearEvent(final int op)&lt;/tt&gt;. The fix is the same than for the first method.&lt;/p&gt;

&lt;p&gt;I can submit a pull request with the fix(es) if you indicate me in which branch I should submit it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13353325">HTTPCORE-659</key>
            <summary>Race condition in IOSessionImpl when setting event</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ncapponi">Nicolas Capponi</reporter>
                        <labels>
                    </labels>
                <created>Tue, 19 Jan 2021 17:12:48 +0000</created>
                <updated>Fri, 2 Apr 2021 10:46:33 +0000</updated>
                            <resolved>Tue, 26 Jan 2021 08:10:45 +0000</resolved>
                                    <version>5.0.3</version>
                                    <fixVersion>5.1-beta3</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>HttpCore NIO</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="17268067" author="michael-o" created="Tue, 19 Jan 2021 17:25:34 +0000"  >&lt;p&gt;Please fork, create PR where branches are named after the ticket.&lt;/p&gt;</comment>
                            <comment id="17268211" author="olegk" created="Tue, 19 Jan 2021 20:42:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ncapponi&quot; class=&quot;user-hover&quot; rel=&quot;ncapponi&quot;&gt;ncapponi&lt;/a&gt; The proposed fix sounds reasonable to me. Please do raise a PR at GitHub as suggested by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=michael-o&quot; class=&quot;user-hover&quot; rel=&quot;michael-o&quot;&gt;michael-o&lt;/a&gt;. If possible please do try to add a test case to TestHttp1Reactive reproducing the condition.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17270633" author="olegk" created="Sat, 23 Jan 2021 11:41:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ncapponi&quot; class=&quot;user-hover&quot; rel=&quot;ncapponi&quot;&gt;ncapponi&lt;/a&gt; I would like to release HttpCore 5.1-beta3 sometime next week and would like to have a fix for this issue included in the release. Do you think you are going to have time to work on a PR?&lt;/p&gt;

&lt;p&gt;Oleg &lt;/p&gt;</comment>
                            <comment id="17271148" author="ncapponi" created="Mon, 25 Jan 2021 08:24:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt;&#160;Yes I should be able to provide a PR today&lt;/p&gt;</comment>
                            <comment id="17271169" author="ncapponi" created="Mon, 25 Jan 2021 08:53:13 +0000"  >&lt;p&gt;I submitted a PR in 5.0.x branch, please tell me if I should also submit it in another branch and/or master.&lt;/p&gt;</comment>
                            <comment id="17271945" author="jira-bot" created="Tue, 26 Jan 2021 08:01:03 +0000"  >&lt;p&gt;Commit 5178ff39e4a8379d2c59cf7f4132e89378f95028 in httpcomponents-core&apos;s branch refs/heads/5.0.x from Nicolas Capponi&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=5178ff3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=5178ff3&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-659&quot; title=&quot;Race condition in IOSessionImpl when setting event&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-659&quot;&gt;&lt;del&gt;HTTPCORE-659&lt;/del&gt;&lt;/a&gt; Race condition in IOSessionImpl when setting event&lt;/p&gt;</comment>
                            <comment id="17271950" author="jira-bot" created="Tue, 26 Jan 2021 08:09:15 +0000"  >&lt;p&gt;Commit 4c9fbd27bac88ee64e3ad3e64b8f3b3e4a5d6621 in httpcomponents-core&apos;s branch refs/heads/master from Nicolas Capponi&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=4c9fbd2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=4c9fbd2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-659&quot; title=&quot;Race condition in IOSessionImpl when setting event&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-659&quot;&gt;&lt;del&gt;HTTPCORE-659&lt;/del&gt;&lt;/a&gt; Race condition in IOSessionImpl when setting event&lt;/p&gt;</comment>
                            <comment id="17271952" author="olegk" created="Tue, 26 Jan 2021 08:10:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ncapponi&quot; class=&quot;user-hover&quot; rel=&quot;ncapponi&quot;&gt;ncapponi&lt;/a&gt; PR merged to 5.0.x and master.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17276881" author="jnrouvignac" created="Tue, 2 Feb 2021 06:35:44 +0000"  >&lt;p&gt;Hello, do you have plans to release 5.0.4 with this fix soon-ish?&lt;/p&gt;</comment>
                            <comment id="17276894" author="olegk" created="Tue, 2 Feb 2021 07:05:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jnrouvignac&quot; class=&quot;user-hover&quot; rel=&quot;jnrouvignac&quot;&gt;jnrouvignac&lt;/a&gt; The fix will soon be released with 5.1-beta3. It may also well happen that the next GA release is going to be 5.1, not 5.0.3.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17276910" author="jnrouvignac" created="Tue, 2 Feb 2021 07:44:23 +0000"  >&lt;p&gt;OK, if the final release happens during this month, then we should be ok, otherwise it will too late for our upcoming release.&lt;br/&gt;
Anyway, thank you again.&lt;/p&gt;</comment>
                            <comment id="17276957" author="olegk" created="Tue, 2 Feb 2021 08:54:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jnrouvignac&quot; class=&quot;user-hover&quot; rel=&quot;jnrouvignac&quot;&gt;jnrouvignac&lt;/a&gt; I am not sure what it is exactly that stops you from using 5.1b3 but this is up to you.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17276977" author="jnrouvignac" created="Tue, 2 Feb 2021 09:28:14 +0000"  >&lt;p&gt;Sorry I should have been clearer about this. I think we have a policy to not use &quot;beta&quot; artifacts, but I need to double check to be sure.&lt;br/&gt;
Looking at all the changes in 5.1, I am thinking it would be safe to switch to it.&lt;br/&gt;
I only saw bug fixes and some API additions. Am I reading this correctly?&lt;br/&gt;
If that&apos;s the case, I&apos;ll lobby internally for using 5.1b3.&lt;/p&gt;</comment>
                            <comment id="17276995" author="olegk" created="Tue, 2 Feb 2021 09:50:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jnrouvignac&quot; class=&quot;user-hover&quot; rel=&quot;jnrouvignac&quot;&gt;jnrouvignac&lt;/a&gt; Yes, you are. BETA status represents API stability, at least in Apache HC. It has nothing to do with quality of code. It basically means that new APIs introduced in a minor release are still subject to change but that is it. &lt;/p&gt;

&lt;p&gt;Generally minor release BETAs are as good as GA releases. I understand if people do not upgrade to the latest release series (regardless of its status) but policy precluding the use of BETA artifacts is outright silly.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 40 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0mrqg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>