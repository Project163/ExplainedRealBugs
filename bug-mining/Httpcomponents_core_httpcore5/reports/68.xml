<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 18:24:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[HTTPCORE-726] SharedInputBuffer expands unbounded on large responses</title>
                <link>https://issues.apache.org/jira/browse/HTTPCORE-726</link>
                <project id="12310340" key="HTTPCORE">HttpComponents HttpCore</project>
                    <description>&lt;p&gt;Large responses can result in the &lt;tt&gt;SharedInputBuffer&lt;/tt&gt; expanding unbounded, but with small intervals. Each expansion is the minimum 1024 byte aligned size bigger than the current buffer that is filling it beyond its current capacity. This leads to a ton of heap allocations and garbage collection each time is expands.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It looks like the capacity updates to &lt;tt&gt;CapacityChannel&lt;/tt&gt; are reporting current capacity rather than deltas/increments, so that even when small reads occur, the whole capacity is reported again to the channel and the capacity window also grows unbounded.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve attached a patch that includes some &lt;tt&gt;println&lt;/tt&gt; statements for the capacity window size and for buffer being expanded along with the integration test &lt;tt&gt;testLargeResponseConsumer&lt;/tt&gt; that shows the buffer and window growing quite large (the test passes, but the println statements show how large they are growing).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;For a fix I was thinking of updating the capacity tracking to be similar to &lt;tt&gt;ReactiveDataConsumer&lt;/tt&gt; in tracking the number of bytes read and then reporting that delta to &lt;tt&gt;CapacityChannel&lt;/tt&gt;. This does seem to prevent the buffer from expanding to huge sizes, but it still expands more than I would expect because after each read from the &lt;tt&gt;SharedInputBuffer&lt;/tt&gt;. This remaining expansion appears to be from &lt;tt&gt;CapacityWindow&lt;/tt&gt; always setting the IO sessions with &lt;tt&gt;OP_READ&lt;/tt&gt; even when the window is still negative after the update.&lt;/p&gt;</description>
                <environment>MacOS 12, Debian 9, Debian 10</environment>
        <key id="13486207">HTTPCORE-726</key>
            <summary>SharedInputBuffer expands unbounded on large responses</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="johnlcox">John Leacox</reporter>
                        <labels>
                    </labels>
                <created>Thu, 13 Oct 2022 22:08:57 +0000</created>
                <updated>Wed, 19 Oct 2022 11:55:36 +0000</updated>
                            <resolved>Tue, 18 Oct 2022 21:55:13 +0000</resolved>
                                    <version>5.1.3</version>
                                    <fixVersion>5.1.5</fixVersion>
                    <fixVersion>5.2</fixVersion>
                                    <component>HttpCore</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17618135" author="olegk" created="Sat, 15 Oct 2022 16:39:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johnlcox&quot; class=&quot;user-hover&quot; rel=&quot;johnlcox&quot;&gt;johnlcox&lt;/a&gt; I am not sure I fully understand the intent of the change-set. Is it to reduce the number of buffer expansions and heap allocations or is to prevent the buffer from growing beyond a particular size?&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17618160" author="johnlcox" created="Sat, 15 Oct 2022 19:36:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; The intent of the change-set is to report the capacity based on the number of bytes read out of the buffer. The result of that is a reduced number of buffer expansions and heap allocations. Technically it could maybe still grow unbounded, but I haven&apos;t seen it grow even close to how big it was getting before. I think, but I could be misunderstanding something, this change to the way capacity is reported is also more correct; The original implementation results in the &lt;tt&gt;CapacityWindow&lt;/tt&gt; growing huge and way out of proportion to the actual buffer size.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Separately from that, the piece I&apos;m still not understanding is how &lt;tt&gt;CapacityWindow&lt;/tt&gt; in &lt;tt&gt;AbstractHttp1StreamDuplexer&lt;/tt&gt; is intended to control when the more bytes are read off the socket. Is it odd that it&apos;s setting &lt;tt&gt;OP_READ&lt;/tt&gt; even though the window is still negative after being incremented?&lt;/p&gt;</comment>
                            <comment id="17618249" author="olegk" created="Sun, 16 Oct 2022 10:08:35 +0000"  >&lt;p&gt;&amp;gt; Separately from that, the piece I&apos;m still not understanding is how &lt;tt&gt;CapacityWindow&lt;/tt&gt; in &lt;tt&gt;AbstractHttp1StreamDuplexer&lt;/tt&gt; is intended to control when the more bytes are read off the socket. Is it odd that it&apos;s setting &lt;tt&gt;OP_READ&lt;/tt&gt; even though the window is still negative after being incremented?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johnlcox&quot; class=&quot;user-hover&quot; rel=&quot;johnlcox&quot;&gt;johnlcox&lt;/a&gt; This looks wrong. I am looking into it.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17618994" author="jira-bot" created="Mon, 17 Oct 2022 16:32:27 +0000"  >&lt;p&gt;Commit dc179e1416c65edc36de49cf8edf42ab1e941833 in httpcomponents-core&apos;s branch refs/heads/&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-726&quot; title=&quot;SharedInputBuffer expands unbounded on large responses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-726&quot;&gt;&lt;del&gt;HTTPCORE-726&lt;/del&gt;&lt;/a&gt; from Oleg Kalnichevski&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=dc179e141&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=dc179e141&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-726&quot; title=&quot;SharedInputBuffer expands unbounded on large responses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-726&quot;&gt;&lt;del&gt;HTTPCORE-726&lt;/del&gt;&lt;/a&gt;: Improved capacity management in SharedInputBuffer&lt;/p&gt;</comment>
                            <comment id="17619021" author="olegk" created="Mon, 17 Oct 2022 17:25:02 +0000"  >&lt;p&gt;&amp;gt; For a fix I was thinking of updating the capacity tracking to be similar to &lt;tt&gt;ReactiveDataConsumer&lt;/tt&gt; in tracking the number of bytes read and then reporting that delta to &lt;tt&gt;CapacityChannel&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johnlcox&quot; class=&quot;user-hover&quot; rel=&quot;johnlcox&quot;&gt;johnlcox&lt;/a&gt; I tried out several different things but ended up choosing the fix you have proposed with some fairly small tweaks. Please review the change-set &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; and let me know if my modifications to your original patch look acceptable. Please also feel free to let me know your GitHub account name or email address. I will amend the commit with your name as the author.&lt;/p&gt;

&lt;p&gt;&amp;gt; This does seem to prevent the buffer from expanding to huge sizes, but it still expands more than I would expect because after each read from the &lt;tt&gt;SharedInputBuffer&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;In my local tests the input buffer gets expanded a little more beyond the initial window size (64K) which looks acceptable to me given that the test case uses a producer on the server that sends data in a tight stream, while the consumer on the client side reads 16 byte at a time and generally is quite a bit slower.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&#160;
Expanding capacity: 63488
Expanding capacity: 64512
Expanding capacity: 65536
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What we can do though is make &lt;tt&gt;SharedInputBuffer&lt;/tt&gt; expand more aggressively until its internal buffer is smaller than the initial window size (64K), thus reducing the number of allocations, data copy operations and intermediate garbage.&lt;/p&gt;

&lt;p&gt;&amp;gt; Separately from that, the piece I&apos;m still not understanding is how CapacityWindow in AbstractHttp1StreamDuplexer is intended to control when the more bytes are read off the socket. Is it odd that it&apos;s setting OP_READ even though the window is still negative after being incremented?&lt;/p&gt;

&lt;p&gt;It took me some time to recall what the rationale was but here is it. Unlike HTTP/2 data frame counting with HTTP/1.1 is just an approximation that has no bearing on what the opposite endpoint will end up sending. The assumption is that if the consumer pushes a capacity update greater than 0 it is capable of receiving at least &lt;em&gt;some&lt;/em&gt; data. Even if the total value of the window is negative it is just an approximation so it is okay to ask the server for more data even if it can be more than the declared capacity.&lt;/p&gt;

&lt;p&gt;I am thinking about changing this behavior in the 5.2 if you are willing to work with me and help me with testing.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/httpcomponents-core/commit/dc179e1416c65edc36de49cf8edf42ab1e941833&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/httpcomponents-core/commit/dc179e1416c65edc36de49cf8edf42ab1e941833&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17619079" author="johnlcox" created="Mon, 17 Oct 2022 20:09:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; I&apos;ll take a look at the commit and hook the change in to some of the testing I&apos;ve done to see it in action. My Github name is &lt;a href=&quot;https://github.com/johnlcox&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;johnlcox&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;That makes sense on the capacity tracking being an approximation. I&apos;m happy to help test changes on that behavior for 5.2.&lt;/p&gt;</comment>
                            <comment id="17619089" author="jira-bot" created="Mon, 17 Oct 2022 20:28:43 +0000"  >&lt;p&gt;Commit 791dcd25df0fd40b0f14e8a02d6c8f1bc1b9b27b in httpcomponents-core&apos;s branch refs/heads/&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-726&quot; title=&quot;SharedInputBuffer expands unbounded on large responses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-726&quot;&gt;&lt;del&gt;HTTPCORE-726&lt;/del&gt;&lt;/a&gt; from John Leacox&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=791dcd25d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=791dcd25d&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-726&quot; title=&quot;SharedInputBuffer expands unbounded on large responses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-726&quot;&gt;&lt;del&gt;HTTPCORE-726&lt;/del&gt;&lt;/a&gt;: Improved capacity management in SharedInputBuffer&lt;/p&gt;</comment>
                            <comment id="17619643" author="johnlcox" created="Tue, 18 Oct 2022 15:10:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=olegk&quot; class=&quot;user-hover&quot; rel=&quot;olegk&quot;&gt;olegk&lt;/a&gt; we tested the change in some of our integration tests up to a 200GB response and the buffer only expanded to slightly larger than 300k. That&apos;s a huge improvement to what we were seeing before, so this change looks great to me.&lt;/p&gt;</comment>
                            <comment id="17619763" author="jira-bot" created="Tue, 18 Oct 2022 20:02:14 +0000"  >&lt;p&gt;Commit 82a0b1ad246c77ea58d9eca8ddbc9f2f89eb051c in httpcomponents-core&apos;s branch refs/heads/5.1.x from John Leacox&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=82a0b1ad2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=82a0b1ad2&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-726&quot; title=&quot;SharedInputBuffer expands unbounded on large responses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-726&quot;&gt;&lt;del&gt;HTTPCORE-726&lt;/del&gt;&lt;/a&gt;: Improved capacity management in SharedInputBuffer&lt;/p&gt;</comment>
                            <comment id="17619811" author="jira-bot" created="Tue, 18 Oct 2022 21:53:46 +0000"  >&lt;p&gt;Commit 4864b1314d9e91e8d014849df66d5bad6854e77b in httpcomponents-core&apos;s branch refs/heads/master from John Leacox&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=4864b1314&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=4864b1314&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-726&quot; title=&quot;SharedInputBuffer expands unbounded on large responses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-726&quot;&gt;&lt;del&gt;HTTPCORE-726&lt;/del&gt;&lt;/a&gt;: Improved capacity management in SharedInputBuffer&lt;/p&gt;</comment>
                            <comment id="17619812" author="olegk" created="Tue, 18 Oct 2022 21:55:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=johnlcox&quot; class=&quot;user-hover&quot; rel=&quot;johnlcox&quot;&gt;johnlcox&lt;/a&gt; I am glad to hear that. Many thanks for reporting the problem and providing a fix.&lt;/p&gt;

&lt;p&gt;Oleg&lt;/p&gt;</comment>
                            <comment id="17620284" author="jira-bot" created="Wed, 19 Oct 2022 11:55:36 +0000"  >&lt;p&gt;Commit f1bb865b6f4959a56d89f6eb7a13cee5ac909fb6 in httpcomponents-core&apos;s branch refs/heads/master from John Leacox&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=f1bb865b6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=httpcomponents-core.git;h=f1bb865b6&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCORE-726&quot; title=&quot;SharedInputBuffer expands unbounded on large responses&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HTTPCORE-726&quot;&gt;&lt;del&gt;HTTPCORE-726&lt;/del&gt;&lt;/a&gt;: Improved capacity management in SharedInputBuffer&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13050917" name="SharedInputBuffer_Unbounded_Growth_Example.patch" size="5912" author="johnlcox" created="Thu, 13 Oct 2022 21:54:48 +0000"/>
                            <attachment id="13050916" name="SharedInputBuffer_Unbounded_Growth_Possible_Fix.patch" size="3380" author="johnlcox" created="Thu, 13 Oct 2022 21:55:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 3 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z19cps:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>