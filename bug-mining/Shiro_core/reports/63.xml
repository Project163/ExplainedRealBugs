<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:35:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SHIRO-380] runAs feature (still) doesn&apos;t work</title>
                <link>https://issues.apache.org/jira/browse/SHIRO-380</link>
                <project id="12310950" key="SHIRO">Shiro</project>
                    <description>&lt;p&gt;Right after SecurityUtils.getSubject().runAs(new new SimplePrincipalCollection()&lt;/p&gt;
{...}
&lt;p&gt;)&lt;/p&gt;

&lt;p&gt;SecurityUtils.getSubject().getPrincipal() returns correct new Principal&lt;br/&gt;
SecurityUtils.getSubject()..getPreviousPrincipals() returns correct original Principal&lt;/p&gt;

&lt;p&gt;but DefaultSubjectDAO merge principals in method&lt;/p&gt;

&lt;p&gt;protected void mergePrincipals(Subject subject) {&lt;br/&gt;
  PrincipalCollection currentPrincipals = subject.getPrincipals();&lt;br/&gt;
  ...&lt;br/&gt;
  if (session == null) &lt;/p&gt;
{
  ...
  }
&lt;p&gt; else {&lt;br/&gt;
    PrincipalCollection existingPrincipals = (PrincipalCollection) session.getAttribute(DefaultSubjectContext.PRINCIPALS_SESSION_KEY);&lt;br/&gt;
    if (CollectionUtils.isEmpty(currentPrincipals)) &lt;/p&gt;
{
      ...
    }
&lt;p&gt; else {&lt;br/&gt;
       if (!currentPrincipals.equals(existingPrincipals)) &lt;/p&gt;
{
            session.setAttribute(DefaultSubjectContext.PRINCIPALS_SESSION_KEY, currentPrincipals);
      }
&lt;p&gt;   }&lt;br/&gt;
}&lt;/p&gt;


&lt;p&gt;and after that&lt;br/&gt;
SecurityUtils.getSubject().getPrincipal() and SecurityUtils.getSubject().getPreviousPrincipals() both returns new Principal - this is wrong behavior&lt;/p&gt;</description>
                <environment></environment>
        <key id="12601949">SHIRO-380</key>
            <summary>runAs feature (still) doesn&apos;t work</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="zefixlluja">Jochen Munz</reporter>
                        <labels>
                            <label>principal,</label>
                            <label>shiro,</label>
                            <label>subject</label>
                    </labels>
                <created>Tue, 7 Aug 2012 14:41:10 +0000</created>
                <updated>Fri, 15 Jul 2016 14:48:27 +0000</updated>
                            <resolved>Fri, 15 Jul 2016 14:48:27 +0000</resolved>
                                    <version>1.2.1</version>
                                    <fixVersion>1.2.2</fixVersion>
                                    <component>Realms </component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13430374" author="zefixlluja" created="Tue, 7 Aug 2012 14:50:23 +0000"  >&lt;p&gt;I have cloned the &lt;a href=&quot;https://issues.apache.org/jira/browse/SHIRO-344&quot; title=&quot;runAs feature doesn&amp;#39;t work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SHIRO-344&quot;&gt;&lt;del&gt;SHIRO-344&lt;/del&gt;&lt;/a&gt; issue, because using shiro 1.2.1, I still experience this issue - the principals get overwritten in the mergePrincipals() method.&lt;/p&gt;

&lt;p&gt;Running the runAs() tests for the DelegatingSubject gives me no errors.&lt;/p&gt;

&lt;p&gt;Also noteworthy, when entering a second runAs-Level, the previous principals are preserved. It is only on the first runAs level that the previous principal gets overwritten.&lt;/p&gt;

&lt;p&gt;When I am using the subclassed SubjectDAO of &lt;a href=&quot;https://issues.apache.org/jira/browse/SHIRO-344&quot; title=&quot;runAs feature doesn&amp;#39;t work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SHIRO-344&quot;&gt;&lt;del&gt;SHIRO-344&lt;/del&gt;&lt;/a&gt; the problem does not occur, runAs works on all levels as expected.&lt;/p&gt;

&lt;p&gt;My setup is web-based, maybe this leads to some subtle differences?&lt;/p&gt;</comment>
                            <comment id="13430403" author="zefixlluja" created="Tue, 7 Aug 2012 16:30:17 +0000"  >&lt;p&gt;Attached sample webapp to demonstrate the behaviour - see the README file explanations&lt;/p&gt;</comment>
                            <comment id="13430485" author="lhazlewood" created="Tue, 7 Aug 2012 18:01:34 +0000"  >&lt;p&gt;Thanks for the update Jochen, and the sample app.  Hopefully we can use this to create more test cases beyond the ones we already have.&lt;/p&gt;

&lt;p&gt;Do you know how the behavior differs from the DelegatingSubjectTest testRunAs() test case (other than the web scenario)?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/repos/asf/shiro/trunk/core/src/test/java/org/apache/shiro/subject/DelegatingSubjectTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/shiro/trunk/core/src/test/java/org/apache/shiro/subject/DelegatingSubjectTest.java&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13430961" author="zefixlluja" created="Wed, 8 Aug 2012 09:02:10 +0000"  >&lt;p&gt;I am not aware of significant differences between sample app and the unit test (besides the web setup). &lt;/p&gt;

&lt;p&gt;The steps are quite similar:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;3 users are defined upfront&lt;/li&gt;
	&lt;li&gt;login as user 1  (1st request)&lt;/li&gt;
	&lt;li&gt;runAs user2 (2nd request, status shows up ok)&lt;/li&gt;
	&lt;li&gt;check status (3rd request, status shows user2 as current and previous principal)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I could think of different behaviour because of (web) session handling and/or threading (as the unit test runs in one go).&lt;/p&gt;

&lt;p&gt;Can you (or somebody else) please verify the behaviour/setup with the attached sample app, so that we can exclude misconfiguration as a possible cause? I&apos;ll be happy to investigate further.&lt;/p&gt;</comment>
                            <comment id="13431187" author="elijah.korneckis" created="Wed, 8 Aug 2012 15:54:48 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Here&apos;s what I&apos;ve been able to piece together. I think the main difference between the test scenario and a web app setup is that the Subject that is bound to the tread and saved in the session is recreated between requests - in the filter chain (see AbstractShiroFilter, line 359).&lt;/p&gt;

&lt;p&gt;During the creation process the DefaultSecurityManager.createSubject calls it&apos;s save method (at line 350).&lt;br/&gt;
That, in turn, calls DefaultSubjectDAO.mergePrincipals (at line 163): save -&amp;gt; saveToSession -&amp;gt; mergePrincipals.&lt;/p&gt;

&lt;p&gt;Here&apos;s where things get interesting. Consider Jochen&apos;s scenario, right after runAs is executed:&lt;br/&gt;
 1. The session now contains the following attributes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;DefaultSubjectContext.PRINCIPALS_SESSION_KEY = user1&lt;/li&gt;
	&lt;li&gt;DelegatingSubject.RUN_AS_PRINCIPALS_SESSION_KEY = &lt;span class=&quot;error&quot;&gt;&amp;#91;user2&amp;#93;&lt;/span&gt;;&lt;br/&gt;
 2. When the next request is fired, we enter the filter chain and get to mergePrincipals. &lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;At this point &lt;br/&gt;
 PrincipalCollection currentPrincipals = subject.getPrincipals(); (DefaultSubjectDAO, line 177) &lt;br/&gt;
will return &quot;user2&quot; as it is the top item in the runAs stack.&lt;/p&gt;

&lt;p&gt;After that  &lt;br/&gt;
 PrincipalCollection existingPrincipals = (PrincipalCollection) session.getAttribute(DefaultSubjectContext.PRINCIPALS_SESSION_KEY); (line 187) &lt;br/&gt;
will return &quot;user1&quot; as it is saved in the session.&lt;/p&gt;

&lt;p&gt;And here the initial principal is overwritten (lines 196 to 198):&lt;/p&gt;

&lt;p&gt; // currentPrincipals == user2, existingPrincipals = user1&lt;br/&gt;
 if (!currentPrincipals.equals(existingPrincipals)) &lt;/p&gt;
{
    session.setAttribute(DefaultSubjectContext.PRINCIPALS_SESSION_KEY, currentPrincipals); 
 }

&lt;p&gt;Whew, hope I got that right. I&apos;ve attached a diff with changes that solved this issue for me. The changes are rather minor - initial prinicpal is saved to session during login and restored when the runAs stack is emptied.&lt;/p&gt;

&lt;p&gt;P.S. All line numbers and the diff file are taken from 1.2.1 relase tag (&lt;a href=&quot;https://svn.apache.org/repos/asf/shiro/tags/shiro-root-1.2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/shiro/tags/shiro-root-1.2.1&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="13486592" author="lhazlewood" created="Tue, 30 Oct 2012 01:34:53 +0000"  >&lt;p&gt;Jochen and Elijah thanks for your help!!!  Jochen, the sample web app was a HUGE help, I wish all bug reports had one of these &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  Great stuff!&lt;/p&gt;

&lt;p&gt;I just committed a hotfix for this using a sneaky bit of reflection to ensure point-version forwards and backwards compatibility (new non-private fields, constants and methods can only be introduced during minor point revision releases (i.e. 1.2 -&amp;gt; 1.3, but not 1.2.1 -&amp;gt; 1.2.2).&lt;/p&gt;

&lt;p&gt;I tested with Jochen&apos;s web app and all appears to be well. &lt;/p&gt;

&lt;p&gt;Jochen, I also added another action to your servlet, &quot;pop&quot;, i.e. localhost:8080/shiro380/login?action=pop which calls subject.releaseRunAs();&lt;/p&gt;

&lt;p&gt;This allows me to action=runas or action=runas2 as many times as I wanted.  Each action=pop request would pop the stack and, when depleted, would return the original Subject principals as expected.    This would have been a bit harder to test without your webapp - thanks again!&lt;/p&gt;

&lt;p&gt;For those following along, if you&apos;re willing, please try the latest 1.2.x branch (1.2.2-SNAPSHOT) and feel free to test it out.&lt;/p&gt;

&lt;p&gt;Thanks again,&lt;/p&gt;

&lt;p&gt;Les&lt;/p&gt;</comment>
                            <comment id="13487294" author="lhazlewood" created="Tue, 30 Oct 2012 22:12:02 +0000"  >&lt;p&gt;Fixed in the 1.2.x branch (with test cases) and ported to trunk (1.3.0-SNAPSHOT).  Thanks to Jochen and Elijah for their debugging help!&lt;/p&gt;

&lt;p&gt;If there are any further issues related to this prior to a 1.2.2 and/or 1.3.0 release, please re-open this issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                            <outwardlinks description="is a clone of">
                                        <issuelink>
            <issuekey id="12540599">SHIRO-344</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12539882" name="SHIRO-380-patch1.diff" size="3122" author="elijah.korneckis" created="Wed, 8 Aug 2012 15:54:48 +0000"/>
                            <attachment id="12539664" name="shiro_380_webapp.tgz" size="3657" author="zefixlluja" created="Tue, 7 Aug 2012 16:30:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>252914</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 3 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0daan:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>75597</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>