<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:35:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SHIRO-515] ExecutorServiceSessionValidationScheduler leaks resources due to improper synchronization</title>
                <link>https://issues.apache.org/jira/browse/SHIRO-515</link>
                <project id="12310950" key="SHIRO">Shiro</project>
                    <description>&lt;p&gt;Related to &lt;a href=&quot;https://issues.apache.org/jira/browse/SHIRO-514&quot; title=&quot;ExecutorServiceSessionValidationScheduler should create threads with a configurable name&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SHIRO-514&quot;&gt;&lt;del&gt;SHIRO-514&lt;/del&gt;&lt;/a&gt;, which talks about a bunch of threads with &quot;ugly&quot; names. This ticket is about &lt;em&gt;why&lt;/em&gt; there are multiple of those in the first place.&lt;/p&gt;

&lt;p&gt;From my heap dump I can see about 71 ThreadFactory instances of ExecutorServiceSessionValidationScheduler$1, each actually linking to a distinct ScheduledThreadPoolExecutor, and each running one thread.&lt;br/&gt;
However, there are only 2 ExecutorServiceSessionValidationScheduler instances.&lt;/p&gt;

&lt;p&gt;The problem is in AbstractValidatingSessionManager#enableSessionValidationIfNecessary(): if this method is called from multiple threads, and those threads race in such a way that multiple ones see an unset/not-yet-enabled scheduler, they will each run #enableSessionValidation(), which creates a scheduler, sets it (still disabled), and then runs SessionValidationScheduler#enableSessionValidation(), which might set its &apos;enabled&apos; flag to true. In the case of the default ExecutorServiceSessionValidationScheduler this creates the thread pool executor, and schedules the validation run iff there is a positive interval configured.&lt;/p&gt;

&lt;p&gt;The race is not particularly unlikely when an application using shiro is deployed and many requests hit it immediately. As Shiro is leaking both JVM and system resources here it&apos;s also not a benign race. &lt;/p&gt;

&lt;p&gt;The attached patch changes the sessionValidationScheduler to be volatile, and makes #enableSessionValidation() as  well as #disableSessionValidation()  &lt;tt&gt;synchronized&lt;/tt&gt;.&lt;br/&gt;
#enableSessionValidationIfNecessary() is not synchronized in the common case to avoid too much blocking when everything is properly warmed up, but rather uses double-checked locking. Shiro targets a 1.5 JVM from what I can see, so this should be ok.&lt;/p&gt;

&lt;p&gt;Note that callers can possibly still produce issues by modifying the field directly.&lt;/p&gt;

&lt;p&gt;Additionally the ExecutorServiceSessionValidationScheduler was changed to report &apos;enabled&apos; when someone tried enabling the validation, regardless of whether the interval was 0 or not. The rationale here is that someone might try disabling the validation by setting the interval, which would mean useless calls to #enableSessionValidation() in every request.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12735405">SHIRO-515</key>
            <summary>ExecutorServiceSessionValidationScheduler leaks resources due to improper synchronization</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ankon">Andreas Kohn</reporter>
                        <labels>
                            <label>patch</label>
                    </labels>
                <created>Wed, 20 Aug 2014 13:51:29 +0000</created>
                <updated>Wed, 29 Jun 2016 22:22:12 +0000</updated>
                            <resolved>Wed, 29 Jun 2016 17:32:53 +0000</resolved>
                                    <version>1.2.3</version>
                                    <fixVersion>1.3.0</fixVersion>
                                    <component>Session Management</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14322641" author="ankon" created="Mon, 16 Feb 2015 10:54:13 +0000"  >&lt;p&gt;Any news/feedback on this issue? &lt;/p&gt;</comment>
                            <comment id="14950151" author="ankon" created="Fri, 9 Oct 2015 09:53:46 +0000"  >&lt;p&gt;Another half year over, and not even some feedback.&lt;/p&gt;

&lt;p&gt;Maybe the text isn&apos;t obvious, so here&apos;s a TL;DR: Shiro will run out of memory and native resources. Shiro has really bad race conditions. And as a security framework I&apos;m growing concerned about relying further on it.&lt;/p&gt;</comment>
                            <comment id="15201800" author="ankon" created="Fri, 18 Mar 2016 17:11:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SHIRO-443&quot; title=&quot;SessionValidationScheduler created multiple times, enabling it is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SHIRO-443&quot;&gt;&lt;del&gt;SHIRO-443&lt;/del&gt;&lt;/a&gt; looks like it describes/solves the same problem. That issue doesn&apos;t have any comments from any Shiro developer either as of now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15351405" author="bdemers" created="Mon, 27 Jun 2016 17:00:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ankon&quot; class=&quot;user-hover&quot; rel=&quot;ankon&quot;&gt;ankon&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/SHIRO-443&quot; title=&quot;SessionValidationScheduler created multiple times, enabling it is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SHIRO-443&quot;&gt;&lt;del&gt;SHIRO-443&lt;/del&gt;&lt;/a&gt; was resolved in 1.2.5, looks like there are a couple extra diffs in your patch.&lt;br/&gt;
Can you update this issue with what is left (and possibly a pull request) ?&lt;/p&gt;</comment>
                            <comment id="15353037" author="ankon" created="Tue, 28 Jun 2016 14:06:32 +0000"  >&lt;p&gt;The changes to ExecutorServiceSessionValidationScheduler are still relevant:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Additionally the ExecutorServiceSessionValidationScheduler was changed to report &apos;enabled&apos; when someone tried enabling the validation, regardless of whether the interval was 0 or not. The rationale here is that someone might try disabling the validation by setting the interval, which would mean useless calls to #enableSessionValidation() in every request.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The &lt;tt&gt;synchronized&lt;/tt&gt; for &lt;tt&gt;#disableSessionValidation()&lt;/tt&gt; is also still needed, as you might otherwise hit a case where two threads could possibly try to destroy the same scheduler. That&apos;s probably &quot;just weird&quot;, but I think it makes the code easier to read when symmetric methods look symmetric. &lt;/p&gt;

&lt;p&gt;The volatile addition is not needed I think, and the copy-pasted code inside #enableSessionValidationIfNecessary() also isn&apos;t required as the #enableSessionValidation() is synchronized, and so would do the right thing. &lt;/p&gt;

&lt;p&gt;I can create a PR with those needed parts for this ticket, or should I also create a new issue?&lt;/p&gt;</comment>
                            <comment id="15353305" author="bdemers" created="Tue, 28 Jun 2016 16:18:28 +0000"  >&lt;p&gt;This ticket is fine, keeping it here in context is probably a good idea anyway.&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ankon&quot; class=&quot;user-hover&quot; rel=&quot;ankon&quot;&gt;ankon&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="15353361" author="githubbot" created="Tue, 28 Jun 2016 16:49:23 +0000"  >&lt;p&gt;GitHub user ankon opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/shiro/pull/21&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/shiro/pull/21&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/SHIRO-515&quot; title=&quot;ExecutorServiceSessionValidationScheduler leaks resources due to improper synchronization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SHIRO-515&quot;&gt;&lt;del&gt;SHIRO-515&lt;/del&gt;&lt;/a&gt;: Better synchronization for the session validation&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/Collaborne/shiro&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Collaborne/shiro&lt;/a&gt; issue/&lt;a href=&quot;https://issues.apache.org/jira/browse/SHIRO-515&quot; title=&quot;ExecutorServiceSessionValidationScheduler leaks resources due to improper synchronization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SHIRO-515&quot;&gt;&lt;del&gt;SHIRO-515&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/shiro/pull/21.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/shiro/pull/21.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #21&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d0fa29360dca827c5e293ce112b6c2d646bb6124&lt;br/&gt;
Author: Andreas Kohn &amp;lt;andreas.kohn@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-06-28T16:46:51Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/SHIRO-515&quot; title=&quot;ExecutorServiceSessionValidationScheduler leaks resources due to improper synchronization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SHIRO-515&quot;&gt;&lt;del&gt;SHIRO-515&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;1/2&amp;#93;&lt;/span&gt; Mark the ExecutorServiceSessionValidationScheduler &quot;enabled&quot; even with a 0 interval&lt;/p&gt;

&lt;p&gt;commit dfb0e3691e3bddd6f0c3f92116d21e4039ee5cab&lt;br/&gt;
Author: Andreas Kohn &amp;lt;andreas.kohn@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-06-28T16:47:18Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/SHIRO-515&quot; title=&quot;ExecutorServiceSessionValidationScheduler leaks resources due to improper synchronization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SHIRO-515&quot;&gt;&lt;del&gt;SHIRO-515&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;2/2&amp;#93;&lt;/span&gt; &apos;synchronized&apos; #disableSessionValidation()&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15355910" author="githubbot" created="Wed, 29 Jun 2016 22:22:12 +0000"  >&lt;p&gt;Github user ankon closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/shiro/pull/21&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/shiro/pull/21&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12649063">SHIRO-443</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12735380">SHIRO-514</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12663130" name="SHIRO-515-race.patch" size="3293" author="ankon" created="Wed, 20 Aug 2014 13:54:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 20 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i00ytj:00000000000009</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>