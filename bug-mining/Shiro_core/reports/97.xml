<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:35:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SHIRO-512] Race condition in Shiro&apos;s web container session timeout handling</title>
                <link>https://issues.apache.org/jira/browse/SHIRO-512</link>
                <project id="12310950" key="SHIRO">Shiro</project>
                    <description>&lt;p&gt;I cannot find anywhere that Shiro uses HttpSessionListener to trap sessionDestroyed event from the container. &lt;br/&gt;
I believe this is leading to a rare race condition in my application, as Shiro thinks the session is still active, &lt;br/&gt;
but in reality, the web session has been destroyed. &lt;/p&gt;

&lt;p&gt;Code:  SecurityUtils.getSubject().getPrincipal(); &lt;/p&gt;

&lt;p&gt;Relevant bit of stack trace: &lt;/p&gt;

&lt;p&gt;Caused by: org.apache.shiro.session.InvalidSessionException: java.lang.IllegalStateException: PWC2778: getAttribute: Session already invalidated &lt;br/&gt;
        at org.apache.shiro.web.session.HttpServletSession.getAttribute(HttpServletSession.java:148) &lt;br/&gt;
        at org.apache.shiro.session.ProxiedSession.getAttribute(ProxiedSession.java:121) &lt;br/&gt;
        at org.apache.shiro.subject.support.DelegatingSubject.getRunAsPrincipalsStack(DelegatingSubject.java:469) &lt;br/&gt;
        at org.apache.shiro.subject.support.DelegatingSubject.getPrincipals(DelegatingSubject.java:153) &lt;br/&gt;
        at org.apache.shiro.subject.support.DelegatingSubject.getPrincipal(DelegatingSubject.java:149) &lt;/p&gt;


&lt;p&gt;Link to the mailing list thread: &lt;br/&gt;
&lt;a href=&quot;http://shiro-user.582556.n2.nabble.com/Possible-race-condition-in-Shiro-s-web-container-session-timeout-handling-td7580138.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://shiro-user.582556.n2.nabble.com/Possible-race-condition-in-Shiro-s-web-container-session-timeout-handling-td7580138.html&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12733787">SHIRO-512</key>
            <summary>Race condition in Shiro&apos;s web container session timeout handling</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10003">Resolved</resolution>
                                        <assignee username="fpapon">Francois Papon</assignee>
                                    <reporter username="lprimak">Lenny Primak</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Aug 2014 15:05:19 +0000</created>
                <updated>Wed, 12 Oct 2022 15:50:06 +0000</updated>
                            <resolved>Mon, 26 Sep 2022 06:38:09 +0000</resolved>
                                    <version>1.2.2</version>
                    <version>1.2.3</version>
                                    <fixVersion>2.0.0-alpha</fixVersion>
                    <fixVersion>1.10.0</fixVersion>
                                    <component>Authentication (log-in)</component>
                        <due></due>
                            <votes>5</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="9000">2.5h</timespent>
                                <comments>
                            <comment id="14354859" author="burlaka" created="Tue, 10 Mar 2015 13:15:54 +0000"  >&lt;p&gt;I also have similar issue:&lt;br/&gt;
org.apache.shiro.session.InvalidSessionException: java.lang.IllegalStateException: getAttribute: Session already invalidated&lt;br/&gt;
        at org.apache.shiro.web.session.HttpServletSession.getAttribute(HttpServletSession.java:148) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;HttpServletSession.class:1.2.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.shiro.session.ProxiedSession.getAttribute(ProxiedSession.java:121) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;ProxiedSession.class:1.2.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.shiro.session.ProxiedSession.getAttribute(ProxiedSession.java:121) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;ProxiedSession.class:1.2.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.shiro.subject.support.DelegatingSubject.getRunAsPrincipalsStack(DelegatingSubject.java:469) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;DelegatingSubject.class:1.2.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.shiro.subject.support.DelegatingSubject.getPrincipals(DelegatingSubject.java:153) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;DelegatingSubject.class:1.2.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.shiro.subject.support.DelegatingSubject.hasPrincipals(DelegatingSubject.java:126) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;DelegatingSubject.class:1.2.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.shiro.subject.support.DelegatingSubject.isPermitted(DelegatingSubject.java:158) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;DelegatingSubject.class:1.2.3&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16193222" author="otter606" created="Thu, 5 Oct 2017 17:19:28 +0000"  >&lt;p&gt;Don&apos;t know if this is related but I occasionally see the same exception when running background jobs launched through a REST -API call with &lt;tt&gt;noSessionCreation&lt;/tt&gt; set to true. In brief:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Client submits POST request to launch long-running job, using an API key in the header to authenticate&lt;/li&gt;
	&lt;li&gt;Server authenticates( we can identify a Shiro subject from the key) and logs them in for the duration of the call&lt;/li&gt;
	&lt;li&gt;Server creates a new job to run in background. Subject is bound to this background thread&lt;/li&gt;
	&lt;li&gt;Server returns quickly, logging out the subject, with a response containing a job  id to query job progress&lt;/li&gt;
	&lt;li&gt;Some time later, the job starts. While the job is running, it has to do some permissions authorisation, calling exactly the same stack as listed above. Most of the time it works, but occasionally I get this stack trace. I am puzzled as there should not be any session created at all - the user is not logged into the web application while making the API call for example.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I am using Java 8, Tomcat 7.054, Spring 4.3.1 and Shiro 1.4.0. I have tried exploring the relative timing of when the initial request returns, and when the job is launched, and no combination reproduces this error deterministically. E.g. &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;pausing job in debug mode to ensure initial submission post request returns before permissions lookups&lt;/li&gt;
	&lt;li&gt;pausing return from initial post to ensure job starts before initial request is logged out.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Here is the code in  a Spring Interceptor which wraps round each  api request:&lt;br/&gt;
pre request: &lt;tt&gt;SecurityUtils.getSubject().login(new ApiKeyAuthenticationToken(u.getUsername(), apiKey));&lt;/tt&gt;&lt;br/&gt;
post request: &lt;tt&gt;SecurityUtils.getSubject().logout();&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Thanks for any help on this or if anyone else has got this stack trace.&lt;br/&gt;
I would say that I only see this on Tomcat, never on Jetty, have no idea if this is relevant.&lt;/p&gt;

&lt;p&gt;Richard&lt;/p&gt;

</comment>
                            <comment id="17600072" author="lprimak" created="Sun, 4 Sep 2022 15:22:59 +0000"  >&lt;p&gt;Any updates? I will try to see if I can fix this in Shrio and contribute at some point &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17600202" author="lprimak" created="Mon, 5 Sep 2022 05:20:11 +0000"  >&lt;p&gt;Pull request submitted: &lt;a href=&quot;https://github.com/apache/shiro/pull/372&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/shiro/pull/372&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17600204" author="lprimak" created="Mon, 5 Sep 2022 05:29:57 +0000"  >&lt;p&gt;Looks like there is something&apos;s wrong with some test environment in ASF Jenkins:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
com.github.mjeanroy.junit.servers.exceptions.ServerStartException: java.io.IOException: Failed to bind to 0.0.0.0/0.0.0.0:37081
Caused by: java.io.IOException: Failed to bind to 0.0.0.0/0.0.0.0:37081
Caused by: java.net.BindException: Address already in use &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411815</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 9 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i00ytj:0000000000004</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411806</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>