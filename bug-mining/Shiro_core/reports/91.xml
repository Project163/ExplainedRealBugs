<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:35:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SHIRO-552] JdbcRealm in SaltStyle.COLUMN assumes that password column is Base64 but salt column is utf8 bytes</title>
                <link>https://issues.apache.org/jira/browse/SHIRO-552</link>
                <project id="12310950" key="SHIRO">Shiro</project>
                    <description>&lt;p&gt;The &lt;tt&gt;org.apache.shiro.realm.jdbc.JdbcRealm&lt;/tt&gt; class, when configured with SaltStyle.COLUMN, assumes that password column is Base64 but salt column is utf8 bytes.&lt;/p&gt;

&lt;p&gt;The password is returned as a &lt;tt&gt;char[]&lt;/tt&gt; (see JdbcRealm.java:241), which &lt;tt&gt;org.apache.shiro.authc.credential.HashedCredentialsMatcher&lt;/tt&gt; (see HashedCredentialsMatcher.java:353):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (credentials &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; || credentials &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;[]) {
            &lt;span class=&quot;code-comment&quot;&gt;//account.credentials were a &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;[] or &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, so
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;//we need to &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; text decoding first:
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isStoredCredentialsHexEncoded()) {
                storedBytes = Hex.decode(storedBytes);
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                storedBytes = Base64.decode(storedBytes);
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, the salt is returned as a &lt;tt&gt;ByteSource&lt;/tt&gt;, by converting the DB-returned String into its UTF-8 bytes. See JdbcRealm.java:224:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (salt != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                info.setCredentialsSalt(ByteSource.Util.bytes(salt));
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is broken and inconsistent.&lt;/p&gt;

&lt;p&gt;Not all salt byte[]s are valid UTF8 strings, so the default assumption should be that the salt column is Base64 encoded.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12922734">SHIRO-552</key>
            <summary>JdbcRealm in SaltStyle.COLUMN assumes that password column is Base64 but salt column is utf8 bytes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10003">Resolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="richard.bradley">Richard Bradley</reporter>
                        <labels>
                    </labels>
                <created>Thu, 17 Dec 2015 15:01:50 +0000</created>
                <updated>Fri, 2 Aug 2019 19:08:10 +0000</updated>
                            <resolved>Fri, 2 Aug 2019 19:08:10 +0000</resolved>
                                    <version>1.2.4</version>
                                    <fixVersion>1.5.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                <comments>
                            <comment id="16052811" author="sb@dod.no" created="Sat, 17 Jun 2017 12:12:17 +0000"  >&lt;p&gt;This one bit me today.&lt;/p&gt;

&lt;p&gt;I&apos;m trying to use salt from a password table used by my own custom realm &lt;a href=&quot;https://github.com/steinarb/ukelonn/blob/master/ukelonn.bundle/src/main/java/no/priv/bang/ukelonn/impl/UkelonnRealm.java#L60&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;UkelonnRealm&lt;/a&gt; from a JdbcRealm, but that breaks because the base64 encoded salt value from the DB is interpreted as UTF-8 when converting the salt into a byte array.&lt;/p&gt;

&lt;p&gt;I&apos;ve been looking for a way to configure the encoding of the salt in JdbcRealm, but there doesn&apos;t seem to be any way to do this?&lt;/p&gt;</comment>
                            <comment id="16053244" author="sb@dod.no" created="Sun, 18 Jun 2017 15:57:08 +0000"  >&lt;p&gt;I&apos;ve been trying to convert my existing salt to a form understood by the JdbcRealm but so far I&apos;ve failed:&lt;br/&gt;
I can&apos;t get the same byte[] out of CodecSupport.toBytes(String) that I&apos;m putting in.&lt;/p&gt;

&lt;p&gt;Has anyone successfully used the JdbcRealm with salt?&lt;/p&gt;

&lt;p&gt;So far I haven&apos;t found any google matches that shows working code examples of this.  The closest I&apos;ve been getting is &lt;a href=&quot;https://stackoverflow.com/a/23755827&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this stackoverflow answer&lt;/a&gt;, which has saving the salt as a TODO&lt;/p&gt;

&lt;p&gt;This is what I&apos;ve done to try to fix the salt in the database:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Add a liquibase changeset that adds a new column to the users table in the database
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;changeSet author=&lt;span class=&quot;code-quote&quot;&gt;&quot;sb&quot;&lt;/span&gt; id=&lt;span class=&quot;code-quote&quot;&gt;&quot;add-password-salt-column-to-users-table&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;addColumn tableName=&lt;span class=&quot;code-quote&quot;&gt;&quot;users&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;column name=&lt;span class=&quot;code-quote&quot;&gt;&quot;password_salt&quot;&lt;/span&gt; type=&lt;span class=&quot;code-quote&quot;&gt;&quot;varchar(255)&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/addColumn&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/changeSet&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Add a liquibase changeset that runs a custom task to convert the old base64 encoded salt values to utf-8 encoded salt values
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;changeSet author=&lt;span class=&quot;code-quote&quot;&gt;&quot;sb&quot;&lt;/span&gt; id=&lt;span class=&quot;code-quote&quot;&gt;&quot;convert-salt-from-base64-to-utf8&quot;&lt;/span&gt; runAlways=&lt;span class=&quot;code-quote&quot;&gt;&quot;false&quot;&lt;/span&gt; failOnError=&quot;true&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;customChange class=&lt;span class=&quot;code-quote&quot;&gt;&quot;no.priv.bang.ukelonn.bundle.db.liquibase.customchange.ConvertUsersTableSaltEncodingFromBase64ToUtf8&quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/changeSet&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The essential part of the custom task, is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ConvertUsersTableSaltEncodingFromBase64ToUtf8 &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; CustomTaskChange {

	@Override
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void execute(Database database) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; CustomChangeException {
	    JdbcConnection connection = (JdbcConnection) database.getConnection();
	    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
	        PreparedStatement getsalt = connection.prepareStatement(&lt;span class=&quot;code-quote&quot;&gt;&quot;select user_id, salt from users&quot;&lt;/span&gt;);
	        PreparedStatement updateUtf8EncodedSalt = connection.prepareStatement(&lt;span class=&quot;code-quote&quot;&gt;&quot;update users set password_salt=? where user_id=?&quot;&lt;/span&gt;);
	        ResultSet result = getsalt.executeQuery();
	        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(result.next()) {
	            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; userId = result.getInt(0);
	            &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; base64EncodedSalt = result.getString(1);
	            &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] decodedSalt = Base64.getDecoder().decode(base64EncodedSalt);
	            &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;[] utf8EncodedSalt = CodecSupport.toChars(decodedSalt);
                &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; utf8EncodedSalt = CodecSupport.toString(decodedSalt);
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; utf8EncodedSalt = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;(decodedSalt, StandardCharsets.UTF_8);
&lt;/span&gt;	            updateUtf8EncodedSalt.setString(0, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;(utf8EncodedSalt));
	            updateUtf8EncodedSalt.setInt(1, userId);
	            updateUtf8EncodedSalt.executeUpdate();
	        }
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CustomChangeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to convert users table salt values from base64 to utf-8&quot;&lt;/span&gt;, e);
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The variuous commented out variants all give the same results:&lt;br/&gt;
What I put in, is:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[34, -17, 112, -83, -19, -119, -127, 123, -79, -67, 20, -10, 48, 13, 2, 25]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;What I get out, is:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[34, -17, -65, -67, 112, -17, -65, -67, -19, -119, -127, 123, -17, -65, -67, -17, -65, -67, 20, -17, -65, -67, 48, 13, 2, 25]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There is a pattern there: byte three in the original sequence can be found as byte 5 in the second, the start and end are the same in both sequences&lt;/p&gt;

&lt;p&gt;But trying to figure out what the correct way of encoding the salt should be has so far evaded me...&lt;/p&gt;

&lt;p&gt;Base64 would have been much simpler, and I know from my own custom realm: it works&lt;br/&gt;
(and when I think about it: the issues around the salt may be why I ended up with a custom realm last autumn...? I remember something vaguely about that)&lt;/p&gt;</comment>
                            <comment id="16053721" author="richard.bradley" created="Mon, 19 Jun 2017 09:48:32 +0000"  >&lt;p&gt;&amp;gt; I&apos;ve been trying to convert my existing salt to a form understood by the JdbcRealm but so far I&apos;ve failed:&lt;br/&gt;
&amp;gt; ...&lt;br/&gt;
&amp;gt; But trying to figure out what the correct way of encoding the salt should be has so far evaded me...&lt;/p&gt;

&lt;p&gt;Those salt bytes are not a valid UTF-8 byte sequence, so any sensible database / database client will not allow you to store them as a UTF-8 string.&lt;br/&gt;
There is no way of configuring or encoding JdbcRealm to fix this; the code needs changing so that either a) the salt is stored Base64 encoded in a String column or b) the salt is stored in a binary column.&lt;/p&gt;

&lt;p&gt;You can either fork Shiro and make this change (please submit this change upstream for the benefit of all if you do), or you could write your own Realm which includes this change.&lt;/p&gt;

&lt;p&gt;GL,&lt;/p&gt;


&lt;p&gt;Rich&lt;/p&gt;</comment>
                            <comment id="16054619" author="sb@dod.no" created="Mon, 19 Jun 2017 19:19:40 +0000"  >&lt;p&gt;Thanks.  For now I&apos;m staying with &lt;a href=&quot;https://github.com/steinarb/ukelonn/blob/master/ukelonn.bundle/src/main/java/no/priv/bang/ukelonn/impl/UkelonnRealm.java#L28&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;my eksisting custom realm&lt;/a&gt; (which does base64 encoding of the salt).&lt;/p&gt;

&lt;p&gt;Another workaround would be to go to hex encoding of the password and the salt.  Presumably that works...?&lt;/p&gt;</comment>
                            <comment id="16055409" author="richard.bradley" created="Tue, 20 Jun 2017 09:04:00 +0000"  >&lt;p&gt;&amp;gt; Another workaround would be to go to hex encoding of the password and the salt. Presumably that works...?&lt;/p&gt;

&lt;p&gt;Yes, any reversible binary safe encoding would work. Base64 is a lot denser than hexadecimal strings though, so would be more efficient.&lt;/p&gt;</comment>
                            <comment id="16851284" author="sb@dod.no" created="Wed, 29 May 2019 20:30:07 +0000"  >&lt;p&gt;I&apos;ve created a github pull request with a fix for this issue: &lt;a href=&quot;https://github.com/apache/shiro/pull/138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/shiro/pull/138&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16899149" author="fpapon" created="Fri, 2 Aug 2019 19:08:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sb%40dod.no&quot; class=&quot;user-hover&quot; rel=&quot;sb@dod.no&quot;&gt;sb@dod.no&lt;/a&gt; thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 15 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2q1h3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>