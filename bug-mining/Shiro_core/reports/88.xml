<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:35:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SHIRO-457] Login without static VM security manager cause exception in debug</title>
                <link>https://issues.apache.org/jira/browse/SHIRO-457</link>
                <project id="12310950" key="SHIRO">Shiro</project>
                    <description>&lt;p&gt;I have run into a possible issue with regards to using the Subject login(use,pwd) api when the SecurityUtils SecurityManager has not been set (SecurityUtils.setSecurityManager(secMgr).&lt;/p&gt;

&lt;p&gt;        Subject currentUser = new Subject.Builder(securityManager).buildSubject();&lt;br/&gt;
        UsernamePasswordToken token = new UsernamePasswordToken(userName, password);&lt;br/&gt;
        currentUser.login(token);&lt;/p&gt;

&lt;p&gt;The code above results in an exception (this exception is not the end of the world as later in the code the current default security manager will get set so all should be ok):&lt;/p&gt;

&lt;p&gt;15:31:01.325 &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; DEBUG o.a.s.s.s.DefaultSubjectContext - No SecurityManager available via SecurityUtils.  Heuristics exhausted.&lt;br/&gt;
org.apache.shiro.UnavailableSecurityManagerException: No SecurityManager accessible to the calling code, either bound to the org.apache.shiro.util.ThreadContext or as a vm static singleton.  This is an invalid application configuration.&lt;br/&gt;
 	at org.apache.shiro.SecurityUtils.getSecurityManager(SecurityUtils.java:123) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;shiro-core-1.2.1.jar:1.2.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
 	at org.apache.shiro.subject.support.DefaultSubjectContext.resolveSecurityManager(DefaultSubjectContext.java:106) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;shiro-core-1.2.1.jar:1.2.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
 	at org.apache.shiro.mgt.DefaultSecurityManager.ensureSecurityManager(DefaultSecurityManager.java:411) &lt;span class=&quot;error&quot;&gt;&amp;#91;shiro-core-1.2.1.jar:1.2.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
 	at org.apache.shiro.mgt.DefaultSecurityManager.createSubject(DefaultSecurityManager.java:333) &lt;span class=&quot;error&quot;&gt;&amp;#91;shiro-core-1.2.1.jar:1.2.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
 	at org.apache.shiro.mgt.DefaultSecurityManager.createSubject(DefaultSecurityManager.java:183) &lt;span class=&quot;error&quot;&gt;&amp;#91;shiro-core-1.2.1.jar:1.2.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
 	at org.apache.shiro.mgt.DefaultSecurityManager.login(DefaultSecurityManager.java:283) &lt;span class=&quot;error&quot;&gt;&amp;#91;shiro-core-1.2.1.jar:1.2.1&amp;#93;&lt;/span&gt;&lt;br/&gt;
 	at org.apache.shiro.subject.support.DelegatingSubject.login(DelegatingSubject.java:256) &lt;span class=&quot;error&quot;&gt;&amp;#91;shiro-core-1.2.1.jar:1.2.1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;I think the issue rises from line 1 of the following code in DefaultSecurityManager:&lt;/p&gt;

&lt;p&gt;    protected Subject createSubject(AuthenticationToken token, AuthenticationInfo info, Subject existing) {&lt;br/&gt;
        SubjectContext context = createSubjectContext();  &amp;lt;-- Results in a context with no security manager&lt;br/&gt;
        context.setAuthenticated(true);&lt;br/&gt;
        context.setAuthenticationToken(token);&lt;br/&gt;
        context.setAuthenticationInfo(info);&lt;br/&gt;
        if (existing != null) &lt;/p&gt;
{
            context.setSubject(existing);
        }&lt;br/&gt;
        return createSubject(context); &amp;lt;-- This complains about no security manager&lt;br/&gt;
    }&lt;br/&gt;
&lt;br/&gt;
Could the DefaultSecurityManager code instead be as follows?&lt;br/&gt;
&lt;br/&gt;
    protected Subject createSubject(AuthenticationToken token, AuthenticationInfo info, Subject existing) {&lt;br/&gt;
        SubjectContext context = createSubjectContext();&lt;br/&gt;
        context.setAuthenticated(true);&lt;br/&gt;
        context.setAuthenticationToken(token);&lt;br/&gt;
        context.setAuthenticationInfo(info);&lt;br/&gt;
        context.setSecurityManager(this); &amp;lt;-- Set the security manager before the createSubject&lt;br/&gt;
        if (existing != null) {            context.setSubject(existing);        }
&lt;p&gt;        return createSubject(context);&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;This exception can be masked but I think it would be better not to raise it in this scenario.&lt;/p&gt;</description>
                <environment>Mac OS X 10.8.3, Java 1.6.0_51</environment>
        <key id="12668739">SHIRO-457</key>
            <summary>Login without static VM security manager cause exception in debug</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10003">Resolved</resolution>
                                        <assignee username="fpapon">Francois Papon</assignee>
                                    <reporter username="trisport88">Stuart Broad</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Sep 2013 08:38:28 +0000</created>
                <updated>Tue, 29 Jan 2019 04:56:31 +0000</updated>
                            <resolved>Tue, 29 Jan 2019 04:56:31 +0000</resolved>
                                    <version>1.2.2</version>
                                    <fixVersion>1.4.1</fixVersion>
                                    <component>Authentication (log-in)</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13771169" author="sriharshareddyk" created="Wed, 18 Sep 2013 20:02:21 +0000"  >&lt;p&gt;I don&apos;t think there is any need to change the DefaultSecurityManager the createSubject(SubjectContext subjectContext)&lt;/p&gt;
{...}
&lt;p&gt; method already does the check to set the securityManager if not set by the user. The exception can be taken as just a warning to the user. Perhaps the log level should have been set to warn than error or debug.&lt;/p&gt;</comment>
                            <comment id="13771680" author="trisport88" created="Thu, 19 Sep 2013 08:01:17 +0000"  >&lt;p&gt;In the context of logging in without a static VM security manager I don&apos;t think it makes sense to have this exception:&lt;/p&gt;

&lt;p&gt;a) It will happen every time someone logs in&lt;br/&gt;
b) It looks &apos;scary&apos; - Looking at the debug you will think there is something wrong (Yes you can still mask it, but you would still have the overhead of creating and throwing the exception within the code).&lt;br/&gt;
c) Why not add the one line to set the security manager?  It would remove the exception and would be a more efficient way of setting it in this context.&lt;/p&gt;

&lt;p&gt;If people MUST set a static VM security manager then this exception would make sense but my understanding is that not using a static VM security manager is the way to go.&lt;/p&gt;</comment>
                            <comment id="13771813" author="sriharshareddyk" created="Thu, 19 Sep 2013 11:48:48 +0000"  >&lt;p&gt;Your take is reasonable and I agree with you explanation.&lt;/p&gt;</comment>
                            <comment id="13771835" author="trisport88" created="Thu, 19 Sep 2013 12:32:02 +0000"  >&lt;p&gt;Thanks for the re-evaluation.&lt;/p&gt;</comment>
                            <comment id="13827523" author="trisport88" created="Wed, 20 Nov 2013 10:45:30 +0000"  >&lt;p&gt;I have just come across another side issue that I think is related to the above code (which the above fix would also resolve).&lt;/p&gt;

&lt;p&gt;SecurityUtils.getSecurityManager()&lt;br/&gt;
-&amp;gt;&lt;br/&gt;
ThreadContext.getSecurityManager()&lt;br/&gt;
-&amp;gt;&lt;br/&gt;
ThreadContext.get(..)&lt;br/&gt;
-&amp;gt;&lt;br/&gt;
ThreadContext$InheritableThreadLocalMap.setInitialValue()&lt;/p&gt;

&lt;p&gt;The above calls are causing a ThreadLocal to be created which tomcat is complaining about on shutdown (I am destroying the security manager):&lt;/p&gt;

&lt;p&gt;SEVERE: The web application &lt;span class=&quot;error&quot;&gt;&amp;#91;/xxx&amp;#93;&lt;/span&gt; created a ThreadLocal with key of type &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.shiro.util.ThreadContext.InheritableThreadLocalMap&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.shiro.util.ThreadContext$InheritableThreadLocalMap@1afb7ac7&amp;#93;&lt;/span&gt;) and a value of type &lt;span class=&quot;error&quot;&gt;&amp;#91;java.util.HashMap&amp;#93;&lt;/span&gt; (value &lt;span class=&quot;error&quot;&gt;&amp;#91;{}&amp;#93;&lt;/span&gt;) but failed to remove it when the web application was stopped. Threads are going to be renewed over time to try and avoid a probable memory leak.&lt;/p&gt;

&lt;p&gt;As I mentioned above I am not using a static VM security manager.&lt;/p&gt;

&lt;p&gt;I have not created a new jira ticket for this.&lt;/p&gt;

&lt;p&gt;I have worked around the issue by calling ThreadContext.remove() after logging in.  Not sure if this will have any unwanted side effects (so far so good though).&lt;/p&gt;</comment>
                            <comment id="14032356" author="mjhale" created="Mon, 16 Jun 2014 11:30:07 +0000"  >&lt;p&gt;So, I have a similar issue that would be fixed by this. So if createSubject does not explicitly set the security manager. Then it is left to ensureSecurityManager to fix up the issue. The problem with this is that ensureSecurityManager uses resolveSecurityManager to check for the security manger which delegates to a thread local check. If the thread local contains a different security manager then this will end up being used instead of &quot;this&quot; securitymanager. (Surely it should be getSecurityManager() instead of resolveSecurityManager()???)&lt;/p&gt;

&lt;p&gt;Here is my work-around:&lt;br/&gt;
		// work-around for &lt;a href=&quot;https://issues.apache.org/jira/browse/SHIRO-457&quot; title=&quot;Login without static VM security manager cause exception in debug&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SHIRO-457&quot;&gt;&lt;del&gt;SHIRO-457&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
		// unbind any thread-local security manager to ensure&lt;br/&gt;
		// the SecurityManager passed in to Builder is used&lt;br/&gt;
		org.apache.shiro.mgt.SecurityManager threadSecurityManager = ThreadContext.unbindSecurityManager();&lt;br/&gt;
		Subject subject = new Subject.Builder(securityManager).buildSubject();&lt;br/&gt;
		subject.login(new UsernamePasswordToken(username, password));&lt;br/&gt;
		ThreadContext.bind(threadSecurityManager);&lt;/p&gt;</comment>
                            <comment id="16466835" author="githubbot" created="Tue, 8 May 2018 04:17:42 +0000"  >&lt;p&gt;GitHub user mmpestorich opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/shiro/pull/83&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/shiro/pull/83&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/SHIRO-457&quot; title=&quot;Login without static VM security manager cause exception in debug&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SHIRO-457&quot;&gt;&lt;del&gt;SHIRO-457&lt;/del&gt;&lt;/a&gt; Set SecurityManager in createSubject()&lt;/p&gt;

&lt;p&gt;    When one does not use a static SecurityManager an exception is thrown everytime a new (unauthenticated) subject successfully logs in. See the associated JIRA issue &lt;a href=&quot;https://issues.apache.org/jira/browse/SHIRO-457&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SHIRO-457&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/mmpestorich/shiro&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mmpestorich/shiro&lt;/a&gt; patch-1&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/shiro/pull/83.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/shiro/pull/83.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #83&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 1cb3016efab9b57b68881b2697a23bee040fb2e5&lt;br/&gt;
Author: Mike M Pestorich &amp;lt;mmpestorich@...&amp;gt;&lt;br/&gt;
Date:   2018-05-08T04:17:03Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/SHIRO-457&quot; title=&quot;Login without static VM security manager cause exception in debug&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SHIRO-457&quot;&gt;&lt;del&gt;SHIRO-457&lt;/del&gt;&lt;/a&gt; Set SecurityManager in createSubject()&lt;/p&gt;

&lt;p&gt;    When one does not use a static SecurityManager an exception is thrown everytime a new (unauthenticated) subject successfully logs in. See the associated JIRA issue &lt;a href=&quot;https://issues.apache.org/jira/browse/SHIRO-457&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SHIRO-457&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16466839" author="mmpestorich" created="Tue, 8 May 2018 04:22:35 +0000"  >&lt;p&gt;I added a pull request on github for this. Would really like to see it merged. Makes all the sense in the world to me.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/shiro/pull/83&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;GitHub Pull Request #83&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>348673</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 27 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1o4e7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>348970</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>