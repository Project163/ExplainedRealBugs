{"url":"https://api.github.com/repos/laravel/framework/issues/56944","repository_url":"https://api.github.com/repos/laravel/framework","labels_url":"https://api.github.com/repos/laravel/framework/issues/56944/labels{/name}","comments_url":"https://api.github.com/repos/laravel/framework/issues/56944/comments","events_url":"https://api.github.com/repos/laravel/framework/issues/56944/events","html_url":"https://github.com/laravel/framework/issues/56944","id":3387136961,"node_id":"I_kwDOAHMwOs7J45vB","number":56944,"title":"MariaDB transaction exception not detected","user":{"login":"Muffinman","id":1319568,"node_id":"MDQ6VXNlcjEzMTk1Njg=","avatar_url":"https://avatars.githubusercontent.com/u/1319568?v=4","gravatar_id":"","url":"https://api.github.com/users/Muffinman","html_url":"https://github.com/Muffinman","followers_url":"https://api.github.com/users/Muffinman/followers","following_url":"https://api.github.com/users/Muffinman/following{/other_user}","gists_url":"https://api.github.com/users/Muffinman/gists{/gist_id}","starred_url":"https://api.github.com/users/Muffinman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Muffinman/subscriptions","organizations_url":"https://api.github.com/users/Muffinman/orgs","repos_url":"https://api.github.com/users/Muffinman/repos","events_url":"https://api.github.com/users/Muffinman/events{/privacy}","received_events_url":"https://api.github.com/users/Muffinman/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2025-09-05T10:56:35Z","updated_at":"2025-09-07T22:59:53Z","closed_at":"2025-09-07T22:59:53Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Laravel Version\n\n12.26.4\n\n### PHP Version\n\n8.3.24\n\n### Database Driver & Version\n\n11.8.3-MariaDB\n\n### Description\n\nMariaDB fairly recently introduced a new default value for `innodb_snapshot_isolation`\n\nhttps://mariadb.com/docs/release-notes/community-server/mariadb-10-6-series/mariadb-10-6-18-release-notes\n\nhttps://mariadb.com/docs/server/server-usage/storage-engines/innodb/innodb-system-variables#innodb_snapshot_isolation\n\nThis can cause the following error to be generated by a transaction commit:\n\n```\nPDOException: SQLSTATE[HY000]: General error: 1020 Record has changed since last read in table 'orders' in test.php\n```\n\nThis error is currently not detected as a concurrency error in `ConcurrencyErrorDetector::class` [[ref](https://github.com/laravel/framework/blob/12.x/src/Illuminate/Database/ConcurrencyErrorDetector.php#L26)], so it cannot be retried.\n\n\n\n\n### Steps To Reproduce\n\nHere is a good summary of how to reproduce the problem:\n\nhttps://github.com/DOMjudge/domjudge/issues/2848#issuecomment-2497115621\n\n### Reproduction repo\n\nhttps://github.com/Muffinman/test-concurrency-error\n\n```bash\ngit clone https://github.com/Muffinman/test-concurrency-error\ncd test-concurrency-error\ncp .env.example .env\ndocker compose up -d\nphp artisan key:generate\nphp artisan migrate\nphp artisan app:test-concurrency-exception\n```\n\n### Expected output\n\n```console\n11.8.3-MariaDB-ubu2404\ninnodb_snapshot_isolation = ON\nT1 started\nRow 1 selected in T1\nT2 started\nRow 1 email updated in T2\nT2 committed\nRow 1 ref updated in T1\nT1 committed\n```\n\n### Actual output\n\n```console\n11.8.3-MariaDB-ubu2404\ninnodb_snapshot_isolation = ON\nT1 started\nRow 1 selected in T1\nT2 started\nRow 1 email updated in T2\nT2 committed\n\n   Illuminate\\Database\\QueryException\n\n  SQLSTATE[HY000]: General error: 1020 Record has changed since last read in table 'orders' (Connection: mariadb, SQL: update `orders` set `ref` = 54321 where `id` = 1)\n\n  at vendor/laravel/framework/src/Illuminate/Database/Connection.php:824\n    820▕                     $this->getName(), $query, $this->prepareBindings($bindings), $e\n    821▕                 );\n    822▕             }\n    823▕\n  ➜ 824▕             throw new QueryException(\n    825▕                 $this->getName(), $query, $this->prepareBindings($bindings), $e\n    826▕             );\n    827▕         }\n    828▕     }\n\n      +7 vendor frames\n\n  8   app/Console/Commands/TestConcurrencyException.php:71\n      Illuminate\\Database\\Query\\Builder::update(Object(Illuminate\\Support\\Collection))\n      +1 vendor frames\n\n  10  app/Console/Commands/TestConcurrencyException.php:45\n      Illuminate\\Database\\Connection::transaction(Object(Closure))\n```\n","closed_by":{"login":"taylorotwell","id":463230,"node_id":"MDQ6VXNlcjQ2MzIzMA==","avatar_url":"https://avatars.githubusercontent.com/u/463230?v=4","gravatar_id":"","url":"https://api.github.com/users/taylorotwell","html_url":"https://github.com/taylorotwell","followers_url":"https://api.github.com/users/taylorotwell/followers","following_url":"https://api.github.com/users/taylorotwell/following{/other_user}","gists_url":"https://api.github.com/users/taylorotwell/gists{/gist_id}","starred_url":"https://api.github.com/users/taylorotwell/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/taylorotwell/subscriptions","organizations_url":"https://api.github.com/users/taylorotwell/orgs","repos_url":"https://api.github.com/users/taylorotwell/repos","events_url":"https://api.github.com/users/taylorotwell/events{/privacy}","received_events_url":"https://api.github.com/users/taylorotwell/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/laravel/framework/issues/56944/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/laravel/framework/issues/56944/timeline","performed_via_github_app":null,"state_reason":"completed"}