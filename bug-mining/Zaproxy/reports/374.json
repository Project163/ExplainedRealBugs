{"url":"https://api.github.com/repos/zaproxy/zaproxy/issues/7218","repository_url":"https://api.github.com/repos/zaproxy/zaproxy","labels_url":"https://api.github.com/repos/zaproxy/zaproxy/issues/7218/labels{/name}","comments_url":"https://api.github.com/repos/zaproxy/zaproxy/issues/7218/comments","events_url":"https://api.github.com/repos/zaproxy/zaproxy/issues/7218/events","html_url":"https://github.com/zaproxy/zaproxy/issues/7218","id":1208871332,"node_id":"I_kwDOAjHKnc5IDemk","number":7218,"title":"Container image scanner started failing today with ApiException: does_not_exist","user":{"login":"JohnStarich","id":1009441,"node_id":"MDQ6VXNlcjEwMDk0NDE=","avatar_url":"https://avatars.githubusercontent.com/u/1009441?v=4","gravatar_id":"","url":"https://api.github.com/users/JohnStarich","html_url":"https://github.com/JohnStarich","followers_url":"https://api.github.com/users/JohnStarich/followers","following_url":"https://api.github.com/users/JohnStarich/following{/other_user}","gists_url":"https://api.github.com/users/JohnStarich/gists{/gist_id}","starred_url":"https://api.github.com/users/JohnStarich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JohnStarich/subscriptions","organizations_url":"https://api.github.com/users/JohnStarich/orgs","repos_url":"https://api.github.com/users/JohnStarich/repos","events_url":"https://api.github.com/users/JohnStarich/events{/privacy}","received_events_url":"https://api.github.com/users/JohnStarich/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":220063774,"node_id":"MDU6TGFiZWwyMjAwNjM3NzQ=","url":"https://api.github.com/repos/zaproxy/zaproxy/labels/bug","name":"bug","color":"fc2929","default":true,"description":null},{"id":268967616,"node_id":"MDU6TGFiZWwyNjg5Njc2MTY=","url":"https://api.github.com/repos/zaproxy/zaproxy/labels/weekly","name":"weekly","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":true,"assignee":{"login":"thc202","id":4639210,"node_id":"MDQ6VXNlcjQ2MzkyMTA=","avatar_url":"https://avatars.githubusercontent.com/u/4639210?v=4","gravatar_id":"","url":"https://api.github.com/users/thc202","html_url":"https://github.com/thc202","followers_url":"https://api.github.com/users/thc202/followers","following_url":"https://api.github.com/users/thc202/following{/other_user}","gists_url":"https://api.github.com/users/thc202/gists{/gist_id}","starred_url":"https://api.github.com/users/thc202/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thc202/subscriptions","organizations_url":"https://api.github.com/users/thc202/orgs","repos_url":"https://api.github.com/users/thc202/repos","events_url":"https://api.github.com/users/thc202/events{/privacy}","received_events_url":"https://api.github.com/users/thc202/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"thc202","id":4639210,"node_id":"MDQ6VXNlcjQ2MzkyMTA=","avatar_url":"https://avatars.githubusercontent.com/u/4639210?v=4","gravatar_id":"","url":"https://api.github.com/users/thc202","html_url":"https://github.com/thc202","followers_url":"https://api.github.com/users/thc202/followers","following_url":"https://api.github.com/users/thc202/following{/other_user}","gists_url":"https://api.github.com/users/thc202/gists{/gist_id}","starred_url":"https://api.github.com/users/thc202/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thc202/subscriptions","organizations_url":"https://api.github.com/users/thc202/orgs","repos_url":"https://api.github.com/users/thc202/repos","events_url":"https://api.github.com/users/thc202/events{/privacy}","received_events_url":"https://api.github.com/users/thc202/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":10,"created_at":"2022-04-19T21:18:37Z","updated_at":"2022-07-20T01:34:42Z","closed_at":"2022-04-20T13:06:25Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Describe the bug\n\nWe use the Docker image and `zap-api-scan.py` shipped inside it.\r\n\r\nOur automated Zap scanners started failing today (a few hours ago) with exceptions like these:\r\n\r\n```\r\n[ZAP-IO-EventExecutor-3-3] WARN  org.zaproxy.zap.extension.api.API - Bad request to API endpoint [/JSON/ascan/action/setScannerAlertThreshold/] from [127.0.0.1]:\r\norg.zaproxy.zap.extension.api.ApiException: does_not_exist\r\n\tat org.zaproxy.zap.extension.ascan.ActiveScanAPI.getScannerFromId(ActiveScanAPI.java:854) ~[zap-D-2022-04-19.jar:D-2022-04-19]\r\n\tat org.zaproxy.zap.extension.ascan.ActiveScanAPI.handleApiAction(ActiveScanAPI.java:483) ~[zap-D-2022-04-19.jar:D-2022-04-19]\r\n\tat org.zaproxy.zap.extension.api.API.handleApiRequest(API.java:516) ~[zap-D-2022-04-19.jar:D-2022-04-19]\r\n\tat org.zaproxy.addon.network.internal.server.http.handlers.ZapApiHandler.handleApiRequest(ZapApiHandler.java:93) ~[?:?]\r\n\tat org.zaproxy.addon.network.internal.server.http.handlers.ZapApiHandler.handleRequest(ZapApiHandler.java:67) ~[?:?]\r\n\tat org.zaproxy.addon.network.internal.server.http.handlers.HttpRequestHandler.handleMessage0(HttpRequestHandler.java:32) ~[?:?]\r\n\tat org.zaproxy.addon.network.internal.server.http.handlers.HttpIncludedMessageHandler.handleMessage(HttpIncludedMessageHandler.java:32) ~[?:?]\r\n\tat org.zaproxy.addon.network.internal.server.http.MainServerHandler.notifyMessageHandlers(MainServerHandler.java:118) ~[?:?]\r\n\tat org.zaproxy.addon.network.internal.server.http.MainServerHandler.processMessage(MainServerHandler.java:100) ~[?:?]\r\n\tat org.zaproxy.addon.network.internal.server.http.LocalServerHandler.processMessage(LocalServerHandler.java:63) ~[?:?]\r\n\tat org.zaproxy.addon.network.internal.server.http.MainServerHandler.process(MainServerHandler.java:83) ~[?:?]\r\n\tat org.zaproxy.addon.network.internal.server.http.MainServerHandler.channelRead0(MainServerHandler.java:72) ~[?:?]\r\n\tat org.zaproxy.addon.network.internal.server.http.MainServerHandler.channelRead0(MainServerHandler.java:37) ~[?:?]\r\n\tat io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:99) ~[?:?]\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379) ~[?:?]\r\n\tat io.netty.channel.AbstractChannelHandlerContext.access$600(AbstractChannelHandlerContext.java:61) ~[?:?]\r\n\tat io.netty.channel.AbstractChannelHandlerContext$7.run(AbstractChannelHandlerContext.java:370) ~[?:?]\r\n\tat io.netty.util.concurrent.DefaultEventExecutor.run(DefaultEventExecutor.java:66) ~[?:?]\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:986) ~[?:?]\r\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) ~[?:?]\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) ~[?:?]\r\n\tat java.lang.Thread.run(Thread.java:829) ~[?:?]\r\n[ZAP-IO-EventExecutor-3-6] INFO  org.parosproxy.paros.core.scanner.Scanner - scanner started\r\n[Thread-6] INFO  org.parosproxy.paros.core.scanner.HostProcess - Scanning 37 node(s) from http://172.17.0.5:6970\r\n```\r\n\r\nAnd a Python traceback like this:\r\n```\r\n2022-04-19 16:51:55,052 http://localhost:41691 \"GET http://zap/JSON/pscan/view/scanners/ HTTP/1.1\" 200 6409\r\nERROR <class 'AttributeError'>\r\n2022-04-19 16:51:55,054 Unexpected error: <class 'AttributeError'>\r\nTraceback (most recent call last):\r\n  File \"/zap/zap-api-scan.py\", line 507, in main\r\n    plugin_id = rule.get('id')\r\nAttributeError: 'str' object has no attribute 'get'\r\n```\r\nI'm not sure if these are related.\r\n\r\nUsing the old image version (`:w2022-04-11`) resolves the issue.\r\n\r\nI suspect this cropped up somewhere in the past week's diff: https://github.com/zaproxy/zaproxy/compare/7c032d420e6fb188b052745c938028eb930a0279...d2d0b7155b5bd6a55851c2edd5e13b6e26a930dc\r\nSpecifically, this PR seems to have touched the lines of code in this stack trace: https://github.com/zaproxy/zaproxy/pull/7206\r\nFYI @ricekot @kingthorin \n\n### Steps to reproduce the behavior\n\n1. Run the docker image scanner with the `:latest` version. We run it like this in CI:\r\n```\r\ndocker run \\\r\n    --tty --rm \\\r\n    --name=zap-scanner-6728221835413462714 \\\r\n    --volume=/tmp/tmp.87XV2BwCDg:/zap/wrk/ owasp/zap2docker-weekly:latest \\\r\n    zap-api-scan.py \\\r\n        -j -d \\\r\n        -t openapi-2344525620.json \\\r\n        -f openapi \\\r\n        -c zap.conf \\\r\n        -r report.html \\\r\n        -w report.md \\\r\n        -J report.json \\\r\n        -z -config ...(rules configuring auth replacements)...\r\n```\r\n2. Observe the Python traceback and Java ApiException\r\n3. Re-run with last week's image, observe no issue.\n\n### Expected behavior\n\nExpected to see no change in internal image behavior from continuous scans with `:latest`.\n\n### Software versions\n\n`:latest`\n\n### Screenshots\n\n_No response_\n\n### Errors from the zap.log file\n\nIncluded relevant snippets above. Let me know if you need more logs, I can redact ours as needed.\n\n### Additional context\n\n_No response_\n\n### Would you like to help fix this issue?\n\n- [ ] Yes","closed_by":{"login":"psiinon","id":1081115,"node_id":"MDQ6VXNlcjEwODExMTU=","avatar_url":"https://avatars.githubusercontent.com/u/1081115?v=4","gravatar_id":"","url":"https://api.github.com/users/psiinon","html_url":"https://github.com/psiinon","followers_url":"https://api.github.com/users/psiinon/followers","following_url":"https://api.github.com/users/psiinon/following{/other_user}","gists_url":"https://api.github.com/users/psiinon/gists{/gist_id}","starred_url":"https://api.github.com/users/psiinon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/psiinon/subscriptions","organizations_url":"https://api.github.com/users/psiinon/orgs","repos_url":"https://api.github.com/users/psiinon/repos","events_url":"https://api.github.com/users/psiinon/events{/privacy}","received_events_url":"https://api.github.com/users/psiinon/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/zaproxy/zaproxy/issues/7218/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/zaproxy/zaproxy/issues/7218/timeline","performed_via_github_app":null,"state_reason":"completed"}