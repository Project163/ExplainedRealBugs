{"url":"https://api.github.com/repos/FasterXML/aalto-xml/issues/35","repository_url":"https://api.github.com/repos/FasterXML/aalto-xml","labels_url":"https://api.github.com/repos/FasterXML/aalto-xml/issues/35/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/aalto-xml/issues/35/comments","events_url":"https://api.github.com/repos/FasterXML/aalto-xml/issues/35/events","html_url":"https://github.com/FasterXML/aalto-xml/issues/35","id":125217324,"node_id":"MDU6SXNzdWUxMjUyMTczMjQ=","number":35,"title":"Carriage return (\\r) dropped by `XMLStreamWriter` implementation","user":{"login":"conleym","id":293492,"node_id":"MDQ6VXNlcjI5MzQ5Mg==","avatar_url":"https://avatars.githubusercontent.com/u/293492?v=4","gravatar_id":"","url":"https://api.github.com/users/conleym","html_url":"https://github.com/conleym","followers_url":"https://api.github.com/users/conleym/followers","following_url":"https://api.github.com/users/conleym/following{/other_user}","gists_url":"https://api.github.com/users/conleym/gists{/gist_id}","starred_url":"https://api.github.com/users/conleym/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/conleym/subscriptions","organizations_url":"https://api.github.com/users/conleym/orgs","repos_url":"https://api.github.com/users/conleym/repos","events_url":"https://api.github.com/users/conleym/events{/privacy}","received_events_url":"https://api.github.com/users/conleym/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/aalto-xml/milestones/5","html_url":"https://github.com/FasterXML/aalto-xml/milestone/5","labels_url":"https://api.github.com/repos/FasterXML/aalto-xml/milestones/5/labels","id":3224001,"node_id":"MDk6TWlsZXN0b25lMzIyNDAwMQ==","number":5,"title":"1.1.0","description":null,"creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":6,"state":"open","created_at":"2018-03-28T03:26:41Z","updated_at":"2018-04-01T23:56:15Z","due_on":null,"closed_at":null},"comments":4,"created_at":"2016-01-06T16:57:15Z","updated_at":"2018-04-02T20:37:12Z","closed_at":"2018-03-30T23:12:29Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I'm using StAX to do some XML processing, reading events and then writing them, sometimes with some changes, etc., as you do, and I've noticed something odd: aalto, given XML containing `&#13;` in a text node will, at the end of this process, produce text with neither the CR nor a newline. This differs from other StAX implementations and appears to be a bug (the handling of this particular case is different across all implementations I know of, but aalto's seems to be the most-wrong).\n\nThis program illustrates:\n\n```\nimport java.io.ByteArrayInputStream;\nimport java.io.ByteArrayOutputStream;\nimport java.nio.charset.StandardCharsets;\n\nimport javax.xml.parsers.DocumentBuilderFactory;\nimport javax.xml.stream.XMLEventFactory;\nimport javax.xml.stream.XMLEventReader;\nimport javax.xml.stream.XMLEventWriter;\nimport javax.xml.stream.XMLInputFactory;\nimport javax.xml.stream.XMLOutputFactory;\nimport javax.xml.stream.events.XMLEvent;\nimport javax.xml.xpath.XPath;\nimport javax.xml.xpath.XPathConstants;\nimport javax.xml.xpath.XPathFactory;\n\nimport org.w3c.dom.Document;\n\n\npublic final class Minimal {\n    /** Enumeration of supported StAX implementations. */\n    public enum StAXImplementation {\n        AALTO(\"com.fasterxml.aalto.stax.InputFactoryImpl\",\n                \"com.fasterxml.aalto.stax.OutputFactoryImpl\",\n                \"com.fasterxml.aalto.stax.EventFactoryImpl\"),\n        /** JDK built in implementation, based on Xerces. */\n        JDK(\"com.sun.xml.internal.stream.XMLInputFactoryImpl\",\n                \"com.sun.xml.internal.stream.XMLOutputFactoryImpl\",\n                \"com.sun.xml.internal.stream.events.XMLEventFactoryImpl\"),\n        WOODSTOX(\"com.ctc.wstx.stax.WstxInputFactory\",\n                \"com.ctc.wstx.stax.WstxOutputFactory\",\n                \"com.ctc.wstx.stax.WstxEventFactory\"),\n        XERCES(JDK.inputFactory,\n                JDK.outputFactory,\n                \"org.apache.xerces.stax.XMLEventFactoryImpl\");\n\n        final String inputFactory;\n        final String outputFactory;\n        final String eventFactory;\n\n        private StAXImplementation(final String inputFactory,\n                final String outputFactory, final String eventFactory) {\n            this.inputFactory = inputFactory;\n            this.outputFactory = outputFactory;\n            this.eventFactory = eventFactory;\n        }\n\n        /**\n         * Tell the JDK to use this StAXImplementation.\n         */\n        public void use() {\n            System.setProperty(\"javax.xml.stream.XMLInputFactory\",\n                    inputFactory);\n            System.setProperty(\"javax.xml.stream.XMLOutputFactory\",\n                    outputFactory);\n            System.setProperty(\"javax.xml.stream.XMLEventFactory\",\n                    eventFactory);\n        }\n    }\n\n\n    static final String CR = new String(Character.toChars(32));\n    static final String TEXT=\"a&#13;a\";\n    static final String EXPANDED_TEXT = \"a\" + CR + \"a\";\n    static final String NEWLINE_TEXT = \"a\\na\";\n    static final String XML = \"<x>\" + TEXT + \"</x>\";\n    static final byte[] XML_BYTES = XML.getBytes(\n            StandardCharsets.UTF_8);\n\n    /** Run some tests for each StAX implementation. */\n    public static void main(final String[] args) throws Exception {\n        for (final StAXImplementation impl : StAXImplementation.values()) {\n            runTest(impl);\n            System.out.println();\n        }\n    }\n\n    private static void runTest(final StAXImplementation impl)\n            throws Exception {\n        impl.use();\n        System.out.println(\"************** Trying \" + impl + \" **************\");\n        final XMLInputFactory inputFactory = XMLInputFactory.newFactory();\n        final XMLOutputFactory outputFactory =\n                XMLOutputFactory.newFactory();\n        final ByteArrayOutputStream baos = new ByteArrayOutputStream();\n\n        System.out.println(\"-------------- Factory classes:\");\n        printName(\"XMLInputFactory\", inputFactory);\n        printName(\"XMLOutputFactory\", outputFactory);\n        printName(\"XMLEventFactory\", XMLEventFactory.newFactory());\n\n        System.out.println(\"-------------- StAX results:\");\n        final XMLEventReader r = inputFactory.createXMLEventReader(\n                new ByteArrayInputStream(XML_BYTES));\n        final XMLEventWriter w = outputFactory.createXMLEventWriter(baos);\n        final StringBuilder buffer = new StringBuilder();\n        while (r.hasNext()) {\n            final XMLEvent e = r.nextEvent();\n            if (e.isStartDocument()) {\n                // Avoid the XML declaration. Not present in the input.\n                continue;\n            }\n            if (e.isCharacters()) {\n                buffer.append(e.asCharacters().getData());\n            } else {\n                if (buffer.length() > 0) {\n                    testText(buffer.toString());\n                    buffer.setLength(0);\n                }\n            }\n            w.add(e);\n        }\n        r.close();\n        w.flush();\n        w.close();\n        final byte[] resultBytes = baos.toByteArray();\n        System.out.println(\"StAX XML: [\" + new String(resultBytes,\n                StandardCharsets.UTF_8) + \"]\");\n        testDOM(resultBytes);\n    }\n\n    private static void printName(final String name, final Object obj) {\n        System.out.println(name + \"=\" + obj.getClass().getName());\n    }\n\n    private static void testText(final String text) {\n        System.out.println(\"Buffered text: [\" + text + \"]\");\n        System.out.println(\"Code point at index 1: \" +\n                Character.codePointAt(text, 1));\n        System.out.println(\"Buffered text equals input text? \" +\n                TEXT.equals(text));\n        System.out.println(\n                \"Buffered text equals expanded text? \" +\n                        EXPANDED_TEXT.equals(text));\n        System.out.println(\"Buffered text has \\\\n for \\\\r? \" +\n                NEWLINE_TEXT.equals(text));\n    }\n\n    private static void testDOM(final byte[] resultBytes) throws Exception {\n        final DocumentBuilderFactory dbf =\n                DocumentBuilderFactory.newInstance();\n        dbf.setNamespaceAware(true);\n        dbf.setExpandEntityReferences(false);\n        final Document doc = dbf.newDocumentBuilder().parse(\n                new ByteArrayInputStream(resultBytes));\n        final XPath xpath = XPathFactory.newInstance().newXPath();\n        final String domText = (String)xpath.evaluate(\"/x/text()\", doc,\n                XPathConstants.STRING);\n        System.out.println(\"============== DOM results:\");\n        testText(domText);\n    }\n}\n```\n\nIt's pretty straightforward to run if you have all the implementations in your classpath. I use the following pom:\n\n```\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n  xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n  <modelVersion>4.0.0</modelVersion>\n  <groupId>foobar</groupId>\n  <artifactId>stax-stuff</artifactId>\n  <version>0.0.1-SNAPSHOT</version>\n\n  <dependencies>\n    <dependency>\n      <groupId>com.fasterxml.woodstox</groupId>\n      <artifactId>woodstox-core</artifactId>\n      <version>5.0.1</version>\n    </dependency>\n    <dependency>\n      <groupId>xerces</groupId>\n      <artifactId>xercesImpl</artifactId>\n      <version>2.11.0</version>\n    </dependency>\n    <dependency>\n      <groupId>com.fasterxml</groupId>\n      <artifactId>aalto-xml</artifactId>\n      <version>1.0.0</version>\n    </dependency>\n  </dependencies>\n\n  <build>\n    <plugins>\n      <plugin>\n        <artifactId>maven-compiler-plugin</artifactId>\n        <version>3.3</version>\n        <configuration>\n          <source>1.8</source>\n          <target>1.8</target>\n        </configuration>\n      </plugin>\n      </plugins>\n  </build>\n</project>\n```\n\nOutput:\n\n```\n************** Trying AALTO **************\n-------------- Factory classes:\nXMLInputFactory=com.fasterxml.aalto.stax.InputFactoryImpl\nXMLOutputFactory=com.fasterxml.aalto.stax.OutputFactoryImpl\nXMLEventFactory=com.fasterxml.aalto.stax.EventFactoryImpl\n-------------- StAX results:\nBuffered text: [a\na]\nCode point at index 1: 13\nBuffered text equals input text? false\nBuffered text equals expanded text? false\nBuffered text has \\n for \\r? false\nStAX XML: [<x>aa</x>]\n============== DOM results:\nBuffered text: [aa]\nCode point at index 1: 97\nBuffered text equals input text? false\nBuffered text equals expanded text? false\nBuffered text has \\n for \\r? false\n\n************** Trying JDK **************\n-------------- Factory classes:\nXMLInputFactory=com.sun.xml.internal.stream.XMLInputFactoryImpl\nXMLOutputFactory=com.sun.xml.internal.stream.XMLOutputFactoryImpl\nXMLEventFactory=com.sun.xml.internal.stream.events.XMLEventFactoryImpl\n-------------- StAX results:\nBuffered text: [a\na]\nCode point at index 1: 13\nBuffered text equals input text? false\nBuffered text equals expanded text? false\nBuffered text has \\n for \\r? false\nStAX XML: [<x>a\na</x>]\n============== DOM results:\nBuffered text: [a\na]\nCode point at index 1: 10\nBuffered text equals input text? false\nBuffered text equals expanded text? false\nBuffered text has \\n for \\r? true\n\n************** Trying WOODSTOX **************\n-------------- Factory classes:\nXMLInputFactory=com.ctc.wstx.stax.WstxInputFactory\nXMLOutputFactory=com.ctc.wstx.stax.WstxOutputFactory\nXMLEventFactory=com.ctc.wstx.stax.WstxEventFactory\n-------------- StAX results:\nBuffered text: [a\na]\nCode point at index 1: 13\nBuffered text equals input text? false\nBuffered text equals expanded text? false\nBuffered text has \\n for \\r? false\nStAX XML: [<x>a&#xd;a</x>]\n============== DOM results:\nBuffered text: [a\na]\nCode point at index 1: 13\nBuffered text equals input text? false\nBuffered text equals expanded text? false\nBuffered text has \\n for \\r? false\n\n************** Trying XERCES **************\n-------------- Factory classes:\nXMLInputFactory=com.sun.xml.internal.stream.XMLInputFactoryImpl\nXMLOutputFactory=com.sun.xml.internal.stream.XMLOutputFactoryImpl\nXMLEventFactory=org.apache.xerces.stax.XMLEventFactoryImpl\n-------------- StAX results:\nBuffered text: [a\na]\nCode point at index 1: 13\nBuffered text equals input text? false\nBuffered text equals expanded text? false\nBuffered text has \\n for \\r? false\nStAX XML: [<x>a\na</x>]\n============== DOM results:\nBuffered text: [a\na]\nCode point at index 1: 10\nBuffered text equals input text? false\nBuffered text equals expanded text? false\nBuffered text has \\n for \\r? true\n```\n","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/aalto-xml/issues/35/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/aalto-xml/issues/35/timeline","performed_via_github_app":null,"state_reason":"completed"}