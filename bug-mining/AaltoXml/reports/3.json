{"url":"https://api.github.com/repos/FasterXML/aalto-xml/issues/29","repository_url":"https://api.github.com/repos/FasterXML/aalto-xml","labels_url":"https://api.github.com/repos/FasterXML/aalto-xml/issues/29/labels{/name}","comments_url":"https://api.github.com/repos/FasterXML/aalto-xml/issues/29/comments","events_url":"https://api.github.com/repos/FasterXML/aalto-xml/issues/29/events","html_url":"https://github.com/FasterXML/aalto-xml/issues/29","id":78976138,"node_id":"MDU6SXNzdWU3ODk3NjEzOA==","number":29,"title":"Multi-threading bug in XmlScanner/FixedNsContext","user":{"login":"bcoughlan","id":421683,"node_id":"MDQ6VXNlcjQyMTY4Mw==","avatar_url":"https://avatars.githubusercontent.com/u/421683?v=4","gravatar_id":"","url":"https://api.github.com/users/bcoughlan","html_url":"https://github.com/bcoughlan","followers_url":"https://api.github.com/users/bcoughlan/followers","following_url":"https://api.github.com/users/bcoughlan/following{/other_user}","gists_url":"https://api.github.com/users/bcoughlan/gists{/gist_id}","starred_url":"https://api.github.com/users/bcoughlan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bcoughlan/subscriptions","organizations_url":"https://api.github.com/users/bcoughlan/orgs","repos_url":"https://api.github.com/users/bcoughlan/repos","events_url":"https://api.github.com/users/bcoughlan/events{/privacy}","received_events_url":"https://api.github.com/users/bcoughlan/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/FasterXML/aalto-xml/milestones/4","html_url":"https://github.com/FasterXML/aalto-xml/milestone/4","labels_url":"https://api.github.com/repos/FasterXML/aalto-xml/milestones/4/labels","id":1426497,"node_id":"MDk6TWlsZXN0b25lMTQyNjQ5Nw==","number":4,"title":"1.0.0","description":null,"creator":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":3,"state":"open","created_at":"2015-11-24T03:13:53Z","updated_at":"2015-11-24T03:31:00Z","due_on":null,"closed_at":null},"comments":1,"created_at":"2015-05-21T12:36:49Z","updated_at":"2015-11-24T03:15:42Z","closed_at":"2015-11-24T03:15:42Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I believe that there is a multi-threading bug in XmlScanner/FixedNsContext.\n\nI suspect that this is because `XmlScanner` uses the static `FixedNsContext.EMPTY_CONTEXT` initially, so threads are sharing the `_tmpDecl` array in `FixedNsContext`.\n\nI am not familiar enough with Aalto to produce a fix, but I did manage to create a reproducible example (you may need to run it a few times to get the error):\n\n``` java\npackage performance;\n\nimport com.fasterxml.aalto.AsyncByteBufferFeeder;\nimport com.fasterxml.aalto.AsyncXMLInputFactory;\nimport com.fasterxml.aalto.AsyncXMLStreamReader;\nimport com.fasterxml.aalto.evt.EventAllocatorImpl;\nimport com.fasterxml.aalto.stax.InputFactoryImpl;\n\nimport java.nio.ByteBuffer;\nimport java.nio.charset.StandardCharsets;\nimport java.util.concurrent.ExecutorService;\nimport java.util.concurrent.Executors;\nimport java.util.concurrent.TimeUnit;\n\nimport javax.xml.stream.util.XMLEventAllocator;\n\npublic class AaltoBug implements Runnable {\n\n    private static String xml = \"<?xml version='1.0'?><stream:stream xmlns='jabber:client' xmlns:stream='http://etherx.jabber.org/streams' id='4095288169' from='localhost' version='1.0' xml:lang='en'>\";\n    private static int NUM_THREADS = 5;\n    private static XMLEventAllocator allocator = EventAllocatorImpl.getDefaultInstance();\n    private static AsyncXMLInputFactory inputFactory = new InputFactoryImpl();\n\n    public static void main(String[] args) throws InterruptedException {\n        ExecutorService ex = Executors.newFixedThreadPool(NUM_THREADS);\n\n        for (int i = 0; i < 100000; i++) {\n            ex.submit(new AaltoBug(i));\n        }\n\n        ex.shutdown();\n        ex.awaitTermination(Integer.MAX_VALUE, TimeUnit.SECONDS);\n    }\n\n    private final int count;\n\n    public AaltoBug(int count) {\n        this.count = count;\n    }\n\n    @Override\n    public void run() {\n        try {\n            ByteBuffer bb = StandardCharsets.UTF_8.encode(xml);\n            AsyncXMLStreamReader<AsyncByteBufferFeeder> parser = inputFactory.createAsyncForByteBuffer();\n            parser.getInputFeeder().feedInput(bb);\n            while (parser.hasNext()) {\n                int eventType = parser.next();\n                if (eventType == AsyncXMLStreamReader.EVENT_INCOMPLETE) {\n                    break;\n                }\n\n                allocator.allocate(parser);\n            }\n        } catch (Exception e) {\n            System.out.println(\"Error in \" + count);\n            e.printStackTrace();\n        }\n    }\n}\n```\n\nWhich produces this exception:\n\n```\njava.lang.ArrayIndexOutOfBoundsException: 10\n    at java.util.ArrayList.add(ArrayList.java:459)\n    at com.fasterxml.aalto.in.FixedNsContext.reuseOrCreate(FixedNsContext.java:76)\n    at com.fasterxml.aalto.in.XmlScanner.getNonTransientNamespaceContext(XmlScanner.java:916)\n    at com.fasterxml.aalto.stax.StreamReaderImpl.getNonTransientNamespaceContext(StreamReaderImpl.java:1528)\n    at org.codehaus.stax2.ri.evt.Stax2EventAllocatorImpl.createStartElement(Stax2EventAllocatorImpl.java:160)\n    at org.codehaus.stax2.ri.evt.Stax2EventAllocatorImpl.allocate(Stax2EventAllocatorImpl.java:69)\n    at com.fasterxml.aalto.evt.EventAllocatorImpl.allocate(EventAllocatorImpl.java:103)\n    at performance.AaltoBug.run(AaltoBug.java:61)\n    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n    at java.util.concurrent.FutureTask.run(FutureTask.java:266)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\n```\n","closed_by":{"login":"cowtowncoder","id":55065,"node_id":"MDQ6VXNlcjU1MDY1","avatar_url":"https://avatars.githubusercontent.com/u/55065?v=4","gravatar_id":"","url":"https://api.github.com/users/cowtowncoder","html_url":"https://github.com/cowtowncoder","followers_url":"https://api.github.com/users/cowtowncoder/followers","following_url":"https://api.github.com/users/cowtowncoder/following{/other_user}","gists_url":"https://api.github.com/users/cowtowncoder/gists{/gist_id}","starred_url":"https://api.github.com/users/cowtowncoder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cowtowncoder/subscriptions","organizations_url":"https://api.github.com/users/cowtowncoder/orgs","repos_url":"https://api.github.com/users/cowtowncoder/repos","events_url":"https://api.github.com/users/cowtowncoder/events{/privacy}","received_events_url":"https://api.github.com/users/cowtowncoder/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/FasterXML/aalto-xml/issues/29/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/FasterXML/aalto-xml/issues/29/timeline","performed_via_github_app":null,"state_reason":"completed"}