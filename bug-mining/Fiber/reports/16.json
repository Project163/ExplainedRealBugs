{"url":"https://api.github.com/repos/gofiber/fiber/issues/2016","repository_url":"https://api.github.com/repos/gofiber/fiber","labels_url":"https://api.github.com/repos/gofiber/fiber/issues/2016/labels{/name}","comments_url":"https://api.github.com/repos/gofiber/fiber/issues/2016/comments","events_url":"https://api.github.com/repos/gofiber/fiber/issues/2016/events","html_url":"https://github.com/gofiber/fiber/issues/2016","id":1339217519,"node_id":"I_kwDODfYWS85P0tZv","number":2016,"title":"üêõ [Bug]: `IP()` function does not return client IP reliably","user":{"login":"gbolo","id":13604991,"node_id":"MDQ6VXNlcjEzNjA0OTkx","avatar_url":"https://avatars.githubusercontent.com/u/13604991?v=4","gravatar_id":"","url":"https://api.github.com/users/gbolo","html_url":"https://github.com/gbolo","followers_url":"https://api.github.com/users/gbolo/followers","following_url":"https://api.github.com/users/gbolo/following{/other_user}","gists_url":"https://api.github.com/users/gbolo/gists{/gist_id}","starred_url":"https://api.github.com/users/gbolo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gbolo/subscriptions","organizations_url":"https://api.github.com/users/gbolo/orgs","repos_url":"https://api.github.com/users/gbolo/repos","events_url":"https://api.github.com/users/gbolo/events{/privacy}","received_events_url":"https://api.github.com/users/gbolo/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2064310319,"node_id":"MDU6TGFiZWwyMDY0MzEwMzE5","url":"https://api.github.com/repos/gofiber/fiber/labels/%E2%98%A2%EF%B8%8F%20Bug","name":"‚ò¢Ô∏è Bug","color":"e11d21","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-08-15T16:41:37Z","updated_at":"2022-08-23T06:32:24Z","closed_at":"2022-08-23T06:32:24Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug Description\r\n\r\nAccording to documentation for `func (c *Ctx) IP() string`: \r\n\r\n> IP returns the remote IP address of the request.\r\n\r\nHowever, the logic in this function is too basic and cannot be trusted. Here are some issues for example:\r\n\r\n- when setting `ProxyHeader: \"X-Forwarded-For\"` (or any other value), if this header is missing or empty then fiber will return an empty value for `c.IP()`. I think it would be better if the value defaulted to `fasthttp.RemoteIP().String()` when the value of this header is missing/empty\r\n- no validation or modifications are done on the return value of `c.Get(c.app.config.ProxyHeader)`. This means that it's possible to return any string that does not even represent an IP\r\n\r\n### How to Reproduce\r\n\r\nExample App\r\n```\r\npackage main\r\n\r\nimport (\r\n\t\"github.com/gofiber/fiber/v2\"\r\n\t\"log\"\r\n)\r\n\r\nfunc main() {\r\n\tapp := fiber.New(fiber.Config{ProxyHeader: \"X-Forwarded-For\"})\r\n\tapp.Get(\"/ip\", func(c *fiber.Ctx) error {\r\n\t\treturn c.JSON(fiber.Map{\"ip\": c.IP()})\r\n\t})\r\n\tlog.Fatal(app.Listen(\":19876\"))\r\n}\r\n```\r\n\r\nTesting\r\n```\r\n# Empty when proxy header is missing\r\n‚ùØ curl http://127.0.0.1:19876/ip\r\n{\"ip\":\"\"}\r\n\r\n# Populated when proxy header has a value\r\n‚ùØ curl -H \"X-Forwarded-For: 1.1.1.1\" http://127.0.0.1:19876/ip\r\n{\"ip\":\"1.1.1.1\"}\r\n\r\n# The value is not checked, just simply passed through\r\n‚ùØ curl -H \"X-Forwarded-For: whatever\" http://127.0.0.1:19876/ip\r\n{\"ip\":\"whatever\"}\r\n\r\n‚ùØ curl -H \"X-Forwarded-For: 1.1.1.1, 2.2.2.2\" http://127.0.0.1:19876/ip\r\n{\"ip\":\"1.1.1.1, 2.2.2.2\"}\r\n```\r\n\r\n### Expected Behavior\r\n\r\n```\r\n# default to TCP IP address that you received the request from\r\n‚ùØ curl http://127.0.0.1:19876/ip\r\n{\"ip\":\"127.0.0.1\"}\r\n\r\n# same default if the proxy header does not make sense\r\n‚ùØ curl -H \"X-Forwarded-For: whatever\" http://127.0.0.1:19876/ip\r\n{\"ip\":\"127.0.0.1\"}\r\n\r\n# attempt to interpret what the IP of the actual client is\r\n‚ùØ curl -H \"X-Forwarded-For: 1.1.1.1, 2.2.2.2\" http://127.0.0.1:19876/ip\r\n{\"ip\":\"1.1.1.1\"}\r\n```\r\n\r\n### Fiber Version\r\n\r\nv2.36.0\r\n\r\n### Code Snippet (optional)\r\n\r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"github.com/gofiber/fiber/v2\"\r\n\t\"log\"\r\n)\r\n\r\nfunc main() {\r\n\tapp := fiber.New(fiber.Config{ProxyHeader: \"X-Forwarded-For\"})\r\n\tapp.Get(\"/ip\", func(c *fiber.Ctx) error {\r\n\t\treturn c.JSON(fiber.Map{\"ip\": c.IP()})\r\n\t})\r\n\tlog.Fatal(app.Listen(\":19876\"))\r\n}\r\n```\r\n\r\n\r\n### Checklist:\r\n\r\n- [X] I agree to follow Fiber's [Code of Conduct](https://github.com/gofiber/fiber/blob/master/.github/CODE_OF_CONDUCT.md).\r\n- [X] I have checked for existing issues that describe my problem prior to opening this one.\r\n- [X] I understand that improperly formatted bug reports may be closed without explanation.","closed_by":{"login":"ReneWerner87","id":7063188,"node_id":"MDQ6VXNlcjcwNjMxODg=","avatar_url":"https://avatars.githubusercontent.com/u/7063188?v=4","gravatar_id":"","url":"https://api.github.com/users/ReneWerner87","html_url":"https://github.com/ReneWerner87","followers_url":"https://api.github.com/users/ReneWerner87/followers","following_url":"https://api.github.com/users/ReneWerner87/following{/other_user}","gists_url":"https://api.github.com/users/ReneWerner87/gists{/gist_id}","starred_url":"https://api.github.com/users/ReneWerner87/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ReneWerner87/subscriptions","organizations_url":"https://api.github.com/users/ReneWerner87/orgs","repos_url":"https://api.github.com/users/ReneWerner87/repos","events_url":"https://api.github.com/users/ReneWerner87/events{/privacy}","received_events_url":"https://api.github.com/users/ReneWerner87/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/gofiber/fiber/issues/2016/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/gofiber/fiber/issues/2016/timeline","performed_via_github_app":null,"state_reason":"completed"}