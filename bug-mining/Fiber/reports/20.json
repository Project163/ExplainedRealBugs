{"url":"https://api.github.com/repos/gofiber/fiber/issues/2396","repository_url":"https://api.github.com/repos/gofiber/fiber","labels_url":"https://api.github.com/repos/gofiber/fiber/issues/2396/labels{/name}","comments_url":"https://api.github.com/repos/gofiber/fiber/issues/2396/comments","events_url":"https://api.github.com/repos/gofiber/fiber/issues/2396/events","html_url":"https://github.com/gofiber/fiber/issues/2396","id":1650425546,"node_id":"I_kwDODfYWS85iX37K","number":2396,"title":"ğŸ› [Bug]:  Partial config cause race condition","user":{"login":"lpongetti","id":6831116,"node_id":"MDQ6VXNlcjY4MzExMTY=","avatar_url":"https://avatars.githubusercontent.com/u/6831116?v=4","gravatar_id":"","url":"https://api.github.com/users/lpongetti","html_url":"https://github.com/lpongetti","followers_url":"https://api.github.com/users/lpongetti/followers","following_url":"https://api.github.com/users/lpongetti/following{/other_user}","gists_url":"https://api.github.com/users/lpongetti/gists{/gist_id}","starred_url":"https://api.github.com/users/lpongetti/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lpongetti/subscriptions","organizations_url":"https://api.github.com/users/lpongetti/orgs","repos_url":"https://api.github.com/users/lpongetti/repos","events_url":"https://api.github.com/users/lpongetti/events{/privacy}","received_events_url":"https://api.github.com/users/lpongetti/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2064310319,"node_id":"MDU6TGFiZWwyMDY0MzEwMzE5","url":"https://api.github.com/repos/gofiber/fiber/labels/%E2%98%A2%EF%B8%8F%20Bug","name":"â˜¢ï¸ Bug","color":"e11d21","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2023-04-01T11:07:52Z","updated_at":"2023-04-02T12:49:09Z","closed_at":"2023-04-02T12:49:09Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug Description\r\n\r\nThis works\r\n\r\n```go\r\napp.Use(\r\n  logger.New(),\r\n)\r\n```\r\n\r\nwhile this cause race condition:\r\n```go\r\napp.Use(\r\n  logger.New(logger.Config{\r\n\t  Format: \"${time} | ${pid} | ${locals:requestid} | ${status} | ${latency} | ${method} | ${path}\\n\",\r\n  }),\r\n)\r\n```\r\n\r\n```bash\r\nWARNING: DATA RACE\r\nRead at 0x00c000091230 by goroutine 14:\r\n  github.com/gofiber/fiber/v2/middleware/logger.New.func3()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/gofiber/fiber/v2@v2.42.0/middleware/logger/logger.go:183 +0x1504\r\n  github.com/gofiber/fiber/v2.(*App).next()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/gofiber/fiber/v2@v2.42.0/router.go:134 +0x4b6\r\n  github.com/gofiber/fiber/v2.(*App).handler()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/gofiber/fiber/v2@v2.42.0/router.go:160 +0xf2\r\n  github.com/gofiber/fiber/v2.(*App).handler-fm()\r\n      <autogenerated>:1 +0x44\r\n  github.com/valyala/fasthttp.(*Server).serveConn()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/valyala/fasthttp@v1.45.0/server.go:2371 +0x1b4a\r\n  github.com/valyala/fasthttp.(*Server).serveConn-fm()\r\n      <autogenerated>:1 +0x4d\r\n  github.com/valyala/fasthttp.(*workerPool).workerFunc()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/valyala/fasthttp@v1.45.0/workerpool.go:224 +0xee\r\n  github.com/valyala/fasthttp.(*workerPool).getCh.func1()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/valyala/fasthttp@v1.45.0/workerpool.go:196 +0x53\r\n\r\nPrevious write at 0x00c000091230 by goroutine 13:\r\n  github.com/gofiber/fiber/v2/middleware/logger.New.func3()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/gofiber/fiber/v2@v2.42.0/middleware/logger/logger.go:179 +0x1364\r\n  github.com/gofiber/fiber/v2.(*App).next()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/gofiber/fiber/v2@v2.42.0/router.go:134 +0x4b6\r\n  github.com/gofiber/fiber/v2.(*App).handler()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/gofiber/fiber/v2@v2.42.0/router.go:160 +0xf2\r\n  github.com/gofiber/fiber/v2.(*App).handler-fm()\r\n      <autogenerated>:1 +0x44\r\n  github.com/valyala/fasthttp.(*Server).serveConn()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/valyala/fasthttp@v1.45.0/server.go:2371 +0x1b4a\r\n  github.com/valyala/fasthttp.(*Server).serveConn-fm()\r\n      <autogenerated>:1 +0x4d\r\n  github.com/valyala/fasthttp.(*workerPool).workerFunc()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/valyala/fasthttp@v1.45.0/workerpool.go:224 +0xee\r\n  github.com/valyala/fasthttp.(*workerPool).getCh.func1()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/valyala/fasthttp@v1.45.0/workerpool.go:196 +0x53\r\n\r\nGoroutine 14 (running) created at:\r\n  github.com/valyala/fasthttp.(*workerPool).getCh()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/valyala/fasthttp@v1.45.0/workerpool.go:195 +0x364\r\n  github.com/valyala/fasthttp.(*workerPool).Serve()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/valyala/fasthttp@v1.45.0/workerpool.go:148 +0x7f1\r\n  github.com/valyala/fasthttp.(*Server).Serve()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/valyala/fasthttp@v1.45.0/server.go:1832 +0x850\r\n  github.com/gofiber/fiber/v2.(*App).Listen()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/gofiber/fiber/v2@v2.42.0/listen.go:82 +0x1d6\r\n  main.main()\r\n      C:/Users/LorenzoPongetti/Desktop/work/lorenzo/proji/test.go:23 +0x16c\r\n\r\nGoroutine 13 (running) created at:\r\n  github.com/valyala/fasthttp.(*workerPool).getCh()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/valyala/fasthttp@v1.45.0/workerpool.go:195 +0x364\r\n  github.com/valyala/fasthttp.(*workerPool).Serve()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/valyala/fasthttp@v1.45.0/workerpool.go:148 +0x7f1\r\n  github.com/valyala/fasthttp.(*Server).Serve()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/valyala/fasthttp@v1.45.0/server.go:1832 +0x850\r\n  github.com/gofiber/fiber/v2.(*App).Listen()\r\n      C:/Users/LorenzoPongetti/go/pkg/mod/github.com/gofiber/fiber/v2@v2.42.0/listen.go:82 +0x1d6\r\n  main.main()\r\n      C:/Users/LorenzoPongetti/Desktop/work/lorenzo/proji/test.go:23 +0x16c\r\n==================\r\n```\r\n\r\n\r\n### How to Reproduce\r\n\r\n```go\r\nfunc main() {\r\n\tapp := fiber.New()\r\n\r\n\t// add middlewares\r\n\tapp.Use(\r\n\t\tlogger.New(logger.Config{\r\n\t\t\tFormat: \"${time} | ${pid} | ${locals:requestid} | ${status} | ${latency} | ${method} | ${path}\\n\",\r\n\t\t}),\r\n\t)\r\n\r\n\tapi := app.Group(\"api/v1\")\r\n\tapi.Get(\"/test\", func(c *fiber.Ctx) error {\r\n\t\treturn c.SendString(\"Hello, World ğŸ‘‹!\")\r\n\t})\r\n\r\n\tapp.Listen(\":3000\")\r\n}\r\n```\r\n\r\nand do\r\n`seq 1 200 | xargs -n1 -P20  curl \"http://172.31.240.1:3000/api/v1/test\"`\r\n\r\n\r\n### Expected Behavior\r\n```bash\r\n â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\r\n â”‚                   Fiber v2.42.0                   â”‚\r\n â”‚               http://127.0.0.1:3000               â”‚\r\n â”‚       (bound on host 0.0.0.0 and port 3000)       â”‚\r\n â”‚                                                   â”‚\r\n â”‚ Handlers ............. 3  Processes ........... 1 â”‚\r\n â”‚ Prefork ....... Disabled  PID ............. 10724 â”‚\r\n â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\r\n\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test    \r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test    \r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n13:06:48 | 200 |      0s |  172.31.249.205 | GET     | /api/v1/test\r\n```\r\n\r\n### Fiber Version\r\n\r\n2.42.2\r\n\r\n\r\n\r\n### Checklist:\r\n\r\n- [X] I agree to follow Fiber's [Code of Conduct](https://github.com/gofiber/fiber/blob/master/.github/CODE_OF_CONDUCT.md).\r\n- [X] I have checked for existing issues that describe my problem prior to opening this one.\r\n- [X] I understand that improperly formatted bug reports may be closed without explanation.","closed_by":{"login":"leonklingele","id":5585491,"node_id":"MDQ6VXNlcjU1ODU0OTE=","avatar_url":"https://avatars.githubusercontent.com/u/5585491?v=4","gravatar_id":"","url":"https://api.github.com/users/leonklingele","html_url":"https://github.com/leonklingele","followers_url":"https://api.github.com/users/leonklingele/followers","following_url":"https://api.github.com/users/leonklingele/following{/other_user}","gists_url":"https://api.github.com/users/leonklingele/gists{/gist_id}","starred_url":"https://api.github.com/users/leonklingele/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/leonklingele/subscriptions","organizations_url":"https://api.github.com/users/leonklingele/orgs","repos_url":"https://api.github.com/users/leonklingele/repos","events_url":"https://api.github.com/users/leonklingele/events{/privacy}","received_events_url":"https://api.github.com/users/leonklingele/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/gofiber/fiber/issues/2396/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/gofiber/fiber/issues/2396/timeline","performed_via_github_app":null,"state_reason":"completed"}