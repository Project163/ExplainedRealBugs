{"url":"https://api.github.com/repos/gofiber/fiber/issues/2383","repository_url":"https://api.github.com/repos/gofiber/fiber","labels_url":"https://api.github.com/repos/gofiber/fiber/issues/2383/labels{/name}","comments_url":"https://api.github.com/repos/gofiber/fiber/issues/2383/comments","events_url":"https://api.github.com/repos/gofiber/fiber/issues/2383/events","html_url":"https://github.com/gofiber/fiber/issues/2383","id":1640347448,"node_id":"I_kwDODfYWS85hxbc4","number":2383,"title":"ðŸ› [Bug]: ctx.Accepts(\"text\", \"json\") with headerAccept, \"text/*, application/json\" fails on macOS ","user":{"login":"sixcolors","id":6501251,"node_id":"MDQ6VXNlcjY1MDEyNTE=","avatar_url":"https://avatars.githubusercontent.com/u/6501251?v=4","gravatar_id":"","url":"https://api.github.com/users/sixcolors","html_url":"https://github.com/sixcolors","followers_url":"https://api.github.com/users/sixcolors/followers","following_url":"https://api.github.com/users/sixcolors/following{/other_user}","gists_url":"https://api.github.com/users/sixcolors/gists{/gist_id}","starred_url":"https://api.github.com/users/sixcolors/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sixcolors/subscriptions","organizations_url":"https://api.github.com/users/sixcolors/orgs","repos_url":"https://api.github.com/users/sixcolors/repos","events_url":"https://api.github.com/users/sixcolors/events{/privacy}","received_events_url":"https://api.github.com/users/sixcolors/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2064310319,"node_id":"MDU6TGFiZWwyMDY0MzEwMzE5","url":"https://api.github.com/repos/gofiber/fiber/labels/%E2%98%A2%EF%B8%8F%20Bug","name":"â˜¢ï¸ Bug","color":"e11d21","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":15,"created_at":"2023-03-25T03:16:11Z","updated_at":"2023-03-27T13:55:43Z","closed_at":"2023-03-27T13:55:43Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Bug Description\r\n\r\nctx.Accepts(\"text\", \"json\") with headerAccept, \"text/*, application/json\" is not the same on macOS and linux\r\n\r\nOn macOS it returns \"text\"\r\n\r\nOn linux it returns \"json\"\r\n\r\n### How to Reproduce\r\n\r\nRun test on macOS and linux\r\n\r\n### Expected Behavior\r\n\r\nconsistent return and tests pass\r\n\r\n### Fiber Version\r\n\r\nv2.43.0\r\n\r\n### Code Snippet (optional)\r\n\r\n```go\r\nfunc Test_Ctx_Accepts(t *testing.T) {\r\n\tt.Parallel()\r\n\tapp := New()\r\n\tc := app.AcquireCtx(&fasthttp.RequestCtx{})\r\n\tdefer app.ReleaseCtx(c)\r\n\r\n\tc.Request().Header.Set(HeaderAccept, \"text/*, application/json\")\r\n\tutils.AssertEqual(t, \"json\", c.Accepts(\"json\", \"text\"))\r\n}\r\n\r\n// called with above params DEBUG comments added\r\nfunc (c *Ctx) Accepts(offers ...string) string {\r\n\tif len(offers) == 0 {\r\n\t\treturn \"\"\r\n\t}\r\n\theader := c.Get(HeaderAccept)\r\n\tif header == \"\" {\r\n\t\treturn offers[0]\r\n\t}\r\n\r\n\tspec, commaPos := \"\", 0\r\n\tfor len(header) > 0 && commaPos != -1 {\r\n\t\tcommaPos = strings.IndexByte(header, ',')\r\n\t\tif commaPos != -1 {\r\n\t\t\tspec = utils.Trim(header[:commaPos], ' ')\r\n\t\t} else {\r\n\t\t\tspec = utils.TrimLeft(header, ' ')\r\n\t\t}\r\n\t\tif factorSign := strings.IndexByte(spec, ';'); factorSign != -1 {\r\n\t\t\tspec = spec[:factorSign]\r\n\t\t}\r\n\r\n\t\tvar mimetype string\r\n\t\tfor _, offer := range offers { // DEBUG first loop \"text\"\r\n\t\t\tif len(offer) == 0 {\r\n\t\t\t\tcontinue\r\n\t\t\t\t// Accept: */*\r\n\t\t\t} else if spec == \"*/*\" {\r\n\t\t\t\treturn offer\r\n\t\t\t}\r\n\r\n\t\t\tif strings.IndexByte(offer, '/') != -1 {\r\n\t\t\t\tmimetype = offer // MIME type\r\n\t\t\t} else {\r\n\t\t\t\tmimetype = utils.GetMIME(offer) // DEBUG on linux: \"application/octet-stream\", on macOS: \"text/plain; charset=utf-8\"\r\n\t\t\t}\r\n\r\n\t\t\tif spec == mimetype {\r\n\t\t\t\t// Accept: <MIME_type>/<MIME_subtype>\r\n\t\t\t\treturn offer\r\n\t\t\t}\r\n\r\n\t\t\ts := strings.IndexByte(mimetype, '/')\r\n\t\t\t// Accept: <MIME_type>/*\r\n\t\t\tif strings.HasPrefix(spec, mimetype[:s]) && (spec[s:] == \"/*\" || mimetype[s:] == \"/*\") { // DEBUG first loop mimeType = \"text/*\"\r\n\t\t\t\treturn offer // DEBUG on macOS text spec matches the string before / (text), on linux text does not match string before / (application)\r\n\t\t\t}\r\n\t\t}\r\n\t\tif commaPos != -1 {\r\n\t\t\theader = header[commaPos+1:]\r\n\t\t}\r\n\t}\r\n\r\n\treturn \"\"\r\n}\r\n```\r\n\r\n### Further context\r\n\r\nCaused by: utils.GetMIME(\"text\"), which calls mime.TypeByExtension(\".\" + extension) on macOS returns \"text/plain; charset=utf-8\" while on linux it returns \"\"\r\n\r\n### Checklist:\r\n\r\n- [X] I agree to follow Fiber's [Code of Conduct](https://github.com/gofiber/fiber/blob/master/.github/CODE_OF_CONDUCT.md).\r\n- [X] I have checked for existing issues that describe my problem prior to opening this one.\r\n- [X] I understand that improperly formatted bug reports may be closed without explanation.","closed_by":{"login":"ReneWerner87","id":7063188,"node_id":"MDQ6VXNlcjcwNjMxODg=","avatar_url":"https://avatars.githubusercontent.com/u/7063188?v=4","gravatar_id":"","url":"https://api.github.com/users/ReneWerner87","html_url":"https://github.com/ReneWerner87","followers_url":"https://api.github.com/users/ReneWerner87/followers","following_url":"https://api.github.com/users/ReneWerner87/following{/other_user}","gists_url":"https://api.github.com/users/ReneWerner87/gists{/gist_id}","starred_url":"https://api.github.com/users/ReneWerner87/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ReneWerner87/subscriptions","organizations_url":"https://api.github.com/users/ReneWerner87/orgs","repos_url":"https://api.github.com/users/ReneWerner87/repos","events_url":"https://api.github.com/users/ReneWerner87/events{/privacy}","received_events_url":"https://api.github.com/users/ReneWerner87/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/gofiber/fiber/issues/2383/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/gofiber/fiber/issues/2383/timeline","performed_via_github_app":null,"state_reason":"completed"}