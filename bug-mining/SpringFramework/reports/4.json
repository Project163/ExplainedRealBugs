{"url":"https://api.github.com/repos/spring-projects/spring-framework/issues/28283","repository_url":"https://api.github.com/repos/spring-projects/spring-framework","labels_url":"https://api.github.com/repos/spring-projects/spring-framework/issues/28283/labels{/name}","comments_url":"https://api.github.com/repos/spring-projects/spring-framework/issues/28283/comments","events_url":"https://api.github.com/repos/spring-projects/spring-framework/issues/28283/events","html_url":"https://github.com/spring-projects/spring-framework/issues/28283","id":1191986376,"node_id":"I_kwDOABGHUc5HDETI","number":28283,"title":"Using AOP and DI itself causes Spring ApplicationListener to be fired twice ","user":{"login":"ZiFeng-Wu","id":54225332,"node_id":"MDQ6VXNlcjU0MjI1MzMy","avatar_url":"https://avatars.githubusercontent.com/u/54225332?v=4","gravatar_id":"","url":"https://api.github.com/users/ZiFeng-Wu","html_url":"https://github.com/ZiFeng-Wu","followers_url":"https://api.github.com/users/ZiFeng-Wu/followers","following_url":"https://api.github.com/users/ZiFeng-Wu/following{/other_user}","gists_url":"https://api.github.com/users/ZiFeng-Wu/gists{/gist_id}","starred_url":"https://api.github.com/users/ZiFeng-Wu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ZiFeng-Wu/subscriptions","organizations_url":"https://api.github.com/users/ZiFeng-Wu/orgs","repos_url":"https://api.github.com/users/ZiFeng-Wu/repos","events_url":"https://api.github.com/users/ZiFeng-Wu/events{/privacy}","received_events_url":"https://api.github.com/users/ZiFeng-Wu/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1188511953,"node_id":"MDU6TGFiZWwxMTg4NTExOTUz","url":"https://api.github.com/repos/spring-projects/spring-framework/labels/type:%20bug","name":"type: bug","color":"e3d9fc","default":false,"description":"A general bug"},{"id":1188512000,"node_id":"MDU6TGFiZWwxMTg4NTEyMDAw","url":"https://api.github.com/repos/spring-projects/spring-framework/labels/in:%20core","name":"in: core","color":"e8f9de","default":false,"description":"Issues in core modules (aop, beans, core, context, expression)"},{"id":1189497922,"node_id":"MDU6TGFiZWwxMTg5NDk3OTIy","url":"https://api.github.com/repos/spring-projects/spring-framework/labels/status:%20superseded","name":"status: superseded","color":"fef2c0","default":false,"description":"An issue that has been superseded by another"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2022-04-04T15:48:07Z","updated_at":"2023-10-10T15:01:02Z","closed_at":"2023-07-10T11:30:55Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Software versions\r\n\r\n- Spring Version  5.3.18 and earlier \r\n- JDK Version 1.8.0_202\r\n\r\n## Overview\r\n\r\nWhen I use Spring ApplicationListener, in order to prevent transaction invalidation, my ApplicationListener implementation class writes the following code (of course, the code can be written differently to avoid this problem), which will cause my listener to trigger twice after the event is published. I think it's not normal, but not sure if it's a bug, so I want to ask everyone's opinion.\r\n\r\n```java\r\n@Component\r\npublic class EventDemoListener implements ApplicationListener<EventDemo> {\r\n    @Autowired\r\n    DemoService1 demoService1;\r\n    @Autowired\r\n    DemoService2 demoService2;\r\n    @Autowired\r\n    EventDemoListener eventDemoListener;\r\n\r\n    @Override\r\n    public void onApplicationEvent(EventDemo event) {\r\n        eventDemoListener.testTransaction();\r\n        System.out.println(\"receiver \" + event.getMessage());\r\n    }\r\n\r\n    @Transactional(rollbackFor = Exception.class)\r\n    public void testTransaction() {\r\n        demoService1.doService();\r\n        demoService2.doService();\r\n    }\r\n}\r\n```\r\nThrough this demo project, this problem can be reproduced. Please read the README.md document before running.    \r\n[https://github.com/ZiFeng-Wu/spring-study](https://github.com/ZiFeng-Wu/spring-study)\r\n\r\n## Analysis\r\n\r\n1. After analysis, because here DI itself , When `EventDemoListener` is created, property filling will trigger `DefaultSingletonBeanRegistry#getSingleton(String, boolean)` in advance.\r\n\r\n2. Then `singletonFactory.getObject()` executed in `getSingleton()` will cause the unproxyed `EventDemoListener` object to be put into `AbstractAutoProxyCreator#earlyProxyReferences`.\r\n\r\n3. After the properties are filled, calling `AbstractAutowireCapableBeanFactory#initializeBean(String, Object, RootBeanDefinition)` and executing `ApplicationListenerDetector#postProcessAfterInitialization(Object, String)` will cause the unproxyed `EventDemoListener` object to be put into the `AbstractApplicationEventMulticaster.DefaultListenerRetriever#applicationListeners` container.\r\n\r\n    [![enter image description here][1]][1]\r\n\r\n4. Then when the event is published, execute `AbstractApplicationEventMulticaster.DefaultListenerRetriever#getApplicationListeners()`  and use `ApplicationListener<?> listener =beanFactory.getBean(listenerBeanName, ApplicationListener.class)` to obtain the listener is the proxied `EventDemoListener` object.\r\n\r\n5. At this time, there are only unproxyed `EventDemoListener` object in the `applicationListeners` container, so the proxied `EventDemoListener` object will be added to the final returned allListeners collection, as shown in the figure below, which will eventually cause the listener to be triggered twice.\r\n\r\n    [![enter image description here][2]][2]\r\n\r\n\r\n  [1]: https://i.stack.imgur.com/lz51c.png\r\n  [2]: https://i.stack.imgur.com/oZ8OA.png\r\n","closed_by":{"login":"jhoeller","id":1263688,"node_id":"MDQ6VXNlcjEyNjM2ODg=","avatar_url":"https://avatars.githubusercontent.com/u/1263688?v=4","gravatar_id":"","url":"https://api.github.com/users/jhoeller","html_url":"https://github.com/jhoeller","followers_url":"https://api.github.com/users/jhoeller/followers","following_url":"https://api.github.com/users/jhoeller/following{/other_user}","gists_url":"https://api.github.com/users/jhoeller/gists{/gist_id}","starred_url":"https://api.github.com/users/jhoeller/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhoeller/subscriptions","organizations_url":"https://api.github.com/users/jhoeller/orgs","repos_url":"https://api.github.com/users/jhoeller/repos","events_url":"https://api.github.com/users/jhoeller/events{/privacy}","received_events_url":"https://api.github.com/users/jhoeller/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/spring-projects/spring-framework/issues/28283/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/spring-projects/spring-framework/issues/28283/timeline","performed_via_github_app":null,"state_reason":"completed"}