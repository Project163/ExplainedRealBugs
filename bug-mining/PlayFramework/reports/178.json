{"url":"https://api.github.com/repos/playframework/playframework/issues/10892","repository_url":"https://api.github.com/repos/playframework/playframework","labels_url":"https://api.github.com/repos/playframework/playframework/issues/10892/labels{/name}","comments_url":"https://api.github.com/repos/playframework/playframework/issues/10892/comments","events_url":"https://api.github.com/repos/playframework/playframework/issues/10892/events","html_url":"https://github.com/playframework/playframework/issues/10892","id":915198731,"node_id":"MDU6SXNzdWU5MTUxOTg3MzE=","number":10892,"title":"Too large evolution script failing not reported","user":{"login":"gaeljw","id":18280708,"node_id":"MDQ6VXNlcjE4MjgwNzA4","avatar_url":"https://avatars.githubusercontent.com/u/18280708?v=4","gravatar_id":"","url":"https://api.github.com/users/gaeljw","html_url":"https://github.com/gaeljw","followers_url":"https://api.github.com/users/gaeljw/followers","following_url":"https://api.github.com/users/gaeljw/following{/other_user}","gists_url":"https://api.github.com/users/gaeljw/gists{/gist_id}","starred_url":"https://api.github.com/users/gaeljw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gaeljw/subscriptions","organizations_url":"https://api.github.com/users/gaeljw/orgs","repos_url":"https://api.github.com/users/gaeljw/repos","events_url":"https://api.github.com/users/gaeljw/events{/privacy}","received_events_url":"https://api.github.com/users/gaeljw/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2021-06-08T15:50:35Z","updated_at":"2021-09-24T06:53:43Z","closed_at":"2021-09-24T06:53:43Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n\r\nIf you are reporting a bug, please be informative. This template can guide you to provide basic information, but you are not limited to that.\r\n\r\n### Are you looking for help?\r\n\r\nThis is an issue tracker, used to manage and track the development of Play. It is not a support system and so it is not a place to ask questions or get help. If you're not sure if you have found a bug, or if you have a feature request, the best place to start is with either the [Discuss Play Forum](https://discuss.playframework.com) or [Stack Overflow](http://stackoverflow.com/questions/ask?tags=playframework).\r\n\r\n-->\r\n\r\n### Play Version\r\n\r\n2.8.8\r\n\r\n### API\r\n\r\nScala\r\n\r\n### Operating System\r\n\r\nLinux\r\n\r\n### JDK\r\n\r\nOpenjdk 11.0.11 2021-04-20\r\n\r\n### Library Dependencies\r\n\r\nmariadb-java-client 2.7.3 (but doesn't seem related to mariadb or the driver)\r\n\r\n### Expected Behavior\r\n\r\nGiven an evolution which is too big (more than what is accepted in the `apply_script` column in `play_evolutions` table)\r\nI expect to have:\r\n- an error in the logs about the fact that the script couldn't be applied\r\n- optionally, an error in `play_evolutions` table in `last_problem` column\r\n\r\n\r\n### Actual Behavior\r\n\r\n- No logs at all, even with log level set to `DEBUG`.\r\n- No error traced in `play_evolutions` table\r\n\r\nHappens both in DEV mode or PROD mode.\r\n\r\nIn DEV mode there's a \"hint\" which is that even with `autoApply=true`, Play keep displaying the message _Database 'default' needs evolution![An SQL script need to be run on your database.]_ but without more details.\r\n\r\n### Reproducible Test Case\r\n\r\nNone yet but I could probably using a Docker container for a MariaDB instance if you feel it's needed.\r\n\r\n### Additional info\r\n\r\nConnecting in debug to the JVM, I was able to understand the issue thanks to a breakpoint at https://github.com/playframework/playframework/blob/master/persistence/play-jdbc-evolutions/src/main/scala/play/api/db/evolutions/EvolutionsApi.scala#L406\r\n\r\nWhat I was able to see is:\r\n- the variable message containing the value `(conn=8) Data too long for column 'apply_script' at row 1 [ERROR:1406, \r\nSQLSTATE:22001]`\r\n- then, as autocommit was enabled, it tries to run `updateLastProblem` to update `last_problem` in `play_evolutions` but there was no row in the table in the 1st place as data too big to be inserted\r\n\r\n:bulb: My feeling is that a quick fix would be to:\r\n- always log an error (even if autocommit is enabled)\r\n- optionally, do an `UPSERT` for the `last_problem` (https://github.com/playframework/playframework/blob/master/persistence/play-jdbc-evolutions/src/main/scala/play/api/db/evolutions/EvolutionsApi.scala#L370)","closed_by":{"login":"gmethvin","id":171663,"node_id":"MDQ6VXNlcjE3MTY2Mw==","avatar_url":"https://avatars.githubusercontent.com/u/171663?v=4","gravatar_id":"","url":"https://api.github.com/users/gmethvin","html_url":"https://github.com/gmethvin","followers_url":"https://api.github.com/users/gmethvin/followers","following_url":"https://api.github.com/users/gmethvin/following{/other_user}","gists_url":"https://api.github.com/users/gmethvin/gists{/gist_id}","starred_url":"https://api.github.com/users/gmethvin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmethvin/subscriptions","organizations_url":"https://api.github.com/users/gmethvin/orgs","repos_url":"https://api.github.com/users/gmethvin/repos","events_url":"https://api.github.com/users/gmethvin/events{/privacy}","received_events_url":"https://api.github.com/users/gmethvin/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/playframework/playframework/issues/10892/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/playframework/playframework/issues/10892/timeline","performed_via_github_app":null,"state_reason":"completed"}