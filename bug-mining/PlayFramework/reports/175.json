{"url":"https://api.github.com/repos/playframework/playframework/issues/10418","repository_url":"https://api.github.com/repos/playframework/playframework","labels_url":"https://api.github.com/repos/playframework/playframework/issues/10418/labels{/name}","comments_url":"https://api.github.com/repos/playframework/playframework/issues/10418/comments","events_url":"https://api.github.com/repos/playframework/playframework/issues/10418/events","html_url":"https://github.com/playframework/playframework/issues/10418","id":676697321,"node_id":"MDU6SXNzdWU2NzY2OTczMjE=","number":10418,"title":"If no new data arrives GzipFilter buffers data indefinitely up to the defined chunk size","user":{"login":"jrudolph","id":9868,"node_id":"MDQ6VXNlcjk4Njg=","avatar_url":"https://avatars.githubusercontent.com/u/9868?v=4","gravatar_id":"","url":"https://api.github.com/users/jrudolph","html_url":"https://github.com/jrudolph","followers_url":"https://api.github.com/users/jrudolph/followers","following_url":"https://api.github.com/users/jrudolph/following{/other_user}","gists_url":"https://api.github.com/users/jrudolph/gists{/gist_id}","starred_url":"https://api.github.com/users/jrudolph/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrudolph/subscriptions","organizations_url":"https://api.github.com/users/jrudolph/orgs","repos_url":"https://api.github.com/users/jrudolph/repos","events_url":"https://api.github.com/users/jrudolph/events{/privacy}","received_events_url":"https://api.github.com/users/jrudolph/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":33226908,"node_id":"MDU6TGFiZWwzMzIyNjkwOA==","url":"https://api.github.com/repos/playframework/playframework/labels/type:defect","name":"type:defect","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2020-08-11T08:47:31Z","updated_at":"2020-08-17T17:11:28Z","closed_at":"2020-08-17T17:11:28Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The Chunker holds back data indefinitely if the buffer is not filled.\r\n\r\nIn fact, it's unclear what the purpose of the chunker is in front of the gzip compression in GzipFlow. \r\n\r\n~Most likely it is an attempt to make compression work if the input data is chunked to very small pieces. Akka Stream's Compression.Gzip does a [`SYNC_FLUSH`](https://www.bolet.org/~pornin/deflate-flush.html) after each chunk which will create a new deflate block for each chunk. This leads to an extra constant 4 bytes delimiter per chunk and reduced compression rate because of potentially suboptimal Huffman encoding because short blocks do not aggregate enough statistics to warrant custom and more optimal huffman coding. In any case, the LZ part of compression (finding repetitions in recent stream history) works across chunks and the default huffman table will still be good enough for most purposes.~\r\n\r\n~There's a tradeoff between better compression rate and sending data earlier. One reasoning not to require the extra buffers of the chunker is that if you have a high-throughput stream, you are more likely already have data in bigger chunks, i.e. extra chunking in GzipFlow is not required. On the other hand, if you send out small chunks, data will probably arrive in greater intervals, i.e. throughput is not the main concern, so there's no reason to retain data (potentially indefinitely) for the purpose of optimizing compression rate.~\r\n\r\n*EDIT: I don't think the above explanation makes sense. This issue is just a bug AFAIU. The purpose of the chunker seems to be to limit the **maximum** amount of data to send to the gzip stage and not the **minimum**. So, there's no reason hold back data in `onPull`.*\r\n\r\nIt seems the Chunker was introduced in #6813 in 2016 and later improved in #9520. @schmitch do you happen to remember why you added the Chunker?","closed_by":{"login":"mergify[bot]","id":37929162,"node_id":"MDM6Qm90Mzc5MjkxNjI=","avatar_url":"https://avatars.githubusercontent.com/in/10562?v=4","gravatar_id":"","url":"https://api.github.com/users/mergify%5Bbot%5D","html_url":"https://github.com/apps/mergify","followers_url":"https://api.github.com/users/mergify%5Bbot%5D/followers","following_url":"https://api.github.com/users/mergify%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/mergify%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/mergify%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mergify%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/mergify%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/mergify%5Bbot%5D/repos","events_url":"https://api.github.com/users/mergify%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/mergify%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/playframework/playframework/issues/10418/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/playframework/playframework/issues/10418/timeline","performed_via_github_app":null,"state_reason":"completed"}