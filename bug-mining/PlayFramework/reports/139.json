{"url":"https://api.github.com/repos/playframework/playframework/issues/8128","repository_url":"https://api.github.com/repos/playframework/playframework","labels_url":"https://api.github.com/repos/playframework/playframework/issues/8128/labels{/name}","comments_url":"https://api.github.com/repos/playframework/playframework/issues/8128/comments","events_url":"https://api.github.com/repos/playframework/playframework/issues/8128/events","html_url":"https://github.com/playframework/playframework/issues/8128","id":284909969,"node_id":"MDU6SXNzdWUyODQ5MDk5Njk=","number":8128,"title":"[2.6.10] Invalid escape sequence in query String is handled differently in AkkaHttpServer vs NettyHttpServer","user":{"login":"fkoehler","id":943818,"node_id":"MDQ6VXNlcjk0MzgxOA==","avatar_url":"https://avatars.githubusercontent.com/u/943818?v=4","gravatar_id":"","url":"https://api.github.com/users/fkoehler","html_url":"https://github.com/fkoehler","followers_url":"https://api.github.com/users/fkoehler/followers","following_url":"https://api.github.com/users/fkoehler/following{/other_user}","gists_url":"https://api.github.com/users/fkoehler/gists{/gist_id}","starred_url":"https://api.github.com/users/fkoehler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fkoehler/subscriptions","organizations_url":"https://api.github.com/users/fkoehler/orgs","repos_url":"https://api.github.com/users/fkoehler/repos","events_url":"https://api.github.com/users/fkoehler/events{/privacy}","received_events_url":"https://api.github.com/users/fkoehler/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":60939452,"node_id":"MDU6TGFiZWw2MDkzOTQ1Mg==","url":"https://api.github.com/repos/playframework/playframework/labels/help%20wanted","name":"help wanted","color":"7057ff","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2017-12-28T12:59:13Z","updated_at":"2023-02-15T21:30:21Z","closed_at":"2018-02-05T10:09:17Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When an invalid request is being made where the query string parameters are not correctly encoded, i.e:\r\n\r\n- localhost:9000?a=someparam%invalidhexvalue\r\n- localhost:9000?a=%\r\n- localhost:9000?a=%_D\r\n\r\nwhen using plugin `PlayNettyServer` play fails with an Internal Server Error with an exception similar to this one:\r\n\r\n```\r\nCaused by: java.lang.IllegalArgumentException: unterminated escape sequence at index 3 of: ?a=%\r\n\tat io.netty.handler.codec.http.QueryStringDecoder.decodeComponent(QueryStringDecoder.java:334)\r\n\tat io.netty.handler.codec.http.QueryStringDecoder.addParam(QueryStringDecoder.java:243)\r\n\tat io.netty.handler.codec.http.QueryStringDecoder.decodeParams(QueryStringDecoder.java:230)\r\n\tat io.netty.handler.codec.http.QueryStringDecoder.parameters(QueryStringDecoder.java:180)\r\n\tat play.core.server.netty.NettyModelConversion$$anon$2.queryMap$lzycompute(NettyModelConversion.scala:113)\r\n\tat play.core.server.netty.NettyModelConversion$$anon$2.queryMap(NettyModelConversion.scala:111)\r\n\tat play.api.mvc.RequestHeader.queryString(RequestHeader.scala:95)\r\n```\r\n\r\nThe behaviour in the `PlayAkkaHttpServer` is different though. It just prints a WARNing and continues to process the request using an empty map for the query parameters:\r\n\r\n```\r\nWARN  13:36:43.108 | p.c.s.a.AkkaModelConversion | Failed to parse query string; returning empty map.: \r\nakka.http.scaladsl.model.IllegalUriException: Illegal query: Unexpected end of input, expected HEXDIG (line 1, column 4): a=%\r\n   ^\r\n\tat akka.http.scaladsl.model.IllegalUriException$.apply(ErrorInfo.scala:40)\r\n\tat akka.http.scaladsl.model.Uri$.fail(Uri.scala:813)\r\n\tat akka.http.impl.model.parser.UriParser.fail(UriParser.scala:81)\r\n\tat akka.http.impl.model.parser.UriParser.parseQuery(UriParser.scala:70)\r\n\tat akka.http.scaladsl.model.Uri.query(Uri.scala:37)\r\n\tat play.core.server.akkahttp.AkkaModelConversion$$anon$2.liftedTree2$1(AkkaModelConversion.scala:134)\r\n\tat play.core.server.akkahttp.AkkaModelConversion$$anon$2.queryMap$lzycompute(AkkaModelConversion.scala:133)\r\n\tat play.core.server.akkahttp.AkkaModelConversion$$anon$2.queryMap(AkkaModelConversion.scala:132)\r\n```\r\n\r\nI think there are two issues here: \r\n\r\n1. Both server implementations should behave equally\r\n2. I would prefer it behaves like in the AkkaHttpServer since it is more robust and in this case valid to return an empty map\r\n\r\nHere are the problematic source code lines. In the AkkaModelConversion there is a try/catch around the query parsing to make it robust:\r\n\r\nhttps://github.com/playframework/playframework/blob/master/framework/src/play-akka-http-server/src/main/scala/play/core/server/akkahttp/AkkaModelConversion.scala#L132-L140\r\nvs\r\nhttps://github.com/playframework/playframework/blob/master/framework/src/play-netty-server/src/main/scala/play/core/server/netty/NettyModelConversion.scala#L111-L115\r\n\r\n\r\n","closed_by":{"login":"gmethvin","id":171663,"node_id":"MDQ6VXNlcjE3MTY2Mw==","avatar_url":"https://avatars.githubusercontent.com/u/171663?v=4","gravatar_id":"","url":"https://api.github.com/users/gmethvin","html_url":"https://github.com/gmethvin","followers_url":"https://api.github.com/users/gmethvin/followers","following_url":"https://api.github.com/users/gmethvin/following{/other_user}","gists_url":"https://api.github.com/users/gmethvin/gists{/gist_id}","starred_url":"https://api.github.com/users/gmethvin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmethvin/subscriptions","organizations_url":"https://api.github.com/users/gmethvin/orgs","repos_url":"https://api.github.com/users/gmethvin/repos","events_url":"https://api.github.com/users/gmethvin/events{/privacy}","received_events_url":"https://api.github.com/users/gmethvin/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/playframework/playframework/issues/8128/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/playframework/playframework/issues/8128/timeline","performed_via_github_app":null,"state_reason":"completed"}