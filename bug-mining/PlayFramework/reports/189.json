{"url":"https://api.github.com/repos/playframework/playframework/issues/12770","repository_url":"https://api.github.com/repos/playframework/playframework","labels_url":"https://api.github.com/repos/playframework/playframework/issues/12770/labels{/name}","comments_url":"https://api.github.com/repos/playframework/playframework/issues/12770/comments","events_url":"https://api.github.com/repos/playframework/playframework/issues/12770/events","html_url":"https://github.com/playframework/playframework/issues/12770","id":2359408527,"node_id":"I_kwDOACO2xc6MobeP","number":12770,"title":"Temporary file is deleted before a controller returns a response","user":{"login":"tkawachi","id":22657,"node_id":"MDQ6VXNlcjIyNjU3","avatar_url":"https://avatars.githubusercontent.com/u/22657?v=4","gravatar_id":"","url":"https://api.github.com/users/tkawachi","html_url":"https://github.com/tkawachi","followers_url":"https://api.github.com/users/tkawachi/followers","following_url":"https://api.github.com/users/tkawachi/following{/other_user}","gists_url":"https://api.github.com/users/tkawachi/gists{/gist_id}","starred_url":"https://api.github.com/users/tkawachi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tkawachi/subscriptions","organizations_url":"https://api.github.com/users/tkawachi/orgs","repos_url":"https://api.github.com/users/tkawachi/repos","events_url":"https://api.github.com/users/tkawachi/events{/privacy}","received_events_url":"https://api.github.com/users/tkawachi/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/playframework/playframework/milestones/137","html_url":"https://github.com/playframework/playframework/milestone/137","labels_url":"https://api.github.com/repos/playframework/playframework/milestones/137/labels","id":11195694,"node_id":"MI_kwDOACO2xc4AqtUu","number":137,"title":"2.9.5","description":"","creator":{"login":"mkurz","id":644927,"node_id":"MDQ6VXNlcjY0NDkyNw==","avatar_url":"https://avatars.githubusercontent.com/u/644927?v=4","gravatar_id":"","url":"https://api.github.com/users/mkurz","html_url":"https://github.com/mkurz","followers_url":"https://api.github.com/users/mkurz/followers","following_url":"https://api.github.com/users/mkurz/following{/other_user}","gists_url":"https://api.github.com/users/mkurz/gists{/gist_id}","starred_url":"https://api.github.com/users/mkurz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mkurz/subscriptions","organizations_url":"https://api.github.com/users/mkurz/orgs","repos_url":"https://api.github.com/users/mkurz/repos","events_url":"https://api.github.com/users/mkurz/events{/privacy}","received_events_url":"https://api.github.com/users/mkurz/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":7,"state":"closed","created_at":"2024-06-17T10:22:52Z","updated_at":"2024-07-24T08:58:01Z","due_on":null,"closed_at":"2024-07-24T08:58:01Z"},"comments":6,"created_at":"2024-06-18T09:35:51Z","updated_at":"2025-02-11T11:06:01Z","closed_at":"2024-06-24T21:57:14Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Play Version\r\n\r\n3.0.4\r\n\r\n### API\r\n\r\nScala\r\n\r\n### Operating System\r\n\r\nmacOS 14.4.1\r\n\r\n### JDK\r\n\r\n```\r\nopenjdk version \"21.0.2\" 2024-01-16 LTS\r\nOpenJDK Runtime Environment Corretto-21.0.2.13.1 (build 21.0.2+13-LTS)\r\nOpenJDK 64-Bit Server VM Corretto-21.0.2.13.1 (build 21.0.2+13-LTS, mixed mode, sharing)\r\n```\r\n\r\n### Library Dependencies\r\n\r\nNone\r\n\r\n### Expected Behavior\r\n\r\nI have prepared the following Controller method.\r\n\r\n```scala\r\n  def fileSize() =\r\n    Action.async(parse.multipartFormData) { implicit request =>\r\n      request.body.file(\"file\") match {\r\n        case Some(image) =>\r\n          for {\r\n            path <- Future(image.ref.path)\r\n            _ <- Future(System.gc())\r\n            _ <- Future(Thread.sleep(100))\r\n          } yield Ok(Files.size(path).toString)\r\n        case None =>\r\n          Future.successful(BadRequest(\"No image supplied\"))\r\n      }\r\n    }\r\n```\r\n\r\nThe endpoint is as follows.\r\n\r\n```\r\nPOST    /fileSize                   controllers.HomeController.fileSize()\r\n```\r\n\r\n<!-- Please describe the expected behavior of the issue, starting from the first action. -->\r\n\r\n1. Send a POST request.\r\n    - `echo -n Hello > /tmp/a; curl -X POST http://localhost:9000/fileSize -F\"file=@/tmp/a\"`\r\n2. The server returns the file size and the command displays 5.\r\n\r\n### Actual Behavior\r\n\r\n\r\n1. Send a POST request.\r\n    - `echo -n Hello > /tmp/a; curl -X POST http://localhost:9000/fileSize -F\"file=@/tmp/a\"`\r\n2. The server returns an error page.\r\n3. The server logs following\r\n\r\n```\r\n2024-06-18 18:25:01 ERROR p.api.http.DefaultHttpErrorHandler  \r\n\r\n! @85ph4o99f - Internal server error, for (POST) [/fileSize] ->\r\n \r\nplay.api.http.HttpErrorHandlerExceptions$$anon$1: Execution exception[[NoSuchFileException: /var/folders/r2/qjlxkmsn49v6mtmb6dgs3xrc0000gr/T/playtemp8649900777384842915/multipartBody4548848415921731547asTemporaryFile]]\r\n\tat play.api.http.HttpErrorHandlerExceptions$.$anonfun$convertToPlayException$2(HttpErrorHandler.scala:400)\r\n\tat scala.Option.map(Option.scala:242)\r\n\tat play.api.http.HttpErrorHandlerExceptions$.convertToPlayException(HttpErrorHandler.scala:398)\r\n\tat play.api.http.HttpErrorHandlerExceptions$.throwableToUsefulException(HttpErrorHandler.scala:390)\r\n\tat play.api.http.DefaultHttpErrorHandler.onServerError(HttpErrorHandler.scala:267)\r\n\tat play.core.server.PekkoHttpServer$$anonfun$invokeAction$1$1.applyOrElse(PekkoHttpServer.scala:482)\r\n\tat play.core.server.PekkoHttpServer$$anonfun$invokeAction$1$1.applyOrElse(PekkoHttpServer.scala:474)\r\n\tat scala.concurrent.impl.Promise$Transformation.run(Promise.scala:490)\r\n\tat org.apache.pekko.dispatch.BatchingExecutor$AbstractBatch.processBatch(BatchingExecutor.scala:73)\r\n\tat org.apache.pekko.dispatch.BatchingExecutor$BlockableBatch.$anonfun$run$1(BatchingExecutor.scala:110)\r\n\tat scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)\r\n\tat scala.concurrent.BlockContext$.withBlockContext(BlockContext.scala:94)\r\n\tat org.apache.pekko.dispatch.BatchingExecutor$BlockableBatch.run(BatchingExecutor.scala:110)\r\n\tat org.apache.pekko.dispatch.TaskInvocation.run(AbstractDispatcher.scala:59)\r\n\tat org.apache.pekko.dispatch.ForkJoinExecutorConfigurator$PekkoForkJoinTask.exec(ForkJoinExecutorConfigurator.scala:57)\r\n\tat java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387)\r\n\tat java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1312)\r\n\tat java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1843)\r\n\tat java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1808)\r\n\tat java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188)\r\nCaused by: java.nio.file.NoSuchFileException: /var/folders/r2/qjlxkmsn49v6mtmb6dgs3xrc0000gr/T/playtemp8649900777384842915/multipartBody4548848415921731547asTemporaryFile\r\n\tat java.base/sun.nio.fs.UnixException.translateToIOException(UnixException.java:92)\r\n\tat java.base/sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:106)\r\n\tat java.base/sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:111)\r\n\tat java.base/sun.nio.fs.UnixFileAttributeViews$Basic.readAttributes(UnixFileAttributeViews.java:55)\r\n\tat java.base/sun.nio.fs.UnixFileSystemProvider.readAttributes(UnixFileSystemProvider.java:171)\r\n\tat java.base/java.nio.file.Files.readAttributes(Files.java:1853)\r\n\tat java.base/java.nio.file.Files.size(Files.java:2462)\r\n\tat controllers.HomeController.$anonfun$fileSize$7(HomeController.scala:36)\r\n\tat scala.concurrent.impl.Promise$Transformation.run(Promise.scala:467)\r\n\tat java.base/java.util.concurrent.ForkJoinTask$RunnableExecuteAction.exec(ForkJoinTask.java:1423)\r\n\t... 5 common frames omitted\r\n```\r\n\r\nThe file pointed to by TemporaryFile seems to be erased during GC, but I suppose that it would not be GC'd until it returns a response.\r\n\r\n### Reproducible Test Case\r\n\r\nhttps://github.com/tkawachi/play-tmpfile-deleted/commit/c9dbcd7c00863afc5b2f070cdc7fe9ceabe85dda","closed_by":{"login":"mkurz","id":644927,"node_id":"MDQ6VXNlcjY0NDkyNw==","avatar_url":"https://avatars.githubusercontent.com/u/644927?v=4","gravatar_id":"","url":"https://api.github.com/users/mkurz","html_url":"https://github.com/mkurz","followers_url":"https://api.github.com/users/mkurz/followers","following_url":"https://api.github.com/users/mkurz/following{/other_user}","gists_url":"https://api.github.com/users/mkurz/gists{/gist_id}","starred_url":"https://api.github.com/users/mkurz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mkurz/subscriptions","organizations_url":"https://api.github.com/users/mkurz/orgs","repos_url":"https://api.github.com/users/mkurz/repos","events_url":"https://api.github.com/users/mkurz/events{/privacy}","received_events_url":"https://api.github.com/users/mkurz/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/playframework/playframework/issues/12770/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/playframework/playframework/issues/12770/timeline","performed_via_github_app":null,"state_reason":"completed"}