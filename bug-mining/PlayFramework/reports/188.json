{"url":"https://api.github.com/repos/playframework/playframework/issues/12333","repository_url":"https://api.github.com/repos/playframework/playframework","labels_url":"https://api.github.com/repos/playframework/playframework/issues/12333/labels{/name}","comments_url":"https://api.github.com/repos/playframework/playframework/issues/12333/comments","events_url":"https://api.github.com/repos/playframework/playframework/issues/12333/events","html_url":"https://github.com/playframework/playframework/issues/12333","id":2094136993,"node_id":"I_kwDOACO2xc580f6h","number":12333,"title":"Loss `Result` attributes by any modification","user":{"login":"hertg","id":3533648,"node_id":"MDQ6VXNlcjM1MzM2NDg=","avatar_url":"https://avatars.githubusercontent.com/u/3533648?v=4","gravatar_id":"","url":"https://api.github.com/users/hertg","html_url":"https://github.com/hertg","followers_url":"https://api.github.com/users/hertg/followers","following_url":"https://api.github.com/users/hertg/following{/other_user}","gists_url":"https://api.github.com/users/hertg/gists{/gist_id}","starred_url":"https://api.github.com/users/hertg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hertg/subscriptions","organizations_url":"https://api.github.com/users/hertg/orgs","repos_url":"https://api.github.com/users/hertg/repos","events_url":"https://api.github.com/users/hertg/events{/privacy}","received_events_url":"https://api.github.com/users/hertg/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":33226908,"node_id":"MDU6TGFiZWwzMzIyNjkwOA==","url":"https://api.github.com/repos/playframework/playframework/labels/type:defect","name":"type:defect","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/playframework/playframework/milestones/131","html_url":"https://github.com/playframework/playframework/milestone/131","labels_url":"https://api.github.com/repos/playframework/playframework/milestones/131/labels","id":10279964,"node_id":"MI_kwDOACO2xc4AnNwc","number":131,"title":"3.0.2","description":"","creator":{"login":"mkurz","id":644927,"node_id":"MDQ6VXNlcjY0NDkyNw==","avatar_url":"https://avatars.githubusercontent.com/u/644927?v=4","gravatar_id":"","url":"https://api.github.com/users/mkurz","html_url":"https://github.com/mkurz","followers_url":"https://api.github.com/users/mkurz/followers","following_url":"https://api.github.com/users/mkurz/following{/other_user}","gists_url":"https://api.github.com/users/mkurz/gists{/gist_id}","starred_url":"https://api.github.com/users/mkurz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mkurz/subscriptions","organizations_url":"https://api.github.com/users/mkurz/orgs","repos_url":"https://api.github.com/users/mkurz/repos","events_url":"https://api.github.com/users/mkurz/events{/privacy}","received_events_url":"https://api.github.com/users/mkurz/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":40,"state":"closed","created_at":"2023-12-07T12:17:29Z","updated_at":"2024-03-01T16:18:22Z","due_on":null,"closed_at":"2024-03-01T16:18:22Z"},"comments":4,"created_at":"2024-01-22T15:11:25Z","updated_at":"2024-01-23T11:09:53Z","closed_at":"2024-01-23T11:09:53Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Play Version\r\n\r\n`3.0.0`\r\n\r\n### API\r\n\r\nJava\r\n\r\n### JDK\r\n\r\n```\r\nopenjdk version \"21.0.1\" 2023-10-17 LTS\r\nOpenJDK Runtime Environment Corretto-21.0.1.12.1 (build 21.0.1+12-LTS)\r\nOpenJDK 64-Bit Server VM Corretto-21.0.1.12.1 (build 21.0.1+12-LTS, mixed mode, sharing)\r\n```\r\n\r\n### Expected Behavior\r\n\r\nAdding cookies to an `Http.Result` should not clear the `Http.Result` attrs.\r\n\r\n### Actual Behavior\r\n\r\nI found this unexpected side effect of the `withCookies()` method by implementing something similar to this inside a [Filter](https://www.playframework.com/documentation/2.8.x/Filters):\r\n\r\n```java\r\n// pseudo-code\r\nreturn next.apply(rh)\r\n        .thenApply(result -> {\r\n            if (result.attrs().getOptional(CREATE_FOO_COOKIE).isPresent()) {\r\n                // this has the unintended side-effect of clearing the result attrs\r\n                return result.withCookies(fooCookie);\r\n            }\r\n            return result;\r\n        })\r\n        .thenApply(result -> {\r\n            // the attrs will be empty if the foo cookie above was created\r\n            if (result.attrs().getOptional(CREATE_BAR_COOKIE).isPresent()) {\r\n                return result.withCookies(barCookie);\r\n            }\r\n            return result;\r\n        });\r\n```\r\n\r\n### Workaround\r\n\r\nMy workaround will probably be to simply do this in a single step, and adding all cookies at once. Since I do not need the attrs at a later stage, this will be sufficient for me. However, I do feel that this is unexpected behavior and a loss of the result's `attrs` may impact anyone who relies on those in their action composition.\r\n\r\n### Fix\r\n\r\nI expect this to be fairly easy to fix. The LOC at fault is https://github.com/playframework/playframework/blob/a77da07e0b2d594af5d538c38803ba2466e20517/core/play/src/main/java/play/mvc/Result.java#L474\r\n\r\nThis calls the constructor here: https://github.com/playframework/playframework/blob/a77da07e0b2d594af5d538c38803ba2466e20517/core/play/src/main/java/play/mvc/Result.java#L82-L84\r\n\r\nWhen it should probably call this constructor directly: https://github.com/playframework/playframework/blob/a77da07e0b2d594af5d538c38803ba2466e20517/core/play/src/main/java/play/mvc/Result.java#L58-L71\r\n","closed_by":{"login":"mkurz","id":644927,"node_id":"MDQ6VXNlcjY0NDkyNw==","avatar_url":"https://avatars.githubusercontent.com/u/644927?v=4","gravatar_id":"","url":"https://api.github.com/users/mkurz","html_url":"https://github.com/mkurz","followers_url":"https://api.github.com/users/mkurz/followers","following_url":"https://api.github.com/users/mkurz/following{/other_user}","gists_url":"https://api.github.com/users/mkurz/gists{/gist_id}","starred_url":"https://api.github.com/users/mkurz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mkurz/subscriptions","organizations_url":"https://api.github.com/users/mkurz/orgs","repos_url":"https://api.github.com/users/mkurz/repos","events_url":"https://api.github.com/users/mkurz/events{/privacy}","received_events_url":"https://api.github.com/users/mkurz/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/playframework/playframework/issues/12333/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":1,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/playframework/playframework/issues/12333/timeline","performed_via_github_app":null,"state_reason":"completed"}