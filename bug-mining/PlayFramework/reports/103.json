{"url":"https://api.github.com/repos/playframework/playframework/issues/4878","repository_url":"https://api.github.com/repos/playframework/playframework","labels_url":"https://api.github.com/repos/playframework/playframework/issues/4878/labels{/name}","comments_url":"https://api.github.com/repos/playframework/playframework/issues/4878/comments","events_url":"https://api.github.com/repos/playframework/playframework/issues/4878/events","html_url":"https://github.com/playframework/playframework/issues/4878","id":96524943,"node_id":"MDU6SXNzdWU5NjUyNDk0Mw==","number":4878,"title":"HEAD request on websocket throws ugly 500","user":{"login":"gpgekko","id":5121420,"node_id":"MDQ6VXNlcjUxMjE0MjA=","avatar_url":"https://avatars.githubusercontent.com/u/5121420?v=4","gravatar_id":"","url":"https://api.github.com/users/gpgekko","html_url":"https://github.com/gpgekko","followers_url":"https://api.github.com/users/gpgekko/followers","following_url":"https://api.github.com/users/gpgekko/following{/other_user}","gists_url":"https://api.github.com/users/gpgekko/gists{/gist_id}","starred_url":"https://api.github.com/users/gpgekko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gpgekko/subscriptions","organizations_url":"https://api.github.com/users/gpgekko/orgs","repos_url":"https://api.github.com/users/gpgekko/repos","events_url":"https://api.github.com/users/gpgekko/events{/privacy}","received_events_url":"https://api.github.com/users/gpgekko/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":33226908,"node_id":"MDU6TGFiZWwzMzIyNjkwOA==","url":"https://api.github.com/repos/playframework/playframework/labels/type:defect","name":"type:defect","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2015-07-22T09:53:50Z","updated_at":"2017-03-13T19:07:20Z","closed_at":"2017-03-13T19:07:20Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Tripped over this by complete coincidence, but when you do a `HEAD` request to a websocket endpoint, you get a ugly internal server error (see stacktrace at the bottom).\n\nI started poking around, but this is the only case I could come up with that would break, so I'm guessing this is the automagic `GET`s-also-serve-`HEAD`s code messing things up here, probably failing to return a `WebSocket.reject response`.\nOther things I tried, but were handled perfectly fine:\n- normal `GET` request to the websocket endpoint, without websocket headers (`400 bad request`, expecting this from the `HEAD` request too)\n- other HTTP method requests (like `DELETE`, `OPTION`, `PUT`) to the websocket endpoint (`404 not found`)\n- `HEAD` request to non websocket endpoints (`200 OK`)\n\nIt would be nice to get a clean response instead of a nasty stacktrace, even though it is unlikely that someone will run in to this.\n\n```\n[ERROR] from application in New I/O worker #19 - ! @6mpedf1kb - Internal server error, for (HEAD) [/news/stream] -> play.api.http.HttpErrorHandlerExceptions$$anon$1: Execution exception[[MatchError: Some(WebSocket(<function1>)) (of class scala.Some)]]\n    at play.api.http.HttpErrorHandlerExceptions$.throwableToUsefulException(HttpErrorHandler.scala:265) ~[play_2.11-2.4.2.jar:2.4.2]\n    at play.api.http.DefaultHttpErrorHandler.onServerError(HttpErrorHandler.scala:191) ~[play_2.11-2.4.2.jar:2.4.2]\n    at play.core.server.Server$class.logExceptionAndGetResult$1(Server.scala:50) [play-server_2.11-2.4.2.jar:2.4.2]\n    at play.core.server.Server$$anonfun$getHandlerFor$4.apply(Server.scala:59) [play-server_2.11-2.4.2.jar:2.4.2]\n    at play.core.server.Server$$anonfun$getHandlerFor$4.apply(Server.scala:57) [play-server_2.11-2.4.2.jar:2.4.2]\n    at scala.util.Either$RightProjection.flatMap(Either.scala:522) [scala-library-2.11.7.jar:na]\n    at play.core.server.Server$class.getHandlerFor(Server.scala:57) [play-server_2.11-2.4.2.jar:2.4.2]\n    at play.core.server.NettyServer.getHandlerFor(NettyServer.scala:33) [play-netty-server_2.11-2.4.2.jar:2.4.2]\n    at play.core.server.netty.PlayDefaultUpstreamHandler$$anonfun$8.apply(PlayDefaultUpstreamHandler.scala:139) [play-netty-server_2.11-2.4.2.jar:2.4.2]\n    at play.core.server.netty.PlayDefaultUpstreamHandler$$anonfun$8.apply(PlayDefaultUpstreamHandler.scala:139) [play-netty-server_2.11-2.4.2.jar:2.4.2]\n    at scala.util.Either.fold(Either.scala:99) [scala-library-2.11.7.jar:na]\n    at play.core.server.netty.PlayDefaultUpstreamHandler.messageReceived(PlayDefaultUpstreamHandler.scala:127) [play-netty-server_2.11-2.4.2.jar:2.4.2]\n    at org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(DefaultChannelPipeline.java:791) [netty-3.10.3.Final.jar:na]\n    at com.typesafe.netty.http.pipelining.HttpPipeliningHandler.messageReceived(HttpPipeliningHandler.java:62) [netty-http-pipelining-1.1.4.jar:na]\n    at org.jboss.netty.channel.SimpleChannelHandler.handleUpstream(SimpleChannelHandler.java:88) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(DefaultChannelPipeline.java:791) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.handler.codec.http.HttpContentDecoder.messageReceived(HttpContentDecoder.java:108) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(DefaultChannelPipeline.java:791) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:296) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.handler.codec.frame.FrameDecoder.unfoldAndFireMessageReceived(FrameDecoder.java:459) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.handler.codec.replay.ReplayingDecoder.callDecode(ReplayingDecoder.java:536) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.handler.codec.replay.ReplayingDecoder.messageReceived(ReplayingDecoder.java:435) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:559) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:268) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:255) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.socket.nio.NioWorker.read(NioWorker.java:88) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.socket.nio.AbstractNioWorker.process(AbstractNioWorker.java:108) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.socket.nio.AbstractNioSelector.run(AbstractNioSelector.java:337) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.socket.nio.AbstractNioWorker.run(AbstractNioWorker.java:89) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:178) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:108) [netty-3.10.3.Final.jar:na]\n    at org.jboss.netty.util.internal.DeadLockProofWorker$1.run(DeadLockProofWorker.java:42) [netty-3.10.3.Final.jar:na]\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [na:1.8.0_51]\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_51]\n    at java.lang.Thread.run(Thread.java:745) [na:1.8.0_51]\nCaused by: scala.MatchError: Some(WebSocket(<function1>)) (of class scala.Some)\n    at play.api.GlobalSettings$$anonfun$3.apply(GlobalSettings.scala:119) ~[play_2.11-2.4.2.jar:2.4.2]\n    at play.api.GlobalSettings$$anonfun$3.apply(GlobalSettings.scala:113) ~[play_2.11-2.4.2.jar:2.4.2]\n    at scala.Option.getOrElse(Option.scala:121) ~[scala-library-2.11.7.jar:na]\n    at play.api.GlobalSettings$class.onRequestReceived(GlobalSettings.scala:113) ~[play_2.11-2.4.2.jar:2.4.2]\n    at play.core.j.JavaGlobalSettingsAdapter.onRequestReceived(JavaGlobalSettingsAdapter.scala:14) ~[play_2.11-2.4.2.jar:2.4.2]\n    at play.api.http.GlobalSettingsHttpRequestHandler.handlerForRequest(HttpRequestHandler.scala:183) ~[play_2.11-2.4.2.jar:2.4.2]\n    at play.core.server.Server$$anonfun$sendHandler$1$1.apply(Server.scala:38) ~[play-server_2.11-2.4.2.jar:2.4.2]\n    at play.core.server.Server$$anonfun$sendHandler$1$1.apply(Server.scala:37) ~[play-server_2.11-2.4.2.jar:2.4.2]\n    at scala.util.Success$$anonfun$map$1.apply(Try.scala:237) ~[scala-library-2.11.7.jar:na]\n    at scala.util.Try$.apply(Try.scala:192) ~[scala-library-2.11.7.jar:na]\n    at scala.util.Success.map(Try.scala:237) ~[scala-library-2.11.7.jar:na]\n    at play.core.server.Server$class.sendHandler$1(Server.scala:37) [play-server_2.11-2.4.2.jar:2.4.2]\n    at play.core.server.Server$$anonfun$getHandlerFor$4.apply(Server.scala:58) [play-server_2.11-2.4.2.jar:2.4.2]\n    ... 38 common frames omitted\n```\n","closed_by":{"login":"marcospereira","id":4576,"node_id":"MDQ6VXNlcjQ1NzY=","avatar_url":"https://avatars.githubusercontent.com/u/4576?v=4","gravatar_id":"","url":"https://api.github.com/users/marcospereira","html_url":"https://github.com/marcospereira","followers_url":"https://api.github.com/users/marcospereira/followers","following_url":"https://api.github.com/users/marcospereira/following{/other_user}","gists_url":"https://api.github.com/users/marcospereira/gists{/gist_id}","starred_url":"https://api.github.com/users/marcospereira/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcospereira/subscriptions","organizations_url":"https://api.github.com/users/marcospereira/orgs","repos_url":"https://api.github.com/users/marcospereira/repos","events_url":"https://api.github.com/users/marcospereira/events{/privacy}","received_events_url":"https://api.github.com/users/marcospereira/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/playframework/playframework/issues/4878/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/playframework/playframework/issues/4878/timeline","performed_via_github_app":null,"state_reason":"completed"}