{"url":"https://api.github.com/repos/playframework/playframework/issues/10944","repository_url":"https://api.github.com/repos/playframework/playframework","labels_url":"https://api.github.com/repos/playframework/playframework/issues/10944/labels{/name}","comments_url":"https://api.github.com/repos/playframework/playframework/issues/10944/comments","events_url":"https://api.github.com/repos/playframework/playframework/issues/10944/events","html_url":"https://github.com/playframework/playframework/issues/10944","id":966224518,"node_id":"MDU6SXNzdWU5NjYyMjQ1MTg=","number":10944,"title":"Unicode header values should not cause server errors","user":{"login":"bursauxa","id":15860132,"node_id":"MDQ6VXNlcjE1ODYwMTMy","avatar_url":"https://avatars.githubusercontent.com/u/15860132?v=4","gravatar_id":"","url":"https://api.github.com/users/bursauxa","html_url":"https://github.com/bursauxa","followers_url":"https://api.github.com/users/bursauxa/followers","following_url":"https://api.github.com/users/bursauxa/following{/other_user}","gists_url":"https://api.github.com/users/bursauxa/gists{/gist_id}","starred_url":"https://api.github.com/users/bursauxa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bursauxa/subscriptions","organizations_url":"https://api.github.com/users/bursauxa/orgs","repos_url":"https://api.github.com/users/bursauxa/repos","events_url":"https://api.github.com/users/bursauxa/events{/privacy}","received_events_url":"https://api.github.com/users/bursauxa/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-08-11T08:27:18Z","updated_at":"2021-09-22T21:15:51Z","closed_at":"2021-09-22T21:15:51Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Play Version\r\n\r\n2.8.8\r\n\r\n### API\r\n\r\nScala\r\n\r\n### Expected Behavior\r\n\r\nWhen receiving headers with Unicode values, Play server should do either of the following:\r\n\r\n1. Return HTTP 400, based on the request header being invalid as per [RFC2616](https://datatracker.ietf.org/doc/html/rfc2616#section-4.2)\r\n2. Be lenient and accept Unicode headers just as it accepts Ascii headers (we received this header through several routing layers, so evidently there are some tech stacks out there that tolerate Unicode headers)\r\n\r\n### Actual Behavior\r\n\r\nWhen receiving headers with Unicode values, the following happens:\r\n\r\n1. An error is logged with the following message:\r\n```\r\nException occurred while converting Result with headers [<myHeader>: <독골사거리역더퍼스트뷰>, ...]. Calling HttpErrorHandler to get alternative Result.\r\n```\r\nAnd the following stack trace:\r\n```\r\njava.lang.IllegalArgumentException: Character 46021 cannot match AsciiSet because it is out of range\r\n        at play.core.utils.AsciiBitSet.get(AsciiSet.scala:94)\r\n\tat play.core.server.common.ServerResultUtils.loop$1(ServerResultUtils.scala:130)\r\n        ...\r\n```\r\nThis one is explicitly logged at [ServerResultUtils:166](https://github.com/playframework/playframework/blob/2.8.x/transport/server/play-server/src/main/scala/play/core/server/common/ServerResultUtils.scala#L166) - this log should be info level, not error level.\r\n\r\nI assume there could in theory be server-caused conversion errors that deserve the error level, so it may be needed to differentiate on the type of `Throwable` received as parameter.\r\n\r\n2. Another error is logged with the following message:\r\n```\r\n! @7kjn33i1p - Internal server error, for (GET) [/myRoute] ->\r\n```\r\nAnd the following stack trace:\r\n```\r\nplay.api.UnexpectedException: Unexpected exception[ServerResultException: Error converting Play Result for server backend]\r\n\tat play.api.http.HttpErrorHandlerExceptions$.throwableToUsefulException(HttpErrorHandler.scala:358)\r\n\tat play.api.http.DefaultHttpErrorHandler.onServerError(HttpErrorHandler.scala:264)\r\n\tat play.core.server.common.ServerResultUtils.play$core$server$common$ServerResultUtils$$handleConversionError$1(ServerResultUtils.scala:173)\r\n        ...\r\n```\r\nThis one is caused by [ServerResultUtils:171](https://github.com/playframework/playframework/blob/2.8.x/transport/server/play-server/src/main/scala/play/core/server/common/ServerResultUtils.scala#L171) \"throwing\" an exception that bubbles all the way up. In this case it is not a server error, but a client error, so `onClientError` should be called instead of `onServerError`.\r\n\r\nThe same remark on error types applies as in point 1 above.\r\n\r\n3. The client receives an HTTP 500 reponse, when in reality it is the client that is at fault, so it should be HTTP 400. This has the same cause as point 2 above and would be fixed at the same time.","closed_by":{"login":"gmethvin","id":171663,"node_id":"MDQ6VXNlcjE3MTY2Mw==","avatar_url":"https://avatars.githubusercontent.com/u/171663?v=4","gravatar_id":"","url":"https://api.github.com/users/gmethvin","html_url":"https://github.com/gmethvin","followers_url":"https://api.github.com/users/gmethvin/followers","following_url":"https://api.github.com/users/gmethvin/following{/other_user}","gists_url":"https://api.github.com/users/gmethvin/gists{/gist_id}","starred_url":"https://api.github.com/users/gmethvin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmethvin/subscriptions","organizations_url":"https://api.github.com/users/gmethvin/orgs","repos_url":"https://api.github.com/users/gmethvin/repos","events_url":"https://api.github.com/users/gmethvin/events{/privacy}","received_events_url":"https://api.github.com/users/gmethvin/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/playframework/playframework/issues/10944/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/playframework/playframework/issues/10944/timeline","performed_via_github_app":null,"state_reason":"completed"}