{"id":359,"status":"New","summary":"src/system-alloc.cc:423] SbrkSysAllocator failed","labels":["Type-Defect","Priority-Medium"],"stars":0,"commentCount":26,"comments":[{"id":0,"commenterId":-7509596770629132865,"content":"I am seeing the following in my output linking against tcmalloc:\r\nsrc/system-alloc.cc:423] SbrkSysAllocator failed.\r\n\r\nI am using perftools v1.8 and this error cropped up after a recent re-compile. The program completes as expected, although it runs significantly slower (3x) compared to when I linked against tcmalloc and this error did not occur.  Removing tcmalloc restores performance to the expected without fast memory allocation.\r\n\r\nI am assuming some memory is not able to be allocated. I would be happy to create a minimal test case with some guidance on the error.\r\n","timestamp":1312210162,"attachments":[]},{"id":1,"commenterId":1451955930852924383,"content":"Did you update your version of tcmalloc when you started to see this message?  This message is new in perftools 1.8 (I\u0027m pretty sure).  I\u0027m not sure I understand your description of what is going on.\r\n\r\n(Also, you don\u0027t say what OS, CPU, compiler, etc. you\u0027re using.)\r\n\r\nYou may do best running with a debugger and putting a breakpoint in src/system-alloc.cc, and seeing what is causing the failure.  I don\u0027t know if this is the cause of the slowdown you\u0027re seeing, or a symptom.  You could also try running with a CPU profiler to see where the program is spending its time.","timestamp":1312317310,"attachments":[]},{"id":2,"commenterId":-7509596770629132865,"content":"It was when I re-compiled the software that is linking tcmalloc.  I am using the same version of tcmalloc.\r\n\r\nGCC: i686-apple-darwin10-gcc-4.2.1\r\nOS: Mac 10.6.8\r\nCPU: 2x2.66 GHz 6-core Intel Xeon\r\n\r\nI will try running the debugger and report my results.  Thank-you so far.\r\n","timestamp":1312317598,"attachments":[]},{"id":3,"commenterId":1451955930852924383,"content":"Oooh, OS X.  I revamped the memory routines for OS X pretty significantly in perftools 1.8, so I wouldn\u0027t be surprised if there were issues hanging about.  But I would have expected them to show up moving from perftools 1.7 to 1.8, not just when recompiling code that is linked against 1.8.  Also, I wouldn\u0027t expect problems to manifest with that particular warning message.  Very curious; definitely let me know what you find out!","timestamp":1312317898,"attachments":[]},{"id":4,"commenterId":-7509596770629132865,"content":"I added the \"-g\" option to CFLAGS and recompiled.  I then tried loading my software in the debugger and got a ton of warnings (see below).  I tried the trick at: http://code.google.com/p/google-perftools/issues/detail?id\u003d350, but no luck.\r\n\r\nGNU gdb 6.3.50-20050815 (Apple version gdb-1515) (Sat Jan 15 08:33:48 UTC 2011)\r\nCopyright 2004 Free Software Foundation, Inc.\r\nGDB is free software, covered by the GNU General Public License, and you are\r\nwelcome to change it and/or distribute copies of it under certain conditions.\r\nType \"show copying\" to see the conditions.\r\nThere is absolutely no warranty for GDB.  Type \"show warranty\" for details.\r\nThis GDB was configured as \"x86_64-apple-darwin\"...Reading symbols for shared libraries .\r\nwarning: .o file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc_la-tcmalloc.o\" more recent than executable timestamp in \"/usr/local/lib/libtcmalloc.0.dylib\"\r\n\r\nwarning: Could not open OSO file /Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc_la-tcmalloc.o to scan for pubtypes for objfile /usr/local/lib/libtcmalloc.0.dylib\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/dynamic_annotations.o\" - no debug information available for \"src/base/dynamic_annotations.c\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-central_freelist.o\" - no debug information available for \"src/central_freelist.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-common.o\" - no debug information available for \"src/common.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-heap-profile-table.o\" - no debug information available for \"src/heap-profile-table.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-heap-profiler.o\" - no debug information available for \"src/heap-profiler.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-internal_logging.o\" - no debug information available for \"src/internal_logging.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-low_level_alloc.o\" - no debug information available for \"src/base/low_level_alloc.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-malloc_extension.o\" - no debug information available for \"src/malloc_extension.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-malloc_hook.o\" - no debug information available for \"src/malloc_hook.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-maybe_threads.o\" - no debug information available for \"src/maybe_threads.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-memory_region_map.o\" - no debug information available for \"src/memory_region_map.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-page_heap.o\" - no debug information available for \"src/page_heap.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-raw_printer.o\" - no debug information available for \"src/raw_printer.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-sampler.o\" - no debug information available for \"src/sampler.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-span.o\" - no debug information available for \"src/span.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-stack_trace_table.o\" - no debug information available for \"src/stack_trace_table.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-static_vars.o\" - no debug information available for \"src/static_vars.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-symbolize.o\" - no debug information available for \"src/symbolize.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-system-alloc.o\" - no debug information available for \"src/system-alloc.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/libtcmalloc_internal_la-thread_cache.o\" - no debug information available for \"src/thread_cache.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/logging.o\" - no debug information available for \"src/base/logging.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/spinlock.o\" - no debug information available for \"src/base/spinlock.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/spinlock_internal.o\" - no debug information available for \"src/base/spinlock_internal.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/stacktrace.o\" - no debug information available for \"src/stacktrace.cc\".\r\n\r\n\r\nwarning: Could not find object file \"/Users/nilshomer/build/google-perftools-1.8.1/.libs/libtcmalloc.lax/libtcmalloc_internal.a/sysinfo.o\" - no debug information available for \"src/base/sysinfo.cc\".\r\n\r\n","timestamp":1312319562,"attachments":[]},{"id":5,"commenterId":1451955930852924383,"content":"Perhaps you need to set DYLD_LOAD_PATH?  What is the exact gdb command you ran, and from what directory did you run it?","timestamp":1312320494,"attachments":[]},{"id":6,"commenterId":-7509596770629132865,"content":"I resorted to modifying the source code instead.\r\n\r\nIn src/system-alloc.cc, the SbrkSysAllocator::Alloc function (line 225): \r\n  void* result \u003d sbrk(size)\r\nis returning NULL.  I then looked at the Mac OS X sbrk manual:http://developer.apple.com/library/mac/#documentation/Darwin/Reference/ManPages/man2/sbrk.2.html\r\n\r\nI added the following code to the if statement thereafter:\r\n      struct rlimit limit;\r\n      unsigned long qetext \u003d get_etext();\r\n      getrlimit(RLIMIT_DATA, \u0026limit);\r\nThe values for these are:\r\n limit.rlim_max\u003d9223372036854775807\r\n qetext\u003d4295370247\r\nThe size in bytes it is trying to allocate is \"784293888\".\r\n\r\nSo it looks like I have a infinite size for the data segment, so that leaves a lack of swap space (mentioned in the manual).  But Mac OS X dynamically adjusts the swap size, and my partition is \u003e1TB (free).\r\n","timestamp":1312321969,"attachments":[]},{"id":7,"commenterId":1451955930852924383,"content":"Hmm, I\u0027m not sure I followed all of that. :-}  Did you figure out what is wrong and how to fix it?  Is there a perftools issue in here somewhere?","timestamp":1312322159,"attachments":[]},{"id":8,"commenterId":-7509596770629132865,"content":"I am not sure why sbrk is returning NULL, and which causes SbrkSysAllocator::Alloc to return null, and then the \"src/system-alloc.cc:423] SbrkSysAllocator failed\" message.  The running of the program is decreased compared to a prior build and one without tcmalloc.","timestamp":1312323208,"attachments":[]},{"id":9,"commenterId":1451955930852924383,"content":"What about all the rlimit stuff?  Or did that turn out to be a dead-end?\r\n\r\nI don\u0027t know why sbrk is returning NULL either.  You can step into the sbrk call to make sure it\u0027s actually calling the one in OS X libc, and not some other version somewhere.  (We hook sbrk in malloc_hook, I think, but it should call through to the libc sbrk.  Maybe there\u0027s trouble there somehow?  Seems unlikely, but...)\r\n\r\nIf you have a debug version of OS X libc around, you could step into it and see why it\u0027s returning NULL.","timestamp":1312326211,"attachments":[]},{"id":10,"commenterId":-7509596770629132865,"content":"The rlimit stuff said that the data segment size was infinite, so sbrk is not returning null due to that.  It therefore implicates the swap file, but Mac OS X dynamically adjusts the swap size from my recollection.  There is enough memory for the process, so I am not sure what is going on.","timestamp":1312390306,"attachments":[]},{"id":11,"commenterId":-5418875898204089268,"content":"I\u0027m seeing the same error message on SLES10 Linux. Any idea why this is happening?","timestamp":1314738688,"attachments":[]},{"id":12,"commenterId":1451955930852924383,"content":"Are you trying to do huge allocations (like billions of bytes)?  That may cause sbrk to fail.  Otherwise, I don\u0027t know what might be causing the failure.  Hitting your rlimit?  Other memory pressure?","timestamp":1314739765,"attachments":[]},{"id":13,"commenterId":-7509596770629132865,"content":"I was not hitting the rlimit (as far as I could tell), but yes, I was allocating tens of gigabytes, and this is a regular occurrence.","timestamp":1314740067,"attachments":[]},{"id":14,"commenterId":1451955930852924383,"content":"You\u0027ll have to read your local man page on sbrk.  It may have a limit how much it can allocate at once.  We\u0027ll fall back to mmap, so the error should be harmless.  There\u0027s an environment variable you can set (see the tcmalloc docs) to suppress even trying to do sbrk allocations, if the error message is annoying.","timestamp":1314740971,"attachments":[]},{"id":15,"commenterId":-7509596770629132865,"content":"For those who want to reproduce, see \"git://github.com/nh13/TMAP.git\", compile the code, download \"ftp://ftp.sanger.ac.uk/pub/1000genomes/tk2/main_project_reference/human_g1k_v37.fasta.gz\", decompress it, and then run \"./tmap index -vf human_g1k_v37.fasta\".","timestamp":1318522180,"attachments":[]},{"id":16,"commenterId":7612890397192862352,"content":"I just saw the same error message when running a program with tcmalloc (1.8.3) on CentOS 5.7 (x86_64):\r\n\r\nsrc/system-alloc.cc:423] SbrkSysAllocator failed.\r\n\r\ngetrlimit for RLIMIT_DATA returns:\r\n\r\nsoft limit \u003d 18446744073709551615\r\nhard limit \u003d 18446744073709551615\r\n\r\nI\u0027ll try rolling back to google perftools 1.7 to see if it occurs in that version as well.\r\n","timestamp":1318653372,"attachments":[]},{"id":17,"commenterId":1451955930852924383,"content":"Right, the logging statement you\u0027re seeing is new in perftools 1.8.  It may be (is probably?) that the sbrk call is failing there too, you\u0027re just not seeing an error message.\r\n\r\nAny chance you can run through things with the debugger and seeing why the sbrk call is failing?","timestamp":1318870567,"attachments":[]},{"id":18,"commenterId":1451955930852924383,"content":"Maybe the return code from sbrk()?\r\n\r\nThis will probably be difficult to debug.  It\u0027s also not clear it\u0027s a problem: if sbrk fails, we just fall back to mmap.  Are you seeing any problems as a result of this message?","timestamp":1318875339,"attachments":[]},{"id":19,"commenterId":1451955930852924383,"content":"[This didn\u0027t make it back to the issue report for some reason, so I\u0027m pasting it in manually.]\r\n\r\nFrom: Doug Judd \u003cdoug@hypertable.com\u003e\r\nSubject: Re: Issue 359 in google-perftools: src/system-alloc.cc:423]\r\n SbrkSysAllocator failed\r\nTo: google-perftools@googlegroups.com\r\nDate: Mon, 17 Oct 2011 20:20:49 -0700\r\n\r\nRan it again and printed out errno and it was ENOMEM. Â It\u0027s very reproducible,\r\nso if you want me to try anything else, just let me know.","timestamp":1318969515,"attachments":[]},{"id":20,"commenterId":1451955930852924383,"content":"I have to assume that this is legitimate, and that your OS doesn\u0027t want to give you however much memory we\u0027re asking for.  I don\u0027t know how the OS decides it can satisfy an sbrk() request or not; you may have to look at the source to see.  (sbrk is actually a libc call, so the kernel code would be in the underlying brk call, I guess.)","timestamp":1318970202,"attachments":[]},{"id":21,"commenterId":7267818543782715545,"content":"Hi,\r\n\r\nLong time listener, first time caller.\r\n\r\nI\u0027m hitting warnings similar to those reported above:\r\n\r\n...\r\ntcmalloc: large alloc 18446744073709494272 bytes \u003d\u003d 0x0 @ \r\nsrc/system-alloc.cc:423] SbrkSysAllocator failed.\r\nsrc/system-alloc.cc:423] MmapSysAllocator failed.\r\n...\r\n\r\nwhen I run \"make check\" unit tests (after \"./configure \u0026\u0026 make\") on OS X 10.7.\r\n\r\nAdditionally, after those warnings the unit tests seem to go on forever allocating progressively huge chunks of memory:\r\n\r\n...\r\n\r\ntcmalloc: large alloc 11093934080 bytes \u003d\u003d 0x55775c06000 @ \r\ntcmalloc: large alloc 11104419840 bytes \u003d\u003d 0x55a0ba5e000 @ \r\ntcmalloc: large alloc 11114905600 bytes \u003d\u003d 0x55ca22b6000 @ \r\ntcmalloc: large alloc 11125391360 bytes \u003d\u003d 0x55f39512000 @ \r\n\r\n...\r\n\r\nI have no idea if the two issues are related, or if I can safely skip the unit tests.\r\n\r\nThanks,\r\n\r\nTJ","timestamp":1319146671,"attachments":[]},{"id":22,"commenterId":1451955930852924383,"content":"You\u0027d expect to see those warnings in the unittests -- we try to allocate more memory than sbrk can satisfy.\r\n\r\n} Additionally, after those warnings the unit tests seem to go on forever allocating\r\n} progressively huge chunks of memory:\r\n\r\nAre you sure they go on forever, and not just for a long time?  Try letting it run for 30 minutes or so and see what happens.","timestamp":1319228830,"attachments":[]},{"id":23,"commenterId":-5893580125349082467,"content":"I got the same error message in mysql error log:\r\n\r\ncentos 5.4\r\nmysql 5.1.59\r\ntcmalloc 1.8.3\r\n\r\n\r\n111205 17:40:16 mysqld_safe mysqld from pid file /data/mysql/mysql3306.pid ended\r\n111205 17:40:35 mysqld_safe Starting mysqld daemon with databases from /data/mysql/\r\nsrc/system-alloc.cc:423] SbrkSysAllocator failed.\r\n111205 17:40:35  InnoDB: Initializing buffer pool, size \u003d 8.0G\r\ntcmalloc: large alloc 8589959168 bytes \u003d\u003d 0x2aaacef44000 @\r\n111205 17:40:36  InnoDB: Completed initialization of buffer pool\r\n111205 17:40:36  InnoDB: Started; log sequence number 0 44233\r\n111205 17:40:36 [Note] Event Scheduler: Loaded 0 events\r\n111205 17:40:36 [Note] /usr/local/mysql/libexec/mysqld: ready for connections.","timestamp":1323080135,"attachments":[]},{"id":24,"commenterId":1451955930852924383,"content":"Looks like the messages are perhaps appropriate in this case: it seems that innodb is trying to allocate a large amount of memory, maybe more than sbrk can handle.\r\n\r\nI\u0027m wondering if logging this message does more harm than good.  It can help when a program fails mysteriously, but these messages can happen when programs are able to continue just fine, at which point they only scare people unnecessarily.","timestamp":1323106466,"attachments":[]},{"id":25,"commenterId":3087862206750992731,"content":"I\u0027m also getting this message on OS X when trying to upgrade Ruby Enterprise Edition to tcmalloc 1.9.1. The message occurs almost every time I run the Ruby interpreter. However other than printing a warning it doesn\u0027t seem to cause any problems. I also don\u0027t see any messages saying that MmapAllocator failed.","timestamp":1325253663,"attachments":[]}]}