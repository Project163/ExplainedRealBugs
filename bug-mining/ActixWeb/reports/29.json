{"url":"https://api.github.com/repos/actix/actix-web/issues/2678","repository_url":"https://api.github.com/repos/actix/actix-web","labels_url":"https://api.github.com/repos/actix/actix-web/issues/2678/labels{/name}","comments_url":"https://api.github.com/repos/actix/actix-web/issues/2678/comments","events_url":"https://api.github.com/repos/actix/actix-web/issues/2678/events","html_url":"https://github.com/actix/actix-web/issues/2678","id":1158613337,"node_id":"I_kwDOBkf28c5FDwlZ","number":2678,"title":"mishandling of keep-alive in pipelined requests causes panic in dispatcher","user":{"login":"ALSchwalm","id":1063999,"node_id":"MDQ6VXNlcjEwNjM5OTk=","avatar_url":"https://avatars.githubusercontent.com/u/1063999?v=4","gravatar_id":"","url":"https://api.github.com/users/ALSchwalm","html_url":"https://github.com/ALSchwalm","followers_url":"https://api.github.com/users/ALSchwalm/followers","following_url":"https://api.github.com/users/ALSchwalm/following{/other_user}","gists_url":"https://api.github.com/users/ALSchwalm/gists{/gist_id}","starred_url":"https://api.github.com/users/ALSchwalm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ALSchwalm/subscriptions","organizations_url":"https://api.github.com/users/ALSchwalm/orgs","repos_url":"https://api.github.com/users/ALSchwalm/repos","events_url":"https://api.github.com/users/ALSchwalm/events{/privacy}","received_events_url":"https://api.github.com/users/ALSchwalm/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":707286502,"node_id":"MDU6TGFiZWw3MDcyODY1MDI=","url":"https://api.github.com/repos/actix/actix-web/labels/C-bug","name":"C-bug","color":"ee0701","default":false,"description":"Category: bug"},{"id":1426756839,"node_id":"MDU6TGFiZWwxNDI2NzU2ODM5","url":"https://api.github.com/repos/actix/actix-web/labels/A-http","name":"A-http","color":"fff4af","default":false,"description":"project: actix-http"}],"state":"closed","locked":false,"assignee":{"login":"robjtede","id":3316789,"node_id":"MDQ6VXNlcjMzMTY3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/3316789?v=4","gravatar_id":"","url":"https://api.github.com/users/robjtede","html_url":"https://github.com/robjtede","followers_url":"https://api.github.com/users/robjtede/followers","following_url":"https://api.github.com/users/robjtede/following{/other_user}","gists_url":"https://api.github.com/users/robjtede/gists{/gist_id}","starred_url":"https://api.github.com/users/robjtede/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robjtede/subscriptions","organizations_url":"https://api.github.com/users/robjtede/orgs","repos_url":"https://api.github.com/users/robjtede/repos","events_url":"https://api.github.com/users/robjtede/events{/privacy}","received_events_url":"https://api.github.com/users/robjtede/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"robjtede","id":3316789,"node_id":"MDQ6VXNlcjMzMTY3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/3316789?v=4","gravatar_id":"","url":"https://api.github.com/users/robjtede","html_url":"https://github.com/robjtede","followers_url":"https://api.github.com/users/robjtede/followers","following_url":"https://api.github.com/users/robjtede/following{/other_user}","gists_url":"https://api.github.com/users/robjtede/gists{/gist_id}","starred_url":"https://api.github.com/users/robjtede/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robjtede/subscriptions","organizations_url":"https://api.github.com/users/robjtede/orgs","repos_url":"https://api.github.com/users/robjtede/repos","events_url":"https://api.github.com/users/robjtede/events{/privacy}","received_events_url":"https://api.github.com/users/robjtede/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":2,"created_at":"2022-03-03T16:19:01Z","updated_at":"2022-03-04T03:13:58Z","closed_at":"2022-03-04T03:12:49Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"\r\n## Expected Behavior\r\nWhen running a simple static file server via actix_files, clients should be able to pipeline requests within one TCP stream. \r\n\r\n## Current Behavior\r\nWhen a client sends a pipelined request, an actix thread panics:\r\n\r\n```\r\nthread 'actix-rt|system:0|arbiter:0' panicked at 'dispatcher should not be in keep-alive phase if state is not none: State::SendPayload { .. }', /home/adam/.cargo/registry/src/github.com-1ecc6299db9ec823/actix-http-3.0.0/src/h1/dispatcher.rs:929:13\r\n```\r\n\r\nA full backtrace is attached.\r\n\r\n## Possible Solution\r\n\r\nBy some basic testing, removing the debug_assert at https://github.com/actix/actix-web/blob/955c3ac0c4124f3807d0ac7be647668ea831cecc/actix-http/src/h1/dispatcher.rs#L929 seems to make things work as expected, but I don't know if that's a correct solution.\r\n\r\n## Steps to Reproduce (for bugs)\r\nRun a trivial static file server like:\r\n\r\n```\r\nuse actix_files::Files;\r\nuse actix_web::{App, HttpServer};\r\n\r\n#[actix_web::main]\r\nasync fn main() {\r\n\r\n    HttpServer::new(move || {\r\n        App::new().service(Files::new(\"/static\", \".\"))\r\n    })\r\n        .bind(\"localhost:8097\").unwrap()\r\n        .run()\r\n        .await.unwrap();\r\n}\r\n```\r\n\r\nAnd create a file 'example' like `echo contents > example` and start the server with `cargo run`.\r\n\r\nThen make the attached request via netcat: `nc localhost 8097 < request.txt`. This request is two GET requests:\r\n\r\n```\r\nGET /static/example HTTP/1.1\r\nGET /static/example HTTP/1.1\r\n```\r\n\r\nYou will get back a response like:\r\n\r\n```\r\nHTTP/1.1 200 OK\r\ncontent-length: 8\r\ncontent-disposition: attachment; filename=\"example\"\r\netag: \"12a112d:8:6220e692:1592e92e\"\r\ncontent-type: application/octet-stream\r\naccept-ranges: bytes\r\nlast-modified: Thu, 03 Mar 2022 16:02:26 GMT\r\ndate: Thu, 03 Mar 2022 16:07:01 GMT\r\n\r\ncontent\r\nHTTP/1.1 200 OK\r\ncontent-length: 8\r\ncontent-disposition: attachment; filename=\"example\"\r\netag: \"12a112d:8:6220e692:1592e92e\"\r\ncontent-type: application/octet-stream\r\naccept-ranges: bytes\r\nlast-modified: Thu, 03 Mar 2022 16:02:26 GMT\r\ndate: Thu, 03 Mar 2022 16:07:01 GMT\r\n```\r\n\r\nNote that in the final 200 OK, the body is never received, and the server will show the thread panic message.\r\n\r\n## Context\r\nMy company is using actix as part of a file server internally. Some tools like debian APT will attempt to pipeline requests under some circumstances and this bug causes commands like apt install to fail when connecting to the actix server.\r\n\r\n## Your Environment\r\n\r\n- rustc 1.56.1 (59eed8a2a 2021-11-01)\r\n- actix-web 4.0.1\r\n- actix-files 0.6.0\r\n[backtrace.txt](https://github.com/actix/actix-web/files/8179284/backtrace.txt)\r\n[request.txt](https://github.com/actix/actix-web/files/8179293/request.txt)\r\n\r\n","closed_by":{"login":"robjtede","id":3316789,"node_id":"MDQ6VXNlcjMzMTY3ODk=","avatar_url":"https://avatars.githubusercontent.com/u/3316789?v=4","gravatar_id":"","url":"https://api.github.com/users/robjtede","html_url":"https://github.com/robjtede","followers_url":"https://api.github.com/users/robjtede/followers","following_url":"https://api.github.com/users/robjtede/following{/other_user}","gists_url":"https://api.github.com/users/robjtede/gists{/gist_id}","starred_url":"https://api.github.com/users/robjtede/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robjtede/subscriptions","organizations_url":"https://api.github.com/users/robjtede/orgs","repos_url":"https://api.github.com/users/robjtede/repos","events_url":"https://api.github.com/users/robjtede/events{/privacy}","received_events_url":"https://api.github.com/users/robjtede/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/actix/actix-web/issues/2678/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/actix/actix-web/issues/2678/timeline","performed_via_github_app":null,"state_reason":"completed"}