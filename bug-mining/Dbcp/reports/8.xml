<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:46:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-116] [dbcp] transactionIsolation,  testOnBorrow and autoCommmit=false crashes for Oracle</title>
                <link>https://issues.apache.org/jira/browse/DBCP-116</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;I&apos;m using dbcp nightly build 20050626 (i.e. &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-20&quot; title=&quot;[DBCP] per-user pooling with Oracle driver and default isolation settings&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-20&quot;&gt;&lt;del&gt;COM-1666&lt;/del&gt;&lt;/a&gt; is fixed) to work with a&lt;br/&gt;
SharedPoolDataSource with an underlying oracle9i database and the 9.2.0.4 oracle&lt;br/&gt;
jdbc driver.&lt;br/&gt;
defaultTransactionIsolation is set to 8 (serializable), testOnBorrow is set to&lt;br/&gt;
true and defaultAutoCommit is set to false. (as an aside, with the oracle 10g&lt;br/&gt;
driver 10.1.0.4 the error also appears for defaultAutoCommit=true, but this is&lt;br/&gt;
an oracle problem) &lt;br/&gt;
I retrieve a connection, commit it, and close it. The first time works fine. The&lt;br/&gt;
second time while retrieving the connection, I get the ORA-01453: SET&lt;br/&gt;
TRANSACTION must be first statement of transaction error in the method&lt;br/&gt;
SharedPoolDataSource.setupDefaults upon execution of the line 215 :&lt;br/&gt;
con.setTransactionIsolation(defaultTransactionIsolation);&lt;br/&gt;
I have debugged the pool behaviour, extracted the jdbc commands and am able to&lt;br/&gt;
reproduce the behaviour with the following code:&lt;/p&gt;

&lt;p&gt;Connection connection = DriverManager.getConnection(sid, user, password);&lt;br/&gt;
connection.createStatement().execute(&quot;Select 1 from dual&quot;);&lt;br/&gt;
connection.setAutoCommit(false);&lt;br/&gt;
connection.setTransactionIsolation(&lt;br/&gt;
    Connection.TRANSACTION_SERIALIZABLE);&lt;br/&gt;
//connection.setReadOnly(false);  // not needed to get error&lt;br/&gt;
connection.commit();&lt;/p&gt;

&lt;p&gt;connection.createStatement().execute(&quot;Select 1 from dual&quot;);&lt;br/&gt;
// connection.rollback(); // this would solve the problem&lt;br/&gt;
                          // might be inserted into the validateObject()&lt;br/&gt;
                          // method of KeyedCPDSConnectionFactory&lt;br/&gt;
// connection.setAutoCommit(false); // not needed to get error&lt;br/&gt;
connection.setTransactionIsolation(&lt;br/&gt;
    Connection.TRANSACTION_SERIALIZABLE); // this causes the error&lt;/p&gt;

&lt;p&gt;I am not sure whether the rollback after the validation query fits into the&lt;br/&gt;
general philosophy of dbcp. Before I have come to use dbcp, I had programmed my&lt;br/&gt;
own pool and had done a rollback on every connection returned to the pool, in&lt;br/&gt;
order not to hand out a connection with a started transaction. In my opinion,&lt;br/&gt;
this is a good thing, but one might also argue against it because it eats&lt;br/&gt;
performance.&lt;/p&gt;

&lt;p&gt;Another solution would be to reverse the validation query /&lt;br/&gt;
setTransactionIsolation order, but it seems to me that this is very deep in the&lt;br/&gt;
pool architecture.&lt;/p&gt;

&lt;p&gt;Still another solution would be to reset autocommit to true when a connection is&lt;br/&gt;
returned into the pool, but personally I do not like this solution (it has no&lt;br/&gt;
additional merit like the rollback solution).&lt;/p&gt;</description>
                <environment>&lt;p&gt;Operating System: other&lt;br/&gt;
Platform: Other&lt;/p&gt;</environment>
        <key id="12342348">DBCP-116</key>
            <summary>[dbcp] transactionIsolation,  testOnBorrow and autoCommmit=false crashes for Oracle</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="fischer@seitenbau.de">Thomas Fischer</reporter>
                        <labels>
                    </labels>
                <created>Sun, 3 Jul 2005 08:13:26 +0000</created>
                <updated>Tue, 25 Mar 2008 08:11:32 +0000</updated>
                            <resolved>Mon, 18 Sep 2006 02:53:11 +0000</resolved>
                                    <version>Nightly Builds</version>
                                    <fixVersion>1.2.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12409719" author="fischer@seitenbau.de" created="Wed, 27 Jul 2005 18:05:34 +0000"  >&lt;p&gt;I would volunteer to patch and write a testcase for the bug. My idea would be to&lt;br/&gt;
add another configuration parameter, rollbackAfterValidation, which is set false&lt;br/&gt;
by default. If it is set true, it performs a rollback after every validation&lt;br/&gt;
query, which allows to set the connection to serializable afterwards.&lt;br/&gt;
I just would like to make sure that this general direction is ok for dbcp. Some&lt;br/&gt;
feedback would be nice.&lt;/p&gt;

&lt;p&gt;   Thanks,&lt;/p&gt;

&lt;p&gt;         Thomas&lt;/p&gt;</comment>
                            <comment id="12409720" author="fischer@seitenbau.de" created="Wed, 7 Sep 2005 23:30:32 +0000"  >&lt;p&gt;Created an attachment (id=16330)&lt;br/&gt;
testcase to show described behaviour&lt;/p&gt;

&lt;p&gt;The bug is produced in the test testRepeated. The other tests prove everything&lt;br/&gt;
else works as expected.&lt;br/&gt;
The classpatch must contain dbcp, its dependent libraries, and an oracle driver&lt;br/&gt;
jar(I used jdbc14.jar from oracle 9.2.0.6).&lt;br/&gt;
Somebody wanting to run the test must be able to connect to an oracle instance&lt;br/&gt;
(I used oracle 9.2.0.6). The system properties commons.dbcp.user,&lt;br/&gt;
commons.dbcp.password, and commons.dbcp.url must contain the connection info&lt;br/&gt;
for the oracle connection.&lt;/p&gt;</comment>
                            <comment id="12409721" author="fischer@seitenbau.de" created="Thu, 8 Sep 2005 00:29:33 +0000"  >&lt;p&gt;Created an attachment (id=16331)&lt;br/&gt;
proposed patch&lt;/p&gt;

&lt;p&gt;This patch resolves the problem using an additional configuration parameter,&lt;br/&gt;
rollbackAfterValidation. If set to true, dbcp issues a rollback after a&lt;br/&gt;
validation query is executed. The default is not to rollback, so backward&lt;br/&gt;
compatibility is assured. &lt;br/&gt;
The public API was only extended, no existing method signature was  modified.&lt;/p&gt;</comment>
                            <comment id="12409722" author="fischer@seitenbau.de" created="Thu, 8 Sep 2005 00:33:01 +0000"  >&lt;p&gt;Created an attachment (id=16332)&lt;br/&gt;
test case to ensure that the patch works&lt;/p&gt;

&lt;p&gt;This is a modification of the first test case. If run against the patched dbcp&lt;br/&gt;
version, no error should occur. The error can be reproduced by setting the&lt;br/&gt;
class variable ROLLBACK_AFTER_VALIDATION in the testcase to false.&lt;/p&gt;</comment>
                            <comment id="12435376" author="psteitz" created="Mon, 18 Sep 2006 02:53:11 +0000"  >&lt;p&gt;Patch applied.  Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12333608" name="ASF.LICENSE.NOT.GRANTED--TestSerializableOracleConnection.java" size="7889" author="fischer@seitenbau.de" created="Thu, 8 Sep 2005 00:33:01 +0000"/>
                            <attachment id="12333606" name="ASF.LICENSE.NOT.GRANTED--TestSerializableOracleConnection.java" size="6179" author="fischer@seitenbau.de" created="Wed, 7 Sep 2005 23:30:32 +0000"/>
                            <attachment id="12333607" name="ASF.LICENSE.NOT.GRANTED--patch_35591.txt" size="9138" author="fischer@seitenbau.de" created="Thu, 8 Sep 2005 00:29:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_10010" key="com.atlassian.jira.plugin.system.customfieldtypes:importid">
                        <customfieldname>Bugzilla Id</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35591</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>114399</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            19 years, 10 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0uxhr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>178567</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>