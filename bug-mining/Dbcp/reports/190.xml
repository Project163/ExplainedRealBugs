<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:49:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-585] Connection level JMX queries result in concurrent access to connection objects, causing errors</title>
                <link>https://issues.apache.org/jira/browse/DBCP-585</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;As we expose Connection objects over JMX, they may be accessed by multiple threads concurrently; &lt;br/&gt;
a) an application thread that borrows the Connection and uses it business as usual,&lt;br/&gt;
b) another thread simultaneously performing a JMX query, which in turn calls getters on the same connection object via the MBean interface.&lt;/p&gt;

&lt;p&gt;Also, calls to Connection object getters are mostly delegated to the underlying vendor-specific connection provided by the JDBC driver. For example, when we make the JMX query to get the &quot;schema&quot; attribute of the JMX connection object, this is translated into a &quot;java.sql.Connection.getSchema()&quot;, and passed to the vendor-specific Connection object by DBCP. In the case of Postgres, for example, this is further translated to a query &quot;select current_schema()&quot; and sent to the server.&lt;/p&gt;

&lt;p&gt;Hence, querying connections over JMX result in concurrent access by multiple threads to the underlying Connection provided by the vendors, to the point that these two threads may be running queries simultaneously on the same connection. &lt;/p&gt;

&lt;p&gt;However, this is not supported by any of the major database vendors. Vendor links on Connection objects not being threadsafe:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://jdbc.postgresql.org/documentation/head/thread.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Postgres&lt;/a&gt;
&lt;blockquote&gt;&lt;p&gt;The PostgreSQL&#8482; JDBC driver is not thread safe. The PostgreSQL server is not threaded. Each connection creates a new process on the server; as such any concurrent requests to the process would have to be serialized. The driver makes no guarantees that methods on connections are synchronized. It will be up to the caller to synchronize calls to the driver.&lt;/p&gt;&lt;/blockquote&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://docs.oracle.com/en/database/oracle/oracle-database/19/jjdbc/JDBC-coding-tips.html#GUID-EE479007-D105-4F82-8D51-000CBBD4BC77&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Oracle&lt;/a&gt;&#160;
&lt;blockquote&gt;&lt;p&gt;Oracle strongly discourages sharing a database connection among multiple threads. Avoid allowing multiple threads to access a connection simultaneously.&lt;/p&gt;&lt;/blockquote&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://www.javadoc.io/doc/com.microsoft.sqlserver/mssql-jdbc/latest/com.microsoft.sqlserver.jdbc/com/microsoft/sqlserver/jdbc/SQLServerConnection.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Microsoft SQL Server&lt;/a&gt;
&lt;blockquote&gt;&lt;p&gt;SQLServerConnection is not thread safe, however multiple statements created from a single connection can be processing simultaneously in concurrent threads.&lt;/p&gt;&lt;/blockquote&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Another interesting point to note, also to do justice to previous committers who have put this feature in place, is that this was not always the case. In the following links, you may see the same links to the older versions of the same pages. In the past, all vendors indicated that Connection is fully thread-safe; &lt;a href=&quot;https://www.postgresql.org/docs/7.1/jdbc-thread.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Postgres&lt;/a&gt;, &lt;a href=&quot;https://docs.oracle.com/cd/A97335_02/apps.102/a83724/tips1.htm&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Oracle&lt;/a&gt;, &lt;a href=&quot;https://www.javadoc.io/doc/com.microsoft.sqlserver/mssql-jdbc/6.1.0.jre7/com/microsoft/sqlserver/jdbc/SQLServerConnection.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;MSSQL Server&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;Hence, it was once safe to expose Connection objects via JMX given the thread-safety guarantees for the underlying vendor connection were in place. But as Vendors dropped the thread-safety guarantee one by one, it is not safe anymore, and may actually cause convoluted errors that pop up intermittently due to thread races in the JDBC driver code (see an example in the comments section below). Accordingly, exposing Connections via JMX shall be retired along with dropped support from most vendors. &lt;/p&gt;

&lt;p&gt;Note: the Datasource MBeans, which provide a vital set of metrics have no such problems as they don&apos;t depend on the underlying JDBC provider.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13437293">DBCP-585</key>
            <summary>Connection level JMX queries result in concurrent access to connection objects, causing errors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Kurtcebe Eroglu">Kurtcebe Eroglu</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 Apr 2022 16:45:18 +0000</created>
                <updated>Mon, 2 May 2022 22:48:50 +0000</updated>
                            <resolved>Mon, 2 May 2022 22:48:23 +0000</resolved>
                                    <version>2.9.0</version>
                                    <fixVersion>2.10.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="17516009" author="kurtcebe eroglu" created="Fri, 1 Apr 2022 16:45:47 +0000"  >&lt;p&gt;It&apos;s hard to consistently repro race conditions with test classes, but just to provide a sample of cases where concurrent access can actually break things, we may use the class below. We seem to be able to generate such an error almost 50% of the time with the example below.&lt;/p&gt;

&lt;p&gt;The class depends on commons-dbcp2 2.9.0 and Postgres JDBC driver 42.2.23. We simulate external JMX queries using &lt;a href=&quot;https://github.com/prometheus/jmx_exporter&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Prometheus JMX Exporter&lt;/a&gt; 0.16.1.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;download the dependencies and the javaagent&lt;/li&gt;
	&lt;li&gt;create a new file called &apos;jmx-exporter-config.yml&apos; in the same directory, with the following contents. This config will query and report all MBeans.
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;---
startDelaySeconds: 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;compile class with dependencies and run like below. Notice that we expose port 9099 for JMX queries over HTTP. Replace the JDBC connection string parameter as per your DB instance details.&lt;/li&gt;
	&lt;li&gt;after starting a program use a browser or Curl to send a get request to the port exposed by the agent using the address &quot;http://localhost:9099&quot;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java -cp postgresql-42.2.23.jar:commons-dbcp2-2.9.0.jar:commons-pool2-2.10.0.jar:commons-logging/1.2/commons-logging-1.2.jar:. -javaagent:jmx_prometheus_javaagent-0.16.1.jar=9099:jmx-exporter-config.yml TestBasicDataSource &quot;jdbc:postgresql://localhost:5432/testdb?user=testuser&amp;amp;password=testpass&amp;amp;ssl=false&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;~50% of the time, as soon as we browse &quot;http://localhost:9099&quot;, we can notice the following errors in the logs. If the error does not happen, stop and restart the test and try again.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Setting up data source.
Creating threads to use the datasource
waiting for error messages during JMX access...
org.postgresql.util.PSQLException: Cannot change transaction isolation level in the middle of a transaction.
	at org.postgresql.jdbc.PgConnection.setTransactionIsolation(PgConnection.java:940)
	at org.apache.commons.dbcp2.DelegatingConnection.setTransactionIsolation(DelegatingConnection.java:958)
	at org.apache.commons.dbcp2.DelegatingConnection.setTransactionIsolation(DelegatingConnection.java:958)
	at TestBasicDataSource$QueryTask.runOnce(TestBasicDataSource.java:54)
	at TestBasicDataSource$QueryTask.run(TestBasicDataSource.java:35)
	at java.lang.Thread.run(Thread.java:748)
Thread terminated on error
org.postgresql.util.PSQLException: Cannot change transaction isolation level in the middle of a transaction.
	at org.postgresql.jdbc.PgConnection.setTransactionIsolation(PgConnection.java:940)
	at org.apache.commons.dbcp2.DelegatingConnection.setTransactionIsolation(DelegatingConnection.java:958)
	at org.apache.commons.dbcp2.DelegatingConnection.setTransactionIsolation(DelegatingConnection.java:958)
	at TestBasicDataSource$QueryTask.runOnce(TestBasicDataSource.java:54)
	at TestBasicDataSource$QueryTask.run(TestBasicDataSource.java:35)
	at java.lang.Thread.run(Thread.java:748)
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Test class&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.sql.Connection;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.sql.ResultSet;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.sql.SQLException;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.sql.Statement;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; javax.sql.DataSource;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.dbcp2.BasicDataSource;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestBasicDataSource {
    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; DataSource dataSource;

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Setting up data source.&quot;&lt;/span&gt;);
        dataSource = setupDataSource(args[0]);

        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Creating threads to use the datasource&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 20; i ++){
            &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; QueryTask()).start();
        }
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; error messages during JMX access...&quot;&lt;/span&gt;);
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; DataSource setupDataSource(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; connectURI) {
        BasicDataSource ds = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BasicDataSource();
        ds.setJmxName(&lt;span class=&quot;code-quote&quot;&gt;&quot;com.example:name=BasicDataSource1&quot;&lt;/span&gt;);
        ds.setDriverClassName(&lt;span class=&quot;code-quote&quot;&gt;&quot;org.postgresql.Driver&quot;&lt;/span&gt;);
        ds.setUrl(connectURI);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ds;
    }

    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;QueryTask &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; {
        &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; runFlag = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;

        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (runFlag) {
                runOnce();
            }
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; terminated on error&quot;&lt;/span&gt;);
        }

        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void runOnce() {
            Connection conn = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            Statement stmt = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            ResultSet rset = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                conn = dataSource.getConnection();

                &lt;span class=&quot;code-comment&quot;&gt;// Following setTransactionIsolation call will fail &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we&apos;re already in an active transaction.
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// This happens intermittently, because the JMX thread sometimes read the stale value of &lt;span class=&quot;code-quote&quot;&gt;&quot;autoCommit&quot;&lt;/span&gt;
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// flag on the Postgres connection object, and send the &lt;span class=&quot;code-quote&quot;&gt;&quot;select current_schema()&quot;&lt;/span&gt; query with a preceding
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-quote&quot;&gt;&quot;begin&quot;&lt;/span&gt; statement, starting a transaction, which the connection pool and JDBC driver are not aware of
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// This never fails &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we don&apos;t perform any JMX access
&lt;/span&gt;                conn.setTransactionIsolation(Connection.TRANSACTION_READ_COMMITTED);
                conn.setAutoCommit(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);

                stmt = conn.createStatement();
                rset = stmt.executeQuery(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT CURRENT_TIME(3) ;&quot;&lt;/span&gt;);
                rset.next();
                rset.getString(1);

                conn.commit();
                conn.setAutoCommit(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;(SQLException e) {
                e.printStackTrace();
                runFlag = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
            } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; { &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (rset != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) rset.close(); } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;(Exception e) { }
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; { &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (stmt != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) stmt.close(); } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;(Exception e) { }
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; { &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (conn != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) conn.close(); } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;(Exception e) { }
            }
        }
    }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;My testing environment details:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;- Mac 2,6 GHz 6-Core Intel Core i7
- Darwin C02DG16JMD6V 19.6.0 Darwin Kernel Version 19.6.0: Tue Feb 15 21:39:11 PST 2022; root:xnu-6153.141.59~1/RELEASE_X86_64 x86_64
- OpenJDK Runtime Environment (AdoptOpenJDK)(build 1.8.0_292-b10)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17516283" author="garydgregory" created="Sat, 2 Apr 2022 12:28:30 +0000"  >&lt;p&gt;So this is fully dependent on the feature of a specific version of a specific JDBC Driver...&lt;/p&gt;

&lt;p&gt;&quot;Accordingly, exposing Connections via JMX shall be retired along with dropped support from most vendors.&quot;&lt;/p&gt;

&lt;p&gt;Well, no, that would break users for whom this actually works today. I suppose we could consider this if we break compatibility in this area for a possible 3.0 major release, whenever that would be, but not in the 2.x line.&lt;/p&gt;</comment>
                            <comment id="17516403" author="kurtcebe eroglu" created="Sat, 2 Apr 2022 22:19:11 +0000"  >&lt;p&gt;Thanks for your comment &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;It makes perfect sense to handle this with as little disruption as possible to existing users, and dropping an existing feature may indeed be a no go for a minor version.&lt;/p&gt;

&lt;p&gt;Would you agree that even if we don&apos;t have multiple examples (from different vendors and versions) at the moment, the existence of clear guidance from multiple major DB/ JDBC driver vendors, telling that their Connection objects are not thread-safe and shall not be accessed as such, may justify an optional config param for 2.x line? JMX instrumentation is already optional via &quot;jmxName&quot; parameter, but we&apos;d love to hang on to the DataSource MBeans, which are providing immense value on monitoring. For example, an additional config option &quot;registerConnectionMBean&quot;, &quot;true&quot; by default, hence completely transparent to existing users, may give users who have problems, or want to follow the guidance from their DB vendors a way to opt-out from Connection monitoring, only when this parameter is explicitly set to &quot;false&quot;?&#160;&lt;/p&gt;</comment>
                            <comment id="17516506" author="garydgregory" created="Sun, 3 Apr 2022 14:08:29 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Kurtcebe+Eroglu&quot; class=&quot;user-hover&quot; rel=&quot;Kurtcebe Eroglu&quot;&gt;Kurtcebe Eroglu&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;How would &quot;registerConnectionMBean&quot; be different from &lt;tt&gt;org.apache.commons.pool2.impl.BaseObjectPoolConfig.setJmxEnabled(boolean)&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="17516574" author="garydgregory" created="Sun, 3 Apr 2022 18:49:15 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Kurtcebe+Eroglu&quot; class=&quot;user-hover&quot; rel=&quot;Kurtcebe Eroglu&quot;&gt;Kurtcebe Eroglu&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Any patch should be submitted as a PR on GitHub, which will let GitHub automatically run builds and do all of the checks of the Maven default goal.&lt;/p&gt;</comment>
                            <comment id="17516575" author="kurtcebe eroglu" created="Sun, 3 Apr 2022 18:55:41 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;We register two different sets of information to JMX. Below are screenshots from JavaMissionControl for quick visualization.&lt;br/&gt;
When we configure the data source as&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        BasicDataSource ds = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BasicDataSource();
        ds.setJmxName(&lt;span class=&quot;code-quote&quot;&gt;&quot;com.example:name=BasicDataSource1&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;ol&gt;
	&lt;li&gt;The selected object in the screenshot is &quot;&lt;tt&gt;com.example:name=BasicDataSource1&lt;/tt&gt;&quot;.&lt;br/&gt;
It gives the datasource config and runtime metrics as can be seen above.&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13041964/13041964_ds_attrs.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;br/&gt;
We also register a subset of this data at &quot;&lt;tt&gt;com.example:connectionpool=connections,name=BasicDataSource1&lt;/tt&gt;&quot;&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13041965/13041965_connections_attrs.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;And we have the MBeans pointing to the connection object instances. These are registered at &lt;tt&gt;org.apache.commons.dbcp2.PoolableConnection&lt;/tt&gt;, as a part of the connection lifecycle. This is the problematic one as values are fetched from underlying vendor-specific connection objects (we extend &lt;tt&gt;DelegatingConnection&lt;/tt&gt;).&lt;br/&gt;
These are registered with the name &quot;&lt;tt&gt;com.example:connectionpool=connections,connection=X,name=BasicDataSource1&lt;/tt&gt;&quot;, where &quot;X&quot; changes with each new connection creation.&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13041966/13041966_conn_instance_attrs.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The first two sets of data are essential for monitoring, as it gives us both DataSource runtime config options, and metrics like connection pool size, idle and active connections etc. Setting &lt;tt&gt;setJmxEnabled(false)&lt;/tt&gt; would disable everything. However, we can hold on to the essential metrics and just drop out the connection instance metrics (to be honest, in my personal opinion, these are not adding too much value to monitoring anyways).&lt;/p&gt;

&lt;p&gt;Nothing changes with default settings, but if we set up the pool specifying the new flag like below, we end up disabling only the problematic part, and can still reach all the essential monitoring information (notice the connections disappear);&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        BasicDataSource ds = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BasicDataSource();
        ds.setJmxName(&lt;span class=&quot;code-quote&quot;&gt;&quot;com.example:name=BasicDataSource1&quot;&lt;/span&gt;);
        ds.setRegisterConnectionMBean(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13041967/13041967_final.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;br/&gt;
Below is the patch file (a quick one), for testing the above parameter.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;^0001-DBCP-585-idea-clarification.patch&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17516580" author="kurtcebe eroglu" created="Sun, 3 Apr 2022 19:43:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt; I noticed your last comment after I&apos;ve posted. I&apos;ve submitted a PR for your review.&lt;/p&gt;</comment>
                            <comment id="17516589" author="garydgregory" created="Sun, 3 Apr 2022 20:40:14 +0000"  >&lt;p&gt;Thank you the the patch!&lt;/p&gt;</comment>
                            <comment id="17516590" author="garydgregory" created="Sun, 3 Apr 2022 20:41:06 +0000"  >&lt;p&gt; &lt;a href=&quot;https://github.com/apache/commons-dbcp/pull/179&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-dbcp/pull/179&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="17520227" author="psteitz" created="Sun, 10 Apr 2022 22:04:28 +0000"  >&lt;p&gt;Nice analysis.&#160; The patch looks reasonable as a way to turn off the direct connection access.&#160; Trying to allow this safely is an interesting problem.&#160; The only ways that I can come up with risk performance impacts due to adding sync.&#160; The simplest way to do it would be to force clients to obtain a lock in DelegatingConnection.checkOpen (called by everything that actually uses a connection).&#160; The lock would not be contended much, but it would cost something.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17522336" author="garydgregory" created="Thu, 14 Apr 2022 14:17:39 +0000"  >&lt;p&gt;Hi&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=psteitz&quot; class=&quot;user-hover&quot; rel=&quot;psteitz&quot;&gt;psteitz&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Are you ok with merging this PR as it stands? Or are you saying that more work is needed?&lt;/p&gt;</comment>
                            <comment id="17526928" author="psteitz" created="Sat, 23 Apr 2022 21:08:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt; sorry I missed this.&#160; There is a small javadoc error in the patch (says &quot;sets t.&quot; when it means something else).&#160; There should also be some tests added to verify it is working as designed.&#160; But in general, yes, I am +1 on this.&lt;/p&gt;</comment>
                            <comment id="17526929" author="garydgregory" created="Sat, 23 Apr 2022 21:13:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Kurtcebe+Eroglu&quot; class=&quot;user-hover&quot; rel=&quot;Kurtcebe Eroglu&quot;&gt;Kurtcebe Eroglu&lt;/a&gt;&lt;br/&gt;
Please see Phil&apos;s previous comment, basically looks good but we need tests added to the PR.&lt;br/&gt;
TY!&lt;/p&gt;</comment>
                            <comment id="17530521" author="garydgregory" created="Sun, 1 May 2022 14:59:04 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=psteitz&quot; class=&quot;user-hover&quot; rel=&quot;psteitz&quot;&gt;psteitz&lt;/a&gt;&lt;br/&gt;
Do you think the PR&apos;s test is enough to validate the changes?&lt;/p&gt;</comment>
                            <comment id="17530947" author="psteitz" created="Mon, 2 May 2022 21:17:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;&#160; yes this looks good&lt;/p&gt;</comment>
                            <comment id="17530964" author="garydgregory" created="Mon, 2 May 2022 22:48:50 +0000"  >&lt;p&gt;PR merged to git master.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13041968" name="0001-DBCP-585-idea-clarification-1.patch" size="5375" author="Kurtcebe Eroglu" created="Sun, 3 Apr 2022 22:57:47 +0000"/>
                            <attachment id="13041966" name="conn_instance_attrs.png" size="91856" author="Kurtcebe Eroglu" created="Sun, 3 Apr 2022 18:47:35 +0000"/>
                            <attachment id="13041965" name="connections_attrs.png" size="224747" author="Kurtcebe Eroglu" created="Sun, 3 Apr 2022 18:46:41 +0000"/>
                            <attachment id="13041964" name="ds_attrs.png" size="246584" author="Kurtcebe Eroglu" created="Sun, 3 Apr 2022 18:46:26 +0000"/>
                            <attachment id="13041967" name="final.png" size="216301" author="Kurtcebe Eroglu" created="Sun, 3 Apr 2022 18:53:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 27 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z112i8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>