<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:48:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-442] All connections to MS SQL Server fail when SharedPoolDataSource has testOnBorrow set</title>
                <link>https://issues.apache.org/jira/browse/DBCP-442</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;When testOnBorrow is set on a SharedPoolDataSource with connections on MS SQL Server, the first (and all subsequent) connections retrieved from the pool get the exception in this stack trace as a result of executing Connection.isValid() in the validation on borrow.&lt;/p&gt;

&lt;p&gt;java -cp &quot;.;$CLASSPATH&quot; Dbcp2TestOnBorrowFailure &apos;jdbc:sqlserver://myserver.example.com;databasename=mydb&apos; myuser mypassword&lt;br/&gt;
Iteration: 0&lt;br/&gt;
PooledConnection was reused, withoutits previous Connection being closed.&lt;br/&gt;
java.sql.SQLException: PooledConnection was reused, withoutits previous Connection being closed.&lt;br/&gt;
        at org.apache.commons.dbcp2.cpdsadapter.PooledConnectionImpl.getConnection(PooledConnectionImpl.java:183)&lt;br/&gt;
        at org.apache.commons.dbcp2.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:951)&lt;br/&gt;
        at Dbcp2TestOnBorrowFailure.getConnection(Dbcp2TestOnBorrowFailure.java:30)&lt;br/&gt;
        at Dbcp2TestOnBorrowFailure.main(Dbcp2TestOnBorrowFailure.java:42)&lt;/p&gt;

&lt;p&gt;The code for this example is pasted in here (the preview shows that the code indentation and formatting is lost &amp;#8211; sorry):&lt;br/&gt;
----------------------------------------------------------------------&lt;br/&gt;
import java.sql.Connection;&lt;br/&gt;
import java.sql.Driver;&lt;br/&gt;
import java.sql.SQLException;&lt;br/&gt;
import java.util.Properties;&lt;/p&gt;

&lt;p&gt;import org.apache.commons.dbcp2.cpdsadapter.DriverAdapterCPDS;&lt;br/&gt;
import org.apache.commons.dbcp2.datasources.SharedPoolDataSource;&lt;/p&gt;

&lt;p&gt;public final class Dbcp2TestOnBorrowFailure {&lt;/p&gt;

&lt;p&gt;    private static final int MAX_CONNECTIONS = 3;&lt;/p&gt;

&lt;p&gt;    private final SharedPoolDataSource poolDataSource&lt;br/&gt;
        = new SharedPoolDataSource();&lt;/p&gt;

&lt;p&gt;    public Dbcp2TestOnBorrowFailure(String jdbcUrl) &lt;/p&gt;
{
        DriverAdapterCPDS cpds = new DriverAdapterCPDS();
        cpds.setUrl(jdbcUrl);

        poolDataSource.setConnectionPoolDataSource(cpds);
        poolDataSource.setMaxTotal(MAX_CONNECTIONS);
        poolDataSource.setMaxConnLifetimeMillis(300000);
        poolDataSource.setDefaultMaxWaitMillis(1000);
        poolDataSource.setDefaultAutoCommit(Boolean.TRUE);
        poolDataSource.setDefaultTestOnBorrow(true);
        poolDataSource.setValidationQueryTimeout(3000);
    }

&lt;p&gt;    public Connection getConnection(String user, String pwd) throws Exception &lt;/p&gt;
{
        return poolDataSource.getConnection(user, pwd);
    }

&lt;p&gt;    public static void main(String[] args) {&lt;br/&gt;
        if (args.length != 3) &lt;/p&gt;
{
            usage();
        }

&lt;p&gt;        Dbcp2TestOnBorrowFailure poolFailure = new Dbcp2TestOnBorrowFailure(args&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;);&lt;br/&gt;
        for (int i = 0; i &amp;lt; 10; ++i) {&lt;br/&gt;
            System.err.println(&quot;Iteration: &quot; + i);&lt;br/&gt;
            Connection conn = null;&lt;br/&gt;
            try &lt;/p&gt;
{
                conn = poolFailure.getConnection(args[1], args[2]);
                conn.close();
                conn = null;
            }
&lt;p&gt;            catch (Exception e) &lt;/p&gt;
{
                System.err.println(e.getMessage());
                e.printStackTrace(System.err);
                System.exit(88);
            }
&lt;p&gt;            finally {&lt;br/&gt;
                try {&lt;br/&gt;
                    if (conn != null) &lt;/p&gt;
{
                        conn.close();
                    }
&lt;p&gt;                } catch (SQLException e) {&lt;/p&gt;

&lt;p&gt;                }&lt;br/&gt;
            }&lt;br/&gt;
        }&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;    private static void usage() &lt;/p&gt;
{
        System.err.println(&quot;Usage: java -cp ... Dbcp2TestOnBorrowFailure jdbcUrl user password&quot;);
        System.exit(77);
    }
&lt;p&gt;}&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows 7, fully updated as of 2015-07-24, Cygwin, Oracle Java 1.8.0_40, DBCP 2.1, MS SQL Server driver sqljdbc42.jar&lt;/p&gt;</environment>
        <key id="12849052">DBCP-442</key>
            <summary>All connections to MS SQL Server fail when SharedPoolDataSource has testOnBorrow set</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jgreifwork">Jeff Greif (work)</reporter>
                        <labels>
                    </labels>
                <created>Sat, 25 Jul 2015 01:13:52 +0000</created>
                <updated>Fri, 7 Aug 2015 03:42:14 +0000</updated>
                            <resolved>Sun, 26 Jul 2015 01:24:08 +0000</resolved>
                                    <version>2.0.1</version>
                    <version>2.1</version>
                                    <fixVersion>2.1.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14641738" author="jgreifwork" created="Sat, 25 Jul 2015 17:52:00 +0000"  >&lt;p&gt;Same behavior for MySQL (driver mysql-connector-java-5.1.21-bin.jar).&lt;/p&gt;</comment>
                            <comment id="14641809" author="psteitz" created="Sun, 26 Jul 2015 00:30:58 +0000"  >&lt;p&gt;Thanks for reporting this.  Definitely a bug.  Requires a null validation query.  &lt;/p&gt;

&lt;p&gt;The problem is in KeyedCPDSConnectionFactory#validateObject.  If the validation query is null, the validation code just checks the connection; but unfortunately does not close the logical connection implicitly created by&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; valid = pconn.getConnection().isValid(timeout);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;.&lt;/p&gt;</comment>
                            <comment id="14641818" author="psteitz" created="Sun, 26 Jul 2015 01:24:08 +0000"  >&lt;p&gt;Fixed in r1692677.&lt;/p&gt;</comment>
                            <comment id="14641819" author="jgreifwork" created="Sun, 26 Jul 2015 01:30:44 +0000"  >&lt;p&gt;The same bug appears in CPDSConnectionFactory#validateObject, I think, as the code is nearly identical.  Two questions:&lt;/p&gt;

&lt;p&gt;1.  Is the fix just including the &apos;finally&apos; clause from elsewhere in he same method in the try/catch that has the problem?&lt;/p&gt;

&lt;p&gt;2.  Is there a scheduled date for a 2.2 release?&lt;/p&gt;
</comment>
                            <comment id="14641820" author="psteitz" created="Sun, 26 Jul 2015 01:40:47 +0000"  >&lt;p&gt;Good catch.  Yes, CPDSConnectionFactory#validateObject, has the same problem.&lt;/p&gt;

&lt;p&gt;1.  Yes, the fix makes the null validation query path do the same thing that the branch that executes a query does - close the logical connection in a finally block.  &lt;/p&gt;

&lt;p&gt;2.  Should be next couple of weeks and may actually be 2.1.1&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="14641995" author="psteitz" created="Sun, 26 Jul 2015 15:42:25 +0000"  >&lt;p&gt;Fix for CPDSConnectionFactory added in r1692727.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 16 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2hx8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>