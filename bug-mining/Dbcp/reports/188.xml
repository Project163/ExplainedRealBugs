<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:49:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-579] Performance of DelegatingConnection.prepareStatement(String) regressed enormously in 2.8.0 compared to 1.4</title>
                <link>https://issues.apache.org/jira/browse/DBCP-579</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;We recently upgraded the commons DBCP from version 1.4 to latest version 2.8.0. After the upgrade, we observed significant degradation in our use case. After the analysis it was found that the performance of&#160;DelegatingConnection.prepareStatement(String) is regressed in version 2.8.0&#160;enormously compared to 1.4 where the approx time taken in 2.8.0 is 7400 seconds compared to approx 183 sec in 1.4.&lt;/p&gt;

&lt;p&gt;Looking at the Yourkit snapshot, it is observed that the newly added call PoolingConnection.createKey(String) in the method PoolingConnection.prepareStatement(String) is the major contributor for this regression.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We took multiple snapshot and in all these snapshot we observed the regression. So it was not intermittent. Also, we observed this with both the our DBs (MS SQL server and PostgreSQL)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Please find attached the screenshot of YourKit Snapshot showing the Merged Callees of DelegatingConnection.prepareStatement(String) taken for MS SQL server with commons DBCP version 1.4 and version 2.8 for further details.&lt;/p&gt;</description>
                <environment>&lt;p&gt;OS: Windows Server 2008 R2 Enterprise&#160;&lt;/p&gt;

&lt;p&gt;Java: Open JDK 12.0.1&lt;/p&gt;

&lt;p&gt;DB:&#160;Microsoft SQL Server 2012 - 11.0.5058.0 (X64)&lt;/p&gt;</environment>
        <key id="13386495">DBCP-579</key>
            <summary>Performance of DelegatingConnection.prepareStatement(String) regressed enormously in 2.8.0 compared to 1.4</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="sjhala">Shaktisinh Jhala</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Jun 2021 10:27:17 +0000</created>
                <updated>Wed, 27 Oct 2021 06:53:13 +0000</updated>
                            <resolved>Wed, 27 Oct 2021 06:53:13 +0000</resolved>
                                    <version>2.8.0</version>
                                    <fixVersion>2.9.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17375915" author="garydgregory" created="Tue, 6 Jul 2021 18:03:52 +0000"  >&lt;p&gt;Thank you for you report.&lt;/p&gt;

&lt;p&gt;It seems we can cache data like the catalog and schema like we do the auto-commit value. I will look tonight after work.&lt;/p&gt;</comment>
                            <comment id="17376609" author="garydgregory" created="Wed, 7 Jul 2021 14:39:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sjhala&quot; class=&quot;user-hover&quot; rel=&quot;sjhala&quot;&gt;sjhala&lt;/a&gt;&lt;br/&gt;
 May you please try git master or a SNAPSHOT build from &lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/org/apache/commons/commons-dbcp2/2.9.0-SNAPSHOT/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/org/apache/commons/commons-dbcp2/2.9.0-SNAPSHOT/&lt;/a&gt; and report back the difference you see in your use case as the schema name and catalog name is now cached. See changes.xml for details.&lt;/p&gt;</comment>
                            <comment id="17377205" author="sjhala" created="Thu, 8 Jul 2021 08:31:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;&#160;thanks for quick turn around.&lt;/p&gt;

&lt;p&gt;I checked with the guy who manages our performance setups where we had executed runs earlier. Currently some runs are going on on that setup the setup would be free in a day or two. Will revert back to you early next week if not over the weekend.&lt;/p&gt;</comment>
                            <comment id="17378013" author="sjhala" created="Fri, 9 Jul 2021 11:25:08 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;&#160;took the&#160;&lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/org/apache/commons/commons-dbcp2/2.9.0-SNAPSHOT/commons-dbcp2-2.9.0-20210707.143825-1.jar&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commons-dbcp2-2.9.0-20210707.143825-1.jar&lt;/a&gt;&#160;from the link you provided above and run the tests. However, we did not observed any improvement. When opened the jar file, i noticed that all classes were having the time stamp of 22-Jan-2020. I was expecting it to be of Jul 2021. I double check that i downloaded the jar of correct version and it was 2.9.0 which is correct.&lt;/p&gt;

&lt;p&gt;I executed one more run with profiling enabled. I can still see that&#160;PoolingConnection.createKey(String) is still the culprit. Please find the screen shot of yourkit snapshot attached here with name WithPrivateJarFrom2.9.0.jpg.&lt;/p&gt;</comment>
                            <comment id="17378031" author="garydgregory" created="Fri, 9 Jul 2021 12:10:54 +0000"  >&lt;p&gt;Hi&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sjhala&quot; class=&quot;user-hover&quot; rel=&quot;sjhala&quot;&gt;sjhala&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thank you for your update.&lt;/p&gt;

&lt;p&gt;I can&apos;t explain the class file timestamps oddity within the jar. I just built and deployed another SNAPSHOT jar to the snapshot repository and that jar&apos;s class files also have the odd timestamps.&lt;/p&gt;

&lt;p&gt;The next step is to debug your application from connection pool creation and make sure caching gets propagated all the way down to the &lt;tt&gt;org.apache.commons.dbcp2.DelegatingConnection.cacheState&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;With caching enabled, which it should be by default in &lt;tt&gt;org.apache.commons.dbcp2.BasicDataSource.cacheState&lt;/tt&gt;, I would expect &lt;tt&gt;org.apache.commons.dbcp2.DelegatingConnection.getSchema()&lt;/tt&gt; to call &lt;tt&gt;org.apache.commons.dbcp2.Jdbc41Bridge.getSchema(Connection)&lt;/tt&gt; only once for a given &lt;tt&gt;DelegatingConnection&lt;/tt&gt; instance. That one call could take a while and still show up in your measurements but it should only happen once per instance.&lt;/p&gt;

&lt;p&gt;It is possible that your specific configuration does not use caching at the level of&#160;&lt;tt&gt;DelegatingConnection&lt;/tt&gt; somehow. That, or, caching is enabled but still shows up in the measurements because of the way the application makes use of pools.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17378236" author="sjhala" created="Fri, 9 Jul 2021 18:33:12 +0000"  >&lt;p&gt;Hi&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;. Thanks for the details.&lt;/p&gt;

&lt;p&gt;Yes, I can see that while creating the PoolableConnectionFactory in BasicDataSource.createPoolableConnectionFactory, it sets the cacheState to the newly created instance of&#160;PoolableConnectionFactory with its own instance member&#160;cacheState which is initialized with value true so it is expected to cache by default.&#160;&lt;/p&gt;

&lt;p&gt;I can see you have added&#160;cachedSchema member variable in DelegatingConnection class and it is being set in getSchema as well setSchema. So next time when getSchema is called on same instance of DelegatingConnection, it will return back the cachedSchema.&lt;/p&gt;

&lt;p&gt;I will run the test with CPU profiling enabled with callCounting to see how many times the actual implementation&#160;Jdbc41Bridge.getSchema is being called.&lt;/p&gt;

&lt;p&gt;BTW, i could not understand your point &quot;That, or, caching is enabled but still shows up in the measurements because of the way the application makes use of pools.&quot; We have simply configured BasicDatasource in our spring context xml file. Can you pl elaborate on this please.&lt;/p&gt;</comment>
                            <comment id="17379869" author="sjhala" created="Tue, 13 Jul 2021 12:55:26 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;&#160;as discussed above, i executed our tests and captured the your kit snapshot with call counting enabled and i noticed that it was indeed calling&#160;Jdbc41Bridge.getSchema which it should not. Then i captured the heapdump to see what value is set for&#160;cachedSchema&#160; and&#160;cacheState. And i noticed that the&#160;cacheState&#160; was set to true as expected however, i could not find the variable cachedSchema defined at all. Which was bit weird. After some further analysis i understood that the jar file i replaced is not being picked up at run time. So after make necessary change, i got the performance number which we had with DBCP version 1.4&lt;/p&gt;

&lt;p&gt;So we are good to close this issue with the code change you made in shared private jar file.&lt;/p&gt;

&lt;p&gt;Thanks for your quick turn around.&lt;/p&gt;</comment>
                            <comment id="17379872" author="sjhala" created="Tue, 13 Jul 2021 12:56:30 +0000"  >&lt;p&gt;Can you share tentative release date of DBCP 2.9.0? so that we can consume 2.9.0 along with your code change?&lt;/p&gt;</comment>
                            <comment id="17380043" author="garydgregory" created="Tue, 13 Jul 2021 16:57:31 +0000"  >&lt;p&gt;There is no fixed released date set yet, we are all volunteers here. My guess is within a month as I want to release a couple of other components before this one.&lt;/p&gt;</comment>
                            <comment id="17380052" author="sjhala" created="Tue, 13 Jul 2021 17:13:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;,&#160;I absolutely agree that you all are volunteers and we are really thankful for your contributions. My intention for asking the tentative release date was not to push for it but knowing it can help us to plan related things accordingly. Thank you!!&lt;/p&gt;</comment>
                            <comment id="17391062" author="garydgregory" created="Sat, 31 Jul 2021 21:57:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sjhala&quot; class=&quot;user-hover&quot; rel=&quot;sjhala&quot;&gt;sjhala&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;FYI, a release candidate for 2.9.0 is up for review, please see the developer mailing list for details.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17391122" author="sjhala" created="Sun, 1 Aug 2021 09:36:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;&#160;Thanks for the info.&lt;/p&gt;</comment>
                            <comment id="17434564" author="garydgregory" created="Tue, 26 Oct 2021 20:57:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sjhala&quot; class=&quot;user-hover&quot; rel=&quot;sjhala&quot;&gt;sjhala&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We released 2.9.0 a while back. Do you have an update for us?&lt;/p&gt;</comment>
                            <comment id="17434665" author="sjhala" created="Wed, 27 Oct 2021 05:16:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;&#160;We consumed the latest release 2.9.0 and we observed the issue is resolved. Good to close the Jira. Thanks for the support!!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13027392" name="DBCP_v1.4.jpg" size="633217" author="sjhala" created="Tue, 29 Jun 2021 10:35:35 +0000"/>
                            <attachment id="13027393" name="DBCP_v2.8.0.jpg" size="662764" author="sjhala" created="Tue, 29 Jun 2021 10:37:06 +0000"/>
                            <attachment id="13030346" name="WithPrivateJarFrom2.9.0.jpg" size="375896" author="sjhala" created="Fri, 9 Jul 2021 11:20:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 2 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0seqw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>