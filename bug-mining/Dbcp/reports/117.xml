<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:48:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-412] dbcp2.PoolableConnection.close raises NullPointerException</title>
                <link>https://issues.apache.org/jira/browse/DBCP-412</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;I found a critical error while closing a PoolableConnection.&lt;br/&gt;
Here&apos;s the code to reproduce the bug (largely copied from the example shown in the Apache DBCP site):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;PoolingDataSourceExample2.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable {
    &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-quote&quot;&gt;&quot;com.microsoft.sqlserver.jdbc.SQLServerDriver&quot;&lt;/span&gt;);
    DataSource dataSource = setupDataSource(jdbcUrl);

    Connection connection = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    PreparedStatement statement = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    ResultSet result = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;

    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        connection = dataSource.getConnection();
        statement = connection.prepareStatement(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT 1&quot;&lt;/span&gt;);
        result = statement.executeQuery();
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
        result.close();
        statement.close();
        connection.close();
    }
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; DataSource setupDataSource(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; connectURI) {
    ConnectionFactory connectionFactory = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DriverManagerConnectionFactory(connectURI, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
    PoolableConnectionFactory poolableConnectionFactory = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PoolableConnectionFactory(connectionFactory, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
    ObjectPool&amp;lt;PoolableConnection&amp;gt; connectionPool = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GenericObjectPool&amp;lt;&amp;gt;(poolableConnectionFactory);
    PoolingDataSource&amp;lt;PoolableConnection&amp;gt; dataSource = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PoolingDataSource&amp;lt;&amp;gt;(connectionPool);

    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; dataSource;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When the code tries to close the connection (in the final block), an exception is raised:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;PoolingDataSourceExample2.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.NullPointerException
	at org.apache.commons.dbcp2.PoolableConnection.close(PoolableConnection.java:151)
	at org.apache.commons.dbcp2.DelegatingConnection.closeInternal(DelegatingConnection.java:235)
	at org.apache.commons.dbcp2.DelegatingConnection.close(DelegatingConnection.java:218)
	at org.apache.commons.dbcp2.PoolingDataSource$PoolGuardConnectionWrapper.close(PoolingDataSource.java:212)
	at dbcp.PoolingDataSourceExample2.closeQuietly(PoolingDataSourceExample2.java:64)
	at dbcp.PoolingDataSourceExample2.main(PoolingDataSourceExample2.java:43)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As I can see, the problem is the &quot;_pool&quot; variable inside PoolableConnection but I could not find any solution.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Mac OSX, Java 7, SQLAzure&lt;/p&gt;</environment>
        <key id="12706393">DBCP-412</key>
            <summary>dbcp2.PoolableConnection.close raises NullPointerException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="DavideCaroselli">Davide Caroselli</reporter>
                        <labels>
                            <label>NullPointerException</label>
                            <label>PoolableConnection</label>
                    </labels>
                <created>Thu, 3 Apr 2014 10:10:22 +0000</created>
                <updated>Tue, 24 Feb 2015 03:23:06 +0000</updated>
                            <resolved>Sat, 14 Feb 2015 00:04:56 +0000</resolved>
                                    <version>2.0</version>
                                    <fixVersion>2.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13959040" author="psteitz" created="Thu, 3 Apr 2014 18:01:03 +0000"  >&lt;p&gt;The problem is in the example code.  In version 2, the PoolableConnectionFactory constructor no longer takes the parent pool as a parameter.  To correctly set up the pool manually, we need to set the pool property of the PoolableConnectionFactory using its setPool method.  So above we need to add&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; poolableConnectionFactory.setPool(connectionPool) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We should fix this in the example and add unit tests confirming that the examples work.  Patches welcome.&lt;/p&gt;</comment>
                            <comment id="13959087" author="psteitz" created="Thu, 3 Apr 2014 18:59:54 +0000"  >&lt;p&gt;It might also a good idea to have the PoolingDataSource constructor check that its pool&apos;s factory refers back to itself.&lt;/p&gt;</comment>
                            <comment id="13959716" author="davidecaroselli" created="Fri, 4 Apr 2014 07:31:43 +0000"  >&lt;p&gt;Ok, I&apos;ve modified the code but I found another issue (maybe). This is the example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;PoolingDataSourceExample2.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable {
    &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-quote&quot;&gt;&quot;com.microsoft.sqlserver.jdbc.SQLServerDriver&quot;&lt;/span&gt;);
    DataSource dataSource = setupDataSource(jdbcUrl);

    Connection connection = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    PreparedStatement statement = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    ResultSet result = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;

    &lt;span class=&quot;code-comment&quot;&gt;// = EDITED ==============
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 100; i++)
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            connection = dataSource.getConnection();
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(connection.hashCode());
            statement = connection.prepareStatement(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT 1&quot;&lt;/span&gt;);
            result = statement.executeQuery();
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            result.close();
            statement.close();
            connection.close();
        }
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; DataSource setupDataSource(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; connectURI) {
    ConnectionFactory connectionFactory = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DriverManagerConnectionFactory(connectURI, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
    PoolableConnectionFactory poolableConnectionFactory = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PoolableConnectionFactory(connectionFactory, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
    ObjectPool&amp;lt;PoolableConnection&amp;gt; connectionPool = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GenericObjectPool&amp;lt;&amp;gt;(poolableConnectionFactory);

    &lt;span class=&quot;code-comment&quot;&gt;// = EDITED ==============
&lt;/span&gt;    connectionPool.setMaxTotal(1);
    poolableConnectionFactory.setPool(connectionPool);

    PoolingDataSource&amp;lt;PoolableConnection&amp;gt; dataSource = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PoolingDataSource&amp;lt;&amp;gt;(connectionPool);
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; dataSource;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now the code does not throw exceptions anymore, but it returns always a new connection.&lt;br/&gt;
I request 100 times, but every time the connection hashcode is different; I&apos;ve made a similar example but with DBCP v1.4 over Common Pool 1.6 and with these jars the hashcode is always the same.&lt;/p&gt;

&lt;p&gt;Is this normal or does it really create new connection anytime?&lt;/p&gt;</comment>
                            <comment id="13959971" author="psteitz" created="Fri, 4 Apr 2014 13:49:46 +0000"  >&lt;p&gt;The difference in behavior is likely due to the changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-358&quot; title=&quot;Equals implementations in DelegatingXxx classes are not symmetric&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-358&quot;&gt;&lt;del&gt;DBCP-358&lt;/del&gt;&lt;/a&gt;.  The hashcodes you are examining are those of the DelegatingConnection instances returned by PoolingDataSource.  As of 2.0, DelegatingConnection instances wrapping the same underlying physical connection are not equal.  If you have a way to see the physical connections in the database, you should be able to verify that there is just one being used by the code (else there is a bug here).&lt;/p&gt;</comment>
                            <comment id="13960176" author="davidecaroselli" created="Fri, 4 Apr 2014 17:41:32 +0000"  >&lt;p&gt;Ok I&apos;ve made a test as you suggested and you&apos;re right! Although the connection wrapper is different everytime, the open connections db-side are exactly equals to the value set by setMaxTotal. Great, thanks!&lt;/p&gt;</comment>
                            <comment id="13960959" author="psteitz" created="Sat, 5 Apr 2014 04:20:47 +0000"  >&lt;p&gt;Sample code in PoolingDataSourceExample fixed in r1584958.&lt;/p&gt;

&lt;p&gt;Still to do:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Update other examples (incl header comments)&lt;/li&gt;
	&lt;li&gt;Add unit tests to verify examples work - for this example, either TesterDriver has to modified to handle uid/pwd in URL or example has to set props&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13975206" author="psteitz" created="Sun, 20 Apr 2014 17:59:33 +0000"  >&lt;p&gt;Thinking about this some more, I think it would be a good idea to have the PoolingDataSource constructor check and if necessary fix the factory-pool linkage.  Attached patch does this.  Comments / better ideas welcome.&lt;/p&gt;</comment>
                            <comment id="13988428" author="psteitz" created="Fri, 2 May 2014 23:34:09 +0000"  >&lt;p&gt;PDS constructor check added in r1592119&lt;/p&gt;</comment>
                            <comment id="14098378" author="mutex7c" created="Fri, 15 Aug 2014 09:19:42 +0000"  >&lt;p&gt;The same problem still exists in the examples for the pooling driver. Adding &lt;/p&gt;

&lt;p&gt;poolableConnectionFactory.setPool(connectionPool) &lt;/p&gt;

&lt;p&gt;solves the problem here, too.&lt;/p&gt;</comment>
                            <comment id="14098664" author="psteitz" created="Fri, 15 Aug 2014 15:17:28 +0000"  >&lt;p&gt;Thanks for pointing out the inconsistency in current code in the examples, Sebastien.  The check added in r1592119 makes it unnecessary to add the setPool (once this code is released).  Reopening as we should make the examples consistent.  I think we should add the setPool calls for now as current released code requires them.  Will get to this ASAP unless someone beats me to it. &lt;/p&gt;</comment>
                            <comment id="14321014" author="psteitz" created="Sat, 14 Feb 2015 00:04:56 +0000"  >&lt;p&gt;Fixed examples in r1659726.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12640994" name="DBCP-412.patch" size="2680" author="psteitz" created="Sun, 20 Apr 2014 17:59:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>384716</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 40 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1u9zr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>384983</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>