<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:47:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-8] [dbcp][PATCH] Handle changed passwords in SharedPoolDataSource</title>
                <link>https://issues.apache.org/jira/browse/DBCP-8</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;Problem Summary:&lt;br/&gt;
Currently, DBCP does not provide support for dealing with password changes when&lt;br/&gt;
using InstanceKeyDataSources.  This means that when using a concrete&lt;br/&gt;
implementation of InstanceKeyDataSource, such as SharedPoolDataSource or&lt;br/&gt;
PerUserPoolDataSource, if a user changes his/her password, the entire connection&lt;br/&gt;
pool must be restarted for DBCP to recognize the new password.  In the event the&lt;br/&gt;
connection pool is being managed by a container, such as Tomcat, it requires&lt;br/&gt;
restarting the container.  Users have previously requested an ability to handle&lt;br/&gt;
these situations (see&lt;br/&gt;
&lt;a href=&quot;http://mail-archives.eu.apache.org/mod_mbox/jakarta-commons-user/200405.mbox/%3C40B5F9DC.1080101@pandora.be%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.eu.apache.org/mod_mbox/jakarta-commons-user/200405.mbox/%3C40B5F9DC.1080101@pandora.be%3E&lt;/a&gt;&lt;br/&gt;
and&lt;br/&gt;
&lt;a href=&quot;http://mail-archives.eu.apache.org/mod_mbox/jakarta-commons-user/200405.mbox/%3c40ACA3DE.8080302@pandora.be%3e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.eu.apache.org/mod_mbox/jakarta-commons-user/200405.mbox/%3c40ACA3DE.8080302@pandora.be%3e&lt;/a&gt;&lt;br/&gt;
for examples).&lt;/p&gt;

&lt;p&gt;Proposed Patch:&lt;/p&gt;

&lt;p&gt;The attached patch provides support for using the SharedPoolDataSource in&lt;br/&gt;
situations where user passwords may be changed.  Support is provided by changing&lt;br/&gt;
UserPassKey and SharedPoolDataSource to use the concatenation of the username&lt;br/&gt;
and password as the key.  In this way, after a user changes password, a&lt;br/&gt;
getConnection(String, String) method call will cause the pool to create a new&lt;br/&gt;
Connection using the new username and password.  The Connection that was created&lt;br/&gt;
using the old username and password remains in the pool, where--assuming the&lt;br/&gt;
pool is set up to remove idle objects--it will be collected by the idle object&lt;br/&gt;
eviction thread or eventually (once the pool is full) be discarded according to&lt;br/&gt;
the LRU algorithm provided by the pool.&lt;/p&gt;

&lt;p&gt;Other Solutions Considered:&lt;/p&gt;

&lt;p&gt;In making this patch, I considered several other possible algorithms but chose&lt;br/&gt;
the implemented algorithm as the best combination of safety and ease of use. &lt;br/&gt;
And-&lt;del&gt;as a bonus&lt;/del&gt;-it is a very unobtrusive solution. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The &quot;public void close(String name)&quot; method recommended by Dirk Verbeeck in&lt;br/&gt;
the first link above is relatively complex to implement in the case of a&lt;br/&gt;
SharedPoolDataSource (but would be much easier for a PerUserPoolDataSource, as&lt;br/&gt;
he suggested).  In the case of a SharedPoolDataSource, it&apos;s possible that&lt;br/&gt;
multiple Connections exist for the specified user, in which case&lt;br/&gt;
SharedPoolDataSource would have to provide logic to deal with the cases where&lt;br/&gt;
one or more existing connections for the user are checked out at the time the&lt;br/&gt;
method is called--not to mention the logic required to find all existing&lt;br/&gt;
connections and close them without needlessly opening new connections (since all&lt;br/&gt;
users share the same pool in a SharedPoolDataSource instead of having a pool per&lt;br/&gt;
user as in PerUserPoolDataSource).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Adding a method &quot;public void getConnection(String username, String password,&lt;br/&gt;
boolean closeAndReconnectOnPasswordMismatch)&quot; has similar problems with the&lt;br/&gt;
possibility of the existence of multiple open connections for the given&lt;br/&gt;
username.  If only the current connection is closed, we may be leaving&lt;br/&gt;
connections that are associated with the old password in the pool; therefore,&lt;br/&gt;
the application would need to use the closeAndReconnect functionality in&lt;br/&gt;
most-&lt;del&gt;if not all&lt;/del&gt;-cases where a connection is required.  If all connections are&lt;br/&gt;
closed, we have the same situation described above.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Furthermore, neither of the above methods is a part of the DataSource interface;&lt;br/&gt;
and, therefore, both would require the application to downcast to the&lt;br/&gt;
appropriate DBCP type to make the method call.  For all practical purposes, this&lt;br/&gt;
negates the benefits of using an interface in the first place.&lt;/p&gt;

&lt;p&gt;Additionally, adding new methods as above requires the application to know when&lt;br/&gt;
the user has changed his/her password, and provides a potential failure mode&lt;br/&gt;
when the user changes his/her password through an external application (i.e.&lt;br/&gt;
directly on the database or using some other application).  Although it is&lt;br/&gt;
possible for the application to catch the plain-vanilla SQLException thrown by&lt;br/&gt;
the getConnection(String, String) method of InstanceKeyDataSource and parse the&lt;br/&gt;
exception message looking for the expected text (&quot;Given password did not match&lt;br/&gt;
password used to create the PooledConnection.&quot;), doing so is not at all an&lt;br/&gt;
elegant solution.  Even if a new PasswordChangedException (which extends&lt;br/&gt;
SQLException) were created, the application would then need to downcast the&lt;br/&gt;
DataSource to make the appropriate call, so the previously mentioned problems&lt;br/&gt;
with the solution apply.&lt;/p&gt;

&lt;p&gt;Also, both of the new methods allow a Denial-of-Service-type attack against the&lt;br/&gt;
connection pool wherein a user may prevent the connection pool from reusing&lt;br/&gt;
connections by forcing it to close connections and attempt a reconnect when&lt;br/&gt;
given an incorrect password.  Depending on the application design, this weakness&lt;br/&gt;
could be exploited from a login page, knowing only valid usernames.  The&lt;br/&gt;
proposed solution does not suffer from this problem as the existing connections&lt;br/&gt;
are kept, so a user requesting a connection with a bad password would simply&lt;br/&gt;
cause DBCP to attempt to make a connection that the database would refuse&lt;br/&gt;
because of an invalid password.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Checking the given password in the getPooledConnectionAndInfo( ) method and,&lt;br/&gt;
if different from the originally given password, attempting to connect to the&lt;br/&gt;
database with the new username/password combination and changing the password&lt;br/&gt;
associated with the UserPassKey after a successful connection would also work,&lt;br/&gt;
but requires duplicating the password check done by the InstanceKeyDataSource in&lt;br/&gt;
subclasses wanting to support use after password changes (or removing the check&lt;br/&gt;
from InstanceKeyDataSource and requiring subclasses to handle the situation&lt;br/&gt;
appropriately).  Furthermore, since database behavior regarding usability of&lt;br/&gt;
Connections after a password change is database-dependent, we cannot be sure&lt;br/&gt;
that the existing connections-&lt;del&gt;which were created with the old password&lt;/del&gt;-are&lt;br/&gt;
still valid, so this approach would require users to run a validation query. &lt;br/&gt;
Therefore, it seems more reasonable to simply leave the existing connections and&lt;br/&gt;
let them be evicted or thrown away when the pool becomes full.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Design Decisions for the Attached Patch:&lt;/p&gt;

&lt;p&gt;The first required change was to modify the hashCode() method in the UserPassKey&lt;br/&gt;
class to create a hash based upon both the username and password.  This was done&lt;br/&gt;
simply by concatenating username and password and returning the hashCode of the&lt;br/&gt;
combined String.  If the username is null, 0 is returned.  If the password is&lt;br/&gt;
null but the username is not, the String &quot;null&quot; will be concatenated to the&lt;br/&gt;
username and the hashCode of the combined String will be returned.  Although it&lt;br/&gt;
would have been prettier to only append the password if it is not null, the&lt;br/&gt;
additional logic and extra processing time required for the change did not seem&lt;br/&gt;
worthwhile.&lt;/p&gt;

&lt;p&gt;Next, the getUserPassKey(String username, String password) method was modified&lt;br/&gt;
to ensure the username and password were used as the key for the Map.  In the&lt;br/&gt;
event that username and password are both null, the key will be &quot;nullnull&quot;. &lt;br/&gt;
Similarly, the String &quot;null&quot; will be used for the part associated with username&lt;br/&gt;
or password if one is null.  This means that we will never use a null value for&lt;br/&gt;
a key; however, the effect is the same--since the hashCode() of the String&lt;br/&gt;
&quot;nullnull&quot; will always be the same, we&apos;ll have only one entry for the&lt;br/&gt;
UserPassKey having null username and password.  We only create a new Map entry&lt;br/&gt;
when either username or password is different (as opposed to before, where we&lt;br/&gt;
only create a new entry when username is different).&lt;/p&gt;

&lt;p&gt;Although using the password in the key may be considered to have security&lt;br/&gt;
implications (as a hash of username and password could be considered a password&lt;br/&gt;
equivalent), the data will only be available to the application--which, itself,&lt;br/&gt;
is handling the password.  Furthermore, since the UserPassKey is storing the&lt;br/&gt;
unencoded password, and since the UserPassKey&apos;s toString() method returns the&lt;br/&gt;
unencoded username and password, the proposed patch does not seem to negatively&lt;br/&gt;
impact security of the class.&lt;/p&gt;

&lt;p&gt;The patch also modifies testIncorrectPassword() in TestSharedPoolDataSource. &lt;br/&gt;
After the patch is applied, the SharedPoolDataSource will attempt to connect&lt;br/&gt;
with the new (incorrect) password.  The DataSource throws a SQLNestedException&lt;br/&gt;
(&quot;Could not retrieve connection info from pool&quot;) chained to a SQLException (&quot;x&lt;br/&gt;
is not the correct password for u1.  The correct password is p1&quot;).&lt;/p&gt;

&lt;p&gt;While the existing patch only applies to the SharedPoolDataSource, I would be&lt;br/&gt;
happy to provide a similar patch for the PerUserPoolDataSource (for the reasons&lt;br/&gt;
given above, I feel this approach is also the best approach for the&lt;br/&gt;
PerUserPoolDataSource).  If interested, let me know and I&apos;ll file a patch on&lt;br/&gt;
another bug report.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Operating System: other&lt;br/&gt;
Platform: Other&lt;/p&gt;</environment>
        <key id="12342194">DBCP-8</key>
            <summary>[dbcp][PATCH] Handle changed passwords in SharedPoolDataSource</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="markt">Mark Thomas</assignee>
                                    <reporter username="mtdean@thirdcontact.com">Michael T. Dean</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Apr 2005 08:35:22 +0000</created>
                <updated>Mon, 15 Feb 2010 04:19:47 +0000</updated>
                            <resolved>Sat, 6 Feb 2010 19:54:56 +0000</resolved>
                                                    <fixVersion>1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12409167" author="mtdean@thirdcontact.com" created="Mon, 18 Apr 2005 08:36:45 +0000"  >&lt;p&gt;Created an attachment (id=14741)&lt;br/&gt;
Proposed Patch&lt;/p&gt;</comment>
                            <comment id="12479661" author="mtdean@thirdcontact.com" created="Fri, 9 Mar 2007 17:36:45 +0000"  >&lt;p&gt;Updated patch that applies cleanly to current SVN trunk&lt;/p&gt;</comment>
                            <comment id="12689124" author="markt" created="Wed, 25 Mar 2009 14:55:39 +0000"  >&lt;p&gt;Thanks for the patch. It has been applied to trunk.&lt;/p&gt;</comment>
                            <comment id="12769867" author="markt" created="Sun, 25 Oct 2009 21:12:53 +0000"  >&lt;p&gt;Re-opening as the fix needs to be extended to the PerUserPoolDataSource&lt;/p&gt;</comment>
                            <comment id="12769868" author="markt" created="Sun, 25 Oct 2009 21:16:23 +0000"  >&lt;p&gt;Fixed in trunk and will be in 1.3 onwards.&lt;/p&gt;</comment>
                            <comment id="12801636" author="psteitz" created="Mon, 18 Jan 2010 00:50:13 +0000"  >&lt;p&gt;I am concerned that the implemented solution creates a security problem, or at least a misleading security contract.  If the use case we are trying to satisfy is database passwords being changed,  it seems to me that we really do need to implement a close() method as Dirk suggested.  Under the current implementation, getConnection(username, password) will continue to work with the &quot;old&quot; password, returning pooled connections created using the old password if these still exist in the pool.   &lt;/p&gt;</comment>
                            <comment id="12801647" author="sebb@apache.org" created="Mon, 18 Jan 2010 02:07:59 +0000"  >&lt;p&gt;Seems to me that the only way that the code can know that the password has been changed is when an application calls getConnection() using the new password.&lt;/p&gt;

&lt;p&gt;So if the login succeeds, then this becomes the new password for the user, and any connections in the pool which have a different password for that user can be dropped, and any connections that are returned to the pool subsequently can be dropped if they don&apos;t match the new password.&lt;/p&gt;

&lt;p&gt;I&apos;ve not looked at the code in detail - and it seems a bit too simple - so I may have overlooked something here.&lt;/p&gt;</comment>
                            <comment id="12801655" author="psteitz" created="Mon, 18 Jan 2010 02:47:14 +0000"  >&lt;p&gt;You are describing one reasonable scenario.  The code does not do this or anything similar.  So if we keep it as is, we at least need to document the behavior.  &lt;/p&gt;</comment>
                            <comment id="12801656" author="psteitz" created="Mon, 18 Jan 2010 02:52:20 +0000"  >&lt;p&gt;To qualify my first statement above, after the patch the code is no less secure than before - i.e., before the patch, after a password change, the old password would continue to work as long as there were connections available in the pool (and they were not killed on the server side).  After the patch, the changed password will work as well.&lt;/p&gt;</comment>
                            <comment id="12801665" author="sebb@apache.org" created="Mon, 18 Jan 2010 03:44:55 +0000"  >&lt;p&gt;Sorry, I see my previous comment was ambiguous.&lt;/p&gt;

&lt;p&gt;What I meant was that the code could be AMENDED to keep track of the current user/password combination, and use that to invalidate connections which were set up using a different password.&lt;/p&gt;

&lt;p&gt;As far as I can tell, that would prevent the old password from being used again when getting a new connection from the pool.&lt;/p&gt;

&lt;p&gt;It would not stop an active connection from being used, but IMO that&apos;s really up to the database engine whether or not a password change has any effect on an open connection. Indeed, the database might insist all connections are closed before permitting a password change.&lt;/p&gt;

&lt;p&gt;With my suggestion, there&apos;s no need to change to the API, the user just needs to provide the new password, which is what they would do anyway.&lt;/p&gt;

&lt;p&gt;If the user provides a wrong new password, then the database connection will fail, and in that case obviously the current user/password mapping should not be changed.&lt;/p&gt;

&lt;p&gt;Won&apos;t that work?&lt;/p&gt;</comment>
                            <comment id="12801941" author="psteitz" created="Mon, 18 Jan 2010 20:36:58 +0000"  >&lt;p&gt;I agree that the code could be modified to do what you are suggesting, but it will be tricky to do so, especially for SharedPoolDataSource.  &lt;/p&gt;

&lt;p&gt;Here is another problem with the patch.  While unlikely, it is possible that username+password combinations can collide.  This would not result in credential sharing, but it would result in getConnection failures, as the password comparison in InstanceKeyDatasource.getConnection would fail.  Note that other than in this case, the check will now never fail.&lt;/p&gt;

&lt;p&gt;Here is one idea, which I have not fully thought through, but which may work:&lt;/p&gt;

&lt;p&gt;Modify the following code that validates the password in InstanceKeyDataSource.getConnection&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; == password ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; == info.getPassword() 
                : password.equals(info.getPassword()))) {
            closeDueToException(info);
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SQLException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Given password did not match password used&quot;&lt;/span&gt;
                                   + &lt;span class=&quot;code-quote&quot;&gt;&quot; to create the PooledConnection.&quot;&lt;/span&gt;);
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;to call testCPDS(username, password) before throwing.  If it succeeds, that means the password has been changed, so at this point, you go into a loop, calling getPooledConnectionAndInfo(username, password) up to maxActive times until you get an info object with the new password, calling closeDueToException on the &quot;bad&quot; ones.  This should clear any idle connections with the old password and will also take care of the ones that are out as they would meet a similar fate when they come back and are subsequently checked out.&lt;/p&gt;

&lt;p&gt;Unfortunately, closeDueToExcption really just returns the connection to the pool, so to actually make this work, we would need to add the ability to mark a PooledConnectionAndInfo object as bad and modify CPDSConnectionFactory.passivate to inspect this property and destroy the object if it is marked as bad.&lt;/p&gt;

&lt;p&gt;I apologize for not digging deeply enough into this when the patch was originally applied.&lt;/p&gt;
</comment>
                            <comment id="12801949" author="sebb@apache.org" created="Mon, 18 Jan 2010 20:56:26 +0000"  >&lt;p&gt;The same key is generated for both (&quot;foo&quot;,&quot;bar&quot;) and (&quot;foob&quot;,&quot;ar&quot;) in .PerUserPoolDataSource.getPoolKey(String username, String password).&lt;/p&gt;

&lt;p&gt;So the code in InstanceKeyDataSource.getConnection is required in order to ensure that the key of username+password only matches the correct username - it&apos;s not just needed to check that the correct password has been used.&lt;/p&gt;</comment>
                            <comment id="12803525" author="psteitz" created="Thu, 21 Jan 2010 23:05:02 +0000"  >&lt;p&gt;Here is a patch that implements changed password functionality in SharedPoolDataSource, PerUserPoolDataSource with the &lt;br/&gt;
following semantics for both datasources:&lt;/p&gt;

&lt;p&gt;When a getConnection(username, password) request is processed, an attempt is made to borrow a connection from the backing pool.  If successful, a PooledConnectionAndInfo instance is provided by the backing pool.  The password field is then compared to the actual parameter provided to getConnection and if it matches, the PooledConnection that it contains is returned to the client.  If the password does not match, an attempt is made to connect to the database using the parameters supplied by the client (using testCPDS).  If this succeeds, the password must have changed since the PooledConnectionAndInfo instance was created.  In this case, the PooledConnectionAndInfo instance is destroyed and removed from the backing pool, and the pool associated with &amp;lt;username&amp;gt; is cleared (using a newly added invalidate method and a reference that it maintains to its parent factoryl).  The getConnection implementation (in InstanceKeyDataSource) then proceeds to retry up to 10 times (number could be set lower, as retries should not in general be necessary, but threads returning old connections could force retries), until it gets a PooledConnectionAndInfo with the correct password or encounters a pool error (e.g. NoSuchElementException).&lt;/p&gt;

&lt;p&gt;Summary of changes&lt;/p&gt;

&lt;p&gt;InstanceKeyDataSource: &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;modified getConnection(username, password) to implement the algorithm above.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;PooledConnectionAndInfo: &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;added a &quot;factory&quot; field to hold a reference to the factory that created the instance.  This is typed as ConnectionEventListener, which is perhaps misleading, but this is the only interface or parent that CPDSConnectionFactory, KeyedCPDSConnectionFactory share.&lt;/li&gt;
	&lt;li&gt;added a setFactoryPassword method to support resetting the password used by the factory when creating connections.  This is a no-op if the factory is KeyedCPDSConnectionFactory (SharedPoolDataSource), but is needed for CPDSConnectionFactory (PerUsserPoolDataSpource).&lt;/li&gt;
	&lt;li&gt;added an invalidate method.  The implementation of this method uses the factory reference to get a reference to the backing pool and then invokes the pool&apos;s invalidate method.  This ensures that the PooledConnection is destroyed and pool counters are appropriately updated.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;CPDSConnectionFactory:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;added setPassword method to reset the password used for a user pool (PerUserPoolDataSource)&lt;/li&gt;
	&lt;li&gt;passed reference to itself in PooledConnectionAndInfo constructor in makeObject&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;KeyedCPDSConnectionFactory:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;passed reference to itself in PooledConnectionAndInfo constructor in makeObject&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;PoolKey:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;revert to using only the username in the key&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;PerUserPoolDataSource:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;add logic to check to see if getPooledConnectionAndInfo borrowObject failure is due to factory makeObject failure as a result of password change.  In this case, check to see if the password provided in the call works to establish a connection and, if so, reset the factory password, clear the pool and retry.&lt;/li&gt;
	&lt;li&gt;changed getPoolKey to only use the username (reverting prior change)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;UserKey:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;changed equals and hashCode to identify keys with equal user names.  The password field is retained, as it is needed by the KeyedCPDSConnectionFactory.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;TestPerUserPoolDataSource, TestSharedPoolDataSource&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;modified test cases to ensure that after password changes, old passwords do not continue to work in getConnection and idle instances with old passwords are removed from the pool&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Comments / suggestions for improvement / arguments for no change welcome.  If we do go down this path, the pool fields (and constructor arguments) in CPDSConnectionFactory and KeyedCPDSConnectionFactory should be changed to GenericObjectPool, GenericKeyedObjectPool, respectively.  The patch casts to the concrete implementations because invalidation requires the clear methods which are sadly missing from the interfaces.  This would not be an incompatible change as these classes have package scope.&lt;/p&gt;

&lt;p&gt;Side note:  the last observation above (package scope) means that we can take care of the protected fields in these classes that should be private &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
</comment>
                            <comment id="12803546" author="sebb@apache.org" created="Thu, 21 Jan 2010 23:57:09 +0000"  >&lt;p&gt;What about connections which are returned to the pool? &lt;br/&gt;
If these have the old password, I assume this will be detected when the pool item is next considered for use.&lt;br/&gt;
However, this may be much later - would it not be better to drop them before returning to the pool? Or is that too much work?&lt;/p&gt;

&lt;p&gt;Some minor points:&lt;/p&gt;

&lt;p&gt;The PooledConnectionAndInfo ctor Javadoc says:&lt;/p&gt;

&lt;p&gt;The factory must be an instance of either&lt;br/&gt;
CPDSConnectionFactory (used by PerUserPoolDataSource) or &lt;br/&gt;
KeyedCPDSConnectionFactory (used by SharedPoolDataSource). &lt;/p&gt;

&lt;p&gt;However, it does not check this. Perhaps it should, rather than waiting until invalidate() causes a ClassCastException&lt;/p&gt;

&lt;p&gt;==&lt;/p&gt;

&lt;p&gt;In the code&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (factory != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (factory &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; CPDSConnectionFactory) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the null check is redundant as null can be used in the instanceof check without a problem.&lt;/p&gt;
</comment>
                            <comment id="12803555" author="psteitz" created="Fri, 22 Jan 2010 00:26:57 +0000"  >&lt;p&gt;Good points.  Detecting and killing &quot;old password&quot; connections when they are returned would be possible for PerUserPoolDataSource, since the CPDSConnectionFactory stores the (single user) password.  The only way that I can think of to do this for SharedPoolDataSource would be to attempt a database authenication each time a connection is returned, which is obviously not a good idea.  I will look more fully into what would be required to do this for PerUserPoolDataSource. &lt;/p&gt;

&lt;p&gt;Agree on the null check and I guess the PooledConnectionAndInfo constructor should check and throw.&lt;/p&gt;</comment>
                            <comment id="12803577" author="psteitz" created="Fri, 22 Jan 2010 02:35:02 +0000"  >&lt;p&gt;I had forgotten that both CPDSConnectionFactory and KeyedCPDSConnectionFactory maintain maps holding (weak) references to each of the PooledConnectionAndInfo instances managed by their pools - including the wrappers for the PooledConnections that are checked out.  So the invalidate method in the patch could, in addition to clearing the idle instance pool for the affected user, somehow mark the PooledConnectionAndInfo instances corresponding to &quot;old password&quot; connections checked out and then the factory could invalidate them when it gets a connectionClosed event on a marked connection.  The factories could even be configured to close the connections before they are returned, if that is the desired behavior (I would not recommend that by default, but it could be a config option).&lt;/p&gt;

&lt;p&gt;Another problem that I have been worried a little about is the &quot;denial of service&quot; issue raised above.  Both the original patch and the alternative suffer from the problem that if bad passwords supplied in getConnection(username, password) are common (for previously authenticated usernames), this may strain database resources, as the testCPDS check requires a database connection.  Note that the only net new load is the case where connections have been successfully established for a given username and then bad passwords are supplied frequently for the same username.  Random bad pairs would have the same load effect as they do in 1.2.2.  If we want to be conservative here, we might make the changed password functionality configurable, with default turned off.&lt;/p&gt;</comment>
                            <comment id="12803723" author="sebb@apache.org" created="Fri, 22 Jan 2010 15:20:25 +0000"  >&lt;p&gt;Minor issue: setPassword() does not need to be synch., because the variable is volatile.&lt;/p&gt;

&lt;p&gt;On further reflection, I&apos;m not sure I like the proposed patch - for example I&apos;m not sure that PooledConnectionAndInfo should have a reference to the factory used to create it.&lt;/p&gt;

&lt;p&gt;However I don&apos;t (yet) know the DBCP design well enough to know if there is any other way to solve the problem.&lt;/p&gt;</comment>
                            <comment id="12803777" author="psteitz" created="Fri, 22 Jan 2010 17:50:14 +0000"  >&lt;p&gt;I think I was planning to clean up the access on _password, making it private, so access could be syched.&lt;/p&gt;

&lt;p&gt;Agree that it is a little smelly and inefficient to have PooledConnectionAndInfo instances hold factory references.  For SharedPoolDataSource, the datasource itself could hold a reference to the factory.  PerUserPoolDataSoures would have to maintain a map of such references.   I will look into alternatives.   Suggestions welcome.&lt;/p&gt;</comment>
                            <comment id="12803843" author="sebb@apache.org" created="Fri, 22 Jan 2010 19:42:09 +0000"  >&lt;p&gt;Seems to me that PerUserPoolDataSource could store the factory in the map, instead of the pool - or failing that a wrapper object that contained both.&lt;br/&gt;
This would allow PUPDS to track the password.&lt;/p&gt;

&lt;p&gt;BTW, it seems to me that CPDSConnectionFactory really ought not to have any way of changing the CPDS or Pool once the factory has been created.&lt;br/&gt;
Not sure it makes sense for either to be changed on the fly - I suspect it would seriously mess things up.&lt;/p&gt;</comment>
                            <comment id="12806859" author="psteitz" created="Sun, 31 Jan 2010 19:09:53 +0000"  >&lt;p&gt;Here is an updated patch that accomplishes what changePassword.patch did without adding a factory reference to PooledConnectionAndInfo.  Instead, a new interface is added - PooledConnectionManager - including methods to invalidate PooledConnections and this interface is implemented by the connection factories.  PerUserPoolDataSource is modified to replace its pools map with a &quot;managers&quot; map holding references to source factories rather than host pools.  Otherwise changes are similar to changePassword.patch.  The invalidate method is a useful enhancement which could potentially be exposed by the datasources, allowing users to selectively &quot;realy close&quot; pooled connections without messing up the pool or its counters.&lt;/p&gt;

&lt;p&gt;This patch also reduces mutability of the factories. &lt;/p&gt;

&lt;p&gt;For SharedPooleDataSource / KeyedCPDSConnectionFactory, connections returning after password reset are still not closed immediately.  To implement this would require more work.&lt;/p&gt;</comment>
                            <comment id="12828070" author="sebb@apache.org" created="Mon, 1 Feb 2010 11:34:22 +0000"  >&lt;p&gt;Latest patch looks good, except I&apos;m not sure that CPDSConnectionFactory should allow the username to be changed, only the password.&lt;/p&gt;

&lt;p&gt;It&apos;s a pity that CPDSConnectionFactory is not quite immutable, but I suspect it might be rather complicated to update the stored factory when the password changes.&lt;/p&gt;</comment>
                            <comment id="12828140" author="sebb@apache.org" created="Mon, 1 Feb 2010 15:19:40 +0000"  >&lt;p&gt;Just noticed a minor issue in the existing testChangePassword() methods:&lt;/p&gt;

&lt;p&gt;In the following sample:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    ds.getConnection(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;).close(); &lt;span class=&quot;code-comment&quot;&gt;// old password
&lt;/span&gt;    fail(&lt;span class=&quot;code-quote&quot;&gt;&quot;Should have generated SQLException&quot;&lt;/span&gt;); 
} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; etc
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the .close() should be removed - the test is supposed to be checking getConnection(), not close().&lt;br/&gt;
In theory the get could succeed and the close() fail.&lt;/p&gt;

&lt;p&gt;Need to fix these at some point.&lt;/p&gt;</comment>
                            <comment id="12830555" author="psteitz" created="Sat, 6 Feb 2010 19:54:56 +0000"  >&lt;p&gt;Committed passwordChange2.patch with one change in r907288.  Per Sebb&apos;s comment, the only mutability needed in CPDSConnectionFactory is the password, so PooledConnectionManager exposes only setPassword, rather than setUserPassKey.&lt;/p&gt;

&lt;p&gt;Dropped extraneous close in the changePassword tests in r907290.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12333469" name="ASF.LICENSE.NOT.GRANTED--dbcp-SharedPoolWithPasswordChange.patch" size="2470" author="mtdean@thirdcontact.com" created="Mon, 18 Apr 2005 08:36:45 +0000"/>
                            <attachment id="12431077" name="changePassword.patch" size="26504" author="psteitz" created="Thu, 21 Jan 2010 23:05:02 +0000"/>
                            <attachment id="12353003" name="dbcp-SharedPoolWithPasswordChange-20070309.patch" size="2474" author="mtdean@thirdcontact.com" created="Fri, 9 Mar 2007 17:36:45 +0000"/>
                            <attachment id="12431918" name="passwordChange2.patch" size="45269" author="psteitz" created="Sun, 31 Jan 2010 19:09:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_10010" key="com.atlassian.jira.plugin.system.customfieldtypes:importid">
                        <customfieldname>Bugzilla Id</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34490</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>114292</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 41 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0uw7j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>178359</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>