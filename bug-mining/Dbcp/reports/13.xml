<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:46:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-65] [dbcp] Deadlock when evicting dbcp objects (testWhileIdle=true)</title>
                <link>https://issues.apache.org/jira/browse/DBCP-65</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;The GenericKeyedObjectPool$Evictor thread has probability of deadlock with dbcp&lt;br/&gt;
objects.&lt;/p&gt;

&lt;p&gt;For example, at a certain time, a normal user thread calls a PoolingConnection&lt;br/&gt;
object&apos;s synchronized method, which in turn calls GenericKeyedObjectPool&lt;br/&gt;
object&apos;s synchronzied method.&lt;/p&gt;

&lt;p&gt;At the same time, the evictor thread calls the GenericKeyedObjectPool object&apos;s&lt;br/&gt;
synchronized method &apos;evict&apos;, which in turn calls the PoolingConnection object&apos;s&lt;br/&gt;
synchronized method.  When testWhileIdle=true, the probability of evictor&lt;br/&gt;
calling GenericKeyedObjectPool&apos;s synchronized method is much greater.&lt;/p&gt;

&lt;p&gt;The following is the deadlock information in the thread dump of our program&lt;br/&gt;
(testWhileIdle=true):&lt;/p&gt;

&lt;p&gt;&quot;Thread-106&quot;:&lt;br/&gt;
	at org.apache.commons.dbcp.AbandonedTrace.removeTrace(AbandonedTrace.java:221)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x6a6b1b80&amp;gt; (a org.apache.commons.dbcp.PoolingConnection)&lt;br/&gt;
	at&lt;br/&gt;
org.apache.commons.dbcp.PoolablePreparedStatement.passivate(PoolablePreparedStatement.java:100)&lt;br/&gt;
	at&lt;br/&gt;
org.apache.commons.dbcp.PoolingConnection.passivateObject(PoolingConnection.java:239)&lt;br/&gt;
	at&lt;br/&gt;
org.apache.commons.pool.impl.GenericKeyedObjectPool.evict(GenericKeyedObjectPool.java:1001)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x6a6b1858&amp;gt; (a org.apache.commons.pool.impl.GenericKeyedObjectPool)&lt;br/&gt;
	at&lt;br/&gt;
org.apache.commons.pool.impl.GenericKeyedObjectPool$Evictor.run(GenericKeyedObjectPool.java:1156)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:534)&lt;br/&gt;
&quot;Thread-41&quot;:&lt;br/&gt;
	at&lt;br/&gt;
org.apache.commons.pool.impl.GenericKeyedObjectPool.borrowObject(GenericKeyedObjectPool.java:715)&lt;/li&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x6a6b1858&amp;gt; (a&lt;br/&gt;
org.apache.commons.pool.impl.GenericKeyedObjectPool)&lt;br/&gt;
	at&lt;br/&gt;
org.apache.commons.dbcp.PoolingConnection.prepareStatement(PoolingConnection.java:87)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x6a6b1b80&amp;gt; (a org.apache.commons.dbcp.PoolingConnection)&lt;br/&gt;
	at&lt;br/&gt;
org.apache.commons.dbcp.DelegatingConnection.prepareStatement(DelegatingConnection.java:185)&lt;br/&gt;
	at&lt;br/&gt;
org.apache.commons.dbcp.PoolingDataSource$PoolGuardConnectionWrapper.prepareStatement(PoolingDataSource.java:278)&lt;br/&gt;
...&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This problem can be worked around by setting testWhileIdle to false, although&lt;br/&gt;
there is still very small possibility of deadlock.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Operating System: All&lt;br/&gt;
Platform: All&lt;/p&gt;</environment>
        <key id="12342202">DBCP-65</key>
            <summary>[dbcp] Deadlock when evicting dbcp objects (testWhileIdle=true)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="phnixwxz1@yahoo.com">Wang Xianzhu</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Apr 2005 19:01:49 +0000</created>
                <updated>Fri, 29 Jan 2010 21:43:03 +0000</updated>
                            <resolved>Mon, 22 Jan 2007 04:47:31 +0000</resolved>
                                                    <fixVersion>1.2.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="12409180" author="sandymac@apache.org" created="Sat, 11 Feb 2006 07:23:26 +0000"  >&lt;p&gt;Looking at GenericKeyedObjectPool.Evictor and PoolingConnection I think this is&lt;br/&gt;
a problem with PoolingConnection because it is both a client for&lt;br/&gt;
GenericKeyedObjectPool and passes an instance of itself as the&lt;br/&gt;
KeyedPoolableObjectFactory for GenericKeyedObjectPool.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure GenericKeyedObjectPool can be changed and remain thread safe to fix&lt;br/&gt;
this situation. I think PoolingConnection needs to be changed so it aquires&lt;br/&gt;
synchronization lock in the order of the GenericKeyedObjectPool instance first&lt;br/&gt;
and then itself.&lt;/p&gt;

&lt;p&gt;Does an apache dev agree with me and want to punt this off to Dbcp?&lt;/p&gt;</comment>
                            <comment id="12409181" author="sandymac@apache.org" created="Mon, 13 Feb 2006 05:10:34 +0000"  >&lt;p&gt;After sleeping on it I&apos;m convinced this is a DBCP problem.&lt;/p&gt;

&lt;p&gt;DBCP needs to be careful about syncronization on it KeyedPoolableObjectFactory&lt;br/&gt;
implementations. Specificly it needs to pay attention to the fact that the&lt;br/&gt;
ObjectPool&apos;s evictor aquires the sync lock for the ObjectPool first and then may&lt;br/&gt;
call the following methods in KeyedPoolableObjectFactory: activateObject,&lt;br/&gt;
validateObject, and passivateObject. I&apos;m not familiar with DBCP else I&apos;d try to&lt;br/&gt;
be  more specific.&lt;/p&gt;</comment>
                            <comment id="12451188" author="psteitz" created="Sun, 19 Nov 2006 22:06:39 +0000"  >&lt;p&gt;I cannot find a backward compatible way to fix this. &lt;/p&gt;</comment>
                            <comment id="12451390" author="sandymac" created="Mon, 20 Nov 2006 18:47:28 +0000"  >&lt;p&gt;I think the only backward compatible way to fix this is to drop Pool as a dependency and pull GOP into DBCP and make it a DBCP specific implementations. This would be kinda funny since, as I understand it, Pool was birthed from DBCP long ago.&lt;/p&gt;

&lt;p&gt;The other choices would be to:&lt;/p&gt;

&lt;p&gt;1. Extend PoolableObjectFactory with a subinterface that provides hooks for the pool&apos;s eviction thread to acquire the needed locks before acquiring the internal pool locks. I think this would be very hard to do in the existing pool implementations in a backwards compatible way, but there is the new composite pool implementation that hasn&apos;t seen an official release and we could make this work with that in Pool 2.&lt;/p&gt;

&lt;p&gt;2. Simply make the DBCP config options that cause an eviction thread to be created be no-ops and provide a way to enable the erodingPool decorator that will be in Pool 2.&lt;/p&gt;

&lt;p&gt;3. Perform deep surgery on DBCP so it works with existing pool implementations but, as you said, this probably won&apos;t be backward compatible and I think it&apos;s a bit of the tail wagging the dog.&lt;/p&gt;

&lt;p&gt;I personally think #2 is the best choice but I&apos;ll work with you to make #1 happen. A lot of users think they need an evictor even though I maintain that is a risky way to use Pool and should be discouraged.&lt;/p&gt;</comment>
                            <comment id="12452488" author="psteitz" created="Fri, 24 Nov 2006 16:02:38 +0000"  >&lt;p&gt;I am +1 on option 2, or just migrate to Pool 2 when it is released.  Having spent many hours trying to find workarounds for this and &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-44&quot; title=&quot;[dbcp] Evictor thread in GenericObjectPool has potential for deadlock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-44&quot;&gt;&lt;del&gt;DBCP-44&lt;/del&gt;&lt;/a&gt; (trying to do things like 1 outside of &lt;span class=&quot;error&quot;&gt;&amp;#91;pool&amp;#93;&lt;/span&gt;, which is hopeless), I agree that the current evictor setup is a recipe for deadlocks and can&apos;t be fixed without changes to &lt;span class=&quot;error&quot;&gt;&amp;#91;pool&amp;#93;&lt;/span&gt; or &lt;span class=&quot;error&quot;&gt;&amp;#91;dbcp&amp;#93;&lt;/span&gt; config semantics.&lt;/p&gt;</comment>
                            <comment id="12460140" author="psteitz" created="Thu, 21 Dec 2006 04:49:51 +0000"  >&lt;p&gt;Unless someone can give a good reason that PoolingConnection&apos;s prepareStatement methods &lt;b&gt;must&lt;/b&gt; be synchronized, I am inclined to remove the synchronization from these methods.  That sounds radical, but observe that all we have in these methods is:q&lt;br/&gt;
try &lt;/p&gt;
{
            return(PreparedStatement)(_pstmtPool.borrowObject(createKey(sql)));
        }
&lt;p&gt; catch(NoSuchElementException e) &lt;/p&gt;
{
            throw new SQLNestedException(&quot;MaxOpenPreparedStatements limit reached&quot;, e); 
        }
&lt;p&gt; catch(RuntimeException e) &lt;/p&gt;
{
            throw e;
        }
&lt;p&gt; catch(Exception e) &lt;/p&gt;
{
            throw new SQLNestedException(&quot;Borrow prepareStatement from pool failed&quot;, e);
        }
&lt;p&gt;The borrowObject pool method is synchronized and the cause of the deadlocks here and in &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-202&quot; title=&quot;Deadlock creating/closing PreparedStatement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-202&quot;&gt;&lt;del&gt;DBCP-202&lt;/del&gt;&lt;/a&gt; is that these methods lock the PoolingConnection first and then the pool.   I thought first about changing the order explicitly by replacing the outer synchronization with &lt;br/&gt;
synchronized (_pstmtPool) {&lt;br/&gt;
  synchronized (this) {&lt;br/&gt;
   ...&lt;br/&gt;
to force consistent lock order, but then could not see any reason for the inner synch, and the other one is already there in the pool method.  &lt;br/&gt;
Can anyone see why these methods need to be synchronized on the PoolingConnection?   If this seems too high-risk, how about the explicit lock ordering above?&lt;br/&gt;
Removing or altering synchronization lock order should resolve &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-202&quot; title=&quot;Deadlock creating/closing PreparedStatement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-202&quot;&gt;&lt;del&gt;DBCP-202&lt;/del&gt;&lt;/a&gt; as well.&lt;/p&gt;</comment>
                            <comment id="12466387" author="psteitz" created="Mon, 22 Jan 2007 04:47:31 +0000"  >&lt;p&gt;Synchronization was removed from the perpareStatement methods per last comment in r498524.  &lt;/p&gt;</comment>
                            <comment id="12573586" author="drees" created="Fri, 29 Feb 2008 04:24:01 +0000"  >&lt;p&gt;This bug still exists in 1.2.2. I don&apos;t think that removing the prepareStatement synchronization helps, there is still a lock-race between the Evictor and returning objects to the pool for example.&lt;/p&gt;

&lt;p&gt;Here is a stack trace, I&apos;ve had this happen twice in the last week on two completely different applications (after using dbcp successfully without issue for years!):&lt;/p&gt;

&lt;p&gt;&quot;Timer-0&quot;:&lt;br/&gt;
at org.apache.commons.dbcp.AbandonedTrace.addTrace(AbandonedTrace.java:175)&lt;br/&gt;
waiting to lock &amp;lt;0x0000002aa04d4be8&amp;gt; (a org.apache.commons.dbcp.PoolableConnection)&lt;br/&gt;
at org.apache.commons.dbcp.AbandonedTrace.init(AbandonedTrace.java:92)&lt;br/&gt;
at org.apache.commons.dbcp.AbandonedTrace.&amp;lt;init&amp;gt;(AbandonedTrace.java:82)&lt;br/&gt;
at org.apache.commons.dbcp.DelegatingStatement.&amp;lt;init&amp;gt;(DelegatingStatement.java:61)&lt;br/&gt;
at org.apache.commons.dbcp.DelegatingConnection.createStatement(DelegatingConnection.java:224)&lt;br/&gt;
at org.apache.commons.dbcp.PoolableConnectionFactory.validateConnection(PoolableConnectionFactory.java:331)&lt;br/&gt;
at org.apache.commons.dbcp.PoolableConnectionFactory.validateObject(PoolableConnectionFactory.java:312)&lt;br/&gt;
at org.apache.commons.pool.impl.GenericObjectPool.evict(GenericObjectPool.java:1217)&lt;br/&gt;
locked &amp;lt;0x0000002a9ee91bf8&amp;gt; (a org.apache.commons.pool.impl.GenericObjectPool)&lt;br/&gt;
at org.apache.commons.pool.impl.GenericObjectPool$Evictor.run(GenericObjectPool.java:1341)&lt;br/&gt;
at java.util.TimerThread.mainLoop(Timer.java:512)&lt;br/&gt;
at java.util.TimerThread.run(Timer.java:462)&lt;br/&gt;
&quot;SocketRequest-8&quot;:&lt;br/&gt;
at org.apache.commons.pool.impl.GenericObjectPool.addObjectToPool(GenericObjectPool.java:1137)&lt;br/&gt;
waiting to lock &amp;lt;0x0000002a9ee91bf8&amp;gt; (a org.apache.commons.pool.impl.GenericObjectPool)&lt;br/&gt;
at org.apache.commons.pool.impl.GenericObjectPool.returnObject(GenericObjectPool.java:1076)&lt;br/&gt;
at org.apache.commons.dbcp.PoolableConnection.close(PoolableConnection.java:87)&lt;br/&gt;
locked &amp;lt;0x0000002aa04d4be8&amp;gt; (a org.apache.commons.dbcp.PoolableConnection)&lt;br/&gt;
at org.apache.commons.dbcp.PoolingDataSource$PoolGuardConnectionWrapper.close(PoolingDataSource.java:181)&lt;br/&gt;
at my.package.DbUtil.close(DbUtil.java:545)&lt;/p&gt;

&lt;p&gt;In this configuration, minIdle=0, maxIdle=4, maxActive=8, testWhileIdle=true timeBetweenEvictionRunsMillis=15000&lt;/p&gt;

&lt;p&gt;It appears that the only workaround for now to prevent this deadlock is to disable the Evictor thread by disabling testWhileIdle.&lt;/p&gt;

&lt;p&gt;I have two comments on &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-44&quot; title=&quot;[dbcp] Evictor thread in GenericObjectPool has potential for deadlock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-44&quot;&gt;&lt;del&gt;DBCP-44&lt;/del&gt;&lt;/a&gt; with other information (before I realized that this was the bug I was hitting, though they are related).&lt;/p&gt;</comment>
                            <comment id="12806519" author="novoj" created="Fri, 29 Jan 2010 21:43:02 +0000"  >&lt;p&gt;I confirmt, that deadlock persists even in 1.2.2 version. Testing web application under a high load it will with 100% probability stuck at return object method:&lt;/p&gt;

&lt;p&gt;at org.apache.commons.pool.impl.GenericKeyedObjectPool.returnObject (GenericKeyedObjectPool.java:872)&lt;br/&gt;
at org.apache.commons.dbcp.datasources.KeyedCPDSConnectionFactory.connectionClosed (KeyedCPDSConnectionFactory.java:268)&lt;br/&gt;
at com.mysql.jdbc.jdbc2.optional.MysqlPooledConnection.callListener (MysqlPooledConnection.java:209)&lt;br/&gt;
at com.mysql.jdbc.jdbc2.optional.ConnectionWrapper.close (ConnectionWrapper.java:857)&lt;br/&gt;
at com.mysql.jdbc.jdbc2.optional.ConnectionWrapper.close (ConnectionWrapper.java:480)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12356581">DBCP-202</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                                                <inwardlinks description="is cloned by">
                                        <issuelink>
            <issuekey id="12413259">DBCP-281</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_10010" key="com.atlassian.jira.plugin.system.customfieldtypes:importid">
                        <customfieldname>Bugzilla Id</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34539</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>114348</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 43 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0uvzj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>178323</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>