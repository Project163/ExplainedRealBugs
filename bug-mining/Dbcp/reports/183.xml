<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:48:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-568] ManagedConnection must clear its cached state after transaction completes</title>
                <link>https://issues.apache.org/jira/browse/DBCP-568</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;There&apos;s a spurious log (see log in comment) about failure to rollback a connection in the following context:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;use of a managed connection&lt;/li&gt;
	&lt;li&gt;cacheState=true (the default)&lt;/li&gt;
	&lt;li&gt;rollback initiated by the transaction manager&lt;/li&gt;
	&lt;li&gt;rollbackOnReturn=true (the default)&lt;/li&gt;
	&lt;li&gt;JDBC driver that refuses to rollback when autoCommit=true (like the PostgreSQL driver)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The sequence of events leading to the error is:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;transaction started&lt;/li&gt;
	&lt;li&gt;application acquires managed connection from pool (wrapping the low-level PgConnection)
	&lt;ul&gt;
		&lt;li&gt;connection enlisted in transaction&lt;/li&gt;
		&lt;li&gt;LocalXAConnectionFactory.LocalXAResource.start sets low-level connection autoCommit=false&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;application does some work&lt;/li&gt;
	&lt;li&gt;application check connection&apos;s autoCommit state for various reasons
	&lt;ul&gt;
		&lt;li&gt;calls DelegatingConnection.getAutoCommit which caches the state (false)&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;application does more work and signals the transaction manager to rollback&lt;/li&gt;
	&lt;li&gt;transaction manager rolls back
	&lt;ul&gt;
		&lt;li&gt;all enlisted resources roll back
		&lt;ul&gt;
			&lt;li&gt;LocalXAConnectionFactory.LocalXAResource.rollback rolls back and sets low-level autoCommit=true&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;managed connection is closed
	&lt;ul&gt;
		&lt;li&gt;PoolableConnection.close calls PoolableConnectionFactory.passivateObject&lt;/li&gt;
		&lt;li&gt;passivation does rollback-on-return which checks for connection autoCommit before doing rollback
		&lt;ul&gt;
			&lt;li&gt;the autoCommit status returned is the one cached in DelegatingConnection so still false&lt;/li&gt;
			&lt;li&gt;rollback is called on low-level connection, which throws because it&apos;s still in state autoCommit=true&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;There are several workarounds:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;use cacheState=false in the datasource config&lt;/li&gt;
	&lt;li&gt;use rollbackOnReturn=false in the datasource config&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;But the correct fix is to make the DelegatingConnection aware that during rollback something was changed at low-level and its cache is invalid. This can be done by making ManagedConnection.transactionComplete (which is called in afterCompletion) clear the cached state.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13340718">DBCP-568</key>
            <summary>ManagedConnection must clear its cached state after transaction completes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="fguillaume">Florent Guillaume</reporter>
                        <labels>
                    </labels>
                <created>Sun, 15 Nov 2020 18:38:06 +0000</created>
                <updated>Wed, 13 Jan 2021 19:50:12 +0000</updated>
                            <resolved>Wed, 13 Jan 2021 19:37:38 +0000</resolved>
                                    <version>2.0</version>
                                    <fixVersion>2.9.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                <comments>
                            <comment id="17232375" author="fguillaume" created="Sun, 15 Nov 2020 18:45:05 +0000"  >
&lt;p&gt;Example stacktrace logged&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2020-11-15 16:16:10,455 [mythread] WARN  [SwallowedExceptionLogger] An internal object pool swallowed an Exception.
org.postgresql.util.PSQLException: Cannot rollback when autoCommit is enabled.
	at org.postgresql.jdbc.PgConnection.rollback(PgConnection.java:895) ~[postgresql-42.2.18.jar:42.2.18]
	at org.apache.commons.dbcp2.DelegatingConnection.rollback(DelegatingConnection.java:482) ~[commons-dbcp2-2.8.0.jar:2.8.0]
	at org.apache.commons.dbcp2.PoolableConnectionFactory.passivateObject(PoolableConnectionFactory.java:427) ~[commons-dbcp2-2.8.0.jar:2.8.0]
	at org.apache.commons.pool2.impl.GenericObjectPool.returnObject(GenericObjectPool.java:557) ~[commons-pool2-2.9.0.jar:2.9.0]
	at org.apache.commons.dbcp2.PoolableConnection.close(PoolableConnection.java:203) ~[commons-dbcp2-2.8.0.jar:2.8.0]
	at org.apache.commons.dbcp2.DelegatingConnection.closeInternal(DelegatingConnection.java:236) ~[commons-dbcp2-2.8.0.jar:2.8.0]
	at org.apache.commons.dbcp2.DelegatingConnection.close(DelegatingConnection.java:207) ~[commons-dbcp2-2.8.0.jar:2.8.0]
	at org.apache.commons.dbcp2.managed.ManagedConnection.close(ManagedConnection.java:111) ~[commons-dbcp2-2.8.0.jar:2.8.0]
	at com.example.MyApp.closeConnection(MyApp.java:42)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17264381" author="garydgregory" created="Wed, 13 Jan 2021 19:33:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fguillaume&quot; class=&quot;user-hover&quot; rel=&quot;fguillaume&quot;&gt;fguillaume&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thank you for the detailed write up. Your explanation makes the PR much easier to understand.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17264382" author="garydgregory" created="Wed, 13 Jan 2021 19:37:38 +0000"  >&lt;p&gt;In git master. Please verify and close this ticket.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 43 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0klug:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>