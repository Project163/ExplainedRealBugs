<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:48:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-309] First example for FSContext is invalid</title>
                <link>https://issues.apache.org/jira/browse/DBCP-309</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;First example on page &lt;a href=&quot;http://commons.apache.org/dbcp/guide/jndi-howto.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://commons.apache.org/dbcp/guide/jndi-howto.html&lt;/a&gt; is invalid, with this code every call of  &lt;/p&gt;

&lt;p&gt;  InitialContext ic2 = new InitialContext();&lt;br/&gt;
  DataSource ds = (DataSource) ic2.lookup(&quot;jdbc/basic&quot;);&lt;br/&gt;
  Connection conn = ds.getConnection();&lt;br/&gt;
  conn.close();&lt;/p&gt;

&lt;p&gt;ends with new datasource with unclosed connection in it becase new Reference(&quot;javax.sql.DataSource&quot;,  &quot;org.apache.commons.dbcp.BasicDataSourceFactory&quot;, null); reference creates new DataSource instead using created one while calling  ic2.lookup(&quot;jdbc/basic&quot;).&lt;/p&gt;

&lt;p&gt;At the end it ends with many opened connections to DB until JVM is ended.&lt;/p&gt;

&lt;p&gt;Second example I didn&apos;t test, i use direct aproach with manualy creating SharedPoolDataSource and registring it in FSContext JNDI itself.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12441779">DBCP-309</key>
            <summary>First example for FSContext is invalid</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="5" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Trivial</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="barkh">Ondrej Tisler</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 Nov 2009 14:12:05 +0000</created>
                <updated>Tue, 24 Feb 2015 03:23:18 +0000</updated>
                            <resolved>Wed, 12 Feb 2014 20:05:51 +0000</resolved>
                                    <version>1.2.2</version>
                                    <fixVersion>1.5.1</fixVersion>
                    <fixVersion>2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12783483" author="psteitz" created="Sun, 29 Nov 2009 21:52:38 +0000"  >&lt;p&gt;Looks like a bug in the examples to me.  Looks like the BasicDataSource example is taken from an example (Tomcat?) where a more general type of resource is being created but not bound directly into the JNDI context.  Unless I am missing something, it would be simpler (and correct) to just create the datasource instance and bind it directly.&lt;/p&gt;</comment>
                            <comment id="12783729" author="psteitz" created="Mon, 30 Nov 2009 16:25:28 +0000"  >&lt;p&gt;Strike last comment.  DataSoources do not implement Referenceable, so direct references will not work.  When using the FileSystem provider, datasources are created new for each lookup (as reported in the issue).  Tomcat&apos;s in-memory provider, however, returns the same datasource for repeated lookups.  The following test, for example, succeeds with the Tomcat provider, but fails with the FS provider&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Hashtable environment = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Hashtable();
        environment.put(Context.INITIAL_CONTEXT_FACTORY,
                org.apache.naming.java.javaURLContextFactory.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;getName());
        InitialContext ic = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InitialContext(environment);
        ic.createSubcontext(&lt;span class=&quot;code-quote&quot;&gt;&quot;jdbc&quot;&lt;/span&gt;); 
        &lt;span class=&quot;code-comment&quot;&gt;// Construct BasicDataSource reference
&lt;/span&gt;        Reference ref = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Reference(&lt;span class=&quot;code-quote&quot;&gt;&quot;javax.sql.DataSource&quot;&lt;/span&gt;,
          &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.commons.dbcp.BasicDataSourceFactory&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
        ref.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringRefAddr(&lt;span class=&quot;code-quote&quot;&gt;&quot;driverClassName&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;TesterDriver&quot;&lt;/span&gt;));
        ref.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringRefAddr(&lt;span class=&quot;code-quote&quot;&gt;&quot;url&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;jdbc:apache:commons:testdriver&quot;&lt;/span&gt;));
        ref.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringRefAddr(&lt;span class=&quot;code-quote&quot;&gt;&quot;username&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;username&quot;&lt;/span&gt;));
        ref.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringRefAddr(&lt;span class=&quot;code-quote&quot;&gt;&quot;password&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;password&quot;&lt;/span&gt;));
        ic.rebind(&lt;span class=&quot;code-quote&quot;&gt;&quot;jdbc/basic&quot;&lt;/span&gt;, ref);
         
        &lt;span class=&quot;code-comment&quot;&gt;// Use
&lt;/span&gt;        InitialContext ic2 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InitialContext(environment);
        DataSource ds = (DataSource) ic2.lookup(&lt;span class=&quot;code-quote&quot;&gt;&quot;jdbc/basic&quot;&lt;/span&gt;);
        ((BasicDataSource) ds).setAccessToUnderlyingConnectionAllowed(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        Assert.assertNotNull(ds);
        Connection conn = ds.getConnection();
        Connection uconn = ((DelegatingConnection) conn).getInnermostDelegate();
        Assert.assertNotNull(conn);
        conn.close();
        
        DataSource ds2 = (DataSource) ic2.lookup(&lt;span class=&quot;code-quote&quot;&gt;&quot;jdbc/basic&quot;&lt;/span&gt;);
        ((BasicDataSource) ds2).setAccessToUnderlyingConnectionAllowed(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        Assert.assertNotNull(ds2);
        Connection conn2 = ds2.getConnection();
        Connection uconn2 = ((DelegatingConnection) conn2).getInnermostDelegate();
        Assert.assertNotNull(conn2);
        conn2.close();
        Assert.assertEquals(ds, ds2);
        Assert.assertEquals(uconn2, uconn);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To make the examples less misleading, it seems we have two choices - 1) change to use the Tomcat provider or 2) comment that the FS provider creates new datasources each time.  Would appreciate comments / patches from JNDI spi experts on this.&lt;/p&gt;</comment>
                            <comment id="12784807" author="barkh" created="Wed, 2 Dec 2009 13:05:45 +0000"  >&lt;p&gt;I use this code for registring JNDI inFSContext:&lt;br/&gt;
      // JNDI with datasource&lt;br/&gt;
      InitialContext ic = new InitialContext();&lt;br/&gt;
      // Construct BasicDataSource reference&lt;br/&gt;
      Configuration poolConfig = dbConfig.subset(&quot;datasource&quot;);&lt;br/&gt;
      DriverAdapterCPDS cpds = new DriverAdapterCPDS();&lt;br/&gt;
      cpds.setDriver(poolConfig.getString(&quot;driver.driverClassName&quot;));&lt;br/&gt;
      cpds.setUrl(poolConfig.getString(&quot;driver.url&quot;));&lt;br/&gt;
      cpds.setUser(poolConfig.getString(&quot;driver.username&quot;));&lt;br/&gt;
      cpds.setPassword(CryptPass.encryptPass(poolConfig.getString(&quot;driver.password&quot;)));&lt;br/&gt;
      SharedPoolDataSource ds = new SharedPoolDataSource();&lt;br/&gt;
      ds.setConnectionPoolDataSource(cpds);&lt;br/&gt;
      ds.setDefaultAutoCommit(poolConfig.getBoolean(&quot;connection.defaultAutoCommit&quot;, true));&lt;br/&gt;
      ds.setValidationQuery(poolConfig.getString(&quot;validation.validationQuery&quot;));&lt;br/&gt;
      ic.rebind(poolConfig.getString(&quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;@jndi&amp;#93;&lt;/span&gt;&quot;), ds);&lt;br/&gt;
      log.info(&quot;JNDI datasource is inicialized&quot;);&lt;/p&gt;

&lt;p&gt;next you can normaly use JNDI lookup:&lt;br/&gt;
      InitialContext ic2 = new InitialContext();&lt;br/&gt;
      ds = (DataSource) ic2.lookup(poolConfig.getString(&quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;@jndi&amp;#93;&lt;/span&gt;&quot;));&lt;br/&gt;
      conn = ds.getConnection();&lt;/p&gt;</comment>
                            <comment id="13027555" author="psteitz" created="Mon, 2 May 2011 05:50:54 +0000"  >&lt;p&gt;Unfortunately, I think the right fix here is to drop the BasicDataSource example and resolve this issue, but open another one to make BasicDataSource implement Referenceable in 2.0.&lt;/p&gt;</comment>
                            <comment id="13898311" author="markt" created="Tue, 11 Feb 2014 21:05:32 +0000"  >&lt;p&gt;Caveat: I am no JNDI expert. The little I do know is gleaned from reverse engineering Tomcat&apos;s JNDI implementation.&lt;/p&gt;

&lt;p&gt;I think the example is wrong because it binds a reference. A reference will always result in a new object being created when it is looked up. If the example binds a BasicDataSource instance, it appears to behave as desired/expected.&lt;/p&gt;

&lt;p&gt;As most users expect multiple JNDI look ups using the same name to return the same object, Tomcat deliberately breaks the rules. By default, when Tomcat finds a reference, Tomcat resolves that reference to an object and then replaces the reference in JNDI with the object. In later Tomcat versions, this is configurable with the singleton property.&lt;/p&gt;

&lt;p&gt;It isn&apos;t clear to me how implementing Referenceable will help. If anything, that will make it worse as it would then be impossible to bind an instance of a BasicDataSource to JNDI as the Reference would be bound.&lt;/p&gt;

&lt;p&gt;I intend to tweak the examples to bind instances rather than References. This appears to be consistent with Ondrej Tisler&apos;s approach above.&lt;/p&gt;</comment>
                            <comment id="13899523" author="markt" created="Wed, 12 Feb 2014 20:05:51 +0000"  >&lt;p&gt;I&apos;ve fixed trunk for the 2.x series the 1.5.x branch. It will be included in the next release of each.&lt;/p&gt;

&lt;p&gt;If there are further 1.3.x and 1.4.x releases (currently being discussed on the dev mailing list) my expectation is that they will be generated from the 1.5.x branch so will pick up this fix too.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>114586</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 40 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0fu0f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>90460</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>