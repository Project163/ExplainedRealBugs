<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:48:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-414] PoolablePreparedStatement can get closed while it&apos;s being used</title>
                <link>https://issues.apache.org/jira/browse/DBCP-414</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;I&apos;ve found a case where a PoolablePreparedStatement that&apos;s currently in active use can get closed (resulting in &quot;PoolablePreparedStatement with address: ... is closed&quot; SQLException to the application), from a finalizer of another DelegatingPreparedStatement (that&apos;s obviously not in use, since it&apos;s being garbage collected). &lt;/p&gt;

&lt;p&gt;Details:&lt;/p&gt;

&lt;p&gt;0. Starting point: application has a Connection (it&apos;s a PoolGuardConnectionWrapper wrapping PoolableConnection wrapping PoolingConnection wrapping com.mysql.jdbc.JDBC4Connection), statement pooling is enabled, and prepareStatement has never been called&lt;/p&gt;

&lt;p&gt;1. Application calls conn.prepareStatement. The statement pool is empty, so this ends up in PoolingConnection.makeObject, which then calls MySQL to get a PreparedStatement (stmt1), and wraps it in PoolablePreparedStatement (stmt2). PoolableConnection.prepareStatement wraps it in new DelegatingPreparedStatement (stmt3), and PoolGuardConnectionWrapper wraps it again (stmt4).&lt;/p&gt;

&lt;p&gt;2. Application does something with stmt4, and eventually calls stmt4.close(). The call ends up in stmt2.close (in PoolablePreparedStatement) which returns stmt2 to the statement pool. Stmt2.passivate() gets called, setting the _closed flag to true.&lt;/p&gt;

&lt;p&gt;3. Application forgets all about stmt4&lt;/p&gt;

&lt;p&gt;4. Later, application calls conn.prepareStatement (with same SQL) again. The result is the old MySQL PreparedStatement (stmt1) wrapped in the old PoolablePreparedStatement (stmt2) wrapped in new DelegatingPreparedStatement stmt5 wrapped in new DelegatingPreparedStatement stmt6.  Stmt2.activate() gets called, setting the _closed flag to false.&lt;/p&gt;

&lt;p&gt;5. Now, garbage collection gets run, and stmt4 gets gc&apos;d. stmt4.finalize() calls stmt4.close() which calls stmt3.close() which calls stmt2.close(). Since stmt2 is not closed any more (_closed was just set to false above), it gets closed and returned to the pool.&lt;/p&gt;

&lt;p&gt;6. Applications calls something in stmt6, which ends up in stmt2, and stmt2.checkOpen() throws exception java.sql.SQLException: org.apache.commons.dbcp2.PoolablePreparedStatement with address: &quot;com.mysql.jdbc.ServerPreparedStatement&lt;span class=&quot;error&quot;&gt;&amp;#91;12&amp;#93;&lt;/span&gt; - select 1&quot; is closed.&lt;/p&gt;

&lt;p&gt;PoolGuardConnectionWrapper prevents the application from accidentally calling stmt4.close() later again, but this doesn&apos;t prevent the finalizer.... DBCP 1.4 did not have any finalizers, so it doesn&apos;t have this bug. &lt;/p&gt;

&lt;p&gt;I guess DelegatingStatement.close() should check isClosed(), and in the finally block, also do setDelegate(null) (like PoolGuardConnectionWrapper does), to make sure the delegate (which might be in active use by someone else) can never get called via this DelegatingStatement again (although most methods in DelegatingStatement start with checkOpen(), not all of them do!).&lt;/p&gt;</description>
                <environment>&lt;p&gt;DBCP 2.0&lt;/p&gt;</environment>
        <key id="12707932">DBCP-414</key>
            <summary>PoolablePreparedStatement can get closed while it&apos;s being used</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="peronen">Pasi Eronen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Apr 2014 12:54:05 +0000</created>
                <updated>Wed, 24 May 2017 07:30:14 +0000</updated>
                            <resolved>Wed, 23 Apr 2014 11:25:33 +0000</resolved>
                                    <version>2.0</version>
                                    <fixVersion>2.0.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13970043" author="psteitz" created="Tue, 15 Apr 2014 20:46:19 +0000"  >&lt;p&gt;See comments on the duplicate issue, &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-415&quot; title=&quot;Pooled PreparedStatements may be closed when accessed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-415&quot;&gt;&lt;del&gt;DBCP-415&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13972024" author="psteitz" created="Wed, 16 Apr 2014 22:17:45 +0000"  >&lt;p&gt;I think the analysis in the bug description is correct.  In r1588087, I changed DelegatingStatement close to null the delegate reference and no-op on close.  All tests pass now.  Leaving open for now, pending review.&lt;/p&gt;</comment>
                            <comment id="13974631" author="psteitz" created="Fri, 18 Apr 2014 23:28:33 +0000"  >&lt;p&gt;Test committed in r1588592 verifying that DelegatingStatement close does not re-close wrapped PPS.  Per comments in the description, DBCP itself did not expose this bug prior to 2.0.  The changes for &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-180&quot; title=&quot;[dbcp] Dbcp doesn&amp;#39;t meet JDBC specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-180&quot;&gt;&lt;del&gt;DBCP-180&lt;/del&gt;&lt;/a&gt; exposed it.&lt;/p&gt;

&lt;p&gt;Thanks, Pasi, for the report and analysis.&lt;/p&gt;</comment>
                            <comment id="13978081" author="markt" created="Wed, 23 Apr 2014 11:25:33 +0000"  >&lt;p&gt;Fix looks good to me.&lt;/p&gt;</comment>
                            <comment id="16021145" author="tmielke" created="Tue, 23 May 2017 12:44:42 +0000"  >&lt;p&gt;Apologies for commenting on this old bug but is someone able to clarify if this bug would likely also exist on version 1.4? &lt;br/&gt;
I understand it was raised against version 2.0 and wonder if this could also show up on 1.4...&lt;/p&gt;

&lt;p&gt;Any feedback is highly appreciated.&lt;/p&gt;</comment>
                            <comment id="16021465" author="psteitz" created="Tue, 23 May 2017 16:54:15 +0000"  >&lt;p&gt;Torsten - not likely this bug.  The issue documented on this ticket was (we think) a regression introduced in 2.0.&lt;/p&gt;</comment>
                            <comment id="16022452" author="tmielke" created="Wed, 24 May 2017 07:30:14 +0000"  >&lt;p&gt;Many thanks for confirming Phil!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12708122">DBCP-415</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>386255</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 25 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ujgf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>386520</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>