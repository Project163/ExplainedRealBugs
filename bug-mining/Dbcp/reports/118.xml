<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:48:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-415] Pooled PreparedStatements may be closed when accessed</title>
                <link>https://issues.apache.org/jira/browse/DBCP-415</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;Under high concurrency, connections using pooled PreparedStatements may encounter SQLExceptions with messages of the form &quot;org.apache.commons.dbcp2.PoolablePreparedStatement with address: &apos;quoted SQL&apos; is closed.&quot;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12708122">DBCP-415</key>
            <summary>Pooled PreparedStatements may be closed when accessed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="psteitz">Phil Steitz</reporter>
                        <labels>
                    </labels>
                <created>Sun, 13 Apr 2014 06:09:12 +0000</created>
                <updated>Tue, 15 Apr 2014 20:45:16 +0000</updated>
                            <resolved>Tue, 15 Apr 2014 20:45:16 +0000</resolved>
                                    <version>2.0</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13967745" author="psteitz" created="Sun, 13 Apr 2014 06:18:36 +0000"  >&lt;p&gt;Test case (commented out) added to TestPStmtPoolingBasicDataSource  in r1586926 to illustrate this bug.  I think this is likely a regression due to the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-180&quot; title=&quot;[dbcp] Dbcp doesn&amp;#39;t meet JDBC specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-180&quot;&gt;&lt;del&gt;DBCP-180&lt;/del&gt;&lt;/a&gt;.  &lt;/p&gt;</comment>
                            <comment id="13967930" author="psteitz" created="Sun, 13 Apr 2014 19:57:31 +0000"  >&lt;p&gt;The test succeeds if I move the finalizer for DelegatingStatment to PoolablePreparedStatement (and to PoolableCalledStatement too).  I think that what is going on here is that PoolablePreparedStatements themselves wrap DelegatingStatements (created by their owning PoolingConnection&apos;s delegate) and we don&apos;t want these wrapped statements to be closed by finalizers.  Limiting close-by-finalizer to the PoolableXxxStatements themselves gets them returned to the pool and does not have this effect.&lt;/p&gt;</comment>
                            <comment id="13967995" author="sebb@apache.org" created="Mon, 14 Apr 2014 00:38:07 +0000"  >&lt;p&gt;I&apos;m seeing a different problem (I think).&lt;/p&gt;

&lt;p&gt;DelegatingPreparedStatement.executeQuery() calls getDelegate(). It looks like sometimes this returns a statement created in a different thread. This looks to be because it is using a PoolablePreparedStatement &lt;br/&gt;
This extends DelegatingPreparedStatement which extends DelegatingStatement which is not thread-safe; in particular the _closed flag is not volatile. However _stmt is also not synch, nor is _conn.&lt;br/&gt;
Ideally those two should be made final. Although there is a setDelegate() method it does not appear to be used.&lt;/p&gt;

&lt;p&gt;Setting all three volatile seems to reduce the number of failures, but does not solve the problem completely.&lt;/p&gt;</comment>
                            <comment id="13968045" author="psteitz" created="Mon, 14 Apr 2014 03:50:13 +0000"  >&lt;p&gt;@Sebb - I don&apos;t think that is actually a problem.  Only one thread at a time should have access to a given PoolingConnection at a time (else we have a &lt;span class=&quot;error&quot;&gt;&amp;#91;pool&amp;#93;&lt;/span&gt; problem, which I first thought this might be, but now think it is not).  As long as clients adhere to the pool contract (which I am pretty sure DBCP does and I know the test code does from DBCP standpoint - no retained references / use after connection close), there will be no concurrent access to a single PoolingConnection.  In addition to that protection, the PoolalePreparedStatements are accessed only through their PooledObject wrappers in the GKOP owned by the PoolingConnection that they belong to.  I could be wrong, but I am pretty sure that the problem here is the &quot;back door&quot; access to the DelegatingStatement via the finalizer.  I am -0 to the volatile changes, OK if they can be shown to have zero performance impact.&lt;/p&gt;</comment>
                            <comment id="13968749" author="sebb@apache.org" created="Mon, 14 Apr 2014 19:51:39 +0000"  >&lt;p&gt;OK, having thought some more I agree it&apos;s probably not the lack of synch within the class (though it would not do any harm to limit mutability).&lt;/p&gt;

&lt;p&gt;I still think we should document the thread safety of the various classes so end users know not to share statements etc between threads.&lt;/p&gt;

&lt;p&gt;Note that it is not only concurrent access that can cause a problem, the Java memory model means that synch. is needed to ensure safe publication of updates to mutable fields.&lt;/p&gt;

&lt;p&gt;We sh/could also point out in a general page that POOL takes special care to ensure safe publication of changes to mutable fields, which is why the instances can be shared via the pool.&lt;/p&gt;</comment>
                            <comment id="13969231" author="psteitz" created="Tue, 15 Apr 2014 05:01:55 +0000"  >&lt;p&gt;Returning to the actual issue here, I am not sure now I really get the need for the finalizer as described in the javadoc for DelegatingStatement#finalize.  When statement pooling is enabled the PoolableXxxStatements are strongly held by the statement pool in the allObjects maps under their keys, so I don&apos;t see how they end up garbage collected.  On the other hand, I can see why the close needs to be there on finalization if we want the auto-cleanup behavior asked for in &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-180&quot; title=&quot;[dbcp] Dbcp doesn&amp;#39;t meet JDBC specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-180&quot;&gt;&lt;del&gt;DBCP-180&lt;/del&gt;&lt;/a&gt;.  Unfortunately, IIUC what is going on here, the change that I suggested above will not trigger the close-on-GC behavior in general.  If we want both, we probably need to explicitly guard against the case where a DelegatingStatement is wrapped by a PoolableXxxStatement.  Could be I am missing something about the issue and fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-180&quot; title=&quot;[dbcp] Dbcp doesn&amp;#39;t meet JDBC specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-180&quot;&gt;&lt;del&gt;DBCP-180&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13969417" author="sebb@apache.org" created="Tue, 15 Apr 2014 10:34:59 +0000"  >&lt;p&gt;I think the PPS needs to be treated as the Statement to be finalised.&lt;br/&gt;
If it were a subclass of Statement rather than a wrapper &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;, it would not make sense to close the statement without closing the PPS - the statement is an intrinsic part of the PPS.&lt;br/&gt;
So I agree that allowing the DelegatingStatement (DS) to finalise itself seems wrong; only poolable object knows when it is no longer needed by the application.&lt;/p&gt;

&lt;p&gt;I think it might be useful to add some debugging to the various finalisers to see how the DS finaliser can run if its PPS has not been finalised - if indeed that is happening.&lt;/p&gt;

&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; this is an analogy, not a suggestion to change the code!&lt;/p&gt;</comment>
                            <comment id="13969700" author="psteitz" created="Tue, 15 Apr 2014 16:37:24 +0000"  >&lt;p&gt;The problem, if I understand the intent of &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-180&quot; title=&quot;[dbcp] Dbcp doesn&amp;#39;t meet JDBC specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-180&quot;&gt;&lt;del&gt;DBCP-180&lt;/del&gt;&lt;/a&gt; and the current code correctly, is that when statement pooling is not enabled, you do in fact need to clean up DelegatingStatements.  The one case where you do &lt;b&gt;not&lt;/b&gt; want to close-on-finalize is when the DelegatingStatement is wrapped by a PPS.  So it seems to me the safest thing to do is to find a way to guard on that condition.&lt;/p&gt;</comment>
                            <comment id="13969734" author="b.eckenfels" created="Tue, 15 Apr 2014 16:55:37 +0000"  >&lt;p&gt;Hmm, I am not sure I follow. When using a connection pool, no matter if it is caching prepared statements or not I would expect it to track statements and resultsets issued for a certain pooled connection. If you close that all dependend objects need to be closed or at least invalidated (ideally it should be configurable if a warning is issued or not).&lt;/p&gt;

&lt;p&gt;If this is done, then there is no need for finalizers on the dependend objects.&lt;/p&gt;

&lt;p&gt;For a connection you could have a finalizer, but I think a more natural way is to have a &quot;checkout timeout&quot; since this catches other problems as well. This also avoids the need for finalizers which are so evil - not only in this bug.&lt;/p&gt;</comment>
                            <comment id="13969745" author="psteitz" created="Tue, 15 Apr 2014 17:04:41 +0000"  >&lt;p&gt;@Bernd - I agree with you, which is why I participated in the multi-year punting of &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-180&quot; title=&quot;[dbcp] Dbcp doesn&amp;#39;t meet JDBC specification&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-180&quot;&gt;&lt;del&gt;DBCP-180&lt;/del&gt;&lt;/a&gt;.  Have a look at that issue, which explains why the finalizer is there (I think).&lt;/p&gt;</comment>
                            <comment id="13969970" author="peronen" created="Tue, 15 Apr 2014 19:38:08 +0000"  >&lt;p&gt;This seems to be the same issue as &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-414&quot; title=&quot;PoolablePreparedStatement can get closed while it&amp;#39;s being used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-414&quot;&gt;&lt;del&gt;DBCP-414&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13970040" author="psteitz" created="Tue, 15 Apr 2014 20:44:36 +0000"  >&lt;p&gt;Thanks, Pasi, you are correct.  I somehow missed that report before opening this one.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12707932">DBCP-414</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12708163">DBCP-416</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>386445</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 31 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ukmf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>386709</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>