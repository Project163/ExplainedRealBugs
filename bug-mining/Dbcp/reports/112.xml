<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:48:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-358] Equals implementations in DelegatingXxx classes are not symmetric</title>
                <link>https://issues.apache.org/jira/browse/DBCP-358</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;For reasons unclear to me, DelegatingConnection, DelegatingStatement, PoolGuardConnectionWrappers and other DBCP classes implement equals so that the wrapping class is considered equal to its innermost delegate JDBC object.  This makes equals asymmetric when applied to a wrapper and its wrapped JDBC object - wrapper.equals(delegate) returns true, but delegate.equals(wrapper) will in general return false.&lt;/p&gt;

&lt;p&gt;I am pretty sure that DBCP itself does not rely on this bugged behavior, so I am inclined to fix it, making equals an equivalence relation on wrapper instances, with two considered equal iff their innermost delegates are equal.  I can&apos;t imagine use cases where the bugged behavior is required.  Can anyone else?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12505732">DBCP-358</key>
            <summary>Equals implementations in DelegatingXxx classes are not symmetric</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="psteitz">Phil Steitz</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Apr 2011 22:14:29 +0000</created>
                <updated>Sat, 31 May 2014 04:13:05 +0000</updated>
                            <resolved>Tue, 4 Feb 2014 13:45:08 +0000</resolved>
                                    <version>1.2</version>
                    <version>1.2.2</version>
                    <version>1.3</version>
                    <version>1.4</version>
                                    <fixVersion>2.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13027957" author="joehni" created="Tue, 3 May 2011 00:32:08 +0000"  >&lt;p&gt;This behavior is unfortunately used in the PoolableManagedConnection w/ TransactionRegistry. When a new connection is created in the pool, the unwrapped connection is registered (and used as key in the internal WeakHashMap). Later on the wrapped connection is used to unregister again (or to lookup the XAResource as done in org.apache.commons.dbcp.managed.TestBasicManagedDataSource.testReallyClose()). As workaround it is possible to wrap the registered connection if it is not wrapped yet:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Index: src/java/org/apache/commons/dbcp/managed/TransactionRegistry.java
===================================================================
--- src/java/org/apache/commons/dbcp/managed/TransactionRegistry.java   (revision 1098813)
+++ src/java/org/apache/commons/dbcp/managed/TransactionRegistry.java   (working copy)
@@ -28,7 +28,9 @@
 import javax.transaction.TransactionManager;
 import javax.transaction.xa.XAResource;
 
+import org.apache.commons.dbcp.DelegatingConnection;
 
+
 /**
  * TransactionRegistry tracks Connections and XAResources in a transacted environment for a single XAConnectionFactory.
  * &amp;lt;/p&amp;gt;
@@ -62,7 +64,10 @@
     public synchronized void registerConnection(Connection connection, XAResource xaResource) {
         if (connection == null) throw new NullPointerException(&quot;connection is null&quot;);
         if (xaResource == null) throw new NullPointerException(&quot;xaResource is null&quot;);
-        xaResources.put(connection, xaResource);
+        Connection key = connection instanceof DelegatingConnection 
+            ? connection 
+            : new DelegatingConnection(connection);
+        xaResources.put(key, xaResource);
     }
 
     /**
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This approach will also solve &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-356&quot; title=&quot;ManagedDataSource doesn&amp;#39;t work with an active transaction in progress on IBM JDK 6+&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-356&quot;&gt;&lt;del&gt;DBCP-356&lt;/del&gt;&lt;/a&gt; (another workaround is to use a HasMap instead of a WeakHashMap for the XAResources).&lt;/p&gt;</comment>
                            <comment id="13027967" author="joehni" created="Tue, 3 May 2011 00:44:21 +0000"  >&lt;p&gt;Thinking about it ... if I create a &lt;b&gt;temporary&lt;/b&gt; connection instance and use it as key in a WeakHashMap, it does not make too much sense either. OTOH, if I use an unwrapped connection as key that is also part of the WeakHashMap&apos;s value (the xaResource), the WeakHashMap is also useless. So, what do we try to solve with the WeakHashMap for the XAResources here?&lt;/p&gt;</comment>
                            <comment id="13832463" author="balazs.zsoldos" created="Tue, 26 Nov 2013 10:11:37 +0000"  >&lt;p&gt;Would be nice to fix this issue in a way that equals and hashcode does not use innermost.&lt;/p&gt;

&lt;p&gt;A short example why a programmer feels the current behavior is a bug::&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Connection conn1 = dataSource.getConnection();
conn1.close();
Connection conn2 = dataSource.getConnection();
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (conn2.equals(conn1) &amp;amp;&amp;amp; conn1.isClosed() != conn2.isClosed()) {
    &lt;span class=&quot;code-comment&quot;&gt;// Oops they are equal but one of them is closed but the other is not
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13890611" author="markt" created="Tue, 4 Feb 2014 12:28:06 +0000"  >&lt;p&gt;I have a great deal of sympathy with the point that Balazs makes above. I intend to explore removing the custom equals and hashcode methods entirely. I know that this is going to break a bunch of tests. What I need to look at is whether the tests are just testing for the current behaviour or whether - like TransactionRegistry - the implementation actually depends on the current behaviour. Assuming it is the former, I&apos;ll change the tests. If it is the latter, I&apos;ll have to see what options I&apos;m left with.&lt;/p&gt;

&lt;p&gt;Regarding the TransactionRegistry, there is going to have to be a hack of some form somewhere. My preferred approach at the moment is to make getInnermostDelegateInternal() public but make it clear in the Javadoc that it is not part of the API. What I like about this is that it becomes very clear that the code that depends on the innermost delegate rather than having a dependency on an equals implementation several hops away. This should also provide a route to change any other code that depends on the current equals and hashcode behaviour.&lt;/p&gt;</comment>
                            <comment id="13890676" author="markt" created="Tue, 4 Feb 2014 13:45:08 +0000"  >&lt;p&gt;This can&apos;t be fixed prior to 2.0 because it requires API changes. It has been fixed in 2.0 onwards.&lt;/p&gt;

&lt;p&gt;The equals() implementations of the DelegatingXxx classes are now symmetric.&lt;br/&gt;
There are some important API changes underlying this fix:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;two DelegatingXxx instances are no longer considered equal if they have the same innermost delegate;&lt;/li&gt;
	&lt;li&gt;a DelegatingXxx instance is not considered equal to its innermost delegate;&lt;/li&gt;
	&lt;li&gt;the getInnermostDelegateInternal() method has been made public (but remains part of the internal API) to allow classes extending this implementation to access the innermost delegate when required.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12444651">DBCP-317</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12502264">DBCP-356</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>114632</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 41 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ftwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>90442</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>