<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:47:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-294] Memory leak in XA Implementation</title>
                <link>https://issues.apache.org/jira/browse/DBCP-294</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;Hello,&lt;br/&gt;
We are been using Ofbiz with DBCP based implementation.&lt;br/&gt;
Ofbiz uses a Head revision of DBCP (package org.apache.commons.dbcp.managed is the same as current TRUNK) and geronimo-transaction-1.0.&lt;/p&gt;

&lt;p&gt;We are having recurrent OutOfMemory which occur on a 2 days basis.&lt;br/&gt;
I analyzed the Heap Dump and I think have found the source of the problem:&lt;br/&gt;
The Heap Dump shows a Retained Heap of 400Mo by org.apache.commons.dbcp.managed.TransactionRegistry#xaResources field.&lt;/p&gt;

&lt;p&gt;After analyzing more deeply, the leak seems to come from what is stored in xaResources through&lt;br/&gt;
xaResources.put(connection, xaResource);&lt;/p&gt;

&lt;p&gt;Values inside weak Hash map  will never be removed since XAResource holds a STRONG reference on key (connection) through:&lt;br/&gt;
org.apache.commons.dbcp.managed.LocalXAConnectionFactory$LocalXAResource through:&lt;br/&gt;
public LocalXAResource(Connection localTransaction) &lt;/p&gt;
{
            this.connection = localTransaction;
        }


&lt;p&gt;Found in WeakHashMap javadoc:&lt;br/&gt;
Implementation note: The value objects in a WeakHashMap are held by ordinary strong references. &amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;Thus care should be taken to ensure that value objects do not strongly refer to their own keys &amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;, either directly or indirectly, since that will prevent the keys from being discarded. Note that a value object may refer indirectly to its key via the WeakHashMap itself; that is, a value object may strongly refer to some other key object whose associated value object, in turn, strongly refers to the key of the first value object. One way to deal with this is to wrap values themselves within WeakReferences before inserting, as in: m.put(key, new WeakReference(value)), and then unwrapping upon each get. &lt;/p&gt;

&lt;p&gt;Philippe Mouawad&lt;br/&gt;
&lt;a href=&quot;http://www.ubik-ingenierie.com&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.ubik-ingenierie.com&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;JDK5, Oracle 10G,Postgres 8.x&lt;/p&gt;</environment>
        <key id="12427743">DBCP-294</key>
            <summary>Memory leak in XA Implementation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="psteitz">Phil Steitz</assignee>
                                    <reporter username="pmouawad">Philippe Mouawad</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Jun 2009 13:47:54 +0000</created>
                <updated>Mon, 15 Feb 2010 02:22:02 +0000</updated>
                            <resolved>Sun, 25 Oct 2009 16:28:21 +0000</resolved>
                                    <version>1.3</version>
                    <version>1.4</version>
                    <version>2.0</version>
                                    <fixVersion>1.3</fixVersion>
                                        <due></due>
                            <votes>5</votes>
                                    <watches>5</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="187200">52h</timeoriginalestimate>
                            <timeestimate seconds="187200">52h</timeestimate>
                                        <comments>
                            <comment id="12718978" author="pmouawad" created="Fri, 12 Jun 2009 21:06:08 +0000"  >&lt;p&gt;Please find attached a patch to TransactionRegistry.&lt;br/&gt;
The idea is to unregister connection instead of relying on WeakHashMap release.&lt;br/&gt;
Release will be done by PoolableManagedConnection#reallyClose()&lt;/p&gt;

&lt;p&gt;Philippe Mouawad&lt;br/&gt;
&lt;a href=&quot;http://www.ubik-ingenierie.com&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.ubik-ingenierie.com&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12719267" author="pmouawad" created="Sun, 14 Jun 2009 14:08:15 +0000"  >&lt;p&gt;After investigating more deeply I understood what was happening.&lt;/p&gt;

&lt;p&gt;1) In Ofbiz configuration the DBCP evictor Thread is configured.&lt;br/&gt;
2) When that thread runs, it kills down idle connection =&amp;gt; THIS IS THE PROBLEM&lt;br/&gt;
3) TransactionRegistry holds a through LocalXAResource a reference on a connection created by DriverConnectionFactory&lt;br/&gt;
4) When evictor kill down a PoolableConnection calling reallyClose(), the underlying JDBC connection does not unregister from TransactionRegistry#xaResources provoking the leak.&lt;/p&gt;

&lt;p&gt;I send a TestCase that reproduces the bug, here necessary elements:&lt;br/&gt;
Script for Postgres:&lt;/p&gt;

&lt;p&gt;CREATE TABLE cb_memory_monitoring_info&quot;(&lt;br/&gt;
mmi_id int8 PRIMARY KEY not null,&lt;br/&gt;
mmi_console_id varchar not null,&lt;br/&gt;
mmi_name varchar not null,&lt;br/&gt;
mmi_date timestamp not null,&lt;br/&gt;
mmi_value int4)&lt;/p&gt;


&lt;p&gt;Run TestBug with:&lt;br/&gt;
-Dcom.sun.management.jmxremote -Xmx4m -Xms4m -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=C:/temp&lt;/p&gt;

&lt;p&gt;It will generate a heapDump after some seconds, look a TransactionRegistry#xaResources size, it will be around 110 elements&lt;/p&gt;


&lt;p&gt;Then run TestBugPatch with:&lt;br/&gt;
-Dcom.sun.management.jmxremote -Xmx4m -Xms4m -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=C:/temp&lt;/p&gt;

&lt;p&gt;It will never run out of memory, TransactionRegistry#xaResources never grows over &lt;/p&gt;

&lt;p&gt;Philippe Mouawad&lt;br/&gt;
&lt;a href=&quot;http://www.ubik-ingenierie.com&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.ubik-ingenierie.com&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12719268" author="pmouawad" created="Sun, 14 Jun 2009 14:09:29 +0000"  >&lt;p&gt;Implementations of PoolableConnectionFactory and PoolableConnection that work well with managed connections SOLVING the OOM&lt;/p&gt;</comment>
                            <comment id="12719269" author="pmouawad" created="Sun, 14 Jun 2009 14:16:05 +0000"  >&lt;p&gt;Test case&lt;/p&gt;</comment>
                            <comment id="12719275" author="pmouawad" created="Sun, 14 Jun 2009 15:07:03 +0000"  >&lt;p&gt;Moved implementations to org.apache.commons.dbcp.managed&lt;/p&gt;</comment>
                            <comment id="12719277" author="pmouawad" created="Sun, 14 Jun 2009 15:10:11 +0000"  >&lt;p&gt;Patch to TransactionRegistry&lt;/p&gt;</comment>
                            <comment id="12719278" author="pmouawad" created="Sun, 14 Jun 2009 15:12:56 +0000"  >&lt;p&gt;Cleanup some code&lt;/p&gt;</comment>
                            <comment id="12719279" author="psteitz" created="Sun, 14 Jun 2009 15:27:41 +0000"  >&lt;p&gt;Thanks for reporting this.  Reviewing the patch, setting fix version to 1.3&lt;/p&gt;</comment>
                            <comment id="12719306" author="pmouawad" created="Sun, 14 Jun 2009 17:22:43 +0000"  >&lt;p&gt;One more precision, in a previous comment I said that problem was due mainly to Evictor Thread.&lt;br/&gt;
The problem will occur even if Evictor Thread does not run aggressively, in fact each time Commons-pool destroy a PoolableConnection (call to reallyClose()) (which may occur outside of Evictor Thread depending on idle management configuration), this destroyed connection will generate a leak.&lt;/p&gt;

&lt;p&gt;Philippe Mouawad&lt;br/&gt;
&lt;a href=&quot;http://www.ubik-ingenierie.com&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.ubik-ingenierie.com&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12724822" author="pmouawad" created="Sat, 27 Jun 2009 08:34:09 +0000"  >&lt;p&gt;Memory image of Production server.&lt;br/&gt;
4 days of run. &lt;br/&gt;
Around the point 3800 patch was put in production.&lt;br/&gt;
You can see that memory leak is solved.&lt;/p&gt;

&lt;p&gt;Philippe Mouawad&lt;br/&gt;
&lt;a href=&quot;http://www.ubik-ingenierie.com&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.ubik-ingenierie.com&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12769832" author="psteitz" created="Sun, 25 Oct 2009 16:28:21 +0000"  >&lt;p&gt;Applied the patch with the following changes/additions:&lt;/p&gt;

&lt;p&gt;1) Modified BasicDataSource to allow BasicManagedDataSource to use PoolableManagedConnectionFactory&lt;br/&gt;
2) Added a &quot;full&quot; constructor for PMCF so BasicManagedDataSource properties can be set&lt;br/&gt;
3) Made initializeConnection protected in PCF and added call to this in PMCF#makeObject()&lt;br/&gt;
4) Modified PoolableManagedConnection constructor to not ignore abandonedConfig parameter&lt;br/&gt;
4) Added a test case demonstrating the bug&lt;/p&gt;

&lt;p&gt;Thanks for the patch!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12410576" name="PoolableManagedConnection.java" size="1128" author="pmouawad" created="Sun, 14 Jun 2009 15:07:03 +0000"/>
                            <attachment id="12410577" name="PoolableManagedConnectionFactory.java" size="1991" author="pmouawad" created="Sun, 14 Jun 2009 15:07:03 +0000"/>
                            <attachment id="12410580" name="Test.zip" size="661292" author="pmouawad" created="Sun, 14 Jun 2009 15:12:56 +0000"/>
                            <attachment id="12410579" name="TransactionRegistry-patch.txt" size="1220" author="pmouawad" created="Sun, 14 Jun 2009 15:10:11 +0000"/>
                            <attachment id="12411981" name="memory.png" size="6214" author="pmouawad" created="Sat, 27 Jun 2009 08:34:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>114571</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 4 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0uv9r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>178207</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>