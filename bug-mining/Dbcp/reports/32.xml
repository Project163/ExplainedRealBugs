<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:47:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-269] final jdbc connection never closed --&gt; number of connections grows</title>
                <link>https://issues.apache.org/jira/browse/DBCP-269</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;Using DBCP parameters:&lt;/p&gt;

&lt;p&gt;    JdbcDriver  com.mysql.jdbc.Driver&lt;br/&gt;
    JdbcUrl     jdbc:mysql://localhost:3307/dbcp?cacheResultsetMetadata=true&lt;br/&gt;
    UserName    dbcp&lt;br/&gt;
    Password    dbcp&lt;br/&gt;
    InitialSize 5&lt;br/&gt;
    MaxActive 8&lt;br/&gt;
    MaxWait -1&lt;br/&gt;
    TestOnBorrow false&lt;br/&gt;
    TestOnReturn false&lt;br/&gt;
    PoolPreparedStatements true&lt;br/&gt;
    MaxOpenPreparedStatements 10&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;TimeBetweenEvictionRunsMillis 20000&lt;/li&gt;
	&lt;li&gt;MinEvictableIdleTimeMillis 30000&lt;/li&gt;
	&lt;li&gt;NumTestsPerEvictionRun 3&lt;/li&gt;
	&lt;li&gt;TestWhileIdle false&lt;br/&gt;
    MinIdle 2&lt;br/&gt;
    MaxIdle 5&lt;br/&gt;
    DefaultTransactionIsolation 1&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;provides strange behaviour. &lt;br/&gt;
The testcase is simple:&lt;br/&gt;
                @Test&lt;br/&gt;
                public void testMaxIdle() throws Exception {&lt;br/&gt;
                               int MAX_ACTIVE = 8;&lt;br/&gt;
                               List&amp;lt;Connection&amp;gt; connectionList = new ArrayList&amp;lt;Connection&amp;gt;();&lt;br/&gt;
                               int i = 0;&lt;br/&gt;
                               DataSource dataSource = ...; // retrieve the datasource&lt;br/&gt;
                               Assert.assertNotNull(dataSource);&lt;/p&gt;

&lt;p&gt;                               System.out.println(&quot;*** Getting all connections ...&quot;);&lt;br/&gt;
                               for (i = 0; i &amp;lt; MAX_ACTIVE; i++) &lt;/p&gt;
{
                                               System.out.println(&quot;get connection &quot; + (i + 1));
                                               Connection con = dataSource.getConnection();
                                               Assert.assertNotNull(con);
                                               connectionList.add(con);
                               }&lt;br/&gt;
&lt;br/&gt;
                               i = 0;&lt;br/&gt;
                               System.out.println(&quot;*** Releasing all connections ...&quot;);&lt;br/&gt;
                               for (Iterator&amp;lt;Connection&amp;gt; iterator = connectionList.iterator(); iterator.hasNext()&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; {
                                               Connection connection = (Connection) iterator.next();
                                               System.out.println(&quot;close connection &quot; + (++i));
                                               connection.close();
                                               iterator.remove();
                               }&lt;br/&gt;
&lt;br/&gt;
                               i = 0;&lt;br/&gt;
                               System.out.println(&quot;*** Getting all + X connections ...&quot;);&lt;br/&gt;
                               for (i = 0; i &amp;lt; (MAX_ACTIVE + 1); i++) {                                               System.out.println(&quot;get connection &quot; + (i + 1));                                               Connection con = dataSource.getConnection();                                               Assert.assertNotNull(con);                                               connectionList.add(con);                               }

&lt;p&gt;                }&lt;/p&gt;

&lt;p&gt;First of all, after initialization, the number of real database connections established is 6 instead of 5. This due to the &quot;protected synchronized DataSource createDataSource&quot; method of the BasicDataSource object because of the validation of the ConnectionFactory. The &quot;validateConnectionFactory&quot; method creates a new jdbc connection and destroy it at the end. Nonetheless, the underlying database connection is not really closed.&lt;/p&gt;

&lt;p&gt;At the end of the above test case, we should not have more than 8 connections but we have in fact 12 of them (8 + 1 for validation + 3 because DBCP wants to close extra connection MAX_ACTIVE - MAX_IDLE). In fact, those 3 connections are not really closed.&lt;/p&gt;

&lt;p&gt;Please find attached a patch correcting this bug. This is due to the method isClosed() of the DelegatingConnection. From my point of view, the implementation of the method should be:&lt;/p&gt;

&lt;p&gt;  public boolean isClosed() throws SQLException {&lt;br/&gt;
         if(_closed &amp;amp;&amp;amp; _conn.isClosed()) &lt;/p&gt;
{ // Instead of if(_closed || _conn.isClosed())
             return true;
         }
&lt;p&gt;         return false;&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;From my understanding, a connection is considered as closed if and only if one of the connection chain is closed (OR in the test). But, if I&apos;m write the _closed flag of the delegating connection is set to true during the passivation. So, after returning to the pool, a connection can not be closed. The isClosed method is really important because it&apos;s used indirectly by the reallyClose method of a PoolableConnection.&lt;/p&gt;

&lt;p&gt;The behaviour is much more impressive if the evict thread of the configuration is activated because, with a testcase that simply wait after getting the datasource initialized (Thread.currentThread().sleep(600000)&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; you will see database connections growing.&lt;/p&gt;

&lt;p&gt;Finally, after applying the given patch, I faced some problems regarding DBCP TestCases:&lt;br/&gt;
In some test cases, you have a test method&lt;br/&gt;
    public void testClose() throws Exception &lt;/p&gt;
{
        ds.setAccessToUnderlyingConnectionAllowed(true);

                [...]

        // raw idle connection should now be closed
        // FIXME should be assertTrue
        assertFalse(rawIdleConnection.isClosed());

                [...]

        // both wrapper and raw active connection should be closed
        assertTrue(activeConnection.isClosed());
        assertTrue(rawActiveConnection.isClosed());
    }

&lt;p&gt;From my point of view and regarding the comment the assertFalse(rawIdleConnection.isClosed()); sould become assertTrue(rawIdleConnection.isClosed());.&lt;/p&gt;

&lt;p&gt;Moreover, the next test method fails.&lt;br/&gt;
    // Bugzilla Bug 28251:  Returning dead database connections to BasicDataSource&lt;br/&gt;
    // isClosed() failure blocks returning a connection to the pool &lt;br/&gt;
    public void testIsClosedFailure() throws SQLException {&lt;br/&gt;
        ds.setAccessToUnderlyingConnectionAllowed(true);&lt;br/&gt;
        Connection conn = ds.getConnection();&lt;br/&gt;
        assertNotNull(conn);&lt;br/&gt;
        assertEquals(1, ds.getNumActive());&lt;/p&gt;

&lt;p&gt;        // set an IO failure causing the isClosed mathod to fail&lt;br/&gt;
        TesterConnection tconn = (TesterConnection) ((DelegatingConnection)conn).getInnermostDelegate();&lt;br/&gt;
        tconn.setFailure(new IOException(&quot;network error&quot;));&lt;/p&gt;

&lt;p&gt;        try &lt;/p&gt;
{
            conn.close();
            fail(&quot;Expected SQLException&quot;);
        }
&lt;p&gt;        catch(SQLException ex) { }&lt;/p&gt;

&lt;p&gt;        assertEquals(0, ds.getNumActive());&lt;br/&gt;
    }&lt;br/&gt;
But again, looking at the AddObjectToPool of the GenericObjectPool (commons-pool), the IOException(&quot;Network error&quot;) is catch during the passivation. It implies that the underlying connection (in error) is not returned to the pool. It will be re-created by the evict thread if minIdle property is set.&lt;br/&gt;
Am I wrong ?&lt;/p&gt;

&lt;p&gt;Sorry for the little long post.&lt;br/&gt;
Kind regards,&lt;br/&gt;
Jean-Louis MONTEIRO&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows, JDK 5&lt;/p&gt;</environment>
        <key id="12398152">DBCP-269</key>
            <summary>final jdbc connection never closed --&gt; number of connections grows</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dain">Dain Sundstrom</assignee>
                                    <reporter username="jlmonteiro">Jean-Louis Monteiro</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Jun 2008 09:23:26 +0000</created>
                <updated>Mon, 16 Jun 2008 20:26:51 +0000</updated>
                            <resolved>Mon, 16 Jun 2008 20:26:51 +0000</resolved>
                                    <version>1.3</version>
                    <version>1.4</version>
                    <version>Nightly Builds</version>
                                    <fixVersion>1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12605402" author="dain" created="Mon, 16 Jun 2008 20:26:51 +0000"  >&lt;p&gt;I didn&apos;t use the patch as is.  Instead of changing the behavior of the proxy, I changed the close logic to inspect the underlying connection to determine if the proxy should be returned to the pool or destroyed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12383900" name="patch.txt" size="726" author="jlmonteiro" created="Thu, 12 Jun 2008 09:26:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>114547</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            17 years, 23 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0uvyn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>178319</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>