<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:47:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-352] Repeated calls to getMetadata in a transaction leads to performance degredation</title>
                <link>https://issues.apache.org/jira/browse/DBCP-352</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;During long-running transactions that utilize conditional logic based on the database metadata, it is possible to get thousands of calls to Connection.getMetaData.  An ArrayList is built up containing objects which are never removed (this is the cause of &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-330&quot; title=&quot;Calling getMetaData() without closing the connection lead to a memory leak&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-330&quot;&gt;&lt;del&gt;DBCP-330&lt;/del&gt;&lt;/a&gt;).  However, the array is shared with all other PreparedStatements, so the array scan and modification time keeps rising as the transaction progresses.&lt;/p&gt;

&lt;p&gt;I will attempt to attach an Eclipse project; profiling (or even a few JStacks) will show that most of the time is spent scanning the cluttered and growing array for objects to remove.&lt;/p&gt;</description>
                <environment>&lt;p&gt;PostgreSQL, MySQL, JDK 1.6&lt;/p&gt;</environment>
        <key id="12497342">DBCP-352</key>
            <summary>Repeated calls to getMetadata in a transaction leads to performance degredation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="derekhulley">Derek Hulley</reporter>
                        <labels>
                    </labels>
                <created>Tue, 1 Feb 2011 14:45:21 +0000</created>
                <updated>Tue, 24 Feb 2015 03:23:05 +0000</updated>
                            <resolved>Sat, 23 Apr 2011 23:57:05 +0000</resolved>
                                    <version>1.2.2</version>
                    <version>1.3.1</version>
                    <version>1.4</version>
                                    <fixVersion>1.3.1</fixVersion>
                    <fixVersion>1.4.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12989225" author="derekhulley" created="Tue, 1 Feb 2011 14:51:41 +0000"  >&lt;p&gt;Requires table:&lt;br/&gt;
   CREATE TABLE dbcp_test( val integer NOT NULL );&lt;/p&gt;

&lt;p&gt;Example arguments:&lt;br/&gt;
jdbc:postgresql://localhost:5432/dbcptest&lt;br/&gt;
test&lt;br/&gt;
test&lt;br/&gt;
10000&lt;/p&gt;

&lt;p&gt;Crank up the getMetaData calls and profile.  Once you&apos;ve hit 100K getMetaData calls, things start looking really bad; CPU usage suffers.&lt;/p&gt;</comment>
                            <comment id="12989226" author="ggregory@seagullsw.com" created="Tue, 1 Feb 2011 14:52:31 +0000"  >&lt;p&gt;If you can make your example use an H2 (or any) in-memory database, it will be easier to reproduce and test for anyone. I suppose Derby would do the trick as well but I know from experience that H2 works great for standalone unit tests.&lt;/p&gt;</comment>
                            <comment id="12989236" author="psteitz" created="Tue, 1 Feb 2011 15:16:21 +0000"  >&lt;p&gt;The fix that I suggested for &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-330&quot; title=&quot;Calling getMetaData() without closing the connection lead to a memory leak&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-330&quot;&gt;&lt;del&gt;DBCP-330&lt;/del&gt;&lt;/a&gt; should resolve this as well.  I would appreciate review and comments on the fix proposed there.&lt;/p&gt;</comment>
                            <comment id="12989596" author="derekhulley" created="Wed, 2 Feb 2011 10:59:57 +0000"  >&lt;p&gt;The table is deliberately simple, so use your database of choice.  I&apos;m not convinced that using an in-memory DB is the solution given that the test is designed to scale up to hundreds of thousands of insertions; it&apos;s probably better just to piggy back off a real DB.&lt;/p&gt;</comment>
                            <comment id="12989597" author="derekhulley" created="Wed, 2 Feb 2011 11:00:38 +0000"  >&lt;p&gt;Phil&apos;s suggested fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-330&quot; title=&quot;Calling getMetaData() without closing the connection lead to a memory leak&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-330&quot;&gt;&lt;del&gt;DBCP-330&lt;/del&gt;&lt;/a&gt; will also address this problem.&lt;/p&gt;</comment>
                            <comment id="12993012" author="derekhulley" created="Thu, 10 Feb 2011 11:26:01 +0000"  >&lt;p&gt;Patch diff&lt;/p&gt;</comment>
                            <comment id="12993013" author="derekhulley" created="Thu, 10 Feb 2011 11:29:14 +0000"  >&lt;p&gt;Results of running DBCPMetadataTest before and after applying trivial patch:&lt;/p&gt;

&lt;p&gt;Before:&lt;/p&gt;

&lt;p&gt;Found table dbcp_test&lt;br/&gt;
Inserted 5000 rows with average of 0ms per row.  Issued 0 metadata queries per insert.&lt;br/&gt;
Inserted 10000 rows with average of 0ms per row.  Issued 0 metadata queries per insert.&lt;br/&gt;
Inserted 5000 rows with average of 2ms per row.  Issued 5 metadata queries per insert.&lt;br/&gt;
Inserted 10000 rows with average of 1ms per row.  Issued 5 metadata queries per insert.&lt;br/&gt;
Inserted 5000 rows with average of 5ms per row.  Issued 10 metadata queries per insert.&lt;br/&gt;
Inserted 10000 rows with average of 2ms per row.  Issued 10 metadata queries per insert.&lt;br/&gt;
Inserted 5000 rows with average of 8ms per row.  Issued 15 metadata queries per insert.&lt;br/&gt;
Inserted 10000 rows with average of 4ms per row.  Issued 15 metadata queries per insert.&lt;br/&gt;
Inserted 5000 rows with average of 11ms per row.  Issued 20 metadata queries per insert.&lt;br/&gt;
Inserted 10000 rows with average of 5ms per row.  Issued 20 metadata queries per insert.&lt;/p&gt;

&lt;p&gt;After:&lt;/p&gt;

&lt;p&gt;Found table dbcp_test&lt;br/&gt;
Inserted 5000 rows with average of 0ms per row.  Issued 0 metadata queries per insert.&lt;br/&gt;
Inserted 10000 rows with average of 0ms per row.  Issued 0 metadata queries per insert.&lt;br/&gt;
Inserted 5000 rows with average of 0ms per row.  Issued 5 metadata queries per insert.&lt;br/&gt;
Inserted 10000 rows with average of 0ms per row.  Issued 5 metadata queries per insert.&lt;br/&gt;
Inserted 5000 rows with average of 0ms per row.  Issued 10 metadata queries per insert.&lt;br/&gt;
Inserted 10000 rows with average of 0ms per row.  Issued 10 metadata queries per insert.&lt;br/&gt;
Inserted 5000 rows with average of 0ms per row.  Issued 15 metadata queries per insert.&lt;br/&gt;
Inserted 10000 rows with average of 0ms per row.  Issued 15 metadata queries per insert.&lt;br/&gt;
Inserted 5000 rows with average of 0ms per row.  Issued 20 metadata queries per insert.&lt;br/&gt;
Inserted 10000 rows with average of 0ms per row.  Issued 20 metadata queries per insert.&lt;/p&gt;

&lt;p&gt;As is evident, the overhead of getMetadata() calls has disappeared.  The &quot;memory leak&quot; will have gone, too.&lt;br/&gt;
Similar results are obtained for other unit tests with long-running transactions.&lt;/p&gt;</comment>
                            <comment id="13023619" author="psteitz" created="Sat, 23 Apr 2011 23:57:05 +0000"  >&lt;p&gt;Fixed in trunk (r1096260) and 1_4 branch (r1096259).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12462025">DBCP-330</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12469928" name="DBCPMetadataTest.zip" size="400289" author="derekhulley" created="Tue, 1 Feb 2011 14:51:41 +0000"/>
                            <attachment id="12470770" name="commons-dbcp-1.4-patched.diff" size="664" author="derekhulley" created="Thu, 10 Feb 2011 11:26:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>114626</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 30 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0tj13:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>170392</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>