<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:47:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-369] Exception when using SharedPoolDataSource concurrently</title>
                <link>https://issues.apache.org/jira/browse/DBCP-369</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I get a ConcurrentModificationException when using instances of SharedPoolDataSource concurrently. The problem occurs when one thread calls setDataSourceName() while another thread calls close(), either on the same instance of SharedPoolDataSource or on different instances. I&apos;ll attach a short example program that leads to an exception for almost every run on my machine.&lt;/p&gt;

&lt;p&gt;The cause of the exception seems to be in InstanceKeyObjectFactory. registerNewInstance() is synchronized, but removeInstance() isn&apos;t. This allows concurrent accesses to the non-thread-safe &apos;instanceMap&apos;.&lt;/p&gt;

&lt;p&gt;Is this a bug? Or are SharedPoolDataSource and InstanceKeyObjectFactory not supposed to be thread-safe?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;


&lt;p&gt;import java.util.ArrayList;&lt;br/&gt;
import org.apache.commons.dbcp.datasources.SharedPoolDataSource;&lt;/p&gt;

&lt;p&gt;public class SharedPoolDataSourceTest {&lt;/p&gt;

&lt;p&gt;	public static void main(String[] args) &lt;/p&gt;
{
		new SharedPoolDataSourceTest().run();
	}

&lt;p&gt;	private void run() {&lt;br/&gt;
		final ArrayList&amp;lt;SharedPoolDataSource&amp;gt; dataSources = new ArrayList&amp;lt;SharedPoolDataSource&amp;gt;();&lt;br/&gt;
		for (int j = 0; j &amp;lt; 10000; j++) &lt;/p&gt;
{
			SharedPoolDataSource dataSource = new SharedPoolDataSource();
			dataSources.add(dataSource);
		}

&lt;p&gt;		Thread t1 = new Thread(new Runnable() {&lt;br/&gt;
			public void run() {&lt;br/&gt;
				for (SharedPoolDataSource dataSource : dataSources) &lt;/p&gt;
{
					dataSource.setDataSourceName(&quot;a&quot;);	
				}
&lt;p&gt;					&lt;br/&gt;
			}&lt;br/&gt;
		});&lt;br/&gt;
		Thread t2 = new Thread(new Runnable() {&lt;br/&gt;
			public void run() {&lt;br/&gt;
				for (SharedPoolDataSource dataSource : dataSources) {&lt;br/&gt;
					try &lt;/p&gt;
{ dataSource.close(); }
&lt;p&gt; catch (Exception e) {}	&lt;br/&gt;
				}&lt;/p&gt;

&lt;p&gt;			}&lt;br/&gt;
		});&lt;br/&gt;
		t1.start();&lt;br/&gt;
		t2.start();&lt;br/&gt;
		try &lt;/p&gt;
{
			t1.join();
			t2.join();
		}
&lt;p&gt; catch (InterruptedException ie) {}&lt;br/&gt;
	}	&lt;br/&gt;
}&lt;/p&gt;



&lt;p&gt;Exception in thread &quot;Thread-0&quot; java.util.ConcurrentModificationException&lt;br/&gt;
	at java.util.HashMap$HashIterator.nextEntry(HashMap.java:793)&lt;br/&gt;
	at java.util.HashMap$KeyIterator.next(HashMap.java:828)&lt;br/&gt;
	at org.apache.commons.dbcp.datasources.InstanceKeyObjectFactory.registerNewInstance(InstanceKeyObjectFactory.java:51)&lt;br/&gt;
	at org.apache.commons.dbcp.datasources.InstanceKeyDataSource.setDataSourceName(InstanceKeyDataSource.java:246)&lt;br/&gt;
	at potentialBugs.SharedPoolDataSourceTest$1.run(SharedPoolDataSourceTest.java:23)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;/p&gt;</description>
                <environment>&lt;p&gt;Java Hotspot Server VM 1.6.0_07, Linux&lt;/p&gt;</environment>
        <key id="12526807">DBCP-369</key>
            <summary>Exception when using SharedPoolDataSource concurrently</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="michaelpradel">Michael Pradel</reporter>
                        <labels>
                    </labels>
                <created>Wed, 12 Oct 2011 07:34:13 +0000</created>
                <updated>Sat, 31 May 2014 04:09:55 +0000</updated>
                            <resolved>Thu, 30 Jan 2014 21:56:42 +0000</resolved>
                                    <version>1.4</version>
                                    <fixVersion>1.5.1</fixVersion>
                    <fixVersion>2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13492426" author="tn" created="Wed, 7 Nov 2012 15:29:29 +0000"  >&lt;p&gt;The access to the InstanceKeyObjectFactory is not fully synchronized. Some methods (registerNewInstance) were already synchronized, while others (removeInstance, closeAll) not.&lt;/p&gt;

&lt;p&gt;This lead to the ConcurrentModificationExceptions when multiple threads try to modify the internal instanceMap.&lt;/p&gt;

&lt;p&gt;The attached patch adds a unit test and fixes the problem by synchronizing all public/protected methods in the factory that modify / access the instanceMap.&lt;/p&gt;</comment>
                            <comment id="13887121" author="markt" created="Thu, 30 Jan 2014 21:56:42 +0000"  >&lt;p&gt;Thanks for the report and the test case. Sorry it has taken so long to address this.&lt;/p&gt;

&lt;p&gt;I&apos;ve fixed trunk for the 2.x series the 1.5.x branch. It will be included in the next release of each.&lt;/p&gt;

&lt;p&gt;If there are further 1.3.x and 1.4.x releases (currently being discussed on the dev mailing list) my expectation is that they will be generated from the 1.5.x branch so will pick up this fix too.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12552478" name="DBCP-369.patch" size="3236" author="tn" created="Wed, 7 Nov 2012 15:29:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>73864</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 42 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ftuv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>90435</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>