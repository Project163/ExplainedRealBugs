<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:48:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-372] Statement Leak occurs when batch update is used.</title>
                <link>https://issues.apache.org/jira/browse/DBCP-372</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;org.apache.commons.dbcp.PoolablePreparedStatement#passivate()&lt;br/&gt;
execute clearBatch().&lt;br/&gt;
(&lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-264&quot; title=&quot;clear batch when closing statement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-264&quot;&gt;&lt;del&gt;DBCP-264&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;But this clearBatch() throw SQLException.&lt;br/&gt;
(DelegatingStatement#checkOpen() throw SQLException, because _closed is true.)&lt;/p&gt;

&lt;p&gt;The result,&lt;br/&gt;
the PoolablePreparedStatement doesn&apos;t return to pool, and&lt;br/&gt;
the PoolablePreparedStatement doesn&apos;t execute PreparedStatement#close().&lt;/p&gt;

&lt;p&gt;When a lot of data is processed, &lt;br/&gt;
in the case of Oracle&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;ORA-00604&lt;/li&gt;
	&lt;li&gt;ORA-01000&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;occurs.&lt;/p&gt;


&lt;p&gt;Proposal:&lt;br/&gt;
&quot;clearBatch();&quot; in passivate() method&lt;br/&gt;
changes as follows.&lt;/p&gt;

&lt;p&gt;batchAdded = false;&lt;br/&gt;
getInnermostDelegate().clearBatch();&lt;/p&gt;</description>
                <environment>&lt;p&gt;Oracle 11g&lt;/p&gt;</environment>
        <key id="12533878">DBCP-372</key>
            <summary>Statement Leak occurs when batch update is used.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="taromaru">Naozumi Taromaru</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 Dec 2011 13:10:08 +0000</created>
                <updated>Tue, 24 Feb 2015 03:23:15 +0000</updated>
                            <resolved>Mon, 3 Feb 2014 23:20:33 +0000</resolved>
                                    <version>1.3</version>
                    <version>1.4</version>
                                    <fixVersion>1.5.1</fixVersion>
                    <fixVersion>2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13492454" author="tn" created="Wed, 7 Nov 2012 16:06:08 +0000"  >&lt;p&gt;Indeed, the current passivate method in PoolablePreparedStatement does the following:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    public void passivate() throws SQLException {
        _closed = true;
        if(_conn != null) {
            _conn.removeTrace(this);
        }

        // The JDBC spec requires that a statement closes any open
        // ResultSet&apos;s when it is closed.
        // FIXME The PreparedStatement we&apos;re wrapping should handle this for us.
        // See bug 17301 for what could happen when ResultSets are closed twice.
        List&amp;lt;AbandonedTrace&amp;gt; resultSets = getTrace();
        if( resultSets != null) {
            ResultSet[] set = resultSets.toArray(new ResultSet[resultSets.size()]);
            for (int i = 0; i &amp;lt; set.length; i++) {
                set[i].close();
            }
            clearTrace();
        }
        if (batchAdded) {
            clearBatch();
        }
        
        super.passivate();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thus, indicating that the connection is closed first, and then afterwards trying to clear any batches. Now the clearBatch method throws an exception if the connection is already marked as closed.&lt;/p&gt;

&lt;p&gt;Imho, the suggested fix would be fine, but we could also change the passivate method to call clearBatch before setting _closed to true.&lt;/p&gt;</comment>
                            <comment id="13614103" author="psteitz" created="Tue, 26 Mar 2013 15:14:19 +0000"  >&lt;p&gt;Any other comments / suggestions on this?  It might also be good to wrap and swallow SQLException per the first patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-264&quot; title=&quot;clear batch when closing statement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DBCP-264&quot;&gt;&lt;del&gt;DBCP-264&lt;/del&gt;&lt;/a&gt; (along with Thomas&apos; suggested changes).&lt;/p&gt;</comment>
                            <comment id="13890096" author="markt" created="Mon, 3 Feb 2014 23:20:33 +0000"  >&lt;p&gt;Thanks for the report and the fix. Sorry it has taken so long to address this.&lt;/p&gt;

&lt;p&gt;I think, based on my testing, that the statement leak has been fixed by changes to Pool but that prior to this fix the problem manifested itself as the PreparedStatement always being invalidated on return to the pool (making the pooling of statements pointless) if batchUpdate() was used.&lt;/p&gt;

&lt;p&gt;I&apos;ve fixed trunk for the 2.x series the 1.5.x branch. It will be included in the next release of each.&lt;/p&gt;

&lt;p&gt;If there are further 1.3.x and 1.4.x releases (currently being discussed on the dev mailing list) my expectation is that they will be generated from the 1.5.x branch so will pick up this fix too.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12638779">DBCP-397</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12638779">DBCP-397</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12682395">DBCP-407</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>219604</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 41 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ftun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>90434</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>