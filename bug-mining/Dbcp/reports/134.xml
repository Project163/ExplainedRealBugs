<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:48:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-438] Nested connections in a transaction (local) throws null pointer</title>
                <link>https://issues.apache.org/jira/browse/DBCP-438</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;In a transaction context, if we open multiple connections and close each of them after commit, we get a null pointer exception. Sample code:&lt;br/&gt;
		transactionManager.begin();&lt;/p&gt;

&lt;p&gt;		Connection c1 = null;&lt;br/&gt;
		Connection c2 = null;&lt;/p&gt;

&lt;p&gt;		c1 = newConnection();&lt;br/&gt;
		c2 = newConnection();&lt;/p&gt;

&lt;p&gt;		transactionManager.commit();&lt;/p&gt;

&lt;p&gt;		try&lt;/p&gt;
{
			c1.close();
		}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
			e.printStackTrace();
		}

&lt;p&gt;		try&lt;/p&gt;
{
			c2.close();
		}
&lt;p&gt;catch(Exception e)&lt;/p&gt;
{
			//throws execption
			e.printStackTrace();
		}

&lt;p&gt;Null pointer is thrown at:&lt;br/&gt;
org.apache.commons.dbcp2.DelegatingConnection.closeInternal&lt;/p&gt;

&lt;p&gt;Affects versions-- 2.1, 2.0&lt;/p&gt;</description>
                <environment>&lt;p&gt;All (linux, aix, windows)&lt;/p&gt;</environment>
        <key id="12826266">DBCP-438</key>
            <summary>Nested connections in a transaction (local) throws null pointer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="raihan">Raihan Kibria</reporter>
                        <labels>
                    </labels>
                <created>Thu, 30 Apr 2015 10:23:45 +0000</created>
                <updated>Sat, 16 Jul 2016 00:55:27 +0000</updated>
                            <resolved>Sun, 19 Jul 2015 23:23:56 +0000</resolved>
                                    <version>2.0</version>
                    <version>2.1</version>
                                    <fixVersion>2.1.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14521288" author="raihan" created="Thu, 30 Apr 2015 10:28:30 +0000"  >&lt;p&gt;The file can be tested as it is in maven test;&lt;/p&gt;

&lt;p&gt;location:&lt;br/&gt;
src\test\java\org\apache\commons\dbcp2\managed&lt;/p&gt;

&lt;p&gt;In the console you will see the null pointer exception stacktrace.&lt;/p&gt;</comment>
                            <comment id="14521293" author="raihan" created="Thu, 30 Apr 2015 10:34:06 +0000"  >&lt;p&gt;This stack trace is from version 2.1&lt;/p&gt;</comment>
                            <comment id="14521304" author="adrianc@hlmksw.com" created="Thu, 30 Apr 2015 10:42:44 +0000"  >&lt;p&gt;We are having a similar problem in OFBiz:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/OFBIZ-6218&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/OFBIZ-6218&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;DBCP 2 v 2.1&lt;/p&gt;</comment>
                            <comment id="14522732" author="psteitz" created="Fri, 1 May 2015 03:56:17 +0000"  >&lt;p&gt;Thanks for reporting this and extra thanks for the test case.  I think the problem is likely in the updateTransactionStatus method in ManagedConnection.  &lt;/p&gt;</comment>
                            <comment id="14522739" author="psteitz" created="Fri, 1 May 2015 04:06:34 +0000"  >&lt;p&gt;A quick fix that would eliminate the NPE would be to just have DelegatingConnection#closeInternal null-check _conn.  But we should verify correctness of the logic in MC updateTransactionStatus.&lt;/p&gt;</comment>
                            <comment id="14623849" author="psteitz" created="Sun, 12 Jul 2015 15:23:52 +0000"  >&lt;p&gt;Adding the null check to DelegatingConnection#closeInternal  fixes the reported issue here (and is probably not a bad idea in any case), but I suspect that what is really going on here is that we don&apos;t correctly support the use case in the example.  I am not a JTA expert, so could use some help reviewing the code in ManagedConnection.  It looks to me like the code in this example triggers incorrect (at least incomprehensible to me) behavior in ManagedConnection#updateTransactionStatus.  Looks to me like the first connection will get closed and returned to the pool when the second one is opened.   &lt;/p&gt;</comment>
                            <comment id="14624180" author="raihan" created="Mon, 13 Jul 2015 04:14:48 +0000"  >&lt;p&gt;Our production system is running smoothly after we added the null-pointer check in the code. We configured DBCP as DataSource to run on a J2EE app-server as a separate war. The EJBs from different applications are using the DBCP data-source to get connection. The only way we could overcome the NPE was to add the null-pointer check in the source code of DBCP iteself. Handling the exception in the calling apps does not work because of different domains (exception does not get propagated to the calling apps). I wish I could help, but I am not an expert on JTA. I will need a lot of time to study the correctness of the code.&lt;/p&gt;
</comment>
                            <comment id="14632958" author="psteitz" created="Sun, 19 Jul 2015 23:23:56 +0000"  >&lt;p&gt;Null check added to DelegatingConnection#close  in r1691861.&lt;/p&gt;</comment>
                            <comment id="15380389" author="lagar84" created="Sat, 16 Jul 2016 00:55:27 +0000"  >&lt;p&gt;I am getting nullpointer also on method isClosed. Did this received the null check? I guess its related to #446&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/DBCP-446&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/DBCP-446&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12729461" name="TestManagedDataSourceInNesetedConnTx.java" size="2137" author="raihan" created="Thu, 30 Apr 2015 10:28:30 +0000"/>
                            <attachment id="12729462" name="dbcpNull.png" size="101701" author="raihan" created="Thu, 30 Apr 2015 10:34:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 18 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2e4uf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>