<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:47:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-272] Contention for DriverManager when initializing multiple datasources </title>
                <link>https://issues.apache.org/jira/browse/DBCP-272</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;This issue has been discussed in the commons user&apos;s mailing list between myself, Simon Kitching and Phil Steitz. &lt;/p&gt;

&lt;p&gt;In summary:&lt;/p&gt;

&lt;p&gt;I have a webapp deployed in tomcat containing 3 pooled datasources which are managed by Spring. The webapp starts up OK and is immediately hit by a load of a few hundred requests a second. It seems to handle a few hundred request and then just locks up entirely and stops responding entirely. Attached is a stack trace obtained by doing kill -3 when in this state. After discussion on the mailing list I changed the datasources to be non-lazy initialised in spring but the issue still occurs. &lt;/p&gt;

&lt;p&gt;Simon Kitching said:&lt;br/&gt;
&quot;The first thread is trying to initialise a postgresql driver and register it with DriverManager. The driver registration is being triggered from a static initialiser block on the postgresql driver class, so is executing from within the Class.forName method (and therefore the postgresql driver Class object is locked by this thread).&lt;/p&gt;

&lt;p&gt;The second thread is trying to initialise a mysql driver and register it with DriverManager. Again, the driver registration is being triggered from a static initialiser block on the mysql driver class, so the mysql driver Class object is locked by this thread).&lt;/p&gt;

&lt;p&gt;But in both cases, the DriverManager needs to be initialised before anything can be registered. The first thread appears to have run first, triggering the initialisation process, and the second thread is blocked waiting for initialisation of DriverManager to complete before it registers the mysql driver. &lt;/p&gt;

&lt;p&gt;&amp;lt;snip/&amp;gt;&lt;/p&gt;

&lt;p&gt;Possibly dbcp should call DriverManager.getDrivers() internally on startup to avoid this race... &quot;&lt;/p&gt;


</description>
                <environment>&lt;p&gt;Java HotSpot(TM) 64-Bit Server VM (1.6.0-b105 mixed mode) on Linux&lt;/p&gt;</environment>
        <key id="12399369">DBCP-272</key>
            <summary>Contention for DriverManager when initializing multiple datasources </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="adrianw">Adrian Woodhead</reporter>
                        <labels>
                    </labels>
                <created>Tue, 1 Jul 2008 13:51:14 +0000</created>
                <updated>Mon, 15 Feb 2010 02:34:40 +0000</updated>
                            <resolved>Wed, 18 Feb 2009 18:31:23 +0000</resolved>
                                    <version>1.2.2</version>
                                    <fixVersion>1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12612006" author="adrianw" created="Wed, 9 Jul 2008 11:44:22 +0000"  >&lt;p&gt;This is the thread dump obtained by doing a &quot;kill -3&quot; on the tomcat process when in the stuck state soon after startup.&lt;/p&gt;</comment>
                            <comment id="12612202" author="adrianw" created="Wed, 9 Jul 2008 17:46:14 +0000"  >&lt;p&gt;Interestingly, we tried to replace the DBCP connection pool with c3p0. We did not mark the datasources as lazy-init in spring. c3p0 exhibited very similar behaviour to dbcp, what is does better is that it actually detects the deadlock itself and outputs some useful information related to this It seems it also blocks in DirverManager.registerDriver and in doing the Class.forName step:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2008-07-09 17:31:24&amp;#93;&lt;/span&gt; WARN (com.mchange.v2.async.ThreadPoolAsynchronousRunner:608) - com.mchange.v2.async.ThreadPoolAsynchronousRunner$DeadlockDetector@2cec4462 &amp;#8211; APPARENT DEADLOCK!!! Creating emergency threads for unassigned pending tasks!&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2008-07-09 17:31:24&amp;#93;&lt;/span&gt; WARN (com.mchange.v2.async.ThreadPoolAsynchronousRunner:624) - com.mchange.v2.async.ThreadPoolAsynchronousRunner$DeadlockDetector@2cec4462 &amp;#8211; APPARENT DEADLOCK!!! Complete Status: &lt;br/&gt;
	Managed Threads: 3&lt;br/&gt;
	Active Threads: 3&lt;br/&gt;
	Active Tasks: &lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool$AcquireTask@21bf4c80 (com.mchange.v2.async.ThreadPoolAsynchronousRunner$PoolThread-#0)&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool$AcquireTask@163778cf (com.mchange.v2.async.ThreadPoolAsynchronousRunner$PoolThread-#1)&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool$AcquireTask@13dc696e (com.mchange.v2.async.ThreadPoolAsynchronousRunner$PoolThread-#2)&lt;br/&gt;
	Pending Tasks: &lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool$AcquireTask@6b8dbef1&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool$AcquireTask@26f2f761&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool$AcquireTask@194f1541&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool$AcquireTask@16fc6b62&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool$AcquireTask@15edfab8&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool$AcquireTask@3ae75147&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool$AcquireTask@28892a87&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool$AcquireTask@454719db&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool$AcquireTask@3ef29c65&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool$AcquireTask@29f9cb2c&lt;br/&gt;
Pool thread stack traces:&lt;br/&gt;
	Thread&lt;a href=&quot;#0,5,main&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;com.mchange.v2.async.ThreadPoolAsynchronousRunner$PoolThread-#0,5,main&lt;/a&gt;&lt;br/&gt;
		java.sql.DriverManager.registerDriver(DriverManager.java:280)&lt;br/&gt;
		com.mysql.jdbc.Driver.&amp;lt;clinit&amp;gt;(Driver.java:62)&lt;br/&gt;
		java.lang.Class.forName0(Native Method)&lt;br/&gt;
		java.lang.Class.forName(Class.java:169)&lt;br/&gt;
		com.mchange.v2.c3p0.DriverManagerDataSource.ensureDriverLoaded(DriverManagerDataSource.java:100)&lt;br/&gt;
		com.mchange.v2.c3p0.DriverManagerDataSource.getConnection(DriverManagerDataSource.java:132)&lt;br/&gt;
		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:182)&lt;br/&gt;
		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:171)&lt;br/&gt;
		com.mchange.v2.c3p0.impl.C3P0PooledConnectionPool$1PooledConnectionResourcePoolManager.acquireResource(C3P0PooledConnectionPool.java:137)&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool.doAcquire(BasicResourcePool.java:1014)&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool.access$800(BasicResourcePool.java:32)&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool$AcquireTask.run(BasicResourcePool.java:1810)&lt;br/&gt;
		com.mchange.v2.async.ThreadPoolAsynchronousRunner$PoolThread.run(ThreadPoolAsynchronousRunner.java:547)&lt;br/&gt;
	Thread&lt;a href=&quot;#1,5,main&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;com.mchange.v2.async.ThreadPoolAsynchronousRunner$PoolThread-#1,5,main&lt;/a&gt;&lt;br/&gt;
		java.lang.Class.forName0(Native Method)&lt;br/&gt;
		java.lang.Class.forName(Class.java:169)&lt;br/&gt;
		com.mchange.v2.c3p0.DriverManagerDataSource.ensureDriverLoaded(DriverManagerDataSource.java:100)&lt;br/&gt;
		com.mchange.v2.c3p0.DriverManagerDataSource.getConnection(DriverManagerDataSource.java:132)&lt;br/&gt;
		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:182)&lt;br/&gt;
		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:171)&lt;br/&gt;
		com.mchange.v2.c3p0.impl.C3P0PooledConnectionPool$1PooledConnectionResourcePoolManager.acquireResource(C3P0PooledConnectionPool.java:137)&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool.doAcquire(BasicResourcePool.java:1014)&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool.access$800(BasicResourcePool.java:32)&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool$AcquireTask.run(BasicResourcePool.java:1810)&lt;br/&gt;
		com.mchange.v2.async.ThreadPoolAsynchronousRunner$PoolThread.run(ThreadPoolAsynchronousRunner.java:547)&lt;br/&gt;
	Thread&lt;a href=&quot;#2,5,main&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;com.mchange.v2.async.ThreadPoolAsynchronousRunner$PoolThread-#2,5,main&lt;/a&gt;&lt;br/&gt;
		java.lang.Class.forName0(Native Method)&lt;br/&gt;
		java.lang.Class.forName(Class.java:169)&lt;br/&gt;
		com.mchange.v2.c3p0.DriverManagerDataSource.ensureDriverLoaded(DriverManagerDataSource.java:100)&lt;br/&gt;
		com.mchange.v2.c3p0.DriverManagerDataSource.getConnection(DriverManagerDataSource.java:132)&lt;br/&gt;
		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:182)&lt;br/&gt;
		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:171)&lt;br/&gt;
		com.mchange.v2.c3p0.impl.C3P0PooledConnectionPool$1PooledConnectionResourcePoolManager.acquireResource(C3P0PooledConnectionPool.java:137)&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool.doAcquire(BasicResourcePool.java:1014)&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool.access$800(BasicResourcePool.java:32)&lt;br/&gt;
		com.mchange.v2.resourcepool.BasicResourcePool$AcquireTask.run(BasicResourcePool.java:1810)&lt;br/&gt;
		com.mchange.v2.async.ThreadPoolAsynchronousRunner$PoolThread.run(ThreadPoolAsynchronousRunner.java:547)&lt;/p&gt;</comment>
                            <comment id="12674725" author="markt" created="Wed, 18 Feb 2009 18:31:23 +0000"  >&lt;p&gt;We can never truly fix this since the way drivers are expected to register with the DriverManager is asking for a deadlock to occur in multi-thread environments. Yuck.&lt;/p&gt;

&lt;p&gt;What we can do is attempt to prevent this in environments where only DBCP is used. I have applied a patch that calls DriverManager.getDrivers() to force initialisation before we ever do anything that might use Class.forName() to load (and register) a JDBC driver. This should prevent this deadlock occurring. Any feedback from testing in your environment would be appreciated.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12385621" name="catalina.out.stuck2" size="939919" author="adrianw" created="Wed, 9 Jul 2008 11:44:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>114550</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 40 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0uycf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>178705</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>