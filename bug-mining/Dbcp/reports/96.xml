<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:47:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-376] Thread safety issue</title>
                <link>https://issues.apache.org/jira/browse/DBCP-376</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;Under high load commons-dbcp (or commons-pool) exhibits thread safety issues and begins throwing various exceptions. I don&apos;t yet know the cause of the issue but it looks like a connection maybe handed out to multiple threads concurrently. Here&apos;s a few examples of the exceptions we are getting:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;jvm 1    | Caused by: java.sql.SQLException: Attempted to use PooledConnection after closed() was called.
jvm 1    |      at org.apache.commons.dbcp.cpdsadapter.PooledConnectionImpl.assertOpen(PooledConnectionImpl.java:163)
jvm 1    |      at org.apache.commons.dbcp.cpdsadapter.PooledConnectionImpl.getConnection(PooledConnectionImpl.java:174)
jvm 1    |      at org.apache.commons.dbcp.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:768)
jvm 1    |      at org.apache.commons.dbcp.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:676)
jvm 1    |      at uk.co.webessence.kernel.database.DriverAdapterConnectionPool.acquireConnection(DriverAdapterConnectionPool.java:101)
jvm 1    |      ... 94 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;jvm 1    | Caused by: java.sql.SQLException: PooledConnection was reused, withoutits previous Connection being closed.
jvm 1    |      at org.apache.commons.dbcp.cpdsadapter.PooledConnectionImpl.getConnection(PooledConnectionImpl.java:179)
jvm 1    |      at org.apache.commons.dbcp.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:768)
jvm 1    |      at org.apache.commons.dbcp.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:676)
jvm 1    |      at uk.co.webessence.kernel.database.DriverAdapterConnectionPool.acquireConnection(DriverAdapterConnectionPool.java:101)
jvm 1    |      ... 77 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;jvm 1    | Caused by: java.sql.SQLException: Invalid state, the ResultSet object is closed.
jvm 1    |      at net.sourceforge.jtds.jdbc.JtdsResultSet.checkOpen(JtdsResultSet.java:299)
jvm 1    |      at net.sourceforge.jtds.jdbc.JtdsResultSet.getColumn(JtdsResultSet.java:273)
jvm 1    |      at net.sourceforge.jtds.jdbc.JtdsResultSet.getObject(JtdsResultSet.java:840)
jvm 1    |      at org.apache.commons.dbcp.DelegatingResultSet.getObject(DelegatingResultSet.java:325)
jvm 1    |      at uk.co.webessence.kernel.persistence.Preloader.getDataArray(Preloader.java:428)
jvm 1    |      at uk.co.webessence.kernel.persistence.Preloader.processSingleRow(Preloader.java:175)
jvm 1    |      at uk.co.webessence.kernel.persistence.PersistenceHandler.processRecordReload(PersistenceHandler.java:471)
jvm 1    |      at uk.co.webessence.kernel.persistence.PersistenceHandler$1.doLoad(PersistenceHandler.java:447)
jvm 1    |      ... 71 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Message:   TDS Protocol error: Invalid packet type 0x4
jvm 1    | Caused by: java.sql.SQLException: TDS Protocol error: Invalid packet type 0x4
jvm 1    |      at net.sourceforge.jtds.jdbc.TdsCore.nextToken(TdsCore.java:2314)
jvm 1    |      at net.sourceforge.jtds.jdbc.TdsCore.getNextRow(TdsCore.java:764)
jvm 1    |      at net.sourceforge.jtds.jdbc.JtdsResultSet.next(JtdsResultSet.java:593)
jvm 1    |      at org.apache.commons.dbcp.DelegatingResultSet.next(DelegatingResultSet.java:207)
jvm 1    |      at uk.co.webessence.kernel.persistence.Preloader.loadData(Preloader.java:142)
jvm 1    |      at uk.co.webessence.kernel.persistence.PersistenceHandler$3.doLoad(PersistenceHandler.java:592)
jvm 1    |      ... 111 more
jvm 1    | Caused by: net.sourceforge.jtds.jdbc.ProtocolException: Invalid packet type 0x4
jvm 1    |      at net.sourceforge.jtds.jdbc.TdsCore.nextToken(TdsCore.java:2301)
jvm 1    |      ... 116 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12539371">DBCP-376</key>
            <summary>Thread safety issue</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="dave@daveoxley.co.uk">Dave Oxley</reporter>
                        <labels>
                    </labels>
                <created>Mon, 23 Jan 2012 01:04:31 +0000</created>
                <updated>Wed, 25 Feb 2015 00:27:12 +0000</updated>
                            <resolved>Wed, 25 Feb 2015 00:27:12 +0000</resolved>
                                    <version>1.3</version>
                                    <fixVersion>1.5.1</fixVersion>
                    <fixVersion>2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13190843" author="dave@daveoxley.co.uk" created="Mon, 23 Jan 2012 01:13:55 +0000"  >&lt;p&gt;A sample application that recreates the issue. I&apos;ve found that after a few runs it stop reproducing the issue on Linux. Clearing the file cache makes reproduce the issue again:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;sudo sync &amp;amp;&amp;amp; echo 3 | sudo tee /proc/sys/vm/drop_caches
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here is an example of output from running the application:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Loading JDBC driver:
JDBC driver loaded succesfully
java.sql.SQLException: Attempted to use PooledConnection after closed() was called.
	at org.apache.commons.dbcp.cpdsadapter.PooledConnectionImpl.assertOpen(PooledConnectionImpl.java:163)
	at org.apache.commons.dbcp.cpdsadapter.PooledConnectionImpl.getConnection(PooledConnectionImpl.java:174)
	at org.apache.commons.dbcp.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:768)
	at org.apache.commons.dbcp.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:676)
	at com.daveoxley.dbcpbug.App$TestThread.run(App.java:140)
	at java.lang.Thread.run(Thread.java:662)

java.sql.SQLException: Attempted to use PooledConnection after closed() was called.
	at org.apache.commons.dbcp.cpdsadapter.PooledConnectionImpl.assertOpen(PooledConnectionImpl.java:163)
	at org.apache.commons.dbcp.cpdsadapter.PooledConnectionImpl.getConnection(PooledConnectionImpl.java:174)
	at org.apache.commons.dbcp.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:768)
	at org.apache.commons.dbcp.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:676)
	at com.daveoxley.dbcpbug.App$TestThread.run(App.java:140)
	at java.lang.Thread.run(Thread.java:662)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13191864" author="dave@daveoxley.co.uk" created="Tue, 24 Jan 2012 04:27:26 +0000"  >&lt;p&gt;I&apos;ve just recreated the same issue with snapshots of dbcp2 and pool2. Here is the output:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Loading JDBC driver:
JDBC driver loaded succesfully
INFO  - checkpointClose start
INFO  - checkpointClose end
CLOSING DOWN CONNECTION AS IT COULD NOT BE RETURNED TO THE POOL
java.sql.SQLException: PooledConnection was reused, withoutits previous Connection being closed.
	at org.apache.commons.dbcp2.cpdsadapter.PooledConnectionImpl.getConnection(PooledConnectionImpl.java:184)
	at org.apache.commons.dbcp2.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:778)
	at org.apache.commons.dbcp2.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:685)
	at com.daveoxley.dbcpbug.App$TestThread.run(App.java:143)
	at java.lang.Thread.run(Thread.java:662)

CLOSING DOWN CONNECTION AS IT COULD NOT BE RETURNED TO THE POOL
CLOSING DOWN CONNECTION AS IT COULD NOT BE RETURNED TO THE POOL
java.sql.SQLException: Attempted to use PooledConnection after closed() was called.
	at org.apache.commons.dbcp2.cpdsadapter.PooledConnectionImpl.assertOpen(PooledConnectionImpl.java:167)
	at org.apache.commons.dbcp2.cpdsadapter.PooledConnectionImpl.getConnection(PooledConnectionImpl.java:179)
	at org.apache.commons.dbcp2.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:778)
	at org.apache.commons.dbcp2.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:685)
	at com.daveoxley.dbcpbug.App$TestThread.run(App.java:143)
	at java.lang.Thread.run(Thread.java:662)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13193029" author="markt" created="Wed, 25 Jan 2012 13:36:58 +0000"  >&lt;p&gt;That the pooling implementation has been completely re-written between 1.x and 2.x yet the problem continues points to a problem in DBCP or the app.&lt;/p&gt;

&lt;p&gt;I&apos;ll try and take a look at this when I get some cycles but that might not be for a while. On the plus side, having the test case you provided should make investigating this a lot easier.&lt;/p&gt;</comment>
                            <comment id="13193072" author="wspeirs" created="Wed, 25 Jan 2012 14:53:28 +0000"  >&lt;p&gt;For what it&apos;s worth, all of the creating of the table and selects calls don&apos;t impact the issue. I&apos;ve stripped down the run method in the thread to the following and still get similar errors (SELECT_LOOPS = 5000):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run() {
            Connection c = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; j=0; j &amp;lt; SELECT_LOOPS; j++) {
                    c = ds.getConnection();

                    c.close();
                }
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (SQLException sqle) {
                handleException(sqle);
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Loading JDBC driver:
JDBC driver loaded succesfully
Exception in thread &quot;Thread-161&quot; java.lang.IllegalStateException: close() was called on a Connection, but I have no record of the underlying PooledConnection.
	at org.apache.commons.dbcp.datasources.KeyedCPDSConnectionFactory.connectionClosed(KeyedCPDSConnectionFactory.java:249)
	at org.apache.commons.dbcp.cpdsadapter.PooledConnectionImpl.notifyListeners(PooledConnectionImpl.java:229)
	at org.apache.commons.dbcp.cpdsadapter.ConnectionImpl.close(ConnectionImpl.java:78)
	at com.daveoxley.dbcpbug.App$TestThread.run(App.java:96)
	at java.lang.Thread.run(Thread.java:662)

Exception in thread &quot;Thread-143&quot; java.lang.IllegalStateException: close() was called on a Connection, but I have no record of the underlying PooledConnection.
	at org.apache.commons.dbcp.datasources.KeyedCPDSConnectionFactory.connectionClosed(KeyedCPDSConnectionFactory.java:249)
	at org.apache.commons.dbcp.cpdsadapter.PooledConnectionImpl.notifyListeners(PooledConnectionImpl.java:229)
	at org.apache.commons.dbcp.cpdsadapter.ConnectionImpl.close(ConnectionImpl.java:78)
	at com.daveoxley.dbcpbug.App$TestThread.run(App.java:96)
	at java.lang.Thread.run(Thread.java:662)

java.sql.SQLException: PooledConnection was reused, withoutits previous Connection being closed.
	at org.apache.commons.dbcp.cpdsadapter.PooledConnectionImpl.getConnection(PooledConnectionImpl.java:179)
	at org.apache.commons.dbcp.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:768)
	at org.apache.commons.dbcp.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:676)
	at com.daveoxley.dbcpbug.App$TestThread.run(App.java:94)
	at java.lang.Thread.run(Thread.java:662)

java.sql.SQLException: PooledConnection was reused, withoutits previous Connection being closed.
	at org.apache.commons.dbcp.cpdsadapter.PooledConnectionImpl.getConnection(PooledConnectionImpl.java:179)
	at org.apache.commons.dbcp.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:768)
	at org.apache.commons.dbcp.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:676)
	at com.daveoxley.dbcpbug.App$TestThread.run(App.java:94)
	at java.lang.Thread.run(Thread.java:662)

java.sql.SQLException: Attempted to use PooledConnection after closed() was called.
	at org.apache.commons.dbcp.cpdsadapter.PooledConnectionImpl.assertOpen(PooledConnectionImpl.java:163)
	at org.apache.commons.dbcp.cpdsadapter.PooledConnectionImpl.getConnection(PooledConnectionImpl.java:174)
	at org.apache.commons.dbcp.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:768)
	at org.apache.commons.dbcp.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:676)
	at com.daveoxley.dbcpbug.App$TestThread.run(App.java:94)
	at java.lang.Thread.run(Thread.java:662)

java.sql.SQLException: PooledConnection was reused, withoutits previous Connection being closed.
	at org.apache.commons.dbcp.cpdsadapter.PooledConnectionImpl.getConnection(PooledConnectionImpl.java:179)
	at org.apache.commons.dbcp.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:768)
	at org.apache.commons.dbcp.datasources.InstanceKeyDataSource.getConnection(InstanceKeyDataSource.java:676)
	at com.daveoxley.dbcpbug.App$TestThread.run(App.java:94)
	at java.lang.Thread.run(Thread.java:662)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13204257" author="dave@daveoxley.co.uk" created="Thu, 9 Feb 2012 05:04:45 +0000"  >&lt;p&gt;Attached patch fixes this issue by synchronising validatingMap and pcMap in KeyedCPDSConnectionFactory and CPDSConnectionFactory.&lt;/p&gt;</comment>
                            <comment id="13886621" author="markt" created="Thu, 30 Jan 2014 14:45:15 +0000"  >&lt;p&gt;Thanks for the report and test case. Sorry it has taken so long to fix this.&lt;/p&gt;

&lt;p&gt;A variation of the fix has been applied to trunk for 2.0 and to the 1.5.x branch. Assuming that the next 1.3.x and 1.4.x releases are auto generated from the 1.5.x branch they should pick up the fix too.&lt;/p&gt;

&lt;p&gt;I have also added a unit test, again based on your sample code.&lt;/p&gt;</comment>
                            <comment id="14335720" author="psteitz" created="Wed, 25 Feb 2015 00:27:05 +0000"  >&lt;p&gt;Should be resolved, but not closed (pending 1.4.1 release)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12513905" name="DBCP-376.diff" size="2588" author="dave@daveoxley.co.uk" created="Thu, 9 Feb 2012 05:04:45 +0000"/>
                            <attachment id="12511462" name="dbcp_bug.tar.gz" size="2739" author="dave@daveoxley.co.uk" created="Mon, 23 Jan 2012 01:13:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>224873</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 38 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0fttz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>90431</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>