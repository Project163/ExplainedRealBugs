<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:49:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DBCP-597]  Validation query not timing out on connections managed by SharedPoolDataSource</title>
                <link>https://issues.apache.org/jira/browse/DBCP-597</link>
                <project id="12310469" key="DBCP">Commons DBCP</project>
                    <description>&lt;p&gt;We are running a Java application that uses &lt;b&gt;org.apache.commons.dbcp2.datasources.SharedPoolDataSource&lt;/b&gt;&#160;to maintain a JDBC connection pool.&lt;/p&gt;

&lt;p&gt;In a recent database failover event, we noticed database validation queries were not timing out as expected, resulting in the application hanging and waiting indefinitely for a response from the database.&lt;/p&gt;

&lt;p&gt;The validation query and timeout were both explicitly set on the SharedPoolDataSource instance.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;ds = new SharedPoolDataSource();&lt;/p&gt;

&lt;p&gt;ds.setValidationQuery(&quot;SELECT 1&quot;)&lt;/p&gt;

&lt;p&gt;ds.setValidationQueryTimeout(5).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Upon diving a bit into the source code, we suspect the issue was caused by this code:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/commons-dbcp/blob/master/src/main/java/org/apache/commons/dbcp2/datasources/CPDSConnectionFactory.java#L465&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-dbcp/blob/master/src/main/java/org/apache/commons/dbcp2/datasources/CPDSConnectionFactory.java#L465&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; conn = pconn.getConnection();&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; stmt = conn.createStatement();&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; rset = stmt.executeQuery(validationQuery);&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; valid = rset.next();&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We noticed the &lt;em&gt;stmt&lt;/em&gt; statement object does not call setQueryTimeout() and the validation query seems to be executed with no timeout at all.&#160;&lt;/p&gt;

&lt;p&gt;Could you confirm that this is indeed a bug, not us missing some fundamental details? We would greatly appreciate a prompt resolution to this issue, thanks!&lt;/p&gt;</description>
                <environment></environment>
        <key id="13570610">DBCP-597</key>
            <summary> Validation query not timing out on connections managed by SharedPoolDataSource</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ggregory">Gary D. Gregory</assignee>
                                    <reporter username="xiaotianbai">Xiaotian Bai</reporter>
                        <labels>
                    </labels>
                <created>Mon, 4 Mar 2024 03:05:17 +0000</created>
                <updated>Sun, 15 Dec 2024 23:02:16 +0000</updated>
                            <resolved>Sun, 15 Dec 2024 14:46:25 +0000</resolved>
                                    <version>2.9.0</version>
                                    <fixVersion>2.13.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17823024" author="garydgregory" created="Mon, 4 Mar 2024 03:14:26 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xiaotianbai&quot; class=&quot;user-hover&quot; rel=&quot;xiaotianbai&quot;&gt;xiaotianbai&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thank you for reaching out.&lt;/p&gt;

&lt;p&gt;Would you please provide a failing unit test in order for us to reproduce this issue?&lt;/p&gt;

&lt;p&gt;This would be best as a PR on GitHub.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17823032" author="JIRAUSER304480" created="Mon, 4 Mar 2024 05:07:41 +0000"  >&lt;p&gt;A quick simple test would be&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SharedPoolDataSource ds = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SharedPoolDataSource();
ds.setValidationQuery(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT PG_SLEEP(10)&quot;&lt;/span&gt;);
ds.setValidationQueryTimeout(1);
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (Connection conn = ds.getConnection()){
    fail(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expected a timeout exception &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the database connection.&quot;&lt;/span&gt;); 
} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
  &#160;&lt;span class=&quot;code-comment&quot;&gt;// expected, &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; nothing 
&lt;/span&gt;}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I also tested this locally, the connection can be borrowed from the pool without an exception.&lt;/p&gt;</comment>
                            <comment id="17905808" author="JIRAUSER308107" created="Sun, 15 Dec 2024 14:16:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt; I have created a failing test based on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xiaotianbai&quot; class=&quot;user-hover&quot; rel=&quot;xiaotianbai&quot;&gt;xiaotianbai&lt;/a&gt; comments at &lt;a href=&quot;https://github.com/apache/commons-dbcp/pull/464.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-dbcp/pull/464.&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Please take a review and let me know if this is indeed a bug. I would like to take on this work but would like confirmation that it is a go-ahead. Thanks!&lt;/p&gt;</comment>
                            <comment id="17905812" author="garydgregory" created="Sun, 15 Dec 2024 14:46:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xiaotianbai&quot; class=&quot;user-hover&quot; rel=&quot;xiaotianbai&quot;&gt;xiaotianbai&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rajugupta&quot; class=&quot;user-hover&quot; rel=&quot;rajugupta&quot;&gt;rajugupta&lt;/a&gt;&lt;br/&gt;
This is fixed in git master for 2.13.1-SNAPSHOT, please verify.&lt;br/&gt;
This fix is also available in snapshot builds here: &lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="17905813" author="JIRAUSER308107" created="Sun, 15 Dec 2024 14:53:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt; &#160; I think I am using the 2.13.1-SNAPSHOT version. At least that&apos;s what the pom.xml file tells me&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13073478/13073478_image-2024-12-15-14-51-46-184.png&quot; height=&quot;104&quot; width=&quot;217&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I ran the test in this version and the tests have failed. Could you link the PR that fixes this behaviour ? Also, maybe you can run the CI pipelines to test the fix ? Thanks!&lt;/p&gt;</comment>
                            <comment id="17905814" author="JIRAUSER308107" created="Sun, 15 Dec 2024 14:59:03 +0000"  >&lt;p&gt;Got it. The issue has been fixed. Thanks a ton. &lt;a href=&quot;https://github.com/rajucomp/commons-dbcp/commit/7659d9e55f77a0633972f268a62f68dabb8ff5c5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rajucomp/commons-dbcp/commit/7659d9e55f77a0633972f268a62f68dabb8ff5c5&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17905846" author="garydgregory" created="Sun, 15 Dec 2024 23:02:16 +0000"  >&lt;p&gt;Note that &lt;font color=&quot;#de350b&quot;&gt;&lt;b&gt;&lt;tt&gt;PerUserPoolDataSource&lt;/tt&gt;&lt;/b&gt;&lt;/font&gt; suffered from the same issue.&lt;/p&gt;

&lt;p&gt;This is also now fixed in git master and snapshot builds here: &lt;a href=&quot;https://repository.apache.org/content/repositories/snapshots/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://repository.apache.org/content/repositories/snapshots/&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13073478" name="image-2024-12-15-14-51-46-184.png" size="79539" author="rajugupta" created="Sun, 15 Dec 2024 14:51:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>Java</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            46 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1nr20:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>