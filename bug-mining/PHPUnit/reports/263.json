{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/1351","repository_url":"https://api.github.com/repos/sebastianbergmann/phpunit","labels_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/1351/labels{/name}","comments_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/1351/comments","events_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/1351/events","html_url":"https://github.com/sebastianbergmann/phpunit/issues/1351","id":38676860,"node_id":"MDU6SXNzdWUzODY3Njg2MA==","number":1351,"title":"Process isolation TestResult contains serialized test class upon test failure/exception","user":{"login":"sun","id":41992,"node_id":"MDQ6VXNlcjQxOTky","avatar_url":"https://avatars.githubusercontent.com/u/41992?v=4","gravatar_id":"","url":"https://api.github.com/users/sun","html_url":"https://github.com/sun","followers_url":"https://api.github.com/users/sun/followers","following_url":"https://api.github.com/users/sun/following{/other_user}","gists_url":"https://api.github.com/users/sun/gists{/gist_id}","starred_url":"https://api.github.com/users/sun/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sun/subscriptions","organizations_url":"https://api.github.com/users/sun/orgs","repos_url":"https://api.github.com/users/sun/repos","events_url":"https://api.github.com/users/sun/events{/privacy}","received_events_url":"https://api.github.com/users/sun/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/milestones/2","html_url":"https://github.com/sebastianbergmann/phpunit/milestone/2","labels_url":"https://api.github.com/repos/sebastianbergmann/phpunit/milestones/2/labels","id":741672,"node_id":"MDk6TWlsZXN0b25lNzQxNjcy","number":2,"title":"PHPUnit 4.3","description":"Alpha: June 6, 2014 - August 8, 2014\r\nBeta: August 8, 2014 - October 3, 2014","creator":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":5,"state":"closed","created_at":"2014-08-04T06:51:49Z","updated_at":"2014-10-06T08:54:45Z","due_on":"2014-10-03T07:00:00Z","closed_at":"2014-10-03T12:18:03Z"},"comments":21,"created_at":"2014-07-24T21:40:10Z","updated_at":"2014-10-06T08:53:51Z","closed_at":"2014-07-27T06:26:22Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"If a test is executed in a separate process and it passes, then the serialized `$result` is a simple instance of `PHPUnit_Framework_TestResult`.\n\nBut if it fails, then the `TestResult::$failures` property contains a [`TestFailure`](https://github.com/sebastianbergmann/phpunit/blob/master/src/Framework/TestFailure.php#L75) object,\n1. whose `$failedTest` property contains the complete instance of the test class,  \n   and\n2. whose `$thrownException` property contains an instance of `ExpectationFailedException`, which in turn contains a full backtrace that includes another instance of the test class.\n\nA full serialization of the `TestCase` is problematic, because the class instance can have properties that cannot be serialized - or - which will be unserialized into the scope of the parent process (e.g., a full service container, including instantiated database connections).\n\nTo see it in action, Inject a `var_dump($result);` right before the serialization in the [process isolation template](https://github.com/sebastianbergmann/phpunit/blob/master/src/Util/PHP/Template/TestCaseMethod.tpl.dist#L43) + execute a test that fails:\n\n```\nclass PHPUnit_Framework_TestResult#3 (26) {\n  protected $passed => array(0) {}\n  protected $errors => array(0) {}\n  protected $deprecatedFeatures => array(0) {}\n  protected $failures => array(1) {\n    [0] => class PHPUnit_Framework_TestFailure#3716 (2) {\n\n      protected $failedTest => class Drupal\\views\\Tests\\Handler\\ArgumentDateTest#4 (44) {\n        protected $preserveGlobalState => bool(false)\n        ...\n\n      protected $thrownException => class PHPUnit_Framework_ExpectationFailedException#2968 (9) {\n        protected $comparisonFailure => NULL\n        protected $message => ...\n        ...\n        private $trace => array(15) {\n          ...\n          [5] => array(6) {\n            'class' => string(35) \"Drupal\\views\\Tests\\ViewUnitTestBase\"\n            'args' => array(5) {\n              [0] => class Drupal\\views\\ViewExecutable#2575 (55) {\n                public $storage => class Drupal\\views\\Entity\\View#3655 (21) {\n                ...\n              ...\n           ...\n```\n\nNow, the part I don't understand:  Why does `TestFailure` hold objects to begin with?\n1. `$failedTest` is only consumed once in `TestFailure::toString()`, to call the corresponding method on `TestCase`.\n2. `$thrownException` is only consumed to generate string representations of the exception's message + backtrace.\n\nBoth operations could be performed ahead of time upon instantiation of `TestFailure`, so that it no longer references any objects and just simply holds a string representation of the test failure.\n\nAlso positive impact on memory:  By removing the object references, they can be destructed sooner.  Currently, they're kept around + add up until test results are printed. - In case of process isolation, all involved objects of the child process are _newly_ instantiated in the parent process, clobbering CPU + memory (for no purpose).\n\nThe response in similar issues has been that this would be required to back up global state with enabled process isolation. â€” However, I can't get behind that idea.  In my mind, process isolation is one-directional, not bi-directional.  Global state is injected into the child process only, not vice-versa.  The whole point of process isolation is that the child process should not affect the parent process, so unserializing any kind of _user_ data/objects into the parent process defeats that purpose (because `unserialize()` is an unholy magic beast).\n#### Proposed solution\n1. #1352 Remove the properties referencing injected objects from `TestFailure`, make it hold a string representation of the failure only.\n\nI'm not familiar with this part of the code yet, but given some initial pointers, I could try to get my hands dirty.\n#### Related issues\n- #282 seemingly reported this problem in the past, but suggested a slightly weird solution.\n- #7 fixed a similar problem for `Warning` already, but the solution does not apply here.\n- #451 is about serialization of Closures in process isolation, which might have the same root cause.\n#### API changes\n\nThe only backwards-incompatible API change is in `TestFailure`:\n\n``` diff\ndiff src/Framework/TestFailure.php\n     /**\n-     * Gets the failed test.\n+     * Returns the name of the failing test (including data set, if any).\n      *\n-     * @return PHPUnit_Framework_Test\n+     * @return string\n      */\n-    public function failedTest()\n+    public function getTestName()\n     {\n-        return $this->failedTest;\n+        return $this->testName;\n     }\n```\n\nHowever, the only call existed in `ResultPrinter`:\n\n``` diff\ndiff src/TextUI/ResultPrinter.php\n     protected function printDefectHeader(PHPUnit_Framework_TestFailure $defect, $count)\n     {\n-        $failedTest = $defect->failedTest();\n-\n-        if ($failedTest instanceof PHPUnit_Framework_SelfDescribing) {\n-            $testName = $failedTest->toString();\n-        } else {\n-            $testName = get_class($failedTest);\n-        }\n...\n         $this->write(\n...\n-            $testName\n+            $defect->getTestName()\n```\n\nIf that's deemed to be an integral part of the API, then I assume this fix will have to wait for the next minor release.  (Hopefully not major :wink:)\n\n---\n\n_Original intro:_\nI'm a [Drupal](https://drupal.org) core developer, and I want to rebase 900+ functional integration tests from its custom testing framework (originally a fork of [Simpletest](http://simpletest.org)) to PHPUnit.  Due to many [fatal errors](https://travis-ci.org/sun/drupal), I don't even get a test result that would allow me to debug similarities in failures, so that's why process isolation is highly useful.\n\nI don't plan to keep it enabled in the end, but a future change to (Drupal) APIs might run into similar mass-failure conditions, in which case process isolation would likely help to pinpoint the root causes again, so that's why I'm looking into these bugs.\n","closed_by":{"login":"whatthejeff","id":306525,"node_id":"MDQ6VXNlcjMwNjUyNQ==","avatar_url":"https://avatars.githubusercontent.com/u/306525?v=4","gravatar_id":"","url":"https://api.github.com/users/whatthejeff","html_url":"https://github.com/whatthejeff","followers_url":"https://api.github.com/users/whatthejeff/followers","following_url":"https://api.github.com/users/whatthejeff/following{/other_user}","gists_url":"https://api.github.com/users/whatthejeff/gists{/gist_id}","starred_url":"https://api.github.com/users/whatthejeff/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/whatthejeff/subscriptions","organizations_url":"https://api.github.com/users/whatthejeff/orgs","repos_url":"https://api.github.com/users/whatthejeff/repos","events_url":"https://api.github.com/users/whatthejeff/events{/privacy}","received_events_url":"https://api.github.com/users/whatthejeff/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/1351/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/1351/timeline","performed_via_github_app":null,"state_reason":"completed"}