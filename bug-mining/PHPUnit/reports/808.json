{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5551","repository_url":"https://api.github.com/repos/sebastianbergmann/phpunit","labels_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5551/labels{/name}","comments_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5551/comments","events_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5551/events","html_url":"https://github.com/sebastianbergmann/phpunit/issues/5551","id":1965379898,"node_id":"I_kwDOAAbWLc51JVE6","number":5551,"title":"Support for omitting parameter default values for `willReturnMap()`","user":{"login":"Schrank","id":379680,"node_id":"MDQ6VXNlcjM3OTY4MA==","avatar_url":"https://avatars.githubusercontent.com/u/379680?v=4","gravatar_id":"","url":"https://api.github.com/users/Schrank","html_url":"https://github.com/Schrank","followers_url":"https://api.github.com/users/Schrank/followers","following_url":"https://api.github.com/users/Schrank/following{/other_user}","gists_url":"https://api.github.com/users/Schrank/gists{/gist_id}","starred_url":"https://api.github.com/users/Schrank/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Schrank/subscriptions","organizations_url":"https://api.github.com/users/Schrank/orgs","repos_url":"https://api.github.com/users/Schrank/repos","events_url":"https://api.github.com/users/Schrank/events{/privacy}","received_events_url":"https://api.github.com/users/Schrank/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":44002,"node_id":"MDU6TGFiZWw0NDAwMg==","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/type/enhancement","name":"type/enhancement","color":"73d216","default":false,"description":"A new idea that should be implemented"},{"id":930693698,"node_id":"MDU6TGFiZWw5MzA2OTM2OTg=","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/feature/test-doubles","name":"feature/test-doubles","color":"e9b96e","default":false,"description":"Test Stubs and Mock Objects"}],"state":"closed","locked":false,"assignee":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/milestones/58","html_url":"https://github.com/sebastianbergmann/phpunit/milestone/58","labels_url":"https://api.github.com/repos/sebastianbergmann/phpunit/milestones/58/labels","id":8964800,"node_id":"MI_kwDOAAbWLc4AiMrA","number":58,"title":"PHPUnit 10.5","description":"","creator":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":3,"state":"closed","created_at":"2023-01-25T11:10:54Z","updated_at":"2023-12-01T06:15:25Z","due_on":"2023-12-01T08:00:00Z","closed_at":"2023-12-01T06:15:25Z"},"comments":2,"created_at":"2023-10-27T12:02:28Z","updated_at":"2023-10-30T18:03:54Z","closed_at":"2023-10-28T07:27:12Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"There are at least two ways to tell a test double to return a value: `with()->willReturn()` and `willReturnMap()`.\r\n\r\nWhile `with()->willReturn()` kind of works as I expect it, `willReturnMap()` does not.\r\n\r\n`with()->willReturn()` seems to \"ignore\" the default values and returns the `willReturn()` although the default values are not part of the test double configuration.\r\n\r\nExample:\r\n```php\r\n// We have a method like this:\r\npublic function methodWithDefaultValue(int $return, int $subtract = 0): int\r\n{\r\n        return $return - $subtract;\r\n}\r\n```\r\n\r\nThe following code will work as expected and be a valid test and `$this->methodWithDefaultValue($a)` will return `6`.\r\n```php\r\n $a = 6;\r\n\r\n$this->exampleMock\r\n    ->method('methodWithDefaultValue')\r\n    ->with($a)\r\n    ->willReturn($a);\r\n```\r\n\r\nWhile this does not work:\r\n```php\r\n        $a = 6;\r\n\r\n        $this->exampleMock\r\n            ->method('methodWithDefaultValue')\r\n            ->willReturnMap([[$a, $a]]);\r\n```\r\n\r\nIt returns an error `TypeError: MockObject_Example_5ee46b65::methodWithDefaultValue(): Return value must be of type int, null returned`\r\n\r\nAnd this is already more than expected, because in the horrible past, the error would be: `Failed asserting that null is identical to 6.` if we don't define return types on the methods.\r\n\r\nMy situation is: I'm writing not enough unit tests, therefore I forget the problem often. And in combination with PHPStorm not autocompleting a method with its optional parameters, I often forget, that the method I double even has more than the required parameter.\r\n\r\nTo make `willReturnMap()` work, we need to pass **all** parameters to the mapping array, looking like this:\r\n\r\n```php\r\n$this->exampleMock\r\n            ->method('methodWithDefaultValue')\r\n            ->willReturnMap([[$a, 0, $a]]);\r\n```\r\n\r\nthen the code will return our expected `6`.\r\n\r\nAfter a nice chat with Sebastian, we thought about how to fix it and there are two location, where it might make sense to do it:\r\n1. When creating the ReturnValueMap or\r\n2. when matching against it.\r\n\r\nSebastian already said, 1. makes more sense, because then we know we have to handle default values, because the others are passed to us. While if we do it while matching, we first need to determine wether the values we have are default or not and over all, Sebastian said it is more complex.\r\n\r\n@sebastianbergmann I hope I didn't forget anything. The good news: `with()->willReturn()` works as expected <3\r\n\r\nThanks for all your work!","closed_by":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5551/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5551/timeline","performed_via_github_app":null,"state_reason":"completed"}