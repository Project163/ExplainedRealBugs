{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5652","repository_url":"https://api.github.com/repos/sebastianbergmann/phpunit","labels_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5652/labels{/name}","comments_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5652/comments","events_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5652/events","html_url":"https://github.com/sebastianbergmann/phpunit/issues/5652","id":2074166581,"node_id":"I_kwDOAAbWLc57oUU1","number":5652,"title":"`HRTime::duration()` throws `InvalidArgumentException`","user":{"login":"josep11","id":5558911,"node_id":"MDQ6VXNlcjU1NTg5MTE=","avatar_url":"https://avatars.githubusercontent.com/u/5558911?v=4","gravatar_id":"","url":"https://api.github.com/users/josep11","html_url":"https://github.com/josep11","followers_url":"https://api.github.com/users/josep11/followers","following_url":"https://api.github.com/users/josep11/following{/other_user}","gists_url":"https://api.github.com/users/josep11/gists{/gist_id}","starred_url":"https://api.github.com/users/josep11/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/josep11/subscriptions","organizations_url":"https://api.github.com/users/josep11/orgs","repos_url":"https://api.github.com/users/josep11/repos","events_url":"https://api.github.com/users/josep11/events{/privacy}","received_events_url":"https://api.github.com/users/josep11/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":44001,"node_id":"MDU6TGFiZWw0NDAwMQ==","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/type/bug","name":"type/bug","color":"cc0000","default":false,"description":"Something is broken"},{"id":3054889839,"node_id":"MDU6TGFiZWwzMDU0ODg5ODM5","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/feature/events","name":"feature/events","color":"e9b96e","default":false,"description":"Issues related to PHPUnit's event system"},{"id":5111411238,"node_id":"LA_kwDOAAbWLc8AAAABMKnyJg","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/version/10","name":"version/10","color":"888a85","default":false,"description":"Something affects PHPUnit 10"},{"id":6451625518,"node_id":"LA_kwDOAAbWLc8AAAABgIv-Lg","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/event/code-sprint/2024-03","name":"event/code-sprint/2024-03","color":"eeeeec","default":false,"description":"PHPUnit Code Sprint: March 2024"},{"id":6451629111,"node_id":"LA_kwDOAAbWLc8AAAABgIwMNw","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/version/11","name":"version/11","color":"888a85","default":false,"description":"Something affects PHPUnit 11"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":29,"created_at":"2024-01-10T11:28:14Z","updated_at":"2024-03-09T12:25:16Z","closed_at":"2024-03-08T16:23:14Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"| Q                   | A\r\n| --------------------| ---------------\r\n| PHPUnit version     | 10.5.5\r\n| PHP version         |  8.3.0\r\n| Installation Method | Composer\r\n\r\n#### Summary\r\n\r\n`\\PHPUnit\\Event\\Telemetry\\HRTime::duration` throws `InvalidArgumentException`\r\n\r\nThis line is the one that throws, but only sometimes.\r\n\r\n```php\r\npublic function duration(self $start): Duration\r\n    {\r\n        ...\r\n\r\n        if ($seconds < 0) {\r\n            throw new InvalidArgumentException('Start needs to be smaller.');\r\n        }\r\n\r\n       ...\r\n    }\r\n```\r\n\r\nIn my test it fails when invoking the `createMock` method. \r\nToday: `$logger = $this->createMock(LoggerInterface::class);`\r\nYesterday: `$calendar = $this->createMock(Calendar::class);`\r\n\r\nWe have had that test running on our CI pipeline for over a year. PRs have been rised on a daily basis and it never failed till yesterday.\r\n\r\nWe upgraded to PHPUnit 10 one month ago. Same thing, it always worked.\r\n\r\n#### Current behavior\r\n\r\nWe get one failed test case when running it on our CI provider. The step looks like this:\r\n\r\n`XDEBUG_MODE=off php -d memory_limit=-1 vendor/bin/phpunit --testsuite unit --colors=never`\r\n\r\nThe same does not happen if we add another pipeline step with the phpunit \"--filter\"\r\n\r\n`XDEBUG_MODE=off php -d memory_limit=-1 vendor/bin/phpunit --testsuite unit --colors=never --filter=\"AttendeeController\"`\r\n\r\n#### How to reproduce\r\n\r\nIt is extremely difficult to reproduce. I tried reproducing it locally and cannot succeed. Also, on the CI pipeline it's somehow inconsistent. \r\n\r\n- If I comment one of the data provider scenarios out, the error disappears. And then it appears on the immediately previous data provider scenario.\r\n- If I comment the immediately previous data provider scenario, it disappears. ðŸ¤¯ \r\n- If I comment all data providers out it disappears. But then randomly appears the next day on another test case.\r\n\r\n#### Expected behavior\r\n\r\nI would say that, if `$seconds` (which I am not sure how that can even happen ðŸ¤¯) is less than 0, we should not care at all in the relevant test method. It should be caught and handled by PhpUnit as it's related to grabbing the total execution time.\r\n\r\nIn summary, it should not be leaked to the phpunit user.\r\n","closed_by":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5652/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5652/timeline","performed_via_github_app":null,"state_reason":"completed"}