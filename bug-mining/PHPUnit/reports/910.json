{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/6095","repository_url":"https://api.github.com/repos/sebastianbergmann/phpunit","labels_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/6095/labels{/name}","comments_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/6095/comments","events_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/6095/events","html_url":"https://github.com/sebastianbergmann/phpunit/issues/6095","id":2776557824,"node_id":"I_kwDOAAbWLc6lfukA","number":6095,"title":"Expectation is not counted correctly when a doubled method is called more often than is expected","user":{"login":"cabbey","id":522147,"node_id":"MDQ6VXNlcjUyMjE0Nw==","avatar_url":"https://avatars.githubusercontent.com/u/522147?v=4","gravatar_id":"","url":"https://api.github.com/users/cabbey","html_url":"https://github.com/cabbey","followers_url":"https://api.github.com/users/cabbey/followers","following_url":"https://api.github.com/users/cabbey/following{/other_user}","gists_url":"https://api.github.com/users/cabbey/gists{/gist_id}","starred_url":"https://api.github.com/users/cabbey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cabbey/subscriptions","organizations_url":"https://api.github.com/users/cabbey/orgs","repos_url":"https://api.github.com/users/cabbey/repos","events_url":"https://api.github.com/users/cabbey/events{/privacy}","received_events_url":"https://api.github.com/users/cabbey/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":44001,"node_id":"MDU6TGFiZWw0NDAwMQ==","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/type/bug","name":"type/bug","color":"cc0000","default":false,"description":"Something is broken"},{"id":930693698,"node_id":"MDU6TGFiZWw5MzA2OTM2OTg=","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/feature/test-doubles","name":"feature/test-doubles","color":"e9b96e","default":false,"description":"Test Stubs and Mock Objects"},{"id":5111411238,"node_id":"LA_kwDOAAbWLc8AAAABMKnyJg","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/version/10","name":"version/10","color":"888a85","default":false,"description":"Something affects PHPUnit 10"},{"id":6451629111,"node_id":"LA_kwDOAAbWLc8AAAABgIwMNw","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/version/11","name":"version/11","color":"888a85","default":false,"description":"Something affects PHPUnit 11"}],"state":"closed","locked":false,"assignee":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":8,"created_at":"2025-01-08T23:54:17Z","updated_at":"2025-01-10T05:59:05Z","closed_at":"2025-01-09T08:48:07Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"| Q                   | A\r\n| --------------------| ---------------\r\n| PHPUnit version     | 11.4.3\r\n| PHP version         | 8.3.12\r\n| Installation Method | Composer\r\n\r\n```\r\nacmephp/core                                 2.1.0              Raw implementation of the ACME protocol in PHP\r\nacmephp/ssl                                  2.1.0              PHP wrapper around OpenSSL extension providing SSL...\r\nasync-aws/core                               1.20.1             Core package to integrate with AWS. This is a ligh...\r\nasync-aws/lambda                             1.9.0              Lambda client, part of the AWS SDK provided by Asy...\r\naws/aws-crt-php                              v1.2.4             AWS Common Runtime for PHP\r\naws/aws-php-sns-message-validator            1.9.0              Amazon SNS message validation for PHP\r\naws/aws-sdk-php                              3.288.1            AWS SDK for PHP - Use Amazon Web Services in your ...\r\nbacon/bacon-qr-code                          2.0.8              BaconQrCode is a QR code generator for PHP.\r\nbrick/math                                   0.11.0             Arbitrary-precision arithmetic library\r\nclue/stream-filter                           v1.6.0             A simple and modern approach to stream filtering i...\r\ncomposer/ca-bundle                           1.4.0              Lets you find a path to the system CA bundle, and ...\r\ndasprid/enum                                 1.0.3              PHP 7.1 enum implementation\r\nelasticsearch/elasticsearch                  v7.17.2            PHP Client for Elasticsearch\r\nendroid/qr-code                              4.0.0              Endroid QR Code\r\nezimuel/guzzlestreams                        3.1.0              Fork of guzzle/streams (abandoned) to be used with...\r\nezimuel/ringphp                              1.2.2              Fork of guzzle/RingPHP (abandoned) to be used with...\r\nfidry/cpu-core-counter                       0.4.1              Tiny utility to get the number of CPU cores.\r\nfirebase/php-jwt                             v6.3.1             A simple library to encode and decode JSON Web Tok...\r\nfpdf/fpdf                                    1.85.0             FPDF Composer Wrapper\r\ngeoip2/geoip2                                v2.13.0            MaxMind GeoIP2 PHP API\r\ngiggsey/libphonenumber-for-php-lite          8.13.3             A lite version of giggsey/libphonenumber-for-php, ...\r\ngoogle/apiclient                             v2.17.0            Client library for Google APIs\r\ngoogle/apiclient-services                    v0.375.1           Client library for Google APIs\r\ngoogle/auth                                  v1.37.1            Google Auth Library for PHP\r\nguzzlehttp/guzzle                            7.8.1              Guzzle is a PHP HTTP client library\r\nguzzlehttp/promises                          1.5.3              Guzzle promises library\r\nguzzlehttp/psr7                              2.7.0              PSR-7 message implementation that also provides co...\r\nhollodotme/fast-cgi-client                   v3.1.7             A PHP fast CGI client to send requests (a)synchron...\r\nintercom/intercom-php                        4.4.3              Intercom API client built on top of HTTPlug\r\nkelvinmo/simplejwt                           v0.5.1             A simple JSON Web Token library for PHP.\r\nkickbox/kickbox                              2.2.6.2            Official kickbox API library client for PHP\r\nlaminas/laminas-diactoros                    2.26.0             PSR HTTP Message implementations\r\nlaminas/laminas-httphandlerrunner            2.10.0             Execute PSR-15 RequestHandlerInterface instances a...\r\nlaunchdarkly/server-sdk                      4.2.4              Official LaunchDarkly SDK for PHP\r\nlaunchdarkly/server-sdk-dynamodb             1.0.0              LaunchDarkly PHP SDK DynamoDB integration\r\nlcobucci/clock                               2.2.0              Yet another clock abstraction\r\nlcobucci/jwt                                 4.0.4              A simple library to work with JSON Web Token and J...\r\nleague/container                             4.2.0              A fast and intuitive dependency injection container.\r\nleague/event                                 3.0.2              Event package\r\nleague/iso3166                               4.1.0              ISO 3166-1 PHP Library\r\nleague/route                                 5.1.2              Fast routing and dispatch component including PSR-...\r\nleague/uri                                   6.8.0              URI manipulation library\r\nleague/uri-interfaces                        2.3.0              Common interface for URI representation\r\nmaennchen/zipstream-php                      2.0.0              ZipStream is a library for dynamically streaming d...\r\nmaxmind-db/reader                            v1.11.1            MaxMind DB Reader API\r\nmaxmind/web-service-common                   v0.9.0             Internal MaxMind Web Service API\r\nmoneyphp/money                               v4.5.0             PHP implementation of Fowler's Money pattern\r\nmonolog/monolog                              2.9.3              Sends your logs to files, sockets, inboxes, databa...\r\nmtdowling/jmespath.php                       2.7.0              Declaratively specify how to extract elements from...\r\nmyclabs/deep-copy                            1.12.0             Create deep copies (clones) of your objects\r\nmyclabs/php-enum                             1.8.4              PHP Enum implementation\r\nnikic/fast-route                             v1.3.0             Fast request router for PHP\r\nnikic/php-parser                             v5.3.1             A PHP parser written in PHP\r\nnyholm/psr7                                  1.8.1              A fast PHP7 implementation of PSR-7\r\nopensearch-project/opensearch-php            1.0.2              PHP Client for OpenSearch\r\nopis/closure                                 3.6.3              A library that can be used to serialize closures (...\r\nparagonie/constant_time_encoding             v2.6.3             Constant-time Implementations of RFC 4648 Encoding...\r\nparagonie/csp-builder                        v2.9.0             Easily add and update Content-Security-Policy head...\r\nparagonie/random_compat                      v9.99.100          PHP 5.x polyfill for random_bytes() and random_int...\r\nphar-io/manifest                             2.0.4              Component for reading phar.io manifest information...\r\nphar-io/version                              3.2.1              Library for handling version information and const...\r\nphp-http/client-common                       2.6.0              Common HTTP Client implementations and tools for H...\r\nphp-http/discovery                           1.14.3             Finds installed HTTPlug implementations and PSR-7 ...\r\nphp-http/guzzle7-adapter                     1.0.0              Guzzle 7 HTTP Adapter\r\nphp-http/httplug                             2.3.0              HTTPlug, the HTTP client abstraction for PHP\r\nphp-http/message                             1.13.0             HTTP Message related tools\r\nphp-http/message-factory                     1.1.0              Factory interfaces for PSR-7 HTTP Message\r\nphp-http/promise                             1.1.0              Promise used for asynchronous HTTP requests\r\nphp-parallel-lint/php-parallel-lint          v1.3.2             This tool check syntax of PHP files about 20x fast...\r\nphpseclib/phpseclib                          3.0.37             PHP Secure Communications Library - Pure-PHP imple...\r\nphpstan/phpstan                              1.12.7             PHPStan - PHP Static Analysis Tool\r\nphpunit/php-code-coverage                    11.0.7             Library that provides collection, processing, and ...\r\nphpunit/php-file-iterator                    5.1.0              FilterIterator implementation that filters files b...\r\nphpunit/php-invoker                          5.0.1              Invoke callables with a timeout\r\nphpunit/php-text-template                    4.0.1              Simple template engine.\r\nphpunit/php-timer                            7.0.1              Utility class for timing\r\nphpunit/phpunit                              11.4.3             The PHP Unit Testing framework.\r\npragmarx/google2fa                           v8.0.1             A One Time Password Authentication package, compat...\r\npsalm/phar                                   5.17.0             Composer-based Psalm Phar\r\npsr/cache                                    1.0.1              Common interface for caching libraries\r\npsr/clock                                    1.0.0              Common interface for reading the clock.\r\npsr/container                                1.1.2              Common Container Interface (PHP FIG PSR-11)\r\npsr/event-dispatcher                         1.0.0              Standard interfaces for event handling.\r\npsr/http-client                              1.0.3              Common interface for HTTP clients\r\npsr/http-factory                             1.0.2              Common interfaces for PSR-7 HTTP message factories\r\npsr/http-message                             1.1                Common interface for HTTP messages\r\npsr/http-server-handler                      1.0.2              Common interface for HTTP server-side request handler\r\npsr/http-server-middleware                   1.0.2              Common interface for HTTP server-side middleware\r\npsr/log                                      2.0.0              Common interface for logging libraries\r\npsr/simple-cache                             1.0.1              Common interfaces for simple caching\r\nralouphie/getallheaders                      3.0.3              A polyfill for getallheaders.\r\nramsey/collection                            2.0.0              A PHP library for representing and manipulating co...\r\nramsey/uuid                                  4.7.5              A PHP library for generating and working with univ...\r\nreact/promise                                v2.11.0            A lightweight implementation of CommonJS Promises/...\r\nrector/rector                                1.2.8              Instant Upgrade and Automated Refactoring of any P...\r\nriverline/multipart-parser                   2.1.1              One class library to parse multipart content with ...\r\nroave/security-advisories                    dev-latest 01fd41b Prevents installation of composer packages with kn...\r\nsebastian/cli-parser                         3.0.2              Library for parsing CLI options\r\nsebastian/code-unit                          3.0.1              Collection of value objects that represent the PHP...\r\nsebastian/code-unit-reverse-lookup           4.0.1              Looks up which function or method a line of code b...\r\nsebastian/comparator                         6.1.1              Provides the functionality to compare PHP values f...\r\nsebastian/complexity                         4.0.1              Library for calculating the complexity of PHP code...\r\nsebastian/diff                               6.0.2              Diff implementation\r\nsebastian/environment                        7.2.0              Provides functionality to handle HHVM/PHP environm...\r\nsebastian/exporter                           6.1.3              Provides the functionality to export PHP variables...\r\nsebastian/global-state                       7.0.2              Snapshotting of global state\r\nsebastian/lines-of-code                      3.0.1              Library for counting the lines of code in PHP sour...\r\nsebastian/object-enumerator                  6.0.1              Traverses array structures and object graphs to en...\r\nsebastian/object-reflector                   4.0.1              Allows reflection of object attributes, including ...\r\nsebastian/recursion-context                  6.0.2              Provides functionality to recursively process PHP ...\r\nsebastian/type                               5.1.0              Collection of value objects that represent the typ...\r\nsebastian/version                            5.0.2              Library that helps with managing the version numbe...\r\nsmartystreets/phpsdk                         4.17.0             The official PHP client library from SmartyStreets.\r\nsnowplow/snowplow-tracker                    0.6.1              Snowplow event tracker for PHP. Add analytics into...\r\nspomky-labs/base64url                        v2.0.4             Base 64 URL Safe Encoding/Decoding PHP Library\r\nsquizlabs/php_codesniffer                    3.7.2              PHP_CodeSniffer tokenizes PHP, JavaScript and CSS ...\r\nstaabm/annotate-pull-request-from-checkstyle 1.8.5             \r\nstella-maris/clock                           0.1.7              A pre-release of the proposed PSR-20 Clock-Interface\r\nstripe/stripe-php                            v15.2.0            Stripe PHP Library\r\nsymfony/console                              v5.4.35            Eases the creation of beautiful and testable comma...\r\nsymfony/deprecation-contracts                v3.4.0             A generic function and convention to trigger depre...\r\nsymfony/filesystem                           v6.4.3             Provides basic utilities for the filesystem\r\nsymfony/http-client                          v6.2.13            Provides powerful methods to fetch HTTP resources ...\r\nsymfony/http-client-contracts                v3.4.0             Generic abstractions related to HTTP clients\r\nsymfony/options-resolver                     v6.2.0             Provides an improved replacement for the array_rep...\r\nsymfony/polyfill-ctype                       v1.29.0            Symfony polyfill for ctype functions\r\nsymfony/polyfill-intl-grapheme               v1.29.0            Symfony polyfill for intl's grapheme_* functions\r\nsymfony/polyfill-intl-normalizer             v1.29.0            Symfony polyfill for intl's Normalizer class and r...\r\nsymfony/polyfill-mbstring                    v1.29.0            Symfony polyfill for the Mbstring extension\r\nsymfony/polyfill-php73                       v1.29.0            Symfony polyfill backporting some PHP 7.3+ feature...\r\nsymfony/polyfill-php80                       v1.29.0            Symfony polyfill backporting some PHP 8.0+ feature...\r\nsymfony/process                              v6.4.3             Executes commands in sub-processes\r\nsymfony/service-contracts                    v3.4.1             Generic abstractions related to writing services\r\nsymfony/string                               v6.4.3             Provides an object-oriented API to strings and dea...\r\nsymfony/yaml                                 v5.4.35            Loads and dumps YAML files\r\ntheseer/tokenizer                            1.2.3              A small library for converting tokenized PHP sourc...\r\ntideways/ext-tideways-stubs                  v5.6.0.1           IDE stubs for Tideways Profiler PHP extension\r\nulrichsg/getopt-php                          v4.0.3             Command line arguments parser for PHP 7.1 and above\r\nvube/monolog-splunk-formatter                v2.0               Splunk Line Formatter for Monolog\r\nwebmozart/assert                             1.11.0             Assertions to validate method input/output with ni...\r\nwikimedia/less.php                           v3.1.0             PHP port of the Javascript version of LESS http://...\r\n```\r\n\r\n#### Summary\r\n\r\nWe have some testcases that rely 100% on configuring mocks with expectations for their assertions. I'll focus on one of them that has 6 variations from it's data provider. With the upgrade to phpunit 11, all 6 variations now report as risky, saying they did not perform any assertions. This is demonstrably false, as I can intentionally break the mocked objects passed into the test from the dataProvider and observe that it does in fact fail the test because the expectations on another mocked object don't align with how the object is called in the code under test, however if the expectation is not violated it doesn't trigger. (For example, if the expectation is that a method will be called once, and it is never called, then the failure will not be seen. But if it is called twice, the failure will be reported.) This only happens with mocks provided via dataProviders, those created in the test function do not exhibit this behavior.\r\n\r\n#### Current behavior\r\n\r\n```\r\nphpunit -c phpunit.xml tests/phpunit/functional/SmugMug/Stats/Image/ZombieAccessProcessorTest.php \r\nusing vendor/bin/phpunit\r\nPHPUnit 11.4.3 by Sebastian Bergmann and contributors.\r\n\r\nRuntime:       PHP 8.3.12\r\nConfiguration: /home/cabbey/sandboxes/10/phpunit.xml\r\n\r\nRRRRRR                                                              6 / 6 (100%)\r\n\r\nTime: 00:00.463, Memory: 62.50 MB\r\n\r\nThere were 6 risky tests:\r\n\r\n1) TestSuite\\Functional\\SmugMug\\Stats\\Image\\ZombieAccessProcessorTest::testEvaluateStatsForInvalidAccess with data set \"allGoodModernUrlNoSignature\" (SmugMug\\Stats\\Image\\CollectionForVerification Object (...), MockObject_FlushCoordinator_e18fb1d3 Object (...), MockObject_ImageRepository_4d1241ba Object (...))\r\nThis test did not perform any assertions\r\n\r\n/home/cabbey/sandboxes/10/tests/phpunit/functional/SmugMug/Stats/Image/ZombieAccessProcessorTest.php:25\r\n\r\n... five more instances of the same thing with a different data set ...\r\n\r\nOK, but there were issues!\r\nTests: 6, Assertions: 0, PHPUnit Deprecations: 1, Risky: 6.\r\n```\r\n\r\n#### How to reproduce\r\n\r\n[bugDemo.php.gz](https://github.com/user-attachments/files/18354202/bugDemo.php.gz)\r\n\r\nI've extracted the issue out of our test cases and attached a simple testcase file which has 9 test functions in a 3x3 grid as follows:\r\n\r\n1. the mock object is:\r\n    a. created locally \r\n    b. injected from a dataProvider \r\n    c. injected from a dataProvider *and* registered with `$this->registerMockObject()` in the function\r\n2. the number of calls to the `demo()` function is:\r\n    a. zero (should fail)\r\n    b. one (should pass)\r\n    c. two (should fail)\r\n\r\n| 0 | 1 | 2 |   |\r\n|---|---|---|-----|\r\n| F | P | F | Expected |\r\n| F | P | FR | created locally |\r\n| R | R | FR | Injected |\r\n| F | P | FR | Registered |\r\n\r\nUsing the internal `registerMockObject()` function in the test to register the mocks injected from the data provider appears to bring the behavior closer into alignment with expectations, but still unexpectedly reports a risky test on the two call version. This leaves me with very little faith that using this internal function is a proper solution to our issue. (and needing to use an internal function to make the test case whole seems... alarming.)\r\n\r\n(phpunit 11.5.2 behaves the same as 11.4.3 with this test; but there are issues with some of our other tests that prevent me from using 11.5 across the whole test suite just yet.)\r\n\r\nPhpunit 10.5.40 with this test case is slightly different, but is consistent:\r\n| 0 | 1 | 2 |   |\r\n|---|---|---|-----|\r\n| F | P | F | Expected |\r\n| F | P | FR | created locally |\r\n| F | P | FR | Injected |\r\n| F | P | FR | Registered |\r\n\r\n#### Expected behavior\r\n\r\nUnder phpunit 10.5.40 these tests run perfectly with no deprecation warnings:\r\n```\r\nphpunit -c phpunit.xml tests/phpunit/functional/SmugMug/Stats/Image/ZombieAccessProcessorTest.php \r\nusing vendor/bin/phpunit\r\nPHPUnit 10.5.40 by Sebastian Bergmann and contributors.\r\n\r\nRuntime:       PHP 8.3.12\r\nConfiguration: /home/cabbey/sandboxes/10/phpunit.xml\r\n\r\n......                                                              6 / 6 (100%)\r\n\r\nTime: 00:00.037, Memory: 46.50 MB\r\n\r\nOK (6 tests, 6 assertions)\r\n```\r\nThe only difference here is that I did `composer require --dev phpunit/phpunit:^10.0 -W` after running with 11.4.3 above to back down to 10.5.40... all code under test was the same.\r\n","closed_by":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/6095/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/6095/timeline","performed_via_github_app":null,"state_reason":"completed"}