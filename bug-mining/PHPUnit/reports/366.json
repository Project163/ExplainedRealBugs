{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/2101","repository_url":"https://api.github.com/repos/sebastianbergmann/phpunit","labels_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/2101/labels{/name}","comments_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/2101/comments","events_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/2101/events","html_url":"https://github.com/sebastianbergmann/phpunit/issues/2101","id":137199900,"node_id":"MDU6SXNzdWUxMzcxOTk5MDA=","number":2101,"title":"Output Buffer Level consumption prevents custom output buffers from working","user":{"login":"ghost","id":10137,"node_id":"MDQ6VXNlcjEwMTM3","avatar_url":"https://avatars.githubusercontent.com/u/10137?v=4","gravatar_id":"","url":"https://api.github.com/users/ghost","html_url":"https://github.com/ghost","followers_url":"https://api.github.com/users/ghost/followers","following_url":"https://api.github.com/users/ghost/following{/other_user}","gists_url":"https://api.github.com/users/ghost/gists{/gist_id}","starred_url":"https://api.github.com/users/ghost/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghost/subscriptions","organizations_url":"https://api.github.com/users/ghost/orgs","repos_url":"https://api.github.com/users/ghost/repos","events_url":"https://api.github.com/users/ghost/events{/privacy}","received_events_url":"https://api.github.com/users/ghost/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":44001,"node_id":"MDU6TGFiZWw0NDAwMQ==","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/type/bug","name":"type/bug","color":"cc0000","default":false,"description":"Something is broken"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2016-02-29T09:34:55Z","updated_at":"2016-09-21T14:38:16Z","closed_at":"2016-09-21T14:38:16Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi,\n\nI noticed a weird behaviour as I wanted to wrap the output of a test run in an output buffer. It seems like the phpunit code closes all existing output buffers in the process. Even those opened by me.\n\nHere is my test code:\n\n``` php\nob_start();\ninclude('/home/johann/development/toolbox/lib/vendor/phpunit/phpunit.phar');\nob_end_clean();\n\n$_SERVER['argv'] = [\n    '/home/johann/development/toolbox/lib/vendor/phpunit/phpunit.phar',\n    '--configuration',\n    '/home/johann/development/toolbox/lib/toolbox/services/cli/unix/test/config/phpUnit.xml',\n];\n\nob_start();\nPHPUnit_TextUI_Command::main(false);\n$content = ob_get_contents();\nob_end_clean();\n```\n\nThe last `ob_end_clean()` call fails because all output buffers were already closed by phpunit.\n\nThe code responsible for closing ALL open output buffers is in the `phpunit.phar/phpunit/Framework/TestCase.php` file and in the `startOutputBuffering` method:\n\n``` php\nprivate function startOutputBuffering()\n{\n    while (!defined('PHPUNIT_TESTSUITE') && ob_get_level() > 0) {\n        ob_end_clean();\n    }\n\n    ob_start();\n\n    $this->outputBufferingActive = true;\n    $this->outputBufferingLevel  = ob_get_level();\n}\n```\n\nSo what it does is close output buffers till the level reaches 0. That's bad if you want use your own output buffer outside. Maybe the current level should be taken into consideration.\n\nI found similar issues here (all closed for some reason):\n#1398\n#1545\n#1553\n","closed_by":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/2101/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/2101/timeline","performed_via_github_app":null,"state_reason":"completed"}