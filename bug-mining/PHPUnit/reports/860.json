{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5937","repository_url":"https://api.github.com/repos/sebastianbergmann/phpunit","labels_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5937/labels{/name}","comments_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5937/comments","events_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5937/events","html_url":"https://github.com/sebastianbergmann/phpunit/issues/5937","id":2502858917,"node_id":"I_kwDOAAbWLc6VLpil","number":5937,"title":"Optionally ignore PHPUnit deprecations when determining the test runner's shell exit code","user":{"login":"jrfnl","id":663378,"node_id":"MDQ6VXNlcjY2MzM3OA==","avatar_url":"https://avatars.githubusercontent.com/u/663378?v=4","gravatar_id":"","url":"https://api.github.com/users/jrfnl","html_url":"https://github.com/jrfnl","followers_url":"https://api.github.com/users/jrfnl/followers","following_url":"https://api.github.com/users/jrfnl/following{/other_user}","gists_url":"https://api.github.com/users/jrfnl/gists{/gist_id}","starred_url":"https://api.github.com/users/jrfnl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrfnl/subscriptions","organizations_url":"https://api.github.com/users/jrfnl/orgs","repos_url":"https://api.github.com/users/jrfnl/repos","events_url":"https://api.github.com/users/jrfnl/events{/privacy}","received_events_url":"https://api.github.com/users/jrfnl/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":44002,"node_id":"MDU6TGFiZWw0NDAwMg==","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/type/enhancement","name":"type/enhancement","color":"73d216","default":false,"description":"A new idea that should be implemented"},{"id":1329317012,"node_id":"MDU6TGFiZWwxMzI5MzE3MDEy","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/feature/test-runner","name":"feature/test-runner","color":"e9b96e","default":false,"description":"CLI test runner"},{"id":5111411238,"node_id":"LA_kwDOAAbWLc8AAAABMKnyJg","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/version/10","name":"version/10","color":"888a85","default":false,"description":"Something affects PHPUnit 10"},{"id":5333828224,"node_id":"LA_kwDOAAbWLc8AAAABPevCgA","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/feature/configuration/xml","name":"feature/configuration/xml","color":"e9b96e","default":false,"description":""},{"id":5333828800,"node_id":"LA_kwDOAAbWLc8AAAABPevEwA","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/feature/configuration/cli","name":"feature/configuration/cli","color":"e9b96e","default":false,"description":""},{"id":6451629111,"node_id":"LA_kwDOAAbWLc8AAAABgIwMNw","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/version/11","name":"version/11","color":"888a85","default":false,"description":"Something affects PHPUnit 11"}],"state":"closed","locked":false,"assignee":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":2,"created_at":"2024-09-03T13:15:51Z","updated_at":"2024-09-04T08:53:42Z","closed_at":"2024-09-04T06:10:10Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"| Q                   | A\r\n| --------------------| ---------------\r\n| PHPUnit version     | 10 + 11\r\n| PHP version         | any supported\r\n| Installation Method | either\r\n\r\n### Summary\r\n\r\n#### Use case\r\n\r\nGiven a test suite which:\r\n* Needs to run on PHPUnit 10 + 11\r\n* AND the source code includes traits which are covered by tests\r\n* AND the test suite needs to fail the build when PHP native deprecation notices are seen...\r\n\r\nHow can I make the tests pass and code coverage be recorded on both PHPUnit 10 + 11 ?\r\n\r\n#### The underlying problem\r\n\r\nThis is actually part of a larger problem which has existed since PHPUnit 10.0: deprecations coming from PHPUnit itself affecting the exit code.\r\n\r\nNow, I know this was a deliberate choice (based on comments by @sebastianbergmann in various tickets over time) and as there have been work-arounds until now, I have not spoken up about this before, but with the deprecation of `#[CoversClass]` in favour of `#[CoversTrait]` this is now an insurmountable problem.\r\n\r\nThe typical use-case for the `failOn*` settings is (open source) libraries which need to run on multiple PHP versions and want to prevent (new) PHP deprecations/notices/warnings from creeping into their code.\r\n\r\nUp to now, the fact that PHPUnit deprecations affected the exit code meant that those libraries would need:\r\n* To do upgrades to their test suite on every PHPUnit version which introduced a new deprecation.\r\n    In contrast to the previous (PHPUnit <= 9) behaviour where those deprecations could be ignored until the next major PHPUnit release.\r\n* (in most cases) Have an extra `--migration-configuration` step in the CI (with `continue-on-error`) just to be sure that their test run would not fail on an outdated (cross-version compatible) configuration.\r\n* If still supporting PHPUnit 9, those projects would also need two separate PHPUnit config file as the migration doesn't handle the `convertDeprecationsToExceptions` conversion to `displayDetailsOnTestsThatTriggerDeprecations` + `failOnDeprecation`.\r\n* etc\r\n\r\nTo me, the fact that PHPUnit deprecations affect the exit code is in stark contrast to the changes made in PHPUnit 9.5.x to no longer fail tests on PHP deprecation notices by default and in PHPUnit 10 to do the same for PHP warnings and notices.\r\nThe argument for that change was that most packages should be able to ignore those deprecations (notices/warnings) until the next PHP major, so these notices should not be a reason to fail the tests.\r\n\r\nBy that same logic, I should be able to ignore PHPUnit deprecation notices until the next PHPUnit major, but I no longer can if I **_do_** want to see PHP deprecation notices.\r\n\r\n\r\n### Current behavior\r\n\r\nAs things are, the test run will always fail on PHPUnit 11.x due to the PHPUnit deprecation notice \"Targeting a trait such as * with #[CoversClass] is deprecated, please refactor your test to use #[CoversTrait] instead.\" and exit with exit code 1.\r\n\r\n\r\n### How to reproduce\r\n\r\nI've created a reproduction sample here: https://github.com/jrfnl/bug-report-reproduction-scenarios/commits/phpunit/5937-fail-on-deprecation/\r\nCI run on the original test code: https://github.com/jrfnl/bug-report-reproduction-scenarios/actions/runs/10683893211\r\n\r\nThings I've considered/tried to see if I could find a work-around (also available as commits in the reproduction sample):\r\n* Adding both `#[CoversTrait]` (for PHPUnit 11) and `#[CoversClass]` (for PHPUnit 10).\r\n   Result: :x: still getting the `#[CoversClass]` deprecation notice on PHPUnit 11, tests can no longer run on PHPUnit 10 as it fails hard on a \"Attribute class not found\" fatal.\r\n    Commit: https://github.com/jrfnl/bug-report-reproduction-scenarios/commit/dab7ee536b74f14627c7739534ea36a972aebd34\r\n    CI run: https://github.com/jrfnl/bug-report-reproduction-scenarios/actions/runs/10683909438\r\n* Replacing the `#[CoversClass]` with `#[CoversTrait]`.\r\n    Result: :x: tests can no longer run on PHPUnit 10 as it fails hard on a \"Attribute class not found\" fatal.\r\n    Commit: https://github.com/jrfnl/bug-report-reproduction-scenarios/commit/01d0beb05af599dda5814da0dc21a54ba4b144e8\r\n    CI run: https://github.com/jrfnl/bug-report-reproduction-scenarios/actions/runs/10683924693\r\n* Adding variations of the `ignore*Deprecations` XML attributes in the config file.\r\n    Result: :x: PHPUnit 10 fails due to invalid configuration, PHPUnit 11 still fails on the `#[CoversClass]` deprecation notice.\r\n    Commit: https://github.com/jrfnl/bug-report-reproduction-scenarios/commit/3c5156772c475f2f13f543e0f01582725381e848\r\n    CI run: https://github.com/jrfnl/bug-report-reproduction-scenarios/actions/runs/10683935620\r\n    Commit: https://github.com/jrfnl/bug-report-reproduction-scenarios/commit/d680037bf63c62bf9780e9fea52522198bf8fef4\r\n    CI run: https://github.com/jrfnl/bug-report-reproduction-scenarios/actions/runs/10683946857\r\n    Commit: https://github.com/jrfnl/bug-report-reproduction-scenarios/commit/cc0c671b16ec37886cc62350ab73c64f0a949f87\r\n    CI run: https://github.com/jrfnl/bug-report-reproduction-scenarios/actions/runs/10683957942\r\n    Commit: https://github.com/jrfnl/bug-report-reproduction-scenarios/commit/f8eabfbe3d25d79711d9ee8bc6ec9c22eeaaea74\r\n    CI run: https://github.com/jrfnl/bug-report-reproduction-scenarios/actions/runs/10683968001\r\n* Adding the `@` silence operator to the `#[CoversClass]` attribute.\r\n    Result: :x: not supported by PHP, syntax error. Tried both `@#[CoversClass]` and `#[@CoversClass]`.\r\n    Commit: https://github.com/jrfnl/bug-report-reproduction-scenarios/commit/bce2fe063035f89373323036459ce57334581999\r\n    CI run: https://github.com/jrfnl/bug-report-reproduction-scenarios/actions/runs/10683977200\r\n* Conditionally adding the desired attribute\r\n    Result: :x: not supported by PHP, syntax error.\r\n    Commit: https://github.com/jrfnl/bug-report-reproduction-scenarios/commit/1e433e1ba33b75a6253e9e0882d64bf78333e4d7\r\n    CI run: https://github.com/jrfnl/bug-report-reproduction-scenarios/actions/runs/10683985742\r\n\r\nMaybe I'm overlooking yet another option and there is work-around, in which case: great! but I haven't been able to find one.\r\n\r\n\r\n### Expected behavior\r\n\r\nThe most optimal solution would be one where PHPUnit deprecation notices do not affect the exit code of the test run **ever**.\r\n\r\nThe second most optimal solution would be some sort of configuration setting in the XML file and via a CLI flag to ignore PHPUnit deprecation notices.\r\nYes, this would also need a CLI flag as if this is only available via the XML config, the XML file would cause failing builds on older PHPUnit versions due to invalid configuration.\r\n\r\nA much less optimal, but sort-of-workable solution would be one where the deprecation notice for using `#[CoversClass]` on traits is not thrown when there is _also_ a `#[CoversTrait]` attribute on the same test class, in combination with ignoring attributes which are not available in older PHPUnit versions.\r\n\r\n\r\n### Additional context\r\n\r\nClosely related issues:\r\n* #5199\r\n* #5406\r\n* #5799\r\n","closed_by":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5937/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5937/timeline","performed_via_github_app":null,"state_reason":"completed"}