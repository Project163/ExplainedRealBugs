{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/6174","repository_url":"https://api.github.com/repos/sebastianbergmann/phpunit","labels_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/6174/labels{/name}","comments_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/6174/comments","events_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/6174/events","html_url":"https://github.com/sebastianbergmann/phpunit/issues/6174","id":2975908139,"node_id":"I_kwDOAAbWLc6xYMEr","number":6174,"title":"`willReturnMap()` fails with nullable parameters when their default is `null` and no argument is passed for them","user":{"login":"frozenbrain","id":723221,"node_id":"MDQ6VXNlcjcyMzIyMQ==","avatar_url":"https://avatars.githubusercontent.com/u/723221?v=4","gravatar_id":"","url":"https://api.github.com/users/frozenbrain","html_url":"https://github.com/frozenbrain","followers_url":"https://api.github.com/users/frozenbrain/followers","following_url":"https://api.github.com/users/frozenbrain/following{/other_user}","gists_url":"https://api.github.com/users/frozenbrain/gists{/gist_id}","starred_url":"https://api.github.com/users/frozenbrain/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/frozenbrain/subscriptions","organizations_url":"https://api.github.com/users/frozenbrain/orgs","repos_url":"https://api.github.com/users/frozenbrain/repos","events_url":"https://api.github.com/users/frozenbrain/events{/privacy}","received_events_url":"https://api.github.com/users/frozenbrain/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":44001,"node_id":"MDU6TGFiZWw0NDAwMQ==","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/type/bug","name":"type/bug","color":"cc0000","default":false,"description":"Something is broken"},{"id":930693698,"node_id":"MDU6TGFiZWw5MzA2OTM2OTg=","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/feature/test-doubles","name":"feature/test-doubles","color":"e9b96e","default":false,"description":"Test Stubs and Mock Objects"},{"id":6451629111,"node_id":"LA_kwDOAAbWLc8AAAABgIwMNw","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/version/11","name":"version/11","color":"888a85","default":false,"description":"Something affects PHPUnit 11"},{"id":7573337865,"node_id":"LA_kwDOAAbWLc8AAAABw2f3CQ","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/version/12","name":"version/12","color":"888a85","default":false,"description":"Something affects PHPUnit 12"}],"state":"closed","locked":false,"assignee":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2025-04-07T07:35:03Z","updated_at":"2025-04-07T12:51:45Z","closed_at":"2025-04-07T12:51:45Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"| Q                   | A\n| --------------------| ---------------\n| PHPUnit version     | 12.1.0\n| PHP version         | 8.4.3\n| Installation Method | Composer\n\n#### Summary\n\nThe handling of default values in `willReturnMap` doesn't seem to take into account that parameters and/or default values may be null.\n\n#### Current behavior\n\n- Omitting a default null parameter in `willReturnMap` does not work and causes the mapping to never match (see `methodNullDefault` tests below)\n- Omitting a default non-null parameter does work, however doing so breaks the handling of other null parameters, even without default values (see `methodStringDefault` tests below)\n\nTherefore the only way to get the tests to pass is to provide the full set of parameters.\n\n#### How to reproduce\n\n```php\n<?php\n\nnamespace App;\n\ninterface SomeInterface\n{\n    public function methodNullDefault(?string $param, ?string $nullDefault = null): string;\n\n    public function methodStringDefault(?string $param, ?string $stringDefault = 'something'): string;\n}\n```\n```php\n<?php\n\nuse App\\SomeInterface;\nuse PHPUnit\\Framework\\TestCase;\n\nclass SomeInterfaceTest extends TestCase\n{\n    public function testMethodNullDefaultPasses(): void\n    {\n        $mock = $this->createMock(SomeInterface::class);\n        $mock->method('methodNullDefault')->willReturnMap([\n            ['A', null, 'ret'],\n        ]);\n\n        self::assertSame('ret', $mock->methodNullDefault('A'));\n    }\n\n    public function testMethodNullDefaultFails(): void\n    {\n        $mock = $this->createMock(SomeInterface::class);\n        $mock->method('methodNullDefault')->willReturnMap([\n            ['A', 'ret'],\n        ]);\n\n        self::assertSame('ret', $mock->methodNullDefault('A'));\n    }\n\n    public function testMethodStringDefaultPasses(): void\n    {\n        $mock = $this->createMock(SomeInterface::class);\n        $mock->method('methodStringDefault')->willReturnMap([\n            ['A', 'ret'],\n        ]);\n\n        self::assertSame('ret', $mock->methodStringDefault('A'));\n    }\n\n    public function testMethodStringDefaultFails(): void\n    {\n        $mock = $this->createMock(SomeInterface::class);\n        $mock->method('methodStringDefault')->willReturnMap([\n            [null, 'ret'],\n        ]);\n\n        self::assertSame('ret', $mock->methodStringDefault(null));\n    }\n}\n```\n\n#### Expected behavior\n\nAll of the above tests pass.\n\nI believe this is caused by the two `isset` calls in https://github.com/sebastianbergmann/phpunit/blob/cf54f48ea96f5b20add41c58b92f65fdafea50da/src/Framework/MockObject/Runtime/InvocationStubberImplementation.php#L221 which I would guess should be `array_key_exists` instead.\n\n#### Output of `composer info | sort`\n```\nmyclabs/deep-copy            1.13.0 Create deep copies (clones) of your objects\nnikic/php-parser             5.4.0  A PHP parser written in PHP\nphar-io/manifest             2.0.4  Component for reading phar.io manifest information from a PHP Archive (PHAR)\nphar-io/version              3.2.1  Library for handling version information and constraints\nphpunit/php-code-coverage    12.1.2 Library that provides collection, processing, and rendering functionality for PHP code coverage information.\nphpunit/php-file-iterator    6.0.0  FilterIterator implementation that filters files based on a list of suffixes.\nphpunit/php-invoker          6.0.0  Invoke callables with a timeout\nphpunit/php-text-template    5.0.0  Simple template engine.\nphpunit/php-timer            8.0.0  Utility class for timing\nphpunit/phpunit              12.1.0 The PHP Unit Testing framework.\nsebastian/cli-parser         4.0.0  Library for parsing CLI options\nsebastian/comparator         7.0.1  Provides the functionality to compare PHP values for equality\nsebastian/complexity         5.0.0  Library for calculating the complexity of PHP code units\nsebastian/diff               7.0.0  Diff implementation\nsebastian/environment        8.0.0  Provides functionality to handle HHVM/PHP environments\nsebastian/exporter           7.0.0  Provides the functionality to export PHP variables for visualization\nsebastian/global-state       8.0.0  Snapshotting of global state\nsebastian/lines-of-code      4.0.0  Library for counting the lines of code in PHP source code\nsebastian/object-enumerator  7.0.0  Traverses array structures and object graphs to enumerate all referenced objects\nsebastian/object-reflector   5.0.0  Allows reflection of object attributes, including inherited and non-public ones\nsebastian/recursion-context  7.0.0  Provides functionality to recursively process PHP variables\nsebastian/type               6.0.2  Collection of value objects that represent the types of the PHP type system\nsebastian/version            6.0.0  Library that helps with managing the version number of Git-hosted PHP projects\nstaabm/side-effects-detector 1.0.5  A static analysis tool to detect side effects in PHP code\ntheseer/tokenizer            1.2.3  A small library for converting tokenized PHP source code into XML and potentially other formats\n```","closed_by":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/6174/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/6174/timeline","performed_via_github_app":null,"state_reason":"completed"}