{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5857","repository_url":"https://api.github.com/repos/sebastianbergmann/phpunit","labels_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5857/labels{/name}","comments_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5857/comments","events_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5857/events","html_url":"https://github.com/sebastianbergmann/phpunit/issues/5857","id":2341742172,"node_id":"I_kwDOAAbWLc6LlCZc","number":5857,"title":"Mocked methods cannot be called from the original constructor of a partially mocked class","user":{"login":"sbuerk","id":1453466,"node_id":"MDQ6VXNlcjE0NTM0NjY=","avatar_url":"https://avatars.githubusercontent.com/u/1453466?v=4","gravatar_id":"","url":"https://api.github.com/users/sbuerk","html_url":"https://github.com/sbuerk","followers_url":"https://api.github.com/users/sbuerk/followers","following_url":"https://api.github.com/users/sbuerk/following{/other_user}","gists_url":"https://api.github.com/users/sbuerk/gists{/gist_id}","starred_url":"https://api.github.com/users/sbuerk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sbuerk/subscriptions","organizations_url":"https://api.github.com/users/sbuerk/orgs","repos_url":"https://api.github.com/users/sbuerk/repos","events_url":"https://api.github.com/users/sbuerk/events{/privacy}","received_events_url":"https://api.github.com/users/sbuerk/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":44001,"node_id":"MDU6TGFiZWw0NDAwMQ==","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/type/bug","name":"type/bug","color":"cc0000","default":false,"description":"Something is broken"},{"id":930693698,"node_id":"MDU6TGFiZWw5MzA2OTM2OTg=","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/feature/test-doubles","name":"feature/test-doubles","color":"e9b96e","default":false,"description":"Test Stubs and Mock Objects"},{"id":6451629111,"node_id":"LA_kwDOAAbWLc8AAAABgIwMNw","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/version/11","name":"version/11","color":"888a85","default":false,"description":"Something affects PHPUnit 11"}],"state":"closed","locked":false,"assignee":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":4,"created_at":"2024-06-08T17:05:54Z","updated_at":"2024-06-10T20:26:38Z","closed_at":"2024-06-10T20:14:59Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\r\n- Please do not report a bug for a version of PHPUnit that is no longer in Bugfix Support. A list of currently supported versions of PHPUnit is available at https://phpunit.de/supported-versions.html.\r\n- Please do not report an issue if you are using a version of PHP that is not supported by the version of PHPUnit you are using. A list that shows which version of PHP is supported by which version of PHPUnit is available at https://phpunit.de/supported-versions.html.\r\n- Please do not report an issue if you are not using PHPUnit directly, but rather a third-party wrapper around it.\r\n- Please do not report an issue if you are using a third-party extension such as alternative output printers.\r\n- Please do not report an issue for API changes in internal code (see https://phpunit.de/backward-compatibility.html#internal-code).\r\n- Please fill in this template according to your issue.\r\n- Please keep the table shown below at the top of your issue.\r\n- Please include the output of \"composer info | sort\" if you installed PHPUnit using Composer.\r\n- Please post code as text (using proper markup). Do not post screenshots of code.\r\n- Please make sure that you have configured your PHP interpreter like so: `error_reporting=-1`, `zend.assertions=1`.\r\n- Please remove this comment before submitting your issue.\r\n-->\r\n\r\n| Q                   | A\r\n| --------------------| ---------------\r\n| PHPUnit version     | 11.2.0\r\n| PHP version         | 8.2, 8.3\r\n| Installation Method | Composer + phpunit repo directly\r\n\r\n#### Summary\r\n\r\nA class method is called in the constructor and in other\r\nclass methods. Using `onlyMethods()` to mock that method\r\ndoes not regonized the calling (count) until now, but at\r\nleast subsequential calls could be tested and ensured.\r\n\r\nThis worked until 11.2.0 of phpunit and was detected in\r\nthe TYPO3 nightly pipeline automatically pulling in new\r\ndependency versions, like phpunit.\r\n\r\nNote: In manual tests this has been reduced to phpunit\r\nand other dependency ruled out. Can be reproduced within\r\nthe phpunit source code directly.\r\n\r\n#### Current behavior\r\n\r\nSince 11.2.0 this no longer works and a exception like following\r\nis thrown:\r\n\r\n```\r\nError: Typed property MockObject_ClassCallingMethodInConstructor_b5ada611::$__phpunit_state\r\nmust not be accessed before initialization\r\n```\r\n\r\n#### How to reproduce\r\n\r\nThis can be reproduced with a simple class:\r\n\r\n```php\r\n<?php declare(strict_types=1);\r\n\r\nnamespace Vendor\\Package;\r\n\r\nclass ClassCallingMethodInConstructor\r\n{\r\n    public function __construct()\r\n    {\r\n        $this->reset();\r\n    }\r\n\r\n    public function reset(): void\r\n    {\r\n    }\r\n\r\n    public function second(): void\r\n    {\r\n        $this->reset();\r\n    }\r\n}\r\n```\r\n\r\nand having a test like following:\r\n\r\n```php\r\nuse Vendor\\Package\\ClassCallingMethodInConstructor;\r\n\r\npublic function testOnlyMethodCalledInConstructorWorks(): void\r\n{\r\n  $testClassMock = $this->getMockBuilder(ClassCallingMethodInConstructor::class)\r\n     ->onlyMethods(['reset'])\r\n     ->getMock();\r\n\r\n  $testClassMock->expects($this::once())->method('reset');\r\n  $testClassMock->second();\r\n}\r\n```\r\n\r\n#### Expected behavior\r\n\r\nTest passes without error (green), which worked until 11.2.0.\r\n","closed_by":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5857/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5857/timeline","performed_via_github_app":null,"state_reason":"completed"}