{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/4934","repository_url":"https://api.github.com/repos/sebastianbergmann/phpunit","labels_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/4934/labels{/name}","comments_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/4934/comments","events_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/4934/events","html_url":"https://github.com/sebastianbergmann/phpunit/issues/4934","id":1170730355,"node_id":"I_kwDOAAbWLc5Fx-1z","number":4934,"title":"Code Coverage does not work with PHPUnit 8.5.24 PHAR on PHP 7","user":{"login":"osma","id":1132830,"node_id":"MDQ6VXNlcjExMzI4MzA=","avatar_url":"https://avatars.githubusercontent.com/u/1132830?v=4","gravatar_id":"","url":"https://api.github.com/users/osma","html_url":"https://github.com/osma","followers_url":"https://api.github.com/users/osma/followers","following_url":"https://api.github.com/users/osma/following{/other_user}","gists_url":"https://api.github.com/users/osma/gists{/gist_id}","starred_url":"https://api.github.com/users/osma/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/osma/subscriptions","organizations_url":"https://api.github.com/users/osma/orgs","repos_url":"https://api.github.com/users/osma/repos","events_url":"https://api.github.com/users/osma/events{/privacy}","received_events_url":"https://api.github.com/users/osma/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":44001,"node_id":"MDU6TGFiZWw0NDAwMQ==","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/type/bug","name":"type/bug","color":"cc0000","default":false,"description":"Something is broken"},{"id":1842312927,"node_id":"MDU6TGFiZWwxODQyMzEyOTI3","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/feature/code-coverage","name":"feature/code-coverage","color":"e9b96e","default":false,"description":"Issues related to code coverage (but not php-code-coverage)"},{"id":2046355097,"node_id":"MDU6TGFiZWwyMDQ2MzU1MDk3","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/installation/phar","name":"installation/phar","color":"729fcf","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":6,"created_at":"2022-03-16T09:05:15Z","updated_at":"2022-03-17T08:26:19Z","closed_at":"2022-03-16T16:27:09Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"| Q                   | A\r\n| --------------------| ---------------\r\n| PHPUnit version     | 8.5.24\r\n| PHP version         | 7.4.3\r\n| Installation Method | PHAR\r\n\r\n#### Summary\r\n\r\nThere appears to be a regression in PHPUnit 8.5.24 (compared to 8.5.23) when installed from PHAR. Enabling any coverage reports will cause all tests to fail. The error messages are related to php-token-stream; I suspect that something is wrong with the bundling of php-token-stream within the PHAR. I couldn't reproduce this when PHPUnit was installed via Composer.\r\n\r\nOriginally I found this problem when investigating why GitHub Actions CI tests for the Skosmos project started failing a few days ago, coinciding with the 8.5.24 release (see https://github.com/NatLibFi/Skosmos/issues/1288 for background and details) but I was eventually able to reproduce the problem with a much more minimal test case that I'm reporting here.\r\n\r\n#### Current behavior\r\n\r\nHere is an example of broken tests:\r\n\r\n```\r\n$ php phpunit-8.5.24.phar --bootstrap src/autoload.php --coverage-text --whitelist src tests\r\nPHPUnit 8.5.24 #StandWithUkraine\r\n\r\nPHP Fatal error:  Uncaught Error: Class 'PHP_Token_OPEN_TAG' not found in phar:///REDACTED/phpunit-coverage-debug/phpunit-8.5.24.phar/php-token-stream/Token/Stream.php:131\r\nStack trace:\r\n#0 phar:///REDACTED/phpunit-coverage-debug/phpunit-8.5.24.phar/php-token-stream/Token/Stream.php(73): PHPUnit\\PHP_Token_Stream->scan()\r\n#1 phar:///REDACTED/phpunit-coverage-debug/phpunit-8.5.24.phar/php-code-coverage/CodeCoverage.php(515): PHPUnit\\PHP_Token_Stream->__construct()\r\n#2 phar:///REDACTED/phpunit-coverage-debug/phpunit-8.5.24.phar/php-code-coverage/CodeCoverage.php(496): PHPUnit\\SebastianBergmann\\CodeCoverage\\CodeCoverage->getLinesToBeIgnoredInner()\r\n#3 phar:///REDACTED/phpunit-coverage-debug/phpunit-8.5.24.phar/php-code-coverage/CodeCoverage.php(450): PHPUnit\\SebastianBergmann\\CodeCoverage\\CodeCoverage->getLinesToBeIgnored()\r\n#4 phar:///REDACTED/phpunit-coverage-debug/phpunit-8.5.24.phar/php-code-coverage/CodeCoverage.php(254): PHPUnit\\Sebasti in phar:///REDACTED/phpunit-coverage-debug/phpunit-8.5.24.phar/php-token-stream/Token/Stream.php on line 131\r\n```\r\n\r\n#### How to reproduce\r\n\r\nPreconditions: PHP 7.x (seems to affect all of 7.2, 7.3 and 7.4), PHPUnit 8.5.24 installed from PHAR, and either XDebug or PCOV is installed so that coverage collection is possible.\r\n\r\nHere is a very simple test project based on the [PHPUnit 8 tutorial](https://phpunit.de/getting-started/phpunit-8.html).\r\n\r\nsrc/Email.php (unchanged from tutorial):\r\n```php\r\n<?php declare(strict_types=1);\r\nfinal class Email\r\n{\r\n    private $email;\r\n\r\n    private function __construct(string $email)\r\n    {\r\n        $this->ensureIsValidEmail($email);\r\n\r\n        $this->email = $email;\r\n    }\r\n\r\n    public static function fromString(string $email): self\r\n    {\r\n        return new self($email);\r\n    }\r\n\r\n    public function __toString(): string\r\n    {\r\n        return $this->email;\r\n    }\r\n\r\n    private function ensureIsValidEmail(string $email): void\r\n    {\r\n        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {\r\n            throw new InvalidArgumentException(\r\n                sprintf(\r\n                    '\"%s\" is not a valid email address',\r\n                    $email\r\n                )\r\n            );\r\n        }\r\n    }\r\n}\r\n```\r\n\r\ntests/EmailTest.php (unchanged from tutorial):\r\n```php\r\n<?php declare(strict_types=1);\r\nuse PHPUnit\\Framework\\TestCase;\r\n\r\nfinal class EmailTest extends TestCase\r\n{\r\n    public function testCanBeCreatedFromValidEmailAddress(): void\r\n    {\r\n        $this->assertInstanceOf(\r\n            Email::class,\r\n            Email::fromString('user@example.com')\r\n        );\r\n    }\r\n\r\n    public function testCannotBeCreatedFromInvalidEmailAddress(): void\r\n    {\r\n        $this->expectException(InvalidArgumentException::class);\r\n\r\n        Email::fromString('invalid');\r\n    }\r\n\r\n    public function testCanBeUsedAsString(): void\r\n    {\r\n        $this->assertEquals(\r\n            'user@example.com',\r\n            Email::fromString('user@example.com')\r\n        );\r\n    }\r\n}\r\n```\r\n\r\nsrc/autoload.php (hand-crafted):\r\n```php\r\n<?php\r\n\r\nrequire_once('Email.php');\r\n```\r\n\r\n\r\n#### Expected behavior\r\n\r\nThis is how it works with PHPUnit 8.5.23 and how I expect it should work also with the newest version:\r\n\r\n```\r\n$ php phpunit-8.5.23.phar --bootstrap src/autoload.php --coverage-text --whitelist src tests\r\nPHPUnit 8.5.23 by Sebastian Bergmann and contributors.\r\n\r\n...                                                                 3 / 3 (100%)\r\n\r\nTime: 131 ms, Memory: 17.02 MB\r\n\r\nOK (3 tests, 3 assertions)\r\n\r\n\r\nCode Coverage Report:    \r\n  2022-03-16 10:59:42    \r\n                         \r\n Summary:                \r\n  Classes: 100.00% (1/1) \r\n  Methods: 100.00% (4/4) \r\n  Lines:   91.67% (11/12)\r\n\r\nEmail\r\n  Methods: 100.00% ( 4/ 4)   Lines: 100.00% ( 11/ 11)\r\n```\r\n\r\n","closed_by":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/4934/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/4934/timeline","performed_via_github_app":null,"state_reason":"completed"}