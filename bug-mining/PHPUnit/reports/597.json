{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/4435","repository_url":"https://api.github.com/repos/sebastianbergmann/phpunit","labels_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/4435/labels{/name}","comments_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/4435/comments","events_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/4435/events","html_url":"https://github.com/sebastianbergmann/phpunit/issues/4435","id":684716549,"node_id":"MDU6SXNzdWU2ODQ3MTY1NDk=","number":4435,"title":"Global assert wrappers break preloading","user":{"login":"iquito","id":973653,"node_id":"MDQ6VXNlcjk3MzY1Mw==","avatar_url":"https://avatars.githubusercontent.com/u/973653?v=4","gravatar_id":"","url":"https://api.github.com/users/iquito","html_url":"https://github.com/iquito","followers_url":"https://api.github.com/users/iquito/followers","following_url":"https://api.github.com/users/iquito/following{/other_user}","gists_url":"https://api.github.com/users/iquito/gists{/gist_id}","starred_url":"https://api.github.com/users/iquito/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iquito/subscriptions","organizations_url":"https://api.github.com/users/iquito/orgs","repos_url":"https://api.github.com/users/iquito/repos","events_url":"https://api.github.com/users/iquito/events{/privacy}","received_events_url":"https://api.github.com/users/iquito/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":44001,"node_id":"MDU6TGFiZWw0NDAwMQ==","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/type/bug","name":"type/bug","color":"cc0000","default":false,"description":"Something is broken"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-08-24T14:29:23Z","updated_at":"2020-08-24T15:02:32Z","closed_at":"2020-08-24T15:02:32Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"| Q                   | A\r\n| --------------------| ---------------\r\n| PHPUnit version     | 9.3.7\r\n| PHP version         | 7.4.9\r\n| Installation Method | Composer\r\n\r\n#### Summary\r\n\r\nWhen using PHP 7.4 with preloading, Composer and PHPUnit there is always a fatal error because the global assert functions of PHPUnit are included via preloading and via Composer for each script, leading to a cannot-redeclare-function error.\r\n\r\n#### Current behavior + How to reproduce\r\n\r\nEnable preloading in php.ini and use the autoload.php file from Composer as a preload file, which will automatically preload `PHPUnit\\Framework\\Functions.php`. Then load any PHP file which includes autoload.php from Composer and there will be this error:\r\n\r\n```PHP Fatal error:  Cannot redeclare PHPUnit\\Framework\\assertArrayHasKey() (previously declared in /var/www/html/vendor/phpunit/phpunit/src/Framework/Assert/Functions.php:84) in /var/www/html/vendor/phpunit/phpunit/src/Framework/Assert/Functions.php on line 84```\r\n\r\nThis happens because the file is included again by composer and PHPUnit only checks the `__PHPUNIT_GLOBAL_ASSERT_WRAPPERS__` constant to check if the functions have been loaded, which is not set through preloading (only functions and classes are preloaded), yet all the functions are already permanently defined via preloading.\r\n\r\n#### Expected behavior\r\n\r\nPHPUnit could check if at least the first function is defined, or even if each function is defined in the file. Replacing\r\n\r\n```php\r\nif (!defined('__PHPUNIT_GLOBAL_ASSERT_WRAPPERS__')) {\r\n  // function definitions\r\n}\r\n```\r\n\r\nwith\r\n\r\n```php\r\nif (!defined('__PHPUNIT_GLOBAL_ASSERT_WRAPPERS__') && !function_exists(__NAMESPACE__ . '\\assertArrayHasKey')) {\r\n  // function definitions\r\n}\r\n```\r\n\r\nwould already solve the problem and lead to preloading and PHPUnit working again when used together.","closed_by":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/4435/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":1,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/4435/timeline","performed_via_github_app":null,"state_reason":"completed"}