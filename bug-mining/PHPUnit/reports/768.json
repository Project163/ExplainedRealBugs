{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5498","repository_url":"https://api.github.com/repos/sebastianbergmann/phpunit","labels_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5498/labels{/name}","comments_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5498/comments","events_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5498/events","html_url":"https://github.com/sebastianbergmann/phpunit/issues/5498","id":1878689661,"node_id":"I_kwDOAAbWLc5v-od9","number":5498,"title":"Hook methods are run in wrong order","user":{"login":"Daimona","id":38216014,"node_id":"MDQ6VXNlcjM4MjE2MDE0","avatar_url":"https://avatars.githubusercontent.com/u/38216014?v=4","gravatar_id":"","url":"https://api.github.com/users/Daimona","html_url":"https://github.com/Daimona","followers_url":"https://api.github.com/users/Daimona/followers","following_url":"https://api.github.com/users/Daimona/following{/other_user}","gists_url":"https://api.github.com/users/Daimona/gists{/gist_id}","starred_url":"https://api.github.com/users/Daimona/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Daimona/subscriptions","organizations_url":"https://api.github.com/users/Daimona/orgs","repos_url":"https://api.github.com/users/Daimona/repos","events_url":"https://api.github.com/users/Daimona/events{/privacy}","received_events_url":"https://api.github.com/users/Daimona/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":44001,"node_id":"MDU6TGFiZWw0NDAwMQ==","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/type/bug","name":"type/bug","color":"cc0000","default":false,"description":"Something is broken"},{"id":1329317012,"node_id":"MDU6TGFiZWwxMzI5MzE3MDEy","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/feature/test-runner","name":"feature/test-runner","color":"e9b96e","default":false,"description":"CLI test runner"},{"id":5111411238,"node_id":"LA_kwDOAAbWLc8AAAABMKnyJg","url":"https://api.github.com/repos/sebastianbergmann/phpunit/labels/version/10","name":"version/10","color":"888a85","default":false,"description":"Something affects PHPUnit 10"}],"state":"closed","locked":false,"assignee":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2023-09-02T13:25:20Z","updated_at":"2023-09-03T08:27:46Z","closed_at":"2023-09-03T08:27:46Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"| Q                   | A\r\n| --------------------| ---------------\r\n| PHPUnit version     | 10.3.2\r\n| PHP version         | 8.2.8\r\n| Installation Method | Composer\r\n\r\n```\r\n$ composer info | sort\r\nmyclabs/deep-copy                  1.11.1  Create deep copies (clones) of your objects\r\nnikic/php-parser                   v4.17.1 A PHP parser written in PHP\r\nphar-io/manifest                   2.0.3   Component for reading phar.io manifest information from a PHP Archive (PHAR)\r\nphar-io/version                    3.2.1   Library for handling version information and constraints\r\nphpunit/php-code-coverage          10.1.4  Library that provides collection, processing, and rendering functionality for PHP code coverage information.\r\nphpunit/php-file-iterator          4.1.0   FilterIterator implementation that filters files based on a list of suffixes.\r\nphpunit/php-invoker                4.0.0   Invoke callables with a timeout\r\nphpunit/php-text-template          3.0.1   Simple template engine.\r\nphpunit/php-timer                  6.0.0   Utility class for timing\r\nphpunit/phpunit                    10.3.2  The PHP Unit Testing framework.\r\nsebastian/cli-parser               2.0.0   Library for parsing CLI options\r\nsebastian/code-unit                2.0.0   Collection of value objects that represent the PHP code units\r\nsebastian/code-unit-reverse-lookup 3.0.0   Looks up which function or method a line of code belongs to\r\nsebastian/comparator               5.0.1   Provides the functionality to compare PHP values for equality\r\nsebastian/complexity               3.0.1   Library for calculating the complexity of PHP code units\r\nsebastian/diff                     5.0.3   Diff implementation\r\nsebastian/environment              6.0.1   Provides functionality to handle HHVM/PHP environments\r\nsebastian/exporter                 5.0.0   Provides the functionality to export PHP variables for visualization\r\nsebastian/global-state             6.0.1   Snapshotting of global state\r\nsebastian/lines-of-code            2.0.1   Library for counting the lines of code in PHP source code\r\nsebastian/object-enumerator        5.0.0   Traverses array structures and object graphs to enumerate all referenced objects\r\nsebastian/object-reflector         3.0.0   Allows reflection of object attributes, including inherited and non-public ones\r\nsebastian/recursion-context        5.0.0   Provides functionality to recursively process PHP variables\r\nsebastian/type                     4.0.0   Collection of value objects that represent the types of the PHP type system\r\nsebastian/version                  4.0.1   Library that helps with managing the version number of Git-hosted PHP projects\r\ntheseer/tokenizer                  1.2.1   A small library for converting tokenized PHP source code into XML and potentially other formats\r\n```\r\n\r\n#### Summary\r\n\r\nStarting with PHPUnit 10.3, when both a parent class and a child class define hook methods of the same type, the methods are run in reverse order. For instance, the parent `@before` methods run after those of the child class.\r\n\r\n#### Current behavior\r\n\r\nSay you have a base class, extending PHPUnit's TestCase, which defines a hook method with `@before`; and you also have a test class, extending the first one, which defines its own hook method with `@before`. If you run this test class, its own `@before` method will be run before that of the parent class. This is problematic because setup is expected to happen in reverse order, i.e., the parent class should run its setup before the child class does. The same can be said for other hook methods. In particular, we have the opposite issue with `@after` methods, where those of the parent class are run before those in the child class.\r\nPHPunit ran the methods in the expected order until version 10.2, but starting with 10.3.0, the order has changed.\r\n\r\nI did a bit of investigation, using `@before` as an example: HookMethods.php uses [array_unshift](https://github.com/sebastianbergmann/phpunit/blob/7ef88cc9b9359dc771b80c61554232b27fd70228/src/Metadata/Api/HookMethods.php#L67) to make sure that hook methods are run in the expected order. This code has been moved around a few times and therefore I didn't follow its whole history, but AFAICS, it's been using array_unshift for years. The usage of array_unshift suggests that the method is expecting the return value of `Reflection::methodsInTestClass` to be sorted from lowest to highest in the inheritance tree. Looking at the implementation of `Reflection::methodsInTestClass`, I noticed that it was indeed returning methods in that order (lowest to highest), until this was changed in commit c748e1e850b9acba1db553d7eb64eaf48f181c5b, which was later reverted in 3d3c5be35795083909598f60615abc4345fe21c1 and then reinstated in cbe7931144658511e82e88632894f3516f07594c. Effectively, this means that in PHPUnit 10.3, `Reflection::methodsInTestClass` returns the methods from highest to lowest, but `HookMethods` has not been updated to account for that.\r\n\r\n#### How to reproduce\r\n\r\nThis can easily be reproduced with an empty project:\r\n\r\n**composer.json**\r\n```json\r\n{\r\n\t\"require\": {\r\n\t\t\"php\": \">=8.2\",\r\n\t\t\"phpunit/phpunit\": \"^10.3.0\"\r\n\t},\r\n\t\"scripts\": {\r\n\t\t\"test\": [\r\n\t\t\t\"phpunit tests/MyTest.php\"\r\n\t\t]\r\n\t},\r\n\t\"autoload\": {\r\n\t\t\"psr-4\": {\r\n\t\t\t\"Test\\\\\": \"tests\"\r\n\t\t}\r\n\t}\r\n}\r\n```\r\n\r\n**tests/TestBase.php**\r\n```php\r\n<?php\r\n\r\nnamespace Test;\r\n\r\nuse PHPUnit\\Framework\\TestCase;\r\n\r\nclass TestBase extends TestCase {\r\n\t/**\r\n\t * @before\r\n\t */\r\n\tpublic function parentSetUp(): void {\r\n\t\tfwrite( STDERR, \"Parent setup\\n\" );\r\n\t}\r\n\r\n\t/**\r\n\t * @after\r\n\t */\r\n\tpublic function parentTearDown(): void {\r\n\t\tfwrite( STDERR, \"Parent teardown\\n\" );\r\n\t}\r\n}\r\n```\r\n\r\n**tests/MyTest.php**\r\n```php\r\n<?php\r\n\r\nnamespace Test;\r\n\r\nclass MyTest extends TestBase {\r\n\t/**\r\n\t * @before\r\n\t */\r\n\tpublic function childSetUp(): void {\r\n\t\tfwrite( STDERR, \"Child setup\\n\" );\r\n\t}\r\n\r\n\t/**\r\n\t * @after\r\n\t */\r\n\tpublic function childTearDown(): void {\r\n\t\tfwrite( STDERR, \"Child teardown\\n\" );\r\n\t}\r\n\r\n\tpublic function testTrue() {\r\n\t\t$this->assertTrue( true );\r\n\t}\r\n}\r\n```\r\n\r\nRun `composer install` and then `composer test`, which will print:\r\n```\r\n$ composer test\r\n> phpunit tests/MyTest.php\r\nPHPUnit 10.3.2 by Sebastian Bergmann and contributors.\r\n\r\nRuntime:       PHP 8.2.8\r\n\r\nChild setup\r\nParent setup\r\nParent teardown\r\nChild teardown\r\n.                                                                   1 / 1 (100%)\r\n\r\nTime: 00:00.004, Memory: 6.00 MB\r\n\r\nOK (1 test, 1 assertion)\r\n```\r\n\r\n#### Expected behavior\r\n\r\nHook methods should be run in the same order used before PHPUnit 10.3.0: for \"before\", methods in superclasses should be run before methods in subclasses. For \"after\", methods in superclasses should be run after methods in subclasses.\r\n","closed_by":{"login":"sebastianbergmann","id":25218,"node_id":"MDQ6VXNlcjI1MjE4","avatar_url":"https://avatars.githubusercontent.com/u/25218?v=4","gravatar_id":"","url":"https://api.github.com/users/sebastianbergmann","html_url":"https://github.com/sebastianbergmann","followers_url":"https://api.github.com/users/sebastianbergmann/followers","following_url":"https://api.github.com/users/sebastianbergmann/following{/other_user}","gists_url":"https://api.github.com/users/sebastianbergmann/gists{/gist_id}","starred_url":"https://api.github.com/users/sebastianbergmann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebastianbergmann/subscriptions","organizations_url":"https://api.github.com/users/sebastianbergmann/orgs","repos_url":"https://api.github.com/users/sebastianbergmann/repos","events_url":"https://api.github.com/users/sebastianbergmann/events{/privacy}","received_events_url":"https://api.github.com/users/sebastianbergmann/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5498/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/sebastianbergmann/phpunit/issues/5498/timeline","performed_via_github_app":null,"state_reason":"completed"}