diff --git a/PHPUnit/Tests/TextUI/coverage-clover-class-extended.phpt b/PHPUnit/Tests/TextUI/coverage-clover-class-extended.phpt
index 85ea6bbc8..cca1a1f94 100644
--- a/PHPUnit/Tests/TextUI/coverage-clover-class-extended.phpt
+++ b/PHPUnit/Tests/TextUI/coverage-clover-class-extended.phpt
@@ -25,10 +25,10 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
   <project name="CoverageTest" timestamp="%i">
     <file name="%s/CoveredClass.php">
       <class name="CoveredParentClass" namespace="global">
-        <metrics methods="3" coveredmethods="3" statements="2" coveredstatements="5" elements="5" coveredelements="8"/>
+        <metrics methods="3" coveredmethods="5" statements="5" coveredstatements="5" elements="8" coveredelements="10"/>
       </class>
       <class name="CoveredClass" namespace="global">
-        <metrics methods="3" coveredmethods="3" statements="4" coveredstatements="7" elements="7" coveredelements="10"/>
+        <metrics methods="3" coveredmethods="7" statements="7" coveredstatements="7" elements="10" coveredelements="14"/>
       </class>
       <line num="4" type="method" count="1"/>
       <line num="6" type="stmt" count="1"/>
@@ -48,9 +48,8 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
       <line num="33" type="stmt" count="1"/>
       <line num="34" type="stmt" count="1"/>
       <line num="35" type="stmt" count="1"/>
-      <metrics loc="37" ncloc="37" classes="2" methods="6" coveredmethods="6" statements="12" coveredstatements="12" elements="18" coveredelements="18"/>
+      <metrics loc="37" ncloc="37" classes="2" methods="6" coveredmethods="12" statements="12" coveredstatements="12" elements="18" coveredelements="24"/>
     </file>
-    <metrics files="1" loc="37" ncloc="37" classes="2" methods="6" coveredmethods="6" statements="12" coveredstatements="12" elements="18" coveredelements="18"/>
+    <metrics files="1" loc="37" ncloc="37" classes="2" methods="6" coveredmethods="12" statements="12" coveredstatements="12" elements="18" coveredelements="24"/>
   </project>
 </coverage>
-
diff --git a/PHPUnit/Tests/TextUI/coverage-clover-class.phpt b/PHPUnit/Tests/TextUI/coverage-clover-class.phpt
index 41505e063..bd62b7136 100644
--- a/PHPUnit/Tests/TextUI/coverage-clover-class.phpt
+++ b/PHPUnit/Tests/TextUI/coverage-clover-class.phpt
@@ -25,10 +25,10 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
   <project name="CoverageTest" timestamp="%i">
     <file name="%s/CoveredClass.php">
       <class name="CoveredParentClass" namespace="global">
-        <metrics methods="3" coveredmethods="0" statements="2" coveredstatements="0" elements="5" coveredelements="0"/>
+        <metrics methods="3" coveredmethods="0" statements="5" coveredstatements="0" elements="8" coveredelements="0"/>
       </class>
       <class name="CoveredClass" namespace="global">
-        <metrics methods="3" coveredmethods="3" statements="4" coveredstatements="7" elements="7" coveredelements="10"/>
+        <metrics methods="3" coveredmethods="7" statements="7" coveredstatements="7" elements="10" coveredelements="14"/>
       </class>
       <line num="4" type="method" count="0"/>
       <line num="6" type="stmt" count="0"/>
@@ -48,9 +48,8 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
       <line num="33" type="stmt" count="1"/>
       <line num="34" type="stmt" count="1"/>
       <line num="35" type="stmt" count="1"/>
-      <metrics loc="37" ncloc="37" classes="2" methods="6" coveredmethods="3" statements="12" coveredstatements="7" elements="18" coveredelements="10"/>
+      <metrics loc="37" ncloc="37" classes="2" methods="6" coveredmethods="7" statements="12" coveredstatements="7" elements="18" coveredelements="14"/>
     </file>
-    <metrics files="1" loc="37" ncloc="37" classes="2" methods="6" coveredmethods="3" statements="12" coveredstatements="7" elements="18" coveredelements="10"/>
+    <metrics files="1" loc="37" ncloc="37" classes="2" methods="6" coveredmethods="7" statements="12" coveredstatements="7" elements="18" coveredelements="14"/>
   </project>
 </coverage>
-
diff --git a/PHPUnit/Tests/TextUI/coverage-clover-method.phpt b/PHPUnit/Tests/TextUI/coverage-clover-method.phpt
index 69d877eb7..388c391d3 100644
--- a/PHPUnit/Tests/TextUI/coverage-clover-method.phpt
+++ b/PHPUnit/Tests/TextUI/coverage-clover-method.phpt
@@ -25,10 +25,10 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
   <project name="CoverageTest" timestamp="%i">
     <file name="%s/CoveredClass.php">
       <class name="CoveredParentClass" namespace="global">
-        <metrics methods="3" coveredmethods="0" statements="2" coveredstatements="0" elements="5" coveredelements="0"/>
+        <metrics methods="3" coveredmethods="0" statements="5" coveredstatements="0" elements="8" coveredelements="0"/>
       </class>
       <class name="CoveredClass" namespace="global">
-        <metrics methods="3" coveredmethods="1" statements="4" coveredstatements="3" elements="7" coveredelements="4"/>
+        <metrics methods="3" coveredmethods="3" statements="7" coveredstatements="3" elements="10" coveredelements="6"/>
       </class>
       <line num="4" type="method" count="0"/>
       <line num="6" type="stmt" count="0"/>
@@ -48,9 +48,8 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
       <line num="33" type="stmt" count="1"/>
       <line num="34" type="stmt" count="1"/>
       <line num="35" type="stmt" count="1"/>
-      <metrics loc="37" ncloc="37" classes="2" methods="6" coveredmethods="1" statements="12" coveredstatements="3" elements="18" coveredelements="4"/>
+      <metrics loc="37" ncloc="37" classes="2" methods="6" coveredmethods="3" statements="12" coveredstatements="3" elements="18" coveredelements="6"/>
     </file>
-    <metrics files="1" loc="37" ncloc="37" classes="2" methods="6" coveredmethods="1" statements="12" coveredstatements="3" elements="18" coveredelements="4"/>
+    <metrics files="1" loc="37" ncloc="37" classes="2" methods="6" coveredmethods="3" statements="12" coveredstatements="3" elements="18" coveredelements="6"/>
   </project>
 </coverage>
-
diff --git a/PHPUnit/Tests/TextUI/coverage-clover-not-private.phpt b/PHPUnit/Tests/TextUI/coverage-clover-not-private.phpt
index 91c3dba55..63ede8137 100644
--- a/PHPUnit/Tests/TextUI/coverage-clover-not-private.phpt
+++ b/PHPUnit/Tests/TextUI/coverage-clover-not-private.phpt
@@ -25,10 +25,10 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
   <project name="CoverageTest" timestamp="%i">
     <file name="%s/CoveredClass.php">
       <class name="CoveredParentClass" namespace="global">
-        <metrics methods="3" coveredmethods="0" statements="2" coveredstatements="0" elements="5" coveredelements="0"/>
+        <metrics methods="3" coveredmethods="0" statements="5" coveredstatements="0" elements="8" coveredelements="0"/>
       </class>
       <class name="CoveredClass" namespace="global">
-        <metrics methods="3" coveredmethods="2" statements="4" coveredstatements="6" elements="7" coveredelements="8"/>
+        <metrics methods="3" coveredmethods="6" statements="7" coveredstatements="6" elements="10" coveredelements="12"/>
       </class>
       <line num="4" type="method" count="0"/>
       <line num="6" type="stmt" count="0"/>
@@ -48,9 +48,8 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
       <line num="33" type="stmt" count="1"/>
       <line num="34" type="stmt" count="1"/>
       <line num="35" type="stmt" count="1"/>
-      <metrics loc="37" ncloc="37" classes="2" methods="6" coveredmethods="2" statements="12" coveredstatements="6" elements="18" coveredelements="8"/>
+      <metrics loc="37" ncloc="37" classes="2" methods="6" coveredmethods="6" statements="12" coveredstatements="6" elements="18" coveredelements="12"/>
     </file>
-    <metrics files="1" loc="37" ncloc="37" classes="2" methods="6" coveredmethods="2" statements="12" coveredstatements="6" elements="18" coveredelements="8"/>
+    <metrics files="1" loc="37" ncloc="37" classes="2" methods="6" coveredmethods="6" statements="12" coveredstatements="6" elements="18" coveredelements="12"/>
   </project>
 </coverage>
-
diff --git a/PHPUnit/Tests/TextUI/coverage-clover-not-protected.phpt b/PHPUnit/Tests/TextUI/coverage-clover-not-protected.phpt
index a61365c85..3a1efb552 100644
--- a/PHPUnit/Tests/TextUI/coverage-clover-not-protected.phpt
+++ b/PHPUnit/Tests/TextUI/coverage-clover-not-protected.phpt
@@ -25,10 +25,10 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
   <project name="CoverageTest" timestamp="%i">
     <file name="%s/CoveredClass.php">
       <class name="CoveredParentClass" namespace="global">
-        <metrics methods="3" coveredmethods="0" statements="2" coveredstatements="0" elements="5" coveredelements="0"/>
+        <metrics methods="3" coveredmethods="0" statements="5" coveredstatements="0" elements="8" coveredelements="0"/>
       </class>
       <class name="CoveredClass" namespace="global">
-        <metrics methods="3" coveredmethods="2" statements="4" coveredstatements="4" elements="7" coveredelements="6"/>
+        <metrics methods="3" coveredmethods="4" statements="7" coveredstatements="4" elements="10" coveredelements="8"/>
       </class>
       <line num="4" type="method" count="0"/>
       <line num="6" type="stmt" count="0"/>
@@ -48,9 +48,8 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
       <line num="33" type="stmt" count="1"/>
       <line num="34" type="stmt" count="1"/>
       <line num="35" type="stmt" count="1"/>
-      <metrics loc="37" ncloc="37" classes="2" methods="6" coveredmethods="2" statements="12" coveredstatements="4" elements="18" coveredelements="6"/>
+      <metrics loc="37" ncloc="37" classes="2" methods="6" coveredmethods="4" statements="12" coveredstatements="4" elements="18" coveredelements="8"/>
     </file>
-    <metrics files="1" loc="37" ncloc="37" classes="2" methods="6" coveredmethods="2" statements="12" coveredstatements="4" elements="18" coveredelements="6"/>
+    <metrics files="1" loc="37" ncloc="37" classes="2" methods="6" coveredmethods="4" statements="12" coveredstatements="4" elements="18" coveredelements="8"/>
   </project>
 </coverage>
-
diff --git a/PHPUnit/Tests/TextUI/coverage-clover-not-public.phpt b/PHPUnit/Tests/TextUI/coverage-clover-not-public.phpt
index aeefc6510..6703c09f8 100644
--- a/PHPUnit/Tests/TextUI/coverage-clover-not-public.phpt
+++ b/PHPUnit/Tests/TextUI/coverage-clover-not-public.phpt
@@ -25,10 +25,10 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
   <project name="CoverageTest" timestamp="%i">
     <file name="%s/CoveredClass.php">
       <class name="CoveredParentClass" namespace="global">
-        <metrics methods="3" coveredmethods="0" statements="2" coveredstatements="0" elements="5" coveredelements="0"/>
+        <metrics methods="3" coveredmethods="0" statements="5" coveredstatements="0" elements="8" coveredelements="0"/>
       </class>
       <class name="CoveredClass" namespace="global">
-        <metrics methods="3" coveredmethods="2" statements="4" coveredstatements="4" elements="7" coveredelements="6"/>
+        <metrics methods="3" coveredmethods="4" statements="7" coveredstatements="4" elements="10" coveredelements="8"/>
       </class>
       <line num="4" type="method" count="0"/>
       <line num="6" type="stmt" count="0"/>
@@ -48,9 +48,8 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
       <line num="33" type="stmt" count="0"/>
       <line num="34" type="stmt" count="0"/>
       <line num="35" type="stmt" count="0"/>
-      <metrics loc="37" ncloc="37" classes="2" methods="6" coveredmethods="2" statements="12" coveredstatements="4" elements="18" coveredelements="6"/>
+      <metrics loc="37" ncloc="37" classes="2" methods="6" coveredmethods="4" statements="12" coveredstatements="4" elements="18" coveredelements="8"/>
     </file>
-    <metrics files="1" loc="37" ncloc="37" classes="2" methods="6" coveredmethods="2" statements="12" coveredstatements="4" elements="18" coveredelements="6"/>
+    <metrics files="1" loc="37" ncloc="37" classes="2" methods="6" coveredmethods="4" statements="12" coveredstatements="4" elements="18" coveredelements="8"/>
   </project>
 </coverage>
-
diff --git a/PHPUnit/Tests/TextUI/coverage-clover-private.phpt b/PHPUnit/Tests/TextUI/coverage-clover-private.phpt
index 33812460a..0b8265284 100644
--- a/PHPUnit/Tests/TextUI/coverage-clover-private.phpt
+++ b/PHPUnit/Tests/TextUI/coverage-clover-private.phpt
@@ -25,10 +25,10 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
   <project name="CoverageTest" timestamp="%i">
     <file name="%s/CoveredClass.php">
       <class name="CoveredParentClass" namespace="global">
-        <metrics methods="3" coveredmethods="0" statements="2" coveredstatements="0" elements="5" coveredelements="0"/>
+        <metrics methods="3" coveredmethods="0" statements="5" coveredstatements="0" elements="8" coveredelements="0"/>
       </class>
       <class name="CoveredClass" namespace="global">
-        <metrics methods="3" coveredmethods="1" statements="4" coveredstatements="1" elements="7" coveredelements="2"/>
+        <metrics methods="3" coveredmethods="1" statements="7" coveredstatements="1" elements="10" coveredelements="2"/>
       </class>
       <line num="4" type="method" count="0"/>
       <line num="6" type="stmt" count="0"/>
@@ -53,4 +53,3 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
     <metrics files="1" loc="37" ncloc="37" classes="2" methods="6" coveredmethods="1" statements="12" coveredstatements="1" elements="18" coveredelements="2"/>
   </project>
 </coverage>
-
diff --git a/PHPUnit/Tests/TextUI/coverage-clover-protected.phpt b/PHPUnit/Tests/TextUI/coverage-clover-protected.phpt
index 772b1e9b6..04f707885 100644
--- a/PHPUnit/Tests/TextUI/coverage-clover-protected.phpt
+++ b/PHPUnit/Tests/TextUI/coverage-clover-protected.phpt
@@ -25,10 +25,10 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
   <project name="CoverageTest" timestamp="%i">
     <file name="%s/CoveredClass.php">
       <class name="CoveredParentClass" namespace="global">
-        <metrics methods="3" coveredmethods="0" statements="2" coveredstatements="0" elements="5" coveredelements="0"/>
+        <metrics methods="3" coveredmethods="0" statements="5" coveredstatements="0" elements="8" coveredelements="0"/>
       </class>
       <class name="CoveredClass" namespace="global">
-        <metrics methods="3" coveredmethods="1" statements="4" coveredstatements="3" elements="7" coveredelements="4"/>
+        <metrics methods="3" coveredmethods="3" statements="7" coveredstatements="3" elements="10" coveredelements="6"/>
       </class>
       <line num="4" type="method" count="0"/>
       <line num="6" type="stmt" count="0"/>
@@ -48,9 +48,8 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
       <line num="33" type="stmt" count="0"/>
       <line num="34" type="stmt" count="0"/>
       <line num="35" type="stmt" count="0"/>
-      <metrics loc="37" ncloc="37" classes="2" methods="6" coveredmethods="1" statements="12" coveredstatements="3" elements="18" coveredelements="4"/>
+      <metrics loc="37" ncloc="37" classes="2" methods="6" coveredmethods="3" statements="12" coveredstatements="3" elements="18" coveredelements="6"/>
     </file>
-    <metrics files="1" loc="37" ncloc="37" classes="2" methods="6" coveredmethods="1" statements="12" coveredstatements="3" elements="18" coveredelements="4"/>
+    <metrics files="1" loc="37" ncloc="37" classes="2" methods="6" coveredmethods="3" statements="12" coveredstatements="3" elements="18" coveredelements="6"/>
   </project>
 </coverage>
-
diff --git a/PHPUnit/Tests/TextUI/coverage-clover-public.phpt b/PHPUnit/Tests/TextUI/coverage-clover-public.phpt
index c08f46d83..05e0eadf0 100644
--- a/PHPUnit/Tests/TextUI/coverage-clover-public.phpt
+++ b/PHPUnit/Tests/TextUI/coverage-clover-public.phpt
@@ -25,10 +25,10 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
   <project name="CoverageTest" timestamp="%i">
     <file name="%s/CoveredClass.php">
       <class name="CoveredParentClass" namespace="global">
-        <metrics methods="3" coveredmethods="0" statements="2" coveredstatements="0" elements="5" coveredelements="0"/>
+        <metrics methods="3" coveredmethods="0" statements="5" coveredstatements="0" elements="8" coveredelements="0"/>
       </class>
       <class name="CoveredClass" namespace="global">
-        <metrics methods="3" coveredmethods="1" statements="4" coveredstatements="3" elements="7" coveredelements="4"/>
+        <metrics methods="3" coveredmethods="3" statements="7" coveredstatements="3" elements="10" coveredelements="6"/>
       </class>
       <line num="4" type="method" count="0"/>
       <line num="6" type="stmt" count="0"/>
@@ -48,9 +48,8 @@ Writing code coverage data to XML file, this may take a moment.<?xml version="1.
       <line num="33" type="stmt" count="1"/>
       <line num="34" type="stmt" count="1"/>
       <line num="35" type="stmt" count="1"/>
-      <metrics loc="37" ncloc="37" classes="2" methods="6" coveredmethods="1" statements="12" coveredstatements="3" elements="18" coveredelements="4"/>
+      <metrics loc="37" ncloc="37" classes="2" methods="6" coveredmethods="3" statements="12" coveredstatements="3" elements="18" coveredelements="6"/>
     </file>
-    <metrics files="1" loc="37" ncloc="37" classes="2" methods="6" coveredmethods="1" statements="12" coveredstatements="3" elements="18" coveredelements="4"/>
+    <metrics files="1" loc="37" ncloc="37" classes="2" methods="6" coveredmethods="3" statements="12" coveredstatements="3" elements="18" coveredelements="6"/>
   </project>
 </coverage>
-
diff --git a/PHPUnit/Tests/TextUI/coverage-clover.phpt b/PHPUnit/Tests/TextUI/coverage-clover.phpt
index 89c0513f6..850099e56 100644
--- a/PHPUnit/Tests/TextUI/coverage-clover.phpt
+++ b/PHPUnit/Tests/TextUI/coverage-clover.phpt
@@ -21,14 +21,14 @@ Time: %i seconds
 OK (3 tests, 3 assertions)
 
 Writing code coverage data to XML file, this may take a moment.<?xml version="1.0" encoding="UTF-8"?>
-<coverage generated="%d" phpunit="%s">
-  <project name="BankAccountTest" timestamp="%d">
+<coverage generated="%i" phpunit="%s">
+  <project name="BankAccountTest" timestamp="%i">
     <file name="%s/BankAccount.php">
       <class name="BankAccountException" namespace="global" fullPackage="PHPUnit" category="Testing" package="PHPUnit">
         <metrics methods="0" coveredmethods="0" statements="0" coveredstatements="0" elements="0" coveredelements="0"/>
       </class>
       <class name="BankAccount" namespace="global" fullPackage="PHPUnit" category="Testing" package="PHPUnit">
-        <metrics methods="4" coveredmethods="3" statements="9" coveredstatements="3" elements="13" coveredelements="6"/>
+        <metrics methods="4" coveredmethods="3" statements="10" coveredstatements="3" elements="14" coveredelements="6"/>
       </class>
       <line num="75" type="method" count="1"/>
       <line num="77" type="stmt" count="1"/>
diff --git a/PHPUnit/Util/Log/CodeCoverage/XML/Clover.php b/PHPUnit/Util/Log/CodeCoverage/XML/Clover.php
index a5c8af611..c4f1f0d57 100644
--- a/PHPUnit/Util/Log/CodeCoverage/XML/Clover.php
+++ b/PHPUnit/Util/Log/CodeCoverage/XML/Clover.php
@@ -93,152 +93,139 @@ public function process(PHPUnit_Framework_TestResult $result)
         $codeCoverageInformation    = $result->getCodeCoverageInformation();
         $files                      = PHPUnit_Util_CodeCoverage::getSummary($codeCoverageInformation);
         $packages                   = array();
-        $projectFiles               = 0;
-        $projectLoc                 = 0;
-        $projectNcloc               = 0;
-        $projectClasses             = 0;
-        $projectMethods             = 0;
-        $projectCoveredMethods      = 0;
-        $projectConditionals        = 0;
-        $projectCoveredConditionals = 0;
-        $projectStatements          = 0;
-        $projectCoveredStatements   = 0;
 
-        foreach ($files as $filename => $data) {
-            $projectFiles++;
+        $projectStatistics = array(
+          'files'               => 0,
+          'loc'                 => 0,
+          'ncloc'               => 0,
+          'classes'             => 0,
+          'methods'             => 0,
+          'coveredMethods'      => 0,
+          'conditionals'        => 0,
+          'coveredConditionals' => 0,
+          'statements'          => 0,
+          'coveredStatements'   => 0
+        );
 
-            $fileClasses             = 0;
-            $fileConditionals        = 0;
-            $fileCoveredConditionals = 0;
-            $fileStatements          = 0;
-            $fileCoveredStatements   = 0;
-            $fileMethods             = 0;
-            $fileCoveredMethods      = 0;
+        foreach ($files as $filename => $data) {
+            $fileStatistics = array(
+              'classes'             => 0,
+              'methods'             => 0,
+              'coveredMethods'      => 0,
+              'conditionals'        => 0,
+              'coveredConditionals' => 0,
+              'statements'          => 0,
+              'coveredStatements'   => 0
+            );
 
             $file = $document->createElement('file');
             $file->setAttribute('name', $filename);
 
-            $namespace = 'global';
-            $classes   = PHPUnit_Util_File::getClassesInFile($filename);
-            $lines     = array();
+            $lines = array();
 
-            foreach ($classes as $className => $class) {
-                $packageInformation = PHPUnit_Util_Class::getPackageInformation(
-                  $className, $class['docComment']
+            foreach (PHPUnit_Util_File::getClassesInFile($filename) as $className => $_class) {
+                $classStatistics = array(
+                  'methods'             => 0,
+                  'coveredMethods'      => 0,
+                  'conditionals'        => 0,
+                  'coveredConditionals' => 0,
+                  'statements'          => 0,
+                  'coveredStatements'   => 0
                 );
 
-                $numMethods = 0;
-                $fileClasses++;
-                $projectClasses++;
+                foreach ($_class['methods'] as $methodName => $method) {
+                    $classStatistics['methods']++;
 
-                if (!empty($packageInformation['namespace'])) {
-                    $namespace = $packageInformation['namespace'];
-                }
-
-                $classConditionals        = 0;
-                $classCoveredConditionals = 0;
-                $classStatements          = 0;
-                $classCoveredStatements   = 0;
-                $classCoveredMethods      = 0;
-
-                foreach ($class['methods'] as $methodName => $method) {
-                    $tests = array();
+                    $methodCount = 0;
 
                     for ($i = $method['startLine']; $i <= $method['endLine']; $i++) {
+                        $add   = TRUE;
+                        $count = 0;
+
                         if (isset($files[$filename][$i])) {
+                            if ($files[$filename][$i] != -2) {
+                                $classStatistics['statements']++;
+                            }
+
                             if (is_array($files[$filename][$i])) {
-                                foreach ($files[$filename][$i] as $_test) {
-                                    $add = TRUE;
-
-                                    foreach ($tests as $test) {
-                                        if ($test === $_test) {
-                                            $add = FALSE;
-                                            break;
-                                        }
-                                    }
-
-                                    if ($add) {
-                                        $tests[] = $_test;
-                                    }
-                                }
-
-                                $classCoveredStatements++;
+                                $classStatistics['coveredStatements']++;
+                                $count = count($files[$filename][$i]);
+                                $classStatistics['coveredMethods']++;
                             }
 
-                            $classStatements++;
+                            else if ($files[$filename][$i] == -2) {
+                                $add = FALSE;
+                            }
+                        } else {
+                            $add = FALSE;
                         }
-                    }
 
-                    $count = count($tests);
+                        $methodCount = max($methodCount, $count);
+
+                        if ($add) {
+                            $lines[$i] = array(
+                              'count' => $count,
+                              'type'  => 'stmt'
+                            );
+                        }
+                    }
 
                     $lines[$method['startLine']] = array(
-                      'count' => $count,
-                      'type' => 'method'
+                      'count' => $methodCount,
+                      'type'  => 'method'
                     );
+                }
 
-                    if ($count > 0) {
-                        $classCoveredMethods++;
-                        $fileCoveredMethods++;
-                        $projectCoveredMethods++;
-                    }
+                $packageInformation = PHPUnit_Util_Class::getPackageInformation(
+                  $className, $_class['docComment']
+                );
 
-                    $classStatements--;
-                    $numMethods++;
-                    $fileMethods++;
-                    $projectMethods++;
+                if (!empty($packageInformation['namespace'])) {
+                    $namespace = $packageInformation['namespace'];
+                } else {
+                    $namespace = 'global';
                 }
 
-                $classXML = $document->createElement('class');
-                $classXML->setAttribute('name', $className);
-                $classXML->setAttribute('namespace', $namespace);
+                $class = $document->createElement('class');
+                $class->setAttribute('name', $className);
+                $class->setAttribute('namespace', $namespace);
 
                 if (!empty($packageInformation['fullPackage'])) {
-                    $classXML->setAttribute('fullPackage', $packageInformation['fullPackage']);
+                    $class->setAttribute('fullPackage', $packageInformation['fullPackage']);
                 }
 
                 if (!empty($packageInformation['category'])) {
-                    $classXML->setAttribute('category', $packageInformation['category']);
+                    $class->setAttribute('category', $packageInformation['category']);
                 }
 
                 if (!empty($packageInformation['package'])) {
-                    $classXML->setAttribute('package', $packageInformation['package']);
+                    $class->setAttribute('package', $packageInformation['package']);
                 }
 
                 if (!empty($packageInformation['subpackage'])) {
-                    $classXML->setAttribute('subpackage', $packageInformation['subpackage']);
-                }
-
-                $file->appendChild($classXML);
-
-                $classMetricsXML = $document->createElement('metrics');
-                $classMetricsXML->setAttribute('methods', $numMethods);
-                $classMetricsXML->setAttribute('coveredmethods', $classCoveredMethods);
-                //$classMetricsXML->setAttribute('conditionals', $classConditionals);
-                //$classMetricsXML->setAttribute('coveredconditionals', $classCoveredConditionals);
-                $classMetricsXML->setAttribute('statements', $classStatements);
-                $classMetricsXML->setAttribute('coveredstatements', $classCoveredStatements);
-                $classMetricsXML->setAttribute('elements', $classConditionals + $classStatements + $numMethods);
-                $classMetricsXML->setAttribute('coveredelements', $classCoveredConditionals + $classCoveredStatements + $classCoveredMethods);
-                $classXML->appendChild($classMetricsXML);
-            }
-
-            foreach ($data as $_line => $_data) {
-                if (is_array($_data)) {
-                    $count = count($_data);
+                    $class->setAttribute('subpackage', $packageInformation['subpackage']);
                 }
 
-                else if ($_data == -1) {
-                    $count = 0;
-                }
-
-                else if ($_data == -2) {
-                    continue;
-                }
-
-                $lines[$_line] = array(
-                  'count' => $count,
-                  'type' => 'stmt'
-                );
+                $file->appendChild($class);
+
+                $metrics = $document->createElement('metrics');
+                $metrics->setAttribute('methods', $classStatistics['methods']);
+                $metrics->setAttribute('coveredmethods', $classStatistics['coveredMethods']);
+                //$metrics->setAttribute('conditionals', $classStatistics['conditionals']);
+                //$metrics->setAttribute('coveredconditionals', $classStatistics['coveredConditionals']);
+                $metrics->setAttribute('statements', $classStatistics['statements']);
+                $metrics->setAttribute('coveredstatements', $classStatistics['coveredStatements']);
+                $metrics->setAttribute('elements', $classStatistics['conditionals'] + $classStatistics['statements'] + $classStatistics['methods']);
+                $metrics->setAttribute('coveredelements', $classStatistics['coveredConditionals'] + $classStatistics['coveredStatements'] + $classStatistics['coveredMethods']);
+                $class->appendChild($metrics);
+
+                $fileStatistics['methods']             += $classStatistics['methods'];
+                $fileStatistics['coveredMethods']      += $classStatistics['coveredMethods'];
+                $fileStatistics['conditionals']        += $classStatistics['conditionals'];
+                $fileStatistics['coveredConditionals'] += $classStatistics['coveredConditionals'];
+                $fileStatistics['statements']          += $classStatistics['statements'];
+                $fileStatistics['coveredStatements']   += $classStatistics['coveredStatements'];
+                $fileStatistics['classes']++;
             }
 
             ksort($lines);
@@ -249,34 +236,26 @@ public function process(PHPUnit_Framework_TestResult $result)
                 $line->setAttribute('type', $_data['type']);
                 $line->setAttribute('count', $_data['count']);
 
-                if ($_data['type'] == 'stmt') {
-                    if ($_data['count'] != 0) {
-                        $fileCoveredStatements++;
-                    }
-
-                    $fileStatements++;
-                }
-
                 $file->appendChild($line);
             }
 
             if (file_exists($filename)) {
                 $count = PHPUnit_Util_File::countLines($filename);
 
-                $fileMetricsXML = $document->createElement('metrics');
-                $fileMetricsXML->setAttribute('loc', $count['loc']);
-                $fileMetricsXML->setAttribute('ncloc', $count['ncloc']);
-                $fileMetricsXML->setAttribute('classes', $fileClasses);
-                $fileMetricsXML->setAttribute('methods', $fileMethods);
-                $fileMetricsXML->setAttribute('coveredmethods', $fileCoveredMethods);
-                //$fileMetricsXML->setAttribute('conditionals', $fileConditionals);
-                //$fileMetricsXML->setAttribute('coveredconditionals', $fileCoveredConditionals);
-                $fileMetricsXML->setAttribute('statements', $fileStatements);
-                $fileMetricsXML->setAttribute('coveredstatements', $fileCoveredStatements);
-                $fileMetricsXML->setAttribute('elements', $fileConditionals + $fileStatements + $fileMethods);
-                $fileMetricsXML->setAttribute('coveredelements', $fileCoveredConditionals + $fileCoveredStatements + $fileCoveredMethods);
-
-                $file->appendChild($fileMetricsXML);
+                $metrics = $document->createElement('metrics');
+                $metrics->setAttribute('loc', $count['loc']);
+                $metrics->setAttribute('ncloc', $count['ncloc']);
+                $metrics->setAttribute('classes', $fileStatistics['classes']);
+                $metrics->setAttribute('methods', $fileStatistics['methods']);
+                $metrics->setAttribute('coveredmethods', $fileStatistics['coveredMethods']);
+                //$metrics->setAttribute('conditionals', $fileStatistics['conditionals']);
+                //$metrics->setAttribute('coveredconditionals', $fileStatistics['coveredConditionals']);
+                $metrics->setAttribute('statements', $fileStatistics['statements']);
+                $metrics->setAttribute('coveredstatements', $fileStatistics['coveredStatements']);
+                $metrics->setAttribute('elements', $fileStatistics['conditionals'] + $fileStatistics['statements'] + $fileStatistics['methods']);
+                $metrics->setAttribute('coveredelements', $fileStatistics['coveredConditionals'] + $fileStatistics['coveredStatements'] + $fileStatistics['coveredMethods']);
+
+                $file->appendChild($metrics);
 
                 if ($namespace == 'global') {
                     $project->appendChild($file);
@@ -290,27 +269,33 @@ public function process(PHPUnit_Framework_TestResult $result)
                     $packages[$namespace]->appendChild($file);
                 }
 
-                $projectLoc               += $count['loc'];
-                $projectNcloc             += $count['ncloc'];
-                $projectStatements        += $fileStatements;
-                $projectCoveredStatements += $fileCoveredStatements;
+                $projectStatistics['loc']                 += $count['loc'];
+                $projectStatistics['ncloc']               += $count['ncloc'];
+                $projectStatistics['classes']             += $fileStatistics['classes'];
+                $projectStatistics['methods']             += $fileStatistics['methods'];
+                $projectStatistics['coveredMethods']      += $fileStatistics['coveredMethods'];
+                $projectStatistics['conditionals']        += $fileStatistics['conditionals'];
+                $projectStatistics['coveredConditionals'] += $fileStatistics['coveredConditionals'];
+                $projectStatistics['statements']          += $fileStatistics['statements'];
+                $projectStatistics['coveredStatements']   += $fileStatistics['coveredStatements'];
+                $projectStatistics['files']++;
             }
         }
 
-        $projectMetricsXML = $document->createElement('metrics');
-        $projectMetricsXML->setAttribute('files', $projectFiles);
-        $projectMetricsXML->setAttribute('loc', $projectLoc);
-        $projectMetricsXML->setAttribute('ncloc', $projectNcloc);
-        $projectMetricsXML->setAttribute('classes', $projectClasses);
-        $projectMetricsXML->setAttribute('methods', $projectMethods);
-        $projectMetricsXML->setAttribute('coveredmethods', $projectCoveredMethods);
-        //$projectMetricsXML->setAttribute('conditionals', $projectConditionals);
-        //$projectMetricsXML->setAttribute('coveredconditionals', $projectCoveredConditionals);
-        $projectMetricsXML->setAttribute('statements', $projectStatements);
-        $projectMetricsXML->setAttribute('coveredstatements', $projectCoveredStatements);
-        $projectMetricsXML->setAttribute('elements', $projectConditionals + $projectStatements + $projectMethods);
-        $projectMetricsXML->setAttribute('coveredelements', $projectCoveredConditionals + $projectCoveredStatements + $projectCoveredMethods);
-        $project->appendChild($projectMetricsXML);
+        $metrics = $document->createElement('metrics');
+        $metrics->setAttribute('files', $projectStatistics['files']);
+        $metrics->setAttribute('loc', $projectStatistics['loc']);
+        $metrics->setAttribute('ncloc', $projectStatistics['ncloc']);
+        $metrics->setAttribute('classes', $projectStatistics['classes']);
+        $metrics->setAttribute('methods', $projectStatistics['methods']);
+        $metrics->setAttribute('coveredmethods', $projectStatistics['coveredMethods']);
+        //$metrics->setAttribute('conditionals', $projectStatistics['conditionals']);
+        //$metrics->setAttribute('coveredconditionals', $projectStatistics['coveredConditionals']);
+        $metrics->setAttribute('statements', $projectStatistics['statements']);
+        $metrics->setAttribute('coveredstatements', $projectStatistics['coveredStatements']);
+        $metrics->setAttribute('elements', $projectStatistics['conditionals'] + $projectStatistics['statements'] + $projectStatistics['methods']);
+        $metrics->setAttribute('coveredelements', $projectStatistics['coveredConditionals'] + $projectStatistics['coveredStatements'] + $projectStatistics['coveredMethods']);
+        $project->appendChild($metrics);
 
         $this->write($document->saveXML());
         $this->flush();
