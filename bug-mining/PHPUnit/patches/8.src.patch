diff --git a/PHPUnit/Framework/Constraint/IsEqual.php b/PHPUnit/Framework/Constraint/IsEqual.php
index 5efc4db3e..387eb1d76 100644
--- a/PHPUnit/Framework/Constraint/IsEqual.php
+++ b/PHPUnit/Framework/Constraint/IsEqual.php
@@ -47,7 +47,6 @@
 
 require_once 'PHPUnit/Framework.php';
 require_once 'PHPUnit/Util/Array.php';
-require_once 'PHPUnit/Util/DualIterator.php';
 require_once 'PHPUnit/Util/Filter.php';
 
 PHPUnit_Util_Filter::addFileToFilter(__FILE__, 'PHPUNIT');
@@ -63,7 +62,7 @@
  *
  * @category   Testing
  * @package    PHPUnit
- * @author     Jan Borsodi <jb@ez.no>
+ * @author     Kore Nordmann <kn@ez.no>
  * @author     Sebastian Bergmann <sb@sebastian-bergmann.de>
  * @copyright  2002-2006 Sebastian Bergmann <sb@sebastian-bergmann.de>
  * @license    http://www.opensource.org/licenses/bsd-license.php  BSD License
@@ -75,6 +74,7 @@ class PHPUnit_Framework_Constraint_IsEqual implements PHPUnit_Framework_Constrai
 {
     private $value;
     private $delta = 0;
+    private $maxDepth = 10;
 
     public function __construct($value, $delta = 0)
     {
@@ -91,44 +91,7 @@ public function __construct($value, $delta = 0)
      */
     public function evaluate($other)
     {
-        if  ((is_array($this->value)  && is_array($other)) ||
-             (is_object($this->value) && is_object($other))) {
-            if (is_object($this->value) && is_object($other)) {
-                $value = (array) $this->value;
-                $other = (array) $other;
-            } else {
-                $value = $this->value;
-            }
-
-            if (count($value) != count($other)) {
-                return FALSE;
-            }
-
-            return PHPUnit_Util_DualIterator::compareIterators(
-              new RecursiveIteratorIterator(
-                new RecursiveArrayIterator(
-                  PHPUnit_Util_Array::sortRecursively($value)
-                ),
-                RecursiveIteratorIterator::SELF_FIRST
-              ),
-              new RecursiveIteratorIterator(
-                new RecursiveArrayIterator(
-                  PHPUnit_Util_Array::sortRecursively($other)
-                ),
-                RecursiveIteratorIterator::SELF_FIRST
-              ),
-              FALSE,
-              $this->delta
-            );
-        }
-
-        else if (is_float($this->value) && is_float($other) && is_float($this->delta)) {
-            return (abs($this->value - $other) <= $this->delta);
-        }
-
-        else {
-            return $this->value == $other;
-        }
+        return $this->recursiveComparison($this->value, $other);
     }
 
     /**
@@ -189,5 +152,83 @@ public function toString()
             );
         }
     }
+
+    /**
+     * Perform the actual recursive comparision of two values
+     * 
+     * @param mixed $a First value
+     * @param mixed $b Second value
+     * @param int $depth Depth
+     * @return bool
+     */
+    protected function recursiveComparison($a, $b, $depth = 0)
+    {
+        if ($depth >= $this->maxDepth) {
+            return TRUE;
+        }
+
+        // Normal comparision for scalar values.
+        if ((!is_array($a) && !is_object($a)) ||
+            (!is_array($b) && !is_object($b))) {
+            if (is_numeric($a) && is_numeric($b)) {
+                // Optionally apply delta on numeric values.
+                return $this->numericComparison($a, $b);
+            } else {
+                return ($a == $b);
+            }
+        }
+
+        if (is_object($a) XOR is_object($b)) {
+            return FALSE;
+        }
+
+        if (is_object($a) && is_object($b) &&
+           (get_class($a) !== get_class($b))) {
+            return FALSE;
+        }
+
+        if (is_object($a)) {
+            $a = (array) $a;
+            $b = (array) $b;
+        }
+
+        foreach ($a as $key => $v) {
+            if (!isset($b[$key])) {
+                // Abort on missing key in $b.
+                return FALSE;
+            }
+
+            if (!$this->recursiveComparison($a[$key], $b[$key], $depth + 1)) {
+                // FALSE, if child comparision fails.
+                return FALSE;
+            }
+
+            // Unset key to check whether all keys of b are compared.
+            unset($b[$key]);
+        }
+
+        if (count($b)) {
+            // There is something in $b, that is missing in $a.
+            return FALSE;
+        }
+
+        return TRUE;
+    }
+
+    /**
+     * Compares two numeric values - use delta if applieable
+     * 
+     * @param mixed $a First value
+     * @param mixed $b Second value
+     * @return bool
+     */
+    protected function numericComparison($a, $b)
+    {
+        if ($this->delta === FALSE) {
+            return ($a == $b);
+        } else {
+            return (abs($a - $b) <= $this->delta);
+        }
+    }
 }
 ?>
diff --git a/PHPUnit/Util/DualIterator.php b/PHPUnit/Util/DualIterator.php
deleted file mode 100644
index 510b89f30..000000000
--- a/PHPUnit/Util/DualIterator.php
+++ /dev/null
@@ -1,231 +0,0 @@
-<?php
-/**
- * PHPUnit
- *
- * Copyright (c) 2002-2006, Sebastian Bergmann <sb@sebastian-bergmann.de>.
- * All rights reserved.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- *
- *   * Redistributions of source code must retain the above copyright
- *     notice, this list of conditions and the following disclaimer.
- *
- *   * Redistributions in binary form must reproduce the above copyright
- *     notice, this list of conditions and the following disclaimer in
- *     the documentation and/or other materials provided with the
- *     distribution.
- *
- *   * Neither the name of Sebastian Bergmann nor the names of his
- *     contributors may be used to endorse or promote products derived
- *     from this software without specific prior written permission.
- *
- * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
- * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
- * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
- * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
- * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
- * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
- * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
- * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
- * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRIC
- * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
- * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
- * POSSIBILITY OF SUCH DAMAGE.
- *
- * @category   Testing
- * @package    PHPUnit
- * @author     Marcus Börger <helly@php.net>
- * @author     Kore Nordmann <mail@kore-nordmann.de>
- * @author     Sebastian Bergmann <sb@sebastian-bergmann.de>
- * @copyright  2002-2006 Sebastian Bergmann <sb@sebastian-bergmann.de>
- * @license    http://www.opensource.org/licenses/bsd-license.php  BSD License
- * @version    SVN: $Id$
- * @link       http://www.phpunit.de/
- * @since      File available since Release 3.0.0
- */
-
-require_once 'PHPUnit/Util/Filter.php';
-
-PHPUnit_Util_Filter::addFileToFilter(__FILE__, 'PHPUNIT');
-
-/**
- *
- *
- * @category   Testing
- * @package    PHPUnit
- * @author     Marcus Börger <helly@php.net>
- * @author     Kore Nordmann <mail@kore-nordmann.de>
- * @author     Sebastian Bergmann <sb@sebastian-bergmann.de>
- * @copyright  2002-2006 Sebastian Bergmann <sb@sebastian-bergmann.de>
- * @license    http://www.opensource.org/licenses/bsd-license.php  BSD License
- * @version    Release: @package_version@
- * @link       http://www.phpunit.de/
- * @since      Class available since Release 3.0.0
- */
-class PHPUnit_Util_DualIterator implements Iterator
-{
-    const CURRENT_LHS   = 0x01;
-    const CURRENT_RHS   = 0x02;
-    const CURRENT_ARRAY = 0x03;
-    const CURRENT_0     = 0x00;
-
-    const KEY_LHS   = 0x10;
-    const KEY_RHS   = 0x20;
-    const KEY_ARRAY = 0x30;
-    const KEY_0     = 0x00;
-
-    const DEFAULT_FLAGS = 0x33;
-
-    private $lhs;
-    private $rhs;
-    private $flags;
-
-    public function __construct(Iterator $lhs, Iterator $rhs, $flags = 0x33)
-    {
-        $this->lhs   = $lhs;
-        $this->rhs   = $rhs;
-        $this->flags = $flags;
-    }
-
-    public function getLHS()
-    {
-        return $this->lhs;
-    }
-
-    public function getRHS()
-    {
-        return $this->rhs;
-    }
-
-    public function setFlags($flags)
-    {
-        $this->flags = $flags;
-    }
-
-    public function getFlags()
-    {
-        return $this->flags;
-    }
-
-    public function rewind()
-    {
-        $this->lhs->rewind();
-        $this->rhs->rewind();
-    }
-
-    public function valid()
-    {
-        return $this->lhs->valid() && $this->rhs->valid();
-    }
-
-    public function current()
-    {
-        switch($this->flags & 0x0F) {
-            default:
-            case self::CURRENT_ARRAY: {
-              return array($this->lhs->current(), $this->rhs->current());
-            }
-
-            case self::CURRENT_LHS: {
-              return $this->lhs->current();
-            }
-
-            case self::CURRENT_RHS: {
-              return $this->rhs->current();
-            }
-
-            case self::CURRENT_0: {
-              return NULL;
-            }
-        }
-    }
-
-    public function key()
-    {
-        switch($this->flags & 0xF0) {
-            default:
-            case self::CURRENT_ARRAY: {
-              return array($this->lhs->key(), $this->rhs->key());
-            }
-
-            case self::CURRENT_LHS: {
-              return $this->lhs->key();
-            }
-
-            case self::CURRENT_RHS: {
-              return $this->rhs->key();
-            }
-
-            case self::CURRENT_0: {
-              return NULL;
-            }
-        }
-    }
-
-    public function next()
-    {
-        $this->lhs->next();
-        $this->rhs->next();
-    }
-
-    public function areIdentical()
-    {
-        return $this->valid()
-             ? $this->lhs->current() === $this->rhs->current()
-            && $this->lhs->key()     === $this->rhs->key()
-             : $this->lhs->valid()   ==  $this->rhs->valid();
-    }
-
-    public function areEqual($delta)
-    {
-        if ($this->valid()) {
-            if ($this->lhs->key() == $this->rhs->key()) {
-                if ($this->lhs->current() == $this->rhs->current()) {
-                    return TRUE;
-                }
-
-                if (is_numeric($this->lhs->current()) &&
-                    is_numeric($this->rhs->current()) &&
-                    abs($this->lhs->current() - $this->rhs->current()) <= $delta) {
-                    return TRUE;
-                }
-            }
-        } else {
-            return $this->lhs->valid() == $this->rhs->valid();
-        }
-    }
-
-    public static function compareIterators(Iterator $lhs, Iterator $rhs, $identical = FALSE, $delta = .0)
-    {
-        if ($lhs instanceof RecursiveIterator) {
-            if ($rhs instanceof RecursiveIterator) {
-                $it = new PHPUnit_Util_RecursiveDualIterator($lhs, $rhs, self::CURRENT_0 | self::KEY_0);
-            } else {
-                return FALSE;
-            }
-        } else {
-            $it = new PHPUnit_Util_DualIterator($lhs, $rhs, self::CURRENT_0 | self::KEY_0);
-        }
-
-        if ($identical) {
-            foreach (new RecursiveIteratorIterator($it) as $n) {
-                if (!$it->areIdentical()) {
-                    return FALSE;
-                }
-            }
-        } else {
-            foreach ($it as $n) {
-                if (!$it->areEqual($delta)) {
-                    return FALSE;
-                }
-            }
-        }
-
-        return $identical ? $it->areIdentical() : $it->areEqual($delta);
-    }
-}
-
-require_once 'PHPUnit/Util/RecursiveDualIterator.php';
-?>
diff --git a/PHPUnit/Util/RecursiveDualIterator.php b/PHPUnit/Util/RecursiveDualIterator.php
deleted file mode 100644
index 5a878d054..000000000
--- a/PHPUnit/Util/RecursiveDualIterator.php
+++ /dev/null
@@ -1,104 +0,0 @@
-<?php
-/**
- * PHPUnit
- *
- * Copyright (c) 2002-2006, Sebastian Bergmann <sb@sebastian-bergmann.de>.
- * All rights reserved.
- *
- * Redistribution and use in source and binary forms, with or without
- * modification, are permitted provided that the following conditions
- * are met:
- *
- *   * Redistributions of source code must retain the above copyright
- *     notice, this list of conditions and the following disclaimer.
- *
- *   * Redistributions in binary form must reproduce the above copyright
- *     notice, this list of conditions and the following disclaimer in
- *     the documentation and/or other materials provided with the
- *     distribution.
- *
- *   * Neither the name of Sebastian Bergmann nor the names of his
- *     contributors may be used to endorse or promote products derived
- *     from this software without specific prior written permission.
- *
- * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
- * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
- * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
- * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
- * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
- * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
- * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
- * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
- * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRIC
- * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
- * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
- * POSSIBILITY OF SUCH DAMAGE.
- *
- * @category   Testing
- * @package    PHPUnit
- * @author     Marcus Börger <helly@php.net>
- * @author     Sebastian Bergmann <sb@sebastian-bergmann.de>
- * @copyright  2002-2006 Sebastian Bergmann <sb@sebastian-bergmann.de>
- * @license    http://www.opensource.org/licenses/bsd-license.php  BSD License
- * @version    SVN: $Id$
- * @link       http://www.phpunit.de/
- * @since      File available since Release 3.0.0
- */
-
-require_once 'PHPUnit/Util/Filter.php';
-require_once 'PHPUnit/Util/DualIterator.php';
-
-PHPUnit_Util_Filter::addFileToFilter(__FILE__, 'PHPUNIT');
-
-/**
- *
- *
- * @category   Testing
- * @package    PHPUnit
- * @author     Marcus Börger <helly@php.net>
- * @author     Sebastian Bergmann <sb@sebastian-bergmann.de>
- * @copyright  2002-2006 Sebastian Bergmann <sb@sebastian-bergmann.de>
- * @license    http://www.opensource.org/licenses/bsd-license.php  BSD License
- * @version    Release: @package_version@
- * @link       http://www.phpunit.de/
- * @since      Class available since Release 3.0.0
- */
-class PHPUnit_Util_RecursiveDualIterator extends PHPUnit_Util_DualIterator implements RecursiveIterator
-{
-    private $ref;
-
-    public function __construct(RecursiveIterator $lhs, RecursiveIterator $rhs, $flags = 0x33)
-    {
-        parent::__construct($lhs, $rhs, $flags);
-    }
-
-    public function hasChildren()
-    {
-        return $this->getLHS()->hasChildren() && $this->getRHS()->hasChildren();
-    }
-
-    public function getChildren()
-    {
-        if (empty($this->ref))
-        {
-            $this->ref = new ReflectionClass($this);
-        }
-
-        return $this->ref->newInstance(
-          $this->getLHS()->getChildren(),
-          $this->getRHS()->getChildren(),
-          $this->getFlags()
-        );
-    }
-
-    public function areIdentical()
-    {
-        return $this->getLHS()->hasChildren() === $this->getRHS()->hasChildren() && parent::areIdentical();
-    }
-
-    public function areEqual($delta)
-    {
-        return $this->getLHS()->hasChildren() === $this->getRHS()->hasChildren() && parent::areEqual($delta);
-    }
-}
-?>
diff --git a/package.xml b/package.xml
index ecc7829b8..b57ce06ef 100644
--- a/package.xml
+++ b/package.xml
@@ -585,9 +585,6 @@
      <file baseinstalldir="/" name="Array.php" role="php">
       <tasks:replace from="@package_version@" to="version" type="package-info" />
      </file>
-     <file baseinstalldir="/" name="DualIterator.php" role="php">
-      <tasks:replace from="@package_version@" to="version" type="package-info" />
-     </file>
      <file baseinstalldir="/" name="ErrorHandler.php" role="php">
       <tasks:replace from="@package_version@" to="version" type="package-info" />
      </file>
@@ -606,9 +603,6 @@
      <file baseinstalldir="/" name="Printer.php" role="php">
       <tasks:replace from="@package_version@" to="version" type="package-info" />
      </file>
-     <file baseinstalldir="/" name="RecursiveDualIterator.php" role="php">
-      <tasks:replace from="@package_version@" to="version" type="package-info" />
-     </file>
      <file baseinstalldir="/" name="Report.php" role="php">
       <tasks:replace from="@package_version@" to="version" type="package-info" />
      </file>
