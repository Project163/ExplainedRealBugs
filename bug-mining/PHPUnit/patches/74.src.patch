diff --git a/PHPUnit/Framework/ComparisonFailure.php b/PHPUnit/Framework/ComparisonFailure.php
index edd103ec3..d70e3f02b 100644
--- a/PHPUnit/Framework/ComparisonFailure.php
+++ b/PHPUnit/Framework/ComparisonFailure.php
@@ -92,11 +92,6 @@ abstract class PHPUnit_Framework_ComparisonFailure extends PHPUnit_Framework_Ass
      */
     protected $message;
 
-    /**
-     * @var boolean
-     */
-    protected static $hasDiff = NULL;
-
     /**
      * Initialises with the expected value and the actual value.
      *
@@ -104,7 +99,7 @@ abstract class PHPUnit_Framework_ComparisonFailure extends PHPUnit_Framework_Ass
      * @param mixed $actual Actual value retrieved.
      * @param boolean $identical
      * @param string $message A string which is prefixed on all returned lines
-     *                       in the difference output.
+     *                        in the difference output.
      */
     public function __construct($expected, $actual, $identical = FALSE, $message = '')
     {
@@ -138,7 +133,7 @@ public function identical()
      * @param mixed $expected Expected value retrieved.
      * @param mixed $actual Actual value retrieved.
      * @param string $message A string which is prefixed on all returned lines
-     *                       in the difference output.
+     *                        in the difference output.
      * @return PHPUnit_Framework_ComparisonFailure
      */
     public static function diffIdentical($expected, $actual, $message = '')
@@ -173,7 +168,7 @@ public static function diffIdentical($expected, $actual, $message = '')
      * @param mixed $expected Expected value retrieved.
      * @param mixed $actual Actual value retrieved.
      * @param string $message A string which is prefixed on all returned lines
-     *                       in the difference output.
+     *                        in the difference output.
      * @return PHPUnit_Framework_ComparisonFailure
      */
     public static function diffEqual($expected, $actual, $message = '')
@@ -194,85 +189,6 @@ public static function diffEqual($expected, $actual, $message = '')
             return new PHPUnit_Framework_ComparisonFailure_Object($expected, $actual, FALSE, $message);
         }
     }
-
-    protected function diff($expected, $actual)
-    {
-        $expectedFile = tempnam('/tmp', 'expected');
-        file_put_contents($expectedFile, $expected);
-
-        $actualFile = tempnam('/tmp', 'actual');
-        file_put_contents($actualFile, $actual);
-
-        $buffer = shell_exec(
-          sprintf(
-            'diff -u %s %s',
-            escapeshellarg($expectedFile),
-            escapeshellarg($actualFile)
-          )
-        );
-
-        unlink($expectedFile);
-        unlink($actualFile);
-
-        if (!empty($buffer)) {
-            $buffer = explode("\n", $buffer);
-
-            $buffer[0] = "--- Expected";
-            $buffer[1] = "+++ Actual";
-
-            $buffer = implode("\n", $buffer);
-        }
-
-        return $buffer;
-    }
-
-    public static function hasDiff()
-    {
-        if (self::$hasDiff === NULL)
-        {
-            self::$hasDiff = FALSE;
-
-            $binary = 'diff';
-
-            if (substr(php_uname('s'), 0, 7) == 'Windows')
-            {
-                $binary .= '.exe';
-            }
-
-            if (isset($_ENV['PATH'])) {
-                $var = $_ENV['PATH'];
-            }
-
-            else if (isset($_ENV['Path'])) {
-                $var = $_ENV['Path'];
-            }
-
-            else if (isset($_SERVER['PATH'])) {
-                $var = $_SERVER['PATH'];
-            }
-
-            else if (isset($_SERVER['Path'])) {
-                $var = $_SERVER['Path'];
-            }
-
-            if (isset($var)) {
-                $paths = explode(PATH_SEPARATOR, $var);
-            } else {
-                $paths = array();
-            }
-
-            foreach ($paths as $path) {
-                if (file_exists($path . DIRECTORY_SEPARATOR . $binary) &&
-                    is_executable($path . DIRECTORY_SEPARATOR . $binary))
-                {
-                    self::$hasDiff = TRUE;
-                    break;
-                }
-            }
-        }
-
-        return self::$hasDiff;
-    }
 }
 
 }
diff --git a/PHPUnit/Framework/ComparisonFailure/Array.php b/PHPUnit/Framework/ComparisonFailure/Array.php
index 1ba88eef0..589fbda5e 100644
--- a/PHPUnit/Framework/ComparisonFailure/Array.php
+++ b/PHPUnit/Framework/ComparisonFailure/Array.php
@@ -46,6 +46,7 @@
  */
 
 require_once 'PHPUnit/Framework.php';
+require_once 'PHPUnit/Util/Diff.php';
 require_once 'PHPUnit/Util/Filter.php';
 
 PHPUnit_Util_Filter::addFileToFilter(__FILE__, 'PHPUNIT');
@@ -73,14 +74,13 @@ class PHPUnit_Framework_ComparisonFailure_Array extends PHPUnit_Framework_Compar
      */
     public function toString()
     {
-        if ($this->hasDiff()) {
-            $diff = $this->diff(
-              print_r($this->expected, TRUE), print_r($this->actual, TRUE)
-            );
+        $diff = PHPUnit_Util_Diff::diff(
+          print_r($this->expected, TRUE),
+          print_r($this->actual, TRUE)
+        );
 
-            if (!empty($diff)) {
-                return $diff;
-            }
+        if ($diff !== FALSE) {
+            return $diff;
         }
 
         // Fallback: Either diff is not available or the print_r() output for
diff --git a/PHPUnit/Framework/ComparisonFailure/Object.php b/PHPUnit/Framework/ComparisonFailure/Object.php
index 6e9272dd3..ca1f419c3 100644
--- a/PHPUnit/Framework/ComparisonFailure/Object.php
+++ b/PHPUnit/Framework/ComparisonFailure/Object.php
@@ -46,6 +46,7 @@
  */
 
 require_once 'PHPUnit/Framework.php';
+require_once 'PHPUnit/Util/Diff.php';
 require_once 'PHPUnit/Util/Filter.php';
 
 PHPUnit_Util_Filter::addFileToFilter(__FILE__, 'PHPUNIT');
@@ -73,14 +74,13 @@ class PHPUnit_Framework_ComparisonFailure_Object extends PHPUnit_Framework_Compa
      */
     public function toString()
     {
-        if ($this->hasDiff()) {
-            $diff = $this->diff(
-              print_r($this->expected, TRUE), print_r($this->actual, TRUE)
-            );
+        $diff = PHPUnit_Util_Diff::diff(
+          print_r($this->expected, TRUE),
+          print_r($this->actual, TRUE)
+        );
 
-            if (!empty($diff)) {
-                return $diff;
-            }
+        if ($diff !== FALSE) {
+            return $diff;
         }
 
         // Fallback: Either diff is not available or the print_r() output for
diff --git a/PHPUnit/Framework/ComparisonFailure/String.php b/PHPUnit/Framework/ComparisonFailure/String.php
index d47f49d7c..b3bd0eda7 100644
--- a/PHPUnit/Framework/ComparisonFailure/String.php
+++ b/PHPUnit/Framework/ComparisonFailure/String.php
@@ -46,6 +46,7 @@
  */
 
 require_once 'PHPUnit/Framework.php';
+require_once 'PHPUnit/Util/Diff.php';
 require_once 'PHPUnit/Util/Filter.php';
 
 PHPUnit_Util_Filter::addFileToFilter(__FILE__, 'PHPUNIT');
@@ -75,8 +76,10 @@ public function toString()
         $actual   = (string)$this->actual;
 
         if (strpos($expected, "\n") !== FALSE || strpos($actual, "\n") !== FALSE) {
-            if ($this->hasDiff()) {
-                return $this->diff($expected, $actual);
+            $diff = PHPUnit_Util_Diff::diff($expected, $actual);
+
+            if ($diff !== FALSE) {
+                return $diff;
             } else {
                 return '';
             }
diff --git a/PHPUnit/Util/Diff.php b/PHPUnit/Util/Diff.php
new file mode 100644
index 000000000..8bba20264
--- /dev/null
+++ b/PHPUnit/Util/Diff.php
@@ -0,0 +1,188 @@
+<?php
+/**
+ * PHPUnit
+ *
+ * Copyright (c) 2002-2008, Sebastian Bergmann <sb@sebastian-bergmann.de>.
+ * All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ *
+ *   * Redistributions of source code must retain the above copyright
+ *     notice, this list of conditions and the following disclaimer.
+ *
+ *   * Redistributions in binary form must reproduce the above copyright
+ *     notice, this list of conditions and the following disclaimer in
+ *     the documentation and/or other materials provided with the
+ *     distribution.
+ *
+ *   * Neither the name of Sebastian Bergmann nor the names of his
+ *     contributors may be used to endorse or promote products derived
+ *     from this software without specific prior written permission.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
+ * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
+ * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
+ * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
+ * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
+ * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
+ * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
+ * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
+ * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
+ * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
+ * POSSIBILITY OF SUCH DAMAGE.
+ *
+ * @category   Testing
+ * @package    PHPUnit
+ * @author     Sebastian Bergmann <sb@sebastian-bergmann.de>
+ * @copyright  2002-2008 Sebastian Bergmann <sb@sebastian-bergmann.de>
+ * @license    http://www.opensource.org/licenses/bsd-license.php  BSD License
+ * @version    SVN: $Id$
+ * @link       http://www.phpunit.de/
+ * @since      File available since Release 3.4.0
+ */
+
+require_once 'PHPUnit/Util/Filesystem.php';
+require_once 'PHPUnit/Util/Filter.php';
+
+PHPUnit_Util_Filter::addFileToFilter(__FILE__, 'PHPUNIT');
+
+/**
+ * Diff helpers.
+ *
+ * @category   Testing
+ * @package    PHPUnit
+ * @author     Sebastian Bergmann <sb@sebastian-bergmann.de>
+ * @copyright  2002-2008 Sebastian Bergmann <sb@sebastian-bergmann.de>
+ * @license    http://www.opensource.org/licenses/bsd-license.php  BSD License
+ * @version    Release: @package_version@
+ * @link       http://www.phpunit.de/
+ * @since      Class available since Release 3.4.0
+ */
+class PHPUnit_Util_Diff
+{
+    /**
+     * @var boolean
+     */
+    protected static $hasTextDiff = NULL;
+
+    /**
+     * @var boolean
+     */
+    protected static $hasDiffCommand = NULL;
+
+    /**
+     * @param  string $from
+     * @param  string $to
+     * @return string
+     */
+    public static function diff($from, $to)
+    {
+        self::setUp();
+
+        if (self::$hasTextDiff) {
+            $result = self::doTextDiff($from, $to);
+        }
+
+        else if (self::$hasDiffCommand) {
+            $result = self::doDiffCommand($from, $to);
+        }
+
+        if (isset($result)) {
+            $result = explode("\n", $result);
+
+            $result[0] = "--- Expected";
+            $result[1] = "+++ Actual";
+
+            return implode("\n", $result);
+        }
+
+        return FALSE;
+    }
+
+    /**
+     * @param  string $from
+     * @param  string $to
+     * @return string
+     */
+    protected static function doTextDiff($from, $to)
+    {
+        $from = explode("\n", $from);
+        $to   = explode("\n", $to);
+
+        $currentErrorReporting = error_reporting(E_ERROR | E_WARNING | E_PARSE);
+        PHPUnit_Util_Filesystem::collectStart();
+
+        $renderer = new Text_Diff_Renderer_unified;
+        $diff     = $renderer->render(new Text_Diff($from, $to));
+
+        foreach (PHPUnit_Util_Filesystem::collectEnd() as $blacklistedFile) {
+            PHPUnit_Util_Filter::addFileToFilter($blacklistedFile, 'PHPUNIT');
+        }
+
+        error_reporting($currentErrorReporting);
+
+        return $diff;
+    }
+
+    /**
+     * @param  string $from
+     * @param  string $to
+     * @return string
+     */
+    protected static function doDiffCommand($from, $to)
+    {
+        $expectedFile = tempnam('/tmp', 'expected');
+        file_put_contents($expectedFile, $expected);
+
+        $actualFile = tempnam('/tmp', 'actual');
+        file_put_contents($actualFile, $actual);
+
+        $buffer = shell_exec(
+          sprintf(
+            'diff -u %s %s',
+            escapeshellarg($expectedFile),
+            escapeshellarg($actualFile)
+          )
+        );
+
+        unlink($expectedFile);
+        unlink($actualFile);
+
+        return $buffer;
+    }
+
+    /**
+     * - Tries to find the Text_Diff PEAR package.
+     * - Tries to find the "diff" command.
+     */
+    protected static function setUp()
+    {
+        if (self::$hasTextDiff === NULL) {
+            if (PHPUnit_Util_Filesystem::fileExistsInIncludePath('Text/Diff.php')) {
+                $currentErrorReporting = error_reporting(E_ERROR | E_WARNING | E_PARSE);
+                PHPUnit_Util_Filesystem::collectStart();
+                require_once 'Text/Diff.php';
+                require_once 'Text/Diff/Renderer/unified.php';
+                error_reporting($currentErrorReporting);
+
+                foreach (PHPUnit_Util_Filesystem::collectEnd() as $blacklistedFile) {
+                    PHPUnit_Util_Filter::addFileToFilter($blacklistedFile, 'PHPUNIT');
+                }
+            }
+        }
+
+        if (class_exists('Text_Diff', FALSE)) {
+            self::$hasTextDiff = TRUE;
+        } else {
+            self::$hasTextDiff = FALSE;
+        }
+
+        if (!self::$hasTextDiff && self::$hasDiff === NULL) {
+            self::$hasDiff = PHPUnit_Util_Filesystem::hasBinary('diff');
+        }
+    }
+}
+?>
diff --git a/PHPUnit/Util/Filesystem.php b/PHPUnit/Util/Filesystem.php
index ad350c985..0e1069f5d 100644
--- a/PHPUnit/Util/Filesystem.php
+++ b/PHPUnit/Util/Filesystem.php
@@ -63,8 +63,16 @@
  */
 class PHPUnit_Util_Filesystem
 {
+    /**
+     * @var array
+     */
     protected static $buffer = array();
 
+    /**
+     * @var array
+     */
+    protected static $hasBinary = array();
+
     /**
      * Starts the collection of loaded files.
      *
@@ -206,6 +214,66 @@ public static function getSafeFilename($filename)
         return preg_replace('#[^\w.]#', '_', $filename);
     }
 
+    /**
+     * @param  string $binary
+     * @return boolean
+     * @since  Method available since Release 3.4.0
+     */
+    public static function hasBinary($binary)
+    {
+        if (!isset(self::$hasBinary[$binary])) {
+            self::$hasBinary[$binary] = FALSE;
+
+            if (substr(php_uname('s'), 0, 7) == 'Windows') {
+                $binary .= '.exe';
+            }
+
+            $openBaseDir = ini_get('open_basedir');
+
+            if ($openBaseDir !== FALSE) {
+                $safeModeExecDir = ini_get('safe_mode_exec_dir');
+                $var             = $openBaseDir;
+
+                if (!empty($safeModeExecDir)) {
+                    $var .= PATH_SEPARATOR . $safeModeExecDir;
+                }
+            } else {
+                if (isset($_ENV['PATH'])) {
+                    $var = $_ENV['PATH'];
+                }
+
+                else if (isset($_ENV['Path'])) {
+                    $var = $_ENV['Path'];
+                }
+
+                else if (isset($_SERVER['PATH'])) {
+                    $var = $_SERVER['PATH'];
+                }
+
+                else if (isset($_SERVER['Path'])) {
+                    $var = $_SERVER['Path'];
+                }
+            }
+
+            if (isset($var)) {
+                $paths = explode(PATH_SEPARATOR, $var);
+            } else {
+                $paths = array();
+            }
+
+            foreach ($paths as $path) {
+                $_path = $path . DIRECTORY_SEPARATOR . $binary;
+
+                if (file_exists($_path) && is_executable($_path)) {
+                    self::$hasBinary[$binary] = TRUE;
+                    break;
+                }
+            }
+        }
+
+        return self::$hasBinary[$binary];
+    }
+
     /**
      * Reduces the paths by cutting the longest common start path.
      *
diff --git a/package.xml b/package.xml
index a00318037..56ed9aee6 100644
--- a/package.xml
+++ b/package.xml
@@ -1285,6 +1285,9 @@
      <file baseinstalldir="/" name="Configuration.php" role="php">
       <tasks:replace from="@package_version@" to="version" type="package-info" />
      </file>
+     <file baseinstalldir="/" name="Diff.php" role="php">
+      <tasks:replace from="@package_version@" to="version" type="package-info" />
+     </file>
      <file baseinstalldir="/" name="ErrorHandler.php" role="php">
       <tasks:replace from="@package_version@" to="version" type="package-info" />
      </file>
@@ -1384,6 +1387,11 @@
     <name>Log</name>
     <channel>pear.php.net</channel>
    </package>
+   <package>
+    <name>Text_Diff</name>
+    <channel>pear.php.net</channel>
+    <min>1.1.0</min>
+   </package>
    <extension>
     <name>json</name>
    </extension>
