{"url":"https://api.github.com/repos/rwf2/Rocket/issues/2512","repository_url":"https://api.github.com/repos/rwf2/Rocket","labels_url":"https://api.github.com/repos/rwf2/Rocket/issues/2512/labels{/name}","comments_url":"https://api.github.com/repos/rwf2/Rocket/issues/2512/comments","events_url":"https://api.github.com/repos/rwf2/Rocket/issues/2512/events","html_url":"https://github.com/rwf2/Rocket/issues/2512","id":1652795241,"node_id":"I_kwDOAzqMt85ig6dp","number":2512,"title":"Reconsider URI normalization","user":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":758540633,"node_id":"MDU6TGFiZWw3NTg1NDA2MzM=","url":"https://api.github.com/repos/rwf2/Rocket/labels/suggestion","name":"suggestion","color":"5319E7","default":false,"description":"A suggestion to change functionality"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-04-03T21:23:02Z","updated_at":"2023-04-10T22:48:28Z","closed_at":"2023-04-10T22:48:28Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"At present, Rocket considers the following URLs equivalent and will often normalize to the first variant:\r\n\r\n1. `https://rocket.rs/foo`\r\n2. `https://rocket.rs/foo/`\r\n3. `https://rocket.rs/foo/?`\r\n\r\nRFC#3986 [6.2.2](https://www.rfc-editor.org/rfc/rfc3986#section-6.2.2) describes the types of normalization that should result in equivalent URIs. Comparing the guidelines in the RFC with the examples above, we conclude that while Rocket is not violating the RFC, it also isn't following the RFC's advice. In particular, the RFC states:\r\n\r\n> In general, a URI that uses the generic syntax for authority with an empty path should be normalized to a path of \"/\".\r\n\r\n~~This means that the first variant (`https://rocket.rs/foo`) should be normalized to the second (`https://rocket.rs/foo/`) whereas Rocket actually performs the inverse.~~ correction: This isn't stated by the RFC, but the RFC does mention that `/foo` and `/foo/` _may_ be equivalent, not _should_, so performing the normalization in the inverse isn't necessarily correct. The RFC further states:\r\n\r\n> For example, the URI \"http://example.com/?\" cannot be assumed to be equivalent to any of the examples above.\r\n\r\nGiven that the examples the RFC refers to include `http://example.com`, we can conclude that Rocket is also not following this guideline: it normalizes the third variant (`https://rocket.rs/foo/?`) above to the first (`https://rocket.rs/foo`).\r\n\r\nThis is problematic, not only because we're not following the guidelines in the RFC, but also because other servers may not be either. This means that even though considering `https://rocket.rs/foo/` and `https://rocket.rs/foo` equivalent is  strictly correct as far as the RFC goes, other servers may disagree. And since the `uri!()` macro performs normalization automatically, this can result in a frustrating case where a user can't comfortably use the `uri!()` macro to construct the needed URI to an external resource.\r\n\r\nMy recommendation is that Rocket continue to perform normalization, but limited to mutations that are extremely unlikely to cause issues in the wild. In particular, Rocket should only remove empty segments in the _middle_ of a component and apply _no further normalization_. Here are examples of applying this rule:\r\n\r\nThese remain unchanged after normalization, unlike before:\r\n\r\n* `https://rocket.rs/foo`\r\n* `https://rocket.rs/foo/`\r\n* `https://rocket.rs/foo/?`\r\n* `/a/b/`\r\n* `/?&foo&` -> `/?&foo&`\r\n* `/?foo&` -> `/?foo&`\r\n\r\nThese are still normalized, but more conservatively:\r\n\r\n* `https://rocket.rs/foo//?` -> `https://rocket.rs/foo/?`\r\n* `https://rocket.rs/.././foo//?` -> `https://rocket.rs/foo/?`\r\n* `https://rocket.rs/.././foo/../?` -> `https://rocket.rs/?`\r\n* `https://rocket.rs/.././foo/../../?` -> `https://rocket.rs/?`\r\n* `/a/ab//c//d/` -> `/a/ab/c/d/`\r\n* `/?a&&b` -> `/?a&b`\r\n* `/?a&&b&` -> `/?a&b`\r\n* `/?&` -> `/?&`\r\n\r\nSome URIs normalize just like before:\r\n\r\n* `//` -> `/`\r\n* `///` -> `/`\r\n* `/a/ab//c//d` -> `/a/ab/c/d`\r\n* `/a/ab//c//d?foo` -> `/a/ab/c/d?foo`\r\n\r\n<sup>According to [whatwg on form-urlencoded](https://url.spec.whatwg.org/#application/x-www-form-urlencoded), we can be significantly more aggressive with normalizing query strings, if desired.</sup>\r\n\r\nWe should explore making this change sooner than later.","closed_by":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/2512/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rwf2/Rocket/issues/2512/timeline","performed_via_github_app":null,"state_reason":"completed"}