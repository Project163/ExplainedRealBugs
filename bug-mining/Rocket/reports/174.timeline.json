[{"id":4155816714,"node_id":"MDEyOkxhYmVsZWRFdmVudDQxNTU4MTY3MTQ=","url":"https://api.github.com/repos/rwf2/Rocket/issues/events/4155816714","actor":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2020-12-29T22:01:51Z","label":{"name":"enhancement","color":"84b6eb"},"performed_via_github_app":null},{"id":4155816959,"node_id":"MDEyOkxhYmVsZWRFdmVudDQxNTU4MTY5NTk=","url":"https://api.github.com/repos/rwf2/Rocket/issues/events/4155816959","actor":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2020-12-29T22:02:02Z","label":{"name":"help wanted","color":"006b75"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/752705222","html_url":"https://github.com/rwf2/Rocket/issues/1498#issuecomment-752705222","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1498","id":752705222,"node_id":"MDEyOklzc3VlQ29tbWVudDc1MjcwNTIyMg==","user":{"login":"jebrosen","id":7102588,"node_id":"MDQ6VXNlcjcxMDI1ODg=","avatar_url":"https://avatars.githubusercontent.com/u/7102588?v=4","gravatar_id":"","url":"https://api.github.com/users/jebrosen","html_url":"https://github.com/jebrosen","followers_url":"https://api.github.com/users/jebrosen/followers","following_url":"https://api.github.com/users/jebrosen/following{/other_user}","gists_url":"https://api.github.com/users/jebrosen/gists{/gist_id}","starred_url":"https://api.github.com/users/jebrosen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jebrosen/subscriptions","organizations_url":"https://api.github.com/users/jebrosen/orgs","repos_url":"https://api.github.com/users/jebrosen/repos","events_url":"https://api.github.com/users/jebrosen/events{/privacy}","received_events_url":"https://api.github.com/users/jebrosen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-12-30T17:51:49Z","updated_at":"2020-12-30T22:54:24Z","body":"> Header names and values cannot borrow.\r\n\r\n~~We *might* actually be able to do this already, by having `Request::from_hyp` take an `&'r HeaderMap`! This still allocates when `String::from_utf8_lossy` does.~~","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/752705222/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jebrosen","id":7102588,"node_id":"MDQ6VXNlcjcxMDI1ODg=","avatar_url":"https://avatars.githubusercontent.com/u/7102588?v=4","gravatar_id":"","url":"https://api.github.com/users/jebrosen","html_url":"https://github.com/jebrosen","followers_url":"https://api.github.com/users/jebrosen/followers","following_url":"https://api.github.com/users/jebrosen/following{/other_user}","gists_url":"https://api.github.com/users/jebrosen/gists{/gist_id}","starred_url":"https://api.github.com/users/jebrosen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jebrosen/subscriptions","organizations_url":"https://api.github.com/users/jebrosen/orgs","repos_url":"https://api.github.com/users/jebrosen/repos","events_url":"https://api.github.com/users/jebrosen/events{/privacy}","received_events_url":"https://api.github.com/users/jebrosen/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/752765935","html_url":"https://github.com/rwf2/Rocket/issues/1498#issuecomment-752765935","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1498","id":752765935,"node_id":"MDEyOklzc3VlQ29tbWVudDc1Mjc2NTkzNQ==","user":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-12-30T21:36:12Z","updated_at":"2020-12-30T21:36:12Z","body":"> > Header names and values cannot borrow.\r\n> \r\n> We _might_ actually be able to do this already, by having `Request::from_hyp` take an `&'r HeaderMap`! This still allocates when `String::from_utf8_lossy` does.\r\n\r\nI'm not sure I follow. As far as I can tell, there is _no_ way to get `HeaderMap` to accept borrowed strings for header names, and the only way to do the same for values would be to have a custom `HeaderValue` type. When converting the hyper values into these new Rocket one's, it would mean _at least_ copying all of the names/values into the new `HeaderMap`, though it would save the allocation time for each value, and we could optimize the value so that we don't \"require a UTF-8 check every time\". Is this what you had in mind?","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/752765935/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/752784683","html_url":"https://github.com/rwf2/Rocket/issues/1498#issuecomment-752784683","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1498","id":752784683,"node_id":"MDEyOklzc3VlQ29tbWVudDc1Mjc4NDY4Mw==","user":{"login":"jebrosen","id":7102588,"node_id":"MDQ6VXNlcjcxMDI1ODg=","avatar_url":"https://avatars.githubusercontent.com/u/7102588?v=4","gravatar_id":"","url":"https://api.github.com/users/jebrosen","html_url":"https://github.com/jebrosen","followers_url":"https://api.github.com/users/jebrosen/followers","following_url":"https://api.github.com/users/jebrosen/following{/other_user}","gists_url":"https://api.github.com/users/jebrosen/gists{/gist_id}","starred_url":"https://api.github.com/users/jebrosen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jebrosen/subscriptions","organizations_url":"https://api.github.com/users/jebrosen/orgs","repos_url":"https://api.github.com/users/jebrosen/repos","events_url":"https://api.github.com/users/jebrosen/events{/privacy}","received_events_url":"https://api.github.com/users/jebrosen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-12-30T23:06:31Z","updated_at":"2020-12-30T23:06:31Z","body":"Sorry - I conflated that point with the situation in both `0.4` and `master`, where the request headers are cloned into a new `rocket` `HeaderMap` (with new allocations), instead of taking references to `hyper`'s original `HeaderMap` or reusing the allocations somehow where possible. Reusing or wrapping the `HeaderMap` wholesale makes neither of those necessary.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/752784683/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jebrosen","id":7102588,"node_id":"MDQ6VXNlcjcxMDI1ODg=","avatar_url":"https://avatars.githubusercontent.com/u/7102588?v=4","gravatar_id":"","url":"https://api.github.com/users/jebrosen","html_url":"https://github.com/jebrosen","followers_url":"https://api.github.com/users/jebrosen/followers","following_url":"https://api.github.com/users/jebrosen/following{/other_user}","gists_url":"https://api.github.com/users/jebrosen/gists{/gist_id}","starred_url":"https://api.github.com/users/jebrosen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jebrosen/subscriptions","organizations_url":"https://api.github.com/users/jebrosen/orgs","repos_url":"https://api.github.com/users/jebrosen/repos","events_url":"https://api.github.com/users/jebrosen/events{/privacy}","received_events_url":"https://api.github.com/users/jebrosen/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"jespersm","id":664940,"node_id":"MDQ6VXNlcjY2NDk0MA==","avatar_url":"https://avatars.githubusercontent.com/u/664940?v=4","gravatar_id":"","url":"https://api.github.com/users/jespersm","html_url":"https://github.com/jespersm","followers_url":"https://api.github.com/users/jespersm/followers","following_url":"https://api.github.com/users/jespersm/following{/other_user}","gists_url":"https://api.github.com/users/jespersm/gists{/gist_id}","starred_url":"https://api.github.com/users/jespersm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jespersm/subscriptions","organizations_url":"https://api.github.com/users/jespersm/orgs","repos_url":"https://api.github.com/users/jespersm/repos","events_url":"https://api.github.com/users/jespersm/events{/privacy}","received_events_url":"https://api.github.com/users/jespersm/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-02-13T20:42:38Z","updated_at":"2021-02-13T20:42:38Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/1535","repository_url":"https://api.github.com/repos/rwf2/Rocket","labels_url":"https://api.github.com/repos/rwf2/Rocket/issues/1535/labels{/name}","comments_url":"https://api.github.com/repos/rwf2/Rocket/issues/1535/comments","events_url":"https://api.github.com/repos/rwf2/Rocket/issues/1535/events","html_url":"https://github.com/rwf2/Rocket/pull/1535","id":805080887,"node_id":"MDExOlB1bGxSZXF1ZXN0NTcwNzQzOTQy","number":1535,"title":"Fix #1067 by importing typed headers from hyperx","user":{"login":"jespersm","id":664940,"node_id":"MDQ6VXNlcjY2NDk0MA==","avatar_url":"https://avatars.githubusercontent.com/u/664940?v=4","gravatar_id":"","url":"https://api.github.com/users/jespersm","html_url":"https://github.com/jespersm","followers_url":"https://api.github.com/users/jespersm/followers","following_url":"https://api.github.com/users/jespersm/following{/other_user}","gists_url":"https://api.github.com/users/jespersm/gists{/gist_id}","starred_url":"https://api.github.com/users/jespersm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jespersm/subscriptions","organizations_url":"https://api.github.com/users/jespersm/orgs","repos_url":"https://api.github.com/users/jespersm/repos","events_url":"https://api.github.com/users/jespersm/events{/privacy}","received_events_url":"https://api.github.com/users/jespersm/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2021-02-10T01:52:17Z","updated_at":"2021-06-29T12:25:09Z","closed_at":"2021-06-29T12:25:09Z","author_association":"NONE","type":null,"active_lock_reason":null,"draft":false,"repository":{"id":54168759,"node_id":"MDEwOlJlcG9zaXRvcnk1NDE2ODc1OQ==","name":"Rocket","full_name":"rwf2/Rocket","private":false,"owner":{"login":"rwf2","id":106361765,"node_id":"O_kgDOBlbzpQ","avatar_url":"https://avatars.githubusercontent.com/u/106361765?v=4","gravatar_id":"","url":"https://api.github.com/users/rwf2","html_url":"https://github.com/rwf2","followers_url":"https://api.github.com/users/rwf2/followers","following_url":"https://api.github.com/users/rwf2/following{/other_user}","gists_url":"https://api.github.com/users/rwf2/gists{/gist_id}","starred_url":"https://api.github.com/users/rwf2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rwf2/subscriptions","organizations_url":"https://api.github.com/users/rwf2/orgs","repos_url":"https://api.github.com/users/rwf2/repos","events_url":"https://api.github.com/users/rwf2/events{/privacy}","received_events_url":"https://api.github.com/users/rwf2/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/rwf2/Rocket","description":"A web framework for Rust.","fork":false,"url":"https://api.github.com/repos/rwf2/Rocket","forks_url":"https://api.github.com/repos/rwf2/Rocket/forks","keys_url":"https://api.github.com/repos/rwf2/Rocket/keys{/key_id}","collaborators_url":"https://api.github.com/repos/rwf2/Rocket/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/rwf2/Rocket/teams","hooks_url":"https://api.github.com/repos/rwf2/Rocket/hooks","issue_events_url":"https://api.github.com/repos/rwf2/Rocket/issues/events{/number}","events_url":"https://api.github.com/repos/rwf2/Rocket/events","assignees_url":"https://api.github.com/repos/rwf2/Rocket/assignees{/user}","branches_url":"https://api.github.com/repos/rwf2/Rocket/branches{/branch}","tags_url":"https://api.github.com/repos/rwf2/Rocket/tags","blobs_url":"https://api.github.com/repos/rwf2/Rocket/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/rwf2/Rocket/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/rwf2/Rocket/git/refs{/sha}","trees_url":"https://api.github.com/repos/rwf2/Rocket/git/trees{/sha}","statuses_url":"https://api.github.com/repos/rwf2/Rocket/statuses/{sha}","languages_url":"https://api.github.com/repos/rwf2/Rocket/languages","stargazers_url":"https://api.github.com/repos/rwf2/Rocket/stargazers","contributors_url":"https://api.github.com/repos/rwf2/Rocket/contributors","subscribers_url":"https://api.github.com/repos/rwf2/Rocket/subscribers","subscription_url":"https://api.github.com/repos/rwf2/Rocket/subscription","commits_url":"https://api.github.com/repos/rwf2/Rocket/commits{/sha}","git_commits_url":"https://api.github.com/repos/rwf2/Rocket/git/commits{/sha}","comments_url":"https://api.github.com/repos/rwf2/Rocket/comments{/number}","issue_comment_url":"https://api.github.com/repos/rwf2/Rocket/issues/comments{/number}","contents_url":"https://api.github.com/repos/rwf2/Rocket/contents/{+path}","compare_url":"https://api.github.com/repos/rwf2/Rocket/compare/{base}...{head}","merges_url":"https://api.github.com/repos/rwf2/Rocket/merges","archive_url":"https://api.github.com/repos/rwf2/Rocket/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/rwf2/Rocket/downloads","issues_url":"https://api.github.com/repos/rwf2/Rocket/issues{/number}","pulls_url":"https://api.github.com/repos/rwf2/Rocket/pulls{/number}","milestones_url":"https://api.github.com/repos/rwf2/Rocket/milestones{/number}","notifications_url":"https://api.github.com/repos/rwf2/Rocket/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/rwf2/Rocket/labels{/name}","releases_url":"https://api.github.com/repos/rwf2/Rocket/releases{/id}","deployments_url":"https://api.github.com/repos/rwf2/Rocket/deployments","created_at":"2016-03-18T02:50:18Z","updated_at":"2025-11-09T18:27:08Z","pushed_at":"2025-10-01T04:53:46Z","git_url":"git://github.com/rwf2/Rocket.git","ssh_url":"git@github.com:rwf2/Rocket.git","clone_url":"https://github.com/rwf2/Rocket.git","svn_url":"https://github.com/rwf2/Rocket","homepage":"https://rocket.rs","size":8445,"stargazers_count":25480,"watchers_count":25480,"language":"Rust","has_issues":true,"has_projects":true,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":true,"forks_count":1614,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":84,"license":{"key":"other","name":"Other","spdx_id":"NOASSERTION","url":null,"node_id":"MDc6TGljZW5zZTA="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["framework","rocket","rust","web","web-development","web-framework"],"visibility":"public","forks":1614,"open_issues":84,"watchers":25480,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/rwf2/Rocket/pulls/1535","html_url":"https://github.com/rwf2/Rocket/pull/1535","diff_url":"https://github.com/rwf2/Rocket/pull/1535.diff","patch_url":"https://github.com/rwf2/Rocket/pull/1535.patch","merged_at":null},"body":"First attempt patch for #1067.\r\n\r\nImports all typed headers from `hyperx` except \"Set-Cookie\" since it requires multiline format, and thus can't do simple to_string().\r\n\r\nProbably not a big deal since Rocket handles cookies through CookieJar mechanism.","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/1535/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rwf2/Rocket/issues/1535/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/780182488","html_url":"https://github.com/rwf2/Rocket/issues/1498#issuecomment-780182488","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1498","id":780182488,"node_id":"MDEyOklzc3VlQ29tbWVudDc4MDE4MjQ4OA==","user":{"login":"jespersm","id":664940,"node_id":"MDQ6VXNlcjY2NDk0MA==","avatar_url":"https://avatars.githubusercontent.com/u/664940?v=4","gravatar_id":"","url":"https://api.github.com/users/jespersm","html_url":"https://github.com/jespersm","followers_url":"https://api.github.com/users/jespersm/followers","following_url":"https://api.github.com/users/jespersm/following{/other_user}","gists_url":"https://api.github.com/users/jespersm/gists{/gist_id}","starred_url":"https://api.github.com/users/jespersm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jespersm/subscriptions","organizations_url":"https://api.github.com/users/jespersm/orgs","repos_url":"https://api.github.com/users/jespersm/repos","events_url":"https://api.github.com/users/jespersm/events{/privacy}","received_events_url":"https://api.github.com/users/jespersm/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-02-16T23:23:24Z","updated_at":"2021-02-16T23:23:24Z","body":"I've tried implementing a new HeaderMap which wraps `http::HeaderMap` so that it can be moved in during request initialisation and response generation. Sure, it works, but there are *a* *ton* of doctest which end up looking rather ugly, where header data now are compared as strings.\r\nExposing the actual HeaderValues would make these tests slightly more tolerable, and push the eventual bytes->string handling onto the user.\r\n\r\nAs for the issues raised above:\r\n\r\n> Header names and values cannot borrow.\r\n\r\nTrue, but this is slightly mitigated by taking ownership of Hyper's headers as suggested above.\r\n\r\nFor header names, it's not much waste anyway, since the internal representation is either an owned string (which will be initialized just once during processing), or a \"known\" header, which is represented efficiently.\r\n\r\n> Retrieving a value as a string requires a UTF-8 check every time.\r\n\r\nExposing the actual HeaderValues would make these tests slightly more tolerable, and push the eventual bytes->string handling onto the user. The only other way to deal with this is to ensure that only values stored in the map are always valid UTF-8, but that's not spec compliant.\r\n\r\n> The map also does not preserve case which is known to cause issues downstream.\r\n\r\nWe have those issues already on `master`, since the incoming AND outgoing headers are processed by http::HeaderMap anyway. So no user-chosen case gets in or out.\r\n\r\nFinally, how should we insert and lookups by `&str` values which are not always valid header names? There's an issue in initializing a HeaderName form a bare string, since this can fail. This is fixable by using a declarative macro like `header_name!(\"X-My-Header\")` which can use a const fn to ensure that the eventual unwrap() is safe, like const_assert does. Would that be too clunky? It's better to provide a compile-time check than subjecting the user to a panic.\r\nIdeally, this should be done in `http`.\r\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/780182488/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jespersm","id":664940,"node_id":"MDQ6VXNlcjY2NDk0MA==","avatar_url":"https://avatars.githubusercontent.com/u/664940?v=4","gravatar_id":"","url":"https://api.github.com/users/jespersm","html_url":"https://github.com/jespersm","followers_url":"https://api.github.com/users/jespersm/followers","following_url":"https://api.github.com/users/jespersm/following{/other_user}","gists_url":"https://api.github.com/users/jespersm/gists{/gist_id}","starred_url":"https://api.github.com/users/jespersm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jespersm/subscriptions","organizations_url":"https://api.github.com/users/jespersm/orgs","repos_url":"https://api.github.com/users/jespersm/repos","events_url":"https://api.github.com/users/jespersm/events{/privacy}","received_events_url":"https://api.github.com/users/jespersm/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/780289451","html_url":"https://github.com/rwf2/Rocket/issues/1498#issuecomment-780289451","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1498","id":780289451,"node_id":"MDEyOklzc3VlQ29tbWVudDc4MDI4OTQ1MQ==","user":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-02-17T04:28:52Z","updated_at":"2021-02-17T04:28:52Z","body":"Thanks for taking a look at this!\r\n\r\n> I've tried implementing a new HeaderMap which wraps `http::HeaderMap` so that it can be moved in during request initialisation and response generation. Sure, it works, but there are _a_ _ton_ of doctest which end up looking rather ugly, where header data now are compared as strings.\r\n\r\nAre you saying you've done something like:\r\n\r\n```rust\r\npub struct HeaderMap<'h> {\r\n    hyper: http::HeaderMap\r\n    headers: IndexMap<Uncased<'h>, Vec<Cow<'h, str>>>\r\n}\r\n```\r\n\r\nOr something else? If you haven't done the former, this is the approach that I think would be a good fit in the interim.\r\n\r\n> Exposing the actual HeaderValues would make these tests slightly more tolerable, and push the eventual bytes->string handling onto the user.\r\n\r\nI don't think the user should have to deal with such a common task themselves. At worst, we should have two methods, one which returns bytes and the other a string, caching the result of the latter for later retrieval.\r\n\r\n> As for the issues raised above:\r\n> \r\n> > Header names and values cannot borrow.\r\n> \r\n> True, but this is slightly mitigated by taking ownership of Hyper's headers as suggested above.\r\n\r\nThe issue is with adding new headers that borrow from the request. Unless the approach I've suggested above is taken, the issue isn't at all mitigated.\r\n\r\n> > Retrieving a value as a string requires a UTF-8 check every time.\r\n> \r\n> Exposing the actual HeaderValues would make these tests slightly more tolerable, and push the eventual bytes->string handling onto the user. The only other way to deal with this is to ensure that only values stored in the map are always valid UTF-8, but that's not spec compliant.\r\n\r\nI think a header `get()` should something look like:\r\n\r\n```rust\r\nfn get(&self name: &str) -> impl Iterator<Item = &str> {\r\n    self.headers.get(name)\r\n        .or_else(self.hyper.get(name))\r\n        .filter_map(|h| h.as_str())\r\n}\r\n```\r\n\r\nThat is, try to get from `self.headers` first then from `self.hyper`. An `insert` would need to do the appropriate thing.\r\n\r\n> > The map also does not preserve case which is known to cause issues downstream.\r\n> \r\n> We have those issues already on `master`, since the incoming AND outgoing headers are processed by http::HeaderMap anyway. So no user-chosen case gets in or out.\r\n\r\nThat's a good point, though ideally this wouldn't be the case.\r\n\r\nIn all, I really think `http::HeaderMap` should simply be fixed to address the issues above.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/780289451/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":4346025605,"node_id":"MDE1OlJlZmVyZW5jZWRFdmVudDQzNDYwMjU2MDU=","url":"https://api.github.com/repos/rwf2/Rocket/issues/events/4346025605","actor":{"login":"jespersm","id":664940,"node_id":"MDQ6VXNlcjY2NDk0MA==","avatar_url":"https://avatars.githubusercontent.com/u/664940?v=4","gravatar_id":"","url":"https://api.github.com/users/jespersm","html_url":"https://github.com/jespersm","followers_url":"https://api.github.com/users/jespersm/followers","following_url":"https://api.github.com/users/jespersm/following{/other_user}","gists_url":"https://api.github.com/users/jespersm/gists{/gist_id}","starred_url":"https://api.github.com/users/jespersm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jespersm/subscriptions","organizations_url":"https://api.github.com/users/jespersm/orgs","repos_url":"https://api.github.com/users/jespersm/repos","events_url":"https://api.github.com/users/jespersm/events{/privacy}","received_events_url":"https://api.github.com/users/jespersm/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"fcb59818b9bd7c9da9063cb4dc346c4d7dfb32d5","commit_url":"https://api.github.com/repos/jespersm/Rocket/commits/fcb59818b9bd7c9da9063cb4dc346c4d7dfb32d5","created_at":"2021-02-18T10:37:08Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/781251796","html_url":"https://github.com/rwf2/Rocket/issues/1498#issuecomment-781251796","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1498","id":781251796,"node_id":"MDEyOklzc3VlQ29tbWVudDc4MTI1MTc5Ng==","user":{"login":"jespersm","id":664940,"node_id":"MDQ6VXNlcjY2NDk0MA==","avatar_url":"https://avatars.githubusercontent.com/u/664940?v=4","gravatar_id":"","url":"https://api.github.com/users/jespersm","html_url":"https://github.com/jespersm","followers_url":"https://api.github.com/users/jespersm/followers","following_url":"https://api.github.com/users/jespersm/following{/other_user}","gists_url":"https://api.github.com/users/jespersm/gists{/gist_id}","starred_url":"https://api.github.com/users/jespersm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jespersm/subscriptions","organizations_url":"https://api.github.com/users/jespersm/orgs","repos_url":"https://api.github.com/users/jespersm/repos","events_url":"https://api.github.com/users/jespersm/events{/privacy}","received_events_url":"https://api.github.com/users/jespersm/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-02-18T10:42:01Z","updated_at":"2021-02-18T10:43:35Z","body":"> Thanks for taking a look at this!\r\n\r\nYou're welcome. I really like Rocket's approach, and I'd like to help it towards a nice 0.5 release on stable Rust.\r\n\r\n> > I've tried implementing a new HeaderMap which wraps `http::HeaderMap` so that it can be moved in during request initialisation and response generation. Sure, it works, but there are _a_ _ton_ of doctest which end up looking rather ugly, where header data now are compared as strings.\r\n> \r\n> Are you saying you've done something like:\r\n> \r\n> ```rust\r\n> pub struct HeaderMap<'h> {\r\n>     hyper: http::HeaderMap\r\n>     headers: IndexMap<Uncased<'h>, Vec<Cow<'h, str>>>\r\n> }\r\n> ```\r\n\r\nNo, I have just one map, the `http::HeaderMap<>` one.\r\nIllegal header names and values are checked on insertion, rather than when committing the response, as now.\r\n\r\n> Or something else? If you haven't done the former, this is the approach that I think would be a good fit in the interim.\r\n\r\nUsing two maps would help with the duplication of incoming request headers, but not the overhead around outgoing response headers (nor the problem with converting values and header names to and from strings).\r\nThe response headers will ultimately be put into a http::HeaderMap on preparing the response, since hyper only deals with http::HeaderMap. That why I opted for the wholesale reuse of that.\r\n\r\n> > Exposing the actual HeaderValues would make these tests slightly more tolerable, and push the eventual bytes->string handling onto the user.\r\n> \r\n> I don't think the user should have to deal with such a common task themselves. At worst, we should have two methods, one which returns bytes and the other a string, caching the result of the latter for later retrieval.\r\n\r\nI don't get this. Would you just \"panic\" on illegal header names or values, or \"sanitize\" them by dropping the offending bytes? Perhaps I am focusing too much on edge cases? ;-)\r\n\r\n> > As for the issues raised above:\r\n> > > Header names and values cannot borrow.\r\n> > \r\n> > \r\n> > True, but this is slightly mitigated by taking ownership of Hyper's headers as suggested above.\r\n> \r\n> The issue is with adding new headers that borrow from the request. Unless the approach I've suggested above is taken, the issue isn't at all mitigated.\r\n\r\nBut the results are eventually allocated and put into http::HeaderMap before being returned to hyper (in `Rocket::make_response`. So there no allocations saved on the outgoing header?\r\n \r\n> > > Retrieving a value as a string requires a UTF-8 check every time.\r\n> > \r\n> > \r\n> > Exposing the actual HeaderValues would make these tests slightly more tolerable, and push the eventual bytes->string handling onto the user. The only other way to deal with this is to ensure that only values stored in the map are always valid UTF-8, but that's not spec compliant.\r\n> \r\n> I think a header `get()` should something look like:\r\n> \r\n> ```rust\r\n> fn get(&self name: &str) -> impl Iterator<Item = &str> {\r\n>     self.headers.get(name)\r\n>         .or_else(self.hyper.get(name))\r\n>         .filter_map(|h| h.as_str())\r\n> }\r\n> ```\r\n> \r\n> That is, try to get from `self.headers` first then from `self.hyper`. An `insert` would need to do the appropriate thing.\r\n> \r\n> > > The map also does not preserve case which is known to cause issues downstream.\r\n> > \r\n> > \r\n> > We have those issues already on `master`, since the incoming AND outgoing headers are processed by http::HeaderMap anyway. So no user-chosen case gets in or out.\r\n> \r\n> That's a good point, though ideally this wouldn't be the case.\r\n> \r\n> In all, I really think `http::HeaderMap` should simply be fixed to address the issues above.\r\n\r\nYes, that's probably the right place to address both the case-preservation and the borrowing issue, if fixable.\r\n\r\nAnyway, I've thrown my work in progress in a branch on my fork: https://github.com/jespersm/Rocket/commit/fcb59818b9bd7c9da9063cb4dc346c4d7dfb32d5 (note: it has multiple issues, TODOs, and the tests don't compile.)\r\n","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/781251796/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jespersm","id":664940,"node_id":"MDQ6VXNlcjY2NDk0MA==","avatar_url":"https://avatars.githubusercontent.com/u/664940?v=4","gravatar_id":"","url":"https://api.github.com/users/jespersm","html_url":"https://github.com/jespersm","followers_url":"https://api.github.com/users/jespersm/followers","following_url":"https://api.github.com/users/jespersm/following{/other_user}","gists_url":"https://api.github.com/users/jespersm/gists{/gist_id}","starred_url":"https://api.github.com/users/jespersm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jespersm/subscriptions","organizations_url":"https://api.github.com/users/jespersm/orgs","repos_url":"https://api.github.com/users/jespersm/repos","events_url":"https://api.github.com/users/jespersm/events{/privacy}","received_events_url":"https://api.github.com/users/jespersm/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/782377500","html_url":"https://github.com/rwf2/Rocket/issues/1498#issuecomment-782377500","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1498","id":782377500,"node_id":"MDEyOklzc3VlQ29tbWVudDc4MjM3NzUwMA==","user":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-02-19T21:44:13Z","updated_at":"2021-02-19T21:44:24Z","body":"Excellent points regarding allocations! I would be in favor of a change to use `http::HeaderMap` internally _as long as_ the public API does not change and continues to \"allow\" borrows of request-scoped data.\r\n\r\n> I don't get this. Would you just \"panic\" on illegal header names or values, or \"sanitize\" them by dropping the offending bytes? Perhaps I am focusing too much on edge cases? ;-)\r\n\r\nPerhaps the correct surface API to change here is that of `Header`: should we make `Header` fail when an invalid header name/value is used? It would be great if we could have a `const` API that fails at compile-time for statically known strings.","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/782377500/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/782612883","html_url":"https://github.com/rwf2/Rocket/issues/1498#issuecomment-782612883","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1498","id":782612883,"node_id":"MDEyOklzc3VlQ29tbWVudDc4MjYxMjg4Mw==","user":{"login":"jespersm","id":664940,"node_id":"MDQ6VXNlcjY2NDk0MA==","avatar_url":"https://avatars.githubusercontent.com/u/664940?v=4","gravatar_id":"","url":"https://api.github.com/users/jespersm","html_url":"https://github.com/jespersm","followers_url":"https://api.github.com/users/jespersm/followers","following_url":"https://api.github.com/users/jespersm/following{/other_user}","gists_url":"https://api.github.com/users/jespersm/gists{/gist_id}","starred_url":"https://api.github.com/users/jespersm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jespersm/subscriptions","organizations_url":"https://api.github.com/users/jespersm/orgs","repos_url":"https://api.github.com/users/jespersm/repos","events_url":"https://api.github.com/users/jespersm/events{/privacy}","received_events_url":"https://api.github.com/users/jespersm/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-02-20T11:47:40Z","updated_at":"2021-02-20T11:47:40Z","body":"> Excellent points regarding allocations! I would be in favor of a change to use `http::HeaderMap` internally _as long as_ the public API does not change and continues to \"allow\" borrows of request-scoped data.\r\n\r\nRight. This does require adding lifetimes for the borrowed values inside the `http` crate, for structs `http::header::HeaderValue`, `http::header::HeaderMap`, `http::Response` and `http::Builder`, a new `http` release, and it requires `hyper` to pick up that dependency. Perhaps we could also sneak in a way of inserting a complete `HeaderMap` into the `Builder` when making the response, that would save a bit of copying. I'll give it a go, and ask the maintainer.\r\n\r\nIt also requires either adding silent value dropping, or panic'ing on bad values, when getting and setting values.\r\n\r\n> > I don't get this. Would you just \"panic\" on illegal header names or values, or \"sanitize\" them by dropping the offending bytes? Perhaps I am focusing too much on edge cases? ;-)\r\n> \r\n> Perhaps the correct surface API to change here is that of `Header`: should we make `Header` fail when an invalid header name/value is used? It would be great if we could have a `const` API that fails at compile-time for statically known strings.\r\n\r\nExactly. I have a PoC of this in my branch already (for `HeaderName`):\r\n\r\n```rust\r\nlet vals: Vec<_> = req.headers().get(header_name!(\"My-Header\")).collect();\r\n```\r\n\r\n(Changing `My-Header` to e.g. `Rødgrød-Header` will cause a compile error, by the power of const fn). See  at https://github.com/jespersm/Rocket/blob/wip_1498/examples/hello_world/src/main.rs#L22-L57 for details.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/782612883/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jespersm","id":664940,"node_id":"MDQ6VXNlcjY2NDk0MA==","avatar_url":"https://avatars.githubusercontent.com/u/664940?v=4","gravatar_id":"","url":"https://api.github.com/users/jespersm","html_url":"https://github.com/jespersm","followers_url":"https://api.github.com/users/jespersm/followers","following_url":"https://api.github.com/users/jespersm/following{/other_user}","gists_url":"https://api.github.com/users/jespersm/gists{/gist_id}","starred_url":"https://api.github.com/users/jespersm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jespersm/subscriptions","organizations_url":"https://api.github.com/users/jespersm/orgs","repos_url":"https://api.github.com/users/jespersm/repos","events_url":"https://api.github.com/users/jespersm/events{/privacy}","received_events_url":"https://api.github.com/users/jespersm/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/786939540","html_url":"https://github.com/rwf2/Rocket/issues/1498#issuecomment-786939540","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1498","id":786939540,"node_id":"MDEyOklzc3VlQ29tbWVudDc4NjkzOTU0MA==","user":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-02-26T22:59:43Z","updated_at":"2021-02-26T22:59:54Z","body":"> Right. This does require adding lifetimes for the borrowed values inside the `http` crate, for structs `http::header::HeaderValue`, `http::header::HeaderMap`, `http::Response` and `http::Builder`, a new `http` release, and it requires `hyper` to pick up that dependency. Perhaps we could also sneak in a way of inserting a complete `HeaderMap` into the `Builder` when making the response, that would save a bit of copying. I'll give it a go, and ask the maintainer.\r\n\r\nI'm suggesting \"lying\": keep Rocket's API (except for `Header` related safety changes) _exactly_ the same and allocate internally as needed. If we get an `&'r str`, call `.to_string()`, and so on. The idea is that we can fix `http::HeaderMap` later  without any effect on Rocket's API.\r\n\r\n> Exactly. I have a PoC of this in my branch already (for `HeaderName`):\r\n\r\nVery cool!","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/786939540/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false}},{"actor":{"login":"jespersm","id":664940,"node_id":"MDQ6VXNlcjY2NDk0MA==","avatar_url":"https://avatars.githubusercontent.com/u/664940?v=4","gravatar_id":"","url":"https://api.github.com/users/jespersm","html_url":"https://github.com/jespersm","followers_url":"https://api.github.com/users/jespersm/followers","following_url":"https://api.github.com/users/jespersm/following{/other_user}","gists_url":"https://api.github.com/users/jespersm/gists{/gist_id}","starred_url":"https://api.github.com/users/jespersm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jespersm/subscriptions","organizations_url":"https://api.github.com/users/jespersm/orgs","repos_url":"https://api.github.com/users/jespersm/repos","events_url":"https://api.github.com/users/jespersm/events{/privacy}","received_events_url":"https://api.github.com/users/jespersm/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-02-27T23:39:38Z","updated_at":"2021-02-27T23:39:38Z","source":{"type":"issue","issue":{"url":"https://api.github.com/repos/hyperium/http/issues/467","repository_url":"https://api.github.com/repos/hyperium/http","labels_url":"https://api.github.com/repos/hyperium/http/issues/467/labels{/name}","comments_url":"https://api.github.com/repos/hyperium/http/issues/467/comments","events_url":"https://api.github.com/repos/hyperium/http/issues/467/events","html_url":"https://github.com/hyperium/http/pull/467","id":818056639,"node_id":"MDExOlB1bGxSZXF1ZXN0NTgxNDIxNjI2","number":467,"title":"Add lifetime to HttpValues for non-copying response headers","user":{"login":"jespersm","id":664940,"node_id":"MDQ6VXNlcjY2NDk0MA==","avatar_url":"https://avatars.githubusercontent.com/u/664940?v=4","gravatar_id":"","url":"https://api.github.com/users/jespersm","html_url":"https://github.com/jespersm","followers_url":"https://api.github.com/users/jespersm/followers","following_url":"https://api.github.com/users/jespersm/following{/other_user}","gists_url":"https://api.github.com/users/jespersm/gists{/gist_id}","starred_url":"https://api.github.com/users/jespersm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jespersm/subscriptions","organizations_url":"https://api.github.com/users/jespersm/orgs","repos_url":"https://api.github.com/users/jespersm/repos","events_url":"https://api.github.com/users/jespersm/events{/privacy}","received_events_url":"https://api.github.com/users/jespersm/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2021-02-27T23:39:38Z","updated_at":"2021-06-23T00:58:54Z","closed_at":null,"author_association":"NONE","type":null,"active_lock_reason":null,"draft":true,"repository":{"id":84983058,"node_id":"MDEwOlJlcG9zaXRvcnk4NDk4MzA1OA==","name":"http","full_name":"hyperium/http","private":false,"owner":{"login":"hyperium","id":8730506,"node_id":"MDEyOk9yZ2FuaXphdGlvbjg3MzA1MDY=","avatar_url":"https://avatars.githubusercontent.com/u/8730506?v=4","gravatar_id":"","url":"https://api.github.com/users/hyperium","html_url":"https://github.com/hyperium","followers_url":"https://api.github.com/users/hyperium/followers","following_url":"https://api.github.com/users/hyperium/following{/other_user}","gists_url":"https://api.github.com/users/hyperium/gists{/gist_id}","starred_url":"https://api.github.com/users/hyperium/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hyperium/subscriptions","organizations_url":"https://api.github.com/users/hyperium/orgs","repos_url":"https://api.github.com/users/hyperium/repos","events_url":"https://api.github.com/users/hyperium/events{/privacy}","received_events_url":"https://api.github.com/users/hyperium/received_events","type":"Organization","user_view_type":"public","site_admin":false},"html_url":"https://github.com/hyperium/http","description":"Rust HTTP types","fork":false,"url":"https://api.github.com/repos/hyperium/http","forks_url":"https://api.github.com/repos/hyperium/http/forks","keys_url":"https://api.github.com/repos/hyperium/http/keys{/key_id}","collaborators_url":"https://api.github.com/repos/hyperium/http/collaborators{/collaborator}","teams_url":"https://api.github.com/repos/hyperium/http/teams","hooks_url":"https://api.github.com/repos/hyperium/http/hooks","issue_events_url":"https://api.github.com/repos/hyperium/http/issues/events{/number}","events_url":"https://api.github.com/repos/hyperium/http/events","assignees_url":"https://api.github.com/repos/hyperium/http/assignees{/user}","branches_url":"https://api.github.com/repos/hyperium/http/branches{/branch}","tags_url":"https://api.github.com/repos/hyperium/http/tags","blobs_url":"https://api.github.com/repos/hyperium/http/git/blobs{/sha}","git_tags_url":"https://api.github.com/repos/hyperium/http/git/tags{/sha}","git_refs_url":"https://api.github.com/repos/hyperium/http/git/refs{/sha}","trees_url":"https://api.github.com/repos/hyperium/http/git/trees{/sha}","statuses_url":"https://api.github.com/repos/hyperium/http/statuses/{sha}","languages_url":"https://api.github.com/repos/hyperium/http/languages","stargazers_url":"https://api.github.com/repos/hyperium/http/stargazers","contributors_url":"https://api.github.com/repos/hyperium/http/contributors","subscribers_url":"https://api.github.com/repos/hyperium/http/subscribers","subscription_url":"https://api.github.com/repos/hyperium/http/subscription","commits_url":"https://api.github.com/repos/hyperium/http/commits{/sha}","git_commits_url":"https://api.github.com/repos/hyperium/http/git/commits{/sha}","comments_url":"https://api.github.com/repos/hyperium/http/comments{/number}","issue_comment_url":"https://api.github.com/repos/hyperium/http/issues/comments{/number}","contents_url":"https://api.github.com/repos/hyperium/http/contents/{+path}","compare_url":"https://api.github.com/repos/hyperium/http/compare/{base}...{head}","merges_url":"https://api.github.com/repos/hyperium/http/merges","archive_url":"https://api.github.com/repos/hyperium/http/{archive_format}{/ref}","downloads_url":"https://api.github.com/repos/hyperium/http/downloads","issues_url":"https://api.github.com/repos/hyperium/http/issues{/number}","pulls_url":"https://api.github.com/repos/hyperium/http/pulls{/number}","milestones_url":"https://api.github.com/repos/hyperium/http/milestones{/number}","notifications_url":"https://api.github.com/repos/hyperium/http/notifications{?since,all,participating}","labels_url":"https://api.github.com/repos/hyperium/http/labels{/name}","releases_url":"https://api.github.com/repos/hyperium/http/releases{/id}","deployments_url":"https://api.github.com/repos/hyperium/http/deployments","created_at":"2017-03-14T18:21:23Z","updated_at":"2025-11-08T11:57:36Z","pushed_at":"2025-11-04T13:24:55Z","git_url":"git://github.com/hyperium/http.git","ssh_url":"git@github.com:hyperium/http.git","clone_url":"https://github.com/hyperium/http.git","svn_url":"https://github.com/hyperium/http","homepage":"","size":737,"stargazers_count":1288,"watchers_count":1288,"language":"Rust","has_issues":true,"has_projects":false,"has_downloads":true,"has_wiki":false,"has_pages":false,"has_discussions":false,"forks_count":343,"mirror_url":null,"archived":false,"disabled":false,"open_issues_count":166,"license":{"key":"apache-2.0","name":"Apache License 2.0","spdx_id":"Apache-2.0","url":"https://api.github.com/licenses/apache-2.0","node_id":"MDc6TGljZW5zZTI="},"allow_forking":true,"is_template":false,"web_commit_signoff_required":false,"topics":["http","rust"],"visibility":"public","forks":343,"open_issues":166,"watchers":1288,"default_branch":"master","permissions":{"admin":false,"maintain":false,"push":false,"triage":false,"pull":true}},"pull_request":{"url":"https://api.github.com/repos/hyperium/http/pulls/467","html_url":"https://github.com/hyperium/http/pull/467","diff_url":"https://github.com/hyperium/http/pull/467.diff","patch_url":"https://github.com/hyperium/http/pull/467.patch","merged_at":null},"body":"This is a draft PR for adding lifetimes HeaderValues, HeaderMap, and Response, so that header _values_ can borrow from something with some longer lifetime.\r\n\r\nThe patch is implemented by suggestion from @SergioBenitez: This would reduce allocation in a number of cases and would match Rocket's current API for https://github.com/SergioBenitez/Rocket/issues/1498\r\n\r\nThere appears to be a slight time overhead due to the enum storing either a `&[u8]` reference instead of just the `Bytes` struct, but no noticeable impact otherwise. I've included a benchmark for the borrow case, and it appears to give the expected benefits.\r\n\r\nAs submitted, the patch breaks 9 doctests, and needs a bit of doc touches. I'll fix those if there is interest in adding this borrowing variation.","reactions":{"url":"https://api.github.com/repos/hyperium/http/issues/467/reactions","total_count":2,"+1":0,"-1":0,"laugh":0,"hooray":2,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hyperium/http/issues/467/timeline","performed_via_github_app":null,"state_reason":null}},"event":"cross-referenced"},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/787205616","html_url":"https://github.com/rwf2/Rocket/issues/1498#issuecomment-787205616","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1498","id":787205616,"node_id":"MDEyOklzc3VlQ29tbWVudDc4NzIwNTYxNg==","user":{"login":"jespersm","id":664940,"node_id":"MDQ6VXNlcjY2NDk0MA==","avatar_url":"https://avatars.githubusercontent.com/u/664940?v=4","gravatar_id":"","url":"https://api.github.com/users/jespersm","html_url":"https://github.com/jespersm","followers_url":"https://api.github.com/users/jespersm/followers","following_url":"https://api.github.com/users/jespersm/following{/other_user}","gists_url":"https://api.github.com/users/jespersm/gists{/gist_id}","starred_url":"https://api.github.com/users/jespersm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jespersm/subscriptions","organizations_url":"https://api.github.com/users/jespersm/orgs","repos_url":"https://api.github.com/users/jespersm/repos","events_url":"https://api.github.com/users/jespersm/events{/privacy}","received_events_url":"https://api.github.com/users/jespersm/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-02-27T23:50:21Z","updated_at":"2021-02-27T23:50:21Z","body":"> I'm suggesting \"lying\"\r\n\r\nNoted.\r\n\r\nThere's also the question of \"bad\" values, such as newlines, in a header value.\r\n\r\nToday, the Rocket accepts them but \"silently\" crashes when pivoting the response. We have the option of either silently sanitizing the value, or dropping it altogether on insertion, if it contains illegal ASCII values. This should probably be logged in either case, so the unsuspecting developer can realize their mistake.\r\n\r\nBy the way, I've posted a **draft** PR for `http` with the borrowing version of `HeaderValue`, so the maintainers can decide if that's a road they want consider: https://github.com/hyperium/http/pull/467","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/787205616/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jespersm","id":664940,"node_id":"MDQ6VXNlcjY2NDk0MA==","avatar_url":"https://avatars.githubusercontent.com/u/664940?v=4","gravatar_id":"","url":"https://api.github.com/users/jespersm","html_url":"https://github.com/jespersm","followers_url":"https://api.github.com/users/jespersm/followers","following_url":"https://api.github.com/users/jespersm/following{/other_user}","gists_url":"https://api.github.com/users/jespersm/gists{/gist_id}","starred_url":"https://api.github.com/users/jespersm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jespersm/subscriptions","organizations_url":"https://api.github.com/users/jespersm/orgs","repos_url":"https://api.github.com/users/jespersm/repos","events_url":"https://api.github.com/users/jespersm/events{/privacy}","received_events_url":"https://api.github.com/users/jespersm/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/790544792","html_url":"https://github.com/rwf2/Rocket/issues/1498#issuecomment-790544792","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1498","id":790544792,"node_id":"MDEyOklzc3VlQ29tbWVudDc5MDU0NDc5Mg==","user":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-03-04T11:26:48Z","updated_at":"2021-03-04T11:26:48Z","body":"> > Exactly. I have a PoC of this in my branch already (for `HeaderName`):\r\n> \r\n> Very cool!\r\n\r\nJust a note: if/when https://github.com/rust-lang/rust/issues/51999 lands, we can make `Header::new()` exhibit the same behavior!","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/790544792/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":4827798661,"node_id":"MDExOkNsb3NlZEV2ZW50NDgyNzc5ODY2MQ==","url":"https://api.github.com/repos/rwf2/Rocket/issues/events/4827798661","actor":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"009be32a8cfd572f36de3df09cc4327da0b113cc","commit_url":"https://api.github.com/repos/rwf2/Rocket/commits/009be32a8cfd572f36de3df09cc4327da0b113cc","created_at":"2021-06-01T20:58:39Z","state_reason":null,"performed_via_github_app":null},{"id":11603836233,"node_id":"REFE_lADOAzqMt84uQmxJzwAAAAKzpH1J","url":"https://api.github.com/repos/rwf2/Rocket/issues/events/11603836233","actor":{"login":"pull[bot]","id":39814207,"node_id":"MDM6Qm90Mzk4MTQyMDc=","avatar_url":"https://avatars.githubusercontent.com/in/12910?v=4","gravatar_id":"","url":"https://api.github.com/users/pull%5Bbot%5D","html_url":"https://github.com/apps/pull","followers_url":"https://api.github.com/users/pull%5Bbot%5D/followers","following_url":"https://api.github.com/users/pull%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/pull%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/pull%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pull%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/pull%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/pull%5Bbot%5D/repos","events_url":"https://api.github.com/users/pull%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/pull%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"009be32a8cfd572f36de3df09cc4327da0b113cc","commit_url":"https://api.github.com/repos/Necmttn/Rocket/commits/009be32a8cfd572f36de3df09cc4327da0b113cc","created_at":"2024-01-26T01:03:04Z","performed_via_github_app":null}]