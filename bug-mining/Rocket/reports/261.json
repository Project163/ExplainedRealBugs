{"url":"https://api.github.com/repos/rwf2/Rocket/issues/2730","repository_url":"https://api.github.com/repos/rwf2/Rocket","labels_url":"https://api.github.com/repos/rwf2/Rocket/issues/2730/labels{/name}","comments_url":"https://api.github.com/repos/rwf2/Rocket/issues/2730/comments","events_url":"https://api.github.com/repos/rwf2/Rocket/issues/2730/events","html_url":"https://github.com/rwf2/Rocket/issues/2730","id":2142164461,"node_id":"I_kwDOAzqMt85_rtXt","number":2730,"title":"DefaultListener::bindable() isn’t usable","user":{"login":"palant","id":374261,"node_id":"MDQ6VXNlcjM3NDI2MQ==","avatar_url":"https://avatars.githubusercontent.com/u/374261?v=4","gravatar_id":"","url":"https://api.github.com/users/palant","html_url":"https://github.com/palant","followers_url":"https://api.github.com/users/palant/followers","following_url":"https://api.github.com/users/palant/following{/other_user}","gists_url":"https://api.github.com/users/palant/gists{/gist_id}","starred_url":"https://api.github.com/users/palant/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/palant/subscriptions","organizations_url":"https://api.github.com/users/palant/orgs","repos_url":"https://api.github.com/users/palant/repos","events_url":"https://api.github.com/users/palant/events{/privacy}","received_events_url":"https://api.github.com/users/palant/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":758541123,"node_id":"MDU6TGFiZWw3NTg1NDExMjM=","url":"https://api.github.com/repos/rwf2/Rocket/labels/deficiency","name":"deficiency","color":"D93F0B","default":false,"description":"Something doesn't work as well as it could"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2024-02-19T11:36:07Z","updated_at":"2024-04-17T06:50:45Z","closed_at":"2024-04-17T06:50:45Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Rocket Version\n\n0.6.0 rev f75fb63\n\n### Operating System\n\nFedora Linux 39\n\n### Rust Toolchain Version\n\nrustc 1.78.0-nightly (2bf78d12d 2024-02-18) and rustc 1.76.0 (07dca489a 2024-02-04)\n\n### What happened?\n\nA low-level connection interface has been added in #1070 which I’m trying to use to implement more advanced TLS support. I’ve hit a roadblock however, as Rust won’t let me use the `Bindable` returned by `DefaultListener::bindable()`. I’ve been unable to find a work-around other than making `DefaultListener::base_bindable()` public or making `DefaultListener::bindable()` return `Either<TlsBindable<std::net::SocketAddr>, TlsBindable<super::unix::UdsConfig>>` explicitly instead of `impl Binding`. It is my understanding that the latter shouldn’t have any impact, but for some reason it does.\r\n\r\nNote that having `DefaultListener::base_bindable()` public would be helpful regardless. Currently I have to remove TLS configuration from `DefaultListener` to make sure it won’t give me a TLS bindable.\n\n### Test Case\n\n```rust\n#[rocket::main]\r\nasync fn main() -> Result<(), rocket::Error> {\r\n    let rocket = rocket::build();\r\n    let config = rocket\r\n        .figment()\r\n        .extract::<rocket::listener::DefaultListener>()?;\r\n    rocket.launch_on(config.bindable()?).await?;\r\n    Ok(())\r\n}\n```\n\n\n### Log Output\n\n```shell\nerror[E0277]: `impl std::future::Future<Output = Result<<impl Bindable as Bindable>::Listener, <impl Bindable as Bindable>::Error>>` cannot be sent between threads safely\r\n   --> src/main.rs:2:46\r\n    |\r\n2   |   async fn main() -> Result<(), rocket::Error> {\r\n    |  ______________________________________________^\r\n3   | |     let rocket = rocket::build();\r\n4   | |     let config = rocket.figment().extract::<rocket::listener::DefaultListener>()?;\r\n5   | |     rocket.launch_on(config.bindable()?)\r\n6   | |         .await?;\r\n7   | |     Ok(())\r\n8   | | }\r\n    | | ^\r\n    | | |\r\n    | |_`impl std::future::Future<Output = Result<<impl Bindable as Bindable>::Listener, <impl Bindable as Bindable>::Error>>` cannot be sent between threads safely\r\n    |   within this `{async block@src/main.rs:2:46: 8:2}`\r\n    |\r\n    = help: within `{async block@src/main.rs:2:46: 8:2}`, the trait `std::marker::Send` is not implemented for `impl std::future::Future<Output = Result<<impl Bindable as Bindable>::Listener, <impl Bindable as Bindable>::Error>>`, which is required by `{async block@src/main.rs:2:46: 8:2}: std::marker::Send`\r\nnote: `<impl Bindable as Bindable>::bind` is an `async fn` in trait, which does not automatically imply that its future is `std::marker::Send`\r\n   --> Rocket/core/lib/src/listener/bindable.rs:10:5\r\n    |\r\n10  |     async fn bind(self) -> Result<Self::Listener, Self::Error>;\r\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    = note: required because it captures the following types: `Rocket<Ignite>`, `impl std::future::Future<Output = Result<<impl Bindable as Bindable>::Listener, <impl Bindable as Bindable>::Error>>`, `impl std::future::Future<Output = Result<Rocket<Ignite>, rocket::Error>>`\r\nnote: required because it's used within this `async` fn body\r\n   --> Rocket/core/lib/src/rocket.rs:690:90\r\n    |\r\n690 |       async fn _launch_on<B: Bindable>(self, bindable: B) -> Result<Rocket<Ignite>, Error> {\r\n    |  __________________________________________________________________________________________^\r\n691 | |         let listener = bindable.bind().await.map_err(|e| ErrorKind::Bind(Box::new(e)))?;\r\n692 | |         self.serve(listener).await\r\n693 | |     }\r\n    | |_____^\r\n    = note: required because it captures the following types: `Rocket<Build>`, `impl Bindable`, `rocket::phase::State`, `ControlFlow<Result<Infallible, rocket::Error>, Rocket<Ignite>>`, `impl std::future::Future<Output = Result<Rocket<Ignite>, rocket::Error>>`, `impl std::future::Future<Output = Result<Rocket<Ignite>, rocket::Error>>`, `impl std::future::Future<Output = Result<Rocket<Ignite>, rocket::Error>>`\r\nnote: required because it's used within this `async` fn body\r\n   --> Rocket/core/lib/src/rocket.rs:944:93\r\n    |\r\n944 |       pub async fn launch_on<B: Bindable>(self, bindable: B) -> Result<Rocket<Ignite>, Error> {\r\n    |  _____________________________________________________________________________________________^\r\n945 | |         match self.0.into_state() {\r\n946 | |             State::Build(s) => Rocket::from(s).ignite().await?._launch_on(bindable).await,\r\n947 | |             State::Ignite(s) => Rocket::from(s)._launch_on(bindable).await,\r\n948 | |             State::Orbit(s) => Ok(Rocket::from(s).into_ignite())\r\n949 | |         }\r\n950 | |     }\r\n    | |_____^\r\n    = note: required because it captures the following types: `Rocket<Build>`, `DefaultListener`, `ControlFlow<Result<Infallible, rocket::Error>, impl Bindable>`, `impl std::future::Future<Output = Result<Rocket<Ignite>, rocket::Error>>`\r\nnote: required because it's used within this `async` block\r\n   --> src/main.rs:2:46\r\n    |\r\n2   |   async fn main() -> Result<(), rocket::Error> {\r\n    |  ______________________________________________^\r\n3   | |     let rocket = rocket::build();\r\n4   | |     let config = rocket.figment().extract::<rocket::listener::DefaultListener>()?;\r\n5   | |     rocket.launch_on(config.bindable()?)\r\n6   | |         .await?;\r\n7   | |     Ok(())\r\n8   | | }\r\n    | |_^\r\nnote: required by a bound in `async_main`\r\n   --> Rocket/core/lib/src/lib.rs:252:66\r\n    |\r\n252 | pub fn async_main<R>(fut: impl std::future::Future<Output = R> + Send) -> R {\r\n    |                                                                  ^^^^ required by this bound in `async_main`\r\n\r\nerror[E0277]: `impl std::future::Future<Output = Result<<<impl Bindable as Bindable>::Listener as Listener>::Accept, std::io::Error>>` cannot be sent between threads safely\r\n   --> src/main.rs:2:46\r\n    |\r\n2   |   async fn main() -> Result<(), rocket::Error> {\r\n    |  ______________________________________________^\r\n3   | |     let rocket = rocket::build();\r\n4   | |     let config = rocket.figment().extract::<rocket::listener::DefaultListener>()?;\r\n5   | |     rocket.launch_on(config.bindable()?)\r\n6   | |         .await?;\r\n7   | |     Ok(())\r\n8   | | }\r\n    | | ^\r\n    | | |\r\n    | |_`impl std::future::Future<Output = Result<<<impl Bindable as Bindable>::Listener as Listener>::Accept, std::io::Error>>` cannot be sent between threads safely\r\n    |   within this `{async block@src/main.rs:2:46: 8:2}`\r\n    |\r\n    = help: within `{async block@src/main.rs:2:46: 8:2}`, the trait `std::marker::Send` is not implemented for `impl std::future::Future<Output = Result<<<impl Bindable as Bindable>::Listener as Listener>::Accept, std::io::Error>>`, which is required by `{async block@src/main.rs:2:46: 8:2}: std::marker::Send`\r\nnote: `<<impl Bindable as Bindable>::Listener as Listener>::accept` is an `async fn` in trait, which does not automatically imply that its future is `std::marker::Send`\r\n   --> Rocket/core/lib/src/listener/listener.rs:13:5\r\n    |\r\n13  |     async fn accept(&self) -> io::Result<Self::Accept>;\r\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n    = note: required because it captures the following types: `&listener::bounced::Bounced<<impl Bindable as Bindable>::Listener>`, `Result<<<impl Bindable as Bindable>::Listener as Listener>::Accept, std::io::Error>`, `impl std::future::Future<Output = Result<<<impl Bindable as Bindable>::Listener as Listener>::Accept, std::io::Error>>`, `std::io::Error`, `Sleep`\r\nnote: required because it's used within this `async` fn body\r\n   --> Rocket/core/lib/src/listener/bounced.rs:28:67\r\n    |\r\n28  |       pub async fn accept_next(&self) -> <Self as Listener>::Accept {\r\n    |  ___________________________________________________________________^\r\n29  | |         loop {\r\n30  | |             match self.listener.accept().await {\r\n31  | |                 Ok(accept) => return accept,\r\n...   |\r\n38  | |         }\r\n39  | |     }\r\n    | |_____^\r\n    = note: required because it captures the following types: `impl std::future::Future<Output = <listener::bounced::Bounced<<impl Bindable as Bindable>::Listener> as Listener>::Accept>`, `rocket::futures::future::Select<Pin<&mut impl std::future::Future<Output = <listener::bounced::Bounced<<impl Bindable as Bindable>::Listener> as Listener>::Accept>>, rocket::Shutdown>`\r\nnote: required because it's used within this `async` fn body\r\n   --> Rocket/core/lib/src/listener/cancellable.rs:111:75\r\n    |\r\n111 |       pub async fn accept_next(&self) -> Option<<Self as Listener>::Accept> {\r\n    |  ___________________________________________________________________________^\r\n112 | |         let next = std::pin::pin!(self.listener.accept_next());\r\n113 | |         match select(next, self.trigger.clone()).await {\r\n114 | |             Either::Left((next, _)) => Some(next),\r\n115 | |             Either::Right(_) => None,\r\n116 | |         }\r\n117 | |     }\r\n    | |_____^\r\n    = note: required because it captures the following types: `Rocket<Ignite>`, `hyper_util::server::conn::auto::Builder<hyper_util::rt::tokio::TokioExecutor>`, `std::time::Duration`, `listener::cancellable::CancellableListener<rocket::Shutdown, listener::bounced::Bounced<<impl Bindable as Bindable>::Listener>>`, `Arc<Rocket<Orbit>>`, `rocket::tokio::task::JoinHandle<()>`, `Arc<hyper_util::server::conn::auto::Builder<hyper_util::rt::tokio::TokioExecutor>>`, `Arc<listener::cancellable::CancellableListener<rocket::Shutdown, listener::bounced::Bounced<<impl Bindable as Bindable>::Listener>>>`, `impl std::future::Future<Output = std::option::Option<<listener::cancellable::CancellableListener<rocket::Shutdown, listener::bounced::Bounced<<impl Bindable as Bindable>::Listener>> as Listener>::Accept>>`, `std::array::IntoIter<std::time::Duration, 5>`, `Sleep`\r\nnote: required because it's used within this `async` fn body\r\n   --> Rocket/core/lib/src/server.rs:89:5\r\n    |\r\n89  | /     {\r\n90  | |         let mut builder = Builder::new(TokioExecutor::new());\r\n91  | |         let keep_alive = Duration::from_secs(self.config.keep_alive.into());\r\n92  | |         builder.http1()\r\n...   |\r\n178 | |         }\r\n179 | |     }\r\n    | |_____^\r\n    = note: required because it captures the following types: `Rocket<Ignite>`, `impl std::future::Future<Output = Result<<impl Bindable as Bindable>::Listener, <impl Bindable as Bindable>::Error>>`, `impl std::future::Future<Output = Result<Rocket<Ignite>, rocket::Error>>`\r\nnote: required because it's used within this `async` fn body\r\n   --> Rocket/core/lib/src/rocket.rs:690:90\r\n    |\r\n690 |       async fn _launch_on<B: Bindable>(self, bindable: B) -> Result<Rocket<Ignite>, Error> {\r\n    |  __________________________________________________________________________________________^\r\n691 | |         let listener = bindable.bind().await.map_err(|e| ErrorKind::Bind(Box::new(e)))?;\r\n692 | |         self.serve(listener).await\r\n693 | |     }\r\n    | |_____^\r\n    = note: required because it captures the following types: `Rocket<Build>`, `impl Bindable`, `rocket::phase::State`, `ControlFlow<Result<Infallible, rocket::Error>, Rocket<Ignite>>`, `impl std::future::Future<Output = Result<Rocket<Ignite>, rocket::Error>>`, `impl std::future::Future<Output = Result<Rocket<Ignite>, rocket::Error>>`, `impl std::future::Future<Output = Result<Rocket<Ignite>, rocket::Error>>`\r\nnote: required because it's used within this `async` fn body\r\n   --> Rocket/core/lib/src/rocket.rs:944:93\r\n    |\r\n944 |       pub async fn launch_on<B: Bindable>(self, bindable: B) -> Result<Rocket<Ignite>, Error> {\r\n    |  _____________________________________________________________________________________________^\r\n945 | |         match self.0.into_state() {\r\n946 | |             State::Build(s) => Rocket::from(s).ignite().await?._launch_on(bindable).await,\r\n947 | |             State::Ignite(s) => Rocket::from(s)._launch_on(bindable).await,\r\n948 | |             State::Orbit(s) => Ok(Rocket::from(s).into_ignite())\r\n949 | |         }\r\n950 | |     }\r\n    | |_____^\r\n    = note: required because it captures the following types: `Rocket<Build>`, `DefaultListener`, `ControlFlow<Result<Infallible, rocket::Error>, impl Bindable>`, `impl std::future::Future<Output = Result<Rocket<Ignite>, rocket::Error>>`\r\nnote: required because it's used within this `async` block\r\n   --> src/main.rs:2:46\r\n    |\r\n2   |   async fn main() -> Result<(), rocket::Error> {\r\n    |  ______________________________________________^\r\n3   | |     let rocket = rocket::build();\r\n4   | |     let config = rocket.figment().extract::<rocket::listener::DefaultListener>()?;\r\n5   | |     rocket.launch_on(config.bindable()?)\r\n6   | |         .await?;\r\n7   | |     Ok(())\r\n8   | | }\r\n    | |_^\r\nnote: required by a bound in `async_main`\r\n   --> Rocket/core/lib/src/lib.rs:252:66\r\n    |\r\n252 | pub fn async_main<R>(fut: impl std::future::Future<Output = R> + Send) -> R {\r\n    |                                                                  ^^^^ required by this bound in `async_main`\r\n\r\nFor more information about this error, try `rustc --explain E0277`.\n```\n\n\n### Additional Context\n\n_No response_\n\n### System Checks\n\n- [X] My bug report relates to functionality.\n- [X] I have tested against the latest Rocket release or a recent git commit.\n- [X] I have tested against the latest stable `rustc` toolchain.\n- [X] I was unable to find this issue previously reported.","closed_by":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/2730/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rwf2/Rocket/issues/2730/timeline","performed_via_github_app":null,"state_reason":"completed"}