{"url":"https://api.github.com/repos/rwf2/Rocket/issues/1262","repository_url":"https://api.github.com/repos/rwf2/Rocket","labels_url":"https://api.github.com/repos/rwf2/Rocket/issues/1262/labels{/name}","comments_url":"https://api.github.com/repos/rwf2/Rocket/issues/1262/comments","events_url":"https://api.github.com/repos/rwf2/Rocket/issues/1262/events","html_url":"https://github.com/rwf2/Rocket/issues/1262","id":589624245,"node_id":"MDU6SXNzdWU1ODk2MjQyNDU=","number":1262,"title":"`Route.set_uri` does not play well with segment offset calculation","user":{"login":"jebrosen","id":7102588,"node_id":"MDQ6VXNlcjcxMDI1ODg=","avatar_url":"https://avatars.githubusercontent.com/u/7102588?v=4","gravatar_id":"","url":"https://api.github.com/users/jebrosen","html_url":"https://github.com/jebrosen","followers_url":"https://api.github.com/users/jebrosen/followers","following_url":"https://api.github.com/users/jebrosen/following{/other_user}","gists_url":"https://api.github.com/users/jebrosen/gists{/gist_id}","starred_url":"https://api.github.com/users/jebrosen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jebrosen/subscriptions","organizations_url":"https://api.github.com/users/jebrosen/orgs","repos_url":"https://api.github.com/users/jebrosen/repos","events_url":"https://api.github.com/users/jebrosen/events{/privacy}","received_events_url":"https://api.github.com/users/jebrosen/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":343542064,"node_id":"MDU6TGFiZWwzNDM1NDIwNjQ=","url":"https://api.github.com/repos/rwf2/Rocket/labels/bug","name":"bug","color":"B60205","default":true,"description":"Deviation from the specification or expected behavior"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-03-28T17:44:08Z","updated_at":"2020-07-29T23:45:09Z","closed_at":"2020-07-29T23:45:09Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Consider this example code (adapted from an issue reported on IRC):\r\n\r\n<details>\r\n\r\n```rust\r\n#![feature(proc_macro_hygiene, decl_macro)]\r\n\r\n#[macro_use] extern crate rocket;\r\n\r\nuse rocket::http::uri;\r\n\r\npub fn prepend(prefix: &str, route: &rocket::Route) -> rocket::Route {\r\n    let prefix = uri::Origin::parse(prefix).unwrap();\r\n    let new_base = uri::Origin::parse_owned(format!(\"{}{}\", prefix, route.base)).unwrap();\r\n\r\n    let uri_part = &route.uri.to_string()[route.base.path().len() - 1..];\r\n\r\n    let mut new_route = route.clone();\r\n    if let Err(error) = new_route.set_uri(new_base, uri::Origin::parse_route(uri_part).unwrap()) {\r\n        panic!(error);\r\n    }\r\n    new_route\r\n}\r\n\r\npub fn extend_routes(prefix: &str, routes: Vec<rocket::Route>) -> Vec<rocket::Route> {\r\n    routes\r\n        .iter()\r\n        .map(|route| dbg!(prepend(prefix, route)))\r\n        .collect()\r\n}\r\n\r\nmod a {\r\n    #[get(\"/b/<id>\")]\r\n    fn b(id: u8) -> String {\r\n        format!(\"{}\", id)\r\n    }\r\n\r\n    pub fn routes() -> Vec<rocket::Route> {\r\n        super::extend_routes(\"/a\", routes![b])\r\n    }\r\n}\r\n\r\n#[get(\"/\")]\r\nfn hello() -> &'static str {\r\n    \"Hello, world!\"\r\n}\r\n\r\nfn main() {\r\n    rocket::ignite().mount(\"/\", routes![hello]).mount(\"/\", a::routes()).launch();\r\n}\r\n```\r\n\r\n</details>\r\n\r\nTrying to access `/a/b/3` fails, because the `id` parameter tries to decode `b` as a `u8`. I am not quite sure where exactly the blame lies here, but it has to do with the behavior of `set_uri` and of `Request::routed_path_segment`.\r\n\r\n* `Request::routed_path_segment` is used to calculate which part of a URI corresponds to the \"nth\" segment. This is done by calculating how many segments are in the \"base\" URI, then skipping over that many segments in the full URI.\r\n* When calling `set_uri` manually it is difficult to correctly preserve the relationship between \"base\" and \"original\" URIs such that it does not break `routed_path_segment`. The code above does that (I think), but in a hacky way.\r\n* `mount` calls `set_uri` in such a way that it does *not* preserve the relationship between base and original URIs. Consider the route with `base`=\"/a\" and `uri`=\"/a/b/<id>\" (`uri` always includes `base`). `mount`ing this route at \"/\" will adjust the route to have `base`=\"/\" and `uri`=\"/a/b/\\<id\\>\", which has changed the base-to-uri offset and adversely affected `routed_path_segment`.\r\n\r\nI am not sure what the best way to solve this is, but I definitely think the `set_uri` API and/or documentation should be improved to avoid falling into this trap.","closed_by":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/1262/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rwf2/Rocket/issues/1262/timeline","performed_via_github_app":null,"state_reason":"completed"}