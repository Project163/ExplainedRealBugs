{"url":"https://api.github.com/repos/rwf2/Rocket/issues/1881","repository_url":"https://api.github.com/repos/rwf2/Rocket","labels_url":"https://api.github.com/repos/rwf2/Rocket/issues/1881/labels{/name}","comments_url":"https://api.github.com/repos/rwf2/Rocket/issues/1881/comments","events_url":"https://api.github.com/repos/rwf2/Rocket/issues/1881/events","html_url":"https://github.com/rwf2/Rocket/issues/1881","id":986700986,"node_id":"MDU6SXNzdWU5ODY3MDA5ODY=","number":1881,"title":"Allow pre-building a Rocket instance (without runtime) then launch it with Rocket's runtime","user":{"login":"blackghost1987","id":2356991,"node_id":"MDQ6VXNlcjIzNTY5OTE=","avatar_url":"https://avatars.githubusercontent.com/u/2356991?v=4","gravatar_id":"","url":"https://api.github.com/users/blackghost1987","html_url":"https://github.com/blackghost1987","followers_url":"https://api.github.com/users/blackghost1987/followers","following_url":"https://api.github.com/users/blackghost1987/following{/other_user}","gists_url":"https://api.github.com/users/blackghost1987/gists{/gist_id}","starred_url":"https://api.github.com/users/blackghost1987/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/blackghost1987/subscriptions","organizations_url":"https://api.github.com/users/blackghost1987/orgs","repos_url":"https://api.github.com/users/blackghost1987/repos","events_url":"https://api.github.com/users/blackghost1987/events{/privacy}","received_events_url":"https://api.github.com/users/blackghost1987/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":442152232,"node_id":"MDU6TGFiZWw0NDIxNTIyMzI=","url":"https://api.github.com/repos/rwf2/Rocket/labels/request","name":"request","color":"5319E7","default":false,"description":"Request for new functionality"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rwf2/Rocket/milestones/8","html_url":"https://github.com/rwf2/Rocket/milestone/8","labels_url":"https://api.github.com/repos/rwf2/Rocket/milestones/8/labels","id":2300325,"node_id":"MDk6TWlsZXN0b25lMjMwMDMyNQ==","number":8,"title":"0.5.0","description":null,"creator":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":43,"state":"open","created_at":"2017-02-05T07:58:22Z","updated_at":"2023-04-05T18:18:52Z","due_on":null,"closed_at":null},"comments":8,"created_at":"2021-09-02T13:06:43Z","updated_at":"2022-05-07T20:56:03Z","closed_at":"2022-05-07T20:56:02Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Is your feature request motivated by a concrete problem? Please describe.**\r\n\r\nI would require a way to build Rocket outside of `#[rocket::main]` before even having a runtime, but still start it with Rocket's own runtime when the building is finished.\r\n\r\nAs Rocket matures it seems like there's a frequent need to include Rocket in a bigger application as a module, or maybe have more control over the startup and shutdown of the application. In my opinion the issue is there's only two ways to start Rocket with it's own \"official\" runtime, and they are both designed to be used on the application's `main()`. These are really useful for simple applications where Rocket is a first class citizen and it governs application startup, but they lack the flexibility needed by more complex programs, where Rocket is just a module (especially if the runtime should be started from another thread!). It would be really useful to do some computation on application startup, check some data, and only launch Rocket and it's runtime (on a separate thread) when needed.\r\n\r\nCurrently Rocket CAN be started programmatically e.g. by putting `#[launch]` in a sub-module, then calling the blocking `main()` function of the sub-module (generated by the codegen). This function can be launched in a separate thread.\r\nThe biggest issue is these macros can only be used on functions without any inputs or outputs. This makes it impossible to use any data from outside of the function which has been annotated with the macro.\r\n\r\nHaving access to the \"outside world\" would be really useful during the building or ignition of Rocket. The current setup makes the following cases impossible:\r\n- Adding any data to Rocket managed state which was created before runtime creation\r\n- Using the Shutdown functionality from a spawning thread (see [here](https://github.com/SergioBenitez/Rocket/discussions/1880))\r\n\r\nOf course it is possible to create a custom Tokio runtime and call build(), ignite() and launch() respectively, but this has some limitations:\r\n- it's up to the user to provide an appropriate runtime, which could be complicated for newbies and easy to mess up. This is especially cumbersome if other parts of the application doesn't even need any async functionalities.\r\n- even if the user provides a proper runtime, the Shutdown functionality depends on Rocket using it's own runtime, and using a custom runtime will mess things up with cooperative shutdown.\r\n\r\n**Why this feature can't or shouldn't live outside of Rocket**\r\nThe launch mechanism and the runtime creation is a core part of Rocket. The `async_main` function contains the runtime creation, and there's no other way to create it. That function is only public though because of a Rust limitation and should not be called directly (see #1772 ), so there's not way to re-create Rocket's runtime from the outside.\r\n\r\n**Ideal Solution**\r\nMy idea is to move the building of Rocket (or at least parts of it) outside of the async main. The current functions in `Rocket<Build>` (build, mount, attach, etc.) are not async at all, they can be called before the runtime is even created. There could be a new function to accept a \"pre-built\" Rocket (with all the outside world stuff already in it), then Rocket would create it's own Tokio runtime and ignite & launch it.\r\nThis could also be a macro, similar to `#[launch]`. The macro would be working on functions like `fn(Rocket<Build>) -> Rocket<Build>`. This way the user function could get a \"semi-built\" Rocket and complete it before passing it to Rocket to launch it. (This sounds a bit like Payload Integration to me, if we are talking rocketry analogies ðŸ˜ƒ )\r\n\r\n**Alternatives Considered**\r\nAn alternative would be to expose the runtime by adding a \"getter\". This way the users could get Rocket's runtime and call block_on(launch()) themselves. This seams less ergonomical though, and AFAIK Rocket is trying to hide the underlying runtime from it's public interface, so probably not a good idea for the future.\r\n\r\nNote: These changes would still make it impossible to do anything with the _ignited_ Rocket instance from the outside, so Shutdown from the spawning thread would still be impossible (because it requires ignition, which requires a runtime), but I hope this will be easy to solve later.\r\n","closed_by":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/1881/reactions","total_count":6,"+1":6,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rwf2/Rocket/issues/1881/timeline","performed_via_github_app":null,"state_reason":"completed"}