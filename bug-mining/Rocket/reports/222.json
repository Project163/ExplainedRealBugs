{"url":"https://api.github.com/repos/rwf2/Rocket/issues/2375","repository_url":"https://api.github.com/repos/rwf2/Rocket","labels_url":"https://api.github.com/repos/rwf2/Rocket/issues/2375/labels{/name}","comments_url":"https://api.github.com/repos/rwf2/Rocket/issues/2375/comments","events_url":"https://api.github.com/repos/rwf2/Rocket/issues/2375/events","html_url":"https://github.com/rwf2/Rocket/issues/2375","id":1426066687,"node_id":"I_kwDOAzqMt85VAAz_","number":2375,"title":"Shutdown using sync_db_pools panics on master","user":{"login":"liquidnya","id":7364785,"node_id":"MDQ6VXNlcjczNjQ3ODU=","avatar_url":"https://avatars.githubusercontent.com/u/7364785?v=4","gravatar_id":"","url":"https://api.github.com/users/liquidnya","html_url":"https://github.com/liquidnya","followers_url":"https://api.github.com/users/liquidnya/followers","following_url":"https://api.github.com/users/liquidnya/following{/other_user}","gists_url":"https://api.github.com/users/liquidnya/gists{/gist_id}","starred_url":"https://api.github.com/users/liquidnya/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/liquidnya/subscriptions","organizations_url":"https://api.github.com/users/liquidnya/orgs","repos_url":"https://api.github.com/users/liquidnya/repos","events_url":"https://api.github.com/users/liquidnya/events{/privacy}","received_events_url":"https://api.github.com/users/liquidnya/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":615883980,"node_id":"MDU6TGFiZWw2MTU4ODM5ODA=","url":"https://api.github.com/repos/rwf2/Rocket/labels/triage","name":"triage","color":"FBCA04","default":false,"description":"A bug report being investigated"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-10-27T18:01:09Z","updated_at":"2023-03-24T00:52:28Z","closed_at":"2023-03-24T00:52:28Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Description**\r\n\r\nWhen using `sync_db_pools` on master, closing the application causes a panic:\r\n\r\n```\r\nRocket has launched from http://127.0.0.1:8000\r\n^CWarning: Received SIGINT. Requesting shutdown.\r\nShutdown requested. Waiting for pending I/O...\r\nGraceful shutdown completed successfully.\r\nthread 'main' panicked at 'there is no reactor running, must be called from the context of a Tokio 1.x runtime', /home/nya/.cargo/git/checkouts/rocket-8bf16d9ca7e90bdc/6c3d35e/contrib/sync_db_pools/lib/src/connection.rs:198:9\r\nstack backtrace:\r\n   0: rust_begin_unwind\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/std/src/panicking.rs:584:5\r\n   1: core::panicking::panic_fmt\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/panicking.rs:142:14\r\n   2: core::panicking::panic_display\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/panicking.rs:72:5\r\n   3: tokio::runtime::context::current\r\n             at /home/nya/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.21.2/src/runtime/context.rs:22:19\r\n   4: tokio::runtime::blocking::pool::spawn_blocking\r\n             at /home/nya/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.21.2/src/runtime/blocking/pool.rs:134:14\r\n   5: tokio::task::blocking::spawn_blocking\r\n             at /home/nya/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.21.2/src/task/blocking.rs:208:9\r\n   6: <rocket_sync_db_pools::connection::ConnectionPool<K,C> as core::ops::drop::Drop>::drop\r\n             at /home/nya/.cargo/git/checkouts/rocket-8bf16d9ca7e90bdc/6c3d35e/contrib/sync_db_pools/lib/src/connection.rs:198:9\r\n   7: core::ptr::drop_in_place<rocket_sync_db_pools::connection::ConnectionPool<connection_pool_drop_example::Pool,diesel::sqlite::connection::SqliteConnection>>\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ptr/mod.rs:487:1\r\n   8: core::ptr::drop_in_place<alloc::boxed::Box<dyn core::any::Any>>\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ptr/mod.rs:487:1\r\n   9: core::mem::drop\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/mem/mod.rs:988:24\r\n  10: <state::container::AnyObject as core::ops::drop::Drop>::drop\r\n             at /home/nya/.cargo/registry/src/github.com-1ecc6299db9ec823/state-0.5.3/src/container.rs:223:13\r\n  11: core::ptr::drop_in_place<state::container::AnyObject>\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ptr/mod.rs:487:1\r\n  12: core::ptr::drop_in_place<(core::any::TypeId,state::container::AnyObject)>\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ptr/mod.rs:487:1\r\n  13: core::ptr::mut_ptr::<impl *mut T>::drop_in_place\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ptr/mut_ptr.rs:1409:18\r\n  14: hashbrown::raw::Bucket<T>::drop\r\n             at /cargo/registry/src/github.com-1ecc6299db9ec823/hashbrown-0.12.3/src/raw/mod.rs:335:9\r\n  15: hashbrown::raw::RawTable<T,A>::drop_elements\r\n             at /cargo/registry/src/github.com-1ecc6299db9ec823/hashbrown-0.12.3/src/raw/mod.rs:598:17\r\n  16: <hashbrown::raw::RawTable<T,A> as core::ops::drop::Drop>::drop\r\n             at /cargo/registry/src/github.com-1ecc6299db9ec823/hashbrown-0.12.3/src/raw/mod.rs:1806:17\r\n  17: core::ptr::drop_in_place<hashbrown::raw::RawTable<(core::any::TypeId,state::container::AnyObject)>>\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ptr/mod.rs:487:1\r\n  18: core::ptr::drop_in_place<hashbrown::map::HashMap<core::any::TypeId,state::container::AnyObject,core::hash::BuildHasherDefault<state::ident_hash::IdentHash>>>\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ptr/mod.rs:487:1\r\n  19: core::ptr::drop_in_place<std::collections::hash::map::HashMap<core::any::TypeId,state::container::AnyObject,core::hash::BuildHasherDefault<state::ident_hash::IdentHash>>>\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ptr/mod.rs:487:1\r\n  20: core::ptr::drop_in_place<core::option::Option<std::collections::hash::map::HashMap<core::any::TypeId,state::container::AnyObject,core::hash::BuildHasherDefault<state::ident_hash::IdentHash>>>>\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ptr/mod.rs:487:1\r\n  21: core::ptr::drop_in_place<core::cell::UnsafeCell<core::option::Option<std::collections::hash::map::HashMap<core::any::TypeId,state::container::AnyObject,core::hash::BuildHasherDefault<state::ident_hash::IdentHash>>>>>\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ptr/mod.rs:487:1\r\n  22: core::ptr::drop_in_place<state::shim::cell::UnsafeCell<core::option::Option<std::collections::hash::map::HashMap<core::any::TypeId,state::container::AnyObject,core::hash::BuildHasherDefault<state::ident_hash::IdentHash>>>>>\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ptr/mod.rs:487:1\r\n  23: core::ptr::drop_in_place<state::container::Container<state::container::kind::SendSync>>\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ptr/mod.rs:487:1\r\n  24: core::ptr::drop_in_place<rocket::phase::Igniting>\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ptr/mod.rs:487:1\r\n  25: core::ptr::drop_in_place<rocket::rocket::Rocket<rocket::phase::Ignite>>\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ptr/mod.rs:487:1\r\n  26: core::ptr::drop_in_place<core::result::Result<rocket::rocket::Rocket<rocket::phase::Ignite>,rocket::error::Error>>\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ptr/mod.rs:487:1\r\n  27: connection_pool_drop_example::main\r\n             at ./src/main.rs:11:1\r\n  28: core::ops::function::FnOnce::call_once\r\n             at /rustc/a55dd71d5fb0ec5a6a3a9e8c27b2127ba491ce52/library/core/src/ops/function.rs:248:5\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n```\r\n\r\n**To Reproduce**\r\n\r\n1. Add a database connection pool using `sync_db_pools` with the feature `\"diesel_sqlite_pool\"` using diesel and attach its fairing to the rocket:\r\n\r\n```rust\r\nuse rocket::launch;\r\nuse rocket_sync_db_pools::database;\r\n\r\n#[database(\"test\")]\r\nstruct Pool(diesel::SqliteConnection);\r\n\r\n#[launch]\r\nfn rocket() -> _ {\r\n    rocket::build()\r\n        .attach(Pool::fairing())\r\n}\r\n```\r\n\r\n2. Configure the database\r\n```toml\r\n[global.databases]\r\ntest = { url = \":memory:\" }\r\n```\r\n\r\n3. Run the application and exit the application with e.g. SIGINT\r\n\r\nI prepared a simple example here: <https://github.com/liquidnya/connection-pool-drop-example>.\r\n\r\n**Environment:**\r\n\r\n - OS Distribution and Kernel: Ubuntu 22.10, 5.10.102.1-microsoft-standard-WSL2\r\n - Rocket Version: master@6c3d35e7e5bceaf11c329623d48f81c276407030\r\n\r\n**Additional Context**\r\n\r\nThe panic happens because the `ConnectionPool` is dropped after the runtime is shutdown.\r\n`tokio::task::spawn_blocking` is used after the runtime has been shut down already.\r\nhttps://github.com/SergioBenitez/Rocket/blob/6c3d35e7e5bceaf11c329623d48f81c276407030/contrib/sync_db_pools/lib/src/connection.rs#L195-L200\r\nhttps://github.com/SergioBenitez/Rocket/blob/6c3d35e7e5bceaf11c329623d48f81c276407030/core/lib/src/lib.rs#L248-L250\r\n\r\n`ConnectionPool` is dropped after the shutdown, because the `Rocket<Orbit>` is returned by `::rocket::async_main` which happens after the shutdown and so the rockets `state` is only dropped later.\r\nhttps://github.com/SergioBenitez/Rocket/blob/6c3d35e7e5bceaf11c329623d48f81c276407030/core/codegen/src/attribute/entry/launch.rs#L45-L61\r\n","closed_by":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/2375/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rwf2/Rocket/issues/2375/timeline","performed_via_github_app":null,"state_reason":"completed"}