{"url":"https://api.github.com/repos/rwf2/Rocket/issues/505","repository_url":"https://api.github.com/repos/rwf2/Rocket","labels_url":"https://api.github.com/repos/rwf2/Rocket/issues/505/labels{/name}","comments_url":"https://api.github.com/repos/rwf2/Rocket/issues/505/comments","events_url":"https://api.github.com/repos/rwf2/Rocket/issues/505/events","html_url":"https://github.com/rwf2/Rocket/issues/505","id":282679365,"node_id":"MDU6SXNzdWUyODI2NzkzNjU=","number":505,"title":"`request.content_type()` not working in `FromData`","user":{"login":"LegNeato","id":368904,"node_id":"MDQ6VXNlcjM2ODkwNA==","avatar_url":"https://avatars.githubusercontent.com/u/368904?v=4","gravatar_id":"","url":"https://api.github.com/users/LegNeato","html_url":"https://github.com/LegNeato","followers_url":"https://api.github.com/users/LegNeato/followers","following_url":"https://api.github.com/users/LegNeato/following{/other_user}","gists_url":"https://api.github.com/users/LegNeato/gists{/gist_id}","starred_url":"https://api.github.com/users/LegNeato/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LegNeato/subscriptions","organizations_url":"https://api.github.com/users/LegNeato/orgs","repos_url":"https://api.github.com/users/LegNeato/repos","events_url":"https://api.github.com/users/LegNeato/events{/privacy}","received_events_url":"https://api.github.com/users/LegNeato/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":343542064,"node_id":"MDU6TGFiZWwzNDM1NDIwNjQ=","url":"https://api.github.com/repos/rwf2/Rocket/labels/bug","name":"bug","color":"B60205","default":true,"description":"Deviation from the specification or expected behavior"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2017-12-17T08:48:47Z","updated_at":"2018-01-06T03:36:12Z","closed_at":"2018-01-06T03:36:12Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"In `juniper` we are [implementing `FromData` for a custom type](https://github.com/graphql-rust/juniper/blob/b46951717d103ec544334a7af79f6d2259cc2b33/juniper_rocket/src/lib.rs#L150). We want to restrict requests to json without having users manually specify in the route. Sadly we never actually handle post requests because `request.content_type()` always returns `None` when running tests with a `LocalClient`, causing this code to always forward the request rather than handle it:\r\n\r\n```rust\r\nfn from_data(request: &Request, data: Data) -> FromDataOutcome<Self, Self::Error> {\r\n  if !request.content_type().map_or(false, |ct| ct.is_json()) {\r\n     // Not json. This ALWAYS happens, so we never handle the request.\r\n     return Forward(data);\r\n  } else {\r\n    // Handle the request. It is never called.\r\n  }\r\n}\r\n```\r\n\r\nChanging the check to the following works:\r\n\r\n```rust\r\nfn from_data(request: &Request, data: Data) -> FromDataOutcome<Self, Self::Error> {\r\n   let content_type: Option<ContentType> = request\r\n     .headers()\r\n     .get_one(\"Content-Type\")\r\n     .and_then(|v| v.parse().ok());\r\n    if !content_type.map_or(false, |ct| ct.is_json()) {\r\n      // Not json.\r\n      return Forward(data);\r\n    } else {\r\n      // Handle the request. Called correctly.\r\n    }\r\n}\r\n```\r\n\r\n---\r\n\r\nThe [relevant rocket code](https://api.rocket.rs/src/rocket/request/request.rs.html#320-324) looks like:\r\n\r\n```rust\r\npub fn content_type(&self) -> Option<&ContentType> {\r\n        self.state.content_type.get_or_set(|| {\r\n            self.headers().get_one(\"Content-Type\").and_then(|v| v.parse().ok())\r\n        }).as_ref()\r\n    }\r\n```\r\n\r\nSo it appears that `state` is not updated correctly somewhere.\r\n\r\n---\r\n\r\nRocket: v0.3.4\r\nOS: mac OS v10.12.16","closed_by":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/505/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rwf2/Rocket/issues/505/timeline","performed_via_github_app":null,"state_reason":"completed"}