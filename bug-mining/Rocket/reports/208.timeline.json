[{"id":4898582423,"node_id":"MDE3OlJlbmFtZWRUaXRsZUV2ZW50NDg5ODU4MjQyMw==","url":"https://api.github.com/repos/rwf2/Rocket/issues/events/4898582423","actor":{"login":"JarvisCraft","id":7693005,"node_id":"MDQ6VXNlcjc2OTMwMDU=","avatar_url":"https://avatars.githubusercontent.com/u/7693005?v=4","gravatar_id":"","url":"https://api.github.com/users/JarvisCraft","html_url":"https://github.com/JarvisCraft","followers_url":"https://api.github.com/users/JarvisCraft/followers","following_url":"https://api.github.com/users/JarvisCraft/following{/other_user}","gists_url":"https://api.github.com/users/JarvisCraft/gists{/gist_id}","starred_url":"https://api.github.com/users/JarvisCraft/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JarvisCraft/subscriptions","organizations_url":"https://api.github.com/users/JarvisCraft/orgs","repos_url":"https://api.github.com/users/JarvisCraft/repos","events_url":"https://api.github.com/users/JarvisCraft/events{/privacy}","received_events_url":"https://api.github.com/users/JarvisCraft/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"renamed","commit_id":null,"commit_url":null,"created_at":"2021-06-16T15:03:38Z","rename":{"from":"[Feature] Way to handle Rocket shutdown while its managed objects are still available","to":"[Feature] Access to managed objects on Rocket shutdown"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/862836350","html_url":"https://github.com/rwf2/Rocket/issues/1707#issuecomment-862836350","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1707","id":862836350,"node_id":"MDEyOklzc3VlQ29tbWVudDg2MjgzNjM1MA==","user":{"login":"jebrosen","id":7102588,"node_id":"MDQ6VXNlcjcxMDI1ODg=","avatar_url":"https://avatars.githubusercontent.com/u/7102588?v=4","gravatar_id":"","url":"https://api.github.com/users/jebrosen","html_url":"https://github.com/jebrosen","followers_url":"https://api.github.com/users/jebrosen/followers","following_url":"https://api.github.com/users/jebrosen/following{/other_user}","gists_url":"https://api.github.com/users/jebrosen/gists{/gist_id}","starred_url":"https://api.github.com/users/jebrosen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jebrosen/subscriptions","organizations_url":"https://api.github.com/users/jebrosen/orgs","repos_url":"https://api.github.com/users/jebrosen/repos","events_url":"https://api.github.com/users/jebrosen/events{/privacy}","received_events_url":"https://api.github.com/users/jebrosen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-06-17T01:08:50Z","updated_at":"2021-06-17T01:08:50Z","body":"> In order to do it I need both access to the `rocket.shutdown().await` mechanism and `rocket.state::<sqlx::PgPool>()`. The only place in which this can be done are:\r\n\r\nFor database pools (maybe not all, but certainly `sqlx`), there is another option already available: retrieve and clone the `PgPool` after it has been added to managed state, and use the clone after shutdown. The connection pool already uses `Arc` (or something similar) internally. I've also tentatively made \"you can easily get to and/or clone the database pool itself\" part of the public API for `rocket_db_pools` in #1696.\r\n\r\nThat aside, I do think that having access to managed state is sufficient reason to reconsider adding a method `Fairing::on_shutdown()`.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/862836350/reactions","total_count":2,"+1":0,"-1":0,"laugh":0,"hooray":2,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jebrosen","id":7102588,"node_id":"MDQ6VXNlcjcxMDI1ODg=","avatar_url":"https://avatars.githubusercontent.com/u/7102588?v=4","gravatar_id":"","url":"https://api.github.com/users/jebrosen","html_url":"https://github.com/jebrosen","followers_url":"https://api.github.com/users/jebrosen/followers","following_url":"https://api.github.com/users/jebrosen/following{/other_user}","gists_url":"https://api.github.com/users/jebrosen/gists{/gist_id}","starred_url":"https://api.github.com/users/jebrosen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jebrosen/subscriptions","organizations_url":"https://api.github.com/users/jebrosen/orgs","repos_url":"https://api.github.com/users/jebrosen/repos","events_url":"https://api.github.com/users/jebrosen/events{/privacy}","received_events_url":"https://api.github.com/users/jebrosen/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":4901165801,"node_id":"MDEyOkxhYmVsZWRFdmVudDQ5MDExNjU4MDE=","url":"https://api.github.com/repos/rwf2/Rocket/issues/events/4901165801","actor":{"login":"jebrosen","id":7102588,"node_id":"MDQ6VXNlcjcxMDI1ODg=","avatar_url":"https://avatars.githubusercontent.com/u/7102588?v=4","gravatar_id":"","url":"https://api.github.com/users/jebrosen","html_url":"https://github.com/jebrosen","followers_url":"https://api.github.com/users/jebrosen/followers","following_url":"https://api.github.com/users/jebrosen/following{/other_user}","gists_url":"https://api.github.com/users/jebrosen/gists{/gist_id}","starred_url":"https://api.github.com/users/jebrosen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jebrosen/subscriptions","organizations_url":"https://api.github.com/users/jebrosen/orgs","repos_url":"https://api.github.com/users/jebrosen/repos","events_url":"https://api.github.com/users/jebrosen/events{/privacy}","received_events_url":"https://api.github.com/users/jebrosen/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2021-06-17T01:08:57Z","label":{"name":"request","color":"fbca04"},"performed_via_github_app":null},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/862849421","html_url":"https://github.com/rwf2/Rocket/issues/1707#issuecomment-862849421","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1707","id":862849421,"node_id":"MDEyOklzc3VlQ29tbWVudDg2Mjg0OTQyMQ==","user":{"login":"JarvisCraft","id":7693005,"node_id":"MDQ6VXNlcjc2OTMwMDU=","avatar_url":"https://avatars.githubusercontent.com/u/7693005?v=4","gravatar_id":"","url":"https://api.github.com/users/JarvisCraft","html_url":"https://github.com/JarvisCraft","followers_url":"https://api.github.com/users/JarvisCraft/followers","following_url":"https://api.github.com/users/JarvisCraft/following{/other_user}","gists_url":"https://api.github.com/users/JarvisCraft/gists{/gist_id}","starred_url":"https://api.github.com/users/JarvisCraft/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JarvisCraft/subscriptions","organizations_url":"https://api.github.com/users/JarvisCraft/orgs","repos_url":"https://api.github.com/users/JarvisCraft/repos","events_url":"https://api.github.com/users/JarvisCraft/events{/privacy}","received_events_url":"https://api.github.com/users/JarvisCraft/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-06-17T01:44:04Z","updated_at":"2021-06-17T01:44:04Z","body":"> For database pools (maybe not all, but certainly sqlx), there is another option already available: retrieve and clone the PgPool after it has been added to managed state, and use the clone after shutdown.\r\n\r\nThanks, this worked :rocket:\r\n\r\nHowever, this leads to another problem, async task does not seem to be executed after `shutdown.await` returns the control flow (yet, it may be just me doing something wrong): \r\n![image](https://user-images.githubusercontent.com/7693005/122317547-6713f480-cf26-11eb-8b22-c1900225f969.png)\r\n![image](https://user-images.githubusercontent.com/7693005/122317532-60857d00-cf26-11eb-85e3-23e34327f972.png)\r\n","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/862849421/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"JarvisCraft","id":7693005,"node_id":"MDQ6VXNlcjc2OTMwMDU=","avatar_url":"https://avatars.githubusercontent.com/u/7693005?v=4","gravatar_id":"","url":"https://api.github.com/users/JarvisCraft","html_url":"https://github.com/JarvisCraft","followers_url":"https://api.github.com/users/JarvisCraft/followers","following_url":"https://api.github.com/users/JarvisCraft/following{/other_user}","gists_url":"https://api.github.com/users/JarvisCraft/gists{/gist_id}","starred_url":"https://api.github.com/users/JarvisCraft/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JarvisCraft/subscriptions","organizations_url":"https://api.github.com/users/JarvisCraft/orgs","repos_url":"https://api.github.com/users/JarvisCraft/repos","events_url":"https://api.github.com/users/JarvisCraft/events{/privacy}","received_events_url":"https://api.github.com/users/JarvisCraft/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/863714613","html_url":"https://github.com/rwf2/Rocket/issues/1707#issuecomment-863714613","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1707","id":863714613,"node_id":"MDEyOklzc3VlQ29tbWVudDg2MzcxNDYxMw==","user":{"login":"jebrosen","id":7102588,"node_id":"MDQ6VXNlcjcxMDI1ODg=","avatar_url":"https://avatars.githubusercontent.com/u/7102588?v=4","gravatar_id":"","url":"https://api.github.com/users/jebrosen","html_url":"https://github.com/jebrosen","followers_url":"https://api.github.com/users/jebrosen/followers","following_url":"https://api.github.com/users/jebrosen/following{/other_user}","gists_url":"https://api.github.com/users/jebrosen/gists{/gist_id}","starred_url":"https://api.github.com/users/jebrosen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jebrosen/subscriptions","organizations_url":"https://api.github.com/users/jebrosen/orgs","repos_url":"https://api.github.com/users/jebrosen/repos","events_url":"https://api.github.com/users/jebrosen/events{/privacy}","received_events_url":"https://api.github.com/users/jebrosen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-06-18T02:50:22Z","updated_at":"2021-06-18T02:50:22Z","body":"Hm, right. I see at least two issues with that approach if you are using `#[launch]`. First, the \"main\" task (running the rocket server) exits and the program stops; it does not wait for spawned tasks to exit. This can be solved by using `#[rocket::main]` instead of launch, and putting shutdown code after `.launch().await`. The second issue you might run into is <https://api.rocket.rs/v0.5-rc/rocket/config/struct.Shutdown.html#runaway-io> - by default, once connections and requests are finished (or the grace period is over), the server will be force-killed shortly after.\r\n\r\ne.g. (pseudocode):\r\n\r\n```rust\r\n#[rocket::main]\r\nasync fn main() {\r\n    let rocket = rocket::build().manage(/* database pool */);\r\n    let db_pool = rocket.state::<PgPool>()\r\n\r\n    rocket.launch().await;\r\n\r\n    let connection = db_pool.get().await;\r\n    // ...\r\n}\r\n```","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/863714613/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"jebrosen","id":7102588,"node_id":"MDQ6VXNlcjcxMDI1ODg=","avatar_url":"https://avatars.githubusercontent.com/u/7102588?v=4","gravatar_id":"","url":"https://api.github.com/users/jebrosen","html_url":"https://github.com/jebrosen","followers_url":"https://api.github.com/users/jebrosen/followers","following_url":"https://api.github.com/users/jebrosen/following{/other_user}","gists_url":"https://api.github.com/users/jebrosen/gists{/gist_id}","starred_url":"https://api.github.com/users/jebrosen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jebrosen/subscriptions","organizations_url":"https://api.github.com/users/jebrosen/orgs","repos_url":"https://api.github.com/users/jebrosen/repos","events_url":"https://api.github.com/users/jebrosen/events{/privacy}","received_events_url":"https://api.github.com/users/jebrosen/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/889594965","html_url":"https://github.com/rwf2/Rocket/issues/1707#issuecomment-889594965","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1707","id":889594965,"node_id":"IC_kwDOAzqMt841BiRV","user":{"login":"j4ger","id":12110829,"node_id":"MDQ6VXNlcjEyMTEwODI5","avatar_url":"https://avatars.githubusercontent.com/u/12110829?v=4","gravatar_id":"","url":"https://api.github.com/users/j4ger","html_url":"https://github.com/j4ger","followers_url":"https://api.github.com/users/j4ger/followers","following_url":"https://api.github.com/users/j4ger/following{/other_user}","gists_url":"https://api.github.com/users/j4ger/gists{/gist_id}","starred_url":"https://api.github.com/users/j4ger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/j4ger/subscriptions","organizations_url":"https://api.github.com/users/j4ger/orgs","repos_url":"https://api.github.com/users/j4ger/repos","events_url":"https://api.github.com/users/j4ger/events{/privacy}","received_events_url":"https://api.github.com/users/j4ger/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2021-07-30T03:09:24Z","updated_at":"2021-07-30T03:09:24Z","body":"I also encountered this issue recently when I was trying to save the state of a serial generator on server shutdown, and had to take a different approach by performing the serialization to file in the `fn drop`. Nevertheless a proper shutdown listener or something like that would be much more elegant for such occasions. It could be a trait which can be implemented by managed states, providing a function to do clean-ups on shutdown.","author_association":"NONE","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/889594965/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"j4ger","id":12110829,"node_id":"MDQ6VXNlcjEyMTEwODI5","avatar_url":"https://avatars.githubusercontent.com/u/12110829?v=4","gravatar_id":"","url":"https://api.github.com/users/j4ger","html_url":"https://github.com/j4ger","followers_url":"https://api.github.com/users/j4ger/followers","following_url":"https://api.github.com/users/j4ger/following{/other_user}","gists_url":"https://api.github.com/users/j4ger/gists{/gist_id}","starred_url":"https://api.github.com/users/j4ger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/j4ger/subscriptions","organizations_url":"https://api.github.com/users/j4ger/orgs","repos_url":"https://api.github.com/users/j4ger/repos","events_url":"https://api.github.com/users/j4ger/events{/privacy}","received_events_url":"https://api.github.com/users/j4ger/received_events","type":"User","user_view_type":"public","site_admin":false}},{"id":6545431151,"node_id":"UNLE_lADOAzqMt842_82gzwAAAAGGI1pv","url":"https://api.github.com/repos/rwf2/Rocket/issues/events/6545431151","actor":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"unlabeled","commit_id":null,"commit_url":null,"created_at":"2022-05-04T01:54:47Z","label":{"name":"request","color":"fbca04"},"performed_via_github_app":null},{"id":6545431152,"node_id":"LE_lADOAzqMt842_82gzwAAAAGGI1pw","url":"https://api.github.com/repos/rwf2/Rocket/issues/events/6545431152","actor":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"labeled","commit_id":null,"commit_url":null,"created_at":"2022-05-04T01:54:47Z","label":{"name":"accepted","color":"0e8a16"},"performed_via_github_app":null},{"id":6545435961,"node_id":"MIE_lADOAzqMt842_82gzwAAAAGGI205","url":"https://api.github.com/repos/rwf2/Rocket/issues/events/6545435961","actor":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"milestoned","commit_id":null,"commit_url":null,"created_at":"2022-05-04T01:57:05Z","milestone":{"title":"0.5.0"},"performed_via_github_app":null},{"id":6567376355,"node_id":"CE_lADOAzqMt842_82gzwAAAAGHcjXj","url":"https://api.github.com/repos/rwf2/Rocket/issues/events/6567376355","actor":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"event":"closed","commit_id":"7908dc43ca2d68f5b6afc2a2e344faa1f1380c7d","commit_url":"https://api.github.com/repos/rwf2/Rocket/commits/7908dc43ca2d68f5b6afc2a2e344faa1f1380c7d","created_at":"2022-05-07T11:13:33Z","state_reason":null,"performed_via_github_app":null},{"id":11603836628,"node_id":"REFE_lADOAzqMt842_82gzwAAAAKzpH7U","url":"https://api.github.com/repos/rwf2/Rocket/issues/events/11603836628","actor":{"login":"pull[bot]","id":39814207,"node_id":"MDM6Qm90Mzk4MTQyMDc=","avatar_url":"https://avatars.githubusercontent.com/in/12910?v=4","gravatar_id":"","url":"https://api.github.com/users/pull%5Bbot%5D","html_url":"https://github.com/apps/pull","followers_url":"https://api.github.com/users/pull%5Bbot%5D/followers","following_url":"https://api.github.com/users/pull%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/pull%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/pull%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pull%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/pull%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/pull%5Bbot%5D/repos","events_url":"https://api.github.com/users/pull%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/pull%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"event":"referenced","commit_id":"7908dc43ca2d68f5b6afc2a2e344faa1f1380c7d","commit_url":"https://api.github.com/repos/Necmttn/Rocket/commits/7908dc43ca2d68f5b6afc2a2e344faa1f1380c7d","created_at":"2024-01-26T01:03:08Z","performed_via_github_app":null},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/3187864650","html_url":"https://github.com/rwf2/Rocket/issues/1707#issuecomment-3187864650","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1707","id":3187864650,"node_id":"IC_kwDOAzqMt86-AvRK","user":{"login":"cormacrelf","id":378760,"node_id":"MDQ6VXNlcjM3ODc2MA==","avatar_url":"https://avatars.githubusercontent.com/u/378760?v=4","gravatar_id":"","url":"https://api.github.com/users/cormacrelf","html_url":"https://github.com/cormacrelf","followers_url":"https://api.github.com/users/cormacrelf/followers","following_url":"https://api.github.com/users/cormacrelf/following{/other_user}","gists_url":"https://api.github.com/users/cormacrelf/gists{/gist_id}","starred_url":"https://api.github.com/users/cormacrelf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cormacrelf/subscriptions","organizations_url":"https://api.github.com/users/cormacrelf/orgs","repos_url":"https://api.github.com/users/cormacrelf/repos","events_url":"https://api.github.com/users/cormacrelf/events{/privacy}","received_events_url":"https://api.github.com/users/cormacrelf/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-08-14T10:00:05Z","updated_at":"2025-08-14T10:01:33Z","body":"The pool-cloning advice looks like it would work, but the implementation of `rocket_db_pools` sabotages any attempt to do this. I have encountered a tricky situation where:\n\n- `rocket_db_pools` calls `pool.close()` on the pool (see its `Fairing::on_shutdown` impl, which does this without delay)\n- The docs say all the shutdown hooks run concurrently, and they run at the start of the grace period (hence if you want to wait for all connections to drain, you need to tokio::sleep for the grace + mercy + eps duration, etc.).\n- This means the db pool is closed virtually as soon as graceful shutdown starts, but not necessarily immediately\n- Another fairing which originally cloned the pool via `Db::fetch(&rocket).unwrap().clone()` still has a reference to it during shutdown\n- The shutdowns race against each other and sometimes the pool is closed before the other fairing can use it and do cleanup\n\nThis is, at the very least, a warning that people should not do this trick with `rocket_db_pools` and expect it to work. You might get away with it if, rather than `rocket_db_pools`, you are using a directly managed pool object, which does not close the pool during shutdown.\n\nI don't know if it's a good or bad idea for the fairing for rocket_db_pools to close the pool. When shutdown is called, there are still requests in flight, so this issue does not only affect other fairings, it affects those requests, which might still want to obtain a pool connection during the grace period.\n\nI think maybe you can work around this by maintaining a single persistent PoolConnection for your long-running task, re-acquiring it if it ever conks out, but also subscribing to e.g. sqlx::PgPool.close_event() and closing the pool connection when you're done to prevent blocking up the pool closer. I guess I'll try that.","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/3187864650/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"cormacrelf","id":378760,"node_id":"MDQ6VXNlcjM3ODc2MA==","avatar_url":"https://avatars.githubusercontent.com/u/378760?v=4","gravatar_id":"","url":"https://api.github.com/users/cormacrelf","html_url":"https://github.com/cormacrelf","followers_url":"https://api.github.com/users/cormacrelf/followers","following_url":"https://api.github.com/users/cormacrelf/following{/other_user}","gists_url":"https://api.github.com/users/cormacrelf/gists{/gist_id}","starred_url":"https://api.github.com/users/cormacrelf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cormacrelf/subscriptions","organizations_url":"https://api.github.com/users/cormacrelf/orgs","repos_url":"https://api.github.com/users/cormacrelf/repos","events_url":"https://api.github.com/users/cormacrelf/events{/privacy}","received_events_url":"https://api.github.com/users/cormacrelf/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/3229737092","html_url":"https://github.com/rwf2/Rocket/issues/1707#issuecomment-3229737092","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1707","id":3229737092,"node_id":"IC_kwDOAzqMt87AgeCE","user":{"login":"the10thWiz","id":16281943,"node_id":"MDQ6VXNlcjE2MjgxOTQz","avatar_url":"https://avatars.githubusercontent.com/u/16281943?v=4","gravatar_id":"","url":"https://api.github.com/users/the10thWiz","html_url":"https://github.com/the10thWiz","followers_url":"https://api.github.com/users/the10thWiz/followers","following_url":"https://api.github.com/users/the10thWiz/following{/other_user}","gists_url":"https://api.github.com/users/the10thWiz/gists{/gist_id}","starred_url":"https://api.github.com/users/the10thWiz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/the10thWiz/subscriptions","organizations_url":"https://api.github.com/users/the10thWiz/orgs","repos_url":"https://api.github.com/users/the10thWiz/repos","events_url":"https://api.github.com/users/the10thWiz/events{/privacy}","received_events_url":"https://api.github.com/users/the10thWiz/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-08-27T21:04:12Z","updated_at":"2025-08-27T21:04:12Z","body":"This is an interesting case. Out of curiosity, what actions are you hoping to take between Rocket starting shutdown, and the db connection being closed? I'm assuming you want to write some entries into a database table (e.g., logging the shutdown event).\n\nI do think this is something we should support if possible, but I'm not convinced there is a simple option. Perhaps this should be handled by some kind of pool specific feature, since it could then provide trivial access to the db.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/3229737092/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"the10thWiz","id":16281943,"node_id":"MDQ6VXNlcjE2MjgxOTQz","avatar_url":"https://avatars.githubusercontent.com/u/16281943?v=4","gravatar_id":"","url":"https://api.github.com/users/the10thWiz","html_url":"https://github.com/the10thWiz","followers_url":"https://api.github.com/users/the10thWiz/followers","following_url":"https://api.github.com/users/the10thWiz/following{/other_user}","gists_url":"https://api.github.com/users/the10thWiz/gists{/gist_id}","starred_url":"https://api.github.com/users/the10thWiz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/the10thWiz/subscriptions","organizations_url":"https://api.github.com/users/the10thWiz/orgs","repos_url":"https://api.github.com/users/the10thWiz/repos","events_url":"https://api.github.com/users/the10thWiz/events{/privacy}","received_events_url":"https://api.github.com/users/the10thWiz/received_events","type":"User","user_view_type":"public","site_admin":false}},{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/3231720522","html_url":"https://github.com/rwf2/Rocket/issues/1707#issuecomment-3231720522","issue_url":"https://api.github.com/repos/rwf2/Rocket/issues/1707","id":3231720522,"node_id":"IC_kwDOAzqMt87AoCRK","user":{"login":"cormacrelf","id":378760,"node_id":"MDQ6VXNlcjM3ODc2MA==","avatar_url":"https://avatars.githubusercontent.com/u/378760?v=4","gravatar_id":"","url":"https://api.github.com/users/cormacrelf","html_url":"https://github.com/cormacrelf","followers_url":"https://api.github.com/users/cormacrelf/followers","following_url":"https://api.github.com/users/cormacrelf/following{/other_user}","gists_url":"https://api.github.com/users/cormacrelf/gists{/gist_id}","starred_url":"https://api.github.com/users/cormacrelf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cormacrelf/subscriptions","organizations_url":"https://api.github.com/users/cormacrelf/orgs","repos_url":"https://api.github.com/users/cormacrelf/repos","events_url":"https://api.github.com/users/cormacrelf/events{/privacy}","received_events_url":"https://api.github.com/users/cormacrelf/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2025-08-28T03:39:54Z","updated_at":"2025-08-28T03:39:54Z","body":"Yeah, it's a matter of flushing a last batch of queued writes. Queueing and executing later on a background task is faster than round tripping in situ. It's not a huge issue if the writes are lost (hence just yeeting into a queue) but it's nice to try to write them since there is a batch waiting. \n\nThe workaround (dedicating a pool connection to the background task, which survives beyond pool close) did work. It's a bit of a waste of a pool connection but not a big deal. ","author_association":"CONTRIBUTOR","reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/comments/3231720522/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null,"event":"commented","actor":{"login":"cormacrelf","id":378760,"node_id":"MDQ6VXNlcjM3ODc2MA==","avatar_url":"https://avatars.githubusercontent.com/u/378760?v=4","gravatar_id":"","url":"https://api.github.com/users/cormacrelf","html_url":"https://github.com/cormacrelf","followers_url":"https://api.github.com/users/cormacrelf/followers","following_url":"https://api.github.com/users/cormacrelf/following{/other_user}","gists_url":"https://api.github.com/users/cormacrelf/gists{/gist_id}","starred_url":"https://api.github.com/users/cormacrelf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cormacrelf/subscriptions","organizations_url":"https://api.github.com/users/cormacrelf/orgs","repos_url":"https://api.github.com/users/cormacrelf/repos","events_url":"https://api.github.com/users/cormacrelf/events{/privacy}","received_events_url":"https://api.github.com/users/cormacrelf/received_events","type":"User","user_view_type":"public","site_admin":false}}]