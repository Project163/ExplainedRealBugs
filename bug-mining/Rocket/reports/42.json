{"url":"https://api.github.com/repos/rwf2/Rocket/issues/323","repository_url":"https://api.github.com/repos/rwf2/Rocket","labels_url":"https://api.github.com/repos/rwf2/Rocket/issues/323/labels{/name}","comments_url":"https://api.github.com/repos/rwf2/Rocket/issues/323/comments","events_url":"https://api.github.com/repos/rwf2/Rocket/issues/323/events","html_url":"https://github.com/rwf2/Rocket/issues/323","id":237314410,"node_id":"MDU6SXNzdWUyMzczMTQ0MTA=","number":323,"title":"Memory leak when benchmarking hello_world example","user":{"login":"benwilber","id":165319,"node_id":"MDQ6VXNlcjE2NTMxOQ==","avatar_url":"https://avatars.githubusercontent.com/u/165319?v=4","gravatar_id":"","url":"https://api.github.com/users/benwilber","html_url":"https://github.com/benwilber","followers_url":"https://api.github.com/users/benwilber/followers","following_url":"https://api.github.com/users/benwilber/following{/other_user}","gists_url":"https://api.github.com/users/benwilber/gists{/gist_id}","starred_url":"https://api.github.com/users/benwilber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwilber/subscriptions","organizations_url":"https://api.github.com/users/benwilber/orgs","repos_url":"https://api.github.com/users/benwilber/repos","events_url":"https://api.github.com/users/benwilber/events{/privacy}","received_events_url":"https://api.github.com/users/benwilber/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":343542064,"node_id":"MDU6TGFiZWwzNDM1NDIwNjQ=","url":"https://api.github.com/repos/rwf2/Rocket/labels/bug","name":"bug","color":"B60205","default":true,"description":"Deviation from the specification or expected behavior"},{"id":442158672,"node_id":"MDU6TGFiZWw0NDIxNTg2NzI=","url":"https://api.github.com/repos/rwf2/Rocket/labels/accepted","name":"accepted","color":"0E8A16","default":false,"description":"An accepted request or suggestion"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":14,"created_at":"2017-06-20T19:10:50Z","updated_at":"2022-06-23T17:17:48Z","closed_at":"2017-06-20T23:49:25Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"  1. The version of Rocket you're using. Ensure it's the latest, if possible.\r\n\r\nLatest master as of this bug report\r\n\r\n```shell\r\n$ git branch\r\n* master\r\n$ git rev-parse HEAD\r\n3f87b16d759e91386371ef0eb61df9a372ea8fec\r\n```\r\n\r\n  2. The operating system (distribution and version) where the issue occurs.\r\n\r\nCentOS 7.3 on Digital Ocean 512MB Droplet.\r\n\r\n```shell\r\n$ uname -a\r\nLinux rocket-test 3.10.0-514.21.1.el7.x86_64 #1 SMP Thu May 25 17:04:51 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n\r\n  3. A brief description of the bug:\r\n\r\nI'm testing benchmarks of the `hello_world` example against Rust nightly (6/20/2017) and noticing that resident memory grows and is never released until OOM occurs.  I built a release binary of the `hello_world` example with:\r\n\r\n```shell\r\n$ rustup run nightly cargo build --release\r\n```\r\n\r\nI then run it with:\r\n\r\n```shell\r\n$ ROCKET_ENV=prod ROCKET_PORT=8000 target/release/hello_world\r\nWarning: environment is 'production', but no `secret_key` is configured\r\nðŸš€  Rocket has launched from http://0.0.0.0:8000\r\n```\r\n\r\nI then open another terminal session and watch memory usage with:\r\n\r\n```shell\r\n$ watch 'pidstat -r -C hello_world'\r\n```\r\n\r\n```\r\nEvery 2.0s: pidstat -r -C hello_world                                                                                         Tue Jun 20 18:57:10 2017\r\n\r\nLinux 3.10.0-514.21.1.el7.x86_64 (rocket.sunspot.io)    06/20/2017\t_x86_64_        (1 CPU)\r\n\r\n06:57:10 PM   UID\tPID  minflt/s  majflt/s     VSZ    RSS   %MEM  Command\r\n06:57:10 PM     0     10042\t 0.15\t   0.00   27452   1292   0.26  hello_world\r\n```\r\n\r\nThen from a different server I run Apache Bench with:\r\n\r\n```shell\r\n# 100 concurrent request, 1 million total\r\n$ ab -c 100 -n 1000000 http://rocket-test.example.com:8000/\r\n```\r\n\r\nI observe that the RSS continues to grow rapidly and is never released until OOM (at ~512MB)\r\n\r\n```shell\r\n# After roughly 500k requests:\r\n07:06:49 PM   UID\tPID  minflt/s  majflt/s     VSZ    RSS   %MEM  Command\r\n07:06:49 PM     0     10578\t13.83\t   0.00  234300 207992  41.56  hello_world\r\n```\r\n\r\n```shell\r\n$ ROCKET_ENV=prod ROCKET_PORT=8000 target/release/hello_world\r\nWarning: environment is 'production', but no `secret_key` is configured\r\nðŸš€  Rocket has launched from http://0.0.0.0:8000\r\nKilled\r\n```\r\n\r\nI tried stopping the test early (before OOM) and waiting for netstat to indicate all the TCP connections had cleared to see if the memory was released, but it wasn't.  The memory stays resident until the app is restarted completely.","closed_by":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/323/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rwf2/Rocket/issues/323/timeline","performed_via_github_app":null,"state_reason":"completed"}