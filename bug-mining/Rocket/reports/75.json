{"url":"https://api.github.com/repos/rwf2/Rocket/issues/654","repository_url":"https://api.github.com/repos/rwf2/Rocket","labels_url":"https://api.github.com/repos/rwf2/Rocket/issues/654/labels{/name}","comments_url":"https://api.github.com/repos/rwf2/Rocket/issues/654/comments","events_url":"https://api.github.com/repos/rwf2/Rocket/issues/654/events","html_url":"https://github.com/rwf2/Rocket/issues/654","id":329891226,"node_id":"MDU6SXNzdWUzMjk4OTEyMjY=","number":654,"title":"Request-Local State Cache","user":{"login":"vhakulinen","id":4594126,"node_id":"MDQ6VXNlcjQ1OTQxMjY=","avatar_url":"https://avatars.githubusercontent.com/u/4594126?v=4","gravatar_id":"","url":"https://api.github.com/users/vhakulinen","html_url":"https://github.com/vhakulinen","followers_url":"https://api.github.com/users/vhakulinen/followers","following_url":"https://api.github.com/users/vhakulinen/following{/other_user}","gists_url":"https://api.github.com/users/vhakulinen/gists{/gist_id}","starred_url":"https://api.github.com/users/vhakulinen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vhakulinen/subscriptions","organizations_url":"https://api.github.com/users/vhakulinen/orgs","repos_url":"https://api.github.com/users/vhakulinen/repos","events_url":"https://api.github.com/users/vhakulinen/events{/privacy}","received_events_url":"https://api.github.com/users/vhakulinen/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":343542068,"node_id":"MDU6TGFiZWwzNDM1NDIwNjg=","url":"https://api.github.com/repos/rwf2/Rocket/labels/enhancement","name":"enhancement","color":"5319E7","default":true,"description":"A minor feature request"},{"id":453025789,"node_id":"MDU6TGFiZWw0NTMwMjU3ODk=","url":"https://api.github.com/repos/rwf2/Rocket/labels/docs","name":"docs","color":"333FEA","default":false,"description":"Improvements or additions to documentation"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rwf2/Rocket/milestones/5","html_url":"https://github.com/rwf2/Rocket/milestone/5","labels_url":"https://api.github.com/repos/rwf2/Rocket/milestones/5/labels","id":2216546,"node_id":"MDk6TWlsZXN0b25lMjIxNjU0Ng==","number":5,"title":"0.4.0","description":null,"creator":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":24,"state":"closed","created_at":"2016-12-27T08:21:17Z","updated_at":"2019-07-25T23:19:38Z","due_on":null,"closed_at":"2019-07-25T23:19:38Z"},"comments":2,"created_at":"2018-06-06T14:24:42Z","updated_at":"2018-08-08T06:16:41Z","closed_at":"2018-08-08T06:16:41Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Rocket doesn't currently support \"per request cache\". Usually this is done with middlewares (#55) on other frameworks (and Go does this with `Context`). Such functionality is usually used to store (as an example) loaded `User` object to the context of current request. This way, if the user object is needed in multiple places in the request handling path, the same object can be used.\r\n\r\nHere's an simple example of such use case: https://gist.github.com/vhakulinen/5f72f380d5959b7f00435fc473b2c1e3. In the `cargo run` file, you can see that the user object is being loaded multiple times, and this cannot currently be avoided in any non-hacky way.\r\n\r\n\r\nThat said, I'm interested in implementing this feature, as I said earlier in Matrix. I don't yet have any plan yet other that to extend the `Request` or `RequestState` to have `context` property which would act as a cache. This is so that both fairings and request guards have access to the per request cache.\r\n\r\nExample usage (for request guard) would be following:\r\n```rust\r\nstruct User {\r\n    uid: usize\r\n}\r\n\r\nstruct PermissionViewContent{}\r\n\r\nimpl<'a, 'r> FromRequest<'a, 'r> for PermissionViewContent {\r\n    type Error = ();\r\n\r\n    fn from_request(request: &'a Request<'r>) -> request::Outcome<PermissionViewContent, ()> {\r\n        let u = request.guard::<User>()?;\r\n        if u.uid != 1 {\r\n            return Outcome::Forward(())\r\n        }\r\n\r\n        Outcome::Success(PermissionViewContent{})\r\n    }\r\n}\r\n\r\nimpl<'a, 'r> FromRequest<'a, 'r> for User {\r\n    type Error = ();\r\n\r\n    fn from_request(request: &'a Request<'r>) -> request::Outcome<User, ()> {\r\n        if let Some(user) = request.context.get(\"my-unique-user-key\")Â {\r\n            return user;\r\n        }\r\n\r\n        let u = ...database access and so on... \r\n\r\n        request.context.set(\"my-unique-user-key\", u);\r\n\r\n        return u;\r\n    }\r\n}\r\n```\r\n\r\nI'm quite new to rust, so there probably is more 'rust' way to do this. I was wondering if something like the `request.guard::<User>()` could be implemented for the per request cache, but that would be limiting in some ways: for example, you'd be limited to have one cached `User` object per request.","closed_by":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/654/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rwf2/Rocket/issues/654/timeline","performed_via_github_app":null,"state_reason":"completed"}