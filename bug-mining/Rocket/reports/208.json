{"url":"https://api.github.com/repos/rwf2/Rocket/issues/1707","repository_url":"https://api.github.com/repos/rwf2/Rocket","labels_url":"https://api.github.com/repos/rwf2/Rocket/issues/1707/labels{/name}","comments_url":"https://api.github.com/repos/rwf2/Rocket/issues/1707/comments","events_url":"https://api.github.com/repos/rwf2/Rocket/issues/1707/events","html_url":"https://github.com/rwf2/Rocket/issues/1707","id":922733984,"node_id":"MDU6SXNzdWU5MjI3MzM5ODQ=","number":1707,"title":"[Feature] Access to managed objects on Rocket shutdown","user":{"login":"JarvisCraft","id":7693005,"node_id":"MDQ6VXNlcjc2OTMwMDU=","avatar_url":"https://avatars.githubusercontent.com/u/7693005?v=4","gravatar_id":"","url":"https://api.github.com/users/JarvisCraft","html_url":"https://github.com/JarvisCraft","followers_url":"https://api.github.com/users/JarvisCraft/followers","following_url":"https://api.github.com/users/JarvisCraft/following{/other_user}","gists_url":"https://api.github.com/users/JarvisCraft/gists{/gist_id}","starred_url":"https://api.github.com/users/JarvisCraft/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JarvisCraft/subscriptions","organizations_url":"https://api.github.com/users/JarvisCraft/orgs","repos_url":"https://api.github.com/users/JarvisCraft/repos","events_url":"https://api.github.com/users/JarvisCraft/events{/privacy}","received_events_url":"https://api.github.com/users/JarvisCraft/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":442158672,"node_id":"MDU6TGFiZWw0NDIxNTg2NzI=","url":"https://api.github.com/repos/rwf2/Rocket/labels/accepted","name":"accepted","color":"0E8A16","default":false,"description":"An accepted request or suggestion"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rwf2/Rocket/milestones/8","html_url":"https://github.com/rwf2/Rocket/milestone/8","labels_url":"https://api.github.com/repos/rwf2/Rocket/milestones/8/labels","id":2300325,"node_id":"MDk6TWlsZXN0b25lMjMwMDMyNQ==","number":8,"title":"0.5.0","description":null,"creator":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":43,"state":"open","created_at":"2017-02-05T07:58:22Z","updated_at":"2023-04-05T18:18:52Z","due_on":null,"closed_at":null},"comments":7,"created_at":"2021-06-16T15:02:59Z","updated_at":"2025-08-28T03:39:54Z","closed_at":"2022-05-07T11:13:32Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"# Feature Requests\r\n\r\n## Description\r\n\r\nIn #1079 the [shutdown mechanism](https://docs.rs/rocket/0.5.0-rc.1/rocket/struct.Shutdown.html) was added in order to allow API users to:\r\n\r\n- trigger shutdown via `Shutdown::notify(self)`\r\n- wait for shutdown via `Shutdown::await`\r\n\r\nThe latter is the subject of this feature request.\r\n\r\nWhile the await approach seems to be a common one, it still does not cover cases in which the shutdown awaitor requires access to Rocket and especially its managed states:\r\n\r\nCurrently there can be two approaches for finalization:\r\n- spawning a tokio task awaiting on the shutdown object done in a faring's closure in its `on_ignite` or `on_liftoff`:\r\n```rust\r\nAdHoc::on_ignite(\"Add finalizer\", |rocket| {\r\n    let shutdown = rocket.shutdown();\r\n    rocket::tokio::spawn(async {\r\n        shutdown.await;\r\n        /* shutdown action */\r\n    });\r\n\r\n    Ok(rocket)\r\n)\r\n```\r\nThis is the most obvious approach but it cannot capture `rocket` into closure body due to an obvious lifetime conflict.\r\n\r\n- register a finalizer-state whose destructor will perform the finalization action:\r\n\r\n```rust\r\nAdHoc::on_ignite(\"Add finalizer\", |rocket| {\r\n    struct Finalizer;\r\n    impl Drop for Finalizer {\r\n        fn drop(&mut self) {\r\n            /* shutdown action */\r\n        }\r\n    }\r\n\r\n    Ok(rocket.manage(Finalizer))\r\n)\r\n```\r\n\r\nThis approach looks like a dirty hack and still does not provide a way to access Rocket's state.\r\n\r\n## Motivation\r\n\r\nThere are cases in which it is needed to run finalization which requires access to Rocket-managed states such as a database.\r\n\r\n## Example\r\n\r\nIn my use-case a Rocket-powered service generates a temporary API token on startup via a managed database instance (currently, a `&State<sqlx::PgPool>` until #1696 gets integrated) which I would like to revoke on Rocket shutdown. In order to do it I need both access to the `rocket.shutdown().await` mechanism and `rocket.state::<sqlx::PgPool>()`. The only place in which this can be done are:\r\n- Fairing's `on_`s which yet have to complete without indeterminate awaits thus making it impossible to use `rocket.shutdown().await`.\r\n- Route functions, but these obviously correspond to separate requests.\r\n\r\nThe only ways in which this *may* be implemented is by:\r\n- wrapping the managed database object into a smart-pointer like `Arc` and using it with the `spawn`-based approach, but this requires `Arc` overhead for all operations on this object while it is needed (except for its regular usage) only once on shut-down; moreover this may only work for some specific use-cases and would not work with `rocket(_sync)_db_pools`; generally it would be an architecture design error as it would require the required object to be aware of the need to be `Arc`ed which would also make this approach unusable with foreign crates\r\n- **a really dirty hack**: provide a *private* route (such as guarded by an `AtomicBool` CASed to `false` on first request) as routes do have access to both `Shutdown` and `State` / `impl FromReqest` and perform `await` and shutdown action in this route and *ping* this route on Rocket's liftoff in a `spawn`ed task.\r\n\r\n## Reasons to be part of Rocket\r\n\r\nThis feature has to be implemented as part of Rocket itself rather than as a separate crate as it is related to core Rocket functionality (especially its lifecycle) and requires access to members currently unavailable in the API (i.e. rocket instance on shutdown).\r\n\r\n## Possible design\r\n\r\nThis may be implemented as an additional method of `trait Fairing` such as `async fn on_shutdown(&self, _rocket: &Rocket<Parachute>) { }` and the corresponding `AdHoc` function which was suggested in #1576.","closed_by":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/1707/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rwf2/Rocket/issues/1707/timeline","performed_via_github_app":null,"state_reason":"completed"}