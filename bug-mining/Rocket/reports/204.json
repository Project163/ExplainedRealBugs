{"url":"https://api.github.com/repos/rwf2/Rocket/issues/2118","repository_url":"https://api.github.com/repos/rwf2/Rocket","labels_url":"https://api.github.com/repos/rwf2/Rocket/issues/2118/labels{/name}","comments_url":"https://api.github.com/repos/rwf2/Rocket/issues/2118/comments","events_url":"https://api.github.com/repos/rwf2/Rocket/issues/2118/events","html_url":"https://github.com/rwf2/Rocket/issues/2118","id":1161762866,"node_id":"I_kwDOAzqMt85FPxgy","number":2118,"title":"Run out of sockets (lots in `CLOSE-WAIT`)","user":{"login":"richard-uk1","id":1392222,"node_id":"MDQ6VXNlcjEzOTIyMjI=","avatar_url":"https://avatars.githubusercontent.com/u/1392222?v=4","gravatar_id":"","url":"https://api.github.com/users/richard-uk1","html_url":"https://github.com/richard-uk1","followers_url":"https://api.github.com/users/richard-uk1/followers","following_url":"https://api.github.com/users/richard-uk1/following{/other_user}","gists_url":"https://api.github.com/users/richard-uk1/gists{/gist_id}","starred_url":"https://api.github.com/users/richard-uk1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/richard-uk1/subscriptions","organizations_url":"https://api.github.com/users/richard-uk1/orgs","repos_url":"https://api.github.com/users/richard-uk1/repos","events_url":"https://api.github.com/users/richard-uk1/events{/privacy}","received_events_url":"https://api.github.com/users/richard-uk1/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":615883980,"node_id":"MDU6TGFiZWw2MTU4ODM5ODA=","url":"https://api.github.com/repos/rwf2/Rocket/labels/triage","name":"triage","color":"FBCA04","default":false,"description":"A bug report being investigated"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":27,"created_at":"2022-03-07T18:15:53Z","updated_at":"2023-03-27T15:01:28Z","closed_at":"2023-03-27T15:01:28Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Description**\r\n\r\nMy server has stopped responding to requests. When I logged in to see what was going on, I could see lots of errors that looked like hacking attempts (e.g. `GET /.env`) and also lots of error messages that I've subsequently traced to `rustls` (`received corrupt message of type Handshake`), which again are malformed packets that are probably targeted at openssl. \r\n\r\nWhen I look at the state of sockets (`ss -t`) I see loads of sockets open on `CLOSE-WAIT` (and a few on `ESTAB`). I wonder if the socket is never closed when the client doesn't send the right close messages (which would enable a DDOS attack). I wonder if there's an option we should be setting on the OS socket that would timeout and close sockets that are on CLOSE-WAIT for long enough. It could be something else - I'm not an expert in this area.\r\n\r\n**To Reproduce**\r\n\r\nI'm sorry but I'm not sure how to reproduce the error. I don't have a low-level log of exactly what the TLS handshake & close looks like. I'm more than happy to run any experiments that would be useful. I can give you the versions of libraries that I'm using..\r\n\r\n```toml\r\n[dependencies]\r\ndiesel = { version = \"1.4.8\", default-features = false, features = [\"uuid\", \"chrono\"] }\r\nrocket = { version = \"0.5.0-rc.1\", features = [\"secrets\", \"tls\", \"json\"] }\r\nrocket_sync_db_pools = { version = \"0.1.0-rc.1\", default-features = false, features = [\"diesel_postgres_pool\"] }\r\nserde = { version = \"1.0.136\", features = [\"derive\"] }\r\nuuid = { version = \"0.6.5\", features = [\"v4\", \"serde\"] }\r\nserde_json = \"1.0.79\"\r\nchrono = { version = \"0.4.19\", features = [\"serde\"] }\r\nanyhow = \"1.0.54\"\r\n```\r\n\r\n**Environment:**\r\n\r\n - `uname -a`: `Linux hostname 5.4.0-100-generic #113-Ubuntu SMP Thu Feb 3 18:43:29 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux`\r\n - Rocket Version: see dependencies above\r\n\r\n**Additional Context**\r\n\r\nHere is some debug output (both snipped because messages are the same)\r\n\r\n<details>\r\n<summary>output of `ss` and Rocket logs</summary>\r\n\r\n```\r\n\r\n-- rocket logs --\r\n\r\nFeb 21 21:25:22 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:25:22 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:25:25 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:25:25 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:25:25 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:25:25 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:25:26 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:25:26 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:25:26 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:25:26 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:25:26 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:25:26 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:25:26 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:25:26 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:25:27 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:25:27 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:25:27 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:25:27 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:25:27 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:25:27 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:43:19 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:43:19 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:43:19 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:43:19 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:43:19 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:43:19 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:43:20 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:43:20 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:43:20 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:43:20 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:43:20 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:43:20 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:43:21 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:43:21 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:43:21 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:43:21 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:43:21 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:43:21 host server[21894]: Error: optimistically retrying now\r\nFeb 21 21:43:21 host server[21894]: Error: connection accept error: received corrupt message of type Handshake\r\nFeb 21 21:43:21 host server[21894]: Error: optimistically retrying now\r\nFeb 21 22:17:40 host server[21894]: Error: connection accept error: received corrupt message\r\nFeb 21 22:17:40 host server[21894]: Error: optimistically retrying now\r\nFeb 21 22:17:40 host server[21894]: Error: connection accept error: received corrupt message\r\nFeb 21 22:17:40 host server[21894]: Error: optimistically retrying now\r\n\r\n-- output of `ss -ot`\r\n\r\nCLOSE-WAIT  183     0        0.my.ip.0:https           193.118.53.194:59762\r\nCLOSE-WAIT  416     0        0.my.ip.0:https           159.203.91.246:40734\r\nCLOSE-WAIT  417     0        0.my.ip.0:https            23.239.10.235:41462\r\nCLOSE-WAIT  139     0        0.my.ip.0:https            45.79.216.179:51300\r\nCLOSE-WAIT  301     0        0.my.ip.0:https            103.78.180.53:57637\r\nCLOSE-WAIT  335     0        0.my.ip.0:https           159.203.91.246:42640\r\nCLOSE-WAIT  221     0        0.my.ip.0:https           130.211.54.158:60272\r\nCLOSE-WAIT  204     0        0.my.ip.0:https             192.3.67.179:47314\r\nCLOSE-WAIT  123     0        0.my.ip.0:https          139.162.145.250:49526\r\nESTAB       244     0        0.my.ip.0:https             23.96.35.227:60472\r\nCLOSE-WAIT  105     0        0.my.ip.0:https          192.241.201.233:58786\r\nCLOSE-WAIT  105     0        0.my.ip.0:https           192.241.198.70:38632\r\nCLOSE-WAIT  335     0        0.my.ip.0:https          192.241.218.121:57466\r\nESTAB       0       0        0.my.ip.0:https           222.186.19.235:53586\r\nCLOSE-WAIT  244     0        0.my.ip.0:https            45.146.165.37:47820\r\nCLOSE-WAIT  518     0        0.my.ip.0:https             66.249.66.19:38986\r\nCLOSE-WAIT  123     0        0.my.ip.0:https             60.217.75.69:35568\r\nCLOSE-WAIT  160     0        0.my.ip.0:https            64.62.197.212:44426\r\nESTAB       244     0        0.my.ip.0:https             23.96.35.227:55962\r\nCLOSE-WAIT  282     0        0.my.ip.0:https            198.17.52.130:57414\r\nCLOSE-WAIT  160     0        0.my.ip.0:https             64.62.197.92:26960\r\nCLOSE-WAIT  351     0        0.my.ip.0:https           188.166.33.116:41896\r\nCLOSE-WAIT  518     0        0.my.ip.0:https            3.145.217.144:34732\r\nCLOSE-WAIT  105     0        0.my.ip.0:https          192.241.219.171:43058\r\nCLOSE-WAIT  293     0        0.my.ip.0:https            124.57.42.113:56430\r\nESTAB       244     0        0.my.ip.0:https             20.120.32.30:51659\r\nCLOSE-WAIT  183     0        0.my.ip.0:https           128.14.209.146:47751\r\nCLOSE-WAIT  518     0        0.my.ip.0:https             44.203.91.84:55122\r\nCLOSE-WAIT  350     0        0.my.ip.0:https            185.174.28.39:53682\r\nCLOSE-WAIT  419     0        0.my.ip.0:https          207.154.204.132:51636\r\nCLOSE-WAIT  244     0        0.my.ip.0:https            45.146.165.37:40500\r\nCLOSE-WAIT  139     0        0.my.ip.0:https            45.79.216.179:42006\r\nCLOSE-WAIT  1       0        0.my.ip.0:https            23.129.64.211:21750\r\nCLOSE-WAIT  1       0        0.my.ip.0:https           45.153.160.137:39160\r\nESTAB       244     0        0.my.ip.0:https             20.120.32.30:64493\r\nCLOSE-WAIT  244     0        0.my.ip.0:https           45.146.165.168:7598\r\nCLOSE-WAIT  419     0        0.my.ip.0:https           188.166.33.116:51370\r\nCLOSE-WAIT  198     0        0.my.ip.0:https            134.122.11.90:60185\r\nCLOSE-WAIT  139     0        0.my.ip.0:https            45.79.216.179:54814\r\nCLOSE-WAIT  244     0        0.my.ip.0:https              154.89.5.80:8738\r\nCLOSE-WAIT  417     0        0.my.ip.0:https          192.241.212.220:34400\r\nCLOSE-WAIT  419     0        0.my.ip.0:https            159.203.34.23:45604\r\nCLOSE-WAIT  1       0        0.my.ip.0:https           45.153.160.137:46285\r\nCLOSE-WAIT  244     0        0.my.ip.0:https            45.146.165.37:38502\r\nCLOSE-WAIT  5       0        0.my.ip.0:https           23.225.163.205:52748\r\nCLOSE-WAIT  351     0        0.my.ip.0:https            167.99.176.87:52608\r\nESTAB       244     0        0.my.ip.0:https             23.96.35.227:58420\r\nCLOSE-WAIT  351     0        0.my.ip.0:https             68.183.40.13:52634\r\nCLOSE-WAIT  518     0        0.my.ip.0:https           89.187.175.246:34485\r\nESTAB       244     0        0.my.ip.0:https             20.120.32.30:62169\r\nESTAB       244     0        0.my.ip.0:https             20.120.32.30:57161\r\nCLOSE-WAIT  1       0        0.my.ip.0:https            134.122.11.90:50849\r\nCLOSE-WAIT  20      0        0.my.ip.0:https           89.248.165.244:35110\r\nCLOSE-WAIT  123     0        0.my.ip.0:https          192.241.218.116:59286\r\nCLOSE-WAIT  378     0        0.my.ip.0:https           46.101.135.113:58590\r\nCLOSE-WAIT  40      0        0.my.ip.0:https           23.236.147.154:53890\r\nESTAB       0       0            127.0.0.1:44982                127.0.0.1:postgresql   timer:(keepalive,117min,0)\r\nESTAB       244     0        0.my.ip.0:https             20.120.32.30:64694\r\nCLOSE-WAIT  160     0        0.my.ip.0:https             64.62.197.62:59442\r\nCLOSE-WAIT  123     0        0.my.ip.0:https          192.241.215.153:49624\r\nCLOSE-WAIT  432     0        0.my.ip.0:https           188.166.33.116:46248\r\nESTAB       244     0        0.my.ip.0:https             23.96.35.227:63713\r\nCLOSE-WAIT  244     0        0.my.ip.0:https           45.146.165.168:3610\r\nCLOSE-WAIT  105     0        0.my.ip.0:https          192.241.217.122:49146\r\nCLOSE-WAIT  405     0        0.my.ip.0:https           46.101.135.113:53420\r\nCLOSE-WAIT  378     0        0.my.ip.0:https           188.166.33.116:33084\r\nCLOSE-WAIT  244     0        0.my.ip.0:https            45.146.165.37:51794\r\nCLOSE-WAIT  329     0        0.my.ip.0:https            54.241.251.88:39558\r\nCLOSE-WAIT  293     0        0.my.ip.0:https            124.57.42.113:48066\r\nCLOSE-WAIT  112     0        0.my.ip.0:https            89.248.165.52:37526\r\nCLOSE-WAIT  518     0        0.my.ip.0:https             66.249.66.21:49634\r\nCLOSE-WAIT  428     0        0.my.ip.0:https           165.227.76.114:46866\r\nCLOSE-WAIT  227     0        0.my.ip.0:https           185.220.101.38:7396\r\nCLOSE-WAIT  123     0        0.my.ip.0:https           192.241.218.97:56230\r\nESTAB       244     0        0.my.ip.0:https             20.120.32.30:59518\r\nESTAB       244     0        0.my.ip.0:https             20.120.32.30:54206\r\nCLOSE-WAIT  244     0        0.my.ip.0:https            45.146.165.37:48838\r\nESTAB       244     0        0.my.ip.0:https             23.96.35.227:54342\r\nCLOSE-WAIT  123     0        0.my.ip.0:https          192.241.198.145:45926\r\nCLOSE-WAIT  17      0        0.my.ip.0:https            134.122.11.90:42915\r\nCLOSE-WAIT  163     0        0.my.ip.0:https               20.115.6.6:54746\r\nCLOSE-WAIT  105     0        0.my.ip.0:https          192.241.209.114:59180\r\nCLOSE-WAIT  105     0        0.my.ip.0:https          192.241.211.162:51272\r\nCLOSE-WAIT  244     0        0.my.ip.0:https            45.146.165.37:37206\r\nCLOSE-WAIT  335     0        0.my.ip.0:https          192.241.215.159:45166\r\nCLOSE-WAIT  183     0        0.my.ip.0:https           193.118.53.202:43290\r\nCLOSE-WAIT  349     0        0.my.ip.0:https           165.227.76.114:43434\r\nCLOSE-WAIT  244     0        0.my.ip.0:https            45.146.165.37:50118\r\nCLOSE-WAIT  20      0        0.my.ip.0:https           128.14.209.146:34329\r\nCLOSE-WAIT  264     0        0.my.ip.0:https            34.219.36.208:3408\r\nCLOSE-WAIT  105     0        0.my.ip.0:https          192.241.221.126:53778\r\nCLOSE-WAIT  417     0        0.my.ip.0:https           159.203.91.246:37874\r\nCLOSE-WAIT  183     0        0.my.ip.0:https           128.14.134.134:34836\r\nCLOSE-WAIT  422     0        0.my.ip.0:https             68.183.40.13:52750\r\nCLOSE-WAIT  354     0        0.my.ip.0:https           212.192.241.99:44828\r\nCLOSE-WAIT  143     0        0.my.ip.0:https             45.143.99.69:45506\r\nCLOSE-WAIT  335     0        0.my.ip.0:https          192.241.209.167:33148\r\nCLOSE-WAIT  145     0        0.my.ip.0:https          192.241.212.241:54068\r\nCLOSE-WAIT  139     0        0.my.ip.0:https            45.79.216.179:49124\r\nCLOSE-WAIT  145     0        0.my.ip.0:https             80.82.77.192:32826\r\nCLOSE-WAIT  139     0        0.my.ip.0:https            45.79.216.179:56218\r\nCLOSE-WAIT  518     0        0.my.ip.0:https             213.121.4.11:60225\r\nCLOSE-WAIT  244     0        0.my.ip.0:https            45.146.165.37:48462\r\nCLOSE-WAIT  139     0        0.my.ip.0:https            45.79.216.179:46610\r\nCLOSE-WAIT  518     0        0.my.ip.0:https            54.183.255.27:58054\r\nCLOSE-WAIT  349     0        0.my.ip.0:https          192.241.209.167:38902\r\nCLOSE-WAIT  57      0        0.my.ip.0:https              154.89.5.80:48384\r\nCLOSE-WAIT  518     0        0.my.ip.0:https          114.119.140.107:12580\r\nCLOSE-WAIT  419     0        0.my.ip.0:https          207.154.204.132:56456\r\nCLOSE-WAIT  420     0        0.my.ip.0:https          192.241.215.159:55790\r\nCLOSE-WAIT  518     0        0.my.ip.0:https          114.119.146.141:45472\r\nESTAB       0       0            127.0.0.1:postgresql           127.0.0.1:44984        timer:(keepalive,119min,0)\r\nCLOSE-WAIT  19      0        0.my.ip.0:https          185.189.182.234:35808\r\nCLOSE-WAIT  244     0        0.my.ip.0:https            45.146.165.37:51110\r\n\r\n```\r\n</details>\r\n","closed_by":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/2118/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rwf2/Rocket/issues/2118/timeline","performed_via_github_app":null,"state_reason":"completed"}