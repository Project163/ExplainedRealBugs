{"url":"https://api.github.com/repos/rwf2/Rocket/issues/2591","repository_url":"https://api.github.com/repos/rwf2/Rocket","labels_url":"https://api.github.com/repos/rwf2/Rocket/issues/2591/labels{/name}","comments_url":"https://api.github.com/repos/rwf2/Rocket/issues/2591/comments","events_url":"https://api.github.com/repos/rwf2/Rocket/issues/2591/events","html_url":"https://github.com/rwf2/Rocket/issues/2591","id":1840240867,"node_id":"I_kwDOAzqMt85tr9jj","number":2591,"title":"`CookieJar::get_pending` returns both pending and non-pending cookies","user":{"login":"quentinmit","id":115761,"node_id":"MDQ6VXNlcjExNTc2MQ==","avatar_url":"https://avatars.githubusercontent.com/u/115761?v=4","gravatar_id":"","url":"https://api.github.com/users/quentinmit","html_url":"https://github.com/quentinmit","followers_url":"https://api.github.com/users/quentinmit/followers","following_url":"https://api.github.com/users/quentinmit/following{/other_user}","gists_url":"https://api.github.com/users/quentinmit/gists{/gist_id}","starred_url":"https://api.github.com/users/quentinmit/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/quentinmit/subscriptions","organizations_url":"https://api.github.com/users/quentinmit/orgs","repos_url":"https://api.github.com/users/quentinmit/repos","events_url":"https://api.github.com/users/quentinmit/events{/privacy}","received_events_url":"https://api.github.com/users/quentinmit/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":453025789,"node_id":"MDU6TGFiZWw0NTMwMjU3ODk=","url":"https://api.github.com/repos/rwf2/Rocket/labels/docs","name":"docs","color":"333FEA","default":false,"description":"Improvements or additions to documentation"},{"id":758541123,"node_id":"MDU6TGFiZWw3NTg1NDExMjM=","url":"https://api.github.com/repos/rwf2/Rocket/labels/deficiency","name":"deficiency","color":"D93F0B","default":false,"description":"Something doesn't work as well as it could"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-08-07T21:37:29Z","updated_at":"2023-08-10T20:23:26Z","closed_at":"2023-08-10T20:23:26Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Description**\r\n\r\nThe docs for `CookieJar::get_pending` say:\r\n\r\n> This _does not_ return cookies sent by the client in a request. To\r\n> retrieve such cookies, using [`CookieJar::get()`] or\r\n> [`CookieJar::get_private()`].\r\n\r\nbut in fact, the last line of the implementation of `get_pending` is\r\n\r\n```rust\r\nself.get(name).cloned()\r\n```\r\n\r\nwhich means that it *does* in fact return the cookie sent by the client, if there wasn't a pending operation that replaced the cookie.\r\n\r\nThis means that it cannot be safely used to retrieve a pending private cookie, because it will fall back to returning an unencrypted cookie with the same name.\r\n\r\n**To Reproduce**\r\n\r\nHere's an example program that demonstrates the bug, and demonstrates the security implications re: private cookies:\r\n\r\n```rust\r\nuse rocket::*;\r\nuse rocket::local::blocking::Client;\r\nuse rocket::http::{Cookie, CookieJar};\r\n\r\n#[get(\"/?<set>\")]\r\nfn hello(jar: &CookieJar<'_>, set: bool) -> String {\r\n    if set {\r\n        jar.add_private(Cookie::new(\"private_cookie\", \"encrypted value\"));\r\n    }\r\n    let cookie = jar.get_pending(\"private_cookie\");\r\n    format!(\"cookie = {:?}\", cookie.map(|c| c.value().to_string()))\r\n}\r\n\r\n#[launch]\r\nfn rocket() -> _ {\r\n    rocket::build().mount(\"/\", routes![hello])\r\n}\r\n\r\n#[test]\r\nfn test_ignores_encrypted() {\r\n    let client = Client::tracked(rocket()).expect(\"valid rocket\");\r\n\r\n    assert_eq!(\r\n        client.get(\"/\")\r\n            .dispatch().into_string(),\r\n        Some(\"cookie = None\".to_owned()),\r\n    );\r\n\r\n    assert_eq!(\r\n        client.get(\"/?set\")\r\n            .dispatch().into_string(),\r\n        Some(r#\"cookie = Some(\"encrypted value\")\"#.to_owned()),\r\n    );\r\n\r\n    // Fails here, returning the raw encrypted value of the cookie.\r\n    assert_eq!(\r\n        client.get(\"/\")\r\n            .dispatch().into_string(),\r\n        Some(\"cookie = None\".to_owned()),\r\n    );\r\n}\r\n\r\n#[test]\r\nfn test_ignores_unencrypted() {\r\n    let client = Client::tracked(rocket()).expect(\"valid rocket\");\r\n\r\n    // Fails here, returning the string \"unencrypted value\".\r\n    assert_eq!(\r\n        client.get(\"/\")\r\n            .cookie(Cookie::new(\"private_cookie\", \"unencrypted value\"))\r\n            .dispatch().into_string(),\r\n        Some(\"cookie = None\".to_owned()),\r\n    );\r\n}\r\n```\r\n\r\n**Expected Behavior**\r\n\r\nEither `get_pending()` should not call `get()`, or a second `get_pending_private()` should be introduced that calls `get_private()` instead of `get()` (and probably also makes sure that the pending cookie is private before returning it).\r\n\r\n**Environment:**\r\n\r\n - Rocket Version: 0.5.0-rc3","closed_by":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/2591/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rwf2/Rocket/issues/2591/timeline","performed_via_github_app":null,"state_reason":"completed"}