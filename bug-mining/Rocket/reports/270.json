{"url":"https://api.github.com/repos/rwf2/Rocket/issues/2821","repository_url":"https://api.github.com/repos/rwf2/Rocket","labels_url":"https://api.github.com/repos/rwf2/Rocket/issues/2821/labels{/name}","comments_url":"https://api.github.com/repos/rwf2/Rocket/issues/2821/comments","events_url":"https://api.github.com/repos/rwf2/Rocket/issues/2821/events","html_url":"https://github.com/rwf2/Rocket/issues/2821","id":2394198777,"node_id":"I_kwDOAzqMt86OtJL5","number":2821,"title":"Fairing returns incorrect Content-Length for status 204","user":{"login":"koenbot","id":13939279,"node_id":"MDQ6VXNlcjEzOTM5Mjc5","avatar_url":"https://avatars.githubusercontent.com/u/13939279?v=4","gravatar_id":"","url":"https://api.github.com/users/koenbot","html_url":"https://github.com/koenbot","followers_url":"https://api.github.com/users/koenbot/followers","following_url":"https://api.github.com/users/koenbot/following{/other_user}","gists_url":"https://api.github.com/users/koenbot/gists{/gist_id}","starred_url":"https://api.github.com/users/koenbot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/koenbot/subscriptions","organizations_url":"https://api.github.com/users/koenbot/orgs","repos_url":"https://api.github.com/users/koenbot/repos","events_url":"https://api.github.com/users/koenbot/events{/privacy}","received_events_url":"https://api.github.com/users/koenbot/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":343542064,"node_id":"MDU6TGFiZWwzNDM1NDIwNjQ=","url":"https://api.github.com/repos/rwf2/Rocket/labels/bug","name":"bug","color":"B60205","default":true,"description":"Deviation from the specification or expected behavior"},{"id":567172509,"node_id":"MDU6TGFiZWw1NjcxNzI1MDk=","url":"https://api.github.com/repos/rwf2/Rocket/labels/upstream","name":"upstream","color":"cfd3d7","default":false,"description":"An unresolvable issue: an upstream dependency bug"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2024-07-07T20:07:05Z","updated_at":"2024-08-23T23:26:48Z","closed_at":"2024-08-23T23:26:48Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Rocket Version\n\n0.5.1\n\n### Operating System\n\nWindows 10\n\n### Rust Toolchain Version\n\nrustc 1.79.0 (129f3b996 2024-06-10)\n\n### What happened?\n\nWhen adding a fairing to handle CORS requests, the Content-Length header is not updated. When you run the example server below and then check the returned headers, e.g. with Python\r\n\r\n```py\r\nr = requests.options(\"http://127.0.0.1:8000/login\")\r\nr.headers\r\n```\r\n\r\nit gives\r\n\r\n> {'content-type': 'text/html; charset=utf-8', 'server': 'Rocket', 'x-frame-options': 'SAMEORIGIN', 'x-content-type-options': 'nosniff', 'permissions-policy': 'interest-cohort=()', 'access-control-allow-methods': 'POST, GET, PATCH, DELETE', 'access-control-allow-headers': '*', 'access-control-allow-origin': 'http://localhost:8080', 'access-control-allow-credentials': 'true', 'content-length': '435', 'date': 'Sun, 07 Jul 2024 19:25:33 GMT'}\r\n\r\nI suspect the 'content-length': '435' comes from the length of the default 404 page in Rocket. However for a 204 No Content [the RFC](https://datatracker.ietf.org/doc/html/rfc7230#section-3.3.2) says\r\n\r\n>   A server MUST NOT send a Content-Length header field in any response\r\n>   with a status code of 1xx (Informational) or 204 (No Content)\r\n\r\nThere is no way to manually set this header in Rocket and trying to override it in the Fairing results in a runtime crash.\r\n\r\nIt's a really minor thing and browsers don't seem to care, but I found it strange that an OPTIONS request returned a header with Content-Length: 435 so I dug a bit deeper.\r\n\r\nI could manually add an OPTIONS route for each existing endpoint to avoid the internal redirect to the default 404 page, but\r\n1. the above does seem like a bug\r\n2. maybe there's a better way?\r\n\r\n\r\nNote, when trying to find these headers via the Rocket test Client I don't get all the actual headers (e.g. Date and Content-Length are not included), I'm probably doing something wrong.\r\n\r\n```rust\r\n#[test]\r\nfn test_options() {\r\n    let client = Client::tracked(rocket()).unwrap();\r\n    let response = client.options(\"/login\").dispatch();\r\n    println!(\"{:?}\", response.headers());\r\n}\r\n```\r\n\n\n### Test Case\n\n```rust\n#[macro_use] extern crate rocket;\r\n\r\nuse rocket::http::{Header, Method, Status};\r\nuse rocket::{Request, Response};\r\nuse rocket::fairing::{Fairing, Info, Kind};\r\n\r\npub struct CORS;\r\n\r\n#[rocket::async_trait]\r\nimpl Fairing for CORS {\r\n    fn info(&self) -> Info {\r\n        Info {\r\n            name: \"Add CORS headers to responses\",\r\n            kind: Kind::Response\r\n        }\r\n    }\r\n\r\n    async fn on_response<'r>(&self, request: &'r Request<'_>, response: &mut Response<'r>) {\r\n        if request.method() == Method::Options {\r\n            response.set_status(Status::NoContent);\r\n            response.set_header(Header::new(\"Access-Control-Allow-Methods\", \"POST, GET, PATCH, DELETE\"));\r\n            response.set_header(Header::new(\"Access-Control-Allow-Headers\", \"*\"));\r\n        }\r\n        response.set_header(Header::new(\"Access-Control-Allow-Origin\", \"http://localhost:8080\"));\r\n        response.set_header(Header::new(\"Access-Control-Allow-Credentials\", \"true\"));\r\n        // response.set_header(Header::new(\"Content-Length\", \"0\")); // adding this causes a runtime crash\r\n    }\r\n}\r\n\r\n#[post(\"/login\")]\r\npub async fn login() -> String {\r\n    \"logged in\".to_string()\r\n}\r\n\r\n#[launch]\r\nfn rocket() -> _ {\r\n    rocket::build()\r\n        .mount(\"/\", routes![login])\r\n        .attach(CORS)\r\n}\n```\n\n\n### Log Output\n\n```shell\n{'content-type': 'text/html; charset=utf-8', 'server': 'Rocket', 'x-frame-options': 'SAMEORIGIN', 'x-content-type-options': 'nosniff', 'permissions-policy': 'interest-cohort=()', 'access-control-allow-methods': 'POST, GET, PATCH, DELETE', 'access-control-allow-headers': '*', 'access-control-allow-origin': 'http://localhost:8080', 'access-control-allow-credentials': 'true', 'content-length': '435', 'date': 'Sun, 07 Jul 2024 19:25:33 GMT'}\n```\n\n\n### Additional Context\n\n_No response_\n\n### System Checks\n\n- [X] My bug report relates to functionality.\n- [X] I have tested against the latest Rocket release or a recent git commit.\n- [X] I have tested against the latest stable `rustc` toolchain.\n- [X] I was unable to find this issue previously reported.","closed_by":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/2821/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rwf2/Rocket/issues/2821/timeline","performed_via_github_app":null,"state_reason":"completed"}