{"url":"https://api.github.com/repos/rwf2/Rocket/issues/534","repository_url":"https://api.github.com/repos/rwf2/Rocket","labels_url":"https://api.github.com/repos/rwf2/Rocket/issues/534/labels{/name}","comments_url":"https://api.github.com/repos/rwf2/Rocket/issues/534/comments","events_url":"https://api.github.com/repos/rwf2/Rocket/issues/534/events","html_url":"https://github.com/rwf2/Rocket/issues/534","id":287916301,"node_id":"MDU6SXNzdWUyODc5MTYzMDE=","number":534,"title":"custom `Status` reason isn't used in HTTP response","user":{"login":"YetAnotherMinion","id":8005290,"node_id":"MDQ6VXNlcjgwMDUyOTA=","avatar_url":"https://avatars.githubusercontent.com/u/8005290?v=4","gravatar_id":"","url":"https://api.github.com/users/YetAnotherMinion","html_url":"https://github.com/YetAnotherMinion","followers_url":"https://api.github.com/users/YetAnotherMinion/followers","following_url":"https://api.github.com/users/YetAnotherMinion/following{/other_user}","gists_url":"https://api.github.com/users/YetAnotherMinion/gists{/gist_id}","starred_url":"https://api.github.com/users/YetAnotherMinion/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/YetAnotherMinion/subscriptions","organizations_url":"https://api.github.com/users/YetAnotherMinion/orgs","repos_url":"https://api.github.com/users/YetAnotherMinion/repos","events_url":"https://api.github.com/users/YetAnotherMinion/events{/privacy}","received_events_url":"https://api.github.com/users/YetAnotherMinion/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":758541123,"node_id":"MDU6TGFiZWw3NTg1NDExMjM=","url":"https://api.github.com/repos/rwf2/Rocket/labels/deficiency","name":"deficiency","color":"D93F0B","default":false,"description":"Something doesn't work as well as it could"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-01-11T20:37:17Z","updated_at":"2021-04-29T04:29:35Z","closed_at":"2021-04-29T04:29:35Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"  1. The version of Rocket you're using. Ensure it's the latest, if possible.\r\n\r\n0.4.0-dev (9bf33bdd1b7e2cd155f210bcabafc08d27790288)\r\n\r\n  2. The operating system (distribution and version) where the issue occurs.\r\n\r\nFedora 25 kernel 4.9.56\r\n\r\n  3. A brief description of the bug that includes:\r\n\r\nUsing a custom reason for a rocket::http::Status is not propagated to the wire, because when translating rocket's Response to hyper's response only the status code is used. The reason string hyper sends out is hardcoded based on the value of the code only.\r\n\r\nThe bug occurs with any reason string.\r\n\r\nI expected to vary the reason and see the string in the HTTP response, instead I always receive the canonical reason for the status code (as defined by Hyper, not Rocket).\r\n\r\n  4. How you uncovered the bug. Short, reproducible tests are especially useful.\r\n\r\n```rust\r\n#![feature(plugin)]\r\n#![plugin(rocket_codegen)]\r\n\r\nextern crate rocket;\r\n\r\nuse rocket::http::Status;\r\nuse rocket::response::status::Custom;\r\n\r\n\r\n#[get(\"/hello/<name>/<age>\")]\r\nfn hello(name: String, age: u8) -> Custom<String> {\r\n    Custom(Status::new(1000, \"reason\"), format!(\"Hello, {} year old named {}!\", age, name))\r\n}\r\n\r\nfn main() {\r\n    rocket::ignite().mount(\"/\", routes![hello]).launch();\r\n}\r\n```\r\n\r\n```\r\n$ curl -vvv localhost:8000/hello/bob/8\r\n*   Trying ::1...\r\n* TCP_NODELAY set\r\n* Connected to localhost (::1) port 8000 (#0)\r\n> GET /hello/bob/8 HTTP/1.1\r\n> Host: localhost:8000\r\n> User-Agent: curl/7.51.0\r\n> Accept: */*\r\n> \r\n< HTTP/1.1 1000 <unknown status code>\r\n< Content-Type: text/plain; charset=utf-8\r\n< Server: Rocket\r\n< Content-Length: 28\r\n< Date: Thu, 11 Jan 2018 19:21:06 GMT\r\n< \r\n* Curl_http_done: called premature == 0\r\n* Connection #0 to host localhost left intact\r\nHello, 8 year old named bob!\r\n```\r\nThe reason string is being set by Hyper, not Rocket. If I set a `Status::new(400, \"reason\")` then I will get `400 Bad Request` instead of the expected `400 reason`.\r\n\r\n\r\n  5. Ideas, if any, about what Rocket is doing incorrectly.\r\nRocket should not imply that the reason field can set by the user.\r\n\r\nhttps://github.com/SergioBenitez/Rocket/blob/9bf33bdd1b7e2cd155f210bcabafc08d27790288/lib/src/rocket.rs#L125\r\n\r\nRocket should not have a reason field. Hyper 0.10.x does not support a user defined reason on the response. Hyper 0.11.x introduced a RawStatus with a user defined reason field that is part of the way to a fix. However hyper 0.11.x would need a patch to make the raw_status field on the hyper::server::response::Response mutable (it is read only at current master)\r\n\r\nSince I don't think fixing the custom reason in Rocket will be easy (switch Rocket to fork of hyper with raw_status feature backported), it would be simpler to remove the reason field from Rocket\r\n\r\n\r\n```diff\r\ndiff --git a/lib/src/http/status.rs b/lib/src/http/status.rs\r\nindex 12e8568..9599b5b 100644\r\n--- a/lib/src/http/status.rs\r\n+++ b/lib/src/http/status.rs\r\n@@ -85,20 +85,15 @@ impl StatusClass {\r\n pub struct Status {\r\n     /// The HTTP status code associated with this status.\r\n     pub code: u16,\r\n-    /// The HTTP reason phrase associated with this status.\r\n-    pub reason: &'static str\r\n }\r\n \r\n macro_rules! ctrs {\r\n-    ($($code:expr, $code_str:expr, $name:ident => $reason:expr),+) => {\r\n+    ($($code:expr, $code_str:expr, $name:ident),+) => {\r\n         $(\r\n             #[doc=\"[Status](struct.Status.html) with code <b>\"]\r\n             #[doc=$code_str]\r\n-            #[doc=\"</b> and reason <i>\"]\r\n-            #[doc=$reason]\r\n-            #[doc=\"</i>.\"]\r\n             #[allow(non_upper_case_globals)]\r\n-            pub const $name: Status = Status::new($code, $reason);\r\n+            pub const $name: Status = Status::new($code);\r\n          )+\r\n \r\n         /// Returns a Status given a standard status code `code`. If `code` is\r\n@@ -134,25 +129,24 @@ macro_rules! ctrs {\r\n }\r\n \r\n impl Status {\r\n-    /// Creates a new `Status` with `code` and `reason`. This should be _only_\r\n-    /// to construct non-standard HTTP statuses. Use an associated constant for\r\n-    /// standard statuses.\r\n+    /// Creates a new `Status` with `code`. The reason is chosen by Hyper based only on the\r\n+    /// value of `code`. This should be _only_ to construct non-standard HTTP statuses. Use an\r\n+    /// associated constant for standard statuses.\r\n     ///\r\n     /// # Example\r\n-    ///\r\n-    /// Create a custom `299 Somewhat Successful` status:\r\n+    /// Hyper will choose `<unknown status code>` for the reason of any code it does not recognize\r\n+    /// Create a custom `299 <unknown status code>` status:\r\n     ///\r\n     /// ```rust\r\n     /// use rocket::http::Status;\r\n     ///\r\n-    /// let custom = Status::new(299, \"Somewhat Successful\");\r\n-    /// assert_eq!(custom.to_string(), \"299 Somewhat Successful\".to_string());\r\n+    /// let custom = Status::new(299);\r\n+    /// assert_eq!(custom.to_string(), \"299\".to_owned());\r\n     /// ```\r\n     #[inline(always)]\r\n-    pub const fn new(code: u16, reason: &'static str) -> Status {\r\n+    pub const fn new(code: u16) -> Status {\r\n         Status {\r\n             code: code,\r\n-            reason: reason\r\n         }\r\n     }\r\n \r\n@@ -178,7 +172,7 @@ impl Status {\r\n     /// let internal_error = Status::InternalServerError;\r\n     /// assert_eq!(internal_error.class(), StatusClass::ServerError);\r\n     ///\r\n-    /// let custom = Status::new(600, \"Bizarre\");\r\n+    /// let custom = Status::new(600);\r\n     /// assert_eq!(custom.class(), StatusClass::Unknown);\r\n     /// ```\r\n     pub fn class(&self) -> StatusClass {\r\n@@ -192,85 +186,74 @@ impl Status {\r\n         }\r\n     }\r\n \r\n-    /// Returns a status from a given status code. If the status code is a\r\n-    /// standard code, then the reason phrase is populated accordingly.\r\n-    /// Otherwise the reason phrase is set to \"<unknown code>\".\r\n-    #[inline]\r\n-    #[doc(hidden)]\r\n-    pub fn raw(code: u16) -> Status {\r\n-        match Status::from_code(code) {\r\n-            Some(status) => status,\r\n-            None => Status::new(code, \"<unknown code>\")\r\n-        }\r\n-    }\r\n \r\n     ctrs! {\r\n-        100, \"100\", Continue => \"Continue\",\r\n-        101, \"101\", SwitchingProtocols => \"Switching Protocols\",\r\n-        102, \"102\", Processing => \"Processing\",\r\n-        200, \"200\", Ok => \"OK\",\r\n-        201, \"201\", Created => \"Created\",\r\n-        202, \"202\", Accepted => \"Accepted\",\r\n-        203, \"203\", NonAuthoritativeInformation => \"Non-Authoritative Information\",\r\n-        204, \"204\", NoContent => \"No Content\",\r\n-        205, \"205\", ResetContent => \"Reset Content\",\r\n-        206, \"206\", PartialContent => \"Partial Content\",\r\n-        207, \"207\", MultiStatus => \"Multi-Status\",\r\n-        208, \"208\", AlreadyReported => \"Already Reported\",\r\n-        226, \"226\", ImUsed => \"IM Used\",\r\n-        300, \"300\", MultipleChoices => \"Multiple Choices\",\r\n-        301, \"301\", MovedPermanently => \"Moved Permanently\",\r\n-        302, \"302\", Found => \"Found\",\r\n-        303, \"303\", SeeOther => \"See Other\",\r\n-        304, \"304\", NotModified => \"Not Modified\",\r\n-        305, \"305\", UseProxy => \"Use Proxy\",\r\n-        307, \"307\", TemporaryRedirect => \"Temporary Redirect\",\r\n-        308, \"308\", PermanentRedirect => \"Permanent Redirect\",\r\n-        400, \"400\", BadRequest => \"Bad Request\",\r\n-        401, \"401\", Unauthorized => \"Unauthorized\",\r\n-        402, \"402\", PaymentRequired => \"Payment Required\",\r\n-        403, \"403\", Forbidden => \"Forbidden\",\r\n-        404, \"404\", NotFound => \"Not Found\",\r\n-        405, \"405\", MethodNotAllowed => \"Method Not Allowed\",\r\n-        406, \"406\", NotAcceptable => \"Not Acceptable\",\r\n-        407, \"407\", ProxyAuthenticationRequired => \"Proxy Authentication Required\",\r\n-        408, \"408\", RequestTimeout => \"Request Timeout\",\r\n-        409, \"409\", Conflict => \"Conflict\",\r\n-        410, \"410\", Gone => \"Gone\",\r\n-        411, \"411\", LengthRequired => \"Length Required\",\r\n-        412, \"412\", PreconditionFailed => \"Precondition Failed\",\r\n-        413, \"413\", PayloadTooLarge => \"Payload Too Large\",\r\n-        414, \"414\", UriTooLong => \"URI Too Long\",\r\n-        415, \"415\", UnsupportedMediaType => \"Unsupported Media Type\",\r\n-        416, \"416\", RangeNotSatisfiable => \"Range Not Satisfiable\",\r\n-        417, \"417\", ExpectationFailed => \"Expectation Failed\",\r\n-        418, \"418\", ImATeapot => \"I'm a teapot\",\r\n-        421, \"421\", MisdirectedRequest => \"Misdirected Request\",\r\n-        422, \"422\", UnprocessableEntity => \"Unprocessable Entity\",\r\n-        423, \"423\", Locked => \"Locked\",\r\n-        424, \"424\", FailedDependency => \"Failed Dependency\",\r\n-        426, \"426\", UpgradeRequired => \"Upgrade Required\",\r\n-        428, \"428\", PreconditionRequired => \"Precondition Required\",\r\n-        429, \"429\", TooManyRequests => \"Too Many Requests\",\r\n-        431, \"431\", RequestHeaderFieldsTooLarge => \"Request Header Fields Too Large\",\r\n-        451, \"451\", UnavailableForLegalReasons => \"Unavailable For Legal Reasons\",\r\n-        500, \"500\", InternalServerError => \"Internal Server Error\",\r\n-        501, \"501\", NotImplemented => \"Not Implemented\",\r\n-        502, \"502\", BadGateway => \"Bad Gateway\",\r\n-        503, \"503\", ServiceUnavailable => \"Service Unavailable\",\r\n-        504, \"504\", GatewayTimeout => \"Gateway Timeout\",\r\n-        505, \"505\", HttpVersionNotSupported => \"HTTP Version Not Supported\",\r\n-        506, \"506\", VariantAlsoNegotiates => \"Variant Also Negotiates\",\r\n-        507, \"507\", InsufficientStorage => \"Insufficient Storage\",\r\n-        508, \"508\", LoopDetected => \"Loop Detected\",\r\n-        510, \"510\", NotExtended => \"Not Extended\",\r\n-        511, \"511\", NetworkAuthenticationRequired => \"Network Authentication Required\"\r\n+        100, \"100\", Continue,\r\n+        101, \"101\", SwitchingProtocols,\r\n+        102, \"102\", Processing,\r\n+        200, \"200\", Ok,\r\n+        201, \"201\", Created,\r\n+        202, \"202\", Accepted,\r\n+        203, \"203\", NonAuthoritativeInformation,\r\n+        204, \"204\", NoContent,\r\n+        205, \"205\", ResetContent,\r\n+        206, \"206\", PartialContent,\r\n+        207, \"207\", MultiStatus,\r\n+        208, \"208\", AlreadyReported,\r\n+        226, \"226\", ImUsed,\r\n+        300, \"300\", MultipleChoices,\r\n+        301, \"301\", MovedPermanently,\r\n+        302, \"302\", Found,\r\n+        303, \"303\", SeeOther,\r\n+        304, \"304\", NotModified,\r\n+        305, \"305\", UseProxy,\r\n+        307, \"307\", TemporaryRedirect,\r\n+        308, \"308\", PermanentRedirect,\r\n+        400, \"400\", BadRequest,\r\n+        401, \"401\", Unauthorized,\r\n+        402, \"402\", PaymentRequired,\r\n+        403, \"403\", Forbidden,\r\n+        404, \"404\", NotFound,\r\n+        405, \"405\", MethodNotAllowed,\r\n+        406, \"406\", NotAcceptable,\r\n+        407, \"407\", ProxyAuthenticationRequired,\r\n+        408, \"408\", RequestTimeout,\r\n+        409, \"409\", Conflict,\r\n+        410, \"410\", Gone,\r\n+        411, \"411\", LengthRequired,\r\n+        412, \"412\", PreconditionFailed,\r\n+        413, \"413\", PayloadTooLarge,\r\n+        414, \"414\", UriTooLong,\r\n+        415, \"415\", UnsupportedMediaType,\r\n+        416, \"416\", RangeNotSatisfiable,\r\n+        417, \"417\", ExpectationFailed,\r\n+        418, \"418\", ImATeapot,\r\n+        421, \"421\", MisdirectedRequest,\r\n+        422, \"422\", UnprocessableEntity,\r\n+        423, \"423\", Locked,\r\n+        424, \"424\", FailedDependency,\r\n+        426, \"426\", UpgradeRequired,\r\n+        428, \"428\", PreconditionRequired,\r\n+        429, \"429\", TooManyRequests,\r\n+        431, \"431\", RequestHeaderFieldsTooLarge,\r\n+        451, \"451\", UnavailableForLegalReasons,\r\n+        500, \"500\", InternalServerError,\r\n+        501, \"501\", NotImplemented,\r\n+        502, \"502\", BadGateway,\r\n+        503, \"503\", ServiceUnavailable,\r\n+        504, \"504\", GatewayTimeout,\r\n+        505, \"505\", HttpVersionNotSupported,\r\n+        506, \"506\", VariantAlsoNegotiates,\r\n+        507, \"507\", InsufficientStorage,\r\n+        508, \"508\", LoopDetected,\r\n+        510, \"510\", NotExtended,\r\n+        511, \"511\", NetworkAuthenticationRequired\r\n     }\r\n }\r\n \r\n impl fmt::Display for Status {\r\n     #[inline(always)]\r\n     fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {\r\n-        write!(f, \"{} {}\", self.code, self.reason)\r\n+        write!(f, \"{}\", self.code)\r\n     }\r\n }\r\ndiff --git a/lib/src/response/response.rs b/lib/src/response/response.rs\r\nindex c81a6ef..06d4f4a 100644\r\n--- a/lib/src/response/response.rs\r\n+++ b/lib/src/response/response.rs\r\n@@ -200,26 +200,6 @@ impl<'r> ResponseBuilder<'r> {\r\n         self\r\n     }\r\n \r\n-    /// Sets the status of the `Response` being built to a custom status\r\n-    /// constructed from the `code` and `reason` phrase.\r\n-    ///\r\n-    /// # Example\r\n-    ///\r\n-    /// ```rust\r\n-    /// use rocket::Response;\r\n-    ///\r\n-    /// # #[allow(unused_variables)]\r\n-    /// let response = Response::build()\r\n-    ///     .raw_status(699, \"Alien Encounter\")\r\n-    ///     .finalize();\r\n-    /// ```\r\n-    #[inline(always)]\r\n-    pub fn raw_status(&mut self, code: u16, reason: &'static str)\r\n-            -> &mut ResponseBuilder<'r> {\r\n-        self.response.set_raw_status(code, reason);\r\n-        self\r\n-    }\r\n-\r\n     /// Adds `header` to the `Response`, replacing any header with the same name\r\n     /// that already exists in the response. If multiple headers with\r\n     /// the same name exist, they are all removed, and only the new header and\r\n@@ -680,25 +660,6 @@ impl<'r> Response<'r> {\r\n         self.headers().get_one(\"Content-Type\").and_then(|v| v.parse().ok())\r\n     }\r\n \r\n-    /// Sets the status of `self` to a custom `status` with status code `code`\r\n-    /// and reason phrase `reason`. This method should be used sparingly; prefer\r\n-    /// to use [set_status](#method.set_status) instead.\r\n-    ///\r\n-    /// # Example\r\n-    ///\r\n-    /// ```rust\r\n-    /// use rocket::Response;\r\n-    /// use rocket::http::Status;\r\n-    ///\r\n-    /// let mut response = Response::new();\r\n-    /// response.set_raw_status(699, \"Tripped a Wire\");\r\n-    /// assert_eq!(response.status(), Status::new(699, \"Tripped a Wire\"));\r\n-    /// ```\r\n-    #[inline(always)]\r\n-    pub fn set_raw_status(&mut self, code: u16, reason: &'static str) {\r\n-        self.status = Some(Status::new(code, reason));\r\n-    }\r\n-\r\n     /// Returns a [`HeaderMap`](/rocket/http/struct.HeaderMap.html) of all of\r\n     /// the headers in `self`.\r\n     ///\r\n```\r\n\r\n","closed_by":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/534/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rwf2/Rocket/issues/534/timeline","performed_via_github_app":null,"state_reason":"completed"}