{"url":"https://api.github.com/repos/rwf2/Rocket/issues/171","repository_url":"https://api.github.com/repos/rwf2/Rocket","labels_url":"https://api.github.com/repos/rwf2/Rocket/issues/171/labels{/name}","comments_url":"https://api.github.com/repos/rwf2/Rocket/issues/171/comments","events_url":"https://api.github.com/repos/rwf2/Rocket/issues/171/events","html_url":"https://github.com/rwf2/Rocket/issues/171","id":205381402,"node_id":"MDU6SXNzdWUyMDUzODE0MDI=","number":171,"title":"Documentation on deploying Rocket üöÄ to Heroku (and other similar ‚òÅÔ∏è environments)","user":{"login":"tcbyrd","id":13207348,"node_id":"MDQ6VXNlcjEzMjA3MzQ4","avatar_url":"https://avatars.githubusercontent.com/u/13207348?v=4","gravatar_id":"","url":"https://api.github.com/users/tcbyrd","html_url":"https://github.com/tcbyrd","followers_url":"https://api.github.com/users/tcbyrd/followers","following_url":"https://api.github.com/users/tcbyrd/following{/other_user}","gists_url":"https://api.github.com/users/tcbyrd/gists{/gist_id}","starred_url":"https://api.github.com/users/tcbyrd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tcbyrd/subscriptions","organizations_url":"https://api.github.com/users/tcbyrd/orgs","repos_url":"https://api.github.com/users/tcbyrd/repos","events_url":"https://api.github.com/users/tcbyrd/events{/privacy}","received_events_url":"https://api.github.com/users/tcbyrd/received_events","type":"User","user_view_type":"public","site_admin":true},"labels":[{"id":453025789,"node_id":"MDU6TGFiZWw0NTMwMjU3ODk=","url":"https://api.github.com/repos/rwf2/Rocket/labels/docs","name":"docs","color":"333FEA","default":false,"description":"Improvements or additions to documentation"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/rwf2/Rocket/milestones/6","html_url":"https://github.com/rwf2/Rocket/milestone/6","labels_url":"https://api.github.com/repos/rwf2/Rocket/milestones/6/labels","id":2224310,"node_id":"MDk6TWlsZXN0b25lMjIyNDMxMA==","number":6,"title":"0.6.0","description":"","creator":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":11,"closed_issues":18,"state":"open","created_at":"2017-01-03T03:17:51Z","updated_at":"2024-08-24T10:40:35Z","due_on":null,"closed_at":null},"comments":38,"created_at":"2017-02-04T22:08:22Z","updated_at":"2024-04-26T03:04:09Z","closed_at":"2024-04-26T03:04:08Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"First off I'd like to just say I'm really enjoying this framework and big üëè  to @SergioBenitez for the ‚ú®  work and great documentation and examples so far. I'm just getting started with Rust and this has been a great introduction to the language for me.\r\n\r\nI'm not sure what other platforms people are using to deploy Rust web servers, but since most of my experience on the back-end has been with NodeJS and Ruby, I typically deploy to Heroku so I can take advantage of their free dynos while getting built-in Git/GitHub integrations. Unfortunately, Heroku doesn't have an officially supported buildpack or any documentation on how to work with Rust, so I was venturing into uncharted territory. I was originally going to open an Issue here to see if anybody had tips, but I decided to see if I could piece it together since the documentation seemed already pretty thorough.\r\n\r\nA big part of getting this working is thanks to an actively maintained custom Heroku buildpack for Rust that supports Cargo here: https://github.com/emk/heroku-buildpack-rust.\r\n\r\n**TL;DR** - Using the steps outlined in that :point_up: repo and a üÜï [recently shipped feature](https://github.com/SergioBenitez/Rocket/commit/d4d5c5dd29b40e9c563197490adce503c1370be8) to override Rocket's config parameters via environment variables, here is what ultimately worked for me:\r\n\r\n\r\n```sh\r\n$ heroku create --buildpack https://github.com/emk/heroku-buildpack-rust.git\r\n$ git remote add heroku https://git.heroku.com/<heroku-project-name>.git\r\n$ echo \"web: ROCKET_PORT=$PORT ROCKET_ENV=prod ./target/release/<MyApp>\" > Procfile\r\n# Dynamically binds Rocket to the Dyno's $PORT on 0.0.0.0\r\n$ echo \"VERSION=nightly\" > RustConfig\r\n# Ensures the buildpack uses Rust nightly\r\n$ git add . && git commit -m \"Add Heroku deploy configuration\"\r\n$ git push heroku master\r\n```\r\n\r\n### Slightly longer explanation\r\nOutlined below are the some of the problems I ran into and how I ultimately ended up getting it all working properly (*I Think* :wink:). I know an Issue probably isn't the best place for this kind of stuff long term, so feel free to use any of this to enhance existing documentation where it makes sense.\r\n\r\n#### Config variables\r\nWhile it made complete since that I could modify the port manually and have independent configurations for [different environments](https://rocket.rs/guide/overview/#configuration), because Heroku [dynamically allocates the port](https://devcenter.heroku.com/articles/runtime-principles#web-servers) every time a dyno (container) is executed, this can't be defined in a `.toml` file ahead of time.\r\n\r\nIt wasn't until I found [this issue](https://github.com/SergioBenitez/Rocket/issues/37) that I realized I could use `CONFIG_PORT` to override the config variables on the command line. This allows you to do `CONFIG_PORT=$PORT` on Heroku to dynamically define the port at launch time.\r\n\r\nWhich worked great! To get the right port, at least. But I still ran into problems getting the server started. In NodeJS (what I'm most familiar with), once you get the port right, it works. But Heroku was still complaining that the process wasn't binding to $PORT:\r\n\r\n```\r\nüîß  Configured for development.\r\n=> address: localhost\r\n=> port: 28693\r\n=> log: normal\r\n=> workers: 8\r\nüöÄ  Rocket has launched from http://localhost:28693...\r\nError R10 (Boot timeout) -> Web process failed to bind to $PORT within 60 seconds of launch\r\n\r\n# Also fails on 127.0.0.1:\r\nüöÄ  Rocket has launched from http://127.0.0.1:18003...\r\nError R10 (Boot timeout) -> Web process failed to bind to $PORT within 60 seconds of launch\r\n```\r\n\r\nIn some cases in Node, an application needs to be aware of the URL that gets created by Heroku, so I thought I would pass that in as the address. This made sense to me because the default was \"localhost\", but doing it this way, once Heroku finished with the deploy, I would get an \"internal application error\" when I tried to browse to that URL. Looking at the logs, this was caused by a panic from Hyper when trying to create the server at that address:\r\n\r\n```sh\r\n$ ROCKET_ADDRESS=immense-sierra-89480.herokuapp.com ROCKET_PORT=$PORT ./target/release/main\r\nüîß  Configured for development.\r\n    => address: immense-sierra-89480.herokuapp.com\r\n    => port: 39205\r\n    => log: normal\r\n    => workers: 8\r\nError: Failed to start server.\r\nthread \"main\" panicked at \"Can't assign requested address (os error 49)\", lib/src/rocket.rs:554\r\n```\r\n\r\nLooking at the [function that caused the panic](https://github.com/SergioBenitez/Rocket/blob/master/lib/src/rocket.rs#L550-L554), basically it just means I was trying to bind to an invalid address.\r\n\r\nOk so that didn't work, but in tracing down that error, I came across the defaults that get used by Rocket in different stages and noticed this:\r\nhttps://github.com/SergioBenitez/Rocket/blob/master/lib/src/config/config.rs#L157\r\n```Rust\r\nProduction => {\r\n    Config {\r\n        environment: Production,\r\n        address: \"0.0.0.0\".to_string(),\r\n        port: 80,\r\n        ...\r\n```\r\n\r\nOf course! Bind the server to 0.0.0.0!\r\n\r\n```\r\n$ ROCKET_ADDRESS=0.0.0.0 ROCKET_PORT=$PORT ./target/release/main\r\nüîß  Configured for development.\r\n    => address: 0.0.0.0\r\n    => port: 50795\r\n    => log: normal\r\n    => workers: 8\r\nüöÄ  Rocket has launched from http://0.0.0.0:50795...\r\nState changed from starting to up\r\n\r\n```\r\n\r\nIt works!!! :boom:üéâ:boom: üéä :boom:\r\n\r\nThis also made me realize that if I configured the Heroku [Procfile](https://devcenter.heroku.com/articles/procfile) command to launch in the production [configuration](https://rocket.rs/guide/overview/#configuration), it would default to 0.0.0.0, meaning I could leave out the address config variable and only define the port:\r\n\r\n```\r\n$ ROCKET_PORT=$PORT ROCKET_ENV=prod ./target/release/main\r\n```\r\n\r\n#### Conclusion\r\nThis is ultimately a very simple solution, which I'm sure speaks to my inexperience with Rust/Hyper and the incredible engineering going on under the hood. So far though, this server is blazingly fast and handles a lot more concurrent connections than a similar NodeJS server I was using on Heroku. Great work again and let me know if anything isn't clear. Cheers! üëã \r\n","closed_by":{"login":"SergioBenitez","id":1480321,"node_id":"MDQ6VXNlcjE0ODAzMjE=","avatar_url":"https://avatars.githubusercontent.com/u/1480321?v=4","gravatar_id":"","url":"https://api.github.com/users/SergioBenitez","html_url":"https://github.com/SergioBenitez","followers_url":"https://api.github.com/users/SergioBenitez/followers","following_url":"https://api.github.com/users/SergioBenitez/following{/other_user}","gists_url":"https://api.github.com/users/SergioBenitez/gists{/gist_id}","starred_url":"https://api.github.com/users/SergioBenitez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergioBenitez/subscriptions","organizations_url":"https://api.github.com/users/SergioBenitez/orgs","repos_url":"https://api.github.com/users/SergioBenitez/repos","events_url":"https://api.github.com/users/SergioBenitez/events{/privacy}","received_events_url":"https://api.github.com/users/SergioBenitez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/171/reactions","total_count":91,"+1":42,"-1":0,"laugh":0,"hooray":27,"confused":0,"heart":22,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rwf2/Rocket/issues/171/timeline","performed_via_github_app":null,"state_reason":"completed"}