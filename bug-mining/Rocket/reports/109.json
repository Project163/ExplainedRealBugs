{"url":"https://api.github.com/repos/rwf2/Rocket/issues/1090","repository_url":"https://api.github.com/repos/rwf2/Rocket","labels_url":"https://api.github.com/repos/rwf2/Rocket/issues/1090/labels{/name}","comments_url":"https://api.github.com/repos/rwf2/Rocket/issues/1090/comments","events_url":"https://api.github.com/repos/rwf2/Rocket/issues/1090/events","html_url":"https://github.com/rwf2/Rocket/issues/1090","id":479802410,"node_id":"MDU6SXNzdWU0Nzk4MDI0MTA=","number":1090,"title":"Question: How to use Cookies and Flash together?","user":{"login":"olback","id":8039145,"node_id":"MDQ6VXNlcjgwMzkxNDU=","avatar_url":"https://avatars.githubusercontent.com/u/8039145?v=4","gravatar_id":"","url":"https://api.github.com/users/olback","html_url":"https://github.com/olback","followers_url":"https://api.github.com/users/olback/followers","following_url":"https://api.github.com/users/olback/following{/other_user}","gists_url":"https://api.github.com/users/olback/gists{/gist_id}","starred_url":"https://api.github.com/users/olback/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/olback/subscriptions","organizations_url":"https://api.github.com/users/olback/orgs","repos_url":"https://api.github.com/users/olback/repos","events_url":"https://api.github.com/users/olback/events{/privacy}","received_events_url":"https://api.github.com/users/olback/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":343542075,"node_id":"MDU6TGFiZWwzNDM1NDIwNzU=","url":"https://api.github.com/repos/rwf2/Rocket/labels/question","name":"question","color":"D61CBC","default":true,"description":"A question (converts to discussion)"},{"id":453025789,"node_id":"MDU6TGFiZWw0NTMwMjU3ODk=","url":"https://api.github.com/repos/rwf2/Rocket/labels/docs","name":"docs","color":"333FEA","default":false,"description":"Improvements or additions to documentation"}],"state":"closed","locked":false,"assignee":{"login":"jebrosen","id":7102588,"node_id":"MDQ6VXNlcjcxMDI1ODg=","avatar_url":"https://avatars.githubusercontent.com/u/7102588?v=4","gravatar_id":"","url":"https://api.github.com/users/jebrosen","html_url":"https://github.com/jebrosen","followers_url":"https://api.github.com/users/jebrosen/followers","following_url":"https://api.github.com/users/jebrosen/following{/other_user}","gists_url":"https://api.github.com/users/jebrosen/gists{/gist_id}","starred_url":"https://api.github.com/users/jebrosen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jebrosen/subscriptions","organizations_url":"https://api.github.com/users/jebrosen/orgs","repos_url":"https://api.github.com/users/jebrosen/repos","events_url":"https://api.github.com/users/jebrosen/events{/privacy}","received_events_url":"https://api.github.com/users/jebrosen/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"jebrosen","id":7102588,"node_id":"MDQ6VXNlcjcxMDI1ODg=","avatar_url":"https://avatars.githubusercontent.com/u/7102588?v=4","gravatar_id":"","url":"https://api.github.com/users/jebrosen","html_url":"https://github.com/jebrosen","followers_url":"https://api.github.com/users/jebrosen/followers","following_url":"https://api.github.com/users/jebrosen/following{/other_user}","gists_url":"https://api.github.com/users/jebrosen/gists{/gist_id}","starred_url":"https://api.github.com/users/jebrosen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jebrosen/subscriptions","organizations_url":"https://api.github.com/users/jebrosen/orgs","repos_url":"https://api.github.com/users/jebrosen/repos","events_url":"https://api.github.com/users/jebrosen/events{/privacy}","received_events_url":"https://api.github.com/users/jebrosen/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2019-08-12T19:05:15Z","updated_at":"2019-11-16T21:24:12Z","closed_at":"2019-11-16T21:24:12Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Scenarios:\r\n- `GET /` Works as expected. Renders the template without errors.\r\n```terminal\r\nGET / text/html:\r\n    => Matched: GET / (index)\r\n    => Outcome: Success\r\n    => Response succeeded.\r\n```\r\n\r\n- `POST /mail` Everything works except the `_flash` cookie does not get deleted. Success, Warning and Error all yield the same error.\r\n```terminal\r\nPOST /mail application/x-www-form-urlencoded:\r\n    => Matched: POST /mail (send_mail)\r\n    => Outcome: Success\r\n    => Response succeeded.\r\nGET / text/html:\r\n    => Matched: GET / (index)\r\n    => Error: Multiple `Cookies` instances are active at once.\r\n    => An instance of `Cookies` must be dropped before another can be retrieved.\r\n    => Warning: The retrieved `Cookies` instance will be empty.\r\n    => Outcome: Success\r\n    => Response succeeded.\r\n```\r\n\r\nCode:\r\n```rust\r\n#[get(\"/\")]\r\nfn index(flash: Option<FlashMessage>, mut cookies: Cookies) -> Template {\r\n\r\n    let protect = AesGcmCsrfProtection::from_key(conf::get_aes_key());\r\n\r\n    // Generate token/cookie pair\r\n    let (csrf_token, csrf_cookie) = protect.generate_token_pair(None, 18000)\r\n        .expect(\"couldn't generate token/cookie pair\");\r\n\r\n    // Set cookie\r\n    cookies.add_private(Cookie::new(\".csrf\", csrf_cookie.b64_string()));\r\n\r\n    // Construct context\r\n    let mut context = templates::IndexTemplate {\r\n        csrf: csrf_token.b64_string(),\r\n        ..Default::default()\r\n    };\r\n\r\n    let f = flash.map(|msg| (msg.name().to_string(), msg.msg().to_string()))\r\n    .unwrap_or_else(|| (\"\".to_string(), \"\".to_string()));\r\n\r\n    if f.0 == \"success\" || f.0 == \"warning\" {\r\n\r\n        context.class = f.0;\r\n        context.message = f.1;\r\n\r\n    } else if f.0 == \"error\" {\r\n\r\n        match cookies.get_private(\".form-data\") {\r\n            Some(form_data_cookie) => {\r\n\r\n                let decoded = match BASE64.decode(form_data_cookie.value().as_bytes()) {\r\n                    Ok(v) => v,\r\n                    Err(_) => {\r\n                        cookies.remove_private(form_data_cookie);\r\n                        drop(cookies);\r\n                        context.class = \"error\".to_string();\r\n                        context.message = \"Form refill decoding failed.\".to_string();\r\n                        return Template::render(\"index\", &context);\r\n                    }\r\n                };\r\n\r\n                let deserialized: form::Mail = match bincode::deserialize(&decoded) {\r\n                    Ok(v) => v,\r\n                    Err(_) => {\r\n                        cookies.remove_private(form_data_cookie);\r\n                        drop(cookies);\r\n                        context.class = \"error\".to_string();\r\n                        context.message = \"Form refill deserialization failed.\".to_string();\r\n                        return Template::render(\"index\", &context);\r\n                    }\r\n                };\r\n\r\n                cookies.remove_private(form_data_cookie);\r\n                context.mail = Some(deserialized);\r\n\r\n            },\r\n            None => ()\r\n        };\r\n\r\n    }\r\n\r\n    Template::render(\"index\", &context)\r\n}\r\n\r\n#[post(\"/mail\", data = \"<mail>\")]\r\nfn send_mail(mail: Form<form::Mail>, mut cookies: Cookies) -> Flash<RawRedirect> {\r\n\r\n    let mail_data = mail.into_inner();\r\n\r\n    ....\r\n\r\n    /*\r\n     *  Send the email.\r\n     */\r\n    if !mailer::send(&mail_data) {\r\n        cookies.add_private(mail_data.refill().1);\r\n        drop(cookies);\r\n        return Flash::error(RawRedirect((), Location(String::from(\"/#contact\"))), \"Failed to send email.\");\r\n    }\r\n\r\n    drop(cookies);\r\n\r\n    Flash::success(RawRedirect((), Location(String::from(\"/#contact\"))), \"Message sent!\")\r\n\r\n}\r\n```\r\n\r\nFor info on RawRedirect, see #842.\r\n\r\n> ## Questions\r\n> Any questions _must_ include:\r\n> 1. The version of Rocket you're using. Ensure it's the latest, if possible.\r\n> 2. What steps you've taken to answer the question yourself.\r\n> 3. What documentation you believe should include an answer to this question.\r\n\r\n1. Rocket version: `0.4.2`\r\n2. I tried what was suggested in #934 with no success. I have tried to use `drop()` everywhere I can but I can't get that to work either.\r\n3. If something's actually wrong or if any documentation should be updated, I think this section should be changed: [https://rocket.rs/v0.4/guide/requests/#one-at-a-time](https://rocket.rs/v0.4/guide/requests/#one-at-a-time).\r\n","closed_by":{"login":"jebrosen","id":7102588,"node_id":"MDQ6VXNlcjcxMDI1ODg=","avatar_url":"https://avatars.githubusercontent.com/u/7102588?v=4","gravatar_id":"","url":"https://api.github.com/users/jebrosen","html_url":"https://github.com/jebrosen","followers_url":"https://api.github.com/users/jebrosen/followers","following_url":"https://api.github.com/users/jebrosen/following{/other_user}","gists_url":"https://api.github.com/users/jebrosen/gists{/gist_id}","starred_url":"https://api.github.com/users/jebrosen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jebrosen/subscriptions","organizations_url":"https://api.github.com/users/jebrosen/orgs","repos_url":"https://api.github.com/users/jebrosen/repos","events_url":"https://api.github.com/users/jebrosen/events{/privacy}","received_events_url":"https://api.github.com/users/jebrosen/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/rwf2/Rocket/issues/1090/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/rwf2/Rocket/issues/1090/timeline","performed_via_github_app":null,"state_reason":"completed"}