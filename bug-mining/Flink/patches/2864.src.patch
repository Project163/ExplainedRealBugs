diff --git a/flink-core/src/test/java/org/apache/flink/testutils/ClassLoaderUtils.java b/flink-core/src/test/java/org/apache/flink/testutils/ClassLoaderUtils.java
index 0688c1df156..b10f2e175b8 100644
--- a/flink-core/src/test/java/org/apache/flink/testutils/ClassLoaderUtils.java
+++ b/flink-core/src/test/java/org/apache/flink/testutils/ClassLoaderUtils.java
@@ -24,8 +24,11 @@ import javax.tools.ToolProvider;
 import java.io.File;
 import java.io.FileWriter;
 import java.io.IOException;
+import java.net.MalformedURLException;
 import java.net.URL;
 import java.net.URLClassLoader;
+import java.util.HashMap;
+import java.util.Map;
 
 /**
  * Utilities to create class loaders.
@@ -33,15 +36,23 @@ import java.net.URLClassLoader;
 public class ClassLoaderUtils {
 	public static URLClassLoader compileAndLoadJava(File root, String filename, String source) throws
 		IOException {
-		File file = writeSourceFile(root, filename, source);
-
-		compileClass(file);
+		return withRoot(root)
+			.addClass(filename.replaceAll("\\.java", ""), source)
+			.build();
+	}
 
+	private static URLClassLoader createClassLoader(File root) throws MalformedURLException {
 		return new URLClassLoader(
 			new URL[]{root.toURI().toURL()},
 			Thread.currentThread().getContextClassLoader());
 	}
 
+	private static void writeAndCompile(File root, String filename, String source) throws IOException {
+		File file = writeSourceFile(root, filename, source);
+
+		compileClass(file);
+	}
+
 	private static File writeSourceFile(File root, String filename, String source) throws IOException {
 		File file = new File(root, filename);
 		FileWriter fileWriter = new FileWriter(file);
@@ -52,8 +63,45 @@ public class ClassLoaderUtils {
 		return file;
 	}
 
+	public static ClassLoaderBuilder withRoot(File root) {
+		return new ClassLoaderBuilder(root);
+	}
+
 	private static int compileClass(File sourceFile) {
 		JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();
 		return compiler.run(null, null, null, "-proc:none", sourceFile.getPath());
 	}
+
+	public static class ClassLoaderBuilder {
+
+		private final File root;
+		private final Map<String, String> classes;
+
+		private ClassLoaderBuilder(File root) {
+			this.root = root;
+			this.classes = new HashMap<>();
+		}
+
+		public ClassLoaderBuilder addClass(String className, String source) {
+			String oldValue = classes.putIfAbsent(className, source);
+
+			if (oldValue != null) {
+				throw new RuntimeException(String.format("Class with name %s already registered.", className));
+			}
+
+			return this;
+		}
+
+		public URLClassLoader build() throws IOException {
+			for (Map.Entry<String, String> classInfo : classes.entrySet()) {
+				writeAndCompile(root, createFileName(classInfo.getKey()), classInfo.getValue());
+			}
+
+			return createClassLoader(root);
+		}
+
+		private String createFileName(String className) {
+			return className + ".java";
+		}
+	}
 }
diff --git a/flink-core/src/test/java/org/apache/flink/util/InstantiationUtilTest.java b/flink-core/src/test/java/org/apache/flink/util/InstantiationUtilTest.java
index 3de393e7d89..ccbb5d7d9ab 100644
--- a/flink-core/src/test/java/org/apache/flink/util/InstantiationUtilTest.java
+++ b/flink-core/src/test/java/org/apache/flink/util/InstantiationUtilTest.java
@@ -32,12 +32,11 @@ import org.junit.ClassRule;
 import org.junit.Test;
 import org.junit.rules.TemporaryFolder;
 
-import java.io.ByteArrayInputStream;
-import java.io.ByteArrayOutputStream;
 import java.io.IOException;
 import java.io.ObjectInputStream;
 import java.io.ObjectOutputStream;
-import java.io.Serializable;
+import java.lang.reflect.InvocationHandler;
+import java.lang.reflect.Proxy;
 import java.net.URLClassLoader;
 import java.util.Objects;
 import java.util.Random;
@@ -56,27 +55,45 @@ public class InstantiationUtilTest extends TestLogger {
 	@ClassRule
 	public static TemporaryFolder temporaryFolder = new TemporaryFolder();
 
+	private static final String PROXY_DEFINITION_FORMAT =
+			"import java.lang.reflect.InvocationHandler;" +
+			"import java.lang.reflect.Method;" +
+			"import java.io.Serializable;" +
+			"public class %s implements InvocationHandler, Serializable {\n" +
+			"\n" +
+			"  @Override\n" +
+			"  public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n" +
+			"    return null;\n" +
+			"  }\n" +
+			"}";
+
 	@Test
 	public void testResolveProxyClass() throws Exception {
+		final String interfaceName = "UserDefinedInterface";
+		final String proxyName = "UserProxy";
 
-		UserDefineFunctionImpl method = new UserDefineFunctionImpl();
-		final String className = "UserDefineFunctionImpl";
-		final URLClassLoader userClassLoader = ClassLoaderUtils.compileAndLoadJava(
-			temporaryFolder.newFolder(),
-			className + ".java",
-			"import java.io.Serializable;\n"
-				+ "interface UserDefineFunction { void test();}\n"
-				+ "public class " + className + " implements UserDefineFunction, Serializable {public void test() {} }");
+		try (URLClassLoader userClassLoader = createClassLoader(interfaceName, proxyName)) {
+			Class<?> userInterface = Class.forName(interfaceName, false, userClassLoader);
+			InvocationHandler userProxy = (InvocationHandler) Class.forName(proxyName, false, userClassLoader)
+				.newInstance();
 
-		ByteArrayOutputStream baos = new ByteArrayOutputStream();
+			Object proxy = Proxy.newProxyInstance(userClassLoader, new Class[]{userInterface}, userProxy);
 
-		InstantiationUtil.serializeObject(baos, method);
+			byte[] serializeObject = InstantiationUtil.serializeObject(proxy);
+			Object deserializedProxy = InstantiationUtil.deserializeObject(serializeObject, userClassLoader);
+			assertNotNull(deserializedProxy);
+		}
+	}
 
-		InstantiationUtil.ClassLoaderObjectInputStream cloi = new InstantiationUtil.ClassLoaderObjectInputStream(
-			new ByteArrayInputStream(baos.toByteArray()), userClassLoader);
-		cloi.resolveProxyClass(new String[]{"UserDefineFunction"});
+	private URLClassLoader createClassLoader(String interfaceName, String proxyName) throws IOException {
+		return ClassLoaderUtils.withRoot(temporaryFolder.newFolder())
+			.addClass(interfaceName, String.format("interface %s { void test();}", interfaceName))
+			.addClass(proxyName, createProxyDefinition(proxyName))
+			.build();
+	}
 
-		userClassLoader.close();
+	private String createProxyDefinition(String proxyName) {
+		return String.format(PROXY_DEFINITION_FORMAT, proxyName);
 	}
 
 	@Test
@@ -186,17 +203,6 @@ public class InstantiationUtilTest extends TestLogger {
 
 	// --------------------------------------------------------------------------------------------
 
-	interface UserDefineFunction extends Serializable {
-		void test();
-	}
-
-	private static class UserDefineFunctionImpl implements UserDefineFunction {
-		@Override
-		public void test() {
-
-		}
-	}
-
 	private class TestClass {}
 
 	private static class TestException extends IOException {
