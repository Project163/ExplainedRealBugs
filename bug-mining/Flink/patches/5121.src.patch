diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/memory/MemoryManager.java b/flink-runtime/src/main/java/org/apache/flink/runtime/memory/MemoryManager.java
index 19c2dfd9db2..f9e6e24db77 100644
--- a/flink-runtime/src/main/java/org/apache/flink/runtime/memory/MemoryManager.java
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/memory/MemoryManager.java
@@ -540,7 +540,12 @@ public class MemoryManager {
                                 e);
                     }
 
-                    return initializer.apply(size);
+                    try {
+                        return initializer.apply(size);
+                    } catch (Throwable t) {
+                        releaseMemory(type, size);
+                        throw t;
+                    }
                 };
 
         final Consumer<Long> releaser = (size) -> releaseMemory(type, size);
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/memory/MemoryManagerSharedResourcesTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/memory/MemoryManagerSharedResourcesTest.java
index d224a15d79b..9c4fb9efa30 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/memory/MemoryManagerSharedResourcesTest.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/memory/MemoryManagerSharedResourcesTest.java
@@ -224,6 +224,23 @@ public class MemoryManagerSharedResourcesTest {
         assertTrue(resource.getResourceHandle().closed);
     }
 
+    @Test
+    public void testAllocateResourceInitializeFail() {
+        final MemoryManager memoryManager = createMemoryManager();
+
+        try {
+            memoryManager.getSharedMemoryResourceForManagedMemory(
+                    "type",
+                    (ignore) -> {
+                        throw new RuntimeException("initialization fail");
+                    },
+                    0.1);
+            fail("expect to fail");
+        } catch (Throwable t) {
+            // expected
+        }
+        assertTrue(memoryManager.verifyEmpty());
+    }
     // ------------------------------------------------------------------------
     //  Utils
     // ------------------------------------------------------------------------
