diff --git a/flink-queryable-state/flink-queryable-state-runtime/pom.xml b/flink-queryable-state/flink-queryable-state-runtime/pom.xml
index 340baabea90..e756b4766d3 100644
--- a/flink-queryable-state/flink-queryable-state-runtime/pom.xml
+++ b/flink-queryable-state/flink-queryable-state-runtime/pom.xml
@@ -63,6 +63,14 @@ under the License.
 								Testing
 			=================================================== -->
 
+		<dependency>
+			<groupId>org.apache.flink</groupId>
+			<artifactId>flink-core</artifactId>
+			<version>${project.version}</version>
+			<scope>test</scope>
+			<type>test-jar</type>
+		</dependency>
+
 		<dependency>
 			<groupId>org.apache.flink</groupId>
 			<artifactId>flink-statebackend-rocksdb_${scala.binary.version}</artifactId>
diff --git a/flink-queryable-state/flink-queryable-state-runtime/src/main/java/org/apache/flink/queryablestate/server/KvStateServerHandler.java b/flink-queryable-state/flink-queryable-state-runtime/src/main/java/org/apache/flink/queryablestate/server/KvStateServerHandler.java
index 0ffb4689041..798008e3e28 100644
--- a/flink-queryable-state/flink-queryable-state-runtime/src/main/java/org/apache/flink/queryablestate/server/KvStateServerHandler.java
+++ b/flink-queryable-state/flink-queryable-state-runtime/src/main/java/org/apache/flink/queryablestate/server/KvStateServerHandler.java
@@ -31,6 +31,7 @@ import org.apache.flink.runtime.query.KvStateInfo;
 import org.apache.flink.runtime.query.KvStateRegistry;
 import org.apache.flink.runtime.state.internal.InternalKvState;
 import org.apache.flink.util.ExceptionUtils;
+import org.apache.flink.util.LambdaUtil;
 import org.apache.flink.util.Preconditions;
 
 import org.apache.flink.shaded.netty4.io.netty.channel.ChannelHandler;
@@ -109,14 +110,19 @@ public class KvStateServerHandler
             final KvStateEntry<K, N, V> entry, final byte[] serializedKeyAndNamespace)
             throws Exception {
 
-        final InternalKvState<K, N, V> state = entry.getState();
-        final KvStateInfo<K, N, V> infoForCurrentThread = entry.getInfoForCurrentThread();
+        return LambdaUtil.withContextClassLoader(
+                entry.getUserClassLoader(),
+                () -> {
+                    final InternalKvState<K, N, V> state = entry.getState();
+                    final KvStateInfo<K, N, V> infoForCurrentThread =
+                            entry.getInfoForCurrentThread();
 
-        return state.getSerializedValue(
-                serializedKeyAndNamespace,
-                infoForCurrentThread.getKeySerializer(),
-                infoForCurrentThread.getNamespaceSerializer(),
-                infoForCurrentThread.getStateValueSerializer());
+                    return state.getSerializedValue(
+                            serializedKeyAndNamespace,
+                            infoForCurrentThread.getKeySerializer(),
+                            infoForCurrentThread.getNamespaceSerializer(),
+                            infoForCurrentThread.getStateValueSerializer());
+                });
     }
 
     @Override
diff --git a/flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/itcases/AbstractQueryableStateTestBase.java b/flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/itcases/AbstractQueryableStateTestBase.java
index 762a1bff3c9..733c4bd6e92 100644
--- a/flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/itcases/AbstractQueryableStateTestBase.java
+++ b/flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/itcases/AbstractQueryableStateTestBase.java
@@ -42,6 +42,7 @@ import org.apache.flink.api.common.typeinfo.BasicTypeInfo;
 import org.apache.flink.api.common.typeinfo.TypeInformation;
 import org.apache.flink.api.java.functions.KeySelector;
 import org.apache.flink.api.java.tuple.Tuple2;
+import org.apache.flink.api.java.typeutils.GenericTypeInfo;
 import org.apache.flink.client.program.ClusterClient;
 import org.apache.flink.configuration.Configuration;
 import org.apache.flink.queryablestate.client.QueryableStateClient;
@@ -63,18 +64,26 @@ import org.apache.flink.streaming.api.functions.source.RichParallelSourceFunctio
 import org.apache.flink.streaming.api.operators.AbstractStreamOperator;
 import org.apache.flink.streaming.api.operators.OneInputStreamOperator;
 import org.apache.flink.streaming.runtime.streamrecord.StreamRecord;
+import org.apache.flink.testutils.ClassLoaderUtils;
 import org.apache.flink.util.Collector;
 import org.apache.flink.util.ExceptionUtils;
+import org.apache.flink.util.LambdaUtil;
 import org.apache.flink.util.Preconditions;
 import org.apache.flink.util.TestLogger;
 
+import com.esotericsoftware.kryo.Serializer;
 import org.junit.Assert;
 import org.junit.Before;
+import org.junit.ClassRule;
 import org.junit.Ignore;
 import org.junit.Test;
+import org.junit.rules.TemporaryFolder;
 
+import java.io.IOException;
+import java.net.URLClassLoader;
 import java.time.Duration;
 import java.util.ArrayList;
+import java.util.Arrays;
 import java.util.HashMap;
 import java.util.HashSet;
 import java.util.List;
@@ -116,6 +125,8 @@ public abstract class AbstractQueryableStateTestBase extends TestLogger {
 
     protected static int maxParallelism;
 
+    @ClassRule public static TemporaryFolder classloaderFolder = new TemporaryFolder();
+
     @Before
     public void setUp() throws Exception {
         // NOTE: do not use a shared instance for all tests as the tests may break
@@ -361,6 +372,65 @@ public abstract class AbstractQueryableStateTestBase extends TestLogger {
         }
     }
 
+    /** This test checks if custom Kryo serializers are loaded with correct classloader. */
+    @Test
+    public void testCustomKryoSerializerHandling() throws Exception {
+        final Deadline deadline = Deadline.now().plus(TEST_TIMEOUT);
+        final long numElements = 1;
+        final String stateName = "teriberka";
+
+        final String customSerializerClassName = "CustomKryo";
+        final URLClassLoader userClassLoader =
+                createLoaderWithCustomKryoSerializer(customSerializerClassName);
+
+        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
+        env.setStateBackend(stateBackend);
+        env.setParallelism(maxParallelism);
+        // Very important, because cluster is shared between tests and we
+        // don't explicitly check that all slots are available before
+        // submitting.
+        env.setRestartStrategy(RestartStrategies.fixedDelayRestart(Integer.MAX_VALUE, 1000L));
+
+        // Custom serializer is not needed, it's used just to check if serialization works.
+        @SuppressWarnings("unchecked")
+        Class<Serializer<?>> customSerializerClass =
+                (Class<Serializer<?>>) userClassLoader.loadClass(customSerializerClassName);
+        env.getConfig().addDefaultKryoSerializer(Byte.class, customSerializerClass);
+
+        // Here we *force* using Kryo, to check if custom serializers are handled correctly WRT
+        // classloading
+        @SuppressWarnings({"rawtypes", "unchecked"})
+        ValueStateDescriptor<Tuple2<Integer, Long>> valueState =
+                new ValueStateDescriptor<>("any", new GenericTypeInfo(Tuple2.class));
+
+        env.addSource(new TestAscendingValueSource(numElements))
+                .keyBy(
+                        new KeySelector<Tuple2<Integer, Long>, Integer>() {
+                            private static final long serialVersionUID = 7662520075515707428L;
+
+                            @Override
+                            public Integer getKey(Tuple2<Integer, Long> value) {
+                                return value.f0;
+                            }
+                        })
+                .asQueryableState(stateName, valueState);
+
+        try (AutoCancellableJob autoCancellableJob =
+                new AutoCancellableJob(deadline, clusterClient, env)) {
+
+            final JobID jobId = autoCancellableJob.getJobId();
+            final JobGraph jobGraph = autoCancellableJob.getJobGraph();
+            jobGraph.setClasspaths(Arrays.asList(userClassLoader.getURLs()));
+
+            clusterClient.submitJob(jobGraph).get();
+            LambdaUtil.withContextClassLoader(
+                    userClassLoader,
+                    () ->
+                            executeValueQuery(
+                                    deadline, client, jobId, stateName, valueState, numElements));
+        }
+    }
+
     /**
      * Tests that the correct exception is thrown if the query contains a wrong jobId or wrong
      * queryable state name.
@@ -1384,4 +1454,26 @@ public abstract class AbstractQueryableStateTestBase extends TestLogger {
             assertTrue("Did not succeed query", success);
         }
     }
+
+    private static URLClassLoader createLoaderWithCustomKryoSerializer(String className)
+            throws IOException {
+        return ClassLoaderUtils.compileAndLoadJava(
+                classloaderFolder.newFolder(),
+                className + ".java",
+                "import com.esotericsoftware.kryo.Kryo;\n"
+                        + "import com.esotericsoftware.kryo.Serializer;\n"
+                        + "import com.esotericsoftware.kryo.io.Input;\n"
+                        + "import com.esotericsoftware.kryo.io.Output;\n"
+                        + "import java.io.Serializable;\n"
+                        + "public class "
+                        + className
+                        + " extends Serializer<Byte> implements Serializable {\n"
+                        + "    @Override\n"
+                        + "    public void write(Kryo kryo, Output output, Byte testJob) {}\n"
+                        + "    @Override\n"
+                        + "    public Byte read(Kryo kryo, Input input, Class<Byte> aClass) {\n"
+                        + "        return null;\n"
+                        + "    }\n"
+                        + "}\n");
+    }
 }
diff --git a/flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/network/ClientTest.java b/flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/network/ClientTest.java
index 6e888cb60bd..e89a14f45ea 100644
--- a/flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/network/ClientTest.java
+++ b/flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/network/ClientTest.java
@@ -741,7 +741,8 @@ public class ClientTest extends TestLogger {
                                 new JobVertexID(),
                                 new KeyGroupRange(0, 0),
                                 "any",
-                                kvState);
+                                kvState,
+                                getClass().getClassLoader());
             }
 
             final Client<KvStateInternalRequest, KvStateResponse> finalClient = client;
diff --git a/flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/network/KvStateServerHandlerTest.java b/flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/network/KvStateServerHandlerTest.java
index f156d9ac01e..6df22a827b1 100644
--- a/flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/network/KvStateServerHandlerTest.java
+++ b/flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/network/KvStateServerHandlerTest.java
@@ -383,7 +383,8 @@ public class KvStateServerHandlerTest extends TestLogger {
                         new JobVertexID(),
                         new KeyGroupRange(0, 0),
                         "vanilla",
-                        kvState);
+                        kvState,
+                        getClass().getClassLoader());
 
         KvStateInternalRequest request = new KvStateInternalRequest(kvStateId, new byte[0]);
         ByteBuf serRequest = MessageSerializer.serializeRequest(channel.alloc(), 282872L, request);
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/query/KvStateEntry.java b/flink-runtime/src/main/java/org/apache/flink/runtime/query/KvStateEntry.java
index 43b8e2419ef..0567d139fea 100644
--- a/flink-runtime/src/main/java/org/apache/flink/runtime/query/KvStateEntry.java
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/query/KvStateEntry.java
@@ -43,7 +43,9 @@ public class KvStateEntry<K, N, V> {
 
     private final ConcurrentMap<Thread, KvStateInfo<K, N, V>> serializerCache;
 
-    public KvStateEntry(final InternalKvState<K, N, V> state) {
+    private final ClassLoader userClassLoader;
+
+    public KvStateEntry(final InternalKvState<K, N, V> state, ClassLoader userClassLoader) {
         this.state = Preconditions.checkNotNull(state);
         this.stateInfo =
                 new KvStateInfo<>(
@@ -51,6 +53,7 @@ public class KvStateEntry<K, N, V> {
                         state.getNamespaceSerializer(),
                         state.getValueSerializer());
         this.serializerCache = new ConcurrentHashMap<>();
+        this.userClassLoader = userClassLoader;
         this.areSerializersStateless = stateInfo.duplicate() == stateInfo;
     }
 
@@ -58,6 +61,10 @@ public class KvStateEntry<K, N, V> {
         return state;
     }
 
+    public ClassLoader getUserClassLoader() {
+        return userClassLoader;
+    }
+
     public KvStateInfo<K, N, V> getInfoForCurrentThread() {
         return areSerializersStateless
                 ? stateInfo
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/query/KvStateRegistry.java b/flink-runtime/src/main/java/org/apache/flink/runtime/query/KvStateRegistry.java
index 1def92a983f..cf9c7bfe1c9 100644
--- a/flink-runtime/src/main/java/org/apache/flink/runtime/query/KvStateRegistry.java
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/query/KvStateRegistry.java
@@ -87,11 +87,13 @@ public class KvStateRegistry {
             JobVertexID jobVertexId,
             KeyGroupRange keyGroupRange,
             String registrationName,
-            InternalKvState<?, ?, ?> kvState) {
+            InternalKvState<?, ?, ?> kvState,
+            ClassLoader userClassLoader) {
 
         KvStateID kvStateId = new KvStateID();
 
-        if (registeredKvStates.putIfAbsent(kvStateId, new KvStateEntry<>(kvState)) == null) {
+        if (registeredKvStates.putIfAbsent(kvStateId, new KvStateEntry<>(kvState, userClassLoader))
+                == null) {
             final KvStateRegistryListener listener = getKvStateRegistryListener(jobId);
 
             if (listener != null) {
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/query/TaskKvStateRegistry.java b/flink-runtime/src/main/java/org/apache/flink/runtime/query/TaskKvStateRegistry.java
index f72240277a5..cdd80158127 100644
--- a/flink-runtime/src/main/java/org/apache/flink/runtime/query/TaskKvStateRegistry.java
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/query/TaskKvStateRegistry.java
@@ -60,10 +60,16 @@ public class TaskKvStateRegistry {
     public void registerKvState(
             KeyGroupRange keyGroupRange,
             String registrationName,
-            InternalKvState<?, ?, ?> kvState) {
+            InternalKvState<?, ?, ?> kvState,
+            ClassLoader userClassLoader) {
         KvStateID kvStateId =
                 registry.registerKvState(
-                        jobId, jobVertexId, keyGroupRange, registrationName, kvState);
+                        jobId,
+                        jobVertexId,
+                        keyGroupRange,
+                        registrationName,
+                        kvState,
+                        userClassLoader);
         registeredKvStates.add(new KvStateInfo(keyGroupRange, registrationName, kvStateId));
     }
 
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/state/AbstractKeyedStateBackend.java b/flink-runtime/src/main/java/org/apache/flink/runtime/state/AbstractKeyedStateBackend.java
index 6dd471cfb7c..1ded0dc516a 100644
--- a/flink-runtime/src/main/java/org/apache/flink/runtime/state/AbstractKeyedStateBackend.java
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/state/AbstractKeyedStateBackend.java
@@ -284,7 +284,7 @@ public abstract class AbstractKeyedStateBackend<K>
                 throw new IllegalStateException("State backend has not been initialized for job.");
             }
             String name = stateDescriptor.getQueryableStateName();
-            kvStateRegistry.registerKvState(keyGroupRange, name, kvState);
+            kvStateRegistry.registerKvState(keyGroupRange, name, kvState, userCodeClassLoader);
         }
     }
 
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/query/KvStateRegistryTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/query/KvStateRegistryTest.java
index 3f3ed747497..f0ac7180446 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/query/KvStateRegistryTest.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/query/KvStateRegistryTest.java
@@ -71,7 +71,12 @@ public class KvStateRegistryTest extends TestLogger {
         final KvStateRegistry kvStateRegistry = new KvStateRegistry();
         final KvStateID stateID =
                 kvStateRegistry.registerKvState(
-                        jobID, jobVertexId, keyGroupRange, registrationName, new DummyKvState());
+                        jobID,
+                        jobVertexId,
+                        keyGroupRange,
+                        registrationName,
+                        new DummyKvState(),
+                        getClass().getClassLoader());
 
         final AtomicReference<Throwable> exceptionHolder = new AtomicReference<>();
 
@@ -162,7 +167,12 @@ public class KvStateRegistryTest extends TestLogger {
         final String registrationName = "foobar";
         final KvStateID kvStateID =
                 kvStateRegistry.registerKvState(
-                        jobId1, jobVertexId, keyGroupRange, registrationName, new DummyKvState());
+                        jobId1,
+                        jobVertexId,
+                        keyGroupRange,
+                        registrationName,
+                        new DummyKvState(),
+                        getClass().getClassLoader());
 
         assertThat(registeredNotifications1.poll(), equalTo(jobId1));
         assertThat(registeredNotifications2.isEmpty(), is(true));
@@ -176,7 +186,8 @@ public class KvStateRegistryTest extends TestLogger {
                         jobVertexId2,
                         keyGroupRange2,
                         registrationName2,
-                        new DummyKvState());
+                        new DummyKvState(),
+                        getClass().getClassLoader());
 
         assertThat(registeredNotifications2.poll(), equalTo(jobId2));
         assertThat(registeredNotifications1.isEmpty(), is(true));
@@ -222,7 +233,12 @@ public class KvStateRegistryTest extends TestLogger {
         final String registrationName = "registrationName";
         final KvStateID kvStateID =
                 kvStateRegistry.registerKvState(
-                        jobId, jobVertexId, keyGroupRange, registrationName, new DummyKvState());
+                        jobId,
+                        jobVertexId,
+                        keyGroupRange,
+                        registrationName,
+                        new DummyKvState(),
+                        getClass().getClassLoader());
 
         assertThat(stateRegistrationNotifications.poll(), equalTo(jobId));
         // another listener should not have received any notifications
