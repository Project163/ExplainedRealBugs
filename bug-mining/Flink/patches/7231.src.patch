diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/state/StateBackendTestBase.java b/flink-runtime/src/test/java/org/apache/flink/runtime/state/StateBackendTestBase.java
index 7824286ebbf..1150a172917 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/state/StateBackendTestBase.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/state/StateBackendTestBase.java
@@ -445,33 +445,66 @@ public abstract class StateBackendTestBase<B extends AbstractStateBackend> {
         CheckpointableKeyedStateBackend<Integer> backend =
                 createKeyedBackend(IntSerializer.INSTANCE);
         try {
-            final String ns1 = "ns1";
-            ValueState<Integer> keyedState1 =
-                    backend.getPartitionedState(
-                            ns1,
-                            StringSerializer.INSTANCE,
-                            new ValueStateDescriptor<>(fieldName, IntSerializer.INSTANCE));
-
-            final String ns2 = "ns2";
-            ValueState<Integer> keyedState2 =
-                    backend.getPartitionedState(
-                            ns2,
+            String[] namespaces = new String[] {"ns1", "ns2"};
+            InternalValueState<Integer, String, Integer> keyedState =
+                    backend.createOrUpdateInternalState(
                             StringSerializer.INSTANCE,
                             new ValueStateDescriptor<>(fieldName, IntSerializer.INSTANCE));
 
             for (int key = 0; key < elementsNum; key++) {
                 backend.setCurrentKey(key);
-                keyedState1.update(key * 2);
-                keyedState2.update(key * 2);
+                for (String ns : namespaces) {
+                    keyedState.setCurrentNamespace(ns);
+                    keyedState.update(key * 2);
+                }
+            }
+
+            try (Stream<Tuple2<Integer, String>> stream = backend.getKeysAndNamespaces(fieldName)) {
+                final Map<String, Set<Integer>> keysByNamespace = new HashMap<>();
+                stream.forEach(
+                        entry -> {
+                            assertThat(entry.f1)
+                                    .withFailMessage("Unexpected namespace")
+                                    .isIn(namespaces);
+                            assertThat(entry.f0)
+                                    .withFailMessage("Unexpected key")
+                                    .isGreaterThanOrEqualTo(0)
+                                    .isLessThan(elementsNum);
+
+                            Set<Integer> keys =
+                                    keysByNamespace.computeIfAbsent(entry.f1, k -> new HashSet<>());
+                            assertThat(keys.add(entry.f0))
+                                    .withFailMessage("Duplicate key for namespace")
+                                    .isTrue();
+                        });
+                assertThat(keysByNamespace.size())
+                        .withFailMessage("Unexpected namespaces count")
+                        .isEqualTo(namespaces.length);
             }
 
+            // make snapshot
+            KeyedStateHandle snapshot =
+                    runSnapshot(
+                            backend.snapshot(
+                                    682375462378L,
+                                    2,
+                                    createStreamFactory(),
+                                    CheckpointOptions.forCheckpointWithDefaultLocation()),
+                            new SharedStateRegistryImpl());
+
+            IOUtils.closeQuietly(backend);
+            backend.dispose();
+
+            // restore backend
+            backend = restoreKeyedBackend(IntSerializer.INSTANCE, snapshot, env);
+
             try (Stream<Tuple2<Integer, String>> stream = backend.getKeysAndNamespaces(fieldName)) {
                 final Map<String, Set<Integer>> keysByNamespace = new HashMap<>();
                 stream.forEach(
                         entry -> {
                             assertThat(entry.f1)
                                     .withFailMessage("Unexpected namespace")
-                                    .isIn(ns1, ns2);
+                                    .isIn(namespaces);
                             assertThat(entry.f0)
                                     .withFailMessage("Unexpected key")
                                     .isGreaterThanOrEqualTo(0)
@@ -483,6 +516,9 @@ public abstract class StateBackendTestBase<B extends AbstractStateBackend> {
                                     .withFailMessage("Duplicate key for namespace")
                                     .isTrue();
                         });
+                assertThat(keysByNamespace.size())
+                        .withFailMessage("Unexpected namespaces count")
+                        .isEqualTo(namespaces.length);
             }
         } finally {
             IOUtils.closeQuietly(backend);
