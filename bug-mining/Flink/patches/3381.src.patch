diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/TaskMailbox.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/TaskMailbox.java
index 6238f595b51..78311cb6110 100644
--- a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/TaskMailbox.java
+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/TaskMailbox.java
@@ -74,4 +74,15 @@ public interface TaskMailbox extends Mailbox {
 	 * Returns <code>true</code> if the mailbox contains mail.
 	 */
 	boolean hasMail();
+
+	/**
+	 * Runs the given code exclusively on this mailbox. No synchronized operations can be run concurrently to the
+	 * given runnable (e.g., {@link #put(Mail)} or modifying lifecycle methods).
+	 *
+	 * <p>Use this methods when you want to atomically execute code that uses different methods (e.g., check for
+	 * state and then put message if open).
+	 *
+	 * @param runnable the runnable to execute
+	 */
+	void runExclusively(Runnable runnable);
 }
diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/TaskMailboxImpl.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/TaskMailboxImpl.java
index 645d57df525..61889507a3b 100644
--- a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/TaskMailboxImpl.java
+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/TaskMailboxImpl.java
@@ -245,4 +245,14 @@ public class TaskMailboxImpl implements TaskMailbox {
 	public State getState() {
 		return state;
 	}
+
+	@Override
+	public void runExclusively(Runnable runnable) {
+		lock.lock();
+		try {
+			runnable.run();
+		} finally {
+			lock.unlock();
+		}
+	}
 }
diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/execution/MailboxProcessor.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/execution/MailboxProcessor.java
index 0dcb8a25704..d627f75c00c 100644
--- a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/execution/MailboxProcessor.java
+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/execution/MailboxProcessor.java
@@ -169,7 +169,13 @@ public class MailboxProcessor {
 	 * This method must be called to end the stream task when all actions for the tasks have been performed.
 	 */
 	public void allActionsCompleted() {
-		sendPriorityLetter(mailboxPoisonLetter, "poison letter");
+		mailbox.runExclusively(() -> {
+			// keep state check and poison letter enqueuing atomic, such that no intermediate #close may cause a
+			// MailboxStateException in #sendPriorityLetter.
+			if (mailbox.getState() == TaskMailbox.State.OPEN) {
+				sendPriorityLetter(mailboxPoisonLetter, "poison letter");
+			}
+		});
 	}
 
 	private void sendPriorityLetter(Runnable priorityLetter, String descriptionFormat, Object... descriptionArgs) {
diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/mailbox/TaskMailboxImplTest.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/mailbox/TaskMailboxImplTest.java
index 61256122dd7..0b6653ec060 100644
--- a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/mailbox/TaskMailboxImplTest.java
+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/mailbox/TaskMailboxImplTest.java
@@ -34,6 +34,7 @@ import java.util.concurrent.CountDownLatch;
 import java.util.function.Consumer;
 
 import static org.apache.flink.streaming.runtime.tasks.mailbox.TaskMailbox.MAX_PRIORITY;
+import static org.junit.Assert.assertEquals;
 
 /**
  * Unit tests for {@link TaskMailboxImpl}.
@@ -307,4 +308,31 @@ public class TaskMailboxImplTest {
 		Assert.assertSame(mailB, taskMailbox.take(TaskMailbox.MIN_PRIORITY));
 		Assert.assertSame(mailD, taskMailbox.take(TaskMailbox.MIN_PRIORITY));
 	}
+
+	/**
+	 * Testing that we cannot close while running exclusively.
+	 */
+	@Test
+	public void testRunExclusively() throws InterruptedException {
+		CountDownLatch exclusiveCodeStarted = new CountDownLatch(1);
+
+		final int numMails = 10;
+
+		// send 10 mails in an atomic operation
+		new Thread(() ->
+			taskMailbox.runExclusively(() -> {
+				exclusiveCodeStarted.countDown();
+				for (int index = 0; index < numMails; index++) {
+					try {
+						taskMailbox.put(new Mail(() -> {}, 1, "mailD"));
+						Thread.sleep(1);
+					} catch (Exception e) {
+					}
+				}
+			})).start();
+
+		exclusiveCodeStarted.await();
+		// make sure that all 10 messages have been actually enqueued.
+		assertEquals(numMails, taskMailbox.close().size());
+	}
 }
diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/mailbox/execution/TaskMailboxProcessorTest.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/mailbox/execution/TaskMailboxProcessorTest.java
index 466c4f7e7df..cf58da39388 100644
--- a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/mailbox/execution/TaskMailboxProcessorTest.java
+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/mailbox/execution/TaskMailboxProcessorTest.java
@@ -201,6 +201,16 @@ public class TaskMailboxProcessorTest {
 		mailboxThread.checkException();
 	}
 
+	/**
+	 * Testing that canceling after closing will not lead to an exception.
+	 */
+	@Test
+	public void testCancelAfterClose() {
+		MailboxProcessor mailboxProcessor = new MailboxProcessor((ctx) -> {});
+		mailboxProcessor.close();
+		mailboxProcessor.allActionsCompleted();
+	}
+
 	private static MailboxProcessor start(MailboxThread mailboxThread) {
 		mailboxThread.start();
 		final MailboxProcessor mailboxProcessor = mailboxThread.getMailboxProcessor();
