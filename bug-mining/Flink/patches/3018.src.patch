diff --git a/flink-java/src/main/java/org/apache/flink/api/java/ExecutionEnvironment.java b/flink-java/src/main/java/org/apache/flink/api/java/ExecutionEnvironment.java
index beb1b65c4a5..f9fc1ef8eb6 100644
--- a/flink-java/src/main/java/org/apache/flink/api/java/ExecutionEnvironment.java
+++ b/flink-java/src/main/java/org/apache/flink/api/java/ExecutionEnvironment.java
@@ -104,6 +104,9 @@ public abstract class ExecutionEnvironment {
 	/** The environment of the context (local by default, cluster if invoked through command line). */
 	private static ExecutionEnvironmentFactory contextEnvironmentFactory;
 
+	/** The ThreadLocal used to store {@link ExecutionEnvironmentFactory}. */
+	private static ThreadLocal<ExecutionEnvironmentFactory> contextEnvironmentFactoryThreadLocal = new ThreadLocal<>();
+
 	/** The default parallelism used by local environments. */
 	private static int defaultLocalDop = Runtime.getRuntime().availableProcessors();
 
@@ -1061,8 +1064,11 @@ public abstract class ExecutionEnvironment {
 	 * @return The execution environment of the context in which the program is executed.
 	 */
 	public static ExecutionEnvironment getExecutionEnvironment() {
-		return contextEnvironmentFactory == null ?
-				createLocalEnvironment() : contextEnvironmentFactory.createExecutionEnvironment();
+
+		return contextEnvironmentFactoryThreadLocal.get() == null ?
+				(contextEnvironmentFactory == null ?
+					createLocalEnvironment() : contextEnvironmentFactory.createExecutionEnvironment()) :
+				contextEnvironmentFactoryThreadLocal.get().createExecutionEnvironment();
 	}
 
 	/**
@@ -1253,6 +1259,7 @@ public abstract class ExecutionEnvironment {
 	 */
 	protected static void initializeContextEnvironment(ExecutionEnvironmentFactory ctx) {
 		contextEnvironmentFactory = Preconditions.checkNotNull(ctx);
+		contextEnvironmentFactoryThreadLocal.set(contextEnvironmentFactory);
 	}
 
 	/**
@@ -1262,6 +1269,7 @@ public abstract class ExecutionEnvironment {
 	 */
 	protected static void resetContextEnvironment() {
 		contextEnvironmentFactory = null;
+		contextEnvironmentFactoryThreadLocal.remove();
 	}
 
 	/**
@@ -1273,6 +1281,6 @@ public abstract class ExecutionEnvironment {
 	 */
 	@Internal
 	public static boolean areExplicitEnvironmentsAllowed() {
-		return contextEnvironmentFactory == null;
+		return contextEnvironmentFactory == null && contextEnvironmentFactoryThreadLocal.get() == null;
 	}
 }
diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/StreamExecutionEnvironment.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/StreamExecutionEnvironment.java
index 7ac1ac68985..f93fd4c50da 100644
--- a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/StreamExecutionEnvironment.java
+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/StreamExecutionEnvironment.java
@@ -117,6 +117,9 @@ public abstract class StreamExecutionEnvironment {
 	 */
 	private static StreamExecutionEnvironmentFactory contextEnvironmentFactory;
 
+	/** The ThreadLocal used to store {@link StreamExecutionEnvironmentFactory}. */
+	private static ThreadLocal<StreamExecutionEnvironmentFactory> contextEnvironmentFactoryThreadLocal = new ThreadLocal<>();
+
 	/** The default parallelism used when creating a local environment. */
 	private static int defaultLocalParallelism = Runtime.getRuntime().availableProcessors();
 
@@ -1568,6 +1571,9 @@ public abstract class StreamExecutionEnvironment {
 	 * executed.
 	 */
 	public static StreamExecutionEnvironment getExecutionEnvironment() {
+		if (contextEnvironmentFactoryThreadLocal.get() != null) {
+			return contextEnvironmentFactoryThreadLocal.get().createExecutionEnvironment();
+		}
 		if (contextEnvironmentFactory != null) {
 			return contextEnvironmentFactory.createExecutionEnvironment();
 		}
@@ -1766,10 +1772,12 @@ public abstract class StreamExecutionEnvironment {
 
 	protected static void initializeContextEnvironment(StreamExecutionEnvironmentFactory ctx) {
 		contextEnvironmentFactory = ctx;
+		contextEnvironmentFactoryThreadLocal.set(contextEnvironmentFactory);
 	}
 
 	protected static void resetContextEnvironment() {
 		contextEnvironmentFactory = null;
+		contextEnvironmentFactoryThreadLocal.remove();
 	}
 
 	/**
