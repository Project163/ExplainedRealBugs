diff --git a/flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/metadata/FlinkRelMdDistinctRowCount.scala b/flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/metadata/FlinkRelMdDistinctRowCount.scala
index d0738920e5c..99e290c59c7 100644
--- a/flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/metadata/FlinkRelMdDistinctRowCount.scala
+++ b/flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/metadata/FlinkRelMdDistinctRowCount.scala
@@ -98,7 +98,7 @@ class FlinkRelMdDistinctRowCount private extends MetadataHandler[BuiltInMetadata
     val selectivity = RelMdUtil.guessSelectivity(predicate)
     val rowCount = mq.getRowCount(rel)
     val nRows = rowCount / 2
-    RelMdUtil.numDistinctVals(nRows, nRows * selectivity)
+    FlinkRelMdUtil.numDistinctVals(nRows, nRows * selectivity)
   }
 
   def getDistinctRowCount(
@@ -191,7 +191,7 @@ class FlinkRelMdDistinctRowCount private extends MetadataHandler[BuiltInMetadata
       distinctRowCount *= subRowCount
     }
     val rowCount = mq.getRowCount(rel)
-    RelMdUtil.numDistinctVals(distinctRowCount, rowCount)
+    FlinkRelMdUtil.numDistinctVals(distinctRowCount, rowCount)
   }
 
   def getDistinctRowCount(
diff --git a/flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/metadata/FlinkRelMdPopulationSize.scala b/flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/metadata/FlinkRelMdPopulationSize.scala
index 800fec6cd0c..e61c94b28cc 100644
--- a/flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/metadata/FlinkRelMdPopulationSize.scala
+++ b/flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/metadata/FlinkRelMdPopulationSize.scala
@@ -94,7 +94,7 @@ class FlinkRelMdPopulationSize private extends MetadataHandler[BuiltInMetadata.P
     // numDistinctVals.  This is needed; otherwise, population can be
     // larger than the number of rows in the RelNode.
     val rowCount = mq.getRowCount(rel)
-    RelMdUtil.numDistinctVals(population, rowCount)
+    FlinkRelMdUtil.numDistinctVals(population, rowCount)
   }
 
   def getPopulationSize(
@@ -136,7 +136,7 @@ class FlinkRelMdPopulationSize private extends MetadataHandler[BuiltInMetadata.P
     // numDistinctVals.  This is needed; otherwise, population can be
     // larger than the number of rows in the RelNode.
     val rowCount = mq.getRowCount(rel)
-    RelMdUtil.numDistinctVals(population, rowCount)
+    FlinkRelMdUtil.numDistinctVals(population, rowCount)
   }
 
   def getPopulationSize(
diff --git a/flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/utils/FlinkRelMdUtil.scala b/flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/utils/FlinkRelMdUtil.scala
index c121a8478d9..6012ffa5f62 100644
--- a/flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/utils/FlinkRelMdUtil.scala
+++ b/flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/utils/FlinkRelMdUtil.scala
@@ -222,6 +222,32 @@ object FlinkRelMdUtil {
     RexUtil.composeConjunction(rexBuilder, pushable, true)
   }
 
+  /**
+   * Returns the number of distinct values provided numSelected are selected
+   * where there are domainSize distinct values.
+   *
+   * <p>Current implementation of RelMdUtil#numDistinctVals in Calcite 1.26
+   * has precision problem, so we treat small and large inputs differently
+   * here and handle large inputs with the old implementation of
+   * RelMdUtil#numDistinctVals in Calcite 1.22.
+   *
+   * <p>This method should be removed once CALCITE-4351 is fixed. See CALCITE-4351
+   * and FLINK-19780.
+   */
+  def numDistinctVals(domainSize: Double, numSelected: Double): Double = {
+    val EPS = 1e-9
+    if (Math.abs(1 / domainSize) < EPS) {
+      // ln(1+x) ~= x for small x
+      val dSize = RelMdUtil.capInfinity(domainSize)
+      val numSel = RelMdUtil.capInfinity(numSelected)
+      val res = if (dSize > 0) (1.0 - Math.exp(-1 * numSel / dSize)) * dSize else 0
+      // fix the boundary cases
+      Math.max(0, Math.min(res, Math.min(dSize, numSel)))
+    } else {
+      RelMdUtil.numDistinctVals(domainSize, numSelected)
+    }
+  }
+
   /**
     * Estimates outputRowCount of local aggregate.
     *
@@ -653,12 +679,12 @@ object FlinkRelMdUtil {
       if (distinctRowCount == null) {
         null
       } else {
-        RelMdUtil.numDistinctVals(distinctRowCount, mq.getAverageRowSize(calc))
+        FlinkRelMdUtil.numDistinctVals(distinctRowCount, mq.getAverageRowSize(calc))
       }
     }
 
     override def visitLiteral(literal: RexLiteral): JDouble = {
-      RelMdUtil.numDistinctVals(1D, mq.getAverageRowSize(calc))
+      FlinkRelMdUtil.numDistinctVals(1D, mq.getAverageRowSize(calc))
     }
 
     override def visitCall(call: RexCall): JDouble = {
@@ -733,7 +759,7 @@ object FlinkRelMdUtil {
       if (distinctRowCount == null) {
         null
       } else {
-        RelMdUtil.numDistinctVals(distinctRowCount, rowCount)
+        FlinkRelMdUtil.numDistinctVals(distinctRowCount, rowCount)
       }
     }
 
diff --git a/flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/metadata/FlinkRelMdDistinctRowCountTest.scala b/flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/metadata/FlinkRelMdDistinctRowCountTest.scala
index d42741a082d..a698b129ad3 100644
--- a/flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/metadata/FlinkRelMdDistinctRowCountTest.scala
+++ b/flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/metadata/FlinkRelMdDistinctRowCountTest.scala
@@ -75,10 +75,10 @@ class FlinkRelMdDistinctRowCountTest extends FlinkRelMdHandlerTestBase {
   def testGetDistinctRowCountOnValues(): Unit = {
     assertEquals(1.0, mq.getDistinctRowCount(logicalValues, ImmutableBitSet.of(), null))
     (0 until logicalValues.getRowType.getFieldCount).foreach { idx =>
-      assertEquals(RelMdUtil.numDistinctVals(2.0, 2.0),
+      assertEquals(FlinkRelMdUtil.numDistinctVals(2.0, 2.0),
         mq.getDistinctRowCount(logicalValues, ImmutableBitSet.of(idx), null))
     }
-    assertEquals(RelMdUtil.numDistinctVals(2.0, 2.0),
+    assertEquals(FlinkRelMdUtil.numDistinctVals(2.0, 2.0),
       mq.getDistinctRowCount(logicalValues, ImmutableBitSet.of(0, 1), null))
 
     (0 until logicalValues.getRowType.getFieldCount).foreach { idx =>
@@ -660,4 +660,19 @@ class FlinkRelMdDistinctRowCountTest extends FlinkRelMdHandlerTestBase {
     assertEquals(null, mq.getDistinctRowCount(testRel, ImmutableBitSet.of(0), null))
   }
 
+  @Test
+  def testGetDistinctRowCountOnLargeDomainSize(): Unit = {
+    relBuilder.clear()
+    val rel = relBuilder
+      .scan("MyTable1")
+      .project(
+        relBuilder.field(0),
+        relBuilder.field(1),
+        relBuilder.call(SUBSTRING, relBuilder.field(3), relBuilder.literal(10)))
+      .build()
+    assertEquals(
+      7.999999964933156E8,
+      mq.getDistinctRowCount(rel, ImmutableBitSet.of(0, 1, 2), null),
+      1e-2)
+  }
 }
diff --git a/flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/metadata/FlinkRelMdPopulationSizeTest.scala b/flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/metadata/FlinkRelMdPopulationSizeTest.scala
index c2b56127d18..db79714cc03 100644
--- a/flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/metadata/FlinkRelMdPopulationSizeTest.scala
+++ b/flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/metadata/FlinkRelMdPopulationSizeTest.scala
@@ -20,6 +20,7 @@ package org.apache.flink.table.planner.plan.metadata
 
 import org.apache.flink.table.planner.plan.nodes.physical.batch.BatchExecRank
 
+import org.apache.calcite.sql.fun.SqlStdOperatorTable
 import org.apache.calcite.util.ImmutableBitSet
 import org.junit.Assert._
 import org.junit.Test
@@ -362,6 +363,21 @@ class FlinkRelMdPopulationSizeTest extends FlinkRelMdHandlerTestBase {
   def testGetPopulationSizeOnDefault(): Unit = {
     assertNull(mq.getPopulationSize(testRel, ImmutableBitSet.of()))
     assertNull(mq.getPopulationSize(testRel, ImmutableBitSet.of(1)))
+  }
 
+  @Test
+  def testGetPopulationSizeOnLargeDomainSize(): Unit = {
+    relBuilder.clear()
+    val rel = relBuilder
+      .scan("MyTable1")
+      .project(
+        relBuilder.field(0),
+        relBuilder.field(1),
+        relBuilder.call(SqlStdOperatorTable.SUBSTRING, relBuilder.field(3), relBuilder.literal(10)))
+      .build()
+    assertEquals(
+      7.999999964933156E8,
+      mq.getPopulationSize(rel, ImmutableBitSet.of(0, 1, 2)),
+      1e-2)
   }
 }
diff --git a/flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/utils/FlinkRelMdUtilTest.scala b/flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/utils/FlinkRelMdUtilTest.scala
new file mode 100644
index 00000000000..cd3949252b6
--- /dev/null
+++ b/flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/utils/FlinkRelMdUtilTest.scala
@@ -0,0 +1,41 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.flink.table.planner.plan.utils
+
+import org.apache.calcite.rel.metadata.RelMdUtil
+import org.junit.{Assert, Test}
+
+class FlinkRelMdUtilTest {
+
+  @Test
+  def testNumDistinctValsWithSmallInputs(): Unit = {
+    Assert.assertEquals(
+      RelMdUtil.numDistinctVals(1e5, 1e4),
+      FlinkRelMdUtil.numDistinctVals(1e5, 1e4))
+  }
+
+  @Test
+  def testNumDistinctValsWithLargeInputs(): Unit = {
+    Assert.assertNotEquals(0.0, FlinkRelMdUtil.numDistinctVals(1e18, 1e10))
+    // this test will fail once CALCITE-4351 is fixed
+    // in that case FlinkRelMdUtil#numDistinctVals should be removed
+    // see FLINK-19780
+    Assert.assertEquals(0.0, RelMdUtil.numDistinctVals(1e18, 1e10))
+  }
+}
