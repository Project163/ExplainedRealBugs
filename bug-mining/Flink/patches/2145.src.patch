diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironment.java b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironment.java
index 861cf35423d..2fdddb591e1 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironment.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/MockEnvironment.java
@@ -63,6 +63,7 @@ import java.util.List;
 import java.util.Map;
 import java.util.concurrent.Future;
 
+import static org.apache.flink.util.Preconditions.checkState;
 import static org.junit.Assert.fail;
 import static org.mockito.Matchers.any;
 import static org.mockito.Matchers.anyInt;
@@ -70,7 +71,10 @@ import static org.mockito.Mockito.doAnswer;
 import static org.mockito.Mockito.mock;
 import static org.mockito.Mockito.when;
 
-public class MockEnvironment implements Environment {
+/**
+ * IMPORTANT! Remember to close environment after usage!
+ */
+public class MockEnvironment implements Environment, AutoCloseable {
 	
 	private final TaskInfo taskInfo;
 	
@@ -376,4 +380,17 @@ public class MockEnvironment implements Environment {
 	public void failExternally(Throwable cause) {
 		throw new UnsupportedOperationException("MockEnvironment does not support external task failure.");
 	}
+
+	@Override
+	public void close() {
+		// close() method should be idempotent and calling memManager.verifyEmpty() will throw after it was shutdown.
+		if (!memManager.isShutdown()) {
+			checkState(memManager.verifyEmpty(), "Memory Manager managed memory was not completely freed.");
+		}
+
+		memManager.shutdown();
+		ioManager.shutdown();
+
+		checkState(ioManager.isProperlyShutDown(), "IO Manager has not properly shut down.");
+	}
 }
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/TaskTestBase.java b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/TaskTestBase.java
index 53d75b35c2e..8d198d89b2d 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/TaskTestBase.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/operators/testutils/TaskTestBase.java
@@ -23,7 +23,6 @@ import org.apache.flink.api.common.io.DelimitedInputFormat;
 import org.apache.flink.api.common.io.FileOutputFormat;
 import org.apache.flink.api.common.operators.util.UserCodeClassWrapper;
 import org.apache.flink.api.common.operators.util.UserCodeObjectWrapper;
-import org.apache.flink.runtime.testutils.recordutils.RecordSerializerFactory;
 import org.apache.flink.configuration.Configuration;
 import org.apache.flink.core.fs.FileSystem.WriteMode;
 import org.apache.flink.core.fs.Path;
@@ -33,12 +32,13 @@ import org.apache.flink.runtime.memory.MemoryManager;
 import org.apache.flink.runtime.operators.Driver;
 import org.apache.flink.runtime.operators.shipping.ShipStrategyType;
 import org.apache.flink.runtime.operators.util.TaskConfig;
+import org.apache.flink.runtime.testutils.recordutils.RecordSerializerFactory;
 import org.apache.flink.types.Record;
 import org.apache.flink.util.InstantiationUtil;
 import org.apache.flink.util.MutableObjectIterator;
 import org.apache.flink.util.TestLogger;
+
 import org.junit.After;
-import org.junit.Assert;
 
 import java.util.List;
 
@@ -145,19 +145,7 @@ public abstract class TaskTestBase extends TestLogger {
 	}
 
 	@After
-	public void shutdownIOManager() throws Exception {
-		this.mockEnv.getIOManager().shutdown();
-		Assert.assertTrue("IO Manager has not properly shut down.", this.mockEnv.getIOManager().isProperlyShutDown());
-	}
-
-	@After
-	public void shutdownMemoryManager() throws Exception {
-		if (this.memorySize > 0) {
-			MemoryManager memMan = getMemoryManager();
-			if (memMan != null) {
-				Assert.assertTrue("Memory Manager managed memory was not completely freed.", memMan.verifyEmpty());
-				memMan.shutdown();
-			}
-		}
+	public void shutdown() {
+		mockEnv.close();
 	}
 }
diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/InputFormatSourceFunctionTest.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/InputFormatSourceFunctionTest.java
index b99119edbeb..82d11db2301 100644
--- a/flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/InputFormatSourceFunctionTest.java
+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/InputFormatSourceFunctionTest.java
@@ -28,6 +28,7 @@ import org.apache.flink.core.io.InputSplit;
 import org.apache.flink.core.io.InputSplitAssigner;
 import org.apache.flink.metrics.MetricGroup;
 import org.apache.flink.metrics.groups.UnregisteredMetricsGroup;
+import org.apache.flink.runtime.execution.Environment;
 import org.apache.flink.runtime.jobgraph.tasks.InputSplitProvider;
 import org.apache.flink.runtime.memory.MemoryManager;
 import org.apache.flink.runtime.operators.testutils.MockEnvironment;
@@ -63,26 +64,29 @@ public class InputFormatSourceFunctionTest {
 
 		final LifeCycleTestInputFormat format = new LifeCycleTestInputFormat();
 		final InputFormatSourceFunction<Integer> reader = new InputFormatSourceFunction<>(format, TypeInformation.of(Integer.class));
-		reader.setRuntimeContext(new MockRuntimeContext(format, noOfSplits));
 
-		Assert.assertTrue(!format.isConfigured);
-		Assert.assertTrue(!format.isInputFormatOpen);
-		Assert.assertTrue(!format.isSplitOpen);
+		try (MockEnvironment environment = new MockEnvironment("no", 4 * MemoryManager.DEFAULT_PAGE_SIZE, null, 16)) {
+			reader.setRuntimeContext(new MockRuntimeContext(format, noOfSplits, environment));
 
-		reader.open(new Configuration());
-		Assert.assertTrue(format.isConfigured);
+			Assert.assertTrue(!format.isConfigured);
+			Assert.assertTrue(!format.isInputFormatOpen);
+			Assert.assertTrue(!format.isSplitOpen);
 
-		TestSourceContext ctx = new TestSourceContext(reader, format, midCancel, cancelAt);
-		reader.run(ctx);
+			reader.open(new Configuration());
+			Assert.assertTrue(format.isConfigured);
 
-		int splitsSeen = ctx.getSplitsSeen();
-		Assert.assertTrue(midCancel ? splitsSeen == cancelAt : splitsSeen == noOfSplits);
+			TestSourceContext ctx = new TestSourceContext(reader, format, midCancel, cancelAt);
+			reader.run(ctx);
 
-		// we have exhausted the splits so the
-		// format and splits should be closed by now
+			int splitsSeen = ctx.getSplitsSeen();
+			Assert.assertTrue(midCancel ? splitsSeen == cancelAt : splitsSeen == noOfSplits);
 
-		Assert.assertTrue(!format.isSplitOpen);
-		Assert.assertTrue(!format.isInputFormatOpen);
+			// we have exhausted the splits so the
+			// format and splits should be closed by now
+
+			Assert.assertTrue(!format.isSplitOpen);
+			Assert.assertTrue(!format.isInputFormatOpen);
+		}
 	}
 
 	private static class LifeCycleTestInputFormat extends RichInputFormat<Integer, InputSplit> {
@@ -255,10 +259,9 @@ public class InputFormatSourceFunctionTest {
 		private final LifeCycleTestInputFormat format;
 		private InputSplit[] inputSplits;
 
-		private MockRuntimeContext(LifeCycleTestInputFormat format, int noOfSplits) {
-
+		private MockRuntimeContext(LifeCycleTestInputFormat format, int noOfSplits, Environment environment) {
 			super(new MockStreamOperator(),
-				new MockEnvironment("no", 4 * MemoryManager.DEFAULT_PAGE_SIZE, null, 16),
+				environment,
 				Collections.<String, Accumulator<?, ?>>emptyMap());
 
 			this.noOfSplits = noOfSplits;
diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/operators/StreamOperatorChainingTest.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/operators/StreamOperatorChainingTest.java
index 8d99acdf64f..b2373739a74 100644
--- a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/operators/StreamOperatorChainingTest.java
+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/operators/StreamOperatorChainingTest.java
@@ -147,25 +147,30 @@ public class StreamOperatorChainingTest {
 		StreamMap<Integer, Integer> headOperator =
 				streamConfig.getStreamOperator(Thread.currentThread().getContextClassLoader());
 
-		StreamTask<Integer, StreamMap<Integer, Integer>> mockTask =
-				createMockTask(streamConfig, chainedVertex.getName());
+		try (MockEnvironment environment = createMockEnvironment(chainedVertex.getName())) {
+			StreamTask<Integer, StreamMap<Integer, Integer>> mockTask = createMockTask(streamConfig, environment);
 
-		OperatorChain<Integer, StreamMap<Integer, Integer>> operatorChain = new OperatorChain<>(mockTask);
+			OperatorChain<Integer, StreamMap<Integer, Integer>> operatorChain = new OperatorChain<>(mockTask);
 
-		headOperator.setup(mockTask, streamConfig, operatorChain.getChainEntryPoint());
+			headOperator.setup(mockTask, streamConfig, operatorChain.getChainEntryPoint());
 
-		for (StreamOperator<?> operator : operatorChain.getAllOperators()) {
-			if (operator != null) {
-				operator.open();
+			for (StreamOperator<?> operator : operatorChain.getAllOperators()) {
+				if (operator != null) {
+					operator.open();
+				}
 			}
-		}
 
-		headOperator.processElement(new StreamRecord<>(1));
-		headOperator.processElement(new StreamRecord<>(2));
-		headOperator.processElement(new StreamRecord<>(3));
+			headOperator.processElement(new StreamRecord<>(1));
+			headOperator.processElement(new StreamRecord<>(2));
+			headOperator.processElement(new StreamRecord<>(3));
+
+			assertThat(sink1Results, contains("First: 1", "First: 2", "First: 3"));
+			assertThat(sink2Results, contains("Second: 1", "Second: 2", "Second: 3"));
+		}
+	}
 
-		assertThat(sink1Results, contains("First: 1", "First: 2", "First: 3"));
-		assertThat(sink2Results, contains("Second: 1", "Second: 2", "Second: 3"));
+	private MockEnvironment createMockEnvironment(String taskName) {
+		return new MockEnvironment(taskName, 3 * 1024 * 1024, new MockInputSplitProvider(), 1024);
 	}
 
 	@Test
@@ -287,38 +292,40 @@ public class StreamOperatorChainingTest {
 		StreamMap<Integer, Integer> headOperator =
 				streamConfig.getStreamOperator(Thread.currentThread().getContextClassLoader());
 
-		StreamTask<Integer, StreamMap<Integer, Integer>> mockTask =
-				createMockTask(streamConfig, chainedVertex.getName());
+		try (MockEnvironment environment = createMockEnvironment(chainedVertex.getName())) {
+			StreamTask<Integer, StreamMap<Integer, Integer>> mockTask = createMockTask(streamConfig, environment);
 
-		OperatorChain<Integer, StreamMap<Integer, Integer>> operatorChain = new OperatorChain<>(mockTask);
+			OperatorChain<Integer, StreamMap<Integer, Integer>> operatorChain = new OperatorChain<>(mockTask);
 
-		headOperator.setup(mockTask, streamConfig, operatorChain.getChainEntryPoint());
+			headOperator.setup(mockTask, streamConfig, operatorChain.getChainEntryPoint());
 
-		for (StreamOperator<?> operator : operatorChain.getAllOperators()) {
-			if (operator != null) {
-				operator.open();
+			for (StreamOperator<?> operator : operatorChain.getAllOperators()) {
+				if (operator != null) {
+					operator.open();
+				}
 			}
-		}
 
-		headOperator.processElement(new StreamRecord<>(1));
-		headOperator.processElement(new StreamRecord<>(2));
-		headOperator.processElement(new StreamRecord<>(3));
+			headOperator.processElement(new StreamRecord<>(1));
+			headOperator.processElement(new StreamRecord<>(2));
+			headOperator.processElement(new StreamRecord<>(3));
 
-		assertThat(sink1Results, contains("First 1: 1"));
-		assertThat(sink2Results, contains("First 2: 1"));
-		assertThat(sink3Results, contains("Second: 2", "Second: 3"));
+			assertThat(sink1Results, contains("First 1: 1"));
+			assertThat(sink2Results, contains("First 2: 1"));
+			assertThat(sink3Results, contains("Second: 2", "Second: 3"));
+		}
 	}
 
-	private <IN, OT extends StreamOperator<IN>> StreamTask<IN, OT> createMockTask(StreamConfig streamConfig, String taskName) {
+	private <IN, OT extends StreamOperator<IN>> StreamTask<IN, OT> createMockTask(
+			StreamConfig streamConfig,
+			Environment environment) {
 		final Object checkpointLock = new Object();
-		final Environment env = new MockEnvironment(taskName, 3 * 1024 * 1024, new MockInputSplitProvider(), 1024);
 
 		@SuppressWarnings("unchecked")
 		StreamTask<IN, OT> mockTask = mock(StreamTask.class);
 		when(mockTask.getName()).thenReturn("Mock Task");
 		when(mockTask.getCheckpointLock()).thenReturn(checkpointLock);
 		when(mockTask.getConfiguration()).thenReturn(streamConfig);
-		when(mockTask.getEnvironment()).thenReturn(env);
+		when(mockTask.getEnvironment()).thenReturn(environment);
 		when(mockTask.getExecutionConfig()).thenReturn(new ExecutionConfig().enableObjectReuse());
 
 		return mockTask;
diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/operators/windowing/WindowOperatorTest.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/operators/windowing/WindowOperatorTest.java
index 2fa1c3cdd2e..c03207e7f16 100644
--- a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/operators/windowing/WindowOperatorTest.java
+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/operators/windowing/WindowOperatorTest.java
@@ -35,6 +35,7 @@ import org.apache.flink.streaming.api.functions.windowing.PassThroughWindowFunct
 import org.apache.flink.streaming.api.functions.windowing.ProcessWindowFunction;
 import org.apache.flink.streaming.api.functions.windowing.RichWindowFunction;
 import org.apache.flink.streaming.api.functions.windowing.WindowFunction;
+import org.apache.flink.streaming.api.operators.OneInputStreamOperator;
 import org.apache.flink.streaming.api.watermark.Watermark;
 import org.apache.flink.streaming.api.windowing.assigners.EventTimeSessionWindows;
 import org.apache.flink.streaming.api.windowing.assigners.GlobalWindows;
@@ -98,7 +99,13 @@ public class WindowOperatorTest extends TestLogger {
 	// late arriving event OutputTag<StreamRecord<IN>>
 	private static final OutputTag<Tuple2<String, Integer>> lateOutputTag = new OutputTag<Tuple2<String, Integer>>("late-output") {};
 
-	private void testSlidingEventTimeWindows(OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness) throws Exception {
+	private void testSlidingEventTimeWindows(OneInputStreamOperator<Tuple2<String, Integer>, Tuple2<String, Integer>> operator) throws Exception {
+
+		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
+			createTestHarness(operator);
+
+		testHarness.setup();
+		testHarness.open();
 
 		ConcurrentLinkedQueue<Object> expectedOutput = new ConcurrentLinkedQueue<>();
 
@@ -134,6 +141,9 @@ public class WindowOperatorTest extends TestLogger {
 		// do a snapshot, close and restore again
 		OperatorStateHandles snapshot = testHarness.snapshot(0L, 0L);
 		testHarness.close();
+
+		expectedOutput.clear();
+		testHarness = createTestHarness(operator);
 		testHarness.setup();
 		testHarness.initializeState(snapshot);
 		testHarness.open();
@@ -160,6 +170,8 @@ public class WindowOperatorTest extends TestLogger {
 		expectedOutput.add(new Watermark(7999));
 
 		TestHarnessUtil.assertOutputEqualsSorted("Output was not correct.", expectedOutput, testHarness.getOutput(), new Tuple2ResultSortComparator());
+
+		testHarness.close();
 	}
 
 	@Test
@@ -187,15 +199,7 @@ public class WindowOperatorTest extends TestLogger {
 				0,
 				null /* late data output tag */);
 
-		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-				new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
-
-		testHarness.setup();
-		testHarness.open();
-
-		testSlidingEventTimeWindows(testHarness);
-
-		testHarness.close();
+		testSlidingEventTimeWindows(operator);
 	}
 
 	@Test
@@ -222,20 +226,16 @@ public class WindowOperatorTest extends TestLogger {
 				0,
 				null /* late data output tag */);
 
-		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-				new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
-
-		testHarness.open();
-
-		testSlidingEventTimeWindows(testHarness);
-
-		testHarness.close();
+		testSlidingEventTimeWindows(operator);
 
 		// we close once in the rest...
 		Assert.assertEquals("Close was not called.", 2, closeCalled.get());
 	}
 
-	private void testTumblingEventTimeWindows(OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness) throws Exception {
+	private void testTumblingEventTimeWindows(OneInputStreamOperator<Tuple2<String, Integer>, Tuple2<String, Integer>> operator) throws Exception {
+		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
+			createTestHarness(operator);
+
 		ConcurrentLinkedQueue<Object> expectedOutput = new ConcurrentLinkedQueue<>();
 
 		testHarness.open();
@@ -262,7 +262,11 @@ public class WindowOperatorTest extends TestLogger {
 
 		// do a snapshot, close and restore again
 		OperatorStateHandles snapshot = testHarness.snapshot(0L, 0L);
+		TestHarnessUtil.assertOutputEqualsSorted("Output was not correct.", expectedOutput, testHarness.getOutput(), new Tuple2ResultSortComparator());
 		testHarness.close();
+
+		testHarness = createTestHarness(operator);
+		expectedOutput.clear();
 		testHarness.setup();
 		testHarness.initializeState(snapshot);
 		testHarness.open();
@@ -293,6 +297,8 @@ public class WindowOperatorTest extends TestLogger {
 		expectedOutput.add(new Watermark(7999));
 
 		TestHarnessUtil.assertOutputEqualsSorted("Output was not correct.", expectedOutput, testHarness.getOutput(), new Tuple2ResultSortComparator());
+
+		testHarness.close();
 	}
 
 	@Test
@@ -319,14 +325,7 @@ public class WindowOperatorTest extends TestLogger {
 				0,
 				null /* late data output tag */);
 
-		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-				new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
-
-		testHarness.open();
-
-		testTumblingEventTimeWindows(testHarness);
-
-		testHarness.close();
+		testTumblingEventTimeWindows(operator);
 	}
 
 	@Test
@@ -352,14 +351,7 @@ public class WindowOperatorTest extends TestLogger {
 				0,
 				null /* late data output tag */);
 
-		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-				new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
-
-		testHarness.open();
-
-		testTumblingEventTimeWindows(testHarness);
-
-		testHarness.close();
+		testTumblingEventTimeWindows(operator);
 
 		// we close once in the rest...
 		Assert.assertEquals("Close was not called.", 2, closeCalled.get());
@@ -389,7 +381,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple3<String, Long, Long>> testHarness =
-				new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+				createTestHarness(operator);
 
 		ConcurrentLinkedQueue<Object> expectedOutput = new ConcurrentLinkedQueue<>();
 
@@ -405,7 +397,12 @@ public class WindowOperatorTest extends TestLogger {
 
 		// do a snapshot, close and restore again
 		OperatorStateHandles snapshot = testHarness.snapshot(0L, 0L);
+
+		TestHarnessUtil.assertOutputEqualsSorted("Output was not correct.", expectedOutput, testHarness.getOutput(), new Tuple3ResultSortComparator());
+
 		testHarness.close();
+
+		testHarness = createTestHarness(operator);
 		testHarness.setup();
 		testHarness.initializeState(snapshot);
 		testHarness.open();
@@ -462,7 +459,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple3<String, Long, Long>> testHarness =
-				new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+				createTestHarness(operator);
 
 		ConcurrentLinkedQueue<Object> expectedOutput = new ConcurrentLinkedQueue<>();
 
@@ -478,7 +475,12 @@ public class WindowOperatorTest extends TestLogger {
 
 		// do a snapshot, close and restore again
 		OperatorStateHandles snapshot = testHarness.snapshot(0L, 0L);
+
+		TestHarnessUtil.assertOutputEqualsSorted("Output was not correct.", expectedOutput, testHarness.getOutput(), new Tuple3ResultSortComparator());
+
 		testHarness.close();
+
+		testHarness = createTestHarness(operator);
 		testHarness.setup();
 		testHarness.initializeState(snapshot);
 		testHarness.open();
@@ -535,7 +537,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple3<String, Long, Long>> testHarness =
-				new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+				createTestHarness(operator);
 
 		ConcurrentLinkedQueue<Object> expectedOutput = new ConcurrentLinkedQueue<>();
 
@@ -549,6 +551,8 @@ public class WindowOperatorTest extends TestLogger {
 		// do a snapshot, close and restore again
 		OperatorStateHandles snapshot = testHarness.snapshot(0L, 0L);
 		testHarness.close();
+
+		testHarness = createTestHarness(operator);
 		testHarness.setup();
 		testHarness.initializeState(snapshot);
 		testHarness.open();
@@ -606,7 +610,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple3<String, Long, Long>> testHarness =
-				new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+				createTestHarness(operator);
 
 		ConcurrentLinkedQueue<Object> expectedOutput = new ConcurrentLinkedQueue<>();
 
@@ -620,6 +624,8 @@ public class WindowOperatorTest extends TestLogger {
 		// do a snapshot, close and restore again
 		OperatorStateHandles snapshot = testHarness.snapshot(0L, 0L);
 		testHarness.close();
+
+		testHarness = createTestHarness(operator);
 		testHarness.setup();
 		testHarness.initializeState(snapshot);
 		testHarness.open();
@@ -681,7 +687,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple3<String, Long, Long>> testHarness =
-				new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+				createTestHarness(operator);
 
 		ConcurrentLinkedQueue<Object> expectedOutput = new ConcurrentLinkedQueue<>();
 
@@ -699,6 +705,12 @@ public class WindowOperatorTest extends TestLogger {
 		// do a snapshot, close and restore again
 		OperatorStateHandles snapshot = testHarness.snapshot(0L, 0L);
 		testHarness.close();
+
+		expectedOutput.add(new StreamRecord<>(new Tuple3<>("key2-10", 0L, 6500L), 6499));
+		TestHarnessUtil.assertOutputEqualsSorted("Output was not correct.", expectedOutput, testHarness.getOutput(), new Tuple3ResultSortComparator());
+		expectedOutput.clear();
+
+		testHarness = createTestHarness(operator);
 		testHarness.setup();
 		testHarness.initializeState(snapshot);
 		testHarness.open();
@@ -709,8 +721,6 @@ public class WindowOperatorTest extends TestLogger {
 		testHarness.processElement(new StreamRecord<>(new Tuple2<>("key1", 2), 6500));
 		testHarness.processElement(new StreamRecord<>(new Tuple2<>("key1", 3), 7000));
 
-		expectedOutput.add(new StreamRecord<>(new Tuple3<>("key2-10", 0L, 6500L), 6499));
-
 		TestHarnessUtil.assertOutputEqualsSorted("Output was not correct.", expectedOutput, testHarness.getOutput(), new Tuple3ResultSortComparator());
 
 		// add an element that merges the two "key1" sessions, they should now have count 6, and therefore fire
@@ -751,7 +761,7 @@ public class WindowOperatorTest extends TestLogger {
 			null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple3<String, Long, Long>> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		ConcurrentLinkedQueue<Object> expectedOutput = new ConcurrentLinkedQueue<>();
 
@@ -776,7 +786,13 @@ public class WindowOperatorTest extends TestLogger {
 
 		// do a snapshot, close and restore again
 		OperatorStateHandles snapshot = testHarness.snapshot(0L, 0L);
+
+		TestHarnessUtil.assertOutputEqualsSorted("Output was not correct.", expectedOutput, testHarness.getOutput(), new Tuple3ResultSortComparator());
+
 		testHarness.close();
+
+		expectedOutput.clear();
+		testHarness = createTestHarness(operator);
 		testHarness.setup();
 		testHarness.initializeState(snapshot);
 		testHarness.open();
@@ -823,39 +839,45 @@ public class WindowOperatorTest extends TestLogger {
 				0,
 				null /* late data output tag */);
 
-		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple3<String, Long, Long>> testHarness =
-				new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
-
 		ConcurrentLinkedQueue<Object> expectedOutput = new ConcurrentLinkedQueue<>();
+		OperatorStateHandles snapshot;
 
-		testHarness.open();
+		try (OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple3<String, Long, Long>> testHarness =
+				createTestHarness(operator)) {
+			testHarness.open();
 
-		// add elements out-of-order
-		testHarness.processElement(new StreamRecord<>(new Tuple2<>("key2", 1), 0));
-		testHarness.processElement(new StreamRecord<>(new Tuple2<>("key2", 33), 1000));
+			// add elements out-of-order
+			testHarness.processElement(new StreamRecord<>(new Tuple2<>("key2", 1), 0));
+			testHarness.processElement(new StreamRecord<>(new Tuple2<>("key2", 33), 1000));
 
-		// do a snapshot, close and restore again
-		OperatorStateHandles snapshot = testHarness.snapshot(0L, 0L);
-		testHarness.close();
-		testHarness.setup();
-		testHarness.initializeState(snapshot);
-		testHarness.open();
+			// do a snapshot, close and restore again
+			snapshot = testHarness.snapshot(0L, 0L);
+		}
 
-		testHarness.processElement(new StreamRecord<>(new Tuple2<>("key2", 33), 2500));
+		try (OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple3<String, Long, Long>> testHarness =
+				createTestHarness(operator)) {
+			testHarness.setup();
+			testHarness.initializeState(snapshot);
+			testHarness.open();
 
-		testHarness.processElement(new StreamRecord<>(new Tuple2<>("key1", 1), 10));
-		testHarness.processElement(new StreamRecord<>(new Tuple2<>("key1", 2), 1000));
-		testHarness.processElement(new StreamRecord<>(new Tuple2<>("key1", 33), 2500));
+			testHarness.processElement(new StreamRecord<>(new Tuple2<>("key2", 33), 2500));
 
-		testHarness.processWatermark(new Watermark(12000));
+			testHarness.processElement(new StreamRecord<>(new Tuple2<>("key1", 1), 10));
+			testHarness.processElement(new StreamRecord<>(new Tuple2<>("key1", 2), 1000));
+			testHarness.processElement(new StreamRecord<>(new Tuple2<>("key1", 33), 2500));
 
-		expectedOutput.add(new StreamRecord<>(new Tuple3<>("key1-36", 10L, 4000L), 3999));
-		expectedOutput.add(new StreamRecord<>(new Tuple3<>("key2-67", 0L, 3000L), 2999));
-		expectedOutput.add(new Watermark(12000));
+			testHarness.processWatermark(new Watermark(12000));
 
-		TestHarnessUtil.assertOutputEqualsSorted("Output was not correct.", expectedOutput, testHarness.getOutput(), new Tuple3ResultSortComparator());
+			expectedOutput.add(new StreamRecord<>(new Tuple3<>("key1-36", 10L, 4000L), 3999));
+			expectedOutput.add(new StreamRecord<>(new Tuple3<>("key2-67", 0L, 3000L), 2999));
+			expectedOutput.add(new Watermark(12000));
 
-		testHarness.close();
+			TestHarnessUtil.assertOutputEqualsSorted("Output was not correct.", expectedOutput, testHarness.getOutput(), new Tuple3ResultSortComparator());
+		}
+	}
+
+	private static <OUT> OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, OUT> createTestHarness(OneInputStreamOperator<Tuple2<String, Integer>, OUT> operator) throws Exception {
+		return new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
 	}
 
 	@Test
@@ -883,7 +905,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-				new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+				createTestHarness(operator);
 
 		ConcurrentLinkedQueue<Object> expectedOutput = new ConcurrentLinkedQueue<>();
 
@@ -969,7 +991,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-				new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+				createTestHarness(operator);
 
 		ConcurrentLinkedQueue<Object> expectedOutput = new ConcurrentLinkedQueue<>();
 
@@ -1010,7 +1032,7 @@ public class WindowOperatorTest extends TestLogger {
 				0,
 				null /* late data output tag */);
 
-		testHarness = new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+		testHarness = createTestHarness(operator);
 
 		testHarness.setup();
 		testHarness.initializeState(snapshot);
@@ -1058,7 +1080,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-				new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+				createTestHarness(operator);
 
 		ConcurrentLinkedQueue<Object> expectedOutput = new ConcurrentLinkedQueue<>();
 
@@ -1117,7 +1139,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-				new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+				createTestHarness(operator);
 
 		ConcurrentLinkedQueue<Object> expectedOutput = new ConcurrentLinkedQueue<>();
 
@@ -1189,7 +1211,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-				new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+				createTestHarness(operator);
 
 		ConcurrentLinkedQueue<Object> expectedOutput = new ConcurrentLinkedQueue<>();
 
@@ -1255,7 +1277,7 @@ public class WindowOperatorTest extends TestLogger {
 				lateOutputTag);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		testHarness.open();
 
@@ -1325,7 +1347,7 @@ public class WindowOperatorTest extends TestLogger {
 					null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		testHarness.open();
 
@@ -1392,7 +1414,7 @@ public class WindowOperatorTest extends TestLogger {
 				lateOutputTag);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		testHarness.open();
 
@@ -1457,7 +1479,7 @@ public class WindowOperatorTest extends TestLogger {
 				lateOutputTag /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		testHarness.open();
 
@@ -1536,7 +1558,7 @@ public class WindowOperatorTest extends TestLogger {
 				lateOutputTag);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple3<String, Long, Long>> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		testHarness.open();
 
@@ -1628,7 +1650,7 @@ public class WindowOperatorTest extends TestLogger {
 				lateOutputTag);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple3<String, Long, Long>> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		testHarness.open();
 
@@ -1718,7 +1740,7 @@ public class WindowOperatorTest extends TestLogger {
 				lateOutputTag);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple3<String, Long, Long>> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		testHarness.open();
 
@@ -1805,7 +1827,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple3<String, Long, Long>> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		testHarness.open();
 
@@ -1906,7 +1928,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple3<String, Long, Long>> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		testHarness.open();
 
@@ -1997,7 +2019,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple3<String, Long, Long>> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		testHarness.open();
 
@@ -2089,7 +2111,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, String> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		testHarness.open();
 
@@ -2144,7 +2166,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		testHarness.open();
 
@@ -2191,7 +2213,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		testHarness.open();
 
@@ -2249,7 +2271,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		testHarness.open();
 
@@ -2295,7 +2317,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		testHarness.open();
 
@@ -2340,7 +2362,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple3<String, Long, Long>> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		testHarness.open();
 
@@ -2396,7 +2418,7 @@ public class WindowOperatorTest extends TestLogger {
 				null /* late data output tag */);
 
 		OneInputStreamOperatorTestHarness<Tuple2<String, Integer>, Tuple2<String, Integer>> testHarness =
-			new KeyedOneInputStreamOperatorTestHarness<>(operator, new TupleKeySelector(), BasicTypeInfo.STRING_TYPE_INFO);
+			createTestHarness(operator);
 
 		testHarness.open();
 
diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskTest.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskTest.java
index d7a26c34efe..d907df19f47 100644
--- a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskTest.java
+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/tasks/StreamTaskTest.java
@@ -754,43 +754,44 @@ public class StreamTaskTest extends TestLogger {
 		streamConfig.setStreamOperator(new BlockingCloseStreamOperator());
 		streamConfig.setOperatorID(new OperatorID());
 
-		MockEnvironment mockEnvironment = new MockEnvironment(
-			"Test Task",
-			32L * 1024L,
-			new MockInputSplitProvider(),
-			1,
-			taskConfiguration,
-			new ExecutionConfig());
-		StreamTask<Void, BlockingCloseStreamOperator> streamTask = new NoOpStreamTask<>(mockEnvironment);
-		final AtomicReference<Throwable> atomicThrowable = new AtomicReference<>(null);
-
-		CompletableFuture<Void> invokeFuture = CompletableFuture.runAsync(
-			() -> {
-				try {
-					streamTask.invoke();
-				} catch (Exception e) {
-					atomicThrowable.set(e);
-				}
-			},
-			TestingUtils.defaultExecutor());
+		try (MockEnvironment mockEnvironment = new MockEnvironment(
+				"Test Task",
+				32L * 1024L,
+				new MockInputSplitProvider(),
+				1,
+				taskConfiguration,
+				new ExecutionConfig())) {
+			StreamTask<Void, BlockingCloseStreamOperator> streamTask = new NoOpStreamTask<>(mockEnvironment);
+			final AtomicReference<Throwable> atomicThrowable = new AtomicReference<>(null);
+
+			CompletableFuture<Void> invokeFuture = CompletableFuture.runAsync(
+				() -> {
+					try {
+						streamTask.invoke();
+					} catch (Exception e) {
+						atomicThrowable.set(e);
+					}
+				},
+				TestingUtils.defaultExecutor());
 
-		BlockingCloseStreamOperator.IN_CLOSE.await();
+			BlockingCloseStreamOperator.IN_CLOSE.await();
 
-		// check that the StreamTask is not yet in isRunning == false
-		assertTrue(streamTask.isRunning());
+			// check that the StreamTask is not yet in isRunning == false
+			assertTrue(streamTask.isRunning());
 
-		// let the operator finish its close operation
-		BlockingCloseStreamOperator.FINISH_CLOSE.trigger();
+			// let the operator finish its close operation
+			BlockingCloseStreamOperator.FINISH_CLOSE.trigger();
 
-		// wait until the invoke is complete
-		invokeFuture.get();
+			// wait until the invoke is complete
+			invokeFuture.get();
 
-		// now the StreamTask should no longer be running
-		assertFalse(streamTask.isRunning());
+			// now the StreamTask should no longer be running
+			assertFalse(streamTask.isRunning());
 
-		// check if an exception occurred
-		if (atomicThrowable.get() != null) {
-			throw atomicThrowable.get();
+			// check if an exception occurred
+			if (atomicThrowable.get() != null) {
+				throw atomicThrowable.get();
+			}
 		}
 	}
 
diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/util/AbstractStreamOperatorTestHarness.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/util/AbstractStreamOperatorTestHarness.java
index 13f0b3fa59b..66501182d0f 100644
--- a/flink-streaming-java/src/test/java/org/apache/flink/streaming/util/AbstractStreamOperatorTestHarness.java
+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/util/AbstractStreamOperatorTestHarness.java
@@ -71,6 +71,7 @@ import java.util.HashMap;
 import java.util.LinkedList;
 import java.util.List;
 import java.util.Map;
+import java.util.Optional;
 import java.util.concurrent.ConcurrentLinkedQueue;
 
 import static org.mockito.Matchers.any;
@@ -99,6 +100,8 @@ public class AbstractStreamOperatorTestHarness<OUT> implements AutoCloseable {
 
 	final Environment environment;
 
+	private final Optional<MockEnvironment> internalEnvironment;
+
 	CloseableRegistry closableRegistry;
 
 	// use this as default for tests
@@ -118,11 +121,10 @@ public class AbstractStreamOperatorTestHarness<OUT> implements AutoCloseable {
 	private volatile boolean wasFailedExternally = false;
 
 	public AbstractStreamOperatorTestHarness(
-		StreamOperator<OUT> operator,
-		int maxParallelism,
-		int parallelism,
-		int subtaskIndex) throws Exception {
-
+			StreamOperator<OUT> operator,
+			int maxParallelism,
+			int parallelism,
+			int subtaskIndex) throws Exception {
 		this(
 			operator,
 			new MockEnvironment(
@@ -134,12 +136,20 @@ public class AbstractStreamOperatorTestHarness<OUT> implements AutoCloseable {
 				new ExecutionConfig(),
 				maxParallelism,
 				parallelism,
-				subtaskIndex));
+				subtaskIndex),
+			true);
 	}
 
 	public AbstractStreamOperatorTestHarness(
 			StreamOperator<OUT> operator,
 			final Environment environment) throws Exception {
+		this(operator, environment, false);
+	}
+
+	private AbstractStreamOperatorTestHarness(
+			StreamOperator<OUT> operator,
+			final Environment environment,
+			boolean environmentIsInternal) throws Exception {
 		this.operator = operator;
 		this.outputList = new ConcurrentLinkedQueue<>();
 		this.sideOutputLists = new HashMap<>();
@@ -153,6 +163,7 @@ public class AbstractStreamOperatorTestHarness<OUT> implements AutoCloseable {
 		this.checkpointLock = new Object();
 
 		this.environment = Preconditions.checkNotNull(environment);
+		this.internalEnvironment = environmentIsInternal ? Optional.of((MockEnvironment) environment) : Optional.empty();
 
 		mockTask = mock(StreamTask.class);
 		processingTimeService = new TestProcessingTimeService();
@@ -492,6 +503,8 @@ public class AbstractStreamOperatorTestHarness<OUT> implements AutoCloseable {
 			processingTimeService.shutdownService();
 		}
 		setupCalled = false;
+
+		internalEnvironment.ifPresent(MockEnvironment::close);
 	}
 
 	public void setProcessingTime(long time) throws Exception {
diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/util/SourceFunctionUtil.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/util/SourceFunctionUtil.java
index 5f17467f72f..312891e4acc 100644
--- a/flink-streaming-java/src/test/java/org/apache/flink/streaming/util/SourceFunctionUtil.java
+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/util/SourceFunctionUtil.java
@@ -18,7 +18,6 @@
 package org.apache.flink.streaming.util;
 
 import org.apache.flink.api.common.ExecutionConfig;
-import org.apache.flink.api.common.accumulators.Accumulator;
 import org.apache.flink.api.common.functions.RichFunction;
 import org.apache.flink.api.common.functions.RuntimeContext;
 import org.apache.flink.configuration.Configuration;
@@ -42,22 +41,32 @@ import static org.mockito.Mockito.when;
 public class SourceFunctionUtil {
 
 	public static <T extends Serializable> List<T> runSourceFunction(SourceFunction<T> sourceFunction) throws Exception {
-		final List<T> outputs = new ArrayList<T>();
-
 		if (sourceFunction instanceof RichFunction) {
+			return runRichSourceFunction(sourceFunction);
+		}
+		else {
+			return runNonRichSourceFunction(sourceFunction);
+		}
+	}
 
+	private static <T extends Serializable> List<T> runRichSourceFunction(SourceFunction<T> sourceFunction) throws Exception {
+		try (MockEnvironment environment = new MockEnvironment("MockTask", 3 * 1024 * 1024, new MockInputSplitProvider(), 1024)) {
 			AbstractStreamOperator<?> operator = mock(AbstractStreamOperator.class);
 			when(operator.getExecutionConfig()).thenReturn(new ExecutionConfig());
 
-			RuntimeContext runtimeContext =  new StreamingRuntimeContext(
-					operator,
-					new MockEnvironment("MockTask", 3 * 1024 * 1024, new MockInputSplitProvider(), 1024),
-					new HashMap<String, Accumulator<?, ?>>());
-
+			RuntimeContext runtimeContext = new StreamingRuntimeContext(
+				operator,
+				environment,
+				new HashMap<>());
 			((RichFunction) sourceFunction).setRuntimeContext(runtimeContext);
-
 			((RichFunction) sourceFunction).open(new Configuration());
+
+			return runNonRichSourceFunction(sourceFunction);
 		}
+	}
+
+	private static <T extends Serializable> List<T> runNonRichSourceFunction(SourceFunction<T> sourceFunction) {
+		final List<T> outputs = new ArrayList<>();
 		try {
 			SourceFunction.SourceContext<T> ctx = new CollectingSourceContext<T>(new Object(), outputs);
 			sourceFunction.run(ctx);
diff --git a/flink-tests/src/test/java/org/apache/flink/test/typeserializerupgrade/PojoSerializerUpgradeTest.java b/flink-tests/src/test/java/org/apache/flink/test/typeserializerupgrade/PojoSerializerUpgradeTest.java
index 54fe8792c5c..99a9d1f0cc3 100644
--- a/flink-tests/src/test/java/org/apache/flink/test/typeserializerupgrade/PojoSerializerUpgradeTest.java
+++ b/flink-tests/src/test/java/org/apache/flink/test/typeserializerupgrade/PojoSerializerUpgradeTest.java
@@ -350,50 +350,51 @@ public class PojoSerializerUpgradeTest extends TestLogger {
 			OperatorStateHandles operatorStateHandles,
 			Iterable<Long> input) throws Exception {
 
-		final MockEnvironment environment = new MockEnvironment(
-			"test task",
-			32 * 1024,
-			new MockInputSplitProvider(),
-			256,
-			taskConfiguration,
-			executionConfig,
-			16,
-			1,
-			0,
-			classLoader);
-
-		OneInputStreamOperatorTestHarness<Long, Long> harness;
-
-		if (isKeyedState) {
-			harness = new KeyedOneInputStreamOperatorTestHarness<>(
-				operator,
-				keySelector,
-				BasicTypeInfo.LONG_TYPE_INFO,
-				environment);
-		} else {
-			harness = new OneInputStreamOperatorTestHarness<>(operator, LongSerializer.INSTANCE, environment);
-		}
+		try (final MockEnvironment environment = new MockEnvironment(
+				"test task",
+				32 * 1024,
+				new MockInputSplitProvider(),
+				256,
+				taskConfiguration,
+				executionConfig,
+				16,
+				1,
+				0,
+				classLoader)) {
+
+			OneInputStreamOperatorTestHarness<Long, Long> harness;
+
+			if (isKeyedState) {
+				harness = new KeyedOneInputStreamOperatorTestHarness<>(
+					operator,
+					keySelector,
+					BasicTypeInfo.LONG_TYPE_INFO,
+					environment);
+			} else {
+				harness = new OneInputStreamOperatorTestHarness<>(operator, LongSerializer.INSTANCE, environment);
+			}
 
-		harness.setStateBackend(stateBackend);
+			harness.setStateBackend(stateBackend);
 
-		harness.setup();
-		harness.initializeState(operatorStateHandles);
-		harness.open();
+			harness.setup();
+			harness.initializeState(operatorStateHandles);
+			harness.open();
 
-		long timestamp = 0L;
+			long timestamp = 0L;
 
-		for (Long value : input) {
-			harness.processElement(value, timestamp++);
-		}
+			for (Long value : input) {
+				harness.processElement(value, timestamp++);
+			}
 
-		long checkpointId = 1L;
-		long checkpointTimestamp = timestamp + 1L;
+			long checkpointId = 1L;
+			long checkpointTimestamp = timestamp + 1L;
 
-		OperatorStateHandles stateHandles = harness.snapshot(checkpointId, checkpointTimestamp);
+			OperatorStateHandles stateHandles = harness.snapshot(checkpointId, checkpointTimestamp);
 
-		harness.close();
+			harness.close();
 
-		return stateHandles;
+			return stateHandles;
+		}
 	}
 
 	private static File writeSourceFile(File root, String name, String source) throws IOException {
