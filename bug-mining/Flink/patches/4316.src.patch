diff --git a/flink-table/flink-sql-client/src/main/java/org/apache/flink/table/client/gateway/local/LocalExecutor.java b/flink-table/flink-sql-client/src/main/java/org/apache/flink/table/client/gateway/local/LocalExecutor.java
index dbed581f9a2..d4eb405b07f 100644
--- a/flink-table/flink-sql-client/src/main/java/org/apache/flink/table/client/gateway/local/LocalExecutor.java
+++ b/flink-table/flink-sql-client/src/main/java/org/apache/flink/table/client/gateway/local/LocalExecutor.java
@@ -587,13 +587,17 @@ public class LocalExecutor implements Executor {
 		// create execution
 		final ProgramDeployer deployer = new ProgramDeployer(configuration, jobName, pipeline);
 
-		// blocking deployment
-		try {
-			JobClient jobClient = deployer.deploy().get();
-			return ProgramTargetDescriptor.of(jobClient.getJobID());
-		} catch (Exception e) {
-			throw new RuntimeException("Error running SQL job.", e);
-		}
+		// wrap in classloader because CodeGenOperatorFactory#getStreamOperatorClass
+		// requires to access UDF in deployer.deploy().
+		return context.wrapClassLoader(() -> {
+			try {
+				// blocking deployment
+				JobClient jobClient = deployer.deploy().get();
+				return ProgramTargetDescriptor.of(jobClient.getJobID());
+			} catch (Exception e) {
+				throw new RuntimeException("Error running SQL job.", e);
+			}
+		});
 	}
 
 	private <C> ResultDescriptor executeQueryInternal(String sessionId, ExecutionContext<C> context, String query) {
@@ -641,12 +645,16 @@ public class LocalExecutor implements Executor {
 				configuration, jobName, pipeline);
 
 		JobClient jobClient;
-		// blocking deployment
-		try {
-			jobClient = deployer.deploy().get();
-		} catch (Exception e) {
-			throw new SqlExecutionException("Error while submitting job.", e);
-		}
+		// wrap in classloader because CodeGenOperatorFactory#getStreamOperatorClass
+		// requires to access UDF in deployer.deploy().
+		jobClient = context.wrapClassLoader(() -> {
+			try {
+				// blocking deployment
+				return deployer.deploy().get();
+			} catch (Exception e) {
+				throw new SqlExecutionException("Error while submitting job.", e);
+			}
+		});
 
 		String jobId = jobClient.getJobID().toString();
 		// store the result under the JobID
diff --git a/flink-table/flink-sql-client/src/test/java/org/apache/flink/table/client/gateway/local/LocalExecutorITCase.java b/flink-table/flink-sql-client/src/test/java/org/apache/flink/table/client/gateway/local/LocalExecutorITCase.java
index 6a7f9ca81a5..cab4d50a3cd 100644
--- a/flink-table/flink-sql-client/src/test/java/org/apache/flink/table/client/gateway/local/LocalExecutorITCase.java
+++ b/flink-table/flink-sql-client/src/test/java/org/apache/flink/table/client/gateway/local/LocalExecutorITCase.java
@@ -47,6 +47,7 @@ import org.apache.flink.table.client.gateway.SqlExecutionException;
 import org.apache.flink.table.client.gateway.TypedResult;
 import org.apache.flink.table.client.gateway.utils.EnvironmentFileUtil;
 import org.apache.flink.table.client.gateway.utils.SimpleCatalogFactory;
+import org.apache.flink.table.client.gateway.utils.TestUserClassLoaderJar;
 import org.apache.flink.table.functions.ScalarFunction;
 import org.apache.flink.test.util.MiniClusterWithClientResource;
 import org.apache.flink.test.util.TestBaseUtils;
@@ -127,9 +128,16 @@ public class LocalExecutorITCase extends TestLogger {
 
 	private static ClusterClient<?> clusterClient;
 
+	// a generated UDF jar used for testing classloading of dependencies
+	private static URL udfDependency;
+
 	@BeforeClass
-	public static void setup() {
+	public static void setup() throws IOException {
 		clusterClient = MINI_CLUSTER_RESOURCE.getClusterClient();
+		File udfJar = TestUserClassLoaderJar.createJarFile(
+			tempFolder.newFolder("test-jar"),
+			"test-classloader-udf.jar");
+		udfDependency = udfJar.toURI().toURL();
 	}
 
 	private static Configuration getConfig() {
@@ -835,14 +843,16 @@ public class LocalExecutorITCase extends TestLogger {
 		assertEquals("test-session", sessionId);
 
 		try {
+			executor.executeSql(sessionId, "CREATE FUNCTION LowerUDF AS 'LowerUDF'");
 			// Case 1: Registered sink
 			// Case 1.1: Registered sink with uppercase insert into keyword.
+			// FLINK-18302: wrong classloader when INSERT INTO with UDF
 			final String statement1 = "INSERT INTO TableSourceSink SELECT IntegerField1 = 42," +
-					" StringField1, TimestampField1 FROM TableNumber1";
+					" LowerUDF(StringField1), TimestampField1 FROM TableNumber1";
 			executeAndVerifySinkResult(executor, sessionId, statement1, csvOutputPath);
 			// Case 1.2: Registered sink with lowercase insert into keyword.
 			final String statement2 = "insert Into TableSourceSink \n "
-					+ "SELECT IntegerField1 = 42, StringField1, TimestampField1 "
+					+ "SELECT IntegerField1 = 42, LowerUDF(StringField1), TimestampField1 "
 					+ "FROM TableNumber1";
 			executeAndVerifySinkResult(executor, sessionId, statement2, csvOutputPath);
 			// Case 1.3: Execute the same statement again, the results should expect to be the same.
@@ -1375,12 +1385,12 @@ public class LocalExecutorITCase extends TestLogger {
 		final List<String> actualResults = new ArrayList<>();
 		TestBaseUtils.readAllResultLines(actualResults, path);
 		final List<String> expectedResults = new ArrayList<>();
-		expectedResults.add("true,Hello World,2020-01-01 00:00:01.0");
-		expectedResults.add("false,Hello World,2020-01-01 00:00:02.0");
-		expectedResults.add("false,Hello World,2020-01-01 00:00:03.0");
-		expectedResults.add("false,Hello World,2020-01-01 00:00:04.0");
-		expectedResults.add("true,Hello World,2020-01-01 00:00:05.0");
-		expectedResults.add("false,Hello World!!!!,2020-01-01 00:00:06.0");
+		expectedResults.add("true,hello world,2020-01-01 00:00:01.0");
+		expectedResults.add("false,hello world,2020-01-01 00:00:02.0");
+		expectedResults.add("false,hello world,2020-01-01 00:00:03.0");
+		expectedResults.add("false,hello world,2020-01-01 00:00:04.0");
+		expectedResults.add("true,hello world,2020-01-01 00:00:05.0");
+		expectedResults.add("false,hello world!!!!,2020-01-01 00:00:06.0");
 		TestBaseUtils.compareResultCollections(expectedResults, actualResults, Comparator.naturalOrder());
 	}
 
@@ -1431,7 +1441,7 @@ public class LocalExecutorITCase extends TestLogger {
 		replaceVars.putIfAbsent("$VAR_RESTART_STRATEGY_TYPE", "failure-rate");
 		return new LocalExecutor(
 				EnvironmentFileUtil.parseModified(DEFAULTS_ENVIRONMENT_FILE, replaceVars),
-				Collections.emptyList(),
+				Collections.singletonList(udfDependency),
 				clusterClient.getFlinkConfiguration(),
 				new DefaultCLI(clusterClient.getFlinkConfiguration()),
 				new DefaultClusterClientServiceLoader());
diff --git a/flink-table/flink-sql-client/src/test/java/org/apache/flink/table/client/gateway/utils/TestUserClassLoaderJar.java b/flink-table/flink-sql-client/src/test/java/org/apache/flink/table/client/gateway/utils/TestUserClassLoaderJar.java
new file mode 100644
index 00000000000..066d8c6c60e
--- /dev/null
+++ b/flink-table/flink-sql-client/src/test/java/org/apache/flink/table/client/gateway/utils/TestUserClassLoaderJar.java
@@ -0,0 +1,90 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.flink.table.client.gateway.utils;
+
+import org.apache.flink.util.FileUtils;
+
+import javax.tools.DiagnosticCollector;
+import javax.tools.JavaCompiler;
+import javax.tools.JavaFileObject;
+import javax.tools.StandardJavaFileManager;
+import javax.tools.ToolProvider;
+
+import java.io.File;
+import java.io.FileOutputStream;
+import java.io.IOException;
+import java.nio.file.Paths;
+import java.util.Collections;
+import java.util.jar.JarEntry;
+import java.util.jar.JarOutputStream;
+
+/**
+ * Mainly used for testing classloading of UDF dependencies.
+ */
+public class TestUserClassLoaderJar {
+
+	private static final String GENERATED_UDF_CLASS = "LowerUDF";
+
+	private static final String GENERATED_UDF_CODE =
+			"public class " + GENERATED_UDF_CLASS + " extends org.apache.flink.table.functions.ScalarFunction {\n" +
+			"  public String eval(String str) {\n" +
+			"    return str.toLowerCase();\n" +
+			"  }\n" +
+			"}\n";
+
+	/**
+	 * Pack the generated UDF class into a JAR and return the path of the JAR.
+	 */
+	public static File createJarFile(File tmpDir, String jarName) throws IOException {
+		// write class source code to file
+		File javaFile = Paths.get(tmpDir.toString(), GENERATED_UDF_CLASS + ".java").toFile();
+		//noinspection ResultOfMethodCallIgnored
+		javaFile.createNewFile();
+		FileUtils.writeFileUtf8(javaFile, GENERATED_UDF_CODE);
+
+		// compile class source code
+		DiagnosticCollector<JavaFileObject> diagnostics = new DiagnosticCollector<>();
+		JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();
+		StandardJavaFileManager fileManager = compiler.getStandardFileManager(diagnostics, null, null);
+		Iterable<? extends JavaFileObject> compilationUnit =
+			fileManager.getJavaFileObjectsFromFiles(Collections.singletonList(javaFile));
+		JavaCompiler.CompilationTask task = compiler.getTask(
+			null,
+			fileManager,
+			diagnostics,
+			Collections.emptyList(),
+			null,
+			compilationUnit);
+		task.call();
+
+		// pack class file to jar
+		File classFile = Paths.get(tmpDir.toString(), GENERATED_UDF_CLASS + ".class").toFile();
+		File jarFile = Paths.get(tmpDir.toString(), jarName).toFile();
+		JarOutputStream jos = new JarOutputStream(new FileOutputStream(jarFile));
+		JarEntry jarEntry = new JarEntry(GENERATED_UDF_CLASS + ".class");
+		jos.putNextEntry(jarEntry);
+		byte[] classBytes = FileUtils.readAllBytes(classFile.toPath());
+		jos.write(classBytes);
+		jos.closeEntry();
+		jos.close();
+
+		return jarFile;
+	}
+
+}
