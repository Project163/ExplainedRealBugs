diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/reader/AbstractRecordReader.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/reader/AbstractRecordReader.java
index a2d9caeeea7..c6cabc0e5f6 100644
--- a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/reader/AbstractRecordReader.java
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/reader/AbstractRecordReader.java
@@ -19,6 +19,7 @@
 package org.apache.flink.runtime.io.network.api.reader;
 
 import org.apache.flink.core.io.IOReadableWritable;
+import org.apache.flink.runtime.checkpoint.channel.ChannelStateWriter;
 import org.apache.flink.runtime.checkpoint.channel.InputChannelInfo;
 import org.apache.flink.runtime.io.network.api.serialization.RecordDeserializer;
 import org.apache.flink.runtime.io.network.api.serialization.RecordDeserializer.DeserializationResult;
@@ -88,6 +89,7 @@ abstract class AbstractRecordReader<T extends IOReadableWritable> extends Abstra
 				Optional<BufferOrEvent> polled = inputGate.pollNext();
 				Preconditions.checkState(!polled.isPresent());
 			}
+			inputGate.setChannelStateWriter(ChannelStateWriter.NO_OP);
 			inputGate.requestPartitions();
 			requestedPartitions = true;
 		}
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/ChannelStatePersister.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/ChannelStatePersister.java
index c0998ec9dab..cec9a927f58 100644
--- a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/ChannelStatePersister.java
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/ChannelStatePersister.java
@@ -31,14 +31,14 @@ import javax.annotation.concurrent.NotThreadSafe;
 import java.io.IOException;
 import java.util.List;
 
-import static org.apache.flink.util.Preconditions.checkState;
+import static org.apache.flink.util.Preconditions.checkNotNull;
 
 /**
  * Helper class for persisting channel state via {@link ChannelStateWriter}.
  */
 @NotThreadSafe
 final class ChannelStatePersister {
-	protected final InputChannelInfo channelInfo;
+	private final InputChannelInfo channelInfo;
 
 	private enum CheckpointStatus {COMPLETED, BARRIER_PENDING, BARRIER_RECEIVED}
 
@@ -49,17 +49,14 @@ final class ChannelStatePersister {
 	/**
 	 * Writer must be initialized before usage. {@link #startPersisting(long, List)} enforces this invariant.
 	 */
-	@Nullable
 	private final ChannelStateWriter channelStateWriter;
 
-	ChannelStatePersister(@Nullable ChannelStateWriter channelStateWriter, InputChannelInfo channelInfo) {
-		this.channelStateWriter = channelStateWriter;
-		this.channelInfo = channelInfo;
+	ChannelStatePersister(ChannelStateWriter channelStateWriter, InputChannelInfo channelInfo) {
+		this.channelStateWriter = checkNotNull(channelStateWriter);
+		this.channelInfo = checkNotNull(channelInfo);
 	}
 
 	protected void startPersisting(long barrierId, List<Buffer> knownBuffers) {
-		checkState(isInitialized(), "Channel state writer not injected");
-
 		if (checkpointStatus != CheckpointStatus.BARRIER_RECEIVED && lastSeenBarrier < barrierId) {
 			checkpointStatus = CheckpointStatus.BARRIER_PENDING;
 			lastSeenBarrier = barrierId;
@@ -73,10 +70,6 @@ final class ChannelStatePersister {
 		}
 	}
 
-	protected boolean isInitialized() {
-		return channelStateWriter != null;
-	}
-
 	protected void stopPersisting(long id) {
 		if (id >= lastSeenBarrier) {
 			checkpointStatus = CheckpointStatus.COMPLETED;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/LocalInputChannel.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/LocalInputChannel.java
index cc652bafd82..a0d69c51253 100644
--- a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/LocalInputChannel.java
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/LocalInputChannel.java
@@ -28,7 +28,6 @@ import org.apache.flink.runtime.io.network.api.CheckpointBarrier;
 import org.apache.flink.runtime.io.network.buffer.Buffer;
 import org.apache.flink.runtime.io.network.buffer.FileRegionBuffer;
 import org.apache.flink.runtime.io.network.partition.BufferAvailabilityListener;
-import org.apache.flink.runtime.io.network.partition.ChannelStateHolder;
 import org.apache.flink.runtime.io.network.partition.PartitionNotFoundException;
 import org.apache.flink.runtime.io.network.partition.ResultPartitionID;
 import org.apache.flink.runtime.io.network.partition.ResultPartitionManager;
@@ -52,7 +51,7 @@ import static org.apache.flink.util.Preconditions.checkState;
 /**
  * An input channel, which requests a local subpartition.
  */
-public class LocalInputChannel extends InputChannel implements BufferAvailabilityListener, ChannelStateHolder {
+public class LocalInputChannel extends InputChannel implements BufferAvailabilityListener {
 
 	private static final Logger LOG = LoggerFactory.getLogger(LocalInputChannel.class);
 
@@ -71,7 +70,7 @@ public class LocalInputChannel extends InputChannel implements BufferAvailabilit
 
 	private volatile boolean isReleased;
 
-	private ChannelStatePersister channelStatePersister = new ChannelStatePersister(null, channelInfo);
+	private final ChannelStatePersister channelStatePersister;
 
 	public LocalInputChannel(
 		SingleInputGate inputGate,
@@ -82,7 +81,7 @@ public class LocalInputChannel extends InputChannel implements BufferAvailabilit
 		Counter numBytesIn,
 		Counter numBuffersIn) {
 
-		this(inputGate, channelIndex, partitionId, partitionManager, taskEventPublisher, 0, 0, numBytesIn, numBuffersIn);
+		this(inputGate, channelIndex, partitionId, partitionManager, taskEventPublisher, 0, 0, numBytesIn, numBuffersIn, ChannelStateWriter.NO_OP);
 	}
 
 	public LocalInputChannel(
@@ -94,23 +93,20 @@ public class LocalInputChannel extends InputChannel implements BufferAvailabilit
 		int initialBackoff,
 		int maxBackoff,
 		Counter numBytesIn,
-		Counter numBuffersIn) {
+		Counter numBuffersIn,
+		ChannelStateWriter stateWriter) {
 
 		super(inputGate, channelIndex, partitionId, initialBackoff, maxBackoff, numBytesIn, numBuffersIn);
 
 		this.partitionManager = checkNotNull(partitionManager);
 		this.taskEventPublisher = checkNotNull(taskEventPublisher);
+		this.channelStatePersister = new ChannelStatePersister(stateWriter, getChannelInfo());
 	}
 
 	// ------------------------------------------------------------------------
 	// Consume
 	// ------------------------------------------------------------------------
 
-	public void setChannelStateWriter(ChannelStateWriter channelStateWriter) {
-		checkState(!channelStatePersister.isInitialized(), "Already initialized");
-		channelStatePersister = new ChannelStatePersister(checkNotNull(channelStateWriter), channelInfo);
-	}
-
 	public void checkpointStarted(CheckpointBarrier barrier) {
 		channelStatePersister.startPersisting(barrier.getId(), Collections.emptyList());
 	}
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/LocalRecoveredInputChannel.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/LocalRecoveredInputChannel.java
index db03d534f20..a9254aad163 100644
--- a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/LocalRecoveredInputChannel.java
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/LocalRecoveredInputChannel.java
@@ -59,7 +59,7 @@ public class LocalRecoveredInputChannel extends RecoveredInputChannel {
 
 	@Override
 	protected InputChannel toInputChannelInternal() {
-		final LocalInputChannel localInputChannel = new LocalInputChannel(
+		return new LocalInputChannel(
 			inputGate,
 			getChannelIndex(),
 			partitionId,
@@ -68,10 +68,7 @@ public class LocalRecoveredInputChannel extends RecoveredInputChannel {
 			initialBackoff,
 			maxBackoff,
 			numBytesIn,
-			numBytesIn);
-		if (channelStateWriter != null) {
-			localInputChannel.setChannelStateWriter(channelStateWriter);
-		}
-		return localInputChannel;
+			numBytesIn,
+			channelStateWriter);
 	}
 }
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java
index 614af48d439..45e3271f982 100644
--- a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java
@@ -33,7 +33,6 @@ import org.apache.flink.runtime.io.network.api.serialization.EventSerializer;
 import org.apache.flink.runtime.io.network.buffer.Buffer;
 import org.apache.flink.runtime.io.network.buffer.Buffer.DataType;
 import org.apache.flink.runtime.io.network.buffer.BufferProvider;
-import org.apache.flink.runtime.io.network.partition.ChannelStateHolder;
 import org.apache.flink.runtime.io.network.partition.PartitionNotFoundException;
 import org.apache.flink.runtime.io.network.partition.PrioritizedDeque;
 import org.apache.flink.runtime.io.network.partition.ResultPartitionID;
@@ -60,7 +59,7 @@ import static org.apache.flink.util.Preconditions.checkState;
 /**
  * An input channel, which requests a remote partition queue.
  */
-public class RemoteInputChannel extends InputChannel implements ChannelStateHolder {
+public class RemoteInputChannel extends InputChannel {
 
 	public static final int ALL = -1;
 	/** ID to distinguish this channel from other channels sharing the same TCP connection. */
@@ -104,8 +103,7 @@ public class RemoteInputChannel extends InputChannel implements ChannelStateHold
 	@GuardedBy("receivedBuffers")
 	private int numBuffersOvertaken = ALL;
 
-	@GuardedBy("receivedBuffers")
-	private ChannelStatePersister channelStatePersister = new ChannelStatePersister(null, channelInfo);
+	private final ChannelStatePersister channelStatePersister;
 
 	public RemoteInputChannel(
 		SingleInputGate inputGate,
@@ -117,7 +115,8 @@ public class RemoteInputChannel extends InputChannel implements ChannelStateHold
 		int maxBackoff,
 		int networkBuffersPerChannel,
 		Counter numBytesIn,
-		Counter numBuffersIn) {
+		Counter numBuffersIn,
+		ChannelStateWriter stateWriter) {
 
 		super(inputGate, channelIndex, partitionId, initialBackOff, maxBackoff, numBytesIn, numBuffersIn);
 
@@ -125,11 +124,7 @@ public class RemoteInputChannel extends InputChannel implements ChannelStateHold
 		this.connectionId = checkNotNull(connectionId);
 		this.connectionManager = checkNotNull(connectionManager);
 		this.bufferManager = new BufferManager(inputGate.getMemorySegmentProvider(), this, 0);
-	}
-
-	public void setChannelStateWriter(ChannelStateWriter channelStateWriter) {
-		checkState(!channelStatePersister.isInitialized(), "Already initialized");
-		channelStatePersister = new ChannelStatePersister(checkNotNull(channelStateWriter), channelInfo);
+		this.channelStatePersister = new ChannelStatePersister(stateWriter, getChannelInfo());
 	}
 
 	/**
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteRecoveredInputChannel.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteRecoveredInputChannel.java
index a89b71ff291..7481e263a6d 100644
--- a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteRecoveredInputChannel.java
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteRecoveredInputChannel.java
@@ -71,10 +71,8 @@ public class RemoteRecoveredInputChannel extends RecoveredInputChannel {
 			maxBackoff,
 			networkBuffersPerChannel,
 			numBytesIn,
-			numBuffersIn);
-		if (channelStateWriter != null) {
-			remoteInputChannel.setChannelStateWriter(channelStateWriter);
-		}
+			numBuffersIn,
+			channelStateWriter);
 		remoteInputChannel.setup();
 		return remoteInputChannel;
 	}
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/UnknownInputChannel.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/UnknownInputChannel.java
index 9e5fb0c04b6..5d4ada6c827 100644
--- a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/UnknownInputChannel.java
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/UnknownInputChannel.java
@@ -18,13 +18,18 @@
 
 package org.apache.flink.runtime.io.network.partition.consumer;
 
+import org.apache.flink.runtime.checkpoint.channel.ChannelStateWriter;
 import org.apache.flink.runtime.event.TaskEvent;
 import org.apache.flink.runtime.io.network.ConnectionID;
 import org.apache.flink.runtime.io.network.ConnectionManager;
 import org.apache.flink.runtime.io.network.TaskEventPublisher;
 import org.apache.flink.runtime.io.network.metrics.InputChannelMetrics;
+import org.apache.flink.runtime.io.network.partition.ChannelStateHolder;
 import org.apache.flink.runtime.io.network.partition.ResultPartitionID;
 import org.apache.flink.runtime.io.network.partition.ResultPartitionManager;
+import org.apache.flink.util.Preconditions;
+
+import javax.annotation.Nullable;
 
 import java.io.IOException;
 import java.util.Optional;
@@ -35,7 +40,7 @@ import static org.apache.flink.util.Preconditions.checkNotNull;
  * An input channel place holder to be replaced by either a {@link RemoteInputChannel}
  * or {@link LocalInputChannel} at runtime.
  */
-class UnknownInputChannel extends InputChannel {
+class UnknownInputChannel extends InputChannel implements ChannelStateHolder {
 
 	private final ResultPartitionManager partitionManager;
 
@@ -52,6 +57,9 @@ class UnknownInputChannel extends InputChannel {
 
 	private final InputChannelMetrics metrics;
 
+	@Nullable
+	private ChannelStateWriter channelStateWriter;
+
 	public UnknownInputChannel(
 			SingleInputGate gate,
 			int channelIndex,
@@ -133,7 +141,8 @@ class UnknownInputChannel extends InputChannel {
 			maxBackoff,
 			networkBuffersPerChannel,
 			metrics.getNumBytesInRemoteCounter(),
-			metrics.getNumBuffersInRemoteCounter());
+			metrics.getNumBuffersInRemoteCounter(),
+			channelStateWriter == null ? ChannelStateWriter.NO_OP : channelStateWriter);
 	}
 
 	public LocalInputChannel toLocalInputChannel() {
@@ -146,6 +155,13 @@ class UnknownInputChannel extends InputChannel {
 			initialBackoff,
 			maxBackoff,
 			metrics.getNumBytesInRemoteCounter(),
-			metrics.getNumBuffersInRemoteCounter());
+			metrics.getNumBuffersInRemoteCounter(),
+			channelStateWriter == null ? ChannelStateWriter.NO_OP : channelStateWriter);
+	}
+
+	@Override
+	public void setChannelStateWriter(ChannelStateWriter channelStateWriter) {
+		Preconditions.checkState(this.channelStateWriter == null);
+		this.channelStateWriter = channelStateWriter;
 	}
 }
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/netty/CreditBasedPartitionRequestClientHandlerTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/netty/CreditBasedPartitionRequestClientHandlerTest.java
index b62f0e4f929..e02757f8bcf 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/netty/CreditBasedPartitionRequestClientHandlerTest.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/netty/CreditBasedPartitionRequestClientHandlerTest.java
@@ -19,6 +19,7 @@
 package org.apache.flink.runtime.io.network.netty;
 
 import org.apache.flink.metrics.SimpleCounter;
+import org.apache.flink.runtime.checkpoint.channel.ChannelStateWriter;
 import org.apache.flink.runtime.io.network.ConnectionID;
 import org.apache.flink.runtime.io.network.PartitionRequestClient;
 import org.apache.flink.runtime.io.network.TestingConnectionManager;
@@ -637,7 +638,8 @@ public class CreditBasedPartitionRequestClientHandlerTest {
 				100,
 				2,
 				new SimpleCounter(),
-				new SimpleCounter());
+				new SimpleCounter(),
+				ChannelStateWriter.NO_OP);
 			this.expectedMessage = expectedMessage;
 		}
 
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/InputChannelTestUtils.java b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/InputChannelTestUtils.java
index 9c25e65cb0d..bd14a21d491 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/InputChannelTestUtils.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/InputChannelTestUtils.java
@@ -37,6 +37,7 @@ import org.mockito.stubbing.Answer;
 
 import java.util.Collection;
 import java.util.Collections;
+import java.util.function.Consumer;
 
 import static org.mockito.Matchers.any;
 import static org.mockito.Matchers.anyInt;
@@ -105,11 +106,22 @@ public class InputChannelTestUtils {
 		int initialBackoff,
 		int maxBackoff) {
 
-		return InputChannelBuilder.newBuilder()
+		return createLocalInputChannel(inputGate, partitionManager, initialBackoff, maxBackoff, unused -> { /* no op */ });
+	}
+
+	public static LocalInputChannel createLocalInputChannel(
+			SingleInputGate inputGate,
+			ResultPartitionManager partitionManager,
+			int initialBackoff,
+			int maxBackoff,
+			Consumer<InputChannelBuilder> setter) {
+
+		InputChannelBuilder inputChannelBuilder = InputChannelBuilder.newBuilder()
 			.setPartitionManager(partitionManager)
 			.setInitialBackoff(initialBackoff)
-			.setMaxBackoff(maxBackoff)
-			.buildLocalChannel(inputGate);
+			.setMaxBackoff(maxBackoff);
+		setter.accept(inputChannelBuilder);
+		return inputChannelBuilder.buildLocalChannel(inputGate);
 	}
 
 	public static RemoteInputChannel createRemoteInputChannel(
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/PartialConsumePipelinedResultTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/PartialConsumePipelinedResultTest.java
index 0acdf296917..743f853f6a9 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/PartialConsumePipelinedResultTest.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/PartialConsumePipelinedResultTest.java
@@ -21,6 +21,7 @@ package org.apache.flink.runtime.io.network.partition;
 import org.apache.flink.configuration.AkkaOptions;
 import org.apache.flink.configuration.Configuration;
 import org.apache.flink.configuration.NettyShuffleEnvironmentOptions;
+import org.apache.flink.runtime.checkpoint.channel.ChannelStateWriter;
 import org.apache.flink.runtime.execution.Environment;
 import org.apache.flink.runtime.io.network.api.writer.ResultPartitionWriter;
 import org.apache.flink.runtime.io.network.buffer.Buffer;
@@ -141,6 +142,7 @@ public class PartialConsumePipelinedResultTest extends TestLogger {
 			while (!gate.getStateConsumedFuture().isDone()) {
 				gate.pollNext();
 			}
+			gate.setChannelStateWriter(ChannelStateWriter.NO_OP);
 			gate.requestPartitions();
 			Buffer buffer = gate.getNext().orElseThrow(IllegalStateException::new).getBuffer();
 			if (buffer != null) {
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/InputChannelBuilder.java b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/InputChannelBuilder.java
index ec80a1c4fcd..1a9ca0ce846 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/InputChannelBuilder.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/InputChannelBuilder.java
@@ -18,6 +18,7 @@
 
 package org.apache.flink.runtime.io.network.partition.consumer;
 
+import org.apache.flink.runtime.checkpoint.channel.ChannelStateWriter;
 import org.apache.flink.runtime.io.network.ConnectionID;
 import org.apache.flink.runtime.io.network.ConnectionManager;
 import org.apache.flink.runtime.io.network.NettyShuffleEnvironment;
@@ -46,6 +47,7 @@ public class InputChannelBuilder {
 	private ConnectionID connectionID = STUB_CONNECTION_ID;
 	private ResultPartitionManager partitionManager = new TestingResultPartitionManager(new NoOpResultSubpartitionView());
 	private TaskEventPublisher taskEventPublisher = new TaskEventDispatcher();
+	private ChannelStateWriter stateWriter = ChannelStateWriter.NO_OP;
 	private ConnectionManager connectionManager = new TestingConnectionManager();
 	private int initialBackoff = 0;
 	private int maxBackoff = 0;
@@ -101,6 +103,11 @@ public class InputChannelBuilder {
 		return this;
 	}
 
+	public InputChannelBuilder setStateWriter(ChannelStateWriter stateWriter) {
+		this.stateWriter = stateWriter;
+		return this;
+	}
+
 	public InputChannelBuilder setupFromNettyShuffleEnvironment(NettyShuffleEnvironment network) {
 		this.partitionManager = network.getResultPartitionManager();
 		this.connectionManager = network.getConnectionManager();
@@ -111,7 +118,7 @@ public class InputChannelBuilder {
 	}
 
 	UnknownInputChannel buildUnknownChannel(SingleInputGate inputGate) {
-		return new UnknownInputChannel(
+		UnknownInputChannel channel = new UnknownInputChannel(
 			inputGate,
 			channelIndex,
 			partitionId,
@@ -122,6 +129,8 @@ public class InputChannelBuilder {
 			maxBackoff,
 			networkBuffersPerChannel,
 			metrics);
+		channel.setChannelStateWriter(stateWriter);
+		return channel;
 	}
 
 	public LocalInputChannel buildLocalChannel(SingleInputGate inputGate) {
@@ -134,7 +143,8 @@ public class InputChannelBuilder {
 			initialBackoff,
 			maxBackoff,
 			metrics.getNumBytesInLocalCounter(),
-			metrics.getNumBuffersInLocalCounter());
+			metrics.getNumBuffersInLocalCounter(),
+			stateWriter);
 	}
 
 	public RemoteInputChannel buildRemoteChannel(SingleInputGate inputGate) {
@@ -148,11 +158,12 @@ public class InputChannelBuilder {
 			maxBackoff,
 			networkBuffersPerChannel,
 			metrics.getNumBytesInRemoteCounter(),
-			metrics.getNumBuffersInRemoteCounter());
+			metrics.getNumBuffersInRemoteCounter(),
+			stateWriter);
 	}
 
 	public LocalRecoveredInputChannel buildLocalRecoveredChannel(SingleInputGate inputGate) {
-		return new LocalRecoveredInputChannel(
+		LocalRecoveredInputChannel channel = new LocalRecoveredInputChannel(
 			inputGate,
 			channelIndex,
 			partitionId,
@@ -162,10 +173,12 @@ public class InputChannelBuilder {
 			maxBackoff,
 			networkBuffersPerChannel,
 			metrics);
+		channel.setChannelStateWriter(stateWriter);
+		return channel;
 	}
 
 	public RemoteRecoveredInputChannel buildRemoteRecoveredChannel(SingleInputGate inputGate) {
-		return new RemoteRecoveredInputChannel(
+		RemoteRecoveredInputChannel channel = new RemoteRecoveredInputChannel(
 			inputGate,
 			channelIndex,
 			partitionId,
@@ -175,5 +188,7 @@ public class InputChannelBuilder {
 			maxBackoff,
 			networkBuffersPerChannel,
 			metrics);
+		channel.setChannelStateWriter(stateWriter);
+		return channel;
 	}
 }
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/LocalInputChannelTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/LocalInputChannelTest.java
index f0658f3d0e5..08cdf6cbe04 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/LocalInputChannelTest.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/LocalInputChannelTest.java
@@ -467,13 +467,11 @@ public class LocalInputChannelTest {
 		ResultSubpartitionView subpartitionView = subpartition.createReadView(() -> {});
 
 		TestingResultPartitionManager partitionManager = new TestingResultPartitionManager(subpartitionView);
-		LocalInputChannel channel = createLocalInputChannel(inputGate, partitionManager);
+		final RecordingChannelStateWriter stateWriter = new RecordingChannelStateWriter();
+		LocalInputChannel channel = createLocalInputChannel(inputGate, partitionManager, 0, 0, b -> b.setStateWriter(stateWriter));
 		inputGate.setInputChannels(channel);
 		channel.requestSubpartition(0);
 
-		final RecordingChannelStateWriter stateWriter = new RecordingChannelStateWriter();
-		inputGate.setChannelStateWriter(stateWriter);
-
 		final CheckpointStorageLocationReference location = CheckpointStorageLocationReference.getDefault();
 		CheckpointOptions options = new CheckpointOptions(CheckpointType.CHECKPOINT, location, true, true, 0);
 		stateWriter.start(0, options);
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateBuilder.java b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateBuilder.java
index 051ef56d070..10e04ea72dd 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateBuilder.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateBuilder.java
@@ -153,9 +153,8 @@ public class SingleInputGateBuilder {
 			bufferSize);
 		if (channelFactory != null) {
 			gate.setInputChannels(IntStream.range(0, numberOfChannels)
-				.mapToObj(index -> channelFactory.apply(InputChannelBuilder.newBuilder().setChannelIndex(index), gate))
+				.mapToObj(index -> channelFactory.apply(InputChannelBuilder.newBuilder().setStateWriter(channelStateWriter).setChannelIndex(index), gate))
 				.toArray(InputChannel[]::new));
-			gate.setChannelStateWriter(channelStateWriter);
 		}
 		return gate;
 	}
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateTest.java
index d164f946e1e..a437eed464a 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateTest.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateTest.java
@@ -21,6 +21,7 @@ package org.apache.flink.runtime.io.network.partition.consumer;
 import org.apache.flink.core.memory.MemorySegment;
 import org.apache.flink.core.memory.MemorySegmentFactory;
 import org.apache.flink.metrics.groups.UnregisteredMetricsGroup;
+import org.apache.flink.runtime.checkpoint.channel.ChannelStateWriter;
 import org.apache.flink.runtime.checkpoint.channel.InputChannelInfo;
 import org.apache.flink.runtime.clusterframework.types.ResourceID;
 import org.apache.flink.runtime.deployment.InputGateDeploymentDescriptor;
@@ -474,6 +475,7 @@ public class SingleInputGateTest extends InputGateTestBase {
 				gateDesc,
 				SingleInputGateBuilder.NO_OP_PRODUCER_CHECKER,
 				InputChannelTestUtils.newUnregisteredInputChannelMetrics());
+		gate.setChannelStateWriter(ChannelStateWriter.NO_OP);
 
 		gate.finishReadRecoveredState();
 		while (!gate.getStateConsumedFuture().isDone()) {
@@ -490,6 +492,13 @@ public class SingleInputGateTest extends InputGateTestBase {
 			Map<IntermediateResultPartitionID, InputChannel> channelMap = gate.getInputChannels();
 
 			assertEquals(3, channelMap.size());
+			channelMap.values().forEach(channel -> {
+				try {
+					channel.checkError();
+				} catch (IOException e) {
+					throw new RuntimeException(e);
+				}
+			});
 			InputChannel localChannel = channelMap.get(partitionIds[0]);
 			assertEquals(LocalInputChannel.class, localChannel.getClass());
 
diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/UnalignedControllerTest.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/UnalignedControllerTest.java
index 269ef0b26d4..a365bf5aba0 100644
--- a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/UnalignedControllerTest.java
+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/UnalignedControllerTest.java
@@ -650,11 +650,11 @@ public class UnalignedControllerTest {
 			.mapToObj(channelIndex ->
 				InputChannelBuilder.newBuilder()
 					.setChannelIndex(channelIndex)
+					.setStateWriter(channelStateWriter)
 					.setupFromNettyShuffleEnvironment(environment)
 					.setConnectionManager(new TestingConnectionManager())
 					.buildRemoteChannel(gate))
 			.toArray(RemoteInputChannel[]::new));
-		gate.setChannelStateWriter(channelStateWriter);
 		sequenceNumbers = new int[numberOfChannels];
 
 		gate.setup();
@@ -704,8 +704,9 @@ public class UnalignedControllerTest {
 	}
 
 	private void assertInflightData(BufferOrEvent... expected) {
-		assertEquals("Unexpected in-flight sequence", getIds(Arrays.asList(expected)),
-			getIds(getAndResetInflightData()));
+		Collection<BufferOrEvent> andResetInflightData = getAndResetInflightData();
+		assertEquals("Unexpected in-flight sequence: " + andResetInflightData, getIds(Arrays.asList(expected)),
+			getIds(andResetInflightData));
 	}
 
 	private Collection<BufferOrEvent> getAndResetInflightData() {
diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/benchmark/SingleInputGateBenchmarkFactory.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/benchmark/SingleInputGateBenchmarkFactory.java
index 8f94746efba..0eb5728c85b 100644
--- a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/benchmark/SingleInputGateBenchmarkFactory.java
+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/benchmark/SingleInputGateBenchmarkFactory.java
@@ -18,6 +18,7 @@
 
 package org.apache.flink.streaming.runtime.io.benchmark;
 
+import org.apache.flink.runtime.checkpoint.channel.ChannelStateWriter;
 import org.apache.flink.runtime.clusterframework.types.ResourceID;
 import org.apache.flink.runtime.io.network.ConnectionID;
 import org.apache.flink.runtime.io.network.ConnectionManager;
@@ -116,7 +117,8 @@ public class SingleInputGateBenchmarkFactory extends SingleInputGateFactory {
 				initialBackoff,
 				maxBackoff,
 				metrics.getNumBytesInLocalCounter(),
-				metrics.getNumBuffersInLocalCounter());
+				metrics.getNumBuffersInLocalCounter(),
+				ChannelStateWriter.NO_OP);
 		}
 
 		@Override
@@ -162,7 +164,8 @@ public class SingleInputGateBenchmarkFactory extends SingleInputGateFactory {
 				maxBackoff,
 				networkBuffersPerChannel,
 				metrics.getNumBytesInRemoteCounter(),
-				metrics.getNumBuffersInRemoteCounter());
+				metrics.getNumBuffersInRemoteCounter(),
+				ChannelStateWriter.NO_OP);
 		}
 
 		@Override
