diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPool.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPool.java
index 3a54aa33194..c50da97c7cd 100644
--- a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPool.java
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPool.java
@@ -424,6 +424,12 @@ class LocalBufferPool implements BufferPool {
         mayNotifyAvailable(toNotify);
     }
 
+    private boolean shouldBeAvailable() {
+        assert Thread.holdsLock(availableMemorySegments);
+
+        return !availableMemorySegments.isEmpty() && unavailableSubpartitionsCount == 0;
+    }
+
     private boolean checkAvailability() {
         assert Thread.holdsLock(availableMemorySegments);
 
@@ -435,6 +441,7 @@ class LocalBufferPool implements BufferPool {
                 return unavailableSubpartitionsCount == 0;
             } else {
                 requestMemorySegmentFromGlobalWhenAvailable();
+                return shouldBeAvailable();
             }
         }
         return false;
@@ -443,8 +450,7 @@ class LocalBufferPool implements BufferPool {
     private void checkConsistentAvailability() {
         assert Thread.holdsLock(availableMemorySegments);
 
-        final boolean shouldBeAvailable =
-                availableMemorySegments.size() > 0 && unavailableSubpartitionsCount == 0;
+        final boolean shouldBeAvailable = shouldBeAvailable();
         checkState(
                 availabilityHelper.isApproximatelyAvailable() == shouldBeAvailable,
                 "Inconsistent availability: expected " + shouldBeAvailable);
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPoolTest.java b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPoolTest.java
index d016960bd68..c5115a62fd3 100644
--- a/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPoolTest.java
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/io/network/buffer/LocalBufferPoolTest.java
@@ -18,6 +18,7 @@
 
 package org.apache.flink.runtime.io.network.buffer;
 
+import org.apache.flink.core.memory.MemorySegment;
 import org.apache.flink.util.TestLogger;
 
 import org.apache.flink.shaded.guava18.com.google.common.collect.Lists;
@@ -30,6 +31,8 @@ import org.junit.Test;
 import org.junit.rules.Timeout;
 import org.mockito.Mockito;
 
+import javax.annotation.Nullable;
+
 import java.util.ArrayDeque;
 import java.util.ArrayList;
 import java.util.Deque;
@@ -515,6 +518,22 @@ public class LocalBufferPoolTest extends TestLogger {
         assertTrue(availableFuture2.isDone());
     }
 
+    /** For FLINK-20547: https://issues.apache.org/jira/browse/FLINK-20547. */
+    @Test
+    public void testConsistentAvailability() throws Exception {
+        NetworkBufferPool globalPool = new TestNetworkBufferPool(numBuffers, memorySegmentSize);
+        try {
+            BufferPool localPool = new LocalBufferPool(globalPool, 1);
+            MemorySegment segment = localPool.requestBufferBuilderBlocking().getMemorySegment();
+            localPool.setNumBuffers(2);
+
+            localPool.recycle(segment);
+            localPool.lazyDestroy();
+        } finally {
+            globalPool.destroy();
+        }
+    }
+
     // ------------------------------------------------------------------------
     // Helpers
     // ------------------------------------------------------------------------
@@ -570,4 +589,22 @@ public class LocalBufferPoolTest extends TestLogger {
             return true;
         }
     }
+
+    private static class TestNetworkBufferPool extends NetworkBufferPool {
+
+        private int requestCounter;
+
+        public TestNetworkBufferPool(int numberOfSegmentsToAllocate, int segmentSize) {
+            super(numberOfSegmentsToAllocate, segmentSize);
+        }
+
+        @Nullable
+        @Override
+        public MemorySegment requestMemorySegment() {
+            if (requestCounter++ == 1) {
+                return null;
+            }
+            return super.requestMemorySegment();
+        }
+    }
 }
