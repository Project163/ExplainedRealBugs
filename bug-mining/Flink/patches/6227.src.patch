diff --git a/flink-table/flink-table-planner/src/main/scala/org/apache/flink/table/planner/codegen/CodeGeneratorContext.scala b/flink-table/flink-table-planner/src/main/scala/org/apache/flink/table/planner/codegen/CodeGeneratorContext.scala
index 6ddcbe75e7a..d9004908d49 100644
--- a/flink-table/flink-table-planner/src/main/scala/org/apache/flink/table/planner/codegen/CodeGeneratorContext.scala
+++ b/flink-table/flink-table-planner/src/main/scala/org/apache/flink/table/planner/codegen/CodeGeneratorContext.scala
@@ -419,22 +419,31 @@ class CodeGeneratorContext(val tableConfig: TableConfig) {
       case _ => className[ObjectHashSet[_]]
     }
 
-    addReusableMember(
-      s"final $setTypeTerm $fieldTerm = new $setTypeTerm(${elements.size});")
+    val addElementsCode = elements.map { element =>
+      s"""
+         |${element.code}
+         |if (${element.nullTerm}) {
+         |  $fieldTerm.addNull();
+         |} else {
+         |  $fieldTerm.add(${element.resultTerm});
+         |}
+         |""".stripMargin
+    }.mkString("\n")
+    val setBuildingFunctionName = newName("buildSet")
+    val setBuildingFunctionCode =
+      s"""
+         |private void $setBuildingFunctionName() {
+         |  $addElementsCode
+         |  $fieldTerm.optimize();
+         |}
+         |""".stripMargin
 
-    elements.foreach { element =>
-      val content =
-        s"""
-           |${element.code}
-           |if (${element.nullTerm}) {
-           |  $fieldTerm.addNull();
-           |} else {
-           |  $fieldTerm.add(${element.resultTerm});
-           |}
-           |""".stripMargin
-      reusableInitStatements.add(content)
-    }
-    reusableInitStatements.add(s"$fieldTerm.optimize();")
+    addReusableMember(
+      s"""
+         |final $setTypeTerm $fieldTerm = new $setTypeTerm(${elements.size});
+         |$setBuildingFunctionCode
+         |""".stripMargin)
+    reusableInitStatements.add(s"$setBuildingFunctionName();")
 
     fieldTerm
   }
diff --git a/flink-table/flink-table-planner/src/test/scala/org/apache/flink/table/planner/runtime/batch/sql/CodeSplitITCase.scala b/flink-table/flink-table-planner/src/test/scala/org/apache/flink/table/planner/runtime/batch/sql/CodeSplitITCase.scala
index 038ef888c8c..caad536082d 100644
--- a/flink-table/flink-table-planner/src/test/scala/org/apache/flink/table/planner/runtime/batch/sql/CodeSplitITCase.scala
+++ b/flink-table/flink-table-planner/src/test/scala/org/apache/flink/table/planner/runtime/batch/sql/CodeSplitITCase.scala
@@ -117,6 +117,24 @@ class CodeSplitITCase extends BatchTestBase {
     Assert.assertEquals(expected, TestValuesTableFactory.getResults("test_many_values"))
   }
 
+  @Test
+  def testManyIns(): Unit = {
+    val sql = new StringBuilder("SELECT a FROM SmallTable3 WHERE a IN (")
+    for (i <- 1 to 10000) {
+      sql.append(i)
+      if (i != 10000) {
+        sql.append(", ")
+      }
+    }
+    sql.append(")")
+
+    val result = Seq(
+      Row.of(java.lang.Integer.valueOf(1)),
+      Row.of(java.lang.Integer.valueOf(2)),
+      Row.of(java.lang.Integer.valueOf(3)))
+    runTest(sql.mkString, result)
+  }
+
   private[flink] def runTest(sql: String, results: Seq[Row]): Unit = {
     tEnv.getConfig.getConfiguration.setInteger(
       TableConfigOptions.MAX_LENGTH_GENERATED_CODE, 4000)
