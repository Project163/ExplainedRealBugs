diff --git a/flink-dist/src/main/flink-bin/bin/bash-java-utils.sh b/flink-dist/src/main/flink-bin/bin/bash-java-utils.sh
index f4d02327197..fb248e8db32 100755
--- a/flink-dist/src/main/flink-bin/bin/bash-java-utils.sh
+++ b/flink-dist/src/main/flink-bin/bin/bash-java-utils.sh
@@ -17,16 +17,60 @@
 # limitations under the License.
 ################################################################################
 
-UNAME=$(uname -s)
-if [ "${UNAME:0:6}" == "CYGWIN" ]; then
-    JAVA_RUN=java
-else
-    if [[ -d "$JAVA_HOME" ]]; then
-        JAVA_RUN="$JAVA_HOME"/bin/java
+readFromConfigFile() {
+    local key=$1
+    local defaultValue=$2
+    local configFile=$3
+
+    # first extract the value with the given key (1st sed), then trim the result (2nd sed)
+    # if a key exists multiple times, take the "last" one (tail)
+    local value=`sed -n "s/^[ ]*${key}[ ]*: \([^#]*\).*$/\1/p" "${configFile}" | sed "s/^ *//;s/ *$//" | tail -n 1`
+
+    [ -z "$value" ] && echo "$defaultValue" || echo "$value"
+}
+
+
+setJavaHome() {
+    # read JAVA_HOME from config with no default value
+    # NOTE: we need to obtain JAVA_HOME before using BashJavaUtils, so the value for env.java.home must
+    # be in a flattened format, rather than nested, allowing us to retrieve the corresponding value via
+    # shell script.
+    CONF_FILE="$1/flink-conf.yaml"
+    if [ ! -e "$1/flink-conf.yaml" ]; then
+        CONF_FILE="$1/config.yaml"
+    fi;
+    
+    KEY_ENV_JAVA_HOME="env.java.home"
+    MY_JAVA_HOME=$(readFromConfigFile ${KEY_ENV_JAVA_HOME} "" "${CONF_FILE}")
+    # check if config specified JAVA_HOME
+    if [ -z "${MY_JAVA_HOME}" ]; then
+        # config did not specify JAVA_HOME. Use system JAVA_HOME
+        MY_JAVA_HOME="${JAVA_HOME}"
+    fi
+    # check if we have a valid JAVA_HOME and if java is not available
+    if [ -z "${MY_JAVA_HOME}" ] && ! type java > /dev/null 2> /dev/null; then
+        echo "Please specify JAVA_HOME. Either in Flink config ./conf/config.yaml or as system-wide JAVA_HOME."
+        exit 1
     else
+        export JAVA_HOME="${MY_JAVA_HOME}"
+    fi
+}
+  
+setJavaRun() {
+    setJavaHome "$1"
+
+    UNAME=$(uname -s)
+    if [ "${UNAME:0:6}" == "CYGWIN" ]; then
         JAVA_RUN=java
+    else
+        if [[ -d "$JAVA_HOME" ]]; then
+            JAVA_RUN="$JAVA_HOME"/bin/java
+        else
+            JAVA_RUN=java
+        fi
     fi
-fi
+    export JAVA_RUN
+}
 
 manglePathList() {
     UNAME=$(uname -s)
diff --git a/flink-dist/src/main/flink-bin/bin/config-parser-utils.sh b/flink-dist/src/main/flink-bin/bin/config-parser-utils.sh
index cfed6db8618..6e7f41b94d3 100755
--- a/flink-dist/src/main/flink-bin/bin/config-parser-utils.sh
+++ b/flink-dist/src/main/flink-bin/bin/config-parser-utils.sh
@@ -25,6 +25,7 @@ if [ "$#" -lt 3 ]; then
 fi
 
 source "$2"/bash-java-utils.sh
+setJavaRun "$FLINK_CONF_DIR"
 
 ARGS=("${@:1}")
 result=$(updateAndGetFlinkConfiguration "${ARGS[@]}")
diff --git a/flink-dist/src/main/flink-bin/bin/config.sh b/flink-dist/src/main/flink-bin/bin/config.sh
index 2959f9c5ece..e45e1fb4f36 100755
--- a/flink-dist/src/main/flink-bin/bin/config.sh
+++ b/flink-dist/src/main/flink-bin/bin/config.sh
@@ -213,6 +213,7 @@ export FLINK_LIB_DIR
 export FLINK_OPT_DIR
 
 source "${FLINK_BIN_DIR}/bash-java-utils.sh"
+setJavaRun "$FLINK_CONF_DIR"
 YAML_CONF=$(updateAndGetFlinkConfiguration "${FLINK_CONF_DIR}" "${FLINK_BIN_DIR}" ${FLINK_LIB_DIR} -flatten)
 
 ########################################################################################################################
diff --git a/flink-dist/src/test/bin/runBashJavaUtilsCmd.sh b/flink-dist/src/test/bin/runBashJavaUtilsCmd.sh
index e0340146b87..ee2b21a9f2d 100755
--- a/flink-dist/src/test/bin/runBashJavaUtilsCmd.sh
+++ b/flink-dist/src/test/bin/runBashJavaUtilsCmd.sh
@@ -38,6 +38,7 @@ FLINK_DIST_JARS=(`find ${FLINK_TARGET_DIR} -maxdepth 1 -name 'flink-dist*.jar'`)
 FLINK_DIST_CLASSPATH=`echo ${FLINK_DIST_JARS[@]} | tr ' ' ':'`
 
 . ${bin}/../../main/flink-bin/bin/bash-java-utils.sh > /dev/null
+setJavaRun "$FLINK_CONF_DIR"
 
 output=$(runBashJavaUtilsCmd ${COMMAND} ${FLINK_CONF_DIR} "$FLINK_TARGET_DIR/bash-java-utils.jar:${FLINK_DIST_CLASSPATH}" $DYNAMIC_OPTS)
 extractExecutionResults "${output}" ${EXPECTED_LINES}
diff --git a/flink-end-to-end-tests/test-scripts/common.sh b/flink-end-to-end-tests/test-scripts/common.sh
index d3452b4b1bb..db09fdceb15 100755
--- a/flink-end-to-end-tests/test-scripts/common.sh
+++ b/flink-end-to-end-tests/test-scripts/common.sh
@@ -55,6 +55,7 @@ source "${FLINK_DIR}/bin/bash-java-utils.sh"
 if [[ -z "${FLINK_CONF_DIR:-}" ]]; then
     FLINK_CONF_DIR="$FLINK_DIR/conf"
 fi
+setJavaRun "$FLINK_CONF_DIR"
 FLINK_CONF=${FLINK_CONF_DIR}/config.yaml
 # Flatten the configuration file config.yaml to enable end-to-end test cases which will modify 
 # it directly through shell scripts.
