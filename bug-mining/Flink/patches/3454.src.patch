diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamGraphGenerator.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamGraphGenerator.java
index 45435fc7e38..9da4298db74 100644
--- a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamGraphGenerator.java
+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamGraphGenerator.java
@@ -37,6 +37,7 @@ import org.apache.flink.streaming.api.transformations.CoFeedbackTransformation;
 import org.apache.flink.streaming.api.transformations.FeedbackTransformation;
 import org.apache.flink.streaming.api.transformations.OneInputTransformation;
 import org.apache.flink.streaming.api.transformations.PartitionTransformation;
+import org.apache.flink.streaming.api.transformations.PhysicalTransformation;
 import org.apache.flink.streaming.api.transformations.SelectTransformation;
 import org.apache.flink.streaming.api.transformations.SideOutputTransformation;
 import org.apache.flink.streaming.api.transformations.SinkTransformation;
@@ -292,7 +293,9 @@ public class StreamGraphGenerator {
 		}
 
 		if (!streamGraph.getExecutionConfig().hasAutoGeneratedUIDsEnabled()) {
-			if (transform.getUserProvidedNodeHash() == null && transform.getUid() == null) {
+			if (transform instanceof PhysicalTransformation &&
+					transform.getUserProvidedNodeHash() == null &&
+					transform.getUid() == null) {
 				throw new IllegalStateException("Auto generated UIDs have been disabled " +
 					"but no UID or hash has been assigned to operator " + transform.getName());
 			}
diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/graph/StreamingJobGraphGeneratorNodeHashTest.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/graph/StreamingJobGraphGeneratorNodeHashTest.java
index 92a67c9bab8..0726261c98f 100644
--- a/flink-streaming-java/src/test/java/org/apache/flink/streaming/graph/StreamingJobGraphGeneratorNodeHashTest.java
+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/graph/StreamingJobGraphGeneratorNodeHashTest.java
@@ -489,6 +489,19 @@ public class StreamingJobGraphGeneratorNodeHashTest extends TestLogger {
 		env.getStreamGraph();
 	}
 
+	@Test
+	public void testDisablingAutoUidsWorksWithKeyBy() throws Exception {
+		StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
+		env.getConfig().disableAutoGeneratedUIDs();
+
+		env
+			.addSource(new NoOpSourceFunction()).setUidHash("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa")
+			.keyBy(o -> o)
+			.addSink(new DiscardingSink<>()).setUidHash("bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb");
+
+		env.execute();
+	}
+
 	// ------------------------------------------------------------------------
 
 	/**
