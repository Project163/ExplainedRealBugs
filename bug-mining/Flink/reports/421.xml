<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:19:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-2133] Possible deadlock in ExecutionGraph</title>
                <link>https://issues.apache.org/jira/browse/FLINK-2133</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I had the following output on Travis:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Found one Java-level deadlock:
=============================
&lt;span class=&quot;code-quote&quot;&gt;&quot;ForkJoinPool-1-worker-3&quot;&lt;/span&gt;:
  waiting to lock monitor 0x00007f1c54af7eb8 (object 0x00000000d77fa8c0, a org.apache.flink.runtime.util.SerializableObject),
  which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-4&quot;&lt;/span&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-4&quot;&lt;/span&gt;:
  waiting to lock monitor 0x00007f1c5486aca0 (object 0x00000000d77fa218, a org.apache.flink.runtime.util.SerializableObject),
  which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;ForkJoinPool-1-worker-3&quot;&lt;/span&gt;
Java stack information &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the threads listed above:
===================================================
&lt;span class=&quot;code-quote&quot;&gt;&quot;ForkJoinPool-1-worker-3&quot;&lt;/span&gt;:
	at org.apache.flink.runtime.executiongraph.ExecutionJobVertex.resetForNewExecution(ExecutionJobVertex.java:338)
	- waiting to lock &amp;lt;0x00000000d77fa8c0&amp;gt; (a org.apache.flink.runtime.util.SerializableObject)
	at org.apache.flink.runtime.executiongraph.ExecutionGraph.restart(ExecutionGraph.java:595)
	- locked &amp;lt;0x00000000d77fa218&amp;gt; (a org.apache.flink.runtime.util.SerializableObject)
	at org.apache.flink.runtime.executiongraph.ExecutionGraph$3.call(ExecutionGraph.java:733)
	at akka.dispatch.Futures$$anonfun$&lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;$1.apply(Future.scala:94)
	at scala.concurrent.impl.Future$PromiseCompletingRunnable.liftedTree1$1(Future.scala:24)
	at scala.concurrent.impl.Future$PromiseCompletingRunnable.run(Future.scala:24)
	at scala.concurrent.impl.ExecutionContextImpl$$anon$3.exec(ExecutionContextImpl.scala:107)
	at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
	at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)
	at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
	at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
&lt;span class=&quot;code-quote&quot;&gt;&quot;flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-4&quot;&lt;/span&gt;:
	at org.apache.flink.runtime.executiongraph.ExecutionGraph.jobVertexInFinalState(ExecutionGraph.java:683)
	- waiting to lock &amp;lt;0x00000000d77fa218&amp;gt; (a org.apache.flink.runtime.util.SerializableObject)
	at org.apache.flink.runtime.executiongraph.ExecutionJobVertex.subtaskInFinalState(ExecutionJobVertex.java:454)
	- locked &amp;lt;0x00000000d77fa8c0&amp;gt; (a org.apache.flink.runtime.util.SerializableObject)
	at org.apache.flink.runtime.executiongraph.ExecutionJobVertex.vertexCancelled(ExecutionJobVertex.java:426)
	at org.apache.flink.runtime.executiongraph.ExecutionVertex.executionCanceled(ExecutionVertex.java:565)
	at org.apache.flink.runtime.executiongraph.Execution.cancelingComplete(Execution.java:653)
	at org.apache.flink.runtime.executiongraph.ExecutionGraph.updateState(ExecutionGraph.java:784)
	at org.apache.flink.runtime.jobmanager.JobManager$$anonfun$receiveWithLogMessages$1$$anonfun$applyOrElse$2.apply$mcV$sp(JobManager.scala:220)
	at org.apache.flink.runtime.jobmanager.JobManager$$anonfun$receiveWithLogMessages$1$$anonfun$applyOrElse$2.apply(JobManager.scala:219)
	at org.apache.flink.runtime.jobmanager.JobManager$$anonfun$receiveWithLogMessages$1$$anonfun$applyOrElse$2.apply(JobManager.scala:219)
	at scala.concurrent.impl.Future$PromiseCompletingRunnable.liftedTree1$1(Future.scala:24)
	at scala.concurrent.impl.Future$PromiseCompletingRunnable.run(Future.scala:24)
	at akka.dispatch.TaskInvocation.run(AbstractDispatcher.scala:41)
	at akka.dispatch.ForkJoinExecutorConfigurator$AkkaForkJoinTask.exec(AbstractDispatcher.scala:401)
	at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
	at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.pollAndExecAll(ForkJoinPool.java:1253)
	at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1346)
	at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
	at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
Found 1 deadlock.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12834565">FLINK-2133</key>
            <summary>Possible deadlock in ExecutionGraph</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sewen">Stephan Ewen</assignee>
                                    <reporter username="aljoscha">Aljoscha Krettek</reporter>
                        <labels>
                    </labels>
                <created>Tue, 2 Jun 2015 12:33:56 +0000</created>
                <updated>Fri, 5 Jun 2015 21:25:55 +0000</updated>
                            <resolved>Fri, 5 Jun 2015 21:25:42 +0000</resolved>
                                                    <fixVersion>0.9</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14569032" author="aljoscha" created="Tue, 2 Jun 2015 12:36:07 +0000"  >&lt;p&gt;This was the whole travis run: &lt;a href=&quot;https://travis-ci.org/aljoscha/flink/jobs/65039616&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/aljoscha/flink/jobs/65039616&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14569035" author="aljoscha" created="Tue, 2 Jun 2015 12:38:04 +0000"  >&lt;p&gt;Also, this is on my checkpoint-hardening branch: &lt;a href=&quot;https://github.com/aljoscha/flink/tree/checkpoint-hardening&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/aljoscha/flink/tree/checkpoint-hardening&lt;/a&gt;&lt;br/&gt;
I don&apos;t know if this also occurs on master. I&apos;m not seeing this often, most of the travis runs go trough.&lt;/p&gt;</comment>
                            <comment id="14569062" author="uce" created="Tue, 2 Jun 2015 13:02:42 +0000"  >&lt;p&gt;I&apos;ve looked at the ExecutionGraph and this seems to be a simple deadlock due to the ordering of lock acquisitions.&lt;/p&gt;

&lt;p&gt;Two tasks of the same JobVertex aquire the locks in the following order:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;T1 (ForkJoinPool-1-worker-3): ExecutionGraph#restart() aquires ExecutionGraph#progressLock =&amp;gt; ExecutionJobVertex#reset() aquires ExecutionJobVertex#stateMonitor&lt;/li&gt;
	&lt;li&gt;T2 (flink-akka.actor.default-dispatcher-4): ExecutionJobVertex#subtaskInFinalState acquires ExecutionJobVertex#stateMonitor to cancel task =&amp;gt; ExecutionGraph#jobVertexInFinalState() aquires ExecutionGraph#progressLock&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think that both messages have to be triggered by the same task, because both actions should only happen for the final vertex (I think cancel (transition to cancelling) and canceling complete msg (transition to cancelled)). &lt;/p&gt;</comment>
                            <comment id="14575036" author="stephanewen" created="Fri, 5 Jun 2015 19:05:39 +0000"  >&lt;p&gt;Okay, I found a plausible scenario how this can happen: (It is a super hard race)&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;During canceling, the &lt;tt&gt;ExecutionJobVertices&lt;/tt&gt; cancel simultaneously (vertex1 and vertex2)&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;Vertex 1&lt;/tt&gt; transitions into its final state&lt;/li&gt;
	&lt;li&gt;In the executiongraph, it transitions the counter to the next vertex to check/wait for to &lt;tt&gt;vertex 2&lt;/tt&gt; and checks if that one is finished already&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;Vertex 2&lt;/tt&gt; is just done with its final subtask canceling has reached the state where it increments the number of terminal subtasks (ExecutionJobvertex, after 448, but before 454)&lt;/li&gt;
	&lt;li&gt;The thread that finished &lt;tt&gt;vertex 1&lt;/tt&gt; recognizes that this considers &lt;tt&gt;vertex 2&lt;/tt&gt; terminal and marks the job entirely as complete. It triggers restart.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;Vertex 2&lt;/tt&gt; tries to tell the ExecutionGraph that it reached a terminal state and cannot acquire the lock any more that it needs to learn that its transition to terminal has already been registered.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;==&amp;gt; Deadlock&lt;/p&gt;

&lt;p&gt;There is a simple way to fix this, but I am not sure if there is any reasonable way to test this. Seems that one needs to provoke this insanely exact timed race between the threads to provoke that situation.&lt;/p&gt;</comment>
                            <comment id="14575175" author="stephanewen" created="Fri, 5 Jun 2015 20:32:51 +0000"  >&lt;p&gt;Good news, I am able to provoke it in a Unit test (massive random concurrent cancel()).&lt;/p&gt;</comment>
                            <comment id="14575226" author="githubbot" created="Fri, 5 Jun 2015 21:07:17 +0000"  >&lt;p&gt;GitHub user StephanEwen opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/797&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/797&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2133&quot; title=&quot;Possible deadlock in ExecutionGraph&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2133&quot;&gt;&lt;del&gt;FLINK-2133&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;jobmanager&amp;#93;&lt;/span&gt; Fix possible deadlock when vertices transition to final state&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/StephanEwen/incubator-flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/StephanEwen/incubator-flink&lt;/a&gt; final_state_deadlock&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/797.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/797.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #797&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 2298cfedbf880b3a6065a307224c5f3e9e326a0b&lt;br/&gt;
Author: Stephan Ewen &amp;lt;sewen@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-06-05T20:39:29Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2133&quot; title=&quot;Possible deadlock in ExecutionGraph&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2133&quot;&gt;&lt;del&gt;FLINK-2133&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;jobmanager&amp;#93;&lt;/span&gt; Fix possible deadlock when vertices transition to final state.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14575246" author="githubbot" created="Fri, 5 Jun 2015 21:24:54 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/797&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/797&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14575247" author="stephanewen" created="Fri, 5 Jun 2015 21:25:42 +0000"  >&lt;p&gt;Fixed via 2298cfedbf880b3a6065a307224c5f3e9e326a0b&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 24 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ficv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>