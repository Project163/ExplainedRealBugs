<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:57:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-22698] RabbitMQ source does not stop unless message arrives in queue</title>
                <link>https://issues.apache.org/jira/browse/FLINK-22698</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;In a streaming job with multiple RMQSources, a stop-with-savepoint request has unexpected behavior. Regular checkpoints and savepoints complete successfully, it is only the stop-with-savepoint request where this behavior is seen.&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;b&gt;Expected Behavior:&lt;/b&gt;&lt;br/&gt;
The stop-with-savepoint request stops the job with a FINISHED state.&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;b&gt;Actual Behavior:&lt;/b&gt;&lt;br/&gt;
The stop-with-savepoint request either times out or hangs indefinitely unless a message arrives in all the queues that the job consumes from after the stop-with-savepoint request is made.&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;b&gt;Current workaround:&lt;/b&gt;&lt;br/&gt;
Send a sentinel value to each of the queues consumed by the job that the deserialization schema checks in its isEndOfStream method. This is cumbersome and makes it difficult to do stateful upgrades, as coordination with another system is now necessary. &lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
The TaskManager thread dump is attached.&lt;br/&gt;
&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13379137">FLINK-22698</key>
            <summary>RabbitMQ source does not stop unless message arrives in queue</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cmick">Micha&#322; Ciesielczyk</assignee>
                                    <reporter username="austince">Austin Cawley-Edwards</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 18 May 2021 20:34:01 +0000</created>
                <updated>Wed, 17 Nov 2021 15:21:28 +0000</updated>
                            <resolved>Tue, 22 Jun 2021 11:35:29 +0000</resolved>
                                    <version>1.13.1</version>
                    <version>1.12.4</version>
                                    <fixVersion>1.14.0</fixVersion>
                    <fixVersion>1.12.5</fixVersion>
                    <fixVersion>1.13.2</fixVersion>
                                    <component>Connectors/ RabbitMQ</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17347340" author="nicholasjiang" created="Wed, 19 May 2021 06:53:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=austince&quot; class=&quot;user-hover&quot; rel=&quot;austince&quot;&gt;austince&lt;/a&gt;, thank you for your research. From your description, the problem lies in the inspection of IsEndStream method. And the check of the deserialization schema cause difficult&#160;upgrades, therefore this check should consider the state of Job not the isEndOfStream in&#160;deserialization schema. Right?&lt;/p&gt;</comment>
                            <comment id="17347771" author="austince" created="Wed, 19 May 2021 16:48:23 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nicholasjiang&quot; class=&quot;user-hover&quot; rel=&quot;nicholasjiang&quot;&gt;nicholasjiang&lt;/a&gt; &#8211; I think that is correct. I&apos;m coming from &lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/RabbitMQ-source-does-not-stop-unless-message-arrives-in-queue-td43705.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this ML thread&lt;/a&gt; and am trying to get some more information from the OP.&lt;/p&gt;</comment>
                            <comment id="17348011" author="nicholasjiang" created="Thu, 20 May 2021 02:08:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=austince&quot; class=&quot;user-hover&quot; rel=&quot;austince&quot;&gt;austince&lt;/a&gt;, thanks for tracking this issue. From this ML thread, the discussion is in the obstruct progress. IMO, we could fix the IsEndStream method to solve the above problem possiblely.&lt;/p&gt;</comment>
                            <comment id="17349245" author="cmick" created="Fri, 21 May 2021 12:35:08 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=austince&quot; class=&quot;user-hover&quot; rel=&quot;austince&quot;&gt;austince&lt;/a&gt;, we&apos;ve encountered a similar issue after upgrading to Flink 1.12. Seems recent changes (introduced in 1.12) in the RMQSource caused this issue to appear (so most likely 1.13 is affected as well). Actually, it happens with a single queue as well - it&apos;s not possible to stop the job with a savepoint when there is no data on the queue (the job ends up in some weird state). You can still cancel it though (which seems to be a good workaround here).&lt;/p&gt;

&lt;p&gt;I&apos;ve investigated the issue, and its caused by the way how message delivery is implemented in the &lt;font color=&quot;#000000&quot;&gt;QueueingConsumer (or rather on how it&apos;s used). In the run function it is waiting indefinitely for the next message to arrive (without checking if the source was cancelled):&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/0a7ec4fe3f11dbcc1f56685c2211b60d8f496b2d/flink-connectors/flink-connector-rabbitmq/src/main/java/org/apache/flink/streaming/connectors/rabbitmq/RMQSource.java#L329&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/0a7ec4fe3f11dbcc1f56685c2211b60d8f496b2d/flink-connectors/flink-connector-rabbitmq/src/main/java/org/apache/flink/streaming/connectors/rabbitmq/RMQSource.java#L329&lt;/a&gt;&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;So I believe it&apos;s not about inspecting the isEndOfStream method as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nicholasjiang&quot; class=&quot;user-hover&quot; rel=&quot;nicholasjiang&quot;&gt;nicholasjiang&lt;/a&gt; suggested.&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;This can be easily solved by adding a delivery timeout (setting it to some low values such as 15s instead of infinity solves the issue).&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;We&apos;ve already tested this out, and were able to reproduce it with additional unit tests. I suggest to add a deliveryTimeout parameter to the configuration (so by default we could leave the current behavior). If you think it&apos;s a good approach I could create a PR solving the problem.&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17349300" author="austince" created="Fri, 21 May 2021 14:47:04 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cmick&quot; class=&quot;user-hover&quot; rel=&quot;cmick&quot;&gt;cmick&lt;/a&gt; &#8211; that cause makes perfect sense to me. And the proposed solution also sounds good, just a couple of questions:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;What happens when a delivery times out?&lt;/li&gt;
	&lt;li&gt;How do other sources handle this, i.e. Kafka? Do they wait for messages on another thread than where the source&apos;s `run` is called?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Anyway, I&apos;ll assign it to you + thanks for looking into this! Also, I&apos;m going to cc&apos; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fpaul&quot; class=&quot;user-hover&quot; rel=&quot;fpaul&quot;&gt;fpaul&lt;/a&gt;, as he&apos;s been working with this connector (+ others) and its FLIP-27 upgrades. He might have some other ideas.&lt;/p&gt;</comment>
                            <comment id="17350315" author="cmick" created="Mon, 24 May 2021 09:28:40 +0000"  >&lt;p&gt;Thanks.&lt;/p&gt;

&lt;p&gt;When the delivery times out, but the the consumer was not cancelled yet, nothing will happen - the consumer internal queue (LinkedBlockingQueue) will be checked again (one null check needs to be added, as the poll returns null instead of blocking the thread).&lt;/p&gt;

&lt;p&gt;If the consumer was cancelled, the main loop in the source will be completed and the job will be able to stop gracefully.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I will checkout the implementation of other sources. I will write here if I find something that might be of help. Thanks for the suggestion.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17351424" author="nicholasjiang" created="Wed, 26 May 2021 01:32:12 +0000"  >&lt;p&gt;Thanks for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cmick&quot; class=&quot;user-hover&quot; rel=&quot;cmick&quot;&gt;cmick&lt;/a&gt;&apos;s investigation. The solution which adds a deliveryTimeout parameter to the configuration makes sense to me. IMO, this deliveryTimeout could be regarded as configuration option and users could configure this timeout. &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cmick&quot; class=&quot;user-hover&quot; rel=&quot;cmick&quot;&gt;cmick&lt;/a&gt;, In the unit test, how do you configure the delivery timeout which maybe cause the failure of the unit test?&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=austince&quot; class=&quot;user-hover&quot; rel=&quot;austince&quot;&gt;austince&lt;/a&gt;, should the FLIP-27 upgrade of RabbiteMQ Source concern this problem?&lt;/p&gt;</comment>
                            <comment id="17351619" author="cmick" created="Wed, 26 May 2021 08:10:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=austince&quot; class=&quot;user-hover&quot; rel=&quot;austince&quot;&gt;austince&lt;/a&gt; In other data sources it&apos;s handled similarly (via timeout) or by interrupting the consumer thread (for instance Kafka source has a consumer thread running in the background). Adding a delivery timeout will be simple and will do the job here, so I would not recommend refactoring the whole source into thread-based (but maybe its worth considering when implementing the FLIP-27 source).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nicholasjiang&quot; class=&quot;user-hover&quot; rel=&quot;nicholasjiang&quot;&gt;nicholasjiang&lt;/a&gt; Yes, I will add it to configuration. I&apos;m still not sure what should be the default. I would probably go with 0 - meaning no deliveryTimeout (and wait forever) - as this is the current approach (and if fixed in 1.12 or 1.13 this is the way to go). Although, probably in all real-world cases it makes no sense to wait forever for something, so maybe something like 30s would be better here (so in worst case, when there is no input data, the local LinkedBlockingQueue would be checked for new elements every 30s)&lt;/p&gt;

&lt;p&gt;The unit test should be quite straightforward like:&lt;br/&gt;
1) start the source (with very low deliveryTimeout)&lt;br/&gt;
2) cancel the source&lt;br/&gt;
3) wait until source stops (in case of timeout the test fails)&lt;br/&gt;
4) check if there was no exception (there shouldn&apos;t be any cause its stopped gracefully)&lt;br/&gt;
The current tests use a mock that always returns some value from the consumer immediately. That is why the above case would pass the tests now (so additionally the mock will have to be slightly adjusted for this specific test only)&lt;/p&gt;</comment>
                            <comment id="17351899" author="austince" created="Wed, 26 May 2021 16:04:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nicholasjiang&quot; class=&quot;user-hover&quot; rel=&quot;nicholasjiang&quot;&gt;nicholasjiang&lt;/a&gt; &#8211; yes, I agree w/ Micha&#322; that this is something that should be considered w/ the FLIP-27 source, if it has not already been.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cmick&quot; class=&quot;user-hover&quot; rel=&quot;cmick&quot;&gt;cmick&lt;/a&gt; Thanks for the research into other sources, the approach still sounds good to me, including the user-facing configuration option. I&apos;m not sure if there is precedent for it, but we could potentially introduce the fix in 1.14 with a reasonable timeout default (like the suggested 30s), and use the 0s default when backporting to 1.12 + 1.13 to maintain functionality. What do you think of that? Would it be more confusing to users?&lt;/p&gt;</comment>
                            <comment id="17353374" author="cmick" created="Fri, 28 May 2021 14:08:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=austince&quot; class=&quot;user-hover&quot; rel=&quot;austince&quot;&gt;austince&lt;/a&gt; I think it&apos;s a good idea. If someone faces the issue now, it will be easy to solve by setting this parameter, and for all others it will be resolved by default in the next releases.&lt;/p&gt;

&lt;p&gt;I will prepare the PR based on this discussion shortly. Back-port should be easy (I can prepare later as well), just need to modify the default value.&lt;/p&gt;</comment>
                            <comment id="17367250" author="arvid" created="Tue, 22 Jun 2021 11:35:08 +0000"  >&lt;p&gt;Merged into master as 9df4d26530c3dc12345d3c4b26ef1eb7cb672a4, into 1.13 as 19cf47ba7740b149413b418685bc2ec3e9d6b1da, and into 1.12 as 4b4b61485b8675aad177fe1a44d0170d28ae2c01&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13388514">FLINK-23322</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13025617" name="taskmanager_thread_dump.json" size="54239" author="austince" created="Tue, 18 May 2021 20:33:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0r5fk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>