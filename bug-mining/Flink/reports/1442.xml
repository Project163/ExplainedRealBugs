<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:26:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-5530] race condition in AbstractRocksDBState#getSerializedValue</title>
                <link>https://issues.apache.org/jira/browse/FLINK-5530</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;AbstractRocksDBState#getSerializedValue() uses the same key serialisation stream as the ordinary state access methods but is called in parallel during state queries thus violating the assumption of only one thread accessing it. &lt;/p&gt;

&lt;p&gt;This may lead to either wrong results in queries or corrupt data while queries are executed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13035554">FLINK-5530</key>
            <summary>race condition in AbstractRocksDBState#getSerializedValue</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nkruber">Nico Kruber</assignee>
                                    <reporter username="nkruber">Nico Kruber</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Jan 2017 14:48:45 +0000</created>
                <updated>Sun, 22 Jan 2017 10:46:29 +0000</updated>
                            <resolved>Sun, 22 Jan 2017 10:46:28 +0000</resolved>
                                    <version>1.2.0</version>
                                    <fixVersion>1.2.0</fixVersion>
                    <fixVersion>1.3.0</fixVersion>
                                    <component>Runtime / Queryable State</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15826501" author="githubbot" created="Tue, 17 Jan 2017 17:56:58 +0000"  >&lt;p&gt;GitHub user NicoK opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3143&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3143&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5530&quot; title=&quot;race condition in AbstractRocksDBState#getSerializedValue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5530&quot;&gt;&lt;del&gt;FLINK-5530&lt;/del&gt;&lt;/a&gt; fix race condition in AbstractRocksDBState#getSerializedValue&lt;/p&gt;

&lt;p&gt;    `AbstractRocksDBState#getSerializedValue()` uses the same key serialisation&lt;br/&gt;
    stream as the ordinary state access methods but is called in parallel during&lt;br/&gt;
    state queries thus violating the assumption of only one thread accessing it.&lt;/p&gt;

&lt;p&gt;    This may lead to either wrong results in queries or corrupt data while queries&lt;br/&gt;
    are executed.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/NicoK/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/NicoK/flink&lt;/a&gt; flink-5530&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3143.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3143.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3143&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 7fa4c61a04cb96b94907e6ec3803b994d3c6643d&lt;br/&gt;
Author: Nico Kruber &amp;lt;nico@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-01-17T16:38:29Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5530&quot; title=&quot;race condition in AbstractRocksDBState#getSerializedValue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5530&quot;&gt;&lt;del&gt;FLINK-5530&lt;/del&gt;&lt;/a&gt; fix race condition in AbstractRocksDBState#getSerializedValue&lt;/p&gt;

&lt;p&gt;    AbstractRocksDBState#getSerializedValue() uses the same key serialisation&lt;br/&gt;
    stream as the ordinary state access methods but is called in parallel during&lt;br/&gt;
    state queries thus violating the assumption of only one thread accessing it.&lt;/p&gt;

&lt;p&gt;    This may lead to either wrong results in queries or corrupt data while queries&lt;br/&gt;
    are executed.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15826548" author="githubbot" created="Tue, 17 Jan 2017 18:25:24 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3143#discussion_r96476317&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3143#discussion_r96476317&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-contrib/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/AbstractRocksDBState.java &amp;#8212;&lt;br/&gt;
    @@ -132,55 +132,95 @@ public void setCurrentNamespace(N namespace) {&lt;br/&gt;
     				namespaceSerializer);&lt;/p&gt;

&lt;p&gt;     		int keyGroup = KeyGroupRangeAssignment.assignToKeyGroup(des.f0, backend.getNumberOfKeyGroups());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;writeKeyWithGroupAndNamespace(keyGroup, des.f0, des.f1);&lt;/li&gt;
	&lt;li&gt;return backend.db.get(columnFamily, keySerializationStream.toByteArray());&lt;br/&gt;
    +&lt;br/&gt;
    +		// we cannot reuse the keySerializationStream member since this method&lt;br/&gt;
    +		// is called concurrently to the other ones and it may this contain garbage
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    this -&amp;gt; thus?&lt;/p&gt;</comment>
                            <comment id="15827894" author="githubbot" created="Wed, 18 Jan 2017 11:25:34 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3143#discussion_r96612773&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3143#discussion_r96612773&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-contrib/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/AbstractRocksDBState.java &amp;#8212;&lt;br/&gt;
    @@ -132,55 +132,95 @@ public void setCurrentNamespace(N namespace) {&lt;br/&gt;
     				namespaceSerializer);&lt;/p&gt;

&lt;p&gt;     		int keyGroup = KeyGroupRangeAssignment.assignToKeyGroup(des.f0, backend.getNumberOfKeyGroups());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;writeKeyWithGroupAndNamespace(keyGroup, des.f0, des.f1);&lt;/li&gt;
	&lt;li&gt;return backend.db.get(columnFamily, keySerializationStream.toByteArray());&lt;br/&gt;
    +&lt;br/&gt;
    +		// we cannot reuse the keySerializationStream member since this method&lt;br/&gt;
    +		// is called concurrently to the other ones and it may thus contain garbage&lt;br/&gt;
    +		ByteArrayOutputStreamWithPos tmpKeySerializationStream =
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    You don&apos;t need to wrap that heavily, most code uses 120 characters line lengths.&lt;/p&gt;</comment>
                            <comment id="15827895" author="githubbot" created="Wed, 18 Jan 2017 11:25:34 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3143#discussion_r96613631&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3143#discussion_r96613631&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-contrib/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/AbstractRocksDBState.java &amp;#8212;&lt;br/&gt;
    @@ -132,55 +132,95 @@ public void setCurrentNamespace(N namespace) &lt;/p&gt;
{
     				namespaceSerializer);
     
     		int keyGroup = KeyGroupRangeAssignment.assignToKeyGroup(des.f0, backend.getNumberOfKeyGroups());
    -		writeKeyWithGroupAndNamespace(keyGroup, des.f0, des.f1);
    -		return backend.db.get(columnFamily, keySerializationStream.toByteArray());
    +
    +		// we cannot reuse the keySerializationStream member since this method
    +		// is called concurrently to the other ones and it may thus contain garbage
    +		ByteArrayOutputStreamWithPos tmpKeySerializationStream =
    +			new ByteArrayOutputStreamWithPos(128);
    +		DataOutputViewStreamWrapper tmpKeySerializationDateDataOutputView =
    +			new DataOutputViewStreamWrapper(tmpKeySerializationStream);
    +
    +		writeKeyWithGroupAndNamespace(keyGroup, des.f0, des.f1,
    +			tmpKeySerializationStream, tmpKeySerializationDateDataOutputView);
    +
    +		return backend.db.get(columnFamily, tmpKeySerializationStream.toByteArray());
     
     	}

&lt;p&gt;     	protected void writeCurrentKeyWithGroupAndNamespace() throws IOException &lt;/p&gt;
{
    -		writeKeyWithGroupAndNamespace(backend.getCurrentKeyGroupIndex(), backend.getCurrentKey(), currentNamespace);
    +		writeKeyWithGroupAndNamespace(
    +			backend.getCurrentKeyGroupIndex(),
    +			backend.getCurrentKey(),
    +			currentNamespace,
    +			this.keySerializationStream,
    +			this.keySerializationDateDataOutputView);
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected void writeKeyWithGroupAndNamespace(int keyGroup, K key, N namespace) throws IOException {&lt;br/&gt;
    +	protected void writeKeyWithGroupAndNamespace(int keyGroup, K key,&lt;br/&gt;
    +		N namespace,&lt;br/&gt;
    +		final ByteArrayOutputStreamWithPos keySerializationStream,&lt;br/&gt;
    +		final DataOutputView keySerializationDateDataOutputView) throws&lt;br/&gt;
    +		IOException 
{
    +
     		keySerializationStream.reset();
    -		writeKeyGroup(keyGroup);
    -		writeKey(key);
    -		writeNameSpace(namespace);
    +		writeKeyGroup(keyGroup, keySerializationDateDataOutputView);
    +		writeKey(key, keySerializationStream, keySerializationDateDataOutputView);
    +		writeNameSpace(namespace, keySerializationStream, keySerializationDateDataOutputView);
     	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeKeyGroup(int keyGroup) throws IOException {&lt;br/&gt;
    +	private void writeKeyGroup(int keyGroup,&lt;br/&gt;
    +		final DataOutputView keySerializationDateDataOutputView) throws&lt;br/&gt;
    +		IOException 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +     		for (int i = backend.getKeyGroupPrefixBytes(); --i &amp;gt;= 0;) {
     			keySerializationDateDataOutputView.writeByte(keyGroup &amp;gt;&amp;gt;&amp;gt; (i &amp;lt;&amp;lt; 3));
     		}     	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeKey(K key) throws IOException {&lt;br/&gt;
    +	private void writeKey(K key,&lt;br/&gt;
    +		final ByteArrayOutputStreamWithPos keySerializationStream,&lt;br/&gt;
    +		final DataOutputView keySerializationDateDataOutputView) throws&lt;br/&gt;
    +		IOException {&lt;br/&gt;
    +&lt;br/&gt;
     		//write key&lt;br/&gt;
     		int beforeWrite = keySerializationStream.getPosition();&lt;br/&gt;
     		backend.getKeySerializer().serialize(key, keySerializationDateDataOutputView);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		if (ambiguousKeyPossible) &lt;/p&gt;
{
     			//write size of key
    -			writeLengthFrom(beforeWrite);
    +			writeLengthFrom(beforeWrite, keySerializationStream,
    +				keySerializationDateDataOutputView);
     		}
&lt;p&gt;     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeNameSpace(N namespace) throws IOException {&lt;br/&gt;
    +	private void writeNameSpace(N namespace,&lt;br/&gt;
    +		final ByteArrayOutputStreamWithPos keySerializationStream,&lt;br/&gt;
    +		final DataOutputView keySerializationDateDataOutputView) throws&lt;br/&gt;
    +		IOException {&lt;br/&gt;
    +&lt;br/&gt;
     		int beforeWrite = keySerializationStream.getPosition();&lt;br/&gt;
     		namespaceSerializer.serialize(namespace, keySerializationDateDataOutputView);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		if (ambiguousKeyPossible) &lt;/p&gt;
{
     			//write length of namespace
    -			writeLengthFrom(beforeWrite);
    +			writeLengthFrom(beforeWrite, keySerializationStream,
    +				keySerializationDateDataOutputView);
     		}
&lt;p&gt;     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeLengthFrom(int fromPosition) throws IOException {&lt;br/&gt;
    +	private static void writeLengthFrom(int fromPosition,&lt;br/&gt;
    +		final ByteArrayOutputStreamWithPos keySerializationStream,&lt;br/&gt;
    +		final DataOutputView keySerializationDateDataOutputView) throws&lt;br/&gt;
    +		IOException {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think other part of the Flink code do not break between `throws` and exceptions. Would be nice to keep the style similar across the code.&lt;/p&gt;</comment>
                            <comment id="15827896" author="githubbot" created="Wed, 18 Jan 2017 11:25:34 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3143#discussion_r96612430&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3143#discussion_r96612430&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/state/StateBackendTestBase.java &amp;#8212;&lt;br/&gt;
    @@ -242,6 +245,132 @@ public void testValueState() throws Exception &lt;/p&gt;
{
     		backend.dispose();
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests &lt;/p&gt;
{@link ValueState#value()}
&lt;p&gt; and &lt;/p&gt;
{@link KvState#getSerializedValue(byte[])}
&lt;p&gt;    +	 * accessing the state concurrently. They should not get in the way of each&lt;br/&gt;
    +	 * other.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
    +	public void testValueStateRace() throws Exception {&lt;br/&gt;
    +		final AbstractKeyedStateBackend&amp;lt;Integer&amp;gt; backend =&lt;br/&gt;
    +			createKeyedBackend(IntSerializer.INSTANCE);&lt;br/&gt;
    +		final Integer namespace = Integer.valueOf(1);&lt;br/&gt;
    +&lt;br/&gt;
    +		final ValueStateDescriptor&amp;lt;String&amp;gt; kvId =&lt;br/&gt;
    +			new ValueStateDescriptor&amp;lt;&amp;gt;(&quot;id&quot;, String.class);&lt;br/&gt;
    +		kvId.initializeSerializerUnlessSet(new ExecutionConfig());&lt;br/&gt;
    +&lt;br/&gt;
    +		final TypeSerializer&amp;lt;Integer&amp;gt; keySerializer = IntSerializer.INSTANCE;&lt;br/&gt;
    +		final TypeSerializer&amp;lt;Integer&amp;gt; namespaceSerializer =&lt;br/&gt;
    +			IntSerializer.INSTANCE;&lt;br/&gt;
    +		final TypeSerializer&amp;lt;String&amp;gt; valueSerializer = kvId.getSerializer();&lt;br/&gt;
    +&lt;br/&gt;
    +		final ValueState&amp;lt;String&amp;gt; state = backend&lt;br/&gt;
    +			.getPartitionedState(namespace, IntSerializer.INSTANCE, kvId);&lt;br/&gt;
    +&lt;br/&gt;
    +		@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
    +		final KvState&amp;lt;Integer&amp;gt; kvState = (KvState&amp;lt;Integer&amp;gt;) state;&lt;br/&gt;
    +&lt;br/&gt;
    +		/**&lt;br/&gt;
    +		 * 1) Test that ValueState#value() before and after&lt;br/&gt;
    +		 * KvState#getSerializedValue(byte[]) return the same value.&lt;br/&gt;
    +		 */&lt;br/&gt;
    +&lt;br/&gt;
    +		// set some key and namespace&lt;br/&gt;
    +		final int key1 = 1;&lt;br/&gt;
    +		backend.setCurrentKey(key1);&lt;br/&gt;
    +		kvState.setCurrentNamespace(2);&lt;br/&gt;
    +		state.update(&quot;2&quot;);&lt;br/&gt;
    +		assertEquals(&quot;2&quot;, state.value());&lt;br/&gt;
    +&lt;br/&gt;
    +		// query another key and namespace&lt;br/&gt;
    +		assertNull(getSerializedValue(kvState, 3, keySerializer,&lt;br/&gt;
    +			namespace, IntSerializer.INSTANCE,&lt;br/&gt;
    +			valueSerializer));&lt;br/&gt;
    +&lt;br/&gt;
    +		// the state should not have changed!&lt;br/&gt;
    +		assertEquals(&quot;2&quot;, state.value());&lt;br/&gt;
    +&lt;br/&gt;
    +		// re-set values&lt;br/&gt;
    +		kvState.setCurrentNamespace(namespace);&lt;br/&gt;
    +&lt;br/&gt;
    +		/**&lt;br/&gt;
    +		 * 2) Test two threads concurrently using ValueState#value() and&lt;br/&gt;
    +		 * KvState#getSerializedValue(byte[]).&lt;br/&gt;
    +		 */&lt;br/&gt;
    +&lt;br/&gt;
    +		// some modifications to the state&lt;br/&gt;
    +		final int key2 = 10;&lt;br/&gt;
    +		backend.setCurrentKey(key2);&lt;br/&gt;
    +		assertNull(state.value());&lt;br/&gt;
    +		assertNull(getSerializedValue(kvState, key2, keySerializer,&lt;br/&gt;
    +			namespace, namespaceSerializer, valueSerializer));&lt;br/&gt;
    +		state.update(&quot;1&quot;);&lt;br/&gt;
    +&lt;br/&gt;
    +		boolean getterSuccess;&lt;br/&gt;
    +		final Throwable[] throwables = &lt;/p&gt;
{null, null}
&lt;p&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +		final Thread getter = new Thread(&quot;State getter&quot;) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    How about using the `CheckedThread` to avoid the stuff with Throwable arrays, etc&lt;/p&gt;</comment>
                            <comment id="15827897" author="githubbot" created="Wed, 18 Jan 2017 11:25:34 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3143#discussion_r96613474&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3143#discussion_r96613474&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-contrib/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/AbstractRocksDBState.java &amp;#8212;&lt;br/&gt;
    @@ -132,55 +132,95 @@ public void setCurrentNamespace(N namespace) &lt;/p&gt;
{
     				namespaceSerializer);
     
     		int keyGroup = KeyGroupRangeAssignment.assignToKeyGroup(des.f0, backend.getNumberOfKeyGroups());
    -		writeKeyWithGroupAndNamespace(keyGroup, des.f0, des.f1);
    -		return backend.db.get(columnFamily, keySerializationStream.toByteArray());
    +
    +		// we cannot reuse the keySerializationStream member since this method
    +		// is called concurrently to the other ones and it may thus contain garbage
    +		ByteArrayOutputStreamWithPos tmpKeySerializationStream =
    +			new ByteArrayOutputStreamWithPos(128);
    +		DataOutputViewStreamWrapper tmpKeySerializationDateDataOutputView =
    +			new DataOutputViewStreamWrapper(tmpKeySerializationStream);
    +
    +		writeKeyWithGroupAndNamespace(keyGroup, des.f0, des.f1,
    +			tmpKeySerializationStream, tmpKeySerializationDateDataOutputView);
    +
    +		return backend.db.get(columnFamily, tmpKeySerializationStream.toByteArray());
     
     	}

&lt;p&gt;     	protected void writeCurrentKeyWithGroupAndNamespace() throws IOException &lt;/p&gt;
{
    -		writeKeyWithGroupAndNamespace(backend.getCurrentKeyGroupIndex(), backend.getCurrentKey(), currentNamespace);
    +		writeKeyWithGroupAndNamespace(
    +			backend.getCurrentKeyGroupIndex(),
    +			backend.getCurrentKey(),
    +			currentNamespace,
    +			this.keySerializationStream,
    +			this.keySerializationDateDataOutputView);
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected void writeKeyWithGroupAndNamespace(int keyGroup, K key, N namespace) throws IOException {&lt;br/&gt;
    +	protected void writeKeyWithGroupAndNamespace(int keyGroup, K key,&lt;br/&gt;
    +		N namespace,
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Just my personal opinion, but indenting parameters differently than the method body helps readability (say two indentations for the parameter list).&lt;/p&gt;</comment>
                            <comment id="15828101" author="githubbot" created="Wed, 18 Jan 2017 13:55:58 +0000"  >&lt;p&gt;Github user NicoK commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3143#discussion_r96638451&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3143#discussion_r96638451&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/state/StateBackendTestBase.java &amp;#8212;&lt;br/&gt;
    @@ -242,6 +245,132 @@ public void testValueState() throws Exception &lt;/p&gt;
{
     		backend.dispose();
     	}

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests &lt;/p&gt;
{@link ValueState#value()}
&lt;p&gt; and &lt;/p&gt;
{@link KvState#getSerializedValue(byte[])}
&lt;p&gt;    +	 * accessing the state concurrently. They should not get in the way of each&lt;br/&gt;
    +	 * other.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
    +	public void testValueStateRace() throws Exception {&lt;br/&gt;
    +		final AbstractKeyedStateBackend&amp;lt;Integer&amp;gt; backend =&lt;br/&gt;
    +			createKeyedBackend(IntSerializer.INSTANCE);&lt;br/&gt;
    +		final Integer namespace = Integer.valueOf(1);&lt;br/&gt;
    +&lt;br/&gt;
    +		final ValueStateDescriptor&amp;lt;String&amp;gt; kvId =&lt;br/&gt;
    +			new ValueStateDescriptor&amp;lt;&amp;gt;(&quot;id&quot;, String.class);&lt;br/&gt;
    +		kvId.initializeSerializerUnlessSet(new ExecutionConfig());&lt;br/&gt;
    +&lt;br/&gt;
    +		final TypeSerializer&amp;lt;Integer&amp;gt; keySerializer = IntSerializer.INSTANCE;&lt;br/&gt;
    +		final TypeSerializer&amp;lt;Integer&amp;gt; namespaceSerializer =&lt;br/&gt;
    +			IntSerializer.INSTANCE;&lt;br/&gt;
    +		final TypeSerializer&amp;lt;String&amp;gt; valueSerializer = kvId.getSerializer();&lt;br/&gt;
    +&lt;br/&gt;
    +		final ValueState&amp;lt;String&amp;gt; state = backend&lt;br/&gt;
    +			.getPartitionedState(namespace, IntSerializer.INSTANCE, kvId);&lt;br/&gt;
    +&lt;br/&gt;
    +		@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
    +		final KvState&amp;lt;Integer&amp;gt; kvState = (KvState&amp;lt;Integer&amp;gt;) state;&lt;br/&gt;
    +&lt;br/&gt;
    +		/**&lt;br/&gt;
    +		 * 1) Test that ValueState#value() before and after&lt;br/&gt;
    +		 * KvState#getSerializedValue(byte[]) return the same value.&lt;br/&gt;
    +		 */&lt;br/&gt;
    +&lt;br/&gt;
    +		// set some key and namespace&lt;br/&gt;
    +		final int key1 = 1;&lt;br/&gt;
    +		backend.setCurrentKey(key1);&lt;br/&gt;
    +		kvState.setCurrentNamespace(2);&lt;br/&gt;
    +		state.update(&quot;2&quot;);&lt;br/&gt;
    +		assertEquals(&quot;2&quot;, state.value());&lt;br/&gt;
    +&lt;br/&gt;
    +		// query another key and namespace&lt;br/&gt;
    +		assertNull(getSerializedValue(kvState, 3, keySerializer,&lt;br/&gt;
    +			namespace, IntSerializer.INSTANCE,&lt;br/&gt;
    +			valueSerializer));&lt;br/&gt;
    +&lt;br/&gt;
    +		// the state should not have changed!&lt;br/&gt;
    +		assertEquals(&quot;2&quot;, state.value());&lt;br/&gt;
    +&lt;br/&gt;
    +		// re-set values&lt;br/&gt;
    +		kvState.setCurrentNamespace(namespace);&lt;br/&gt;
    +&lt;br/&gt;
    +		/**&lt;br/&gt;
    +		 * 2) Test two threads concurrently using ValueState#value() and&lt;br/&gt;
    +		 * KvState#getSerializedValue(byte[]).&lt;br/&gt;
    +		 */&lt;br/&gt;
    +&lt;br/&gt;
    +		// some modifications to the state&lt;br/&gt;
    +		final int key2 = 10;&lt;br/&gt;
    +		backend.setCurrentKey(key2);&lt;br/&gt;
    +		assertNull(state.value());&lt;br/&gt;
    +		assertNull(getSerializedValue(kvState, key2, keySerializer,&lt;br/&gt;
    +			namespace, namespaceSerializer, valueSerializer));&lt;br/&gt;
    +		state.update(&quot;1&quot;);&lt;br/&gt;
    +&lt;br/&gt;
    +		boolean getterSuccess;&lt;br/&gt;
    +		final Throwable[] throwables = &lt;/p&gt;
{null, null}
&lt;p&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +		final Thread getter = new Thread(&quot;State getter&quot;) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nice replacement - didn&apos;t know about that class&lt;/p&gt;</comment>
                            <comment id="15828102" author="githubbot" created="Wed, 18 Jan 2017 13:56:06 +0000"  >&lt;p&gt;Github user NicoK commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3143#discussion_r96638478&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3143#discussion_r96638478&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-contrib/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/AbstractRocksDBState.java &amp;#8212;&lt;br/&gt;
    @@ -132,55 +132,95 @@ public void setCurrentNamespace(N namespace) {&lt;br/&gt;
     				namespaceSerializer);&lt;/p&gt;

&lt;p&gt;     		int keyGroup = KeyGroupRangeAssignment.assignToKeyGroup(des.f0, backend.getNumberOfKeyGroups());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;writeKeyWithGroupAndNamespace(keyGroup, des.f0, des.f1);&lt;/li&gt;
	&lt;li&gt;return backend.db.get(columnFamily, keySerializationStream.toByteArray());&lt;br/&gt;
    +&lt;br/&gt;
    +		// we cannot reuse the keySerializationStream member since this method&lt;br/&gt;
    +		// is called concurrently to the other ones and it may thus contain garbage&lt;br/&gt;
    +		ByteArrayOutputStreamWithPos tmpKeySerializationStream =
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    yes, I saw very long lines here and there but imho 120 is quite long and affects readability as well - so does wrapping lines to some extend... I will go up to 90 instead&lt;/p&gt;</comment>
                            <comment id="15828105" author="githubbot" created="Wed, 18 Jan 2017 13:56:46 +0000"  >&lt;p&gt;Github user NicoK commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3143#discussion_r96638594&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3143#discussion_r96638594&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-contrib/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/AbstractRocksDBState.java &amp;#8212;&lt;br/&gt;
    @@ -132,55 +132,95 @@ public void setCurrentNamespace(N namespace) &lt;/p&gt;
{
     				namespaceSerializer);
     
     		int keyGroup = KeyGroupRangeAssignment.assignToKeyGroup(des.f0, backend.getNumberOfKeyGroups());
    -		writeKeyWithGroupAndNamespace(keyGroup, des.f0, des.f1);
    -		return backend.db.get(columnFamily, keySerializationStream.toByteArray());
    +
    +		// we cannot reuse the keySerializationStream member since this method
    +		// is called concurrently to the other ones and it may thus contain garbage
    +		ByteArrayOutputStreamWithPos tmpKeySerializationStream =
    +			new ByteArrayOutputStreamWithPos(128);
    +		DataOutputViewStreamWrapper tmpKeySerializationDateDataOutputView =
    +			new DataOutputViewStreamWrapper(tmpKeySerializationStream);
    +
    +		writeKeyWithGroupAndNamespace(keyGroup, des.f0, des.f1,
    +			tmpKeySerializationStream, tmpKeySerializationDateDataOutputView);
    +
    +		return backend.db.get(columnFamily, tmpKeySerializationStream.toByteArray());
     
     	}

&lt;p&gt;     	protected void writeCurrentKeyWithGroupAndNamespace() throws IOException &lt;/p&gt;
{
    -		writeKeyWithGroupAndNamespace(backend.getCurrentKeyGroupIndex(), backend.getCurrentKey(), currentNamespace);
    +		writeKeyWithGroupAndNamespace(
    +			backend.getCurrentKeyGroupIndex(),
    +			backend.getCurrentKey(),
    +			currentNamespace,
    +			this.keySerializationStream,
    +			this.keySerializationDateDataOutputView);
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected void writeKeyWithGroupAndNamespace(int keyGroup, K key, N namespace) throws IOException {&lt;br/&gt;
    +	protected void writeKeyWithGroupAndNamespace(int keyGroup, K key,&lt;br/&gt;
    +		N namespace,
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    it certainly helps - didn&apos;t see how to configure my IntelliJ style to automatically do that though &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15828107" author="githubbot" created="Wed, 18 Jan 2017 13:57:23 +0000"  >&lt;p&gt;Github user NicoK commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3143#discussion_r96638710&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3143#discussion_r96638710&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-contrib/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/AbstractRocksDBState.java &amp;#8212;&lt;br/&gt;
    @@ -132,55 +132,95 @@ public void setCurrentNamespace(N namespace) &lt;/p&gt;
{
     				namespaceSerializer);
     
     		int keyGroup = KeyGroupRangeAssignment.assignToKeyGroup(des.f0, backend.getNumberOfKeyGroups());
    -		writeKeyWithGroupAndNamespace(keyGroup, des.f0, des.f1);
    -		return backend.db.get(columnFamily, keySerializationStream.toByteArray());
    +
    +		// we cannot reuse the keySerializationStream member since this method
    +		// is called concurrently to the other ones and it may thus contain garbage
    +		ByteArrayOutputStreamWithPos tmpKeySerializationStream =
    +			new ByteArrayOutputStreamWithPos(128);
    +		DataOutputViewStreamWrapper tmpKeySerializationDateDataOutputView =
    +			new DataOutputViewStreamWrapper(tmpKeySerializationStream);
    +
    +		writeKeyWithGroupAndNamespace(keyGroup, des.f0, des.f1,
    +			tmpKeySerializationStream, tmpKeySerializationDateDataOutputView);
    +
    +		return backend.db.get(columnFamily, tmpKeySerializationStream.toByteArray());
     
     	}

&lt;p&gt;     	protected void writeCurrentKeyWithGroupAndNamespace() throws IOException &lt;/p&gt;
{
    -		writeKeyWithGroupAndNamespace(backend.getCurrentKeyGroupIndex(), backend.getCurrentKey(), currentNamespace);
    +		writeKeyWithGroupAndNamespace(
    +			backend.getCurrentKeyGroupIndex(),
    +			backend.getCurrentKey(),
    +			currentNamespace,
    +			this.keySerializationStream,
    +			this.keySerializationDateDataOutputView);
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected void writeKeyWithGroupAndNamespace(int keyGroup, K key, N namespace) throws IOException {&lt;br/&gt;
    +	protected void writeKeyWithGroupAndNamespace(int keyGroup, K key,&lt;br/&gt;
    +		N namespace,&lt;br/&gt;
    +		final ByteArrayOutputStreamWithPos keySerializationStream,&lt;br/&gt;
    +		final DataOutputView keySerializationDateDataOutputView) throws&lt;br/&gt;
    +		IOException 
{
    +
     		keySerializationStream.reset();
    -		writeKeyGroup(keyGroup);
    -		writeKey(key);
    -		writeNameSpace(namespace);
    +		writeKeyGroup(keyGroup, keySerializationDateDataOutputView);
    +		writeKey(key, keySerializationStream, keySerializationDateDataOutputView);
    +		writeNameSpace(namespace, keySerializationStream, keySerializationDateDataOutputView);
     	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeKeyGroup(int keyGroup) throws IOException {&lt;br/&gt;
    +	private void writeKeyGroup(int keyGroup,&lt;br/&gt;
    +		final DataOutputView keySerializationDateDataOutputView) throws&lt;br/&gt;
    +		IOException 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +     		for (int i = backend.getKeyGroupPrefixBytes(); --i &amp;gt;= 0;) {
     			keySerializationDateDataOutputView.writeByte(keyGroup &amp;gt;&amp;gt;&amp;gt; (i &amp;lt;&amp;lt; 3));
     		}     	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeKey(K key) throws IOException {&lt;br/&gt;
    +	private void writeKey(K key,&lt;br/&gt;
    +		final ByteArrayOutputStreamWithPos keySerializationStream,&lt;br/&gt;
    +		final DataOutputView keySerializationDateDataOutputView) throws&lt;br/&gt;
    +		IOException {&lt;br/&gt;
    +&lt;br/&gt;
     		//write key&lt;br/&gt;
     		int beforeWrite = keySerializationStream.getPosition();&lt;br/&gt;
     		backend.getKeySerializer().serialize(key, keySerializationDateDataOutputView);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		if (ambiguousKeyPossible) &lt;/p&gt;
{
     			//write size of key
    -			writeLengthFrom(beforeWrite);
    +			writeLengthFrom(beforeWrite, keySerializationStream,
    +				keySerializationDateDataOutputView);
     		}
&lt;p&gt;     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeNameSpace(N namespace) throws IOException {&lt;br/&gt;
    +	private void writeNameSpace(N namespace,&lt;br/&gt;
    +		final ByteArrayOutputStreamWithPos keySerializationStream,&lt;br/&gt;
    +		final DataOutputView keySerializationDateDataOutputView) throws&lt;br/&gt;
    +		IOException {&lt;br/&gt;
    +&lt;br/&gt;
     		int beforeWrite = keySerializationStream.getPosition();&lt;br/&gt;
     		namespaceSerializer.serialize(namespace, keySerializationDateDataOutputView);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		if (ambiguousKeyPossible) &lt;/p&gt;
{
     			//write length of namespace
    -			writeLengthFrom(beforeWrite);
    +			writeLengthFrom(beforeWrite, keySerializationStream,
    +				keySerializationDateDataOutputView);
     		}
&lt;p&gt;     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeLengthFrom(int fromPosition) throws IOException {&lt;br/&gt;
    +	private static void writeLengthFrom(int fromPosition,&lt;br/&gt;
    +		final ByteArrayOutputStreamWithPos keySerializationStream,&lt;br/&gt;
    +		final DataOutputView keySerializationDateDataOutputView) throws&lt;br/&gt;
    +		IOException {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I&apos;ll try to do that manually, too, as I didn&apos;t see a way to teach my IntelliJ style that behaviour&lt;/p&gt;</comment>
                            <comment id="15831533" author="githubbot" created="Fri, 20 Jan 2017 10:46:41 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3143#discussion_r97049360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3143#discussion_r97049360&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-contrib/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/AbstractRocksDBState.java &amp;#8212;&lt;br/&gt;
    @@ -132,55 +132,95 @@ public void setCurrentNamespace(N namespace) {&lt;br/&gt;
     				namespaceSerializer);&lt;/p&gt;

&lt;p&gt;     		int keyGroup = KeyGroupRangeAssignment.assignToKeyGroup(des.f0, backend.getNumberOfKeyGroups());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;writeKeyWithGroupAndNamespace(keyGroup, des.f0, des.f1);&lt;/li&gt;
	&lt;li&gt;return backend.db.get(columnFamily, keySerializationStream.toByteArray());&lt;br/&gt;
    +&lt;br/&gt;
    +		// we cannot reuse the keySerializationStream member since this method&lt;br/&gt;
    +		// is called concurrently to the other ones and it may thus contain garbage&lt;br/&gt;
    +		ByteArrayOutputStreamWithPos tmpKeySerializationStream =
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Please try to use the same style as the remainder of the project. I know that every programmer in the world has figured out the perfect code style and is very opinionated on that &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;    Keeping a coherent style in a project is worth a lot and worth compromising...&lt;/p&gt;</comment>
                            <comment id="15831612" author="githubbot" created="Fri, 20 Jan 2017 12:02:56 +0000"  >&lt;p&gt;Github user uce commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3143#discussion_r97059850&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3143#discussion_r97059850&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-contrib/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/AbstractRocksDBState.java &amp;#8212;&lt;br/&gt;
    @@ -132,55 +132,91 @@ public void setCurrentNamespace(N namespace) &lt;/p&gt;
{
     				namespaceSerializer);
     
     		int keyGroup = KeyGroupRangeAssignment.assignToKeyGroup(des.f0, backend.getNumberOfKeyGroups());
    -		writeKeyWithGroupAndNamespace(keyGroup, des.f0, des.f1);
    -		return backend.db.get(columnFamily, keySerializationStream.toByteArray());
    +
    +		// we cannot reuse the keySerializationStream member since this method
    +		// is called concurrently to the other ones and it may thus contain garbage
    +		ByteArrayOutputStreamWithPos tmpKeySerializationStream =
    +			new ByteArrayOutputStreamWithPos(128);
    +		DataOutputViewStreamWrapper tmpKeySerializationDateDataOutputView =
    +			new DataOutputViewStreamWrapper(tmpKeySerializationStream);
    +
    +		writeKeyWithGroupAndNamespace(keyGroup, des.f0, des.f1,
    +			tmpKeySerializationStream, tmpKeySerializationDateDataOutputView);
    +
    +		return backend.db.get(columnFamily, tmpKeySerializationStream.toByteArray());
     
     	}

&lt;p&gt;     	protected void writeCurrentKeyWithGroupAndNamespace() throws IOException &lt;/p&gt;
{
    -		writeKeyWithGroupAndNamespace(backend.getCurrentKeyGroupIndex(), backend.getCurrentKey(), currentNamespace);
    +		writeKeyWithGroupAndNamespace(
    +			backend.getCurrentKeyGroupIndex(),
    +			backend.getCurrentKey(),
    +			currentNamespace,
    +			this.keySerializationStream,
    +			this.keySerializationDateDataOutputView);
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected void writeKeyWithGroupAndNamespace(int keyGroup, K key, N namespace) throws IOException {&lt;br/&gt;
    +	protected void writeKeyWithGroupAndNamespace(&lt;br/&gt;
    +			int keyGroup, K key, N namespace,&lt;br/&gt;
    +			final ByteArrayOutputStreamWithPos keySerializationStream,&lt;br/&gt;
    +			final DataOutputView keySerializationDateDataOutputView) throws IOException 
{
    +
     		keySerializationStream.reset();
    -		writeKeyGroup(keyGroup);
    -		writeKey(key);
    -		writeNameSpace(namespace);
    +		writeKeyGroup(keyGroup, keySerializationDateDataOutputView);
    +		writeKey(key, keySerializationStream, keySerializationDateDataOutputView);
    +		writeNameSpace(namespace, keySerializationStream, keySerializationDateDataOutputView);
     	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeKeyGroup(int keyGroup) throws IOException {&lt;br/&gt;
    +	private void writeKeyGroup(&lt;br/&gt;
    +			int keyGroup, final DataOutputView keySerializationDateDataOutputView)&lt;br/&gt;
    +			throws IOException 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +     		for (int i = backend.getKeyGroupPrefixBytes(); --i &amp;gt;= 0;) {
     			keySerializationDateDataOutputView.writeByte(keyGroup &amp;gt;&amp;gt;&amp;gt; (i &amp;lt;&amp;lt; 3));
     		}     	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeKey(K key) throws IOException {&lt;br/&gt;
    +	private void writeKey(&lt;br/&gt;
    +			K key, final ByteArrayOutputStreamWithPos keySerializationStream,&lt;br/&gt;
    +			final DataOutputView keySerializationDateDataOutputView) throws IOException {&lt;br/&gt;
    +&lt;br/&gt;
     		//write key&lt;br/&gt;
     		int beforeWrite = keySerializationStream.getPosition();&lt;br/&gt;
     		backend.getKeySerializer().serialize(key, keySerializationDateDataOutputView);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		if (ambiguousKeyPossible) &lt;/p&gt;
{
     			//write size of key
    -			writeLengthFrom(beforeWrite);
    +			writeLengthFrom(beforeWrite, keySerializationStream,
    +				keySerializationDateDataOutputView);
     		}
&lt;p&gt;     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeNameSpace(N namespace) throws IOException {&lt;br/&gt;
    +	private void writeNameSpace(&lt;br/&gt;
    +			N namespace, final ByteArrayOutputStreamWithPos keySerializationStream,&lt;br/&gt;
    +			final DataOutputView keySerializationDateDataOutputView) throws IOException {&lt;br/&gt;
    +&lt;br/&gt;
     		int beforeWrite = keySerializationStream.getPosition();&lt;br/&gt;
     		namespaceSerializer.serialize(namespace, keySerializationDateDataOutputView);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		if (ambiguousKeyPossible) &lt;/p&gt;
{
     			//write length of namespace
    -			writeLengthFrom(beforeWrite);
    +			writeLengthFrom(beforeWrite, keySerializationStream,
    +				keySerializationDateDataOutputView);
     		}
&lt;p&gt;     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeLengthFrom(int fromPosition) throws IOException {&lt;br/&gt;
    +	private static void writeLengthFrom(&lt;br/&gt;
    +			int fromPosition, final ByteArrayOutputStreamWithPos keySerializationStream,&lt;br/&gt;
    +			final DataOutputView keySerializationDateDataOutputView) throws IOException 
{
    +
     		int length = keySerializationStream.getPosition() - fromPosition;
    -		writeVariableIntBytes(length);
    +		writeVariableIntBytes(length, keySerializationDateDataOutputView);
     	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeVariableIntBytes(int value) throws IOException {&lt;br/&gt;
    +	private static void writeVariableIntBytes(&lt;br/&gt;
    +			int value, final DataOutputView keySerializationDateDataOutputView)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Why are the output view arguments declared `final` here and in other methods? Usually we only mark method arguments as final if required for anonymous classes, etc.&lt;/p&gt;</comment>
                            <comment id="15831683" author="githubbot" created="Fri, 20 Jan 2017 12:45:58 +0000"  >&lt;p&gt;Github user NicoK commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3143#discussion_r97065423&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3143#discussion_r97065423&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-contrib/flink-statebackend-rocksdb/src/main/java/org/apache/flink/contrib/streaming/state/AbstractRocksDBState.java &amp;#8212;&lt;br/&gt;
    @@ -132,55 +132,91 @@ public void setCurrentNamespace(N namespace) &lt;/p&gt;
{
     				namespaceSerializer);
     
     		int keyGroup = KeyGroupRangeAssignment.assignToKeyGroup(des.f0, backend.getNumberOfKeyGroups());
    -		writeKeyWithGroupAndNamespace(keyGroup, des.f0, des.f1);
    -		return backend.db.get(columnFamily, keySerializationStream.toByteArray());
    +
    +		// we cannot reuse the keySerializationStream member since this method
    +		// is called concurrently to the other ones and it may thus contain garbage
    +		ByteArrayOutputStreamWithPos tmpKeySerializationStream =
    +			new ByteArrayOutputStreamWithPos(128);
    +		DataOutputViewStreamWrapper tmpKeySerializationDateDataOutputView =
    +			new DataOutputViewStreamWrapper(tmpKeySerializationStream);
    +
    +		writeKeyWithGroupAndNamespace(keyGroup, des.f0, des.f1,
    +			tmpKeySerializationStream, tmpKeySerializationDateDataOutputView);
    +
    +		return backend.db.get(columnFamily, tmpKeySerializationStream.toByteArray());
     
     	}

&lt;p&gt;     	protected void writeCurrentKeyWithGroupAndNamespace() throws IOException &lt;/p&gt;
{
    -		writeKeyWithGroupAndNamespace(backend.getCurrentKeyGroupIndex(), backend.getCurrentKey(), currentNamespace);
    +		writeKeyWithGroupAndNamespace(
    +			backend.getCurrentKeyGroupIndex(),
    +			backend.getCurrentKey(),
    +			currentNamespace,
    +			this.keySerializationStream,
    +			this.keySerializationDateDataOutputView);
     	}

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected void writeKeyWithGroupAndNamespace(int keyGroup, K key, N namespace) throws IOException {&lt;br/&gt;
    +	protected void writeKeyWithGroupAndNamespace(&lt;br/&gt;
    +			int keyGroup, K key, N namespace,&lt;br/&gt;
    +			final ByteArrayOutputStreamWithPos keySerializationStream,&lt;br/&gt;
    +			final DataOutputView keySerializationDateDataOutputView) throws IOException 
{
    +
     		keySerializationStream.reset();
    -		writeKeyGroup(keyGroup);
    -		writeKey(key);
    -		writeNameSpace(namespace);
    +		writeKeyGroup(keyGroup, keySerializationDateDataOutputView);
    +		writeKey(key, keySerializationStream, keySerializationDateDataOutputView);
    +		writeNameSpace(namespace, keySerializationStream, keySerializationDateDataOutputView);
     	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeKeyGroup(int keyGroup) throws IOException {&lt;br/&gt;
    +	private void writeKeyGroup(&lt;br/&gt;
    +			int keyGroup, final DataOutputView keySerializationDateDataOutputView)&lt;br/&gt;
    +			throws IOException 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +     		for (int i = backend.getKeyGroupPrefixBytes(); --i &amp;gt;= 0;) {
     			keySerializationDateDataOutputView.writeByte(keyGroup &amp;gt;&amp;gt;&amp;gt; (i &amp;lt;&amp;lt; 3));
     		}     	}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeKey(K key) throws IOException {&lt;br/&gt;
    +	private void writeKey(&lt;br/&gt;
    +			K key, final ByteArrayOutputStreamWithPos keySerializationStream,&lt;br/&gt;
    +			final DataOutputView keySerializationDateDataOutputView) throws IOException {&lt;br/&gt;
    +&lt;br/&gt;
     		//write key&lt;br/&gt;
     		int beforeWrite = keySerializationStream.getPosition();&lt;br/&gt;
     		backend.getKeySerializer().serialize(key, keySerializationDateDataOutputView);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		if (ambiguousKeyPossible) &lt;/p&gt;
{
     			//write size of key
    -			writeLengthFrom(beforeWrite);
    +			writeLengthFrom(beforeWrite, keySerializationStream,
    +				keySerializationDateDataOutputView);
     		}
&lt;p&gt;     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeNameSpace(N namespace) throws IOException {&lt;br/&gt;
    +	private void writeNameSpace(&lt;br/&gt;
    +			N namespace, final ByteArrayOutputStreamWithPos keySerializationStream,&lt;br/&gt;
    +			final DataOutputView keySerializationDateDataOutputView) throws IOException {&lt;br/&gt;
    +&lt;br/&gt;
     		int beforeWrite = keySerializationStream.getPosition();&lt;br/&gt;
     		namespaceSerializer.serialize(namespace, keySerializationDateDataOutputView);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		if (ambiguousKeyPossible) &lt;/p&gt;
{
     			//write length of namespace
    -			writeLengthFrom(beforeWrite);
    +			writeLengthFrom(beforeWrite, keySerializationStream,
    +				keySerializationDateDataOutputView);
     		}
&lt;p&gt;     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeLengthFrom(int fromPosition) throws IOException {&lt;br/&gt;
    +	private static void writeLengthFrom(&lt;br/&gt;
    +			int fromPosition, final ByteArrayOutputStreamWithPos keySerializationStream,&lt;br/&gt;
    +			final DataOutputView keySerializationDateDataOutputView) throws IOException 
{
    +
     		int length = keySerializationStream.getPosition() - fromPosition;
    -		writeVariableIntBytes(length);
    +		writeVariableIntBytes(length, keySerializationDateDataOutputView);
     	}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void writeVariableIntBytes(int value) throws IOException {&lt;br/&gt;
    +	private static void writeVariableIntBytes(&lt;br/&gt;
    +			int value, final DataOutputView keySerializationDateDataOutputView)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Just a habit of mine so that I don&apos;t accidentally change a variable that is not supposed to in the current implementation of the method.&lt;br/&gt;
    I agree, however, that it is not very consistent among the parameters of each method, e.g. the `value` parameter in your example. I&apos;ll remove them.&lt;/p&gt;</comment>
                            <comment id="15833448" author="githubbot" created="Sun, 22 Jan 2017 10:46:26 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3143&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3143&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15833449" author="uce" created="Sun, 22 Jan 2017 10:46:28 +0000"  >&lt;p&gt;Fixed in d8222c1 (release-1.2), d16552d (master).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 43 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i38tiv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>