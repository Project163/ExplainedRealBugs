<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:08:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-25728] Potential memory leaks in StreamMultipleInputProcessor</title>
                <link>https://issues.apache.org/jira/browse/FLINK-25728</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We have an application that contains a broadcast process stage. The none-broadcast input has roughly 10 million messages per second, and the broadcast side is some kind of control stream, rarely has message follow through.&#160;&lt;/p&gt;

&lt;p&gt;After several hours of running, the TaskManager will run out of heap memory and restart. We reviewed the application code without finding any relevant issues.&lt;/p&gt;

&lt;p&gt;We found that the running to crash time was roughly the same. Then we make a heap dump before the crash and found mass `CompletableFuture$UniRun` instances.&#160;&lt;/p&gt;

&lt;p&gt;These `CompletableFuture$UniRun` instances consume several gigabytes memories.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The following pic is from the heap dump we get from a mock testing stream with the same scenario.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13039143/13039143_image-2022-01-20-18-43-32-816.png&quot; height=&quot;471&quot; width=&quot;1161&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;After some source code research. We found that it might be caused by the &lt;b&gt;StreamMultipleInputProcessor.getAvailableFuture()&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;StreamMultipleInputProcessor&lt;/b&gt; has multiple &lt;b&gt;inputProcessors&lt;/b&gt; , it&apos;s &lt;b&gt;availableFuture&lt;/b&gt; got completed when any of it&apos;s input&apos;s &lt;b&gt;availableFuture&lt;/b&gt; is complete. &lt;br/&gt;
The current implementation create a new &lt;b&gt;CompletableFuture&lt;/b&gt; and a new &lt;b&gt;CompletableFuture$UniRun&lt;/b&gt; append to delegate inputProcessor&apos;s &lt;b&gt;avaiableFuture&lt;/b&gt;.&lt;br/&gt;
The issue is caused by the stacking of &lt;b&gt;CompletableFuture$UniRun&lt;/b&gt; on the slow inputProcessor&apos;s &lt;b&gt;avaiableFuture&lt;/b&gt;. &lt;br/&gt;
See the source code below.&lt;br/&gt;
&lt;a href=&quot;https://github.com/wpc009/flink/blob/d33c39d974f08a5ac520f220219ecb0796c9448c/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/StreamMultipleInputProcessor.java#L65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;StreamMultipleInputProcessor.java#L65&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Because the &lt;b&gt;UniRun&lt;/b&gt; holds the reference of outside &lt;b&gt;StreamMultipleInputProcessor&lt;/b&gt;&apos;s avaiableFuture, that cause mass &lt;b&gt;CompletableFuture&lt;/b&gt; instance which can not be recycled.&lt;/p&gt;

&lt;p&gt;We made some modifications to the &lt;b&gt;StreamMultipleInputProcessor&lt;/b&gt;.&lt;b&gt;getAvaiableFuture&lt;/b&gt; function, and verify that the issue is gone on our modified version. &lt;/p&gt;

&lt;p&gt;We are willing to make a PR for this fix.&lt;/p&gt;

&lt;p&gt; Heap Dump File &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13039154/13039154_flink-completablefuture-issue.tar.xz&quot; title=&quot;flink-completablefuture-issue.tar.xz attached to FLINK-25728&quot;&gt;flink-completablefuture-issue.tar.xz&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;br/&gt;
PS: This is a YourKit heap dump. may be not compatible HPROF files.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/wpc009/flink/blob/FLINK-25728/flink-end-to-end-tests/flink-datastream-allround-test/src/main/java/org/apache/flink/streaming/tests/MultipleInputStreamMemoryIssueTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Sample Code to reproduce the issue&lt;/a&gt;&lt;br/&gt;
&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13423716">FLINK-25728</key>
            <summary>Potential memory leaks in StreamMultipleInputProcessor</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wpc009">pc wang</assignee>
                                    <reporter username="wpc009">pc wang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 20 Jan 2022 10:25:23 +0000</created>
                <updated>Mon, 31 Jan 2022 16:36:27 +0000</updated>
                            <resolved>Mon, 31 Jan 2022 16:36:27 +0000</resolved>
                                    <version>1.12.5</version>
                    <version>1.13.5</version>
                    <version>1.14.2</version>
                    <version>1.15.0</version>
                                    <fixVersion>1.13.6</fixVersion>
                    <fixVersion>1.14.4</fixVersion>
                    <fixVersion>1.15.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17479328" author="wpc009" created="Thu, 20 Jan 2022 12:26:03 +0000"  >&lt;p&gt;The issue has the same symptoms as &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-24300&quot; title=&quot;MultipleInputOperator is running much more slowly in TPCDS&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-24300&quot;&gt;&lt;del&gt;FLINK-24300&lt;/del&gt;&lt;/a&gt;, beside the momery issue, the mass&#160;&lt;b&gt;CompletableFuture$UniRun&lt;/b&gt; will also cause a long period of CPU busy after a long idle.&lt;/p&gt;</comment>
                            <comment id="17480848" author="wpc009" created="Mon, 24 Jan 2022 06:57:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt; hello, could you please take a look at this issue?&lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="17480850" author="gaoyunhaii" created="Mon, 24 Jan 2022 07:02:19 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wpc009&quot; class=&quot;user-hover&quot; rel=&quot;wpc009&quot;&gt;wpc009&lt;/a&gt; for reporting the issue! I&apos;ll have a look~&#160;&lt;/p&gt;</comment>
                            <comment id="17480976" author="gaoyunhaii" created="Mon, 24 Jan 2022 10:19:40 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wpc009&quot; class=&quot;user-hover&quot; rel=&quot;wpc009&quot;&gt;wpc009&lt;/a&gt; ~ I roughly got the issue, have you already opened a PR for this issue?&lt;/p&gt;</comment>
                            <comment id="17481002" author="wpc009" created="Mon, 24 Jan 2022 10:54:06 +0000"  >&lt;p&gt;Thanks.&lt;br/&gt;
You can reproduce this issue using this &lt;a href=&quot;https://github.com/wpc009/flink-mirror/blob/3ade9719b565beeacf7761ab71d5abb7ba62e62a/flink-end-to-end-tests/flink-datastream-allround-test/src/main/java/org/apache/flink/streaming/tests/MultipleInputStreamMemoryIssueTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Test&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17481008" author="wpc009" created="Mon, 24 Jan 2022 11:03:35 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt;,&lt;br/&gt;
I&apos;m working on a fix for the issue. Currently, it&apos;s working on my test environment.&lt;br/&gt;
I&apos;m ready to make a PR, if it is ok with you.&lt;/p&gt;</comment>
                            <comment id="17481061" author="gaoyunhaii" created="Mon, 24 Jan 2022 12:53:39 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wpc009&quot; class=&quot;user-hover&quot; rel=&quot;wpc009&quot;&gt;wpc009&lt;/a&gt; for the PR~ By the way, is it &lt;a href=&quot;https://github.com/flink-ci/flink-mirror/pull/13&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/flink-ci/flink-mirror/pull/13&lt;/a&gt; ? It should be targeted at apache/flink ~&#160;&#160;&lt;/p&gt;</comment>
                            <comment id="17481070" author="wpc009" created="Mon, 24 Jan 2022 13:08:59 +0000"  >&lt;p&gt;I know. I&apos;m using the &lt;b&gt;&lt;em&gt;flink-mirror&lt;/em&gt;&lt;/b&gt; repo to run some tests on Azure Pipeline.&lt;br/&gt;
I&apos;ll submit a formal PR at apache/flink repo.&lt;/p&gt;</comment>
                            <comment id="17481626" author="till.rohrmann" created="Tue, 25 Jan 2022 07:58:25 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17481909" author="pnowojski" created="Tue, 25 Jan 2022 15:53:02 +0000"  >&lt;p&gt;Thanks for reporting and analysing the issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wpc009&quot; class=&quot;user-hover&quot; rel=&quot;wpc009&quot;&gt;wpc009&lt;/a&gt;. Could you maybe rephrase why &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                        inputProcessors[i]
                                .getAvailableFuture()
                                .thenRun(() -&amp;gt; anyInputAvailable.complete(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;is causing this memory leak?&lt;/p&gt;

&lt;p&gt;Or maybe let me rephrase it. Let&apos;s assume we have two inputs, one is flipping between available/unavailable status, the other is continuously unavailable. Now per each &lt;tt&gt;StreamMultipleInputProcessor#getAvailableFuture&lt;/tt&gt; call, we will create one &lt;tt&gt;CompletableFuture&amp;lt;?&amp;gt; anyInputAvailable&lt;/tt&gt;, referenced by TWO instances &lt;tt&gt;CompletableFuture$UniRun&lt;/tt&gt;, for &lt;tt&gt;inputProcessors&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.getAvailableFuture()&lt;/tt&gt; from each of the inputs. &lt;tt&gt;anyInputAvailable&lt;/tt&gt; will be returned, and it will be completed by first input sooner or later, waking up &lt;tt&gt;SteamTask&lt;/tt&gt; in the process. That&apos;s fine. Now the problem is that each of those &lt;tt&gt;anyInputAvailable&lt;/tt&gt; instance will be in this scenario referenced forever by the second input&apos;s &lt;tt&gt;inputProcessors&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.getAvailableFuture()&lt;/tt&gt;. As long as the second input is not available, we are keep building up the memory leak. &lt;/p&gt;

&lt;p&gt;Did I understand the problem correctly?&lt;/p&gt;</comment>
                            <comment id="17481944" author="wpc009" created="Tue, 25 Jan 2022 16:39:34 +0000"  >&lt;p&gt;That&apos;s correct. A bunch of &lt;b&gt;CompletableFuture&lt;/b&gt; instances and &lt;b&gt;CompletableFuture$UniRun&lt;/b&gt; instances were held by the &lt;em&gt;inputProcessors&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.getAvailableFuture()&lt;/em&gt;  from the idle input.&lt;br/&gt;
Besides the memory issues, when the data was eventually available on the idle input, then the huge amount of &lt;b&gt;CompletableFuture$UniRun&lt;/b&gt; will cause CPU spike.&lt;/p&gt;</comment>
                            <comment id="17481954" author="pnowojski" created="Tue, 25 Jan 2022 16:48:57 +0000"  >&lt;p&gt;Thanks for the confirmation. Good catch! (let&apos;s move the discussion to the PR about how to fix it)&lt;/p&gt;</comment>
                            <comment id="17481956" author="wpc009" created="Tue, 25 Jan 2022 16:52:24 +0000"  >&lt;p&gt;Ok.&lt;/p&gt;</comment>
                            <comment id="17483792" author="pnowojski" created="Fri, 28 Jan 2022 14:04:54 +0000"  >&lt;p&gt;After an offline discussion with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt;, we agreed to merge a fix for this bug without a test coverage. After the feature freeze, we will try to provide stress test coverage for this issue. I&apos;ve created &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-25869&quot; title=&quot;Create a stress test cron build&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-25869&quot;&gt;FLINK-25869&lt;/a&gt; for this purpose.&lt;/p&gt;</comment>
                            <comment id="17484776" author="pnowojski" created="Mon, 31 Jan 2022 16:36:27 +0000"  >&lt;p&gt;Merged to master as a7eadf57e42^ and a7eadf57e42&lt;br/&gt;
Merged to release-1.14 as 761a4623dda^ and 761a4623dda&lt;br/&gt;
Merged to release-1.13 as 9653999a27b^ and 9653999a27b&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13424920">FLINK-25827</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13425415">FLINK-25869</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13401421">FLINK-24300</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13039154" name="flink-completablefuture-issue.tar.xz" size="12725264" author="wpc009" created="Thu, 20 Jan 2022 12:27:07 +0000"/>
                            <attachment id="13039143" name="image-2022-01-20-18-43-32-816.png" size="624931" author="wpc009" created="Thu, 20 Jan 2022 10:43:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 41 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0yrk8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>