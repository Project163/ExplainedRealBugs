<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:30:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7880] flink-queryable-state-java fails with core-dump</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7880</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;flink-queryable-state-java&lt;/tt&gt; module fails on Travis with a core dump.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://travis-ci.org/tillrohrmann/flink/jobs/289949829&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/tillrohrmann/flink/jobs/289949829&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13110898">FLINK-7880</key>
            <summary>flink-queryable-state-java fails with core-dump</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kkl0u">Kostas Kloudas</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                            <label>test-stability</label>
                    </labels>
                <created>Fri, 20 Oct 2017 07:13:14 +0000</created>
                <updated>Wed, 6 Dec 2017 15:44:29 +0000</updated>
                            <resolved>Wed, 6 Dec 2017 15:44:29 +0000</resolved>
                                    <version>1.4.0</version>
                                                    <component>Runtime / Queryable State</component>
                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16212278" author="till.rohrmann" created="Fri, 20 Oct 2017 07:14:26 +0000"  >&lt;p&gt;One more: &lt;a href=&quot;https://travis-ci.org/apache/flink/jobs/290015718&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/apache/flink/jobs/290015718&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16212301" author="kkl0u" created="Fri, 20 Oct 2017 07:47:01 +0000"  >&lt;p&gt;Thanks for opening this. I will check it out!&lt;/p&gt;</comment>
                            <comment id="16214281" author="aljoscha" created="Sun, 22 Oct 2017 11:07:10 +0000"  >&lt;p&gt;I &lt;tt&gt;@Ignored&lt;/tt&gt; the unstable tests in 137e61736b92a0e4c48e4f6ef6d8077c37584da2. They should be re-activated once the cause for the flakyness is found.&lt;/p&gt;</comment>
                            <comment id="16218876" author="till.rohrmann" created="Wed, 25 Oct 2017 15:16:46 +0000"  >&lt;p&gt;Apparently, there are also other QS tests affected by this. Can we either fix this or make sure that only tests are affected but not the real usage of the QS client?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://travis-ci.org/tillrohrmann/flink/jobs/292608461&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/tillrohrmann/flink/jobs/292608461&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16220281" author="kkl0u" created="Thu, 26 Oct 2017 10:31:11 +0000"  >&lt;p&gt;Yes I will look into it.&lt;/p&gt;</comment>
                            <comment id="16220824" author="githubbot" created="Thu, 26 Oct 2017 17:16:16 +0000"  >&lt;p&gt;GitHub user kl0u opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4909&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4909&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7880&quot; title=&quot;flink-queryable-state-java fails with core-dump&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7880&quot;&gt;&lt;del&gt;FLINK-7880&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;QS&amp;#93;&lt;/span&gt; Fix QS test instabilities.&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/kl0u/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/kl0u/flink&lt;/a&gt; qs-test-instability&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4909.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4909.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4909&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 2b3bba7a2e3778cf3f9d580a32bd466d77fcdb39&lt;br/&gt;
Author: kkloudas &amp;lt;kkloudas@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-10-26T17:11:03Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7880&quot; title=&quot;flink-queryable-state-java fails with core-dump&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7880&quot;&gt;&lt;del&gt;FLINK-7880&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;QS&amp;#93;&lt;/span&gt; Fix QS test instabilities.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16220825" author="kkl0u" created="Thu, 26 Oct 2017 17:16:48 +0000"  >&lt;p&gt;I think this PR fixes it.&lt;/p&gt;</comment>
                            <comment id="16221816" author="githubbot" created="Fri, 27 Oct 2017 06:47:10 +0000"  >&lt;p&gt;Github user kl0u commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4909&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4909&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    It should call `dispose()`, you are correct. This was a mistake  due to sloppy &quot;manual rebasing&quot;.&lt;/p&gt;</comment>
                            <comment id="16224042" author="kkl0u" created="Sun, 29 Oct 2017 15:30:59 +0000"  >&lt;p&gt;Merged on master at 6b8f7dc2d818cbe87bdfbe8852cfec5507f77a5a&lt;/p&gt;</comment>
                            <comment id="16224043" author="githubbot" created="Sun, 29 Oct 2017 15:31:23 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4909&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4909&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16226657" author="till.rohrmann" created="Tue, 31 Oct 2017 11:46:30 +0000"  >&lt;p&gt;Given &lt;a href=&quot;https://github.com/apache/flink/commit/f2c3ff3ee3a5121665e32acebbaeee7bbb380e7f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/f2c3ff3ee3a5121665e32acebbaeee7bbb380e7f&lt;/a&gt; I assume that this issue has not been fixed yet.&lt;/p&gt;</comment>
                            <comment id="16227479" author="zentol" created="Tue, 31 Oct 2017 20:33:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; yes it&apos;s still an issue, another occurrence can be seen here: &lt;a href=&quot;https://travis-ci.org/zentol/flink/jobs/295199999&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/zentol/flink/jobs/295199999&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The branch did include the assumed fix.&lt;/p&gt;</comment>
                            <comment id="16237584" author="kkl0u" created="Fri, 3 Nov 2017 13:19:34 +0000"  >&lt;p&gt;I will keep on investigating &lt;b&gt;BUT&lt;/b&gt; I commented out the &lt;tt&gt;queryable state&lt;/tt&gt; code from the tests and they still seem to fail even locally with:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
libc++abi.dylib: terminating with uncaught exception of type std::__1::system_error: mutex lock failed: Invalid argument
/bin/sh: line 1: 10553 Abort trap: 6           /Library/Java/JavaVirtualMachines/jdk1.8.0_60.jdk/Contents/Home/jre/bin/java -Xms256m -Xmx2048m -Dmvn.forkNumber=1 -XX:+UseSerialGC -jar /Users/kkloudas/repos/dataartisans/flink/flink-queryable-state/flink-queryable-state-runtime/target/surefire/surefirebooter6530581495710923655.jar /Users/kkloudas/repos/dataartisans/flink/flink-queryable-state/flink-queryable-state-runtime/target/surefire/surefire7293759706604721607tmp /Users/kkloudas/repos/dataartisans/flink/flink-queryable-state/flink-queryable-state-runtime/target/surefire/surefire_87379374358455308985tmp
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can find my code here &lt;a href=&quot;https://github.com/kl0u/flink/tree/more-than-qs&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/kl0u/flink/tree/more-than-qs&lt;/a&gt; and to reproduce, go to the &lt;tt&gt;flink-queryable-state&lt;/tt&gt; dir and run a couple of times &lt;tt&gt;mvn verify&lt;/tt&gt;. At least on my machine this reproduces the problem.&lt;/p&gt;

&lt;p&gt;So the root problem may not be in the Queryable State but in the sequence of steps taken when shutting down the RocksDB state backend.&lt;/p&gt;</comment>
                            <comment id="16237616" author="gjy" created="Fri, 3 Nov 2017 13:53:26 +0000"  >&lt;p&gt;I have further isolated the problem. The problem still appears even if you are running a single test method. I tried &lt;tt&gt;NonHAQueryableStateRocksDBBackendITCase#testValueState&lt;/tt&gt; and even replaced the state query with a &lt;tt&gt;Thread.sleep(400)&lt;/tt&gt;. My changes to the code are documented here: &lt;a href=&quot;https://github.com/apache/flink/compare/master...GJL:FLINK-7880?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/compare/master...GJL:FLINK-7880?expand=1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To run the tests, I use the command below. Note that multiple iterations may be required. Hence, the &lt;tt&gt;while&lt;/tt&gt; loop.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;while mvn -o clean verify -Dtest=NonHAQueryableStateRocksDBBackendITCase -DfailIfNoTests=false -Dcheckstyle.skip; do :; done
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The failure, I get is the same as mentioned by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkl0u&quot; class=&quot;user-hover&quot; rel=&quot;kkl0u&quot;&gt;kkl0u&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;libc++abi.dylib: terminating with uncaught exception of type std::__1::system_error: mutex lock failed: Invalid argument
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="16238936" author="aljoscha" created="Sat, 4 Nov 2017 11:42:31 +0000"  >&lt;p&gt;I think this is an issue with RocksDB cleanup (or lack thereof). Maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srichter&quot; class=&quot;user-hover&quot; rel=&quot;srichter&quot;&gt;srichter&lt;/a&gt; has an idea?&lt;/p&gt;</comment>
                            <comment id="16239068" author="srichter" created="Sat, 4 Nov 2017 15:55:07 +0000"  >&lt;p&gt;My theory is that the `dispose()` is not properly executed before the test finishes. By adding printouts to the backend&apos;s constructor, dispose(), and the code that waits for cancelation like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
		} &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
			&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;shutdown a&quot;&lt;/span&gt;);
			&lt;span class=&quot;code-comment&quot;&gt;// Free cluster resources
&lt;/span&gt;			&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (jobId != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
				CompletableFuture&amp;lt;CancellationSuccess&amp;gt; cancellation = FutureUtils.toJava(cluster
						.getLeaderGateway(deadline.timeLeft())
						.ask(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JobManagerMessages.CancelJob(jobId), deadline.timeLeft())
						.mapTo(ClassTag$.MODULE$.&amp;lt;CancellationSuccess&amp;gt;apply(CancellationSuccess.class)));

				cancellation.get(deadline.timeLeft().toMillis(), TimeUnit.MILLISECONDS);
			}
			&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;shutdown b&quot;&lt;/span&gt;);
		}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I obtain the following printing order:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
created org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend@58482c7d
created org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend@5278696f
created org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend@11c418d8
created org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend@78424ca5
created org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend@79690844
created org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend@44855a3
created org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend@459dcdef
created org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend@54cef1d0
shutdown a
shutdown b
dispose org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend@11c418d8
dispose org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend@79690844
dispose org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend@58482c7d
dispose org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend@44855a3
dispose org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend@78424ca5
dispose org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend@5278696f
dispose org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend@459dcdef
dispose org.apache.flink.contrib.streaming.state.RocksDBKeyedStateBackend@54cef1d0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I conclude that the way in which the tests waits for cancelation does not work as expected. In particular, it does not ensure that `dispose()` was executed before the method ends and this can lead to problems with the native resources like what you observe.&lt;/p&gt;</comment>
                            <comment id="16240024" author="till.rohrmann" created="Mon, 6 Nov 2017 08:28:28 +0000"  >&lt;p&gt;The &lt;tt&gt;CancellationSuccess&lt;/tt&gt; message is sent after the &lt;tt&gt;JobManager&lt;/tt&gt; has called &lt;tt&gt;cancel&lt;/tt&gt; on the &lt;tt&gt;ExecutionGraph&lt;/tt&gt;. But this does not necessarily mean that the &lt;tt&gt;ExecutionGraph&lt;/tt&gt; is in a terminal state when the client receives the &lt;tt&gt;CancellationSuccess&lt;/tt&gt; message. Thus, waiting on the &lt;tt&gt;CancelJob&lt;/tt&gt; response won&apos;t work to ensure proper job termination/cleanup.&lt;/p&gt;</comment>
                            <comment id="16240153" author="srichter" created="Mon, 6 Nov 2017 11:17:55 +0000"  >&lt;p&gt;Yes, but the test seems to expect that waiting for &lt;tt&gt;CancellationSuccess&lt;/tt&gt; includes a successful cleanup or it was just not aware how important the proper cleanup is with native resources. In any case, I think the origin of this problem might be taking other IT cases as blueprint, and I have seen different patterns for this &quot;wait until the job is gone&quot; problem in different tests. Many of them might be similar to this one, but they will often look correct or cause no trouble if there are no native libraries involved (e.g. test only uses heap backend). I would suggest that there should be one and only one simple (maybe one helper class that does this), idiomatic way of waiting for a job to go away and release all resources that is used throughout all tests that actually want to have this behaviour. Otherwise, for example, extending an existing test to include a different backend can suddenly uncover the improper cleanup and make tests randomly fail with a JVM crash. &lt;/p&gt;

&lt;p&gt;Having a clear way to end IT cases could help to avoid chasing seriously looking, misleading test failures that seem to originate from the RocksDB backend code, but are actually tests problems from improper cleanup. What do you think?&lt;/p&gt;</comment>
                            <comment id="16240252" author="aljoscha" created="Mon, 6 Nov 2017 13:06:10 +0000"  >&lt;p&gt;+2 to (to what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srichter&quot; class=&quot;user-hover&quot; rel=&quot;srichter&quot;&gt;srichter&lt;/a&gt; said)&lt;/p&gt;</comment>
                            <comment id="16259346" author="githubbot" created="Mon, 20 Nov 2017 15:15:30 +0000"  >&lt;p&gt;GitHub user kl0u opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5038&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5038&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7880&quot; title=&quot;flink-queryable-state-java fails with core-dump&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7880&quot;&gt;&lt;del&gt;FLINK-7880&lt;/del&gt;&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7975&quot; title=&quot;Queryable state client does not wait for shutdown completion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7975&quot;&gt;&lt;del&gt;FLINK-7975&lt;/del&gt;&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7974&quot; title=&quot;AbstractServerBase#shutdown does not wait for shutdown completion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7974&quot;&gt;&lt;del&gt;FLINK-7974&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;QS&amp;#93;&lt;/span&gt; QS test instability fix.&lt;/p&gt;

&lt;p&gt;    This is a follow-up on &lt;a href=&quot;https://github.com/apache/flink/pull/4993&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4993&lt;/a&gt;. &lt;br/&gt;
    It contains one additional commit that makes the QS ITcases to wait for proper clean-up before exiting.&lt;/p&gt;

&lt;p&gt;    R: @aljoscha @zentol &lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/kl0u/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/kl0u/flink&lt;/a&gt; qs-shutdown-fin-fin&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5038.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5038.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5038&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 15c39807f560f6ee4f34e4ad1ba245b66dd10b09&lt;br/&gt;
Author: kkloudas &amp;lt;kkloudas@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-11-09T18:21:43Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7975&quot; title=&quot;Queryable state client does not wait for shutdown completion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7975&quot;&gt;&lt;del&gt;FLINK-7975&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;QS&amp;#93;&lt;/span&gt; Wait for QS client to shutdown.&lt;/p&gt;

&lt;p&gt;commit 689502e70cced18a9cb5b2b6435ff500b7bf70dd&lt;br/&gt;
Author: kkloudas &amp;lt;kkloudas@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-11-09T18:30:29Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7974&quot; title=&quot;AbstractServerBase#shutdown does not wait for shutdown completion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7974&quot;&gt;&lt;del&gt;FLINK-7974&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;QS&amp;#93;&lt;/span&gt; Wait for QS abstract server to shutdown.&lt;/p&gt;

&lt;p&gt;commit 5c0e3fc82a88768caa750367fbf02e24848b3b53&lt;br/&gt;
Author: kkloudas &amp;lt;kkloudas@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-11-20T13:28:24Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7880&quot; title=&quot;flink-queryable-state-java fails with core-dump&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7880&quot;&gt;&lt;del&gt;FLINK-7880&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;QS&amp;#93;&lt;/span&gt; Wait for proper resource cleanup after each ITCase.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16259424" author="githubbot" created="Mon, 20 Nov 2017 16:16:42 +0000"  >&lt;p&gt;Github user kl0u closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5038&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5038&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16260866" author="githubbot" created="Tue, 21 Nov 2017 15:04:15 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5038#discussion_r152298240&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5038#discussion_r152298240&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -312,32 +345,43 @@ private void handInChannel(Channel channel) {&lt;br/&gt;
     		/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Close the connecting channel with a ClosedChannelException.&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void close() {&lt;/li&gt;
	&lt;li&gt;close(new ClosedChannelException());&lt;br/&gt;
    +		private CompletableFuture&amp;lt;?&amp;gt; close() 
{
    +			return close(new ClosedChannelException());
     		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Close the connecting channel with an Exception (can be 
{@code null}
&lt;p&gt;)&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;or forward to the established channel.&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void close(Throwable cause) {&lt;/li&gt;
	&lt;li&gt;synchronized (connectLock) {&lt;/li&gt;
	&lt;li&gt;if (!closed) {&lt;/li&gt;
	&lt;li&gt;if (failureCause == null) 
{
    -						failureCause = cause;
    -					}
&lt;p&gt;    +		private CompletableFuture&amp;lt;?&amp;gt; close(Throwable cause) {&lt;br/&gt;
    +			CompletableFuture&amp;lt;?&amp;gt; future = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			if (connectionShutdownFuture.compareAndSet(null, future)) {&lt;br/&gt;
    +				synchronized (connectLock) {&lt;br/&gt;
    +					if (!closed) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    this seems unnecessary, doesn&apos;t the check at L358 guarantee that the entire branch is only executed once?&lt;/p&gt;</comment>
                            <comment id="16260867" author="githubbot" created="Tue, 21 Nov 2017 15:04:15 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5038#discussion_r152299398&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5038#discussion_r152299398&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/network/ClientTest.java &amp;#8212;&lt;br/&gt;
    @@ -95,15 +97,20 @@&lt;/p&gt;

&lt;p&gt;     	private static final Logger LOG = LoggerFactory.getLogger(ClientTest.class);&lt;/p&gt;

&lt;p&gt;    +	private static final FiniteDuration TEST_TIMEOUT = new FiniteDuration(20L, TimeUnit.SECONDS);&lt;br/&gt;
    +&lt;br/&gt;
     	// Thread pool for client bootstrap (shared between tests)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final NioEventLoopGroup NIO_GROUP = new NioEventLoopGroup();&lt;br/&gt;
    +	private NioEventLoopGroup nioGroup;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final FiniteDuration TEST_TIMEOUT = new FiniteDuration(10L, TimeUnit.SECONDS);&lt;br/&gt;
    +	@Before&lt;br/&gt;
    +	public void setUp() throws Exception {&lt;br/&gt;
    +		nioGroup = new NioEventLoopGroup();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    you could just write `private NioEventLoopGroup nioGroup = new NioEventLoopGroup();` and remove the `@Before` method&lt;/p&gt;</comment>
                            <comment id="16260868" author="githubbot" created="Tue, 21 Nov 2017 15:04:15 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5038#discussion_r152294984&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5038#discussion_r152294984&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -166,28 +167,57 @@ public String getClientName() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the client and closes all connections.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;After a call to this method, all returned futures will be failed.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @return A 
{@link CompletableFuture}
&lt;p&gt; that will be completed when the shutdown process is done.&lt;br/&gt;
     	 */&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;if (shutDown.compareAndSet(false, true)) {&lt;br/&gt;
    +	public CompletableFuture&amp;lt;?&amp;gt; shutdown() {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    should be typed to `Void`.&lt;/p&gt;</comment>
                            <comment id="16260869" author="githubbot" created="Tue, 21 Nov 2017 15:04:15 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5038#discussion_r152300724&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5038#discussion_r152300724&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -166,28 +167,57 @@ public String getClientName() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the client and closes all connections.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;After a call to this method, all returned futures will be failed.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @return A 
{@link CompletableFuture}
&lt;p&gt; that will be completed when the shutdown process is done.&lt;br/&gt;
     	 */&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;if (shutDown.compareAndSet(false, true)) {&lt;br/&gt;
    +	public CompletableFuture&amp;lt;?&amp;gt; shutdown() {&lt;br/&gt;
    +		final CompletableFuture&amp;lt;?&amp;gt; newShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +		if (clientShutdownFuture.compareAndSet(null, newShutdownFuture)) {&lt;br/&gt;
    +&lt;br/&gt;
    +			final List&amp;lt;CompletableFuture&amp;lt;?&amp;gt;&amp;gt; connectionFutures = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
     			for (Map.Entry&amp;lt;InetSocketAddress, EstablishedConnection&amp;gt; conn : establishedConnections.entrySet()) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {     				if (establishedConnections.remove(conn.getKey(), conn.getValue())) {
    -					conn.getValue().close();
    +					connectionFutures.add(conn.getValue().close());
     				}&lt;br/&gt;
     			}&lt;br/&gt;
     &lt;br/&gt;
     			for (Map.Entry&amp;lt;InetSocketAddress, PendingConnection&amp;gt; conn : pendingConnections.entrySet()) {&lt;br/&gt;
     				if (pendingConnections.remove(conn.getKey()) != null) {    -					conn.getValue().close();    +					connectionFutures.add(conn.getValue().close());     				}     			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (bootstrap != null) {&lt;/li&gt;
	&lt;li&gt;EventLoopGroup group = bootstrap.group();&lt;/li&gt;
	&lt;li&gt;if (group != null) {&lt;/li&gt;
	&lt;li&gt;group.shutdownGracefully(0L, 10L, TimeUnit.SECONDS);&lt;br/&gt;
    +			CompletableFuture.allOf(&lt;br/&gt;
    +					connectionFutures.toArray(new CompletableFuture&amp;lt;?&amp;gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;connectionFutures.size()&amp;#93;&lt;/span&gt;)&lt;br/&gt;
    +			).whenComplete((result, throwable) -&amp;gt; {&lt;br/&gt;
    +				if (throwable != null) 
{
    +					newShutdownFuture.completeExceptionally(throwable);
    +				}
&lt;p&gt; else if (bootstrap != null) {&lt;br/&gt;
    +					EventLoopGroup group = bootstrap.group();&lt;br/&gt;
    +					if (group != null &amp;amp;&amp;amp; !group.isShutdown()) {&lt;br/&gt;
    +						group.shutdownGracefully(0L, 0L, TimeUnit.MILLISECONDS)&lt;br/&gt;
    +								.addListener(finished -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +									if (finished.isSuccess()) {
    +										newShutdownFuture.complete(null);
    +									} else {
    +										newShutdownFuture.completeExceptionally(finished.cause());
    +									}    +								}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
    +					} else &lt;/p&gt;
{
    +						newShutdownFuture.complete(null);
    +					}
&lt;p&gt;    +				} else &lt;/p&gt;
{
    +					newShutdownFuture.complete(null);
     				}
&lt;p&gt;    +			});&lt;br/&gt;
    +&lt;br/&gt;
    +			// check again if in the meantime another thread completed the future&lt;br/&gt;
    +			if (clientShutdownFuture.compareAndSet(null, newShutdownFuture)) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    where in close() do we set the shutdown future to null? I only see that being done in sendRequest. (which seems fishy)&lt;/p&gt;</comment>
                            <comment id="16260870" author="githubbot" created="Tue, 21 Nov 2017 15:04:15 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5038#discussion_r152298612&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5038#discussion_r152298612&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -386,6 +430,9 @@ private PendingRequest(REQ request) {&lt;br/&gt;
     		/** Reference to a failure that was reported by the channel. */&lt;br/&gt;
     		private final AtomicReference&amp;lt;Throwable&amp;gt; failureCause = new AtomicReference&amp;lt;&amp;gt;();&lt;/p&gt;

&lt;p&gt;    +		/** Atomic shut down future. */&lt;br/&gt;
    +		private final AtomicReference&amp;lt;CompletableFuture&amp;lt;Boolean&amp;gt;&amp;gt; connectionShutdownFuture = new AtomicReference&amp;lt;&amp;gt;(null);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    why does this one suddenly return a boolean?&lt;/p&gt;</comment>
                            <comment id="16260871" author="githubbot" created="Tue, 21 Nov 2017 15:04:15 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5038#discussion_r152297601&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5038#discussion_r152297601&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -312,32 +345,43 @@ private void handInChannel(Channel channel) {&lt;br/&gt;
     		/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Close the connecting channel with a ClosedChannelException.&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void close() {&lt;/li&gt;
	&lt;li&gt;close(new ClosedChannelException());&lt;br/&gt;
    +		private CompletableFuture&amp;lt;?&amp;gt; close() 
{
    +			return close(new ClosedChannelException());
     		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Close the connecting channel with an Exception (can be 
{@code null}
&lt;p&gt;)&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;or forward to the established channel.&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void close(Throwable cause) {&lt;/li&gt;
	&lt;li&gt;synchronized (connectLock) {&lt;/li&gt;
	&lt;li&gt;if (!closed) {&lt;/li&gt;
	&lt;li&gt;if (failureCause == null) 
{
    -						failureCause = cause;
    -					}
&lt;p&gt;    +		private CompletableFuture&amp;lt;?&amp;gt; close(Throwable cause) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    same as above&lt;/p&gt;</comment>
                            <comment id="16264379" author="githubbot" created="Thu, 23 Nov 2017 14:09:59 +0000"  >&lt;p&gt;GitHub user kl0u opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7880&quot; title=&quot;flink-queryable-state-java fails with core-dump&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7880&quot;&gt;&lt;del&gt;FLINK-7880&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;QS&amp;#93;&lt;/span&gt; Wait for proper resource cleanup after each ITCase.&lt;/p&gt;

&lt;p&gt;    R @aljoscha &lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/kl0u/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/kl0u/flink&lt;/a&gt; qs-shutdown-fin-fin&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5062&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit fd8ea759321b83022497e25e2dfa56ac6d976e15&lt;br/&gt;
Author: kkloudas &amp;lt;kkloudas@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-11-09T18:21:43Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7975&quot; title=&quot;Queryable state client does not wait for shutdown completion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7975&quot;&gt;&lt;del&gt;FLINK-7975&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;QS&amp;#93;&lt;/span&gt; Wait for QS client to shutdown.&lt;/p&gt;

&lt;p&gt;commit a474071d5810562326930a147f0ecdcfe506f13d&lt;br/&gt;
Author: kkloudas &amp;lt;kkloudas@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-11-09T18:30:29Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7974&quot; title=&quot;AbstractServerBase#shutdown does not wait for shutdown completion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7974&quot;&gt;&lt;del&gt;FLINK-7974&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;QS&amp;#93;&lt;/span&gt; Wait for QS abstract server to shutdown.&lt;/p&gt;

&lt;p&gt;commit 2ffe223a8c8d89efbee0e08f8b90ea7b58fbf9df&lt;br/&gt;
Author: kkloudas &amp;lt;kkloudas@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-11-20T13:28:24Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7880&quot; title=&quot;flink-queryable-state-java fails with core-dump&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7880&quot;&gt;&lt;del&gt;FLINK-7880&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;QS&amp;#93;&lt;/span&gt; Wait for proper resource cleanup after each ITCase.&lt;/p&gt;

&lt;p&gt;commit f7f8d2a6ebbaf464200c44a902e5b829c88f9499&lt;br/&gt;
Author: kkloudas &amp;lt;kkloudas@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-11-23T13:20:32Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;QS&amp;#93;&lt;/span&gt; ITCase refactoring.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16265060" author="githubbot" created="Fri, 24 Nov 2017 09:14:53 +0000"  >&lt;p&gt;Github user kl0u commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This is a follow-up to &lt;a href=&quot;https://github.com/apache/flink/pull/5062&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16270715" author="githubbot" created="Wed, 29 Nov 2017 13:17:46 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Your follow-up reference points to this very PR &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16270718" author="githubbot" created="Wed, 29 Nov 2017 13:19:58 +0000"  >&lt;p&gt;Github user kl0u commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Fixed @zentol !&lt;/p&gt;</comment>
                            <comment id="16270823" author="githubbot" created="Wed, 29 Nov 2017 14:41:03 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153785916&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153785916&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -166,28 +167,57 @@ public String getClientName() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the client and closes all connections.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;After a call to this method, all returned futures will be failed.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @return A 
{@link CompletableFuture}
&lt;p&gt; that will be completed when the shutdown process is done.&lt;br/&gt;
     	 */&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;if (shutDown.compareAndSet(false, true)) {&lt;br/&gt;
    +	public CompletableFuture&amp;lt;Void&amp;gt; shutdown() {&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Void&amp;gt; newShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +		if (clientShutdownFuture.compareAndSet(null, newShutdownFuture)) {&lt;br/&gt;
    +&lt;br/&gt;
    +			final List&amp;lt;CompletableFuture&amp;lt;Void&amp;gt;&amp;gt; connectionFutures = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
     			for (Map.Entry&amp;lt;InetSocketAddress, EstablishedConnection&amp;gt; conn : establishedConnections.entrySet()) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {     				if (establishedConnections.remove(conn.getKey(), conn.getValue())) {
    -					conn.getValue().close();
    +					connectionFutures.add(conn.getValue().close());
     				}&lt;br/&gt;
     			}&lt;br/&gt;
     &lt;br/&gt;
     			for (Map.Entry&amp;lt;InetSocketAddress, PendingConnection&amp;gt; conn : pendingConnections.entrySet()) {&lt;br/&gt;
     				if (pendingConnections.remove(conn.getKey()) != null) {    -					conn.getValue().close();    +					connectionFutures.add(conn.getValue().close());     				}     			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (bootstrap != null) {&lt;/li&gt;
	&lt;li&gt;EventLoopGroup group = bootstrap.group();&lt;/li&gt;
	&lt;li&gt;if (group != null) {&lt;/li&gt;
	&lt;li&gt;group.shutdownGracefully(0L, 10L, TimeUnit.SECONDS);&lt;br/&gt;
    +			CompletableFuture.allOf(&lt;br/&gt;
    +					connectionFutures.toArray(new CompletableFuture&amp;lt;?&amp;gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;connectionFutures.size()&amp;#93;&lt;/span&gt;)&lt;br/&gt;
    +			).whenComplete((result, throwable) -&amp;gt; {&lt;br/&gt;
    +				if (throwable != null) 
{
    +					newShutdownFuture.completeExceptionally(throwable);
    +				}
&lt;p&gt; else if (bootstrap != null) {&lt;br/&gt;
    +					EventLoopGroup group = bootstrap.group();&lt;br/&gt;
    +					if (group != null &amp;amp;&amp;amp; !group.isShutdown()) {&lt;br/&gt;
    +						group.shutdownGracefully(0L, 0L, TimeUnit.MILLISECONDS)&lt;br/&gt;
    +								.addListener(finished -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +									if (finished.isSuccess()) {
    +										newShutdownFuture.complete(null);
    +									} else {
    +										newShutdownFuture.completeExceptionally(finished.cause());
    +									}    +								}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
    +					} else &lt;/p&gt;
{
    +						newShutdownFuture.complete(null);
    +					}
&lt;p&gt;    +				} else &lt;/p&gt;
{
    +					newShutdownFuture.complete(null);
     				}
&lt;p&gt;    +			});&lt;br/&gt;
    +&lt;br/&gt;
    +			// check again if in the meantime another thread completed the future&lt;br/&gt;
    +			if (clientShutdownFuture.compareAndSet(null, newShutdownFuture)) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This can never be true. We can only arrive here if `clientShutdownFuture.compareAndSet(null, newShutdownFuture)` succeeds, and there is no other code path that ever sets it to null again.&lt;/p&gt;</comment>
                            <comment id="16270824" author="githubbot" created="Wed, 29 Nov 2017 14:41:04 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153788979&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153788979&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/network/ClientTest.java &amp;#8212;&lt;br/&gt;
    @@ -95,15 +97,20 @@&lt;/p&gt;

&lt;p&gt;     	private static final Logger LOG = LoggerFactory.getLogger(ClientTest.class);&lt;/p&gt;

&lt;p&gt;    +	private static final FiniteDuration TEST_TIMEOUT = new FiniteDuration(20L, TimeUnit.SECONDS);&lt;br/&gt;
    +&lt;br/&gt;
     	// Thread pool for client bootstrap (shared between tests)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final NioEventLoopGroup NIO_GROUP = new NioEventLoopGroup();&lt;br/&gt;
    +	private NioEventLoopGroup nioGroup;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static final FiniteDuration TEST_TIMEOUT = new FiniteDuration(10L, TimeUnit.SECONDS);&lt;br/&gt;
    +	@Before&lt;br/&gt;
    +	public void setUp() throws Exception {&lt;br/&gt;
    +		nioGroup = new NioEventLoopGroup();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    this method isn&apos;t strictly necessary; you can also do `private final NioEventLoopGroup nioGroup = new NioEventLoopGroup()`. Then you would also no longer need the null-check in `@After`.&lt;/p&gt;</comment>
                            <comment id="16270825" author="githubbot" created="Wed, 29 Nov 2017 14:41:04 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153790485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153790485&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/network/AbstractServerTest.java &amp;#8212;&lt;br/&gt;
    @@ -86,77 +83,89 @@ public void testServerInitializationFailure() throws Throwable {&lt;br/&gt;
     	 */&lt;br/&gt;
     	@Test&lt;br/&gt;
     	public void testPortRangeSuccess() throws Throwable {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TestServer server1 = null;&lt;/li&gt;
	&lt;li&gt;TestServer server2 = null;&lt;/li&gt;
	&lt;li&gt;Client&amp;lt;TestMessage, TestMessage&amp;gt; client = null;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try {&lt;/li&gt;
	&lt;li&gt;server1 = startServer(&quot;Test Server 1&quot;, 7777, 7778, 7779);&lt;br/&gt;
    +		// this is shared between the two servers.&lt;br/&gt;
    +		AtomicKvStateRequestStats serverStats = new AtomicKvStateRequestStats();&lt;br/&gt;
    +		AtomicKvStateRequestStats clientStats = new AtomicKvStateRequestStats();&lt;br/&gt;
    +&lt;br/&gt;
    +		List&amp;lt;Integer&amp;gt; portList = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +		portList.add(7777);&lt;br/&gt;
    +		portList.add(7778);&lt;br/&gt;
    +		portList.add(7779);&lt;br/&gt;
    +&lt;br/&gt;
    +		try (&lt;br/&gt;
    +				TestServer server1 = new TestServer(&quot;Test Server 1&quot;, serverStats, portList.iterator());&lt;br/&gt;
    +				TestServer server2 = new TestServer(&quot;Test Server 2&quot;, serverStats, portList.iterator());&lt;br/&gt;
    +				TestClient client = new TestClient(&lt;br/&gt;
    +						&quot;Test Client&quot;,&lt;br/&gt;
    +						1,&lt;br/&gt;
    +						new MessageSerializer&amp;lt;&amp;gt;(new TestMessage.TestMessageDeserializer(), new TestMessage.TestMessageDeserializer()),&lt;br/&gt;
    +						clientStats&lt;br/&gt;
    +				)&lt;br/&gt;
    +		) {&lt;br/&gt;
    +			server1.start();&lt;br/&gt;
     			Assert.assertEquals(7777L, server1.getServerAddress().getPort());&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;server2 = startServer(&quot;Test Server 2&quot;, 7777, 7778, 7779);&lt;br/&gt;
    +			server2.start();&lt;br/&gt;
     			Assert.assertEquals(7778L, server2.getServerAddress().getPort());
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    same as above&lt;/p&gt;</comment>
                            <comment id="16270826" author="githubbot" created="Wed, 29 Nov 2017 14:41:04 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153789622&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153789622&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/network/ClientTest.java &amp;#8212;&lt;br/&gt;
    @@ -218,7 +225,18 @@ public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception&lt;br/&gt;
     			assertEquals(expectedRequests, stats.getNumFailed());&lt;br/&gt;
     		} finally {&lt;br/&gt;
     			if (client != null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;client.shutdown();&lt;br/&gt;
    +				try 
{
    +
    +					// todo here we were seeing this problem:
    +					// https://github.com/netty/netty/issues/4357 if we do a get().
    +					// this is why we now simply wait a bit so that everything is
    +					// shut down and then we check
    +
    +					client.shutdown().get(10L, TimeUnit.SECONDS);
    +				}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +					e.printStackTrace();
    +				}
&lt;p&gt;    +				Assert.assertTrue(client.isEventGroupShutdown());&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I would prefer if we would throw `e` in this and similar cases.&lt;/p&gt;</comment>
                            <comment id="16270827" author="githubbot" created="Wed, 29 Nov 2017 14:41:04 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153790032&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153790032&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/network/AbstractServerTest.java &amp;#8212;&lt;br/&gt;
    @@ -60,23 +63,17 @@ public void testServerInitializationFailure() throws Throwable {&lt;br/&gt;
     		expectedEx.expect(FlinkRuntimeException.class);&lt;br/&gt;
     		expectedEx.expectMessage(&quot;Unable to start Test Server 2. All ports in provided range are occupied.&quot;);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TestServer server1 = null;&lt;/li&gt;
	&lt;li&gt;TestServer server2 = null;&lt;/li&gt;
	&lt;li&gt;try {&lt;br/&gt;
    +		List&amp;lt;Integer&amp;gt; portList = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +		portList.add(7777);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;server1 = startServer(&quot;Test Server 1&quot;, 7777);&lt;br/&gt;
    +		try (&lt;br/&gt;
    +				TestServer server1 = new TestServer(&quot;Test Server 1&quot;, new DisabledKvStateRequestStats(), portList.iterator());
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    a safer pattern is to give `server1` multiple ports to choose from and specifically start `server2` on the port `server1` eventually started with.&lt;/p&gt;</comment>
                            <comment id="16270828" author="githubbot" created="Wed, 29 Nov 2017 14:41:04 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153794265&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153794265&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/main/java/org/apache/flink/queryablestate/client/proxy/KvStateClientProxyImpl.java &amp;#8212;&lt;br/&gt;
    @@ -96,7 +98,13 @@ public void start() throws Throwable {&lt;/p&gt;

&lt;p&gt;     	@Override&lt;br/&gt;
     	public void shutdown() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;super.shutdown();&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			Time timeout = Time.seconds(10L);&lt;br/&gt;
    +			shutdownServer(timeout).get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    why not just get(10, TimeUnit.SECONDS)?&lt;/p&gt;</comment>
                            <comment id="16270829" author="githubbot" created="Wed, 29 Nov 2017 14:41:04 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153790466&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153790466&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/network/AbstractServerTest.java &amp;#8212;&lt;br/&gt;
    @@ -86,77 +83,89 @@ public void testServerInitializationFailure() throws Throwable {&lt;br/&gt;
     	 */&lt;br/&gt;
     	@Test&lt;br/&gt;
     	public void testPortRangeSuccess() throws Throwable {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TestServer server1 = null;&lt;/li&gt;
	&lt;li&gt;TestServer server2 = null;&lt;/li&gt;
	&lt;li&gt;Client&amp;lt;TestMessage, TestMessage&amp;gt; client = null;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try {&lt;/li&gt;
	&lt;li&gt;server1 = startServer(&quot;Test Server 1&quot;, 7777, 7778, 7779);&lt;br/&gt;
    +		// this is shared between the two servers.&lt;br/&gt;
    +		AtomicKvStateRequestStats serverStats = new AtomicKvStateRequestStats();&lt;br/&gt;
    +		AtomicKvStateRequestStats clientStats = new AtomicKvStateRequestStats();&lt;br/&gt;
    +&lt;br/&gt;
    +		List&amp;lt;Integer&amp;gt; portList = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +		portList.add(7777);&lt;br/&gt;
    +		portList.add(7778);&lt;br/&gt;
    +		portList.add(7779);&lt;br/&gt;
    +&lt;br/&gt;
    +		try (&lt;br/&gt;
    +				TestServer server1 = new TestServer(&quot;Test Server 1&quot;, serverStats, portList.iterator());&lt;br/&gt;
    +				TestServer server2 = new TestServer(&quot;Test Server 2&quot;, serverStats, portList.iterator());&lt;br/&gt;
    +				TestClient client = new TestClient(&lt;br/&gt;
    +						&quot;Test Client&quot;,&lt;br/&gt;
    +						1,&lt;br/&gt;
    +						new MessageSerializer&amp;lt;&amp;gt;(new TestMessage.TestMessageDeserializer(), new TestMessage.TestMessageDeserializer()),&lt;br/&gt;
    +						clientStats&lt;br/&gt;
    +				)&lt;br/&gt;
    +		) {&lt;br/&gt;
    +			server1.start();&lt;br/&gt;
     			Assert.assertEquals(7777L, server1.getServerAddress().getPort());
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    these should be removed, or generalized to `portRangeStart &amp;lt;= server1.getServerAddress().getPort() &amp;lt;= portRangeEnd`. &lt;/p&gt;</comment>
                            <comment id="16270830" author="githubbot" created="Wed, 29 Nov 2017 14:41:04 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153786954&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153786954&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -312,32 +345,41 @@ private void handInChannel(Channel channel) {&lt;br/&gt;
     		/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Close the connecting channel with a ClosedChannelException.&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void close() {&lt;/li&gt;
	&lt;li&gt;close(new ClosedChannelException());&lt;br/&gt;
    +		private CompletableFuture&amp;lt;Void&amp;gt; close() 
{
    +			return close(new ClosedChannelException());
     		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Close the connecting channel with an Exception (can be 
{@code null}
&lt;p&gt;)&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;or forward to the established channel.&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void close(Throwable cause) {&lt;/li&gt;
	&lt;li&gt;synchronized (connectLock) {&lt;/li&gt;
	&lt;li&gt;if (!closed) {&lt;br/&gt;
    +		private CompletableFuture&amp;lt;Void&amp;gt; close(Throwable cause) {&lt;br/&gt;
    +			CompletableFuture&amp;lt;Void&amp;gt; future = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			if (connectionShutdownFuture.compareAndSet(null, future)) {&lt;br/&gt;
    +				synchronized (connectLock) {&lt;br/&gt;
     					if (failureCause == null) 
{
     						failureCause = cause;
     					}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +					closed = true;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    this field should be redundant, as `(connectionShutdownFuture.get() != null) == closed` should always hold.&lt;/p&gt;</comment>
                            <comment id="16270831" author="githubbot" created="Wed, 29 Nov 2017 14:41:04 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153786058&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153786058&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -300,7 +333,7 @@ private void handInChannel(Channel channel) {&lt;br/&gt;
     					// Check shut down for possible race with shut down. We&lt;br/&gt;
     					// don&apos;t want any lingering connections after shut down,&lt;br/&gt;
     					// which can happen if we don&apos;t check this here.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (shutDown.get()) {&lt;br/&gt;
    +					if (!clientShutdownFuture.compareAndSet(null, null)) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    for clarity we should call `get()` instead of `compareAndSet` since the setting part is a no-op anyway.&lt;/p&gt;</comment>
                            <comment id="16270832" author="githubbot" created="Wed, 29 Nov 2017 14:41:04 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153794621&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153794621&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/client/QueryableStateClient.java &amp;#8212;&lt;br/&gt;
    @@ -108,9 +108,33 @@ public QueryableStateClient(final InetAddress remoteAddress, final int remotePor&lt;br/&gt;
     				new DisabledKvStateRequestStats());&lt;br/&gt;
     	}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/** Shuts down the client. */&lt;/li&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;client.shutdown();&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Shuts down the client and returns a 
{@link CompletableFuture} that&lt;br/&gt;
    +	 * will be completed when the shutdown process is completed.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;If an exception is thrown for any reason, then the returned future&lt;br/&gt;
    +	 * will be completed exceptionally with that exception.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @return A {@link CompletableFuture}
&lt;p&gt; for further handling of the&lt;br/&gt;
    +	 * shutdown result.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public CompletableFuture&amp;lt;?&amp;gt; shutdownAndHandle() &lt;/p&gt;
{
    +		return client.shutdown();
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Shuts down the client and waits until shutdown is completed.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;If an exception is thrown, a warning is printed containing&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    the warning is logged, not printed (generally implies stdout).&lt;/p&gt;</comment>
                            <comment id="16270833" author="githubbot" created="Wed, 29 Nov 2017 14:41:05 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153794159&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153794159&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/main/java/org/apache/flink/queryablestate/server/KvStateServerImpl.java &amp;#8212;&lt;br/&gt;
    @@ -101,6 +103,12 @@ public InetSocketAddress getServerAddress() {&lt;/p&gt;

&lt;p&gt;     	@Override&lt;br/&gt;
     	public void shutdown() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;super.shutdown();&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			Time timeout = Time.seconds(10L);&lt;br/&gt;
    +			shutdownServer(timeout).get(timeout.toMilliseconds(), TimeUnit.MILLISECONDS);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    why not just `get(10, TimeUnit.SECONDS)`?&lt;/p&gt;</comment>
                            <comment id="16270834" author="githubbot" created="Wed, 29 Nov 2017 14:41:06 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153796142&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153796142&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -205,6 +212,11 @@ public void start() throws Throwable {&lt;br/&gt;
     	private boolean attemptToBind(final int port) throws Throwable {&lt;br/&gt;
     		log.debug(&quot;Attempting to start {} on port {}.&quot;, serverName, port);&lt;/p&gt;

&lt;p&gt;    +		// here we reset the future every time because in case of failure&lt;br/&gt;
    +		// to bind, we call shutdown here and this may interfere with future&lt;br/&gt;
    +		// shutdown attempts.&lt;br/&gt;
    +		this.serverShutdownFuture.getAndSet(null);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    If we intend to only support a single start of a server this should use compareAndSet and fail immediately if a shutdown is in progress.&lt;/p&gt;

&lt;p&gt;    If we intend to support multiple starts of a server we should guard start() and shutdown() with a lock since otherwise you easily end up in an inconsistent state.&lt;/p&gt;</comment>
                            <comment id="16270835" author="githubbot" created="Wed, 29 Nov 2017 14:41:06 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153797256&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153797256&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -251,34 +263,81 @@ private boolean attemptToBind(final int port) throws Throwable &lt;/p&gt;
{
     			throw future.cause();
     		}
&lt;p&gt; catch (BindException e) {&lt;br/&gt;
     			log.debug(&quot;Failed to start {} on port {}: {}.&quot;, serverName, port, e.getMessage());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;shutdown();&lt;br/&gt;
    +			try 
{
    +				shutdownServer(Time.seconds(10L)).get();
    +			}
&lt;p&gt; catch (Exception r) {&lt;br/&gt;
    +&lt;br/&gt;
    +				// Here we were seeing this problem:&lt;br/&gt;
    +				// &lt;a href=&quot;https://github.com/netty/netty/issues/4357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/issues/4357&lt;/a&gt; if we do a get().&lt;br/&gt;
    +				// this is why we now simply wait a bit so that everything is&lt;br/&gt;
    +				// shut down and then we check&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    we don&apos;t check anything here.&lt;/p&gt;</comment>
                            <comment id="16270836" author="githubbot" created="Wed, 29 Nov 2017 14:41:06 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153798113&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153798113&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -251,34 +263,81 @@ private boolean attemptToBind(final int port) throws Throwable &lt;/p&gt;
{
     			throw future.cause();
     		}
&lt;p&gt; catch (BindException e) {&lt;br/&gt;
     			log.debug(&quot;Failed to start {} on port {}: {}.&quot;, serverName, port, e.getMessage());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;shutdown();&lt;br/&gt;
    +			try 
{
    +				shutdownServer(Time.seconds(10L)).get();
    +			}
&lt;p&gt; catch (Exception r) {&lt;br/&gt;
    +&lt;br/&gt;
    +				// Here we were seeing this problem:&lt;br/&gt;
    +				// &lt;a href=&quot;https://github.com/netty/netty/issues/4357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/issues/4357&lt;/a&gt; if we do a get().&lt;br/&gt;
    +				// this is why we now simply wait a bit so that everything is&lt;br/&gt;
    +				// shut down and then we check&lt;br/&gt;
    +&lt;br/&gt;
    +				log.warn(&quot;Problem while shutting down {}: {}&quot;, serverName, r.getMessage());&lt;br/&gt;
    +			}&lt;br/&gt;
     		}&lt;br/&gt;
     		// any other type of exception we let it bubble up.&lt;br/&gt;
     		return false;&lt;br/&gt;
     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
    +	 * @param timeout The time to wait for the shutdown process to complete.&lt;br/&gt;
    +	 * @return A 
{@link CompletableFuture}
&lt;p&gt; that will be completed upon termination of the shutdown process.&lt;br/&gt;
     	 */&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;Void&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;br/&gt;
    +		CompletableFuture&amp;lt;Void&amp;gt; shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +		if (serverShutdownFuture.compareAndSet(null, shutdownFuture)) {&lt;br/&gt;
    +			log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Void&amp;gt; groupShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			if (bootstrap != null) {&lt;br/&gt;
    +				EventLoopGroup group = bootstrap.group();&lt;br/&gt;
    +				if (group != null &amp;amp;&amp;amp; !group.isShutdown()) {&lt;br/&gt;
    +					group.shutdownGracefully(0L, 0L, TimeUnit.MILLISECONDS)&lt;br/&gt;
    +							.addListener(finished -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +								if (finished.isSuccess()) {
    +									groupShutdownFuture.complete(null);
    +								} else {
    +									groupShutdownFuture.completeExceptionally(finished.cause());
    +								}    +							}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
    +				} else &lt;/p&gt;
{
    +					groupShutdownFuture.complete(null);
    +				}
&lt;p&gt;    +			} else &lt;/p&gt;
{
    +				groupShutdownFuture.complete(null);
    +			}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (bootstrap != null) {&lt;/li&gt;
	&lt;li&gt;EventLoopGroup group = bootstrap.group();&lt;/li&gt;
	&lt;li&gt;if (group != null) {&lt;/li&gt;
	&lt;li&gt;group.shutdownGracefully(0L, 10L, TimeUnit.SECONDS);&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Void&amp;gt; handlerShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			if (handler == null) 
{
    +				handlerShutdownFuture.complete(null);
    +			}
&lt;p&gt; else {&lt;br/&gt;
    +				handler.shutdown().whenComplete((result, throwable) -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					if (throwable != null) {
    +						handlerShutdownFuture.completeExceptionally(throwable);
    +					} else {
    +						handlerShutdownFuture.complete(null);
    +					}    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
     			}&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Void&amp;gt; queryExecShutdownFuture = CompletableFuture.runAsync(() -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				if (queryExecutor != null) {
    +					ExecutorUtils.gracefulShutdown(timeout.toMilliseconds(), TimeUnit.MILLISECONDS, queryExecutor);
    +				}    +			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +			CompletableFuture.allOf(&lt;br/&gt;
    +					queryExecShutdownFuture, groupShutdownFuture, handlerShutdownFuture&lt;br/&gt;
    +			).whenComplete((result, throwable) -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				if (throwable != null) {
    +					shutdownFuture.completeExceptionally(throwable);
    +				} else {
    +					shutdownFuture.complete(null);
    +				}    +			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
     		}&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;serverAddress = null;&lt;br/&gt;
    +		return serverShutdownFuture.get();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    if `serverShutdownFuture.get != null` is meant to signal a shutdown in progress, then this method should set it back to null before returning.&lt;/p&gt;</comment>
                            <comment id="16270837" author="githubbot" created="Wed, 29 Nov 2017 14:41:06 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153797851&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153797851&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -251,34 +263,81 @@ private boolean attemptToBind(final int port) throws Throwable &lt;/p&gt;
{
     			throw future.cause();
     		}
&lt;p&gt; catch (BindException e) {&lt;br/&gt;
     			log.debug(&quot;Failed to start {} on port {}: {}.&quot;, serverName, port, e.getMessage());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;shutdown();&lt;br/&gt;
    +			try 
{
    +				shutdownServer(Time.seconds(10L)).get();
    +			}
&lt;p&gt; catch (Exception r) {&lt;br/&gt;
    +&lt;br/&gt;
    +				// Here we were seeing this problem:&lt;br/&gt;
    +				// &lt;a href=&quot;https://github.com/netty/netty/issues/4357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/issues/4357&lt;/a&gt; if we do a get().&lt;br/&gt;
    +				// this is why we now simply wait a bit so that everything is&lt;br/&gt;
    +				// shut down and then we check&lt;br/&gt;
    +&lt;br/&gt;
    +				log.warn(&quot;Problem while shutting down {}: {}&quot;, serverName, r.getMessage());&lt;br/&gt;
    +			}&lt;br/&gt;
     		}&lt;br/&gt;
     		// any other type of exception we let it bubble up.&lt;br/&gt;
     		return false;&lt;br/&gt;
     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
    +	 * @param timeout The time to wait for the shutdown process to complete.&lt;br/&gt;
    +	 * @return A 
{@link CompletableFuture}
&lt;p&gt; that will be completed upon termination of the shutdown process.&lt;br/&gt;
     	 */&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;Void&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    i would remove this timeout argument and simply define large timeout for shutting down the `queryExecutor`.&lt;/p&gt;</comment>
                            <comment id="16270838" author="githubbot" created="Wed, 29 Nov 2017 14:41:07 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153793887&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153793887&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/itcases/HAAbstractQueryableStateTestBase.java &amp;#8212;&lt;br/&gt;
    @@ -80,19 +80,18 @@ public static void setup(int proxyPortRangeStart, int serverPortRangeStart) {&lt;/p&gt;

&lt;p&gt;     	@AfterClass&lt;br/&gt;
     	public static void tearDown() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (cluster != null) {&lt;br/&gt;
    +		try 
{
    +			client.shutdownAndWait();
    +
     			cluster.stop();
     			cluster.awaitTermination();
    -		}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
     			zkServer.stop();
     			zkServer.close();
    -		}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +
    +		}
&lt;p&gt; catch (Throwable e) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    try-catch block is unnecessary&lt;/p&gt;</comment>
                            <comment id="16270839" author="githubbot" created="Wed, 29 Nov 2017 14:41:07 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153798768&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153798768&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -166,28 +167,57 @@ public String getClientName() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the client and closes all connections.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;After a call to this method, all returned futures will be failed.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @return A 
{@link CompletableFuture}
&lt;p&gt; that will be completed when the shutdown process is done.&lt;br/&gt;
     	 */&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;if (shutDown.compareAndSet(false, true)) {&lt;br/&gt;
    +	public CompletableFuture&amp;lt;Void&amp;gt; shutdown() {&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Void&amp;gt; newShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    calling shutdown twice in a row will result in a future being returned that never completes.&lt;/p&gt;</comment>
                            <comment id="16270840" author="githubbot" created="Wed, 29 Nov 2017 14:41:07 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153793789&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153793789&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/itcases/NonHAAbstractQueryableStateTestBase.java &amp;#8212;&lt;br/&gt;
    @@ -68,11 +68,14 @@ public static void setup(int proxyPortRangeStart, int serverPortRangeStart) {&lt;br/&gt;
     	@AfterClass&lt;br/&gt;
     	public static void tearDown() {&lt;br/&gt;
     		try &lt;/p&gt;
{
    +			client.shutdownAndWait();
    +
     			cluster.stop();
    -		}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +			cluster.awaitTermination();
    +
    +		}
&lt;p&gt; catch (Throwable e) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    try-catch block is unnecessary&lt;/p&gt;</comment>
                            <comment id="16270841" author="githubbot" created="Wed, 29 Nov 2017 14:41:07 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153798592&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153798592&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -133,7 +134,7 @@ public String getClientName() {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	public CompletableFuture&amp;lt;RESP&amp;gt; sendRequest(final InetSocketAddress serverAddress, final REQ request) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (shutDown.get()) {&lt;br/&gt;
    +		if (!clientShutdownFuture.compareAndSet(null, null)) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    this should use &#180;clientShutdownFuture.get() != null` for clarity.&lt;/p&gt;</comment>
                            <comment id="16270842" author="githubbot" created="Wed, 29 Nov 2017 14:41:08 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153799484&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153799484&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -251,34 +263,81 @@ private boolean attemptToBind(final int port) throws Throwable &lt;/p&gt;
{
     			throw future.cause();
     		}
&lt;p&gt; catch (BindException e) {&lt;br/&gt;
     			log.debug(&quot;Failed to start {} on port {}: {}.&quot;, serverName, port, e.getMessage());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;shutdown();&lt;br/&gt;
    +			try 
{
    +				shutdownServer(Time.seconds(10L)).get();
    +			}
&lt;p&gt; catch (Exception r) {&lt;br/&gt;
    +&lt;br/&gt;
    +				// Here we were seeing this problem:&lt;br/&gt;
    +				// &lt;a href=&quot;https://github.com/netty/netty/issues/4357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/issues/4357&lt;/a&gt; if we do a get().&lt;br/&gt;
    +				// this is why we now simply wait a bit so that everything is&lt;br/&gt;
    +				// shut down and then we check&lt;br/&gt;
    +&lt;br/&gt;
    +				log.warn(&quot;Problem while shutting down {}: {}&quot;, serverName, r.getMessage());&lt;br/&gt;
    +			}&lt;br/&gt;
     		}&lt;br/&gt;
     		// any other type of exception we let it bubble up.&lt;br/&gt;
     		return false;&lt;br/&gt;
     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
    +	 * @param timeout The time to wait for the shutdown process to complete.&lt;br/&gt;
    +	 * @return A 
{@link CompletableFuture}
&lt;p&gt; that will be completed upon termination of the shutdown process.&lt;br/&gt;
     	 */&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;Void&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;br/&gt;
    +		CompletableFuture&amp;lt;Void&amp;gt; shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +		if (serverShutdownFuture.compareAndSet(null, shutdownFuture)) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    calling shutdown twice in a row will result in a future being returned that never completes.&lt;/p&gt;</comment>
                            <comment id="16270843" author="githubbot" created="Wed, 29 Nov 2017 14:41:08 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153801762&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153801762&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -422,20 +467,31 @@ void close() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param cause The cause to close the channel with.&lt;/li&gt;
	&lt;li&gt;@return Channel close future&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private boolean close(Throwable cause) {&lt;/li&gt;
	&lt;li&gt;if (failureCause.compareAndSet(null, cause)) {&lt;/li&gt;
	&lt;li&gt;channel.close();&lt;/li&gt;
	&lt;li&gt;stats.reportInactiveConnection();&lt;br/&gt;
    +		private CompletableFuture&amp;lt;Void&amp;gt; close(Throwable cause) {&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Void&amp;gt; shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (long requestId : pendingRequests.keySet()) {&lt;/li&gt;
	&lt;li&gt;TimestampedCompletableFuture pending = pendingRequests.remove(requestId);&lt;/li&gt;
	&lt;li&gt;if (pending != null &amp;amp;&amp;amp; pending.completeExceptionally(cause)) {&lt;/li&gt;
	&lt;li&gt;stats.reportFailedRequest();&lt;br/&gt;
    +			if (connectionShutdownFuture.compareAndSet(null, shutdownFuture) &amp;amp;&amp;amp;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    this can result in odd race conditions, where one thread has set the shutdownFuture, but another one the failureCause. I would suggest to create a container for the future and exception and update them atomically.&lt;/p&gt;</comment>
                            <comment id="16270844" author="githubbot" created="Wed, 29 Nov 2017 14:41:08 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153801913&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153801913&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -422,20 +467,31 @@ void close() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param cause The cause to close the channel with.&lt;/li&gt;
	&lt;li&gt;@return Channel close future&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private boolean close(Throwable cause) {&lt;/li&gt;
	&lt;li&gt;if (failureCause.compareAndSet(null, cause)) {&lt;/li&gt;
	&lt;li&gt;channel.close();&lt;/li&gt;
	&lt;li&gt;stats.reportInactiveConnection();&lt;br/&gt;
    +		private CompletableFuture&amp;lt;Void&amp;gt; close(Throwable cause) {&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Void&amp;gt; shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (long requestId : pendingRequests.keySet()) {&lt;/li&gt;
	&lt;li&gt;TimestampedCompletableFuture pending = pendingRequests.remove(requestId);&lt;/li&gt;
	&lt;li&gt;if (pending != null &amp;amp;&amp;amp; pending.completeExceptionally(cause)) {&lt;/li&gt;
	&lt;li&gt;stats.reportFailedRequest();&lt;br/&gt;
    +			if (connectionShutdownFuture.compareAndSet(null, shutdownFuture) &amp;amp;&amp;amp;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Let&apos;s also log other shutdown attempts as DEBUG.&lt;/p&gt;</comment>
                            <comment id="16270845" author="githubbot" created="Wed, 29 Nov 2017 14:41:08 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153804310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153804310&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/itcases/AbstractQueryableStateTestBase.java &amp;#8212;&lt;br/&gt;
    @@ -359,12 +355,12 @@ public Integer getKey(Tuple2&amp;lt;Integer, Long&amp;gt; value) throws Exception {&lt;br/&gt;
     		} finally {&lt;br/&gt;
     			// Free cluster resources&lt;br/&gt;
     			if (jobId != null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;scala.concurrent.Future&amp;lt;CancellationSuccess&amp;gt; cancellation = cluster&lt;/li&gt;
	&lt;li&gt;.getLeaderGateway(deadline.timeLeft())&lt;br/&gt;
    +				cluster.getLeaderGateway(deadline.timeLeft())&lt;br/&gt;
     						.ask(new JobManagerMessages.CancelJob(jobId), deadline.timeLeft())&lt;/li&gt;
	&lt;li&gt;.mapTo(ClassTag$.MODULE$.&amp;lt;JobManagerMessages.CancellationSuccess&amp;gt;apply(JobManagerMessages.CancellationSuccess.class));&lt;br/&gt;
    +						.mapTo(ClassTag$.MODULE$.&amp;lt;CancellationSuccess&amp;gt;apply(CancellationSuccess.class));&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Await.ready(cancellation, deadline.timeLeft());&lt;br/&gt;
    +				// we are not waiting for the cancellation to happen because the&lt;br/&gt;
    +				// job has actually failed, as tested above.
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    you can&apos;t guarantee this in the `finally` block. (for example if submitJobDetached failed but the job is actually running)&lt;/p&gt;</comment>
                            <comment id="16270846" author="githubbot" created="Wed, 29 Nov 2017 14:41:08 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153802908&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153802908&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -486,27 +542,25 @@ private boolean close(Throwable cause) {&lt;br/&gt;
     		@Override&lt;br/&gt;
     		public void onRequestResult(long requestId, RESP response) {&lt;br/&gt;
     			TimestampedCompletableFuture pending = pendingRequests.remove(requestId);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (pending != null &amp;amp;&amp;amp; pending.complete(response)) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			if (pending != null &amp;amp;&amp;amp; !pending.isDone()) {
     				long durationMillis = (System.nanoTime() - pending.getTimestamp()) / 1_000_000L;
     				stats.reportSuccessfulRequest(durationMillis);
    +				pending.complete(response);
     			}     		}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		@Override&lt;br/&gt;
     		public void onRequestFailure(long requestId, Throwable cause) {&lt;br/&gt;
     			TimestampedCompletableFuture pending = pendingRequests.remove(requestId);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (pending != null &amp;amp;&amp;amp; pending.completeExceptionally(cause)) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			if (pending != null &amp;amp;&amp;amp; !pending.isDone()) {
     				stats.reportFailedRequest();
    +				pending.completeExceptionally(cause);
     			}     		}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		@Override&lt;br/&gt;
     		public void onFailure(Throwable cause) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (close(cause)) 
{
    -				// Remove from established channels, otherwise future
    -				// requests will be handled by this failed channel.
    -				establishedConnections.remove(serverAddress, this);
    -			}
&lt;p&gt;    +			close(cause).thenAccept(cancelled -&amp;gt; establishedConnections.remove(serverAddress, this));&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    shouldn&apos;t we remove the connection in any case, since if we can&apos;t close &lt;b&gt;something&lt;/b&gt;  is probably wrong with it anyway?&lt;/p&gt;</comment>
                            <comment id="16270847" author="githubbot" created="Wed, 29 Nov 2017 14:41:08 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153804523&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153804523&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/itcases/AbstractQueryableStateTestBase.java &amp;#8212;&lt;br/&gt;
    @@ -434,13 +432,16 @@ public Integer getKey(Tuple2&amp;lt;Integer, Long&amp;gt; value) throws Exception {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;contains a wrong jobId or wrong queryable state name.&lt;br/&gt;
     	 */&lt;br/&gt;
     	@Test&lt;br/&gt;
    +	@Ignore
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    why?&lt;/p&gt;</comment>
                            <comment id="16270848" author="githubbot" created="Wed, 29 Nov 2017 14:41:08 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r153799197&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r153799197&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -166,28 +167,57 @@ public String getClientName() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the client and closes all connections.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;After a call to this method, all returned futures will be failed.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @return A 
{@link CompletableFuture}
&lt;p&gt; that will be completed when the shutdown process is done.&lt;br/&gt;
     	 */&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;if (shutDown.compareAndSet(false, true)) {&lt;br/&gt;
    +	public CompletableFuture&amp;lt;Void&amp;gt; shutdown() {&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Void&amp;gt; newShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +		if (clientShutdownFuture.compareAndSet(null, newShutdownFuture)) {&lt;br/&gt;
    +&lt;br/&gt;
    +			final List&amp;lt;CompletableFuture&amp;lt;Void&amp;gt;&amp;gt; connectionFutures = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
     			for (Map.Entry&amp;lt;InetSocketAddress, EstablishedConnection&amp;gt; conn : establishedConnections.entrySet()) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {     				if (establishedConnections.remove(conn.getKey(), conn.getValue())) {
    -					conn.getValue().close();
    +					connectionFutures.add(conn.getValue().close());
     				}&lt;br/&gt;
     			}&lt;br/&gt;
     &lt;br/&gt;
     			for (Map.Entry&amp;lt;InetSocketAddress, PendingConnection&amp;gt; conn : pendingConnections.entrySet()) {&lt;br/&gt;
     				if (pendingConnections.remove(conn.getKey()) != null) {    -					conn.getValue().close();    +					connectionFutures.add(conn.getValue().close());     				}     			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (bootstrap != null) {&lt;/li&gt;
	&lt;li&gt;EventLoopGroup group = bootstrap.group();&lt;/li&gt;
	&lt;li&gt;if (group != null) {&lt;/li&gt;
	&lt;li&gt;group.shutdownGracefully(0L, 10L, TimeUnit.SECONDS);&lt;br/&gt;
    +			CompletableFuture.allOf(&lt;br/&gt;
    +					connectionFutures.toArray(new CompletableFuture&amp;lt;?&amp;gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;connectionFutures.size()&amp;#93;&lt;/span&gt;)&lt;br/&gt;
    +			).whenComplete((result, throwable) -&amp;gt; {&lt;br/&gt;
    +				if (throwable != null) 
{
    +					newShutdownFuture.completeExceptionally(throwable);
    +				}
&lt;p&gt; else if (bootstrap != null) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    this means that the bootstrap is not shutdown if a connection cannot be closed for whatever reason, which is rather odd. We should still at least try to shut it down.&lt;/p&gt;</comment>
                            <comment id="16278246" author="githubbot" created="Tue, 5 Dec 2017 09:14:27 +0000"  >&lt;p&gt;Github user kl0u commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r154884801&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r154884801&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -251,34 +263,81 @@ private boolean attemptToBind(final int port) throws Throwable &lt;/p&gt;
{
     			throw future.cause();
     		}
&lt;p&gt; catch (BindException e) {&lt;br/&gt;
     			log.debug(&quot;Failed to start {} on port {}: {}.&quot;, serverName, port, e.getMessage());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;shutdown();&lt;br/&gt;
    +			try 
{
    +				shutdownServer(Time.seconds(10L)).get();
    +			}
&lt;p&gt; catch (Exception r) {&lt;br/&gt;
    +&lt;br/&gt;
    +				// Here we were seeing this problem:&lt;br/&gt;
    +				// &lt;a href=&quot;https://github.com/netty/netty/issues/4357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/issues/4357&lt;/a&gt; if we do a get().&lt;br/&gt;
    +				// this is why we now simply wait a bit so that everything is&lt;br/&gt;
    +				// shut down and then we check&lt;br/&gt;
    +&lt;br/&gt;
    +				log.warn(&quot;Problem while shutting down {}: {}&quot;, serverName, r.getMessage());&lt;br/&gt;
    +			}&lt;br/&gt;
     		}&lt;br/&gt;
     		// any other type of exception we let it bubble up.&lt;br/&gt;
     		return false;&lt;br/&gt;
     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
    +	 * @param timeout The time to wait for the shutdown process to complete.&lt;br/&gt;
    +	 * @return A 
{@link CompletableFuture}
&lt;p&gt; that will be completed upon termination of the shutdown process.&lt;br/&gt;
     	 */&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;Void&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;br/&gt;
    +		CompletableFuture&amp;lt;Void&amp;gt; shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +		if (serverShutdownFuture.compareAndSet(null, shutdownFuture)) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Here the idea is that we atomically set the future the first time (`serverShutdownFuture.compareAndSet(null, shutdownFuture)`), and then, at each subsequent call we return that exact future (`serverShutdownFuture.get();`). So I cannot see how this can lead to returning a future that never completes.&lt;/p&gt;</comment>
                            <comment id="16278253" author="githubbot" created="Tue, 5 Dec 2017 09:16:33 +0000"  >&lt;p&gt;Github user kl0u commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r154885293&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r154885293&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -251,34 +263,81 @@ private boolean attemptToBind(final int port) throws Throwable &lt;/p&gt;
{
     			throw future.cause();
     		}
&lt;p&gt; catch (BindException e) {&lt;br/&gt;
     			log.debug(&quot;Failed to start {} on port {}: {}.&quot;, serverName, port, e.getMessage());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;shutdown();&lt;br/&gt;
    +			try 
{
    +				shutdownServer(Time.seconds(10L)).get();
    +			}
&lt;p&gt; catch (Exception r) {&lt;br/&gt;
    +&lt;br/&gt;
    +				// Here we were seeing this problem:&lt;br/&gt;
    +				// &lt;a href=&quot;https://github.com/netty/netty/issues/4357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/issues/4357&lt;/a&gt; if we do a get().&lt;br/&gt;
    +				// this is why we now simply wait a bit so that everything is&lt;br/&gt;
    +				// shut down and then we check&lt;br/&gt;
    +&lt;br/&gt;
    +				log.warn(&quot;Problem while shutting down {}: {}&quot;, serverName, r.getMessage());&lt;br/&gt;
    +			}&lt;br/&gt;
     		}&lt;br/&gt;
     		// any other type of exception we let it bubble up.&lt;br/&gt;
     		return false;&lt;br/&gt;
     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
    +	 * @param timeout The time to wait for the shutdown process to complete.&lt;br/&gt;
    +	 * @return A 
{@link CompletableFuture}
&lt;p&gt; that will be completed upon termination of the shutdown process.&lt;br/&gt;
     	 */&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;Void&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;br/&gt;
    +		CompletableFuture&amp;lt;Void&amp;gt; shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +		if (serverShutdownFuture.compareAndSet(null, shutdownFuture)) {&lt;br/&gt;
    +			log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Void&amp;gt; groupShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			if (bootstrap != null) {&lt;br/&gt;
    +				EventLoopGroup group = bootstrap.group();&lt;br/&gt;
    +				if (group != null &amp;amp;&amp;amp; !group.isShutdown()) {&lt;br/&gt;
    +					group.shutdownGracefully(0L, 0L, TimeUnit.MILLISECONDS)&lt;br/&gt;
    +							.addListener(finished -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +								if (finished.isSuccess()) {
    +									groupShutdownFuture.complete(null);
    +								} else {
    +									groupShutdownFuture.completeExceptionally(finished.cause());
    +								}    +							}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
    +				} else &lt;/p&gt;
{
    +					groupShutdownFuture.complete(null);
    +				}
&lt;p&gt;    +			} else &lt;/p&gt;
{
    +				groupShutdownFuture.complete(null);
    +			}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (bootstrap != null) {&lt;/li&gt;
	&lt;li&gt;EventLoopGroup group = bootstrap.group();&lt;/li&gt;
	&lt;li&gt;if (group != null) {&lt;/li&gt;
	&lt;li&gt;group.shutdownGracefully(0L, 10L, TimeUnit.SECONDS);&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Void&amp;gt; handlerShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			if (handler == null) 
{
    +				handlerShutdownFuture.complete(null);
    +			}
&lt;p&gt; else {&lt;br/&gt;
    +				handler.shutdown().whenComplete((result, throwable) -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					if (throwable != null) {
    +						handlerShutdownFuture.completeExceptionally(throwable);
    +					} else {
    +						handlerShutdownFuture.complete(null);
    +					}    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
     			}&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Void&amp;gt; queryExecShutdownFuture = CompletableFuture.runAsync(() -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				if (queryExecutor != null) {
    +					ExecutorUtils.gracefulShutdown(timeout.toMilliseconds(), TimeUnit.MILLISECONDS, queryExecutor);
    +				}    +			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +			CompletableFuture.allOf(&lt;br/&gt;
    +					queryExecShutdownFuture, groupShutdownFuture, handlerShutdownFuture&lt;br/&gt;
    +			).whenComplete((result, throwable) -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				if (throwable != null) {
    +					shutdownFuture.completeExceptionally(throwable);
    +				} else {
    +					shutdownFuture.complete(null);
    +				}    +			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
     		}&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;serverAddress = null;&lt;br/&gt;
    +		return serverShutdownFuture.get();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I do think so, because this would mean that we can restart the server that we intentionally shut down in that past, right? (This is only done in the start() when we fail to bind to a specific port).&lt;/p&gt;</comment>
                            <comment id="16278254" author="githubbot" created="Tue, 5 Dec 2017 09:17:32 +0000"  >&lt;p&gt;Github user kl0u commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r154885503&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r154885503&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -133,7 +134,7 @@ public String getClientName() {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	public CompletableFuture&amp;lt;RESP&amp;gt; sendRequest(final InetSocketAddress serverAddress, final REQ request) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (shutDown.get()) {&lt;br/&gt;
    +		if (!clientShutdownFuture.compareAndSet(null, null)) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Well, I agree that the code looks clearer, but the `compareAndSet` guarantees atomicity. While `get()` and then compare, does not.&lt;/p&gt;</comment>
                            <comment id="16278256" author="githubbot" created="Tue, 5 Dec 2017 09:19:18 +0000"  >&lt;p&gt;Github user kl0u commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r154885936&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r154885936&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -166,28 +167,57 @@ public String getClientName() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the client and closes all connections.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;After a call to this method, all returned futures will be failed.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @return A 
{@link CompletableFuture}
&lt;p&gt; that will be completed when the shutdown process is done.&lt;br/&gt;
     	 */&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;if (shutDown.compareAndSet(false, true)) {&lt;br/&gt;
    +	public CompletableFuture&amp;lt;Void&amp;gt; shutdown() {&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Void&amp;gt; newShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This is the same pattern as in the case of the `AbstractServerBase` &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16278265" author="githubbot" created="Tue, 5 Dec 2017 09:23:29 +0000"  >&lt;p&gt;Github user kl0u commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r154886964&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r154886964&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -166,28 +167,57 @@ public String getClientName() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the client and closes all connections.&lt;br/&gt;
     	 *&lt;/li&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;After a call to this method, all returned futures will be failed.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @return A 
{@link CompletableFuture}
&lt;p&gt; that will be completed when the shutdown process is done.&lt;br/&gt;
     	 */&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;if (shutDown.compareAndSet(false, true)) {&lt;br/&gt;
    +	public CompletableFuture&amp;lt;Void&amp;gt; shutdown() {&lt;br/&gt;
    +		final CompletableFuture&amp;lt;Void&amp;gt; newShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +		if (clientShutdownFuture.compareAndSet(null, newShutdownFuture)) {&lt;br/&gt;
    +&lt;br/&gt;
    +			final List&amp;lt;CompletableFuture&amp;lt;Void&amp;gt;&amp;gt; connectionFutures = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
     			for (Map.Entry&amp;lt;InetSocketAddress, EstablishedConnection&amp;gt; conn : establishedConnections.entrySet()) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {     				if (establishedConnections.remove(conn.getKey(), conn.getValue())) {
    -					conn.getValue().close();
    +					connectionFutures.add(conn.getValue().close());
     				}&lt;br/&gt;
     			}&lt;br/&gt;
     &lt;br/&gt;
     			for (Map.Entry&amp;lt;InetSocketAddress, PendingConnection&amp;gt; conn : pendingConnections.entrySet()) {&lt;br/&gt;
     				if (pendingConnections.remove(conn.getKey()) != null) {    -					conn.getValue().close();    +					connectionFutures.add(conn.getValue().close());     				}     			}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (bootstrap != null) {&lt;/li&gt;
	&lt;li&gt;EventLoopGroup group = bootstrap.group();&lt;/li&gt;
	&lt;li&gt;if (group != null) {&lt;/li&gt;
	&lt;li&gt;group.shutdownGracefully(0L, 10L, TimeUnit.SECONDS);&lt;br/&gt;
    +			CompletableFuture.allOf(&lt;br/&gt;
    +					connectionFutures.toArray(new CompletableFuture&amp;lt;?&amp;gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;connectionFutures.size()&amp;#93;&lt;/span&gt;)&lt;br/&gt;
    +			).whenComplete((result, throwable) -&amp;gt; {&lt;br/&gt;
    +				if (throwable != null) 
{
    +					newShutdownFuture.completeExceptionally(throwable);
    +				}
&lt;p&gt; else if (bootstrap != null) {&lt;br/&gt;
    +					EventLoopGroup group = bootstrap.group();&lt;br/&gt;
    +					if (group != null &amp;amp;&amp;amp; !group.isShutdown()) {&lt;br/&gt;
    +						group.shutdownGracefully(0L, 0L, TimeUnit.MILLISECONDS)&lt;br/&gt;
    +								.addListener(finished -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +									if (finished.isSuccess()) {
    +										newShutdownFuture.complete(null);
    +									} else {
    +										newShutdownFuture.completeExceptionally(finished.cause());
    +									}    +								}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
    +					} else &lt;/p&gt;
{
    +						newShutdownFuture.complete(null);
    +					}
&lt;p&gt;    +				} else &lt;/p&gt;
{
    +					newShutdownFuture.complete(null);
     				}
&lt;p&gt;    +			});&lt;br/&gt;
    +&lt;br/&gt;
    +			// check again if in the meantime another thread completed the future&lt;br/&gt;
    +			if (clientShutdownFuture.compareAndSet(null, newShutdownFuture)) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    You are right!&lt;/p&gt;</comment>
                            <comment id="16278273" author="githubbot" created="Tue, 5 Dec 2017 09:30:46 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r154888733&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r154888733&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -133,7 +134,7 @@ public String getClientName() {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	public CompletableFuture&amp;lt;RESP&amp;gt; sendRequest(final InetSocketAddress serverAddress, final REQ request) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (shutDown.get()) {&lt;br/&gt;
    +		if (!clientShutdownFuture.compareAndSet(null, null)) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    But the atomicity doesn&apos;t get you anything. Which case wouldn&apos;t be covered?&lt;/p&gt;

&lt;p&gt;    This check can only handle the case when sendRequest() is called after shutdown(), regardless of whether you use compareAndSet() or get(), so it shouldn&apos;t make a difference.&lt;/p&gt;
</comment>
                            <comment id="16278285" author="githubbot" created="Tue, 5 Dec 2017 09:36:53 +0000"  >&lt;p&gt;Github user kl0u commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r154890227&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r154890227&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -312,32 +345,41 @@ private void handInChannel(Channel channel) {&lt;br/&gt;
     		/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Close the connecting channel with a ClosedChannelException.&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void close() {&lt;/li&gt;
	&lt;li&gt;close(new ClosedChannelException());&lt;br/&gt;
    +		private CompletableFuture&amp;lt;Void&amp;gt; close() 
{
    +			return close(new ClosedChannelException());
     		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Close the connecting channel with an Exception (can be 
{@code null}
&lt;p&gt;)&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;or forward to the established channel.&lt;br/&gt;
     		 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private void close(Throwable cause) {&lt;/li&gt;
	&lt;li&gt;synchronized (connectLock) {&lt;/li&gt;
	&lt;li&gt;if (!closed) {&lt;br/&gt;
    +		private CompletableFuture&amp;lt;Void&amp;gt; close(Throwable cause) {&lt;br/&gt;
    +			CompletableFuture&amp;lt;Void&amp;gt; future = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			if (connectionShutdownFuture.compareAndSet(null, future)) {&lt;br/&gt;
    +				synchronized (connectLock) {&lt;br/&gt;
     					if (failureCause == null) 
{
     						failureCause = cause;
     					}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +					closed = true;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Yes. I will remove that.&lt;/p&gt;</comment>
                            <comment id="16278292" author="githubbot" created="Tue, 5 Dec 2017 09:39:49 +0000"  >&lt;p&gt;Github user kl0u commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r154890905&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r154890905&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -486,27 +542,25 @@ private boolean close(Throwable cause) {&lt;br/&gt;
     		@Override&lt;br/&gt;
     		public void onRequestResult(long requestId, RESP response) {&lt;br/&gt;
     			TimestampedCompletableFuture pending = pendingRequests.remove(requestId);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (pending != null &amp;amp;&amp;amp; pending.complete(response)) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			if (pending != null &amp;amp;&amp;amp; !pending.isDone()) {
     				long durationMillis = (System.nanoTime() - pending.getTimestamp()) / 1_000_000L;
     				stats.reportSuccessfulRequest(durationMillis);
    +				pending.complete(response);
     			}     		}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		@Override&lt;br/&gt;
     		public void onRequestFailure(long requestId, Throwable cause) {&lt;br/&gt;
     			TimestampedCompletableFuture pending = pendingRequests.remove(requestId);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (pending != null &amp;amp;&amp;amp; pending.completeExceptionally(cause)) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +			if (pending != null &amp;amp;&amp;amp; !pending.isDone()) {
     				stats.reportFailedRequest();
    +				pending.completeExceptionally(cause);
     			}     		}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     		@Override&lt;br/&gt;
     		public void onFailure(Throwable cause) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (close(cause)) 
{
    -				// Remove from established channels, otherwise future
    -				// requests will be handled by this failed channel.
    -				establishedConnections.remove(serverAddress, this);
    -			}
&lt;p&gt;    +			close(cause).thenAccept(cancelled -&amp;gt; establishedConnections.remove(serverAddress, this));&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Yes.&lt;/p&gt;</comment>
                            <comment id="16278584" author="githubbot" created="Tue, 5 Dec 2017 13:54:47 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r154950558&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r154950558&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -251,34 +263,81 @@ private boolean attemptToBind(final int port) throws Throwable &lt;/p&gt;
{
     			throw future.cause();
     		}
&lt;p&gt; catch (BindException e) {&lt;br/&gt;
     			log.debug(&quot;Failed to start {} on port {}: {}.&quot;, serverName, port, e.getMessage());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;shutdown();&lt;br/&gt;
    +			try 
{
    +				shutdownServer(Time.seconds(10L)).get();
    +			}
&lt;p&gt; catch (Exception r) {&lt;br/&gt;
    +&lt;br/&gt;
    +				// Here we were seeing this problem:&lt;br/&gt;
    +				// &lt;a href=&quot;https://github.com/netty/netty/issues/4357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/issues/4357&lt;/a&gt; if we do a get().&lt;br/&gt;
    +				// this is why we now simply wait a bit so that everything is&lt;br/&gt;
    +				// shut down and then we check&lt;br/&gt;
    +&lt;br/&gt;
    +				log.warn(&quot;Problem while shutting down {}: {}&quot;, serverName, r.getMessage());&lt;br/&gt;
    +			}&lt;br/&gt;
     		}&lt;br/&gt;
     		// any other type of exception we let it bubble up.&lt;br/&gt;
     		return false;&lt;br/&gt;
     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
    +	 * @param timeout The time to wait for the shutdown process to complete.&lt;br/&gt;
    +	 * @return A 
{@link CompletableFuture}
&lt;p&gt; that will be completed upon termination of the shutdown process.&lt;br/&gt;
     	 */&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;Void&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;br/&gt;
    +		CompletableFuture&amp;lt;Void&amp;gt; shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +		if (serverShutdownFuture.compareAndSet(null, shutdownFuture)) {&lt;br/&gt;
    +			log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Void&amp;gt; groupShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			if (bootstrap != null) {&lt;br/&gt;
    +				EventLoopGroup group = bootstrap.group();&lt;br/&gt;
    +				if (group != null &amp;amp;&amp;amp; !group.isShutdown()) {&lt;br/&gt;
    +					group.shutdownGracefully(0L, 0L, TimeUnit.MILLISECONDS)&lt;br/&gt;
    +							.addListener(finished -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +								if (finished.isSuccess()) {
    +									groupShutdownFuture.complete(null);
    +								} else {
    +									groupShutdownFuture.completeExceptionally(finished.cause());
    +								}    +							}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
    +				} else &lt;/p&gt;
{
    +					groupShutdownFuture.complete(null);
    +				}
&lt;p&gt;    +			} else &lt;/p&gt;
{
    +				groupShutdownFuture.complete(null);
    +			}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (bootstrap != null) {&lt;/li&gt;
	&lt;li&gt;EventLoopGroup group = bootstrap.group();&lt;/li&gt;
	&lt;li&gt;if (group != null) {&lt;/li&gt;
	&lt;li&gt;group.shutdownGracefully(0L, 10L, TimeUnit.SECONDS);&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Void&amp;gt; handlerShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			if (handler == null) 
{
    +				handlerShutdownFuture.complete(null);
    +			}
&lt;p&gt; else {&lt;br/&gt;
    +				handler.shutdown().whenComplete((result, throwable) -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					if (throwable != null) {
    +						handlerShutdownFuture.completeExceptionally(throwable);
    +					} else {
    +						handlerShutdownFuture.complete(null);
    +					}    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
     			}&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Void&amp;gt; queryExecShutdownFuture = CompletableFuture.runAsync(() -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				if (queryExecutor != null) {
    +					ExecutorUtils.gracefulShutdown(timeout.toMilliseconds(), TimeUnit.MILLISECONDS, queryExecutor);
    +				}    +			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +			CompletableFuture.allOf(&lt;br/&gt;
    +					queryExecShutdownFuture, groupShutdownFuture, handlerShutdownFuture&lt;br/&gt;
    +			).whenComplete((result, throwable) -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				if (throwable != null) {
    +					shutdownFuture.completeExceptionally(throwable);
    +				} else {
    +					shutdownFuture.complete(null);
    +				}    +			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
     		}&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;serverAddress = null;&lt;br/&gt;
    +		return serverShutdownFuture.get();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    So we do not intend to support restarting the server? In this case I would suggest to check the shutdownfuture in start() and provide a better error message, as it currently would return &quot;serverX is already running&quot;.&lt;/p&gt;</comment>
                            <comment id="16278593" author="githubbot" created="Tue, 5 Dec 2017 14:07:04 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r154950988&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r154950988&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/Client.java &amp;#8212;&lt;br/&gt;
    @@ -191,9 +196,12 @@ public String getClientName() {&lt;br/&gt;
     			CompletableFuture.allOf(&lt;br/&gt;
     					connectionFutures.toArray(new CompletableFuture&amp;lt;?&amp;gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;connectionFutures.size()&amp;#93;&lt;/span&gt;)&lt;br/&gt;
     			).whenComplete((result, throwable) -&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
     				if (throwable != null) &lt;/p&gt;
{
    -					newShutdownFuture.completeExceptionally(throwable);
    -				}
&lt;p&gt; else if (bootstrap != null) {&lt;br/&gt;
    +					LOG.warn(&quot;Problem while shutting down the connections at the {}: {}&quot;, clientName, throwable);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    `LOG.warn(&quot;Problem while shutting down the connections at the {}&quot;, clientName, throwable);` instead?&lt;/p&gt;</comment>
                            <comment id="16278594" author="githubbot" created="Tue, 5 Dec 2017 14:07:04 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r154952648&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r154952648&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/network/AbstractServerTest.java &amp;#8212;&lt;br/&gt;
    @@ -66,14 +65,15 @@ public void testServerInitializationFailure() throws Throwable {&lt;br/&gt;
     		List&amp;lt;Integer&amp;gt; portList = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
     		portList.add(7777);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try (&lt;/li&gt;
	&lt;li&gt;TestServer server1 = new TestServer(&quot;Test Server 1&quot;, new DisabledKvStateRequestStats(), portList.iterator());&lt;/li&gt;
	&lt;li&gt;TestServer server2 = new TestServer(&quot;Test Server 2&quot;, new DisabledKvStateRequestStats(), portList.iterator())&lt;/li&gt;
	&lt;li&gt;) {&lt;br/&gt;
    +		try (TestServer server1 = new TestServer(&quot;Test Server 1&quot;, new DisabledKvStateRequestStats(), portList.iterator())) {&lt;br/&gt;
     			server1.start();&lt;/li&gt;
	&lt;li&gt;Assert.assertEquals(7777L, server1.getServerAddress().getPort());&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;server2.start();&lt;br/&gt;
    +			List&amp;lt;Integer&amp;gt; occupiedPortList = new ArrayList&amp;lt;&amp;gt;();&lt;br/&gt;
    +			occupiedPortList.add(server1.getServerAddress().getPort());
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    could use `Collections.singletonList()` here&lt;/p&gt;</comment>
                            <comment id="16278791" author="githubbot" created="Tue, 5 Dec 2017 16:06:25 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r154955042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r154955042&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/itcases/AbstractQueryableStateTestBase.java &amp;#8212;&lt;br/&gt;
    @@ -1480,7 +1259,52 @@ public String fold(String accumulator, Tuple2&amp;lt;Integer, Long&amp;gt; value) throws Excep&lt;/p&gt;

&lt;p&gt;     	/////				General Utility Methods				//////&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private CompletableFuture&amp;lt;TestingJobManagerMessages.JobStatusIs&amp;gt; notifyWhenJobStatusIs(&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * A wrapper of the job graph that makes sure to cancell the job and wait for
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    typo: cancell -&amp;gt; cancel&lt;/p&gt;</comment>
                            <comment id="16280005" author="githubbot" created="Wed, 6 Dec 2017 10:45:17 +0000"  >&lt;p&gt;Github user kl0u commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r155201806&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r155201806&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-client-java/src/main/java/org/apache/flink/queryablestate/network/AbstractServerBase.java &amp;#8212;&lt;br/&gt;
    @@ -251,34 +263,81 @@ private boolean attemptToBind(final int port) throws Throwable &lt;/p&gt;
{
     			throw future.cause();
     		}
&lt;p&gt; catch (BindException e) {&lt;br/&gt;
     			log.debug(&quot;Failed to start {} on port {}: {}.&quot;, serverName, port, e.getMessage());&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;shutdown();&lt;br/&gt;
    +			try 
{
    +				shutdownServer(Time.seconds(10L)).get();
    +			}
&lt;p&gt; catch (Exception r) {&lt;br/&gt;
    +&lt;br/&gt;
    +				// Here we were seeing this problem:&lt;br/&gt;
    +				// &lt;a href=&quot;https://github.com/netty/netty/issues/4357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/issues/4357&lt;/a&gt; if we do a get().&lt;br/&gt;
    +				// this is why we now simply wait a bit so that everything is&lt;br/&gt;
    +				// shut down and then we check&lt;br/&gt;
    +&lt;br/&gt;
    +				log.warn(&quot;Problem while shutting down {}: {}&quot;, serverName, r.getMessage());&lt;br/&gt;
    +			}&lt;br/&gt;
     		}&lt;br/&gt;
     		// any other type of exception we let it bubble up.&lt;br/&gt;
     		return false;&lt;br/&gt;
     	}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down the server and all related thread pools.&lt;br/&gt;
    +	 * @param timeout The time to wait for the shutdown process to complete.&lt;br/&gt;
    +	 * @return A 
{@link CompletableFuture}
&lt;p&gt; that will be completed upon termination of the shutdown process.&lt;br/&gt;
     	 */&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;public void shutdown() {&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (handler != null) 
{
    -			handler.shutdown();
    -			handler = null;
    -		}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (queryExecutor != null) 
{
    -			queryExecutor.shutdown();
    -		}
&lt;p&gt;    +	public CompletableFuture&amp;lt;Void&amp;gt; shutdownServer(Time timeout) throws InterruptedException {&lt;br/&gt;
    +		CompletableFuture&amp;lt;Void&amp;gt; shutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +		if (serverShutdownFuture.compareAndSet(null, shutdownFuture)) {&lt;br/&gt;
    +			log.info(&quot;Shutting down {} @ {}&quot;, serverName, serverAddress);&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Void&amp;gt; groupShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			if (bootstrap != null) {&lt;br/&gt;
    +				EventLoopGroup group = bootstrap.group();&lt;br/&gt;
    +				if (group != null &amp;amp;&amp;amp; !group.isShutdown()) {&lt;br/&gt;
    +					group.shutdownGracefully(0L, 0L, TimeUnit.MILLISECONDS)&lt;br/&gt;
    +							.addListener(finished -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +								if (finished.isSuccess()) {
    +									groupShutdownFuture.complete(null);
    +								} else {
    +									groupShutdownFuture.completeExceptionally(finished.cause());
    +								}    +							}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
    +				} else &lt;/p&gt;
{
    +					groupShutdownFuture.complete(null);
    +				}
&lt;p&gt;    +			} else &lt;/p&gt;
{
    +				groupShutdownFuture.complete(null);
    +			}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (bootstrap != null) {&lt;/li&gt;
	&lt;li&gt;EventLoopGroup group = bootstrap.group();&lt;/li&gt;
	&lt;li&gt;if (group != null) {&lt;/li&gt;
	&lt;li&gt;group.shutdownGracefully(0L, 10L, TimeUnit.SECONDS);&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Void&amp;gt; handlerShutdownFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			if (handler == null) 
{
    +				handlerShutdownFuture.complete(null);
    +			}
&lt;p&gt; else {&lt;br/&gt;
    +				handler.shutdown().whenComplete((result, throwable) -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +					if (throwable != null) {
    +						handlerShutdownFuture.completeExceptionally(throwable);
    +					} else {
    +						handlerShutdownFuture.complete(null);
    +					}    +				}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
     			}&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Void&amp;gt; queryExecShutdownFuture = CompletableFuture.runAsync(() -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				if (queryExecutor != null) {
    +					ExecutorUtils.gracefulShutdown(timeout.toMilliseconds(), TimeUnit.MILLISECONDS, queryExecutor);
    +				}    +			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +			CompletableFuture.allOf(&lt;br/&gt;
    +					queryExecShutdownFuture, groupShutdownFuture, handlerShutdownFuture&lt;br/&gt;
    +			).whenComplete((result, throwable) -&amp;gt; &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +				if (throwable != null) {
    +					shutdownFuture.completeExceptionally(throwable);
    +				} else {
    +					shutdownFuture.complete(null);
    +				}    +			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;);&lt;br/&gt;
     		}&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;serverAddress = null;&lt;br/&gt;
    +		return serverShutdownFuture.get();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Ok I will add the check in the `start()`.&lt;/p&gt;</comment>
                            <comment id="16280057" author="githubbot" created="Wed, 6 Dec 2017 11:36:49 +0000"  >&lt;p&gt;Github user kl0u commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r155212313&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r155212313&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/itcases/AbstractQueryableStateTestBase.java &amp;#8212;&lt;br/&gt;
    @@ -359,12 +355,12 @@ public Integer getKey(Tuple2&amp;lt;Integer, Long&amp;gt; value) throws Exception {&lt;br/&gt;
     		} finally {&lt;br/&gt;
     			// Free cluster resources&lt;br/&gt;
     			if (jobId != null) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;scala.concurrent.Future&amp;lt;CancellationSuccess&amp;gt; cancellation = cluster&lt;/li&gt;
	&lt;li&gt;.getLeaderGateway(deadline.timeLeft())&lt;br/&gt;
    +				cluster.getLeaderGateway(deadline.timeLeft())&lt;br/&gt;
     						.ask(new JobManagerMessages.CancelJob(jobId), deadline.timeLeft())&lt;/li&gt;
	&lt;li&gt;.mapTo(ClassTag$.MODULE$.&amp;lt;JobManagerMessages.CancellationSuccess&amp;gt;apply(JobManagerMessages.CancellationSuccess.class));&lt;br/&gt;
    +						.mapTo(ClassTag$.MODULE$.&amp;lt;CancellationSuccess&amp;gt;apply(CancellationSuccess.class));&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Await.ready(cancellation, deadline.timeLeft());&lt;br/&gt;
    +				// we are not waiting for the cancellation to happen because the&lt;br/&gt;
    +				// job has actually failed, as tested above.
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    You are right. So I will just remove the `finally` block and check if the status of the job is `FAILED`.&lt;/p&gt;</comment>
                            <comment id="16280060" author="githubbot" created="Wed, 6 Dec 2017 11:39:35 +0000"  >&lt;p&gt;Github user kl0u commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r155212865&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r155212865&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/itcases/HAAbstractQueryableStateTestBase.java &amp;#8212;&lt;br/&gt;
    @@ -80,19 +80,18 @@ public static void setup(int proxyPortRangeStart, int serverPortRangeStart) {&lt;/p&gt;

&lt;p&gt;     	@AfterClass&lt;br/&gt;
     	public static void tearDown() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (cluster != null) {&lt;br/&gt;
    +		try 
{
    +			client.shutdownAndWait();
    +
     			cluster.stop();
     			cluster.awaitTermination();
    -		}&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try 
{
     			zkServer.stop();
     			zkServer.close();
    -		}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +
    +		}
&lt;p&gt; catch (Throwable e) {&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Done.&lt;/p&gt;</comment>
                            <comment id="16280061" author="githubbot" created="Wed, 6 Dec 2017 11:39:41 +0000"  >&lt;p&gt;Github user kl0u commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r155212885&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r155212885&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/itcases/NonHAAbstractQueryableStateTestBase.java &amp;#8212;&lt;br/&gt;
    @@ -68,11 +68,14 @@ public static void setup(int proxyPortRangeStart, int serverPortRangeStart) {&lt;br/&gt;
     	@AfterClass&lt;br/&gt;
     	public static void tearDown() {&lt;br/&gt;
     		try &lt;/p&gt;
{
    +			client.shutdownAndWait();
    +
     			cluster.stop();
    -		}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
    +			cluster.awaitTermination();
    +
    +		}
&lt;p&gt; catch (Throwable e) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Done.&lt;/p&gt;</comment>
                            <comment id="16280124" author="githubbot" created="Wed, 6 Dec 2017 12:43:00 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r155224312&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r155224312&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/network/ClientTest.java &amp;#8212;&lt;br/&gt;
    @@ -234,9 +236,14 @@ public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception&lt;/p&gt;

&lt;p&gt;     					client.shutdown().get(10L, TimeUnit.SECONDS);&lt;br/&gt;
     				} catch (Exception e) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;e.printStackTrace();&lt;br/&gt;
    +					exc = e;&lt;br/&gt;
    +					LOG.error(ExceptionUtils.stringifyException(e));
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    use `LOG.error(&quot;An exception occurred while shutting down netty.&quot;, e)` instead&lt;/p&gt;</comment>
                            <comment id="16280125" author="githubbot" created="Wed, 6 Dec 2017 12:43:00 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r155224199&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r155224199&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/network/ClientTest.java &amp;#8212;&lt;br/&gt;
    @@ -224,6 +225,7 @@ public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception&lt;br/&gt;
     			assertEquals(expectedRequests, stats.getNumSuccessful());&lt;br/&gt;
     			assertEquals(expectedRequests, stats.getNumFailed());&lt;br/&gt;
     		} finally {&lt;br/&gt;
    +			Exception exc = null;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    this could be moved into the if block.&lt;/p&gt;</comment>
                            <comment id="16280126" author="githubbot" created="Wed, 6 Dec 2017 12:43:00 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062#discussion_r155225199&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062#discussion_r155225199&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-queryable-state/flink-queryable-state-runtime/src/test/java/org/apache/flink/queryablestate/itcases/AbstractQueryableStateTestBase.java &amp;#8212;&lt;br/&gt;
    @@ -260,89 +260,90 @@ public void testDuplicateRegistrationFailsJob() throws Exception {&lt;br/&gt;
     		final Deadline deadline = TEST_TIMEOUT.fromNow();&lt;br/&gt;
     		final int numKeys = 256;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;JobID jobId = null;&lt;br/&gt;
    +		StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();&lt;br/&gt;
    +		env.setStateBackend(stateBackend);&lt;br/&gt;
    +		env.setParallelism(maxParallelism);&lt;br/&gt;
    +		// Very important, because cluster is shared between tests and we&lt;br/&gt;
    +		// don&apos;t explicitly check that all slots are available before&lt;br/&gt;
    +		// submitting.&lt;br/&gt;
    +		env.setRestartStrategy(RestartStrategies.fixedDelayRestart(Integer.MAX_VALUE, 1000L));&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;try {&lt;/li&gt;
	&lt;li&gt;//&lt;/li&gt;
	&lt;li&gt;// Test program&lt;/li&gt;
	&lt;li&gt;//&lt;/li&gt;
	&lt;li&gt;StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();&lt;/li&gt;
	&lt;li&gt;env.setStateBackend(stateBackend);&lt;/li&gt;
	&lt;li&gt;env.setParallelism(maxParallelism);&lt;/li&gt;
	&lt;li&gt;// Very important, because cluster is shared between tests and we&lt;/li&gt;
	&lt;li&gt;// don&apos;t explicitly check that all slots are available before&lt;/li&gt;
	&lt;li&gt;// submitting.&lt;/li&gt;
	&lt;li&gt;env.setRestartStrategy(RestartStrategies.fixedDelayRestart(Integer.MAX_VALUE, 1000L));&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;DataStream&amp;lt;Tuple2&amp;lt;Integer, Long&amp;gt;&amp;gt; source = env&lt;/li&gt;
	&lt;li&gt;.addSource(new TestKeyRangeSource(numKeys));&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;// Reducing state&lt;/li&gt;
	&lt;li&gt;ReducingStateDescriptor&amp;lt;Tuple2&amp;lt;Integer, Long&amp;gt;&amp;gt; reducingState = new ReducingStateDescriptor&amp;lt;&amp;gt;(&lt;/li&gt;
	&lt;li&gt;&quot;any-name&quot;,&lt;/li&gt;
	&lt;li&gt;new SumReduce(),&lt;/li&gt;
	&lt;li&gt;source.getType());&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;final String queryName = &quot;duplicate-me&quot;;&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;final QueryableStateStream&amp;lt;Integer, Tuple2&amp;lt;Integer, Long&amp;gt;&amp;gt; queryableState =&lt;/li&gt;
	&lt;li&gt;source.keyBy(new KeySelector&amp;lt;Tuple2&amp;lt;Integer, Long&amp;gt;, Integer&amp;gt;() {&lt;/li&gt;
	&lt;li&gt;private static final long serialVersionUID = -4126824763829132959L;&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public Integer getKey(Tuple2&amp;lt;Integer, Long&amp;gt; value) throws Exception 
{
    -							return value.f0;
    -						}&lt;br/&gt;
    -					}).asQueryableState(queryName, reducingState);&lt;br/&gt;
    +		DataStream&amp;lt;Tuple2&amp;lt;Integer, Long&amp;gt;&amp;gt; source = env.addSource(new TestKeyRangeSource(numKeys));&lt;br/&gt;
     &lt;br/&gt;
    -			final QueryableStateStream&amp;lt;Integer, Tuple2&amp;lt;Integer, Long&amp;gt;&amp;gt; duplicate =&lt;br/&gt;
    -					source.keyBy(new KeySelector&amp;lt;Tuple2&amp;lt;Integer, Long&amp;gt;, Integer&amp;gt;() {&lt;br/&gt;
    -						private static final long serialVersionUID = -6265024000462809436L;&lt;br/&gt;
    +		// Reducing state&lt;br/&gt;
    +		ReducingStateDescriptor&amp;lt;Tuple2&amp;lt;Integer, Long&amp;gt;&amp;gt; reducingState = new ReducingStateDescriptor&amp;lt;&amp;gt;(&lt;br/&gt;
    +				&quot;any-name&quot;,&lt;br/&gt;
    +				new SumReduce(),&lt;br/&gt;
    +				source.getType());&lt;br/&gt;
     &lt;br/&gt;
    -						@Override&lt;br/&gt;
    -						public Integer getKey(Tuple2&amp;lt;Integer, Long&amp;gt; value) throws Exception {    -							return value.f0;    -						}&lt;/li&gt;
	&lt;li&gt;}).asQueryableState(queryName);&lt;br/&gt;
    +		final String queryName = &quot;duplicate-me&quot;;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// Submit the job graph&lt;/li&gt;
	&lt;li&gt;JobGraph jobGraph = env.getStreamGraph().getJobGraph();&lt;/li&gt;
	&lt;li&gt;jobId = jobGraph.getJobID();&lt;br/&gt;
    +		final QueryableStateStream&amp;lt;Integer, Tuple2&amp;lt;Integer, Long&amp;gt;&amp;gt; queryableState =&lt;br/&gt;
    +				source.keyBy(new KeySelector&amp;lt;Tuple2&amp;lt;Integer, Long&amp;gt;, Integer&amp;gt;() {&lt;br/&gt;
    +					private static final long serialVersionUID = -4126824763829132959L;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final CompletableFuture&amp;lt;TestingJobManagerMessages.JobStatusIs&amp;gt; failedFuture =&lt;/li&gt;
	&lt;li&gt;notifyWhenJobStatusIs(jobId, JobStatus.FAILED, deadline);&lt;br/&gt;
    +					@Override&lt;br/&gt;
    +					public Integer getKey(Tuple2&amp;lt;Integer, Long&amp;gt; value) 
{
    +						return value.f0;
    +					}&lt;br/&gt;
    +				}).asQueryableState(queryName, reducingState);&lt;br/&gt;
     &lt;br/&gt;
    -			cluster.submitJobDetached(jobGraph);&lt;br/&gt;
    +		final QueryableStateStream&amp;lt;Integer, Tuple2&amp;lt;Integer, Long&amp;gt;&amp;gt; duplicate =&lt;br/&gt;
    +				source.keyBy(new KeySelector&amp;lt;Tuple2&amp;lt;Integer, Long&amp;gt;, Integer&amp;gt;() {&lt;br/&gt;
    +					private static final long serialVersionUID = -6265024000462809436L;&lt;br/&gt;
     &lt;br/&gt;
    -			TestingJobManagerMessages.JobStatusIs jobStatus =&lt;br/&gt;
    -					failedFuture.get(deadline.timeLeft().toMillis(), TimeUnit.MILLISECONDS);&lt;br/&gt;
    -			assertEquals(JobStatus.FAILED, jobStatus.state());&lt;br/&gt;
    +					@Override&lt;br/&gt;
    +					public Integer getKey(Tuple2&amp;lt;Integer, Long&amp;gt; value) {    +						return value.f0;    +					}
&lt;p&gt;    +				}).asQueryableState(queryName);&lt;br/&gt;
    +&lt;br/&gt;
    +		// Submit the job graph&lt;br/&gt;
    +		final JobGraph jobGraph = env.getStreamGraph().getJobGraph();&lt;br/&gt;
    +		final JobID jobId = jobGraph.getJobID();&lt;br/&gt;
    +&lt;br/&gt;
    +		final CompletableFuture&amp;lt;TestingJobManagerMessages.JobStatusIs&amp;gt; failedFuture =&lt;br/&gt;
    +				notifyWhenJobStatusIs(jobId, JobStatus.FAILED, deadline);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// Get the job and check the cause&lt;/li&gt;
	&lt;li&gt;JobManagerMessages.JobFound jobFound = FutureUtils.toJava(&lt;/li&gt;
	&lt;li&gt;cluster.getLeaderGateway(deadline.timeLeft())&lt;/li&gt;
	&lt;li&gt;.ask(new JobManagerMessages.RequestJob(jobId), deadline.timeLeft())&lt;/li&gt;
	&lt;li&gt;.mapTo(ClassTag$.MODULE$.&amp;lt;JobManagerMessages.JobFound&amp;gt;apply(JobManagerMessages.JobFound.class)))&lt;/li&gt;
	&lt;li&gt;.get(deadline.timeLeft().toMillis(), TimeUnit.MILLISECONDS);&lt;br/&gt;
    +		final CompletableFuture&amp;lt;TestingJobManagerMessages.JobStatusIs&amp;gt; cancellationFuture =&lt;br/&gt;
    +				notifyWhenJobStatusIs(jobId, JobStatus.CANCELED, deadline);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;String failureCause = jobFound.executionGraph().getFailureCause().getExceptionAsString();&lt;br/&gt;
    +		cluster.submitJobDetached(jobGraph);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;assertTrue(&quot;Not instance of SuppressRestartsException&quot;, failureCause.startsWith(&quot;org.apache.flink.runtime.execution.SuppressRestartsException&quot;));&lt;/li&gt;
	&lt;li&gt;int causedByIndex = failureCause.indexOf(&quot;Caused by: &quot;);&lt;/li&gt;
	&lt;li&gt;String subFailureCause = failureCause.substring(causedByIndex + &quot;Caused by: &quot;.length());&lt;/li&gt;
	&lt;li&gt;assertTrue(&quot;Not caused by IllegalStateException&quot;, subFailureCause.startsWith(&quot;java.lang.IllegalStateException&quot;));&lt;/li&gt;
	&lt;li&gt;assertTrue(&quot;Exception does not contain registration name&quot;, subFailureCause.contains(queryName));&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			final TestingJobManagerMessages.JobStatusIs jobStatus =&lt;br/&gt;
    +					failedFuture.get(deadline.timeLeft().toMillis(), TimeUnit.MILLISECONDS);&lt;br/&gt;
    +			assertEquals(JobStatus.FAILED, jobStatus.state());
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    isn&apos;t this always true if the future did not time out? (In which case get() throws a TimeoutException)&lt;/p&gt;</comment>
                            <comment id="16280140" author="githubbot" created="Wed, 6 Dec 2017 12:58:54 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &#128077; &lt;/p&gt;</comment>
                            <comment id="16280184" author="githubbot" created="Wed, 6 Dec 2017 13:39:24 +0000"  >&lt;p&gt;Github user kl0u commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks @zentol ! I will let another travis run, and then merge.&lt;/p&gt;</comment>
                            <comment id="16280295" author="githubbot" created="Wed, 6 Dec 2017 15:13:01 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5062&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5062&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16280333" author="kkl0u" created="Wed, 6 Dec 2017 15:44:29 +0000"  >&lt;p&gt;Merged on master (a3fd548e9c76c67609bbf159d5fb743d756450b1) and 1.4.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13111893">FLINK-7911</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 49 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3152v:r</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>