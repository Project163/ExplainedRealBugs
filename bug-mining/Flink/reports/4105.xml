<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:46:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-17645] REAPER_THREAD.start() in SafetyNetCloseableRegistry failed, causing the repeated failover.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-17645</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I&apos;m running a modified version of Flink, and encountered the exception below when task start:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-05-12 00:46:19,037 ERROR [***] org.apache.flink.runtime.taskmanager.Task   - Encountered an unexpected exception
java.lang.OutOfMemoryError: unable to create &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; thread
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.start0(Native Method)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.start(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:802)
        at org.apache.flink.core.fs.SafetyNetCloseableRegistry.&amp;lt;init&amp;gt;(SafetyNetCloseableRegistry.java:73)
        at org.apache.flink.core.fs.FileSystemSafetyNet.initializeSafetyNetForThread(FileSystemSafetyNet.java:89)
        at org.apache.flink.runtime.taskmanager.Task.run(Task.java:586)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:834)
2020-05-12 00:46:19,038 INFO  [***] org.apache.flink.runtime.taskmanager.Task 
java.lang.OutOfMemoryError: unable to create &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; thread
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.start0(Native Method)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.start(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:802)
        at org.apache.flink.core.fs.SafetyNetCloseableRegistry.&amp;lt;init&amp;gt;(SafetyNetCloseableRegistry.java:73)
        at org.apache.flink.core.fs.FileSystemSafetyNet.initializeSafetyNetForThread(FileSystemSafetyNet.java:89)
        at org.apache.flink.runtime.taskmanager.Task.run(Task.java:586)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:834)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The&#160;REAPER_THREAD.start() fails because of OOM, and REAPER_THREAD will never be null. Since then, every time&#160;SafetyNetCloseableRegistry init in this VM will cause an IllegalStateException:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IllegalStateException
	at org.apache.flink.util.Preconditions.checkState(Preconditions.java:179)
	at org.apache.flink.core.fs.SafetyNetCloseableRegistry.&amp;lt;init&amp;gt;(SafetyNetCloseableRegistry.java:71)
	at org.apache.flink.core.fs.FileSystemSafetyNet.initializeSafetyNetForThread(FileSystemSafetyNet.java:89)
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:586)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:834)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This may happen in very old version of Flink as well.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13304508">FLINK-17645</key>
            <summary>REAPER_THREAD.start() in SafetyNetCloseableRegistry failed, causing the repeated failover.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wanglijie">Lijie Wang</assignee>
                                    <reporter username="zakelly">Zakelly Lan</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 13 May 2020 02:57:35 +0000</created>
                <updated>Fri, 16 Oct 2020 10:53:01 +0000</updated>
                            <resolved>Thu, 21 May 2020 02:24:44 +0000</resolved>
                                    <version>1.10.1</version>
                    <version>1.11.0</version>
                    <version>1.12.0</version>
                                    <fixVersion>1.11.0</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17105938" author="zhuzh" created="Wed, 13 May 2020 03:25:04 +0000"  >&lt;p&gt;Thanks for reporting this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Zakelly&quot; class=&quot;user-hover&quot; rel=&quot;zakelly&quot;&gt;Zakelly&lt;/a&gt;.&lt;br/&gt;
Does this problem still exist in 1.9 or 1.10?&lt;/p&gt;</comment>
                            <comment id="17105943" author="wanglijie95" created="Wed, 13 May 2020 03:36:54 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt;, yes, it still exists in 1.9 and 1.10. I think it should use try/catch code block and reset the REAPER_THREAD to null if catch OOM exception. I&apos;m pleased to fix this bug, can you assign to me?&lt;/p&gt;</comment>
                            <comment id="17105949" author="zhuzh" created="Wed, 13 May 2020 03:56:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wanglijie95&quot; class=&quot;user-hover&quot; rel=&quot;wanglijie95&quot;&gt;wanglijie95&lt;/a&gt; you are right that this issue can still happen in latest FLink versions.&lt;br/&gt;
I checked &lt;tt&gt;SafetyNetCloseableRegistry&lt;/tt&gt;. The static &lt;tt&gt;REAPER_THREAD&lt;/tt&gt; field will be set in the constructor but will not be nulled if OOM happens, which can lead to the state check failure.&lt;/p&gt;</comment>
                            <comment id="17105952" author="zhuzh" created="Wed, 13 May 2020 03:57:27 +0000"  >&lt;p&gt;I have assigned the ticket to you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wanglijie95&quot; class=&quot;user-hover&quot; rel=&quot;wanglijie95&quot;&gt;wanglijie95&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17105957" author="wanglijie95" created="Wed, 13 May 2020 04:08:18 +0000"  >&lt;p&gt;Thank you, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17107313" author="stephanewen" created="Thu, 14 May 2020 13:50:24 +0000"  >&lt;p&gt;What are we gaining by special case handling the reaper thread here?&lt;br/&gt;
If the JVM reaches a point where it cannot create native threads any more, then the JVM is unusable.&lt;/p&gt;

&lt;p&gt;Could we look for a generic way to &quot;exit JVM when thread creation fails&quot;? Handling each thread creation specifically seems not feasible, tbh.&lt;/p&gt;</comment>
                            <comment id="17107902" author="zhuzh" created="Fri, 15 May 2020 03:47:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt; I think this specific fix is valid because the root cause is the inconsistency of &lt;tt&gt;SafetyNetCloseableRegistry&lt;/tt&gt; if any exception happens in its constructor. This is due to the REAPER_THREAD is static and is not properly reset on unexpected failures, which is not a common case.&lt;br/&gt;
In this case, a SafetyNetCloseableRegistry cannot be successfully created anymore even if the native thread creation could succeed later. And any exception thrown from &lt;tt&gt;REAPER_THREAD.start()&lt;/tt&gt; (maybe not a native thread creation error) would also lead to this problem.&lt;/p&gt;

&lt;p&gt;Regarding &quot;exit JVM when thread creation fails&quot;, I&apos;m not sure whether native thread creation failure is really not recoverable.&lt;br/&gt;
If it is, I think we can force the JVM to shutdown in such cases. But I do not have an idea yet that how we can apply it to all the thread creation processes without changing them all.&lt;/p&gt;</comment>
                            <comment id="17108008" author="wanglijie95" created="Fri, 15 May 2020 06:57:52 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;, just like &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt;&#160;&apos;s comment, except OOM, maybe there are other errors and exceptions thrown when start the REAPER_THREAD, it will also meet this problem. And once it occured, we can only see the&#160; &quot;java.lang.IllegalStateException&quot; lead to job failed, it&apos;s confused for user. To get the real reason,&#160; users have to find the first exception at here, and then realized that the first one lead to the&#160;subsequent exceptions.&lt;/p&gt;</comment>
                            <comment id="17108104" author="stephanewen" created="Fri, 15 May 2020 09:00:28 +0000"  >&lt;p&gt;I see, fair point. This is a static shared thread where we need to take care about leaks. Makes sense, +1&lt;/p&gt;</comment>
                            <comment id="17112731" author="zhuzh" created="Thu, 21 May 2020 02:24:45 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;master&lt;br/&gt;
9f3a71183ea4b14a396ecf66e4377da07b06a689&lt;/p&gt;

&lt;p&gt;release-1.1&lt;br/&gt;
d40826d23c8993f46270922a40fe23379b3e166e&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 25 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0eny8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>