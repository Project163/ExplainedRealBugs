<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:42:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10377] Remove precondition in TwoPhaseCommitSinkFunction.notifyCheckpointComplete</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10377</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The precondition &lt;tt&gt;checkState(pendingTransactionIterator.hasNext(), &quot;checkpoint completed, but no transaction pending&quot;);&lt;/tt&gt; in &lt;tt&gt;TwoPhaseCommitSinkFunction.notifyCheckpointComplete()&lt;/tt&gt; seems too strict, because checkpoints can overtake checkpoints and will fail the precondition. In this case the commit was already performed by the first notification and subsumes the late checkpoint. I think the check can be removed.&lt;/p&gt;

&lt;p&gt;edit:&lt;br/&gt;
As &lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/UNCHECKED-Error-while-confirming-Checkpoint-td23213.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;reported by a user on the user mailing list&lt;/a&gt;, &lt;tt&gt;TwoPhaseCommitSinkFunction#notifyCheckpointComplete&lt;/tt&gt; can fail with the following exception:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.RuntimeException: Error while confirming checkpoint
    at org.apache.flink.runtime.taskmanager.Task$2.run(Task.java:1205)
    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
    at java.util.concurrent.FutureTask.run(FutureTask.java:266)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
    at java.lang.Thread.run(Thread.java:748)
Caused by: java.lang.IllegalStateException: checkpoint completed, but no transaction pending
    at org.apache.flink.util.Preconditions.checkState(Preconditions.java:195)
    at org.apache.flink.streaming.api.functions.sink.TwoPhaseCommitSinkFunction.notifyCheckpointComplete(TwoPhaseCommitSinkFunction.java:267)
    at org.apache.flink.streaming.api.operators.AbstractUdfStreamOperator.notifyCheckpointComplete(AbstractUdfStreamOperator.java:130)
    at org.apache.flink.streaming.runtime.tasks.StreamTask.notifyCheckpointComplete(StreamTask.java:822)
    at org.apache.flink.runtime.taskmanager.Task$2.run(Task.java:1200)
    ... 5 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This can happen in the following scenario:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;savepoint is triggered&lt;/li&gt;
	&lt;li&gt;checkpoint is triggered&lt;/li&gt;
	&lt;li&gt;checkpoint completes (but it doesn&apos;t subsume the savepoint, because checkpoints subsume only other checkpoints).&lt;/li&gt;
	&lt;li&gt;savepoint completes&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;In this case, &lt;tt&gt;TwoPhaseCommitSinkFunction&lt;/tt&gt; receives first notification that the later checkpoint completed, it commits both savepoint and the checkpoint. Later when savepoint &lt;tt&gt;notifyCheckpointComplete&lt;/tt&gt; arrives, the above error will occur. &lt;/p&gt;

&lt;p&gt;Possible trivial fix is to remove that failing &lt;tt&gt;checkState&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13186337">FLINK-10377</key>
            <summary>Remove precondition in TwoPhaseCommitSinkFunction.notifyCheckpointComplete</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srichter">Stefan Richter</assignee>
                                    <reporter username="srichter">Stefan Richter</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 20 Sep 2018 12:57:05 +0000</created>
                <updated>Fri, 29 Nov 2019 08:02:58 +0000</updated>
                            <resolved>Thu, 28 Nov 2019 16:26:20 +0000</resolved>
                                    <version>1.5.0</version>
                    <version>1.6.0</version>
                                    <fixVersion>1.8.4</fixVersion>
                    <fixVersion>1.9.2</fixVersion>
                    <fixVersion>1.10.0</fixVersion>
                                    <component>Connectors / Common</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16622196" author="githubbot" created="Thu, 20 Sep 2018 15:18:03 +0000"  >&lt;p&gt;StefanRRichter opened a new pull request #6723: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10377&quot; title=&quot;Remove precondition in TwoPhaseCommitSinkFunction.notifyCheckpointComplete&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10377&quot;&gt;&lt;del&gt;FLINK-10377&lt;/del&gt;&lt;/a&gt; Remove precondition in TwoPhaseCommitSinkFunction.notif&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6723&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6723&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &#8230;yCheckpointComplete&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;br/&gt;
   The precondition `checkState(pendingTransactionIterator.hasNext(), &quot;checkpoint completed, but no transaction pending&quot;);` in `TwoPhaseCommitSinkFunction.notifyCheckpointComplete()` seems to strict, because checkpoints can overtake checkpoints and will fail the precondition. In this case the commit was already performed by the first notification and subsumes the late checkpoint. I think the check can be removed.&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;br/&gt;
   Removed the precondition without replacements and created a test case for ou-of-order notification.&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   `TwoPhaseCommitSinkFunctionTest#testSubsumedNotificationOfPreviousCheckpoint`&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16622197" author="githubbot" created="Thu, 20 Sep 2018 15:18:17 +0000"  >&lt;p&gt;StefanRRichter commented on issue #6723: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10377&quot; title=&quot;Remove precondition in TwoPhaseCommitSinkFunction.notifyCheckpointComplete&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10377&quot;&gt;&lt;del&gt;FLINK-10377&lt;/del&gt;&lt;/a&gt; Remove precondition in TwoPhaseCommitSinkFunction.notif&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6723#issuecomment-423223082&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6723#issuecomment-423223082&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   CC @pnowojski &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16622362" author="githubbot" created="Thu, 20 Sep 2018 17:16:30 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6723: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10377&quot; title=&quot;Remove precondition in TwoPhaseCommitSinkFunction.notifyCheckpointComplete&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10377&quot;&gt;&lt;del&gt;FLINK-10377&lt;/del&gt;&lt;/a&gt; Remove precondition in TwoPhaseCommitSinkFunction.notif&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6723#discussion_r219247717&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6723#discussion_r219247717&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -255,7 +255,6 @@ public final void notifyCheckpointComplete(long checkpointId) throws Exception {&lt;br/&gt;
 		//&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   One thing aboved comment should be adapted:&lt;/p&gt;

&lt;p&gt;   &amp;gt;  		// ==&amp;gt; There should never be a case where we have no pending transaction here&lt;/p&gt;

&lt;p&gt;   Btw @StefanRRichter are you sure that subsuming can happen as in this test that you added? Basing on this large comment (@StephanEwen written it for pravega connector), subsuming of notification should happen on JobManager and such subsumed notification shouldn&apos;t reach the task. &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16622440" author="githubbot" created="Thu, 20 Sep 2018 18:05:05 +0000"  >&lt;p&gt;StefanRRichter commented on a change in pull request #6723: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10377&quot; title=&quot;Remove precondition in TwoPhaseCommitSinkFunction.notifyCheckpointComplete&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10377&quot;&gt;&lt;del&gt;FLINK-10377&lt;/del&gt;&lt;/a&gt; Remove precondition in TwoPhaseCommitSinkFunction.notif&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6723#discussion_r219263435&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6723#discussion_r219263435&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -255,7 +255,6 @@ public final void notifyCheckpointComplete(long checkpointId) throws Exception {&lt;br/&gt;
 		//&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   That is a very good point and IIRC, that is the case. Hmm, I see that there is always an element added in the snapshot method, so one should expect that there is always one in the notify part because no other method is ever removing from the map and method calls should also be mutually exclusive because they both hold the checkpointing lock. What else is left?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16622442" author="githubbot" created="Thu, 20 Sep 2018 18:05:43 +0000"  >&lt;p&gt;StefanRRichter commented on a change in pull request #6723: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10377&quot; title=&quot;Remove precondition in TwoPhaseCommitSinkFunction.notifyCheckpointComplete&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10377&quot;&gt;&lt;del&gt;FLINK-10377&lt;/del&gt;&lt;/a&gt; Remove precondition in TwoPhaseCommitSinkFunction.notif&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6723#discussion_r219263435&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6723#discussion_r219263435&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -255,7 +255,6 @@ public final void notifyCheckpointComplete(long checkpointId) throws Exception {&lt;br/&gt;
 		//&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   That is a very good point and IIRC, that is the case. Hmm, I see that there is always an element added in the snapshot method, so one should expect that there is always one in the notify part because no other method is ever removing from the map and method calls should also be mutually exclusive because they both hold the checkpointing lock. What else is left?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16622448" author="githubbot" created="Thu, 20 Sep 2018 18:08:59 +0000"  >&lt;p&gt;StefanRRichter commented on a change in pull request #6723: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10377&quot; title=&quot;Remove precondition in TwoPhaseCommitSinkFunction.notifyCheckpointComplete&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10377&quot;&gt;&lt;del&gt;FLINK-10377&lt;/del&gt;&lt;/a&gt; Remove precondition in TwoPhaseCommitSinkFunction.notif&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6723#discussion_r219264649&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6723#discussion_r219264649&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -255,7 +255,6 @@ public final void notifyCheckpointComplete(long checkpointId) throws Exception {&lt;br/&gt;
 		//&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   That is a very good point and IIRC, that is the case. Hmm, I see that there is always an element added in the snapshot method, so one should expect that there is always one in the notify part because no other method is ever removing from the map and method calls should also be mutually exclusive because they both hold the checkpointing lock. What else is left?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16623461" author="githubbot" created="Fri, 21 Sep 2018 11:54:13 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6723: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10377&quot; title=&quot;Remove precondition in TwoPhaseCommitSinkFunction.notifyCheckpointComplete&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10377&quot;&gt;&lt;del&gt;FLINK-10377&lt;/del&gt;&lt;/a&gt; Remove precondition in TwoPhaseCommitSinkFunction.notif&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6723#discussion_r219471764&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6723#discussion_r219471764&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -255,7 +255,6 @@ public final void notifyCheckpointComplete(long checkpointId) throws Exception {&lt;br/&gt;
 		//&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   Maybe you can ask the reporter of the bug to provide debug or at least info logs?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16647633" author="githubbot" created="Fri, 12 Oct 2018 08:18:07 +0000"  >&lt;p&gt;StefanRRichter closed pull request #6723: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10377&quot; title=&quot;Remove precondition in TwoPhaseCommitSinkFunction.notifyCheckpointComplete&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10377&quot;&gt;&lt;del&gt;FLINK-10377&lt;/del&gt;&lt;/a&gt; Remove precondition in TwoPhaseCommitSinkFunction.notif&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6723&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6723&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
index 2ffb6d5810e..0e7be9b2e46 100644&lt;br/&gt;
&amp;#8212; a/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunction.java&lt;br/&gt;
@@ -255,7 +255,6 @@ public final void notifyCheckpointComplete(long checkpointId) throws Exception {&lt;br/&gt;
 		//&lt;/p&gt;

&lt;p&gt; 		Iterator&amp;lt;Map.Entry&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt;&amp;gt; pendingTransactionIterator = pendingCommitTransactions.entrySet().iterator();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;checkState(pendingTransactionIterator.hasNext(), &quot;checkpoint completed, but no transaction pending&quot;);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		while (pendingTransactionIterator.hasNext()) {&lt;br/&gt;
 			Map.Entry&amp;lt;Long, TransactionHolder&amp;lt;TXN&amp;gt;&amp;gt; entry = pendingTransactionIterator.next();&lt;br/&gt;
diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunctionTest.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunctionTest.java&lt;br/&gt;
index 2970b87789d..b97eb0c43e1 100644&lt;br/&gt;
&amp;#8212; a/flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunctionTest.java&lt;br/&gt;
+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/sink/TwoPhaseCommitSinkFunctionTest.java&lt;br/&gt;
@@ -138,6 +138,22 @@ private void closeTestHarness() throws Exception &lt;/p&gt;
{
 		harness.close();
 	}

&lt;p&gt;+	@Test&lt;br/&gt;
+	public void testSubsumedNotificationOfPreviousCheckpoint() throws Exception &lt;/p&gt;
{
+		harness.open();
+		harness.processElement(&quot;42&quot;, 0);
+		harness.snapshot(0, 1);
+		harness.processElement(&quot;43&quot;, 2);
+		harness.snapshot(1, 3);
+		harness.processElement(&quot;44&quot;, 4);
+		harness.snapshot(2, 5);
+		harness.notifyOfCompletedCheckpoint(2);
+		harness.notifyOfCompletedCheckpoint(1);
+
+		assertExactlyOnce(Arrays.asList(&quot;42&quot;, &quot;43&quot;, &quot;44&quot;));
+		assertEquals(1, tmpDirectory.listFiles().size()); // one for currentTransaction
+	}
&lt;p&gt;+&lt;br/&gt;
 	@Test&lt;br/&gt;
 	public void testNotifyOfCompletedCheckpoint() throws Exception {&lt;br/&gt;
 		harness.open();&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16984469" author="pnowojski" created="Thu, 28 Nov 2019 14:39:45 +0000"  >&lt;p&gt;As &lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/UNCHECKED-Error-while-confirming-Checkpoint-td23213.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;reported by a user on the user mailing list&lt;/a&gt;, &lt;tt&gt;TwoPhaseCommitSinkFunction#notifyCheckpointComplete&lt;/tt&gt; can fail with the following exception:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.RuntimeException: Error while confirming checkpoint
    at org.apache.flink.runtime.taskmanager.Task$2.run(Task.java:1205)
    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
    at java.util.concurrent.FutureTask.run(FutureTask.java:266)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
    at java.lang.Thread.run(Thread.java:748)
Caused by: java.lang.IllegalStateException: checkpoint completed, but no transaction pending
    at org.apache.flink.util.Preconditions.checkState(Preconditions.java:195)
    at org.apache.flink.streaming.api.functions.sink.TwoPhaseCommitSinkFunction.notifyCheckpointComplete(TwoPhaseCommitSinkFunction.java:267)
    at org.apache.flink.streaming.api.operators.AbstractUdfStreamOperator.notifyCheckpointComplete(AbstractUdfStreamOperator.java:130)
    at org.apache.flink.streaming.runtime.tasks.StreamTask.notifyCheckpointComplete(StreamTask.java:822)
    at org.apache.flink.runtime.taskmanager.Task$2.run(Task.java:1200)
    ... 5 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This can happen in the following scenario:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;savepoint is triggered&lt;/li&gt;
	&lt;li&gt;checkpoint is triggered&lt;/li&gt;
	&lt;li&gt;checkpoint completes (but it doesn&apos;t subsume the savepoint, because checkpoints subsume only other checkpoints).&lt;/li&gt;
	&lt;li&gt;savepoint completes&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;In this case, &lt;tt&gt;TwoPhaseCommitSinkFunction&lt;/tt&gt; receives first notification that the later checkpoint completed, it commits both savepoint and the checkpoint. Later when savepoint &lt;tt&gt;notifyCheckpointComplete&lt;/tt&gt; arrives, the above error will occur. &lt;/p&gt;

&lt;p&gt;Possible trivial fix is to remove that failing &lt;tt&gt;checkState&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16984523" author="pnowojski" created="Thu, 28 Nov 2019 16:26:20 +0000"  >&lt;p&gt;Merged to master as &lt;tt&gt;33f5e330491ca979caedbd033418a17134f22cb6&lt;/tt&gt;&lt;br/&gt;
to release-1.9 as &lt;tt&gt;cf82a145921d08fd8ac6e76d57b50060056d0f47&lt;/tt&gt;&lt;br/&gt;
to release-1.8 as &lt;tt&gt;aa92ec568ce0ebb8c2e71d0d6069668a06fb91fb&lt;/tt&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13271040">FLINK-14979</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 50 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3yaxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>