<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:23:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-4024] FileSourceFunction not adjusted to new IF lifecycle</title>
                <link>https://issues.apache.org/jira/browse/FLINK-4024</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The InputFormat lifecycle was extended in ac2137cfa5e63bd4f53a4b7669dc591ab210093f, adding additional open-/closeInputFormat() methods.&lt;/p&gt;

&lt;p&gt;The streaming FileSourceFunction was not adjusted for this change, and thus will fail for every InputFormat that leverages these new methods.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12975824">FLINK-4024</key>
            <summary>FileSourceFunction not adjusted to new IF lifecycle</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kkl0u">Kostas Kloudas</assignee>
                                    <reporter username="chesnay">Chesnay Schepler</reporter>
                        <labels>
                    </labels>
                <created>Sun, 5 Jun 2016 17:36:10 +0000</created>
                <updated>Thu, 28 Feb 2019 11:14:40 +0000</updated>
                            <resolved>Thu, 16 Jun 2016 07:44:02 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15317064" author="fhueske" created="Mon, 6 Jun 2016 19:39:18 +0000"  >&lt;p&gt;It appears that &lt;tt&gt;FileSourceFunction&lt;/tt&gt; doesn&apos;t call &lt;tt&gt;RichInputFormat.setRuntimeContext()&lt;/tt&gt; as well. &lt;/p&gt;</comment>
                            <comment id="15317071" author="zentol" created="Mon, 6 Jun 2016 19:42:47 +0000"  >&lt;p&gt;it also starts the function regardless of whether splitIterator.hasNext() returns true or false. This may cause issues with NonParallelInputFormats when the parallelism of the FileSourceFunction is greater than 1.&lt;/p&gt;</comment>
                            <comment id="15318338" author="stephanewen" created="Tue, 7 Jun 2016 11:46:01 +0000"  >&lt;p&gt;Related: I commented on &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-3777&quot; title=&quot;Add open and close methods to manage IF lifecycle&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-3777&quot;&gt;&lt;del&gt;FLINK-3777&lt;/del&gt;&lt;/a&gt; voicing some concerns if that is a desirable functionality in the first place.&lt;/p&gt;</comment>
                            <comment id="15324495" author="aljoscha" created="Fri, 10 Jun 2016 14:00:25 +0000"  >&lt;p&gt;This is also impacted by &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2314&quot; title=&quot;Make Streaming File Sources Persistent&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2314&quot;&gt;&lt;del&gt;FLINK-2314&lt;/del&gt;&lt;/a&gt; and vice-versa.&lt;/p&gt;</comment>
                            <comment id="15329623" author="githubbot" created="Tue, 14 Jun 2016 15:00:12 +0000"  >&lt;p&gt;GitHub user kl0u opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4024&quot; title=&quot;FileSourceFunction not adjusted to new IF lifecycle&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4024&quot;&gt;&lt;del&gt;FLINK-4024&lt;/del&gt;&lt;/a&gt; FileSourceFunction not adjusted to new IF lifecycle&lt;/p&gt;

&lt;p&gt;    Refactors the FileSourceFunction to respect the lifecycle of a RichInputFormat.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/kl0u/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/kl0u/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4024&quot; title=&quot;FileSourceFunction not adjusted to new IF lifecycle&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4024&quot;&gt;&lt;del&gt;FLINK-4024&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2100&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 987b3851704a5a20da08bd92e676d1c2c529c532&lt;br/&gt;
Author: kl0u &amp;lt;kkloudas@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-06-13T09:55:56Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-4024&quot; title=&quot;FileSourceFunction not adjusted to new IF lifecycle&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-4024&quot;&gt;&lt;del&gt;FLINK-4024&lt;/del&gt;&lt;/a&gt; FileSourceFunction not adjusted to new IF lifecycle&lt;/p&gt;

&lt;p&gt;    Refactors the FileSourceFunction to respect the&lt;br/&gt;
    lifecycle of a RichInputFormat.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15329780" author="githubbot" created="Tue, 14 Jun 2016 16:19:50 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100#discussion_r67003772&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100#discussion_r67003772&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/FileSourceFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,258 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.ExecutionConfig;&lt;br/&gt;
    +import org.apache.flink.api.common.accumulators.Accumulator;&lt;br/&gt;
    +import org.apache.flink.api.common.io.RichInputFormat;&lt;br/&gt;
    +import org.apache.flink.api.common.io.statistics.BaseStatistics;&lt;br/&gt;
    +import org.apache.flink.api.common.typeinfo.TypeInformation;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplit;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplitAssigner;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.tasks.InputSplitProvider;&lt;br/&gt;
    +import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
    +import org.apache.flink.runtime.operators.testutils.MockEnvironment;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.AbstractStreamOperator;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.StreamingRuntimeContext;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +&lt;br/&gt;
    +public class FileSourceFunctionTest {&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testNormalOp() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(false);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelation() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(true);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void testForEmptyLocation(final boolean midCancel) throws Exception &lt;/p&gt;
{
    +
    +		final int noOfSplits = 5;
    +		final int cancelAt = 2;
    +
    +		final LifeCycleTestInputFormat format = new LifeCycleTestInputFormat();
    +		final FileSourceFunction&amp;lt;Integer&amp;gt; reader = new FileSourceFunction&amp;lt;&amp;gt;(format, TypeInformation.of(Integer.class));
    +		reader.setRuntimeContext(new MockRuntimeContext(format, noOfSplits));
    +
    +		Assert.assertTrue(!format.isConfigured);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +		Assert.assertTrue(!format.isSplitOpen);
    +
    +		reader.open(new Configuration());
    +		Assert.assertTrue(format.isConfigured);
    +
    +		TestSourceContext ctx = new TestSourceContext(reader, format, midCancel, cancelAt);
    +		reader.run(ctx);
    +
    +		int splitsSeen = ctx.getSplitsSeen();
    +		Assert.assertTrue(midCancel ? splitsSeen == cancelAt : splitsSeen == noOfSplits);
    +
    +		// we have exhausted the splits so the
    +		// format and splits should be closed by now
    +
    +		Assert.assertTrue(!format.isSplitOpen);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +&lt;br/&gt;
    +	private static class LifeCycleTestInputFormat extends RichInputFormat&amp;lt;Integer,InputSplit&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		private boolean isConfigured = false;&lt;br/&gt;
    +		private boolean isInputFormatOpen = false;&lt;br/&gt;
    +		private boolean isSplitOpen = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		// end of split&lt;br/&gt;
    +		private boolean eos = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private int splitCounter = 0;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void openInputFormat() &lt;/p&gt;
{
    +			this.isInputFormatOpen = true;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void closeInputFormat() &lt;/p&gt;
{
    +			this.isInputFormatOpen = false;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void configure(Configuration parameters) &lt;/p&gt;
{
    +			this.isConfigured = true;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public BaseStatistics getStatistics(BaseStatistics cachedStatistics) throws IOException &lt;/p&gt;
{
    +			return null;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public InputSplit[] createInputSplits(int minNumSplits) throws IOException {&lt;br/&gt;
    +			InputSplit[] splits = new InputSplit&lt;span class=&quot;error&quot;&gt;&amp;#91;minNumSplits&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +			for (int i = 0; i &amp;lt; minNumSplits; i++) {&lt;br/&gt;
    +				final int idx = i;&lt;br/&gt;
    +				splits&lt;span class=&quot;error&quot;&gt;&amp;#91;idx&amp;#93;&lt;/span&gt; = new InputSplit() {&lt;br/&gt;
    +					@Override&lt;br/&gt;
    +					public int getSplitNumber() {
    +						return idx;
    +					}&lt;br/&gt;
    +				};&lt;br/&gt;
    +			}&lt;br/&gt;
    +			return splits;&lt;br/&gt;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public InputSplitAssigner getInputSplitAssigner(InputSplit[] inputSplits) {    +			return null;    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void open(InputSplit split) throws IOException &lt;/p&gt;
{
    +			// whenever a new split opens,
    +			// the previous should have been closed
    +			Assert.assertTrue(!isSplitOpen);
    +
    +			isSplitOpen = true;
    +			eos = false;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public boolean reachedEnd() throws IOException &lt;/p&gt;
{
    +			return eos;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Integer nextRecord(Integer reuse) throws IOException {&lt;br/&gt;
    +			eos = true;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Assert that open() was called before?&lt;/p&gt;</comment>
                            <comment id="15329784" author="githubbot" created="Tue, 14 Jun 2016 16:19:52 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100#discussion_r67003727&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100#discussion_r67003727&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/FileSourceFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,258 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.ExecutionConfig;&lt;br/&gt;
    +import org.apache.flink.api.common.accumulators.Accumulator;&lt;br/&gt;
    +import org.apache.flink.api.common.io.RichInputFormat;&lt;br/&gt;
    +import org.apache.flink.api.common.io.statistics.BaseStatistics;&lt;br/&gt;
    +import org.apache.flink.api.common.typeinfo.TypeInformation;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplit;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplitAssigner;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.tasks.InputSplitProvider;&lt;br/&gt;
    +import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
    +import org.apache.flink.runtime.operators.testutils.MockEnvironment;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.AbstractStreamOperator;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.StreamingRuntimeContext;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +&lt;br/&gt;
    +public class FileSourceFunctionTest {&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testNormalOp() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(false);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelation() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(true);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void testForEmptyLocation(final boolean midCancel) throws Exception &lt;/p&gt;
{
    +
    +		final int noOfSplits = 5;
    +		final int cancelAt = 2;
    +
    +		final LifeCycleTestInputFormat format = new LifeCycleTestInputFormat();
    +		final FileSourceFunction&amp;lt;Integer&amp;gt; reader = new FileSourceFunction&amp;lt;&amp;gt;(format, TypeInformation.of(Integer.class));
    +		reader.setRuntimeContext(new MockRuntimeContext(format, noOfSplits));
    +
    +		Assert.assertTrue(!format.isConfigured);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +		Assert.assertTrue(!format.isSplitOpen);
    +
    +		reader.open(new Configuration());
    +		Assert.assertTrue(format.isConfigured);
    +
    +		TestSourceContext ctx = new TestSourceContext(reader, format, midCancel, cancelAt);
    +		reader.run(ctx);
    +
    +		int splitsSeen = ctx.getSplitsSeen();
    +		Assert.assertTrue(midCancel ? splitsSeen == cancelAt : splitsSeen == noOfSplits);
    +
    +		// we have exhausted the splits so the
    +		// format and splits should be closed by now
    +
    +		Assert.assertTrue(!format.isSplitOpen);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +&lt;br/&gt;
    +	private static class LifeCycleTestInputFormat extends RichInputFormat&amp;lt;Integer,InputSplit&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		private boolean isConfigured = false;&lt;br/&gt;
    +		private boolean isInputFormatOpen = false;&lt;br/&gt;
    +		private boolean isSplitOpen = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		// end of split&lt;br/&gt;
    +		private boolean eos = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private int splitCounter = 0;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void openInputFormat() &lt;/p&gt;
{
    +			this.isInputFormatOpen = true;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void closeInputFormat() &lt;/p&gt;
{
    +			this.isInputFormatOpen = false;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void configure(Configuration parameters) &lt;/p&gt;
{
    +			this.isConfigured = true;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public BaseStatistics getStatistics(BaseStatistics cachedStatistics) throws IOException &lt;/p&gt;
{
    +			return null;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public InputSplit[] createInputSplits(int minNumSplits) throws IOException {&lt;br/&gt;
    +			InputSplit[] splits = new InputSplit&lt;span class=&quot;error&quot;&gt;&amp;#91;minNumSplits&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +			for (int i = 0; i &amp;lt; minNumSplits; i++) {&lt;br/&gt;
    +				final int idx = i;&lt;br/&gt;
    +				splits&lt;span class=&quot;error&quot;&gt;&amp;#91;idx&amp;#93;&lt;/span&gt; = new InputSplit() {&lt;br/&gt;
    +					@Override&lt;br/&gt;
    +					public int getSplitNumber() {
    +						return idx;
    +					}&lt;br/&gt;
    +				};&lt;br/&gt;
    +			}&lt;br/&gt;
    +			return splits;&lt;br/&gt;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public InputSplitAssigner getInputSplitAssigner(InputSplit[] inputSplits) {    +			return null;    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void open(InputSplit split) throws IOException &lt;/p&gt;
{
    +			// whenever a new split opens,
    +			// the previous should have been closed
    +			Assert.assertTrue(!isSplitOpen);
    +
    +			isSplitOpen = true;
    +			eos = false;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public boolean reachedEnd() throws IOException &lt;/p&gt;
{
    +			return eos;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Integer nextRecord(Integer reuse) throws IOException &lt;/p&gt;
{
    +			eos = true;
    +			return splitCounter++;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() throws IOException {&lt;br/&gt;
    +			this.isSplitOpen = false;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Assert that split was opened before?&lt;/p&gt;</comment>
                            <comment id="15329810" author="githubbot" created="Tue, 14 Jun 2016 16:29:59 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100#discussion_r67006059&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100#discussion_r67006059&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/FileSourceFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,258 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.ExecutionConfig;&lt;br/&gt;
    +import org.apache.flink.api.common.accumulators.Accumulator;&lt;br/&gt;
    +import org.apache.flink.api.common.io.RichInputFormat;&lt;br/&gt;
    +import org.apache.flink.api.common.io.statistics.BaseStatistics;&lt;br/&gt;
    +import org.apache.flink.api.common.typeinfo.TypeInformation;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplit;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplitAssigner;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.tasks.InputSplitProvider;&lt;br/&gt;
    +import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
    +import org.apache.flink.runtime.operators.testutils.MockEnvironment;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.AbstractStreamOperator;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.StreamingRuntimeContext;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +&lt;br/&gt;
    +public class FileSourceFunctionTest {&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testNormalOp() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(false);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelation() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(true);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void testForEmptyLocation(final boolean midCancel) throws Exception {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Why is this called `testForEmptyLocation`? Wouldn&apos;t `testInputFormatLifeCycle` be a better name?&lt;/p&gt;</comment>
                            <comment id="15329823" author="githubbot" created="Tue, 14 Jun 2016 16:34:00 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100#discussion_r67006831&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100#discussion_r67006831&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/FileSourceFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,258 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.ExecutionConfig;&lt;br/&gt;
    +import org.apache.flink.api.common.accumulators.Accumulator;&lt;br/&gt;
    +import org.apache.flink.api.common.io.RichInputFormat;&lt;br/&gt;
    +import org.apache.flink.api.common.io.statistics.BaseStatistics;&lt;br/&gt;
    +import org.apache.flink.api.common.typeinfo.TypeInformation;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplit;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplitAssigner;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.tasks.InputSplitProvider;&lt;br/&gt;
    +import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
    +import org.apache.flink.runtime.operators.testutils.MockEnvironment;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.AbstractStreamOperator;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.StreamingRuntimeContext;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +&lt;br/&gt;
    +public class FileSourceFunctionTest {&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testNormalOp() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(false);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelation() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(true);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void testForEmptyLocation(final boolean midCancel) throws Exception &lt;/p&gt;
{
    +
    +		final int noOfSplits = 5;
    +		final int cancelAt = 2;
    +
    +		final LifeCycleTestInputFormat format = new LifeCycleTestInputFormat();
    +		final FileSourceFunction&amp;lt;Integer&amp;gt; reader = new FileSourceFunction&amp;lt;&amp;gt;(format, TypeInformation.of(Integer.class));
    +		reader.setRuntimeContext(new MockRuntimeContext(format, noOfSplits));
    +
    +		Assert.assertTrue(!format.isConfigured);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +		Assert.assertTrue(!format.isSplitOpen);
    +
    +		reader.open(new Configuration());
    +		Assert.assertTrue(format.isConfigured);
    +
    +		TestSourceContext ctx = new TestSourceContext(reader, format, midCancel, cancelAt);
    +		reader.run(ctx);
    +
    +		int splitsSeen = ctx.getSplitsSeen();
    +		Assert.assertTrue(midCancel ? splitsSeen == cancelAt : splitsSeen == noOfSplits);
    +
    +		// we have exhausted the splits so the
    +		// format and splits should be closed by now
    +
    +		Assert.assertTrue(!format.isSplitOpen);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +&lt;br/&gt;
    +	private static class LifeCycleTestInputFormat extends RichInputFormat&amp;lt;Integer,InputSplit&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		private boolean isConfigured = false;&lt;br/&gt;
    +		private boolean isInputFormatOpen = false;&lt;br/&gt;
    +		private boolean isSplitOpen = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		// end of split&lt;br/&gt;
    +		private boolean eos = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private int splitCounter = 0;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void openInputFormat() &lt;/p&gt;
{
    +			this.isInputFormatOpen = true;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void closeInputFormat() &lt;/p&gt;
{
    +			this.isInputFormatOpen = false;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void configure(Configuration parameters) &lt;/p&gt;
{
    +			this.isConfigured = true;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public BaseStatistics getStatistics(BaseStatistics cachedStatistics) throws IOException &lt;/p&gt;
{
    +			return null;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public InputSplit[] createInputSplits(int minNumSplits) throws IOException {&lt;br/&gt;
    +			InputSplit[] splits = new InputSplit&lt;span class=&quot;error&quot;&gt;&amp;#91;minNumSplits&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +			for (int i = 0; i &amp;lt; minNumSplits; i++) {&lt;br/&gt;
    +				final int idx = i;&lt;br/&gt;
    +				splits&lt;span class=&quot;error&quot;&gt;&amp;#91;idx&amp;#93;&lt;/span&gt; = new InputSplit() {&lt;br/&gt;
    +					@Override&lt;br/&gt;
    +					public int getSplitNumber() {
    +						return idx;
    +					}&lt;br/&gt;
    +				};&lt;br/&gt;
    +			}&lt;br/&gt;
    +			return splits;&lt;br/&gt;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public InputSplitAssigner getInputSplitAssigner(InputSplit[] inputSplits) {    +			return null;    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void open(InputSplit split) throws IOException {&lt;br/&gt;
    +			// whenever a new split opens,&lt;br/&gt;
    +			// the previous should have been closed&lt;br/&gt;
    +			Assert.assertTrue(!isSplitOpen);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    check that configure() was called before.&lt;/p&gt;</comment>
                            <comment id="15329824" author="githubbot" created="Tue, 14 Jun 2016 16:34:11 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100#discussion_r67006854&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100#discussion_r67006854&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/FileSourceFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,258 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.ExecutionConfig;&lt;br/&gt;
    +import org.apache.flink.api.common.accumulators.Accumulator;&lt;br/&gt;
    +import org.apache.flink.api.common.io.RichInputFormat;&lt;br/&gt;
    +import org.apache.flink.api.common.io.statistics.BaseStatistics;&lt;br/&gt;
    +import org.apache.flink.api.common.typeinfo.TypeInformation;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplit;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplitAssigner;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.tasks.InputSplitProvider;&lt;br/&gt;
    +import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
    +import org.apache.flink.runtime.operators.testutils.MockEnvironment;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.AbstractStreamOperator;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.StreamingRuntimeContext;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +&lt;br/&gt;
    +public class FileSourceFunctionTest {&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testNormalOp() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(false);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelation() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(true);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void testForEmptyLocation(final boolean midCancel) throws Exception &lt;/p&gt;
{
    +
    +		final int noOfSplits = 5;
    +		final int cancelAt = 2;
    +
    +		final LifeCycleTestInputFormat format = new LifeCycleTestInputFormat();
    +		final FileSourceFunction&amp;lt;Integer&amp;gt; reader = new FileSourceFunction&amp;lt;&amp;gt;(format, TypeInformation.of(Integer.class));
    +		reader.setRuntimeContext(new MockRuntimeContext(format, noOfSplits));
    +
    +		Assert.assertTrue(!format.isConfigured);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +		Assert.assertTrue(!format.isSplitOpen);
    +
    +		reader.open(new Configuration());
    +		Assert.assertTrue(format.isConfigured);
    +
    +		TestSourceContext ctx = new TestSourceContext(reader, format, midCancel, cancelAt);
    +		reader.run(ctx);
    +
    +		int splitsSeen = ctx.getSplitsSeen();
    +		Assert.assertTrue(midCancel ? splitsSeen == cancelAt : splitsSeen == noOfSplits);
    +
    +		// we have exhausted the splits so the
    +		// format and splits should be closed by now
    +
    +		Assert.assertTrue(!format.isSplitOpen);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +&lt;br/&gt;
    +	private static class LifeCycleTestInputFormat extends RichInputFormat&amp;lt;Integer,InputSplit&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		private boolean isConfigured = false;&lt;br/&gt;
    +		private boolean isInputFormatOpen = false;&lt;br/&gt;
    +		private boolean isSplitOpen = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		// end of split&lt;br/&gt;
    +		private boolean eos = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private int splitCounter = 0;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void openInputFormat() &lt;/p&gt;
{
    +			this.isInputFormatOpen = true;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void closeInputFormat() &lt;/p&gt;
{
    +			this.isInputFormatOpen = false;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void configure(Configuration parameters) &lt;/p&gt;
{
    +			this.isConfigured = true;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public BaseStatistics getStatistics(BaseStatistics cachedStatistics) throws IOException &lt;/p&gt;
{
    +			return null;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public InputSplit[] createInputSplits(int minNumSplits) throws IOException {&lt;br/&gt;
    +			InputSplit[] splits = new InputSplit&lt;span class=&quot;error&quot;&gt;&amp;#91;minNumSplits&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Check that configure was called before&lt;/p&gt;</comment>
                            <comment id="15329825" author="githubbot" created="Tue, 14 Jun 2016 16:34:28 +0000"  >&lt;p&gt;Github user kl0u commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100#discussion_r67006905&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100#discussion_r67006905&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/FileSourceFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,258 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.ExecutionConfig;&lt;br/&gt;
    +import org.apache.flink.api.common.accumulators.Accumulator;&lt;br/&gt;
    +import org.apache.flink.api.common.io.RichInputFormat;&lt;br/&gt;
    +import org.apache.flink.api.common.io.statistics.BaseStatistics;&lt;br/&gt;
    +import org.apache.flink.api.common.typeinfo.TypeInformation;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplit;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplitAssigner;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.tasks.InputSplitProvider;&lt;br/&gt;
    +import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
    +import org.apache.flink.runtime.operators.testutils.MockEnvironment;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.AbstractStreamOperator;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.StreamingRuntimeContext;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +&lt;br/&gt;
    +public class FileSourceFunctionTest {&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testNormalOp() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(false);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelation() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(true);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void testForEmptyLocation(final boolean midCancel) throws Exception &lt;/p&gt;
{
    +
    +		final int noOfSplits = 5;
    +		final int cancelAt = 2;
    +
    +		final LifeCycleTestInputFormat format = new LifeCycleTestInputFormat();
    +		final FileSourceFunction&amp;lt;Integer&amp;gt; reader = new FileSourceFunction&amp;lt;&amp;gt;(format, TypeInformation.of(Integer.class));
    +		reader.setRuntimeContext(new MockRuntimeContext(format, noOfSplits));
    +
    +		Assert.assertTrue(!format.isConfigured);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +		Assert.assertTrue(!format.isSplitOpen);
    +
    +		reader.open(new Configuration());
    +		Assert.assertTrue(format.isConfigured);
    +
    +		TestSourceContext ctx = new TestSourceContext(reader, format, midCancel, cancelAt);
    +		reader.run(ctx);
    +
    +		int splitsSeen = ctx.getSplitsSeen();
    +		Assert.assertTrue(midCancel ? splitsSeen == cancelAt : splitsSeen == noOfSplits);
    +
    +		// we have exhausted the splits so the
    +		// format and splits should be closed by now
    +
    +		Assert.assertTrue(!format.isSplitOpen);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +&lt;br/&gt;
    +	private static class LifeCycleTestInputFormat extends RichInputFormat&amp;lt;Integer,InputSplit&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		private boolean isConfigured = false;&lt;br/&gt;
    +		private boolean isInputFormatOpen = false;&lt;br/&gt;
    +		private boolean isSplitOpen = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		// end of split&lt;br/&gt;
    +		private boolean eos = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private int splitCounter = 0;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void openInputFormat() &lt;/p&gt;
{
    +			this.isInputFormatOpen = true;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void closeInputFormat() &lt;/p&gt;
{
    +			this.isInputFormatOpen = false;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void configure(Configuration parameters) &lt;/p&gt;
{
    +			this.isConfigured = true;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public BaseStatistics getStatistics(BaseStatistics cachedStatistics) throws IOException &lt;/p&gt;
{
    +			return null;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public InputSplit[] createInputSplits(int minNumSplits) throws IOException {&lt;br/&gt;
    +			InputSplit[] splits = new InputSplit&lt;span class=&quot;error&quot;&gt;&amp;#91;minNumSplits&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +			for (int i = 0; i &amp;lt; minNumSplits; i++) {&lt;br/&gt;
    +				final int idx = i;&lt;br/&gt;
    +				splits&lt;span class=&quot;error&quot;&gt;&amp;#91;idx&amp;#93;&lt;/span&gt; = new InputSplit() {&lt;br/&gt;
    +					@Override&lt;br/&gt;
    +					public int getSplitNumber() {
    +						return idx;
    +					}&lt;br/&gt;
    +				};&lt;br/&gt;
    +			}&lt;br/&gt;
    +			return splits;&lt;br/&gt;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public InputSplitAssigner getInputSplitAssigner(InputSplit[] inputSplits) {    +			return null;    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void open(InputSplit split) throws IOException &lt;/p&gt;
{
    +			// whenever a new split opens,
    +			// the previous should have been closed
    +			Assert.assertTrue(!isSplitOpen);
    +
    +			isSplitOpen = true;
    +			eos = false;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public boolean reachedEnd() throws IOException &lt;/p&gt;
{
    +			return eos;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Integer nextRecord(Integer reuse) throws IOException &lt;/p&gt;
{
    +			eos = true;
    +			return splitCounter++;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() throws IOException {&lt;br/&gt;
    +			this.isSplitOpen = false;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    The problem with this is that the close() in the FileSourceFunction is called also in the finally{} block, which can be redundant in the cases that the split was already closed. This is why I do not&lt;br/&gt;
    check it here, but I check that whenever you call open(), the format was not opened before.&lt;/p&gt;</comment>
                            <comment id="15329826" author="githubbot" created="Tue, 14 Jun 2016 16:34:41 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100#discussion_r67006934&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100#discussion_r67006934&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/FileSourceFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,258 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.ExecutionConfig;&lt;br/&gt;
    +import org.apache.flink.api.common.accumulators.Accumulator;&lt;br/&gt;
    +import org.apache.flink.api.common.io.RichInputFormat;&lt;br/&gt;
    +import org.apache.flink.api.common.io.statistics.BaseStatistics;&lt;br/&gt;
    +import org.apache.flink.api.common.typeinfo.TypeInformation;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplit;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplitAssigner;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.tasks.InputSplitProvider;&lt;br/&gt;
    +import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
    +import org.apache.flink.runtime.operators.testutils.MockEnvironment;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.AbstractStreamOperator;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.StreamingRuntimeContext;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +&lt;br/&gt;
    +public class FileSourceFunctionTest {&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testNormalOp() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(false);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelation() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(true);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void testForEmptyLocation(final boolean midCancel) throws Exception &lt;/p&gt;
{
    +
    +		final int noOfSplits = 5;
    +		final int cancelAt = 2;
    +
    +		final LifeCycleTestInputFormat format = new LifeCycleTestInputFormat();
    +		final FileSourceFunction&amp;lt;Integer&amp;gt; reader = new FileSourceFunction&amp;lt;&amp;gt;(format, TypeInformation.of(Integer.class));
    +		reader.setRuntimeContext(new MockRuntimeContext(format, noOfSplits));
    +
    +		Assert.assertTrue(!format.isConfigured);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +		Assert.assertTrue(!format.isSplitOpen);
    +
    +		reader.open(new Configuration());
    +		Assert.assertTrue(format.isConfigured);
    +
    +		TestSourceContext ctx = new TestSourceContext(reader, format, midCancel, cancelAt);
    +		reader.run(ctx);
    +
    +		int splitsSeen = ctx.getSplitsSeen();
    +		Assert.assertTrue(midCancel ? splitsSeen == cancelAt : splitsSeen == noOfSplits);
    +
    +		// we have exhausted the splits so the
    +		// format and splits should be closed by now
    +
    +		Assert.assertTrue(!format.isSplitOpen);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +&lt;br/&gt;
    +	private static class LifeCycleTestInputFormat extends RichInputFormat&amp;lt;Integer,InputSplit&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		private boolean isConfigured = false;&lt;br/&gt;
    +		private boolean isInputFormatOpen = false;&lt;br/&gt;
    +		private boolean isSplitOpen = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		// end of split&lt;br/&gt;
    +		private boolean eos = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private int splitCounter = 0;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void openInputFormat() &lt;/p&gt;
{
    +			this.isInputFormatOpen = true;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void closeInputFormat() {&lt;br/&gt;
    +			this.isInputFormatOpen = false;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Check that openInputFormat() was called before&lt;/p&gt;</comment>
                            <comment id="15329827" author="githubbot" created="Tue, 14 Jun 2016 16:36:31 +0000"  >&lt;p&gt;Github user fhueske commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @kl0u, thanks for the PR! The implementation looks good. A few more checks could be added to the tests.&lt;/p&gt;</comment>
                            <comment id="15329842" author="githubbot" created="Tue, 14 Jun 2016 16:43:02 +0000"  >&lt;p&gt;Github user kl0u commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100#discussion_r67008351&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100#discussion_r67008351&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/FileSourceFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,258 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.ExecutionConfig;&lt;br/&gt;
    +import org.apache.flink.api.common.accumulators.Accumulator;&lt;br/&gt;
    +import org.apache.flink.api.common.io.RichInputFormat;&lt;br/&gt;
    +import org.apache.flink.api.common.io.statistics.BaseStatistics;&lt;br/&gt;
    +import org.apache.flink.api.common.typeinfo.TypeInformation;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplit;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplitAssigner;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.tasks.InputSplitProvider;&lt;br/&gt;
    +import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
    +import org.apache.flink.runtime.operators.testutils.MockEnvironment;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.AbstractStreamOperator;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.StreamingRuntimeContext;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +&lt;br/&gt;
    +public class FileSourceFunctionTest {&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testNormalOp() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(false);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelation() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(true);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void testForEmptyLocation(final boolean midCancel) throws Exception &lt;/p&gt;
{
    +
    +		final int noOfSplits = 5;
    +		final int cancelAt = 2;
    +
    +		final LifeCycleTestInputFormat format = new LifeCycleTestInputFormat();
    +		final FileSourceFunction&amp;lt;Integer&amp;gt; reader = new FileSourceFunction&amp;lt;&amp;gt;(format, TypeInformation.of(Integer.class));
    +		reader.setRuntimeContext(new MockRuntimeContext(format, noOfSplits));
    +
    +		Assert.assertTrue(!format.isConfigured);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +		Assert.assertTrue(!format.isSplitOpen);
    +
    +		reader.open(new Configuration());
    +		Assert.assertTrue(format.isConfigured);
    +
    +		TestSourceContext ctx = new TestSourceContext(reader, format, midCancel, cancelAt);
    +		reader.run(ctx);
    +
    +		int splitsSeen = ctx.getSplitsSeen();
    +		Assert.assertTrue(midCancel ? splitsSeen == cancelAt : splitsSeen == noOfSplits);
    +
    +		// we have exhausted the splits so the
    +		// format and splits should be closed by now
    +
    +		Assert.assertTrue(!format.isSplitOpen);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +&lt;br/&gt;
    +	private static class LifeCycleTestInputFormat extends RichInputFormat&amp;lt;Integer,InputSplit&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		private boolean isConfigured = false;&lt;br/&gt;
    +		private boolean isInputFormatOpen = false;&lt;br/&gt;
    +		private boolean isSplitOpen = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		// end of split&lt;br/&gt;
    +		private boolean eos = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private int splitCounter = 0;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void openInputFormat() &lt;/p&gt;
{
    +			this.isInputFormatOpen = true;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void closeInputFormat() {&lt;br/&gt;
    +			this.isInputFormatOpen = false;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Same for this one.&lt;/p&gt;</comment>
                            <comment id="15329863" author="githubbot" created="Tue, 14 Jun 2016 16:48:26 +0000"  >&lt;p&gt;Github user kl0u commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks @fhueske for the comments. &lt;/p&gt;

&lt;p&gt;    Now that also &lt;a href=&quot;https://github.com/apache/flink/pull/2020&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2020&lt;/a&gt; is merged I will also update that one to handle RichInputFormats.&lt;/p&gt;</comment>
                            <comment id="15329904" author="githubbot" created="Tue, 14 Jun 2016 17:05:04 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100#discussion_r67012682&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100#discussion_r67012682&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/FileSourceFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,258 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.ExecutionConfig;&lt;br/&gt;
    +import org.apache.flink.api.common.accumulators.Accumulator;&lt;br/&gt;
    +import org.apache.flink.api.common.io.RichInputFormat;&lt;br/&gt;
    +import org.apache.flink.api.common.io.statistics.BaseStatistics;&lt;br/&gt;
    +import org.apache.flink.api.common.typeinfo.TypeInformation;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplit;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplitAssigner;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.tasks.InputSplitProvider;&lt;br/&gt;
    +import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
    +import org.apache.flink.runtime.operators.testutils.MockEnvironment;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.AbstractStreamOperator;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.StreamingRuntimeContext;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +&lt;br/&gt;
    +public class FileSourceFunctionTest {&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testNormalOp() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(false);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelation() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(true);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void testForEmptyLocation(final boolean midCancel) throws Exception &lt;/p&gt;
{
    +
    +		final int noOfSplits = 5;
    +		final int cancelAt = 2;
    +
    +		final LifeCycleTestInputFormat format = new LifeCycleTestInputFormat();
    +		final FileSourceFunction&amp;lt;Integer&amp;gt; reader = new FileSourceFunction&amp;lt;&amp;gt;(format, TypeInformation.of(Integer.class));
    +		reader.setRuntimeContext(new MockRuntimeContext(format, noOfSplits));
    +
    +		Assert.assertTrue(!format.isConfigured);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +		Assert.assertTrue(!format.isSplitOpen);
    +
    +		reader.open(new Configuration());
    +		Assert.assertTrue(format.isConfigured);
    +
    +		TestSourceContext ctx = new TestSourceContext(reader, format, midCancel, cancelAt);
    +		reader.run(ctx);
    +
    +		int splitsSeen = ctx.getSplitsSeen();
    +		Assert.assertTrue(midCancel ? splitsSeen == cancelAt : splitsSeen == noOfSplits);
    +
    +		// we have exhausted the splits so the
    +		// format and splits should be closed by now
    +
    +		Assert.assertTrue(!format.isSplitOpen);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +&lt;br/&gt;
    +	private static class LifeCycleTestInputFormat extends RichInputFormat&amp;lt;Integer,InputSplit&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		private boolean isConfigured = false;&lt;br/&gt;
    +		private boolean isInputFormatOpen = false;&lt;br/&gt;
    +		private boolean isSplitOpen = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		// end of split&lt;br/&gt;
    +		private boolean eos = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private int splitCounter = 0;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void openInputFormat() &lt;/p&gt;
{
    +			this.isInputFormatOpen = true;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void closeInputFormat() &lt;/p&gt;
{
    +			this.isInputFormatOpen = false;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void configure(Configuration parameters) &lt;/p&gt;
{
    +			this.isConfigured = true;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public BaseStatistics getStatistics(BaseStatistics cachedStatistics) throws IOException &lt;/p&gt;
{
    +			return null;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public InputSplit[] createInputSplits(int minNumSplits) throws IOException {&lt;br/&gt;
    +			InputSplit[] splits = new InputSplit&lt;span class=&quot;error&quot;&gt;&amp;#91;minNumSplits&amp;#93;&lt;/span&gt;;&lt;br/&gt;
    +&lt;br/&gt;
    +			for (int i = 0; i &amp;lt; minNumSplits; i++) {&lt;br/&gt;
    +				final int idx = i;&lt;br/&gt;
    +				splits&lt;span class=&quot;error&quot;&gt;&amp;#91;idx&amp;#93;&lt;/span&gt; = new InputSplit() {&lt;br/&gt;
    +					@Override&lt;br/&gt;
    +					public int getSplitNumber() {
    +						return idx;
    +					}&lt;br/&gt;
    +				};&lt;br/&gt;
    +			}&lt;br/&gt;
    +			return splits;&lt;br/&gt;
    +		}&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public InputSplitAssigner getInputSplitAssigner(InputSplit[] inputSplits) {    +			return null;    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void open(InputSplit split) throws IOException &lt;/p&gt;
{
    +			// whenever a new split opens,
    +			// the previous should have been closed
    +			Assert.assertTrue(!isSplitOpen);
    +
    +			isSplitOpen = true;
    +			eos = false;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public boolean reachedEnd() throws IOException &lt;/p&gt;
{
    +			return eos;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public Integer nextRecord(Integer reuse) throws IOException &lt;/p&gt;
{
    +			eos = true;
    +			return splitCounter++;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void close() throws IOException {&lt;br/&gt;
    +			this.isSplitOpen = false;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    OK&lt;/p&gt;</comment>
                            <comment id="15329905" author="githubbot" created="Tue, 14 Jun 2016 17:05:05 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100#discussion_r67012706&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100#discussion_r67012706&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/FileSourceFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,258 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.ExecutionConfig;&lt;br/&gt;
    +import org.apache.flink.api.common.accumulators.Accumulator;&lt;br/&gt;
    +import org.apache.flink.api.common.io.RichInputFormat;&lt;br/&gt;
    +import org.apache.flink.api.common.io.statistics.BaseStatistics;&lt;br/&gt;
    +import org.apache.flink.api.common.typeinfo.TypeInformation;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplit;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplitAssigner;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.tasks.InputSplitProvider;&lt;br/&gt;
    +import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
    +import org.apache.flink.runtime.operators.testutils.MockEnvironment;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.AbstractStreamOperator;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.StreamingRuntimeContext;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +&lt;br/&gt;
    +public class FileSourceFunctionTest {&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testNormalOp() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(false);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelation() throws Exception &lt;/p&gt;
{
    +		testForEmptyLocation(true);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void testForEmptyLocation(final boolean midCancel) throws Exception &lt;/p&gt;
{
    +
    +		final int noOfSplits = 5;
    +		final int cancelAt = 2;
    +
    +		final LifeCycleTestInputFormat format = new LifeCycleTestInputFormat();
    +		final FileSourceFunction&amp;lt;Integer&amp;gt; reader = new FileSourceFunction&amp;lt;&amp;gt;(format, TypeInformation.of(Integer.class));
    +		reader.setRuntimeContext(new MockRuntimeContext(format, noOfSplits));
    +
    +		Assert.assertTrue(!format.isConfigured);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +		Assert.assertTrue(!format.isSplitOpen);
    +
    +		reader.open(new Configuration());
    +		Assert.assertTrue(format.isConfigured);
    +
    +		TestSourceContext ctx = new TestSourceContext(reader, format, midCancel, cancelAt);
    +		reader.run(ctx);
    +
    +		int splitsSeen = ctx.getSplitsSeen();
    +		Assert.assertTrue(midCancel ? splitsSeen == cancelAt : splitsSeen == noOfSplits);
    +
    +		// we have exhausted the splits so the
    +		// format and splits should be closed by now
    +
    +		Assert.assertTrue(!format.isSplitOpen);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +&lt;br/&gt;
    +	private static class LifeCycleTestInputFormat extends RichInputFormat&amp;lt;Integer,InputSplit&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		private boolean isConfigured = false;&lt;br/&gt;
    +		private boolean isInputFormatOpen = false;&lt;br/&gt;
    +		private boolean isSplitOpen = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		// end of split&lt;br/&gt;
    +		private boolean eos = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private int splitCounter = 0;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void openInputFormat() &lt;/p&gt;
{
    +			this.isInputFormatOpen = true;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void closeInputFormat() {&lt;br/&gt;
    +			this.isInputFormatOpen = false;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    +1&lt;/p&gt;</comment>
                            <comment id="15331497" author="githubbot" created="Wed, 15 Jun 2016 10:21:02 +0000"  >&lt;p&gt;Github user kl0u commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @fhueske ! I integrated your comments and also updated the &lt;a href=&quot;https://github.com/apache/flink/pull/2020&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2020&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;    Thanks.&lt;/p&gt;</comment>
                            <comment id="15331541" author="githubbot" created="Wed, 15 Jun 2016 11:10:40 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100#discussion_r67142523&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100#discussion_r67142523&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/source/ContinuousFileReaderOperator.java &amp;#8212;&lt;br/&gt;
    @@ -233,10 +236,20 @@ public void run() {&lt;br/&gt;
     				while (this.isRunning) {&lt;/p&gt;

&lt;p&gt;     					synchronized (checkpointLock) {&lt;br/&gt;
    +&lt;br/&gt;
    +						if (!this.isFormatOpen) {&lt;br/&gt;
    +							this.format.openInputFormat();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    if `run()` is only called once, you could move this out of the `while()` loop.&lt;/p&gt;</comment>
                            <comment id="15331544" author="githubbot" created="Wed, 15 Jun 2016 11:13:26 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100#discussion_r67142796&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100#discussion_r67142796&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/source/ContinuousFileReaderOperator.java &amp;#8212;&lt;br/&gt;
    @@ -261,6 +274,10 @@ public void run() {&lt;/p&gt;

&lt;p&gt;     							if (currentSplit.equals(EOS)) {&lt;br/&gt;
     								isRunning = false;&lt;br/&gt;
    +								if (this.isFormatOpen) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    is this necessary? Wouldn&apos;t we directly go into the `finally` clause because of the `break` where the IF is closed anyway?&lt;/p&gt;</comment>
                            <comment id="15331545" author="githubbot" created="Wed, 15 Jun 2016 11:13:34 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100#discussion_r67142811&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100#discussion_r67142811&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/source/ContinuousFileReaderOperator.java &amp;#8212;&lt;br/&gt;
    @@ -233,10 +236,20 @@ public void run() {&lt;br/&gt;
     				while (this.isRunning) {&lt;/p&gt;

&lt;p&gt;     					synchronized (checkpointLock) {&lt;br/&gt;
    +&lt;br/&gt;
    +						if (!this.isFormatOpen) &lt;/p&gt;
{
    +							this.format.openInputFormat();
    +							this.isFormatOpen = true;
    +						}
&lt;p&gt;    +&lt;br/&gt;
     						if (this.currentSplit != null) {&lt;/p&gt;

&lt;p&gt;     							if (currentSplit.equals(EOS)) {&lt;br/&gt;
     								isRunning = false;&lt;br/&gt;
    +								if (this.isFormatOpen) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    is this necessary? Wouldn&apos;t we directly go into the `finally` clause because of the `break` where the IF is closed anyway?&lt;/p&gt;</comment>
                            <comment id="15331563" author="githubbot" created="Wed, 15 Jun 2016 11:32:24 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100#discussion_r67144951&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100#discussion_r67144951&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/InputFormatSourceFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,284 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.ExecutionConfig;&lt;br/&gt;
    +import org.apache.flink.api.common.accumulators.Accumulator;&lt;br/&gt;
    +import org.apache.flink.api.common.io.RichInputFormat;&lt;br/&gt;
    +import org.apache.flink.api.common.io.statistics.BaseStatistics;&lt;br/&gt;
    +import org.apache.flink.api.common.typeinfo.TypeInformation;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplit;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplitAssigner;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.tasks.InputSplitProvider;&lt;br/&gt;
    +import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
    +import org.apache.flink.runtime.operators.testutils.MockEnvironment;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.AbstractStreamOperator;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.StreamingRuntimeContext;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +&lt;br/&gt;
    +public class InputFormatSourceFunctionTest {&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testNormalOp() throws Exception &lt;/p&gt;
{
    +		testFormatLifecycle(false);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelation() throws Exception &lt;/p&gt;
{
    +		testFormatLifecycle(true);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void testFormatLifecycle(final boolean midCancel) throws Exception &lt;/p&gt;
{
    +
    +		final int noOfSplits = 5;
    +		final int cancelAt = 2;
    +
    +		final LifeCycleTestInputFormat format = new LifeCycleTestInputFormat();
    +		final InputFormatSourceFunction&amp;lt;Integer&amp;gt; reader = new InputFormatSourceFunction&amp;lt;&amp;gt;(format, TypeInformation.of(Integer.class));
    +		reader.setRuntimeContext(new MockRuntimeContext(format, noOfSplits));
    +
    +		Assert.assertTrue(!format.isConfigured);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +		Assert.assertTrue(!format.isSplitOpen);
    +
    +		reader.open(new Configuration());
    +		Assert.assertTrue(format.isConfigured);
    +
    +		TestSourceContext ctx = new TestSourceContext(reader, format, midCancel, cancelAt);
    +		reader.run(ctx);
    +
    +		int splitsSeen = ctx.getSplitsSeen();
    +		Assert.assertTrue(midCancel ? splitsSeen == cancelAt : splitsSeen == noOfSplits);
    +
    +		// we have exhausted the splits so the
    +		// format and splits should be closed by now
    +
    +		Assert.assertTrue(!format.isSplitOpen);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +&lt;br/&gt;
    +	private static class LifeCycleTestInputFormat extends RichInputFormat&amp;lt;Integer,InputSplit&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		private boolean isConfigured = false;&lt;br/&gt;
    +		private boolean isInputFormatOpen = false;&lt;br/&gt;
    +		private boolean isSplitOpen = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		// end of split&lt;br/&gt;
    +		private boolean eos = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private int splitCounter = 0;&lt;br/&gt;
    +&lt;br/&gt;
    +		private int reachedEndCalls = 0;&lt;br/&gt;
    +		private int nextRecordCalls = 0;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void openInputFormat() {&lt;br/&gt;
    +			Assert.assertTrue(!isInputFormatOpen);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Assert that IF was configured.&lt;/p&gt;</comment>
                            <comment id="15331564" author="githubbot" created="Wed, 15 Jun 2016 11:32:42 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100#discussion_r67144983&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100#discussion_r67144983&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/test/java/org/apache/flink/streaming/api/functions/source/InputFormatSourceFunctionTest.java &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,284 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements.  See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership.  The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License.  You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    + * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    + * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    + * See the License for the specific language governing permissions and&lt;br/&gt;
    + * limitations under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +package org.apache.flink.streaming.api.functions.source;&lt;br/&gt;
    +&lt;br/&gt;
    +import org.apache.flink.api.common.ExecutionConfig;&lt;br/&gt;
    +import org.apache.flink.api.common.accumulators.Accumulator;&lt;br/&gt;
    +import org.apache.flink.api.common.io.RichInputFormat;&lt;br/&gt;
    +import org.apache.flink.api.common.io.statistics.BaseStatistics;&lt;br/&gt;
    +import org.apache.flink.api.common.typeinfo.TypeInformation;&lt;br/&gt;
    +import org.apache.flink.configuration.Configuration;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplit;&lt;br/&gt;
    +import org.apache.flink.core.io.InputSplitAssigner;&lt;br/&gt;
    +import org.apache.flink.runtime.jobgraph.tasks.InputSplitProvider;&lt;br/&gt;
    +import org.apache.flink.runtime.memory.MemoryManager;&lt;br/&gt;
    +import org.apache.flink.runtime.operators.testutils.MockEnvironment;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.AbstractStreamOperator;&lt;br/&gt;
    +import org.apache.flink.streaming.api.operators.StreamingRuntimeContext;&lt;br/&gt;
    +import org.apache.flink.streaming.api.watermark.Watermark;&lt;br/&gt;
    +import org.junit.Assert;&lt;br/&gt;
    +import org.junit.Test;&lt;br/&gt;
    +&lt;br/&gt;
    +import java.io.IOException;&lt;br/&gt;
    +import java.util.Collections;&lt;br/&gt;
    +&lt;br/&gt;
    +public class InputFormatSourceFunctionTest {&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testNormalOp() throws Exception &lt;/p&gt;
{
    +		testFormatLifecycle(false);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testCancelation() throws Exception &lt;/p&gt;
{
    +		testFormatLifecycle(true);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	private void testFormatLifecycle(final boolean midCancel) throws Exception &lt;/p&gt;
{
    +
    +		final int noOfSplits = 5;
    +		final int cancelAt = 2;
    +
    +		final LifeCycleTestInputFormat format = new LifeCycleTestInputFormat();
    +		final InputFormatSourceFunction&amp;lt;Integer&amp;gt; reader = new InputFormatSourceFunction&amp;lt;&amp;gt;(format, TypeInformation.of(Integer.class));
    +		reader.setRuntimeContext(new MockRuntimeContext(format, noOfSplits));
    +
    +		Assert.assertTrue(!format.isConfigured);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +		Assert.assertTrue(!format.isSplitOpen);
    +
    +		reader.open(new Configuration());
    +		Assert.assertTrue(format.isConfigured);
    +
    +		TestSourceContext ctx = new TestSourceContext(reader, format, midCancel, cancelAt);
    +		reader.run(ctx);
    +
    +		int splitsSeen = ctx.getSplitsSeen();
    +		Assert.assertTrue(midCancel ? splitsSeen == cancelAt : splitsSeen == noOfSplits);
    +
    +		// we have exhausted the splits so the
    +		// format and splits should be closed by now
    +
    +		Assert.assertTrue(!format.isSplitOpen);
    +		Assert.assertTrue(!format.isInputFormatOpen);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +&lt;br/&gt;
    +	private static class LifeCycleTestInputFormat extends RichInputFormat&amp;lt;Integer,InputSplit&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		private boolean isConfigured = false;&lt;br/&gt;
    +		private boolean isInputFormatOpen = false;&lt;br/&gt;
    +		private boolean isSplitOpen = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		// end of split&lt;br/&gt;
    +		private boolean eos = false;&lt;br/&gt;
    +&lt;br/&gt;
    +		private int splitCounter = 0;&lt;br/&gt;
    +&lt;br/&gt;
    +		private int reachedEndCalls = 0;&lt;br/&gt;
    +		private int nextRecordCalls = 0;&lt;br/&gt;
    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void openInputFormat() &lt;/p&gt;
{
    +			Assert.assertTrue(!isInputFormatOpen);
    +			Assert.assertTrue(!isSplitOpen);
    +			this.isInputFormatOpen = true;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void closeInputFormat() &lt;/p&gt;
{
    +			Assert.assertTrue(!isSplitOpen);
    +			this.isInputFormatOpen = false;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public void configure(Configuration parameters) {&lt;br/&gt;
    +			this.isConfigured = true;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Assert that IF was not configured before.&lt;/p&gt;</comment>
                            <comment id="15331565" author="githubbot" created="Wed, 15 Jun 2016 11:33:24 +0000"  >&lt;p&gt;Github user fhueske commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi @kl0u, thanks for the update. I added a few comments. After that the PR should be good. &lt;/p&gt;</comment>
                            <comment id="15331601" author="githubbot" created="Wed, 15 Jun 2016 12:06:27 +0000"  >&lt;p&gt;Github user kl0u commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks @fhueske ! I integrated the comments. &lt;br/&gt;
    Let me know if you have any more.&lt;/p&gt;</comment>
                            <comment id="15331718" author="githubbot" created="Wed, 15 Jun 2016 13:15:06 +0000"  >&lt;p&gt;Github user fhueske commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100#discussion_r67158378&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100#discussion_r67158378&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-streaming-java/src/main/java/org/apache/flink/streaming/api/functions/source/ContinuousFileReaderOperator.java &amp;#8212;&lt;br/&gt;
    @@ -173,6 +175,7 @@ public void close() throws Exception {&lt;br/&gt;
     	private class SplitReader&amp;lt;S extends Serializable, OT&amp;gt; extends Thread {&lt;/p&gt;

&lt;p&gt;     		private volatile boolean isRunning;&lt;br/&gt;
    +		private volatile boolean isFormatOpen = false;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think this flag can be removed.&lt;/p&gt;</comment>
                            <comment id="15331721" author="githubbot" created="Wed, 15 Jun 2016 13:15:54 +0000"  >&lt;p&gt;Github user fhueske commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Good to merge after the `isFormatOpen` flag was removed.&lt;br/&gt;
    Thanks, Fabian&lt;/p&gt;</comment>
                            <comment id="15331741" author="githubbot" created="Wed, 15 Jun 2016 13:26:38 +0000"  >&lt;p&gt;Github user kl0u commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Done! Thanks @fhueske .&lt;br/&gt;
    Kostas&lt;/p&gt;</comment>
                            <comment id="15331750" author="githubbot" created="Wed, 15 Jun 2016 13:29:20 +0000"  >&lt;p&gt;Github user fhueske commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    +1 to merge&lt;/p&gt;</comment>
                            <comment id="15332544" author="githubbot" created="Wed, 15 Jun 2016 20:57:21 +0000"  >&lt;p&gt;Github user fhueske commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Merging&lt;/p&gt;</comment>
                            <comment id="15332547" author="githubbot" created="Wed, 15 Jun 2016 20:58:49 +0000"  >&lt;p&gt;Github user kl0u commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks @fhueske !&lt;/p&gt;</comment>
                            <comment id="15333298" author="githubbot" created="Thu, 16 Jun 2016 07:41:35 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/2100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/2100&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15333302" author="fhueske" created="Thu, 16 Jun 2016 07:44:02 +0000"  >&lt;p&gt;Fixed with fe0eb602d2e908d116d71018bb141e5c748c780b&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 22 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2z03r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>