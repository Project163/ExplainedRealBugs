<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:30:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7400] off-heap limits set to conservatively in cluster environments</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7400</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Inside &lt;tt&gt;ContaineredTaskManagerParameters&lt;/tt&gt;, since &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6217&quot; title=&quot;ContaineredTaskManagerParameters sets off heap memory size incorrectly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6217&quot;&gt;&lt;del&gt;FLINK-6217&lt;/del&gt;&lt;/a&gt;, the &lt;tt&gt;offHeapSize&lt;/tt&gt; is set to the amount of memory Flink will use off-heap which will be set as the value for &lt;tt&gt;-XX:MaxDirectMemorySize&lt;/tt&gt; in various cases. This does not account for any off-heap use by other components than Flink, e.g. RocksDB, other libraries, or the JVM itself.&lt;/p&gt;

&lt;p&gt;We should add the &lt;tt&gt;cutoff&lt;/tt&gt; from the &lt;tt&gt;CONTAINERIZED_HEAP_CUTOFF_RATIO&lt;/tt&gt; configuration parameter to &lt;tt&gt;offHeapSize&lt;/tt&gt; as implied by the description on what this parameter is there for.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13093489">FLINK-7400</key>
            <summary>off-heap limits set to conservatively in cluster environments</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nkruber">Nico Kruber</assignee>
                                    <reporter username="nkruber">Nico Kruber</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Aug 2017 13:59:06 +0000</created>
                <updated>Thu, 28 Feb 2019 14:12:47 +0000</updated>
                            <resolved>Wed, 1 Nov 2017 12:12:29 +0000</resolved>
                                    <version>1.3.0</version>
                    <version>1.3.1</version>
                    <version>1.3.2</version>
                    <version>1.4.0</version>
                                    <fixVersion>1.4.0</fixVersion>
                                    <component>Deployment / Mesos</component>
                    <component>Deployment / YARN</component>
                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16119970" author="nicok" created="Wed, 9 Aug 2017 14:22:21 +0000"  >&lt;p&gt;Please note that this affects (at least) all (batch) programs with the following options set (which do not make much sense for streaming):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;taskmanager.memory.off-heap=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
taskmanager.memory.size=&amp;lt;any value&amp;gt;
taskmanager.memory.preallocate=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If, instead, &lt;tt&gt;taskmanager.memory.fraction&lt;/tt&gt; is used, programs may be safe due to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7401&quot; title=&quot;EnvironmentInformation.getMaxJvmHeapMemory does not return the value given via -Xmx&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7401&quot;&gt;FLINK-7401&lt;/a&gt; but the actual additional buffer that we get from that may be too small, especially if RocksDB or other libraries using off-heap memory are used.&lt;/p&gt;</comment>
                            <comment id="16120012" author="githubbot" created="Wed, 9 Aug 2017 14:39:11 +0000"  >&lt;p&gt;GitHub user NicoK opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4506&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7400&quot; title=&quot;off-heap limits set to conservatively in cluster environments&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7400&quot;&gt;&lt;del&gt;FLINK-7400&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;cluster&amp;#93;&lt;/span&gt; fix off-heap limits set to conservatively in cluster environments&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Inside `ContaineredTaskManagerParameters`, since #3648, the `offHeapSize` is set to the amount of memory Flink will use off-heap which will be set as the value for `-XX:MaxDirectMemorySize` in various cases, e.g. YARN or Mesos. This does not account for any off-heap use by other components than Flink, e.g. RocksDB, other libraries, or the JVM itself.&lt;/p&gt;

&lt;p&gt;    Please note that this affects at least all batch programs with the following options set (which do not make much sense for streaming):&lt;br/&gt;
    ```&lt;br/&gt;
    taskmanager.memory.off-heap=true&lt;br/&gt;
    taskmanager.memory.size=&amp;lt;any value&amp;gt;&lt;br/&gt;
    taskmanager.memory.preallocate=true&lt;br/&gt;
    ```&lt;br/&gt;
    If, instead, `taskmanager.memory.fraction` is used, programs may be safe due to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7401&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-7401&lt;/a&gt; but the actual additional buffer that we get from that may be too small, especially if RocksDB or other libraries using off-heap memory are used.&lt;/p&gt;

&lt;p&gt;    This PR adds the `cutoff` from the `containerized.heap-cutoff-ratio`/`containerized.heap-cutoff-min` configuration parameters to `offHeapSize` as implied by the description of these two options.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;include the cut-off memory (removed from the container memory size for further calculations) into the off-heap part&lt;/li&gt;
	&lt;li&gt;add a unit test verifying the bug fix in a YARN environment&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This change added tests and can be verified as follows:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;added `YARNSessionCapacitySchedulerITCase#perJobYarnClusterOffHeap()` test that validates that we have enough memory available and the bounds are not too strict&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes: memory calculations)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (JavaDocs)&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/NicoK/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/NicoK/flink&lt;/a&gt; flink-7400&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4506.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4506.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4506&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 60d40cde20686b4b1b2d15dc838b15ed0cd994cc&lt;br/&gt;
Author: Nico Kruber &amp;lt;nico@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-08-09T09:53:03Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7400&quot; title=&quot;off-heap limits set to conservatively in cluster environments&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7400&quot;&gt;&lt;del&gt;FLINK-7400&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;cluster&amp;#93;&lt;/span&gt; fix cut-off memory not used for off-heap reserve as intended&lt;/p&gt;

&lt;p&gt;    + fix description of `containerized.heap-cutoff-ratio`&lt;/p&gt;

&lt;p&gt;commit 4135a223288608444d324da333cfdd70117c796d&lt;br/&gt;
Author: Nico Kruber &amp;lt;nico@data-artisans.com&amp;gt;&lt;br/&gt;
Date:   2017-08-09T14:16:31Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7400&quot; title=&quot;off-heap limits set to conservatively in cluster environments&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7400&quot;&gt;&lt;del&gt;FLINK-7400&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;yarn&amp;#93;&lt;/span&gt; add an integration test for yarn container memory restrictions using off-heap memory&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16182543" author="githubbot" created="Wed, 27 Sep 2017 13:18:23 +0000"  >&lt;p&gt;Github user NicoK commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4506&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @tillrohrmann can you have a look at this?&lt;/p&gt;</comment>
                            <comment id="16216584" author="githubbot" created="Tue, 24 Oct 2017 09:14:06 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4506#discussion_r146479686&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4506#discussion_r146479686&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn-tests/src/test/java/org/apache/flink/yarn/YARNSessionCapacitySchedulerITCase.java &amp;#8212;&lt;br/&gt;
    @@ -132,6 +132,36 @@ public void perJobYarnCluster() {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	/**&lt;br/&gt;
    +	 * Test per-job yarn cluster and memory calculations for off-heap use (see &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7400&quot; title=&quot;off-heap limits set to conservatively in cluster environments&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7400&quot;&gt;&lt;del&gt;FLINK-7400&lt;/del&gt;&lt;/a&gt;).&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;This also tests the prefixed CliFrontend options for the YARN case&lt;br/&gt;
    +	 * We also test if the requested parallelism of 2 is passed through.&lt;br/&gt;
    +	 * The parallelism is requested at the YARN client (-ys).&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void perJobYarnClusterOffHeap() {&lt;br/&gt;
    +		LOG.info(&quot;Starting perJobYarnCluster()&quot;);&lt;br/&gt;
    +		addTestAppender(JobClient.class, Level.INFO);&lt;br/&gt;
    +		File exampleJarLocation = new File(&quot;target/programs/BatchWordCount.jar&quot;);&lt;br/&gt;
    +		Assert.assertNotNull(&quot;Could not find wordcount jar&quot;, exampleJarLocation);&lt;br/&gt;
    +		runWithArgs(new String[]{&quot;run&quot;, &quot;-m&quot;, &quot;yarn-cluster&quot;,&lt;br/&gt;
    +				&quot;-yj&quot;, flinkUberjar.getAbsolutePath(), &quot;-yt&quot;, flinkLibFolder.getAbsolutePath(),&lt;br/&gt;
    +				&quot;-yn&quot;, &quot;1&quot;,&lt;br/&gt;
    +				&quot;-ys&quot;, &quot;2&quot;, //test that the job is executed with a DOP of 2&lt;br/&gt;
    +				&quot;-yjm&quot;, &quot;768&quot;,&lt;br/&gt;
    +				&quot;-ytm&quot;, &quot;1024&quot;,&lt;br/&gt;
    +				&quot;-yD&quot;, &quot;taskmanager.memory.off-heap=true&quot;,&lt;br/&gt;
    +				&quot;-yD&quot;, &quot;taskmanager.memory.size=246&quot;, // this should fit!&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Could you add some explanation why this fits now and not before?&lt;/p&gt;</comment>
                            <comment id="16216585" author="githubbot" created="Tue, 24 Oct 2017 09:14:06 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4506#discussion_r146479627&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4506#discussion_r146479627&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn-tests/src/test/java/org/apache/flink/yarn/YARNSessionCapacitySchedulerITCase.java &amp;#8212;&lt;br/&gt;
    @@ -132,6 +132,36 @@ public void perJobYarnCluster() {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	/**&lt;br/&gt;
    +	 * Test per-job yarn cluster and memory calculations for off-heap use (see &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7400&quot; title=&quot;off-heap limits set to conservatively in cluster environments&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7400&quot;&gt;&lt;del&gt;FLINK-7400&lt;/del&gt;&lt;/a&gt;).&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;This also tests the prefixed CliFrontend options for the YARN case&lt;br/&gt;
    +	 * We also test if the requested parallelism of 2 is passed through.&lt;br/&gt;
    +	 * The parallelism is requested at the YARN client (-ys).&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void perJobYarnClusterOffHeap() {&lt;br/&gt;
    +		LOG.info(&quot;Starting perJobYarnCluster()&quot;);&lt;br/&gt;
    +		addTestAppender(JobClient.class, Level.INFO);&lt;br/&gt;
    +		File exampleJarLocation = new File(&quot;target/programs/BatchWordCount.jar&quot;);&lt;br/&gt;
    +		Assert.assertNotNull(&quot;Could not find wordcount jar&quot;, exampleJarLocation);&lt;br/&gt;
    +		runWithArgs(new String[]&lt;/p&gt;
{&quot;run&quot;, &quot;-m&quot;, &quot;yarn-cluster&quot;,
    +				&quot;-yj&quot;, flinkUberjar.getAbsolutePath(), &quot;-yt&quot;, flinkLibFolder.getAbsolutePath(),
    +				&quot;-yn&quot;, &quot;1&quot;,
    +				&quot;-ys&quot;, &quot;2&quot;, //test that the job is executed with a DOP of 2
    +				&quot;-yjm&quot;, &quot;768&quot;,
    +				&quot;-ytm&quot;, &quot;1024&quot;,
    +				&quot;-yD&quot;, &quot;taskmanager.memory.off-heap=true&quot;,
    +				&quot;-yD&quot;, &quot;taskmanager.memory.size=246&quot;, // this should fit!
    +				&quot;-yD&quot;, &quot;taskmanager.memory.preallocate=true&quot;, exampleJarLocation.getAbsolutePath()}
&lt;p&gt;,&lt;br/&gt;
    +				/* test succeeded after this string */&lt;br/&gt;
    +			&quot;Job execution complete&quot;,&lt;br/&gt;
    +			/* prohibited strings: (we want to see &quot;DataSink (...) (2/2) switched to FINISHED&quot;) */&lt;br/&gt;
    +			new String[]&lt;/p&gt;
{&quot;DataSink \\(.*\\) \\(1/1\\) switched to FINISHED&quot;}
&lt;p&gt;,&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    The comment above says something different than this line `(1/1)` vs. `(2/2)`&lt;/p&gt;</comment>
                            <comment id="16216586" author="githubbot" created="Tue, 24 Oct 2017 09:14:07 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4506#discussion_r146498833&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4506#discussion_r146498833&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/clusterframework/ContaineredTaskManagerParameters.java &amp;#8212;&lt;br/&gt;
    @@ -143,7 +143,8 @@ public static ContaineredTaskManagerParameters create(&lt;/p&gt;

&lt;p&gt;     		// (2) split the remaining Java memory between heap and off-heap&lt;br/&gt;
     		final long heapSizeMB = TaskManagerServices.calculateHeapSizeMB(javaMemorySizeMB, config);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final long offHeapSize = javaMemorySizeMB == heapSizeMB ? -1L : javaMemorySizeMB - heapSizeMB;&lt;br/&gt;
    +		// use the cut-off memory for off-heap (that was its intention)&lt;br/&gt;
    +		final long offHeapSize = javaMemorySizeMB == heapSizeMB ? -1L : containerMemoryMB - heapSizeMB;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Do I understand it correctly that with this change, we basically add the safety margin (cut-off) to the amount of direct memory?&lt;/p&gt;</comment>
                            <comment id="16224575" author="githubbot" created="Mon, 30 Oct 2017 09:53:58 +0000"  >&lt;p&gt;Github user NicoK commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4506#discussion_r147656471&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4506#discussion_r147656471&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/clusterframework/ContaineredTaskManagerParameters.java &amp;#8212;&lt;br/&gt;
    @@ -143,7 +143,8 @@ public static ContaineredTaskManagerParameters create(&lt;/p&gt;

&lt;p&gt;     		// (2) split the remaining Java memory between heap and off-heap&lt;br/&gt;
     		final long heapSizeMB = TaskManagerServices.calculateHeapSizeMB(javaMemorySizeMB, config);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final long offHeapSize = javaMemorySizeMB == heapSizeMB ? -1L : javaMemorySizeMB - heapSizeMB;&lt;br/&gt;
    +		// use the cut-off memory for off-heap (that was its intention)&lt;br/&gt;
    +		final long offHeapSize = javaMemorySizeMB == heapSizeMB ? -1L : containerMemoryMB - heapSizeMB;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    yes and as far as I can tell, this was its original intention&lt;/p&gt;</comment>
                            <comment id="16224582" author="githubbot" created="Mon, 30 Oct 2017 10:00:31 +0000"  >&lt;p&gt;Github user NicoK commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4506#discussion_r147657947&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4506#discussion_r147657947&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn-tests/src/test/java/org/apache/flink/yarn/YARNSessionCapacitySchedulerITCase.java &amp;#8212;&lt;br/&gt;
    @@ -132,6 +132,36 @@ public void perJobYarnCluster() {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	/**&lt;br/&gt;
    +	 * Test per-job yarn cluster and memory calculations for off-heap use (see &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7400&quot; title=&quot;off-heap limits set to conservatively in cluster environments&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7400&quot;&gt;&lt;del&gt;FLINK-7400&lt;/del&gt;&lt;/a&gt;).&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * &amp;lt;p&amp;gt;This also tests the prefixed CliFrontend options for the YARN case&lt;br/&gt;
    +	 * We also test if the requested parallelism of 2 is passed through.&lt;br/&gt;
    +	 * The parallelism is requested at the YARN client (-ys).&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void perJobYarnClusterOffHeap() {&lt;br/&gt;
    +		LOG.info(&quot;Starting perJobYarnCluster()&quot;);&lt;br/&gt;
    +		addTestAppender(JobClient.class, Level.INFO);&lt;br/&gt;
    +		File exampleJarLocation = new File(&quot;target/programs/BatchWordCount.jar&quot;);&lt;br/&gt;
    +		Assert.assertNotNull(&quot;Could not find wordcount jar&quot;, exampleJarLocation);&lt;br/&gt;
    +		runWithArgs(new String[]&lt;/p&gt;
{&quot;run&quot;, &quot;-m&quot;, &quot;yarn-cluster&quot;,
    +				&quot;-yj&quot;, flinkUberjar.getAbsolutePath(), &quot;-yt&quot;, flinkLibFolder.getAbsolutePath(),
    +				&quot;-yn&quot;, &quot;1&quot;,
    +				&quot;-ys&quot;, &quot;2&quot;, //test that the job is executed with a DOP of 2
    +				&quot;-yjm&quot;, &quot;768&quot;,
    +				&quot;-ytm&quot;, &quot;1024&quot;,
    +				&quot;-yD&quot;, &quot;taskmanager.memory.off-heap=true&quot;,
    +				&quot;-yD&quot;, &quot;taskmanager.memory.size=246&quot;, // this should fit!
    +				&quot;-yD&quot;, &quot;taskmanager.memory.preallocate=true&quot;, exampleJarLocation.getAbsolutePath()}
&lt;p&gt;,&lt;br/&gt;
    +				/* test succeeded after this string */&lt;br/&gt;
    +			&quot;Job execution complete&quot;,&lt;br/&gt;
    +			/* prohibited strings: (we want to see &quot;DataSink (...) (2/2) switched to FINISHED&quot;) */&lt;br/&gt;
    +			new String[]&lt;/p&gt;
{&quot;DataSink \\(.*\\) \\(1/1\\) switched to FINISHED&quot;}
&lt;p&gt;,&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    that was copied from the `perJobYarnCluster()` test this is based on and from my interpretation, I&apos;d say, &quot;`(1/1)` is prohibited but we should see `(2/2)`&quot; is the correct way of interpreting this comment&lt;/p&gt;</comment>
                            <comment id="16224857" author="githubbot" created="Mon, 30 Oct 2017 12:46:05 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4506&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks. Let me know once you&apos;ve run the cluster tests @NicoK. Then I&apos;ll try to merge the PR.&lt;/p&gt;</comment>
                            <comment id="16225080" author="githubbot" created="Mon, 30 Oct 2017 15:02:02 +0000"  >&lt;p&gt;Github user NicoK commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4506&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I just tested this on a real yarn cluster with `./bin/flink run -m yarn-cluster -yn 1 -ys 2 -yjm 768 -ytm 1024 -yD taskmanager.memory.off-heap=true -yD taskmanager.memory.size=260 -yD taskmanager.memory.preallocate=true ./examples/batch/WordCount.jar` (the equivalent of the test) and verified that it was failing on Flink 1.3.2 but working with the proposed fix.&lt;/p&gt;

&lt;p&gt;    I also tested the counterpart without the three memory options, i.e. `./bin/flink run -m yarn-cluster -yn 1 -ys 2 -yjm 768 -ytm 1024 ./examples/batch/WordCount.jar` and verified it is working with the PR changes&lt;/p&gt;</comment>
                            <comment id="16233796" author="githubbot" created="Wed, 1 Nov 2017 08:53:39 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4506&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for running the test @NicoK. Could you please rebase this PR onto the latest master. Once Travis passes all tests, I&apos;ll merge this PR then.&lt;/p&gt;</comment>
                            <comment id="16233813" author="githubbot" created="Wed, 1 Nov 2017 09:12:34 +0000"  >&lt;p&gt;Github user NicoK commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4506&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    rebased successfully, waiting for Travis now...&lt;/p&gt;</comment>
                            <comment id="16233986" author="githubbot" created="Wed, 1 Nov 2017 12:09:58 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4506&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Travis passed and changes look good to me. Merging this PR.&lt;/p&gt;</comment>
                            <comment id="16233990" author="till.rohrmann" created="Wed, 1 Nov 2017 12:12:29 +0000"  >&lt;p&gt;Fixed via 0df8e0797459ef9e8dfa177920def08bc2f11d65&lt;/p&gt;</comment>
                            <comment id="16233992" author="githubbot" created="Wed, 1 Nov 2017 12:13:27 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4506&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13091202">FLINK-7316</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 2 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ilfz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>