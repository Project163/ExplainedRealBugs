<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:47:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-18137] JobMasterTriggerSavepointITCase.testStopJobAfterSavepoint fails with AskTimeoutException</title>
                <link>https://issues.apache.org/jira/browse/FLINK-18137</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=2747&amp;amp;view=logs&amp;amp;j=5c8e7682-d68f-54d1-16a2-a09310218a49&amp;amp;t=45cc9205-bdb7-5b54-63cd-89fdc0983323&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=2747&amp;amp;view=logs&amp;amp;j=5c8e7682-d68f-54d1-16a2-a09310218a49&amp;amp;t=45cc9205-bdb7-5b54-63cd-89fdc0983323&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-06-04T16:17:20.4404189Z [ERROR] Tests run: 4, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 14.352 s &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.flink.runtime.jobmaster.JobMasterTriggerSavepointITCase
2020-06-04T16:17:20.4405548Z [ERROR] testStopJobAfterSavepoint(org.apache.flink.runtime.jobmaster.JobMasterTriggerSavepointITCase)  Time elapsed: 10.058 s  &amp;lt;&amp;lt;&amp;lt; ERROR!
2020-06-04T16:17:20.4407342Z java.util.concurrent.ExecutionException: java.util.concurrent.TimeoutException: Invocation of &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; java.util.concurrent.CompletableFuture org.apache.flink.runtime.webmonitor.RestfulGateway.triggerSavepoint(org.apache.flink.api.common.JobID,java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;,org.apache.flink.api.common.time.Time) timed out.
2020-06-04T16:17:20.4409562Z 	at java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:357)
2020-06-04T16:17:20.4410333Z 	at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1908)
2020-06-04T16:17:20.4411259Z 	at org.apache.flink.runtime.jobmaster.JobMasterTriggerSavepointITCase.cancelWithSavepoint(JobMasterTriggerSavepointITCase.java:264)
2020-06-04T16:17:20.4412292Z 	at org.apache.flink.runtime.jobmaster.JobMasterTriggerSavepointITCase.testStopJobAfterSavepoint(JobMasterTriggerSavepointITCase.java:127)
2020-06-04T16:17:20.4413163Z 	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
2020-06-04T16:17:20.4413990Z 	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
2020-06-04T16:17:20.4414783Z 	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
2020-06-04T16:17:20.4415936Z 	at java.lang.reflect.Method.invoke(Method.java:498)
2020-06-04T16:17:20.4416693Z 	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)
2020-06-04T16:17:20.4417632Z 	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
2020-06-04T16:17:20.4418637Z 	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)
2020-06-04T16:17:20.4419367Z 	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
2020-06-04T16:17:20.4420118Z 	at org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:48)
2020-06-04T16:17:20.4420742Z 	at org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)
2020-06-04T16:17:20.4421909Z 	at org.junit.rules.RunRules.evaluate(RunRules.java:20)
2020-06-04T16:17:20.4422493Z 	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)
2020-06-04T16:17:20.4423247Z 	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)
2020-06-04T16:17:20.4424263Z 	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)
2020-06-04T16:17:20.4424876Z 	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
2020-06-04T16:17:20.4426346Z 	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
2020-06-04T16:17:20.4427052Z 	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
2020-06-04T16:17:20.4427772Z 	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
2020-06-04T16:17:20.4428562Z 	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
2020-06-04T16:17:20.4429158Z 	at org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:48)
2020-06-04T16:17:20.4429861Z 	at org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:48)
2020-06-04T16:17:20.4430448Z 	at org.junit.rules.RunRules.evaluate(RunRules.java:20)
2020-06-04T16:17:20.4431060Z 	at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
2020-06-04T16:17:20.4431678Z 	at org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:365)
2020-06-04T16:17:20.4432513Z 	at org.apache.maven.surefire.junit4.JUnit4Provider.executeWithRerun(JUnit4Provider.java:273)
2020-06-04T16:17:20.4433396Z 	at org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:238)
2020-06-04T16:17:20.4434298Z 	at org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:159)
2020-06-04T16:17:20.4440904Z 	at org.apache.maven.surefire.booter.ForkedBooter.invokeProviderInSameClassLoader(ForkedBooter.java:384)
2020-06-04T16:17:20.4443425Z 	at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:345)
2020-06-04T16:17:20.4444349Z 	at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:126)
2020-06-04T16:17:20.4445160Z 	at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:418)
2020-06-04T16:17:20.4446389Z Caused by: java.util.concurrent.TimeoutException: Invocation of &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; java.util.concurrent.CompletableFuture org.apache.flink.runtime.webmonitor.RestfulGateway.triggerSavepoint(org.apache.flink.api.common.JobID,java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;,org.apache.flink.api.common.time.Time) timed out.
2020-06-04T16:17:20.4447610Z 	at com.sun.proxy.$Proxy31.triggerSavepoint(Unknown Source)
2020-06-04T16:17:20.4448545Z 	at org.apache.flink.runtime.minicluster.MiniCluster.lambda$triggerSavepoint$8(MiniCluster.java:595)
2020-06-04T16:17:20.4449259Z 	at java.util.concurrent.CompletableFuture.uniApply(CompletableFuture.java:616)
2020-06-04T16:17:20.4449990Z 	at java.util.concurrent.CompletableFuture.uniApplyStage(CompletableFuture.java:628)
2020-06-04T16:17:20.4450789Z 	at java.util.concurrent.CompletableFuture.thenApply(CompletableFuture.java:1996)
2020-06-04T16:17:20.4451584Z 	at org.apache.flink.runtime.minicluster.MiniCluster.runDispatcherCommand(MiniCluster.java:621)
2020-06-04T16:17:20.4452473Z 	at org.apache.flink.runtime.minicluster.MiniCluster.triggerSavepoint(MiniCluster.java:595)
2020-06-04T16:17:20.4453572Z 	at org.apache.flink.client.program.MiniClusterClient.cancelWithSavepoint(MiniClusterClient.java:89)
2020-06-04T16:17:20.4454746Z 	at org.apache.flink.runtime.jobmaster.JobMasterTriggerSavepointITCase.cancelWithSavepoint(JobMasterTriggerSavepointITCase.java:262)
2020-06-04T16:17:20.4455517Z 	... 32 more
2020-06-04T16:17:20.4457589Z Caused by: akka.pattern.AskTimeoutException: Ask timed out on [Actor[akka:&lt;span class=&quot;code-comment&quot;&gt;//flink/user/rpc/dispatcher_2#830345697]] after [10000 ms]. Message of type [org.apache.flink.runtime.rpc.messages.LocalFencedMessage]. A typical reason &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; `AskTimeoutException` is that the recipient actor didn&apos;t send a reply.
&lt;/span&gt;2020-06-04T16:17:20.4459164Z 	at akka.pattern.PromiseActorRef$$anonfun$2.apply(AskSupport.scala:635)
2020-06-04T16:17:20.4460107Z 	at akka.pattern.PromiseActorRef$$anonfun$2.apply(AskSupport.scala:635)
2020-06-04T16:17:20.4460819Z 	at akka.pattern.PromiseActorRef$$anonfun$1.apply$mcV$sp(AskSupport.scala:648)
2020-06-04T16:17:20.4461613Z 	at akka.actor.Scheduler$$anon$4.run(Scheduler.scala:205)
2020-06-04T16:17:20.4462444Z 	at scala.concurrent.Future$InternalCallbackExecutor$.unbatchedExecute(Future.scala:601)
2020-06-04T16:17:20.4463203Z 	at scala.concurrent.BatchingExecutor$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;execute(BatchingExecutor.scala:109)
2020-06-04T16:17:20.4464089Z 	at scala.concurrent.Future$InternalCallbackExecutor$.execute(Future.scala:599)
2020-06-04T16:17:20.4464833Z 	at akka.actor.LightArrayRevolverScheduler$TaskHolder.executeTask(LightArrayRevolverScheduler.scala:328)
2020-06-04T16:17:20.4465800Z 	at akka.actor.LightArrayRevolverScheduler$$anon$4.executeBucket$1(LightArrayRevolverScheduler.scala:279)
2020-06-04T16:17:20.4466746Z 	at akka.actor.LightArrayRevolverScheduler$$anon$4.nextTick(LightArrayRevolverScheduler.scala:283)
2020-06-04T16:17:20.4467579Z 	at akka.actor.LightArrayRevolverScheduler$$anon$4.run(LightArrayRevolverScheduler.scala:235)
2020-06-04T16:17:20.4468467Z 	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13309497">FLINK-18137</key>
            <summary>JobMasterTriggerSavepointITCase.testStopJobAfterSavepoint fails with AskTimeoutException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="rmetzger">Robert Metzger</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Thu, 4 Jun 2020 17:28:07 +0000</created>
                <updated>Mon, 15 Jun 2020 09:09:34 +0000</updated>
                            <resolved>Fri, 12 Jun 2020 13:48:32 +0000</resolved>
                                    <version>1.11.0</version>
                    <version>1.12.0</version>
                                    <fixVersion>1.11.0</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                    <component>Runtime / Coordination</component>
                    <component>Runtime / Task</component>
                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17126658" author="zentol" created="Fri, 5 Jun 2020 10:48:06 +0000"  >&lt;p&gt;Likely closely related to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-18138&quot; title=&quot;KeyedComplexChainTest.testMigrationAndRestore fails with AskTimeoutException on CI&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-18138&quot;&gt;&lt;del&gt;FLINK-18138&lt;/del&gt;&lt;/a&gt; since they both timeout on triggering a savepoint.&lt;/p&gt;</comment>
                            <comment id="17127928" author="rmetzger" created="Mon, 8 Jun 2020 06:31:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=2852&amp;amp;view=logs&amp;amp;j=119bbba7-f5e3-5e08-e72d-09f1529665de&amp;amp;t=7dc1f5a9-54e1-502e-8b02-c7df69073cfc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=2852&amp;amp;view=logs&amp;amp;j=119bbba7-f5e3-5e08-e72d-09f1529665de&amp;amp;t=7dc1f5a9-54e1-502e-8b02-c7df69073cfc&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17130493" author="rmetzger" created="Wed, 10 Jun 2020 10:34:31 +0000"  >&lt;p&gt;And &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-18148&quot; title=&quot;&amp;quot;Resuming Savepoint&amp;quot; e2e fails with TimeoutException in CliFrontend.stop() &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-18148&quot;&gt;&lt;del&gt;FLINK-18148&lt;/del&gt;&lt;/a&gt; is also a savepoint trigger related issue.&lt;/p&gt;</comment>
                            <comment id="17130664" author="rmetzger" created="Wed, 10 Jun 2020 13:11:25 +0000"  >&lt;p&gt;(debugging the run mentioned in the comments ... )&lt;br/&gt;
Timeout is configured to akka.ask.timeout = 10s (default of Minicluster)&lt;/p&gt;

&lt;p&gt;It seems that the checkpoint gets triggered &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
21:35:46,509 [    Checkpoint Timer] INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Triggering checkpoint 1 @ 1591392946509 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job c671d421389fe49b8d86e40fce074a10.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But that&apos;s the last message regarding this checkpoint, job or the test vertex. There are a lot of other checkpoints being triggered from other tests though.&lt;/p&gt;

&lt;p&gt;(The failure in the ticket description run looks exactly the same)&lt;/p&gt;</comment>
                            <comment id="17132971" author="rmetzger" created="Thu, 11 Jun 2020 06:54:43 +0000"  >&lt;p&gt;The error is somewhat reproducible locally, BUT not when running the test until failure.&lt;br/&gt;
Only when starting it from scratch.&lt;/p&gt;

&lt;p&gt;It seems that the test is passing when the savepoint is triggered right after the vertex switches to RUNNING (my logs distinguish between SAVEPOINT and CHECKPOINT): &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
3431 [testVertex (1/1)] INFO  org.apache.flink.runtime.taskmanager.Task [] - testVertex (1/1) (40dd161a086ef633b70d9f505ba614c6) switched from DEPLOYING to RUNNING.
3432 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-5] INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph [] - testVertex (1/1) (40dd161a086ef633b70d9f505ba614c6) switched from DEPLOYING to RUNNING.
3496 [Checkpoint Timer] INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator [] - Triggering SAVEPOINT 2 @ 1591798767033 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job f51485b0d91e3ff6be1d7a55d78c57d7.
3499 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-3] DEBUG org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Trigger checkpoint 2@1591798767033 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 40dd161a086ef633b70d9f505ba614c6.
3504 [jobmanager-&lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;-thread-3] DEBUG org.apache.flink.runtime.checkpoint.CheckpointCoordinator [] - Received acknowledge message &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; checkpoint 2 from task 40dd161a086ef633b70d9f505ba614c6 of job f51485b0d91e3ff6be1d7a55d78c57d7 at 3ddadd8d-c5f3-495e-9c9c-b9278100c72a @ localhost (dataPort=-1).
3522 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-2] INFO  org.apache.flink.runtime.jobmaster.JobMaster [] - Savepoint stored in file:/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/folders/js/yfk_y2450q7559kygttykwk00000gn/T/junit3940216507898676469/junit3659258369742740599/savepoint-f51485-2066a260a0e0. Now cancelling f51485b0d91e3ff6be1d7a55d78c57d7.
3523 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-2] INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph [] - Job (unnamed job) (f51485b0d91e3ff6be1d7a55d78c57d7) switched from state RUNNING to CANCELLING.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, if the Checkpoint Timer manages to trigger a checkpoint in between, then the test is failing.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
3585 [Checkpoint Timer] INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator [] - Triggering CHECKPOINT 1 @ 1591797060672 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job c5388d02ac93d92790e7a43b0b9f8c08.
3589 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-4] DEBUG org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Abort checkpoint 1@1591797060672 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 4174621aed015dd50b4ec8a204ba8724.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What I believe is happening:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;C1: Checkpoint 1 gets triggered, sets CheckpointCoordinator.isTriggering flag to &quot;true&quot;&lt;/li&gt;
	&lt;li&gt;S1: triggerSavepoint call comes in&lt;/li&gt;
	&lt;li&gt;S1: SchedulerBase.triggerSavepoint(SchedulerBase.java:751) calls checkpointCoordinator.stopCheckpointScheduler() and cancels all pending checkpoints, in this case Checkpoint 1.&lt;/li&gt;
	&lt;li&gt;S1: SchedulerBase.triggerSavepoint(SchedulerBase.java:751) now is triggering a checkpoint at the Coordinator, however, the CheckpointRequestDecider decides to not execute any CheckpointTriggerRequest, because isTriggering = true.&lt;/li&gt;
	&lt;li&gt;the system never returns anything on the SchedulerBase.triggerSavepoint call (because the case that the decider opts for &quot;nothing&quot; is not handled here: &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java#L501&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java#L501&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Solutions:&lt;br/&gt;
a) set isTriggering to &quot;false&quot; when aborting pending checkpoints&lt;br/&gt;
b) only modify isTriggering under the CheckpointCoordinator.lock (the checkpoint triggering is not happening under the lock)&lt;/p&gt;

&lt;p&gt;I would appreciate if somebody who knows this component better could validate my analysis and suggest how to resolve the problem.&lt;/p&gt;</comment>
                            <comment id="17133067" author="roman_khachatryan" created="Thu, 11 Jun 2020 08:57:23 +0000"  >&lt;p&gt;From the code, the isTriggering should be set to false regardless of whether the checkpoint is aborted:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;if startTriggeringCheckpoint() fail &quot;synchronously&quot; then failure is caught in the end and onTriggerFailure() is called&lt;/li&gt;
	&lt;li&gt;if&#160;Future&amp;lt;PendingCheckpoint&amp;gt; fails &quot;asynchronously&quot; then&#160;whenCompleteAsync handles it&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17133143" author="rmetzger" created="Thu, 11 Jun 2020 10:41:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; told me offline that he has found the issue. I&apos;ll assign him to the ticket.&lt;/p&gt;</comment>
                            <comment id="17133144" author="roman_khachatryan" created="Thu, 11 Jun 2020 10:51:34 +0000"  >&lt;p&gt;I think there are several issues that can this problem by not completing masterStateCompletableFuture:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;del&gt;masterHooks is empty&lt;/del&gt;&lt;/li&gt;
	&lt;li&gt;checkpoint is discarded (aborted) - line 690 throws an exception instead of completing the future&lt;/li&gt;
	&lt;li&gt;checkpoint is discarded (aborted) - line 696 doesn&apos;t complete the future even if everything is acked (what&#160; has&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;&#160;found)&lt;/li&gt;
	&lt;li&gt;CompletableFuture.allOf waits for both masterStates and coordinatorCheckpoints futures while it could &quot;return&quot; as soon as one fails&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;br/&gt;
Edit:&lt;br/&gt;
I&apos;ve created a separate ticket for the issues above:&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-18257&quot; title=&quot;MasterStateSnapshot future may not be completed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-18257&quot;&gt;&lt;del&gt;FLINK-18257&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17133222" author="till.rohrmann" created="Thu, 11 Jun 2020 12:25:50 +0000"  >&lt;p&gt;The problem seems to be that we call &lt;tt&gt;onTriggerFailure&lt;/tt&gt; with a &lt;tt&gt;null&lt;/tt&gt; value &lt;tt&gt;Throwable&lt;/tt&gt; if the &lt;tt&gt;PendingCheckpoint&lt;/tt&gt; has been discarded: &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java#L564&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java#L564&lt;/a&gt;. Due to &lt;a href=&quot;https://github.com/apache/flink/commit/1af33f1285d557f0171f4587d7f4e789df27e7cb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/1af33f1285d557f0171f4587d7f4e789df27e7cb&lt;/a&gt; &lt;tt&gt;onTriggerFailure&lt;/tt&gt; will fail with a &lt;tt&gt;NullPointerException&lt;/tt&gt;. This exception will then be swallowed by the &lt;tt&gt;CompletableFuture&lt;/tt&gt; returned by the &lt;tt&gt;whenCompleteAsync&lt;/tt&gt; call &lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java#L542&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java#L542&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17133337" author="sleepy" created="Thu, 11 Jun 2020 15:30:27 +0000"  >&lt;p&gt;I just saw this issue. I think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; is&#160;right.&lt;br/&gt;
There is a problem of if/else in&#160;&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java#L547&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/CheckpointCoordinator.java#L547&lt;/a&gt;. The &lt;tt&gt;throwable&lt;/tt&gt; passed to &lt;tt&gt;onTriggerFailure&lt;/tt&gt; can be null unexpectedly. Actually that&apos;s my fault, this code is written by me and I realized it some days ago. I was planning to fix it in the later PR because I checked it at that time that it can&apos;t raise NPE, so I thought it&apos;s not emergency. However &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-16770&quot; title=&quot;Resuming Externalized Checkpoint (rocks, incremental, scale up) end-to-end test fails with no such file&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-16770&quot;&gt;&lt;del&gt;FLINK-16770&lt;/del&gt;&lt;/a&gt; breaks the plan, I reverted a lot of codes and forgot to fix this potential issue separately. Unfortunately &lt;a href=&quot;https://github.com/apache/flink/commit/1af33f1285d557f0171f4587d7f4e789df27e7cb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/1af33f1285d557f0171f4587d7f4e789df27e7cb&lt;/a&gt; hits this NPE. &lt;tt&gt;onTriggerFailure&lt;/tt&gt; shouldn&apos;t throw any exception by design.&lt;br/&gt;
The codes changed a bit from my last commit. I need to double check the comment mentioned by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; to make sure there is no other issue.&lt;/p&gt;</comment>
                            <comment id="17133362" author="till.rohrmann" created="Thu, 11 Jun 2020 15:58:31 +0000"  >&lt;p&gt;Thanks for looking into the problem &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SleePy&quot; class=&quot;user-hover&quot; rel=&quot;SleePy&quot;&gt;SleePy&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="17134231" author="till.rohrmann" created="Fri, 12 Jun 2020 13:48:32 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;master: 38b2755bdf934b9e6d1aa6584b81fa210953d5be&lt;br/&gt;
1.11.0: 90a7dab894b12b85f21d4cfc637d0d770841cfe5&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13309501">FLINK-18138</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 22 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fins:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>