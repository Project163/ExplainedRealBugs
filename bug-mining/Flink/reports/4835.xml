<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:51:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-20261] Uncaught exception in ExecutorNotifier due to split assignment broken by failed task</title>
                <link>https://issues.apache.org/jira/browse/FLINK-20261</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;While trying to extend &lt;tt&gt;FileSourceTextLinesITCase::testContinuousTextFileSourceWithTaskManagerFailover&lt;/tt&gt; with recovery test after TM failure (&lt;tt&gt;TestingMiniCluster::terminateTaskExecutor&lt;/tt&gt;, &lt;a href=&quot;https://github.com/azagrebin/flink/tree/FLINK-20118-it&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;) in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-20118&quot; title=&quot;Test New File Source API - Continuous Streaming Execution&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-20118&quot;&gt;&lt;del&gt;FLINK-20118&lt;/del&gt;&lt;/a&gt;, I encountered the following case:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;SourceCoordinatorContext::assignSplits&lt;/tt&gt; schedules async assignment (all reader tasks alive)&lt;/li&gt;
	&lt;li&gt;call &lt;tt&gt;TestingMiniCluster::terminateTaskExecutor&lt;/tt&gt; while doing writeFile in a loop of testContinuousTextFileSource&lt;/li&gt;
	&lt;li&gt;causes graceful &lt;tt&gt;TaskExecutor::onStop&lt;/tt&gt; shutdown&lt;/li&gt;
	&lt;li&gt;causes TM/RM disconnect and failing slot allocations in JM by RM&lt;/li&gt;
	&lt;li&gt;eventually causes &lt;tt&gt;SourceCoordinatorContext::unregisterSourceReader&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;actual assignment starts (&lt;tt&gt;SourceCoordinatorContext::assignSplits: callInCoordinatorThread&lt;/tt&gt;)&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;registeredReaders.containsKey(subtaskId)&lt;/tt&gt; check fails (due to failed task) with &lt;tt&gt;IllegalArgumentException&lt;/tt&gt; which is uncaught in single thread executor&lt;/li&gt;
	&lt;li&gt;forces ThreadPool to recreate the single thread&lt;/li&gt;
	&lt;li&gt;calls &lt;tt&gt;CoordinatorExecutorThreadFactory::newThread&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;fails expected condition of single thread creation with &lt;tt&gt;IllegalStateException&lt;/tt&gt; which is uncaught&lt;/li&gt;
	&lt;li&gt;calls &lt;tt&gt;FatalExitExceptionHandler&lt;/tt&gt; and exits JVM abruptly&lt;/li&gt;
&lt;/ul&gt;



&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[SourceCoordinator-Source: file-source] ERROR org.apache.flink.runtime.util.FatalExitExceptionHandler - FATAL: &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;SourceCoordinator-Source: file-source&apos;&lt;/span&gt; produced an uncaught exception. Stopping the process...
java.lang.IllegalStateException: Should never happen. This factory should only be used by a SingleThreadExecutor.
	at org.apache.flink.runtime.source.coordinator.SourceCoordinatorProvider$CoordinatorExecutorThreadFactory.newThread(SourceCoordinatorProvider.java:94) ~[classes/:?]
	at java.util.concurrent.ThreadPoolExecutor$Worker.&amp;lt;init&amp;gt;(ThreadPoolExecutor.java:619) ~[?:1.8.0_172]
	at java.util.concurrent.ThreadPoolExecutor.addWorker(ThreadPoolExecutor.java:932) ~[?:1.8.0_172]
	at java.util.concurrent.ThreadPoolExecutor.processWorkerExit(ThreadPoolExecutor.java:1025) ~[?:1.8.0_172]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1167) ~[?:1.8.0_172]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) ~[?:1.8.0_172]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748) [?:1.8.0_172]

&lt;span class=&quot;code-object&quot;&gt;Process&lt;/span&gt; finished with exit code 239
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13341795">FLINK-20261</key>
            <summary>Uncaught exception in ExecutorNotifier due to split assignment broken by failed task</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sewen">Stephan Ewen</assignee>
                                    <reporter username="azagrebin">Andrey Zagrebin</reporter>
                        <labels>
                    </labels>
                <created>Fri, 20 Nov 2020 13:34:27 +0000</created>
                <updated>Sun, 22 Nov 2020 22:56:28 +0000</updated>
                            <resolved>Sun, 22 Nov 2020 22:56:18 +0000</resolved>
                                    <version>1.12.0</version>
                                    <fixVersion>1.12.0</fixVersion>
                                    <component>Connectors / Common</component>
                    <component>Connectors / FileSystem</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17236162" author="till.rohrmann" created="Fri, 20 Nov 2020 13:53:21 +0000"  >&lt;p&gt;This looks a bit like a race condition/not proper handling of concurrent events in the &lt;tt&gt;SourceCoordinator&lt;/tt&gt;. Given that a disconnecting &lt;tt&gt;TaskManager&lt;/tt&gt; can bring down a &lt;tt&gt;JobManager&lt;/tt&gt;, I think this qualifies as a release blocker. Very good finding &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azagrebin&quot; class=&quot;user-hover&quot; rel=&quot;azagrebin&quot;&gt;azagrebin&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jqin&quot; class=&quot;user-hover&quot; rel=&quot;jqin&quot;&gt;jqin&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17236175" author="rmetzger" created="Fri, 20 Nov 2020 14:12:53 +0000"  >&lt;p&gt;This is related: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-20157&quot; title=&quot;SourceCoordinatorProvider kills JobManager with IllegalStateException on job submission&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-20157&quot;&gt;&lt;del&gt;FLINK-20157&lt;/del&gt;&lt;/a&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-20157&quot; title=&quot;SourceCoordinatorProvider kills JobManager with IllegalStateException on job submission&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-20157&quot;&gt;&lt;del&gt;FLINK-20157&lt;/del&gt;&lt;/a&gt; root cause is that the new KafkaSource is not using the usercode classloader on the JobManager). &lt;/p&gt;</comment>
                            <comment id="17236648" author="becket_qin" created="Sat, 21 Nov 2020 11:49:06 +0000"  >&lt;p&gt;It seems the root cause here is a little different. Because the SourceCoordinator is single threaded, so actually there should not be any race condition with its state. In the reported case, the calling sequence in the `SplitEnumerator` side was:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;tt&gt;SplitEnumerator.subtaskFailed()&lt;/tt&gt; is called, the failed subtask is removed from the &lt;tt&gt;SplitEnumeratorContext&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;FileSplitEnumerator.handleSplitRequest()&lt;/tt&gt;&#160;is invoked to let the split enumerator handle the split request from the failed task. At this point the the failed subtask should have already been unregistered.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The problem here is that at step 2, both &lt;tt&gt;ContinuousFileSplitEnumerator&lt;/tt&gt; and &lt;tt&gt;StaticFileSplitEnumerator&lt;/tt&gt;&#160;naively call `SplitEnumeratorContext.assignSplits()` to assign split to the failed subtask without checking the liveness of the subtask in question. This will trigger IllegalArgumentException in the &lt;tt&gt;SplitEnumeratorContext&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;So I think the fix here should be just ignoring the split request when the subtask does not exist in the &lt;tt&gt;SplitEnumeratorContext&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;That being said, the exception handling in the ExecutorNotifier still needs to be improved. But that seems orthogonal to the issue reported here.&lt;/p&gt;

&lt;p&gt;CC: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sewen&quot; class=&quot;user-hover&quot; rel=&quot;sewen&quot;&gt;sewen&lt;/a&gt;&#160;Can you also help check if this is the case?&lt;/p&gt;</comment>
                            <comment id="17237014" author="stephanewen" created="Sun, 22 Nov 2020 20:43:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=becket_qin&quot; class=&quot;user-hover&quot; rel=&quot;becket_qin&quot;&gt;becket_qin&lt;/a&gt; You are right, that is what is happening here. I&apos;ll fix the behavior of the file source enumerator under this ticket, and we fix the enumerator uncaught exception handling in the linked issues.&lt;/p&gt;</comment>
                            <comment id="17237036" author="stephanewen" created="Sun, 22 Nov 2020 22:56:18 +0000"  >&lt;p&gt;Fixed in 1.12.0 via 75599bca3ecff89c0abf9d9027d1280e1ac812b0&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13340254">FLINK-20118</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13339891">FLINK-20081</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13340553">FLINK-20157</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 51 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0kshk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>