<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:07:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-24704] Exception occurs when the input record loses monotonicity on the sort key field of UpdatableTopNFunction</title>
                <link>https://issues.apache.org/jira/browse/FLINK-24704</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;An IllegalArgumentException occurred when the input retract record&apos;s sort key is lower than old&#160;sort key, this&apos;s because it breaks the monotonicity on sort key field&#160;which is guaranteed by the sql semantic. It&apos;s highly&#160;possible upstream stateful operator has shorter state ttl&#160;than the stream records is that cause the staled record cleared by state ttl.&#160;&lt;/p&gt;

&lt;p&gt;A reproduce case like below:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;RankHarnessTest.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
}}

val sql =
 &quot;&quot;&quot;
 |SELECT word, cnt, rank_num
 |FROM (
 | SELECT word, cnt,
 | ROW_NUMBER() OVER (PARTITION BY type ORDER BY cnt DESC) as rank_num
 | FROM (
 | select word, type, sum(cnt) filter (where cnt &amp;gt; 0) cnt from T group by word, type
 | )
 | )
 |WHERE rank_num &amp;lt;= 6
 &quot;&quot;&quot;.stripMargin

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;when then aggregated result column `cnt` becomes lower for a key, then downstream retract rank operator will fail on such exception:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;java.lang.IllegalArgumentExceptionjava.lang.IllegalArgumentException at org.apache.flink.util.Preconditions.checkArgument(Preconditions.java:122) at org.apache.flink.table.runtime.operators.rank.UpdatableTopNFunction.emitRecordsWithRowNumber(UpdatableTopNFunction.java:399) at org.apache.flink.table.runtime.operators.rank.UpdatableTopNFunction.processElementWithRowNumber(UpdatableTopNFunction.java:274) at org.apache.flink.table.runtime.operators.rank.UpdatableTopNFunction.processElement(UpdatableTopNFunction.java:167) at org.apache.flink.table.runtime.operators.rank.UpdatableTopNFunction.processElement(UpdatableTopNFunction.java:69) at org.apache.flink.streaming.api.operators.KeyedProcessOperator.processElement(KeyedProcessOperator.java:83) at org.apache.flink.streaming.util.OneInputStreamOperatorTestHarness.processElement(OneInputStreamOperatorTestHarness.java:209)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Here we should align with the&#160;RetractableTopNFunction, continue processing(but incorrectly result) by default or can be configured to failover after &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-24666&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;Flink-24666&lt;/a&gt; was addressed.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13409108">FLINK-24704</key>
            <summary>Exception occurs when the input record loses monotonicity on the sort key field of UpdatableTopNFunction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lincoln.86xy">lincoln lee</assignee>
                                    <reporter username="lincoln.86xy">lincoln lee</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 29 Oct 2021 12:01:04 +0000</created>
                <updated>Wed, 15 Dec 2021 01:44:10 +0000</updated>
                            <resolved>Wed, 10 Nov 2021 02:08:31 +0000</resolved>
                                    <version>1.14.0</version>
                                    <fixVersion>1.14.3</fixVersion>
                    <fixVersion>1.15.0</fixVersion>
                                    <component>Table SQL / Runtime</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17436583" author="ykt836" created="Mon, 1 Nov 2021 01:51:47 +0000"  >&lt;p&gt;Thanks for reporting this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lincoln.86xy&quot; class=&quot;user-hover&quot; rel=&quot;lincoln.86xy&quot;&gt;lincoln.86xy&lt;/a&gt;, will this leads to incorrect result or endless exception-failover-exception loop?&lt;/p&gt;</comment>
                            <comment id="17436598" author="lincoln.86xy" created="Mon, 1 Nov 2021 03:30:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ykt836&quot; class=&quot;user-hover&quot; rel=&quot;ykt836&quot;&gt;ykt836&lt;/a&gt;, yes, it will cause continuous failover and users cannot recover it only discard the current state and re-run the job.&lt;/p&gt;</comment>
                            <comment id="17436653" author="ykt836" created="Mon, 1 Nov 2021 07:36:57 +0000"  >&lt;p&gt;I changed the priority to critical, and we&apos;d better to also back port this fix to 1.14&lt;/p&gt;</comment>
                            <comment id="17441461" author="lzljs3620320" created="Wed, 10 Nov 2021 02:08:31 +0000"  >&lt;p&gt;master: 33aaabebc63f7a44fb64930f5daf8006ce030752&lt;/p&gt;

&lt;p&gt;release-1.14: d31cfb9b1b206270f5ccdb456c84d8c639e0524d&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0wa5s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>