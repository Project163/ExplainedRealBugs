<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:20:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-2545] NegativeArraySizeException while creating hash table bloom filters</title>
                <link>https://issues.apache.org/jira/browse/FLINK-2545</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The following exception occurred a second time when I immediately re-ran my application, though after recompiling and restarting Flink the subsequent execution ran without error.&lt;/p&gt;

&lt;p&gt;java.lang.Exception: The data preparation for task &apos;...&apos; , caused an error: null&lt;br/&gt;
	at org.apache.flink.runtime.operators.RegularPactTask.run(RegularPactTask.java:465)&lt;br/&gt;
	at org.apache.flink.runtime.operators.RegularPactTask.invoke(RegularPactTask.java:354)&lt;br/&gt;
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:581)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;br/&gt;
Caused by: java.lang.NegativeArraySizeException&lt;br/&gt;
	at org.apache.flink.runtime.operators.hash.MutableHashTable.buildBloomFilterForBucket(MutableHashTable.java:1160)&lt;br/&gt;
	at org.apache.flink.runtime.operators.hash.MutableHashTable.buildBloomFilterForBucketsInPartition(MutableHashTable.java:1143)&lt;br/&gt;
	at org.apache.flink.runtime.operators.hash.MutableHashTable.spillPartition(MutableHashTable.java:1117)&lt;br/&gt;
	at org.apache.flink.runtime.operators.hash.MutableHashTable.insertBucketEntry(MutableHashTable.java:946)&lt;br/&gt;
	at org.apache.flink.runtime.operators.hash.MutableHashTable.insertIntoTable(MutableHashTable.java:868)&lt;br/&gt;
	at org.apache.flink.runtime.operators.hash.MutableHashTable.buildInitialTable(MutableHashTable.java:692)&lt;br/&gt;
	at org.apache.flink.runtime.operators.hash.MutableHashTable.open(MutableHashTable.java:455)&lt;br/&gt;
	at org.apache.flink.runtime.operators.hash.ReusingBuildSecondHashMatchIterator.open(ReusingBuildSecondHashMatchIterator.java:93)&lt;br/&gt;
	at org.apache.flink.runtime.operators.JoinDriver.prepare(JoinDriver.java:195)&lt;br/&gt;
	at org.apache.flink.runtime.operators.RegularPactTask.run(RegularPactTask.java:459)&lt;br/&gt;
	... 3 more&lt;/p&gt;</description>
                <environment></environment>
        <key id="12857007">FLINK-2545</key>
            <summary>NegativeArraySizeException while creating hash table bloom filters</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chengxiang li">Chengxiang Li</assignee>
                                    <reporter username="greghogan">Greg Hogan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Aug 2015 18:59:55 +0000</created>
                <updated>Tue, 6 Oct 2015 15:51:09 +0000</updated>
                            <resolved>Wed, 2 Sep 2015 13:56:23 +0000</resolved>
                                    <version>0.10.0</version>
                                    <fixVersion>0.10.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14701802" author="stephanewen" created="Tue, 18 Aug 2015 19:08:45 +0000"  >&lt;p&gt;Thanks for reporting this!&lt;/p&gt;

&lt;p&gt;As a quick fix, you can disable bloom filters by adding &lt;tt&gt;taskmanager.runtime.hashjoin-bloom-filters: false&lt;/tt&gt; to the Flink config.&lt;/p&gt;

&lt;p&gt;See here for a reference: &lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-master/setup/config.html#runtime-algorithms&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.apache.org/projects/flink/flink-docs-master/setup/config.html#runtime-algorithms&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Th bloom filters are a relatively new addition in 0.10.&lt;/p&gt;</comment>
                            <comment id="14716152" author="chengxiang li" created="Thu, 27 Aug 2015 06:21:06 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=greghogan&quot; class=&quot;user-hover&quot; rel=&quot;greghogan&quot;&gt;greghogan&lt;/a&gt;, do you mind to share how to reproduce this issue? The exception caused by a negative array index, which represents the count of bucket member. It should be very simple to add a check of the count value to fix this issue. But the count should never be negative according to the hashtable implementation, so if it&apos;s possible, i want to reproduce this issue to check if there is other hidden issues behind this.&lt;/p&gt;</comment>
                            <comment id="14716279" author="githubbot" created="Thu, 27 Aug 2015 08:38:36 +0000"  >&lt;p&gt;GitHub user ChengXiangLi opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1067&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1067&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2545&quot; title=&quot;NegativeArraySizeException while creating hash table bloom filters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2545&quot;&gt;&lt;del&gt;FLINK-2545&lt;/del&gt;&lt;/a&gt; add bucket member count verification while build bloom filter&lt;/p&gt;

&lt;p&gt;    Bug fix, see detail error message at &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2545&quot; title=&quot;NegativeArraySizeException while creating hash table bloom filters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2545&quot;&gt;&lt;del&gt;FLINK-2545&lt;/del&gt;&lt;/a&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2545&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-2545&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ChengXiangLi/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ChengXiangLi/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2545&quot; title=&quot;NegativeArraySizeException while creating hash table bloom filters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2545&quot;&gt;&lt;del&gt;FLINK-2545&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1067.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1067.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1067&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 072ce60ac875a270f2cd06ec6323f9eb2814d5ea&lt;br/&gt;
Author: chengxiang li &amp;lt;chengxiang.li@intel.com&amp;gt;&lt;br/&gt;
Date:   2015-08-27T06:28:38Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-2545&quot; title=&quot;NegativeArraySizeException while creating hash table bloom filters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-2545&quot;&gt;&lt;del&gt;FLINK-2545&lt;/del&gt;&lt;/a&gt; add bucket member count verification while build bloom filter.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14716292" author="githubbot" created="Thu, 27 Aug 2015 08:46:21 +0000"  >&lt;p&gt;Github user zentol commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1067#issuecomment-135342976&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1067#issuecomment-135342976&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Have you verified that returning at that position does not cause other issues? This is essentially just swallowing the thrown exception, hoping nothing else goes wrong.&lt;/p&gt;

&lt;p&gt;    I don&apos;t see how this actually fixes the issue. The count being negatives tells us there is something wrong with the bucket count being set. Resolving that would be a fix.&lt;/p&gt;</comment>
                            <comment id="14716324" author="githubbot" created="Thu, 27 Aug 2015 09:11:50 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1067#issuecomment-135354418&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1067#issuecomment-135354418&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @ChengXiangLi Do you know what caused the problem initially? I was puzzled, because the count in the bucket should never be negative, and a zero sized bucket should work with your original code.&lt;/p&gt;

&lt;p&gt;    Would be great to capture that error, to see if the root bug was actually somewhere else (not in the bloom filters), but in the other parts of the hash table structure.&lt;/p&gt;

&lt;p&gt;    Hopefully Greg can help us to reproduce this...&lt;/p&gt;</comment>
                            <comment id="14717934" author="githubbot" created="Fri, 28 Aug 2015 02:24:31 +0000"  >&lt;p&gt;Github user ChengXiangLi commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1067#issuecomment-135612599&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1067#issuecomment-135612599&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the remind, @zentol and @StephanEwen , I should be too hurry to open this PR. I tried to fix the exception in bloom filter in this PR and verify other potential issues in hash table behind negative count number separately, obviously, there is no need to do in that way. So let&apos;s wait for Greg&apos;s response now.&lt;/p&gt;</comment>
                            <comment id="14720556" author="githubbot" created="Fri, 28 Aug 2015 20:55:37 +0000"  >&lt;p&gt;Github user greghogan commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1067#issuecomment-135885866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1067#issuecomment-135885866&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I am currently running release-0.10.0-milestone-1.&lt;/p&gt;

&lt;p&gt;    Debugging with Eclipse and looking at MutableHashTable.initTable, numBuckets is computed as 16086. There are 63 memory segments with 256 buckets each = 16128 total buckets. The last 16128 - 16086 = 42 buckets are not initialized by initTable which terminates the inner loop when bucket == numBuckets. Here is an example header dump from the last memory segment showing the crossover from initialized to uninitialized data.&lt;/p&gt;

&lt;p&gt;    offset, partition, status, count, next-pointer&lt;br/&gt;
    26880 10 0 0 -72340172838076673&lt;br/&gt;
    27008 11 0 0 -72340172838076673&lt;br/&gt;
    27136 12 0 0 -72340172838076673&lt;br/&gt;
    27264 13 0 0 -72340172838076673&lt;br/&gt;
    27392 0 -56 9 844425030795264&lt;br/&gt;
    27520 0 -56 9 -9191846839379296256&lt;br/&gt;
    27648 0 -56 9 10133099245469696&lt;br/&gt;
    27776 0 -56 9 12103424082444288&lt;/p&gt;

&lt;p&gt;    Setting a breakpoint for MutableHashTable.buildBloomFilterForBucket for count &amp;lt; 0, the last memory segment looked as follows (this is from a different execution, operation, and thread).&lt;/p&gt;

&lt;p&gt;    offset, partition, status, count, next-pointer&lt;br/&gt;
    26880 10 0 9 27584547767975936&lt;br/&gt;
    27008 11 0 9 -9208735337998712832&lt;br/&gt;
    27136 12 0 9 4503599694479360&lt;br/&gt;
    27264 13 0 9 -9219994337067139072&lt;br/&gt;
    27392 0 0 -32697 1161165883580435&lt;br/&gt;
    27520 0 3 -15328 18016855230957176&lt;br/&gt;
    27648 0 5 1388 -33740636012148672&lt;br/&gt;
    27776 0 6 25494 -17363350186618861&lt;/p&gt;

&lt;p&gt;    MutableHashTable.buildBloomFilterForBucketsInPartition processed offset 27392 which happened to match the partition number and bucket status even though it looks to be uninitialized.&lt;/p&gt;

&lt;p&gt;    After changing MutableHashTable.initTable to initialize all buckets in all segments I have not seen the bug reoccur.&lt;/p&gt;

    &lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; k = 0; k &amp;lt; bucketsPerSegment &lt;span class=&quot;code-comment&quot;&gt;/* &amp;amp;&amp;amp; bucket &amp;lt; numBuckets*/&lt;/span&gt;; k++, bucket++) {
    }
    &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;    I see at least three potential resolutions: 1) have MutableHashTable.initTable initialize all buckets, 2) have MutableHashTable.buildBloomFilterForBucket skip uninitialized buckets, or 3) I have not looked enough at MutableHashTable.getInitialTableSize but it is possible to completely fill the last segment with usable buckets?&lt;/p&gt;</comment>
                            <comment id="14721111" author="githubbot" created="Sat, 29 Aug 2015 13:06:45 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1067#issuecomment-135983916&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1067#issuecomment-135983916&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Ah, that makes perfect sense. The last memory segment is not fully used (only until the hash index has initialized enough buckets). The bloom filter initialization loops should also skip those last buckets.&lt;/p&gt;

&lt;p&gt;    Since the memory for these buckets is not initialized, their contents (like count) is undefined.&lt;/p&gt;</comment>
                            <comment id="14721931" author="githubbot" created="Mon, 31 Aug 2015 03:38:16 +0000"  >&lt;p&gt;Github user ChengXiangLi commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1067#issuecomment-136243437&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1067#issuecomment-136243437&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Nice job, @greghogan , you just pointed out the root cause and the solution. I add the logic to skip latest buckets as @StephanEwen suggested, and add related unit test for this issue.&lt;/p&gt;</comment>
                            <comment id="14725153" author="githubbot" created="Tue, 1 Sep 2015 10:30:49 +0000"  >&lt;p&gt;Github user StephanEwen commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1067#issuecomment-136667661&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1067#issuecomment-136667661&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Looks good, I&apos;ll merge this!&lt;/p&gt;</comment>
                            <comment id="14727371" author="githubbot" created="Wed, 2 Sep 2015 13:55:00 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/1067&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/1067&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14727376" author="stephanewen" created="Wed, 2 Sep 2015 13:56:23 +0000"  >&lt;p&gt;Fixed via 2e6e4de5d1d2b5123f4311493763fd84f52779ab&lt;/p&gt;

&lt;p&gt;Thank you for the contribution!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12858892">FLINK-2575</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 11 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2j2i7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>