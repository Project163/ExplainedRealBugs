<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:49:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-19289] Remove pods terminated during JM failover</title>
                <link>https://issues.apache.org/jira/browse/FLINK-19289</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;For a senario,&lt;/p&gt;

&lt;p&gt;During JM is down (no JM is running), a TM down with error (for reasons from the node or TM inner), then an Error pod present there. After one JM recover, it will receive a ADDED event about this pod and do nothing.&lt;/p&gt;

&lt;p&gt;We should deal with this case in `onAdded` callback properly, I think.&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xintongsong&quot; class=&quot;user-hover&quot; rel=&quot;xintongsong&quot;&gt;xintongsong&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13328201">FLINK-19289</key>
            <summary>Remove pods terminated during JM failover</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xtsong">Xintong Song</assignee>
                                    <reporter username="yittg">Yi Tang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 18 Sep 2020 08:17:13 +0000</created>
                <updated>Wed, 23 Sep 2020 04:48:32 +0000</updated>
                            <resolved>Tue, 22 Sep 2020 11:28:53 +0000</resolved>
                                    <version>1.12.0</version>
                                    <fixVersion>1.12.0</fixVersion>
                                    <component>Deployment / Kubernetes</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17198234" author="xintongsong" created="Fri, 18 Sep 2020 09:06:52 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yittg&quot; class=&quot;user-hover&quot; rel=&quot;yittg&quot;&gt;yittg&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for pulling me in.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure whether I have understand the problem you described correctly. By &quot;deal with this case properly&quot;, do you mean that Flink should remove the error pod from K8s?&lt;/p&gt;

&lt;p&gt;If that is what you mean, I think Flink should be able to remove such pods. For such pods terminated during JM failover, Flink should receive not only a ADDED event, but also the MODIFIED/ERROR events, thus triggering removal of the pods.&lt;/p&gt;

&lt;p&gt;Have you verified that the error pod is not removed even after the JM successfully recovered for a while?&lt;/p&gt;</comment>
                            <comment id="17198239" author="yittg" created="Fri, 18 Sep 2020 09:19:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xintongsong&quot; class=&quot;user-hover&quot; rel=&quot;xintongsong&quot;&gt;xintongsong&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Flink should receive not only a ADDED event, but also the MODIFIED/ERROR events, thus triggering removal of the pods.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I believe only an ADDED event will be received, it&apos;s about the k8s resource watching logic.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Have you verified that the error pod is not removed even after the JM successfully recovered for a while?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, the JM do nothing with the error pod,&lt;br/&gt;
i try to update some not important fields of the error pod, then it can be removed right now.&lt;/p&gt;</comment>
                            <comment id="17198250" author="xintongsong" created="Fri, 18 Sep 2020 09:51:43 +0000"  >&lt;p&gt;Double checked the k8s watching logic. I think you are right, only ADDED event will be received for the terminated pods. This is indeed a valid bug, thanks for reporting this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yittg&quot; class=&quot;user-hover&quot; rel=&quot;yittg&quot;&gt;yittg&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Regarding the solution, I would suggest to check the pod status in &lt;tt&gt;recoverWorkerNodesFromPreviousAttempts&lt;/tt&gt; and remove pods that are already terminated, rather than handle this in &lt;tt&gt;onAdded&lt;/tt&gt;. If I understand correctly, only pods that are recovered from previous attempt have this problem. To that end, removing the pods in &lt;tt&gt;recoverWorkerNodesFromPreviousAttempt&lt;/tt&gt; might be better since this method only affects recovered pods, unlike &lt;tt&gt;onAdded&lt;/tt&gt; affects both recovered and new pods.&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="17198357" author="yittg" created="Fri, 18 Sep 2020 13:59:26 +0000"  >&lt;p&gt;Exactly, it&apos;s good to filter and remove terminated pods before starting to watch.&lt;/p&gt;

&lt;p&gt;But, there is a gap (maybe very short) btw listing and watching pods. So just filter before is not &lt;b&gt;absolutely&lt;/b&gt; right. What do you think?&lt;/p&gt;</comment>
                            <comment id="17199114" author="xintongsong" created="Mon, 21 Sep 2020 02:00:23 +0000"  >&lt;p&gt;Good point.&lt;br/&gt;
I think we can create the watcher before listing pods in `initializeInternal`. Both calls are synchronized, which guarantees resource version for the watch is &amp;lt;= that of listing.&lt;/p&gt;</comment>
                            <comment id="17199134" author="yittg" created="Mon, 21 Sep 2020 03:27:07 +0000"  >&lt;p&gt;Then, a terminated pod may be processed twice, in listing / onUpdated, which should be noted&lt;/p&gt;</comment>
                            <comment id="17199146" author="xintongsong" created="Mon, 21 Sep 2020 03:48:05 +0000"  >&lt;p&gt;That is exactly the protocol between &lt;tt&gt;ResourceManagerDriver&lt;/tt&gt; and &lt;tt&gt;ActiveResourceManager&lt;/tt&gt;. The &lt;tt&gt;ResourceManagerDriver}}s do not maintain status for the living workers, they simply forward events received from external systems (K8s, Yarn, Mesos). The {{ActiveResourceManager&lt;/tt&gt; should deal with the duplicated events.&lt;/p&gt;</comment>
                            <comment id="17199148" author="yittg" created="Mon, 21 Sep 2020 04:03:11 +0000"  >&lt;p&gt;That&apos;s great.&lt;/p&gt;</comment>
                            <comment id="17199789" author="xintongsong" created="Tue, 22 Sep 2020 04:05:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yittg&quot; class=&quot;user-hover&quot; rel=&quot;yittg&quot;&gt;yittg&lt;/a&gt;,&lt;br/&gt;
I&apos;ve opened a PR to fix this problem. Would you like to take a look?&lt;/p&gt;</comment>
                            <comment id="17199791" author="yittg" created="Tue, 22 Sep 2020 04:12:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xintongsong&quot; class=&quot;user-hover&quot; rel=&quot;xintongsong&quot;&gt;xintongsong&lt;/a&gt;&#160;Looks good.&lt;/p&gt;</comment>
                            <comment id="17200016" author="xintongsong" created="Tue, 22 Sep 2020 11:28:53 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;master: c884aee70555fab70a80fac84b3812a2b74b17fa&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 8 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ipm0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>