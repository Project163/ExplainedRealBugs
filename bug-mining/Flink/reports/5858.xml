<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:06:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-24213] Deadlock in QueryableState Client</title>
                <link>https://issues.apache.org/jira/browse/FLINK-24213</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=23750&amp;amp;view=logs&amp;amp;j=d44f43ce-542c-597d-bf94-b0718c71e5e8&amp;amp;t=ed165f3f-d0f6-524b-5279-86f8ee7d0e2d&amp;amp;l=15476&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=23750&amp;amp;view=logs&amp;amp;j=d44f43ce-542c-597d-bf94-b0718c71e5e8&amp;amp;t=ed165f3f-d0f6-524b-5279-86f8ee7d0e2d&amp;amp;l=15476&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 Found one Java-level deadlock:
Sep 08 11:12:50 =============================
Sep 08 11:12:50 &lt;span class=&quot;code-quote&quot;&gt;&quot;Flink Test Client Event Loop &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; 0&quot;&lt;/span&gt;:
Sep 08 11:12:50   waiting to lock monitor 0x00007f4e380309c8 (object 0x0000000086b2cd50, a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;),
Sep 08 11:12:50   which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt;
Sep 08 11:12:50 &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt;:
Sep 08 11:12:50   waiting to lock monitor 0x00007f4ea4004068 (object 0x0000000086b2cf50, a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;),
Sep 08 11:12:50   which is held by &lt;span class=&quot;code-quote&quot;&gt;&quot;Flink Test Client Event Loop &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; 0&quot;&lt;/span&gt;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13399987">FLINK-24213</key>
            <summary>Deadlock in QueryableState Client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="dwysakowicz">Dawid Wysakowicz</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Wed, 8 Sep 2021 12:56:14 +0000</created>
                <updated>Wed, 15 Dec 2021 01:40:28 +0000</updated>
                            <resolved>Fri, 10 Sep 2021 05:30:52 +0000</resolved>
                                    <version>1.14.0</version>
                    <version>1.12.6</version>
                    <version>1.13.3</version>
                                    <fixVersion>1.14.0</fixVersion>
                    <fixVersion>1.13.3</fixVersion>
                    <fixVersion>1.12.8</fixVersion>
                                    <component>Runtime / Queryable State</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17412349" author="xmarker" created="Thu, 9 Sep 2021 06:02:19 +0000"  >&lt;p&gt;The dead lock seems occur in following scene:&lt;/p&gt;

&lt;p&gt;1.When establishedConnection handle data failed ,call stack&#160; in netty bootstrap thread is:&#160;&lt;/p&gt;

&lt;p&gt;establishedConnection.onFailure() -&amp;gt; establishedConnection.close() -&amp;gt; hold establishedConnection.lock -&amp;gt; when channel closed : hold serverConnection.connectionLock&#160;&lt;/p&gt;

&lt;p&gt;2.When client.shutdown() ,call stack in main thread is :&lt;/p&gt;

&lt;p&gt;serverConnection.close() &lt;del&gt;&amp;gt; hold&#160;serverConnection.connectionLock&lt;/del&gt; &#160;&amp;gt;&#160;&#160;establishedConnection.close()&#160;-&amp;gt;&lt;br/&gt;
 hold establishedConnection.lock&#160;&lt;/p&gt;

&lt;p&gt;so ,two thread with different direction wants hold opposition&apos;s&#160;lock ,dead lock occurred.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;May be&#160;ServerConnection.close should call&#160;internalConnection.close first without lock ,because&#160; internalConnection.close is thread safe, has any better way?&lt;/p&gt;</comment>
                            <comment id="17412406" author="zentol" created="Thu, 9 Sep 2021 07:32:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xmarker&quot; class=&quot;user-hover&quot; rel=&quot;xmarker&quot;&gt;xmarker&lt;/a&gt; concurrency analysis is correct.&lt;/p&gt;

&lt;p&gt;I see 2 options here. Either we enforce a strict order such that we always start close() calls from the ServerConnection, or we merge the locks.&lt;br/&gt;
Due to how the connections are constructed the first option cannot be implemented without larger refactorings, so I&apos;m inclined to go with the latter; it should also make it in general easier to reason about, and the separation of locks doesn&apos;t provide any real benefit as far as I can tell.&lt;/p&gt;</comment>
                            <comment id="17412550" author="zentol" created="Thu, 9 Sep 2021 12:38:03 +0000"  >&lt;p&gt;master:&lt;br/&gt;
b5ac92eb5282ecdedf2daf89c1e9a1a737499836&lt;br/&gt;
2e721ab3fa501ce5c4ac4f9fe032a770aa66bc9a&lt;br/&gt;
1.14:&lt;br/&gt;
a2185c0f9bef64b103a4e1ae2c33619d83d54921&lt;br/&gt;
2459a3c3001c2ef263536276b7d7109752f93286&lt;br/&gt;
1.13:&lt;br/&gt;
640797f39454223503c097f4762ae4f8d5d2e768&lt;br/&gt;
4db7f4c502ba6428bf4f3f7d52b00a8cbada29fa&lt;br/&gt;
1.12:&lt;br/&gt;
fa2ab610c1c20ff828db0fc928b6328c2f440e9d&lt;br/&gt;
de69c3e3e7a4c29e99acd91129937db24afaefb2&lt;/p&gt;</comment>
                            <comment id="17412912" author="xintongsong" created="Fri, 10 Sep 2021 02:18:32 +0000"  >&lt;p&gt;Instance on 1.12:&lt;br/&gt;
&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=23877&amp;amp;view=logs&amp;amp;j=d44f43ce-542c-597d-bf94-b0718c71e5e8&amp;amp;t=03dca39c-73e8-5aaf-601d-328ae5c35f20&amp;amp;l=15504&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=23877&amp;amp;view=logs&amp;amp;j=d44f43ce-542c-597d-bf94-b0718c71e5e8&amp;amp;t=03dca39c-73e8-5aaf-601d-328ae5c35f20&amp;amp;l=15504&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13173937">FLINK-9925</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 9 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0upww:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>