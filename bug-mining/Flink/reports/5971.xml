<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:07:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-24597] RocksdbStateBackend getKeysAndNamespaces would return duplicate data when using MapState </title>
                <link>https://issues.apache.org/jira/browse/FLINK-24597</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;For example, in RocksdbStateBackend , if we worked in VoidNamespace , and And use the ValueState like below .&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-comment&quot;&gt;// insert record
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 3; ++i) {
                keyedStateBackend.setCurrentKey(i);
                testValueState.update(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.valueOf(i));
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then we get all the keysAndNamespace according the method RocksDBKeyedStateBackend#getKeysAndNamespaces().The result of the traversal is&lt;br/&gt;
 &amp;lt;1,VoidNamespace&amp;gt;,&amp;lt;2,VoidNamespace&amp;gt;,&amp;lt;3,VoidNamespace&amp;gt; ,which is as expected.&lt;/p&gt;

&lt;p&gt;Thus&#65292;if we use MapState , and update the MapState with different user key, the getKeysAndNamespaces would return duplicate data with same keyAndNamespace.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-comment&quot;&gt;// insert record
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 3; ++i) {
                keyedStateBackend.setCurrentKey(i);
                mapState.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;userKeyA_&quot;&lt;/span&gt; + i, &lt;span class=&quot;code-quote&quot;&gt;&quot;userValue&quot;&lt;/span&gt;);
                mapState.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;userKeyB_&quot;&lt;/span&gt; + i, &lt;span class=&quot;code-quote&quot;&gt;&quot;userValue&quot;&lt;/span&gt;);
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The result of the traversal is&lt;br/&gt;
 &amp;lt;1,VoidNamespace&amp;gt;,&amp;lt;1,VoidNamespace&amp;gt;,&amp;lt;2,VoidNamespace&amp;gt;,&amp;lt;2,VoidNamespace&amp;gt;,&amp;lt;3,VoidNamespace&amp;gt;,&amp;lt;3,VoidNamespace&amp;gt;.&lt;/p&gt;

&lt;p&gt;By reading the code, I found that the main reason for this problem is in the implementation of &lt;em&gt;RocksStateKeysAndNamespaceIterator&lt;/em&gt;.&lt;br/&gt;
In the &lt;em&gt;hasNext&lt;/em&gt; method, when a new keyAndNamespace is created, there is no comparison with the previousKeyAndNamespace. So we can refer to RocksStateKeysIterator to implement the same logic should solve this problem.&lt;br/&gt;
 &#160;&lt;br/&gt;
 &#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13407432">FLINK-24597</key>
            <summary>RocksdbStateBackend getKeysAndNamespaces would return duplicate data when using MapState </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mayuehappy">Yue Ma</assignee>
                                    <reporter username="mayuehappy">Yue Ma</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 20 Oct 2021 06:43:48 +0000</created>
                <updated>Wed, 15 Dec 2021 01:44:06 +0000</updated>
                            <resolved>Fri, 5 Nov 2021 03:03:04 +0000</resolved>
                                    <version>1.14.0</version>
                    <version>1.12.4</version>
                    <version>1.13.3</version>
                                    <fixVersion>1.13.6</fixVersion>
                    <fixVersion>1.14.3</fixVersion>
                    <fixVersion>1.15.0</fixVersion>
                                    <component>API / State Processor</component>
                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17433432" author="klion26" created="Sun, 24 Oct 2021 12:30:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mayuehappy&quot; class=&quot;user-hover&quot; rel=&quot;mayuehappy&quot;&gt;mayuehappy&lt;/a&gt;&#160;thanks for reporting this issue, I think this is valid.&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sjwiesman&quot; class=&quot;user-hover&quot; rel=&quot;sjwiesman&quot;&gt;sjwiesman&lt;/a&gt;&#160;could you please help to have a double check about this, thanks.&lt;/p&gt;</comment>
                            <comment id="17433569" author="mayuehappy" created="Mon, 25 Oct 2021 05:52:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt;&#160;could you please help to take a look at this issue&#160; , thx ?&#160;&lt;/p&gt;</comment>
                            <comment id="17433794" author="roman_khachatryan" created="Mon, 25 Oct 2021 14:24:32 +0000"  >&lt;p&gt;Thanks for pulling me in &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mayuehappy&quot; class=&quot;user-hover&quot; rel=&quot;mayuehappy&quot;&gt;mayuehappy&lt;/a&gt;, I think the issue is valid and the fix seems correct.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;&#160;do you have any concerns regarding it?&#160;&lt;/p&gt;

&lt;p&gt;In the iterator.hasNext, we&apos;d call equals for (key, ns) each time, which can have some performance implications.&lt;/p&gt;</comment>
                            <comment id="17435842" author="yunta" created="Fri, 29 Oct 2021 08:11:22 +0000"  >&lt;p&gt;I think this is valid, and current &lt;tt&gt;RocksStateKeysIterator&lt;/tt&gt;, which used in &lt;tt&gt;#getKeys&lt;/tt&gt;, would filter same primary key via &lt;tt&gt;!Objects.equals(previousKey, currentKey)&lt;/tt&gt;, we at least need to do simlar things during &lt;tt&gt;#getKeysAndNamespaces&lt;/tt&gt;. For performance things, since we could have unfixed length key-serializer, it might not be easy to avoid the deserialization.&lt;/p&gt;</comment>
                            <comment id="17436629" author="mayuehappy" created="Mon, 1 Nov 2021 06:20:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt;&#160;So, can this ticket be assigned to me ?&lt;/p&gt;</comment>
                            <comment id="17436635" author="yunta" created="Mon, 1 Nov 2021 06:41:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mayuehappy&quot; class=&quot;user-hover&quot; rel=&quot;mayuehappy&quot;&gt;mayuehappy&lt;/a&gt; Already assigned to you, please go ahead.&lt;/p&gt;</comment>
                            <comment id="17436960" author="mayuehappy" created="Mon, 1 Nov 2021 17:57:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt;&#160;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/flink/pull/17525&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/17525&lt;/a&gt;&lt;br/&gt;
have updated the description and added unit test . would you please take a review ?&#160; &#160;thanks&lt;/p&gt;</comment>
                            <comment id="17439000" author="yunta" created="Fri, 5 Nov 2021 03:03:04 +0000"  >&lt;p&gt;Merged&lt;br/&gt;
master: a907d92673a711612b287d184c00dad7fa42269f&lt;br/&gt;
release-1.14: 547b3befcff50bf8fc2bef4e596cd39a55c7d4b2&lt;br/&gt;
release-1.13: 77824d10edb3fd299c242865a3a03fe08e540a85&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13035545" name="image-2021-11-01-14-19-58-372.png" size="312" author="mayuehappy" created="Mon, 1 Nov 2021 06:19:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 1 week, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0vztc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>