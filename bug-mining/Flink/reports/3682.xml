<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:43:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-15150] ZooKeeperLeaderElectionITCase.testJobExecutionOnClusterWithLeaderChange failed on Travis</title>
                <link>https://issues.apache.org/jira/browse/FLINK-15150</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&#160;&lt;br/&gt;
06:37:18.423 &lt;span class=&quot;error&quot;&gt;&amp;#91;ERROR&amp;#93;&lt;/span&gt; Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 14.014 s &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.flink.test.runtime.leaderelection.ZooKeeperLeaderElectionITCase&lt;br/&gt;
375406:37:18.423 &lt;span class=&quot;error&quot;&gt;&amp;#91;ERROR&amp;#93;&lt;/span&gt; testJobExecutionOnClusterWithLeaderChange(org.apache.flink.test.runtime.leaderelection.ZooKeeperLeaderElectionITCase) Time elapsed: 14.001 s &amp;lt;&amp;lt;&amp;lt; ERROR!&lt;br/&gt;
3755java.util.concurrent.ExecutionException: org.apache.flink.util.FlinkException: JobMaster has been shut down.&lt;br/&gt;
3756 at org.apache.flink.test.runtime.leaderelection.ZooKeeperLeaderElectionITCase.lambda$testJobExecutionOnClusterWithLeaderChange$1(ZooKeeperLeaderElectionITCase.java:131)&lt;br/&gt;
3757 at org.apache.flink.test.runtime.leaderelection.ZooKeeperLeaderElectionITCase.testJobExecutionOnClusterWithLeaderChange(ZooKeeperLeaderElectionITCase.java:131)&lt;br/&gt;
3758Caused by: org.apache.flink.util.FlinkException: JobMaster has been shut down.&lt;br/&gt;
3759&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;a href=&quot;https://travis-ci.com/flink-ci/flink/jobs/264972218&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.com/flink-ci/flink/jobs/264972218&lt;/a&gt;&lt;br/&gt;
&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13273310">FLINK-15150</key>
            <summary>ZooKeeperLeaderElectionITCase.testJobExecutionOnClusterWithLeaderChange failed on Travis</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="klion26">Congxian Qiu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 9 Dec 2019 10:15:57 +0000</created>
                <updated>Wed, 22 Jan 2020 13:55:57 +0000</updated>
                            <resolved>Wed, 22 Jan 2020 13:55:57 +0000</resolved>
                                    <version>1.10.0</version>
                                    <fixVersion>1.10.0</fixVersion>
                                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16998158" author="rmetzger" created="Tue, 17 Dec 2019 12:41:23 +0000"  >&lt;p&gt;I have observed the same failure on a azure build:&#160;&lt;a href=&quot;https://dev.azure.com/rmetzger/Flink/_build/results?buildId=3665&amp;amp;view=logs&amp;amp;j=67131492-722d-5683-5ccf-cdfe7eed652d&amp;amp;t=0f864326-4ca6-5e12-40d4-a2b00d6ececf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/rmetzger/Flink/_build/results?buildId=3665&amp;amp;view=logs&amp;amp;j=67131492-722d-5683-5ccf-cdfe7eed652d&amp;amp;t=0f864326-4ca6-5e12-40d4-a2b00d6ececf&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17008633" author="karmagyz" created="Mon, 6 Jan 2020 08:40:55 +0000"  >&lt;p&gt;Another instance &lt;a href=&quot;https://travis-ci.org/apache/flink/jobs/633117057&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/apache/flink/jobs/633117057&lt;/a&gt; .&lt;/p&gt;</comment>
                            <comment id="17016965" author="zentol" created="Thu, 16 Jan 2020 13:59:56 +0000"  >&lt;p&gt;What seems to happen is that, while JobMaster is in the process of allocating slots, the test is calling &lt;tt&gt;Dispatcher#shutDownCluster&lt;/tt&gt;. The dispatcher starts shutting down components, but the JobMaster is &lt;em&gt;not&lt;/em&gt; shut down first.&lt;br/&gt;
This results in a job failure since the slotmanager shuts down during the allocation, which fails the allocation, which fails the task, which fails the job.&lt;br/&gt;
Job restarts are forbidden by the restart strategy, so the job ends up in a terminal state, and subsequent dispatchers don&apos;t recover the job.&lt;/p&gt;

&lt;p&gt;MInimized log with some additional log messages added:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
...
18660 [dispatcher-5] INFO  o.a.f.r.dispatcher.StandaloneDispatcher  - Submitting job 411378b9f7181f9ba431960b08b701d7 (Blocking test job).
18660 [dispatcher-5] DEBUG o.a.f.r.jobmanager.ZooKeeperJobGraphStore  - Adding job graph 411378b9f7181f9ba431960b08b701d7 to flink/&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;/jobgraphs/411378b9f7181f9ba431960b08b701d7.
18670 [dispatcher-5] INFO  o.a.f.r.jobmanager.ZooKeeperJobGraphStore  - Added JobGraph(jobId: 411378b9f7181f9ba431960b08b701d7) to ZooKeeper.
18670 [dispatcher-2] INFO  o.a.f.r.rpc.akka.AkkaRpcService  - Starting RPC endpoint &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; o.a.f.r.jobmaster.JobMaster at akka:&lt;span class=&quot;code-comment&quot;&gt;//flink/user/jobmanager_4 .
&lt;/span&gt;...
18700 [main-EventThread] INFO  o.a.f.r.jobmaster.JobManagerRunnerImpl  - JobManager runner &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job Blocking test job (411378b9f7181f9ba431960b08b701d7) was granted leadership with session id 3ac17f36-f3d9-4b63-ae1e-18572db0cb23 at akka:&lt;span class=&quot;code-comment&quot;&gt;//flink/user/jobmanager_4.
&lt;/span&gt;18700 [main-EventThread] DEBUG o.a.f.r.highavailability.zookeeper.ZooKeeperRunningJobsRegistry  - Setting scheduling state to RUNNING &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job 411378b9f7181f9ba431960b08b701d7.
...
18720 [dispatcher-4] INFO  o.a.f.r.executiongraph.ExecutionGraph  - Job Blocking test job (411378b9f7181f9ba431960b08b701d7) switched from state CREATED to RUNNING.
18720 [main] INFO  org.apache.flink.test.runtime.leaderelection.ZooKeeperLeaderElectionITCase  - Initiated cluster shutdown.
...
18736 [dispatcher-2] INFO  o.a.f.r.jobmaster.JobMaster  - JobManager successfully registered at ResourceManager, leader id: a64a7f6db3146cf378a7d898cf6044d1.
18736 [dispatcher-2] INFO  o.a.f.r.jobmaster.slotpool.SlotPoolImpl  - Requesting &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; slot [SlotRequestId{7a9512bdaf255cc687212211142abd4b}] and profile ResourceProfile{UNKNOWN} from resource manager.
18736 [dispatcher-3] INFO  o.a.f.r.resourcemanager.StandaloneResourceManager  - Request slot with profile ResourceProfile{UNKNOWN} &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job 411378b9f7181f9ba431960b08b701d7 with allocation id 0e5171488810f0cc1c3265e9b278bb17.
...
18740 [dispatcher-3] INFO  o.a.f.r.resourcemanager.slotmanager.SlotManagerImpl  - Suspending the SlotManager.
18740 [dispatcher-5] INFO  o.a.f.r.jobmaster.slotpool.SlotPoolImpl  - Failing pending slot request [SlotRequestId{7a9512bdaf255cc687212211142abd4b}]: The slot manager is being suspended.
...
18750 [dispatcher-5] INFO  o.a.f.r.executiongraph.ExecutionGraph  - blocking &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; (1/1) (927b48379633675aad810f12af2470a6) switched from SCHEDULED to FAILED.
java.util.concurrent.CompletionException: o.a.f.r.resourcemanager.slotmanager.SlotManagerException: The slot manager is being suspended.
...
18750 [dispatcher-5] INFO  o.a.f.r.executiongraph.ExecutionGraph  - Job Blocking test job (411378b9f7181f9ba431960b08b701d7) switched from state RUNNING to FAILING.
o.a.f.r.JobException: Recovery is suppressed by NoRestartBackoffTimeStrategy
Caused by: java.util.concurrent.CompletionException: o.a.f.r.resourcemanager.slotmanager.SlotManagerException: The slot manager is being suspended.
...
18760 [dispatcher-5] INFO  o.a.f.r.executiongraph.ExecutionGraph  - Job Blocking test job (411378b9f7181f9ba431960b08b701d7) switched from state FAILING to FAILED.
o.a.f.r.JobException: Recovery is suppressed by NoRestartBackoffTimeStrategy
Caused by: java.util.concurrent.CompletionException: o.a.f.r.resourcemanager.slotmanager.SlotManagerException: The slot manager is being suspended.
...
18765 [jobmanager-&lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;-thread-2] DEBUG o.a.f.r.jobmaster.JobManagerRunnerImpl  - Job 411378b9f7181f9ba431960b08b701d7 reached globally terminal state FAILED.
18765 [jobmanager-&lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;-thread-2] DEBUG o.a.f.r.jobmaster.JobManagerRunnerImpl  - Unregistering job from 411378b9f7181f9ba431960b08b701d7 from high-availability.
18765 [jobmanager-&lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;-thread-2] DEBUG o.a.f.r.highavailability.zookeeper.ZooKeeperRunningJobsRegistry  - Setting scheduling state to DONE &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job 411378b9f7181f9ba431960b08b701d7.
...
18770 [mini-cluster-io-thread-2] INFO  o.a.f.r.jobmanager.ZooKeeperJobGraphStore  - Recovered JobGraph(jobId: 411378b9f7181f9ba431960b08b701d7).
18770 [mini-cluster-io-thread-2] INFO  o.a.f.r.dispatcher.runner.SessionDispatcherLeaderProcess  - Successfully recovered 1 persisted job graphs.
...
23748 [main-EventThread] INFO  o.a.f.r.jobmaster.JobManagerRunnerImpl  - Granted leader ship but job 411378b9f7181f9ba431960b08b701d7 has been finished.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;From what I can tell the shutdown logic should be adjusted to first shutdown the JobMaster before shutting down any service the JM may be relying on.&lt;br/&gt;
Unfortunately the shutdown logic is one of the most obfuscated things I have seen in a while, and I can&apos;t make heads-or-tails of how it is even supposed to work.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt; WDYT?&lt;/p&gt;</comment>
                            <comment id="17021079" author="zentol" created="Wed, 22 Jan 2020 13:55:57 +0000"  >&lt;p&gt;master: fbc1ef716f8485f9fe0e9e177902a2345af3ac9d&lt;br/&gt;
1.10: 2dd322fbd77f822784c32c06e21e946ee379c377&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13219834">FLINK-11835</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 42 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z09gvk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>