<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:57:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-22682] Checkpoint interval too large for higher DOP</title>
                <link>https://issues.apache.org/jira/browse/FLINK-22682</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When running a job on EMR with DOP of 160, checkpoints are not triggered at the set interval. I used an interval of 10s and the average checkpoint took &amp;lt;10s, so I&apos;d expect ~6 checkpoints per minute.&lt;br/&gt;
However, the actual completion message was heavily delayed. I had backpressure in this test and used unaligned checkpoints.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2021-05-14 10:06:39,182 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 1 for job 58df7eb721aaefbfb08168b2c3fd6717 (8940061335 bytes in 9097 ms).
2021-05-14 10:06:39,205 INFO  org.apache.flink.runtime.source.coordinator.SourceCoordinator [] - Marking checkpoint 1 as completed for source Source: Sequence Source -&amp;gt; Map.
2021-05-14 10:06:40,223 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Triggering checkpoint 2 (type=CHECKPOINT) @ 1620986800082 for job 58df7eb721aaefbfb08168b2c3fd6717.
2021-05-14 10:07:49,263 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 2 for job 58df7eb721aaefbfb08168b2c3fd6717 (8286704522 bytes in 6490 ms).
2021-05-14 10:07:49,281 INFO  org.apache.flink.runtime.source.coordinator.SourceCoordinator [] - Marking checkpoint 2 as completed for source Source: Sequence Source -&amp;gt; Map.
2021-05-14 10:07:49,443 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Triggering checkpoint 3 (type=CHECKPOINT) @ 1620986869281 for job 58df7eb721aaefbfb08168b2c3fd6717.
2021-05-14 10:08:55,679 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 3 for job 58df7eb721aaefbfb08168b2c3fd6717 (7398457668 bytes in 6182 ms).
2021-05-14 10:08:55,694 INFO  org.apache.flink.runtime.source.coordinator.SourceCoordinator [] - Marking checkpoint 3 as completed for source Source: Sequence Source -&amp;gt; Map.
2021-05-14 10:08:55,820 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Triggering checkpoint 4 (type=CHECKPOINT) @ 1620986935694 for job 58df7eb721aaefbfb08168b2c3fd6717.
2021-05-14 10:09:58,024 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 4 for job 58df7eb721aaefbfb08168b2c3fd6717 (7402199053 bytes in 6179 ms).
2021-05-14 10:09:58,035 INFO  org.apache.flink.runtime.source.coordinator.SourceCoordinator [] - Marking checkpoint 4 as completed for source Source: Sequence Source -&amp;gt; Map.
2021-05-14 10:09:58,154 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Triggering checkpoint 5 (type=CHECKPOINT) @ 1620986998035 for job 58df7eb721aaefbfb08168b2c3fd6717.
2021-05-14 10:11:02,694 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 5 for job 58df7eb721aaefbfb08168b2c3fd6717 (7395692776 bytes in 6788 ms).
2021-05-14 10:11:02,705 INFO  org.apache.flink.runtime.source.coordinator.SourceCoordinator [] - Marking checkpoint 5 as completed for source Source: Sequence Source -&amp;gt; Map.
2021-05-14 10:11:02,830 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Triggering checkpoint 6 (type=CHECKPOINT) @ 1620987062705 for job 58df7eb721aaefbfb08168b2c3fd6717.
2021-05-14 10:12:05,043 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 6 for job 58df7eb721aaefbfb08168b2c3fd6717 (7388207757 bytes in 6025 ms).
2021-05-14 10:12:05,054 INFO  org.apache.flink.runtime.source.coordinator.SourceCoordinator [] - Marking checkpoint 6 as completed for source Source: Sequence Source -&amp;gt; Map.
2021-05-14 10:12:05,182 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Triggering checkpoint 7 (type=CHECKPOINT) @ 1620987125054 for job 58df7eb721aaefbfb08168b2c3fd6717.
2021-05-14 10:13:04,754 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 7 for job 58df7eb721aaefbfb08168b2c3fd6717 (7360227162 bytes in 6469 ms).
2021-05-14 10:13:04,779 INFO  org.apache.flink.runtime.source.coordinator.SourceCoordinator [] - Marking checkpoint 7 as completed for source Source: Sequence Source -&amp;gt; Map.
2021-05-14 10:13:04,902 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Triggering checkpoint 8 (type=CHECKPOINT) @ 1620987184779 for job 58df7eb721aaefbfb08168b2c3fd6717.
2021-05-14 10:14:05,486 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 8 for job 58df7eb721aaefbfb08168b2c3fd6717 (7110043004 bytes in 5982 ms).
2021-05-14 10:14:05,495 INFO  org.apache.flink.runtime.source.coordinator.SourceCoordinator [] - Marking checkpoint 8 as completed for source Source: Sequence Source -&amp;gt; Map.
2021-05-14 10:14:05,636 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Triggering checkpoint 9 (type=CHECKPOINT) @ 1620987245495 for job 58df7eb721aaefbfb08168b2c3fd6717.
2021-05-14 10:15:09,160 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 9 for job 58df7eb721aaefbfb08168b2c3fd6717 (7306603281 bytes in 7096 ms).
2021-05-14 10:15:09,171 INFO  org.apache.flink.runtime.source.coordinator.SourceCoordinator [] - Marking checkpoint 9 as completed for source Source: Sequence Source -&amp;gt; Map.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13378762">FLINK-22682</key>
            <summary>Checkpoint interval too large for higher DOP</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10004">Not A Bug</resolution>
                                        <assignee username="akalashnikov">Anton Kalashnikov</assignee>
                                    <reporter username="arvid">Arvid Heise</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 17 May 2021 09:16:26 +0000</created>
                <updated>Thu, 23 Sep 2021 17:25:25 +0000</updated>
                            <resolved>Thu, 17 Jun 2021 11:57:48 +0000</resolved>
                                    <version>1.14.0</version>
                    <version>1.13.1</version>
                                    <fixVersion>1.14.0</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17346114" author="pnowojski" created="Mon, 17 May 2021 12:07:22 +0000"  >&lt;p&gt;Based on the discrepancy between the logged checkpoint duration, and the actual time when &quot;Triggering checkpoint&quot; and &quot;Completed checkpoint&quot; messages were being logged:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2021-05-14 10:14:05,636 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Triggering checkpoint 9 (type=CHECKPOINT) @ 1620987245495 for job 58df7eb721aaefbfb08168b2c3fd6717.
2021-05-14 10:15:09,160 INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Completed checkpoint 9 for job 58df7eb721aaefbfb08168b2c3fd6717 (7306603281 bytes in 7096 ms).
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;(7s vs 1+ minute)&lt;br/&gt;
and the fact that &quot;duration&quot; timer starts ticking before &quot;Triggering checkpoint&quot; is logged, it looks like the problem is that something between stopping the timer in &lt;tt&gt;PendingCheckpoint#finalizeCheckpoint&lt;/tt&gt; and logging &quot;Completed checkpoint&quot; is taking long time. Those are the methods that are being called between those two events on the happy path:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
failureManager.handleCheckpointSuccess(pendingCheckpoint.getCheckpointId());
(...)
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    completedCheckpointStore.addCheckpoint(...)
    (...)
} &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
    pendingCheckpoints.remove(checkpointId);
    scheduleTriggerRequest();
}
rememberRecentCheckpointId(checkpointId);
&lt;span class=&quot;code-comment&quot;&gt;// drop those pending checkpoints that are at prior to the completed one
&lt;/span&gt;dropSubsumedCheckpoints(checkpointId);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;From those, the most likely culprit seems to be &lt;tt&gt;completedCheckpointStore.addCheckpoint&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17346691" author="till.rohrmann" created="Tue, 18 May 2021 08:28:55 +0000"  >&lt;p&gt;The &lt;tt&gt;DefaultCompletedCheckpointStore&lt;/tt&gt; should log &lt;tt&gt;&quot;Added {} to {}&quot;, checkpoint, path&lt;/tt&gt; once it added the checkpoint on debug. This could help verifying the suspicion.&lt;/p&gt;</comment>
                            <comment id="17357417" author="akalashnikov" created="Fri, 4 Jun 2021 15:15:51 +0000"  >&lt;p&gt;Intermediate feedback from me:&lt;/p&gt;

&lt;p&gt;First of all, this situation happens only when state.backend = filesystem. So for reproducing this scenario you need following params:&lt;/p&gt;

&lt;p&gt;state.backend: filesystem (or state.checkpoint-storage: filesystem)&lt;br/&gt;
state.checkpoints.dir: s3://...&lt;br/&gt;
taskmanager.network.memory.fraction: 0.5&lt;/p&gt;

&lt;p&gt;The delay happens here org.apache.flink.runtime.checkpoint.CompletedCheckpoint#discardOnSubsume:&lt;br/&gt;
OperatorSubtaskState contains FileStateHandle which call fileSystem#delete(S3FileSystem) on discardState and that take a while.&lt;/p&gt;

&lt;p&gt;Just for example, my numbers which I received in reproducer:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Checkpoint time in log: 6189 ms&lt;/li&gt;
	&lt;li&gt;Actual checkpoint time: ~19000 ms&lt;/li&gt;
	&lt;li&gt;FileStateHandle#discardState time : 30-60 ms(sometimes up to 100ms) Size depended - 446984 bytes - ~31ms | 2180843 bytes - ~117ms&lt;/li&gt;
	&lt;li&gt;Number of FileStateHandle objects: ~200&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I have not checked yet how fast should normally work S3FileSystem#delete(when the load is less intensive) so if anybody has a clue about it, please, share with me.&lt;/p&gt;

&lt;p&gt;Right now, I think that it is defenetly make sense to expand/change the log in such a way: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Completed checkpoint \{\} &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job \{} (\{\} bytes in \{realTotalTime\} ms).&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;or&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Completed checkpoint \{\} &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job \{} (\{\} bytes, executionTime=\{currentTime\} ms, finalizationTime=\{timeWhichWeLostNow\} ms).&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;About FileStateHandle#discardState, we need to think about how big the problem is because on one hand it is pretty expected that IO gives some degradation, on the other hand, perhaps it is slower than expected and we somehow want to optimize it(batch delete, etc.)&lt;/p&gt;</comment>
                            <comment id="17357588" author="pnowojski" created="Fri, 4 Jun 2021 19:41:52 +0000"  >&lt;p&gt;Thanks for confirming this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=akalashnikov&quot; class=&quot;user-hover&quot; rel=&quot;akalashnikov&quot;&gt;akalashnikov&lt;/a&gt;. I agree that let&apos;s expand logging with something like:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Completed checkpoint \{\} for job \{} (\{\} bytes, checkpointDuration=\{duration\} ms, finalizationTime=\{timeWhichWeAreMissingNow\} ms).
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17359943" author="roman_khachatryan" created="Wed, 9 Jun 2021 11:02:08 +0000"  >&lt;p&gt;Extended logging merged into master as e167068ce6c5a34b46b83d2fe7e29f0341821f1d.&lt;/p&gt;

&lt;p&gt;I don&apos;t think this should be backported to 1.13 (as it&apos;s not a bugfix); nor should we adjust logging any further before getting some feedback.&lt;/p&gt;

&lt;p&gt;So I&apos;d just close (resolve) this issue.&lt;/p&gt;</comment>
                            <comment id="17364900" author="pnowojski" created="Thu, 17 Jun 2021 11:57:48 +0000"  >&lt;p&gt;Thanks for taking care of this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=akalashnikov&quot; class=&quot;user-hover&quot; rel=&quot;akalashnikov&quot;&gt;akalashnikov&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;. Close this as not a bug - better logging merged to master as described above.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13252989">FLINK-13856</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13306403">FLINK-17860</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0r348:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>