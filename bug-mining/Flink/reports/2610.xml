<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:34:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10115] Content-length limit is also applied to FileUploads</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10115</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Uploading jar files via WEB UI not working. After &lt;tt&gt;initializing upload...&lt;/tt&gt;&#160;it only shows &lt;tt&gt;saving...&lt;/tt&gt;&#160;and file never shows up on UI to be able to submit it&lt;/p&gt;</description>
                <environment></environment>
        <key id="13178034">FLINK-10115</key>
            <summary>Content-length limit is also applied to FileUploads</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chesnay">Chesnay Schepler</assignee>
                                    <reporter username="yazdanjs">Yazdan Shirvany</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 9 Aug 2018 15:45:00 +0000</created>
                <updated>Wed, 2 Oct 2019 17:47:42 +0000</updated>
                            <resolved>Mon, 3 Sep 2018 11:39:59 +0000</resolved>
                                    <version>1.5.1</version>
                    <version>1.6.0</version>
                    <version>1.7.0</version>
                                    <fixVersion>1.5.4</fixVersion>
                    <fixVersion>1.6.1</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                                    <component>Runtime / REST</component>
                    <component>Runtime / Web Frontend</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16577934" author="zentol" created="Mon, 13 Aug 2018 08:01:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yazdanjs&quot; class=&quot;user-hover&quot; rel=&quot;yazdanjs&quot;&gt;yazdanjs&lt;/a&gt; Did you encounter this issue with 1.6.0?&lt;/p&gt;</comment>
                            <comment id="16581087" author="yazdanjs" created="Wed, 15 Aug 2018 13:48:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; yes, this issue is only for 1.6.0. haven&apos;t seen it for other versions.&lt;/p&gt;

&lt;p&gt;and it&apos;s a blocker for working with Web UI.&lt;/p&gt;</comment>
                            <comment id="16585906" author="enchom" created="Mon, 20 Aug 2018 13:09:19 +0000"  >&lt;p&gt;Having the same problem here with 1.6.0, but only for large .jar files (over 100MB). Smaller&#160;jars get uploaded fine.&lt;/p&gt;</comment>
                            <comment id="16587160" author="zentol" created="Tue, 21 Aug 2018 08:35:42 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enchom&quot; class=&quot;user-hover&quot; rel=&quot;enchom&quot;&gt;enchom&lt;/a&gt; for the hint regarding the file size, could reproduce this locally.&lt;/p&gt;</comment>
                            <comment id="16587270" author="zentol" created="Tue, 21 Aug 2018 10:34:17 +0000"  >&lt;p&gt;The problem is that the server-side content-length limit is also applied to file uploads, which shouldn&apos;t happen.&lt;/p&gt;

&lt;p&gt;As a temporary workaround you can increase &lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-master/ops/config.html#rest-server-max-content-length&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.apache.org/projects/flink/flink-docs-master/ops/config.html#rest-server-max-content-length&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16587279" author="githubbot" created="Tue, 21 Aug 2018 10:49:48 +0000"  >&lt;p&gt;zentol opened a new pull request #6595: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10115&quot; title=&quot;Content-length limit is also applied to FileUploads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10115&quot;&gt;&lt;del&gt;FLINK-10115&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;rest&amp;#93;&lt;/span&gt; Ignore content-length limit for file uploads &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6595&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6595&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   With this PR the server-side content-length limit (configurable via `rest.server.max-content-length`, enforced by the `HttpObjectAggregator`) is no longer applied to file uploads.&lt;/p&gt;

&lt;p&gt;   File uploads are handle before the aggregator is active; in fact the contents of the files are not visible to the aggregator, thus the aggregator should be a no-op. We however never sanitized the headers to actually reflect this, i.e. the `content-length` header may still be set to the size of the file, and the `content-type` header may still claim to be a `multipart` request.&lt;/p&gt;

&lt;p&gt;   Both headers are now properly updated after the `FileUploadHandler` finishes processing the file upload.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul&gt;
	&lt;li&gt;add a number of trace logging messages to better track what the FileUploadHandler is doing&lt;/li&gt;
	&lt;li&gt;update headers in `FileUploadHandler` when processing has finished&lt;/li&gt;
	&lt;li&gt;if the multipart request also contained a JSON payload then `content-length` will be set to the size of the serialized json payload, and `content-type` to our default JSON content-type.&lt;/li&gt;
	&lt;li&gt;if the multipart request did not contain a JSON payload then `content-length` will be 0 with no `content-type`.&lt;/li&gt;
	&lt;li&gt;set server-side limit in `MultipartUploadResource` to 1mb, which is significantly lower than the to-be-uploaded file (64mb)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   The `MultipartUploadResource` was modified to set the server-side limit to a&lt;/p&gt;

&lt;p&gt;   &lt;b&gt;(Please pick either of the following options)&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;   This change is a trivial rework / code cleanup without any test coverage.&lt;/p&gt;

&lt;p&gt;   &lt;b&gt;(or)&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;   This change is already covered by existing tests that use the `MultipartUploadResource`.&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16587282" author="githubbot" created="Tue, 21 Aug 2018 10:50:58 +0000"  >&lt;p&gt;zentol commented on a change in pull request #6595: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10115&quot; title=&quot;Content-length limit is also applied to FileUploads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10115&quot;&gt;&lt;del&gt;FLINK-10115&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;rest&amp;#93;&lt;/span&gt; Ignore content-length limit for file uploads &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6595#discussion_r211561089&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6595#discussion_r211561089&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/rest/FileUploadHandler.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -134,12 +140,18 @@ protected void channelRead0(final ChannelHandlerContext ctx, final HttpObject ms&lt;br/&gt;
 				}&lt;/p&gt;

&lt;p&gt; 				if (httpContent instanceof LastHttpContent) {&lt;br/&gt;
+					LOG.trace(&quot;Finalizing multipart file upload.&quot;);&lt;br/&gt;
 					ctx.channel().attr(UPLOADED_FILES).set(new FileUploads(currentUploadDir));&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ctx.fireChannelRead(currentHttpRequest);&lt;br/&gt;
 					if (currentJsonPayload != null) 
{
+						currentHttpRequest.headers().set(HttpHeaders.Names.CONTENT_LENGTH, currentJsonPayload.length);
+						currentHttpRequest.headers().set(HttpHeaders.Names.CONTENT_TYPE, RestConstants.REST_CONTENT_TYPE);
+						ctx.fireChannelRead(currentHttpRequest);
 						ctx.fireChannelRead(httpContent.replace(Unpooled.wrappedBuffer(currentJsonPayload)));
 					}
&lt;p&gt; else {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;ctx.fireChannelRead(ReferenceCountUtil.retain(httpContent));&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Forwarding a single httpContent object that may or may not contain content always seemed fishy to me, so we now always send an `EMPTY_LAST_CONTENT` object instead.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16598721" author="githubbot" created="Fri, 31 Aug 2018 13:17:56 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6595: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10115&quot; title=&quot;Content-length limit is also applied to FileUploads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10115&quot;&gt;&lt;del&gt;FLINK-10115&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;rest&amp;#93;&lt;/span&gt; Ignore content-length limit for file uploads &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6595#discussion_r214305773&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6595#discussion_r214305773&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/rest/FileUploadHandler.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -134,12 +140,18 @@ protected void channelRead0(final ChannelHandlerContext ctx, final HttpObject ms&lt;br/&gt;
 				}&lt;/p&gt;

&lt;p&gt; 				if (httpContent instanceof LastHttpContent) {&lt;br/&gt;
+					LOG.trace(&quot;Finalizing multipart file upload.&quot;);&lt;br/&gt;
 					ctx.channel().attr(UPLOADED_FILES).set(new FileUploads(currentUploadDir));&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ctx.fireChannelRead(currentHttpRequest);&lt;br/&gt;
 					if (currentJsonPayload != null) {&lt;br/&gt;
+						currentHttpRequest.headers().set(HttpHeaders.Names.CONTENT_LENGTH, currentJsonPayload.length);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Why don&apos;t we use `HttpHeaderNames.CONTENT_LENGTH` here. `HttpHeaders.Names` is deprecated.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16598823" author="githubbot" created="Fri, 31 Aug 2018 15:11:57 +0000"  >&lt;p&gt;zentol commented on a change in pull request #6595: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10115&quot; title=&quot;Content-length limit is also applied to FileUploads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10115&quot;&gt;&lt;del&gt;FLINK-10115&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;rest&amp;#93;&lt;/span&gt; Ignore content-length limit for file uploads &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6595#discussion_r214386020&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6595#discussion_r214386020&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/rest/FileUploadHandler.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -134,12 +140,18 @@ protected void channelRead0(final ChannelHandlerContext ctx, final HttpObject ms&lt;br/&gt;
 				}&lt;/p&gt;

&lt;p&gt; 				if (httpContent instanceof LastHttpContent) {&lt;br/&gt;
+					LOG.trace(&quot;Finalizing multipart file upload.&quot;);&lt;br/&gt;
 					ctx.channel().attr(UPLOADED_FILES).set(new FileUploads(currentUploadDir));&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ctx.fireChannelRead(currentHttpRequest);&lt;br/&gt;
 					if (currentJsonPayload != null) {&lt;br/&gt;
+						currentHttpRequest.headers().set(HttpHeaders.Names.CONTENT_LENGTH, currentJsonPayload.length);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   to keep the code identical between 1.5 and 1.6.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16598828" author="githubbot" created="Fri, 31 Aug 2018 15:14:46 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6595: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10115&quot; title=&quot;Content-length limit is also applied to FileUploads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10115&quot;&gt;&lt;del&gt;FLINK-10115&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;rest&amp;#93;&lt;/span&gt; Ignore content-length limit for file uploads &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6595#discussion_r214386889&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6595#discussion_r214386889&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/rest/FileUploadHandler.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -134,12 +140,18 @@ protected void channelRead0(final ChannelHandlerContext ctx, final HttpObject ms&lt;br/&gt;
 				}&lt;/p&gt;

&lt;p&gt; 				if (httpContent instanceof LastHttpContent) {&lt;br/&gt;
+					LOG.trace(&quot;Finalizing multipart file upload.&quot;);&lt;br/&gt;
 					ctx.channel().attr(UPLOADED_FILES).set(new FileUploads(currentUploadDir));&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ctx.fireChannelRead(currentHttpRequest);&lt;br/&gt;
 					if (currentJsonPayload != null) {&lt;br/&gt;
+						currentHttpRequest.headers().set(HttpHeaders.Names.CONTENT_LENGTH, currentJsonPayload.length);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Ok, good point&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16601875" author="githubbot" created="Mon, 3 Sep 2018 08:23:04 +0000"  >&lt;p&gt;zentol closed pull request #6595: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10115&quot; title=&quot;Content-length limit is also applied to FileUploads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10115&quot;&gt;&lt;del&gt;FLINK-10115&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;rest&amp;#93;&lt;/span&gt; Ignore content-length limit for file uploads &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6595&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6595&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/rest/AbstractHandler.java b/flink-runtime/src/main/java/org/apache/flink/runtime/rest/AbstractHandler.java&lt;br/&gt;
index 0d8605abc99..3d1ec9d0066 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/rest/AbstractHandler.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/rest/AbstractHandler.java&lt;br/&gt;
@@ -145,6 +145,7 @@ protected void respondAsLeader(ChannelHandlerContext ctx, RoutedRequest routedRe&lt;br/&gt;
 					hre);&lt;br/&gt;
 			}&lt;/p&gt;

&lt;p&gt;+			log.trace(&quot;Starting request processing.&quot;);&lt;br/&gt;
 			CompletableFuture&amp;lt;Void&amp;gt; requestProcessingFuture = respondToRequest(&lt;br/&gt;
 				ctx,&lt;br/&gt;
 				httpRequest,&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/rest/FileUploadHandler.java b/flink-runtime/src/main/java/org/apache/flink/runtime/rest/FileUploadHandler.java&lt;br/&gt;
index d6287507697..7c46af04b55 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/rest/FileUploadHandler.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/rest/FileUploadHandler.java&lt;br/&gt;
@@ -21,6 +21,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.rest.handler.FileUploads;&lt;br/&gt;
 import org.apache.flink.runtime.rest.handler.util.HandlerUtils;&lt;br/&gt;
 import org.apache.flink.runtime.rest.messages.ErrorResponseBody;&lt;br/&gt;
+import org.apache.flink.runtime.rest.util.RestConstants;&lt;br/&gt;
 import org.apache.flink.util.FileUtils;&lt;/p&gt;

&lt;p&gt; import org.apache.flink.shaded.netty4.io.netty.buffer.Unpooled;&lt;br/&gt;
@@ -29,6 +30,7 @@&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.channel.ChannelPipeline;&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.channel.SimpleChannelInboundHandler;&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.handler.codec.http.HttpContent;&lt;br/&gt;
+import org.apache.flink.shaded.netty4.io.netty.handler.codec.http.HttpHeaders;&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.handler.codec.http.HttpMethod;&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.handler.codec.http.HttpObject;&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.handler.codec.http.HttpRequest;&lt;br/&gt;
@@ -94,6 +96,7 @@ protected void channelRead0(final ChannelHandlerContext ctx, final HttpObject ms&lt;br/&gt;
 				LOG.trace(&quot;Received request. URL:{} Method:{}&quot;, httpRequest.getUri(), httpRequest.getMethod());&lt;br/&gt;
 				if (httpRequest.getMethod().equals(HttpMethod.POST)) {&lt;br/&gt;
 					if (HttpPostRequestDecoder.isMultipart(httpRequest)) &lt;/p&gt;
{
+						LOG.trace(&quot;Initializing multipart file upload.&quot;);
 						checkState(currentHttpPostRequestDecoder == null);
 						checkState(currentHttpRequest == null);
 						checkState(currentUploadDir == null);
@@ -107,6 +110,7 @@ protected void channelRead0(final ChannelHandlerContext ctx, final HttpObject ms
 					ctx.fireChannelRead(ReferenceCountUtil.retain(msg));
 				}
&lt;p&gt; 			} else if (msg instanceof HttpContent &amp;amp;&amp;amp; currentHttpPostRequestDecoder != null) {&lt;br/&gt;
+				LOG.trace(&quot;Received http content.&quot;);&lt;br/&gt;
 				// make sure that we still have a upload dir in case that it got deleted in the meanwhile&lt;br/&gt;
 				RestServerEndpoint.createUploadDir(uploadDir, LOG);&lt;/p&gt;

&lt;p&gt;@@ -121,9 +125,11 @@ protected void channelRead0(final ChannelHandlerContext ctx, final HttpObject ms&lt;/p&gt;

&lt;p&gt; 						final Path dest = currentUploadDir.resolve(fileUpload.getFilename());&lt;br/&gt;
 						fileUpload.renameTo(dest.toFile());&lt;br/&gt;
+						LOG.trace(&quot;Upload of file {} complete.&quot;, fileUpload.getFilename());&lt;br/&gt;
 					} else if (data.getHttpDataType() == InterfaceHttpData.HttpDataType.Attribute) {&lt;br/&gt;
 						final Attribute request = (Attribute) data;&lt;br/&gt;
 						// this could also be implemented by using the first found Attribute as the payload&lt;br/&gt;
+						LOG.trace(&quot;Upload of attribute {} complete.&quot;, request.getName());&lt;br/&gt;
 						if (data.getName().equals(HTTP_ATTRIBUTE_REQUEST)) &lt;/p&gt;
{
 							currentJsonPayload = request.get();
 						}
&lt;p&gt; else &lt;/p&gt;
{
@@ -134,12 +140,18 @@ protected void channelRead0(final ChannelHandlerContext ctx, final HttpObject ms
 				}

&lt;p&gt; 				if (httpContent instanceof LastHttpContent) {&lt;br/&gt;
+					LOG.trace(&quot;Finalizing multipart file upload.&quot;);&lt;br/&gt;
 					ctx.channel().attr(UPLOADED_FILES).set(new FileUploads(currentUploadDir));&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ctx.fireChannelRead(currentHttpRequest);&lt;br/&gt;
 					if (currentJsonPayload != null) 
{
+						currentHttpRequest.headers().set(HttpHeaders.Names.CONTENT_LENGTH, currentJsonPayload.length);
+						currentHttpRequest.headers().set(HttpHeaders.Names.CONTENT_TYPE, RestConstants.REST_CONTENT_TYPE);
+						ctx.fireChannelRead(currentHttpRequest);
 						ctx.fireChannelRead(httpContent.replace(Unpooled.wrappedBuffer(currentJsonPayload)));
 					}
&lt;p&gt; else &lt;/p&gt;
{
-						ctx.fireChannelRead(ReferenceCountUtil.retain(httpContent));
+						currentHttpRequest.headers().set(HttpHeaders.Names.CONTENT_LENGTH, 0);
+						currentHttpRequest.headers().remove(HttpHeaders.Names.CONTENT_TYPE);
+						ctx.fireChannelRead(currentHttpRequest);
+						ctx.fireChannelRead(LastHttpContent.EMPTY_LAST_CONTENT);
 					}
&lt;p&gt; 					reset();&lt;br/&gt;
 				}&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/rest/MultipartUploadResource.java b/flink-runtime/src/test/java/org/apache/flink/runtime/rest/MultipartUploadResource.java&lt;br/&gt;
index 0153d5dd31a..c350393371a 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/test/java/org/apache/flink/runtime/rest/MultipartUploadResource.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/rest/MultipartUploadResource.java&lt;br/&gt;
@@ -102,6 +102,8 @@ public void before() throws Exception {&lt;br/&gt;
 		Configuration config = new Configuration();&lt;br/&gt;
 		config.setInteger(RestOptions.PORT, 0);&lt;br/&gt;
 		config.setString(RestOptions.ADDRESS, &quot;localhost&quot;);&lt;br/&gt;
+		// set this to a lower value on purpose to test that files larger than the content limit are still accepted&lt;br/&gt;
+		config.setInteger(RestOptions.SERVER_MAX_CONTENT_LENGTH, 1024 * 1024);&lt;br/&gt;
 		configuredUploadDir = temporaryFolder.newFolder().toPath();&lt;br/&gt;
 		config.setString(WebOptions.UPLOAD_DIR, configuredUploadDir.toString());&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;






&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16601878" author="githubbot" created="Mon, 3 Sep 2018 08:24:51 +0000"  >&lt;p&gt;zentol opened a new pull request #6650: &lt;span class=&quot;error&quot;&gt;&amp;#91;1.6&amp;#93;&lt;/span&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10115&quot; title=&quot;Content-length limit is also applied to FileUploads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10115&quot;&gt;&lt;del&gt;FLINK-10115&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;rest&amp;#93;&lt;/span&gt; Ignore content-length limit for FileUploads &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6650&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Back-port of #6595 for 1.6 .&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16601890" author="githubbot" created="Mon, 3 Sep 2018 08:30:58 +0000"  >&lt;p&gt;zentol opened a new pull request #6651: &lt;span class=&quot;error&quot;&gt;&amp;#91;1.5&amp;#93;&lt;/span&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10115&quot; title=&quot;Content-length limit is also applied to FileUploads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10115&quot;&gt;&lt;del&gt;FLINK-10115&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;rest&amp;#93;&lt;/span&gt; Ignore content-length limit for FileUploads &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6651&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6651&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Back-port of #6595 for 1.5 .&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16601930" author="zentol" created="Mon, 3 Sep 2018 09:20:07 +0000"  >&lt;p&gt;master: b01aff35ec133b028c390341ca22e21bf7e13786&lt;/p&gt;</comment>
                            <comment id="16602062" author="githubbot" created="Mon, 3 Sep 2018 11:39:23 +0000"  >&lt;p&gt;zentol closed pull request #6650: &lt;span class=&quot;error&quot;&gt;&amp;#91;1.6&amp;#93;&lt;/span&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10115&quot; title=&quot;Content-length limit is also applied to FileUploads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10115&quot;&gt;&lt;del&gt;FLINK-10115&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;rest&amp;#93;&lt;/span&gt; Ignore content-length limit for FileUploads &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6650&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/rest/AbstractHandler.java b/flink-runtime/src/main/java/org/apache/flink/runtime/rest/AbstractHandler.java&lt;br/&gt;
index 0d8605abc99..3d1ec9d0066 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/rest/AbstractHandler.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/rest/AbstractHandler.java&lt;br/&gt;
@@ -145,6 +145,7 @@ protected void respondAsLeader(ChannelHandlerContext ctx, RoutedRequest routedRe&lt;br/&gt;
 					hre);&lt;br/&gt;
 			}&lt;/p&gt;

&lt;p&gt;+			log.trace(&quot;Starting request processing.&quot;);&lt;br/&gt;
 			CompletableFuture&amp;lt;Void&amp;gt; requestProcessingFuture = respondToRequest(&lt;br/&gt;
 				ctx,&lt;br/&gt;
 				httpRequest,&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/rest/FileUploadHandler.java b/flink-runtime/src/main/java/org/apache/flink/runtime/rest/FileUploadHandler.java&lt;br/&gt;
index d6287507697..7c46af04b55 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/rest/FileUploadHandler.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/rest/FileUploadHandler.java&lt;br/&gt;
@@ -21,6 +21,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.rest.handler.FileUploads;&lt;br/&gt;
 import org.apache.flink.runtime.rest.handler.util.HandlerUtils;&lt;br/&gt;
 import org.apache.flink.runtime.rest.messages.ErrorResponseBody;&lt;br/&gt;
+import org.apache.flink.runtime.rest.util.RestConstants;&lt;br/&gt;
 import org.apache.flink.util.FileUtils;&lt;/p&gt;

&lt;p&gt; import org.apache.flink.shaded.netty4.io.netty.buffer.Unpooled;&lt;br/&gt;
@@ -29,6 +30,7 @@&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.channel.ChannelPipeline;&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.channel.SimpleChannelInboundHandler;&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.handler.codec.http.HttpContent;&lt;br/&gt;
+import org.apache.flink.shaded.netty4.io.netty.handler.codec.http.HttpHeaders;&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.handler.codec.http.HttpMethod;&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.handler.codec.http.HttpObject;&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.handler.codec.http.HttpRequest;&lt;br/&gt;
@@ -94,6 +96,7 @@ protected void channelRead0(final ChannelHandlerContext ctx, final HttpObject ms&lt;br/&gt;
 				LOG.trace(&quot;Received request. URL:{} Method:{}&quot;, httpRequest.getUri(), httpRequest.getMethod());&lt;br/&gt;
 				if (httpRequest.getMethod().equals(HttpMethod.POST)) {&lt;br/&gt;
 					if (HttpPostRequestDecoder.isMultipart(httpRequest)) &lt;/p&gt;
{
+						LOG.trace(&quot;Initializing multipart file upload.&quot;);
 						checkState(currentHttpPostRequestDecoder == null);
 						checkState(currentHttpRequest == null);
 						checkState(currentUploadDir == null);
@@ -107,6 +110,7 @@ protected void channelRead0(final ChannelHandlerContext ctx, final HttpObject ms
 					ctx.fireChannelRead(ReferenceCountUtil.retain(msg));
 				}
&lt;p&gt; 			} else if (msg instanceof HttpContent &amp;amp;&amp;amp; currentHttpPostRequestDecoder != null) {&lt;br/&gt;
+				LOG.trace(&quot;Received http content.&quot;);&lt;br/&gt;
 				// make sure that we still have a upload dir in case that it got deleted in the meanwhile&lt;br/&gt;
 				RestServerEndpoint.createUploadDir(uploadDir, LOG);&lt;/p&gt;

&lt;p&gt;@@ -121,9 +125,11 @@ protected void channelRead0(final ChannelHandlerContext ctx, final HttpObject ms&lt;/p&gt;

&lt;p&gt; 						final Path dest = currentUploadDir.resolve(fileUpload.getFilename());&lt;br/&gt;
 						fileUpload.renameTo(dest.toFile());&lt;br/&gt;
+						LOG.trace(&quot;Upload of file {} complete.&quot;, fileUpload.getFilename());&lt;br/&gt;
 					} else if (data.getHttpDataType() == InterfaceHttpData.HttpDataType.Attribute) {&lt;br/&gt;
 						final Attribute request = (Attribute) data;&lt;br/&gt;
 						// this could also be implemented by using the first found Attribute as the payload&lt;br/&gt;
+						LOG.trace(&quot;Upload of attribute {} complete.&quot;, request.getName());&lt;br/&gt;
 						if (data.getName().equals(HTTP_ATTRIBUTE_REQUEST)) &lt;/p&gt;
{
 							currentJsonPayload = request.get();
 						}
&lt;p&gt; else &lt;/p&gt;
{
@@ -134,12 +140,18 @@ protected void channelRead0(final ChannelHandlerContext ctx, final HttpObject ms
 				}

&lt;p&gt; 				if (httpContent instanceof LastHttpContent) {&lt;br/&gt;
+					LOG.trace(&quot;Finalizing multipart file upload.&quot;);&lt;br/&gt;
 					ctx.channel().attr(UPLOADED_FILES).set(new FileUploads(currentUploadDir));&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ctx.fireChannelRead(currentHttpRequest);&lt;br/&gt;
 					if (currentJsonPayload != null) 
{
+						currentHttpRequest.headers().set(HttpHeaders.Names.CONTENT_LENGTH, currentJsonPayload.length);
+						currentHttpRequest.headers().set(HttpHeaders.Names.CONTENT_TYPE, RestConstants.REST_CONTENT_TYPE);
+						ctx.fireChannelRead(currentHttpRequest);
 						ctx.fireChannelRead(httpContent.replace(Unpooled.wrappedBuffer(currentJsonPayload)));
 					}
&lt;p&gt; else &lt;/p&gt;
{
-						ctx.fireChannelRead(ReferenceCountUtil.retain(httpContent));
+						currentHttpRequest.headers().set(HttpHeaders.Names.CONTENT_LENGTH, 0);
+						currentHttpRequest.headers().remove(HttpHeaders.Names.CONTENT_TYPE);
+						ctx.fireChannelRead(currentHttpRequest);
+						ctx.fireChannelRead(LastHttpContent.EMPTY_LAST_CONTENT);
 					}
&lt;p&gt; 					reset();&lt;br/&gt;
 				}&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/rest/MultipartUploadResource.java b/flink-runtime/src/test/java/org/apache/flink/runtime/rest/MultipartUploadResource.java&lt;br/&gt;
index 0153d5dd31a..c350393371a 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/test/java/org/apache/flink/runtime/rest/MultipartUploadResource.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/rest/MultipartUploadResource.java&lt;br/&gt;
@@ -102,6 +102,8 @@ public void before() throws Exception {&lt;br/&gt;
 		Configuration config = new Configuration();&lt;br/&gt;
 		config.setInteger(RestOptions.PORT, 0);&lt;br/&gt;
 		config.setString(RestOptions.ADDRESS, &quot;localhost&quot;);&lt;br/&gt;
+		// set this to a lower value on purpose to test that files larger than the content limit are still accepted&lt;br/&gt;
+		config.setInteger(RestOptions.SERVER_MAX_CONTENT_LENGTH, 1024 * 1024);&lt;br/&gt;
 		configuredUploadDir = temporaryFolder.newFolder().toPath();&lt;br/&gt;
 		config.setString(WebOptions.UPLOAD_DIR, configuredUploadDir.toString());&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;






&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16602063" author="githubbot" created="Mon, 3 Sep 2018 11:39:27 +0000"  >&lt;p&gt;zentol closed pull request #6651: &lt;span class=&quot;error&quot;&gt;&amp;#91;1.5&amp;#93;&lt;/span&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10115&quot; title=&quot;Content-length limit is also applied to FileUploads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10115&quot;&gt;&lt;del&gt;FLINK-10115&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;rest&amp;#93;&lt;/span&gt; Ignore content-length limit for FileUploads &lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6651&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6651&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/rest/AbstractHandler.java b/flink-runtime/src/main/java/org/apache/flink/runtime/rest/AbstractHandler.java&lt;br/&gt;
index e8d93845107..0a0d833626e 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/rest/AbstractHandler.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/rest/AbstractHandler.java&lt;br/&gt;
@@ -141,6 +141,7 @@ protected void respondAsLeader(ChannelHandlerContext ctx, Routed routed, T gatew&lt;br/&gt;
 					hre);&lt;br/&gt;
 			}&lt;/p&gt;

&lt;p&gt;+			log.trace(&quot;Starting request processing.&quot;);&lt;br/&gt;
 			CompletableFuture&amp;lt;Void&amp;gt; requestProcessingFuture = respondToRequest(&lt;br/&gt;
 				ctx,&lt;br/&gt;
 				httpRequest,&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/rest/FileUploadHandler.java b/flink-runtime/src/main/java/org/apache/flink/runtime/rest/FileUploadHandler.java&lt;br/&gt;
index c58e86ed1b9..2fdaafaeee2 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/rest/FileUploadHandler.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/rest/FileUploadHandler.java&lt;br/&gt;
@@ -21,6 +21,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.rest.handler.FileUploads;&lt;br/&gt;
 import org.apache.flink.runtime.rest.handler.util.HandlerUtils;&lt;br/&gt;
 import org.apache.flink.runtime.rest.messages.ErrorResponseBody;&lt;br/&gt;
+import org.apache.flink.runtime.rest.util.RestConstants;&lt;br/&gt;
 import org.apache.flink.util.FileUtils;&lt;/p&gt;

&lt;p&gt; import org.apache.flink.shaded.netty4.io.netty.buffer.Unpooled;&lt;br/&gt;
@@ -30,6 +31,7 @@&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.channel.SimpleChannelInboundHandler;&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.handler.codec.http.DefaultLastHttpContent;&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.handler.codec.http.HttpContent;&lt;br/&gt;
+import org.apache.flink.shaded.netty4.io.netty.handler.codec.http.HttpHeaders;&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.handler.codec.http.HttpMethod;&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.handler.codec.http.HttpObject;&lt;br/&gt;
 import org.apache.flink.shaded.netty4.io.netty.handler.codec.http.HttpRequest;&lt;br/&gt;
@@ -97,6 +99,7 @@ protected void channelRead0(final ChannelHandlerContext ctx, final HttpObject ms&lt;br/&gt;
 				LOG.trace(&quot;Received request. URL:{} Method:{}&quot;, httpRequest.getUri(), httpRequest.getMethod());&lt;br/&gt;
 				if (httpRequest.getMethod().equals(HttpMethod.POST)) {&lt;br/&gt;
 					if (HttpPostRequestDecoder.isMultipart(httpRequest)) &lt;/p&gt;
{
+						LOG.trace(&quot;Initializing multipart file upload.&quot;);
 						checkState(currentHttpPostRequestDecoder == null);
 						checkState(currentHttpRequest == null);
 						checkState(currentUploadDir == null);
@@ -110,6 +113,7 @@ protected void channelRead0(final ChannelHandlerContext ctx, final HttpObject ms
 					ctx.fireChannelRead(ReferenceCountUtil.retain(msg));
 				}
&lt;p&gt; 			} else if (msg instanceof HttpContent &amp;amp;&amp;amp; currentHttpPostRequestDecoder != null) {&lt;br/&gt;
+				LOG.trace(&quot;Received http content.&quot;);&lt;br/&gt;
 				// make sure that we still have a upload dir in case that it got deleted in the meanwhile&lt;br/&gt;
 				RestServerEndpoint.createUploadDir(uploadDir, LOG);&lt;/p&gt;

&lt;p&gt;@@ -124,9 +128,11 @@ protected void channelRead0(final ChannelHandlerContext ctx, final HttpObject ms&lt;/p&gt;

&lt;p&gt; 						final Path dest = currentUploadDir.resolve(fileUpload.getFilename());&lt;br/&gt;
 						fileUpload.renameTo(dest.toFile());&lt;br/&gt;
+						LOG.trace(&quot;Upload of file {} complete.&quot;, fileUpload.getFilename());&lt;br/&gt;
 					} else if (data.getHttpDataType() == InterfaceHttpData.HttpDataType.Attribute) {&lt;br/&gt;
 						final Attribute request = (Attribute) data;&lt;br/&gt;
 						// this could also be implemented by using the first found Attribute as the payload&lt;br/&gt;
+						LOG.trace(&quot;Upload of attribute {} complete.&quot;, request.getName());&lt;br/&gt;
 						if (data.getName().equals(HTTP_ATTRIBUTE_REQUEST)) &lt;/p&gt;
{
 							currentJsonPayload = request.get();
 						}
&lt;p&gt; else &lt;/p&gt;
{
@@ -137,17 +143,23 @@ protected void channelRead0(final ChannelHandlerContext ctx, final HttpObject ms
 				}

&lt;p&gt; 				if (httpContent instanceof LastHttpContent) {&lt;br/&gt;
+					LOG.trace(&quot;Finalizing multipart file upload.&quot;);&lt;br/&gt;
 					ctx.channel().attr(UPLOADED_FILES).set(new FileUploads(currentUploadDir));&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ctx.fireChannelRead(currentHttpRequest);&lt;br/&gt;
 					if (currentJsonPayload != null) 
{
 						// the following lines behave similar to httpContent#replace in netty 4.1
 						// the only difference is that the validateHeaders flag isn&apos;t preserved
 						// this shouldn&apos;t be a problem since we only copy existing headers
 						DefaultLastHttpContent newContent = new DefaultLastHttpContent(Unpooled.wrappedBuffer(currentJsonPayload), false);
 						newContent.trailingHeaders().set(((LastHttpContent) httpContent).trailingHeaders());
+						currentHttpRequest.headers().set(HttpHeaders.Names.CONTENT_LENGTH, currentJsonPayload.length);
+						currentHttpRequest.headers().set(HttpHeaders.Names.CONTENT_TYPE, RestConstants.REST_CONTENT_TYPE);
+						ctx.fireChannelRead(currentHttpRequest);
 						ctx.fireChannelRead(newContent);
 					}
&lt;p&gt; else &lt;/p&gt;
{
-						ctx.fireChannelRead(ReferenceCountUtil.retain(httpContent));
+						currentHttpRequest.headers().set(HttpHeaders.Names.CONTENT_LENGTH, 0);
+						currentHttpRequest.headers().remove(HttpHeaders.Names.CONTENT_TYPE);
+						ctx.fireChannelRead(currentHttpRequest);
+						ctx.fireChannelRead(LastHttpContent.EMPTY_LAST_CONTENT);
 					}
&lt;p&gt; 					reset();&lt;br/&gt;
 				}&lt;br/&gt;
diff --git a/flink-runtime/src/test/java/org/apache/flink/runtime/rest/MultipartUploadResource.java b/flink-runtime/src/test/java/org/apache/flink/runtime/rest/MultipartUploadResource.java&lt;br/&gt;
index 0153d5dd31a..c350393371a 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/test/java/org/apache/flink/runtime/rest/MultipartUploadResource.java&lt;br/&gt;
+++ b/flink-runtime/src/test/java/org/apache/flink/runtime/rest/MultipartUploadResource.java&lt;br/&gt;
@@ -102,6 +102,8 @@ public void before() throws Exception {&lt;br/&gt;
 		Configuration config = new Configuration();&lt;br/&gt;
 		config.setInteger(RestOptions.PORT, 0);&lt;br/&gt;
 		config.setString(RestOptions.ADDRESS, &quot;localhost&quot;);&lt;br/&gt;
+		// set this to a lower value on purpose to test that files larger than the content limit are still accepted&lt;br/&gt;
+		config.setInteger(RestOptions.SERVER_MAX_CONTENT_LENGTH, 1024 * 1024);&lt;br/&gt;
 		configuredUploadDir = temporaryFolder.newFolder().toPath();&lt;br/&gt;
 		config.setString(WebOptions.UPLOAD_DIR, configuredUploadDir.toString());&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;






&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16602064" author="zentol" created="Mon, 3 Sep 2018 11:39:59 +0000"  >&lt;p&gt;1.5: 2dbed9bfa96c645e4d7a4e8166a76f78880f48d1&lt;br/&gt;
1.6: 994b18518fb1534f6a62491e5149770b8667f68e&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 11 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ww2f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>