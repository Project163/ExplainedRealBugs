<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:22:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-38286] MAP function with duplicate keys produces non-deterministic results</title>
                <link>https://issues.apache.org/jira/browse/FLINK-38286</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;b&gt;Summary&lt;/b&gt;&lt;br/&gt;
The MAP function exhibits non-deterministic behavior when duplicate keys are provided, returning different results across environments and test runs. This breaks reproducibility and can cause CI failures.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Description&quot;&gt;&lt;/a&gt;&lt;b&gt;Description&lt;/b&gt;&lt;/h3&gt;
&lt;h4&gt;&lt;a name=&quot;Problem&quot;&gt;&lt;/a&gt;Problem&lt;/h4&gt;

&lt;p&gt;The `MAP` function in Flink Table API/SQL produces inconsistent results when duplicate keys are provided. For example, `MAP&lt;span class=&quot;error&quot;&gt;&amp;#91;f0, f0, f0, f1&amp;#93;&lt;/span&gt;` where `f0=1` and `f1=2` should deterministically return `{1=2}` (last value wins), but sometimes returns `{1=1}` instead.&lt;/p&gt;
&lt;h4&gt;&lt;a name=&quot;RootCause&quot;&gt;&lt;/a&gt;Root Cause&lt;/h4&gt;

&lt;p&gt;The issue lies in the code generation logic in `ScalarOperatorGens.scala` (lines ~1510-1530). The current implementation uses:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val keyElements = elements
   .grouped(2)
   .map { &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Seq(key, value) =&amp;gt; (key, value) }
   .toSeq
   .groupBy(_._1)
   .map(_._2.last)
   .keys
   .toSeq&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;




&lt;p&gt;The problem is that `groupBy` returns a `Map`, and when we extract `.keys` and `.values`, the iteration order is &lt;em&gt;non-deterministic&lt;/em&gt;. This breaks the correspondence between `keyArray&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;` and `valueArray&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;` in the generated code.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;StepstoReproduce&quot;&gt;&lt;/a&gt;Steps to Reproduce&lt;/h3&gt;

&lt;p&gt;1. Run the `MapFunctionITCase` test with constant folding disabled&lt;br/&gt;
2. Execute the specific test case: `map(f0, f0, f0, f1)` where `f0=1, f1=2`&lt;br/&gt;
3. Observe that results vary between runs/environments&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Test Code:&lt;/b&gt;&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// In MapFunctionITCase.java 
&lt;/span&gt;resultSpec(
    map($(&lt;span class=&quot;code-quote&quot;&gt;&quot;f0&quot;&lt;/span&gt;), $(&lt;span class=&quot;code-quote&quot;&gt;&quot;f0&quot;&lt;/span&gt;), $(&lt;span class=&quot;code-quote&quot;&gt;&quot;f0&quot;&lt;/span&gt;), $(&lt;span class=&quot;code-quote&quot;&gt;&quot;f1&quot;&lt;/span&gt;)), 
    &lt;span class=&quot;code-quote&quot;&gt;&quot;MAP[f0, f1]&quot;&lt;/span&gt;, 
    Collections.singletonMap(1, 2), &lt;span class=&quot;code-comment&quot;&gt;// Expected: {1=2}
&lt;/span&gt;    DataTypes.MAP(INT().notNull(), INT().notNull()).notNull()
)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;b&gt;Expected Behavior&lt;/b&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;`MAP&lt;span class=&quot;error&quot;&gt;&amp;#91;1, 1, 1, 2&amp;#93;&lt;/span&gt;` should consistently return `{1=2}` (last value wins)&lt;/li&gt;
	&lt;li&gt;Results should be deterministic across all environments&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Actual Behavior&lt;/b&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Sometimes returns `{1=2}` &#9989;&lt;/li&gt;
	&lt;li&gt;Sometimes returns `{1=1}` &#10060;&lt;/li&gt;
	&lt;li&gt;Non-deterministic failures in CI environments&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13627340">FLINK-38286</key>
            <summary>MAP function with duplicate keys produces non-deterministic results</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="raminqaf">Ramin Gharib</assignee>
                                    <reporter username="raminqaf">Ramin Gharib</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 26 Aug 2025 10:12:25 +0000</created>
                <updated>Wed, 27 Aug 2025 13:53:16 +0000</updated>
                            <resolved>Wed, 27 Aug 2025 13:53:16 +0000</resolved>
                                                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                                    <component>Table SQL / API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="18016463" author="dawidwys" created="Wed, 27 Aug 2025 08:51:32 +0000"  >&lt;p&gt;Fixed in:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;master
	&lt;ul&gt;
		&lt;li&gt;e2a2755a0466fec2c7ae7bd3edddf4d6f822a7a0&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;2.1.x
	&lt;ul&gt;
		&lt;li&gt;d67c45a750e7da60cbda7611d1fe674c6ea8658b&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;2.0.x
	&lt;ul&gt;
		&lt;li&gt;f8a3985c5668bfbca6bb7f7e52015acd1b98a76e&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1xf94:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>