<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:40:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-12595] KinesisDataFetcherTest.testOriginalExceptionIsPreservedWhenInterruptedDuringShutdown deadlocks</title>
                <link>https://issues.apache.org/jira/browse/FLINK-12595</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://api.travis-ci.org/v3/job/535738122/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.org/v3/job/535738122/log.txt&lt;/a&gt;&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13235055">FLINK-12595</key>
            <summary>KinesisDataFetcherTest.testOriginalExceptionIsPreservedWhenInterruptedDuringShutdown deadlocks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rehevkor5">Shannon Carey</assignee>
                                    <reporter username="dwysakowicz">Dawid Wysakowicz</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Thu, 23 May 2019 06:44:15 +0000</created>
                <updated>Mon, 22 Jul 2019 16:48:19 +0000</updated>
                            <resolved>Mon, 22 Jul 2019 16:43:30 +0000</resolved>
                                    <version>1.9.0</version>
                                    <fixVersion>1.9.0</fixVersion>
                                    <component>Connectors / Kinesis</component>
                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16865002" author="till.rohrmann" created="Sun, 16 Jun 2019 12:29:23 +0000"  >&lt;p&gt;Another instance: &lt;a href=&quot;https://api.travis-ci.org/v3/job/546124948/log.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.travis-ci.org/v3/job/546124948/log.txt&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16887225" author="thw" created="Wed, 17 Jul 2019 16:37:55 +0000"  >&lt;p&gt;This issues seems related to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-11568&quot; title=&quot;Exception in Kinesis ShardConsumer hidden by InterruptedException &quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-11568&quot;&gt;&lt;del&gt;FLINK-11568&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rehevkor5&quot; class=&quot;user-hover&quot; rel=&quot;rehevkor5&quot;&gt;rehevkor5&lt;/a&gt;&#160;could you take a look please?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16889564" author="rehevkor5" created="Sat, 20 Jul 2019 18:23:33 +0000"  >&lt;p&gt;Sorry about that! Had to draw out a big sequence diagram, but&#160;I have a&#160;hypothesis about the issue. It looks like KinesisDataFetcher (on the FlinkKinesisConsumer thread)&#160;could by chance&#160;pause inside the while(running) loop, before Thread.sleep(). Then, the KinesisShardConsumer thread might&#160;interrupt that thread via KinesisDataFetcher#mainThread.interrupt() and then&#160;trigger shutdownWaiter, allowing the tests&apos;s fetcher.waitUntilShutdown() to complete, after which the test would also interrupt the FlinkKinesisConsumer thread. Then,&#160;when the KinesisDataFetcher code resumes, it calls Thread.sleep() and catches/ignores&#160;the&#160;interrupted state (caused by both interrupts), then it exits the while(running) loop due to running == false, and gets to our awaitTermination() code which waits forever because it has already absorbed the test&apos;s interrupt.&lt;/p&gt;

&lt;p&gt;This can be reproduced by&#160;adding&#160;code like this to the KinesisDataFetcher beneath the if(running &amp;amp;&amp;amp; discoveryIntervalMillis !=0) line in order to force a longer delay&#160;in that thread:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; wasInterrupted = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; interruptionCount = 0;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 4; i++) {
   &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(4000);
   } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException ie) {
      wasInterrupted = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
      interruptionCount++;
   }
}
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (wasInterrupted) {
   &lt;span class=&quot;code-comment&quot;&gt;// Restore the interrupted state
&lt;/span&gt;   &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().interrupt();
}
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;KinesisDataFetcher was interrupted &quot;&lt;/span&gt; + interruptionCount + &lt;span class=&quot;code-quote&quot;&gt;&quot; times during the &quot;&lt;/span&gt; +
   &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(running) loop.&quot;&lt;/span&gt;);
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.flush();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You&apos;ll&#160;likely see that it gets interrupted twice, and the test deadlocks with the same stacks as the logs provided above.&lt;/p&gt;

&lt;p&gt;I have&#160;02a0cf3d4e checked out to reproduce the issue&#160;matching&#160;the&#160;provided logs. I assume it&apos;s best to write this patch against&#160;HEAD of master, and let you handle backporting it? Let me know if that&apos;s not the case. I&apos;ll post again&#160;once I have a PR&#160;to address my hypothesis.&lt;/p&gt;</comment>
                            <comment id="16889565" author="rehevkor5" created="Sat, 20 Jul 2019 18:26:46 +0000"  >&lt;p&gt;Another thing I noticed: FlinkKinesisConsumer#sourceContext.close() is not called if fetcher.runFetcher() throws an exception. This seems like it might be a problem? Should that be&#160;moved into a &quot;finally&quot; block?&#160;Do you think I should submit a&#160;separate issue&#160;for that?&lt;/p&gt;</comment>
                            <comment id="16889581" author="rehevkor5" created="Sat, 20 Jul 2019 20:12:16 +0000"  >&lt;p&gt;Created&#160;&lt;a href=&quot;https://github.com/apache/flink/pull/9187&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/9187&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16890307" author="thw" created="Mon, 22 Jul 2019 16:46:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rehevkor5&quot; class=&quot;user-hover&quot; rel=&quot;rehevkor5&quot;&gt;rehevkor5&lt;/a&gt; thanks for fixing this!&#160;&lt;/p&gt;

&lt;p&gt;Regarding&#160;FlinkKinesisConsumer#sourceContext.close() : It&apos;s a separate discussion. I think that when the fetcher exits with an exception, we should not expect any further (orderly) cleanup.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16890308" author="thw" created="Mon, 22 Jul 2019 16:48:19 +0000"  >&lt;p&gt;cherry pick for release-1.9:&#160;7ea55e967bc450b3b744edcaea23834646e439cd&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13214702">FLINK-11568</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 17 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z02zhk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>