<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:07:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-24501] Unexpected behavior of cumulate window aggregate for late event after recover from sp/cp</title>
                <link>https://issues.apache.org/jira/browse/FLINK-24501</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;b&gt;Problem description&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;After recover from savepoint or checkpoint, unexpected behavior of cumulate window aggregate for late event may happened.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Bug analyze&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Currently, for cumulate window aggregate, late events belongs to the cleaned slice would be merged into the merged window state, and would be counted into the later slice.&lt;/p&gt;

&lt;p&gt;For example, for a CUMULATE window, step is 1 minute, size is 1 day.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SELECT window_start, window_end, COUNT(USER_ID)
  FROM TABLE(
    CUMULATE(TABLE Bid, DESCRIPTOR(bidtime), INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; MINUTES, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; DAY))
  GROUP BY window_start, window_end;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When the watermark already comes to 11:01, result of window [00:00, 11:01) would be emitted. Let&apos;s assume the result is INSERT (00:00, 11:01, 4)&lt;/p&gt;

&lt;p&gt;Then if a late record which event time is 11:00 comes, it would be merged into merged state, and would be counted into the later slice, for example, for window [00:00, 11:02), [00:00, 11:03)... But the emitted window result&#160;INSERT (00:00, 11:01, 4) would not be retracted and updated.&lt;/p&gt;

&lt;p&gt;The behavior would be different if the job recover from savepoint/checkpoint.&lt;/p&gt;

&lt;p&gt;Let&apos;s do a savepoint after watermark comes to 11:01 and emit (00:00, 11:01, 4).&lt;/p&gt;

&lt;p&gt;Then recover the job from savepoint. Watermarks&#160;are not checkpointed and they need to be repopulated again. So after recovered, the watermark may rollback to 11:00, then if a record which event time is 11:00 comes, it would not be processed as late event, after watermark comes to 11:01 again, a window result&#160;INSERT&#160;(00:00, 11:01, 5)&#160; would be emitted to downstream.&lt;/p&gt;

&lt;p&gt;So the downstream operator would receive two INSERT record for WINDOW (00:00, 11:01) which may leads to wrong result.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Solution&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;There are two solutions for the problem:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;save watermark to state in slice shared operator. (Prefered)&lt;/li&gt;
	&lt;li&gt;update the behavior for late event. For example, retract the emitted result and send the updated result. It needs to change the behavior of slice state clean mechanism because we clean the slice state after watermark exceeds the slice end currently.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13405889">FLINK-24501</key>
            <summary>Unexpected behavior of cumulate window aggregate for late event after recover from sp/cp</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jingzhang">Jing Zhang</assignee>
                                    <reporter username="jingzhang">Jing Zhang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 11 Oct 2021 08:50:31 +0000</created>
                <updated>Wed, 10 Nov 2021 07:16:35 +0000</updated>
                            <resolved>Wed, 10 Nov 2021 07:16:35 +0000</resolved>
                                                    <fixVersion>1.15.0</fixVersion>
                                    <component>Table SQL / Runtime</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="17427106" author="jiangang" created="Mon, 11 Oct 2021 12:43:06 +0000"  >&lt;p&gt;+1 for the first solution. Recomputing watermark can cause the watermark&apos;s backward. The late events last time may be not late after restarting which can cause data inconsistent. The problem&#160; occurs in other situations too.&lt;/p&gt;</comment>
                            <comment id="17427108" author="qingru zhang" created="Mon, 11 Oct 2021 12:50:20 +0000"  >&lt;p&gt;There are two solutions for the problem:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;save watermark to state in slice shared operator. (Prefered)&lt;/li&gt;
	&lt;li&gt;update the behavior for late event. For example, retract the emitted result and send the updated result. It needs to change the behavior of slice state clean mechanism because we clean the slice state after watermark exceeds the slice end currently.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;font color=&quot;#ff0000&quot;&gt;&lt;b&gt;Those two solutions could solve current problem based on a minor update of SliceSharedWindowOperator. But could not avoid other problems caused by the watermark repopulated after recover job from savepoint/checkpoint.&lt;/b&gt;&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;For example, for Tumble window which size is 1min.&lt;/p&gt;

&lt;p&gt;When the watermark already comes to 11:01, result of window [00:00, 11:01) would be emitted. Let&apos;s assume the result is INSERT (00:00, 11:01, 4)&lt;/p&gt;

&lt;p&gt;Then if a late record which event time is 11:00 comes, it would be dropped as late event.&lt;/p&gt;

&lt;p&gt;The behavior would be different if the job recover from savepoint/checkpoint.&lt;/p&gt;

&lt;p&gt;Let&apos;s do a savepoint after watermark comes to 11:01 and emit (00:00, 11:01, 4).&lt;/p&gt;

&lt;p&gt;Then recover the job from savepoint. Watermarks&#160;are not checkpointed and they need to be repopulated again. So after recovered, the watermark may rollback to 11:00, then if a record which event time is 11:00 comes, it would not be processed as late event, after watermark comes to 11:01 again, a window result&#160;INSERT&#160;(00:00, 11:01, 1)&#160; would be emitted to downstream.&lt;/p&gt;

&lt;p&gt;So the downstream operator would receive two INSERT record for WINDOW (00:00, 11:01) which may leads to wrong result. For example, the downstream is a KV sink, which key is &lt;span class=&quot;error&quot;&gt;&amp;#91;window_start, window_end&amp;#93;&lt;/span&gt;, the later result may override the previous result.&lt;/p&gt;

&lt;p&gt;So I&apos;m wonder should we look for a better solution which could solve all the problem caused by the watermark repopulated. For example, save the watermark to state for all operators?&lt;/p&gt;

&lt;p&gt;What do you think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=twalthr&quot; class=&quot;user-hover&quot; rel=&quot;twalthr&quot;&gt;twalthr&lt;/a&gt;,&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=godfrey&quot; class=&quot;user-hover&quot; rel=&quot;godfrey&quot;&gt;godfrey&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; ?&lt;/p&gt;

&lt;p&gt;Any suggestion is helpful.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17427608" author="lzljs3620320" created="Tue, 12 Oct 2021 10:31:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=qingru+zhang&quot; class=&quot;user-hover&quot; rel=&quot;qingru zhang&quot;&gt;qingru zhang&lt;/a&gt; Thanks! This is a good problem and good summary.&lt;br/&gt;
Does old window have this problem too?&lt;/p&gt;</comment>
                            <comment id="17427661" author="qingru zhang" created="Tue, 12 Oct 2021 12:45:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt;&#160;I think all operators which depend on event-time would have similar problem, including Group Window Aggregate/Window TVF/Interval Join/Window Join/Window Rank in Flink SQL and Window Operator in DataStream. After recover from savepoint/checkpoint, the late event maybe not processed as late event any more because of watermark repopulated.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17432190" author="wenlong.lwl" created="Thu, 21 Oct 2021 03:56:45 +0000"  >&lt;p&gt;I think it may be better to make sure that watermark would not reduce after restoring from a checkpoint/savepoint instead of modifying the manner of operator to cover such abnormal case. &lt;br/&gt;
For example, add an operator state in watermark assigner, to avoid it producing wrong watermark after restore?&lt;/p&gt;</comment>
                            <comment id="17435136" author="qingru zhang" created="Thu, 28 Oct 2021 03:13:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wenlong.lwl&quot; class=&quot;user-hover&quot; rel=&quot;wenlong.lwl&quot;&gt;wenlong.lwl&lt;/a&gt; Thank a lot for your attention to this issue.&lt;/p&gt;

&lt;p&gt;&amp;gt;&#160;add an operator state in watermark assigner, to avoid it producing wrong watermark after restore?&lt;/p&gt;

&lt;p&gt;It is a rejected alternatives because of the following reasons, please correct me if I&apos;m wrong.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;I think we should not use operator state to store watermark.&#160; Because if the job&#160;parallelism is changed when restore from a checkpoint/savepoint, how to merge each old watermark to a new watermark. If takes min value,&#160;&#160;watermark may be reduce again after&#160;restoring from a checkpoint/savepoint. If takes max value, some normal data events would be mistaken processed as late event.&lt;/li&gt;
	&lt;li&gt;So we need keyed state to store watermark because of the above reason. But the&#160;watermark assigner operator does not and should not require inputs data to be keyedStream. Besides, if use keyed state to store watermark, we need read/write this state frequently.&#160;I am very worried that update this general operator (watermark assigner operator) will cause bad effect on performance.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;So I decide to temporarily correct this bug in a small scope until we have a better general solution.&#160;&lt;/p&gt;

&lt;p&gt;Any better idea?&lt;/p&gt;</comment>
                            <comment id="17435137" author="wenlong.lwl" created="Thu, 28 Oct 2021 03:20:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=qingru+zhang&quot; class=&quot;user-hover&quot; rel=&quot;qingru zhang&quot;&gt;qingru zhang&lt;/a&gt; I think watermark should be the min of all subtask, and nothing wrong would happen, because downstream operator such as window, also treat min of watermark of its upstream as its watermark, the logic is aligned.&lt;/p&gt;</comment>
                            <comment id="17435157" author="qingru zhang" created="Thu, 28 Oct 2021 05:01:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wenlong.lwl&quot; class=&quot;user-hover&quot; rel=&quot;wenlong.lwl&quot;&gt;wenlong.lwl&lt;/a&gt;&#160;If we took min watermark of all subtask as new watermark, we still could not avoid the bug in this Jira because some late data would be regarded as normal data after recover from sp/cp.&lt;/p&gt;</comment>
                            <comment id="17435175" author="wenlong.lwl" created="Thu, 28 Oct 2021 06:16:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=qingru+zhang&quot; class=&quot;user-hover&quot; rel=&quot;qingru zhang&quot;&gt;qingru zhang&lt;/a&gt; in you case&#65292;if the watermark can be restore&#65292;the late event is still late event when restoring from sp/cp&#65292;because its event time is earlier than watermark restored. &lt;br/&gt;
On the other hand, introducing per-key watermark state could increase the state size of window operator in long run and affects performance, because the progress state should never be clean up in order to recognize later event in restore in the future. such side effect could be worse when the window size is small because the space namespace will increase quickly.&lt;/p&gt;</comment>
                            <comment id="17435194" author="qingru zhang" created="Thu, 28 Oct 2021 06:46:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wenlong.lwl&quot; class=&quot;user-hover&quot; rel=&quot;wenlong.lwl&quot;&gt;wenlong.lwl&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt;&#160;in you case&#65292;if the watermark can be restore&#65292;the late event is still late event when restoring from sp/cp&#65292;because its event time is earlier than watermark restored.&lt;/p&gt;

&lt;p&gt;I don&apos;t understand, could you explain more? If parallelism is changed, and we took&#160;took min watermark of all subtask as new watermark, is there any possible that some late data would be regarded as normal data because watermark maybe degrade??&lt;/p&gt;

&lt;p&gt;&amp;gt; On the other hand, introducing per-key watermark state could increase the state size of window operator in long run and affects performance, because the progress state should never be clean up in order to recognize later event in restore in the future. such side effect could be worse when the window size is small because the space namespace will increase quickly.&lt;/p&gt;

&lt;p&gt;I admit read/write state would effects performance. But using operator state, we still need to read/write state.&lt;/p&gt;

&lt;p&gt;About state size, keyed state which stores progress would be cleaned when the window finishes.&lt;/p&gt;</comment>
                            <comment id="17441536" author="lzljs3620320" created="Wed, 10 Nov 2021 07:16:35 +0000"  >&lt;p&gt;master: cba6b2c89a0ecd8858c1849a9b06350db48fb450&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13357041">FLINK-21305</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0vqbk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>