<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:46:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-17351] CheckpointCoordinator and CheckpointFailureManager ignores checkpoint timeouts</title>
                <link>https://issues.apache.org/jira/browse/FLINK-17351</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;As described in point 2: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-17327?focusedCommentId=17090576&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17090576&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-17327?focusedCommentId=17090576&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17090576&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(copy of description from above linked comment):&lt;/p&gt;

&lt;p&gt;The logic in how &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt; handles checkpoint timeouts is broken. In your &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=qinjunjerry&quot; class=&quot;user-hover&quot; rel=&quot;qinjunjerry&quot;&gt;qinjunjerry&lt;/a&gt; examples, your job should have failed after first checkpoint failure, but checkpoints were time outing on CheckpointCoordinator after 5 seconds, before &lt;tt&gt;FlinkKafkaProducer&lt;/tt&gt; was detecting Kafka failure after 2 minutes. Those timeouts were not checked against &lt;tt&gt;setTolerableCheckpointFailureNumber(...)&lt;/tt&gt; limit, so the job was keep going with many timed out checkpoints. Now funny thing happens: FlinkKafkaProducer detects Kafka failure. Funny thing is that it depends where the failure was detected:&lt;/p&gt;

&lt;p&gt;a) on processing record? no problem, job will failover immediately once failure is detected (in this example after 2 minutes)&lt;br/&gt;
b) on checkpoint? heh, the failure is reported to &lt;tt&gt;CheckpointCoordinator&lt;/tt&gt; &lt;b&gt;and gets ignored, as PendingCheckpoint has already been discarded 2 minutes ago&lt;/b&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; So theoretically the checkpoints can keep failing forever and the job will not restart automatically, unless something else fails.&lt;/p&gt;

&lt;p&gt;Even more funny things can happen if we mix &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-17350&quot; title=&quot;StreamTask should always fail immediately on failures in synchronous part of a checkpoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-17350&quot;&gt;&lt;del&gt;FLINK-17350&lt;/del&gt;&lt;/a&gt; . or b) with intermittent external system failure. Sink reports an exception, transaction was lost/aborted, Sink is in failed state, but if there will be a happy coincidence that it manages to accept further records, this exception can be lost and all of the records in those failed checkpoints will be lost forever as well. In all of the examples that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=qinjunjerry&quot; class=&quot;user-hover&quot; rel=&quot;qinjunjerry&quot;&gt;qinjunjerry&lt;/a&gt; posted it hasn&apos;t happened. &lt;tt&gt;FlinkKafkaProducer&lt;/tt&gt; was not able to recover after the initial failure and it was keep throwing exceptions until the job finally failed (but much later then it should have). And that&apos;s not guaranteed anywhere.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13300559">FLINK-17351</key>
            <summary>CheckpointCoordinator and CheckpointFailureManager ignores checkpoint timeouts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ym">Yuan Mei</assignee>
                                    <reporter username="pnowojski">Piotr Nowojski</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 23 Apr 2020 12:54:40 +0000</created>
                <updated>Wed, 27 May 2020 15:15:27 +0000</updated>
                            <resolved>Wed, 27 May 2020 15:15:27 +0000</resolved>
                                    <version>1.9.2</version>
                    <version>1.10.0</version>
                                    <fixVersion>1.11.0</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="17091481" author="roman_khachatryan" created="Fri, 24 Apr 2020 11:17:00 +0000"  >&lt;p&gt;As we discussed offline, the fix would be to increment failure counter&#160;`CHECKPOINT_EXPIRED` in `CheckpointFailureManager`. Other reasons should also be checked.&lt;/p&gt;

&lt;p&gt;But, some cases&#160;are not even reported to&#160;`CheckpointFailureManager`: `TOO_MANY_CONCURRENT_CHECKPOINTS` and `MINIMUM_TIME_BETWEEN_CHECKPOINTS` (maybe others).&lt;/p&gt;</comment>
                            <comment id="17092055" author="wind_ljy" created="Sat, 25 Apr 2020 05:59:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; Interesting issue. But what if users don&apos;t set the &lt;tt&gt;CheckpointFailureManager&lt;/tt&gt;? The exception thrown when producer is doing checkpointing, will also be swallowed because the checkpoint is expired.&lt;/p&gt;</comment>
                            <comment id="17093147" author="pnowojski" created="Mon, 27 Apr 2020 07:58:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wind_ljy&quot; class=&quot;user-hover&quot; rel=&quot;wind_ljy&quot;&gt;wind_ljy&lt;/a&gt; for not swallowing the original exceptions there is another related ticket: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-17350&quot; title=&quot;StreamTask should always fail immediately on failures in synchronous part of a checkpoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-17350&quot;&gt;&lt;del&gt;FLINK-17350&lt;/del&gt;&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;Here, we just want to account all of the missing failure reasons against failure counter. In &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-17350&quot; title=&quot;StreamTask should always fail immediately on failures in synchronous part of a checkpoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-17350&quot;&gt;&lt;del&gt;FLINK-17350&lt;/del&gt;&lt;/a&gt; we make sure that unrecoverable failures (like during synchronous checkpointing) will fail the task (&amp;amp; job) immediately.&lt;/p&gt;</comment>
                            <comment id="17111716" author="ym" created="Wed, 20 May 2020 03:22:47 +0000"  >&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks for the pointers &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;. I have quite a nice walk&#160;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I guess the fix is simple: increase `continuousFailureCounter` for exception&#160;`CHECKPOINT_EXPIRED` as well.&lt;/p&gt;

&lt;p&gt;However, there is a list of checkpoint failure reasons listed (actually most of the reasons) are ignored.&lt;/p&gt;

&lt;p&gt;Hence I am wondering what is the criteria for what should be ignored, and what should not?&lt;/p&gt;</comment>
                            <comment id="17112026" author="roman_khachatryan" created="Wed, 20 May 2020 10:22:13 +0000"  >&lt;p&gt;I think we need to increment the counter for any checkpoint failure that is not caused by another checkpoint (like&#160;TOO_MANY_CONCURRENT_CHECKPOINTS) and a failure with a wider scope (like&#160;TASK_FAILURE).&lt;/p&gt;</comment>
                            <comment id="17113095" author="klion26" created="Thu, 21 May 2020 11:20:12 +0000"  >&lt;p&gt;Attach another issue which wants to increase the count under more checkpoint fail reasons&lt;/p&gt;</comment>
                            <comment id="17117844" author="pnowojski" created="Wed, 27 May 2020 15:15:27 +0000"  >&lt;p&gt;merged commit 3ec768a into apache:master, f9641411ca into apache:release-1.11&lt;/p&gt;

&lt;p&gt;Fix will not be back-ported to previous releases, as it&apos;s changing semantic of the configuration (setTolerableCheckpointFailureNumber, setFailTaskOnCheckpointError)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13300291">FLINK-17327</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13230648">FLINK-12364</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13296972">FLINK-17043</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13300558">FLINK-17350</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 24 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0dzwg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Checkpoint timeouts will now be treated as normal checkpoint failures and checked against `setTolerableCheckpointFailureNumber(...)`.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>