<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:46:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-17820] Memory threshold is ignored for channel state</title>
                <link>https://issues.apache.org/jira/browse/FLINK-17820</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Config parameter state.backend.fs.memory-threshold is ignored for channel state. Causing each subtask to have a file per checkpoint. Regardless of the size of channel state (of this subtask).&lt;/p&gt;

&lt;p&gt;This also causes slow cleanup and delays the next checkpoint.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The problem is that&#160;&lt;tt&gt;ChannelStateCheckpointWriter.finishWriteAndResult&lt;/tt&gt;&#160;calls flush(); which actually flushes the data on disk.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;From FSDataOutputStream.flush Javadoc:&lt;/p&gt;

&lt;p&gt;A completed flush does not mean that the data is necessarily persistent. Data persistence can is only assumed after calls to close() or sync().&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Possible solutions:&lt;/p&gt;

&lt;p&gt;1.&#160;not to flush in&#160;&lt;tt&gt;ChannelStateCheckpointWriter.finishWriteAndResult (which can lead to data loss in a wrapping stream).&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;2. change&#160;&lt;/tt&gt;&lt;tt&gt;FsCheckpointStateOutputStream.flush behavior&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;3. wrap&#160;&lt;/tt&gt;&lt;tt&gt;FsCheckpointStateOutputStream to prevent flush&lt;/tt&gt;&lt;tt&gt;}}{{&lt;/tt&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13306013">FLINK-17820</key>
            <summary>Memory threshold is ignored for channel state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roman">Roman Khachatryan</assignee>
                                    <reporter username="roman">Roman Khachatryan</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 19 May 2020 21:27:51 +0000</created>
                <updated>Fri, 16 Oct 2020 10:56:50 +0000</updated>
                            <resolved>Wed, 27 May 2020 15:35:42 +0000</resolved>
                                    <version>1.11.0</version>
                                    <fixVersion>1.11.0</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17112643" author="stephanewen" created="Wed, 20 May 2020 22:47:31 +0000"  >&lt;p&gt;I would simply avoid flushing here. It makes no difference, persistence wise. Persistence is only guaranteed once you call &lt;tt&gt;closeAndGetHandle()&lt;/tt&gt;.&lt;br/&gt;
There are few reasons ever to call flush on a stream (usually only when it is pipelined to a receiver and you want to make sure that the receiver receives buffered data, which I assume is not the case here, as this is no network stream).&lt;/p&gt;

&lt;p&gt;(The reference to &lt;tt&gt;sync&lt;/tt&gt; is not quite right in the JavaDocs. For some FileSystems, like S3, &lt;tt&gt;sync()&lt;/tt&gt; does not help at all).&lt;/p&gt;

&lt;p&gt;I would not change &lt;tt&gt;FsCheckpointStateOutputStream&lt;/tt&gt;, this is a class that does exactly what it should do at the moment.&lt;/p&gt;

&lt;p&gt;Wrapping also seems like unnecessary complexity, which we should avoid whenever possible.&lt;/p&gt;</comment>
                            <comment id="17112651" author="roman_khachatryan" created="Wed, 20 May 2020 23:02:53 +0000"  >&lt;p&gt;The data to FsCheckpointStateOutputStream is written through DataOutputStream.&lt;/p&gt;

&lt;p&gt;Without flushing&#160;DataOutputStream some data can be left in its buffer. Flushing&#160;DataOutputStream also flushes the underlying&#160;FsCheckpointStateOutputStream.&lt;/p&gt;

&lt;p&gt;Although in current JDK&#160;DataOutputStream doesn&apos;t buffer data. Do you think we can rely on it?&lt;/p&gt;</comment>
                            <comment id="17114849" author="stephanewen" created="Sat, 23 May 2020 15:55:24 +0000"  >&lt;p&gt;I see. You cannot rely on &lt;tt&gt;close()&lt;/tt&gt; here as well, because that closes the underlying stream in a &quot;close for dispose&quot; manner. That is indeed a bit of a design shortcoming in the &lt;tt&gt;CheckpointStateOutputStream&lt;/tt&gt; class.&lt;/p&gt;

&lt;p&gt;My feeling is that this assumption of &lt;tt&gt;DataOutputStream&lt;/tt&gt; being non-buffering is made in some other parts of the code.&lt;br/&gt;
What do you think about adding a test that guards this assumption?&lt;/p&gt;

&lt;p&gt;We also have the &lt;tt&gt;DataOutputViewStreamWrapper&lt;/tt&gt; class which is an extension of &lt;tt&gt;DataOutputStream&lt;/tt&gt; - we could use that, guard it with a &quot;does not buffer&quot; test and if we ever find it actually buffers, then we need to implement the methods directly, rather than inherit from &lt;tt&gt;DataOutputStream&lt;/tt&gt;.&lt;/p&gt;

</comment>
                            <comment id="17114859" author="stephanewen" created="Sat, 23 May 2020 16:02:23 +0000"  >&lt;p&gt;Regarding changing the behavior of &lt;tt&gt;FsCheckpointStateOutputStream#flush()&lt;/tt&gt;  - I cannot say if there is some part of the code at the moment that assumes files are created upon flushing. The tests guard this behavior, so it may very well be.&lt;/p&gt;</comment>
                            <comment id="17115851" author="roman_khachatryan" created="Mon, 25 May 2020 08:49:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;What do you think about adding a test that guards this assumption?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think we can not rely on testing&#160;DataOutputStream because the JRE&#160;could be different at runtime.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;We also have the&#160;&lt;tt&gt;DataOutputViewStreamWrapper&lt;/tt&gt;&#160;class which is an extension of&#160;&lt;tt&gt;DataOutputStream&lt;/tt&gt;&#160;- we could use that, guard it with a &quot;does not buffer&quot; test and if we ever find it actually buffers, then we need to implement the methods directly, rather than inherit from&#160;&lt;tt&gt;DataOutputStream&lt;/tt&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I guess you mean adding a no-op flush method to {{DataOutputViewStreamWrapper.}}I think it will be difficult to detect that some flush calls &quot;don&apos;t work&quot; anymore. And probably it&apos;s better to find incorrect assumptions.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Wrapping also seems like unnecessary complexity&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;br/&gt;
To me, it is less complicated than baking (counter-intuitive?) assumptions into public code and adding tests for it&lt;/p&gt;</comment>
                            <comment id="17116150" author="stephanewen" created="Mon, 25 May 2020 17:03:44 +0000"  >&lt;p&gt;It is true, the assumption that &lt;tt&gt;DataOutputStream&lt;/tt&gt; does not buffer is a fragile point, even if an unlikely one (my feeling is too much existing code would be broken if one SDK made the implementation behave differently for such a core class). That said, it should be possible to flush the stream without voiding the usability of the class.&lt;/p&gt;

&lt;p&gt;If from the initial options, we don&apos;t like (1), then, thinking about it a bit more, I would go for option (2) (adjust &lt;tt&gt;FsCheckpointStateOutputStream&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;I did a quick search through the code and it looks like we can drop the assumption that &lt;tt&gt;FsCheckpointStateOutputStream&lt;/tt&gt; creates the file in &lt;tt&gt;flush()&lt;/tt&gt; It seems not used in the production code (though possibly in tests). How about this?&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;rename the &lt;tt&gt;flush()&lt;/tt&gt; method to &lt;tt&gt;flushToFile()&lt;/tt&gt;, including all existing calls to that method within the class and in relevant tests.&lt;/li&gt;
	&lt;li&gt;override &lt;tt&gt;flush()&lt;/tt&gt; as a no-op.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17116469" author="roman_khachatryan" created="Tue, 26 May 2020 06:10:23 +0000"  >&lt;p&gt;I agree about (2) (adjust&#160;&lt;tt&gt;FsCheckpointStateOutputStream&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;After trying it out I found only a couple of tests that depend on flush and also didn&apos;t find any production usages of it.&lt;/p&gt;

&lt;p&gt;I&apos;ll adjust my PR.&lt;/p&gt;</comment>
                            <comment id="17116496" author="roman_khachatryan" created="Tue, 26 May 2020 07:02:19 +0000"  >&lt;p&gt;I&apos;ve created a PR:&#160;&lt;a href=&quot;https://github.com/apache/flink/pull/12332&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/12332&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It flushes to disk if buffers are above threshold:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void flush() {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pos &amp;gt; localStateThreshold) {
        flushToFile(); 
    } 
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;(I realized that always doing nothing in flush may be counter-intuitive).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17117864" author="zjwang" created="Wed, 27 May 2020 15:39:41 +0000"  >&lt;p&gt;Merged in release-1.11:&#160;05b97924572594ef244236a2f328177a2ec84fc4&lt;/p&gt;

&lt;p&gt;Merged in master:&#160;8b4fe87a74d3ec631350ebac4dfdf69094c802e3&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13307804">FLINK-17986</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 24 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ex8o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>