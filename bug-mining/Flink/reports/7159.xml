<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:17:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-32583] RestClient can deadlock if request made after Netty event executor terminated</title>
                <link>https://issues.apache.org/jira/browse/FLINK-32583</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The RestClient can deadlock if a request is made after the Netty event executor has terminated.&lt;/p&gt;

&lt;p&gt;This is due to the listener that would resolve the CompletableFuture that is attached to the ChannelFuture returned by the call to Netty to connect not being able to run because the executor to run it rejects the execution.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/release-1.17.1/flink-runtime/src/main/java/org/apache/flink/runtime/rest/RestClient.java#L471-L482&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RestClient.java&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ChannelFuture connectFuture = bootstrap.connect(targetAddress, targetPort);

&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CompletableFuture&amp;lt;Channel&amp;gt; channelFuture = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompletableFuture&amp;lt;&amp;gt;();

connectFuture.addListener(
        (ChannelFuture &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;) -&amp;gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;.isSuccess()) {
                channelFuture.complete(&lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;.channel());
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                channelFuture.completeExceptionally(&lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;.cause());
            }
        });
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In this code, the call to &lt;tt&gt;addListener()&lt;/tt&gt; can fail silently (only logging to the console), meaning any code waiting on the CompletableFuture returned by this method will deadlock.&lt;/p&gt;

&lt;p&gt;There was some work in Netty around this back in 2015, but it&apos;s unclear to me how this situation is expected to be handled given the discussion and changes from these issues:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/netty/netty/issues/3449&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/issues/3449&lt;/a&gt; (open)&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/netty/netty/pull/3483&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/pull/3483&lt;/a&gt; (closed)&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/netty/netty/pull/3566&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/pull/3566&lt;/a&gt; (closed)&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/netty/netty/pull/5087&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/pull/5087&lt;/a&gt; (merged)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think a reasonable fix for Flink would be to check the state of &lt;tt&gt;connectFuture&lt;/tt&gt; and &lt;tt&gt;channelFuture&lt;/tt&gt; immediately after the call to &lt;tt&gt;addListener()&lt;/tt&gt;, resolving &lt;tt&gt;channelFuture&lt;/tt&gt; with &lt;tt&gt;completeExceptionally()&lt;/tt&gt; if &lt;tt&gt;connectFuture&lt;/tt&gt; is done and failed and &lt;tt&gt;channelFuture&lt;/tt&gt; has not been completed. In the possible race condition where the listener was attached successfully and the connection fails instantly, the result is the same, as calls to &lt;tt&gt;CompletableFuture#completeExceptionally()&lt;/tt&gt; are idempotent.&lt;/p&gt;

&lt;p&gt;A workaround for users of RestClient is to call &lt;tt&gt;CompletableFuture#get(long timeout, TimeUnit unit)&lt;/tt&gt; rather than &lt;tt&gt;#get()&lt;/tt&gt; or &lt;tt&gt;#join()&lt;/tt&gt; on the CompletableFutures it returns. However, if the call throws TimeoutException, the cause of the failure cannot easily be determined.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13543268">FLINK-32583</key>
            <summary>RestClient can deadlock if request made after Netty event executor terminated</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="plucas">Patrick Lucas</assignee>
                                    <reporter username="plucas">Patrick Lucas</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 12 Jul 2023 12:09:13 +0000</created>
                <updated>Tue, 1 Aug 2023 14:35:12 +0000</updated>
                            <resolved>Mon, 31 Jul 2023 07:13:09 +0000</resolved>
                                    <version>1.18.0</version>
                    <version>1.16.3</version>
                    <version>1.17.2</version>
                                    <fixVersion>1.18.0</fixVersion>
                    <fixVersion>1.16.3</fixVersion>
                    <fixVersion>1.17.2</fixVersion>
                                    <component>Runtime / REST</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17742435" author="plucas" created="Wed, 12 Jul 2023 13:53:21 +0000"  >&lt;p&gt;Further investigation suggests that this can only happen when a request is made after the RestClient itself is closed, which asynchronously shuts down the event loop used by Netty.&lt;/p&gt;

&lt;p&gt;Many uses of RestClient will use try-with-resources where this wouldn&apos;t be an issue, but it should still have the correct behavior when used in other contexts where a request may be attempted after shutdown has already started.&lt;/p&gt;</comment>
                            <comment id="17749057" author="mapohl" created="Mon, 31 Jul 2023 07:13:09 +0000"  >&lt;p&gt;master: b2920728a20c99e064c0553f2ec74c190199971f&lt;br/&gt;
1.17: 5a553c5ef47a9b777f077a20af96666e34fcc7f6&lt;br/&gt;
1.16: 2d6325d0ebbbe418d3e20118da57e8d9d78ea73f&lt;/p&gt;</comment>
                            <comment id="17749829" author="plucas" created="Tue, 1 Aug 2023 14:32:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt; regarding the release note, I just wanted to clarify something.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Fixes a race condition in the RestClient that could happen when submitting a request while closing the client. There was a small chance that the request submission wouldn&apos;t complete.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That is one effect of this change, but the primary problem it solves is not a race condition, but that if a request is made in &lt;em&gt;any time after&lt;/em&gt; the client is closed, then the future will definitely never be resolved, and no exception thrown. If a caller were to call &lt;tt&gt;.join()&lt;/tt&gt; on the returned &lt;tt&gt;CompletableFuture&lt;/tt&gt;&#8212;which does not take a timeout&#8212;the caller will actually block forever.&lt;/p&gt;

&lt;p&gt;I think this is the more serious bug being fixed here than the very rare edge case that required most of the complexity in the change.&lt;/p&gt;

&lt;p&gt;Suggested release note:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Fixes a bug in the RestClient where the response future of a request made after the client was closed is never completed.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;or&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Fixes a bug in the RestClient where making a request after the client was closed returns a future that never completes.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="17749836" author="mapohl" created="Tue, 1 Aug 2023 14:35:12 +0000"  >&lt;p&gt;Good point. Thanks for verifying the release notes &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_up.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 15 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1j3lk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12310192" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Release Note</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Fixes a bug in the RestClient where making a request after the client was closed returns a future that never completes.</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>