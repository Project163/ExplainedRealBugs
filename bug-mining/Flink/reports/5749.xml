<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:00:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-23794] InMemoryReporter leaks memory</title>
                <link>https://issues.apache.org/jira/browse/FLINK-23794</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=22196&amp;amp;view=logs&amp;amp;j=e9af9cde-9a65-5281-a58e-2c8511d36983&amp;amp;t=c520d2c3-4d17-51f1-813b-4b0b74a0c307&amp;amp;l=13960&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=22196&amp;amp;view=logs&amp;amp;j=e9af9cde-9a65-5281-a58e-2c8511d36983&amp;amp;t=c520d2c3-4d17-51f1-813b-4b0b74a0c307&amp;amp;l=13960&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Aug 14 22:56:30 [ERROR] Failed to execute goal org.apache.maven.plugins:maven-surefire-plugin:2.22.2:test (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-test) on project flink-connector-jdbc_2.11: There are test failures.
Aug 14 22:56:30 [ERROR] 
Aug 14 22:56:30 [ERROR] Please refer to /__w/1/s/flink-connectors/flink-connector-jdbc/target/surefire-reports &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the individual test results.
Aug 14 22:56:30 [ERROR] Please refer to dump files (&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; any exist) [date].dump, [date]-jvmRun[N].dump and [date].dumpstream.
Aug 14 22:56:30 [ERROR] ExecutionException The forked VM terminated without properly saying goodbye. VM crash or &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.exit called?
Aug 14 22:56:30 [ERROR] Command was /bin/sh -c cd /__w/1/s/flink-connectors/flink-connector-jdbc &amp;amp;&amp;amp; /usr/lib/jvm/adoptopenjdk-11-hotspot-amd64/bin/java -Xms256m -Xmx2048m -Dmvn.forkNumber=2 -XX:+UseG1GC -jar /__w/1/s/flink-connectors/flink-connector-jdbc/target/surefire/surefirebooter3870491592340940577.jar /__w/1/s/flink-connectors/flink-connector-jdbc/target/surefire 2021-08-14T22-14-27_386-jvmRun2 surefire3999990822284944903tmp surefire_7612891660133211258241tmp
Aug 14 22:56:30 [ERROR] Error occurred in starting fork, check output in log
Aug 14 22:56:30 [ERROR] &lt;span class=&quot;code-object&quot;&gt;Process&lt;/span&gt; Exit Code: 239
Aug 14 22:56:30 [ERROR] Crashed tests:
Aug 14 22:56:30 [ERROR] org.apache.flink.connector.jdbc.xa.JdbcExactlyOnceSinkE2eTest
Aug 14 22:56:30 [ERROR] org.apache.maven.surefire.booter.SurefireBooterForkException: ExecutionException The forked VM terminated without properly saying goodbye. VM crash or &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.exit called?
Aug 14 22:56:30 [ERROR] Command was /bin/sh -c cd /__w/1/s/flink-connectors/flink-connector-jdbc &amp;amp;&amp;amp; /usr/lib/jvm/adoptopenjdk-11-hotspot-amd64/bin/java -Xms256m -Xmx2048m -Dmvn.forkNumber=2 -XX:+UseG1GC -jar /__w/1/s/flink-connectors/flink-connector-jdbc/target/surefire/surefirebooter3870491592340940577.jar /__w/1/s/flink-connectors/flink-connector-jdbc/target/surefire 2021-08-14T22-14-27_386-jvmRun2 surefire3999990822284944903tmp surefire_7612891660133211258241tmp
Aug 14 22:56:30 [ERROR] Error occurred in starting fork, check output in log
Aug 14 22:56:30 [ERROR] &lt;span class=&quot;code-object&quot;&gt;Process&lt;/span&gt; Exit Code: 239
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13395382">FLINK-23794</key>
            <summary>InMemoryReporter leaks memory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="arvid">Arvid Heise</assignee>
                                    <reporter username="xtsong">Xintong Song</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Mon, 16 Aug 2021 04:49:31 +0000</created>
                <updated>Wed, 1 Sep 2021 12:02:17 +0000</updated>
                            <resolved>Fri, 27 Aug 2021 09:25:12 +0000</resolved>
                                    <version>1.14.0</version>
                                    <fixVersion>1.14.0</fixVersion>
                                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17399519" author="xintongsong" created="Mon, 16 Aug 2021 05:16:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=22220&amp;amp;view=logs&amp;amp;j=e9af9cde-9a65-5281-a58e-2c8511d36983&amp;amp;t=c520d2c3-4d17-51f1-813b-4b0b74a0c307&amp;amp;l=13961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=22220&amp;amp;view=logs&amp;amp;j=e9af9cde-9a65-5281-a58e-2c8511d36983&amp;amp;t=c520d2c3-4d17-51f1-813b-4b0b74a0c307&amp;amp;l=13961&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17402949" author="xintongsong" created="Mon, 23 Aug 2021 03:39:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=22618&amp;amp;view=logs&amp;amp;j=e9af9cde-9a65-5281-a58e-2c8511d36983&amp;amp;t=c520d2c3-4d17-51f1-813b-4b0b74a0c307&amp;amp;l=13967&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=22618&amp;amp;view=logs&amp;amp;j=e9af9cde-9a65-5281-a58e-2c8511d36983&amp;amp;t=c520d2c3-4d17-51f1-813b-4b0b74a0c307&amp;amp;l=13967&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17402980" author="till.rohrmann" created="Mon, 23 Aug 2021 06:47:10 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17403136" author="roman_khachatryan" created="Mon, 23 Aug 2021 11:36:04 +0000"  >&lt;p&gt;The crashes are caused by &quot;OOM: Heap space&quot;;&lt;/p&gt;

&lt;p&gt;When analyzing the heapdump, I see old tasks and all the related objects are still referred to, and thus not GCed. There are around 25K flink Task instances.&lt;/p&gt;

&lt;p&gt;Those Tasks a referenced from InMemoryReporter:&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13032310/13032310_Screenshot_2021-08-23_13-34-31.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;&lt;del&gt;The strange thing is that&lt;/del&gt; MetricRegistryImpl of attempt 13 (task#1, MetricRegistryImpl#1) is used by e.g. attempt 4666 (task#19053).&lt;/p&gt;

&lt;p&gt;edit:&lt;br/&gt;
The above is fine as MetricRegistryImpl and is its reporters are re-used across attempts.&lt;/p&gt;

&lt;p&gt;What&apos;s not fine is that InMemoryReporter is not cleared until the test end.&lt;br/&gt;
I see that it&apos;s removedGroups set size is 202458.&lt;/p&gt;

&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arvid&quot; class=&quot;user-hover&quot; rel=&quot;arvid&quot;&gt;arvid&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17403156" author="roman_khachatryan" created="Mon, 23 Aug 2021 12:28:04 +0000"  >&lt;p&gt;The lambda that references the task (TaskExecutor$$Lambda$1325#1) is likely&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/flink/blob/48f531d290dae7783f44f29f3a7e7eec07a12313/flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java#L739&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;task::isBackPressured&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To sum up:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;TaskExecutor creates some metrics for each task that reference this task&lt;/li&gt;
	&lt;li&gt;Those metrics are added to InMemoryReporter&lt;/li&gt;
	&lt;li&gt;When the task is removed, the corresponding metrics are only scheduled for removal from InMemoryReporter&lt;/li&gt;
	&lt;li&gt;With many restarts during the test, InMemoryReporter references all previous attempts and prevents GC&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I see the following solutions:&lt;br/&gt;
1. Disable InMemoryReporter by default&lt;br/&gt;
2. Disable InMemoryReporter for this and similar tests&lt;br/&gt;
3. Try to cleanup references (i.e. null out task reference in metric when the task is removed)&lt;/p&gt;

&lt;p&gt;The latter seems very fragile and modifying production code only for tests.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arvid&quot; class=&quot;user-hover&quot; rel=&quot;arvid&quot;&gt;arvid&lt;/a&gt; WDYT? &lt;/p&gt;</comment>
                            <comment id="17403203" author="till.rohrmann" created="Mon, 23 Aug 2021 14:10:50 +0000"  >&lt;p&gt;Why can&apos;t we remove the metrics right away? Is this some special behaviour for some tests that we need but for other tests this falls on our toes &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=arvid&quot; class=&quot;user-hover&quot; rel=&quot;arvid&quot;&gt;arvid&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17403204" author="arvid" created="Mon, 23 Aug 2021 14:12:45 +0000"  >&lt;p&gt;Wow thanks for the in-depth analysis.&lt;br/&gt;
I think I&apos;ll fix that in the InMemoryReporter (remove all metrics eagerly unless explicitly stated in `InMemoryReporterRule`) or overhaul the whole mechanic (only register when there is a `InMemoryReporterRule`).&lt;br/&gt;
Can I take this ticket?&lt;/p&gt;</comment>
                            <comment id="17403208" author="roman_khachatryan" created="Mon, 23 Aug 2021 14:26:39 +0000"  >&lt;p&gt;Sure, please take it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="17405706" author="arvid" created="Fri, 27 Aug 2021 09:25:12 +0000"  >&lt;p&gt;Merged into master as 3dbd9e785394590bf52fd7dc41c00c5254a4de24..126fafc25d8769e1cdcd8d88e153bc33dbc95c61.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13392258">FLINK-23525</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13393764">FLINK-23652</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13032310" name="Screenshot_2021-08-23_13-34-31.png" size="112728" author="roman" created="Mon, 23 Aug 2021 11:34:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 11 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0txi8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>