<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:19:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-33863] Compressed Operator state restore failed</title>
                <link>https://issues.apache.org/jira/browse/FLINK-33863</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;We encountered an issue when using Flink 1.18.0. Our job enabled Snapshot Compression and used multiple operator states and broadcast states in an operator. When recovering Operator State from a Savepoint, the following error occurred: &quot;org.xerial.snappy.SnappyFramedInputStream: encountered EOF while reading stream header.&quot;&lt;/p&gt;

&lt;p&gt;After researching, I believe the error is due to Flink 1.18.0&apos;s support for Snapshot Compression on Operator State (see &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-30113&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-30113&lt;/a&gt; ). When writing a Savepoint, SnappyFramedInputStream adds a header to the beginning of the data. When recovering Operator State from a Savepoint, SnappyFramedInputStream verifies the header from the beginning of the data.&lt;/p&gt;

&lt;p&gt;Currently, when recovering Operator State with Snapshot Compression enabled, the logic is as follows:&lt;br/&gt;
For each OperatorStateHandle:&lt;br/&gt;
1. Verify if the current Savepoint stream&apos;s offset is the Snappy header.&lt;br/&gt;
2. Seek to the state&apos;s start offset.&lt;br/&gt;
3. Read the state&apos;s data and finally seek to the state&apos;s end offset.&lt;br/&gt;
(See: &lt;a href=&quot;https://github.com/apache/flink/blob/ef2b626d67147797e992ec3b338bafdb4e5ab1c7/flink-runtime/src/main/java/org/apache/flink/runtime/state/OperatorStateRestoreOperation.java#L172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/ef2b626d67147797e992ec3b338bafdb4e5ab1c7/flink-runtime/src/main/java/org/apache/flink/runtime/state/OperatorStateRestoreOperation.java#L172&lt;/a&gt; )&lt;/p&gt;

&lt;p&gt;Furthermore, when there are multiple Operator States, they are not sorted according to the Operator State&apos;s offset. The broadcast states will always be written to the end of the savepoint. However when reading from savepoint, there are no guarantee that broadcast states will be read at last.&lt;/p&gt;

&lt;p&gt;Therefore, if the Operator States are out of order and the final offset is recovered first, the Savepoint stream will be seeked to the end, resulting in an EOF error.&lt;/p&gt;

&lt;p&gt;I propose a solution: sort the OperatorStateHandle by offset and then recover the Operator State in order. After testing, this approach resolves the issue.&lt;/p&gt;

&lt;p&gt;I will submit a PR. This is my first time contributing code, so any help is really appreciated.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13562069">FLINK-33863</key>
            <summary>Compressed Operator state restore failed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ruibin">Ruibin Xing</assignee>
                                    <reporter username="ruibin">Ruibin Xing</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sat, 16 Dec 2023 06:12:38 +0000</created>
                <updated>Mon, 15 Jan 2024 18:05:06 +0000</updated>
                            <resolved>Tue, 2 Jan 2024 10:25:29 +0000</resolved>
                                    <version>1.18.0</version>
                                    <fixVersion>1.19.0</fixVersion>
                    <fixVersion>1.18.2</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17798802" author="yanfei lei" created="Wed, 20 Dec 2023 02:49:02 +0000"  >&lt;p&gt;Is it because once the file stream has reached EOF, we can&#8216;t use this stream to build a SnappyFramedInputStream?&lt;/p&gt;</comment>
                            <comment id="17798808" author="JIRAUSER299280" created="Wed, 20 Dec 2023 03:38:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Yanfei+Lei&quot; class=&quot;user-hover&quot; rel=&quot;Yanfei Lei&quot;&gt;Yanfei Lei&lt;/a&gt; Hi, I will try to illustrate this problem with an example:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
       | Snappy Header 1 | State 1 | Snappy Header 2 | State 2 | Snappy Header 3 | State 3 | 
       ^                 ^         ^                                             ^         ^
offset a                 b         c                                             d         e    

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is the layout of a snapshot of compressed operator states.&lt;/p&gt;

&lt;p&gt;If we try to restore it in a sequence of State 1, 3, 2 instead of State 1, 2, 3:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;We will start with offset a.&lt;/li&gt;
	&lt;li&gt;Snappy will verify the header 1 and everything will be ok.&lt;/li&gt;
	&lt;li&gt;We will seek to offset b(from the OperatorStateHandle) and restoring the states until we reach offset C.&lt;/li&gt;
	&lt;li&gt;Now we are restoring State 3,&#160; we will verify the snappy header 2 instead of 3.&lt;/li&gt;
	&lt;li&gt;Then we will seek to offset d and eventually reached offset e.&lt;/li&gt;
	&lt;li&gt;Then we are going to restoring State 2 and when trying to verify the header, an EOF error is thrown.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;So there are two problems if we don&apos;t sort states by offsets before restoring them:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;In step 4, we try to restoring State 3, instead the header of State 2 is verified.&lt;/li&gt;
	&lt;li&gt;There is currently no simple way to seek to the correct header position.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17800702" author="yanfei lei" created="Wed, 27 Dec 2023 07:41:14 +0000"  >&lt;p&gt;Merged via &lt;a href=&quot;https://github.com/apache/flink/commit/d415d93bbf9620ba985136469107edd8c6e31cc6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;d415d93bbf9620ba985136469107edd8c6e31cc6&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17800974" author="martijnvisser" created="Thu, 28 Dec 2023 11:58:02 +0000"  >&lt;p&gt;Shouldn&apos;t this also be backported to 1.18?&lt;/p&gt;</comment>
                            <comment id="17801086" author="JIRAUSER299280" created="Fri, 29 Dec 2023 02:49:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt; I think so. I have created a backport PR for this. &lt;a href=&quot;https://github.com/apache/flink/pull/24008&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/24008&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17801730" author="martijnvisser" created="Tue, 2 Jan 2024 10:25:19 +0000"  >&lt;p&gt;Merged via apache/flink:release-1.18 f9383e6780ae8beb995d9bbd58a8484d19900f55&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13564374">FLINK-34063</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13504782">FLINK-30113</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 45 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1mauo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>