<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:44:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-16070] Blink planner can not extract correct unique key for UpsertStreamTableSink </title>
                <link>https://issues.apache.org/jira/browse/FLINK-16070</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I reproduce an Elasticsearch6UpsertTableSink issue which user reported in mail list&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; that Blink planner&#160;can not extract correct unique key for following query, but legacy planner works well.&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// user code
&lt;/span&gt;INSERT INTO ES6_ZHANGLE_OUTPUT&#160; 
 SELECT aggId, pageId, ts_min as ts,&#160; 
       count(&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; when eventId = &lt;span class=&quot;code-quote&quot;&gt;&apos;exposure&apos;&lt;/span&gt; then 1 &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; end) as expoCnt,&#160; 
       count(&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; when eventId = &lt;span class=&quot;code-quote&quot;&gt;&apos;click&apos;&lt;/span&gt; then 1 &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; end) as clkCnt&#160; 
 FROM&#160; (&#160; &#160; 
     SELECT&#160; &#160; &#160; &#160; 
       &lt;span class=&quot;code-quote&quot;&gt;&apos;ZL_001&apos;&lt;/span&gt; as aggId,
&#160; &#160; &#160; &#160; pageId,&#160; &#160; &#160; &#160; 
        eventId,&#160; &#160; &#160; &#160; 
        recvTime,&#160; &#160; &#160; &#160; 
        ts2Date(recvTime) as ts_min&#160; &#160; 
     from kafka_zl_etrack_event_stream&#160; &#160; 
     where eventId in (&lt;span class=&quot;code-quote&quot;&gt;&apos;exposure&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;click&apos;&lt;/span&gt;)&#160; 
 ) as t1&#160; 
 group by aggId, pageId, ts_min
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I&#160; found that blink planner can not extract correct unique key in `&lt;b&gt;FlinkRelMetadataQuery.getUniqueKeys(relNode)&lt;/b&gt;`, legacy planner works well in&#160; `&lt;b&gt;org.apache.flink.table.plan.util.UpdatingPlanChecker.getUniqueKeyFields(...)&lt;/b&gt; `. A simple ETL job to reproduce this issue can refers&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/Flink-1-10-es-sink-exception-td32773.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/Flink-1-10-es-sink-exception-td32773.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;&lt;a href=&quot;https://github.com/leonardBang/flink-sql-etl/blob/master/etl-job/src/main/java/kafka2es/Kafka2UpsertEs.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/leonardBang/flink-sql-etl/blob/master/etl-job/src/main/java/kafka2es/Kafka2UpsertEs.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13285509">FLINK-16070</key>
            <summary>Blink planner can not extract correct unique key for UpsertStreamTableSink </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="godfreyhe">godfrey he</assignee>
                                    <reporter username="leonard">Leonard Xu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sat, 15 Feb 2020 12:51:54 +0000</created>
                <updated>Mon, 30 Mar 2020 08:00:00 +0000</updated>
                            <resolved>Mon, 30 Mar 2020 08:00:00 +0000</resolved>
                                    <version>1.10.0</version>
                                    <fixVersion>1.10.1</fixVersion>
                    <fixVersion>1.11.0</fixVersion>
                                    <component>Table SQL / Planner</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="17037512" author="leonard xu" created="Sat, 15 Feb 2020 13:01:22 +0000"  >&lt;p&gt;I&apos;m not sure the root cause comes from blink planner or underlying Calcite up to now.&lt;/p&gt;

&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jark&quot; class=&quot;user-hover&quot; rel=&quot;jark&quot;&gt;jark&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danny0405&quot; class=&quot;user-hover&quot; rel=&quot;danny0405&quot;&gt;danny0405&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17037516" author="lzljs3620320" created="Sat, 15 Feb 2020 13:15:36 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Leonard+Xu&quot; class=&quot;user-hover&quot; rel=&quot;Leonard Xu&quot;&gt;Leonard Xu&lt;/a&gt;&#160;, thanks for reporting.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;FlinkRelMdUniqueKeys&lt;/tt&gt; is in the flink code, it deal with unqiue keys, which means maybe it has some bugs lead to this bug. CC author: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=godfreyhe&quot; class=&quot;user-hover&quot; rel=&quot;godfreyhe&quot;&gt;godfreyhe&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17037698" author="danny0405" created="Sun, 16 Feb 2020 04:14:37 +0000"  >&lt;p&gt;Thanks for reporting this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Leonard+Xu&quot; class=&quot;user-hover&quot; rel=&quot;Leonard Xu&quot;&gt;Leonard Xu&lt;/a&gt; ~&lt;/p&gt;

&lt;p&gt;The AggregateProjectPullUpConstantsRule would reduce the constant grouping keys of aggregate, add for blink-planner, we deduce the unique keys with aggregate grouping keys:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  def getUniqueKeysOnAggregate(
      grouping: Array[Int],
      mq: RelMetadataQuery,
      ignoreNulls: &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;): util.Set[ImmutableBitSet] = {
    &lt;span class=&quot;code-comment&quot;&gt;// group by keys form a unique key
&lt;/span&gt;    ImmutableSet.of(ImmutableBitSet.of(grouping.indices: _*))
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To fix this problem, you can append the constant grouping key to he set.&lt;/p&gt;

&lt;p&gt;Actually i&apos;m curious why you need the constant key in the metadata ?&lt;/p&gt;</comment>
                            <comment id="17037708" author="leonard xu" created="Sun, 16 Feb 2020 05:36:04 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danny0405&quot; class=&quot;user-hover&quot; rel=&quot;danny0405&quot;&gt;danny0405&lt;/a&gt;&#160;thank you for your explanation.&lt;br/&gt;
the query comes from user mail list and I think it&apos;s a&#160;corner case too.&lt;/p&gt;</comment>
                            <comment id="17037724" author="jark" created="Sun, 16 Feb 2020 07:22:14 +0000"  >&lt;p&gt;I think this is a bug in the &lt;tt&gt;FlinkRelMdUniqueKeys&lt;/tt&gt;. I didn&apos;t look into the code, I don&apos;t know why it lost the unique key when there is a constant in the group keys. &lt;/p&gt;</comment>
                            <comment id="17037832" author="godfreyhe" created="Sun, 16 Feb 2020 13:36:21 +0000"  >&lt;p&gt;thanks for reporting this bug &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Leonard+Xu&quot; class=&quot;user-hover&quot; rel=&quot;Leonard Xu&quot;&gt;Leonard Xu&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danny0405&quot; class=&quot;user-hover&quot; rel=&quot;danny0405&quot;&gt;danny0405&lt;/a&gt;, the constant value is already in the grouping. the plan is&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Calc(select=[CAST(_UTF-16LE&lt;span class=&quot;code-quote&quot;&gt;&apos;ZL_001&apos;&lt;/span&gt;:VARCHAR(2147483647) CHARACTER SET &lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-16LE&quot;&lt;/span&gt;) AS aggId, pageId, ts, CAST(expoCnt) AS expoCnt, CAST(clkCnt) AS clkCnt])
+- GroupAggregate(groupBy=[aggId, pageId, ts], select=[aggId, pageId, ts, COUNT($f3) AS expoCnt, COUNT($f4) AS clkCnt])
   +- Exchange(distribution=[hash[aggId, pageId, ts]])
      +- Calc(select=[_UTF-16LE&lt;span class=&quot;code-quote&quot;&gt;&apos;ZL_001&apos;&lt;/span&gt; AS aggId, pageId, ts2Date(recvTime) AS ts, CASE(=(eventId, _UTF-16LE&lt;span class=&quot;code-quote&quot;&gt;&apos;exposure&apos;&lt;/span&gt;:VARCHAR(2147483647) CHARACTER SET &lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-16LE&quot;&lt;/span&gt;), 1, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;:INTEGER) AS $f3, CASE(=(eventId, _UTF-16LE&lt;span class=&quot;code-quote&quot;&gt;&apos;click&apos;&lt;/span&gt;:VARCHAR(2147483647) CHARACTER SET &lt;span class=&quot;code-quote&quot;&gt;&quot;UTF-16LE&quot;&lt;/span&gt;), 1, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;:INTEGER) AS $f4], where=[OR(=(eventId, _UTF-16LE&lt;span class=&quot;code-quote&quot;&gt;&apos;exposure&apos;&lt;/span&gt;), =(eventId, _UTF-16LE&lt;span class=&quot;code-quote&quot;&gt;&apos;click&apos;&lt;/span&gt;))])
         +- TableSourceScan(table=[[default_catalog, default_database, csv, source: [CsvTableSource(read fields: pageId, eventId, recvTime)]]], fields=[pageId, eventId, recvTime])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think there are two bugs:&lt;br/&gt;
one is in &lt;tt&gt;FlinkRelMdUniqueKeys&lt;/tt&gt;, project/calc should handle constant field when deriving unique keys.&lt;br/&gt;
and another is the constant value should be removed from grouping key after &lt;tt&gt;AggregateProjectPullUpConstantsRule&lt;/tt&gt; is applied.&lt;/p&gt;

&lt;p&gt;I would like to fix these bugs.&lt;/p&gt;</comment>
                            <comment id="17057087" author="wuyanzu" created="Wed, 11 Mar 2020 15:03:02 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=godfreyhe&quot; class=&quot;user-hover&quot; rel=&quot;godfreyhe&quot;&gt;godfreyhe&lt;/a&gt; .&#160;&lt;/p&gt;

&lt;p&gt;I think meet similar problem in 1.10 . I copy the grammar &apos;EMIT&apos; from blink( add SqlEmit in RichSqlInsert),&#160;&lt;/p&gt;

&lt;p&gt;and the first SQL is OK when translating to stream,&lt;/p&gt;

&lt;p&gt;but the second one that does DATE_FORMAT throw the exception&#65306;&lt;/p&gt;

&lt;p&gt;UpsertStreamTableSink requires that Table has a full primary keys if it is updated.&lt;/p&gt;

&lt;p&gt;is it will be normal after this bug fixed?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INSERT INTO sink1 
SELECT&#160; 
COUNT(DISTINCT tradeNo), 
TUMBLE_START(tradeTimeTs, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;10&apos;&lt;/span&gt; SECOND) as ts 
FROM payInfo GROUP BY TUMBLE(tradeTimeTs, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;10&apos;&lt;/span&gt; SECOND) 
EMIT WITH DELAY &lt;span class=&quot;code-quote&quot;&gt;&apos;2&apos;&lt;/span&gt; SECOND BEFORE WATERMARK

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INSERT INTO sink1 
SELECT&#160;
COUNT(DISTINCT tradeNo), 
DATE_FORMT(TUMBLE_START(tradeTimeTs, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;10&apos;&lt;/span&gt; SECOND),&lt;span class=&quot;code-quote&quot;&gt;&apos;yyyyMMddHHmmss&apos;&lt;/span&gt;) as ts 
FROM payInfo GROUP BY TUMBLE(tradeTimeTs, INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;10&apos;&lt;/span&gt; SECOND) 
EMIT WITH DELAY &lt;span class=&quot;code-quote&quot;&gt;&apos;2&apos;&lt;/span&gt; SECOND BEFORE WATERMARK

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17057518" author="godfreyhe" created="Thu, 12 Mar 2020 01:47:05 +0000"  >&lt;p&gt;hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wuyanzu&quot; class=&quot;user-hover&quot; rel=&quot;wuyanzu&quot;&gt;wuyanzu&lt;/a&gt; you can apply the &lt;a href=&quot;https://github.com/apache/flink/pull/11158&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt; to your local env. I will push this pr forward asap. &lt;/p&gt;</comment>
                            <comment id="17070768" author="lzljs3620320" created="Mon, 30 Mar 2020 08:00:00 +0000"  >&lt;p&gt;master:&#160;179d7a64983e3a1a7e3bc956891e2a24d84248bc&lt;/p&gt;

&lt;p&gt;release-1.10:&#160;841c5207e2bc0db9db5f34b4387311e40289a246&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12996497" name="image-2020-03-12-14-07-37-429.png" size="97831" author="wuyanzu" created="Thu, 12 Mar 2020 06:07:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 33 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0bj5c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>