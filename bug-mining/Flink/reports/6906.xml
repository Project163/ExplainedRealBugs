<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:16:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-30561] ChangelogStreamHandleReaderWithCache cause FileNotFoundException</title>
                <link>https://issues.apache.org/jira/browse/FLINK-30561</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When a job with state changelog enabled continues to restart, the following exceptions may occur :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.RuntimeException: java.io.FileNotFoundException: /data1/hadoop/yarn/nm-local-dir/usercache/hadoop-rt/appcache/application_1671689962742_1333392/dstl-cache-file/dstl6215344559415829831.tmp (No such file or directory)
&#160; &#160; at org.apache.flink.util.ExceptionUtils.rethrow(ExceptionUtils.java:321)
&#160; &#160; at org.apache.flink.runtime.state.changelog.StateChangelogHandleStreamHandleReader$1.advance(StateChangelogHandleStreamHandleReader.java:87)
&#160; &#160; at org.apache.flink.runtime.state.changelog.StateChangelogHandleStreamHandleReader$1.hasNext(StateChangelogHandleStreamHandleReader.java:69)
&#160; &#160; at org.apache.flink.state.changelog.restore.ChangelogBackendRestoreOperation.readBackendHandle(ChangelogBackendRestoreOperation.java:107)
&#160; &#160; at org.apache.flink.state.changelog.restore.ChangelogBackendRestoreOperation.restore(ChangelogBackendRestoreOperation.java:78)
&#160; &#160; at org.apache.flink.state.changelog.ChangelogStateBackend.restore(ChangelogStateBackend.java:94)
&#160; &#160; at org.apache.flink.state.changelog.AbstractChangelogStateBackend.createKeyedStateBackend(AbstractChangelogStateBackend.java:136)
&#160; &#160; at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.lambda$keyedStatedBackend$1(StreamTaskStateInitializerImpl.java:336)
&#160; &#160; at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.attemptCreateAndRestore(BackendRestorerProcedure.java:168)
&#160; &#160; at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.createAndRestore(BackendRestorerProcedure.java:135)
&#160; &#160; at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.keyedStatedBackend(StreamTaskStateInitializerImpl.java:353)
&#160; &#160; at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.streamOperatorStateContext(StreamTaskStateInitializerImpl.java:165)
&#160; &#160; at org.apache.flink.streaming.api.operators.AbstractStreamOperator.initializeState(AbstractStreamOperator.java:265)
&#160; &#160; at org.apache.flink.streaming.runtime.tasks.RegularOperatorChain.initializeStateAndOpenOperators(RegularOperatorChain.java:106)
&#160; &#160; at org.apache.flink.streaming.runtime.tasks.StreamTask.restoreGates(StreamTask.java:726)
&#160; &#160; at org.apache.flink.streaming.runtime.tasks.StreamTaskActionExecutor$1.call(StreamTaskActionExecutor.java:55)
&#160; &#160; at org.apache.flink.streaming.runtime.tasks.StreamTask.restoreInternal(StreamTask.java:702)
&#160; &#160; at org.apache.flink.streaming.runtime.tasks.StreamTask.restore(StreamTask.java:669)
&#160; &#160; at org.apache.flink.runtime.taskmanager.Task.runWithSystemExitMonitoring(Task.java:935)
&#160; &#160; at org.apache.flink.runtime.taskmanager.Task.restoreAndInvoke(Task.java:904)
&#160; &#160; at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:728)
&#160; &#160; at org.apache.flink.runtime.taskmanager.Task.run(Task.java:550)
&#160; &#160; at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.io.FileNotFoundException: /data1/hadoop/yarn/nm-local-dir/usercache/hadoop-rt/appcache/application_1671689962742_1333392/dstl-cache-file/dstl6215344559415829831.tmp (No such file or directory)
&#160; &#160; at java.io.FileInputStream.open0(Native Method)
&#160; &#160; at java.io.FileInputStream.open(FileInputStream.java:195)
&#160; &#160; at java.io.FileInputStream.&amp;amp;lt;init&amp;amp;gt;(FileInputStream.java:138)
&#160; &#160; at org.apache.flink.changelog.fs.ChangelogStreamHandleReaderWithCache.openAndSeek(ChangelogStreamHandleReaderWithCache.java:158)
&#160; &#160; at org.apache.flink.changelog.fs.ChangelogStreamHandleReaderWithCache.openAndSeek(ChangelogStreamHandleReaderWithCache.java:95)
&#160; &#160; at org.apache.flink.changelog.fs.StateChangeIteratorImpl.read(StateChangeIteratorImpl.java:42)
&#160; &#160; at org.apache.flink.runtime.state.changelog.StateChangelogHandleStreamHandleReader$1.advance(StateChangelogHandleStreamHandleReader.java:85)
&#160; &#160; ... 21 more &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;Problem causes&#65306;&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;b&gt;&lt;em&gt;ChangelogStreamHandleReaderWithCache&lt;/em&gt;&lt;/b&gt; use RefCountedFile manager local cache file. The reference count is incremented when the input stream is opened from the cache file, and decremented by one when the input stream is closed. So the input stream must be closed and only once.&lt;/li&gt;
	&lt;li&gt;&lt;em&gt;&lt;b&gt;StateChangelogHandleStreamHandleReader#getChanges()&lt;/b&gt;&lt;/em&gt; may cause the input stream to be closed twice. This happens when changeIterator.read(tuple2.f0, tuple2.f1) throws an exception (for example, when the task is canceled for other reasons during the restore process) the current state change iterator will be closed twice.&lt;/li&gt;
&lt;/ol&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void advance() {
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!current.hasNext() &amp;amp;&amp;amp; handleIterator.hasNext()) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            current.close();
            Tuple2&amp;lt;StreamStateHandle, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; tuple2 = handleIterator.next();
            LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;read at {} from {}&quot;&lt;/span&gt;, tuple2.f1, tuple2.f0);
            current = changeIterator.read(tuple2.f0, tuple2.f1);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            ExceptionUtils.rethrow(e);
        }
    }
}

@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    current.close();
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So we should make sure current state change iterator only be closed once. I suggest to make the following changes to &lt;em&gt;&lt;b&gt;StateChangelogHandleStreamHandleReader&lt;/b&gt;&lt;/em&gt;&#160;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; currentClosed = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void advance() {
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!current.hasNext() &amp;amp;&amp;amp; handleIterator.hasNext()) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            current.close();
            currentClosed = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;

            Tuple2&amp;lt;StreamStateHandle, &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;&amp;gt; tuple2 = handleIterator.next();
            LOG.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;read at {} from {}&quot;&lt;/span&gt;, tuple2.f1, tuple2.f0);
            current = changeIterator.read(tuple2.f0, tuple2.f1);
            currentClosed = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            ExceptionUtils.rethrow(e);
        }
    }
}

@Override
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!currentClosed) {
        current.close();
    }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yuanmei&quot; class=&quot;user-hover&quot; rel=&quot;yuanmei&quot;&gt;yuanmei&lt;/a&gt; , &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt; .&lt;/p&gt;</description>
                <environment></environment>
        <key id="13516470">FLINK-30561</key>
            <summary>ChangelogStreamHandleReaderWithCache cause FileNotFoundException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Feifan Wang">Feifan Wang</assignee>
                                    <reporter username="Feifan Wang">Feifan Wang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 4 Jan 2023 12:49:24 +0000</created>
                <updated>Fri, 10 Feb 2023 12:21:16 +0000</updated>
                            <resolved>Fri, 10 Feb 2023 12:21:16 +0000</resolved>
                                    <version>1.16.0</version>
                    <version>1.17.0</version>
                                    <fixVersion>1.17.0</fixVersion>
                    <fixVersion>1.16.2</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17654744" author="masteryhx" created="Thu, 5 Jan 2023 05:39:06 +0000"  >&lt;p&gt;It seems&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-30107&quot; title=&quot;Unstable test ChangelogRecoveryITCase#testMaterialization failed on azure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-30107&quot;&gt;&lt;del&gt;FLINK-30107&lt;/del&gt;&lt;/a&gt; and&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-28898&quot; title=&quot;ChangelogRecoverySwitchStateBackendITCase.testSwitchFromEnablingToDisablingWithRescalingOut failed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-28898&quot;&gt;&lt;del&gt;FLINK-28898&lt;/del&gt;&lt;/a&gt; are caused by this ?&lt;/p&gt;</comment>
                            <comment id="17654843" author="feifan wang" created="Thu, 5 Jan 2023 07:54:26 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=masteryhx&quot; class=&quot;user-hover&quot; rel=&quot;masteryhx&quot;&gt;masteryhx&lt;/a&gt; ,&#160; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-30107&quot; title=&quot;Unstable test ChangelogRecoveryITCase#testMaterialization failed on azure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-30107&quot;&gt;&lt;del&gt;FLINK-30107&lt;/del&gt;&lt;/a&gt;&#160;and&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-28898&quot; title=&quot;ChangelogRecoverySwitchStateBackendITCase.testSwitchFromEnablingToDisablingWithRescalingOut failed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-28898&quot;&gt;&lt;del&gt;FLINK-28898&lt;/del&gt;&lt;/a&gt; are caused by origin changelog file not found , the problem described by this ticket is local cached file not found.&lt;/p&gt;</comment>
                            <comment id="17655240" author="yanfei lei" created="Fri, 6 Jan 2023 04:23:09 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Feifan+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Feifan Wang&quot;&gt;Feifan Wang&lt;/a&gt;, could you please share what circumstances the error occurs?&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt; This happens when changeIterator.read(tuple2.f0, tuple2.f1) throws an exception (for example, when the task is canceled for other reasons during the restore process)&#160;&lt;/p&gt;

&lt;p&gt;IIUC, when the task is canceled for other reason, the whole job is canceled, for the next restart, the `FileNotFoundException` will not affect the next run, and the refCount would be reset in the next run. Will the previous refCount still be used after the job is canceled?&lt;/p&gt;</comment>
                            <comment id="17655410" author="feifan wang" created="Fri, 6 Jan 2023 11:43:49 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Yanfei+Lei&quot; class=&quot;user-hover&quot; rel=&quot;Yanfei Lei&quot;&gt;Yanfei Lei&lt;/a&gt; ,&#160;ChangelogStreamHandleReaderWithCache live across job attempts for providing higher cache hit radio, the previous refCount still used after job restarted.&lt;/p&gt;</comment>
                            <comment id="17655905" author="yanfei lei" created="Mon, 9 Jan 2023 04:41:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Feifan+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Feifan Wang&quot;&gt;Feifan Wang&lt;/a&gt; Thanks for the clarification. I think this makes sense in case the TM process doesn&apos;t restart when the job failover.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17677225" author="feifan wang" created="Mon, 16 Jan 2023 08:26:54 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ym&quot; class=&quot;user-hover&quot; rel=&quot;ym&quot;&gt;ym&lt;/a&gt;&#160; , I submitted a pr to fix this problem, can you help me review it ?&lt;/p&gt;</comment>
                            <comment id="17680850" author="feifan wang" created="Thu, 26 Jan 2023 01:19:40 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman&quot; class=&quot;user-hover&quot; rel=&quot;roman&quot;&gt;roman&lt;/a&gt;&#160; , I submitted a pr to fix this problem, can you help me review it ?&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17687052" author="roman_khachatryan" created="Fri, 10 Feb 2023 12:21:16 +0000"  >&lt;p&gt;Thanks for the fix &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Feifan+Wang&quot; class=&quot;user-hover&quot; rel=&quot;Feifan Wang&quot;&gt;Feifan Wang&lt;/a&gt; !&lt;/p&gt;

&lt;p&gt;Merged into master as ba2b55df207fb79ad776eaf64ec8a6c1ab27bac9,&lt;/p&gt;

&lt;p&gt;into 1.17 as 0d14c6188252fadc1408034d73f232312c2f683f,&lt;/p&gt;

&lt;p&gt;into 1.16 as 526d6f949356d65d685bdd223cc5dd71a3997135.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13476077">FLINK-28898</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13504745">FLINK-30107</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13470496">FLINK-28440</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 39 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ej1c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>