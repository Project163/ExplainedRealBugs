<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:56:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-22340] Concurrent access to ThresholdMeter may lead to NPE</title>
                <link>https://issues.apache.org/jira/browse/FLINK-22340</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;It is reported on github &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; that NPE is thrown from ThreasholdMeter, which is likely caused by concurrent accesses.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/flink/commit/b9e576fb845b817d804da3d68471ff8a4723dcf3#commitcomment-49681105&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/b9e576fb845b817d804da3d68471ff8a4723dcf3#commitcomment-49681105&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13373451">FLINK-22340</key>
            <summary>Concurrent access to ThresholdMeter may lead to NPE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xtsong">Xintong Song</assignee>
                                    <reporter username="xtsong">Xintong Song</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 19 Apr 2021 05:31:56 +0000</created>
                <updated>Sat, 28 Aug 2021 11:14:53 +0000</updated>
                            <resolved>Mon, 19 Apr 2021 11:37:33 +0000</resolved>
                                    <version>1.13.0</version>
                                    <fixVersion>1.13.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17324710" author="jiamo" created="Mon, 19 Apr 2021 06:01:13 +0000"  >&lt;p&gt;I copy the&#160;ThreasholdMeter for custom use. And got this NPE:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.NullPointerException at com.papayamobile.streaming.ThresholdMeter.getEventCountsRecentInterval(ThresholdMeter.java:67) at com.papayamobile.streaming.ThresholdMeter.checkAgainstThreshold(ThresholdMeter.java:56) at com.papayamobile.streaming.StreamingClickJob$ToClick.flatMap(StreamingClickJob.java:66) at com.papayamobile.streaming.StreamingClickJob$ToClick.flatMap(StreamingClickJob.java:42) at org.apache.flink.streaming.api.operators.StreamFlatMap.processElement(StreamFlatMap.java:47) at org.apache.flink.streaming.runtime.tasks.CopyingChainingOutput.pushToOperator(CopyingChainingOutput.java:71) at org.apache.flink.streaming.runtime.tasks.CopyingChainingOutput.collect(CopyingChainingOutput.java:46) at org.apache.flink.streaming.runtime.tasks.CopyingChainingOutput.collect(CopyingChainingOutput.java:26) at org.apache.flink.streaming.api.operators.CountingOutput.collect(CountingOutput.java:50) at org.apache.flink.streaming.api.operators.CountingOutput.collect(CountingOutput.java:28) at org.apache.flink.streaming.api.operators.StreamSourceContexts$ManualWatermarkContext.processAndCollectWithTimestamp(StreamSourceContexts.java:322) at org.apache.flink.streaming.api.operators.StreamSourceContexts$WatermarkContext.collectWithTimestamp(StreamSourceContexts.java:426) at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher.emitRecordAndUpdateState(KinesisDataFetcher.java:986) at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher.access$000(KinesisDataFetcher.java:111) at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher$AsyncKinesisRecordEmitter.emit(KinesisDataFetcher.java:314) at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher$SyncKinesisRecordEmitter$1.put(KinesisDataFetcher.java:331) at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher$SyncKinesisRecordEmitter$1.put(KinesisDataFetcher.java:328) at org.apache.flink.streaming.connectors.kinesis.internals.KinesisDataFetcher.emitRecordAndUpdateState(KinesisDataFetcher.java:970) at org.apache.flink.streaming.connectors.kinesis.internals.ShardConsumer.deserializeRecordForCollectionAndUpdateState(ShardConsumer.java:209) at org.apache.flink.streaming.connectors.kinesis.internals.ShardConsumer.lambda$run$0(ShardConsumer.java:125) at org.apache.flink.streaming.connectors.kinesis.internals.publisher.polling.AdaptivePollingRecordPublisher.lambda$run$0(AdaptivePollingRecordPublisher.java:77) at org.apache.flink.streaming.connectors.kinesis.internals.publisher.polling.PollingRecordPublisher.run(PollingRecordPublisher.java:117) at org.apache.flink.streaming.connectors.kinesis.internals.publisher.polling.AdaptivePollingRecordPublisher.run(AdaptivePollingRecordPublisher.java:75) at org.apache.flink.streaming.connectors.kinesis.internals.ShardConsumer.run(ShardConsumer.java:113) at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) at java.util.concurrent.FutureTask.run(FutureTask.java:266) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And jus use `ThreasholdMeter` in normal case:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ToClick &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; RichFlatMapFunction&amp;lt;ObjectNode, Click&amp;gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;transient&lt;/span&gt; ThresholdMeter meter;
      &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;transient&lt;/span&gt; SimpleCounter counter;
      &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; MetricGroup group;

      @Override
      &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void open(org.apache.flink.configuration.Configuration parameters) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
         group = getRuntimeContext()
               .getMetricGroup().addGroup(&lt;span class=&quot;code-quote&quot;&gt;&quot;Click&quot;&lt;/span&gt;);
         meter = group.meter(&lt;span class=&quot;code-quote&quot;&gt;&quot;1seconds&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThresholdMeter(30000, Duration.ofSeconds(1)));
         counter = group.counter(&lt;span class=&quot;code-quote&quot;&gt;&quot;totalCount&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleCounter());
      }


      @Override
      &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void flatMap(ObjectNode object, Collector&amp;lt;Click&amp;gt; out) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {

          ObjectMapper mapper = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ObjectMapper();
          Click click = mapper.readValue(object.toString(), Click.class);
          meter.markEvent();
          counter.inc();
          meter.checkAgainstThreshold();
          out.collect(click);

      }
   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As xintongsong said&lt;br/&gt;
&quot; ThresholdMeter is a Flink runtime internal class. It should not be used in a user defined function. &quot;&lt;/p&gt;

&lt;p&gt;Is there a more better way to achieve the same effect?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17324739" author="xintongsong" created="Mon, 19 Apr 2021 06:50:51 +0000"  >&lt;p&gt;Thanks for the info, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jiamo&quot; class=&quot;user-hover&quot; rel=&quot;jiamo&quot;&gt;jiamo&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Despite the reported problem happens in a user defined function, which is not how &lt;tt&gt;ThresholdMeter&lt;/tt&gt; is expected to be used, the same problem can also happen for the runtime internals. Thus, we need to fix this anyway. I&apos;ve opened a PR to make &lt;tt&gt;ThresholdMeter&lt;/tt&gt; thread safe.&lt;/p&gt;

&lt;p&gt;In your case, I would suggest to use &lt;tt&gt;MeterView&lt;/tt&gt;. One of the reasons we make &lt;tt&gt;ThresholdMeter&lt;/tt&gt; an internal class is that, it is not optimized for performance critical scenarios. Notice that a user defined function can be invoked on every data record, which makes it extremely sensitive to the performance. &lt;tt&gt;MeterView&lt;/tt&gt; updates the rate with a background thread, and reduces the computation overhead by maintaining a history of events count. However, that means you would need do the threshold checking yourselves.&lt;/p&gt;</comment>
                            <comment id="17324957" author="xintongsong" created="Mon, 19 Apr 2021 11:37:34 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;master (1.14): 6c58832852239cf7c04c72ac337dc12dbee0c178&lt;/li&gt;
	&lt;li&gt;release-1.13: 021cf0b26dc1d0221ce07162f45c06b7854bb84b&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 30 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0q6e8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>