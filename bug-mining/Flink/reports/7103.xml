<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:17:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-32204] ZooKeeperLeaderElectionTest.testZooKeeperReelectionWithReplacement fails with The ExecutorService is shut down already. No Callables can be executed on AZP</title>
                <link>https://issues.apache.org/jira/browse/FLINK-32204</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=49386&amp;amp;view=logs&amp;amp;j=0da23115-68bb-5dcd-192c-bd4c8adebde1&amp;amp;t=24c3384f-1bcb-57b3-224f-51bf973bbee8&amp;amp;l=7095&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This build&lt;/a&gt; fails as&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
May 25 18:45:50 Caused by: java.util.concurrent.RejectedExecutionException: The ExecutorService is shut down already. No Callables can be executed.
May 25 18:45:50 	at org.apache.flink.util.concurrent.DirectExecutorService.throwRejectedExecutionExceptionIfShutdown(DirectExecutorService.java:237)
May 25 18:45:50 	at org.apache.flink.util.concurrent.DirectExecutorService.submit(DirectExecutorService.java:100)
May 25 18:45:50 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.recipes.cache.TreeCache.publishEvent(TreeCache.java:902)
May 25 18:45:50 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.recipes.cache.TreeCache.publishEvent(TreeCache.java:894)
May 25 18:45:50 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.recipes.cache.TreeCache.access$1200(TreeCache.java:79)
May 25 18:45:50 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.recipes.cache.TreeCache$TreeNode.processResult(TreeCache.java:489)
May 25 18:45:50 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.imps.CuratorFrameworkImpl.sendToBackgroundCallback(CuratorFrameworkImpl.java:926)
May 25 18:45:50 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.imps.CuratorFrameworkImpl.processBackgroundOperation(CuratorFrameworkImpl.java:683)
May 25 18:45:50 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.imps.WatcherRemovalFacade.processBackgroundOperation(WatcherRemovalFacade.java:152)
May 25 18:45:50 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.imps.GetDataBuilderImpl$3.processResult(GetDataBuilderImpl.java:272)
May 25 18:45:50 	at org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:634)
May 25 18:45:50 	at org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:553)
May 25 18:45:50
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13537766">FLINK-32204</key>
            <summary>ZooKeeperLeaderElectionTest.testZooKeeperReelectionWithReplacement fails with The ExecutorService is shut down already. No Callables can be executed on AZP</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mapohl">Matthias Pohl</assignee>
                                    <reporter username="Sergey Nuyanzin">Sergey Nuyanzin</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Fri, 26 May 2023 08:03:40 +0000</created>
                <updated>Tue, 13 Jun 2023 07:16:09 +0000</updated>
                            <resolved>Tue, 13 Jun 2023 07:16:09 +0000</resolved>
                                    <version>1.18.0</version>
                                    <fixVersion>1.18.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17726540" author="mapohl" created="Fri, 26 May 2023 09:10:03 +0000"  >&lt;p&gt;Thanks for reporting the issue. I&apos;m going to have a look. &lt;del&gt;But I suspect it not being related to the &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-26522&quot; title=&quot;FLIP-285: Refactoring code for multiple component leader election&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-26522&quot;&gt;&lt;del&gt;FLINK-26522&lt;/del&gt;&lt;/a&gt; changes because the test still relies on the legacy &lt;tt&gt;LeaderElectionDriver&lt;/tt&gt; implementation of ZooKeeper.&lt;/del&gt; This specific test utilizes the &lt;tt&gt;DefaultLeaderElectionService&lt;/tt&gt; which was touched in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-31838&quot; title=&quot;Move thread handling from DefaultMultipleComponentLeaderElectionService into DefaultLeaderElectionService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-31838&quot;&gt;&lt;del&gt;FLINK-31838&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-31773&quot; title=&quot;Separate DefaultLeaderElectionService.start(LeaderContender) into two separate methods for starting the driver and registering a contender&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-31773&quot;&gt;&lt;del&gt;FLINK-31773&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17726545" author="mapohl" created="Fri, 26 May 2023 09:15:44 +0000"  >&lt;p&gt;FYI: CI failed on &lt;a href=&quot;https://github.com/apache/flink/commit/a4de8945&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a4de8945&lt;/a&gt;. That version didn&apos;t include &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-31776&quot; title=&quot; Introducing sub-interface LeaderElectionService.LeaderElection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-31776&quot;&gt;&lt;del&gt;FLINK-31776&lt;/del&gt;&lt;/a&gt;, yet.&lt;/p&gt;</comment>
                            <comment id="17726580" author="mapohl" created="Fri, 26 May 2023 10:49:22 +0000"  >&lt;p&gt;It&apos;s most likely being caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-31995&quot; title=&quot;DirectExecutorService doesn&amp;#39;t follow the ExecutorService contract throwing a RejectedExecutionException in case it&amp;#39;s already shut down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-31995&quot;&gt;&lt;del&gt;FLINK-31995&lt;/del&gt;&lt;/a&gt;. The &lt;tt&gt;ZooKeeperLeaderElectionDriver&lt;/tt&gt; uses a &lt;tt&gt;DirectExecutorService&lt;/tt&gt; in for the &lt;tt&gt;TreeCache&lt;/tt&gt;. The &lt;tt&gt;RejectedExecutionException&lt;/tt&gt; handling was added in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-31995&quot; title=&quot;DirectExecutorService doesn&amp;#39;t follow the ExecutorService contract throwing a RejectedExecutionException in case it&amp;#39;s already shut down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-31995&quot;&gt;&lt;del&gt;FLINK-31995&lt;/del&gt;&lt;/a&gt;. So, it could be that it reveals a bug in some other code which was just not visible before.&lt;/p&gt;</comment>
                            <comment id="17726613" author="mapohl" created="Fri, 26 May 2023 12:38:41 +0000"  >&lt;p&gt;The curator&apos;s &lt;tt&gt;TreeCache&lt;/tt&gt; isn&apos;t thread-safe: The event processing within the cache happens is triggered from within the client&apos;s EventThread and calls &lt;tt&gt;TreeCache#publishEvent&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[...]
May 25 18:45:50 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.recipes.cache.TreeCache.publishEvent(TreeCache.java:902)
May 25 18:45:50 	at org.apache.flink.shaded.curator5.org.apache.curator.framework.recipes.cache.TreeCache.publishEvent(TreeCache.java:894)
[...]
May 25 18:45:50 	at org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:634)
May 25 18:45:50 	at org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:553)
[...]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;tt&gt;TreeCache#publishEvent&lt;/tt&gt; will submit a new task to the cache&apos;s &lt;tt&gt;executorService&lt;/tt&gt; (see &lt;a href=&quot;https://github.com/apache/curator/blob/844c0ad36340b695b2784489c078cfd78522143c/curator-recipes/src/main/java/org/apache/curator/framework/recipes/cache/TreeCache.java#L901&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;TreeCache:901&lt;/a&gt;) which is a &lt;tt&gt;directExecutorService&lt;/tt&gt; in the case of Flink&apos;s ZooKeeper LeaderElectionDriver implementations (see &lt;a href=&quot;https://github.com/apache/flink/blob/4576e4384ff36623712043564039f654c3b44a30/flink-runtime/src/main/java/org/apache/flink/runtime/util/ZooKeeperUtils.java#L764&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ZooKeeperUtils:764&lt;/a&gt; for the legacy &lt;tt&gt;ZooKeeperLeaderElectionDriver&lt;/tt&gt; and &lt;a href=&quot;https://github.com/apache/flink/blob/8ddfd590ebba7fc727e79db41b82d3d40a02b56a/flink-runtime/src/main/java/org/apache/flink/runtime/leaderelection/ZooKeeperMultipleComponentLeaderElectionDriver.java#L76&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ZooKeeperMultipleComponentLeaderElectionDriver:76&lt;/a&gt;). The close call happens in the test&apos;s main thread.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;TreeCache#close&lt;/tt&gt; call sets the cache&apos;s state to &lt;tt&gt;CLOSED&lt;/tt&gt; in &lt;a href=&quot;https://github.com/apache/curator/blob/844c0ad36340b695b2784489c078cfd78522143c/curator-recipes/src/main/java/org/apache/curator/framework/recipes/cache/TreeCache.java#L628&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;TreeCache:628&lt;/a&gt;. &lt;tt&gt;TreeCache#publishEvent&lt;/tt&gt; checks this state in &lt;a href=&quot;https://github.com/apache/curator/blob/844c0ad36340b695b2784489c078cfd78522143c/curator-recipes/src/main/java/org/apache/curator/framework/recipes/cache/TreeCache.java#L898&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;TreeCache:898&lt;/a&gt;. The latter one doesn&apos;t use a lock. This can cause a race condition where the &lt;tt&gt;publishEvent&lt;/tt&gt; method is called and passes the if condition before the test&apos;s main thread can trigger the close method but after the task is actually submitted causing the &lt;tt&gt;RejectedExecutionException&lt;/tt&gt; which we&apos;re observing right now.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dmvk&quot; class=&quot;user-hover&quot; rel=&quot;dmvk&quot;&gt;dmvk&lt;/a&gt; may you verify my finding? I would suggest adding a less restrictive version of the &lt;tt&gt;DirectExecutorService&lt;/tt&gt; that we could use in the production code to avoid running into this bug. We could continue to use the more restrictive version (which was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-31995&quot; title=&quot;DirectExecutorService doesn&amp;#39;t follow the ExecutorService contract throwing a RejectedExecutionException in case it&amp;#39;s already shut down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-31995&quot;&gt;&lt;del&gt;FLINK-31995&lt;/del&gt;&lt;/a&gt;) in the test code. WDYT David?&lt;/p&gt;</comment>
                            <comment id="17726616" author="mapohl" created="Fri, 26 May 2023 12:47:17 +0000"  >&lt;p&gt;FYI: I couldn&apos;t reproduce the error locally with 10000 test executions.&lt;/p&gt;</comment>
                            <comment id="17727383" author="mapohl" created="Tue, 30 May 2023 08:04:54 +0000"  >&lt;p&gt;Looking into the code once more: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-31995&quot; title=&quot;DirectExecutorService doesn&amp;#39;t follow the ExecutorService contract throwing a RejectedExecutionException in case it&amp;#39;s already shut down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-31995&quot;&gt;&lt;del&gt;FLINK-31995&lt;/del&gt;&lt;/a&gt; in general is problematic because we use &lt;tt&gt;DirectExecutorService.INSTANCE&lt;/tt&gt; in several places as a singleton. We should through a &lt;tt&gt;RejectedExecutionException&lt;/tt&gt; in these cases because that might influence other classes which use the very same executor.&lt;/p&gt;</comment>
                            <comment id="17728944" author="yunta" created="Sat, 3 Jun 2023 09:49:30 +0000"  >&lt;p&gt;Another instance: &lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=49593&amp;amp;view=logs&amp;amp;j=0da23115-68bb-5dcd-192c-bd4c8adebde1&amp;amp;t=24c3384f-1bcb-57b3-224f-51bf973bbee8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=49593&amp;amp;view=logs&amp;amp;j=0da23115-68bb-5dcd-192c-bd4c8adebde1&amp;amp;t=24c3384f-1bcb-57b3-224f-51bf973bbee8&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17729774" author="sergey nuyanzin" created="Tue, 6 Jun 2023 14:49:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=49606&amp;amp;view=logs&amp;amp;j=f0ac5c25-1168-55a5-07ff-0e88223afed9&amp;amp;t=50bf7a25-bdc4-5e56-5478-c7b4511dde53&amp;amp;l=7108&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=49606&amp;amp;view=logs&amp;amp;j=f0ac5c25-1168-55a5-07ff-0e88223afed9&amp;amp;t=50bf7a25-bdc4-5e56-5478-c7b4511dde53&amp;amp;l=7108&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17731531" author="jark" created="Mon, 12 Jun 2023 09:51:34 +0000"  >&lt;p&gt;ZooKeeperLeaderElectionTest.testZooKeeperReelection&lt;br/&gt;
&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=49893&amp;amp;view=logs&amp;amp;j=0da23115-68bb-5dcd-192c-bd4c8adebde1&amp;amp;t=24c3384f-1bcb-57b3-224f-51bf973bbee8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=49893&amp;amp;view=logs&amp;amp;j=0da23115-68bb-5dcd-192c-bd4c8adebde1&amp;amp;t=24c3384f-1bcb-57b3-224f-51bf973bbee8&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17731921" author="mapohl" created="Tue, 13 Jun 2023 07:16:09 +0000"  >&lt;p&gt;master: df2b9f8d4722c8fc9533656340b9162e0199fb08&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13534922">FLINK-31995</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13493726">FLINK-29813</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 22 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1i5sg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>