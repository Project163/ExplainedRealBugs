<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:33:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9427] Cannot download from BlobServer, because the server address is unknown.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9427</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Setup: 6 + 1 nodes EMR cluster with&#160;m4.4xlarge instances&lt;/p&gt;

&lt;p&gt;Job submission fails in most cases (but not all of them):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[hadoop@ip-172-31-28-17 flink-1.5.0]$ HADOOP_CONF_DIR=/etc/hadoop/conf ./bin/flink run -m yarn-cluster -p 80 -yn 80 examples/batch/WordCount.jar --input hdfs:///user/hadoop/enwiki-latest-abstract.xml --output hdfs:///user/hadoop/output

SLF4J: Class path contains multiple SLF4J bindings.

SLF4J: Found binding in [jar:file:/home/hadoop/flink-1.5.0/lib/slf4j-log4j12-1.7.7.jar!/org/slf4j/impl/StaticLoggerBinder.class]

SLF4J: Found binding in [jar:file:/usr/lib/hadoop/lib/slf4j-log4j12-1.7.10.jar!/org/slf4j/impl/StaticLoggerBinder.class]

SLF4J: See http://www.slf4j.org/codes.html#multiple_bindings for an explanation.

SLF4J: Actual binding is of type [org.slf4j.impl.Log4jLoggerFactory]

2018-05-23 15:07:46,062 INFO&#160; org.apache.hadoop.yarn.client.RMProxy &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; - Connecting to ResourceManager at ip-172-31-28-17.eu-central-1.compute.internal/172.31.28.17:8032

2018-05-23 15:07:46,179 INFO&#160; org.apache.flink.yarn.cli.FlinkYarnSessionCli &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; - No path for the flink jar passed. Using the location of class org.apache.flink.yarn.YarnClusterDescriptor to locate the jar

2018-05-23 15:07:46,179 INFO&#160; org.apache.flink.yarn.cli.FlinkYarnSessionCli &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; - No path for the flink jar passed. Using the location of class org.apache.flink.yarn.YarnClusterDescriptor to locate the jar

2018-05-23 15:07:46,339 INFO&#160; org.apache.flink.yarn.AbstractYarnClusterDescriptor &#160; &#160; &#160; &#160; &#160; - Cluster specification: ClusterSpecification{masterMemoryMB=1024, taskManagerMemoryMB=4096, numberTaskManagers=80, slotsPerTaskManager=1}

2018-05-23 15:07:46,596 WARN&#160; org.apache.flink.yarn.AbstractYarnClusterDescriptor &#160; &#160; &#160; &#160; &#160; - The configuration directory (&apos;/home/hadoop/flink-1.5.0/conf&apos;) contains both LOG4J and Logback configuration files. Please delete or rename one of them.

2018-05-23 15:07:47,318 INFO&#160; org.apache.flink.yarn.AbstractYarnClusterDescriptor &#160; &#160; &#160; &#160; &#160; - Submitting application master application_1526561166266_0049

2018-05-23 15:07:47,336 INFO&#160; org.apache.hadoop.yarn.client.api.impl.YarnClientImpl &#160; &#160; &#160; &#160; - Submitted application application_1526561166266_0049

2018-05-23 15:07:47,337 INFO&#160; org.apache.flink.yarn.AbstractYarnClusterDescriptor &#160; &#160; &#160; &#160; &#160; - Waiting for the cluster to be allocated

2018-05-23 15:07:47,338 INFO&#160; org.apache.flink.yarn.AbstractYarnClusterDescriptor &#160; &#160; &#160; &#160; &#160; - Deploying cluster, current state ACCEPTED

2018-05-23 15:07:51,101 INFO&#160; org.apache.flink.yarn.AbstractYarnClusterDescriptor &#160; &#160; &#160; &#160; &#160; - YARN application has been deployed successfully.

Starting execution of program



------------------------------------------------------------

The program finished with the following exception:



org.apache.flink.client.program.ProgramInvocationException: java.io.IOException: Cannot download from BlobServer, because the server address is unknown.

at org.apache.flink.client.program.rest.RestClusterClient.submitJob(RestClusterClient.java:264)

at org.apache.flink.client.program.ClusterClient.run(ClusterClient.java:464)

at org.apache.flink.client.program.ClusterClient.run(ClusterClient.java:452)

at org.apache.flink.client.program.ContextEnvironment.execute(ContextEnvironment.java:62)

at org.apache.flink.examples.java.wordcount.WordCount.main(WordCount.java:86)

at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)

at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)

at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)

at java.lang.reflect.Method.invoke(Method.java:498)

at org.apache.flink.client.program.PackagedProgram.callMainMethod(PackagedProgram.java:528)

at org.apache.flink.client.program.PackagedProgram.invokeInteractiveModeForExecution(PackagedProgram.java:420)

at org.apache.flink.client.program.ClusterClient.run(ClusterClient.java:404)

at org.apache.flink.client.cli.CliFrontend.executeProgram(CliFrontend.java:781)

at org.apache.flink.client.cli.CliFrontend.runProgram(CliFrontend.java:275)

at org.apache.flink.client.cli.CliFrontend.run(CliFrontend.java:210)

at org.apache.flink.client.cli.CliFrontend.parseParameters(CliFrontend.java:1020)

at org.apache.flink.client.cli.CliFrontend.lambda$main$9(CliFrontend.java:1096)

at java.security.AccessController.doPrivileged(Native Method)

at javax.security.auth.Subject.doAs(Subject.java:422)

at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1836)

at org.apache.flink.runtime.security.HadoopSecurityContext.runSecured(HadoopSecurityContext.java:41)

at org.apache.flink.client.cli.CliFrontend.main(CliFrontend.java:1096)

Caused by: java.io.IOException: Cannot download from BlobServer, because the server address is unknown.

at org.apache.flink.runtime.blob.AbstractBlobCache.getFileInternal(AbstractBlobCache.java:192)

at org.apache.flink.runtime.blob.PermanentBlobCache.getFile(PermanentBlobCache.java:206)

at org.apache.flink.runtime.execution.librarycache.BlobLibraryCacheManager.registerTask(BlobLibraryCacheManager.java:120)

at org.apache.flink.runtime.taskmanager.Task.createUserCodeClassloader(Task.java:863)

at org.apache.flink.runtime.taskmanager.Task.run(Task.java:579)

at java.lang.Thread.run(Thread.java:748)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;See attached full application log&lt;/p&gt;</description>
                <environment></environment>
        <key id="13161463">FLINK-9427</key>
            <summary>Cannot download from BlobServer, because the server address is unknown.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="pnowojski">Piotr Nowojski</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 May 2018 15:11:57 +0000</created>
                <updated>Thu, 28 Feb 2019 14:11:29 +0000</updated>
                            <resolved>Thu, 24 May 2018 14:53:20 +0000</resolved>
                                    <version>1.5.0</version>
                    <version>1.6.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16488622" author="githubbot" created="Thu, 24 May 2018 08:12:23 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6067&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6067&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9427&quot; title=&quot;Cannot download from BlobServer, because the server address is unknown.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9427&quot;&gt;&lt;del&gt;FLINK-9427&lt;/del&gt;&lt;/a&gt; Fix registration and request slot race condition in TaskExecutor&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This commit fixes a race condition between the TaskExecutor and the ResourceManager. Before,&lt;br/&gt;
    it could happen that the ResourceManager sends requestSlots message before the TaskExecutor&lt;br/&gt;
    registration was completed. Due to this, the TaskExecutor did not have all information it needed&lt;br/&gt;
    to accept task submissions.&lt;/p&gt;

&lt;p&gt;    The problem was that the TaskExecutor sent the SlotReport at registration time. Due to this, t&lt;br/&gt;
    he SlotManager could already assign these slots to pending slot requests. With this commit, the&lt;br/&gt;
    registration protocol changes such that the TaskExecutor first registers at the ResourceManager&lt;br/&gt;
    and only after completing this step, it will announce the available slots to the SlotManager.&lt;/p&gt;

&lt;p&gt;    cc @GJL &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Changed the `TaskExecutor` `ResourceManager` registration protocol to announce the available slots after the completion of the registration&lt;/li&gt;
	&lt;li&gt;Hardened the `TaskExecutor#requestSlot` to only accept the call if there is an established connection to a `ResourceManager`&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added `SlotManagerTest#testSlotRequestFailure`&lt;/li&gt;
	&lt;li&gt;Added `TaskExecutorTest#testIgnoringSlotRequestsIfNotRegistered`, `testReconnectionAttemptIfExplicitlyDisconnected`, `testInitialSlotReport` and `testInitialSlotReportFailure`&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_down.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; fixTaskExecutorRegistration&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6067.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6067.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #6067&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4b4d82cc5a3bb9694fd19a37c21345cbe7928962&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@...&amp;gt;&lt;br/&gt;
Date:   2018-05-23T16:50:27Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9427&quot; title=&quot;Cannot download from BlobServer, because the server address is unknown.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9427&quot;&gt;&lt;del&gt;FLINK-9427&lt;/del&gt;&lt;/a&gt; Fix registration and request slot race condition in TaskExecutor&lt;/p&gt;

&lt;p&gt;    This commit fixes a race condition between the TaskExecutor and the ResourceManager. Before,&lt;br/&gt;
    it could happen that the ResourceManager sends requestSlots message before the TaskExecutor&lt;br/&gt;
    registration was completed. Due to this, the TaskExecutor did not have all information it needed&lt;br/&gt;
    to accept task submissions.&lt;/p&gt;

&lt;p&gt;    The problem was that the TaskExecutor sent the SlotReport at registration time. Due to this, t&lt;br/&gt;
    he SlotManager could already assign these slots to pending slot requests. With this commit, the&lt;br/&gt;
    registration protocol changes such that the TaskExecutor first registers at the ResourceManager&lt;br/&gt;
    and only after completing this step, it will announce the available slots to the SlotManager.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16489091" author="githubbot" created="Thu, 24 May 2018 14:18:50 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6067#discussion_r190557380&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6067#discussion_r190557380&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java &amp;#8212;&lt;br/&gt;
    @@ -732,19 +744,10 @@ public void heartbeatFromResourceManager(ResourceID resourceID) {&lt;br/&gt;
     			allocationId, jobId, resourceManagerId);&lt;/p&gt;

&lt;p&gt;     		try {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (resourceManagerConnection == null) {&lt;/li&gt;
	&lt;li&gt;final String message = &quot;TaskManager is not connected to a resource manager.&quot;;&lt;br/&gt;
    +			if (!isConnectedToResourceManager(resourceManagerId)) 
{
    +				final String message = String.format(&quot;TaskManager is not connected to the resource manager %s.&quot;, resourceManagerId);
     				log.debug(message);
    -				throw new SlotAllocationException(message);
    -			}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (!Objects.equals(resourceManagerConnection.getTargetLeaderId(), resourceManagerId)) {&lt;/li&gt;
	&lt;li&gt;final String message = &quot;The leader id &quot; + resourceManagerId +&lt;/li&gt;
	&lt;li&gt;&quot; does not match with the leader id of the connected resource manager &quot; +&lt;/li&gt;
	&lt;li&gt;resourceManagerConnection.getTargetLeaderId() + &apos;.&apos;;&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;log.debug(message);&lt;/li&gt;
	&lt;li&gt;throw new SlotAllocationException(message);&lt;br/&gt;
    +				throw new TaskManagerException(message);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Why not return an exceptional future here?&lt;/p&gt;</comment>
                            <comment id="16489092" author="githubbot" created="Thu, 24 May 2018 14:18:50 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6067#discussion_r190602158&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6067#discussion_r190602158&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/taskexecutor/TaskExecutorTest.java &amp;#8212;&lt;br/&gt;
    @@ -1483,6 +1485,216 @@ public void testMaximumRegistrationDurationAfterConnectionLoss() throws Exceptio&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests that we ignore slot requests if the TaskExecutor is not&lt;br/&gt;
    +	 * registered at a ResourceManager.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testIgnoringSlotRequestsIfNotRegistered() throws Exception {&lt;br/&gt;
    +		final TaskSlotTable taskSlotTable = new TaskSlotTable(Collections.singleton(ResourceProfile.UNKNOWN), timerService);&lt;br/&gt;
    +		final TaskManagerServices taskManagerServices = new TaskManagerServicesBuilder().setTaskSlotTable(taskSlotTable).build();&lt;br/&gt;
    +&lt;br/&gt;
    +		final TaskExecutor taskExecutor = createTaskExecutor(taskManagerServices);&lt;br/&gt;
    +&lt;br/&gt;
    +		taskExecutor.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			final TestingResourceManagerGateway testingResourceManagerGateway = new TestingResourceManagerGateway();&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;RegistrationResponse&amp;gt; registrationFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			final CompletableFuture&amp;lt;ResourceID&amp;gt; taskExecutorResourceIdFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +			testingResourceManagerGateway.setRegisterTaskExecutorFunction(stringResourceIDSlotReportIntegerHardwareDescriptionTuple5 -&amp;gt; &lt;/p&gt;
{
    +                taskExecutorResourceIdFuture.complete(stringResourceIDSlotReportIntegerHardwareDescriptionTuple5.f1);
    +                return registrationFuture;
    +            }
&lt;p&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +			rpc.registerGateway(testingResourceManagerGateway.getAddress(), testingResourceManagerGateway);&lt;br/&gt;
    +			resourceManagerLeaderRetriever.notifyListener(testingResourceManagerGateway.getAddress(), testingResourceManagerGateway.getFencingToken().toUUID());&lt;br/&gt;
    +&lt;br/&gt;
    +			final TaskExecutorGateway taskExecutorGateway = taskExecutor.getSelfGateway(TaskExecutorGateway.class);&lt;br/&gt;
    +&lt;br/&gt;
    +			final ResourceID resourceId = taskExecutorResourceIdFuture.get();&lt;br/&gt;
    +&lt;br/&gt;
    +			final SlotID slotId = new SlotID(resourceId, 0);&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Acknowledge&amp;gt; slotRequestResponse = taskExecutorGateway.requestSlot(slotId, jobId, new AllocationID(), &quot;foobar&quot;, testingResourceManagerGateway.getFencingToken(), timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				slotRequestResponse.get();
    +				fail(&quot;We should not be able to request slots before the TaskExecutor is registered at the ResourceManager.&quot;);
    +			}
&lt;p&gt; catch (ExecutionException ee) &lt;/p&gt;
{
    +				assertThat(ExceptionUtils.stripExecutionException(ee), instanceOf(TaskManagerException.class));
    +			}
&lt;p&gt;    +		} finally &lt;/p&gt;
{
    +			RpcUtils.terminateRpcEndpoint(taskExecutor, timeout);
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that the TaskExecutor tries to reconnect to a ResourceManager from which it&lt;br/&gt;
    +	 * was explicitly disconnected.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testReconnectionAttemptIfExplicitlyDisconnected() throws Exception {&lt;br/&gt;
    +		final long heartbeatInterval = 1000L;&lt;br/&gt;
    +		final TaskSlotTable taskSlotTable = new TaskSlotTable(Collections.singleton(ResourceProfile.UNKNOWN), timerService);&lt;br/&gt;
    +		final TaskManagerLocation taskManagerLocation = new LocalTaskManagerLocation();&lt;br/&gt;
    +		final TaskExecutor taskExecutor = new TaskExecutor(&lt;br/&gt;
    +			rpc,&lt;br/&gt;
    +			TaskManagerConfiguration.fromConfiguration(configuration),&lt;br/&gt;
    +			haServices,&lt;br/&gt;
    +			new TaskManagerServicesBuilder()&lt;br/&gt;
    +				.setTaskSlotTable(taskSlotTable)&lt;br/&gt;
    +				.setTaskManagerLocation(taskManagerLocation)&lt;br/&gt;
    +				.build(),&lt;br/&gt;
    +			new HeartbeatServices(heartbeatInterval, 1000L),&lt;br/&gt;
    +			UnregisteredMetricGroups.createUnregisteredTaskManagerMetricGroup(),&lt;br/&gt;
    +			dummyBlobCacheService,&lt;br/&gt;
    +			testingFatalErrorHandler);&lt;br/&gt;
    +&lt;br/&gt;
    +		taskExecutor.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			final TestingResourceManagerGateway testingResourceManagerGateway = new TestingResourceManagerGateway();&lt;br/&gt;
    +			final ClusterInformation clusterInformation = new ClusterInformation(&quot;foobar&quot;, 1234);&lt;br/&gt;
    +			final CompletableFuture&amp;lt;RegistrationResponse&amp;gt; registrationResponseFuture = CompletableFuture.completedFuture(new TaskExecutorRegistrationSuccess(new InstanceID(), ResourceID.generate(), heartbeatInterval, clusterInformation));&lt;br/&gt;
    +			final BlockingQueue&amp;lt;ResourceID&amp;gt; registrationQueue = new ArrayBlockingQueue&amp;lt;&amp;gt;(1);&lt;br/&gt;
    +&lt;br/&gt;
    +			testingResourceManagerGateway.setRegisterTaskExecutorFunction(stringResourceIDSlotReportIntegerHardwareDescriptionTuple5 -&amp;gt; &lt;/p&gt;
{
    +                registrationQueue.offer(stringResourceIDSlotReportIntegerHardwareDescriptionTuple5.f1);
    +                return registrationResponseFuture;
    +            }
&lt;p&gt;);&lt;br/&gt;
    +			rpc.registerGateway(testingResourceManagerGateway.getAddress(), testingResourceManagerGateway);&lt;br/&gt;
    +&lt;br/&gt;
    +			resourceManagerLeaderRetriever.notifyListener(testingResourceManagerGateway.getAddress(), testingResourceManagerGateway.getFencingToken().toUUID());&lt;br/&gt;
    +&lt;br/&gt;
    +			final ResourceID firstRegistrationAttempt = registrationQueue.take();&lt;br/&gt;
    +&lt;br/&gt;
    +			assertThat(firstRegistrationAttempt, equalTo(taskManagerLocation.getResourceID()));&lt;br/&gt;
    +&lt;br/&gt;
    +			final TaskExecutorGateway taskExecutorGateway = taskExecutor.getSelfGateway(TaskExecutorGateway.class);&lt;br/&gt;
    +&lt;br/&gt;
    +			assertThat(registrationQueue.isEmpty(), is(true));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit: `assertThat(registrationQueue, is(empty()));` gives better failure messages. Now it&apos;s just a fancy way of writing `assertTrue()`.&lt;/p&gt;</comment>
                            <comment id="16489093" author="githubbot" created="Thu, 24 May 2018 14:18:50 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6067#discussion_r190583266&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6067#discussion_r190583266&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java &amp;#8212;&lt;br/&gt;
    @@ -933,25 +956,35 @@ public void requestHeartbeat(ResourceID resourceID, SlotReport slotReport) &lt;/p&gt;
{
     
     		blobCacheService.setBlobServerAddress(blobServerAddress);
     
    +		establishedResourceManagerConnection = new EstablishedResourceManagerConnection(
    +			resourceManagerGateway,
    +			resourceManagerResourceId,
    +			taskExecutorRegistrationId);
    +
     		stopRegistrationTimeout();
     	}

&lt;p&gt;     	private void closeResourceManagerConnection(Exception cause) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (resourceManagerConnection != null) {&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (resourceManagerConnection.isConnected()) {&lt;/li&gt;
	&lt;li&gt;if (log.isDebugEnabled()) {&lt;/li&gt;
	&lt;li&gt;log.debug(&quot;Close ResourceManager connection {}.&quot;,&lt;/li&gt;
	&lt;li&gt;resourceManagerConnection.getResourceManagerId(), cause);&lt;/li&gt;
	&lt;li&gt;} else {&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Close ResourceManager connection {}.&quot;,&lt;/li&gt;
	&lt;li&gt;resourceManagerConnection.getResourceManagerId());&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;resourceManagerHeartbeatManager.unmonitorTarget(resourceManagerConnection.getResourceManagerId());&lt;br/&gt;
    +		if (establishedResourceManagerConnection != null) {&lt;br/&gt;
    +			final ResourceID resourceManagerResourceId = establishedResourceManagerConnection.getResourceManagerResourceId();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ResourceManagerGateway resourceManagerGateway = resourceManagerConnection.getTargetGateway();&lt;/li&gt;
	&lt;li&gt;resourceManagerGateway.disconnectTaskManager(getResourceID(), cause);&lt;br/&gt;
    +			if (log.isDebugEnabled()) {&lt;br/&gt;
    +				log.debug(&quot;Close ResourceManager connection {}.&quot;,
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I was wondering whether `cause` can get logged twice:&lt;/p&gt;

&lt;p&gt;    1. &lt;br/&gt;
    ```&lt;br/&gt;
    log.debug(&quot;Close ResourceManager connection {}.&quot;,&lt;br/&gt;
    					resourceManagerResourceId, cause);&lt;br/&gt;
    ```&lt;br/&gt;
    2.&lt;br/&gt;
    ``` 	&lt;br/&gt;
    log.debug(&quot;Terminating registration attempts towards ResourceManager {}.&quot;,&lt;br/&gt;
    						resourceManagerConnection.getTargetAddress(), cause);&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="16489094" author="githubbot" created="Thu, 24 May 2018 14:18:50 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6067#discussion_r190602807&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6067#discussion_r190602807&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/resourcemanager/slotmanager/SlotManagerTest.java &amp;#8212;&lt;br/&gt;
    @@ -1139,6 +1147,61 @@ public void testReportAllocatedSlot() throws Exception {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Testst that the SlotManager retries allocating a slot if the TaskExecutor#requestSlot call&lt;br/&gt;
    +	 * fails.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSlotRequestFailure() throws Exception {&lt;br/&gt;
    +		try (final SlotManager slotManager = createSlotManager(ResourceManagerId.generate(), new TestingResourceActions())) {&lt;br/&gt;
    +&lt;br/&gt;
    +			final SlotRequest slotRequest = new SlotRequest(new JobID(), new AllocationID(), ResourceProfile.UNKNOWN, &quot;foobar&quot;);&lt;br/&gt;
    +			slotManager.registerSlotRequest(slotRequest);&lt;br/&gt;
    +&lt;br/&gt;
    +			final BlockingQueue&amp;lt;Tuple5&amp;lt;SlotID, JobID, AllocationID, String, ResourceManagerId&amp;gt;&amp;gt; requestSlotQueue = new ArrayBlockingQueue&amp;lt;&amp;gt;(1);&lt;br/&gt;
    +			final BlockingQueue&amp;lt;CompletableFuture&amp;lt;Acknowledge&amp;gt;&amp;gt; responseQueue = new ArrayBlockingQueue&amp;lt;&amp;gt;(1);&lt;br/&gt;
    +&lt;br/&gt;
    +			final TestingTaskExecutorGateway testingTaskExecutorGateway = new TestingTaskExecutorGatewayBuilder()&lt;br/&gt;
    +				.setRequestSlotFunction(slotIDJobIDAllocationIDStringResourceManagerIdTuple5 -&amp;gt; {&lt;br/&gt;
    +                    requestSlotQueue.offer(slotIDJobIDAllocationIDStringResourceManagerIdTuple5);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think you are using spaces for indentation here.&lt;/p&gt;</comment>
                            <comment id="16489095" author="githubbot" created="Thu, 24 May 2018 14:18:51 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6067#discussion_r190603365&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6067#discussion_r190603365&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/taskexecutor/TaskExecutorTest.java &amp;#8212;&lt;br/&gt;
    @@ -1483,6 +1485,216 @@ public void testMaximumRegistrationDurationAfterConnectionLoss() throws Exceptio&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests that we ignore slot requests if the TaskExecutor is not&lt;br/&gt;
    +	 * registered at a ResourceManager.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testIgnoringSlotRequestsIfNotRegistered() throws Exception {&lt;br/&gt;
    +		final TaskSlotTable taskSlotTable = new TaskSlotTable(Collections.singleton(ResourceProfile.UNKNOWN), timerService);&lt;br/&gt;
    +		final TaskManagerServices taskManagerServices = new TaskManagerServicesBuilder().setTaskSlotTable(taskSlotTable).build();&lt;br/&gt;
    +&lt;br/&gt;
    +		final TaskExecutor taskExecutor = createTaskExecutor(taskManagerServices);&lt;br/&gt;
    +&lt;br/&gt;
    +		taskExecutor.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			final TestingResourceManagerGateway testingResourceManagerGateway = new TestingResourceManagerGateway();&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;RegistrationResponse&amp;gt; registrationFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			final CompletableFuture&amp;lt;ResourceID&amp;gt; taskExecutorResourceIdFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +			testingResourceManagerGateway.setRegisterTaskExecutorFunction(stringResourceIDSlotReportIntegerHardwareDescriptionTuple5 -&amp;gt; &lt;/p&gt;
{
    +                taskExecutorResourceIdFuture.complete(stringResourceIDSlotReportIntegerHardwareDescriptionTuple5.f1);
    +                return registrationFuture;
    +            }
&lt;p&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +			rpc.registerGateway(testingResourceManagerGateway.getAddress(), testingResourceManagerGateway);&lt;br/&gt;
    +			resourceManagerLeaderRetriever.notifyListener(testingResourceManagerGateway.getAddress(), testingResourceManagerGateway.getFencingToken().toUUID());&lt;br/&gt;
    +&lt;br/&gt;
    +			final TaskExecutorGateway taskExecutorGateway = taskExecutor.getSelfGateway(TaskExecutorGateway.class);&lt;br/&gt;
    +&lt;br/&gt;
    +			final ResourceID resourceId = taskExecutorResourceIdFuture.get();&lt;br/&gt;
    +&lt;br/&gt;
    +			final SlotID slotId = new SlotID(resourceId, 0);&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Acknowledge&amp;gt; slotRequestResponse = taskExecutorGateway.requestSlot(slotId, jobId, new AllocationID(), &quot;foobar&quot;, testingResourceManagerGateway.getFencingToken(), timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				slotRequestResponse.get();
    +				fail(&quot;We should not be able to request slots before the TaskExecutor is registered at the ResourceManager.&quot;);
    +			}
&lt;p&gt; catch (ExecutionException ee) &lt;/p&gt;
{
    +				assertThat(ExceptionUtils.stripExecutionException(ee), instanceOf(TaskManagerException.class));
    +			}
&lt;p&gt;    +		} finally &lt;/p&gt;
{
    +			RpcUtils.terminateRpcEndpoint(taskExecutor, timeout);
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that the TaskExecutor tries to reconnect to a ResourceManager from which it&lt;br/&gt;
    +	 * was explicitly disconnected.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testReconnectionAttemptIfExplicitlyDisconnected() throws Exception {&lt;br/&gt;
    +		final long heartbeatInterval = 1000L;&lt;br/&gt;
    +		final TaskSlotTable taskSlotTable = new TaskSlotTable(Collections.singleton(ResourceProfile.UNKNOWN), timerService);&lt;br/&gt;
    +		final TaskManagerLocation taskManagerLocation = new LocalTaskManagerLocation();&lt;br/&gt;
    +		final TaskExecutor taskExecutor = new TaskExecutor(&lt;br/&gt;
    +			rpc,&lt;br/&gt;
    +			TaskManagerConfiguration.fromConfiguration(configuration),&lt;br/&gt;
    +			haServices,&lt;br/&gt;
    +			new TaskManagerServicesBuilder()&lt;br/&gt;
    +				.setTaskSlotTable(taskSlotTable)&lt;br/&gt;
    +				.setTaskManagerLocation(taskManagerLocation)&lt;br/&gt;
    +				.build(),&lt;br/&gt;
    +			new HeartbeatServices(heartbeatInterval, 1000L),&lt;br/&gt;
    +			UnregisteredMetricGroups.createUnregisteredTaskManagerMetricGroup(),&lt;br/&gt;
    +			dummyBlobCacheService,&lt;br/&gt;
    +			testingFatalErrorHandler);&lt;br/&gt;
    +&lt;br/&gt;
    +		taskExecutor.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			final TestingResourceManagerGateway testingResourceManagerGateway = new TestingResourceManagerGateway();&lt;br/&gt;
    +			final ClusterInformation clusterInformation = new ClusterInformation(&quot;foobar&quot;, 1234);&lt;br/&gt;
    +			final CompletableFuture&amp;lt;RegistrationResponse&amp;gt; registrationResponseFuture = CompletableFuture.completedFuture(new TaskExecutorRegistrationSuccess(new InstanceID(), ResourceID.generate(), heartbeatInterval, clusterInformation));&lt;br/&gt;
    +			final BlockingQueue&amp;lt;ResourceID&amp;gt; registrationQueue = new ArrayBlockingQueue&amp;lt;&amp;gt;(1);&lt;br/&gt;
    +&lt;br/&gt;
    +			testingResourceManagerGateway.setRegisterTaskExecutorFunction(stringResourceIDSlotReportIntegerHardwareDescriptionTuple5 -&amp;gt; {&lt;br/&gt;
    +                registrationQueue.offer(stringResourceIDSlotReportIntegerHardwareDescriptionTuple5.f1);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Same here: spaces are used for indentation.&lt;/p&gt;</comment>
                            <comment id="16489097" author="githubbot" created="Thu, 24 May 2018 14:19:17 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6067#discussion_r190603900&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6067#discussion_r190603900&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java &amp;#8212;&lt;br/&gt;
    @@ -732,19 +744,10 @@ public void heartbeatFromResourceManager(ResourceID resourceID) {&lt;br/&gt;
     			allocationId, jobId, resourceManagerId);&lt;/p&gt;

&lt;p&gt;     		try {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (resourceManagerConnection == null) {&lt;/li&gt;
	&lt;li&gt;final String message = &quot;TaskManager is not connected to a resource manager.&quot;;&lt;br/&gt;
    +			if (!isConnectedToResourceManager(resourceManagerId)) 
{
    +				final String message = String.format(&quot;TaskManager is not connected to the resource manager %s.&quot;, resourceManagerId);
     				log.debug(message);
    -				throw new SlotAllocationException(message);
    -			}
&lt;p&gt;    -&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (!Objects.equals(resourceManagerConnection.getTargetLeaderId(), resourceManagerId)) {&lt;/li&gt;
	&lt;li&gt;final String message = &quot;The leader id &quot; + resourceManagerId +&lt;/li&gt;
	&lt;li&gt;&quot; does not match with the leader id of the connected resource manager &quot; +&lt;/li&gt;
	&lt;li&gt;resourceManagerConnection.getTargetLeaderId() + &apos;.&apos;;&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;log.debug(message);&lt;/li&gt;
	&lt;li&gt;throw new SlotAllocationException(message);&lt;br/&gt;
    +				throw new TaskManagerException(message);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    We already talked about it offline.&lt;/p&gt;</comment>
                            <comment id="16489098" author="githubbot" created="Thu, 24 May 2018 14:19:20 +0000"  >&lt;p&gt;Github user GJL commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6067#discussion_r190603934&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6067#discussion_r190603934&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java &amp;#8212;&lt;br/&gt;
    @@ -933,25 +956,35 @@ public void requestHeartbeat(ResourceID resourceID, SlotReport slotReport) &lt;/p&gt;
{
     
     		blobCacheService.setBlobServerAddress(blobServerAddress);
     
    +		establishedResourceManagerConnection = new EstablishedResourceManagerConnection(
    +			resourceManagerGateway,
    +			resourceManagerResourceId,
    +			taskExecutorRegistrationId);
    +
     		stopRegistrationTimeout();
     	}

&lt;p&gt;     	private void closeResourceManagerConnection(Exception cause) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (resourceManagerConnection != null) {&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;if (resourceManagerConnection.isConnected()) {&lt;/li&gt;
	&lt;li&gt;if (log.isDebugEnabled()) {&lt;/li&gt;
	&lt;li&gt;log.debug(&quot;Close ResourceManager connection {}.&quot;,&lt;/li&gt;
	&lt;li&gt;resourceManagerConnection.getResourceManagerId(), cause);&lt;/li&gt;
	&lt;li&gt;} else {&lt;/li&gt;
	&lt;li&gt;log.info(&quot;Close ResourceManager connection {}.&quot;,&lt;/li&gt;
	&lt;li&gt;resourceManagerConnection.getResourceManagerId());&lt;/li&gt;
	&lt;li&gt;}&lt;/li&gt;
	&lt;li&gt;resourceManagerHeartbeatManager.unmonitorTarget(resourceManagerConnection.getResourceManagerId());&lt;br/&gt;
    +		if (establishedResourceManagerConnection != null) {&lt;br/&gt;
    +			final ResourceID resourceManagerResourceId = establishedResourceManagerConnection.getResourceManagerResourceId();&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ResourceManagerGateway resourceManagerGateway = resourceManagerConnection.getTargetGateway();&lt;/li&gt;
	&lt;li&gt;resourceManagerGateway.disconnectTaskManager(getResourceID(), cause);&lt;br/&gt;
    +			if (log.isDebugEnabled()) {&lt;br/&gt;
    +				log.debug(&quot;Close ResourceManager connection {}.&quot;,
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    We already talked about it offline.&lt;/p&gt;</comment>
                            <comment id="16489119" author="githubbot" created="Thu, 24 May 2018 14:38:38 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6067#discussion_r190611399&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6067#discussion_r190611399&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/taskexecutor/TaskExecutorTest.java &amp;#8212;&lt;br/&gt;
    @@ -1483,6 +1485,216 @@ public void testMaximumRegistrationDurationAfterConnectionLoss() throws Exceptio&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests that we ignore slot requests if the TaskExecutor is not&lt;br/&gt;
    +	 * registered at a ResourceManager.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testIgnoringSlotRequestsIfNotRegistered() throws Exception {&lt;br/&gt;
    +		final TaskSlotTable taskSlotTable = new TaskSlotTable(Collections.singleton(ResourceProfile.UNKNOWN), timerService);&lt;br/&gt;
    +		final TaskManagerServices taskManagerServices = new TaskManagerServicesBuilder().setTaskSlotTable(taskSlotTable).build();&lt;br/&gt;
    +&lt;br/&gt;
    +		final TaskExecutor taskExecutor = createTaskExecutor(taskManagerServices);&lt;br/&gt;
    +&lt;br/&gt;
    +		taskExecutor.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			final TestingResourceManagerGateway testingResourceManagerGateway = new TestingResourceManagerGateway();&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;RegistrationResponse&amp;gt; registrationFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			final CompletableFuture&amp;lt;ResourceID&amp;gt; taskExecutorResourceIdFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +			testingResourceManagerGateway.setRegisterTaskExecutorFunction(stringResourceIDSlotReportIntegerHardwareDescriptionTuple5 -&amp;gt; &lt;/p&gt;
{
    +                taskExecutorResourceIdFuture.complete(stringResourceIDSlotReportIntegerHardwareDescriptionTuple5.f1);
    +                return registrationFuture;
    +            }
&lt;p&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +			rpc.registerGateway(testingResourceManagerGateway.getAddress(), testingResourceManagerGateway);&lt;br/&gt;
    +			resourceManagerLeaderRetriever.notifyListener(testingResourceManagerGateway.getAddress(), testingResourceManagerGateway.getFencingToken().toUUID());&lt;br/&gt;
    +&lt;br/&gt;
    +			final TaskExecutorGateway taskExecutorGateway = taskExecutor.getSelfGateway(TaskExecutorGateway.class);&lt;br/&gt;
    +&lt;br/&gt;
    +			final ResourceID resourceId = taskExecutorResourceIdFuture.get();&lt;br/&gt;
    +&lt;br/&gt;
    +			final SlotID slotId = new SlotID(resourceId, 0);&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Acknowledge&amp;gt; slotRequestResponse = taskExecutorGateway.requestSlot(slotId, jobId, new AllocationID(), &quot;foobar&quot;, testingResourceManagerGateway.getFencingToken(), timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				slotRequestResponse.get();
    +				fail(&quot;We should not be able to request slots before the TaskExecutor is registered at the ResourceManager.&quot;);
    +			}
&lt;p&gt; catch (ExecutionException ee) &lt;/p&gt;
{
    +				assertThat(ExceptionUtils.stripExecutionException(ee), instanceOf(TaskManagerException.class));
    +			}
&lt;p&gt;    +		} finally &lt;/p&gt;
{
    +			RpcUtils.terminateRpcEndpoint(taskExecutor, timeout);
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that the TaskExecutor tries to reconnect to a ResourceManager from which it&lt;br/&gt;
    +	 * was explicitly disconnected.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testReconnectionAttemptIfExplicitlyDisconnected() throws Exception {&lt;br/&gt;
    +		final long heartbeatInterval = 1000L;&lt;br/&gt;
    +		final TaskSlotTable taskSlotTable = new TaskSlotTable(Collections.singleton(ResourceProfile.UNKNOWN), timerService);&lt;br/&gt;
    +		final TaskManagerLocation taskManagerLocation = new LocalTaskManagerLocation();&lt;br/&gt;
    +		final TaskExecutor taskExecutor = new TaskExecutor(&lt;br/&gt;
    +			rpc,&lt;br/&gt;
    +			TaskManagerConfiguration.fromConfiguration(configuration),&lt;br/&gt;
    +			haServices,&lt;br/&gt;
    +			new TaskManagerServicesBuilder()&lt;br/&gt;
    +				.setTaskSlotTable(taskSlotTable)&lt;br/&gt;
    +				.setTaskManagerLocation(taskManagerLocation)&lt;br/&gt;
    +				.build(),&lt;br/&gt;
    +			new HeartbeatServices(heartbeatInterval, 1000L),&lt;br/&gt;
    +			UnregisteredMetricGroups.createUnregisteredTaskManagerMetricGroup(),&lt;br/&gt;
    +			dummyBlobCacheService,&lt;br/&gt;
    +			testingFatalErrorHandler);&lt;br/&gt;
    +&lt;br/&gt;
    +		taskExecutor.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			final TestingResourceManagerGateway testingResourceManagerGateway = new TestingResourceManagerGateway();&lt;br/&gt;
    +			final ClusterInformation clusterInformation = new ClusterInformation(&quot;foobar&quot;, 1234);&lt;br/&gt;
    +			final CompletableFuture&amp;lt;RegistrationResponse&amp;gt; registrationResponseFuture = CompletableFuture.completedFuture(new TaskExecutorRegistrationSuccess(new InstanceID(), ResourceID.generate(), heartbeatInterval, clusterInformation));&lt;br/&gt;
    +			final BlockingQueue&amp;lt;ResourceID&amp;gt; registrationQueue = new ArrayBlockingQueue&amp;lt;&amp;gt;(1);&lt;br/&gt;
    +&lt;br/&gt;
    +			testingResourceManagerGateway.setRegisterTaskExecutorFunction(stringResourceIDSlotReportIntegerHardwareDescriptionTuple5 -&amp;gt; &lt;/p&gt;
{
    +                registrationQueue.offer(stringResourceIDSlotReportIntegerHardwareDescriptionTuple5.f1);
    +                return registrationResponseFuture;
    +            }
&lt;p&gt;);&lt;br/&gt;
    +			rpc.registerGateway(testingResourceManagerGateway.getAddress(), testingResourceManagerGateway);&lt;br/&gt;
    +&lt;br/&gt;
    +			resourceManagerLeaderRetriever.notifyListener(testingResourceManagerGateway.getAddress(), testingResourceManagerGateway.getFencingToken().toUUID());&lt;br/&gt;
    +&lt;br/&gt;
    +			final ResourceID firstRegistrationAttempt = registrationQueue.take();&lt;br/&gt;
    +&lt;br/&gt;
    +			assertThat(firstRegistrationAttempt, equalTo(taskManagerLocation.getResourceID()));&lt;br/&gt;
    +&lt;br/&gt;
    +			final TaskExecutorGateway taskExecutorGateway = taskExecutor.getSelfGateway(TaskExecutorGateway.class);&lt;br/&gt;
    +&lt;br/&gt;
    +			assertThat(registrationQueue.isEmpty(), is(true));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    good point. Will change it.&lt;/p&gt;</comment>
                            <comment id="16489120" author="githubbot" created="Thu, 24 May 2018 14:39:04 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6067#discussion_r190611581&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6067#discussion_r190611581&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/resourcemanager/slotmanager/SlotManagerTest.java &amp;#8212;&lt;br/&gt;
    @@ -1139,6 +1147,61 @@ public void testReportAllocatedSlot() throws Exception {&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Testst that the SlotManager retries allocating a slot if the TaskExecutor#requestSlot call&lt;br/&gt;
    +	 * fails.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSlotRequestFailure() throws Exception {&lt;br/&gt;
    +		try (final SlotManager slotManager = createSlotManager(ResourceManagerId.generate(), new TestingResourceActions())) {&lt;br/&gt;
    +&lt;br/&gt;
    +			final SlotRequest slotRequest = new SlotRequest(new JobID(), new AllocationID(), ResourceProfile.UNKNOWN, &quot;foobar&quot;);&lt;br/&gt;
    +			slotManager.registerSlotRequest(slotRequest);&lt;br/&gt;
    +&lt;br/&gt;
    +			final BlockingQueue&amp;lt;Tuple5&amp;lt;SlotID, JobID, AllocationID, String, ResourceManagerId&amp;gt;&amp;gt; requestSlotQueue = new ArrayBlockingQueue&amp;lt;&amp;gt;(1);&lt;br/&gt;
    +			final BlockingQueue&amp;lt;CompletableFuture&amp;lt;Acknowledge&amp;gt;&amp;gt; responseQueue = new ArrayBlockingQueue&amp;lt;&amp;gt;(1);&lt;br/&gt;
    +&lt;br/&gt;
    +			final TestingTaskExecutorGateway testingTaskExecutorGateway = new TestingTaskExecutorGatewayBuilder()&lt;br/&gt;
    +				.setRequestSlotFunction(slotIDJobIDAllocationIDStringResourceManagerIdTuple5 -&amp;gt; {&lt;br/&gt;
    +                    requestSlotQueue.offer(slotIDJobIDAllocationIDStringResourceManagerIdTuple5);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Arrg, spaces.... How did they make it into this PR? Will get rid of them.&lt;/p&gt;</comment>
                            <comment id="16489121" author="githubbot" created="Thu, 24 May 2018 14:39:15 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6067#discussion_r190611660&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6067#discussion_r190611660&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/test/java/org/apache/flink/runtime/taskexecutor/TaskExecutorTest.java &amp;#8212;&lt;br/&gt;
    @@ -1483,6 +1485,216 @@ public void testMaximumRegistrationDurationAfterConnectionLoss() throws Exceptio&lt;br/&gt;
     		}&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Tests that we ignore slot requests if the TaskExecutor is not&lt;br/&gt;
    +	 * registered at a ResourceManager.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testIgnoringSlotRequestsIfNotRegistered() throws Exception {&lt;br/&gt;
    +		final TaskSlotTable taskSlotTable = new TaskSlotTable(Collections.singleton(ResourceProfile.UNKNOWN), timerService);&lt;br/&gt;
    +		final TaskManagerServices taskManagerServices = new TaskManagerServicesBuilder().setTaskSlotTable(taskSlotTable).build();&lt;br/&gt;
    +&lt;br/&gt;
    +		final TaskExecutor taskExecutor = createTaskExecutor(taskManagerServices);&lt;br/&gt;
    +&lt;br/&gt;
    +		taskExecutor.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			final TestingResourceManagerGateway testingResourceManagerGateway = new TestingResourceManagerGateway();&lt;br/&gt;
    +&lt;br/&gt;
    +			final CompletableFuture&amp;lt;RegistrationResponse&amp;gt; registrationFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +			final CompletableFuture&amp;lt;ResourceID&amp;gt; taskExecutorResourceIdFuture = new CompletableFuture&amp;lt;&amp;gt;();&lt;br/&gt;
    +&lt;br/&gt;
    +			testingResourceManagerGateway.setRegisterTaskExecutorFunction(stringResourceIDSlotReportIntegerHardwareDescriptionTuple5 -&amp;gt; &lt;/p&gt;
{
    +                taskExecutorResourceIdFuture.complete(stringResourceIDSlotReportIntegerHardwareDescriptionTuple5.f1);
    +                return registrationFuture;
    +            }
&lt;p&gt;);&lt;br/&gt;
    +&lt;br/&gt;
    +			rpc.registerGateway(testingResourceManagerGateway.getAddress(), testingResourceManagerGateway);&lt;br/&gt;
    +			resourceManagerLeaderRetriever.notifyListener(testingResourceManagerGateway.getAddress(), testingResourceManagerGateway.getFencingToken().toUUID());&lt;br/&gt;
    +&lt;br/&gt;
    +			final TaskExecutorGateway taskExecutorGateway = taskExecutor.getSelfGateway(TaskExecutorGateway.class);&lt;br/&gt;
    +&lt;br/&gt;
    +			final ResourceID resourceId = taskExecutorResourceIdFuture.get();&lt;br/&gt;
    +&lt;br/&gt;
    +			final SlotID slotId = new SlotID(resourceId, 0);&lt;br/&gt;
    +			final CompletableFuture&amp;lt;Acknowledge&amp;gt; slotRequestResponse = taskExecutorGateway.requestSlot(slotId, jobId, new AllocationID(), &quot;foobar&quot;, testingResourceManagerGateway.getFencingToken(), timeout);&lt;br/&gt;
    +&lt;br/&gt;
    +			try &lt;/p&gt;
{
    +				slotRequestResponse.get();
    +				fail(&quot;We should not be able to request slots before the TaskExecutor is registered at the ResourceManager.&quot;);
    +			}
&lt;p&gt; catch (ExecutionException ee) &lt;/p&gt;
{
    +				assertThat(ExceptionUtils.stripExecutionException(ee), instanceOf(TaskManagerException.class));
    +			}
&lt;p&gt;    +		} finally &lt;/p&gt;
{
    +			RpcUtils.terminateRpcEndpoint(taskExecutor, timeout);
    +		}
&lt;p&gt;    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Tests that the TaskExecutor tries to reconnect to a ResourceManager from which it&lt;br/&gt;
    +	 * was explicitly disconnected.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testReconnectionAttemptIfExplicitlyDisconnected() throws Exception {&lt;br/&gt;
    +		final long heartbeatInterval = 1000L;&lt;br/&gt;
    +		final TaskSlotTable taskSlotTable = new TaskSlotTable(Collections.singleton(ResourceProfile.UNKNOWN), timerService);&lt;br/&gt;
    +		final TaskManagerLocation taskManagerLocation = new LocalTaskManagerLocation();&lt;br/&gt;
    +		final TaskExecutor taskExecutor = new TaskExecutor(&lt;br/&gt;
    +			rpc,&lt;br/&gt;
    +			TaskManagerConfiguration.fromConfiguration(configuration),&lt;br/&gt;
    +			haServices,&lt;br/&gt;
    +			new TaskManagerServicesBuilder()&lt;br/&gt;
    +				.setTaskSlotTable(taskSlotTable)&lt;br/&gt;
    +				.setTaskManagerLocation(taskManagerLocation)&lt;br/&gt;
    +				.build(),&lt;br/&gt;
    +			new HeartbeatServices(heartbeatInterval, 1000L),&lt;br/&gt;
    +			UnregisteredMetricGroups.createUnregisteredTaskManagerMetricGroup(),&lt;br/&gt;
    +			dummyBlobCacheService,&lt;br/&gt;
    +			testingFatalErrorHandler);&lt;br/&gt;
    +&lt;br/&gt;
    +		taskExecutor.start();&lt;br/&gt;
    +&lt;br/&gt;
    +		try {&lt;br/&gt;
    +			final TestingResourceManagerGateway testingResourceManagerGateway = new TestingResourceManagerGateway();&lt;br/&gt;
    +			final ClusterInformation clusterInformation = new ClusterInformation(&quot;foobar&quot;, 1234);&lt;br/&gt;
    +			final CompletableFuture&amp;lt;RegistrationResponse&amp;gt; registrationResponseFuture = CompletableFuture.completedFuture(new TaskExecutorRegistrationSuccess(new InstanceID(), ResourceID.generate(), heartbeatInterval, clusterInformation));&lt;br/&gt;
    +			final BlockingQueue&amp;lt;ResourceID&amp;gt; registrationQueue = new ArrayBlockingQueue&amp;lt;&amp;gt;(1);&lt;br/&gt;
    +&lt;br/&gt;
    +			testingResourceManagerGateway.setRegisterTaskExecutorFunction(stringResourceIDSlotReportIntegerHardwareDescriptionTuple5 -&amp;gt; {&lt;br/&gt;
    +                registrationQueue.offer(stringResourceIDSlotReportIntegerHardwareDescriptionTuple5.f1);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Arrg, the same.&lt;/p&gt;</comment>
                            <comment id="16489139" author="githubbot" created="Thu, 24 May 2018 14:51:42 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6067&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6067&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16489147" author="till.rohrmann" created="Thu, 24 May 2018 14:53:20 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
master: 47dc69970996aa2a57c0dbfde866d3dac6d53001&lt;br/&gt;
1.5.0: 5c35e04cecabdb56ffe5dc453dff3a748df874b3&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13095418">FLINK-7469</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12924765" name="failure" size="5200512" author="pnowojski" created="Wed, 23 May 2018 15:13:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 25 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3u2gv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>