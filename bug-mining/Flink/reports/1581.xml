<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:27:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-6129] MetricRegistry does not stop query actor</title>
                <link>https://issues.apache.org/jira/browse/FLINK-6129</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The &lt;tt&gt;MetricRegistry&lt;/tt&gt; does not properly close the started query actor upon shutdown. This can be a resource leak.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13057526">FLINK-6129</key>
            <summary>MetricRegistry does not stop query actor</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="trohrmann">Till Rohrmann</reporter>
                        <labels>
                    </labels>
                <created>Mon, 20 Mar 2017 13:22:34 +0000</created>
                <updated>Wed, 2 Oct 2019 17:48:06 +0000</updated>
                            <resolved>Thu, 23 Mar 2017 14:14:16 +0000</resolved>
                                    <version>1.3.0</version>
                                    <fixVersion>1.3.0</fixVersion>
                                    <component>Runtime / Metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15932633" author="zentol" created="Mon, 20 Mar 2017 13:37:22 +0000"  >&lt;p&gt;I thought all actors are properly shutdown when the actorSystem is shutdown?&lt;/p&gt;</comment>
                            <comment id="15932659" author="githubbot" created="Mon, 20 Mar 2017 13:58:15 +0000"  >&lt;p&gt;GitHub user tillrohrmann opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3573&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3573&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6129&quot; title=&quot;MetricRegistry does not stop query actor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6129&quot;&gt;&lt;del&gt;FLINK-6129&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Stop query actor of MetricRegistry&lt;/p&gt;

&lt;p&gt;    This PR properly shuts down the query actor of the MetricRegistry upon shut down.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tillrohrmann/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tillrohrmann/flink&lt;/a&gt; shutdownQueryActor&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3573.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3573.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3573&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 02d30ae9a8837452a14595fd6b32ce6a11240da4&lt;br/&gt;
Author: Till Rohrmann &amp;lt;trohrmann@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-03-20T13:55:30Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6129&quot; title=&quot;MetricRegistry does not stop query actor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6129&quot;&gt;&lt;del&gt;FLINK-6129&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;metrics&amp;#93;&lt;/span&gt; Stop query actor of MetricRegistry&lt;/p&gt;

&lt;p&gt;    This PR properly shuts down the query actor of the MetricRegistry upon shut down.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15933003" author="till.rohrmann" created="Mon, 20 Mar 2017 16:38:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; they are, but who says that the underlying &lt;tt&gt;ActorSystem&lt;/tt&gt; is shut down when the &lt;tt&gt;MetricRegistry&lt;/tt&gt; is shut down?&lt;/p&gt;</comment>
                            <comment id="15933091" author="githubbot" created="Mon, 20 Mar 2017 17:15:08 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3573#discussion_r106959941&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3573#discussion_r106959941&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistry.java &amp;#8212;&lt;br/&gt;
    @@ -198,6 +204,14 @@ public boolean isShutdown() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down this registry and the associated 
{@link MetricReporter}
&lt;p&gt;.&lt;br/&gt;
     	 */&lt;br/&gt;
     	public void shutdown() {&lt;br/&gt;
    +		Future&amp;lt;Boolean&amp;gt; stopFuture = null;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    why do you split the additions in 2 blocks? Could you not merge them with the sole condition that the MQS is not null?&lt;/p&gt;</comment>
                            <comment id="15934441" author="githubbot" created="Tue, 21 Mar 2017 10:52:34 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3573#discussion_r107124400&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3573#discussion_r107124400&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistry.java &amp;#8212;&lt;br/&gt;
    @@ -198,6 +204,14 @@ public boolean isShutdown() {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Shuts down this registry and the associated 
{@link MetricReporter}
&lt;p&gt;.&lt;br/&gt;
     	 */&lt;br/&gt;
     	public void shutdown() {&lt;br/&gt;
    +		Future&amp;lt;Boolean&amp;gt; stopFuture = null;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Because that way we can exploit the asynchronous stop operation of the actors without blocking the stopping of the reporters and the executors.&lt;/p&gt;</comment>
                            <comment id="15936149" author="githubbot" created="Wed, 22 Mar 2017 11:31:10 +0000"  >&lt;p&gt;Github user zentol commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3573&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3573&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Since the MQS is explicitly started i was wondering whether it should also be stopped explicitly via ```stopMetricQueryService()```. The ```shutdown()``` method is right now the counterpart to the MR constructor, which doesn&apos;t start the MQS.&lt;/p&gt;</comment>
                            <comment id="15937952" author="githubbot" created="Thu, 23 Mar 2017 08:57:28 +0000"  >&lt;p&gt;Github user zentol commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3573#discussion_r107615168&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3573#discussion_r107615168&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistry.java &amp;#8212;&lt;br/&gt;
    @@ -209,14 +223,29 @@ public void shutdown() &lt;/p&gt;
{
     			reporters = null;
     		}
&lt;p&gt;     		shutdownExecutor();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (stopFuture != null) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    if the MQS is started while a shutdown is in progress it might not be cleaned up. What do you think about adding a lock here and in startMetricQueryService?&lt;/p&gt;</comment>
                            <comment id="15938103" author="githubbot" created="Thu, 23 Mar 2017 10:59:30 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3573#discussion_r107639246&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3573#discussion_r107639246&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/metrics/MetricRegistry.java &amp;#8212;&lt;br/&gt;
    @@ -209,14 +223,29 @@ public void shutdown() &lt;/p&gt;
{
     			reporters = null;
     		}
&lt;p&gt;     		shutdownExecutor();&lt;br/&gt;
    +&lt;br/&gt;
    +		if (stopFuture != null) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    That is a good point. Will do that.&lt;/p&gt;</comment>
                            <comment id="15938104" author="githubbot" created="Thu, 23 Mar 2017 11:00:59 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3573&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3573&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review @zentol.&lt;/p&gt;

&lt;p&gt;    I think it&apos;s ok to close the query service in the `shutdown` method. If it later should turn out to be a disadvantage, we can still change it.&lt;/p&gt;

&lt;p&gt;    After addressing your comments, I&apos;ll merge the PR.&lt;/p&gt;</comment>
                            <comment id="15938386" author="till.rohrmann" created="Thu, 23 Mar 2017 14:14:16 +0000"  >&lt;p&gt;Fixed via 8319a457d9adee310ef64905709c03ca2f2afd61&lt;/p&gt;</comment>
                            <comment id="15938387" author="githubbot" created="Thu, 23 Mar 2017 14:14:54 +0000"  >&lt;p&gt;Github user tillrohrmann closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3573&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3573&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 34 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3cikv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>