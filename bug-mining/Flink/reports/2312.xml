<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:32:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9034] State Descriptors drop TypeInformation on serialization</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9034</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The following code currently causes problems&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyFunction &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; RichMapFunction&amp;lt;A, B&amp;gt;  {

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ValueStateDescriptor&amp;lt;MyType&amp;gt; descr = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ValueStateDescriptor&amp;lt;&amp;gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;state name&quot;&lt;/span&gt;, MyType.class);

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ValueState&amp;lt;MyType&amp;gt; state;

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void open() {
        state = getRuntimeContext().getValueState(descr);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is that the state descriptor drops the type information and creates a serializer before serialization as part of shipping the function in the cluster. To do that, it initializes the serializer with an empty execution config, making serialization inconsistent.&lt;/p&gt;

&lt;p&gt;This is mainly an artifact from the days when dropping the type information before shipping was necessary, because the type info was not serializable. It now is, and we can fix that bug.&lt;/p&gt;

</description>
                <environment></environment>
        <key id="13146658">FLINK-9034</key>
            <summary>State Descriptors drop TypeInformation on serialization</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sewen">Stephan Ewen</assignee>
                                    <reporter username="sewen">Stephan Ewen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Mar 2018 20:15:27 +0000</created>
                <updated>Mon, 2 Apr 2018 14:22:27 +0000</updated>
                            <resolved>Thu, 22 Mar 2018 15:24:39 +0000</resolved>
                                    <version>1.4.2</version>
                    <version>1.5.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16407020" author="githubbot" created="Tue, 20 Mar 2018 20:48:42 +0000"  >&lt;p&gt;GitHub user StephanEwen opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5732&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5732&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9034&quot; title=&quot;State Descriptors drop TypeInformation on serialization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9034&quot;&gt;&lt;del&gt;FLINK-9034&lt;/del&gt;&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9035&quot; title=&quot;State Descriptors have broken hashCode() and equals()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9035&quot;&gt;&lt;del&gt;FLINK-9035&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; Fix state descriptors&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Fixes two issue with the `StateDescriptors` that are used to obtain state access in transformation functions: &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Broken Equals and hashCode&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    `equals()` and `hashCode()` depends on fields that are not always set and that may change during the life of a state descriptor. That is especially problematic, because the state descriptors are keys in a map, and if the meaning of `equals()` and `hashCode()` changes after insertion, the objects become keys that cannot be references / matched.&lt;/p&gt;

&lt;p&gt;    This pull request changes `equals()` and `hashCode()` to only take state name and descriptor type (by class) into account for hashCode and equality, which are always constant and not changing as part of serializer initialization.&lt;/p&gt;

&lt;p&gt;    *&lt;b&gt;Illustration of the problem:&lt;/b&gt;*&lt;/p&gt;

&lt;p&gt;    The following code fails with a `NullPointerException`, because the `hashCode()` method tries to access the serializer field, which may be uninitialized at that point.&lt;/p&gt;

&lt;p&gt;    ```java&lt;br/&gt;
    ValueStateDescriptor&amp;lt;String&amp;gt; descr = new ValueStateDescriptor&amp;lt;&amp;gt;(&quot;name&quot;, String.class);&lt;br/&gt;
    descr.hashCode(); // exception&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    The equals() method is equally broken (no pun intended):&lt;br/&gt;
    ```java&lt;br/&gt;
    ValueStateDescriptor&amp;lt;String&amp;gt; a = new ValueStateDescriptor&amp;lt;&amp;gt;(&quot;name&quot;, String.class);&lt;br/&gt;
    ValueStateDescriptor&amp;lt;String&amp;gt; b = new ValueStateDescriptor&amp;lt;&amp;gt;(&quot;name&quot;, String.class);&lt;/p&gt;

&lt;p&gt;    a.equals(b) // exception&lt;br/&gt;
    b.equals(a) // exception&lt;br/&gt;
    a.initializeSerializerUnlessSet(new ExecutionConfig());&lt;br/&gt;
    a.equals(b) // false&lt;br/&gt;
    b.equals(a) // exception&lt;br/&gt;
    b.initializeSerializerUnlessSet(new ExecutionConfig());&lt;br/&gt;
    a.equals(b) // true&lt;br/&gt;
    b.equals(a) // true&lt;br/&gt;
    ```&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;
		&lt;ol&gt;
			&lt;li&gt;Type Information dropped prematurely&lt;/li&gt;
		&lt;/ol&gt;
		&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    The following code is currently problematic:&lt;br/&gt;
    ```java&lt;br/&gt;
    public class MyFunction extends RichMapFunction&amp;lt;A, B&amp;gt;  {&lt;/p&gt;

&lt;p&gt;        private final ValueStateDescriptor&amp;lt;MyType&amp;gt; descr = new ValueStateDescriptor&amp;lt;&amp;gt;(&quot;state name&quot;, MyType.class);&lt;/p&gt;

&lt;p&gt;        private ValueState&amp;lt;MyType&amp;gt; state;&lt;/p&gt;

&lt;p&gt;        @Override&lt;br/&gt;
        public void open(Configuration cfg) &lt;/p&gt;
{
            state = getRuntimeContext().getValueState(descr);
        }
&lt;p&gt;    }&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    The problem is that the state descriptor drops the type information and creates a serializer before serialization as part of shipping the function in the cluster. To do that, it initializes the serializer with an empty execution config, making serialization inconsistent.&lt;/p&gt;

&lt;p&gt;    This is mainly an artifact from the days when dropping the type information before shipping was necessary, because the type info was not serializable. It now is, and we can fix that bug.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    *&lt;b&gt;This change is sensitive, because it touches the structures that all users use to obtain access to persistent state.&lt;/b&gt;*&lt;/p&gt;

&lt;p&gt;    This change adds a series of Unit tests to validate the fixed behavior.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no)&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (*&lt;b&gt;yes&lt;/b&gt;* / no) - *&lt;b&gt;All changes should preserve full API compatibility.&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (*&lt;b&gt;yes&lt;/b&gt;* / no / don&apos;t know): *&lt;b&gt;Touches the structures that give access to checkpointed state.&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (*&lt;b&gt;not applicable&lt;/b&gt;* / docs / JavaDocs / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/StephanEwen/incubator-flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/StephanEwen/incubator-flink&lt;/a&gt; fix_state_descriptors&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5732.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5732.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #5732&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 8ff1284d28a056b91d91607584fab2a55fbcc86c&lt;br/&gt;
Author: Stephan Ewen &amp;lt;sewen@...&amp;gt;&lt;br/&gt;
Date:   2018-03-20T14:15:08Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; Fix checkstyle in &apos;org.apache.flink.api.common.state&apos;&lt;/p&gt;

&lt;p&gt;commit dc0df85e064ee45bcb0f83d21b00a1abc9359723&lt;br/&gt;
Author: Stephan Ewen &amp;lt;sewen@...&amp;gt;&lt;br/&gt;
Date:   2018-03-20T14:29:12Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; Add missing serialVersionUID to MapStateDescriptor&lt;/p&gt;

&lt;p&gt;commit c62e84414ff4715399bce35ac74fb1d94256c3ed&lt;br/&gt;
Author: Stephan Ewen &amp;lt;sewen@...&amp;gt;&lt;br/&gt;
Date:   2018-03-20T14:43:33Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; Add @FunctionalInterface to KeySelector&lt;/p&gt;

&lt;p&gt;    That clarifies that this interface should always be a SAM interface&lt;br/&gt;
    to allow that users created lambdas for its use.&lt;/p&gt;

&lt;p&gt;commit 60f0327e8f12de6397e009d2d5c4134024c3e674&lt;br/&gt;
Author: Stephan Ewen &amp;lt;sewen@...&amp;gt;&lt;br/&gt;
Date:   2018-03-20T14:36:19Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; Demockitofy state descriptor tests&lt;/p&gt;

&lt;p&gt;commit e18ad3d7c39c7a92d2db1066ad968fa2e71e3233&lt;br/&gt;
Author: Stephan Ewen &amp;lt;sewen@...&amp;gt;&lt;br/&gt;
Date:   2018-03-20T14:44:27Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; Make State Descriptors consistently use Preconditions instead of Objects.&lt;/p&gt;

&lt;p&gt;commit 3216f5ad0c7d6964ae885979aa5fcfe9c8e19135&lt;br/&gt;
Author: Stephan Ewen &amp;lt;sewen@...&amp;gt;&lt;br/&gt;
Date:   2018-03-20T15:22:12Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9034&quot; title=&quot;State Descriptors drop TypeInformation on serialization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9034&quot;&gt;&lt;del&gt;FLINK-9034&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; StateDescriptor does not throw away TypeInformation upon serialization.&lt;/p&gt;

&lt;p&gt;    Throwing away TypeInformation upon serialization was previously done because the type&lt;br/&gt;
    information was not serializable. Now that it is serializable, we can (and should) keep&lt;br/&gt;
    it to provide consistent user experience, where all serializers respect the ExecutionConfig.&lt;/p&gt;

&lt;p&gt;commit 7340bbec821e635cec7a4179a1444e0b0798bbdc&lt;br/&gt;
Author: Stephan Ewen &amp;lt;sewen@...&amp;gt;&lt;br/&gt;
Date:   2018-03-20T15:46:13Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;hotfix&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; Consilidate serializer duplication tests in StateDescriptorTest where possible&lt;/p&gt;

&lt;p&gt;commit c060ee9acdac35e08b5d1873b19e7bbf4d6906e8&lt;br/&gt;
Author: Stephan Ewen &amp;lt;sewen@...&amp;gt;&lt;br/&gt;
Date:   2018-03-20T16:16:06Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9035&quot; title=&quot;State Descriptors have broken hashCode() and equals()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9035&quot;&gt;&lt;del&gt;FLINK-9035&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; Fix state descriptor equals() and hashCode() handling&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16407454" author="githubbot" created="Wed, 21 Mar 2018 04:47:21 +0000"  >&lt;p&gt;Github user sihuazhou commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5732#discussion_r175983599&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5732#discussion_r175983599&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/api/common/state/StateDescriptor.java &amp;#8212;&lt;br/&gt;
    @@ -77,18 +80,22 @@&lt;/p&gt;

&lt;p&gt;     	/** The serializer for the type. May be eagerly initialized in the constructor,&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;or lazily once the type is serialized or an ExecutionConfig is provided. */&lt;br/&gt;
    +	@Nullable&lt;br/&gt;
     	protected TypeSerializer&amp;lt;T&amp;gt; serializer;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +	/** The type information describing the value type. Only used to lazily create the serializer&lt;br/&gt;
    +	 * and dropped during serialization */&lt;br/&gt;
    +	@Nullable&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit:Type information will not dropped during serialization now, it dropped in `initializeSerializerUnlessSet()`.&lt;/p&gt;</comment>
                            <comment id="16407588" author="githubbot" created="Wed, 21 Mar 2018 08:22:37 +0000"  >&lt;p&gt;Github user StephanEwen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5732#discussion_r176006260&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5732#discussion_r176006260&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/api/common/state/StateDescriptor.java &amp;#8212;&lt;br/&gt;
    @@ -77,18 +80,22 @@&lt;/p&gt;

&lt;p&gt;     	/** The serializer for the type. May be eagerly initialized in the constructor,&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;or lazily once the type is serialized or an ExecutionConfig is provided. */&lt;br/&gt;
    +	@Nullable&lt;br/&gt;
     	protected TypeSerializer&amp;lt;T&amp;gt; serializer;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +	/** The type information describing the value type. Only used to lazily create the serializer&lt;br/&gt;
    +	 * and dropped during serialization */&lt;br/&gt;
    +	@Nullable&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    good catch, will fix that upon merging&lt;/p&gt;</comment>
                            <comment id="16408515" author="githubbot" created="Wed, 21 Mar 2018 20:16:21 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5732#discussion_r176219956&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5732#discussion_r176219956&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/test/java/org/apache/flink/api/common/state/AggregatingStateDescriptorTest.java &amp;#8212;&lt;br/&gt;
    @@ -41,16 +40,11 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;Tests that the returned serializer is duplicated. This allows to&lt;/li&gt;
	&lt;li&gt;share the state descriptor.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
     	@Test&lt;br/&gt;
     	public void testSerializerDuplication() {&lt;/li&gt;
	&lt;li&gt;TypeSerializer&amp;lt;Long&amp;gt; serializer = mock(TypeSerializer.class);&lt;/li&gt;
	&lt;li&gt;when(serializer.duplicate()).thenAnswer(new Answer&amp;lt;TypeSerializer&amp;lt;Long&amp;gt;&amp;gt;() {&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public TypeSerializer&amp;lt;Long&amp;gt; answer(InvocationOnMock invocation) throws Throwable 
{
    -				return mock(TypeSerializer.class);
    -			}&lt;/li&gt;
	&lt;li&gt;});&lt;br/&gt;
    +		// we need a serializer that actually duplicates for testing (a stateful one)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Will this condition always hold? Should we maybe guard this assumption with an assertion, i.e. assert that the result of `serialiser.duplicate()` is different from the original serialiser?&lt;/p&gt;</comment>
                            <comment id="16408516" author="githubbot" created="Wed, 21 Mar 2018 20:16:22 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5732#discussion_r176220108&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5732#discussion_r176220108&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/test/java/org/apache/flink/api/common/state/ReducingStateDescriptorTest.java &amp;#8212;&lt;br/&gt;
    @@ -118,17 +115,14 @@ public void testValueStateDescriptorAutoSerializer() throws Exception {&lt;br/&gt;
     	@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
     	@Test&lt;br/&gt;
     	public void testSerializerDuplication() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TypeSerializer&amp;lt;String&amp;gt; statefulSerializer = mock(TypeSerializer.class);&lt;/li&gt;
	&lt;li&gt;when(statefulSerializer.duplicate()).thenAnswer(new Answer&amp;lt;TypeSerializer&amp;lt;String&amp;gt;&amp;gt;() {&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public TypeSerializer&amp;lt;String&amp;gt; answer(InvocationOnMock invocation) throws Throwable 
{
    -				return mock(TypeSerializer.class);
    -			}&lt;/li&gt;
	&lt;li&gt;});&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;ReduceFunction&amp;lt;String&amp;gt; reducer = mock(ReduceFunction.class);&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;ReducingStateDescriptor&amp;lt;String&amp;gt; descr = new ReducingStateDescriptor&amp;lt;&amp;gt;(&quot;foobar&quot;, reducer, statefulSerializer);&lt;br/&gt;
    +		// we need a serializer that actually duplicates for testing (a stateful one)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    See above&lt;/p&gt;</comment>
                            <comment id="16408517" author="githubbot" created="Wed, 21 Mar 2018 20:16:22 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5732#discussion_r176220974&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5732#discussion_r176220974&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/api/common/state/StateDescriptor.java &amp;#8212;&lt;br/&gt;
    @@ -77,18 +80,22 @@&lt;/p&gt;

&lt;p&gt;     	/** The serializer for the type. May be eagerly initialized in the constructor,&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;or lazily once the type is serialized or an ExecutionConfig is provided. */&lt;br/&gt;
    +	@Nullable&lt;br/&gt;
     	protected TypeSerializer&amp;lt;T&amp;gt; serializer;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    +	/** The type information describing the value type. Only used to lazily create the serializer&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    nit: I think this was also a copying error in the original comment, but this is not necessarily a &quot;value&quot;, unless we simply thing of all state as a value, in which case I&apos;m fine with this.&lt;/p&gt;</comment>
                            <comment id="16408518" author="githubbot" created="Wed, 21 Mar 2018 20:16:22 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5732#discussion_r176221943&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5732#discussion_r176221943&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/main/java/org/apache/flink/api/common/state/StateDescriptor.java &amp;#8212;&lt;br/&gt;
    @@ -249,12 +257,13 @@ public boolean isSerializerInitialized() {&lt;br/&gt;
     	 */&lt;br/&gt;
     	public void initializeSerializerUnlessSet(ExecutionConfig executionConfig) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This is slightly orthogonal to this change, but: could we get rid of this method and instead change `getSerializer()` to `getSerializer(ExecutionConfig)`. That way, we don&apos;t have to be concerned about forgetting to call `initializeSerializerUnlessSet()`.&lt;/p&gt;</comment>
                            <comment id="16408519" author="githubbot" created="Wed, 21 Mar 2018 20:16:22 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5732#discussion_r176222855&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5732#discussion_r176222855&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/test/java/org/apache/flink/api/common/state/StateDescriptorTest.java &amp;#8212;&lt;br/&gt;
    @@ -130,6 +135,31 @@ public void testInitializeSerializerAfterSerializationWithCustomConfig() throws&lt;br/&gt;
     				.getRegistration(File.class).getId() &amp;gt; 0);&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;    +	// ------------------------------------------------------------------------&lt;br/&gt;
    +	//  Tests for serializer initialization&lt;br/&gt;
    +	// ------------------------------------------------------------------------&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6775&quot; title=&quot;StateDescriptor cannot be shared by multiple subtasks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6775&quot;&gt;&lt;del&gt;FLINK-6775&lt;/del&gt;&lt;/a&gt;, tests that the returned serializer is duplicated.&lt;br/&gt;
    +	 * This allows to share the state descriptor across threads.&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testSerializerDuplication() throws Exception {&lt;br/&gt;
    +		// we need a serializer that actually duplicates for testing (a stateful one)&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Same as above, we should assert that assumption&lt;/p&gt;</comment>
                            <comment id="16408520" author="githubbot" created="Wed, 21 Mar 2018 20:16:22 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5732#discussion_r176220129&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5732#discussion_r176220129&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/test/java/org/apache/flink/api/common/state/ValueStateDescriptorTest.java &amp;#8212;&lt;br/&gt;
    @@ -149,13 +145,9 @@ public void testVeryLargeDefaultValue() throws Exception {&lt;br/&gt;
     	@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
     	@Test&lt;br/&gt;
     	public void testSerializerDuplication() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TypeSerializer&amp;lt;String&amp;gt; statefulSerializer = mock(TypeSerializer.class);&lt;/li&gt;
	&lt;li&gt;when(statefulSerializer.duplicate()).thenAnswer(new Answer&amp;lt;TypeSerializer&amp;lt;String&amp;gt;&amp;gt;() {&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public TypeSerializer&amp;lt;String&amp;gt; answer(InvocationOnMock invocation) throws Throwable 
{
    -				return mock(TypeSerializer.class);
    -			}&lt;/li&gt;
	&lt;li&gt;});&lt;br/&gt;
    +		// we need a serializer that actually duplicates for testing (a stateful one)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    See above&lt;/p&gt;</comment>
                            <comment id="16408521" author="githubbot" created="Wed, 21 Mar 2018 20:16:22 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5732#discussion_r176219997&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5732#discussion_r176219997&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/test/java/org/apache/flink/api/common/state/ListStateDescriptorTest.java &amp;#8212;&lt;br/&gt;
    @@ -121,13 +117,9 @@ public void testValueStateDescriptorAutoSerializer() throws Exception {&lt;br/&gt;
     	@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
     	@Test&lt;br/&gt;
     	public void testSerializerDuplication() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TypeSerializer&amp;lt;String&amp;gt; statefulSerializer = mock(TypeSerializer.class);&lt;/li&gt;
	&lt;li&gt;when(statefulSerializer.duplicate()).thenAnswer(new Answer&amp;lt;TypeSerializer&amp;lt;String&amp;gt;&amp;gt;() {&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public TypeSerializer&amp;lt;String&amp;gt; answer(InvocationOnMock invocation) throws Throwable 
{
    -				return mock(TypeSerializer.class);
    -			}&lt;/li&gt;
	&lt;li&gt;});&lt;br/&gt;
    +		// we need a serializer that actually duplicates for testing (a stateful one)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Same comment as above.&lt;/p&gt;</comment>
                            <comment id="16408522" author="githubbot" created="Wed, 21 Mar 2018 20:16:23 +0000"  >&lt;p&gt;Github user aljoscha commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5732#discussion_r176220075&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5732#discussion_r176220075&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-core/src/test/java/org/apache/flink/api/common/state/MapStateDescriptorTest.java &amp;#8212;&lt;br/&gt;
    @@ -129,23 +125,12 @@ public void testMapStateDescriptorAutoSerializer() throws Exception {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&amp;lt;p&amp;gt;Tests that the returned serializer is duplicated. This allows to&lt;/li&gt;
	&lt;li&gt;share the state descriptor.&lt;br/&gt;
     	 */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@SuppressWarnings(&quot;unchecked&quot;)&lt;br/&gt;
     	@Test&lt;br/&gt;
     	public void testSerializerDuplication() {&lt;/li&gt;
	&lt;li&gt;TypeSerializer&amp;lt;String&amp;gt; keySerializer = mock(TypeSerializer.class);&lt;/li&gt;
	&lt;li&gt;TypeSerializer&amp;lt;Long&amp;gt; valueSerializer = mock(TypeSerializer.class);&lt;/li&gt;
	&lt;li&gt;when(keySerializer.duplicate()).thenAnswer(new Answer&amp;lt;TypeSerializer&amp;lt;String&amp;gt;&amp;gt;() {&lt;/li&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public TypeSerializer&amp;lt;String&amp;gt; answer(InvocationOnMock invocation) throws Throwable 
{
    -				return mock(TypeSerializer.class);
    -			}&lt;br/&gt;
    -		});&lt;br/&gt;
    -		when(valueSerializer.duplicate()).thenAnswer(new Answer&amp;lt;TypeSerializer&amp;lt;Long&amp;gt;&amp;gt;() {&lt;br/&gt;
    -			@Override&lt;br/&gt;
    -			public TypeSerializer&amp;lt;Long&amp;gt; answer(InvocationOnMock invocation) throws Throwable {    -				return mock(TypeSerializer.class);    -			}&lt;/li&gt;
	&lt;li&gt;});&lt;br/&gt;
    +		// we need a serializer that actually duplicates for testing (a stateful one)
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    See above&lt;/p&gt;</comment>
                            <comment id="16409230" author="githubbot" created="Thu, 22 Mar 2018 08:48:12 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5732&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5732&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Concerning guarding the test assumptions: I think it is fine, because if the KryoSerializer is not duplicating properly any more (assumption violated), the test will also fail. (The problematic case would be the other way around, a serializer that does not duplicate and we check that the same instance is returned).&lt;/p&gt;

&lt;p&gt;    @aljoscha Do you think this should go into 1.5 as well?&lt;/p&gt;

&lt;p&gt;    @aljoscha Concerning changing `initializeSerializerUnlessSet(ExecutionConfig)` to `getSerializer(ExecutionConfig)` - I think that is a good idea, but would do that in a separate step. We need to re-work anyways a bit how we store state descriptors and obtain and reconfigure serializers.&lt;/p&gt;</comment>
                            <comment id="16409715" author="stephanewen" created="Thu, 22 Mar 2018 15:24:39 +0000"  >&lt;p&gt;Fixed in&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;1.5.0 via 586eb10084f56524f0bf14fb90c16e696b6a941f&lt;/li&gt;
	&lt;li&gt;1.6.0 via 87d31f5cf76fa796b89201ed8c55890e7d36fc81&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16410027" author="githubbot" created="Thu, 22 Mar 2018 18:15:03 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5732&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5732&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @StephanEwen Yes, I think this should go into 1.5.0 because it fixes potential (and real) problems. And yes, I wasn&apos;t suggesting to remove `initializeSerializerUnlessSet(ExecutionConfig)` now, but it seemed like a good place to mention it. &#128515; &lt;/p&gt;</comment>
                            <comment id="16422550" author="githubbot" created="Mon, 2 Apr 2018 14:22:26 +0000"  >&lt;p&gt;Github user StephanEwen commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5732&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5732&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Manually merged in f3a519712fb31f7b71181e876c3c3d5fff08eb71&lt;/p&gt;</comment>
                            <comment id="16422551" author="githubbot" created="Mon, 2 Apr 2018 14:22:27 +0000"  >&lt;p&gt;Github user StephanEwen closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/5732&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/5732&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 33 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3rkcn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>