<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:17:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-31168] JobManagerHAProcessFailureRecoveryITCase failed due to job not being found</title>
                <link>https://issues.apache.org/jira/browse/FLINK-31168</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=46342&amp;amp;view=logs&amp;amp;j=b0a398c0-685b-599c-eb57-c8c2a771138e&amp;amp;t=747432ad-a576-5911-1e2a-68c6bedc248a&amp;amp;l=12706&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=46342&amp;amp;view=logs&amp;amp;j=b0a398c0-685b-599c-eb57-c8c2a771138e&amp;amp;t=747432ad-a576-5911-1e2a-68c6bedc248a&amp;amp;l=12706&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We see this build failure because a job couldn&apos;t be found:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.RuntimeException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job to be initialized
	at org.apache.flink.util.ExceptionUtils.rethrow(ExceptionUtils.java:319)
	at org.apache.flink.api.java.ExecutionEnvironment.executeAsync(ExecutionEnvironment.java:1061)
	at org.apache.flink.api.java.ExecutionEnvironment.execute(ExecutionEnvironment.java:958)
	at org.apache.flink.api.java.ExecutionEnvironment.execute(ExecutionEnvironment.java:942)
	at org.apache.flink.test.recovery.JobManagerHAProcessFailureRecoveryITCase.testJobManagerFailure(JobManagerHAProcessFailureRecoveryITCase.java:235)
	at org.apache.flink.test.recovery.JobManagerHAProcessFailureRecoveryITCase$4.run(JobManagerHAProcessFailureRecoveryITCase.java:336)
Caused by: java.util.concurrent.ExecutionException: java.lang.RuntimeException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job to be initialized
	at java.base/java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:395)
	at java.base/java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1999)
	at org.apache.flink.api.java.ExecutionEnvironment.executeAsync(ExecutionEnvironment.java:1056)
	... 4 more
Caused by: java.lang.RuntimeException: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; job to be initialized
	at org.apache.flink.client.ClientUtils.waitUntilJobInitializationFinished(ClientUtils.java:160)
	at org.apache.flink.client.deployment.executors.AbstractSessionClusterExecutor.lambda$execute$2(AbstractSessionClusterExecutor.java:82)
	at org.apache.flink.util.function.FunctionUtils.lambda$uncheckedFunction$2(FunctionUtils.java:73)
	at java.base/java.util.concurrent.CompletableFuture$UniApply.tryFire(CompletableFuture.java:642)
	at java.base/java.util.concurrent.CompletableFuture$Completion.exec(CompletableFuture.java:479)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:290)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1020)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1656)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1594)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:183)
Caused by: java.util.concurrent.ExecutionException: org.apache.flink.runtime.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.util.RestClientException: [org.apache.flink.runtime.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.NotFoundException: Job 865dcd87f4828dbeb3d93eb52e2636b1 not found
	at org.apache.flink.runtime.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.handler.job.AbstractExecutionGraphHandler.lambda$handleRequest$1(AbstractExecutionGraphHandler.java:99)
	at java.base/java.util.concurrent.CompletableFuture.uniExceptionally(CompletableFuture.java:986)
	at java.base/java.util.concurrent.CompletableFuture$UniExceptionally.tryFire(CompletableFuture.java:970)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:506)
	at java.base/java.util.concurrent.CompletableFuture.completeExceptionally(CompletableFuture.java:2088)
	at org.apache.flink.runtime.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.handler.legacy.DefaultExecutionGraphCache.lambda$getExecutionGraphInternal$0(DefaultExecutionGraphCache.java:109)
	at java.base/java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:859)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:837)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:506)
	at java.base/java.util.concurrent.CompletableFuture.completeExceptionally(CompletableFuture.java:2088)
	at org.apache.flink.runtime.rpc.akka.AkkaInvocationHandler.lambda$invokeRpc$1(AkkaInvocationHandler.java:252)
	at java.base/java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:859)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:837)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:506)
	at java.base/java.util.concurrent.CompletableFuture.completeExceptionally(CompletableFuture.java:2088)
	at org.apache.flink.util.concurrent.FutureUtils.doForward(FutureUtils.java:1387)
	at org.apache.flink.runtime.concurrent.akka.ClassLoadingUtils.lambda$guardCompletionWithContextClassLoader$1(ClassLoadingUtils.java:93)
	at org.apache.flink.runtime.concurrent.akka.ClassLoadingUtils.runWithContextClassLoader(ClassLoadingUtils.java:68)
	at org.apache.flink.runtime.concurrent.akka.ClassLoadingUtils.lambda$guardCompletionWithContextClassLoader$2(ClassLoadingUtils.java:92)
	at java.base/java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:859)
	at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:837)
	at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:506)
	at java.base/java.util.concurrent.CompletableFuture.completeExceptionally(CompletableFuture.java:2088)
	at org.apache.flink.runtime.concurrent.akka.AkkaFutureUtils$1.onComplete(AkkaFutureUtils.java:45)
	at akka.dispatch.OnComplete.internal(Future.scala:299)
	at akka.dispatch.OnComplete.internal(Future.scala:297)
	at akka.dispatch.japi$CallbackBridge.apply(Future.scala:224)
	at akka.dispatch.japi$CallbackBridge.apply(Future.scala:221)
	at scala.concurrent.impl.CallbackRunnable.run(Promise.scala:60)
	at org.apache.flink.runtime.concurrent.akka.AkkaFutureUtils$DirectExecutionContext.execute(AkkaFutureUtils.java:65)
	at scala.concurrent.impl.CallbackRunnable.executeWithValue(Promise.scala:68)
	at scala.concurrent.impl.Promise$DefaultPromise.$anonfun$tryComplete$1(Promise.scala:284)
	at scala.concurrent.impl.Promise$DefaultPromise.$anonfun$tryComplete$1$adapted(Promise.scala:284)
	at scala.concurrent.impl.Promise$DefaultPromise.tryComplete(Promise.scala:284)
	at akka.pattern.PromiseActorRef.$bang(AskSupport.scala:621)
	at akka.pattern.PipeToSupport$PipeableFuture$$anonfun$pipeTo$1.applyOrElse(PipeToSupport.scala:25)
	at akka.pattern.PipeToSupport$PipeableFuture$$anonfun$pipeTo$1.applyOrElse(PipeToSupport.scala:23)
	at scala.concurrent.Future.$anonfun$andThen$1(Future.scala:532)
	at scala.concurrent.impl.Promise.liftedTree1$1(Promise.scala:29)
	at scala.concurrent.impl.Promise.$anonfun$transform$1(Promise.scala:29)
	at scala.concurrent.impl.CallbackRunnable.run(Promise.scala:60)
	at akka.dispatch.BatchingExecutor$AbstractBatch.processBatch(BatchingExecutor.scala:63)
	at akka.dispatch.BatchingExecutor$BlockableBatch.$anonfun$run$1(BatchingExecutor.scala:100)
	at scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.java:12)
	at scala.concurrent.BlockContext$.withBlockContext(BlockContext.scala:81)
	at akka.dispatch.BatchingExecutor$BlockableBatch.run(BatchingExecutor.scala:100)
	at akka.dispatch.TaskInvocation.run(AbstractDispatcher.scala:49)
	at akka.dispatch.ForkJoinExecutorConfigurator$AkkaForkJoinTask.exec(ForkJoinExecutorConfigurator.scala:48)
	at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:290)
	at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1020)
	at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1656)
	at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1594)
	at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:183)
Caused by: org.apache.flink.runtime.messages.FlinkJobNotFoundException: Could not find Flink job (865dcd87f4828dbeb3d93eb52e2636b1)
	at org.apache.flink.runtime.dispatcher.Dispatcher.requestExecutionGraphInfo(Dispatcher.java:840)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:566)
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.lambda$handleRpcInvocation$1(AkkaRpcActor.java:304)
	at org.apache.flink.runtime.concurrent.akka.ClassLoadingUtils.runWithContextClassLoader(ClassLoadingUtils.java:83)
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcInvocation(AkkaRpcActor.java:302)
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcMessage(AkkaRpcActor.java:217)
	at org.apache.flink.runtime.rpc.akka.FencedAkkaRpcActor.handleRpcMessage(FencedAkkaRpcActor.java:78)
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleMessage(AkkaRpcActor.java:163)
	at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:24)
	at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:20)
	at scala.PartialFunction.applyOrElse(PartialFunction.scala:123)
	at scala.PartialFunction.applyOrElse$(PartialFunction.scala:122)
	at akka.japi.pf.UnitCaseStatement.applyOrElse(CaseStatements.scala:20)
	at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:171)
	at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:172)
	at scala.PartialFunction$OrElse.applyOrElse(PartialFunction.scala:172)
	at akka.actor.Actor.aroundReceive(Actor.scala:537)
	at akka.actor.Actor.aroundReceive$(Actor.scala:535)
	at akka.actor.AbstractActor.aroundReceive(AbstractActor.scala:220)
	at akka.actor.ActorCell.receiveMessage(ActorCell.scala:580)
	at akka.actor.ActorCell.invoke(ActorCell.scala:548)
	at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:270)
	at akka.dispatch.Mailbox.run(Mailbox.scala:231)
	at akka.dispatch.Mailbox.exec(Mailbox.scala:243)
	... 5 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13525559">FLINK-31168</key>
            <summary>JobManagerHAProcessFailureRecoveryITCase failed due to job not being found</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mapohl">Matthias Pohl</assignee>
                                    <reporter username="mapohl">Matthias Pohl</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Tue, 21 Feb 2023 12:45:29 +0000</created>
                <updated>Wed, 2 Aug 2023 11:20:07 +0000</updated>
                            <resolved>Wed, 2 Aug 2023 11:20:07 +0000</resolved>
                                    <version>1.15.3</version>
                    <version>1.16.1</version>
                    <version>1.18.0</version>
                                    <fixVersion>1.18.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17691580" author="mapohl" created="Tue, 21 Feb 2023 12:46:29 +0000"  >&lt;p&gt;I&apos;m closing &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-25585&quot; title=&quot;JobManagerHAProcessFailureRecoveryITCase.testDispatcherProcessFailure failed on the azure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-25585&quot;&gt;&lt;del&gt;FLINK-25585&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-15561&quot; title=&quot;Unify Kerberos credentials checking&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-15561&quot;&gt;&lt;del&gt;FLINK-15561&lt;/del&gt;&lt;/a&gt; and create this one as a follow-up because the other two issue seem to be related but lack logs from the documented builds.&lt;/p&gt;</comment>
                            <comment id="17691584" author="mapohl" created="Tue, 21 Feb 2023 12:48:35 +0000"  >&lt;p&gt;This one was documented in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-15561&quot; title=&quot;Unify Kerberos credentials checking&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-15561&quot;&gt;&lt;del&gt;FLINK-15561&lt;/del&gt;&lt;/a&gt; which is still valid and covers the same issue:&lt;br/&gt;
&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=42038&amp;amp;view=logs&amp;amp;j=5c8e7682-d68f-54d1-16a2-a09310218a49&amp;amp;t=86f654fa-ab48-5c1a-25f4-7e7f6afb9bba&amp;amp;l=7466&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=42038&amp;amp;view=logs&amp;amp;j=5c8e7682-d68f-54d1-16a2-a09310218a49&amp;amp;t=86f654fa-ab48-5c1a-25f4-7e7f6afb9bba&amp;amp;l=7466&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The CI build is related to the &lt;a href=&quot;https://github.com/apache/flink/pull/21067&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FLINK-25554 1.16 backport PR&lt;/a&gt;. Therefore, I&apos;m gonna add 1.16 as an affected version as well.&lt;/p&gt;</comment>
                            <comment id="17691585" author="mapohl" created="Tue, 21 Feb 2023 12:51:26 +0000"  >&lt;p&gt;There is a &lt;a href=&quot;https://lists.apache.org/thread/tws3r1oqwpc2n3v1dw5qvkzjzm27fgyd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;user ML thread&lt;/a&gt; that raises a similar stacktrace.&lt;/p&gt;</comment>
                            <comment id="17691710" author="mapohl" created="Tue, 21 Feb 2023 16:52:04 +0000"  >&lt;p&gt;Based on the stacktrace listed in the description, the job is executed (see &lt;a href=&quot;https://github.com/apache/flink/blob/489827520b1a53db04a94346c98327d0d42301c5/flink-tests/src/test/java/org/apache/flink/test/recovery/JobManagerHAProcessFailureRecoveryITCase.java#L235&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JobManagerHAProcessFailureRecoveryITCase:235&lt;/a&gt; which submits the job and then waits for the initialization to be over. This is implemented in using &lt;tt&gt;ClientUtils.waitUntilJobInitializationFinished&lt;/tt&gt; in &lt;a href=&quot;https://github.com/apache/flink/blob/f4b59f615438e76c2b42999fc0a8ebce6a543b07/flink-clients/src/main/java/org/apache/flink/client/deployment/executors/AbstractSessionClusterExecutor.java#L82&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;AbstractSessionClusterExecutor:82ff&lt;/a&gt; utilizing a &lt;tt&gt;RestClusterClient&lt;/tt&gt;&apos;s &lt;tt&gt;getJobStatus&lt;/tt&gt; and &lt;tt&gt;requestJobResult&lt;/tt&gt; methods.&lt;/p&gt;

&lt;p&gt;The actual error happened in &lt;a href=&quot;https://github.com/apache/flink/blob/9e908567ecc06b607d08fca8e2e781b463a38de6/flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java#L840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Dispatcher:480f&lt;/a&gt; where &lt;tt&gt;JobManagerRunner&lt;/tt&gt; is already deregistered. Therefore, the &lt;tt&gt;requestExecutionGraphInfo&lt;/tt&gt; fails returning an exceptionally completed future with the &lt;tt&gt;FlinkJobNotFoundException&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;ClientUtils.waitUntilJobInitializationFinished&lt;/tt&gt; uses &lt;tt&gt;new ExponentialWaitStrategy(50, 2000)&lt;/tt&gt; as a &lt;tt&gt;WaitStrategy&lt;/tt&gt;. My theory is, that the 2s of the wait strategy are too long and the job starts and finishes between two &lt;tt&gt;getJobStatus&lt;/tt&gt; calls causing the corresponding &lt;tt&gt;JobManagerRunner&lt;/tt&gt; to be removed and the &lt;tt&gt;getJobStatus&lt;/tt&gt; call to fail as observed.&lt;/p&gt;</comment>
                            <comment id="17692266" author="mapohl" created="Wed, 22 Feb 2023 16:27:34 +0000"  >&lt;p&gt;My previous conclusion doesn&apos;t hold because the &lt;tt&gt;requestExecutionGraphInfo&lt;/tt&gt; shouldn&apos;t fail but rely on the &lt;tt&gt;ExecutionGraphInfoStore&lt;/tt&gt; as a backup. A local test which increased the interval for the &lt;tt&gt;waitUntilJobInitializationFinished&lt;/tt&gt; also succeeded as expected.&lt;/p&gt;</comment>
                            <comment id="17692272" author="mapohl" created="Wed, 22 Feb 2023 16:35:39 +0000"  >&lt;p&gt;What is odd, though, is the location of the inital cause in the stacktrace:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[...]
Caused by: org.apache.flink.runtime.messages.FlinkJobNotFoundException: Could not find Flink job (865dcd87f4828dbeb3d93eb52e2636b1)
	at org.apache.flink.runtime.dispatcher.Dispatcher.requestExecutionGraphInfo(Dispatcher.java:840)
[...]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The build mentioned in the Jira issue&apos;s description is based on &lt;tt&gt;c6b649bf&lt;/tt&gt;. &lt;a href=&quot;https://github.com/apache/flink/blob/c6b649bf/flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java#L840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Dispatcher:840 in c6b649bf&lt;/a&gt; doesn&apos;t point to a code line that throws the &lt;tt&gt;FlinkJobNotFoundException&lt;/tt&gt;. Line 841 would be a valid location. It looks like I&apos;m missing something here. &lt;/p&gt;</comment>
                            <comment id="17716630" author="sergey nuyanzin" created="Wed, 26 Apr 2023 09:32:33 +0000"  >&lt;p&gt;master(1.18): &lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=48442&amp;amp;view=logs&amp;amp;j=b0a398c0-685b-599c-eb57-c8c2a771138e&amp;amp;t=747432ad-a576-5911-1e2a-68c6bedc248a&amp;amp;l=13428&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=48442&amp;amp;view=logs&amp;amp;j=b0a398c0-685b-599c-eb57-c8c2a771138e&amp;amp;t=747432ad-a576-5911-1e2a-68c6bedc248a&amp;amp;l=13428&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17723039" author="renqs" created="Tue, 16 May 2023 08:14:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt; are you still working on this issue? Thanks&lt;/p&gt;</comment>
                            <comment id="17723050" author="mapohl" created="Tue, 16 May 2023 08:40:42 +0000"  >&lt;p&gt;I didn&apos;t continue with that issue, no.&lt;/p&gt;</comment>
                            <comment id="17731956" author="renqs" created="Tue, 13 Jun 2023 08:23:33 +0000"  >&lt;p&gt;Downgraded to major as the latest case happened two months ago.&#160;&lt;/p&gt;</comment>
                            <comment id="17738496" author="sergey nuyanzin" created="Thu, 29 Jun 2023 10:50:17 +0000"  >&lt;p&gt;new case &lt;br/&gt;
&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=50607&amp;amp;view=logs&amp;amp;j=a596f69e-60d2-5a4b-7d39-dc69e4cdaed3&amp;amp;t=712ade8c-ca16-5b76-3acd-14df33bc1cb1&amp;amp;l=10348&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=50607&amp;amp;view=logs&amp;amp;j=a596f69e-60d2-5a4b-7d39-dc69e4cdaed3&amp;amp;t=712ade8c-ca16-5b76-3acd-14df33bc1cb1&amp;amp;l=10348&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17741884" author="sergey nuyanzin" created="Tue, 11 Jul 2023 07:32:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=51165&amp;amp;view=logs&amp;amp;j=a596f69e-60d2-5a4b-7d39-dc69e4cdaed3&amp;amp;t=712ade8c-ca16-5b76-3acd-14df33bc1cb1&amp;amp;l=11042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=51165&amp;amp;view=logs&amp;amp;j=a596f69e-60d2-5a4b-7d39-dc69e4cdaed3&amp;amp;t=712ade8c-ca16-5b76-3acd-14df33bc1cb1&amp;amp;l=11042&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17743703" author="sergey nuyanzin" created="Mon, 17 Jul 2023 09:43:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=51299&amp;amp;view=logs&amp;amp;j=a596f69e-60d2-5a4b-7d39-dc69e4cdaed3&amp;amp;t=712ade8c-ca16-5b76-3acd-14df33bc1cb1&amp;amp;l=11285&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=51299&amp;amp;view=logs&amp;amp;j=a596f69e-60d2-5a4b-7d39-dc69e4cdaed3&amp;amp;t=712ade8c-ca16-5b76-3acd-14df33bc1cb1&amp;amp;l=11285&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17748254" author="mapohl" created="Thu, 27 Jul 2023 16:50:31 +0000"  >&lt;p&gt;The error appears in the &lt;a href=&quot;https://github.com/apache/flink/blob/d78d52b27af2550f50b44349d3ec6dc84b966a8a/flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/FileExecutionGraphInfoStore.java#L237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FileExecutionGraphInfoStore#getAvailableJobDetails(JobID)&lt;/a&gt; where the JobDetails are not cached. The &lt;tt&gt;FileSystemExecutionGraphInfoStore&lt;/tt&gt; uses two caches:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;jobDetailsCache&lt;/tt&gt; holds the &lt;tt&gt;JobDetails&lt;/tt&gt; of each job in cache. It has a default expiration time of 3600s (see &lt;a href=&quot;https://github.com/apache/flink/blob/f3598c50c0d3dcdf8058b01f13b7eb9fc5954f7c/flink-core/src/main/java/org/apache/flink/configuration/JobManagerOptions.java#L340&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jobstore.expiration-time default&lt;/a&gt;). The size of the cache is limited to &lt;tt&gt;Integer.MAX_VALUE&lt;/tt&gt; entries (see &lt;a href=&quot;https://github.com/apache/flink/blob/f3598c50c0d3dcdf8058b01f13b7eb9fc5954f7c/flink-core/src/main/java/org/apache/flink/configuration/JobManagerOptions.java#L350&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jobstore.max-capacity default&lt;/a&gt;). Removing entries from this cache will trigger the removal of the file and invalidates the corresponding entries in both caches. Removal can happen even earlier, though&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;executionGraphInfoCache&lt;/tt&gt; holds the &lt;tt&gt;ExecutionGraphInfo&lt;/tt&gt; in the cache. It&apos;s limited to 50MB (see &lt;a href=&quot;https://github.com/apache/flink/blob/f3598c50c0d3dcdf8058b01f13b7eb9fc5954f7c/flink-core/src/main/java/org/apache/flink/configuration/JobManagerOptions.java#L331&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jobstore.cache-size default&lt;/a&gt;). The ExecutionGraphInfo will be reloaded from disk in case it was removed from the cache before.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This error can be simulated by reducing either the expiry time of the &lt;tt&gt;jobDetailsCache&lt;/tt&gt; or decreasing the entry limit of that cache.&lt;/p&gt;

&lt;p&gt;One suspicion is that the entry gets removed earlier. The &lt;a href=&quot;https://guava.dev/releases/19.0/api/docs/com/google/common/cache/CacheBuilder.html#maximumSize(long)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CacheBuilder#maximumSize JavaDoc&lt;/a&gt; states that this can happen:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Note that the cache may evict an entry before this limit is exceeded.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We should investigate whether the error started to appear with the &lt;tt&gt;flink-shaded&lt;/tt&gt; update (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-30772&quot; title=&quot;Update Flink Shaded dependencies to the latest versions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-30772&quot;&gt;&lt;del&gt;FLINK-30772&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-32032&quot; title=&quot;Upgrade to flink-shaded 17.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-32032&quot;&gt;&lt;del&gt;FLINK-32032&lt;/del&gt;&lt;/a&gt;) where the update might have included a change in how the cache operates. I will continue investigating this tomorrow.&lt;/p&gt;</comment>
                            <comment id="17748436" author="mapohl" created="Fri, 28 Jul 2023 06:45:39 +0000"  >&lt;p&gt;My suspicion doesn&apos;t seem to hold: I couldn&apos;t identify any change between guava 30.1 and guava 31.1 (I checked the sources and the release notes) that would have been an explanation for different eviction behavior. Additionally, the &lt;a href=&quot;https://guava.dev/releases/19.0/api/docs/com/google/common/cache/CacheBuilder.html#maximumSize(long)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CacheBuilder#maximumSize JavaDoc&lt;/a&gt; states that entries are only evicted if the cache is getting close to its limit (which is &lt;tt&gt;Integer.MAX_VALUE&lt;/tt&gt;). The test itself only runs a single job which would lead to one entry in the cache.&lt;/p&gt;</comment>
                            <comment id="17748445" author="mapohl" created="Fri, 28 Jul 2023 07:20:22 +0000"  >&lt;p&gt;For the record: The reported cases do not always have the same cause.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Build&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Comment&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Description&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=46342&amp;amp;view=logs&amp;amp;j=b0a398c0-685b-599c-eb57-c8c2a771138e&amp;amp;t=747432ad-a576-5911-1e2a-68c6bedc248a&amp;amp;l=12706&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;20230221.2 (#46342)&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;release-1.15 (c6b649bf)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Jira issue description&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Job was not found during initialization phase of the job&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=42038&amp;amp;view=logs&amp;amp;j=5c8e7682-d68f-54d1-16a2-a09310218a49&amp;amp;t=86f654fa-ab48-5c1a-25f4-7e7f6afb9bba&amp;amp;l=9922&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;20221014.20 (#42038)&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.16 PR&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1st report in comments&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Error after job finished&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=48442&amp;amp;view=logs&amp;amp;j=b0a398c0-685b-599c-eb57-c8c2a771138e&amp;amp;t=747432ad-a576-5911-1e2a-68c6bedc248a&amp;amp;l=12170&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;20232504.1 (#48442)&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;master (1.18)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2nd report in comments&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Error after job finished&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=50607&amp;amp;view=logs&amp;amp;j=a596f69e-60d2-5a4b-7d39-dc69e4cdaed3&amp;amp;t=712ade8c-ca16-5b76-3acd-14df33bc1cb1&amp;amp;l=9363&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;20230629.1 (#50607)&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;master (74ae4b24)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;3rd report in comments&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Ask timeout&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=51165&amp;amp;view=logs&amp;amp;j=a596f69e-60d2-5a4b-7d39-dc69e4cdaed3&amp;amp;t=712ade8c-ca16-5b76-3acd-14df33bc1cb1&amp;amp;l=9898&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;20230711.1 (#51165)&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;master (4cf2124d)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;4th report in comments&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Error while restarting the dispatcher (job not finished)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=51299&amp;amp;view=logs&amp;amp;j=a596f69e-60d2-5a4b-7d39-dc69e4cdaed3&amp;amp;t=712ade8c-ca16-5b76-3acd-14df33bc1cb1&amp;amp;l=10039&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;20230717.1 (#51299)&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;master (4690dc29)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;5th report in comments&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Error while restarting the dispatcher (job not finished)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=51165&amp;amp;view=logs&amp;amp;j=a596f69e-60d2-5a4b-7d39-dc69e4cdaed3&amp;amp;t=712ade8c-ca16-5b76-3acd-14df33bc1cb1&amp;amp;l=9898&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;20230711.1 (#51165)&lt;/a&gt; is the first failure that included the flink-shaded 17.0 upgrade (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-32032&quot; title=&quot;Upgrade to flink-shaded 17.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-32032&quot;&gt;&lt;del&gt;FLINK-32032&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="17748491" author="mapohl" created="Fri, 28 Jul 2023 08:45:57 +0000"  >&lt;p&gt;The most-recent failures seem to have been caused by the job recovery not being successful:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=51165&amp;amp;view=logs&amp;amp;j=a596f69e-60d2-5a4b-7d39-dc69e4cdaed3&amp;amp;t=712ade8c-ca16-5b76-3acd-14df33bc1cb1&amp;amp;l=8688&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;20230711.1 (#51165) Dispatcher #1 output in line 8688&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=51299&amp;amp;view=logs&amp;amp;j=a596f69e-60d2-5a4b-7d39-dc69e4cdaed3&amp;amp;t=712ade8c-ca16-5b76-3acd-14df33bc1cb1&amp;amp;l=9918&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;20230717.1 (#51299) Dispatcher #1 output in line 9918&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m gonna raise the priority of this issue to blocker because it could be related to the leader election changes.&lt;/p&gt;

&lt;p&gt;The job is not picked up anymore and therefore, cannot be saved in the &lt;tt&gt;ExecutionGraphInfoStore&lt;/tt&gt;. The job client will wait for the initialization phase to be over and then requests the JobResult which calls &lt;tt&gt;Dispatcher.requestJobStatus&lt;/tt&gt;. &lt;tt&gt;requestJobStatus&lt;/tt&gt; won&apos;t find a &lt;tt&gt;JobManagerRunner&lt;/tt&gt; in &lt;tt&gt;Dispatcher#jobManagerRunnerRegistry&lt;/tt&gt; and non in the &lt;tt&gt;Dispatcher#executionGraphInfoStore&lt;/tt&gt; (see &lt;a href=&quot;https://github.com/apache/flink/blob/ab9445aca56e7d139e8fd9bcc23e5f7e06288e66/flink-runtime/src/main/java/org/apache/flink/runtime/dispatcher/Dispatcher.java#L902&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Dispatcher#requestJobStatus&lt;/a&gt;). Therefore, the response future will complete exceptionally with a &lt;tt&gt;FlinkJobNotFoundException&lt;/tt&gt; causing the error which we&apos;re seeing in the last two CI failures.&lt;/p&gt;</comment>
                            <comment id="17748533" author="mapohl" created="Fri, 28 Jul 2023 09:43:50 +0000"  >&lt;p&gt;It appears that the leader election is not causing the problem: The JobGraph is written properly to the JobGraphStore under &lt;tt&gt;flink/default/jobgraphs&lt;/tt&gt; in the JM run #0 (see &lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=51299&amp;amp;view=logs&amp;amp;j=a596f69e-60d2-5a4b-7d39-dc69e4cdaed3&amp;amp;t=712ade8c-ca16-5b76-3acd-14df33bc1cb1&amp;amp;l=9106&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;log line in build #51299&lt;/a&gt;):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Jul 17 01:09:58 01:09:47,954 10630 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-20] INFO  org.apache.flink.runtime.jobmanager.DefaultJobGraphStore [] - Added JobGraph(jobId: 10ea837b5ff5916e57e0f49298d952d3) to ZooKeeperStateHandleStore{namespace=&lt;span class=&quot;code-quote&quot;&gt;&apos;flink/&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;/jobgraphs&apos;&lt;/span&gt;}.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A leader is picked in JM run #1 that tries to recover the data from the correct ZNode &lt;tt&gt;flink/default/jobgraphs&lt;/tt&gt; (see &lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=51299&amp;amp;view=logs&amp;amp;j=a596f69e-60d2-5a4b-7d39-dc69e4cdaed3&amp;amp;t=712ade8c-ca16-5b76-3acd-14df33bc1cb1&amp;amp;l=9917&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;log line in build #51299&lt;/a&gt;). But it appears that the ZNode is empty:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Jul 17 01:09:59 01:09:55,657 6184 [cluster-io-thread-2] INFO  org.apache.flink.runtime.jobmanager.DefaultJobGraphStore [] - Retrieved job ids [] from ZooKeeperStateHandleStore{namespace=&lt;span class=&quot;code-quote&quot;&gt;&apos;flink/&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;/jobgraphs&apos;&lt;/span&gt;}
Jul 17 01:09:59 01:09:55,657 6184 [cluster-io-thread-2] INFO  org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess [] - Successfully recovered 0 persisted job graphs.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17748537" author="mapohl" created="Fri, 28 Jul 2023 09:49:55 +0000"  >&lt;p&gt;So far, I wasn&apos;t able to reproduce it locally with up to now 300 test runs.&lt;/p&gt;

&lt;p&gt;Update: The test runs happened with JDK11. I noticed that the two test failures in question happened with JDK17. I&apos;m gonna continue looking into the issue in that direction.&lt;/p&gt;</comment>
                            <comment id="17748584" author="mapohl" created="Fri, 28 Jul 2023 12:19:39 +0000"  >&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_up.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I was able to reproduce this test failure using JDK17 (after 3 runs and after 74 runs). I&apos;m gonna go ahead and investigate it further.&lt;/p&gt;</comment>
                            <comment id="17748808" author="mapohl" created="Sat, 29 Jul 2023 10:09:32 +0000"  >&lt;p&gt;the suspicion is now that the process destruction is being prevented by JDK17. There&apos;s an entry in the logs that suggests that:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
01:09:49,250 [                main] ERROR org.apache.flink.runtime.testutils.TestJvmProcess            [] - Failed to forcibly destroy process
java.lang.reflect.InaccessibleObjectException: Unable to make &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; java.lang.&lt;span class=&quot;code-object&quot;&gt;Process&lt;/span&gt; java.lang.ProcessImpl.destroyForcibly() accessible: module java.base does not &lt;span class=&quot;code-quote&quot;&gt;&quot;opens java.lang&quot;&lt;/span&gt; to unnamed module @19dc67c2
        at java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:354) ~[?:?]
        at java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:297) ~[?:?]
        at java.lang.reflect.Method.checkCanSetAccessible(Method.java:199) ~[?:?]
        at java.lang.reflect.Method.setAccessible(Method.java:193) ~[?:?]
        at org.apache.flink.runtime.testutils.TestJvmProcess.destroy(TestJvmProcess.java:214) ~[flink-runtime-1.18-SNAPSHOT-tests.jar:1.18-SNAPSHOT]
        at org.apache.flink.test.recovery.JobManagerHAProcessFailureRecoveryITCase.testDispatcherProcessFailure(JobManagerHAProcessFailureRecoveryITCase.java:367) ~[test-classes/:?]
        at jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[?:?]
        [...]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The &lt;tt&gt;TestJvmProcess&lt;/tt&gt; class actually tries to destroy the process forcefully first through reflection (see &lt;a href=&quot;https://github.com/apache/flink/blob/2940c02c986e3d70708187091bf006806bb90dff/flink-runtime/src/test/java/org/apache/flink/runtime/testutils/TestJvmProcess.java#L214&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;apache/flink:org.apache.flink.runtime.testutils.TestJvmProcess:214ff&lt;/a&gt;) and calls &lt;tt&gt;destroy&lt;/tt&gt; afterwards if the forced approach didn&apos;t work without waiting for the process to finish. That could mean that the process gets destroyed eventually but has enough time to finish the job in the first run (i.e. cleaning the jobgraph up at the end) before the second JM process is started.&lt;/p&gt;

&lt;p&gt;Two interesting observations, though:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Running the test under JDK17 locally multiple times seems to create daemon child processes under the intellij process (which means that some process is still not properly destroyed)&lt;/li&gt;
	&lt;li&gt;The dispatcher logs of the first run don&apos;t reveal the finishing of the job. I have to check whether the &lt;tt&gt;Process&lt;/tt&gt; class stops sending the logs to the pipe before triggering the process destruction (that would explain that the logs are not complete)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17749071" author="mapohl" created="Mon, 31 Jul 2023 07:39:44 +0000"  >&lt;p&gt;jdk17 again: &lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=51817&amp;amp;view=logs&amp;amp;j=a596f69e-60d2-5a4b-7d39-dc69e4cdaed3&amp;amp;t=712ade8c-ca16-5b76-3acd-14df33bc1cb1&amp;amp;l=11234&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=51817&amp;amp;view=logs&amp;amp;j=a596f69e-60d2-5a4b-7d39-dc69e4cdaed3&amp;amp;t=712ade8c-ca16-5b76-3acd-14df33bc1cb1&amp;amp;l=11234&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17749085" author="mapohl" created="Mon, 31 Jul 2023 08:44:57 +0000"  >&lt;p&gt;I&apos;m lowering the priority of this issue again. We should wait for the JM process to finish before triggering the follow-up JM. The job occassionally finishing before the JM process is destroyed seems to be the cause of this test instability.&lt;/p&gt;</comment>
                            <comment id="17750263" author="mapohl" created="Wed, 2 Aug 2023 11:20:07 +0000"  >&lt;p&gt;master: 476d68814ab606a86e376b1649713a7661fb12e4&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13280368">FLINK-15661</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13421607">FLINK-25585</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 14 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1g2tc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>