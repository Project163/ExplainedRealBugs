<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:35:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10638] Invalid table scan resolution for temporal join queries</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10638</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Registered tables that contain a temporal join are not properly resolved when performing a table scan.&lt;/p&gt;

&lt;p&gt;A planning error occurs when registering a table with a temporal join and reading from it again.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
LogicalProject(amount=[*($0, $4)])
  LogicalFilter(condition=[=($3, $1)])
    LogicalCorrelate(correlation=[$cor0], joinType=[&lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt;], requiredColumns=[{2}])
      LogicalTableScan(table=[[_DataStreamTable_0]])
      LogicalTableFunctionScan(invocation=[Rates(CAST($cor0.rowtime):TIMESTAMP(3) NOT NULL)], rowType=[RecordType(VARCHAR(65536) currency, BIGINT rate, TIME ATTRIBUTE(ROWTIME) rowtime)], elementType=[class [Ljava.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13193196">FLINK-10638</key>
            <summary>Invalid table scan resolution for temporal join queries</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pnowojski">Piotr Nowojski</assignee>
                                    <reporter username="twalthr">Timo Walther</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 22 Oct 2018 08:04:26 +0000</created>
                <updated>Mon, 5 Nov 2018 12:31:32 +0000</updated>
                            <resolved>Mon, 5 Nov 2018 12:31:32 +0000</resolved>
                                                    <fixVersion>1.7.0</fixVersion>
                                    <component>Table SQL / API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16658775" author="githubbot" created="Mon, 22 Oct 2018 09:30:00 +0000"  >&lt;p&gt;twalthr opened a new pull request #6893: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10638&quot; title=&quot;Invalid table scan resolution for temporal join queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10638&quot;&gt;&lt;del&gt;FLINK-10638&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix table scan resolution for temporal join queries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6893&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6893&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Changes the optimization order such that table scans are resolved to full plan nodes before performing temporal join conversion.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Optimization order changed.&lt;/li&gt;
&lt;/ul&gt;



&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Extended temporal join IT case.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): no&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: no&lt;/li&gt;
	&lt;li&gt;The serializers: no&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): no&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: no&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: no&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? no&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? not applicable&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16659325" author="githubbot" created="Mon, 22 Oct 2018 18:34:40 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6893: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10638&quot; title=&quot;Invalid table scan resolution for temporal join queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10638&quot;&gt;&lt;del&gt;FLINK-10638&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix table scan resolution for temporal join queries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6893#discussion_r226966124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6893#discussion_r226966124&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/StreamTableEnvironment.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -804,9 +804,9 @@ abstract class StreamTableEnvironment(&lt;br/&gt;
     */&lt;br/&gt;
   private&lt;span class=&quot;error&quot;&gt;&amp;#91;flink&amp;#93;&lt;/span&gt; def optimize(relNode: RelNode, updatesAsRetraction: Boolean): RelNode = {&lt;br/&gt;
     val convSubQueryPlan = optimizeConvertSubQueries(relNode)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val temporalTableJoinPlan = optimizeConvertToTemporalJoin(convSubQueryPlan)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   This was being done before `optimizeConvertTableReferences` because unrolling temporal table functions introduces new plan subtrees that can (and will have) new scan nodes.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16668910" author="githubbot" created="Tue, 30 Oct 2018 15:48:14 +0000"  >&lt;p&gt;pnowojski commented on issue #6893: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10638&quot; title=&quot;Invalid table scan resolution for temporal join queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10638&quot;&gt;&lt;del&gt;FLINK-10638&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix table scan resolution for temporal join queries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6893#issuecomment-434355575&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6893#issuecomment-434355575&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Closing since this is not a valid fix for the problem. Depending on use case either `optimizeConvertTableReferences` or `optimizeConvertToTemporalJoin` should be called first. Probably we need to run those rules in vulcano or loop them until we reach a fix point.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16668911" author="githubbot" created="Tue, 30 Oct 2018 15:48:18 +0000"  >&lt;p&gt;pnowojski closed pull request #6893: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10638&quot; title=&quot;Invalid table scan resolution for temporal join queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10638&quot;&gt;&lt;del&gt;FLINK-10638&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Fix table scan resolution for temporal join queries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6893&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6893&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/StreamTableEnvironment.scala b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/StreamTableEnvironment.scala&lt;br/&gt;
index 65191202ad8..6d6a17d9e8f 100644&lt;br/&gt;
&amp;#8212; a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/StreamTableEnvironment.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/StreamTableEnvironment.scala&lt;br/&gt;
@@ -804,9 +804,9 @@ abstract class StreamTableEnvironment(&lt;br/&gt;
     */&lt;br/&gt;
   private&lt;span class=&quot;error&quot;&gt;&amp;#91;flink&amp;#93;&lt;/span&gt; def optimize(relNode: RelNode, updatesAsRetraction: Boolean): RelNode = {&lt;br/&gt;
     val convSubQueryPlan = optimizeConvertSubQueries(relNode)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val temporalTableJoinPlan = optimizeConvertToTemporalJoin(convSubQueryPlan)&lt;/li&gt;
	&lt;li&gt;val fullNode = optimizeConvertTableReferences(temporalTableJoinPlan)&lt;/li&gt;
	&lt;li&gt;val decorPlan = RelDecorrelator.decorrelateQuery(fullNode)&lt;br/&gt;
+    val fullNode = optimizeConvertTableReferences(convSubQueryPlan)&lt;br/&gt;
+    val temporalTableJoinPlan = optimizeConvertToTemporalJoin(fullNode)&lt;br/&gt;
+    val decorPlan = RelDecorrelator.decorrelateQuery(temporalTableJoinPlan)&lt;br/&gt;
     val planWithMaterializedTimeAttributes =&lt;br/&gt;
       RelTimeIndicatorConverter.convert(decorPlan, getRelBuilder.getRexBuilder)&lt;br/&gt;
     val normalizedPlan = optimizeNormalizeLogicalPlan(planWithMaterializedTimeAttributes)&lt;br/&gt;
diff --git a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/stream/sql/TemporalJoinITCase.scala b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/stream/sql/TemporalJoinITCase.scala&lt;br/&gt;
index df0f01be0d5..4b327a9fe59 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/stream/sql/TemporalJoinITCase.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/stream/sql/TemporalJoinITCase.scala&lt;br/&gt;
@@ -141,12 +141,12 @@ class TemporalJoinITCase extends StreamingWithStateTestBase {&lt;br/&gt;
       .toTable(tEnv, &apos;currency, &apos;rate, &apos;rowtime.rowtime)&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     tEnv.registerTable(&quot;Orders&quot;, orders)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;tEnv.registerTable(&quot;RatesHistory&quot;, ratesHistory)&lt;br/&gt;
     tEnv.registerFunction(&lt;br/&gt;
       &quot;Rates&quot;,&lt;br/&gt;
       ratesHistory.createTemporalTableFunction(&apos;rowtime, &apos;currency))&lt;br/&gt;
+    tEnv.registerTable(&quot;TemporalJoinResult&quot;, tEnv.sqlQuery(sqlQuery))&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val result = tEnv.sqlQuery(sqlQuery).toAppendStream&lt;span class=&quot;error&quot;&gt;&amp;#91;Row&amp;#93;&lt;/span&gt;&lt;br/&gt;
+    val result = tEnv.scan(&quot;TemporalJoinResult&quot;).toAppendStream&lt;span class=&quot;error&quot;&gt;&amp;#91;Row&amp;#93;&lt;/span&gt;&lt;br/&gt;
     result.addSink(new StreamITCase.StringSink&lt;span class=&quot;error&quot;&gt;&amp;#91;Row&amp;#93;&lt;/span&gt;)&lt;br/&gt;
     env.execute()&lt;/li&gt;
&lt;/ul&gt;






&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16671493" author="githubbot" created="Thu, 1 Nov 2018 11:40:25 +0000"  >&lt;p&gt;pnowojski opened a new pull request #6981: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10638&quot; title=&quot;Invalid table scan resolution for temporal join queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10638&quot;&gt;&lt;del&gt;FLINK-10638&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Invalid table scan resolution for temporal join queries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6981&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6981&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Previously there was a strict fixed order of applying LogicalCorrelateToTemporalTableJoinRule&lt;br/&gt;
   and TableScanRule rules. This was causing problems, since either of them could create a new&lt;br/&gt;
   RelNodes that have to be subject of the other rule (imagine deeply nested TemporalTableFunction&lt;br/&gt;
   that references registered tables/views and other TemporalTableFunctions).&lt;/p&gt;

&lt;p&gt;   Solution to this problem is to run both of those rules in one group/collection in HepPlaner.&lt;br/&gt;
   Instead of applying one rule to whole tree then the other rule, both rules are applied to&lt;br/&gt;
   a parent node, before going down/deeper.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change modify existing tests to provide test coverage against this bug.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;The serializers: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (yes / no ****/ don&apos;t know)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (yes / *&lt;b&gt;no&lt;/b&gt;* / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (yes / *&lt;b&gt;no&lt;/b&gt;*)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable / docs / *&lt;b&gt;JavaDocs&lt;/b&gt;* / not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16671611" author="githubbot" created="Thu, 1 Nov 2018 13:26:53 +0000"  >&lt;p&gt;twalthr commented on a change in pull request #6981: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10638&quot; title=&quot;Invalid table scan resolution for temporal join queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10638&quot;&gt;&lt;del&gt;FLINK-10638&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Invalid table scan resolution for temporal join queries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6981#discussion_r230038751&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6981#discussion_r230038751&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/FlinkRuleSets.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -39,18 +39,14 @@ object FlinkRuleSets {&lt;br/&gt;
     SubQueryRemoveRule.JOIN)&lt;/p&gt;

&lt;p&gt;   /**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Handles proper conversion of correlate queries with temporal table functions&lt;/li&gt;
	&lt;li&gt;* into temporal table joins. This can create new table scans in the plan.&lt;br/&gt;
+    * Expand plan by replacing references to tables into a proper plan sub trees. Those rules&lt;br/&gt;
+    * can create new plan nodes.&lt;br/&gt;
     */&lt;/li&gt;
	&lt;li&gt;val TEMPORAL_JOIN_RULES: RuleSet = RuleSets.ofList(&lt;/li&gt;
	&lt;li&gt;LogicalCorrelateToTemporalTableJoinRule.INSTANCE&lt;/li&gt;
	&lt;li&gt;)&lt;br/&gt;
+  val EXPAND_PLAN_RULES: RuleSet = RuleSets.ofList(&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   We should make the rules in expand and post expand phase configurable through `org.apache.flink.table.calcite.CalciteConfigBuilder` we also forgot this for the temporal join phase. We might have users that don&apos;t want to use temporal joins and modify the rule sets accordingly.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16671640" author="githubbot" created="Thu, 1 Nov 2018 13:55:50 +0000"  >&lt;p&gt;twalthr commented on a change in pull request #6981: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10638&quot; title=&quot;Invalid table scan resolution for temporal join queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10638&quot;&gt;&lt;del&gt;FLINK-10638&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Invalid table scan resolution for temporal join queries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6981#discussion_r230049212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6981#discussion_r230049212&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/stream/sql/TemporalJoinITCase.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -142,11 +140,16 @@ class TemporalJoinITCase extends StreamingWithStateTestBase {&lt;/p&gt;

&lt;p&gt;     tEnv.registerTable(&quot;Orders&quot;, orders)&lt;br/&gt;
     tEnv.registerTable(&quot;RatesHistory&quot;, ratesHistory)&lt;br/&gt;
+    tEnv.registerTable(&quot;FilteredRatesHistory&quot;, tEnv.scan(&quot;RatesHistory&quot;).filter(&apos;rate &amp;gt; 110L))&lt;br/&gt;
     tEnv.registerFunction(&lt;br/&gt;
       &quot;Rates&quot;,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ratesHistory.createTemporalTableFunction(&apos;rowtime, &apos;currency))&lt;br/&gt;
+      tEnv.scan(&quot;FilteredRatesHistory&quot;).createTemporalTableFunction(&apos;rowtime, &apos;currency))&lt;br/&gt;
+    tEnv.registerTable(&quot;TemporalJoinResult&quot;, tEnv.sqlQuery(sqlQuery))&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val result = tEnv.sqlQuery(sqlQuery).toAppendStream&lt;span class=&quot;error&quot;&gt;&amp;#91;Row&amp;#93;&lt;/span&gt;&lt;br/&gt;
+    // Scan from registered table to test for interplay between&lt;br/&gt;
+    // LogicalCorrelateToTemporalTableJoinRule and TableScanRule&lt;br/&gt;
+    val result = tEnv.scan(&quot;TemporalJoinResult&quot;).toAppendStream&lt;span class=&quot;error&quot;&gt;&amp;#91;Row&amp;#93;&lt;/span&gt;&lt;br/&gt;
+    System.out.println(tEnv.explain(tEnv.sqlQuery(sqlQuery)))&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Remove `println`.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16673297" author="githubbot" created="Fri, 2 Nov 2018 15:47:43 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6981: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10638&quot; title=&quot;Invalid table scan resolution for temporal join queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10638&quot;&gt;&lt;del&gt;FLINK-10638&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Invalid table scan resolution for temporal join queries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6981#discussion_r230420946&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6981#discussion_r230420946&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/stream/sql/TemporalJoinITCase.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -142,11 +140,16 @@ class TemporalJoinITCase extends StreamingWithStateTestBase {&lt;/p&gt;

&lt;p&gt;     tEnv.registerTable(&quot;Orders&quot;, orders)&lt;br/&gt;
     tEnv.registerTable(&quot;RatesHistory&quot;, ratesHistory)&lt;br/&gt;
+    tEnv.registerTable(&quot;FilteredRatesHistory&quot;, tEnv.scan(&quot;RatesHistory&quot;).filter(&apos;rate &amp;gt; 110L))&lt;br/&gt;
     tEnv.registerFunction(&lt;br/&gt;
       &quot;Rates&quot;,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ratesHistory.createTemporalTableFunction(&apos;rowtime, &apos;currency))&lt;br/&gt;
+      tEnv.scan(&quot;FilteredRatesHistory&quot;).createTemporalTableFunction(&apos;rowtime, &apos;currency))&lt;br/&gt;
+    tEnv.registerTable(&quot;TemporalJoinResult&quot;, tEnv.sqlQuery(sqlQuery))&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val result = tEnv.sqlQuery(sqlQuery).toAppendStream&lt;span class=&quot;error&quot;&gt;&amp;#91;Row&amp;#93;&lt;/span&gt;&lt;br/&gt;
+    // Scan from registered table to test for interplay between&lt;br/&gt;
+    // LogicalCorrelateToTemporalTableJoinRule and TableScanRule&lt;br/&gt;
+    val result = tEnv.scan(&quot;TemporalJoinResult&quot;).toAppendStream&lt;span class=&quot;error&quot;&gt;&amp;#91;Row&amp;#93;&lt;/span&gt;&lt;br/&gt;
+    System.out.println(tEnv.explain(tEnv.sqlQuery(sqlQuery)))&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   ops &#128563; &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16674979" author="githubbot" created="Mon, 5 Nov 2018 11:10:13 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6981: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10638&quot; title=&quot;Invalid table scan resolution for temporal join queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10638&quot;&gt;&lt;del&gt;FLINK-10638&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Invalid table scan resolution for temporal join queries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6981#discussion_r230712519&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6981#discussion_r230712519&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/FlinkRuleSets.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -39,18 +39,14 @@ object FlinkRuleSets {&lt;br/&gt;
     SubQueryRemoveRule.JOIN)&lt;/p&gt;

&lt;p&gt;   /**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Handles proper conversion of correlate queries with temporal table functions&lt;/li&gt;
	&lt;li&gt;* into temporal table joins. This can create new table scans in the plan.&lt;br/&gt;
+    * Expand plan by replacing references to tables into a proper plan sub trees. Those rules&lt;br/&gt;
+    * can create new plan nodes.&lt;br/&gt;
     */&lt;/li&gt;
	&lt;li&gt;val TEMPORAL_JOIN_RULES: RuleSet = RuleSets.ofList(&lt;/li&gt;
	&lt;li&gt;LogicalCorrelateToTemporalTableJoinRule.INSTANCE&lt;/li&gt;
	&lt;li&gt;)&lt;br/&gt;
+  val EXPAND_PLAN_RULES: RuleSet = RuleSets.ofList(&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   It seems to me like providing just a configuration for those rules seems like a halfmassure, since optimizer parameters are just as important as the rules itself (like matching order (`BOTTOM_UP` or `TOP_DOWN`) or vulcano vs hep sequential vs hep simultaneous.&lt;/p&gt;

&lt;p&gt;   Secondly I&apos;m not sure why someone would want to play/change temporal rules but not changing `TABLE_SUBQUERY_RULES` or `TABLE_REF_RULES`? And I see no reason why someone would like to turn off/disable temporal join rules in the first place - if you are not using temporal table function temporal rule will not fire.&lt;/p&gt;

&lt;p&gt;   I think that we should either:&lt;/p&gt;

&lt;p&gt;   1. restrict configuration into just the simplest adding vulcano based rules&lt;br/&gt;
   2. invest more time into a better configuration method of the rules, that covers all of the possible use cases: matching order, vulcano vs hep, grouping rules together, enforcing that some clean up rule is applied after a group of other rules, etc etc.&lt;br/&gt;
   3. tell the advance users that want to play with optimiser rules: just override `opitmize()` method and/or create your custom `TableEnvironment`.&lt;/p&gt;

&lt;p&gt;   I would lean toward the combination of 1. and 3., thus I would drop this issue of configuring `EXPAND_PLAN_RULES`&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16675064" author="githubbot" created="Mon, 5 Nov 2018 12:25:02 +0000"  >&lt;p&gt;twalthr commented on a change in pull request #6981: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10638&quot; title=&quot;Invalid table scan resolution for temporal join queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10638&quot;&gt;&lt;del&gt;FLINK-10638&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Invalid table scan resolution for temporal join queries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6981#discussion_r230731227&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6981#discussion_r230731227&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/FlinkRuleSets.scala&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -39,18 +39,14 @@ object FlinkRuleSets {&lt;br/&gt;
     SubQueryRemoveRule.JOIN)&lt;/p&gt;

&lt;p&gt;   /**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Handles proper conversion of correlate queries with temporal table functions&lt;/li&gt;
	&lt;li&gt;* into temporal table joins. This can create new table scans in the plan.&lt;br/&gt;
+    * Expand plan by replacing references to tables into a proper plan sub trees. Those rules&lt;br/&gt;
+    * can create new plan nodes.&lt;br/&gt;
     */&lt;/li&gt;
	&lt;li&gt;val TEMPORAL_JOIN_RULES: RuleSet = RuleSets.ofList(&lt;/li&gt;
	&lt;li&gt;LogicalCorrelateToTemporalTableJoinRule.INSTANCE&lt;/li&gt;
	&lt;li&gt;)&lt;br/&gt;
+  val EXPAND_PLAN_RULES: RuleSet = RuleSets.ofList(&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Yes you are right. It does not make much sense to configure the rules without selecting the optimization parameters as well. We can also leave the configuration features as they are right now.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16675073" author="githubbot" created="Mon, 5 Nov 2018 12:29:55 +0000"  >&lt;p&gt;pnowojski closed pull request #6981: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10638&quot; title=&quot;Invalid table scan resolution for temporal join queries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10638&quot;&gt;&lt;del&gt;FLINK-10638&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;table&amp;#93;&lt;/span&gt; Invalid table scan resolution for temporal join queries&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6981&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6981&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/BatchTableEnvironment.scala b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/BatchTableEnvironment.scala&lt;br/&gt;
index 6a7a921bffb..99e9d7e6d01 100644&lt;br/&gt;
&amp;#8212; a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/BatchTableEnvironment.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/BatchTableEnvironment.scala&lt;br/&gt;
@@ -449,9 +449,8 @@ abstract class BatchTableEnvironment(&lt;br/&gt;
     */&lt;br/&gt;
   private&lt;span class=&quot;error&quot;&gt;&amp;#91;flink&amp;#93;&lt;/span&gt; def optimize(relNode: RelNode): RelNode = {&lt;br/&gt;
     val convSubQueryPlan = optimizeConvertSubQueries(relNode)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val temporalTableJoinPlan = optimizeConvertToTemporalJoin(convSubQueryPlan)&lt;/li&gt;
	&lt;li&gt;val fullNode = optimizeConvertTableReferences(temporalTableJoinPlan)&lt;/li&gt;
	&lt;li&gt;val decorPlan = RelDecorrelator.decorrelateQuery(fullNode)&lt;br/&gt;
+    val expandedPlan = optimizeExpandPlan(convSubQueryPlan)&lt;br/&gt;
+    val decorPlan = RelDecorrelator.decorrelateQuery(expandedPlan)&lt;br/&gt;
     val normalizedPlan = optimizeNormalizeLogicalPlan(decorPlan)&lt;br/&gt;
     val logicalPlan = optimizeLogicalPlan(normalizedPlan)&lt;br/&gt;
     optimizePhysicalPlan(logicalPlan, FlinkConventions.DATASET)&lt;br/&gt;
diff --git a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/StreamTableEnvironment.scala b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/StreamTableEnvironment.scala&lt;br/&gt;
index 4973f34147f..8c6a1e0a04b 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/StreamTableEnvironment.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/StreamTableEnvironment.scala&lt;br/&gt;
@@ -804,13 +804,13 @@ abstract class StreamTableEnvironment(&lt;br/&gt;
     */&lt;br/&gt;
   private&lt;span class=&quot;error&quot;&gt;&amp;#91;flink&amp;#93;&lt;/span&gt; def optimize(relNode: RelNode, updatesAsRetraction: Boolean): RelNode = 
{
     val convSubQueryPlan = optimizeConvertSubQueries(relNode)
-    val temporalTableJoinPlan = optimizeConvertToTemporalJoin(convSubQueryPlan)
-    val fullNode = optimizeConvertTableReferences(temporalTableJoinPlan)
-    val decorPlan = RelDecorrelator.decorrelateQuery(fullNode)
+    val expandedPlan = optimizeExpandPlan(convSubQueryPlan)
+    val decorPlan = RelDecorrelator.decorrelateQuery(expandedPlan)
     val planWithMaterializedTimeAttributes =
       RelTimeIndicatorConverter.convert(decorPlan, getRelBuilder.getRexBuilder)
     val normalizedPlan = optimizeNormalizeLogicalPlan(planWithMaterializedTimeAttributes)
     val logicalPlan = optimizeLogicalPlan(normalizedPlan)
+
     val physicalPlan = optimizePhysicalPlan(logicalPlan, FlinkConventions.DATASTREAM)
     optimizeDecoratePlan(physicalPlan, updatesAsRetraction)
   }
&lt;p&gt;@@ -827,7 +827,7 @@ abstract class StreamTableEnvironment(&lt;br/&gt;
       } else &lt;/p&gt;
{
         relNode
       }&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;runHepPlanner(&lt;br/&gt;
+      runHepPlannerSequentially(&lt;br/&gt;
         HepMatchOrder.BOTTOM_UP,&lt;br/&gt;
         decoRuleSet,&lt;br/&gt;
         planToDecorate,&lt;br/&gt;
diff --git a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/TableEnvironment.scala b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/TableEnvironment.scala&lt;br/&gt;
index 58831d10271..26f9e50fedd 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/TableEnvironment.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/api/TableEnvironment.scala&lt;br/&gt;
@@ -25,7 +25,7 @@ import com.google.common.collect.ImmutableList&lt;br/&gt;
 import org.apache.calcite.config.Lex&lt;br/&gt;
 import org.apache.calcite.jdbc.CalciteSchema&lt;br/&gt;
 import org.apache.calcite.plan.RelOptPlanner.CannotPlanException&lt;br/&gt;
-import org.apache.calcite.plan.hep.
{HepMatchOrder, HepPlanner, HepProgramBuilder}
&lt;p&gt;+import org.apache.calcite.plan.hep.&lt;/p&gt;
{HepMatchOrder, HepPlanner, HepProgram, HepProgramBuilder}
&lt;p&gt; import org.apache.calcite.plan.&lt;/p&gt;
{Convention, RelOptPlanner, RelOptUtil, RelTraitSet}
&lt;p&gt; import org.apache.calcite.rel.RelNode&lt;br/&gt;
 import org.apache.calcite.schema.SchemaPlus&lt;br/&gt;
@@ -256,34 +256,31 @@ abstract class TableEnvironment(val config: TableConfig) {&lt;br/&gt;
   protected def getBuiltInPhysicalOptRuleSet: RuleSet&lt;/p&gt;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   protected def optimizeConvertSubQueries(relNode: RelNode): RelNode = &lt;/p&gt;
{
-    runHepPlanner(
+    runHepPlannerSequentially(
       HepMatchOrder.BOTTOM_UP,
       FlinkRuleSets.TABLE_SUBQUERY_RULES,
       relNode,
       relNode.getTraitSet)
   }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected def optimizeConvertToTemporalJoin(relNode: RelNode): RelNode = {&lt;/li&gt;
	&lt;li&gt;runHepPlanner(&lt;/li&gt;
	&lt;li&gt;HepMatchOrder.BOTTOM_UP,&lt;/li&gt;
	&lt;li&gt;FlinkRuleSets.TEMPORAL_JOIN_RULES,&lt;br/&gt;
+  protected def optimizeExpandPlan(relNode: RelNode): RelNode = 
{
+    val result = runHepPlannerSimultaneously(
+      HepMatchOrder.TOP_DOWN,
+      FlinkRuleSets.EXPAND_PLAN_RULES,
       relNode,
       relNode.getTraitSet)
-  }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;protected def optimizeConvertTableReferences(relNode: RelNode): RelNode = 
{
-    runHepPlanner(
-      HepMatchOrder.BOTTOM_UP,
-      FlinkRuleSets.TABLE_REF_RULES,
-      relNode,
-      relNode.getTraitSet)
+    runHepPlannerSequentially(
+      HepMatchOrder.TOP_DOWN,
+      FlinkRuleSets.POST_EXPAND_CLEAN_UP_RULES,
+      result,
+      result.getTraitSet)
   }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;-&lt;br/&gt;
   protected def optimizeNormalizeLogicalPlan(relNode: RelNode): RelNode = {&lt;br/&gt;
     val normRuleSet = getNormRuleSet&lt;br/&gt;
     if (normRuleSet.iterator().hasNext) &lt;/p&gt;
{
-      runHepPlanner(HepMatchOrder.BOTTOM_UP, normRuleSet, relNode, relNode.getTraitSet)
+      runHepPlannerSequentially(HepMatchOrder.BOTTOM_UP, normRuleSet, relNode, relNode.getTraitSet)
     }
&lt;p&gt; else &lt;/p&gt;
{
       relNode
     }
&lt;p&gt;@@ -310,13 +307,16 @@ abstract class TableEnvironment(val config: TableConfig) {&lt;br/&gt;
   }&lt;/p&gt;

&lt;p&gt;   /**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* run HEP planner&lt;br/&gt;
+    * run HEP planner with rules applied one by one. First apply one rule to all of the nodes&lt;br/&gt;
+    * and only then apply the next rule. If a rule creates a new node preceding rules will not&lt;br/&gt;
+    * be applied to the newly created node.&lt;br/&gt;
     */&lt;/li&gt;
	&lt;li&gt;protected def runHepPlanner(&lt;br/&gt;
+  protected def runHepPlannerSequentially(&lt;br/&gt;
     hepMatchOrder: HepMatchOrder,&lt;br/&gt;
     ruleSet: RuleSet,&lt;br/&gt;
     input: RelNode,&lt;br/&gt;
     targetTraits: RelTraitSet): RelNode = {&lt;br/&gt;
+&lt;br/&gt;
     val builder = new HepProgramBuilder&lt;br/&gt;
     builder.addMatchOrder(hepMatchOrder)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -324,8 +324,36 @@ abstract class TableEnvironment(val config: TableConfig) {&lt;br/&gt;
     while (it.hasNext) &lt;/p&gt;
{
       builder.addRuleInstance(it.next())
     }
&lt;p&gt;+    runHepPlanner(builder.build(), input, targetTraits)&lt;br/&gt;
+  }&lt;br/&gt;
+&lt;br/&gt;
+  /**&lt;br/&gt;
+    * run HEP planner with rules applied simultaneously. Apply all of the rules to the given&lt;br/&gt;
+    * node before going to the next one. If a rule creates a new node all of the rules will&lt;br/&gt;
+    * be applied to this new node.&lt;br/&gt;
+    */&lt;br/&gt;
+  protected def runHepPlannerSimultaneously(&lt;br/&gt;
+    hepMatchOrder: HepMatchOrder,&lt;br/&gt;
+    ruleSet: RuleSet,&lt;br/&gt;
+    input: RelNode,&lt;br/&gt;
+    targetTraits: RelTraitSet): RelNode = &lt;/p&gt;
{
+
+    val builder = new HepProgramBuilder
+    builder.addMatchOrder(hepMatchOrder)
+
+    builder.addRuleCollection(ruleSet.asScala.toList.asJava)
+    runHepPlanner(builder.build(), input, targetTraits)
+  }
&lt;p&gt;+&lt;br/&gt;
+  /**&lt;br/&gt;
+    * run HEP planner&lt;br/&gt;
+    */&lt;br/&gt;
+  protected def runHepPlanner(&lt;br/&gt;
+    hepProgram: HepProgram,&lt;br/&gt;
+    input: RelNode,&lt;br/&gt;
+    targetTraits: RelTraitSet): RelNode = {&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val planner = new HepPlanner(builder.build, frameworkConfig.getContext)&lt;br/&gt;
+    val planner = new HepPlanner(hepProgram, frameworkConfig.getContext)&lt;br/&gt;
     planner.setRoot(input)&lt;br/&gt;
     if (input.getTraitSet != targetTraits) {&lt;br/&gt;
       planner.changeTraits(input, targetTraits.simplify)&lt;br/&gt;
diff --git a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/FlinkRuleSets.scala b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/FlinkRuleSets.scala&lt;br/&gt;
index 6e2ccdeba5b..5e0ee32ad6c 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/FlinkRuleSets.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/main/scala/org/apache/flink/table/plan/rules/FlinkRuleSets.scala&lt;br/&gt;
@@ -39,18 +39,14 @@ object FlinkRuleSets {&lt;br/&gt;
     SubQueryRemoveRule.JOIN)&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   /**&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;* Handles proper conversion of correlate queries with temporal table functions&lt;/li&gt;
	&lt;li&gt;* into temporal table joins. This can create new table scans in the plan.&lt;br/&gt;
+    * Expand plan by replacing references to tables into a proper plan sub trees. Those rules&lt;br/&gt;
+    * can create new plan nodes.&lt;br/&gt;
     */&lt;/li&gt;
	&lt;li&gt;val TEMPORAL_JOIN_RULES: RuleSet = RuleSets.ofList(&lt;/li&gt;
	&lt;li&gt;LogicalCorrelateToTemporalTableJoinRule.INSTANCE&lt;/li&gt;
	&lt;li&gt;)&lt;br/&gt;
+  val EXPAND_PLAN_RULES: RuleSet = RuleSets.ofList(&lt;br/&gt;
+    LogicalCorrelateToTemporalTableJoinRule.INSTANCE,&lt;br/&gt;
+    TableScanRule.INSTANCE)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Convert table references before query decorrelation.&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;val TABLE_REF_RULES: RuleSet = RuleSets.ofList(&lt;/li&gt;
	&lt;li&gt;TableScanRule.INSTANCE,&lt;br/&gt;
+  val POST_EXPAND_CLEAN_UP_RULES: RuleSet = RuleSets.ofList(&lt;br/&gt;
     EnumerableToLogicalTableScan.INSTANCE)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   val LOGICAL_OPT_RULES: RuleSet = RuleSets.ofList(&lt;br/&gt;
diff --git a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/sql/TemporalTableJoinTest.scala b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/sql/TemporalTableJoinTest.scala&lt;br/&gt;
index 3c47f562aae..27c40bbbef2 100644&lt;br/&gt;
&amp;#8212; a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/sql/TemporalTableJoinTest.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/sql/TemporalTableJoinTest.scala&lt;br/&gt;
@@ -87,7 +87,9 @@ class TemporalTableJoinTest extends TableTestBase {&lt;/p&gt;

&lt;p&gt;     val ratesHistory = util.addTable&lt;span class=&quot;error&quot;&gt;&amp;#91;(Timestamp, String, String, Int, Int)&amp;#93;&lt;/span&gt;(&lt;br/&gt;
       &quot;RatesHistory&quot;, &apos;rowtime.rowtime, &apos;comment, &apos;currency, &apos;rate, &apos;secondary_key)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val rates = ratesHistory.createTemporalTableFunction(&apos;rowtime, &apos;currency)&lt;br/&gt;
+    val rates = ratesHistory&lt;br/&gt;
+      .filter(&apos;rate &amp;gt; 110L)&lt;br/&gt;
+      .createTemporalTableFunction(&apos;rowtime, &apos;currency)&lt;br/&gt;
     util.addFunction(&quot;Rates&quot;, rates)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     val sqlQuery =&lt;br/&gt;
diff --git a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/table/TemporalTableJoinTest.scala b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/table/TemporalTableJoinTest.scala&lt;br/&gt;
index f8d49238430..299c14417b6 100644&lt;br/&gt;
&amp;#8212; a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/table/TemporalTableJoinTest.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/api/stream/table/TemporalTableJoinTest.scala&lt;br/&gt;
@@ -87,7 +87,9 @@ class TemporalTableJoinTest extends TableTestBase {&lt;/p&gt;

&lt;p&gt;     val ratesHistory = util.addTable&lt;span class=&quot;error&quot;&gt;&amp;#91;(Timestamp, String, String, Int, Int)&amp;#93;&lt;/span&gt;(&lt;br/&gt;
       &quot;RatesHistory&quot;, &apos;rowtime.rowtime, &apos;comment, &apos;currency, &apos;rate, &apos;secondary_key)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val rates = ratesHistory.createTemporalTableFunction(&apos;rowtime, &apos;currency)&lt;br/&gt;
+    val rates = ratesHistory&lt;br/&gt;
+      .filter(&apos;rate &amp;gt; 110L)&lt;br/&gt;
+      .createTemporalTableFunction(&apos;rowtime, &apos;currency)&lt;br/&gt;
     util.addFunction(&quot;Rates&quot;, rates)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     val result = orders&lt;br/&gt;
@@ -226,7 +228,8 @@ object TemporalTableJoinTest {&lt;br/&gt;
           unaryNode(&lt;br/&gt;
             &quot;DataStreamCalc&quot;,&lt;br/&gt;
             streamTableNode(2),&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;term(&quot;select&quot;, &quot;rowtime, currency, rate, secondary_key&quot;)&lt;br/&gt;
+            term(&quot;select&quot;, &quot;rowtime, currency, rate, secondary_key&quot;),&lt;br/&gt;
+            term(&quot;where&quot;, &quot;&amp;gt;(rate, 110)&quot;)&lt;br/&gt;
           ),&lt;br/&gt;
           term(&quot;where&quot;,&lt;br/&gt;
             &quot;AND(&quot; +&lt;br/&gt;
diff --git a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/stream/sql/TemporalJoinITCase.scala b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/stream/sql/TemporalJoinITCase.scala&lt;br/&gt;
index df0f01be0d5..0fb175370fb 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/stream/sql/TemporalJoinITCase.scala&lt;br/&gt;
+++ b/flink-libraries/flink-table/src/test/scala/org/apache/flink/table/runtime/stream/sql/TemporalJoinITCase.scala&lt;br/&gt;
@@ -127,8 +127,6 @@ class TemporalJoinITCase extends StreamingWithStateTestBase {&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     var expectedOutput = new mutable.HashSet&lt;span class=&quot;error&quot;&gt;&amp;#91;String&amp;#93;&lt;/span&gt;()&lt;br/&gt;
     expectedOutput += (2 * 114).toString&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;expectedOutput += (1 * 102).toString&lt;/li&gt;
	&lt;li&gt;expectedOutput += (50 * 1).toString&lt;br/&gt;
     expectedOutput += (3 * 116).toString&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     val orders = env&lt;br/&gt;
@@ -142,11 +140,15 @@ class TemporalJoinITCase extends StreamingWithStateTestBase {&lt;/p&gt;

&lt;p&gt;     tEnv.registerTable(&quot;Orders&quot;, orders)&lt;br/&gt;
     tEnv.registerTable(&quot;RatesHistory&quot;, ratesHistory)&lt;br/&gt;
+    tEnv.registerTable(&quot;FilteredRatesHistory&quot;, tEnv.scan(&quot;RatesHistory&quot;).filter(&apos;rate &amp;gt; 110L))&lt;br/&gt;
     tEnv.registerFunction(&lt;br/&gt;
       &quot;Rates&quot;,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ratesHistory.createTemporalTableFunction(&apos;rowtime, &apos;currency))&lt;br/&gt;
+      tEnv.scan(&quot;FilteredRatesHistory&quot;).createTemporalTableFunction(&apos;rowtime, &apos;currency))&lt;br/&gt;
+    tEnv.registerTable(&quot;TemporalJoinResult&quot;, tEnv.sqlQuery(sqlQuery))&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;val result = tEnv.sqlQuery(sqlQuery).toAppendStream&lt;span class=&quot;error&quot;&gt;&amp;#91;Row&amp;#93;&lt;/span&gt;&lt;br/&gt;
+    // Scan from registered table to test for interplay between&lt;br/&gt;
+    // LogicalCorrelateToTemporalTableJoinRule and TableScanRule&lt;br/&gt;
+    val result = tEnv.scan(&quot;TemporalJoinResult&quot;).toAppendStream&lt;span class=&quot;error&quot;&gt;&amp;#91;Row&amp;#93;&lt;/span&gt;&lt;br/&gt;
     result.addSink(new StreamITCase.StringSink&lt;span class=&quot;error&quot;&gt;&amp;#91;Row&amp;#93;&lt;/span&gt;)&lt;br/&gt;
     env.execute()&lt;/li&gt;
&lt;/ul&gt;






&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16675075" author="pnowojski" created="Mon, 5 Nov 2018 12:31:32 +0000"  >&lt;p&gt;Merged to:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;release-1.7 as 97ac1ab0cc&lt;/li&gt;
	&lt;li&gt;master as c58d37e&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 2 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3zh1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>