<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:07:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-24543] 	Zookeeper connection issue causes inconsistent state in Flink</title>
                <link>https://issues.apache.org/jira/browse/FLINK-24543</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Env: Flink 1.13.2 with Zookeeper HA&lt;/p&gt;

&lt;p&gt;Here is what happened:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-bash&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;# checkpoint 1116 was triggered
&lt;/span&gt;2021-10-09 00:16:49,555 [Checkpoint Timer] INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Triggering checkpoint 1116 (type=CHECKPOINT) @ 1633738609538 &lt;span class=&quot;code-object&quot;&gt;for&lt;/span&gt; job a8a4fb85b681a897ba118db64333c9e5.

&lt;span class=&quot;code-comment&quot;&gt;# a few seconds later, zookeeper connection suspended, it turned out to be a disk issue at zookeeper side caused slow fsync and commit)
&lt;/span&gt;2021-10-09 00:16:58,563 [Curator-ConnectionStateManager-0] WARN  org.apache.flink.runtime.leaderretrieval.ZooKeeperLeaderRetrievalDriver [] - Connection to ZooKeeper suspended. Can no longer retrieve the leader from ZooKeeper.
2021-10-09 00:16:58,563 [Curator-ConnectionStateManager-0] WARN  org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionDriver [] - Connection to ZooKeeper suspended. The contender LeaderContender: DefaultDispatcherRunner no longer participates &lt;span class=&quot;code-object&quot;&gt;in&lt;/span&gt; the leader election.

&lt;span class=&quot;code-comment&quot;&gt;# job was switching to suspended
&lt;/span&gt;2021-10-09 00:16:58,564 [flink-akka.actor.default-dispatcher-61] INFO  org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - Disconnect job manager b79b79fe513fb5f47e7bf447b7d9448c@akka.tcp://flink@flink-...-jobmanager:50010/user/rpc/jobmanager_3 &lt;span class=&quot;code-object&quot;&gt;for&lt;/span&gt; job a8a4fb85b681a897ba118db64333c9e5 from the resource manager.

2021-10-09 00:16:58,565 [flink-akka.actor.default-dispatcher-92] INFO  org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - Registering job manager b79b79fe513fb5f47e7bf447b7d9448c@akka.tcp://flink@flink-...-jobmanager:50010/user/rpc/jobmanager_3 &lt;span class=&quot;code-object&quot;&gt;for&lt;/span&gt; job a8a4fb85b681a897ba118db64333c9e5.


2021-10-09 00:16:58,565 [flink-akka.actor.default-dispatcher-90] INFO  org.apache.flink.runtime.jobmaster.JobMaster                 [] - Stopping the JobMaster &lt;span class=&quot;code-object&quot;&gt;for&lt;/span&gt; job Flink ...(a8a4fb85b681a897ba118db64333c9e5).

2021-10-09 00:16:58,567 [flink-akka.actor.default-dispatcher-90] INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - Job Flink ... (a8a4fb85b681a897ba118db64333c9e5) switched from state RUNNING to SUSPENDED.


2021-10-09 00:16:58,570 [flink-akka.actor.default-dispatcher-86] INFO  org.apache.flink.runtime.leaderretrieval.ZooKeeperLeaderRetrievalDriver [] - Closing ZookeeperLeaderRetrievalDriver{retrievalPath=&lt;span class=&quot;code-quote-red&quot;&gt;&apos;/leader/a8a4fb85b681a897ba118db64333c9e5/job_manager_lock&apos;&lt;/span&gt;}.


2021-10-09 00:16:58,667 [flink-akka.actor.default-dispatcher-92] INFO  org.apache.flink.runtime.dispatcher.StandaloneDispatcher     [] - Job a8a4fb85b681a897ba118db64333c9e5 reached terminal state SUSPENDED.

&lt;span class=&quot;code-comment&quot;&gt;# zookeeper connector restored
&lt;/span&gt;2021-10-09 00:17:08,225 [Curator-ConnectionStateManager-0] INFO  org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionDriver [] - Connection to ZooKeeper was reconnected. Leader election can be restarted.

&lt;span class=&quot;code-comment&quot;&gt;# received checkpoint acknowledgement, trying to finalize it, &lt;span class=&quot;code-object&quot;&gt;then&lt;/span&gt; failed to add to zookeeper due to KeeperException&lt;span class=&quot;code-object&quot;&gt;$NodeExistsException&lt;/span&gt;
&lt;/span&gt;2021-10-09 00:17:14,382 [flink-akka.actor.default-dispatcher-90] INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - Source: ... (1/5) (09d25852e3e206d6b7fe0d6bc965870f) switched from RUNNING to CANCELING.
2021-10-09 00:17:14,382 [jobmanager-future-thread-1] WARN  org.apache.flink.runtime.jobmaster.JobMaster                 [] - Error &lt;span class=&quot;code-object&quot;&gt;while&lt;/span&gt; processing AcknowledgeCheckpoint message
org.apache.flink.runtime.checkpoint.CheckpointException: Could not complete the pending checkpoint 1116. Failure reason: Failure to finalize checkpoint.
	at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.completePendingCheckpoint(CheckpointCoordinator.java:1227) 
	at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.receiveAcknowledgeMessage(CheckpointCoordinator.java:1072) 
	at org.apache.flink.runtime.scheduler.ExecutionGraphHandler.lambda&lt;span class=&quot;code-object&quot;&gt;$acknowledgeCheckpoint&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;$1&lt;/span&gt;(ExecutionGraphHandler.java:89) 
	at org.apache.flink.runtime.scheduler.ExecutionGraphHandler.lambda&lt;span class=&quot;code-object&quot;&gt;$processCheckpointCoordinatorMessage&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;$3&lt;/span&gt;(ExecutionGraphHandler.java:119) 
	at java.util.concurrent.Executors&lt;span class=&quot;code-object&quot;&gt;$RunnableAdapter&lt;/span&gt;.call(Executors.java:515) [?:?]
	at java.util.concurrent.FutureTask.run(FutureTask.java:264) [?:?]
	at java.util.concurrent.ScheduledThreadPoolExecutor&lt;span class=&quot;code-object&quot;&gt;$ScheduledFutureTask&lt;/span&gt;.run(ScheduledThreadPoolExecutor.java:304) [?:?]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]
	at java.util.concurrent.ThreadPoolExecutor&lt;span class=&quot;code-object&quot;&gt;$Worker&lt;/span&gt;.run(ThreadPoolExecutor.java:628) [?:?]
	at java.lang.Thread.run(Thread.java:834) [?:?]
Caused by: org.apache.flink.runtime.persistence.StateHandleStore&lt;span class=&quot;code-object&quot;&gt;$AlreadyExistException&lt;/span&gt;: ZooKeeper node /0000000000000001116 already exists.
	at org.apache.flink.runtime.zookeeper.ZooKeeperStateHandleStore.lambda&lt;span class=&quot;code-object&quot;&gt;$addAndLock&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;$0&lt;/span&gt;(ZooKeeperStateHandleStore.java:179) 
	at java.util.Optional.map(Optional.java:265) ~[?:?]
	at org.apache.flink.runtime.zookeeper.ZooKeeperStateHandleStore.addAndLock(ZooKeeperStateHandleStore.java:177) 
	at org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStore.addCheckpoint(DefaultCompletedCheckpointStore.java:182) 
	at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.completePendingCheckpoint(CheckpointCoordinator.java:1209) 
	... 9 more
Caused by: org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.KeeperException&lt;span class=&quot;code-object&quot;&gt;$NodeExistsException&lt;/span&gt;: KeeperErrorCode = NodeExists
	at org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.KeeperException.create(KeeperException.java:122) ~[flink-shaded-zookeeper-3.4.14.jar:3.4.14-13.0-stream1]
	at org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ZooKeeper.multiInternal(ZooKeeper.java:1015) ~[flink-shaded-zookeeper-3.4.14.jar:3.4.14-13.0-stream1]
	at org.apache.flink.shaded.zookeeper3.org.apache.zookeeper.ZooKeeper.multi(ZooKeeper.java:919) ~[flink-shaded-zookeeper-3.4.14.jar:3.4.14-13.0-stream1]
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.CuratorTransactionImpl.doOperation(CuratorTransactionImpl.java:197) ~[flink-shaded-zookeeper-3.4.14.jar:3.4.14-13.0-stream1]
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.CuratorTransactionImpl.access&lt;span class=&quot;code-object&quot;&gt;$000&lt;/span&gt;(CuratorTransactionImpl.java:37) ~[flink-shaded-zookeeper-3.4.14.jar:3.4.14-13.0-stream1]
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.CuratorTransactionImpl&lt;span class=&quot;code-object&quot;&gt;$2&lt;/span&gt;.call(CuratorTransactionImpl.java:130) ~[flink-shaded-zookeeper-3.4.14.jar:3.4.14-13.0-stream1]
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.CuratorTransactionImpl&lt;span class=&quot;code-object&quot;&gt;$2&lt;/span&gt;.call(CuratorTransactionImpl.java:126) ~[flink-shaded-zookeeper-3.4.14.jar:3.4.14-13.0-stream1]
	at org.apache.flink.shaded.curator4.org.apache.curator.connection.StandardConnectionHandlingPolicy.callWithRetry(StandardConnectionHandlingPolicy.java:64) ~[flink-shaded-zookeeper-3.4.14.jar:3.4.14-13.0-stream1]
	at org.apache.flink.shaded.curator4.org.apache.curator.RetryLoop.callWithRetry(RetryLoop.java:100) ~[flink-shaded-zookeeper-3.4.14.jar:3.4.14-13.0-stream1]
	at org.apache.flink.shaded.curator4.org.apache.curator.framework.imps.CuratorTransactionImpl.commit(CuratorTransactionImpl.java:123) ~[flink-shaded-zookeeper-3.4.14.jar:3.4.14-13.0-stream1]
	at org.apache.flink.runtime.zookeeper.ZooKeeperStateHandleStore.writeStoreHandleTransactionally(ZooKeeperStateHandleStore.java:204) 
	at org.apache.flink.runtime.zookeeper.ZooKeeperStateHandleStore.addAndLock(ZooKeeperStateHandleStore.java:165) 
	at org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStore.addCheckpoint(DefaultCompletedCheckpointStore.java:182) 
	at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.completePendingCheckpoint(CheckpointCoordinator.java:1209) 
... 9 more

&lt;span class=&quot;code-comment&quot;&gt;# checkpoint coordinator was stopping
&lt;/span&gt;2021-10-09 00:17:14,385 [flink-akka.actor.default-dispatcher-90] INFO  org.apache.flink.runtime.checkpoint.CheckpointCoordinator    [] - Stopping checkpoint coordinator &lt;span class=&quot;code-object&quot;&gt;for&lt;/span&gt; job a8a4fb85b681a897ba118db64333c9e5.
2021-10-09 00:17:14,401 [flink-akka.actor.default-dispatcher-90] INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - Job a8a4fb85b681a897ba118db64333c9e5 has been suspended.

&lt;span class=&quot;code-comment&quot;&gt;# clean up
&lt;/span&gt;2021-10-09 00:17:14,403 [AkkaRpcService-Supervisor-Termination-Future-Executor-thread-1] INFO  org.apache.flink.runtime.leaderelection.ZooKeeperLeaderElectionDriver [] - Closing ZooKeeperLeaderElectionDriver{leaderPath=&lt;span class=&quot;code-quote-red&quot;&gt;&apos;/leader/a8a4fb85b681a897ba118db64333c9e5/job_manager_lock&apos;&lt;/span&gt;}
2021-10-09 00:17:14,404 [cluster-io-thread-2] INFO  org.apache.flink.runtime.jobmanager.DefaultJobGraphStore     [] - Released job graph a8a4fb85b681a897ba118db64333c9e5 from ZooKeeperStateHandleStore{namespace=&lt;span class=&quot;code-quote-red&quot;&gt;&apos;flink/flink-.../jobgraphs&apos;&lt;/span&gt;}.

&lt;span class=&quot;code-comment&quot;&gt;# however, during recovery, checkpoint 1116 was found &lt;span class=&quot;code-object&quot;&gt;in&lt;/span&gt; zookeeper, but the metadata file /mnt/flink/.flink/ha/flink-.../completedCheckpoint42683d1121c7 was cleaned up due to the KeeperException&lt;span class=&quot;code-object&quot;&gt;$NodeExistsException&lt;/span&gt; happened before
&lt;/span&gt;2021-10-09 00:18:18,678 [jobmanager-future-thread-1] INFO  org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStore [] - Recovering checkpoints from ZooKeeperStateHandleStore{namespace=&lt;span class=&quot;code-quote-red&quot;&gt;&apos;flink/flink-.../checkpoints/a8a4fb85b681a897ba118db64333c9e5&apos;&lt;/span&gt;}.
2021-10-09 00:18:18,686 [jobmanager-future-thread-1] INFO  org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStore [] - Found 4 checkpoints &lt;span class=&quot;code-object&quot;&gt;in&lt;/span&gt; ZooKeeperStateHandleStore{namespace=&lt;span class=&quot;code-quote-red&quot;&gt;&apos;flink/flink-.../checkpoints/a8a4fb85b681a897ba118db64333c9e5&apos;&lt;/span&gt;}.
2021-10-09 00:18:18,686 [jobmanager-future-thread-1] INFO  org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStore [] - Trying to fetch 4 checkpoints from storage.
2021-10-09 00:18:18,686 [jobmanager-future-thread-1] INFO  org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStore [] - Trying to retrieve checkpoint 1113.
2021-10-09 00:18:18,689 [jobmanager-future-thread-1] INFO  org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStore [] - Trying to retrieve checkpoint 1114.
2021-10-09 00:18:18,691 [jobmanager-future-thread-1] INFO  org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStore [] - Trying to retrieve checkpoint 1115.
2021-10-09 00:18:18,693 [jobmanager-future-thread-1] INFO  org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStore [] - Trying to retrieve checkpoint 1116.

2021-10-09 00:18:18,700 [flink-akka.actor.default-dispatcher-18] ERROR org.apache.flink.runtime.entrypoint.ClusterEntrypoint        [] - Fatal error occurred &lt;span class=&quot;code-object&quot;&gt;in&lt;/span&gt; the cluster entrypoint.
org.apache.flink.util.FlinkException: JobMaster &lt;span class=&quot;code-object&quot;&gt;for&lt;/span&gt; job a8a4fb85b681a897ba118db64333c9e5 failed.
	at org.apache.flink.runtime.dispatcher.Dispatcher.jobMasterFailed(Dispatcher.java:873) 
	at org.apache.flink.runtime.dispatcher.Dispatcher.jobManagerRunnerFailed(Dispatcher.java:459) 
	at org.apache.flink.runtime.dispatcher.Dispatcher.handleJobManagerRunnerResult(Dispatcher.java:436) 
	at org.apache.flink.runtime.dispatcher.Dispatcher.lambda&lt;span class=&quot;code-object&quot;&gt;$runJob&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;$3&lt;/span&gt;(Dispatcher.java:415) 
	at java.util.concurrent.CompletableFuture.uniHandle(CompletableFuture.java:930) ~[?:?]
	at java.util.concurrent.CompletableFuture&lt;span class=&quot;code-object&quot;&gt;$UniHandle&lt;/span&gt;.tryFire(CompletableFuture.java:907) ~[?:?]
	at java.util.concurrent.CompletableFuture&lt;span class=&quot;code-object&quot;&gt;$Completion&lt;/span&gt;.run(CompletableFuture.java:478) ~[?:?]
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRunAsync(AkkaRpcActor.java:440) 
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleRpcMessage(AkkaRpcActor.java:208) 
	at org.apache.flink.runtime.rpc.akka.FencedAkkaRpcActor.handleRpcMessage(FencedAkkaRpcActor.java:77) 
	at org.apache.flink.runtime.rpc.akka.AkkaRpcActor.handleMessage(AkkaRpcActor.java:158) 
	at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:26) 
	at akka.japi.pf.UnitCaseStatement.apply(CaseStatements.scala:21) 
	at scala.PartialFunction.applyOrElse(PartialFunction.scala:123) 
	at scala.PartialFunction.applyOrElse$(PartialFunction.scala:122) 
	at akka.japi.pf.UnitCaseStatement.applyOrElse(CaseStatements.scala:21) 
	at scala.PartialFunction&lt;span class=&quot;code-object&quot;&gt;$OrElse&lt;/span&gt;.applyOrElse(PartialFunction.scala:171) 
	at scala.PartialFunction&lt;span class=&quot;code-object&quot;&gt;$OrElse&lt;/span&gt;.applyOrElse(PartialFunction.scala:172) 
	at scala.PartialFunction&lt;span class=&quot;code-object&quot;&gt;$OrElse&lt;/span&gt;.applyOrElse(PartialFunction.scala:172) 
	at akka.actor.Actor.aroundReceive(Actor.scala:517) 
	at akka.actor.Actor.aroundReceive$(Actor.scala:515) 
	at akka.actor.AbstractActor.aroundReceive(AbstractActor.scala:225) 
	at akka.actor.ActorCell.receiveMessage(ActorCell.scala:592) 
	at akka.actor.ActorCell.invoke(ActorCell.scala:561) 
	at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:258) 
	at akka.dispatch.Mailbox.run(Mailbox.scala:225) 
	at akka.dispatch.Mailbox.exec(Mailbox.scala:235) 
	at akka.dispatch.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260) 
	at akka.dispatch.forkjoin.ForkJoinPool&lt;span class=&quot;code-object&quot;&gt;$WorkQueue&lt;/span&gt;.runTask(ForkJoinPool.java:1339) 
	at akka.dispatch.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979) 
	at akka.dispatch.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107) 
Caused by: org.apache.flink.runtime.client.JobInitializationException: Could not start the JobMaster.
	at org.apache.flink.runtime.jobmaster.DefaultJobMasterServiceProcess.lambda&lt;span class=&quot;code-object&quot;&gt;$new&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;$0&lt;/span&gt;(DefaultJobMasterServiceProcess.java:97) 
	at java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:859) ~[?:?]
	at java.util.concurrent.CompletableFuture&lt;span class=&quot;code-object&quot;&gt;$UniWhenComplete&lt;/span&gt;.tryFire(CompletableFuture.java:837) ~[?:?]
	at java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:506) ~[?:?]
	at java.util.concurrent.CompletableFuture&lt;span class=&quot;code-object&quot;&gt;$AsyncSupply&lt;/span&gt;.run(CompletableFuture.java:1705) ~[?:?]
	at java.util.concurrent.Executors&lt;span class=&quot;code-object&quot;&gt;$RunnableAdapter&lt;/span&gt;.call(Executors.java:515) ~[?:?]
	at java.util.concurrent.FutureTask.run(FutureTask.java:264) ~[?:?]
	at java.util.concurrent.ScheduledThreadPoolExecutor&lt;span class=&quot;code-object&quot;&gt;$ScheduledFutureTask&lt;/span&gt;.run(ScheduledThreadPoolExecutor.java:304) ~[?:?]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]
	at java.util.concurrent.ThreadPoolExecutor&lt;span class=&quot;code-object&quot;&gt;$Worker&lt;/span&gt;.run(ThreadPoolExecutor.java:628) ~[?:?]
	at java.lang.Thread.run(Thread.java:834) ~[?:?]
Caused by: java.util.concurrent.CompletionException: java.lang.RuntimeException: org.apache.flink.util.FlinkException: Could not retrieve checkpoint 1116 from state handle under /0000000000000001116. This indicates that the retrieved state handle is broken. Try cleaning the state handle store.
	at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:314) ~[?:?]
	at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:319) ~[?:?]
	at java.util.concurrent.CompletableFuture&lt;span class=&quot;code-object&quot;&gt;$AsyncSupply&lt;/span&gt;.run(CompletableFuture.java:1702) ~[?:?]
	at java.util.concurrent.Executors&lt;span class=&quot;code-object&quot;&gt;$RunnableAdapter&lt;/span&gt;.call(Executors.java:515) ~[?:?]
	at java.util.concurrent.FutureTask.run(FutureTask.java:264) ~[?:?]
	at java.util.concurrent.ScheduledThreadPoolExecutor&lt;span class=&quot;code-object&quot;&gt;$ScheduledFutureTask&lt;/span&gt;.run(ScheduledThreadPoolExecutor.java:304) ~[?:?]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]
	at java.util.concurrent.ThreadPoolExecutor&lt;span class=&quot;code-object&quot;&gt;$Worker&lt;/span&gt;.run(ThreadPoolExecutor.java:628) ~[?:?]
	at java.lang.Thread.run(Thread.java:834) ~[?:?]
Caused by: java.lang.RuntimeException: org.apache.flink.util.FlinkException: Could not retrieve checkpoint 1116 from state handle under /0000000000000001116. This indicates that the retrieved state handle is broken. Try cleaning the state handle store.
	at org.apache.flink.util.ExceptionUtils.rethrow(ExceptionUtils.java:316) 
	at org.apache.flink.util.&lt;span class=&quot;code-object&quot;&gt;function&lt;/span&gt;.FunctionUtils.lambda&lt;span class=&quot;code-object&quot;&gt;$uncheckedSupplier&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;$4&lt;/span&gt;(FunctionUtils.java:114) 
	at java.util.concurrent.CompletableFuture&lt;span class=&quot;code-object&quot;&gt;$AsyncSupply&lt;/span&gt;.run(CompletableFuture.java:1700) ~[?:?]
	at java.util.concurrent.Executors&lt;span class=&quot;code-object&quot;&gt;$RunnableAdapter&lt;/span&gt;.call(Executors.java:515) ~[?:?]
	at java.util.concurrent.FutureTask.run(FutureTask.java:264) ~[?:?]
	at java.util.concurrent.ScheduledThreadPoolExecutor&lt;span class=&quot;code-object&quot;&gt;$ScheduledFutureTask&lt;/span&gt;.run(ScheduledThreadPoolExecutor.java:304) ~[?:?]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]
	at java.util.concurrent.ThreadPoolExecutor&lt;span class=&quot;code-object&quot;&gt;$Worker&lt;/span&gt;.run(ThreadPoolExecutor.java:628) ~[?:?]
	at java.lang.Thread.run(Thread.java:834) ~[?:?]
Caused by: org.apache.flink.util.FlinkException: Could not retrieve checkpoint 1116 from state handle under /0000000000000001116. This indicates that the retrieved state handle is broken. Try cleaning the state handle store.
	at org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStore.retrieveCompletedCheckpoint(DefaultCompletedCheckpointStore.java:309) 
	at org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStore.recover(DefaultCompletedCheckpointStore.java:151) 
	at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.restoreLatestCheckpointedStateInternal(CheckpointCoordinator.java:1513) 
	at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.restoreInitialCheckpointIfPresent(CheckpointCoordinator.java:1476) 
	at org.apache.flink.runtime.scheduler.DefaultExecutionGraphFactory.createAndRestoreExecutionGraph(DefaultExecutionGraphFactory.java:134) 
	at org.apache.flink.runtime.scheduler.SchedulerBase.createAndRestoreExecutionGraph(SchedulerBase.java:342) 
	at org.apache.flink.runtime.scheduler.SchedulerBase.&amp;lt;init&amp;gt;(SchedulerBase.java:190) 
	at org.apache.flink.runtime.scheduler.DefaultScheduler.&amp;lt;init&amp;gt;(DefaultScheduler.java:122) 
	at org.apache.flink.runtime.scheduler.DefaultSchedulerFactory.createInstance(DefaultSchedulerFactory.java:132) 
	at org.apache.flink.runtime.jobmaster.DefaultSlotPoolServiceSchedulerFactory.createScheduler(DefaultSlotPoolServiceSchedulerFactory.java:110) 
	at org.apache.flink.runtime.jobmaster.JobMaster.createScheduler(JobMaster.java:340) 
	at org.apache.flink.runtime.jobmaster.JobMaster.&amp;lt;init&amp;gt;(JobMaster.java:317) 
	at org.apache.flink.runtime.jobmaster.factories.DefaultJobMasterServiceFactory.internalCreateJobMasterService(DefaultJobMasterServiceFactory.java:107) 
	at org.apache.flink.runtime.jobmaster.factories.DefaultJobMasterServiceFactory.lambda&lt;span class=&quot;code-object&quot;&gt;$createJobMasterService&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;$0&lt;/span&gt;(DefaultJobMasterServiceFactory.java:95) 
	at org.apache.flink.util.&lt;span class=&quot;code-object&quot;&gt;function&lt;/span&gt;.FunctionUtils.lambda&lt;span class=&quot;code-object&quot;&gt;$uncheckedSupplier&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;$4&lt;/span&gt;(FunctionUtils.java:112) 
	at java.util.concurrent.CompletableFuture&lt;span class=&quot;code-object&quot;&gt;$AsyncSupply&lt;/span&gt;.run(CompletableFuture.java:1700) ~[?:?]
	at java.util.concurrent.Executors&lt;span class=&quot;code-object&quot;&gt;$RunnableAdapter&lt;/span&gt;.call(Executors.java:515) ~[?:?]
	at java.util.concurrent.FutureTask.run(FutureTask.java:264) ~[?:?]
	at java.util.concurrent.ScheduledThreadPoolExecutor&lt;span class=&quot;code-object&quot;&gt;$ScheduledFutureTask&lt;/span&gt;.run(ScheduledThreadPoolExecutor.java:304) ~[?:?]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]
	at java.util.concurrent.ThreadPoolExecutor&lt;span class=&quot;code-object&quot;&gt;$Worker&lt;/span&gt;.run(ThreadPoolExecutor.java:628) ~[?:?]
	at java.lang.Thread.run(Thread.java:834) ~[?:?]
Caused by: java.io.FileNotFoundException: /mnt/flink/.flink/ha/flink-.../completedCheckpoint42683d1121c7 (No such file or directory)
	at java.io.FileInputStream.open0(Native Method) ~[?:?]
	at java.io.FileInputStream.open(FileInputStream.java:219) ~[?:?]
	at java.io.FileInputStream.&amp;lt;init&amp;gt;(FileInputStream.java:157) ~[?:?]
	at org.apache.flink.core.fs.&lt;span class=&quot;code-object&quot;&gt;local&lt;/span&gt;.LocalDataInputStream.&amp;lt;init&amp;gt;(LocalDataInputStream.java:50) 
	at org.apache.flink.core.fs.&lt;span class=&quot;code-object&quot;&gt;local&lt;/span&gt;.LocalFileSystem.open(LocalFileSystem.java:134) 
	at org.apache.flink.runtime.state.filesystem.FileStateHandle.openInputStream(FileStateHandle.java:68) 
	at org.apache.flink.runtime.state.RetrievableStreamStateHandle.openInputStream(RetrievableStreamStateHandle.java:66) 
	at org.apache.flink.runtime.state.RetrievableStreamStateHandle.retrieveState(RetrievableStreamStateHandle.java:58) 
	at org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStore.retrieveCompletedCheckpoint(DefaultCompletedCheckpointStore.java:298) 
	at org.apache.flink.runtime.checkpoint.DefaultCompletedCheckpointStore.recover(DefaultCompletedCheckpointStore.java:151) 
	at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.restoreLatestCheckpointedStateInternal(CheckpointCoordinator.java:1513) 
	at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.restoreInitialCheckpointIfPresent(CheckpointCoordinator.java:1476) 
	at org.apache.flink.runtime.scheduler.DefaultExecutionGraphFactory.createAndRestoreExecutionGraph(DefaultExecutionGraphFactory.java:134) 
	at org.apache.flink.runtime.scheduler.SchedulerBase.createAndRestoreExecutionGraph(SchedulerBase.java:342) 
	at org.apache.flink.runtime.scheduler.SchedulerBase.&amp;lt;init&amp;gt;(SchedulerBase.java:190) 
	at org.apache.flink.runtime.scheduler.DefaultScheduler.&amp;lt;init&amp;gt;(DefaultScheduler.java:122) 
	at org.apache.flink.runtime.scheduler.DefaultSchedulerFactory.createInstance(DefaultSchedulerFactory.java:132) 
	at org.apache.flink.runtime.jobmaster.DefaultSlotPoolServiceSchedulerFactory.createScheduler(DefaultSlotPoolServiceSchedulerFactory.java:110) 
	at org.apache.flink.runtime.jobmaster.JobMaster.createScheduler(JobMaster.java:340) 
	at org.apache.flink.runtime.jobmaster.JobMaster.&amp;lt;init&amp;gt;(JobMaster.java:317) 
	at org.apache.flink.runtime.jobmaster.factories.DefaultJobMasterServiceFactory.internalCreateJobMasterService(DefaultJobMasterServiceFactory.java:107) 
	at org.apache.flink.runtime.jobmaster.factories.DefaultJobMasterServiceFactory.lambda&lt;span class=&quot;code-object&quot;&gt;$createJobMasterService&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;$0&lt;/span&gt;(DefaultJobMasterServiceFactory.java:95) 
	at org.apache.flink.util.&lt;span class=&quot;code-object&quot;&gt;function&lt;/span&gt;.FunctionUtils.lambda&lt;span class=&quot;code-object&quot;&gt;$uncheckedSupplier&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;$4&lt;/span&gt;(FunctionUtils.java:112) 
	at java.util.concurrent.CompletableFuture&lt;span class=&quot;code-object&quot;&gt;$AsyncSupply&lt;/span&gt;.run(CompletableFuture.java:1700) ~[?:?]
	at java.util.concurrent.Executors&lt;span class=&quot;code-object&quot;&gt;$RunnableAdapter&lt;/span&gt;.call(Executors.java:515) ~[?:?]
	at java.util.concurrent.FutureTask.run(FutureTask.java:264) ~[?:?]
	at java.util.concurrent.ScheduledThreadPoolExecutor&lt;span class=&quot;code-object&quot;&gt;$ScheduledFutureTask&lt;/span&gt;.run(ScheduledThreadPoolExecutor.java:304) ~[?:?]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]
	at java.util.concurrent.ThreadPoolExecutor&lt;span class=&quot;code-object&quot;&gt;$Worker&lt;/span&gt;.run(ThreadPoolExecutor.java:628) ~[?:?]
	at java.lang.Thread.run(Thread.java:834) ~[?:?]

&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13406512">FLINK-24543</key>
            <summary>	Zookeeper connection issue causes inconsistent state in Flink</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dmvk">David Mor&#225;vek</assignee>
                                    <reporter username="qinjunjerry">Jun Qin</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 14 Oct 2021 08:26:22 +0000</created>
                <updated>Tue, 5 Jul 2022 07:06:16 +0000</updated>
                            <resolved>Fri, 26 Nov 2021 17:06:51 +0000</resolved>
                                    <version>1.14.0</version>
                    <version>1.13.3</version>
                                    <fixVersion>1.13.6</fixVersion>
                    <fixVersion>1.14.3</fixVersion>
                    <fixVersion>1.15.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="17428710" author="qinjunjerry" created="Thu, 14 Oct 2021 09:03:47 +0000"  >&lt;p&gt;One thought after discussed with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=trohrmann&quot; class=&quot;user-hover&quot; rel=&quot;trohrmann&quot;&gt;trohrmann&lt;/a&gt;: the reason for the&#160;KeeperException$NodeExistsException may be due to the zookeeper client&apos;s retries as it might not get the response from the zookeeper server in time. This should be handled correctly by curator transactions but it seems not the case.&#160;&lt;/p&gt;</comment>
                            <comment id="17428726" author="victorunique" created="Thu, 14 Oct 2021 09:35:00 +0000"  >&lt;p&gt;After the&#160;KeeperException$NodeExistsException was thrown, the&#160;&lt;b&gt;ZooKeeperStateHandleStore.indicatesPossiblyInconsistentState(e)&lt;/b&gt; returned &lt;b&gt;false&lt;/b&gt; so the state cleaning logic cleaned both the metadata file and the corresponding checkpoints data files which then led to the FileNotFoundException:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.io.FileNotFoundException: /mnt/flink/.flink/ha/flink-.../completedCheckpoint42683d1121c7 (No such file or directory)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The reason was that&#160;&lt;b&gt;NodeExistsException&lt;/b&gt; was included in the&#160;PRE_COMMIT_EXCEPTIONS. But shouldn&apos;t we consider this NodeExistsException as an inconsistent state and remove it from the PRE_COMMIT_EXCEPTIONS? It&apos;s different from other ZK commit exceptions (e.g. AuthFailedException, BadVersionException, etc.) as others mean that the ZK write is failed but this one means the ZK node is already there, though we don&apos;t know if it&apos;s the correct one or not. So I think we should mark it as an inconsistent state and don&apos;t remove the corresponding metadata and checkpoint data files.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17428736" author="qinjunjerry" created="Thu, 14 Oct 2021 09:51:38 +0000"  >&lt;p&gt;It looks like the latest Curator 5.2.0 (released Jul 26, 2021), with contribution from Indeed, fixed exactly this problem:&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CURATOR-584&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CURATOR-584&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;See also their blog post: &lt;a href=&quot;https://medium.com/@jmslocum16/idempotent-fault-tolerant-writes-in-curator-5-2-0-eadf7c12c814&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://medium.com/@jmslocum16/idempotent-fault-tolerant-writes-in-curator-5-2-0-eadf7c12c814&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17430389" author="till.rohrmann" created="Tue, 19 Oct 2021 08:14:16 +0000"  >&lt;p&gt;Good findings &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=qinjunjerry&quot; class=&quot;user-hover&quot; rel=&quot;qinjunjerry&quot;&gt;qinjunjerry&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/browse/CURATOR-584&quot; title=&quot;Curator Client Fault Tolerance Extensions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CURATOR-584&quot;&gt;&lt;del&gt;CURATOR-584&lt;/del&gt;&lt;/a&gt; should indeed solve our problems.&lt;/p&gt;</comment>
                            <comment id="17430410" author="zentol" created="Tue, 19 Oct 2021 08:35:10 +0000"  >&lt;p&gt;Curator 5 no longer supports Zookeeper 3.4 though. We can bundle it exclusively with the ZK 3.5, but I suppose we should think about dropping 3.4 support and/or making 3.5 the default.&lt;/p&gt;</comment>
                            <comment id="17430473" author="davidmoravek" created="Tue, 19 Oct 2021 10:57:43 +0000"  >&lt;p&gt;I think we should be fairly safe dropping the 3.4 support here. The very last past release two 3.4.x branch was more then two years ago (2 April, 2019) and there are already three newer minor versions available (3.5.x,3.6.x,3.7.x).&lt;/p&gt;</comment>
                            <comment id="17449644" author="till.rohrmann" created="Fri, 26 Nov 2021 17:06:51 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;1.15.0: 3d7ad08ea24cb632d0d3db6dc942bb052ab9b464&lt;br/&gt;
1.14.1: 0a5481b2717dfe4d2e7c15ee98df36f85ff94d70&lt;br/&gt;
1.13.4: 07945ea8b346476ef17bd560671f8d7bfb14f0ee&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13409127">FLINK-24707</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13413400">FLINK-25018</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13414397">FLINK-25098</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13416888">FLINK-25265</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13375384">FLINK-22494</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13344444">CURATOR-584</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 50 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0vu54:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>