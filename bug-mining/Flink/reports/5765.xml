<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:00:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-23466] UnalignedCheckpointITCase hangs on Azure</title>
                <link>https://issues.apache.org/jira/browse/FLINK-23466</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=20813&amp;amp;view=logs&amp;amp;j=a57e0635-3fad-5b08-57c7-a4142d7d6fa9&amp;amp;t=2ef0effc-1da1-50e5-c2bd-aab434b1c5b7&amp;amp;l=16016&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=20813&amp;amp;view=logs&amp;amp;j=a57e0635-3fad-5b08-57c7-a4142d7d6fa9&amp;amp;t=2ef0effc-1da1-50e5-c2bd-aab434b1c5b7&amp;amp;l=16016&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The problem is the buffer listener will be removed from the listener queue when notified and then it will be added to the listener queue again if it needs more buffers. However, if some buffers are recycled meanwhile, the buffer listener will not be notified of the available buffers. For example:&lt;/p&gt;

&lt;p&gt;    1. Thread 1 calls LocalBufferPool#recycle().&lt;br/&gt;
    2. Thread 1 reaches LocalBufferPool#fireBufferAvailableNotification() and listener.notifyBufferAvailable() is invoked, but Thread 1 sleeps before acquiring the lock to registeredListeners.add(listener).&lt;br/&gt;
    3. Thread 2 is being woken up as a result of notifyBufferAvailable() call. It takes the buffer, but it needs more buffers.&lt;br/&gt;
    4. Other threads, return all buffers, including this one that has been recycled. None are taken. Are all in the LocalBufferPool.&lt;br/&gt;
    5. Thread 1 wakes up, and continues fireBufferAvailableNotification() invocation.&lt;br/&gt;
    6. Thread 1 re-adds listener that&apos;s waiting for more buffer registeredListeners.add(listener).&lt;br/&gt;
    7. Thread 1 exits loop LocalBufferPool#recycle(MemorySegment, int) inside, as the original memory segment has been used.&lt;/p&gt;

&lt;p&gt;At the end we have a state where all buffers are in the LocalBufferPool, so no new recycle() calls will happen, but there is still one listener waiting for a buffer (despite buffers being available).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13391269">FLINK-23466</key>
            <summary>UnalignedCheckpointITCase hangs on Azure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="dwysakowicz">Dawid Wysakowicz</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Thu, 22 Jul 2021 07:18:53 +0000</created>
                <updated>Wed, 15 Dec 2021 01:44:10 +0000</updated>
                            <resolved>Tue, 16 Nov 2021 08:37:29 +0000</resolved>
                                    <version>1.14.0</version>
                                    <fixVersion>1.14.3</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17400222" author="xintongsong" created="Tue, 17 Aug 2021 08:00:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=22340&amp;amp;view=logs&amp;amp;j=a57e0635-3fad-5b08-57c7-a4142d7d6fa9&amp;amp;t=2ef0effc-1da1-50e5-c2bd-aab434b1c5b7&amp;amp;l=17086&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=22340&amp;amp;view=logs&amp;amp;j=a57e0635-3fad-5b08-57c7-a4142d7d6fa9&amp;amp;t=2ef0effc-1da1-50e5-c2bd-aab434b1c5b7&amp;amp;l=17086&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17402225" author="akalashnikov" created="Fri, 20 Aug 2021 13:51:28 +0000"  >&lt;p&gt;Unfortunately, I failed with reproducing this problem locally, but here is some information from cluster log: &lt;br/&gt;
One of subtasks can not by restored by some reason:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
03:28:52,885 [ Checkpoint Timer] INFO org.apache.flink.runtime.checkpoint.CheckpointCoordinator [] - Failed to trigger checkpoint for job 776bcb49e2efd18ee411248fa66ed39d since Checkpoint triggering task 
keyed (15/20) of job 776bcb49e2efd18ee411248fa66ed39d is not being executed at the moment. Aborting checkpoint. Failure reason: Not all required tasks are currently running.

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;keyed (15/20)#4&quot; #20483 prio=5 os_prio=0 tid=0x00007fbe200f1000 nid=0x383c waiting on condition [0x00007fbc416d4000] 
 java.lang.Thread.State: TIMED_WAITING (parking) 
 at sun.misc.Unsafe.park(Native Method) 
 - parking to wait for &amp;lt;0x0000000094200658&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject) 
 at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215) 
 at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2163) 
 at org.apache.flink.streaming.runtime.tasks.mailbox.TaskMailboxImpl.take(TaskMailboxImpl.java:149) 
 at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.processMailsWhenDefaultActionUnavailable(MailboxProcessor.java:335) 
 at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.processMail(MailboxProcessor.java:324) 
 at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxLoop(MailboxProcessor.java:201) 
 at org.apache.flink.streaming.runtime.tasks.StreamTask.executeRestore(StreamTask.java:669) 
 at org.apache.flink.streaming.runtime.tasks.StreamTask$$Lambda$1116/826634555.run(Unknown Source) 
 at org.apache.flink.streaming.runtime.tasks.StreamTask.runWithCleanUpOnFail(StreamTask.java:785) 
 at org.apache.flink.streaming.runtime.tasks.StreamTask.restore(StreamTask.java:638) 
 at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:766) 
 at org.apache.flink.runtime.taskmanager.Task.run(Task.java:572) 
 at java.lang.Thread.run(Thread.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In one log I see that `restore` is stuck on&#160;requestBufferBlocking which may indicate taht we have problem with buffers availability(the only test with buffersPerChannel=0 fails) but unfortunatelly, I don&apos;t see the same log in the second failed build which may mean that we have different problem or more than one problem(or threaddump was taken in wrong moment):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;channel-state-unspilling-thread-1&quot; #17216 daemon prio=5 os_prio=0 tid=0x00007f6660005000 nid=0x739d in Object.wait() [0x00007f63ff1f0000] 
 java.lang.Thread.State: WAITING (on object monitor) 
 at java.lang.Object.wait(Native Method) 
 at java.lang.Object.wait(Object.java:502) 
 at org.apache.flink.runtime.io.network.partition.consumer.BufferManager.requestBufferBlocking(BufferManager.java:117) 
 - locked &amp;lt;0x00000000954d5fa8&amp;gt; (a org.apache.flink.runtime.io.network.partition.consumer.BufferManager$AvailableBufferQueue) 
 at org.apache.flink.runtime.io.network.partition.consumer.RecoveredInputChannel.requestBufferBlocking(RecoveredInputChannel.java:268) 
 at org.apache.flink.runtime.checkpoint.channel.InputChannelRecoveredStateHandler.getBuffer(RecoveredChannelStateHandler.java:90) 
 at org.apache.flink.runtime.checkpoint.channel.InputChannelRecoveredStateHandler.getBuffer(RecoveredChannelStateHandler.java:69) 
 at org.apache.flink.runtime.checkpoint.channel.ChannelStateChunkReader.readChunk(SequentialChannelStateReaderImpl.java:198) 
 at org.apache.flink.runtime.checkpoint.channel.SequentialChannelStateReaderImpl.readSequentially(SequentialChannelStateReaderImpl.java:107) 
 at org.apache.flink.runtime.checkpoint.channel.SequentialChannelStateReaderImpl.read(SequentialChannelStateReaderImpl.java:93) 
 at org.apache.flink.runtime.checkpoint.channel.SequentialChannelStateReaderImpl.readInputData(SequentialChannelStateReaderImpl.java:64) 
 at org.apache.flink.streaming.runtime.tasks.StreamTask.lambda$restoreGates$0(StreamTask.java:609) 
 at org.apache.flink.streaming.runtime.tasks.StreamTask$$Lambda$1081/1369458294.run(Unknown Source) 
 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) 
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) 
 at java.lang.Thread.run(Thread.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Again, I see that `buffersPerChannel=0` and I see(at least in one build) the problem with buffer avilability. So maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kevin.cyj&quot; class=&quot;user-hover&quot; rel=&quot;kevin.cyj&quot;&gt;kevin.cyj&lt;/a&gt; have any ideas in top of your head why it happens? In fact, I still don&apos;t sure that it is the true reason. &lt;br/&gt;
The second reason can be the problem with compliting StateConsumedFuture after the recovery but there is no any clue that point to this.&lt;/p&gt;</comment>
                            <comment id="17403081" author="kevin.cyj" created="Mon, 23 Aug 2021 09:40:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=akalashnikov&quot; class=&quot;user-hover&quot; rel=&quot;akalashnikov&quot;&gt;akalashnikov&lt;/a&gt;&#160;Thanks for the analysis. Previously, there was no such test for unaligned checkpoint that &apos;buffersPerChannel=0&apos;, I added them in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-16428&quot; title=&quot;Fine-grained network buffer management for backpressure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-16428&quot;&gt;&lt;del&gt;FLINK-16428&lt;/del&gt;&lt;/a&gt;. Maybe&#160;&apos;buffersPerChannel=0&apos; still does not work for&#160;unaligned&#160;checkpoint. If so, we may fix it or remove this test.&#160;I will take a look at this&lt;/p&gt;</comment>
                            <comment id="17403712" author="kevin.cyj" created="Tue, 24 Aug 2021 09:52:06 +0000"  >&lt;p&gt;Update:&lt;/p&gt;

&lt;p&gt;After running the test over one day. I think I finally reproduced the case. The case &quot;hung&quot; there for a very long time, but finally, it succeeded. The common stack among the three cases is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;Source: source (16/20)#4&quot;&lt;/span&gt; #10439 prio=5 os_prio=31 tid=0x00007f93973a2000 nid=0x4c91b sleeping[0x000070000b228000]
&#160;&#160; java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: TIMED_WAITING (sleeping)
&#160; &#160; &#160; &#160; at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(Native Method)
&#160; &#160; &#160; &#160; at org.apache.flink.test.checkpointing.UnalignedCheckpointTestBase$LongSource$LongSourceReader.pollNext(UnalignedCheckpointTestBase.java:319)
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.api.operators.SourceOperator.pollNext(SourceOperator.java:365)
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.api.operators.SourceOperator.emitNext(SourceOperator.java:325)
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.runtime.io.StreamTaskSourceInput.emitNext(StreamTaskSourceInput.java:68)
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.runtime.io.StreamOneInputProcessor.processInput(StreamOneInputProcessor.java:65)
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.runtime.tasks.StreamTask.processInput(StreamTask.java:489)
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.runtime.tasks.StreamTask$$Lambda$1091/178711115.runDefaultAction(Unknown Source)
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.runtime.tasks.mailbox.MailboxProcessor.runMailboxLoop(MailboxProcessor.java:203)
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.runtime.tasks.StreamTask.runMailboxLoop(StreamTask.java:819)
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.runtime.tasks.StreamTask.executeInvoke(StreamTask.java:746)
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.runtime.tasks.StreamTask$$Lambda$1279/2130631630.run(Unknown Source)
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.runtime.tasks.StreamTask.runWithCleanUpOnFail(StreamTask.java:785)
&#160; &#160; &#160; &#160; at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:728)
&#160; &#160; &#160; &#160; at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:786)
&#160; &#160; &#160; &#160; at org.apache.flink.runtime.taskmanager.Task.run(Task.java:572)
&#160; &#160; &#160; &#160; at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I guess this maybe a purely test case issue. I will further analysis it to find out why the thread stuck there that long.&lt;/p&gt;</comment>
                            <comment id="17404251" author="kevin.cyj" created="Wed, 25 Aug 2021 07:34:45 +0000"  >&lt;p&gt;Update:&lt;/p&gt;

&lt;p&gt;I reproduced the case where the thread is stuck in request buffer blocking. This time the test can not pass even after several hours. I will investigate this case further.&lt;/p&gt;</comment>
                            <comment id="17404351" author="kevin.cyj" created="Wed, 25 Aug 2021 11:13:05 +0000"  >&lt;p&gt;Update:&lt;/p&gt;

&lt;p&gt;From the dumped heap, I can see that the buffer manager is waiting for buffer and has registered itself as buffer listener in the buffer pool. At the same time the local buffer pool is full of buffers, but the buffer manager is not notified of available buffer. I guess there may be some concurrent issues.&lt;/p&gt;</comment>
                            <comment id="17404856" author="kevin.cyj" created="Thu, 26 Aug 2021 02:50:15 +0000"  >&lt;p&gt;After reading the code, I think two issues may caused the problem:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;After calling the&#160;requestMemorySegmentFromGlobal method, the buffer listener is not notified. I will try to fix and test it.&lt;/li&gt;
	&lt;li&gt;When recycle buffer, we remove the buffer listener from the queue first and then add it back, if there is any buffer recycled meanwhile, the listener will not be notified.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17404862" author="kevin.cyj" created="Thu, 26 Aug 2021 03:05:24 +0000"  >&lt;p&gt;I will try to fix the issues mentioned above and see if it solves the problem.&lt;/p&gt;</comment>
                            <comment id="17404995" author="pnowojski" created="Thu, 26 Aug 2021 06:46:19 +0000"  >&lt;p&gt;Thanks for the investigation and writing down your suspicions. If the problem is with `BufferManager`, the bug was previously unnoticed, because exclusive buffers were never returned to the buffer pool? That&apos;s why only `buffersPerChannel=0` is surfacing the problem?&lt;/p&gt;

&lt;p&gt;In a retrospect, maybe we should have randomised the number of exclusive buffers in &lt;tt&gt;org.apache.flink.streaming.util.TestStreamEnvironment&lt;/tt&gt; to provide test coverage for 0 exclusive buffers mode in the ITCases?&lt;/p&gt;</comment>
                            <comment id="17405019" author="kevin.cyj" created="Thu, 26 Aug 2021 07:28:30 +0000"  >&lt;p&gt;&amp;gt;&amp;gt;&amp;gt;&#160;Thanks for the investigation and writing down your suspicions. If the problem is with `BufferManager`, the bug was previously unnoticed, because exclusive buffers were never returned to the buffer pool? That&apos;s why only `buffersPerChannel=0` is surfacing the problem?&lt;/p&gt;

&lt;p&gt;I think you are right, if there are exclusive buffers, the floating buffers are optional.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;&amp;gt;&#160;In a retrospect, maybe we should have randomised the number of exclusive buffers in&#160;&lt;tt&gt;org.apache.flink.streaming.util.TestStreamEnvironment&lt;/tt&gt;&#160;to provide test coverage for 0 exclusive buffers mode in the ITCases?&lt;/p&gt;

&lt;p&gt;I think it is a good idea.&lt;/p&gt;</comment>
                            <comment id="17405097" author="pnowojski" created="Thu, 26 Aug 2021 09:31:50 +0000"  >&lt;p&gt;I&apos;ve bumped the priority to the release blocker, as I think we can hit this problem even with the default configuration options if there are just simply not enough buffers in the buffer pool. Before &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-16641&quot; title=&quot;Announce sender&amp;#39;s backlog to solve the deadlock issue without exclusive buffers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-16641&quot;&gt;&lt;del&gt;FLINK-16641&lt;/del&gt;&lt;/a&gt; Flink would fail if there are no exclusive buffers for the input channels. No that&apos;s allowed, but can lead to this deadlock.&lt;/p&gt;</comment>
                            <comment id="17405633" author="kevin.cyj" created="Fri, 27 Aug 2021 06:47:16 +0000"  >&lt;p&gt;I have opened a PR which fix the issue of recycle logic and tested the fix locally, the problem did not produce. For the&#160;requestMemorySegmentFromGlobal logic, it seems not easy to fix. Previously, I was thinking that we can unify the buffer lister to the availability listener. But I am afraid that it may cause performance issue when the number of input channels is large. Another way is to refactor the code and split the LocalBufferPool into two parts (two pool implementations), one contains the buffer listener logic and serves the input gates, the other contains the availability logic and serves the result partition. The logic of LocalBufferPool is pretty complicated. I think it is better to do some simplification. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;What do you think? Any suggestions?&lt;/p&gt;</comment>
                            <comment id="17405844" author="kevin.cyj" created="Fri, 27 Aug 2021 13:50:14 +0000"  >&lt;p&gt;Previously, the buffer listener will be removed from the listener queue when notified and then it will be added to the listener queue again if it needs more buffers. However, if some buffers are recycled meanwhile, the buffer listener will not be notified of the available buffers. For example:&lt;/p&gt;

&lt;p&gt;&#160;&#160; &#160;&lt;/p&gt;

&lt;p&gt;&#160; &#160; 1. Thread 1 calls LocalBufferPool#recycle().&lt;/p&gt;

&lt;p&gt;&#160; &#160; 2. Thread 1 reaches LocalBufferPool#fireBufferAvailableNotification() and listener.notifyBufferAvailable() is invoked, but Thread 1 sleeps before acquiring the lock to registeredListeners.add(listener).&lt;/p&gt;

&lt;p&gt;&#160; &#160; 3. Thread 2 is being woken up as a result of notifyBufferAvailable() call. It takes the buffer, but it needs more buffers.&lt;/p&gt;

&lt;p&gt;&#160; &#160; 4. Other threads, return all buffers, including this one that has been recycled. None are taken. Are all in the LocalBufferPool.&lt;/p&gt;

&lt;p&gt;&#160; &#160; 5. Thread 1 wakes up, and continues fireBufferAvailableNotification() invocation.&lt;/p&gt;

&lt;p&gt;&#160; &#160; 6. Thread 1 re-adds listener that&apos;s waiting for more buffer registeredListeners.add(listener).&lt;/p&gt;

&lt;p&gt;&#160; &#160; 7. Thread 1 exits loop LocalBufferPool#recycle(MemorySegment, int) inside, as the original memory segment has been used.&lt;/p&gt;

&lt;p&gt;&#160;&#160; &#160;&lt;/p&gt;

&lt;p&gt;&#160; &#160; At the end we have a state where all buffers are in the LocalBufferPool, so no new recycle() calls will happen, but there is still one listener waiting for a buffer (despite buffers being available).&lt;/p&gt;

&lt;p&gt;&#160;&#160; &#160;&lt;/p&gt;

&lt;p&gt;&#160; &#160; This change fixes the issue by letting the buffer listener request multiple buffers one after another without having to enqueue BufferListener to the registeredListener queue.&lt;/p&gt;</comment>
                            <comment id="17406643" author="pnowojski" created="Mon, 30 Aug 2021 09:09:37 +0000"  >&lt;p&gt;Merged to master as 48a384dffc7&lt;br/&gt;
Merged to release-1.14 as 0067d35cc0f&lt;/p&gt;</comment>
                            <comment id="17442148" author="till.rohrmann" created="Thu, 11 Nov 2021 08:23:21 +0000"  >&lt;p&gt;This problem seems to still occur: &lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=26304&amp;amp;view=logs&amp;amp;j=a57e0635-3fad-5b08-57c7-a4142d7d6fa9&amp;amp;t=2ef0effc-1da1-50e5-c2bd-aab434b1c5b7&amp;amp;l=13067&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=26304&amp;amp;view=logs&amp;amp;j=a57e0635-3fad-5b08-57c7-a4142d7d6fa9&amp;amp;t=2ef0effc-1da1-50e5-c2bd-aab434b1c5b7&amp;amp;l=13067&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Maybe it is a new problem that manifests with the same symptoms.&lt;/p&gt;</comment>
                            <comment id="17444017" author="till.rohrmann" created="Mon, 15 Nov 2021 18:12:15 +0000"  >&lt;p&gt;Can this also be a problem affecting &lt;tt&gt;1.15.0&lt;/tt&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17444279" author="kevin.cyj" created="Tue, 16 Nov 2021 05:58:35 +0000"  >&lt;p&gt;Nov 10 16:13:03 Starting org.apache.flink.test.checkpointing.UnalignedCheckpointITCase#execute&lt;span class=&quot;error&quot;&gt;&amp;#91;pipeline with mixed channels, p = 20, timeout = 0, buffersPerChannel = 1&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;From the log, we can see this case hangs. I guess this seems a new issue which is different from the one reported in this ticket. From the stack, it seems there is something wrong with the checkpoint coordinator, the following thread locked 0x0000000087db4fb8:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2021-11-10T17:14:21.0899474Z Nov 10 17:14:21 &lt;span class=&quot;code-quote&quot;&gt;&quot;jobmanager-io-thread-2&quot;&lt;/span&gt; #12984 daemon prio=5 os_prio=0 tid=0x00007f12e000b800 nid=0x3fb6 runnable [0x00007f0fcd6d4000]
2021-11-10T17:14:21.0899924Z Nov 10 17:14:21    java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
2021-11-10T17:14:21.0900300Z Nov 10 17:14:21 	at java.util.HashMap$TreeNode.balanceDeletion(HashMap.java:2338)
2021-11-10T17:14:21.0900745Z Nov 10 17:14:21 	at java.util.HashMap$TreeNode.removeTreeNode(HashMap.java:2112)
2021-11-10T17:14:21.0901146Z Nov 10 17:14:21 	at java.util.HashMap.removeNode(HashMap.java:840)
2021-11-10T17:14:21.0901577Z Nov 10 17:14:21 	at java.util.LinkedHashMap.afterNodeInsertion(LinkedHashMap.java:301)
2021-11-10T17:14:21.0902002Z Nov 10 17:14:21 	at java.util.HashMap.putVal(HashMap.java:664)
2021-11-10T17:14:21.0902531Z Nov 10 17:14:21 	at java.util.HashMap.putMapEntries(HashMap.java:515)
2021-11-10T17:14:21.0902931Z Nov 10 17:14:21 	at java.util.HashMap.putAll(HashMap.java:785)
2021-11-10T17:14:21.0903429Z Nov 10 17:14:21 	at org.apache.flink.runtime.checkpoint.ExecutionAttemptMappingProvider.getVertex(ExecutionAttemptMappingProvider.java:60)
2021-11-10T17:14:21.0904060Z Nov 10 17:14:21 	at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.reportStats(CheckpointCoordinator.java:1867)
2021-11-10T17:14:21.0904686Z Nov 10 17:14:21 	at org.apache.flink.runtime.checkpoint.CheckpointCoordinator.receiveAcknowledgeMessage(CheckpointCoordinator.java:1152)
2021-11-10T17:14:21.0905372Z Nov 10 17:14:21 	- locked &amp;lt;0x0000000087db4fb8&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;)
2021-11-10T17:14:21.0905895Z Nov 10 17:14:21 	at org.apache.flink.runtime.scheduler.ExecutionGraphHandler.lambda$acknowledgeCheckpoint$1(ExecutionGraphHandler.java:89)
2021-11-10T17:14:21.0906493Z Nov 10 17:14:21 	at org.apache.flink.runtime.scheduler.ExecutionGraphHandler$$Lambda$1368/705813936.accept(Unknown Source)
2021-11-10T17:14:21.0907086Z Nov 10 17:14:21 	at org.apache.flink.runtime.scheduler.ExecutionGraphHandler.lambda$processCheckpointCoordinatorMessage$3(ExecutionGraphHandler.java:119)
2021-11-10T17:14:21.0907698Z Nov 10 17:14:21 	at org.apache.flink.runtime.scheduler.ExecutionGraphHandler$$Lambda$1369/1447418658.run(Unknown Source)
2021-11-10T17:14:21.0908210Z Nov 10 17:14:21 	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
2021-11-10T17:14:21.0908735Z Nov 10 17:14:21 	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
2021-11-10T17:14:21.0909333Z Nov 10 17:14:21 	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But other thread is waiting for the lock. I am not familiar with these logics and not sure if this is in the right state. Could anyone who is familiar with these logics take a look?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;BTW, concurrent access of HashMap may cause infinite loop&#65292;I see in the stack that there are multiple threads are accessing HashMap, though I am not sure if they are the same instance.&lt;/p&gt;</comment>
                            <comment id="17444365" author="pnowojski" created="Tue, 16 Nov 2021 08:37:29 +0000"  >&lt;p&gt;I&apos;ve extracted the newly reported issue to &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-24919&quot; title=&quot;UnalignedCheckpointITCase hangs on Azure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-24919&quot;&gt;&lt;del&gt;FLINK-24919&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310761">
                    <name>Issue split</name>
                                            <outwardlinks description="split to">
                                        <issuelink>
            <issuekey id="13411986">FLINK-24919</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13292337">FLINK-16641</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13397927">FLINK-24035</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0t84o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>