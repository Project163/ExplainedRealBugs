<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:30:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7721] StatusWatermarkValve should output a new min watermark only if it was aggregated from aligned chhanels</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7721</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Context:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; newMinWatermark = &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MAX_VALUE;

&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (InputChannelStatus channelStatus : channelStatuses) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (channelStatus.isWatermarkAligned) {
        newMinWatermark = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(channelStatus.watermark, newMinWatermark);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the calculation of the new min watermark in &lt;tt&gt;StatusWatermarkValve#findAndOutputNewMinWatermarkAcrossAlignedChannels()&lt;/tt&gt;, there is not verification that the calculated new min watermark &lt;tt&gt;newMinWatermark&lt;/tt&gt; really is aggregated from some aligned channel.&lt;/p&gt;

&lt;p&gt;In the corner case where all input channels are currently not aligned but actually some are active, we would then incorrectly determine that the final aggregation of &lt;tt&gt;newMinWatermark&lt;/tt&gt; is &lt;tt&gt;Long.MAX_VALUE&lt;/tt&gt; and emit that.&lt;/p&gt;

&lt;p&gt;The fix would simply be to only emit the aggregated watermark IFF it was really calculated from some aligned input channel (as well as the already existing constraint that it needs to be larger than the last emitted watermark). This change should also safely cover the case that a &lt;tt&gt;Long.MAX_VALUE&lt;/tt&gt; was genuinely aggregated from one of the input channels.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13105527">FLINK-7721</key>
            <summary>StatusWatermarkValve should output a new min watermark only if it was aggregated from aligned chhanels</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tzulitai">Tzu-Li (Gordon) Tai</assignee>
                                    <reporter username="tzulitai">Tzu-Li (Gordon) Tai</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Sep 2017 18:04:50 +0000</created>
                <updated>Mon, 12 Mar 2018 15:24:10 +0000</updated>
                            <resolved>Mon, 12 Mar 2018 15:24:10 +0000</resolved>
                                    <version>1.2.1</version>
                    <version>1.3.2</version>
                    <version>1.4.0</version>
                                    <fixVersion>1.3.4</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>API / DataStream</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16183014" author="githubbot" created="Wed, 27 Sep 2017 18:15:25 +0000"  >&lt;p&gt;GitHub user tzulitai opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4738&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4738&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7721&quot; title=&quot;StatusWatermarkValve should output a new min watermark only if it was aggregated from aligned chhanels&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7721&quot;&gt;&lt;del&gt;FLINK-7721&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;DataStream&amp;#93;&lt;/span&gt; Only emit new min watermark iff it was aggregated from watermark-aligned inputs&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Prior to this PR, in the calculation of the new min watermark in `StatusWatermarkValve#findAndOutputNewMinWatermarkAcrossAlignedChannels()`, there is no verification that the calculated new min watermark really is aggregated from some aligned channel.&lt;/p&gt;

&lt;p&gt;    In the corner case where all input channels are currently not aligned but actually some are active, we would then incorrectly determine that the final aggregation is `Long.MAX_VALUE` and emit that.&lt;/p&gt;

&lt;p&gt;    This PR fixes this by only emitting the aggregated watermark iff it was really calculated from some aligned input channel (as well as the already existing constraint that it needs to be larger than the last emitted watermark). This change should also safely cover the case that a `Long.MAX_VALUE` was genuinely aggregated from the input channels.&lt;/p&gt;

&lt;p&gt;    *&lt;b&gt;This is a critical bug that should be fixed for all affecting versions: 1.2.1, 1.3.2, 1.4.0 (master)&lt;/b&gt;*&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Fix `findAndOutputNewMinWatermarkAcrossAlignedChannels` to only output the new min watermark iff it was truly computed from some aligned channel.&lt;/li&gt;
	&lt;li&gt;Adapt `StatusWatermarkValveTest#testMultipleInputValve()` to cover the missing case.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    Verified by the modified `StatusWatermarkValveTest#testMultipleInputValve()`.&lt;br/&gt;
    Without the fix in `findAndOutputNewMinWatermarkAcrossAlignedChannels`, the modified test does not pass.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): no&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: no&lt;/li&gt;
	&lt;li&gt;The serializers: no&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): *&lt;b&gt;YES&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes / no / don&apos;t know)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? no&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? no&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/tzulitai/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/tzulitai/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7721&quot; title=&quot;StatusWatermarkValve should output a new min watermark only if it was aggregated from aligned chhanels&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7721&quot;&gt;&lt;del&gt;FLINK-7721&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4738.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4738.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4738&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 29d3b74f81410ea9c2ed861c297ece8134d9b29f&lt;br/&gt;
Author: Tzu-Li (Gordon) Tai &amp;lt;tzulitai@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-09-27T18:05:21Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7721&quot; title=&quot;StatusWatermarkValve should output a new min watermark only if it was aggregated from aligned chhanels&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7721&quot;&gt;&lt;del&gt;FLINK-7721&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;DataStream&amp;#93;&lt;/span&gt; Only emit new min watermark iff it was aggregated from watermark-aligned inputs&lt;/p&gt;

&lt;p&gt;    Prior to this commit, In the calculation of the new min watermark in&lt;br/&gt;
    StatusWatermarkValve#findAndOutputNewMinWatermarkAcrossAlignedChannels(),&lt;br/&gt;
    there is no verification that the calculated new min watermark&lt;br/&gt;
    really is aggregated from some aligned channel.&lt;/p&gt;

&lt;p&gt;    In the corner case where all input channels are currently not aligned&lt;br/&gt;
    but actually some are active, we would then incorrectly determine that&lt;br/&gt;
    the final aggregation is Long.MAX_VALUE and emit that.&lt;/p&gt;

&lt;p&gt;    This commit fixes this by only emitting the aggregated watermark iff it was&lt;br/&gt;
    really calculated from some aligned input channel (as well as the&lt;br/&gt;
    already existing constraint that it needs to be larger than the last&lt;br/&gt;
    emitted watermark). This change should also safely cover the case that a&lt;br/&gt;
    Long.MAX_VALUE was genuinely aggregated from the input channels.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16187796" author="aljoscha" created="Mon, 2 Oct 2017 09:26:11 +0000"  >&lt;p&gt;Fixed on release-1.3 in&lt;br/&gt;
b67bc4da568df08f5a27f5a84546b54c85b5bb7a&lt;/p&gt;

&lt;p&gt;Fixed on master in &lt;br/&gt;
1de47316405a255d3fa21f684ea1500ae59aa9e4&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tzulitai&quot; class=&quot;user-hover&quot; rel=&quot;tzulitai&quot;&gt;tzulitai&lt;/a&gt; Flink 1.2.x doesn&apos;t have the valve, right? Or would the fix go into a different part?&lt;/p&gt;</comment>
                            <comment id="16187802" author="githubbot" created="Mon, 2 Oct 2017 09:29:10 +0000"  >&lt;p&gt;Github user aljoscha commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4738&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4738&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @tzulitai Thanks a lot for this fix! &#128077; Could you please close the PR?&lt;/p&gt;</comment>
                            <comment id="16188203" author="aljoscha" created="Mon, 2 Oct 2017 14:41:36 +0000"  >&lt;p&gt;Reopen to fix git commit hash&lt;/p&gt;</comment>
                            <comment id="16188204" author="aljoscha" created="Mon, 2 Oct 2017 14:41:49 +0000"  >&lt;p&gt;Fixed on master in c81a7e519bf3db2f9c5e62fadd7a3a4fb7692904&lt;/p&gt;</comment>
                            <comment id="16194283" author="githubbot" created="Fri, 6 Oct 2017 08:20:21 +0000"  >&lt;p&gt;Github user tzulitai closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4738&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4738&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 6 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3kmkn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>