<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:56:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-22276] ExceptionHistoryEntryExtractor throws fatal error when task failure</title>
                <link>https://issues.apache.org/jira/browse/FLINK-22276</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When running my batch job on Flink cluster, I got a fatal error as below and JM exits:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13023846/13023846_image-2021-04-14-17-50-45-199.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Digging into the code,&#160; &#160;when DefaultScheduler start archiving failure cause (&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/scheduler/DefaultScheduler.java#L259),&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-runtime/src/main/java/org/apache/flink/runtime/scheduler/DefaultScheduler.java#L259),&lt;/a&gt;&#160;seems Execution#failureCause is not safely/correctly attached/updated.&lt;/p&gt;

&lt;p&gt;I attached JM log, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt;&#160;Would you mind help verify on this ?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The job topology is like below:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13023889/13023889_image-2021-04-15-14-46-42-660.png&quot; height=&quot;308&quot; width=&quot;519&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;All edges are blocking &#8211; &#8211; parallelism is 2 and there are 6 pipelined regions for all;&lt;/li&gt;
	&lt;li&gt;Scheduled encountered fatal error when running ShuffleRead&amp;amp;Write&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13372255">FLINK-22276</key>
            <summary>ExceptionHistoryEntryExtractor throws fatal error when task failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mapohl">Matthias Pohl</assignee>
                                    <reporter username="jinxing6042@126.com">Jin Xing</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 14 Apr 2021 09:48:40 +0000</created>
                <updated>Sat, 28 Aug 2021 11:16:09 +0000</updated>
                            <resolved>Mon, 19 Apr 2021 17:34:34 +0000</resolved>
                                    <version>1.13.0</version>
                                    <fixVersion>1.13.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17320894" author="thesharing" created="Wed, 14 Apr 2021 10:38:05 +0000"  >&lt;p&gt;I&apos;ve gone through the log and got some assumptions. In the log we can see there are two failovers that happen within 30 milliseconds:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;failover 1 includes &lt;tt&gt;shuffleRead&amp;amp;Write (1/2)&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;failover 2 includes &lt;tt&gt;shuffleRead&amp;amp;Write (1/2) + shuffleRead&amp;amp;Write (2/2)&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It seems that &lt;tt&gt;restartTasks&lt;/tt&gt; of failover 2 runs first, resets the execution of &lt;tt&gt;shuffleRead&amp;amp;Write (1/2)&lt;/tt&gt;. Then &lt;tt&gt;archiveFromFailureHandlingResult&lt;/tt&gt; of failover 1 runs, finds that there&apos;s no failure cause in the new execution of &lt;tt&gt;shuffleRead&amp;amp;Write (1/2)&lt;/tt&gt;.&lt;br/&gt;
 &#160;&lt;/p&gt;</comment>
                            <comment id="17321224" author="mapohl" created="Wed, 14 Apr 2021 18:21:28 +0000"  >&lt;p&gt;Thanks for bringing this up, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jinxing6042%40126.com&quot; class=&quot;user-hover&quot; rel=&quot;jinxing6042@126.com&quot;&gt;jinxing6042@126.com&lt;/a&gt;. On what revision of Flink&apos;s source code was this job executed? I&apos;m puzzled a bit about the &lt;tt&gt;ExecutionState&lt;/tt&gt; &lt;tt&gt;RECOVERING&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2021-04-14 17:06:34,566 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - shuffleRead&amp;amp;Write (1/2) (9fcfd71ad147a96527f080752b4732cd) switched from DEPLOYING to RECOVERING.
2021-04-14 17:06:34,569 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - shuffleRead&amp;amp;Write (2/2) (d8f382ae4087fe15368be9fae1bbf310) switched from DEPLOYING to RECOVERING.
2021-04-14 17:06:34,624 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - shuffleRead&amp;amp;Write (1/2) (9fcfd71ad147a96527f080752b4732cd) switched from RECOVERING to RUNNING.
2021-04-14 17:06:34,625 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - shuffleRead&amp;amp;Write (2/2) (d8f382ae4087fe15368be9fae1bbf310) switched from RECOVERING to RUNNING.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I haven&apos;t seen that &lt;tt&gt;ExecutionState&lt;/tt&gt; ever and cannot find it in my version of the code, either?&lt;/p&gt;</comment>
                            <comment id="17321235" author="mapohl" created="Wed, 14 Apr 2021 18:36:12 +0000"  >&lt;p&gt;I see, the &lt;tt&gt;RECOVERING&lt;/tt&gt; was renamed into &lt;tt&gt;INITIALIZING&lt;/tt&gt; in &lt;a href=&quot;https://github.com/apache/flink/commit/b3879280&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;b3879280&lt;/a&gt;. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt; for pointing that out.&lt;/p&gt;</comment>
                            <comment id="17321312" author="mapohl" created="Wed, 14 Apr 2021 20:42:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Thesharing&quot; class=&quot;user-hover&quot; rel=&quot;Thesharing&quot;&gt;Thesharing&lt;/a&gt; thanks for your analysis. I guess, you&apos;re right. The &lt;tt&gt;DefaultScheduler.delayExecutor&lt;/tt&gt; is multi-threaded. That&apos;s where the race condition between restarting the two tasks and archiving the failure of the single task happens. We should have considered the &lt;tt&gt;ExecutionVertex&apos;s&lt;/tt&gt; version when checking the tasks for failures. Already restarted tasks should not be considered for archiving as their failure should have been archived already.&lt;/p&gt;

&lt;p&gt;One thing, that&apos;s probably unrelated, but maybe somebody can give me a reason for it: The &lt;tt&gt;RestartPipelinedRegionFailoverStrategy&lt;/tt&gt; selects only one task for restart when the first failure occurs. For the second failure, the &lt;tt&gt;RestartPipelinedRegionFailoverStrategy&lt;/tt&gt; selects two tasks for restart. Shouldn&apos;t the strategy always select the two tasks for restart considering that both belong to the same pipeline region? Or am I missing something here?&lt;/p&gt;

&lt;p&gt;I&apos;m gonna continue work on this tomorrow...&lt;/p&gt;</comment>
                            <comment id="17321932" author="thesharing" created="Thu, 15 Apr 2021 06:28:08 +0000"  >&lt;p&gt;Thank you for pointing this out, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt;. I go over the job with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jinxing6042%40126.com&quot; class=&quot;user-hover&quot; rel=&quot;jinxing6042@126.com&quot;&gt;jinxing6042@126.com&lt;/a&gt;&#160;and figure this out. When TaskExecutor updates the Execution state to FAILED, it will call&#160;&lt;tt&gt;JobMasterPartitionTracker#stopTrackingAndReleasePartitions&lt;/tt&gt; for the result partition of &lt;tt&gt;shuffleRead&amp;amp;Write (1/2)&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Failover 1 is caused by &lt;tt&gt;shuffleRead&amp;amp;Write(1/2)&lt;/tt&gt;. When failover 1 occurs, it only failover itself because &lt;tt&gt;shuffleRead&amp;amp;Write(2/2)&lt;/tt&gt; is running normally at this moment.&lt;/p&gt;

&lt;p&gt;Failover 2 is caused by &lt;tt&gt;shuffleRead&amp;amp;Write (2/2)&lt;/tt&gt;. When failover 2 occurs, it will first iterate over all the downstream regions of &lt;tt&gt;shuffleRead&amp;amp;Write (2/2)&lt;/tt&gt;, i.e. &lt;tt&gt;write (1/2)&lt;/tt&gt; and &lt;tt&gt;write (2/2)&lt;/tt&gt;. Then when iterating the region of &lt;tt&gt;write (1/2)&lt;/tt&gt;, it will check if its needed input result partition is available or not, and then adds &lt;tt&gt;shuffleRead&amp;amp;Write (1/2)&lt;/tt&gt; to the regions to restart. Therefore there are two tasks for restart in the failover 2.&lt;br/&gt;
 &#160;&lt;/p&gt;</comment>
                            <comment id="17321988" author="mapohl" created="Thu, 15 Apr 2021 07:53:25 +0000"  >&lt;p&gt;We were able to reproduce the issue. The issue is that we&apos;re working on &lt;tt&gt;ExecutionVertex&lt;/tt&gt; instances instead of &lt;tt&gt;Executions&lt;/tt&gt; for retrieving the &lt;tt&gt;failureInfo&lt;/tt&gt;. I&apos;m working on fixing it now.&lt;/p&gt;</comment>
                            <comment id="17322112" author="jinxing6042@126.com" created="Thu, 15 Apr 2021 11:38:55 +0000"  >&lt;p&gt;Thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17322642" author="mapohl" created="Fri, 16 Apr 2021 06:19:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jinxing6042%40126.com&quot; class=&quot;user-hover&quot; rel=&quot;jinxing6042@126.com&quot;&gt;jinxing6042@126.com&lt;/a&gt; was the issue repeatably happening? If yes, it would be good to run the job with the fixes from the PR to verify that it got fixed.&lt;/p&gt;</comment>
                            <comment id="17324083" author="till.rohrmann" created="Fri, 16 Apr 2021 21:18:56 +0000"  >&lt;p&gt;Temporary workaround merged via fe41a87d39cbebe14e8d5de1058874cb4f7e9550&lt;/p&gt;</comment>
                            <comment id="17324734" author="jinxing6042@126.com" created="Mon, 19 Apr 2021 06:40:11 +0000"  >&lt;p&gt;Thanks a lot for quick fix ~ I will try the PR and come back later ~&lt;/p&gt;</comment>
                            <comment id="17324798" author="mapohl" created="Mon, 19 Apr 2021 07:47:25 +0000"  >&lt;p&gt;FYI: There was a workaround merged on Friday (&lt;a href=&quot;https://github.com/apache/flink/pull/15648&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #15648&lt;/a&gt;) to enable building a new RC the past weekend. The actual resolution is still under progress in &lt;a href=&quot;https://github.com/apache/flink/pull/15640&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #15640&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17325217" author="till.rohrmann" created="Mon, 19 Apr 2021 17:34:34 +0000"  >&lt;p&gt;Fixed via&lt;/p&gt;

&lt;p&gt;master: 317687b20901151165db39365e3634b002c70d3e&lt;br/&gt;
1.13.0: f4105f65fb510de11ccb08c4b31d5e4c30744151&lt;/p&gt;</comment>
                            <comment id="17329951" author="jinxing6042@126.com" created="Fri, 23 Apr 2021 03:27:08 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt;&#160;~ I tried the patch and it works very well &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17330231" author="mapohl" created="Fri, 23 Apr 2021 08:58:37 +0000"  >&lt;p&gt;Awesome, thanks for getting back to us &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jinxing6042%40126.com&quot; class=&quot;user-hover&quot; rel=&quot;jinxing6042@126.com&quot;&gt;jinxing6042@126.com&lt;/a&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_up.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13023846" name="image-2021-04-14-17-50-45-199.png" size="681830" author="jinxing6042@126.com" created="Wed, 14 Apr 2021 09:50:46 +0000"/>
                            <attachment id="13023889" name="image-2021-04-15-14-46-42-660.png" size="281629" author="jinxing6042@126.com" created="Thu, 15 Apr 2021 06:46:44 +0000"/>
                            <attachment id="13023847" name="log" size="61266" author="jinxing6042@126.com" created="Wed, 14 Apr 2021 09:59:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 29 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0pz0g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>