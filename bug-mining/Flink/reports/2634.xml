<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:35:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-9567] Flink does not release resource in Yarn Cluster mode</title>
                <link>https://issues.apache.org/jira/browse/FLINK-9567</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;After restart the Job Manager in Yarn Cluster mode, sometimes Flink does not release task manager containers in some specific case.&#160;In the worst case, I had a job configured to 5 task managers, but possess more than 100 containers in the end. Although the task didn&apos;t failed, but it affect other jobs in the Yarn Cluster.&lt;/p&gt;

&lt;p&gt;In the first log I posted, the container with id 24 is the reason why Yarn did not release resources. As the container was killed before restart, but it has not received the callback of &lt;b&gt;onContainerComplete&lt;/b&gt; in &lt;b&gt;YarnResourceManager&lt;/b&gt; which should be called by &lt;b&gt;AMRMAsyncClient&lt;/b&gt; of Yarn. After restart, as we can see&#160;in line 347 of FlinkYarnProblem log,&#160;&lt;/p&gt;

&lt;p&gt;2018-06-14 22:50:47,846 WARN akka.remote.ReliableDeliverySupervisor - Association with remote system &lt;span class=&quot;error&quot;&gt;&amp;#91;akka.tcp://flink@bd-r1hdp69:30609&amp;#93;&lt;/span&gt; has failed, address is now gated for &lt;span class=&quot;error&quot;&gt;&amp;#91;50&amp;#93;&lt;/span&gt; ms. Reason: &lt;span class=&quot;error&quot;&gt;&amp;#91;Disassociated&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Flink lost the connection of container 24 which is on bd-r1hdp69 machine. When it try to call&#160;&lt;b&gt;closeTaskManagerConnection&lt;/b&gt;&#160;in&#160;&lt;b&gt;onContainerComplete&lt;/b&gt;, it did not has the connection to TaskManager on container 24, so it just ignore the close of TaskManger.&lt;/p&gt;

&lt;p&gt;2018-06-14 22:50:51,812 DEBUG org.apache.flink.yarn.YarnResourceManager - No open TaskExecutor connection container_1528707394163_29461_02_000024. Ignoring close TaskExecutor connection.&lt;/p&gt;

&lt;p&gt;&#160;However, bafore calling&#160;&lt;b&gt;closeTaskManagerConnection,&lt;/b&gt; it already called&#160;&lt;b&gt;requestYarnContainer&lt;/b&gt;&#160;which lead to&#160;&lt;b&gt;numPendingContainerRequests&#160;variable in&lt;/b&gt;&#160;&lt;b&gt;YarnResourceManager&lt;/b&gt;&#160;increased by 1.&lt;/p&gt;

&lt;p&gt;As the excessive container return is determined by the&#160;&lt;b&gt;numPendingContainerRequests&lt;/b&gt;&#160;variable in &lt;b&gt;YarnResourceManager&lt;/b&gt;, it cannot return this container although it is not required. Meanwhile, the restart logic has already allocated enough containers for Task Managers, Flink will possess the extra container for a long time for nothing.&#160;&lt;/p&gt;

&lt;p&gt;In the full log, the job ended with 7 containers while only 3 are running TaskManagers.&lt;/p&gt;

&lt;p&gt;ps: Another strange thing I found is that when sometimes request for a yarn container, it will return much more than requested. Is it a normal scenario for AMRMAsyncClient?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13165285">FLINK-9567</key>
            <summary>Flink does not release resource in Yarn Cluster mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dangdangdang">Shimin Yang</assignee>
                                    <reporter username="dangdangdang">Shimin Yang</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 11 Jun 2018 09:52:42 +0000</created>
                <updated>Thu, 28 Feb 2019 14:12:36 +0000</updated>
                            <resolved>Fri, 21 Sep 2018 09:26:35 +0000</resolved>
                                    <version>1.5.0</version>
                                    <fixVersion>1.5.5</fixVersion>
                    <fixVersion>1.6.2</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                                    <component>Deployment / YARN</component>
                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16513390" author="dangdangdang" created="Fri, 15 Jun 2018 06:02:00 +0000"  >&lt;p&gt;I modified the onContainerCompleted method and running for test.&lt;/p&gt;</comment>
                            <comment id="16515018" author="dangdangdang" created="Sun, 17 Jun 2018 07:25:31 +0000"  >&lt;p&gt;I think I can fix the issue but I cannot assign to myself.&lt;/p&gt;</comment>
                            <comment id="16515886" author="till.rohrmann" created="Mon, 18 Jun 2018 15:28:53 +0000"  >&lt;p&gt;Thanks for reporting the issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dangdangdang&quot; class=&quot;user-hover&quot; rel=&quot;dangdangdang&quot;&gt;dangdangdang&lt;/a&gt;. Your analysis sounds like a bug in Flink which we should fix. It would be great if you could provide a patch for the problem. I&apos;ve assigned this issue to you. If you no longer have the capacities to work on this issue, then please unassign yourself.&lt;/p&gt;</comment>
                            <comment id="16516972" author="dangdangdang" created="Tue, 19 Jun 2018 11:41:37 +0000"  >&lt;p&gt;Thanks for assigning the issue to me, I will do my best to fix it.&lt;/p&gt;</comment>
                            <comment id="16519063" author="githubbot" created="Thu, 21 Jun 2018 08:20:09 +0000"  >&lt;p&gt;GitHub user Clarkkkkk opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6192&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6192&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9567&quot; title=&quot;Flink does not release resource in Yarn Cluster mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9567&quot;&gt;&lt;del&gt;FLINK-9567&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;yarn&amp;#93;&lt;/span&gt; Fix the bug that Flink does not release Yarn container in some cases &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;This pull request responds to  &lt;span class=&quot;error&quot;&gt;&amp;#91;JIRA issue FLINK-9567&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9567&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-9567&lt;/a&gt;).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;This pull request is to avoid flink system does not release taskmanager container in some specific case.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Bried change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Modify the onContainerCompleted method in YarnResourceManager.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Add a checkWorkerRegistrationWithResourceId method in ResourceManager that check the status of task executor with specific resourceId&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Add a triggerTaskManagerHeartbeatTimeout method in ResouceManager which is only visibleForTesting, which emulate the timeout of task manager leads to the problem.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;br/&gt;
    This  change is covered by testOnContainerCompleted added in YarnResourceManagerTest&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with&#160;@Public(Evolving): (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (No)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/Clarkkkkk/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Clarkkkkk/flink&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6192.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6192.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #6192&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 6eaac2b5bc06ef6dffef5eb489668b0d81ac179b&lt;br/&gt;
Author: yangshimin &amp;lt;yangshimin@...&amp;gt;&lt;br/&gt;
Date:   2018-06-21T03:36:01Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9567&quot; title=&quot;Flink does not release resource in Yarn Cluster mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9567&quot;&gt;&lt;del&gt;FLINK-9567&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;yarn&amp;#93;&lt;/span&gt;Fix the bug that Flink does not release Yarn container in some cases&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16521984" author="githubbot" created="Mon, 25 Jun 2018 08:12:53 +0000"  >&lt;p&gt;Github user Clarkkkkk commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6192&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6192&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @tillrohrmann I think this problem is caused by inconsistency between instance variables taskExecutor of ResourceManager class and workerNodeMap of YarnResourceManager class. What do you think about my fix?&lt;/p&gt;</comment>
                            <comment id="16522068" author="githubbot" created="Mon, 25 Jun 2018 09:12:47 +0000"  >&lt;p&gt;Github user Clarkkkkk commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6192&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6192&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @tillrohrmann But I think this only works if the restart strategy is RestartAllStrategy. &lt;/p&gt;</comment>
                            <comment id="16526563" author="githubbot" created="Thu, 28 Jun 2018 17:15:03 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6192#discussion_r198914433&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6192#discussion_r198914433&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -1120,5 +1120,28 @@ public void reportPayload(ResourceID resourceID, Void payload) &lt;/p&gt;
{
     			return CompletableFuture.completedFuture(null);
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	// ------------------------------------------------------------------------&lt;br/&gt;
    +	//  Work Registration status checking&lt;br/&gt;
    +	// ------------------------------------------------------------------------&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Check if the executor with given resourceID is still in taskExecutors map&lt;br/&gt;
    +	 * @param resourceID an ID mapping to a task executor&lt;br/&gt;
    +	 * @return&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	protected boolean checkWorkerRegistrationWithResourceId(ResourceID resourceID) {&lt;br/&gt;
    +		boolean status = taskExecutors.containsKey(resourceID);&lt;br/&gt;
    +		if (!status) {&lt;br/&gt;
    +			log.debug(&quot;No open TaskExecutor connection {}. Ignoring close TaskExecutor connection.&quot;, resourceID);&lt;br/&gt;
    +		}&lt;br/&gt;
    +		return status;&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@VisibleForTesting&lt;br/&gt;
    +	public void triggerTaskManagerHeartbeatTimeout(ResourceID resourceID) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Let&apos;s not add this method which is only used for testing purposes to the production code. Instead, I would suggest to subclass `ResourceManager` in your test and add this method.&lt;/p&gt;</comment>
                            <comment id="16526564" author="githubbot" created="Thu, 28 Jun 2018 17:15:03 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6192#discussion_r198915014&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6192#discussion_r198915014&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/test/java/org/apache/flink/yarn/YarnResourceManagerTest.java &amp;#8212;&lt;br/&gt;
    @@ -421,4 +425,139 @@ public void testDeleteApplicationFiles() throws Exception {&lt;br/&gt;
     			assertFalse(&quot;YARN application directory was not removed&quot;, Files.exists(applicationDir.toPath()));&lt;br/&gt;
     		}};&lt;br/&gt;
     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testOnContainerCompleted() throws Exception {&lt;br/&gt;
    +		new Context() {{&lt;br/&gt;
    +			startResourceManager();&lt;br/&gt;
    +			CompletableFuture&amp;lt;?&amp;gt; registerSlotRequestFuture = resourceManager.runInMainThread(() -&amp;gt; &lt;/p&gt;
{
    +				rmServices.slotManager.registerSlotRequest(
    +					new SlotRequest(new JobID(), new AllocationID(), resourceProfile1, taskHost));
    +				return null;
    +			}
&lt;p&gt;);&lt;br/&gt;
    +			// wait for the registerSlotRequest completion&lt;br/&gt;
    +			registerSlotRequestFuture.get();&lt;br/&gt;
    +			// Callback from YARN when container is allocated.&lt;br/&gt;
    +			Container testingContainer = mock(Container.class);&lt;br/&gt;
    +			when(testingContainer.getId()).thenReturn(&lt;br/&gt;
    +				ContainerId.newInstance(&lt;br/&gt;
    +					ApplicationAttemptId.newInstance(&lt;br/&gt;
    +						ApplicationId.newInstance(System.currentTimeMillis(), 1),&lt;br/&gt;
    +						1),&lt;br/&gt;
    +					1));&lt;br/&gt;
    +			when(testingContainer.getNodeId()).thenReturn(NodeId.newInstance(&quot;container&quot;, 1234));&lt;br/&gt;
    +			when(testingContainer.getResource()).thenReturn(Resource.newInstance(200, 1));&lt;br/&gt;
    +			when(testingContainer.getPriority()).thenReturn(Priority.UNDEFINED);&lt;br/&gt;
    +&lt;br/&gt;
    +			ImmutableList&amp;lt;Container&amp;gt; testingContainerList = ImmutableList.of(testingContainer);&lt;br/&gt;
    +			resourceManager.onContainersAllocated(testingContainerList);&lt;br/&gt;
    +			verify(mockResourceManagerClient).addContainerRequest(any(AMRMClient.ContainerRequest.class));&lt;br/&gt;
    +			verify(mockNMClient).startContainer(eq(testingContainer), any(ContainerLaunchContext.class));&lt;br/&gt;
    +&lt;br/&gt;
    +			// Remote task executor registers with YarnResourceManager.&lt;br/&gt;
    +			TaskExecutorGateway mockTaskExecutorGateway = mock(TaskExecutorGateway.class);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Can we use the `TestingTaskExecutorGateway` here?&lt;/p&gt;</comment>
                            <comment id="16526565" author="githubbot" created="Thu, 28 Jun 2018 17:15:03 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6192#discussion_r198917467&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6192#discussion_r198917467&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -334,8 +335,11 @@ public void onContainersCompleted(final List&amp;lt;ContainerStatus&amp;gt; list) {&lt;br/&gt;
     					if (yarnWorkerNode != null) {&lt;br/&gt;
     						// Container completed unexpectedly ~&amp;gt; start a new one&lt;br/&gt;
     						final Container container = yarnWorkerNode.getContainer();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;requestYarnContainer(container.getResource(), yarnWorkerNode.getContainer().getPriority());&lt;/li&gt;
	&lt;li&gt;closeTaskManagerConnection(resourceId, new Exception(containerStatus.getDiagnostics()));&lt;br/&gt;
    +						// check WorkerRegistration status to avoid requesting containers more than required&lt;br/&gt;
    +						if (checkWorkerRegistrationWithResourceId(resourceId)) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Wouldn&apos;t that prevent container restarts if the container failure happened before the `TaskManager` registered at the `ResourceManager`, because then, `ResourceManager#taskExecutors` would not contain the given `ResourceID`?&lt;/p&gt;</comment>
                            <comment id="16527033" author="githubbot" created="Fri, 29 Jun 2018 01:57:47 +0000"  >&lt;p&gt;Github user Clarkkkkk commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6192#discussion_r199035236&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6192#discussion_r199035236&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -1120,5 +1120,28 @@ public void reportPayload(ResourceID resourceID, Void payload) &lt;/p&gt;
{
     			return CompletableFuture.completedFuture(null);
     		}
&lt;p&gt;     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	// ------------------------------------------------------------------------&lt;br/&gt;
    +	//  Work Registration status checking&lt;br/&gt;
    +	// ------------------------------------------------------------------------&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Check if the executor with given resourceID is still in taskExecutors map&lt;br/&gt;
    +	 * @param resourceID an ID mapping to a task executor&lt;br/&gt;
    +	 * @return&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	protected boolean checkWorkerRegistrationWithResourceId(ResourceID resourceID) {&lt;br/&gt;
    +		boolean status = taskExecutors.containsKey(resourceID);&lt;br/&gt;
    +		if (!status) {&lt;br/&gt;
    +			log.debug(&quot;No open TaskExecutor connection {}. Ignoring close TaskExecutor connection.&quot;, resourceID);&lt;br/&gt;
    +		}&lt;br/&gt;
    +		return status;&lt;br/&gt;
    +	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@VisibleForTesting&lt;br/&gt;
    +	public void triggerTaskManagerHeartbeatTimeout(ResourceID resourceID) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    OK.&lt;/p&gt;</comment>
                            <comment id="16527034" author="githubbot" created="Fri, 29 Jun 2018 01:58:06 +0000"  >&lt;p&gt;Github user Clarkkkkk commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6192#discussion_r199035271&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6192#discussion_r199035271&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/test/java/org/apache/flink/yarn/YarnResourceManagerTest.java &amp;#8212;&lt;br/&gt;
    @@ -421,4 +425,139 @@ public void testDeleteApplicationFiles() throws Exception {&lt;br/&gt;
     			assertFalse(&quot;YARN application directory was not removed&quot;, Files.exists(applicationDir.toPath()));&lt;br/&gt;
     		}};&lt;br/&gt;
     	}&lt;br/&gt;
    +&lt;br/&gt;
    +	@Test&lt;br/&gt;
    +	public void testOnContainerCompleted() throws Exception {&lt;br/&gt;
    +		new Context() {{&lt;br/&gt;
    +			startResourceManager();&lt;br/&gt;
    +			CompletableFuture&amp;lt;?&amp;gt; registerSlotRequestFuture = resourceManager.runInMainThread(() -&amp;gt; &lt;/p&gt;
{
    +				rmServices.slotManager.registerSlotRequest(
    +					new SlotRequest(new JobID(), new AllocationID(), resourceProfile1, taskHost));
    +				return null;
    +			}
&lt;p&gt;);&lt;br/&gt;
    +			// wait for the registerSlotRequest completion&lt;br/&gt;
    +			registerSlotRequestFuture.get();&lt;br/&gt;
    +			// Callback from YARN when container is allocated.&lt;br/&gt;
    +			Container testingContainer = mock(Container.class);&lt;br/&gt;
    +			when(testingContainer.getId()).thenReturn(&lt;br/&gt;
    +				ContainerId.newInstance(&lt;br/&gt;
    +					ApplicationAttemptId.newInstance(&lt;br/&gt;
    +						ApplicationId.newInstance(System.currentTimeMillis(), 1),&lt;br/&gt;
    +						1),&lt;br/&gt;
    +					1));&lt;br/&gt;
    +			when(testingContainer.getNodeId()).thenReturn(NodeId.newInstance(&quot;container&quot;, 1234));&lt;br/&gt;
    +			when(testingContainer.getResource()).thenReturn(Resource.newInstance(200, 1));&lt;br/&gt;
    +			when(testingContainer.getPriority()).thenReturn(Priority.UNDEFINED);&lt;br/&gt;
    +&lt;br/&gt;
    +			ImmutableList&amp;lt;Container&amp;gt; testingContainerList = ImmutableList.of(testingContainer);&lt;br/&gt;
    +			resourceManager.onContainersAllocated(testingContainerList);&lt;br/&gt;
    +			verify(mockResourceManagerClient).addContainerRequest(any(AMRMClient.ContainerRequest.class));&lt;br/&gt;
    +			verify(mockNMClient).startContainer(eq(testingContainer), any(ContainerLaunchContext.class));&lt;br/&gt;
    +&lt;br/&gt;
    +			// Remote task executor registers with YarnResourceManager.&lt;br/&gt;
    +			TaskExecutorGateway mockTaskExecutorGateway = mock(TaskExecutorGateway.class);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Sure, I will modify it later.&lt;/p&gt;</comment>
                            <comment id="16527046" author="githubbot" created="Fri, 29 Jun 2018 02:13:36 +0000"  >&lt;p&gt;Github user Clarkkkkk commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6192#discussion_r199036840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6192#discussion_r199036840&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -334,8 +335,11 @@ public void onContainersCompleted(final List&amp;lt;ContainerStatus&amp;gt; list) {&lt;br/&gt;
     					if (yarnWorkerNode != null) {&lt;br/&gt;
     						// Container completed unexpectedly ~&amp;gt; start a new one&lt;br/&gt;
     						final Container container = yarnWorkerNode.getContainer();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;requestYarnContainer(container.getResource(), yarnWorkerNode.getContainer().getPriority());&lt;/li&gt;
	&lt;li&gt;closeTaskManagerConnection(resourceId, new Exception(containerStatus.getDiagnostics()));&lt;br/&gt;
    +						// check WorkerRegistration status to avoid requesting containers more than required&lt;br/&gt;
    +						if (checkWorkerRegistrationWithResourceId(resourceId)) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Yes, I might happen. The problem is not as easy as I thought. The actual cause of this problem is the resource was released before a full restart but the onContainerCompleted callback method happened after the full restart. As the full restart will requesting all the containers needed as configured, if the onContainerCompleted  method was called after that, it will request for a new container and possess it which is not needed.&lt;/p&gt;</comment>
                            <comment id="16527655" author="githubbot" created="Fri, 29 Jun 2018 13:53:49 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6192#discussion_r199166104&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6192#discussion_r199166104&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -334,8 +335,11 @@ public void onContainersCompleted(final List&amp;lt;ContainerStatus&amp;gt; list) {&lt;br/&gt;
     					if (yarnWorkerNode != null) {&lt;br/&gt;
     						// Container completed unexpectedly ~&amp;gt; start a new one&lt;br/&gt;
     						final Container container = yarnWorkerNode.getContainer();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;requestYarnContainer(container.getResource(), yarnWorkerNode.getContainer().getPriority());&lt;/li&gt;
	&lt;li&gt;closeTaskManagerConnection(resourceId, new Exception(containerStatus.getDiagnostics()));&lt;br/&gt;
    +						// check WorkerRegistration status to avoid requesting containers more than required&lt;br/&gt;
    +						if (checkWorkerRegistrationWithResourceId(resourceId)) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Yes, I think it is not possible to distinguish between a container which was released but has not been completed before a recovery and a container failure just after recovery without some kind of state (in both cases we retrieve the containers from the previous attempt and get a onContainerCompleted signal from the container).&lt;/p&gt;

&lt;p&gt;    My question would be how often does it happen that we run into this situation. Releasing a container and failing immediately afterwards should happen fairly rarely, I would assume. Moreover, at some point the an idle `TaskManager` should be released and, thus, also the underlying container.&lt;/p&gt;</comment>
                            <comment id="16527657" author="githubbot" created="Fri, 29 Jun 2018 13:59:41 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6192#discussion_r199168161&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6192#discussion_r199168161&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -334,8 +335,11 @@ public void onContainersCompleted(final List&amp;lt;ContainerStatus&amp;gt; list) {&lt;br/&gt;
     					if (yarnWorkerNode != null) {&lt;br/&gt;
     						// Container completed unexpectedly ~&amp;gt; start a new one&lt;br/&gt;
     						final Container container = yarnWorkerNode.getContainer();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;requestYarnContainer(container.getResource(), yarnWorkerNode.getContainer().getPriority());&lt;/li&gt;
	&lt;li&gt;closeTaskManagerConnection(resourceId, new Exception(containerStatus.getDiagnostics()));&lt;br/&gt;
    +						// check WorkerRegistration status to avoid requesting containers more than required&lt;br/&gt;
    +						if (checkWorkerRegistrationWithResourceId(resourceId)) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    What we maybe could do instead of counting simply how many pending container requests we have is to ask the `SlotManager` how many pending slot allocations it has. If the number of slot allocations is lower than the product of slots per task manager x pending container requests, then we would not have to restart the container.&lt;/p&gt;</comment>
                            <comment id="16527769" author="githubbot" created="Fri, 29 Jun 2018 15:06:30 +0000"  >&lt;p&gt;Github user Clarkkkkk commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6192#discussion_r199189703&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6192#discussion_r199189703&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -334,8 +335,11 @@ public void onContainersCompleted(final List&amp;lt;ContainerStatus&amp;gt; list) {&lt;br/&gt;
     					if (yarnWorkerNode != null) {&lt;br/&gt;
     						// Container completed unexpectedly ~&amp;gt; start a new one&lt;br/&gt;
     						final Container container = yarnWorkerNode.getContainer();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;requestYarnContainer(container.getResource(), yarnWorkerNode.getContainer().getPriority());&lt;/li&gt;
	&lt;li&gt;closeTaskManagerConnection(resourceId, new Exception(containerStatus.getDiagnostics()));&lt;br/&gt;
    +						// check WorkerRegistration status to avoid requesting containers more than required&lt;br/&gt;
    +						if (checkWorkerRegistrationWithResourceId(resourceId)) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Yes, you are right. I have been thinking about how to add a global version state to a container all the week, but feels like I came into a dead end. I found this question when there are higher priority batch job in yarn cluster which occupied all the resources and made yarn kill the flink task manager containers frequently in a period of time. &lt;/p&gt;</comment>
                            <comment id="16527770" author="githubbot" created="Fri, 29 Jun 2018 15:07:58 +0000"  >&lt;p&gt;Github user Clarkkkkk commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6192#discussion_r199190175&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6192#discussion_r199190175&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -334,8 +335,11 @@ public void onContainersCompleted(final List&amp;lt;ContainerStatus&amp;gt; list) {&lt;br/&gt;
     					if (yarnWorkerNode != null) {&lt;br/&gt;
     						// Container completed unexpectedly ~&amp;gt; start a new one&lt;br/&gt;
     						final Container container = yarnWorkerNode.getContainer();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;requestYarnContainer(container.getResource(), yarnWorkerNode.getContainer().getPriority());&lt;/li&gt;
	&lt;li&gt;closeTaskManagerConnection(resourceId, new Exception(containerStatus.getDiagnostics()));&lt;br/&gt;
    +						// check WorkerRegistration status to avoid requesting containers more than required&lt;br/&gt;
    +						if (checkWorkerRegistrationWithResourceId(resourceId)) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I will work on the implementation of the idea you mentioned above which makes perfect sense to me.&lt;/p&gt;</comment>
                            <comment id="16529321" author="githubbot" created="Mon, 2 Jul 2018 01:46:01 +0000"  >&lt;p&gt;Github user Clarkkkkk closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6192&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6192&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16529560" author="githubbot" created="Mon, 2 Jul 2018 08:59:43 +0000"  >&lt;p&gt;GitHub user Clarkkkkk opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6237&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9567&quot; title=&quot;Flink does not release resource in Yarn Cluster mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9567&quot;&gt;&lt;del&gt;FLINK-9567&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;yarn&amp;#93;&lt;/span&gt; Fix the bug that Flink does not release YarnContainer in some cases&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;This pull request responds to  &lt;span class=&quot;error&quot;&gt;&amp;#91;JIRA issue FLINK-9567&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9567&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-9567&lt;/a&gt;).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;This pull request is to avoid flink system from not releasing excessive container when Yarn Callback onContainerCompleted was called after a full restart.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Modify the onContainerCompleted method in YarnResourceManager.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Add a getNumberPendingSlotRequests in SlotManager that check how many pending slot requests are not fulfilled&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Add a getNumberPendingSlotRequests in ResourceManager that get pending slot requests from SlotManager&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;br/&gt;
    This  change is covered by testOnContainerCompleted added in YarnResourceManagerTest&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with&#160;@Public(Evolving): (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (yes)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (No)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/Clarkkkkk/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Clarkkkkk/flink&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6237.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6237.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #6237&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 92086f1c56d9d170619fae170aed092e075c7c63&lt;br/&gt;
Author: yangshimin &amp;lt;yangshimin@...&amp;gt;&lt;br/&gt;
Date:   2018-07-02T03:56:00Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9567&quot; title=&quot;Flink does not release resource in Yarn Cluster mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9567&quot;&gt;&lt;del&gt;FLINK-9567&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;yarn&amp;#93;&lt;/span&gt; Fix the bug that Flink does not release Yarn container when onContainerCompleted callback method happened after full restart&lt;/p&gt;

&lt;p&gt;    a&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9567&quot; title=&quot;Flink does not release resource in Yarn Cluster mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9567&quot;&gt;&lt;del&gt;FLINK-9567&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;yarn&amp;#93;&lt;/span&gt; Fix the bug that Flink does not release Yarn container when onContainerCompleted callback method happened after full restart&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16529722" author="githubbot" created="Mon, 2 Jul 2018 11:20:27 +0000"  >&lt;p&gt;Github user Clarkkkkk commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6237&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @tillrohrmann Hi Till, I fix this bug according to the idea you mentioned on last conversation we had.&lt;/p&gt;</comment>
                            <comment id="16530477" author="till.rohrmann" created="Mon, 2 Jul 2018 21:51:55 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
1.6.0: 49156e8d6c2cb223e350760ad69d1898d67dacab&lt;br/&gt;
1.5.1: 4b0aca5681e749cc8b0389d389e1fac736653eb5&lt;/p&gt;</comment>
                            <comment id="16530478" author="githubbot" created="Mon, 2 Jul 2018 21:52:25 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/6237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6237&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16606629" author="dangdangdang" created="Fri, 7 Sep 2018 02:04:24 +0000"  >&lt;p&gt;This issue also occurs while using region strategy. In that case the pending slot should also be checked during start new worker and on container allocated before request a new Yarn container.&lt;/p&gt;</comment>
                            <comment id="16606632" author="githubbot" created="Fri, 7 Sep 2018 02:13:04 +0000"  >&lt;p&gt;Clarkkkkk opened a new pull request #6669: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9567&quot; title=&quot;Flink does not release resource in Yarn Cluster mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9567&quot;&gt;&lt;del&gt;FLINK-9567&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;yarn&amp;#93;&lt;/span&gt; Fix the yarn container over allocation in&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6669&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6669&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;Second commit for Flink-9567.&lt;br/&gt;
   The first commit ignore the region failover strategy could also cause the yarn container overallocation. This PR is a supplement for #6237 &lt;br/&gt;
   All the changes are already covered by tests in YarnResourceManagerTest.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16606634" author="githubbot" created="Fri, 7 Sep 2018 02:15:03 +0000"  >&lt;p&gt;Clarkkkkk commented on issue #6669: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9567&quot; title=&quot;Flink does not release resource in Yarn Cluster mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9567&quot;&gt;&lt;del&gt;FLINK-9567&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;yarn&amp;#93;&lt;/span&gt; Fix the yarn container over allocation in&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6669#issuecomment-419298559&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6669#issuecomment-419298559&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   cc @tillrohrmann Could you review this after travis gives green light?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16606672" author="githubbot" created="Fri, 7 Sep 2018 03:42:43 +0000"  >&lt;p&gt;yanghua commented on issue #6669: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9567&quot; title=&quot;Flink does not release resource in Yarn Cluster mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9567&quot;&gt;&lt;del&gt;FLINK-9567&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;yarn&amp;#93;&lt;/span&gt; Fix the yarn container over allocation in&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6669#issuecomment-419313241&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6669#issuecomment-419313241&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   +1&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16607931" author="githubbot" created="Sat, 8 Sep 2018 06:52:32 +0000"  >&lt;p&gt;Clarkkkkk commented on issue #6669: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9567&quot; title=&quot;Flink does not release resource in Yarn Cluster mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9567&quot;&gt;&lt;del&gt;FLINK-9567&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;yarn&amp;#93;&lt;/span&gt; Fix the yarn container over allocation in&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6669#issuecomment-419618422&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6669#issuecomment-419618422&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @TisonKun Thank you for your advice.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16623207" author="githubbot" created="Fri, 21 Sep 2018 07:40:52 +0000"  >&lt;p&gt;asfgit closed pull request #6669: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-9567&quot; title=&quot;Flink does not release resource in Yarn Cluster mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-9567&quot;&gt;&lt;del&gt;FLINK-9567&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;yarn&amp;#93;&lt;/span&gt; Fix the yarn container over allocation in&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6669&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6669&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java b/flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java&lt;br/&gt;
index cf3588f6593..956e40fe61b 100644&lt;br/&gt;
&amp;#8212; a/flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java&lt;br/&gt;
+++ b/flink-yarn/src/main/java/org/apache/flink/yarn/YarnResourceManager.java&lt;br/&gt;
@@ -334,7 +334,7 @@ public void onContainersCompleted(final List&amp;lt;ContainerStatus&amp;gt; statuses) {&lt;br/&gt;
 					if (yarnWorkerNode != null) &lt;/p&gt;
{
 						// Container completed unexpectedly ~&amp;gt; start a new one
 						final Container container = yarnWorkerNode.getContainer();
-						internalRequestYarnContainer(container.getResource(), yarnWorkerNode.getContainer().getPriority());
+						requestYarnContainer(container.getResource(), yarnWorkerNode.getContainer().getPriority());
 					}
&lt;p&gt; 					// Eagerly close the connection with task manager.&lt;br/&gt;
 					closeTaskManagerConnection(resourceId, new Exception(containerStatus.getDiagnostics()));&lt;br/&gt;
@@ -443,17 +443,24 @@ private FinalApplicationStatus getYarnStatus(ApplicationStatus status) &lt;/p&gt;
{
 		return new Tuple2&amp;lt;&amp;gt;(host, Integer.valueOf(port));
 	}

&lt;p&gt;+	/**&lt;br/&gt;
+	 * Request new container if pending containers cannot satisfies pending slot requests.&lt;br/&gt;
+	 */&lt;br/&gt;
 	private void requestYarnContainer(Resource resource, Priority priority) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;resourceManagerClient.addContainerRequest(new AMRMClient.ContainerRequest(resource, null, null, priority));&lt;br/&gt;
+		int pendingSlotRequests = getNumberPendingSlotRequests();&lt;br/&gt;
+		int pendingSlotAllocation = numPendingContainerRequests * numberOfTaskSlots;&lt;br/&gt;
+		if (pendingSlotRequests &amp;gt; pendingSlotAllocation) {&lt;br/&gt;
+			resourceManagerClient.addContainerRequest(new AMRMClient.ContainerRequest(resource, null, null, priority));&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// make sure we transmit the request fast and receive fast news of granted allocations&lt;/li&gt;
	&lt;li&gt;resourceManagerClient.setHeartbeatInterval(FAST_YARN_HEARTBEAT_INTERVAL_MS);&lt;br/&gt;
+			// make sure we transmit the request fast and receive fast news of granted allocations&lt;br/&gt;
+			resourceManagerClient.setHeartbeatInterval(FAST_YARN_HEARTBEAT_INTERVAL_MS);&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;numPendingContainerRequests++;&lt;br/&gt;
+			numPendingContainerRequests++;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;log.info(&quot;Requesting new TaskExecutor container with resources {}. Number pending requests {}.&quot;,&lt;/li&gt;
	&lt;li&gt;resource,&lt;/li&gt;
	&lt;li&gt;numPendingContainerRequests);&lt;br/&gt;
+			log.info(&quot;Requesting new TaskExecutor container with resources {}. Number pending requests {}.&quot;,&lt;br/&gt;
+				resource,&lt;br/&gt;
+				numPendingContainerRequests);&lt;br/&gt;
+		}&lt;br/&gt;
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	private ContainerLaunchContext createTaskExecutorLaunchContext(Resource resource, String containerId, String host)&lt;br/&gt;
@@ -510,15 +517,4 @@ private int generatePriority(ResourceProfile resourceProfile) &lt;/p&gt;
{
 			return priority;
 		}
&lt;p&gt; 	}&lt;br/&gt;
-&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/**&lt;/li&gt;
	&lt;li&gt;* Request new container if pending containers cannot satisfies pending slot requests.&lt;/li&gt;
	&lt;li&gt;*/&lt;/li&gt;
	&lt;li&gt;private void internalRequestYarnContainer(Resource resource, Priority priority) {&lt;/li&gt;
	&lt;li&gt;int pendingSlotRequests = getNumberPendingSlotRequests();&lt;/li&gt;
	&lt;li&gt;int pendingSlotAllocation = numPendingContainerRequests * numberOfTaskSlots;&lt;/li&gt;
	&lt;li&gt;if (pendingSlotRequests &amp;gt; pendingSlotAllocation) 
{
-			requestYarnContainer(resource, priority);
-		}&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
 }&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16623326" author="till.rohrmann" created="Fri, 21 Sep 2018 09:26:35 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
1.7.0: 0cf776be4483e7f939de0a7f2b1fe3263a14c6fb&lt;br/&gt;
1.6.2: 806d3a424c0ad66f49282d0496599597d0f9f0c0&lt;br/&gt;
1.5.5: 69cae4f6daf6580ca83c452c7c3ad33489551a36&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12927916" name="FlinkYarnProblem" size="132812" author="dangdangdang" created="Fri, 15 Jun 2018 02:26:56 +0000"/>
                            <attachment id="12927917" name="fulllog.txt" size="44037038" author="dangdangdang" created="Fri, 15 Jun 2018 02:27:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 8 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3uq07:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>