<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:35:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-10469] FileChannel may not write the whole buffer in a single call to FileChannel.write(Buffer buffer)</title>
                <link>https://issues.apache.org/jira/browse/FLINK-10469</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Currently all the calls to&#160;&lt;em&gt;FileChannel.write(ByteBuffer src)&lt;/em&gt;&#160;assumes that this method will not return before&#160;the whole buffer is written, like the one in&#160;&lt;em&gt;AsynchronousFileIOChannel.write().&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;However, this assumption may not be right for all the environments. We have encountered the case that only part of a buffer was written on a cluster with a&#160;high IO load, and the target&#160;file&#160;got&#160;messy.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;To fix this issue, I think we should add a utility method in the&#160;org.apache.flink.util.IOUtils to ensure the whole buffer is written with a loop&#65292;and replace all the calls to &lt;em&gt;FileChannel.write(ByteBuffer)&lt;/em&gt;&#160;with&#160;this new method.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13188447">FLINK-10469</key>
            <summary>FileChannel may not write the whole buffer in a single call to FileChannel.write(Buffer buffer)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nkruber">Nico Kruber</assignee>
                                    <reporter username="gaoyunhaii">Yun Gao</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 1 Oct 2018 05:22:25 +0000</created>
                <updated>Thu, 28 Feb 2019 13:20:28 +0000</updated>
                            <resolved>Tue, 9 Oct 2018 16:17:01 +0000</resolved>
                                    <version>1.4.1</version>
                    <version>1.4.2</version>
                    <version>1.5.3</version>
                    <version>1.5.4</version>
                    <version>1.6.0</version>
                    <version>1.6.1</version>
                    <version>1.6.2</version>
                    <version>1.7.0</version>
                                    <fixVersion>1.5.5</fixVersion>
                    <fixVersion>1.6.2</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                                    <component>Runtime / Network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16633622" author="maguowei" created="Mon, 1 Oct 2018 05:35:05 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16633639" author="tison" created="Mon, 1 Oct 2018 06:25:23 +0000"  >&lt;p&gt;Sounds reasonable. Maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=NicoK&quot; class=&quot;user-hover&quot; rel=&quot;NicoK&quot;&gt;NicoK&lt;/a&gt; could provide more professional advice.&lt;/p&gt;</comment>
                            <comment id="16635176" author="nicok" created="Tue, 2 Oct 2018 09:03:19 +0000"  >&lt;p&gt;That&apos;s actually a very critical bug you discovered and may explain one or two things I saw in the field. How did you discover it is related to the &lt;tt&gt;FileChannel.write(ByteBuffer)&lt;/tt&gt; and that adding a loop helps?&lt;/p&gt;</comment>
                            <comment id="16635180" author="pnowojski" created="Tue, 2 Oct 2018 09:16:16 +0000"  >&lt;p&gt;Good find &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt;. Can you fix it within next 2 weeks so that this can make it to 1.7.0?&lt;/p&gt;</comment>
                            <comment id="16636085" author="githubbot" created="Tue, 2 Oct 2018 20:35:03 +0000"  >&lt;p&gt;NicoK opened a new pull request #6788: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10469&quot; title=&quot;FileChannel may not write the whole buffer in a single call to FileChannel.write(Buffer buffer)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10469&quot;&gt;&lt;del&gt;FLINK-10469&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; make sure to always write the whole buffer to FileChannel&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6788&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6788&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   Currently all the calls to one of the `FileChannel.write()` methods assume that this method will not return before the whole buffer is written, like the one in `AsynchronousFileIOChannel.write()`. However, this assumption may not be right for all the environments and there is no such guarantee. &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;add `FileUtils#writeCompletely()` that loops through the provided buffer until it is completely written&lt;/li&gt;
	&lt;li&gt;adapt all uses of `FileChannel.write()` to use this helper method&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   No tests were added.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does it make sense to test the utility method? no, the functionality is too basic&lt;/li&gt;
	&lt;li&gt;Previously existing tests for writing to a `FileChannel` apparently only covered complete writes through a single call (no failed tests afaik). Extending them may be difficult difficult (`FileChannel` usually internal, need to override it to force the behaviour) and potentially not necessary either - waiting for a second opinion here.&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The serializers: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): *&lt;b&gt;no&lt;/b&gt;* (per buffer written to disk)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? *&lt;b&gt;no&lt;/b&gt;*&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? *&lt;b&gt;not documented&lt;/b&gt;*&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16636087" author="nicok" created="Tue, 2 Oct 2018 20:36:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt; I hacked something together - only tests are missing so far (don&apos;t know whether there should be any). Please have a look whether this is what you had in mind.&lt;/p&gt;</comment>
                            <comment id="16637269" author="githubbot" created="Wed, 3 Oct 2018 17:37:03 +0000"  >&lt;p&gt;isunjin commented on a change in pull request #6788: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10469&quot; title=&quot;FileChannel may not write the whole buffer in a single call to FileChannel.write(Buffer buffer)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10469&quot;&gt;&lt;del&gt;FLINK-10469&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; make sure to always write the whole buffer to FileChannel&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6788#discussion_r222400575&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6788#discussion_r222400575&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/io/disk/iomanager/AsynchronousFileIOChannel.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -28,6 +28,7 @@&lt;br/&gt;
 import java.util.concurrent.atomic.AtomicBoolean;&lt;br/&gt;
 import java.util.concurrent.atomic.AtomicInteger;&lt;/p&gt;

&lt;p&gt;+import static org.apache.flink.util.FileUtils.writeCompletely;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   i would avoid import static&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16637270" author="githubbot" created="Wed, 3 Oct 2018 17:37:31 +0000"  >&lt;p&gt;isunjin commented on a change in pull request #6788: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10469&quot; title=&quot;FileChannel may not write the whole buffer in a single call to FileChannel.write(Buffer buffer)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10469&quot;&gt;&lt;del&gt;FLINK-10469&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; make sure to always write the whole buffer to FileChannel&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6788#discussion_r222400725&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6788#discussion_r222400725&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/serialization/SpillingAdaptiveSpanningRecordDeserializer.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -39,6 +39,8 @@&lt;br/&gt;
 import java.util.Arrays;&lt;br/&gt;
 import java.util.Random;&lt;/p&gt;

&lt;p&gt;+import static org.apache.flink.util.FileUtils.writeCompletely;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   i would avoid import static&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16637271" author="githubbot" created="Wed, 3 Oct 2018 17:37:40 +0000"  >&lt;p&gt;isunjin commented on a change in pull request #6788: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10469&quot; title=&quot;FileChannel may not write the whole buffer in a single call to FileChannel.write(Buffer buffer)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10469&quot;&gt;&lt;del&gt;FLINK-10469&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; make sure to always write the whole buffer to FileChannel&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6788#discussion_r222400795&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6788#discussion_r222400795&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/BufferSpiller.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -38,6 +38,8 @@&lt;br/&gt;
 import java.util.concurrent.ThreadLocalRandom;&lt;br/&gt;
 import java.util.concurrent.atomic.AtomicInteger;&lt;/p&gt;

&lt;p&gt;+import static org.apache.flink.util.FileUtils.writeCompletely;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   i would avoid import static&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16638121" author="gaoyunhaii" created="Thu, 4 Oct 2018 12:02:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=NicoK&quot; class=&quot;user-hover&quot; rel=&quot;NicoK&quot;&gt;NicoK&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;Sorry for responding later. I found the problem by accidentally adding logs to test whether the whole buffer is written when I want to solve a problem of failing to deserialized files. I will view the&#160;pull request by Nico&#160;as soon as possible.&#160; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16638378" author="gaoyunhaii" created="Thu, 4 Oct 2018 15:24:25 +0000"  >&lt;p&gt;I commented on the pull request, but it seems that the comment fails to be synchronized here, so I copied it here manually. Sorry if repeat emails are received. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;==================================================================================&lt;/p&gt;

&lt;p&gt;This is consistent with what I had in mind. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I also checked other calls to WritableByteChannel.write(ByteBuffer), the only calls left unchanged are the ones in NetworkBuffer.getBytes() and AbstractByteBufTest.write(). I agree not to change them referring to the other implementations of ByteBuf in Netty.&lt;/p&gt;

&lt;p&gt;For the testing, the existing tests seem to have covered the writeComplete method from the upper level scenarios, and do you think it is still necessary to add a test for writeComplete itself? We may mock a channel who only writes half of a buffer at one time and assert the whole buffer is written in a single call to writeComplete.&lt;/p&gt;</comment>
                            <comment id="16642965" author="githubbot" created="Tue, 9 Oct 2018 08:31:32 +0000"  >&lt;p&gt;pnowojski commented on a change in pull request #6788: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10469&quot; title=&quot;FileChannel may not write the whole buffer in a single call to FileChannel.write(Buffer buffer)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10469&quot;&gt;&lt;del&gt;FLINK-10469&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; make sure to always write the whole buffer to FileChannel&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6788#discussion_r223602597&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6788#discussion_r223602597&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-runtime/src/main/java/org/apache/flink/runtime/io/disk/iomanager/AsynchronousFileIOChannel.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -28,6 +28,7 @@&lt;br/&gt;
 import java.util.concurrent.atomic.AtomicBoolean;&lt;br/&gt;
 import java.util.concurrent.atomic.AtomicInteger;&lt;/p&gt;

&lt;p&gt;+import static org.apache.flink.util.FileUtils.writeCompletely;&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   I would slightly lean towards avoiding it as well. But I won&apos;t argue about this.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16643474" author="githubbot" created="Tue, 9 Oct 2018 13:58:59 +0000"  >&lt;p&gt;NicoK commented on issue #6788: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10469&quot; title=&quot;FileChannel may not write the whole buffer in a single call to FileChannel.write(Buffer buffer)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10469&quot;&gt;&lt;del&gt;FLINK-10469&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; make sure to always write the whole buffer to FileChannel&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6788#issuecomment-428202717&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6788#issuecomment-428202717&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks @isunjin, @gaoyunhaii, @pnowojski for your reviews - and sorry @gaoyunhaii for taking over - I wanted to verify that this is indeed fixing the problems I&apos;ve seen and needed the patch urgently - to avoid double work, I created the PR immediately.&lt;/p&gt;

&lt;p&gt;   I integrated your comments and will merge once a new Travis build gives its ok.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16643685" author="githubbot" created="Tue, 9 Oct 2018 16:13:20 +0000"  >&lt;p&gt;NicoK closed pull request #6788: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10469&quot; title=&quot;FileChannel may not write the whole buffer in a single call to FileChannel.write(Buffer buffer)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10469&quot;&gt;&lt;del&gt;FLINK-10469&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; make sure to always write the whole buffer to FileChannel&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6788&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6788&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-core/src/main/java/org/apache/flink/util/FileUtils.java b/flink-core/src/main/java/org/apache/flink/util/FileUtils.java&lt;br/&gt;
index 23af2e8cf84..8f322626116 100644&lt;br/&gt;
&amp;#8212; a/flink-core/src/main/java/org/apache/flink/util/FileUtils.java&lt;br/&gt;
+++ b/flink-core/src/main/java/org/apache/flink/util/FileUtils.java&lt;br/&gt;
@@ -28,6 +28,8 @@&lt;br/&gt;
 import java.io.File;&lt;br/&gt;
 import java.io.FileNotFoundException;&lt;br/&gt;
 import java.io.IOException;&lt;br/&gt;
+import java.nio.ByteBuffer;&lt;br/&gt;
+import java.nio.channels.WritableByteChannel;&lt;br/&gt;
 import java.nio.file.AccessDeniedException;&lt;br/&gt;
 import java.nio.file.Files;&lt;br/&gt;
 import java.nio.file.StandardOpenOption;&lt;br/&gt;
@@ -56,6 +58,14 @@&lt;/p&gt;

&lt;p&gt; 	// ------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;+	public static void writeCompletely(WritableByteChannel channel, ByteBuffer src) throws IOException {&lt;br/&gt;
+		while (src.hasRemaining()) &lt;/p&gt;
{
+			channel.write(src);
+		}
&lt;p&gt;+	}&lt;br/&gt;
+&lt;br/&gt;
+	// ------------------------------------------------------------------------&lt;br/&gt;
+&lt;br/&gt;
 	/**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Constructs a random filename with the given prefix and&lt;/li&gt;
	&lt;li&gt;a random part generated from hex characters.&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/disk/iomanager/AsynchronousFileIOChannel.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/disk/iomanager/AsynchronousFileIOChannel.java&lt;br/&gt;
index 0e575d3021a..ddb0c4e839d 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-runtime/src/main/java/org/apache/flink/runtime/io/disk/iomanager/AsynchronousFileIOChannel.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/disk/iomanager/AsynchronousFileIOChannel.java&lt;br/&gt;
@@ -21,6 +21,7 @@&lt;br/&gt;
 import org.apache.flink.core.memory.MemorySegment;&lt;br/&gt;
 import org.apache.flink.runtime.io.network.buffer.Buffer;&lt;br/&gt;
 import org.apache.flink.runtime.util.event.NotificationListener;&lt;br/&gt;
+import org.apache.flink.util.FileUtils;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import java.io.IOException;&lt;br/&gt;
 import java.nio.ByteBuffer;&lt;br/&gt;
@@ -341,7 +342,7 @@ protected SegmentWriteRequest(AsynchronousFileIOChannel&amp;lt;MemorySegment, WriteRequ&lt;br/&gt;
 	@Override&lt;br/&gt;
 	public void write() throws IOException {&lt;br/&gt;
 		try &lt;/p&gt;
{
-			this.channel.fileChannel.write(this.segment.wrap(0, this.segment.size()));
+			FileUtils.writeCompletely(this.channel.fileChannel, this.segment.wrap(0, this.segment.size()));
 		}
&lt;p&gt; 		catch (NullPointerException npex) {&lt;br/&gt;
 			throw new IOException(&quot;Memory segment has been released.&quot;);&lt;br/&gt;
@@ -375,8 +376,8 @@ public void write() throws IOException &lt;/p&gt;
{
 		header.putInt(nioBufferReadable.remaining());
 		header.flip();
 
-		channel.fileChannel.write(header);
-		channel.fileChannel.write(nioBufferReadable);
+		FileUtils.writeCompletely(channel.fileChannel, header);
+		FileUtils.writeCompletely(channel.fileChannel, nioBufferReadable);
 	}

&lt;p&gt; 	@Override&lt;br/&gt;
diff --git a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/serialization/SpillingAdaptiveSpanningRecordDeserializer.java b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/serialization/SpillingAdaptiveSpanningRecordDeserializer.java&lt;br/&gt;
index 8630acee9a8..a78cb4dd708 100644&lt;br/&gt;
&amp;#8212; a/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/serialization/SpillingAdaptiveSpanningRecordDeserializer.java&lt;br/&gt;
+++ b/flink-runtime/src/main/java/org/apache/flink/runtime/io/network/api/serialization/SpillingAdaptiveSpanningRecordDeserializer.java&lt;br/&gt;
@@ -24,6 +24,7 @@&lt;br/&gt;
 import org.apache.flink.core.memory.DataInputViewStreamWrapper;&lt;br/&gt;
 import org.apache.flink.core.memory.MemorySegment;&lt;br/&gt;
 import org.apache.flink.runtime.io.network.buffer.Buffer;&lt;br/&gt;
+import org.apache.flink.util.FileUtils;&lt;br/&gt;
 import org.apache.flink.util.StringUtils;&lt;/p&gt;

&lt;p&gt; import java.io.BufferedInputStream;&lt;br/&gt;
@@ -481,7 +482,7 @@ private void initializeWithPartialRecord(NonSpanningWrapper partial, int nextRec&lt;br/&gt;
 				this.spillingChannel = createSpillingChannel();&lt;/p&gt;

&lt;p&gt; 				ByteBuffer toWrite = partial.segment.wrap(partial.position, numBytesChunk);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;this.spillingChannel.write(toWrite);&lt;br/&gt;
+				FileUtils.writeCompletely(this.spillingChannel, toWrite);&lt;br/&gt;
 			}&lt;br/&gt;
 			else {&lt;br/&gt;
 				// collect in memory&lt;br/&gt;
@@ -528,7 +529,7 @@ private void addNextChunkFromMemorySegment(MemorySegment segment, int offset, in&lt;br/&gt;
 			if (spillingChannel != null) 
{
 				// spill to file
 				ByteBuffer toWrite = segment.wrap(segmentPosition, toCopy);
-				this.spillingChannel.write(toWrite);
+				FileUtils.writeCompletely(this.spillingChannel, toWrite);
 			}
&lt;p&gt; else &lt;/p&gt;
{
 				segment.get(segmentPosition, buffer, this.accumulatedRecordBytes, toCopy);
 			}
&lt;p&gt;diff --git a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/BufferSpiller.java b/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/BufferSpiller.java&lt;br/&gt;
index 4b690d1f750..ae95408af44 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/BufferSpiller.java&lt;br/&gt;
+++ b/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/BufferSpiller.java&lt;br/&gt;
@@ -27,6 +27,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.io.network.buffer.FreeingBufferRecycler;&lt;br/&gt;
 import org.apache.flink.runtime.io.network.buffer.NetworkBuffer;&lt;br/&gt;
 import org.apache.flink.runtime.io.network.partition.consumer.BufferOrEvent;&lt;br/&gt;
+import org.apache.flink.util.FileUtils;&lt;br/&gt;
 import org.apache.flink.util.StringUtils;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; import java.io.File;&lt;br/&gt;
@@ -75,9 +76,6 @@&lt;br/&gt;
 	/** The buffer that encodes the spilled header. */&lt;br/&gt;
 	private final ByteBuffer headBuffer;&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;/** The reusable array that holds header and contents buffers. */&lt;/li&gt;
	&lt;li&gt;private final ByteBuffer[] sources;&lt;br/&gt;
-&lt;br/&gt;
 	/** The file that we currently spill to. */&lt;br/&gt;
 	private File currentSpillFile;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -109,8 +107,6 @@ public BufferSpiller(IOManager ioManager, int pageSize) throws IOException {&lt;br/&gt;
 		this.headBuffer = ByteBuffer.allocateDirect(16);&lt;br/&gt;
 		this.headBuffer.order(ByteOrder.LITTLE_ENDIAN);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;this.sources = new ByteBuffer[] 
{ this.headBuffer, null }
&lt;p&gt;;&lt;br/&gt;
-&lt;br/&gt;
 		File[] tempDirs = ioManager.getSpillingDirectories();&lt;br/&gt;
 		this.tempDir = tempDirs&lt;span class=&quot;error&quot;&gt;&amp;#91;DIRECTORY_INDEX.getAndIncrement() % tempDirs.length&amp;#93;&lt;/span&gt;;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;@@ -148,8 +144,8 @@ public void add(BufferOrEvent boe) throws IOException &lt;/p&gt;
{
 
 			bytesWritten += (headBuffer.remaining() + contents.remaining());
 
-			sources[1] = contents;
-			currentChannel.write(sources);
+			FileUtils.writeCompletely(currentChannel, headBuffer);
+			FileUtils.writeCompletely(currentChannel, contents);
 		}
&lt;p&gt; 		finally {&lt;br/&gt;
 			if (boe.isBuffer()) {&lt;br/&gt;
diff --git a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/SpilledBufferOrEventSequenceTest.java b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/SpilledBufferOrEventSequenceTest.java&lt;br/&gt;
index adbe2405184..c1ff79faf32 100644&lt;br/&gt;
&amp;#8212; a/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/SpilledBufferOrEventSequenceTest.java&lt;br/&gt;
+++ b/flink-streaming-java/src/test/java/org/apache/flink/streaming/runtime/io/SpilledBufferOrEventSequenceTest.java&lt;br/&gt;
@@ -23,6 +23,7 @@&lt;br/&gt;
 import org.apache.flink.runtime.io.network.buffer.Buffer;&lt;br/&gt;
 import org.apache.flink.runtime.io.network.partition.consumer.BufferOrEvent;&lt;br/&gt;
 import org.apache.flink.streaming.runtime.io.BufferSpiller.SpilledBufferOrEventSequence;&lt;br/&gt;
+import org.apache.flink.util.FileUtils;&lt;/p&gt;

&lt;p&gt; import org.junit.After;&lt;br/&gt;
 import org.junit.Before;&lt;br/&gt;
@@ -107,7 +108,7 @@ public void testIncompleteHeaderOnFirstElement() {&lt;br/&gt;
 			ByteBuffer buf = ByteBuffer.allocate(7);&lt;br/&gt;
 			buf.order(ByteOrder.LITTLE_ENDIAN);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;fileChannel.write(buf);&lt;br/&gt;
+			FileUtils.writeCompletely(fileChannel, buf);&lt;br/&gt;
 			fileChannel.position(0);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 			SpilledBufferOrEventSequence seq = new SpilledBufferOrEventSequence(tempFile, fileChannel, buffer, pageSize);&lt;br/&gt;
@@ -175,7 +176,7 @@ public void testBufferSequenceWithIncompleteBuffer() {&lt;br/&gt;
 			data.put((byte) 0);&lt;br/&gt;
 			data.position(0);&lt;br/&gt;
 			data.limit(312);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;fileChannel.write(data);&lt;br/&gt;
+			FileUtils.writeCompletely(fileChannel, data);&lt;br/&gt;
 			fileChannel.position(0L);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 			SpilledBufferOrEventSequence seq = new SpilledBufferOrEventSequence(tempFile, fileChannel, buffer, pageSize);&lt;br/&gt;
@@ -414,7 +415,7 @@ public void testCleanup() &lt;/p&gt;
{
 			ByteBuffer data = ByteBuffer.allocate(157);
 			data.order(ByteOrder.LITTLE_ENDIAN);
 
-			fileChannel.write(data);
+			FileUtils.writeCompletely(fileChannel, data);
 			fileChannel.position(54);
 
 			SpilledBufferOrEventSequence seq = new SpilledBufferOrEventSequence(tempFile, fileChannel, buffer, pageSize);
@@ -451,8 +452,8 @@ private static BufferOrEvent generateAndWriteEvent(FileChannel fileChannel, Rand
 		header.put((byte) 1);
 		header.flip();
 
-		fileChannel.write(header);
-		fileChannel.write(serializedEvent);
+		FileUtils.writeCompletely(fileChannel, header);
+		FileUtils.writeCompletely(fileChannel, serializedEvent);
 		return new BufferOrEvent(evt, channelIndex);
 	}

&lt;p&gt;@@ -467,7 +468,7 @@ private static void writeBuffer(FileChannel fileChannel, int size, int channelIn&lt;br/&gt;
 			data.put((byte) i);&lt;br/&gt;
 		}&lt;br/&gt;
 		data.flip();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;fileChannel.write(data);&lt;br/&gt;
+		FileUtils.writeCompletely(fileChannel, data);&lt;br/&gt;
 	}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 	private static void validateBuffer(BufferOrEvent boe, int expectedSize, int expectedChannelIndex) {&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16643691" author="nicok" created="Tue, 9 Oct 2018 16:17:01 +0000"  >&lt;p&gt;Fixed via:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;master: 1e0a77959d27031048c1c4079a504274c82cc173&lt;/li&gt;
	&lt;li&gt;release-1.6: f266975a38523f7fc5ab09e8d7a1fe1dd41ef54a&lt;/li&gt;
	&lt;li&gt;release-1.5: 7974b6365796bf0290fdf095d47230ab8aa254e2&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16644574" author="githubbot" created="Wed, 10 Oct 2018 07:36:50 +0000"  >&lt;p&gt;gaoyunhaii commented on issue #6788: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-10469&quot; title=&quot;FileChannel may not write the whole buffer in a single call to FileChannel.write(Buffer buffer)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-10469&quot;&gt;&lt;del&gt;FLINK-10469&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;core&amp;#93;&lt;/span&gt; make sure to always write the whole buffer to FileChannel&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6788#issuecomment-428469358&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6788#issuecomment-428469358&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @NicoK It&apos;s OK, glad that the find helps~ &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13194256">FLINK-10682</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 5 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ynvz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>