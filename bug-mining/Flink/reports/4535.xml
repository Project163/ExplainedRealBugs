<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:49:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-19109] Split Reader eats chained periodic watermarks</title>
                <link>https://issues.apache.org/jira/browse/FLINK-19109</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Attempting to generate watermarks chained to the Split Reader / ContinuousFileReaderOperator, as in&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SingleOutputStreamOperator&amp;lt;Event&amp;gt; results = env
  .readTextFile(...)
  .map(...)
  .assignTimestampsAndWatermarks(bounded)
  .keyBy(...)
  .process(...);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;leads to the Watermarks failing to be produced. Breaking the chain, via &lt;tt&gt;disableOperatorChaining()&lt;/tt&gt; or a &lt;tt&gt;rebalance&lt;/tt&gt;, works around the bug. Using punctuated watermarks also avoids the issue.&lt;/p&gt;

&lt;p&gt;Looking at this in the debugger reveals that timer service is being prematurely quiesced.&lt;/p&gt;

&lt;p&gt;In many respects this is &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7666&quot; title=&quot;ContinuousFileReaderOperator swallows chained watermarks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7666&quot;&gt;&lt;del&gt;FLINK-7666&lt;/del&gt;&lt;/a&gt; brought back to life.&lt;/p&gt;

&lt;p&gt;The problem is not present in 1.9.3.&lt;/p&gt;

&lt;p&gt;There&apos;s a minimal reproducible example in &lt;a href=&quot;https://github.com/alpinegizmo/flink-question-001/tree/bug&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/alpinegizmo/flink-question-001/tree/bug&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13325470">FLINK-19109</key>
            <summary>Split Reader eats chained periodic watermarks</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roman">Roman Khachatryan</assignee>
                                    <reporter username="alpinegizmo">David Anderson</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 1 Sep 2020 07:31:39 +0000</created>
                <updated>Tue, 22 Jun 2021 13:55:45 +0000</updated>
                            <resolved>Wed, 16 Sep 2020 19:08:01 +0000</resolved>
                                    <version>1.10.0</version>
                    <version>1.10.1</version>
                    <version>1.10.2</version>
                    <version>1.11.0</version>
                    <version>1.11.1</version>
                                    <fixVersion>1.10.3</fixVersion>
                    <fixVersion>1.11.2</fixVersion>
                    <fixVersion>1.12.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="17188635" author="roman_khachatryan" created="Tue, 1 Sep 2020 16:48:17 +0000"  >&lt;p&gt;I see that with chaining enabled&#160;TimestampsAndWatermarksOperator works as expected - until&#160;ContinuousFileReaderOperator starts reading first elements. After that, it schedules a timer which is executed with 1-2 second delay.&#160;&lt;/p&gt;

&lt;p&gt;This delay is caused by MailboxProcessor not picking up a mail of an already fired timer (timer services are OK).&lt;/p&gt;

&lt;p&gt;This seems reasonable since the priority of operators&#160;MailboxExecutor is defined by its chain index.&lt;/p&gt;

&lt;p&gt;(the chain is ContinuousFileReaderOperator -&amp;gt; Map -&amp;gt;&#160;TimestampsAndWatermarksOperator).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;does it makes sense to you?&lt;/p&gt;

&lt;p&gt;Do you have any idea how to fix this?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Update:&lt;/p&gt;

&lt;p&gt;In 1.10, upon getting END_OF_INPUT (which is received early - after adding all splits to a queue),&#160;StreamTask closes all operators.&#160;&lt;/p&gt;

&lt;p&gt;ContinuousFileReaderOperator.close calls waitSplitReaderFinished() which doesn&apos;t allow Task thread to process any mails.&#160;Once it&apos;s done, mails are drained and the remaining timer callback is executed.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In 1.11,&#160;ContinuousFileReaderOperator.close should allow timers to execute and (thanks to&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-14231&quot; title=&quot;Support the timers of the upstream operator with endInput properly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-14231&quot;&gt;&lt;del&gt;FLINK-14231&lt;/del&gt;&lt;/a&gt;) services shouldn&apos;t be closed. But as ContinuousFileReaderOperator &lt;del&gt;enqueues a higher priority mail&lt;/del&gt;, ignores mails if mailbox loop is stopped, it doesn&apos;t help.&lt;/p&gt;</comment>
                            <comment id="17189373" author="roman_khachatryan" created="Wed, 2 Sep 2020 16:46:07 +0000"  >&lt;p&gt;I&apos;ve published a &lt;a href=&quot;https://github.com/apache/flink/pull/13305&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt;&#160;to fix the issue in 1.12 and 1.11.&lt;/p&gt;

&lt;p&gt;For 1.10, the fix would be problematic as it would likely require backporting &lt;a href=&quot;https://github.com/apache/flink/pull/10435&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;changes to&#160;ContinuousFileReaderOperator&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/flink/pull/10151&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;OperatorChain / timers&lt;/a&gt;. &#160;Given that there are several workarounds, I think the fix for 1.11 and 1.12 will suffice.&lt;/p&gt;</comment>
                            <comment id="17190180" author="alpinegizmo" created="Thu, 3 Sep 2020 14:20:05 +0000"  >&lt;p&gt;I think we should try harder to find a fix for 1.10. 1.10 is still supported, and while there are workarounds this is a difficult problem to diagnose. Not all users will find these workarounds on their own.&lt;/p&gt;

&lt;p&gt;I tracked this down after hearing from a user who wasted a day trying to figure out what was going on with an event time streaming app where none of the windows were closing until the end of the job. Getting from there to the actual problem requires a pretty solid understanding of the internals. &lt;/p&gt;</comment>
                            <comment id="17191487" author="zhuzh" created="Mon, 7 Sep 2020 06:49:34 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;, do you think we can get the fix merged today? &lt;br/&gt;
I&apos;m asking this because it is the deadline to cut 1.11.2 RC1 later today.&lt;/p&gt;</comment>
                            <comment id="17191533" author="roman_khachatryan" created="Mon, 7 Sep 2020 07:42:06 +0000"  >&lt;p&gt;Hi Zhu Zhu,&lt;/p&gt;

&lt;p&gt;Yes, it will be merged today (I asked &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt;&#160;to do that).&lt;/p&gt;</comment>
                            <comment id="17191537" author="zhuzh" created="Mon, 7 Sep 2020 07:44:25 +0000"  >&lt;p&gt;Thanks for the updates! &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17191577" author="zjwang" created="Mon, 7 Sep 2020 08:44:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhuzh&quot; class=&quot;user-hover&quot; rel=&quot;zhuzh&quot;&gt;zhuzh&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;, I will merge it in 1.11 after azure pass, I think it can be done later today.&lt;/p&gt;</comment>
                            <comment id="17191651" author="pnowojski" created="Mon, 7 Sep 2020 11:29:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alpinegizmo&quot; class=&quot;user-hover&quot; rel=&quot;alpinegizmo&quot;&gt;alpinegizmo&lt;/a&gt; those two PRs that the fix depends on are quite big changes (+2000 lines of code), with some follow up bug fixes. Back porting them could mean destabilising the 1.10.x release branch, especially given that our release testing for minor changes is not that good. Furthermore, they are changing behaviour of the system, for example the &lt;a href=&quot;https://github.com/apache/flink/pull/10435&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ContinuousFileReaderOperator changes&lt;/a&gt; will be affecting performance (hopefully improving), while the other one &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-14228&quot; title=&quot;The runtime support for Bounded[One|Multi]Input#endInput does not properly implement their semantics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-14228&quot;&gt;&lt;del&gt;FLINK-14228&lt;/del&gt;&lt;/a&gt; is changing semantic of timers during shutdown.&lt;/p&gt;

&lt;p&gt;Is there other way to fix the problem &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17191745" author="zjwang" created="Mon, 7 Sep 2020 15:00:50 +0000"  >&lt;p&gt;Merged in master: 361ccb3ad734490aa4df9aa9d0430a31680581db&lt;br/&gt;
Merged in release-1.11: bae7d4b7d821cc9cca3d17e1f432be22cd7dbf76&lt;/p&gt;</comment>
                            <comment id="17191818" author="roman_khachatryan" created="Mon, 7 Sep 2020 17:22:02 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt;&#160;for merging the PR.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Regarding 1.10, I tried to use yield in this draft PR: &lt;a href=&quot;https://github.com/apache/flink/pull/13342&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/13342&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160;that it can destabilize 1.10: yield() can lead to&#160;indefinite wait for a mail, particularly because timer service can be shut down prematurely in 1.10.&lt;/p&gt;</comment>
                            <comment id="17193484" author="aljoscha" created="Thu, 10 Sep 2020 09:07:42 +0000"  >&lt;p&gt;I think we definitely need to find a fix for 1.10.x, as David said. This is quite critical and users (and me) can waste quite some time diagnosing what is happening.&lt;/p&gt;</comment>
                            <comment id="17193526" author="pnowojski" created="Thu, 10 Sep 2020 10:38:12 +0000"  >&lt;p&gt;As I wrote, I think we can not backport the proper fix. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;&apos;s fix looks like can deadlock. Maybe it could be solved, but it&apos;s still hacky and risky. If you insist on fixing it in 1.10, I would suggest to disable chaining for the &lt;tt&gt;ContinoutFileReaderOperator&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17193629" author="alpinegizmo" created="Thu, 10 Sep 2020 13:48:51 +0000"  >&lt;p&gt;I like &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&apos;s idea of disabling chaining for the &lt;tt&gt;ContinousFileReaderOperator&lt;/tt&gt; in 1.10. This strikes me as a pragmatic solution, though it will impact performance for some users who aren&apos;t impacted by the bug. Would it make sense to try to optimize this a bit, and only disable chaining when the time characteristic is event time?&lt;/p&gt;</comment>
                            <comment id="17193662" author="arvid" created="Thu, 10 Sep 2020 14:51:06 +0000"  >&lt;p&gt;Yes, it&apos;s possible to contain the fix to just event time characteristics. I&apos;ll prepare a PR soonish.&lt;/p&gt;</comment>
                            <comment id="17194350" author="arvid" created="Fri, 11 Sep 2020 15:49:34 +0000"  >&lt;p&gt;Added a PR. However, I&apos;m quite positive that we need to disallow all chaining of &lt;tt&gt;ProcessingTimeCallback&lt;/tt&gt; after &lt;tt&gt;ContinousFileReaderOperator&lt;/tt&gt;. For now I only disabled them in event time, but it might be also relevant for processing/ingestion time.&lt;/p&gt;</comment>
                            <comment id="17195670" author="arvid" created="Mon, 14 Sep 2020 18:17:30 +0000"  >&lt;p&gt;Since an operator can also register processing time timers without implementing &lt;tt&gt;ProcessingTimeCallback&lt;/tt&gt;, we need to disable any chaining of CFRO in 1.10.&lt;/p&gt;

&lt;p&gt;Best, we could do is to add an &lt;tt&gt;enableChaining&lt;/tt&gt;/&lt;tt&gt;forceChaining&lt;/tt&gt; to &lt;tt&gt;DataStream&lt;/tt&gt; to allow expert users to force the old behavior on their own risk. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt;, any opinion on this? (Might be something to offer in general)&lt;/p&gt;</comment>
                            <comment id="17197195" author="arvid" created="Wed, 16 Sep 2020 19:07:23 +0000"  >&lt;p&gt;Merged in release-1.10: 05ff71c813650f65604d960978f93ba82f09a48d&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 8 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0i8sw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>