<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:20:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-34252] WatermarkAssignerOperator should not emit WatermarkStatus.IDLE under continuous data flow</title>
                <link>https://issues.apache.org/jira/browse/FLINK-34252</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The WatermarkAssignerOperator in the table runtime incorrectly transitions to an IDLE state even when data is continuously flowing. This behavior, observed under normal operating conditions where the interval between data elements is shorter than the configured idleTimeout, leads to regular transitions between ACTIVE and IDLE states, which are unnecessary.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Detail:&lt;/em&gt;&lt;br/&gt;
In the current implementation, the lastRecordTime variable, which tracks the time of the last received data element, is updated only when the WatermarkStatus transitions from IDLE to ACTIVE. However, it is not updated when WatermarkStatus is ACTIVE, which means even under continuous data flow, the condition `(currentTime - lastRecordTime &amp;gt; idleTimeout)` will eventually always become true, and the WatermarkStatus will erroneously be marked IDLE. &lt;/p&gt;

&lt;p&gt;It is unclear to me if this bug produces any incorrectness downstream, since when the WatermarkStatus is in in the IDLE state, the next processElement will cause a WatermarkStatus.ACTIVE to be emitted. Nevertheless, we should eliminate this flip-flop behavior between states.&lt;/p&gt;

&lt;p&gt;The test I wrote fails without the fix and illustrates the flip-flops:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[ERROR] Tests run: 4, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 0.030 s &amp;lt;&amp;lt;&amp;lt; FAILURE! -- in org.apache.flink.table.runtime.operators.wmassigners.WatermarkAssignerOperatorTest
[ERROR] org.apache.flink.table.runtime.operators.wmassigners.WatermarkAssignerOperatorTest.testIdleStateAvoidanceWithConsistentDataFlow -- Time elapsed: 0.013 s &amp;lt;&amp;lt;&amp;lt; FAILURE!
java.lang.AssertionError:

Expecting
  [WatermarkStatus(IDLE),
    WatermarkStatus(ACTIVE),
    WatermarkStatus(IDLE),
    WatermarkStatus(ACTIVE),
    WatermarkStatus(IDLE),
    WatermarkStatus(ACTIVE),
    WatermarkStatus(IDLE),
    WatermarkStatus(ACTIVE),
    WatermarkStatus(IDLE)]
not to contain
  [WatermarkStatus(IDLE)]
but found
  [WatermarkStatus(IDLE)]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13566442">FLINK-34252</key>
            <summary>WatermarkAssignerOperator should not emit WatermarkStatus.IDLE under continuous data flow</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pnowojski">Piotr Nowojski</assignee>
                                    <reporter username="dchristle">David Christle</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sun, 28 Jan 2024 20:53:25 +0000</created>
                <updated>Tue, 18 Jun 2024 12:17:37 +0000</updated>
                            <resolved>Tue, 18 Jun 2024 12:17:37 +0000</resolved>
                                    <version>1.16.3</version>
                    <version>1.17.2</version>
                    <version>1.18.1</version>
                                    <fixVersion>1.18.2</fixVersion>
                    <fixVersion>1.20.0</fixVersion>
                    <fixVersion>1.19.2</fixVersion>
                                    <component>Table SQL / Runtime</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17811771" author="martijnvisser" created="Mon, 29 Jan 2024 08:58:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dchristle&quot; class=&quot;user-hover&quot; rel=&quot;dchristle&quot;&gt;dchristle&lt;/a&gt; If I look at &lt;a href=&quot;https://cwiki.apache.org/confluence/display/FLINK/FLIP-180%3A+Adjust+StreamStatus+and+Idleness+definition&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/FLINK/FLIP-180%3A+Adjust+StreamStatus+and+Idleness+definition&lt;/a&gt; - Which of the situations are you referring to in your ticket? (Static assignment + temporary no data or Dynamic assignment + temporary no split)&lt;/p&gt;</comment>
                            <comment id="17812081" author="dchristle" created="Mon, 29 Jan 2024 22:54:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt; The swapping of watermark between active/idle/active/idle appears to happen when the data stream is &lt;em&gt;not&lt;/em&gt; truly idle. The static vs temporary no data vs dynamic assignment cases are all times where a stream should be signaled as &quot;idle&quot; in some way. But here, a stream that is active is erroneously marked idle.&lt;/p&gt;

&lt;p&gt;The `WatermarkAssignerOperator` isn&apos;t a Source, so it does not know which of the three cases is causing idleness. To detect idleness, the Operator takes `idleTimeout` as an argument, and compares it against the processing timestamp of the last record it received. The way it appears the Operator &lt;em&gt;should&lt;/em&gt; work is that if no record is incoming for longer than `idleTimeout`, it infers the stream is idle, and emits `WatermarkStatus.IDLE`. This logic is like how `withIdleness` works.&lt;/p&gt;

&lt;p&gt;This makes sense: whether the reason for the idleness is a static assignment that made it so no records are received, a stream doesn&apos;t produce records for a while, or whether a split happens to not be assigned for a while due to dynamic assignment/not enough splits, all of these cases translate to the Operator observing no more records for too long of a time. When it hasn&apos;t seen any records for longer than `idleTimeout`, it emits `WatermarkStatus.IDLE`. I believe this signals to all downstream operators that this sub-stream is idle &amp;amp; they should not wait for anymore watermarks from it.&lt;/p&gt;

&lt;p&gt;The problem is that the code doesn&apos;t work like this because the tracking of `lastRecordTime` is broken, causing the check against idleTimeout to fail, even when the stream has records coming in below idleTimeout. The Operator will flip back and forth between emitting WatermarkStatus.IDLE/WatermarkStatus.ACTIVE, when it should just stay ACTIVE.&lt;/p&gt;

&lt;p&gt;This breaks the guarantees around watermarks/event time &amp;amp; could cause incorrect results. If downstream operators receive an IDLE status from this Operator when they shouldn&apos;t, if I understand correctly, they will advance their watermarks too early (IDLE signals they should ignore this sub-stream in their watermark update logic). &lt;/p&gt;

&lt;p&gt;Here is a PR I submitted: &lt;a href=&quot;https://github.com/apache/flink/pull/24211&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/24211&lt;/a&gt; - that might make the issue/fix clearer.&lt;/p&gt;</comment>
                            <comment id="17815719" author="martijnvisser" created="Thu, 8 Feb 2024 15:24:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fanrui&quot; class=&quot;user-hover&quot; rel=&quot;fanrui&quot;&gt;fanrui&lt;/a&gt; I&apos;m curious on your thoughts on this one, given your work you&apos;ve put in watermark alignment etc.&lt;/p&gt;</comment>
                            <comment id="17818266" author="fanrui" created="Sun, 18 Feb 2024 10:12:14 +0000"  >&lt;p&gt;Sorry for the late response as I was on vacation for 10 days.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dchristle&quot; class=&quot;user-hover&quot; rel=&quot;dchristle&quot;&gt;dchristle&lt;/a&gt; for the report and fix, and thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=martijnvisser&quot; class=&quot;user-hover&quot; rel=&quot;martijnvisser&quot;&gt;martijnvisser&lt;/a&gt;&#160; for the ping.&lt;/p&gt;

&lt;p&gt;After my detailed analysis, I think it&apos;s indeed a bug, and this bug was introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-22881&quot; title=&quot;Tasks are blocked while broadcasting stream status&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-22881&quot;&gt;&lt;del&gt;FLINK-22881&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;. The fix PR LGTM, and I have cced &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dwysakowicz&quot; class=&quot;user-hover&quot; rel=&quot;dwysakowicz&quot;&gt;dwysakowicz&lt;/a&gt;&#160; help review as well.&lt;/p&gt;

&lt;p&gt;BTW, IIUC this bug is related to watermark instead of watermark alignment. And it only happens for Table api or SQL.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/flink/pull/16221&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/16221&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/flink/commit/5382cf5d5c143cce8a925a9063c74c51297d6a93&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/commit/5382cf5d5c143cce8a925a9063c74c51297d6a93&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17855830" author="pnowojski" created="Tue, 18 Jun 2024 08:05:22 +0000"  >&lt;p&gt;Merged to master as d93e92c665a and d93e92c665a^&lt;/p&gt;</comment>
                            <comment id="17855917" author="pnowojski" created="Tue, 18 Jun 2024 12:17:37 +0000"  >&lt;p&gt;merged to release-1.18 as b60318ba1a7^ and b60318ba1a7&lt;br/&gt;
merged to release-1.19 as c5dfb57fd94^ and c5dfb57fd94&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13382184">FLINK-22881</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1n1ts:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>