<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:30:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-7870] SlotPool should cancel the slot request to RM if not need any more.</title>
                <link>https://issues.apache.org/jira/browse/FLINK-7870</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;1. SlotPool will request slot to rm if its slots are not enough.&lt;br/&gt;
2. If a slot request is not fulfilled in a certain time, SlotPool will treat the request as timeout and send a new slot request by triggering a failover in JobMaster, the previous request is not needed any more, but rm does not know it.&lt;br/&gt;
3. This may cause the rm request much more resource than the job really need.&lt;br/&gt;
For example:&lt;br/&gt;
1. A job need 100 slots. RM request 100 container to YARN.&lt;br/&gt;
2. But YARN is busy now, it has no resource for the job.&lt;br/&gt;
3. The job failover as the resource request not fulfilled in time.&lt;br/&gt;
4. It ask 100 slots again, now RM request 200 container to YARN.&lt;br/&gt;
5. If failover server time, the containers request  will become more and more.&lt;br/&gt;
6. Now YARN has resource, it will find that the job may need thousands of containers. This is a waste of resources.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13110572">FLINK-7870</key>
            <summary>SlotPool should cancel the slot request to RM if not need any more.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tiemsn">shuai.xu</assignee>
                                    <reporter username="tiemsn">shuai.xu</reporter>
                        <labels>
                            <label>flip-6</label>
                    </labels>
                <created>Thu, 19 Oct 2017 05:20:27 +0000</created>
                <updated>Thu, 28 Feb 2019 14:12:45 +0000</updated>
                            <resolved>Tue, 7 Nov 2017 14:10:41 +0000</resolved>
                                                    <fixVersion>1.5.0</fixVersion>
                                    <component>Runtime / Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16214958" author="githubbot" created="Mon, 23 Oct 2017 10:53:27 +0000"  >&lt;p&gt;GitHub user shuai-xu opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4887&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4887&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-7870&quot; title=&quot;SlotPool should cancel the slot request to RM if not need any more.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-7870&quot;&gt;&lt;del&gt;FLINK-7870&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;runtime&amp;#93;&lt;/span&gt; Cancel slot allocation to RM when requestSlot timed out in SlotPool&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    This pull request add a cancelSlotRequest rpc protocol between slot pool and resource manager. When the pending request timeout in slot pool, it send a cancelSlotRequest rpc to resouce manager to canel the previous slot request in order not to make the slot request become more and more in resource manager.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;br/&gt;
    This change added tests and can be verified as follows:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;*Added a verify in SlotManagerTest to make sure the cancel logic&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not applicable)&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/shuai-xu/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/shuai-xu/flink&lt;/a&gt; jira-xxxx&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4887.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4887.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4887&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit daf7fd5745659d94f5a84f669bc90b82b5e69e5e&lt;br/&gt;
Author: shuai.xus &amp;lt;shuai.xus@alibaba-inc.com&amp;gt;&lt;br/&gt;
Date:   2017-10-17T09:57:18Z&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;FLINK-xxxx&amp;#93;&lt;/span&gt; slot pool cancel slot request to resource manager if timeout&lt;/p&gt;

&lt;p&gt;    Summary: slot pool cancel slot request to resource manager if timeout&lt;/p&gt;

&lt;p&gt;    Test Plan: unit test&lt;/p&gt;

&lt;p&gt;    Reviewers: haitao.w&lt;/p&gt;

&lt;p&gt;    Differential Revision: &lt;a href=&quot;https://aone.alibaba-inc.com/code/D320749&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://aone.alibaba-inc.com/code/D320749&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit 96f80187bb5ef1c268a62bdaf80151a70a04b002&lt;br/&gt;
Author: shuai.xus &amp;lt;shuai.xus@alibaba-inc.com&amp;gt;&lt;br/&gt;
Date:   2017-10-19T04:13:01Z&lt;/p&gt;

&lt;p&gt;    add more contract&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16217986" author="githubbot" created="Wed, 25 Oct 2017 02:07:27 +0000"  >&lt;p&gt;Github user shuai-xu commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4887&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4887&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @tillrohrmann could you help to review this pr? Thank you.&lt;/p&gt;</comment>
                            <comment id="16235845" author="githubbot" created="Thu, 2 Nov 2017 14:52:48 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4887#discussion_r148552085&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4887#discussion_r148552085&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/slotmanager/ResourceActions.java &amp;#8212;&lt;br/&gt;
    @@ -52,4 +52,6 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param cause of the allocation failure&lt;br/&gt;
     	 */&lt;br/&gt;
     	void notifyAllocationFailure(JobID jobId, AllocationID allocationId, Exception cause);&lt;br/&gt;
    +&lt;br/&gt;
    +	void cancelResourceAllocation(ResourceProfile resourceProfile);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think we don&apos;t necessarily need this call. See my comment in the `SlotManager`.&lt;/p&gt;</comment>
                            <comment id="16235846" author="githubbot" created="Thu, 2 Nov 2017 14:52:48 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4887#discussion_r148553179&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4887#discussion_r148553179&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -399,6 +399,26 @@ public void disconnectJobManager(final JobID jobId, final Exception cause) {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	@Override&lt;br/&gt;
    +	public void cancelSlotRequest(JobID jobID, JobMasterId jobMasterId, AllocationID allocationID) {&lt;br/&gt;
    +&lt;br/&gt;
    +		// As the slot allocations are async, it can not avoid all redundent slots, but should best effort.&lt;br/&gt;
    +		JobManagerRegistration jobManagerRegistration = jobManagerRegistrations.get(jobID);&lt;br/&gt;
    +&lt;br/&gt;
    +		if (null != jobManagerRegistration) {&lt;br/&gt;
    +			if (Objects.equals(jobMasterId, jobManagerRegistration.getJobMasterId())) {&lt;br/&gt;
    +				log.info(&quot;Cancel slot request for job {} with allocation id {}.&quot;,&lt;br/&gt;
    +						jobID, allocationID);&lt;br/&gt;
    +&lt;br/&gt;
    +				slotManager.unregisterSlotRequest(allocationID);&lt;br/&gt;
    +			} else {&lt;br/&gt;
    +				log.info(&quot;Job manager {} is not the leader of job {}.&quot;, jobMasterId, jobID);&lt;br/&gt;
    +			}&lt;br/&gt;
    +		} else {&lt;br/&gt;
    +			log.warn(&quot;Could not find registered job manager for job {}.&quot;, jobID);&lt;br/&gt;
    +		}&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This could be simplified to `slotManager.unregisterSlotRequest(allocationId)` if we change `cancelSlotRequest(JobID, JobMasterId, AllocationID)` to `cancelSlotRequest(AllocationID)`.&lt;/p&gt;</comment>
                            <comment id="16235847" author="githubbot" created="Thu, 2 Nov 2017 14:52:48 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4887#discussion_r148551966&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4887#discussion_r148551966&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/slotmanager/SlotManager.java &amp;#8212;&lt;br/&gt;
    @@ -302,7 +302,12 @@ public boolean unregisterSlotRequest(AllocationID allocationId) {&lt;br/&gt;
     		PendingSlotRequest pendingSlotRequest = pendingSlotRequests.remove(allocationId);&lt;/p&gt;

&lt;p&gt;     		if (null != pendingSlotRequest) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;cancelPendingSlotRequest(pendingSlotRequest);&lt;br/&gt;
    +			if (pendingSlotRequest.isAssigned()) 
{
    +				cancelPendingSlotRequest(pendingSlotRequest);
    +			}
&lt;p&gt;    +			else {&lt;br/&gt;
    +				resourceActions.cancelResourceAllocation(pendingSlotRequest.getResourceProfile());&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I think we should not immediately cancel ongoing resource allocations. The `SlotManager` could decide upon registration of a new worker whether this one is actually needed or not. In the latter case it could release the resource. This would also simplify the protocol since you don&apos;t know whether you still can cancel an ongoing resource allocation.&lt;/p&gt;</comment>
                            <comment id="16235848" author="githubbot" created="Thu, 2 Nov 2017 14:52:49 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4887#discussion_r148552792&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4887#discussion_r148552792&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -874,6 +894,13 @@ public void handleError(final Exception exception) {&lt;br/&gt;
     	 */&lt;br/&gt;
     	public abstract boolean stopWorker(ResourceID resourceID);&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Cancel the allocation of a resource. If the resource allocation has not fulfilled, should cancel it.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param resourceProfile The resource description of the previous allocation&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public abstract void cancelNewWorker(ResourceProfile resourceProfile);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    See my comment in the `SlotManager`. I think we don&apos;t need this call here. Rather, I would like the SlotManager to decide upon registration of a new resource whether it needs it or not and release the resource via calling `ResourceManagerActions#releaseResource`.&lt;/p&gt;</comment>
                            <comment id="16235849" author="githubbot" created="Thu, 2 Nov 2017 14:52:49 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4887#discussion_r148550603&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4887#discussion_r148550603&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManagerGateway.java &amp;#8212;&lt;br/&gt;
    @@ -71,6 +71,18 @@&lt;br/&gt;
     		@RpcTimeout Time timeout);&lt;/p&gt;

&lt;p&gt;     	/**&lt;br/&gt;
    +	 * Cancel the slot allocation requests from the resource manager.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param jobID JobID for which the JobManager was the leader&lt;br/&gt;
    +	 * @param jobMasterId id of the JobMaster&lt;br/&gt;
    +	 * @param allocationID The slot to request&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	void cancelSlotRequest(&lt;br/&gt;
    +		JobID jobID,&lt;br/&gt;
    +		JobMasterId jobMasterId,&lt;br/&gt;
    +		AllocationID allocationID);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think this could be `void cancelSlotRequest(AllocationID allocationId)`. Not sure why we need the other information.&lt;/p&gt;</comment>
                            <comment id="16235850" author="githubbot" created="Thu, 2 Nov 2017 14:52:49 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4887#discussion_r148555569&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4887#discussion_r148555569&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/instance/SlotPool.java &amp;#8212;&lt;br/&gt;
    @@ -363,6 +363,9 @@ private void slotRequestToResourceManagerFailed(AllocationID allocationID, Throw&lt;br/&gt;
     	private void checkTimeoutSlotAllocation(AllocationID allocationID) {&lt;br/&gt;
     		PendingRequest request = pendingRequests.remove(allocationID);&lt;br/&gt;
     		if (request != null &amp;amp;&amp;amp; !request.getFuture().isDone()) {&lt;br/&gt;
    +			if (resourceManagerGateway != null) {&lt;br/&gt;
    +				resourceManagerGateway.cancelSlotRequest(jobId, jobMasterId, allocationID);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think we could actually add this call as exceptional callback which is triggered by the `TimeoutException`. In `requestSlotFromResourceManager` we could add something like `future.whenComplete((value, throwable) -&amp;gt; { if (throwable instanceOf TimeoutException) { resourceManagerGateway.cancelSlotRequest(); }});`&lt;/p&gt;</comment>
                            <comment id="16237161" author="githubbot" created="Fri, 3 Nov 2017 06:32:45 +0000"  >&lt;p&gt;Github user shuai-xu commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4887#discussion_r148715651&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4887#discussion_r148715651&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/slotmanager/SlotManager.java &amp;#8212;&lt;br/&gt;
    @@ -302,7 +302,12 @@ public boolean unregisterSlotRequest(AllocationID allocationId) {&lt;br/&gt;
     		PendingSlotRequest pendingSlotRequest = pendingSlotRequests.remove(allocationId);&lt;/p&gt;

&lt;p&gt;     		if (null != pendingSlotRequest) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;cancelPendingSlotRequest(pendingSlotRequest);&lt;br/&gt;
    +			if (pendingSlotRequest.isAssigned()) 
{
    +				cancelPendingSlotRequest(pendingSlotRequest);
    +			}
&lt;p&gt;    +			else {&lt;br/&gt;
    +				resourceActions.cancelResourceAllocation(pendingSlotRequest.getResourceProfile());&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Yes, the SlotManager can decide to release the resource more than needed. But in a worst case:&lt;br/&gt;
    1. Now the MESOS or YARN cluster have not enough resource.&lt;br/&gt;
    2. A job ask for 100 worker of size A;&lt;br/&gt;
    3. As there are not enough resource, the job failover, the previous 100 is not cancelled, it ask another 100.&lt;br/&gt;
    4. This repeated several times, the pending requests for worker of size A reaches 10000.&lt;br/&gt;
    5. A worker of size B crashed, so the job now only need 100 woker of size A and 1 worker of size B. But the YARN or MESOS think the job need 10000 A and 1 B as the request are never cancelled.&lt;br/&gt;
    6. The MESOS/YARN now have some resources for 110 A, more than 100 A and 1 B, and it begin to assign resource for the job, but it first try to allocate 10000 containers of size A, and the job still can not be started as it is lack of container B. &lt;br/&gt;
    7. This may cause the job can not be started even when the cluster resource is now enough in a long time.&lt;br/&gt;
    8. And this did happen in our cluster, as our cluster is busy. So I think it&apos;s better to keep this protocol, and different resource managers can treat this protocol according to their need.&lt;/p&gt;</comment>
                            <comment id="16237162" author="githubbot" created="Fri, 3 Nov 2017 06:33:19 +0000"  >&lt;p&gt;Github user shuai-xu commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4887#discussion_r148715689&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4887#discussion_r148715689&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/slotmanager/ResourceActions.java &amp;#8212;&lt;br/&gt;
    @@ -52,4 +52,6 @@&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;@param cause of the allocation failure&lt;br/&gt;
     	 */&lt;br/&gt;
     	void notifyAllocationFailure(JobID jobId, AllocationID allocationId, Exception cause);&lt;br/&gt;
    +&lt;br/&gt;
    +	void cancelResourceAllocation(ResourceProfile resourceProfile);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I comment it is slot manager.&lt;/p&gt;</comment>
                            <comment id="16237169" author="githubbot" created="Fri, 3 Nov 2017 06:39:51 +0000"  >&lt;p&gt;Github user shuai-xu commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4887#discussion_r148716173&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4887#discussion_r148716173&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/ResourceManager.java &amp;#8212;&lt;br/&gt;
    @@ -874,6 +894,13 @@ public void handleError(final Exception exception) {&lt;br/&gt;
     	 */&lt;br/&gt;
     	public abstract boolean stopWorker(ResourceID resourceID);&lt;/p&gt;

&lt;p&gt;    +	/**&lt;br/&gt;
    +	 * Cancel the allocation of a resource. If the resource allocation has not fulfilled, should cancel it.&lt;br/&gt;
    +	 *&lt;br/&gt;
    +	 * @param resourceProfile The resource description of the previous allocation&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public abstract void cancelNewWorker(ResourceProfile resourceProfile);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I comment it is slot manager.&lt;/p&gt;</comment>
                            <comment id="16237447" author="githubbot" created="Fri, 3 Nov 2017 11:01:14 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4887#discussion_r148754465&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4887#discussion_r148754465&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/slotmanager/SlotManager.java &amp;#8212;&lt;br/&gt;
    @@ -302,7 +302,12 @@ public boolean unregisterSlotRequest(AllocationID allocationId) {&lt;br/&gt;
     		PendingSlotRequest pendingSlotRequest = pendingSlotRequests.remove(allocationId);&lt;/p&gt;

&lt;p&gt;     		if (null != pendingSlotRequest) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;cancelPendingSlotRequest(pendingSlotRequest);&lt;br/&gt;
    +			if (pendingSlotRequest.isAssigned()) 
{
    +				cancelPendingSlotRequest(pendingSlotRequest);
    +			}
&lt;p&gt;    +			else {&lt;br/&gt;
    +				resourceActions.cancelResourceAllocation(pendingSlotRequest.getResourceProfile());&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Then this should be added as a separate feature because it is not strictly required by this PR here.&lt;/p&gt;

&lt;p&gt;    Furthermore, I&apos;m not sure whether this shouldn&apos;t be the responsibility of the `ResourceManager`. E.g. we could think about adding a timeout for container requests after which we cancel them. Additionally, if we add support for starting machines with multiple slots, then we shouldn&apos;t release a requested resource if only a single of it slots is no longer needed. That is something else to consider before adding the cancel resource allocation method.&lt;/p&gt;</comment>
                            <comment id="16237452" author="githubbot" created="Fri, 3 Nov 2017 11:04:38 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4887#discussion_r148754660&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4887#discussion_r148754660&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/instance/SlotPool.java &amp;#8212;&lt;br/&gt;
    @@ -316,6 +316,13 @@ private void requestSlotFromResourceManager(&lt;/p&gt;

&lt;p&gt;     		pendingRequests.put(allocationID, new PendingRequest(allocationID, future, resources));&lt;/p&gt;

&lt;p&gt;    +		future.whenComplete(&lt;br/&gt;
    +			(value, throwable) -&amp;gt; {&lt;br/&gt;
    +				if (throwable != null &amp;amp;&amp;amp; throwable instanceof TimeoutException) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think we should `cancelSlotRequest` for all `Throwables`.&lt;/p&gt;</comment>
                            <comment id="16242058" author="githubbot" created="Tue, 7 Nov 2017 14:09:32 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/4887&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/4887&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16242059" author="till.rohrmann" created="Tue, 7 Nov 2017 14:10:41 +0000"  >&lt;p&gt;Fixed via 902425f5752d0c80f155bc444de93ce250c7ce62&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12996099">FLINK-4344</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 2 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3lg4v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>