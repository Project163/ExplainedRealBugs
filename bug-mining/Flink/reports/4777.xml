<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:50:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-19964] Gelly ITCase stuck on Azure in HITSITCase.testPrintWithRMatGraph</title>
                <link>https://issues.apache.org/jira/browse/FLINK-19964</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;The HITSITCase has gotten stuck on Azure. Chances are that something in the scheduling or network has broken it.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=8919&amp;amp;view=logs&amp;amp;j=c5f0071e-1851-543e-9a45-9ac140befc32&amp;amp;t=1fb1a56f-e8b5-5a82-00a0-a2db7757b4f5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=8919&amp;amp;view=logs&amp;amp;j=c5f0071e-1851-543e-9a45-9ac140befc32&amp;amp;t=1fb1a56f-e8b5-5a82-00a0-a2db7757b4f5&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13338793">FLINK-19964</key>
            <summary>Gelly ITCase stuck on Azure in HITSITCase.testPrintWithRMatGraph</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="arvid">Arvid Heise</assignee>
                                    <reporter username="chesnay">Chesnay Schepler</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Wed, 4 Nov 2020 09:31:40 +0000</created>
                <updated>Tue, 22 Jun 2021 14:05:27 +0000</updated>
                            <resolved>Wed, 11 Nov 2020 06:36:38 +0000</resolved>
                                    <version>1.12.0</version>
                                    <fixVersion>1.12.0</fixVersion>
                                    <component>Library / Graph Processing</component>
                    <component>Runtime / Network</component>
                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17226066" author="rmetzger" created="Wed, 4 Nov 2020 14:03:21 +0000"  >&lt;p&gt;From the logs, you can see that the job seems to make progress without any issues, until we reach this point, where we don&apos;t see any new log events:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
19:58:21,930 [CHAIN CoGroup (Hub) -&amp;gt; Combine (Sum) (3/4)#0] INFO  org.apache.flink.runtime.iterative.task.IterationIntermediateTask [] - finishing iteration [1]:  CHAIN CoGroup (Hub) -&amp;gt; Combine (Sum) (3/4)
19:58:21,930 [flink-akka.actor.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-dispatcher-2] INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - Reduce (Sum) (3/4) (852e861d142fcff331c85ee4b12949b9_9d7788ce41d2b7d2b242bfb2589af1cb_2_0) switched from RUNNING to FINISHED.
19:58:21,931 [Reduce (Sum) (2/4)#0] INFO  org.apache.flink.runtime.iterative.task.IterationIntermediateTask [] - finishing iteration [1]:  Reduce (Sum) (2/4)
19:58:21,931 [Reduce (Sum) (1/4)#0] INFO  org.apache.flink.runtime.iterative.task.IterationIntermediateTask [] - finishing iteration [1]:  Reduce (Sum) (1/4)
19:58:21,931 [CHAIN Map (Square) -&amp;gt; Combine (Sum) (2/4)#0] INFO  org.apache.flink.runtime.iterative.task.IterationIntermediateTask [] - finishing iteration [1]:  CHAIN Map (Square) -&amp;gt; Combine (Sum) (2/4)
19:58:21,931 [Reduce (Sum) (4/4)#0] INFO  org.apache.flink.runtime.iterative.task.IterationIntermediateTask [] - finishing iteration [1]:  Reduce (Sum) (4/4)
19:58:21,931 [Reduce (Sum) (3/4)#0] INFO  org.apache.flink.runtime.iterative.task.IterationIntermediateTask [] - finishing iteration [1]:  Reduce (Sum) (3/4)
19:58:21,931 [CHAIN Map (Square) -&amp;gt; Combine (Sum) (1/4)#0] INFO  org.apache.flink.runtime.iterative.task.IterationIntermediateTask [] - finishing iteration [1]:  CHAIN Map (Square) -&amp;gt; Combine (Sum) (1/4)
19:58:21,931 [CHAIN Map (Square) -&amp;gt; Combine (Sum) (4/4)#0] INFO  org.apache.flink.runtime.iterative.task.IterationIntermediateTask [] - finishing iteration [1]:  CHAIN Map (Square) -&amp;gt; Combine (Sum) (4/4)
19:58:21,931 [CHAIN Map (Square) -&amp;gt; Combine (Sum) (3/4)#0] INFO  org.apache.flink.runtime.iterative.task.IterationIntermediateTask [] - finishing iteration [1]:  CHAIN Map (Square) -&amp;gt; Combine (Sum) (3/4)
19:58:21,931 [Reduce (Sum) (1/1)#0] INFO  org.apache.flink.runtime.iterative.task.IterationIntermediateTask [] - finishing iteration [1]:  Reduce (Sum) (1/1)
19:58:21,931 [CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (3/4)#0] INFO  org.apache.flink.runtime.iterative.task.IterationIntermediateTask [] - starting iteration [1]:  CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (3/4)
19:58:21,932 [CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (1/4)#0] INFO  org.apache.flink.runtime.iterative.task.IterationIntermediateTask [] - starting iteration [1]:  CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (1/4)
19:58:21,932 [CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (2/4)#0] INFO  org.apache.flink.runtime.iterative.task.IterationIntermediateTask [] - starting iteration [1]:  CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (2/4)
19:58:21,932 [CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (4/4)#0] INFO  org.apache.flink.runtime.iterative.task.IterationIntermediateTask [] - starting iteration [1]:  CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (4/4)
19:58:21,932 [CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (3/4)#0] INFO  org.apache.flink.runtime.iterative.task.IterationIntermediateTask [] - finishing iteration [1]:  CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (3/4)
19:58:21,933 [CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (1/4)#0] INFO  org.apache.flink.runtime.iterative.task.IterationIntermediateTask [] - finishing iteration [1]:  CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (1/4)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At this point, it seems that two iterations are finished:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (3/4)&lt;/li&gt;
	&lt;li&gt;CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (1/4)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;and two are not finished:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (2/4)&lt;/li&gt;
	&lt;li&gt;CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (4/4)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Searching for &quot;CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (4/4)&quot; in the threaddumps reveals:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
2020-11-03T20:15:40.9815769Z &lt;span class=&quot;code-quote&quot;&gt;&quot;CHAIN CoGroup (Authority) -&amp;gt; Combine (Sum) (4/4)#0&quot;&lt;/span&gt; #10722 prio=5 os_prio=0 tid=0x00007f8bf00db000 nid=0x6ce8 waiting on condition [0x00007f8a257d5000]
2020-11-03T20:15:40.9816219Z    java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (parking)
2020-11-03T20:15:40.9816467Z 	at sun.misc.Unsafe.park(Native Method)
2020-11-03T20:15:40.9817005Z 	- parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x000000008728caf8&amp;gt; (a java.util.concurrent.CompletableFuture$Signaller)
2020-11-03T20:15:40.9817404Z 	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
2020-11-03T20:15:40.9818064Z 	at java.util.concurrent.CompletableFuture$Signaller.block(CompletableFuture.java:1707)
2020-11-03T20:15:40.9818484Z 	at java.util.concurrent.ForkJoinPool.managedBlock(ForkJoinPool.java:3323)
2020-11-03T20:15:40.9819044Z 	at java.util.concurrent.CompletableFuture.waitingGet(CompletableFuture.java:1742)
2020-11-03T20:15:40.9819455Z 	at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1908)
2020-11-03T20:15:40.9819938Z 	at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.requestMemorySegmentBlocking(LocalBufferPool.java:313)
2020-11-03T20:15:40.9820498Z 	at org.apache.flink.runtime.io.network.buffer.LocalBufferPool.requestBufferBuilderBlocking(LocalBufferPool.java:286)
2020-11-03T20:15:40.9821095Z 	at org.apache.flink.runtime.io.network.partition.BufferWritingResultPartition.requestNewBufferBuilderFromPool(BufferWritingResultPartition.java:315)
2020-11-03T20:15:40.9821765Z 	at org.apache.flink.runtime.io.network.partition.BufferWritingResultPartition.requestNewUnicastBufferBuilder(BufferWritingResultPartition.java:292)
2020-11-03T20:15:40.9822490Z 	at org.apache.flink.runtime.io.network.partition.BufferWritingResultPartition.appendUnicastDataForNewRecord(BufferWritingResultPartition.java:232)
2020-11-03T20:15:40.9823432Z 	at org.apache.flink.runtime.io.network.partition.BufferWritingResultPartition.emitRecord(BufferWritingResultPartition.java:131)
2020-11-03T20:15:40.9823980Z 	at org.apache.flink.runtime.io.network.api.writer.RecordWriter.emit(RecordWriter.java:100)
2020-11-03T20:15:40.9824612Z 	at org.apache.flink.runtime.io.network.api.writer.ChannelSelectorRecordWriter.emit(ChannelSelectorRecordWriter.java:53)
2020-11-03T20:15:40.9825143Z 	at org.apache.flink.runtime.operators.shipping.OutputCollector.collect(OutputCollector.java:65)
2020-11-03T20:15:40.9825627Z 	at org.apache.flink.runtime.operators.util.metrics.CountingCollector.collect(CountingCollector.java:35)
2020-11-03T20:15:40.9826167Z 	at org.apache.flink.runtime.operators.hash.InPlaceMutableHashTable$ReduceFacade.emit(InPlaceMutableHashTable.java:1060)
2020-11-03T20:15:40.9826721Z 	at org.apache.flink.runtime.operators.chaining.ChainedReduceCombineDriver.close(ChainedReduceCombineDriver.java:269)
2020-11-03T20:15:40.9827201Z 	at org.apache.flink.runtime.operators.BatchTask.run(BatchTask.java:517)
2020-11-03T20:15:40.9827637Z 	at org.apache.flink.runtime.iterative.task.AbstractIterativeTask.run(AbstractIterativeTask.java:159)
2020-11-03T20:15:40.9828152Z 	at org.apache.flink.runtime.iterative.task.IterationIntermediateTask.run(IterationIntermediateTask.java:107)
2020-11-03T20:15:40.9828606Z 	at org.apache.flink.runtime.operators.BatchTask.invoke(BatchTask.java:370)
2020-11-03T20:15:40.9828998Z 	at org.apache.flink.runtime.taskmanager.Task.doRun(Task.java:722)
2020-11-03T20:15:40.9829371Z 	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:547)
2020-11-03T20:15:40.9829680Z 	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Both threads ran into this. It seems that the &lt;tt&gt;LocalBufferPool&lt;/tt&gt; ran out of buffers?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=AHeise&quot; class=&quot;user-hover&quot; rel=&quot;AHeise&quot;&gt;AHeise&lt;/a&gt; can you take a look?&lt;/p&gt;</comment>
                            <comment id="17226077" author="arvid" created="Wed, 4 Nov 2020 14:29:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; is looking into it.&lt;/p&gt;</comment>
                            <comment id="17226640" author="roman_khachatryan" created="Thu, 5 Nov 2020 10:54:57 +0000"  >&lt;p&gt;I assumed at first that it&apos;s caused by my recent addition of waiting for EndOfChannelState event.&lt;/p&gt;

&lt;p&gt;But git bisect gave a rather old commit:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
e17dbab24f4f71c5472d27267e938791686e45c3 is the first bad commit
commit e17dbab24f4f71c5472d27267e938791686e45c3
Author: Arvid Heise &amp;lt;arvid@ververica.com&amp;gt;
Date:   Fri Sep 25 14:39:17 2020 +0200

    [FLINK-16972][network] LocalBufferPool eagerly fetches global segments to ensure proper availability.

    Before &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; commit, availability of LocalBufferPool depended on a the availability of a shared NetworkBufferPool. However, &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; multiple LocalBufferPools simultaneously are available only because the NetworkBufferPool becomes available with one segment, only one of the LocalBufferPools is truly available (the one that actually acquires &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; segment).

    The solution in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; commit is to define availability only through the guaranteed ability to provide a memory segment to the consumer. If a LocalBufferPool runs out of local segments it will become unavailable until it receives a segment from the NetworkBufferPool. To minimize unavailability, LocalBufferPool first tries to eagerly fetch &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; segments before declaring unavailability and &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; that fails, the local pool subscribes to the availability to the network pool to restore availability asap.

    Additionally, LocalBufferPool would &lt;span class=&quot;code-keyword&quot;&gt;switch&lt;/span&gt; to unavailable only after it could not serve a requested memory segment. For requestBufferBuilderBlocking that is too late as it entered the blocking loop already.

    Finally, LocalBufferPool now permanently holds at least one buffer. To reflect that, the number of required segments needs to be at least one, which matches all usages in production code. A few test needed to be adjusted to properly capture the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; requirement.

:040000 040000 1331ab5652c4bfbdbed02576f4e57a87ccaa1170 4f767acd0262ba07eefbdee6b8bd717ef1957765 M      flink-runtime

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Reverting it on master solves the problem.&lt;/p&gt;

&lt;p&gt;The failure itself doesn&apos;t happen all the time. Also adding logging or running in debug mode prevents it.&lt;/p&gt;

&lt;p&gt;Given that, and that it&apos;s quite old, I&apos;d lower the priority. WDYT &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rmetzger&quot; class=&quot;user-hover&quot; rel=&quot;rmetzger&quot;&gt;rmetzger&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17226642" author="pnowojski" created="Thu, 5 Nov 2020 10:58:07 +0000"  >&lt;p&gt;Thanks for investigation &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-16972&quot; title=&quot;Fix non-blocking output availability logic.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-16972&quot;&gt;&lt;del&gt;FLINK-16972&lt;/del&gt;&lt;/a&gt; Is not that old, it was only merged in 1.12, so we should keep this ticket as release blocker. Otherwise we might release 1.12 with some serious new bug.&lt;/p&gt;</comment>
                            <comment id="17226649" author="rmetzger" created="Thu, 5 Nov 2020 11:07:09 +0000"  >&lt;p&gt;Yes, let&apos;s keep it as release blocker and fix it asap. All iterative batch jobs are probably affected by this.&lt;/p&gt;</comment>
                            <comment id="17226793" author="rmetzger" created="Thu, 5 Nov 2020 16:01:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; Is this blocker expected to be resolved before the feature freeze on Sunday?&lt;/p&gt;</comment>
                            <comment id="17227032" author="roman_khachatryan" created="Thu, 5 Nov 2020 22:25:22 +0000"  >&lt;p&gt;I&apos;m not sure, probably not.&lt;/p&gt;</comment>
                            <comment id="17227153" author="zhuzh" created="Fri, 6 Nov 2020 04:03:01 +0000"  >&lt;p&gt;We recently noticed the issue &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19994&quot; title=&quot;All vertices in an DataSet iteration job will be eagerly scheduled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19994&quot;&gt;&lt;del&gt;FLINK-19994&lt;/del&gt;&lt;/a&gt; that pipelined region scheduling will eagerly schedule all the vertices in a DataSet iteration job.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt; Is it possible that the problem is caused by downstream task allocated all available network buffers from global pool, and then the upstream task cannot obtain any buffer and get stuck? If so, I think &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19994&quot; title=&quot;All vertices in an DataSet iteration job will be eagerly scheduled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19994&quot;&gt;&lt;del&gt;FLINK-19994&lt;/del&gt;&lt;/a&gt; can fix this problem.&lt;br/&gt;
However, I cannot reproduce the problem after 1700+ runs locally. So I&apos;m not sure whether my guess is correct.&lt;/p&gt;</comment>
                            <comment id="17227368" author="rmetzger" created="Fri, 6 Nov 2020 12:24:26 +0000"  >&lt;p&gt;Another gelly test is affected too: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-20011&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-20011&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17228354" author="rmetzger" created="Mon, 9 Nov 2020 05:54:02 +0000"  >&lt;p&gt;The iterations deadlocks are happening quite frequently now. The commit Roman found bisecting is quite old. I believe a more recent change to the pipelined region scheduling is more likely to cause this instability.&lt;/p&gt;</comment>
                            <comment id="17228381" author="zhuzh" created="Mon, 9 Nov 2020 07:25:06 +0000"  >&lt;p&gt;The change &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-19189&quot; title=&quot;Enable pipelined scheduling by default&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-19189&quot;&gt;&lt;del&gt;FLINK-19189&lt;/del&gt;&lt;/a&gt; to &quot;enable pipelined region scheduling by default&quot; has been merged since 09/24, which is even older.&lt;br/&gt;
So possibly there are also other causes, which together result in this problem.&lt;/p&gt;</comment>
                            <comment id="17229274" author="rmetzger" created="Tue, 10 Nov 2020 15:08:51 +0000"  >&lt;p&gt;You are right. Given the frequency of these deadlocks, something must have been merged in the last week that triggers this.&lt;/p&gt;</comment>
                            <comment id="17229290" author="arvid" created="Tue, 10 Nov 2020 15:19:53 +0000"  >&lt;p&gt;I can confirm &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roman_khachatryan&quot; class=&quot;user-hover&quot; rel=&quot;roman_khachatryan&quot;&gt;roman_khachatryan&lt;/a&gt;&apos;s find that this is caused by e17dbab24f4f71c5472d27267e938791686e45c3. It&apos;s easy to produce locally.&lt;br/&gt;
I&apos;m assuming recent commits just changed the timing and made it more likely to appear.&lt;/p&gt;

&lt;p&gt;However, it&apos;s also interesting that locally, the test only gets stuck after &amp;gt;10 tests are run on the same mini cluster. So it may also be related to some memory leaks.&lt;/p&gt;</comment>
                            <comment id="17229465" author="arvid" created="Tue, 10 Nov 2020 19:25:25 +0000"  >&lt;p&gt;Okay here is what happens:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Two &lt;tt&gt;LocalBufferPools&lt;/tt&gt; are concurrently destroyed.&lt;/li&gt;
	&lt;li&gt;The second &lt;tt&gt;LocalBufferPool&lt;/tt&gt; still gets buffer assigned while the first one is destroyed in &lt;tt&gt;NetworkBufferPool&lt;/tt&gt; (always has been like this).&lt;/li&gt;
	&lt;li&gt;With the change in e17dbab24f4f71c5472d27267e938791686e45c3, the second &lt;tt&gt;LocalBufferPool&lt;/tt&gt; proactively acquires one of the assigned buffers.&lt;/li&gt;
	&lt;li&gt;Since it already has been destroyed this buffer is never returned to the &lt;tt&gt;NetworkBufferPool&lt;/tt&gt; and simply vanishes from heap.&lt;/li&gt;
	&lt;li&gt;With each repeated test run, the &lt;tt&gt;NetworkBufferPool&lt;/tt&gt; of the same mini-cluster has less buffers available (1 less for each concurrent release).&lt;/li&gt;
	&lt;li&gt;Eventually, there are too few buffers available to progress.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So there is a serious bug happening that needs to be fixed asap. The two obvious choices are either to not assign buffers to destroyed pools (which is expensive to detect because of different threads) and to not pro-actively take a buffer on destroyed local pool (easy to implement = old behavior).&lt;/p&gt;

&lt;p&gt;There could also be a follow-up work related to why fewer available buffer cause a deadlock instead of a fast failure.&lt;/p&gt;

&lt;p&gt;Note that the recent changes might have caused more concurrent releases of pools and thus made the issue visible.&lt;br/&gt;
Note2: no dev probably executed one of the tests locally in the last 3 months. (Yes, they happen that often locally!)&lt;/p&gt;</comment>
                            <comment id="17229466" author="rmetzger" created="Tue, 10 Nov 2020 19:30:26 +0000"  >&lt;p&gt;Thanks a lot for your analysis. I still don&apos;t understand why the issue didn&apos;t occur earlier. It has been merged at the beginning of October, but we saw the first failures in November, and that quite frequently. &lt;/p&gt;</comment>
                            <comment id="17229467" author="rmetzger" created="Tue, 10 Nov 2020 19:31:48 +0000"  >&lt;p&gt;Okay, it seems that you&apos;ve edited your comment while I posted &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="17229777" author="arvid" created="Wed, 11 Nov 2020 06:36:30 +0000"  >&lt;p&gt;Yes sorry about that, but I realized that exactly that question was unanswered &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;Merged the fix into master as 18ffebb3dbecc21d2d33c436628176c4971cebbd. Backport not applicable.&lt;/p&gt;</comment>
                            <comment id="17229801" author="rmetzger" created="Wed, 11 Nov 2020 07:15:45 +0000"  >&lt;p&gt;Thanks a lot for the fix!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13339105">FLINK-20011</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13296017">FLINK-16972</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13339105">FLINK-20011</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0k9yw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>