<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:35:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-5542] YARN client incorrectly uses local YARN config to check vcore capacity</title>
                <link>https://issues.apache.org/jira/browse/FLINK-5542</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;See &lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;When using bin/yarn-session.sh, AbstractYarnClusterDescriptor line 271 in 1.1.4 is comparing the user&apos;s selected number of vcores to the vcores configured in the local node&apos;s YARN config (from YarnConfiguration eg. yarn-site.xml and yarn-default.xml). It incorrectly prevents Flink from launching even if there is sufficient vcore capacity on the cluster.&lt;/p&gt;

&lt;p&gt;That is not correct, because the application will not necessarily run on the local node. For example, if running the yarn-session.sh client from the AWS EMR master node, the vcore count there may be different from the vcore count on the core nodes where Flink will actually run.&lt;/p&gt;

&lt;p&gt;A reasonable way to fix this would probably be to reuse the logic from &quot;yarn-session.sh -q&quot; (FlinkYarnSessionCli line 550) which knows how to get vcore information from the real worker nodes.  Alternatively, perhaps we could remove the check entirely and rely on YARN&apos;s Scheduler to determine whether sufficient resources exist.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13035707">FLINK-5542</key>
            <summary>YARN client incorrectly uses local YARN config to check vcore capacity</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rehevkor5">Shannon Carey</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 17 Jan 2017 22:35:36 +0000</created>
                <updated>Fri, 19 Oct 2018 08:16:26 +0000</updated>
                            <resolved>Tue, 9 Oct 2018 19:37:43 +0000</resolved>
                                    <version>1.1.4</version>
                    <version>1.5.3</version>
                    <version>1.6.0</version>
                    <version>1.7.0</version>
                                    <fixVersion>1.5.5</fixVersion>
                    <fixVersion>1.6.2</fixVersion>
                    <fixVersion>1.7.0</fixVersion>
                                    <component>Deployment / YARN</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16631725" author="githubbot" created="Fri, 28 Sep 2018 11:31:49 +0000"  >&lt;p&gt;leanken opened a new pull request #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   See. &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-5542&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;   use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Fetch MaxVCore num via yarnClient instead of using the local yarn conf&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change is a trivial rework / code cleanup without any test coverage.&lt;br/&gt;
   But I already reproduced the &lt;span class=&quot;error&quot;&gt;&amp;#91;Error/Exception&amp;#93;&lt;/span&gt;(&lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html&lt;/a&gt;), after the fix, it&apos;s working as expected.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16631727" author="leanken" created="Fri, 28 Sep 2018 11:32:34 +0000"  >&lt;p&gt;Hi.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rehevkor5&quot; class=&quot;user-hover&quot; rel=&quot;rehevkor5&quot;&gt;rehevkor5&lt;/a&gt;&#160; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt;, Please help review on this&#160;minimal PR. Thanks in advanced.&lt;/p&gt;</comment>
                            <comment id="16632737" author="githubbot" created="Sat, 29 Sep 2018 02:37:31 +0000"  >&lt;p&gt;leanken commented on issue #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775#issuecomment-425609144&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775#issuecomment-425609144&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   cc @rehevkor5 @tillrohrmann &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641033" author="githubbot" created="Sun, 7 Oct 2018 11:17:27 +0000"  >&lt;p&gt;tillrohrmann commented on a change in pull request #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775#discussion_r223209376&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775#discussion_r223209376&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -282,18 +282,29 @@ private void isReadyForDeployment(ClusterSpecification clusterSpecification) thr&lt;br/&gt;
 		}&lt;/p&gt;

&lt;p&gt; 		// Check if we don&apos;t exceed YARN&apos;s maximum virtual cores.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// The number of cores can be configured in the config.&lt;/li&gt;
	&lt;li&gt;// If not configured, it is set to the number of task slots&lt;/li&gt;
	&lt;li&gt;int numYarnVcores = yarnConfiguration.getInt(YarnConfiguration.NM_VCORES, YarnConfiguration.DEFAULT_NM_VCORES);&lt;br/&gt;
+		// Fetch numYarnMaxVcores from all the RUNNING nodes via yarnClient&lt;br/&gt;
+		int numYarnMaxVcores = Integer.MIN_VALUE;&lt;br/&gt;
+		try {&lt;br/&gt;
+			List&amp;lt;NodeReport&amp;gt; nodes = yarnClient.getNodeReports(NodeState.RUNNING);&lt;br/&gt;
+			for (NodeReport rep : nodes) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+				final Resource res = rep.getCapability();+				if (res.getVirtualCores() &amp;gt; numYarnMaxVcores) {
+					numYarnMaxVcores = res.getVirtualCores();
+				}+			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+		} catch (Exception e) &lt;/p&gt;
{
+			throw new YarnDeploymentException(&quot;Couldn&apos;t get cluster description, please check on the YarnConfiguration&quot;, e);
+		}
&lt;p&gt;+&lt;br/&gt;
 		int configuredVcores = flinkConfiguration.getInteger(YarnConfigOptions.VCORES, clusterSpecification.getSlotsPerTaskManager());&lt;br/&gt;
 		// don&apos;t configure more than the maximum configured number of vcores&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (configuredVcores &amp;gt; numYarnVcores) {&lt;br/&gt;
+		if (configuredVcores &amp;gt; numYarnMaxVcores) {&lt;br/&gt;
 			throw new IllegalConfigurationException(&lt;br/&gt;
 				String.format(&quot;The number of virtual cores per node were configured with %d&quot; +&lt;/li&gt;
	&lt;li&gt;&quot; but Yarn only has %d virtual cores available. Please note that the number&quot; +&lt;br/&gt;
+						&quot; already exceeds the max vcores %d set on Yarn Cluster. Please note that the number&quot; +&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   Maybe reword: &quot;The number of requested virtual cores per node %d exceeds the maximum number virtual cores %d available in the Yarn cluster.&quot;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641087" author="githubbot" created="Sun, 7 Oct 2018 14:54:54 +0000"  >&lt;p&gt;leanken commented on issue #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775#issuecomment-427659457&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775#issuecomment-427659457&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks for your review. @tillrohrmann &lt;br/&gt;
   Resolved your comment. Looking forward for further work at FLINK community. About the proposal you mentioned on having a exhaustive check on job submission, I will try go through more submit scenarios and see if what we can do to achieve the exhaustive check goal and create a new follow up issue, thanks.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641088" author="githubbot" created="Sun, 7 Oct 2018 14:55:32 +0000"  >&lt;p&gt;leanken edited a comment on issue #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775#issuecomment-427659457&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775#issuecomment-427659457&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Thanks for your review. @tillrohrmann &lt;br/&gt;
   Resolved your comment. Looking forward for further work at FLINK community. About the proposal you mentioned on having a exhaustive check on job submission, I will try go through more submit scenarios and see what we can do to achieve the exhaustive check goal and create a new follow up issue, thanks.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641293" author="githubbot" created="Mon, 8 Oct 2018 02:20:14 +0000"  >&lt;p&gt;leanken commented on issue #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775#issuecomment-427707833&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775#issuecomment-427707833&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   All checks passed, ready to merge. @tillrohrmann @GJL &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641539" author="githubbot" created="Mon, 8 Oct 2018 08:49:59 +0000"  >&lt;p&gt;GJL commented on issue #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775#issuecomment-427761358&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775#issuecomment-427761358&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Hi, I am taking a look again.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641540" author="githubbot" created="Mon, 8 Oct 2018 08:49:59 +0000"  >&lt;p&gt;GJL closed pull request #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java b/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java&lt;br/&gt;
index c3ad9f7f42c..31aaadfbfb8 100644&lt;br/&gt;
&amp;#8212; a/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java&lt;br/&gt;
+++ b/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java&lt;br/&gt;
@@ -282,18 +282,29 @@ private void isReadyForDeployment(ClusterSpecification clusterSpecification) thr&lt;br/&gt;
 		}&lt;/p&gt;

&lt;p&gt; 		// Check if we don&apos;t exceed YARN&apos;s maximum virtual cores.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// The number of cores can be configured in the config.&lt;/li&gt;
	&lt;li&gt;// If not configured, it is set to the number of task slots&lt;/li&gt;
	&lt;li&gt;int numYarnVcores = yarnConfiguration.getInt(YarnConfiguration.NM_VCORES, YarnConfiguration.DEFAULT_NM_VCORES);&lt;br/&gt;
+		// Fetch numYarnMaxVcores from all the RUNNING nodes via yarnClient&lt;br/&gt;
+		int numYarnMaxVcores = Integer.MIN_VALUE;&lt;br/&gt;
+		try {&lt;br/&gt;
+			List&amp;lt;NodeReport&amp;gt; nodes = yarnClient.getNodeReports(NodeState.RUNNING);&lt;br/&gt;
+			for (NodeReport rep : nodes) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+				final Resource res = rep.getCapability();+				if (res.getVirtualCores() &amp;gt; numYarnMaxVcores) {
+					numYarnMaxVcores = res.getVirtualCores();
+				}+			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+		} catch (Exception e) &lt;/p&gt;
{
+			throw new YarnDeploymentException(&quot;Couldn&apos;t get cluster description, please check on the YarnConfiguration&quot;, e);
+		}
&lt;p&gt;+&lt;br/&gt;
 		int configuredVcores = flinkConfiguration.getInteger(YarnConfigOptions.VCORES, clusterSpecification.getSlotsPerTaskManager());&lt;br/&gt;
 		// don&apos;t configure more than the maximum configured number of vcores&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (configuredVcores &amp;gt; numYarnVcores) {&lt;br/&gt;
+		if (configuredVcores &amp;gt; numYarnMaxVcores) 
{
 			throw new IllegalConfigurationException(
-				String.format(&quot;The number of virtual cores per node were configured with %d&quot; +
-						&quot; but Yarn only has %d virtual cores available. Please note that the number&quot; +
-						&quot; of virtual cores is set to the number of task slots by default unless configured&quot; +
-						&quot; in the Flink config with &apos;%s.&apos;&quot;,
-					configuredVcores, numYarnVcores, YarnConfigOptions.VCORES.key()));
+				String.format(&quot;The number of requested virtual cores per node %d&quot; +
+						&quot; exceeds the maximum number virtual cores %d available in the Yarn Cluster.&quot; +
+						&quot; Please note that the number of virtual cores is set to the number of task slots by default&quot; +
+						&quot; unless configured in the Flink config with &apos;%s.&apos;&quot;,
+					configuredVcores, numYarnMaxVcores, YarnConfigOptions.VCORES.key()));
 		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		// check if required Hadoop environment variables are set. If not, warn user&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641541" author="githubbot" created="Mon, 8 Oct 2018 08:50:03 +0000"  >&lt;p&gt;leanken opened a new pull request #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775&lt;/a&gt;&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;What is the purpose of the change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   See. &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-5542&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;   use YarnCluster vcores setting to do MaxVCore validation instead of using the local yarn conf.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Brief change log&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;b&gt;Fetch MaxVCore num via yarnClient instead of using the local yarn conf&lt;/b&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Verifying this change&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   This change is a trivial rework / code cleanup without any test coverage.&lt;br/&gt;
   But I already reproduced the &lt;span class=&quot;error&quot;&gt;&amp;#91;Error/Exception&amp;#93;&lt;/span&gt;(&lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/1-1-4-on-YARN-vcores-change-td11016.html&lt;/a&gt;), after the fix, it&apos;s working as expected.&lt;/p&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Does this pull request potentially affect one of the following parts:&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Dependencies (does it add or upgrade a dependency): (no)&lt;/li&gt;
	&lt;li&gt;The public API, i.e., is any changed class annotated with `@Public(Evolving)`: (no)&lt;/li&gt;
	&lt;li&gt;The serializers: (no)&lt;/li&gt;
	&lt;li&gt;The runtime per-record code paths (performance sensitive): (no)&lt;/li&gt;
	&lt;li&gt;Anything that affects deployment or recovery: JobManager (and its components), Checkpointing, Yarn/Mesos, ZooKeeper: (no)&lt;/li&gt;
	&lt;li&gt;The S3 file system connector: (no)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;Documentation&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Does this pull request introduce a new feature? (no)&lt;/li&gt;
	&lt;li&gt;If yes, how is the feature documented? (not documented)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641543" author="githubbot" created="Mon, 8 Oct 2018 08:50:38 +0000"  >&lt;p&gt;GJL edited a comment on issue #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775#issuecomment-427761358&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775#issuecomment-427761358&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Hi, I am taking a looking.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641544" author="githubbot" created="Mon, 8 Oct 2018 08:50:45 +0000"  >&lt;p&gt;GJL edited a comment on issue #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775#issuecomment-427761358&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775#issuecomment-427761358&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Hi, I am taking a look.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641545" author="githubbot" created="Mon, 8 Oct 2018 08:51:46 +0000"  >&lt;p&gt;GJL edited a comment on issue #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775#issuecomment-427761358&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775#issuecomment-427761358&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Hi, I am taking a look now.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641584" author="githubbot" created="Mon, 8 Oct 2018 09:36:54 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775#discussion_r223300816&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775#discussion_r223300816&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -282,18 +282,29 @@ private void isReadyForDeployment(ClusterSpecification clusterSpecification) thr&lt;br/&gt;
 		}&lt;/p&gt;

&lt;p&gt; 		// Check if we don&apos;t exceed YARN&apos;s maximum virtual cores.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// The number of cores can be configured in the config.&lt;/li&gt;
	&lt;li&gt;// If not configured, it is set to the number of task slots&lt;/li&gt;
	&lt;li&gt;int numYarnVcores = yarnConfiguration.getInt(YarnConfiguration.NM_VCORES, YarnConfiguration.DEFAULT_NM_VCORES);&lt;br/&gt;
+		// Fetch numYarnMaxVcores from all the RUNNING nodes via yarnClient&lt;br/&gt;
+		int numYarnMaxVcores = Integer.MIN_VALUE;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   How about:&lt;br/&gt;
   ```&lt;br/&gt;
   		final int numYarnMaxVcores;&lt;br/&gt;
   		try &lt;/p&gt;
{
   			numYarnMaxVcores = yarnClient.getNodeReports(NodeState.RUNNING)
   				.stream()
   				.mapToInt(report -&amp;gt; report.getCapability().getVirtualCores())
   				.max()
   				.orElse(0);
   		}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
   			throw new YarnDeploymentException(&quot;Couldn&apos;t get cluster description, please check on the YarnConfiguration&quot;, e);
   		}
&lt;p&gt;   ```&lt;br/&gt;
   ?&lt;/p&gt;

&lt;p&gt;   Pros of doing so:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;`numYarnMaxVcores` is final&lt;/li&gt;
	&lt;li&gt;If no NodeManagers are running at all, we would log `0` vcores instead of `Integer.MIN_VALUE`&lt;/li&gt;
	&lt;li&gt;Concise &amp;amp; easy to read&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641585" author="githubbot" created="Mon, 8 Oct 2018 09:36:54 +0000"  >&lt;p&gt;GJL commented on a change in pull request #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775#discussion_r223301904&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775#discussion_r223301904&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -282,18 +282,29 @@ private void isReadyForDeployment(ClusterSpecification clusterSpecification) thr&lt;br/&gt;
 		}&lt;/p&gt;

&lt;p&gt; 		// Check if we don&apos;t exceed YARN&apos;s maximum virtual cores.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// The number of cores can be configured in the config.&lt;/li&gt;
	&lt;li&gt;// If not configured, it is set to the number of task slots&lt;/li&gt;
	&lt;li&gt;int numYarnVcores = yarnConfiguration.getInt(YarnConfiguration.NM_VCORES, YarnConfiguration.DEFAULT_NM_VCORES);&lt;br/&gt;
+		// Fetch numYarnMaxVcores from all the RUNNING nodes via yarnClient&lt;br/&gt;
+		int numYarnMaxVcores = Integer.MIN_VALUE;&lt;br/&gt;
+		try {&lt;br/&gt;
+			List&amp;lt;NodeReport&amp;gt; nodes = yarnClient.getNodeReports(NodeState.RUNNING);&lt;br/&gt;
+			for (NodeReport rep : nodes) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+				final Resource res = rep.getCapability();+				if (res.getVirtualCores() &amp;gt; numYarnMaxVcores) {
+					numYarnMaxVcores = res.getVirtualCores();
+				}+			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+		} catch (Exception e) &lt;/p&gt;
{
+			throw new YarnDeploymentException(&quot;Couldn&apos;t get cluster description, please check on the YarnConfiguration&quot;, e);
+		}
&lt;p&gt;+&lt;br/&gt;
 		int configuredVcores = flinkConfiguration.getInteger(YarnConfigOptions.VCORES, clusterSpecification.getSlotsPerTaskManager());&lt;br/&gt;
 		// don&apos;t configure more than the maximum configured number of vcores&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (configuredVcores &amp;gt; numYarnVcores) {&lt;br/&gt;
+		if (configuredVcores &amp;gt; numYarnMaxVcores) {&lt;br/&gt;
 			throw new IllegalConfigurationException(&lt;/li&gt;
	&lt;li&gt;String.format(&quot;The number of virtual cores per node were configured with %d&quot; +&lt;/li&gt;
	&lt;li&gt;&quot; but Yarn only has %d virtual cores available. Please note that the number&quot; +&lt;/li&gt;
	&lt;li&gt;&quot; of virtual cores is set to the number of task slots by default unless configured&quot; +&lt;/li&gt;
	&lt;li&gt;&quot; in the Flink config with &apos;%s.&apos;&quot;,&lt;/li&gt;
	&lt;li&gt;configuredVcores, numYarnVcores, YarnConfigOptions.VCORES.key()));&lt;br/&gt;
+				String.format(&quot;The number of requested virtual cores per node %d&quot; +&lt;br/&gt;
+						&quot; exceeds the maximum number virtual cores %d available in the Yarn Cluster.&quot; +&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   I think it  should be: &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; &lt;em&gt;maximum number *&lt;b&gt;of&lt;/b&gt;* virtual cores&lt;/em&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641590" author="githubbot" created="Mon, 8 Oct 2018 09:39:15 +0000"  >&lt;p&gt;leanken commented on a change in pull request #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775#discussion_r223303030&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775#discussion_r223303030&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -282,18 +282,29 @@ private void isReadyForDeployment(ClusterSpecification clusterSpecification) thr&lt;br/&gt;
 		}&lt;/p&gt;

&lt;p&gt; 		// Check if we don&apos;t exceed YARN&apos;s maximum virtual cores.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// The number of cores can be configured in the config.&lt;/li&gt;
	&lt;li&gt;// If not configured, it is set to the number of task slots&lt;/li&gt;
	&lt;li&gt;int numYarnVcores = yarnConfiguration.getInt(YarnConfiguration.NM_VCORES, YarnConfiguration.DEFAULT_NM_VCORES);&lt;br/&gt;
+		// Fetch numYarnMaxVcores from all the RUNNING nodes via yarnClient&lt;br/&gt;
+		int numYarnMaxVcores = Integer.MIN_VALUE;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   this way sure better than mine. I will do the update, thanks @GJL &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641609" author="githubbot" created="Mon, 8 Oct 2018 10:02:50 +0000"  >&lt;p&gt;leanken commented on a change in pull request #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775#discussion_r223309660&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775#discussion_r223309660&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -282,18 +282,29 @@ private void isReadyForDeployment(ClusterSpecification clusterSpecification) thr&lt;br/&gt;
 		}&lt;/p&gt;

&lt;p&gt; 		// Check if we don&apos;t exceed YARN&apos;s maximum virtual cores.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// The number of cores can be configured in the config.&lt;/li&gt;
	&lt;li&gt;// If not configured, it is set to the number of task slots&lt;/li&gt;
	&lt;li&gt;int numYarnVcores = yarnConfiguration.getInt(YarnConfiguration.NM_VCORES, YarnConfiguration.DEFAULT_NM_VCORES);&lt;br/&gt;
+		// Fetch numYarnMaxVcores from all the RUNNING nodes via yarnClient&lt;br/&gt;
+		int numYarnMaxVcores = Integer.MIN_VALUE;&lt;br/&gt;
+		try {&lt;br/&gt;
+			List&amp;lt;NodeReport&amp;gt; nodes = yarnClient.getNodeReports(NodeState.RUNNING);&lt;br/&gt;
+			for (NodeReport rep : nodes) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+				final Resource res = rep.getCapability();+				if (res.getVirtualCores() &amp;gt; numYarnMaxVcores) {
+					numYarnMaxVcores = res.getVirtualCores();
+				}+			}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+		} catch (Exception e) &lt;/p&gt;
{
+			throw new YarnDeploymentException(&quot;Couldn&apos;t get cluster description, please check on the YarnConfiguration&quot;, e);
+		}
&lt;p&gt;+&lt;br/&gt;
 		int configuredVcores = flinkConfiguration.getInteger(YarnConfigOptions.VCORES, clusterSpecification.getSlotsPerTaskManager());&lt;br/&gt;
 		// don&apos;t configure more than the maximum configured number of vcores&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (configuredVcores &amp;gt; numYarnVcores) {&lt;br/&gt;
+		if (configuredVcores &amp;gt; numYarnMaxVcores) {&lt;br/&gt;
 			throw new IllegalConfigurationException(&lt;/li&gt;
	&lt;li&gt;String.format(&quot;The number of virtual cores per node were configured with %d&quot; +&lt;/li&gt;
	&lt;li&gt;&quot; but Yarn only has %d virtual cores available. Please note that the number&quot; +&lt;/li&gt;
	&lt;li&gt;&quot; of virtual cores is set to the number of task slots by default unless configured&quot; +&lt;/li&gt;
	&lt;li&gt;&quot; in the Flink config with &apos;%s.&apos;&quot;,&lt;/li&gt;
	&lt;li&gt;configuredVcores, numYarnVcores, YarnConfigOptions.VCORES.key()));&lt;br/&gt;
+				String.format(&quot;The number of requested virtual cores per node %d&quot; +&lt;br/&gt;
+						&quot; exceeds the maximum number virtual cores %d available in the Yarn Cluster.&quot; +&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   resolved exception msg typo&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641610" author="githubbot" created="Mon, 8 Oct 2018 10:03:16 +0000"  >&lt;p&gt;leanken commented on a change in pull request #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775#discussion_r223309773&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775#discussion_r223309773&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -282,18 +282,29 @@ private void isReadyForDeployment(ClusterSpecification clusterSpecification) thr&lt;br/&gt;
 		}&lt;/p&gt;

&lt;p&gt; 		// Check if we don&apos;t exceed YARN&apos;s maximum virtual cores.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// The number of cores can be configured in the config.&lt;/li&gt;
	&lt;li&gt;// If not configured, it is set to the number of task slots&lt;/li&gt;
	&lt;li&gt;int numYarnVcores = yarnConfiguration.getInt(YarnConfiguration.NM_VCORES, YarnConfiguration.DEFAULT_NM_VCORES);&lt;br/&gt;
+		// Fetch numYarnMaxVcores from all the RUNNING nodes via yarnClient&lt;br/&gt;
+		int numYarnMaxVcores = Integer.MIN_VALUE;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; Review comment:&lt;br/&gt;
   update done and passed local verification&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641612" author="githubbot" created="Mon, 8 Oct 2018 10:03:51 +0000"  >&lt;p&gt;leanken commented on issue #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775#issuecomment-427780528&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775#issuecomment-427780528&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @GJL resolved yours comments.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16641990" author="githubbot" created="Mon, 8 Oct 2018 15:07:54 +0000"  >&lt;p&gt;GJL commented on issue #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775#issuecomment-427871290&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775#issuecomment-427871290&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   LGTM, merging as soon as build is green.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16642916" author="githubbot" created="Tue, 9 Oct 2018 07:45:00 +0000"  >&lt;p&gt;leanken commented on issue #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775#issuecomment-428093652&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775#issuecomment-428093652&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @GJL Kindly remind. Build is ready to go.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16643990" author="githubbot" created="Tue, 9 Oct 2018 19:35:31 +0000"  >&lt;p&gt;asfgit closed pull request #6775: &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-5542&quot; title=&quot;YARN client incorrectly uses local YARN config to check vcore capacity&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-5542&quot;&gt;&lt;del&gt;FLINK-5542&lt;/del&gt;&lt;/a&gt; use YarnCluster vcores setting to do MaxVCore validation&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/flink/pull/6775&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/6775&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java b/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java&lt;br/&gt;
index c3ad9f7f42c..c161e227577 100644&lt;br/&gt;
&amp;#8212; a/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java&lt;br/&gt;
+++ b/flink-yarn/src/main/java/org/apache/flink/yarn/AbstractYarnClusterDescriptor.java&lt;br/&gt;
@@ -282,18 +282,27 @@ private void isReadyForDeployment(ClusterSpecification clusterSpecification) thr&lt;br/&gt;
 		}&lt;/p&gt;

&lt;p&gt; 		// Check if we don&apos;t exceed YARN&apos;s maximum virtual cores.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// The number of cores can be configured in the config.&lt;/li&gt;
	&lt;li&gt;// If not configured, it is set to the number of task slots&lt;/li&gt;
	&lt;li&gt;int numYarnVcores = yarnConfiguration.getInt(YarnConfiguration.NM_VCORES, YarnConfiguration.DEFAULT_NM_VCORES);&lt;br/&gt;
+		// Fetch numYarnMaxVcores from all the RUNNING nodes via yarnClient&lt;br/&gt;
+		final int numYarnMaxVcores;&lt;br/&gt;
+		try 
{
+			numYarnMaxVcores = yarnClient.getNodeReports(NodeState.RUNNING)
+				.stream()
+				.mapToInt(report -&amp;gt; report.getCapability().getVirtualCores())
+				.max()
+				.orElse(0);
+		}
&lt;p&gt; catch (Exception e) &lt;/p&gt;
{
+			throw new YarnDeploymentException(&quot;Couldn&apos;t get cluster description, please check on the YarnConfiguration&quot;, e);
+		}
&lt;p&gt;+&lt;br/&gt;
 		int configuredVcores = flinkConfiguration.getInteger(YarnConfigOptions.VCORES, clusterSpecification.getSlotsPerTaskManager());&lt;br/&gt;
 		// don&apos;t configure more than the maximum configured number of vcores&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;if (configuredVcores &amp;gt; numYarnVcores) {&lt;br/&gt;
+		if (configuredVcores &amp;gt; numYarnMaxVcores) 
{
 			throw new IllegalConfigurationException(
-				String.format(&quot;The number of virtual cores per node were configured with %d&quot; +
-						&quot; but Yarn only has %d virtual cores available. Please note that the number&quot; +
-						&quot; of virtual cores is set to the number of task slots by default unless configured&quot; +
-						&quot; in the Flink config with &apos;%s.&apos;&quot;,
-					configuredVcores, numYarnVcores, YarnConfigOptions.VCORES.key()));
+				String.format(&quot;The number of requested virtual cores per node %d&quot; +
+						&quot; exceeds the maximum number of virtual cores %d available in the Yarn Cluster.&quot; +
+						&quot; Please note that the number of virtual cores is set to the number of task slots by default&quot; +
+						&quot; unless configured in the Flink config with &apos;%s.&apos;&quot;,
+					configuredVcores, numYarnMaxVcores, YarnConfigOptions.VCORES.key()));
 		}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; 		// check if required Hadoop environment variables are set. If not, warn user&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16643992" author="gjy" created="Tue, 9 Oct 2018 19:37:43 +0000"  >&lt;p&gt;fixed via&lt;/p&gt;

&lt;p&gt;1.5: 5fb67abd51aca277d1140c274001e89f4bd7cf9a&lt;br/&gt;
1.6: 5b3211c6f02cf935308e3ff9ebf9cd1deff24d73&lt;br/&gt;
1.7: e959e6d0cd42f0c5b21c0f03ce547f2025ac58d5&lt;/p&gt;

</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13059128">FLINK-6189</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 6 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i38ugv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>