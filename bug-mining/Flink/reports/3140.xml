<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:40:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-12171] The network buffer memory size should not be checked against the heap size on the TM side</title>
                <link>https://issues.apache.org/jira/browse/FLINK-12171</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Currently when computing the network buffer memory size on the TM side in &lt;em&gt;TaskManagerService#calculateNetworkBufferMemory&lt;/em&gt;`(version 1.8 or 1.7) or &lt;em&gt;NetworkEnvironmentConfiguration#calculateNewNetworkBufferMemory&lt;/em&gt;(master), the computed network buffer memory size is checked to be less than `maxJvmHeapMemory`. However, in TM side,&#160;&lt;em&gt;maxJvmHeapMemory&lt;/em&gt; stores the maximum heap memory (namely -Xmx) .&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;With the above process, when TM&#160;starts, -Xmx is computed in RM or in &lt;em&gt;taskmanager.sh&lt;/em&gt; with (container memory - network buffer memory - managed memory),&#160; thus the above checking implies that the heap memory of the TM must be larger than the network memory, which seems to be not necessary.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This may cause TM&#160;to use more memory than expected. For example, for a job who has a large network throughput, uses may configure network memory to 2G. However, if users want to assign 1G to heap memory, the TM will fail to start, and user has to allocate at least 2G heap memory (in other words, 4G in total for the TM instead of 3G) to make the TM runnable. This may cause resource inefficiency.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Therefore, I think the&#160;network buffer memory size also need to be checked against the total memory instead of the heap memory on the TM&#160; side:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Checks that networkBufFraction &amp;lt; 1.0.&lt;/li&gt;
	&lt;li&gt;Compute the total memory by ( jvmHeapNoNet / (1 - networkBufFraction)).&lt;/li&gt;
	&lt;li&gt;Compare the network buffer memory with the total memory.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This checking is also consistent with the similar&#160;one done on the RM side.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Flink-1.7.2, and Flink-1.8 seems have not modified the logic here.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</environment>
        <key id="13227691">FLINK-12171</key>
            <summary>The network buffer memory size should not be checked against the heap size on the TM side</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gaoyunhaii">Yun Gao</assignee>
                                    <reporter username="gaoyunhaii">Yun Gao</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 12 Apr 2019 11:55:37 +0000</created>
                <updated>Tue, 30 Jul 2019 10:10:56 +0000</updated>
                            <resolved>Tue, 30 Jul 2019 10:10:39 +0000</resolved>
                                    <version>1.7.2</version>
                    <version>1.8.0</version>
                    <version>1.9.0</version>
                                    <fixVersion>1.10.0</fixVersion>
                                    <component>Runtime / Network</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16849304" author="gaoyunhaii" created="Tue, 28 May 2019 03:34:38 +0000"  >&lt;p&gt;After further analyze this problem, now I think we do not need to check the maximum allowed memory&#160;on TM side.&lt;/p&gt;

&lt;p&gt;For RM side, we compute the network memory size from the total memory size, there may be cases that the configured MIN and MAX is too large that the resulted network memory is larger than the total memory size, we need to check against that.&lt;/p&gt;

&lt;p&gt;However, on TM side, we do not know the total memory size, instead we only know the heap size. We can only deduce the total memory size by heap size + computed network memory,&#160;which is always larger than the computed network memory.&#160;&lt;/p&gt;

&lt;p&gt;Therefore, unless we ensure the total memory size is available on the TM&#160;side and we also compute the network memory size from the total memory size on TM side, we can not check the network memory size.&lt;/p&gt;

&lt;p&gt;According to the above analysis, I think we can first remove the comparison of the network memory size and heap memory size directly. This comparison is not right since the network memory is not part of the heap memory, and it may raise error when the configuration is in fact reasonable.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16862937" author="gaoyunhaii" created="Thu, 13 Jun 2019 10:58:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pnowojski&quot; class=&quot;user-hover&quot; rel=&quot;pnowojski&quot;&gt;pnowojski&lt;/a&gt;&#160; very sorry to disturb, but I would like to know how do you think about this issue?&#160;&lt;/p&gt;</comment>
                            <comment id="16895986" author="nicok" created="Tue, 30 Jul 2019 10:10:39 +0000"  >&lt;p&gt;fixed via 8dec21f&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 16 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z01q4w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>