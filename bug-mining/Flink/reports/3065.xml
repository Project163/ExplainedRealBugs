<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:39:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-12889] Job keeps in FAILING state</title>
                <link>https://issues.apache.org/jira/browse/FLINK-12889</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;There is a topology of 3 operator, such as, source, parser, and persist. Occasionally, 5 subtasks of the source encounters exception and turns to failed, at the same time, one subtask of the parser runs into exception and turns to failed too. The jobmaster gets a message of the parser&apos;s failed. The jobmaster then try to cancel all the subtask, most of the subtasks of the three operator turns to canceled except the 5 subtasks of the source, because the state of the 5 ones is already FAILED before jobmaster try to cancel it. Then the jobmaster can not reach a final state but keeps in&#160;&#160;Failing state meanwhile the subtask of the source kees in canceling state.&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
The job run on a flink 1.7 cluster on yarn, and there is only one tm with 10 slots.&lt;br/&gt;
&#160;&lt;br/&gt;
The attached files contains a jm log , tm log and the ui picture.&lt;br/&gt;
&#160;&lt;br/&gt;
The exception timestamp is about&#160;2019-06-16 13:42:28.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13240208">FLINK-12889</key>
            <summary>Job keeps in FAILING state</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="trohrmann">Till Rohrmann</assignee>
                                    <reporter username="xinpu">Fan Xinpu</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 18 Jun 2019 13:37:07 +0000</created>
                <updated>Fri, 5 Jul 2019 08:42:25 +0000</updated>
                            <resolved>Fri, 5 Jul 2019 08:42:25 +0000</resolved>
                                    <version>1.7.2</version>
                    <version>1.8.1</version>
                    <version>1.9.0</version>
                                    <fixVersion>1.7.3</fixVersion>
                    <fixVersion>1.8.2</fixVersion>
                    <fixVersion>1.9.0</fixVersion>
                                    <component>Runtime / Task</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="16872933" author="zjwang" created="Wed, 26 Jun 2019 05:31:01 +0000"  >&lt;p&gt;My previous analysis in ML was as follows:&lt;br/&gt;
 &#160;&lt;br/&gt;
 Actually all the five &quot;Source:&#160;ServiceLog&quot; tasks are not in terminal state on JM view, the relevant processes shown in below:&#160;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The checkpoint in task causes OOM issue which would call `Task#failExternally` as a result, we could see the log &quot;Attempting to fail task externally&quot; in TM.&lt;/li&gt;
	&lt;li&gt;The source task would transform state from RUNNING to FAILED and then starts a canceler thread for canceling task, we could see log &quot;Triggering cancellation of task&quot; in TM.&lt;/li&gt;
	&lt;li&gt;When JM starts to cancel the source tasks, the rpc call `Task#cancelExecution` would find the task was already in FAILED state as above step 2, we could see log &quot;Attempting to cancel task&quot; in TM.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;br/&gt;
 At last all the five source tasks are not in terminal states from jm log, I guess the step 2 might not create canceler thread successfully, because the root failover was caused by OOM during creating native thread in step1, so it might exist possibilities that createing canceler thread is not successful as well in OOM case which is unstable.&#160;If so, the source task would not been interrupted at all, then it would not report to JM as well, but the state is already changed to FAILED before.&#160;&lt;br/&gt;
 &#160;&lt;br/&gt;
 For the other vertex tasks, it does not trigger `Task#failExternally` in step 1, and only receives the cancel rpc from JM in step 3. And I guess at this time later than the source period, the canceler thread could be created succesfully after some GCs, then these tasks could be canceled as reported to JM side.&lt;br/&gt;
 &#160;&lt;br/&gt;
 I think the key problem is under OOM case some behaviors are not within expectations, so it might bring problems. Maybe we should handle OOM error in extreme way like making TM exit to solve the potential issue.&lt;br/&gt;
 &#160;&lt;br/&gt;
 &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=till.rohrmann&quot; class=&quot;user-hover&quot; rel=&quot;till.rohrmann&quot;&gt;till.rohrmann&lt;/a&gt; do you think it is worth fixing or have other concerns?&lt;/p&gt;</comment>
                            <comment id="16876799" author="till.rohrmann" created="Tue, 2 Jul 2019 09:03:20 +0000"  >&lt;p&gt;Thanks for reporting this issue &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xinpu&quot; class=&quot;user-hover&quot; rel=&quot;xinpu&quot;&gt;xinpu&lt;/a&gt; and the analysis &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zjwang&quot; class=&quot;user-hover&quot; rel=&quot;zjwang&quot;&gt;zjwang&lt;/a&gt;. I think your analysis is correct. The problem is that we don&apos;t catch the last OOM when creating the task canceller thread. This should indeed kill the TM process because it is no longer guaranteed that this Flink process works correctly.&lt;/p&gt;

&lt;p&gt;I would suggest to create the &lt;tt&gt;StreamTask#asyncOperationsThreadPool&lt;/tt&gt; with a &lt;tt&gt;FatalExitExceptionHandler&lt;/tt&gt; as an uncaught exception handler. This should cause the TM to exit in a situation you&apos;ve described &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xinpu&quot; class=&quot;user-hover&quot; rel=&quot;xinpu&quot;&gt;xinpu&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16879071" author="till.rohrmann" created="Fri, 5 Jul 2019 08:42:25 +0000"  >&lt;p&gt;Fixed via&lt;br/&gt;
1.9.0: 28ac5ef7f1769e9256b3089ed4853736771ae457&lt;br/&gt;
1.8.2: fbfe7d4db8242e4db3c779b3526f6eaa0c599e40&lt;br/&gt;
1.7.3: 7aad9649b83387f86d076014654f3af091640c05&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12972098" name="20190618104945417.jpg" size="66637" author="xinpu" created="Tue, 18 Jun 2019 13:36:11 +0000"/>
                            <attachment id="12972099" name="jobmanager.log.2019-06-16.0" size="751644" author="xinpu" created="Tue, 18 Jun 2019 13:36:03 +0000"/>
                            <attachment id="12972100" name="taskmanager.log" size="8042094" author="xinpu" created="Tue, 18 Jun 2019 13:37:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 19 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z03v5k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>