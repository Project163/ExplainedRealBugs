<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:40:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-13159] java.lang.ClassNotFoundException when restore job</title>
                <link>https://issues.apache.org/jira/browse/FLINK-13159</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.Exception: Exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; creating StreamOperatorStateContext.
at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.streamOperatorStateContext(StreamTaskStateInitializerImpl.java:195)
at org.apache.flink.streaming.api.operators.AbstractStreamOperator.initializeState(AbstractStreamOperator.java:250)
at org.apache.flink.streaming.runtime.tasks.StreamTask.initializeState(StreamTask.java:738)
at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:289)
at org.apache.flink.runtime.taskmanager.Task.run(Task.java:711)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: org.apache.flink.util.FlinkException: Could not restore keyed state backend &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; WindowOperator_b398b3dd4c544ddf2d47a0cc47d332f4_(1/6) from any of the 1 prov
ided restore options.
at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.createAndRestore(BackendRestorerProcedure.java:135)
at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.keyedStatedBackend(StreamTaskStateInitializerImpl.java:307)
at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.streamOperatorStateContext(StreamTaskStateInitializerImpl.java:135)
... 5 common frames omitted
Caused by: org.apache.flink.runtime.state.BackendBuildingException: Failed when trying to restore heap backend
at org.apache.flink.runtime.state.heap.HeapKeyedStateBackendBuilder.build(HeapKeyedStateBackendBuilder.java:130)
at org.apache.flink.runtime.state.filesystem.FsStateBackend.createKeyedStateBackend(FsStateBackend.java:489)
at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.lambda$keyedStatedBackend$1(StreamTaskStateInitializerImpl.java:291)
at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.attemptCreateAndRestore(BackendRestorerProcedure.java:142)
at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.createAndRestore(BackendRestorerProcedure.java:121)
... 7 common frames omitted
Caused by: java.lang.RuntimeException: Cannot instantiate class.
at org.apache.flink.api.java.typeutils.runtime.PojoSerializer.deserialize(PojoSerializer.java:384)
at org.apache.flink.runtime.state.heap.StateTableByKeyGroupReaders.lambda$createV2PlusReader$0(StateTableByKeyGroupReaders.java:74)
at org.apache.flink.runtime.state.KeyGroupPartitioner$PartitioningResultKeyGroupReader.readMappingsInKeyGroup(KeyGroupPartitioner.java:297)
at org.apache.flink.runtime.state.heap.HeapRestoreOperation.readKeyGroupStateData(HeapRestoreOperation.java:290)
at org.apache.flink.runtime.state.heap.HeapRestoreOperation.readStateHandleStateData(HeapRestoreOperation.java:251)
at org.apache.flink.runtime.state.heap.HeapRestoreOperation.restore(HeapRestoreOperation.java:153)
at org.apache.flink.runtime.state.heap.HeapKeyedStateBackendBuilder.build(HeapKeyedStateBackendBuilder.java:127)
... 11 common frames omitted
Caused by: java.lang.ClassNotFoundException: xxx
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName0(Native Method)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:348)
at org.apache.flink.api.java.typeutils.runtime.PojoSerializer.deserialize(PojoSerializer.java:382)
... 17 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;A strange problem with Flink is that after a task has been running properly for a period of time, if any exception (such as ask timeout or ES request timeout) is thrown, the task restart will report the above error (xxx is a business model), and ten subsequent retries will not succeed, but the task will be resubmitted. Then it can run normally. In addition, there are three other tasks running at the same time, none of which has the problem.&lt;/p&gt;

&lt;p&gt;My flink version is 1.8.0.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13243802">FLINK-13159</key>
            <summary>java.lang.ClassNotFoundException when restore job</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yunta">Yun Tang</assignee>
                                    <reporter username="kring">kring</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 9 Jul 2019 03:10:18 +0000</created>
                <updated>Thu, 8 Aug 2019 12:30:25 +0000</updated>
                            <resolved>Thu, 8 Aug 2019 12:30:25 +0000</resolved>
                                    <version>1.8.0</version>
                    <version>1.8.1</version>
                                    <fixVersion>1.8.2</fixVersion>
                    <fixVersion>1.9.0</fixVersion>
                                    <component>API / Type Serialization System</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16880972" author="yunta" created="Tue, 9 Jul 2019 06:31:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kring&quot; class=&quot;user-hover&quot; rel=&quot;kring&quot;&gt;kring&lt;/a&gt; would you please give more details. From your description, you would meet the exception if your job failover. However, this could come to normal just after several times retries. Have you ever turned on &lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-stable/ops/state/large_state_tuning.html#task-local-recovery&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;local recovery&lt;/a&gt;, and if the failling task would come to normal once it run on another worker node?&lt;/p&gt;</comment>
                            <comment id="16880987" author="kring" created="Tue, 9 Jul 2019 06:53:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;&#65292;thank you.My taskManager and JobManager are on the same machine, using local files as backends. Therefore, I did not configure local recovery. Just now, I created a savepoint for this task and tried to recover from the savepoint. Then I reproduced the exception 100 percent, so I&apos;m going to debug flink.&lt;/p&gt;</comment>
                            <comment id="16894254" author="diablox" created="Sat, 27 Jul 2019 04:03:05 +0000"  >&lt;p&gt;I&apos;m using flink 1.8.1 on yarn session with rocksdb as state backend.&lt;/p&gt;

&lt;p&gt;got the same problem when starting flink jobs with checkpoints:&#160;bin/flink run -s /flink/checkpoints/c2b8fa3c51393a2c6865ca13045eccad/chk-84 deploy/xxx.jar&lt;/p&gt;

&lt;p&gt;job keep retrying and fail after about 8 seconds.&#160;&lt;/p&gt;

&lt;p&gt;Our job runs on flink 1.7.2 with no problem for about 4 months and could recover successfully.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Full stack trace:&#160;&lt;/p&gt;

&lt;p&gt;java.lang.RuntimeException: Exception occurred while processing valve output watermark:&lt;br/&gt;
 at org.apache.flink.streaming.runtime.io.StreamInputProcessor$ForwardingValveOutputHandler.handleWatermark(StreamInputProcessor.java:265)&lt;br/&gt;
 at org.apache.flink.streaming.runtime.streamstatus.StatusWatermarkValve.findAndOutputNewMinWatermarkAcrossAlignedChannels(StatusWatermarkValve.java:189)&lt;br/&gt;
 at org.apache.flink.streaming.runtime.streamstatus.StatusWatermarkValve.inputWatermark(StatusWatermarkValve.java:111)&lt;br/&gt;
 at org.apache.flink.streaming.runtime.io.StreamInputProcessor.processInput(StreamInputProcessor.java:184)&lt;br/&gt;
 at org.apache.flink.streaming.runtime.tasks.OneInputStreamTask.run(OneInputStreamTask.java:105)&lt;br/&gt;
 at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:300)&lt;br/&gt;
 at org.apache.flink.runtime.taskmanager.Task.run(Task.java:711)&lt;br/&gt;
 at java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
Caused by: java.lang.RuntimeException: Cannot instantiate class.&lt;br/&gt;
 at org.apache.flink.api.java.typeutils.runtime.PojoSerializer.deserialize(PojoSerializer.java:384)&lt;br/&gt;
 at org.apache.flink.api.java.typeutils.runtime.TupleSerializer.deserialize(TupleSerializer.java:143)&lt;br/&gt;
 at org.apache.flink.api.java.typeutils.runtime.TupleSerializer.deserialize(TupleSerializer.java:37)&lt;br/&gt;
 at org.apache.flink.streaming.api.datastream.CoGroupedStreams$UnionSerializer.deserialize(CoGroupedStreams.java:581)&lt;br/&gt;
 at org.apache.flink.streaming.api.datastream.CoGroupedStreams$UnionSerializer.deserialize(CoGroupedStreams.java:506)&lt;br/&gt;
 at org.apache.flink.contrib.streaming.state.RocksDBListState.deserializeNextElement(RocksDBListState.java:144)&lt;br/&gt;
 at org.apache.flink.contrib.streaming.state.RocksDBListState.deserializeList(RocksDBListState.java:135)&lt;br/&gt;
 at org.apache.flink.contrib.streaming.state.RocksDBListState.getInternal(RocksDBListState.java:119)&lt;br/&gt;
 at org.apache.flink.contrib.streaming.state.RocksDBListState.get(RocksDBListState.java:111)&lt;br/&gt;
 at org.apache.flink.contrib.streaming.state.RocksDBListState.get(RocksDBListState.java:60)&lt;br/&gt;
 at org.apache.flink.streaming.runtime.operators.windowing.WindowOperator.onEventTime(WindowOperator.java:452)&lt;br/&gt;
 at org.apache.flink.streaming.api.operators.InternalTimerServiceImpl.advanceWatermark(InternalTimerServiceImpl.java:255)&lt;br/&gt;
 at org.apache.flink.streaming.api.operators.InternalTimeServiceManager.advanceWatermark(InternalTimeServiceManager.java:128)&lt;br/&gt;
 at org.apache.flink.streaming.api.operators.AbstractStreamOperator.processWatermark(AbstractStreamOperator.java:775)&lt;br/&gt;
 at org.apache.flink.streaming.runtime.io.StreamInputProcessor$ForwardingValveOutputHandler.handleWatermark(StreamInputProcessor.java:262)&lt;br/&gt;
 ... 7 more&lt;br/&gt;
Caused by: java.lang.ClassNotFoundException: com/xx/xx/xx&lt;br/&gt;
 at java.lang.Class.forName0(Native Method)&lt;br/&gt;
 at java.lang.Class.forName(Class.java:348)&lt;br/&gt;
 at org.apache.flink.api.java.typeutils.runtime.PojoSerializer.deserialize(PojoSerializer.java:382)&lt;/p&gt;</comment>
                            <comment id="16895797" author="ssailappan" created="Tue, 30 Jul 2019 05:18:05 +0000"  >&lt;p&gt;I am running into the same issue. I am running Flink 1.8.0 on EMR on a yarn cluster. The checkpoint is externalized and uses S3. The job runs fine for long times before it fails with the below exception and never recovers after that. It keeps trying to restore from the checkpoint and runs into the same error repeatedly.&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
java.lang.Exception: Exception while creating StreamOperatorStateContext.&lt;br/&gt;
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.streamOperatorStateContext(StreamTaskStateInitializerImpl.java:195)&lt;br/&gt;
	at org.apache.flink.streaming.api.operators.AbstractStreamOperator.initializeState(AbstractStreamOperator.java:250)&lt;br/&gt;
	at org.apache.flink.streaming.runtime.tasks.StreamTask.initializeState(StreamTask.java:738)&lt;br/&gt;
	at org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:289)&lt;br/&gt;
	at org.apache.flink.runtime.taskmanager.Task.run(Task.java:711)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
Caused by: org.apache.flink.util.FlinkException: Could not restore keyed state backend for WindowOperator_d28463815a9d818025b1ff96211a6dc9_(2/2) from any of the 1 provided restore options.&lt;br/&gt;
	at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.createAndRestore(BackendRestorerProcedure.java:135)&lt;br/&gt;
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.keyedStatedBackend(StreamTaskStateInitializerImpl.java:307)&lt;br/&gt;
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.streamOperatorStateContext(StreamTaskStateInitializerImpl.java:135)&lt;br/&gt;
	... 5 more&lt;br/&gt;
Caused by: org.apache.flink.runtime.state.BackendBuildingException: Failed when trying to restore heap backend&lt;br/&gt;
	at org.apache.flink.runtime.state.heap.HeapKeyedStateBackendBuilder.build(HeapKeyedStateBackendBuilder.java:130)&lt;br/&gt;
	at org.apache.flink.runtime.state.filesystem.FsStateBackend.createKeyedStateBackend(FsStateBackend.java:489)&lt;br/&gt;
	at org.apache.flink.streaming.api.operators.StreamTaskStateInitializerImpl.lambda$keyedStatedBackend$1(StreamTaskStateInitializerImpl.java:291)&lt;br/&gt;
	at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.attemptCreateAndRestore(BackendRestorerProcedure.java:142)&lt;br/&gt;
	at org.apache.flink.streaming.api.operators.BackendRestorerProcedure.createAndRestore(BackendRestorerProcedure.java:121)&lt;br/&gt;
	... 7 more&lt;br/&gt;
Caused by: java.lang.RuntimeException: Cannot instantiate class.&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.runtime.PojoSerializer.deserialize(PojoSerializer.java:384)&lt;br/&gt;
	at org.apache.flink.api.common.typeutils.base.ListSerializer.deserialize(ListSerializer.java:133)&lt;br/&gt;
	at org.apache.flink.api.common.typeutils.base.ListSerializer.deserialize(ListSerializer.java:42)&lt;br/&gt;
	at org.apache.flink.runtime.state.heap.StateTableByKeyGroupReaders.lambda$createV2PlusReader$0(StateTableByKeyGroupReaders.java:74)&lt;br/&gt;
	at org.apache.flink.runtime.state.KeyGroupPartitioner$PartitioningResultKeyGroupReader.readMappingsInKeyGroup(KeyGroupPartitioner.java:297)&lt;br/&gt;
	at org.apache.flink.runtime.state.heap.HeapRestoreOperation.readKeyGroupStateData(HeapRestoreOperation.java:290)&lt;br/&gt;
	at org.apache.flink.runtime.state.heap.HeapRestoreOperation.readStateHandleStateData(HeapRestoreOperation.java:251)&lt;br/&gt;
	at org.apache.flink.runtime.state.heap.HeapRestoreOperation.restore(HeapRestoreOperation.java:153)&lt;br/&gt;
	at org.apache.flink.runtime.state.heap.HeapKeyedStateBackendBuilder.build(HeapKeyedStateBackendBuilder.java:127)&lt;br/&gt;
	... 11 more&lt;br/&gt;
Caused by: java.lang.ClassNotFoundException: xxx&lt;br/&gt;
	at java.lang.Class.forName0(Native Method)&lt;br/&gt;
	at java.lang.Class.forName(Class.java:348)&lt;br/&gt;
	at org.apache.flink.api.java.typeutils.runtime.PojoSerializer.deserialize(PojoSerializer.java:382)&lt;br/&gt;
	... 19 more&lt;/p&gt;</comment>
                            <comment id="16899946" author="kring" created="Mon, 5 Aug 2019 09:34:03 +0000"  >&lt;p&gt;My code uses a parent reference, which actually points to a subclass object. Then I tried debug Flink and found that CL was not passed in when this constructor &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12976679/12976679_image-2019-08-05-17-29-40-351.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; was used to create PojoSerializer, resulting in no CL leading to Cannot instantiate class error when executing the org.apache.flink.api.java.typeutils.runtime.PojoSerializer#deserialize(org.apache.flink.core.memory.DataInputView) method.So I added&#160; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12976678/12976678_image-2019-08-05-17-32-44-988.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; to the last line of the constructor, and then recompiled and packaged, which successfully solved the problem.&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ssailappan&quot; class=&quot;user-hover&quot; rel=&quot;ssailappan&quot;&gt;ssailappan&lt;/a&gt;&#160;I guess you have the same problem as me.&lt;/p&gt;</comment>
                            <comment id="16900733" author="yunta" created="Tue, 6 Aug 2019 07:57:37 +0000"  >&lt;p&gt;Before Flink-1.8, &lt;tt&gt;PojoSerializer&lt;/tt&gt; would always use the &lt;a href=&quot;https://github.com/apache/flink/blob/56c3e7cd653e4cb2ad0a76ca317aa9fa1d564dc2/flink-core/src/main/java/org/apache/flink/api/java/typeutils/runtime/PojoSerializer.java#L119&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1st constructor&lt;/a&gt; which assign &lt;tt&gt;Thread.currentThread().getContextClassLoader()&lt;/tt&gt; to private field &lt;tt&gt;ClassLoader cl&lt;/tt&gt;. The &lt;a href=&quot;https://github.com/apache/flink/blob/56c3e7cd653e4cb2ad0a76ca317aa9fa1d564dc2/flink-core/src/main/java/org/apache/flink/api/java/typeutils/runtime/PojoSerializer.java#L147&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2nd constructor&lt;/a&gt; without &lt;tt&gt;cl&lt;/tt&gt; assigned would only be used to ensure the compatibility.&lt;/p&gt;

&lt;p&gt;However, after Flink-1.8, we would use the &lt;a href=&quot;https://github.com/apache/flink/blob/a0d236fba7c6abdabb461aa504b1e088a3982c31/flink-core/src/main/java/org/apache/flink/api/java/typeutils/runtime/PojoSerializer.java#L142&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2nd constructor&lt;/a&gt; to create a restore serializer or a reconfigured serializer from a &lt;tt&gt;PojoSerializerSnapshot&lt;/tt&gt;. Unfortunately, the restored serializer does not contain the class loader.&lt;/p&gt;

&lt;p&gt;I could use below code within &lt;tt&gt;PojoSubclassSerializerTest&lt;/tt&gt; to reproduce this.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testRestorePojoSerializer() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
   TypeSerializer&amp;lt;TestUserClassBase&amp;gt; serializer = createSerializer();
   TestUserClass2 bar = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TestUserClass2(
      ThreadLocalRandom.current().nextInt(), &lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;, ThreadLocalRandom.current().nextFloat());
   ByteArrayOutputStream out = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayOutputStream();
   &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (DataOutputViewStreamWrapper outView = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DataOutputViewStreamWrapper(out)) {
      serializer.serialize(bar, outView);
      DataInputViewStreamWrapper inputViewStreamWrapper =
         &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DataInputViewStreamWrapper(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayInputStream(out.toByteArray()));
      serializer.deserialize(inputViewStreamWrapper);
   }
   TypeSerializerSnapshot&amp;lt;TestUserClassBase&amp;gt; snapshot = serializer.snapshotConfiguration();
   TypeSerializer&amp;lt;TestUserClassBase&amp;gt; restoreSerializer = snapshot.restoreSerializer();
   &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (DataInputViewStreamWrapper inputView =
          &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DataInputViewStreamWrapper(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayInputStream(out.toByteArray()))) {
      restoreSerializer.deserialize(inputView);
   }
}
&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tzulitai&quot; class=&quot;user-hover&quot; rel=&quot;tzulitai&quot;&gt;tzulitai&lt;/a&gt;, what do you think of this? If this is really a bug, I am glad to help to resolve this issue.&lt;/p&gt;</comment>
                            <comment id="16900957" author="tzulitai" created="Tue, 6 Aug 2019 12:12:16 +0000"  >&lt;p&gt;Thanks for the diagnosis &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kring&quot; class=&quot;user-hover&quot; rel=&quot;kring&quot;&gt;kring&lt;/a&gt;.&lt;br/&gt;
The observations makes sense to me, and this indeed is a bug since the user classloader is not being used when deserializing.&lt;/p&gt;

&lt;p&gt;Please ping me for a review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yunta&quot; class=&quot;user-hover&quot; rel=&quot;yunta&quot;&gt;yunta&lt;/a&gt;, I&apos;ve assigned you to the JIRA ticket.&lt;/p&gt;</comment>
                            <comment id="16900961" author="tzulitai" created="Tue, 6 Aug 2019 12:14:22 +0000"  >&lt;p&gt;I&apos;ve made this a blocker for 1.8.2.&lt;br/&gt;
Ideally, it would be best if we can fix this for the upcoming 1.9.0 as well.&lt;/p&gt;</comment>
                            <comment id="16902919" author="tzulitai" created="Thu, 8 Aug 2019 12:30:25 +0000"  >&lt;p&gt;Merged.&lt;/p&gt;

&lt;p&gt;master: 268da6a03323b65d6297e4d2288ead39aba7d388&lt;br/&gt;
1.9.0: 5c09e1c29897e7c098ee55c0d7881c5d2016d94c&lt;br/&gt;
1.8.2: 0130b863d959de2bec5f0e9c6176a26ef85cb96d&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12976679" name="image-2019-08-05-17-29-40-351.png" size="802172" author="kring" created="Mon, 5 Aug 2019 09:34:34 +0000"/>
                            <attachment id="12976678" name="image-2019-08-05-17-32-44-988.png" size="752594" author="kring" created="Mon, 5 Aug 2019 09:32:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 14 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z04ha8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>