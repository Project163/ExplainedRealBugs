<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:06:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-24161] Can not stop the job with savepoint while a task is finishing</title>
                <link>https://issues.apache.org/jira/browse/FLINK-24161</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;When stop the job with savepoint, if there is a task is finishing, the action will be timeout.&lt;/p&gt;

&lt;p&gt;Testing job: &lt;a href=&quot;https://github.com/KarmaGYZ/flink/blob/test-147/flink-examples/flink-examples-streaming/src/main/java/org/apache/flink/streaming/examples/wordcount/WordCount.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/KarmaGYZ/flink/blob/test-147/flink-examples/flink-examples-streaming/src/main/java/org/apache/flink/streaming/examples/wordcount/WordCount.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Flink conf:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-bash&quot;&gt;
state.savepoints.dir: file:///tmp/flink-savepoints
state.backend: rocksdb
state.backend.incremental: true
state.checkpoints.dir: file:///tmp/flink-ckp/
execution.checkpointing.aligned-checkpoint-timeout: 30 s
execution.checkpointing.interval: 5 s
taskmanager.numberOfTaskSlots: 2
execution.checkpointing.checkpoints-after-tasks-finish.enabled: true
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;How to reproduce:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-bash&quot;&gt;
bin/flink run -d -p 4 examples/streaming/WordCount.jar
&lt;span class=&quot;code-comment&quot;&gt;# &lt;span class=&quot;code-object&quot;&gt;while&lt;/span&gt; one task is finishing
&lt;/span&gt;bin/flink stop $JOB_ID
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Client log:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-bash&quot;&gt;
------------------------------------------------------------
 The program finished with the following exception:

org.apache.flink.util.FlinkException: Could not stop with a savepoint job &lt;span class=&quot;code-quote-red&quot;&gt;&quot;e139a2eba7f8dc0b07fab65e84421ee4&quot;&lt;/span&gt;.
  at org.apache.flink.client.cli.CliFrontend.lambda&lt;span class=&quot;code-object&quot;&gt;$stop&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;$5&lt;/span&gt;(CliFrontend.java:581)
  at org.apache.flink.client.cli.CliFrontend.runClusterAction(CliFrontend.java:1002)
  at org.apache.flink.client.cli.CliFrontend.stop(CliFrontend.java:569)
  at org.apache.flink.client.cli.CliFrontend.parseAndRun(CliFrontend.java:1069)
  at org.apache.flink.client.cli.CliFrontend.lambda&lt;span class=&quot;code-object&quot;&gt;$main&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;$10&lt;/span&gt;(CliFrontend.java:1132)
  at org.apache.flink.runtime.security.contexts.NoOpSecurityContext.runSecured(NoOpSecurityContext.java:28)
  at org.apache.flink.client.cli.CliFrontend.main(CliFrontend.java:1132)
Caused by: java.util.concurrent.TimeoutException
  at java.util.concurrent.CompletableFuture.timedGet(CompletableFuture.java:1771)
  at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1915)
  at org.apache.flink.client.cli.CliFrontend.lambda&lt;span class=&quot;code-object&quot;&gt;$stop&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;$5&lt;/span&gt;(CliFrontend.java:579)
  ... 6 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13399488">FLINK-24161</key>
            <summary>Can not stop the job with savepoint while a task is finishing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dwysakowicz">Dawid Wysakowicz</assignee>
                                    <reporter username="guoyangze">Yangze Guo</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 6 Sep 2021 02:47:40 +0000</created>
                <updated>Tue, 30 Nov 2021 20:37:57 +0000</updated>
                            <resolved>Fri, 10 Sep 2021 12:09:01 +0000</resolved>
                                    <version>1.14.0</version>
                                    <fixVersion>1.14.0</fixVersion>
                                    <component>Runtime / Checkpointing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17410313" author="karmagyz" created="Mon, 6 Sep 2021 02:52:20 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gaoyunhaii&quot; class=&quot;user-hover&quot; rel=&quot;gaoyunhaii&quot;&gt;gaoyunhaii&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17410393" author="gaoyunhaii" created="Mon, 6 Sep 2021 06:26:41 +0000"  >&lt;p&gt;Very thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guoyangze&quot; class=&quot;user-hover&quot; rel=&quot;guoyangze&quot;&gt;guoyangze&lt;/a&gt; for verifying the functionality and report the issue!&lt;/p&gt;

&lt;p&gt;I confirmed with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=guoyangze&quot; class=&quot;user-hover&quot; rel=&quot;guoyangze&quot;&gt;guoyangze&lt;/a&gt; that the issue happens only if we enabled checkpoints after tasks finished (otherwise the savepoint would fail directly due to not all tasks are running). I checked the case and It should be caused by some deadlock if stop-with-savepoint happens right when the task is finishing:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;The source finished and reach `afterInvoke` to wait for the final checkpoint in a mailbox loop.&lt;/li&gt;
	&lt;li&gt;The user triggers stop-with-savepoint, which could still succeed for we are still in a mailbox loop. But since it is without drain, it would not complete the `finalCheckpointCompleted`.&lt;/li&gt;
	&lt;li&gt;However, when the savepoint is triggered, the CheckpointCoordinator would stop the periodic checkpoint trigger, the final checkpoint would never happen and thus the source would be blocked forever.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17410639" author="pnowojski" created="Mon, 6 Sep 2021 14:37:04 +0000"  >&lt;p&gt;I&apos;ve deprioritized the issue for the time being, as it affects only &lt;tt&gt;execution.checkpointing.checkpoints-after-tasks-finish.enabled: true&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17410939" author="dawidwys" created="Tue, 7 Sep 2021 06:24:16 +0000"  >&lt;p&gt;I have not thought it entirely through, but from a brief look at the description from Yun, I think once we unify the with and w/o drain versions (&lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-23532&quot; title=&quot;Unify stop-with-savepoint w drain and w/o drain&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-23532&quot;&gt;&lt;del&gt;FLINK-23532&lt;/del&gt;&lt;/a&gt;) the problem should go away.&lt;/p&gt;</comment>
                            <comment id="17410957" author="pnowojski" created="Tue, 7 Sep 2021 07:01:06 +0000"  >&lt;p&gt;That might be a solution for 1.15.x, but not for 1.14.x. I would prefer to not risk changing the behaviour of the stop-with-savepoint. So unless the unification is simple/trivial, I would try to solve this for 1.14.x only by modifying the &lt;tt&gt;execution.checkpointing.checkpoints-after-tasks-finish.enabled: true&lt;/tt&gt; code &lt;/p&gt;</comment>
                            <comment id="17411170" author="gaoyunhaii" created="Tue, 7 Sep 2021 12:02:33 +0000"  >&lt;p&gt;Perhaps for 1.14 we could first disable stop-with-savepoint without drain if the tasks are finishing ? We could fail the job if checkpoint after tasks finished is enabled and:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;In&#160;&lt;tt&gt;endData()&lt;/tt&gt;&#160;if there is an pending savepoint without drain, we fail the task by throw an exception.&lt;/li&gt;
	&lt;li&gt;When triggering stop-with-savepoint without drain, if&#160;&lt;tt&gt;endOfDataReceived = true&lt;/tt&gt;&#160;, we then return false to reject the savepoint.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Both of the above 2 cases cause a failover.&#160;&lt;/p&gt;

&lt;p&gt;We could then provide the support for this case in 1.15 after we unified the process of savepoint~&lt;/p&gt;</comment>
                            <comment id="17413140" author="dawidwys" created="Fri, 10 Sep 2021 12:09:02 +0000"  >&lt;p&gt;Fixed in:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;master
	&lt;ul&gt;
		&lt;li&gt;f5ef5ae8f120f3e70ff3fe093fb4c45e92beaabd&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;1.14.0
	&lt;ul&gt;
		&lt;li&gt;df3b7235699c44923966a2ba733576c6a61d3d3a&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="12852528">FLINK-2491</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13392450">FLINK-23532</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13033073" name="flink-yangze-standalonesession-0-IT-C02YV0L8LVDL.local.log" size="68655" author="guoyangze" created="Mon, 6 Sep 2021 02:52:00 +0000"/>
                            <attachment id="13033072" name="flink-yangze-taskexecutor-0-IT-C02YV0L8LVDL.local.log" size="162075" author="guoyangze" created="Mon, 6 Sep 2021 02:52:00 +0000"/>
                            <attachment id="13033071" name="flink-yangze-taskexecutor-1-IT-C02YV0L8LVDL.local.log" size="145740" author="guoyangze" created="Mon, 6 Sep 2021 02:52:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 9 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0umu0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>