<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 20:28:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-6606] Create checkpoint hook with user classloader</title>
                <link>https://issues.apache.org/jira/browse/FLINK-6606</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;Flink should set the thread&apos;s classloader when calling the checkpoint hook factory&apos;s `create` method.   Without that, the hook is likely to fail during initialization (e.g. using ServiceLoader). &lt;/p&gt;</description>
                <environment></environment>
        <key id="13072634">FLINK-6606</key>
            <summary>Create checkpoint hook with user classloader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="eronwright">Eron Wright</assignee>
                                    <reporter username="eronwright">Eron Wright</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 May 2017 00:02:25 +0000</created>
                <updated>Fri, 19 May 2017 13:37:00 +0000</updated>
                            <resolved>Fri, 19 May 2017 13:36:48 +0000</resolved>
                                                    <fixVersion>1.3.0</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16013670" author="eronwright" created="Wed, 17 May 2017 07:30:09 +0000"  >&lt;p&gt;I have a fix ready and will open a PR soon.   The fix wraps all calls to the hook such that the thread&apos;s context classloader is set to the user classloader.&lt;/p&gt;</comment>
                            <comment id="16014378" author="githubbot" created="Wed, 17 May 2017 16:48:52 +0000"  >&lt;p&gt;GitHub user EronWright opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3933&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3933&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6606&quot; title=&quot;Create checkpoint hook with user classloader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6606&quot;&gt;&lt;del&gt;FLINK-6606&lt;/del&gt;&lt;/a&gt; Create checkpoint hook with user classloader&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;wrap calls to MasterTriggerRestoreHook (and its factory) such that the user classloader is applied&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/EronWright/flink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/EronWright/flink&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6606&quot; title=&quot;Create checkpoint hook with user classloader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6606&quot;&gt;&lt;del&gt;FLINK-6606&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3933.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3933.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3933&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit fbf904a60a1e252944e1cbc7ad60c5d95ae28ec2&lt;br/&gt;
Author: Wright, Eron &amp;lt;eron.wright@emc.com&amp;gt;&lt;br/&gt;
Date:   2017-05-17T16:46:13Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-6606&quot; title=&quot;Create checkpoint hook with user classloader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-6606&quot;&gt;&lt;del&gt;FLINK-6606&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;wrap calls to MasterTriggerRestoreHook (and its factory) such that the user classloader is applied&lt;/li&gt;
&lt;/ul&gt;


&lt;hr /&gt;</comment>
                            <comment id="16015695" author="githubbot" created="Thu, 18 May 2017 12:47:31 +0000"  >&lt;p&gt;Github user rmetzger commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3933&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3933&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I haven&apos;t worked on this part of the code before, but I believe this code is +1 to merge.&lt;/p&gt;</comment>
                            <comment id="16015711" author="githubbot" created="Thu, 18 May 2017 12:57:04 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3933&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3933&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for your contribution @EronWright. I&apos;m not quite sure whether I understand which problem we are trying to solve here. &lt;/p&gt;

&lt;p&gt;    I think by deserializing the `MasterTriggerRestoreHook.Factories` with the user code class loader in `ExecutionGraphBuilder.java:253`, we support user code hooks. Given that the `Factory` is a user defined class, then it should get the user code class loader set as its `ClassLoader`. Thus, it should also be able to load a user defined `MasterTriggerRestoreHook` class. And the latter can only be a user defined class if the factory is user defined.&lt;/p&gt;

&lt;p&gt;    But I might be overlooking something here. Maybe you can give me some more details about the PR.&lt;/p&gt;</comment>
                            <comment id="16015963" author="githubbot" created="Thu, 18 May 2017 15:44:56 +0000"  >&lt;p&gt;Github user EronWright commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3933&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3933&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @tillrohrmann the issue is with code that uses the thread&apos;s context classloader (TCCL), that may execute in `Factory.create` or later in the hook methods.  For example, the Pravega connector uses grpc, which uses the TCCL during initialization (see &lt;span class=&quot;error&quot;&gt;&amp;#91;ManagedChannelProvider&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/grpc/grpc-java/blob/v1.3.0/core/src/main/java/io/grpc/ManagedChannelProvider.java#L132&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grpc/grpc-java/blob/v1.3.0/core/src/main/java/io/grpc/ManagedChannelProvider.java#L132&lt;/a&gt;)).&lt;/p&gt;

&lt;p&gt;    Looking at other areas in Flink where usercode is called, I see that the TCCL is consistently set.  For example, see &lt;span class=&quot;error&quot;&gt;&amp;#91;InputFormatVertex&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/flink/blob/2c68085f658873c2d5836fbad6b82be76a79f0f9/flink-runtime/src/main/java/org/apache/flink/runtime/jobgraph/InputFormatVertex.java#L81&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/2c68085f658873c2d5836fbad6b82be76a79f0f9/flink-runtime/src/main/java/org/apache/flink/runtime/jobgraph/InputFormatVertex.java#L81&lt;/a&gt;), &lt;span class=&quot;error&quot;&gt;&amp;#91;ExecutionJobVertex&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/flink/blob/7ad489d87281b74c53d3b1a0dd97e56b7a8ef303/flink-runtime/src/main/java/org/apache/flink/runtime/executiongraph/ExecutionJobVertex.java#L229&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/7ad489d87281b74c53d3b1a0dd97e56b7a8ef303/flink-runtime/src/main/java/org/apache/flink/runtime/executiongraph/ExecutionJobVertex.java#L229&lt;/a&gt;), and &lt;span class=&quot;error&quot;&gt;&amp;#91;Task&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/flink/blob/6181302f1ab741b86af357e4513f5952a5fc1531/flink-runtime/src/main/java/org/apache/flink/runtime/taskmanager/Task.java#L698&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/6181302f1ab741b86af357e4513f5952a5fc1531/flink-runtime/src/main/java/org/apache/flink/runtime/taskmanager/Task.java#L698&lt;/a&gt;).&lt;/p&gt;
</comment>
                            <comment id="16016007" author="githubbot" created="Thu, 18 May 2017 16:15:47 +0000"  >&lt;p&gt;Github user rmetzger commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3933&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3933&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Till and I had an offline discussion about this.&lt;br/&gt;
    What you can do in your user code to set the TCCL properly is the following:&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
    Thread.currentThread().setContextClassLoader(this.getClass().getClassLoader());&lt;br/&gt;
    ```&lt;/p&gt;

&lt;p&gt;    `this` points in user code to a class loaded through the user code classlaoder. So `this.getClass().getClassLoader()` is the CL you need to set for the thread.&lt;/p&gt;</comment>
                            <comment id="16016010" author="githubbot" created="Thu, 18 May 2017 16:17:11 +0000"  >&lt;p&gt;Github user EronWright commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3933&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3933&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    That&apos;s the sort of workaround that Android apps are forced to use.   Why not continue the practice of setting the TCCL in transitions from system to user code?&lt;/p&gt;</comment>
                            <comment id="16016039" author="githubbot" created="Thu, 18 May 2017 16:29:09 +0000"  >&lt;p&gt;Github user rmetzger commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3933&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3933&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Lets see what Till says.&lt;br/&gt;
    In my opinion, both approaches are fine. What you are proposing makes things on Flink&apos;s side a bit more complicated, but the behavior is consistent with other places where user code is executed.&lt;/p&gt;

&lt;p&gt;    Till&apos;s proposal (so get the CL via the class) keeps our code straightforward, but users have to know it.&lt;/p&gt;</comment>
                            <comment id="16016573" author="githubbot" created="Thu, 18 May 2017 22:35:46 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3933&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3933&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I agree with @EronWright that it would be nice to offer all user code the a similar environment. This will become especially important if a `MasterTriggerRestoreHook` which is contained in the system class loader tries to load user code classes dynamically.&lt;/p&gt;

&lt;p&gt;    I&apos;m wondering whether to follow the approach of the `InputFormatVertex` and `ExecutionJobVertex` to set the TCCL explicitly when calling the hooks. This could happen in `MasterHooks#triggerMasterHooks` for example. The advantage would be that we don&apos;t have to reset the TCCL for each hook. On the other hand, it harbours danger that we will forget to set the TCCL when calling the hooks from somewhere else in the future.&lt;/p&gt;</comment>
                            <comment id="16016575" author="githubbot" created="Thu, 18 May 2017 22:37:52 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3933#discussion_r117370134&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3933#discussion_r117370134&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/hooks/MasterHooks.java &amp;#8212;&lt;br/&gt;
    @@ -267,6 +269,112 @@ else if (!allowUnmatchedState) {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	// ------------------------------------------------------------------------&lt;br/&gt;
    +	//  hook management&lt;br/&gt;
    +	// ------------------------------------------------------------------------&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Wraps a hook such that the user-code classloader is applied when the hook is invoked.&lt;br/&gt;
    +	 * @param hook the hook to wrap&lt;br/&gt;
    +	 * @param userClassLoader the classloader to use&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public static &amp;lt;T&amp;gt; MasterTriggerRestoreHook&amp;lt;T&amp;gt; wrapHook(MasterTriggerRestoreHook&amp;lt;T&amp;gt; hook, ClassLoader userClassLoader) &lt;/p&gt;
{
    +		return new WrappedMasterHook&amp;lt;T&amp;gt;(hook, userClassLoader);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@VisibleForTesting&lt;br/&gt;
    +	static class WrappedMasterHook&amp;lt;T&amp;gt; implements MasterTriggerRestoreHook&amp;lt;T&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		private final MasterTriggerRestoreHook&amp;lt;T&amp;gt; hook;&lt;br/&gt;
    +		private final ClassLoader userClassLoader;&lt;br/&gt;
    +&lt;br/&gt;
    +		WrappedMasterHook(MasterTriggerRestoreHook&amp;lt;T&amp;gt; hook, ClassLoader userClassLoader) &lt;/p&gt;
{
    +			this.hook = hook;
    +			this.userClassLoader = userClassLoader;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String getIdentifier() {&lt;br/&gt;
    +			Thread thread = Thread.currentThread();&lt;br/&gt;
    +			ClassLoader originalClassLoader = thread.getContextClassLoader();&lt;br/&gt;
    +			thread.setContextClassLoader(userClassLoader);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Maybe we can move the `setContextClassLoader` into the `try` body. Just to be on the safe side that whenever something happens we will reset the original class loader.&lt;/p&gt;</comment>
                            <comment id="16016577" author="githubbot" created="Thu, 18 May 2017 22:38:38 +0000"  >&lt;p&gt;Github user EronWright commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3933&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3933&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Originally I pursued the path suggested by @tillrohrmann of setting the TCCL at the sites where the hook is invoked, but found that the classloader wasn&apos;t readily available.    I found it more expedient to create a wrapper that eagerly captured the classloader.&lt;/p&gt;</comment>
                            <comment id="16016578" author="githubbot" created="Thu, 18 May 2017 22:39:40 +0000"  >&lt;p&gt;Github user EronWright commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3933#discussion_r117370390&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3933#discussion_r117370390&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/hooks/MasterHooks.java &amp;#8212;&lt;br/&gt;
    @@ -267,6 +269,112 @@ else if (!allowUnmatchedState) {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	// ------------------------------------------------------------------------&lt;br/&gt;
    +	//  hook management&lt;br/&gt;
    +	// ------------------------------------------------------------------------&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Wraps a hook such that the user-code classloader is applied when the hook is invoked.&lt;br/&gt;
    +	 * @param hook the hook to wrap&lt;br/&gt;
    +	 * @param userClassLoader the classloader to use&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public static &amp;lt;T&amp;gt; MasterTriggerRestoreHook&amp;lt;T&amp;gt; wrapHook(MasterTriggerRestoreHook&amp;lt;T&amp;gt; hook, ClassLoader userClassLoader) &lt;/p&gt;
{
    +		return new WrappedMasterHook&amp;lt;T&amp;gt;(hook, userClassLoader);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@VisibleForTesting&lt;br/&gt;
    +	static class WrappedMasterHook&amp;lt;T&amp;gt; implements MasterTriggerRestoreHook&amp;lt;T&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		private final MasterTriggerRestoreHook&amp;lt;T&amp;gt; hook;&lt;br/&gt;
    +		private final ClassLoader userClassLoader;&lt;br/&gt;
    +&lt;br/&gt;
    +		WrappedMasterHook(MasterTriggerRestoreHook&amp;lt;T&amp;gt; hook, ClassLoader userClassLoader) &lt;/p&gt;
{
    +			this.hook = hook;
    +			this.userClassLoader = userClassLoader;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String getIdentifier() {&lt;br/&gt;
    +			Thread thread = Thread.currentThread();&lt;br/&gt;
    +			ClassLoader originalClassLoader = thread.getContextClassLoader();&lt;br/&gt;
    +			thread.setContextClassLoader(userClassLoader);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I disagee with that approach due to lack of symmetry.    The try..finally idiom is typically written as:&lt;/p&gt;</comment>
                            <comment id="16017026" author="githubbot" created="Fri, 19 May 2017 07:42:36 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3933#discussion_r117421730&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3933#discussion_r117421730&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/hooks/MasterHooks.java &amp;#8212;&lt;br/&gt;
    @@ -267,6 +269,112 @@ else if (!allowUnmatchedState) {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	// ------------------------------------------------------------------------&lt;br/&gt;
    +	//  hook management&lt;br/&gt;
    +	// ------------------------------------------------------------------------&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Wraps a hook such that the user-code classloader is applied when the hook is invoked.&lt;br/&gt;
    +	 * @param hook the hook to wrap&lt;br/&gt;
    +	 * @param userClassLoader the classloader to use&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public static &amp;lt;T&amp;gt; MasterTriggerRestoreHook&amp;lt;T&amp;gt; wrapHook(MasterTriggerRestoreHook&amp;lt;T&amp;gt; hook, ClassLoader userClassLoader) &lt;/p&gt;
{
    +		return new WrappedMasterHook&amp;lt;T&amp;gt;(hook, userClassLoader);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@VisibleForTesting&lt;br/&gt;
    +	static class WrappedMasterHook&amp;lt;T&amp;gt; implements MasterTriggerRestoreHook&amp;lt;T&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		private final MasterTriggerRestoreHook&amp;lt;T&amp;gt; hook;&lt;br/&gt;
    +		private final ClassLoader userClassLoader;&lt;br/&gt;
    +&lt;br/&gt;
    +		WrappedMasterHook(MasterTriggerRestoreHook&amp;lt;T&amp;gt; hook, ClassLoader userClassLoader) &lt;/p&gt;
{
    +			this.hook = hook;
    +			this.userClassLoader = userClassLoader;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String getIdentifier() {&lt;br/&gt;
    +			Thread thread = Thread.currentThread();&lt;br/&gt;
    +			ClassLoader originalClassLoader = thread.getContextClassLoader();&lt;br/&gt;
    +			thread.setContextClassLoader(userClassLoader);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    True, but I guess if `close` is idempotent, then it doesn&apos;t hurt.&lt;/p&gt;</comment>
                            <comment id="16017047" author="githubbot" created="Fri, 19 May 2017 08:17:27 +0000"  >&lt;p&gt;Github user tillrohrmann commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3933#discussion_r117427223&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3933#discussion_r117427223&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: flink-runtime/src/main/java/org/apache/flink/runtime/checkpoint/hooks/MasterHooks.java &amp;#8212;&lt;br/&gt;
    @@ -267,6 +269,112 @@ else if (!allowUnmatchedState) {&lt;br/&gt;
     	}&lt;/p&gt;

&lt;p&gt;     	// ------------------------------------------------------------------------&lt;br/&gt;
    +	//  hook management&lt;br/&gt;
    +	// ------------------------------------------------------------------------&lt;br/&gt;
    +&lt;br/&gt;
    +	/**&lt;br/&gt;
    +	 * Wraps a hook such that the user-code classloader is applied when the hook is invoked.&lt;br/&gt;
    +	 * @param hook the hook to wrap&lt;br/&gt;
    +	 * @param userClassLoader the classloader to use&lt;br/&gt;
    +	 */&lt;br/&gt;
    +	public static &amp;lt;T&amp;gt; MasterTriggerRestoreHook&amp;lt;T&amp;gt; wrapHook(MasterTriggerRestoreHook&amp;lt;T&amp;gt; hook, ClassLoader userClassLoader) &lt;/p&gt;
{
    +		return new WrappedMasterHook&amp;lt;T&amp;gt;(hook, userClassLoader);
    +	}
&lt;p&gt;    +&lt;br/&gt;
    +	@VisibleForTesting&lt;br/&gt;
    +	static class WrappedMasterHook&amp;lt;T&amp;gt; implements MasterTriggerRestoreHook&amp;lt;T&amp;gt; {&lt;br/&gt;
    +&lt;br/&gt;
    +		private final MasterTriggerRestoreHook&amp;lt;T&amp;gt; hook;&lt;br/&gt;
    +		private final ClassLoader userClassLoader;&lt;br/&gt;
    +&lt;br/&gt;
    +		WrappedMasterHook(MasterTriggerRestoreHook&amp;lt;T&amp;gt; hook, ClassLoader userClassLoader) &lt;/p&gt;
{
    +			this.hook = hook;
    +			this.userClassLoader = userClassLoader;
    +		}
&lt;p&gt;    +&lt;br/&gt;
    +		@Override&lt;br/&gt;
    +		public String getIdentifier() {&lt;br/&gt;
    +			Thread thread = Thread.currentThread();&lt;br/&gt;
    +			ClassLoader originalClassLoader = thread.getContextClassLoader();&lt;br/&gt;
    +			thread.setContextClassLoader(userClassLoader);&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    True.&lt;/p&gt;</comment>
                            <comment id="16017347" author="githubbot" created="Fri, 19 May 2017 12:52:57 +0000"  >&lt;p&gt;Github user tillrohrmann commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3933&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3933&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Yes that is true. Thanks for your work and the clarification @EronWright. Merging this PR.&lt;/p&gt;</comment>
                            <comment id="16017392" author="till.rohrmann" created="Fri, 19 May 2017 13:36:48 +0000"  >&lt;p&gt;1.4.0: 2ad081636e54a2b8fd98a935a95c0949818843ad&lt;br/&gt;
1.3.0: 3dba48ee6ad3dc6bdb9abfaa91accbb8581cfd2a&lt;/p&gt;</comment>
                            <comment id="16017393" author="githubbot" created="Fri, 19 May 2017 13:37:00 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/flink/pull/3933&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/pull/3933&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13070865">FLINK-6531</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 26 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3f33z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>