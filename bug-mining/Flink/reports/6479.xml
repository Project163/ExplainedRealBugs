<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:10:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-24960] YARNSessionCapacitySchedulerITCase.testVCoresAreSetCorrectlyAndJobManagerHostnameAreShownInWebInterfaceAndDynamicPropertiesAndYarnApplicationNameAndTaskManagerSlots hangs on azure</title>
                <link>https://issues.apache.org/jira/browse/FLINK-24960</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Nov 18 22:37:08 ================================================================================
Nov 18 22:37:08 Test testVCoresAreSetCorrectlyAndJobManagerHostnameAreShownInWebInterfaceAndDynamicPropertiesAndYarnApplicationNameAndTaskManagerSlots(org.apache.flink.yarn.YARNSessionCapacitySchedulerITCase) is running.
Nov 18 22:37:08 --------------------------------------------------------------------------------
Nov 18 22:37:25 22:37:25,470 [                main] INFO  org.apache.flink.yarn.YARNSessionCapacitySchedulerITCase     [] - Extracted hostname:port: 5718b812c7ab:38622
Nov 18 22:52:36 ==============================================================================
Nov 18 22:52:36 &lt;span class=&quot;code-object&quot;&gt;Process&lt;/span&gt; produced no output &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 900 seconds.
Nov 18 22:52:36 ==============================================================================
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=26722&amp;amp;view=logs&amp;amp;j=f450c1a5-64b1-5955-e215-49cb1ad5ec88&amp;amp;t=cc452273-9efa-565d-9db8-ef62a38a0c10&amp;amp;l=36395&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=26722&amp;amp;view=logs&amp;amp;j=f450c1a5-64b1-5955-e215-49cb1ad5ec88&amp;amp;t=cc452273-9efa-565d-9db8-ef62a38a0c10&amp;amp;l=36395&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13412709">FLINK-24960</key>
            <summary>YARNSessionCapacitySchedulerITCase.testVCoresAreSetCorrectlyAndJobManagerHostnameAreShownInWebInterfaceAndDynamicPropertiesAndYarnApplicationNameAndTaskManagerSlots hangs on azure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="gaoyunhaii">Yun Gao</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>test-stability</label>
                    </labels>
                <created>Fri, 19 Nov 2021 06:49:21 +0000</created>
                <updated>Mon, 31 Mar 2025 06:28:12 +0000</updated>
                            <resolved>Mon, 29 Aug 2022 11:05:36 +0000</resolved>
                                    <version>1.14.3</version>
                    <version>1.15.0</version>
                    <version>1.16.0</version>
                                    <fixVersion>1.16.0</fixVersion>
                                    <component>Deployment / YARN</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17446318" author="gaoyunhaii" created="Fri, 19 Nov 2021 06:50:27 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chesnay&quot; class=&quot;user-hover&quot; rel=&quot;chesnay&quot;&gt;chesnay&lt;/a&gt;&#160; could you help to have a look at this issue~?&lt;/p&gt;</comment>
                            <comment id="17468711" author="till.rohrmann" created="Tue, 4 Jan 2022 16:06:30 +0000"  >&lt;p&gt;Another instance: &lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=28931&amp;amp;view=logs&amp;amp;j=fc5181b0-e452-5c8f-68de-1097947f6483&amp;amp;t=995c650b-6573-581c-9ce6-7ad4cc038461&amp;amp;l=35283&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=28931&amp;amp;view=logs&amp;amp;j=fc5181b0-e452-5c8f-68de-1097947f6483&amp;amp;t=995c650b-6573-581c-9ce6-7ad4cc038461&amp;amp;l=35283&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17481065" author="gaoyunhaii" created="Mon, 24 Jan 2022 13:00:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=30001&amp;amp;view=logs&amp;amp;j=fc5181b0-e452-5c8f-68de-1097947f6483&amp;amp;t=995c650b-6573-581c-9ce6-7ad4cc038461&amp;amp;l=34898&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=30001&amp;amp;view=logs&amp;amp;j=fc5181b0-e452-5c8f-68de-1097947f6483&amp;amp;t=995c650b-6573-581c-9ce6-7ad4cc038461&amp;amp;l=34898&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17502395" author="mapohl" created="Mon, 7 Mar 2022 16:28:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=32611&amp;amp;view=logs&amp;amp;j=fc5181b0-e452-5c8f-68de-1097947f6483&amp;amp;t=995c650b-6573-581c-9ce6-7ad4cc038461&amp;amp;l=37651&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=32611&amp;amp;view=logs&amp;amp;j=fc5181b0-e452-5c8f-68de-1097947f6483&amp;amp;t=995c650b-6573-581c-9ce6-7ad4cc038461&amp;amp;l=37651&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17502757" author="gaoyunhaii" created="Tue, 8 Mar 2022 06:51:20 +0000"  >&lt;p&gt;1.14: &lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=32582&amp;amp;view=logs&amp;amp;j=a5ef94ef-68c2-57fd-3794-dc108ed1c495&amp;amp;t=2c68b137-b01d-55c9-e603-3ff3f320364b&amp;amp;l=34954&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=32582&amp;amp;view=logs&amp;amp;j=a5ef94ef-68c2-57fd-3794-dc108ed1c495&amp;amp;t=2c68b137-b01d-55c9-e603-3ff3f320364b&amp;amp;l=34954&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17505006" author="JIRAUSER281719" created="Fri, 11 Mar 2022 16:46:08 +0000"  >&lt;p&gt;An early analysis.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;We start the JobManager via YARN - Works&lt;/li&gt;
	&lt;li&gt;We identify the address of the REST server - We get the right address&lt;/li&gt;
	&lt;li&gt;We start a RestClient to submit a job via YARN - Works&lt;/li&gt;
	&lt;li&gt;RestClusterClient tries to submit job&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;In the last step, a default address &quot;localhost:8081&quot; is used instead of the correct external address port combination. This leads to a connection refused error. I am not sure why this happens though. From how I understand &lt;tt&gt;RestClusterClient#sendRetriableRequest&lt;/tt&gt;, it tries to get the address by using web monitor leader retrieval. It doesn&apos;t make sense to me, why this would return localhost:8081. I also don&apos;t see any place where this could fallback to the localhost:8081 pair.&lt;/p&gt;</comment>
                            <comment id="17506281" author="JIRAUSER281719" created="Mon, 14 Mar 2022 15:17:19 +0000"  >&lt;p&gt;Anyhow, the failure alone doesn&apos;t explain why the test gets stuck.&lt;/p&gt;

&lt;p&gt;We have three threads here&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The outer thread running the test.&lt;/li&gt;
	&lt;li&gt;A Flink cluster running the JobManager and TaskManager.&lt;/li&gt;
	&lt;li&gt;A rest client thread that submits the job.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The rest client thread fails:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Contacting the Rest Server fails (it retries for about 1 minute)&lt;/li&gt;
	&lt;li&gt;The job submission fails&lt;/li&gt;
	&lt;li&gt;The Session interface returns a nonzero exit code&lt;/li&gt;
	&lt;li&gt;An assertion failure is created&lt;/li&gt;
	&lt;li&gt;The assertion failure is caught and stored on the Runner class&lt;/li&gt;
	&lt;li&gt;The inner thread exits&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The outer thread should in principle either re-throw the exception or fail due to the timeout (also 1 minute). There should be no way out of this thread that doesn&apos;t lead to an exception. Yet, we see no indicator that the outer thread acknowledges the failure of the inner thread. Instead, the thread hangs in the finally part of the try-finally of the main thread. It is unable to close the Flink Cluster.&lt;/p&gt;

&lt;p&gt;In contrast, from the JobManager logs we see that it doesn&apos;t receive any stop signal. So, somehow the connection seems to be severed?&lt;/p&gt;</comment>
                            <comment id="17506732" author="gaoyunhaii" created="Tue, 15 Mar 2022 06:42:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=33025&amp;amp;view=logs&amp;amp;j=fc5181b0-e452-5c8f-68de-1097947f6483&amp;amp;t=995c650b-6573-581c-9ce6-7ad4cc038461&amp;amp;l=38866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=33025&amp;amp;view=logs&amp;amp;j=fc5181b0-e452-5c8f-68de-1097947f6483&amp;amp;t=995c650b-6573-581c-9ce6-7ad4cc038461&amp;amp;l=38866&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17506780" author="JIRAUSER281719" created="Tue, 15 Mar 2022 08:26:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt; and I debugged this some more.&lt;/p&gt;

&lt;p&gt;It looks like the external address of the rest server is set by the &lt;a href=&quot;https://github.com/apache/flink/blob/c16e4b4ce20704a0ad4387591894f13105d5e530/flink-yarn/src/main/java/org/apache/flink/yarn/YarnClusterDescriptor.java#L1801&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;YarnClusterDescriptor&lt;/a&gt;. In short, the MiniYarnCluster propages the YarnClusterDescriptor into the execution process of the RestClusterClient. The address is then set via leader retrieval, but there is no actual leader retrieval taking place. Instead, the StandaloneHaServices returns the preconfigured rest server address.&lt;/p&gt;

&lt;p&gt;In principle, this should never return a &quot;localhost&quot; address. To better debug future scenarios of this bug, we add a PR that ensures that the log line in the code above is always printed. If this returns &quot;localhost&quot;, then there is something going wrong with the address the YARN application report includes. If instead, it returns an external address but the RestClusterClient can still not connect, then we missed another place where this property is set. Finally, if the log line does not appear at all, then we need to figure out if there is yet another code path.&lt;/p&gt;</comment>
                            <comment id="17508203" author="JIRAUSER281719" created="Thu, 17 Mar 2022 14:08:39 +0000"  >&lt;p&gt;Turns out that the &lt;a href=&quot;https://github.com/apache/flink/blob/c16e4b4ce20704a0ad4387591894f13105d5e530/flink-yarn/src/main/java/org/apache/flink/yarn/YarnClusterDescriptor.java#L1799&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;relevant log line&lt;/a&gt; is hidden by a &lt;a href=&quot;https://github.com/apache/flink/blob/c16e4b4ce20704a0ad4387591894f13105d5e530/flink-yarn-tests/src/test/java/org/apache/flink/yarn/YARNSessionCapacitySchedulerITCase.java#L120&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test rule&lt;/a&gt;. We recorded this as a bug in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-26710&quot; title=&quot;TestLoggerResource hides log lines&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-26710&quot;&gt;&lt;del&gt;FLINK-26710&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="17513180" author="gaoyunhaii" created="Mon, 28 Mar 2022 06:44:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=33780&amp;amp;view=logs&amp;amp;j=8fd975ef-f478-511d-4997-6f15fe8a1fd3&amp;amp;t=494f6362-8ffa-5ff8-9158-c7f00e541279&amp;amp;l=36852&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=33780&amp;amp;view=logs&amp;amp;j=8fd975ef-f478-511d-4997-6f15fe8a1fd3&amp;amp;t=494f6362-8ffa-5ff8-9158-c7f00e541279&amp;amp;l=36852&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17523578" author="gaoyunhaii" created="Mon, 18 Apr 2022 07:30:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=34743&amp;amp;view=logs&amp;amp;j=298e20ef-7951-5965-0e79-ea664ddc435e&amp;amp;t=d4c90338-c843-57b0-3232-10ae74f00347&amp;amp;l=36026&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=34743&amp;amp;view=logs&amp;amp;j=298e20ef-7951-5965-0e79-ea664ddc435e&amp;amp;t=d4c90338-c843-57b0-3232-10ae74f00347&amp;amp;l=36026&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17524222" author="mapohl" created="Tue, 19 Apr 2022 10:10:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ferenc-csaky&quot; class=&quot;user-hover&quot; rel=&quot;ferenc-csaky&quot;&gt;ferenc-csaky&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bgeng777&quot; class=&quot;user-hover&quot; rel=&quot;bgeng777&quot;&gt;bgeng777&lt;/a&gt; may one of you have a closer look at it? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nsemmler&quot; class=&quot;user-hover&quot; rel=&quot;nsemmler&quot;&gt;nsemmler&lt;/a&gt; worked on a fix around the missing logs in &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-26710&quot; title=&quot;TestLoggerResource hides log lines&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-26710&quot;&gt;&lt;del&gt;FLINK-26710&lt;/del&gt;&lt;/a&gt;. Maybe, that&apos;s of help to fix this test instability.&lt;/p&gt;</comment>
                            <comment id="17524860" author="bgeng777" created="Wed, 20 Apr 2022 10:05:25 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt;, I tried to do some research but in latest &lt;a href=&quot;https://dev.azure.com/apache-flink/apache-flink/_build/results?buildId=34743&amp;amp;view=logs&amp;amp;j=298e20ef-7951-5965-0e79-ea664ddc435e&amp;amp;t=d4c90338-c843-57b0-3232-10ae74f00347&amp;amp;l=36026&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;failure&lt;/a&gt; posted by Yun, I did not find the &lt;tt&gt;Extracted hostname:port: }} was not shown. Though in the description of this ticket, it shows  {{Extracted hostname:port: 5718b812c7ab:38622&lt;/tt&gt; in the old CI test, which seems to be correct. &lt;br/&gt;
I plan to verify &lt;tt&gt;yarnSessionClusterRunner.sendStop();&lt;/tt&gt;  works fine(i.e. the session cluster will be stopped normally) first but I have not found a way to run the cron test&apos;s &quot;test_cron_jdk11 misc&quot; test only on the my own &lt;a href=&quot;https://dev.azure.com/samuelgeng7/Flink/_build/results?buildId=109&amp;amp;view=results&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;azure pipeline&lt;/a&gt;, which made the verification pretty slow and hard. Is there any guidelines about debugging the azure pipeline with some specific tests?&lt;/p&gt;</comment>
                            <comment id="17528760" author="mapohl" created="Wed, 27 Apr 2022 12:22:52 +0000"  >&lt;p&gt;HI &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bgeng777&quot; class=&quot;user-hover&quot; rel=&quot;bgeng777&quot;&gt;bgeng777&lt;/a&gt;, unfortunately, running individual tests within CI is a bit tedious right now. The only way, I know so far, is to alter &lt;tt&gt;tools/ci/test_controller.sh&lt;/tt&gt; to run the test you want to execute&lt;/p&gt;</comment>
                            <comment id="17544070" author="JIRAUSER281719" created="Mon, 30 May 2022 21:36:04 +0000"  >&lt;p&gt;I took another look at this instability and tried to retrace my earlier steps. There are two aspects about this instability:&lt;/p&gt;

&lt;p&gt;1. Why is the &lt;tt&gt;localhost:8081&lt;/tt&gt; address used in this Yarn context? (Instead of the Yarn container &amp;amp; port)&lt;br/&gt;
2. Why does the exception not halt the program? I.e., why is the program continuing to run after the exception is thrown?&lt;/p&gt;

&lt;p&gt;Previously I thought that &lt;tt&gt;localhost&lt;/tt&gt; was set via the setup of the YarnClusterDescriptor. In the newer logs, the following &lt;a href=&quot;https://github.com/apache/flink/blob/c16e4b4ce20704a0ad4387591894f13105d5e530/flink-yarn/src/main/java/org/apache/flink/yarn/YarnClusterDescriptor.java#L1799&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;log line&lt;/a&gt; shows that the address is still correctly set in the YarnClusterDescriptor: &lt;/p&gt;

&lt;p&gt;&lt;tt&gt;7:09:15,731 &lt;span class=&quot;error&quot;&gt;&amp;#91;Frontend (CLI/YARN Client) runner thread (startWithArgs()).&amp;#93;&lt;/span&gt; INFO org.apache.flink.yarn.YarnClusterDescriptor [] - Found Web Interface 6dad280b2159:40493 of application&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Apparently the &lt;tt&gt;localhost&lt;/tt&gt; address is added somewhere else. But where? Maybe it is done when the job is submitted? It may make sense to change the log level of this &lt;a href=&quot;https://github.com/apache/flink/blob/f9438dd54fa6896563b152d50b7a4b3c47ad9ebf/flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontend.java#L244&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;log line&lt;/a&gt; by changing it &lt;a href=&quot;https://github.com/apache/flink/blob/7d85b273ccdbd5a2242e05e5d645ea82280f5eea/flink-yarn-tests/src/test/java/org/apache/flink/yarn/YARNSessionCapacitySchedulerITCase.java#L116&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;This would however just explain point 1 not point 2. My intuition is that there is some timing problem at play that we are so far missing. Let&apos;s compare a successful to an erroneous execution:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Successful execution&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
05:26:42,745 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.yarn.YarnClusterDescriptor                  [] - YARN application has been deployed successfully.
05:26:42,745 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.yarn.YarnClusterDescriptor                  [] - Found Web Interface 6d4ce71bbaec:45932 of application &lt;span class=&quot;code-quote&quot;&gt;&apos;application_1650173077369_0008&apos;&lt;/span&gt;.    05:26:42,931 [                main] INFO  org.apache.flink.yarn.YarnTestBase                           [] - Found expected output in redirected streams
05:26:42,933 [                main] INFO  org.apache.flink.yarn.YARNSessionCapacitySchedulerITCase     [] - Extracted hostname:port: 6d4ce71bbaec:45932
05:26:42,934 [                main] INFO  org.apache.flink.yarn.YarnTestBase                           [] - Running with args [run, --detached, /__w/3/s/flink-yarn-tests/target/programs/WindowJoin.jar]
05:26:42,940 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.yarn.cli.FlinkYarnSessionCli                [] - Found Yarn properties file under /tmp/.yarn-properties-agent03_azpcontainer.
05:26:42,940 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] WARN  org.apache.flink.core.plugin.PluginConfig                    [] - The plugins directory [plugins] does not exist.
05:26:42,941 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.client.cli.CliFrontend                      [] - Running &lt;span class=&quot;code-quote&quot;&gt;&apos;run&apos;&lt;/span&gt; command.
05:26:42,942 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.client.cli.CliFrontend                      [] - Building program from JAR file
05:26:42,945 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.client.ClientUtils                          [] - Starting program (detached: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
05:26:42,975 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.api.java.typeutils.TypeExtractor            [] - &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.flink.streaming.api.datastream.CoGroupedStreams$TaggedUnion does not      contain a setter &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; field one                                                                                                                                                                                                                05:26:42,975 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.api.java.typeutils.TypeExtractor            [] - &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.flink.streaming.api.datastream.CoGroupedStreams$TaggedUnion cannot  be used as a POJO type because not all fields are valid POJO fields, and must be processed as GenericType. Please read the Flink documentation on &lt;span class=&quot;code-quote&quot;&gt;&quot;Data Types &amp;amp; Serialization&quot;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; details of the effect on performance.                      05:26:42,978 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.api.java.typeutils.TypeExtractor            [] - &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.flink.streaming.api.datastream.CoGroupedStreams$TaggedUnion does not      contain a setter &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; field one                                                                                                                                                                                                                05:26:42,978 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.api.java.typeutils.TypeExtractor            [] - &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.flink.streaming.api.datastream.CoGroupedStreams$TaggedUnion cannot  be used as a POJO type because not all fields are valid POJO fields, and must be processed as GenericType. Please read the Flink documentation on &lt;span class=&quot;code-quote&quot;&gt;&quot;Data Types &amp;amp; Serialization&quot;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; details of the effect on performance.                      05:26:43,033 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] WARN  org.apache.flink.yarn.configuration.YarnLogConfigUtil        [] - The configuration directory (&lt;span class=&quot;code-quote&quot;&gt;&apos;/tmp/junit8048407617893879030/conf&apos;&lt;/span&gt;) already contains a      LOG4J config file.If you want to use logback, then please delete or rename the log configuration file.                                                                                                                                        05:26:43,033 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] WARN  org.apache.flink.runtime.util.HadoopUtils                    [] - Could not find Hadoop configuration via any of the supported methods (Flink configuration, environment variables).                                                                                                                                                                                                                       05:26:43,082 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.hadoop.yarn.client.RMProxy                        [] - Connecting to ResourceManager at 6d4ce71bbaec/192.168.192.2:42104
05:26:43,083 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.yarn.YarnClusterDescriptor                  [] - No path &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the flink jar passed. Using the location of &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.flink.yarn.       YarnClusterDescriptor to locate the jar
05:26:43,086 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.yarn.YarnClusterDescriptor                  [] - Found Web Interface 6d4ce71bbaec:45932 of application &lt;span class=&quot;code-quote&quot;&gt;&apos;application_1650173077369_0008&apos;&lt;/span&gt;.
05:26:43,101 [Flink-RestClusterClient-IO-thread-1] INFO  org.apache.flink.client.program.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.RestClusterClient       [] - Submitting job &lt;span class=&quot;code-quote&quot;&gt;&apos;Windowed Join Example&apos;&lt;/span&gt; (8e2a9cb1e08a4b6642ac342bd4d96dcb).                                         05:26:43,620 [Flink-RestClusterClient-IO-thread-4] INFO  org.apache.flink.client.program.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.RestClusterClient       [] - Successfully submitted job &lt;span class=&quot;code-quote&quot;&gt;&apos;Windowed Join Example&apos;&lt;/span&gt; (8e2a9cb1e08a4b6642ac342bd4d96dcb) to &lt;span class=&quot;code-quote&quot;&gt;&apos;http:&lt;span class=&quot;code-comment&quot;&gt;//6d4ce71bbaec:     45932&apos;&lt;/span&gt;.&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Erroneous execution&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
07:09:15,731 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.yarn.YarnClusterDescriptor                  [] - YARN application has been deployed successfully.
07:09:15,731 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.yarn.YarnClusterDescriptor                  [] - Found Web Interface 6dad280b2159:40493 of application &lt;span class=&quot;code-quote&quot;&gt;&apos;application_1650179225006_0008&apos;&lt;/span&gt;.    07:09:15,750 [                main] INFO  org.apache.flink.yarn.YarnTestBase                           [] - Found expected output in redirected streams
07:09:15,752 [                main] INFO  org.apache.flink.yarn.YARNSessionCapacitySchedulerITCase     [] - Extracted hostname:port: 6dad280b2159:40493
07:09:15,752 [                main] INFO  org.apache.flink.yarn.YarnTestBase                           [] - Running with args [run, --detached, /__w/2/s/flink-yarn-tests/target/programs/WindowJoin.jar]
07:09:15,757 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] WARN  org.apache.flink.core.plugin.PluginConfig                    [] - The plugins directory [plugins] does not exist.
07:09:15,758 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.client.cli.CliFrontend                      [] - Running &lt;span class=&quot;code-quote&quot;&gt;&apos;run&apos;&lt;/span&gt; command.
07:09:15,759 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.client.cli.CliFrontend                      [] - Building program from JAR file
07:09:15,762 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.client.ClientUtils                          [] - Starting program (detached: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
07:09:15,867 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.api.java.typeutils.TypeExtractor            [] - &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.flink.streaming.api.datastream.CoGroupedStreams$TaggedUnion does not      contain a setter &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; field one                                                                                                                                                                                                                07:09:15,867 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.api.java.typeutils.TypeExtractor            [] - &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.flink.streaming.api.datastream.CoGroupedStreams$TaggedUnion cannot  be used as a POJO type because not all fields are valid POJO fields, and must be processed as GenericType. Please read the Flink documentation on &lt;span class=&quot;code-quote&quot;&gt;&quot;Data Types &amp;amp; Serialization&quot;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; details of the effect on performance.                      07:09:15,871 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.api.java.typeutils.TypeExtractor            [] - &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.flink.streaming.api.datastream.CoGroupedStreams$TaggedUnion does not      contain a setter &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; field one                                                                                                                                                                                                                07:09:15,871 [Frontend (CLI/YARN Client) runner thread (startWithArgs()).] INFO  org.apache.flink.api.java.typeutils.TypeExtractor            [] - &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.flink.streaming.api.datastream.CoGroupedStreams$TaggedUnion cannot  be used as a POJO type because not all fields are valid POJO fields, and must be processed as GenericType. Please read the Flink documentation on &lt;span class=&quot;code-quote&quot;&gt;&quot;Data Types &amp;amp; Serialization&quot;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; details of the effect on performance.                      07:09:16,194 [Flink-RestClusterClient-IO-thread-1] INFO  org.apache.flink.client.program.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.RestClusterClient       [] - Submitting job &lt;span class=&quot;code-quote&quot;&gt;&apos;Windowed Join Example&apos;&lt;/span&gt; (2788aebd84c123f092c0992e5a7321ca).
07:09:16,236 [flink-&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;-client-netty-thread-1] WARN  org.apache.flink.client.program.&lt;span class=&quot;code-keyword&quot;&gt;rest&lt;/span&gt;.RestClusterClient       [] - Attempt to submit job &lt;span class=&quot;code-quote&quot;&gt;&apos;Windowed Join Example&apos;&lt;/span&gt; (2788aebd84c123f092c0992e5a7321ca) to &lt;span class=&quot;code-quote&quot;&gt;&apos;http:&lt;span class=&quot;code-comment&quot;&gt;//localhost:8081&apos;&lt;/span&gt; has       failed.                                                                                                                                                                                                                                       java.util.concurrent.CompletionException: org.apache.flink.shaded.netty4.io.netty.channel.AbstractChannel$AnnotatedConnectException: Connection refused: localhost/127.0.0.1:8081&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It is noteworthy that the line &lt;tt&gt;The configuration directory (&apos;/tmp/junit8048407617893879030/conf&apos;) already contains a      LOG4J config file&lt;/tt&gt; only appears in the successful execution. This may indicate a timing issue.&lt;/p&gt;</comment>
                            <comment id="17544212" author="JIRAUSER281719" created="Tue, 31 May 2022 08:13:00 +0000"  >&lt;p&gt;Note, the code on master has now replaced &lt;tt&gt;TestLoggerResource&lt;/tt&gt; by &lt;tt&gt;LoggerAuditingExtension&lt;/tt&gt;. In my understanding &lt;tt&gt;LoggerAuditingExtension&lt;/tt&gt; has the same problem as the previous implementation of &lt;tt&gt;TestLoggerResource&lt;/tt&gt;. See &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-26710&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/FLINK-26710&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17544256" author="JIRAUSER281719" created="Tue, 31 May 2022 09:14:21 +0000"  >&lt;p&gt;Ok, so I think what happens here is roughly the following.&lt;/p&gt;

&lt;p&gt;The test submits a packaged program. This program is invoked &lt;a href=&quot;https://github.com/apache/flink/blob/c6997c97c575d334679915c328792b8a3067cfb5/flink-clients/src/main/java/org/apache/flink/client/ClientUtils.java#L114&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. There is a thread local context setup that determines how the program is executed. If set up correctly, the program will be run using a Yarn specific code path (using the &lt;tt&gt;YarnSessionClusterExecutorFactory&lt;/tt&gt; and &lt;tt&gt;YarnClusterDescriptor&lt;/tt&gt;). In this case, the rest address of the job manager will be retrieved via &lt;tt&gt;YarnClusterDescriptor&lt;/tt&gt;. Everything is well.&lt;/p&gt;

&lt;p&gt;If things don&apos;t work out correctly, I &lt;em&gt;think&lt;/em&gt; the Yarn specific code path is not set up and during the program execution the rest address is extracted from the default config file. This leads to the use of the wrong &lt;tt&gt;localhost&lt;/tt&gt; address.&lt;/p&gt;

&lt;p&gt;Now the big question is: Why is the Yarn specific code path not set up correctly for the erroneous executions? Again, I &lt;em&gt;think&lt;/em&gt; this has something to do with the timing of the different threads. But how exactly is still unclear to me.&lt;/p&gt;</comment>
                            <comment id="17544291" author="JIRAUSER281719" created="Tue, 31 May 2022 10:10:37 +0000"  >&lt;p&gt;I just noticed, that the line &lt;tt&gt;Found Yarn properties file under /tmp/.yarn-properties-agent03_azpcontainer&lt;/tt&gt; is missing for the errorneous execution. The file is loaded here &lt;a href=&quot;https://github.com/apache/flink/blob/6086e327cd4168e09eac4f6b0b86fb29ebe3860c/flink-yarn/src/main/java/org/apache/flink/yarn/cli/FlinkYarnSessionCli.java#L288&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and the content ends up in the configuration &lt;a href=&quot;https://github.com/apache/flink/blob/f9438dd54fa6896563b152d50b7a4b3c47ad9ebf/flink-clients/src/main/java/org/apache/flink/client/cli/CliFrontend.java#L241&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. If the file contains the Yarn specific settings and is not available for the erroneous execution, then this explains why the Yarn code path is not used.&lt;/p&gt;</comment>
                            <comment id="17544328" author="JIRAUSER281719" created="Tue, 31 May 2022 11:22:09 +0000"  >&lt;p&gt;This file is written &lt;a href=&quot;https://github.com/apache/flink/blob/6086e327cd4168e09eac4f6b0b86fb29ebe3860c/flink-yarn/src/main/java/org/apache/flink/yarn/cli/FlinkYarnSessionCli.java#L617&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;In the test we wait for the thread, but only for the print output that comes before writing the Yarn properties file. (see &lt;a href=&quot;https://github.com/apache/flink/blob/b98c66cfe44d1b4002fe56dbf323d8ea8ce0409c/flink-yarn-tests/src/test/java/org/apache/flink/yarn/YARNSessionCapacitySchedulerITCase.java#L309&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;We should be able to fix the issue by exchanging the order of the print and the write file command.&lt;/p&gt;</comment>
                            <comment id="17544790" author="JIRAUSER281719" created="Wed, 1 Jun 2022 10:10:58 +0000"  >&lt;p&gt;I finally found an explanation for the aspect 2: Why the yarn session thread sometimes continues to run even when an exception is thrown.&lt;/p&gt;

&lt;p&gt;There is a race condition happening between the &lt;a href=&quot;https://github.com/apache/flink/blob/6086e327cd4168e09eac4f6b0b86fb29ebe3860c/flink-yarn/src/main/java/org/apache/flink/yarn/cli/FlinkYarnSessionCli.java#L874&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;interactive CLI of the YARN session&lt;/a&gt; and the &lt;a href=&quot;https://github.com/apache/flink/blob/98a6a5432b642aa647f6edcd60dae49ef9093786/flink-yarn-tests/src/test/java/org/apache/flink/yarn/YarnTestBase.java#L890&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;job submission&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To explain the problem:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The &lt;em&gt;main thread&lt;/em&gt; executing the test starts two threads: the &lt;em&gt;jobmanager thread&lt;/em&gt; executing the job manager as part of a yarn session and the &lt;em&gt;submission thread&lt;/em&gt; submitting the Flink job.&lt;/li&gt;
	&lt;li&gt;The &lt;em&gt;jobmanager thread&lt;/em&gt; is created before and ends after the &lt;em&gt;submission thread&lt;/em&gt;.&lt;/li&gt;
	&lt;li&gt;Communication between &lt;em&gt;main thread&lt;/em&gt; and the other threads happens via rerouted stdin, stdout, stderr channels. The rerouting takes place when the &lt;em&gt;jobmanager thread&lt;/em&gt; and &lt;em&gt;submission thread&lt;/em&gt; are created respectively.&lt;/li&gt;
	&lt;li&gt;The &lt;em&gt;main thread&lt;/em&gt; waits for the &lt;em&gt;jobmanager thread&lt;/em&gt; and &lt;em&gt;submission thread&lt;/em&gt; to print a specific output message to the rerouted stdout before continuing.&lt;/li&gt;
	&lt;li&gt;The &lt;em&gt;jobmanager thread&lt;/em&gt; needs to be explicitly shutdown via &quot;stop&quot; string communicated via the rerouted stdin&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The problem appears, if &lt;em&gt;submission thread&lt;/em&gt; reroutes the stdin before &lt;em&gt;jobmanager thread&lt;/em&gt; opens a BufferedReader on the old stdin. In this case, the stop message from the &lt;em&gt;main thread&lt;/em&gt; to the &lt;em&gt;jobmanager thread&lt;/em&gt; is lost and the &lt;b&gt;&lt;em&gt;jobmanager thread&lt;/em&gt; continues running indefinitely&lt;/b&gt;. In this cases even an exception will not fail the test.&lt;/p&gt;

&lt;p&gt;We can improve on this by changing the output the &lt;em&gt;main thread&lt;/em&gt; matches on. Instead of the &lt;a href=&quot;https://github.com/apache/flink/blob/b98c66cfe44d1b4002fe56dbf323d8ea8ce0409c/flink-yarn-tests/src/test/java/org/apache/flink/yarn/YARNSessionCapacitySchedulerITCase.java#L309&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;current&lt;/a&gt;, we could add a new output after the creation of the &lt;a href=&quot;https://github.com/apache/flink/blob/6086e327cd4168e09eac4f6b0b86fb29ebe3860c/flink-yarn/src/main/java/org/apache/flink/yarn/cli/FlinkYarnSessionCli.java#L874&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;BufferedReader&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The question here is whether adding an output line here will have some unintended consequences. The code is directly used by the FLINK Yarn session CLI, so if anybody is already parsing the output this may have adverse effects. Also, if we change it here, we may also want to touch other tests that make use of the same code.&lt;/p&gt;

&lt;p&gt;Alternative approaches that only touch the tests are:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;move the current println statement further down in the code (see &lt;a href=&quot;https://github.com/apache/flink/pull/19852&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR19852&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;add a (one second?) delay before the job submission&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;However, both of these solutions only reduce the chance that the test instability will appear.&lt;/p&gt;</comment>
                            <comment id="17544799" author="JIRAUSER281719" created="Wed, 1 Jun 2022 10:35:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/pull/19852&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR19852&lt;/a&gt; implements the partial solution.&lt;/p&gt;

&lt;p&gt;I have tested the partial solution in this &lt;a href=&quot;https://dev.azure.com/NiklasFlink/NiklasFlink/_build/results?buildId=121&amp;amp;view=logs&amp;amp;j=f3dc9b18-b77a-55c1-591e-264c46fe44d1&amp;amp;t=2d3cd81e-1c37-5c31-0ee4-f5d5cdb9324d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;azure pipeline&lt;/a&gt;. After four hours of running the same test, we still don&apos;t see any instabiliity.&lt;/p&gt;

&lt;p&gt;In contrast, when we don&apos;t use the PR we see a failure in &lt;a href=&quot;https://dev.azure.com/NiklasFlink/NiklasFlink/_build/results?buildId=122&amp;amp;view=logs&amp;amp;j=f3dc9b18-b77a-55c1-591e-264c46fe44d1&amp;amp;t=2d3cd81e-1c37-5c31-0ee4-f5d5cdb9324d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this azure pipeline&lt;/a&gt; after 45 minutes.&lt;/p&gt;

&lt;p&gt;The alternative but more heavy weight change is &lt;a href=&quot;https://github.com/apache/flink/pull/19863&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR19863&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17544992" author="JIRAUSER281719" created="Wed, 1 Jun 2022 16:01:36 +0000"  >&lt;p&gt;After a discussion with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt;, a different solution for the problem around stdin is to replace the use of stdin on the test path with a different stream.&lt;/p&gt;

&lt;p&gt;Together with the reordering of the print statement and write yarn properties file command described above, this would remove the synchronization problem&lt;/p&gt;</comment>
                            <comment id="17554056" author="martijnvisser" created="Tue, 14 Jun 2022 11:42:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt; potentially &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ferenc-csaky&quot; class=&quot;user-hover&quot; rel=&quot;ferenc-csaky&quot;&gt;ferenc-csaky&lt;/a&gt; can also help out if needed, he will also look into the other YARN test stability problem &lt;a href=&quot;https://issues.apache.org/jira/browse/FLINK-27667&quot; title=&quot;YARNHighAvailabilityITCase fails with &amp;quot;Failed to delete temp directory /tmp/junit1681&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLINK-27667&quot;&gt;&lt;del&gt;FLINK-27667&lt;/del&gt;&lt;/a&gt; this week &lt;/p&gt;</comment>
                            <comment id="17554133" author="mapohl" created="Tue, 14 Jun 2022 14:32:33 +0000"  >&lt;p&gt;Thanks for looking into it &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nsemmler&quot; class=&quot;user-hover&quot; rel=&quot;nsemmler&quot;&gt;nsemmler&lt;/a&gt; and your thorough review. Of the two proposed PRs, I&apos;d go with &lt;a href=&quot;https://github.com/apache/flink/pull/19852/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #19852&lt;/a&gt;, because it doesn&apos;t touch the production code. Essentially, we&apos;re moving the &lt;tt&gt;*.properties&lt;/tt&gt; creation into the waiting period before proceeding with the job submission to avoid it to take too long before the interactive cli logic (including the BufferedReader initialization around &lt;tt&gt;System.in&lt;/tt&gt;) is started.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/pull/19863&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #19863&lt;/a&gt; touches production code which I am hesitant to do. The test runs in AzureCI indicate already that it might help reducing the flakiness. We might want to tackle the race condition you described above, still.&lt;/p&gt;</comment>
                            <comment id="17554135" author="mapohl" created="Tue, 14 Jun 2022 14:38:00 +0000"  >&lt;p&gt;I merged PR #19863 and related backports:&lt;br/&gt;
master - 6fe543bc8568015bc64eed558817d680a7fce85f&lt;br/&gt;
1.15 - 96c400cf909a4af941a54fa663758d73bb0f9679&lt;br/&gt;
1.14 - 5275206fcb891d67153e108f2e81b3e2734b4784&lt;/p&gt;

&lt;p&gt;I&apos;m going to keep this ticket open to cover the race condition and to observe the frequency of still happening build failures. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ferenc-csaky&quot; class=&quot;user-hover&quot; rel=&quot;ferenc-csaky&quot;&gt;ferenc-csaky&lt;/a&gt; feel free to pick this issue up.&lt;/p&gt;</comment>
                            <comment id="17562414" author="martijnvisser" created="Tue, 5 Jul 2022 07:22:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mapohl&quot; class=&quot;user-hover&quot; rel=&quot;mapohl&quot;&gt;mapohl&lt;/a&gt; What&apos;s the current status of this ticket? &lt;/p&gt;</comment>
                            <comment id="17562417" author="mapohl" created="Tue, 5 Jul 2022 07:34:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nsemmler&quot; class=&quot;user-hover&quot; rel=&quot;nsemmler&quot;&gt;nsemmler&lt;/a&gt; provided a workaround where we hope that it reduces the frequency of the error. Fixing it properly requires a bigger change (making the &lt;tt&gt;PrintStream&lt;/tt&gt; instances configurable instead of using &lt;tt&gt;System.out&lt;/tt&gt; and &lt;tt&gt;System.err&lt;/tt&gt; in a hard-coded fashion) which is not implemented, yet. That&apos;s why I left the ticket open...&lt;/p&gt;</comment>
                            <comment id="17562424" author="martijnvisser" created="Tue, 5 Jul 2022 07:41:38 +0000"  >&lt;p&gt;Are we OK with downgrading this to a Major instead of Critical?&lt;/p&gt;</comment>
                            <comment id="17564154" author="mapohl" created="Fri, 8 Jul 2022 08:19:52 +0000"  >&lt;p&gt;Yes, I guess, that makes sense. Thanks for doing so...&lt;/p&gt;</comment>
                            <comment id="17597147" author="zentol" created="Mon, 29 Aug 2022 11:05:36 +0000"  >&lt;p&gt;Considering it as fixed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13434381">FLINK-26710</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 11 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ww80:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>