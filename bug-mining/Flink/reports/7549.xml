<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 21:20:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[FLINK-33192] State memory leak in the Window Operator due to unregistered cleanup timer</title>
                <link>https://issues.apache.org/jira/browse/FLINK-33192</link>
                <project id="12315522" key="FLINK">Flink</project>
                    <description>&lt;p&gt;I have encountered a state memory leak issue in the default window operator. The cleanup timer for a window is not registered when it does not emit a result if it&#8217;s fired immediately after creation. The window is added to the window state and as the cleanup timer isn&apos;t registered, it&apos;s never cleaned up, allowing it to live forever.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Steps to Reproduce:&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Write a custom trigger that triggers for every element.&lt;/li&gt;
	&lt;li&gt;Write a custom aggregate function that never produces a result.&lt;/li&gt;
	&lt;li&gt;Use a default tumbling event time window with this custom trigger and aggregate function.&lt;/li&gt;
	&lt;li&gt;Publish events spanning multiple time windows.&lt;/li&gt;
	&lt;li&gt;The window state will contain all the windows even after their expiry/cleanup time.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;b&gt;Code with the bug:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/flink/blob/cd95b560d0c11a64b42bf6b98107314d32a4de86/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/operators/windowing/WindowOperator.java#L399-L417&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/cd95b560d0c11a64b42bf6b98107314d32a4de86/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/operators/windowing/WindowOperator.java#L398-L417&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
windowState.setCurrentNamespace(window);
windowState.add(element.getValue());

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (triggerResult.isFire()) {
    ACC contents = windowState.get();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (contents == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
    }
    emitWindowContents(window, contents);
}

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (triggerResult.isPurge()) {
    windowState.clear();
}
registerCleanupTimer(window);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Expected Result:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The cleanup timer should be registered for every window that&apos;s added to the window state regardless of it emitting a result after it&#8217;s fired.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Actual Result:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The cleanup timer is not registered for a window when it does not emit a result after it&#8217;s fired, causing the window state that is already created to live on indefinitely.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Impact:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;This issue led to a huge state memory leak in our applications and was very challenging to identify.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Fix:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;There are two ways to fix this issue. I&apos;m willing to create a PR with the fix if approved.&lt;/p&gt;

&lt;p&gt;1. Register the cleanup timer immediately after a window is added to the state.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
windowState.setCurrentNamespace(window);
windowState.add(element.getValue());
registerCleanupTimer(window);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;2. Emit the results when the contents are not null and remove the continue statement.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (triggerResult.isFire()) {
    ACC contents = windowState.get();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (contents != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) { &#160; &#160; &#160; &#160; 
 &#160; &#160;&#160; &#160;&#160;emitWindowContents(window, contents);
 &#160; &#160;}
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13552955">FLINK-33192</key>
            <summary>State memory leak in the Window Operator due to unregistered cleanup timer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kartikeypant">Kartikey Pant</assignee>
                                    <reporter username="vkalvakunta">Vidya Sagar Kalvakunta</reporter>
                        <labels>
                            <label>easyfix</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 5 Oct 2023 05:07:25 +0000</created>
                <updated>Mon, 8 Jul 2024 08:09:21 +0000</updated>
                            <resolved>Mon, 8 Jul 2024 08:09:21 +0000</resolved>
                                    <version>1.14.6</version>
                    <version>1.15.4</version>
                    <version>1.16.2</version>
                    <version>1.17.1</version>
                                    <fixVersion>1.18.2</fixVersion>
                    <fixVersion>1.20.0</fixVersion>
                    <fixVersion>1.19.2</fixVersion>
                                    <component>Runtime / State Backends</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17852643" author="JIRAUSER301503" created="Thu, 6 Jun 2024 06:14:23 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ym&quot; class=&quot;user-hover&quot; rel=&quot;ym&quot;&gt;ym&lt;/a&gt;, can I take this issue up in case you have not started working on it?&lt;/p&gt;</comment>
                            <comment id="17853077" author="yanfei lei" created="Fri, 7 Jun 2024 08:33:47 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kartikeypant&quot; class=&quot;user-hover&quot; rel=&quot;kartikeypant&quot;&gt;kartikeypant&lt;/a&gt; , thank you for volunteering, assigned to you.&lt;/p&gt;</comment>
                            <comment id="17853344" author="JIRAUSER301503" created="Sat, 8 Jun 2024 08:33:35 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Yanfei+Lei&quot; class=&quot;user-hover&quot; rel=&quot;Yanfei Lei&quot;&gt;Yanfei Lei&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I&apos;ve submitted a Pull Request (&lt;a href=&quot;https://github.com/apache/flink/pull/24917&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;GitHub Pull Request #24917&lt;/a&gt;) aimed at resolving the reported bug. Additionally, I believe there may be a memory leak possibility within the MergingWindow section (&lt;a href=&quot;https://github.com/apache/flink/blob/master/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/operators/windowing/WindowOperator.java#L369-L388&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/flink/blob/master/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/operators/windowing/WindowOperator.java#L369-L388&lt;/a&gt;). Consequently, I&apos;ve included the relevant modification in this pull request as well.&lt;/p&gt;

&lt;p&gt;Could you please review it and let me know if everything looks good, or if any further adjustments or validations are necessary?&lt;/p&gt;

&lt;p&gt;Thank you.&lt;/p&gt;</comment>
                            <comment id="17854312" author="JIRAUSER305785" created="Wed, 12 Jun 2024 08:06:30 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Can be Flink 1.18.x and 1.19.x affected?&lt;/p&gt;

&lt;p&gt;BR. Adam.&lt;/p&gt;</comment>
                            <comment id="17854628" author="JIRAUSER301503" created="Thu, 13 Jun 2024 05:18:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adam.domanski2&quot; class=&quot;user-hover&quot; rel=&quot;adam.domanski2&quot;&gt;adam.domanski2&lt;/a&gt;&#160; - Yes, Flink 1.18.x and 1.19.x should also be affected from this leak.&#160;&lt;/p&gt;</comment>
                            <comment id="17863702" author="hong" created="Mon, 8 Jul 2024 08:08:13 +0000"  >&lt;p&gt;&#160;merged commit &lt;a href=&quot;https://github.com/apache/flink/commit/a97c2bb6cf81337a0fe636b45bb04d7dc0268c7c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;a97c2bb&lt;/tt&gt;&lt;/a&gt; into   apache:release-1.19&lt;/p&gt;</comment>
                            <comment id="17863703" author="hong" created="Mon, 8 Jul 2024 08:08:25 +0000"  >&lt;p&gt;&#160;merged commit &lt;a href=&quot;https://github.com/apache/flink/commit/87b362335128e62112cf34839837b2d635d93df2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;87b3623&lt;/tt&gt;&lt;/a&gt; into   apache:release-1.18&lt;/p&gt;</comment>
                            <comment id="17863704" author="hong" created="Mon, 8 Jul 2024 08:08:50 +0000"  >&lt;p&gt;&#160;merged commit &lt;a href=&quot;https://github.com/apache/flink/commit/f9857caf9fd8582bb9712d32a3b2d3f374907450&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;f9857ca&lt;/tt&gt;&lt;/a&gt; into   apache:release-1.20&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 18 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1kqyo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>